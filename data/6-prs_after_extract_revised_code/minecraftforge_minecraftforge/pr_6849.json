{"pr_number": 6849, "pr_title": "Fix and tweak how resource reload listeners are added", "pr_createdAt": "2020-06-27T02:34:56Z", "pr_url": "https://github.com/MinecraftForge/MinecraftForge/pull/6849", "timeline": [{"oid": "6029e67c24fcbfc5d048ca801ca9422a2405c2d6", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/6029e67c24fcbfc5d048ca801ca9422a2405c2d6", "message": "Fix adding reload listeners", "committedDate": "2020-06-27T02:26:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ5NjMzMA==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/6849#discussion_r446496330", "bodyText": "Because this is in an interface, this is public, it should not be.", "author": "covers1624", "createdAt": "2020-06-27T07:23:03Z", "path": "src/main/java/net/minecraftforge/resource/IForgeDataPackRegistries.java", "diffHunk": "@@ -0,0 +1,22 @@\n+package net.minecraftforge.resource;\n+\n+import net.minecraft.resources.IFutureReloadListener;\n+import net.minecraftforge.common.loot.LootModifierManager;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.stream.Stream;\n+\n+public interface IForgeDataPackRegistries {\n+   List<IFutureReloadListener> resources = new ArrayList<>();", "originalCommit": "6029e67c24fcbfc5d048ca801ca9422a2405c2d6", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2631f08bc2826ba6cd7d316d910d606fb58117ec", "chunk": "diff --git a/src/main/java/net/minecraftforge/resource/IForgeDataPackRegistries.java b/src/main/java/net/minecraftforge/resource/IForgeDataPackRegistries.java\ndeleted file mode 100644\nindex a73ee4991..000000000\n--- a/src/main/java/net/minecraftforge/resource/IForgeDataPackRegistries.java\n+++ /dev/null\n\n@@ -1,22 +0,0 @@\n-package net.minecraftforge.resource;\n-\n-import net.minecraft.resources.IFutureReloadListener;\n-import net.minecraftforge.common.loot.LootModifierManager;\n-\n-import java.util.ArrayList;\n-import java.util.List;\n-import java.util.stream.Stream;\n-\n-public interface IForgeDataPackRegistries {\n-   List<IFutureReloadListener> resources = new ArrayList<>();\n-\n-   default Stream<IFutureReloadListener> getResourcesToReload()\n-   {\n-      return resources.stream();\n-   }\n-\n-   static void addResource(IFutureReloadListener resource)\n-   {\n-      resources.add(resource);\n-   }\n-}\n"}}, {"oid": "2631f08bc2826ba6cd7d316d910d606fb58117ec", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/2631f08bc2826ba6cd7d316d910d606fb58117ec", "message": "Event way", "committedDate": "2020-06-27T13:03:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjU1NDcyOQ==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/6849#discussion_r446554729", "bodyText": "Why are the imports in this file changing?", "author": "pupnewfster", "createdAt": "2020-06-27T18:39:58Z", "path": "src/main/java/net/minecraftforge/common/ForgeMod.java", "diffHunk": "@@ -23,8 +23,8 @@\n import net.minecraft.entity.ai.attributes.RangedAttribute;\n import net.minecraft.util.SoundEvent;\n import net.minecraft.world.storage.IServerConfiguration;\n-import net.minecraft.world.storage.IWorldInfo;", "originalCommit": "2631f08bc2826ba6cd7d316d910d606fb58117ec", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1a601fc93bc52ca56b10c688b8d3f0b764762ddc", "chunk": "diff --git a/src/main/java/net/minecraftforge/common/ForgeMod.java b/src/main/java/net/minecraftforge/common/ForgeMod.java\nindex 1c8132eed..868c1cc90 100644\n--- a/src/main/java/net/minecraftforge/common/ForgeMod.java\n+++ b/src/main/java/net/minecraftforge/common/ForgeMod.java\n\n@@ -24,7 +24,6 @@ import net.minecraft.entity.ai.attributes.RangedAttribute;\n import net.minecraft.util.SoundEvent;\n import net.minecraft.world.storage.IServerConfiguration;\n import net.minecraft.world.storage.SaveFormat;\n-import net.minecraftforge.common.loot.LootModifierManager;\n import net.minecraftforge.eventbus.api.IEventBus;\n import net.minecraftforge.eventbus.api.SubscribeEvent;\n import net.minecraftforge.fml.*;\n"}}, {"oid": "1a601fc93bc52ca56b10c688b8d3f0b764762ddc", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/1a601fc93bc52ca56b10c688b8d3f0b764762ddc", "message": "Add docs + fixes", "committedDate": "2020-06-27T23:08:59Z", "type": "commit"}, {"oid": "a4ee329e63b986ddfdb583faf8e6ff95a146d93e", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/a4ee329e63b986ddfdb583faf8e6ff95a146d93e", "message": "damn imports", "committedDate": "2020-06-27T23:14:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjU4MzY1NA==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/6849#discussion_r446583654", "bodyText": "Might want to emphasize this is for server reload listeners. Only clue in the javadoc is the link to data pack registries, but I could see someone getting confused and trying to use this for the client side resource pack reload listeners.", "author": "KnightMiner", "createdAt": "2020-06-28T00:38:33Z", "path": "src/main/java/net/minecraftforge/event/AddReloadListenerEvent.java", "diffHunk": "@@ -0,0 +1,34 @@\n+package net.minecraftforge.event;\n+\n+import com.google.common.collect.ImmutableList;\n+import net.minecraft.resources.DataPackRegistries;\n+import net.minecraft.resources.IFutureReloadListener;\n+import net.minecraftforge.common.MinecraftForge;\n+import net.minecraftforge.eventbus.api.Event;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+/**\n+ * The main ResourceManager is recreated on each reload, through {@link DataPackRegistries}'s creation.\n+ *\n+ * The event is fired on each reload and lets modders add their own ReloadListeners.\n+ * The event is fired on the {@link MinecraftForge#EVENT_BUS}\n+ */\n+public class AddReloadListenerEvent extends Event", "originalCommit": "a4ee329e63b986ddfdb583faf8e6ff95a146d93e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "4950447c05e29dbed1ba0bf273dc28073810ad77", "chunk": "diff --git a/src/main/java/net/minecraftforge/event/AddReloadListenerEvent.java b/src/main/java/net/minecraftforge/event/AddReloadListenerEvent.java\nindex c53a8451f..c6941f4e6 100644\n--- a/src/main/java/net/minecraftforge/event/AddReloadListenerEvent.java\n+++ b/src/main/java/net/minecraftforge/event/AddReloadListenerEvent.java\n\n@@ -12,7 +12,7 @@ import java.util.List;\n /**\n  * The main ResourceManager is recreated on each reload, through {@link DataPackRegistries}'s creation.\n  *\n- * The event is fired on each reload and lets modders add their own ReloadListeners.\n+ * The event is fired on each reload and lets modders add their own ReloadListeners, for server-side resources.\n  * The event is fired on the {@link MinecraftForge#EVENT_BUS}\n  */\n public class AddReloadListenerEvent extends Event\n"}}, {"oid": "4950447c05e29dbed1ba0bf273dc28073810ad77", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/4950447c05e29dbed1ba0bf273dc28073810ad77", "message": "specify only server ride", "committedDate": "2020-06-28T01:28:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzk0MTU1NA==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/6849#discussion_r447941554", "bodyText": "Forge has its own internal handler, so this shouldn't have this weird meta instance thing...\nWhat is the point of people having access to the instance?", "author": "LexManos", "createdAt": "2020-06-30T19:54:32Z", "path": "src/main/java/net/minecraftforge/common/loot/LootModifierManager.java", "diffHunk": "@@ -154,4 +161,17 @@ private IGlobalLootModifier deserializeModifier(ResourceLocation location, JsonE\n         return registeredLootModifiers.values();\n     }\n \n+    @SubscribeEvent\n+    public static void onResourceReload(AddReloadListenerEvent event)", "originalCommit": "4950447c05e29dbed1ba0bf273dc28073810ad77", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzk1ODg5NQ==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/6849#discussion_r447958895", "bodyText": "used here https://github.com/MinecraftForge/MinecraftForge/blob/1.16.x/src/main/java/net/minecraftforge/common/ForgeHooks.java#L1169 but commented for now. I can put this in the InternalHandler if its better suited.", "author": "Cyborgmas", "createdAt": "2020-06-30T20:27:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzk0MTU1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzk3MzUxNg==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/6849#discussion_r447973516", "bodyText": "Yes this should be moved to the internal handler as there is no sense in exposing a modder facing API if we can avoid it when it comes to internal instances of things.", "author": "pupnewfster", "createdAt": "2020-06-30T20:56:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzk0MTU1NA=="}], "type": "inlineReview", "revised_code": {"commit": "2eb51f8089d330db58173203d9b69e683719400b", "chunk": "diff --git a/src/main/java/net/minecraftforge/common/loot/LootModifierManager.java b/src/main/java/net/minecraftforge/common/loot/LootModifierManager.java\nindex 5353e871d..9a6cd9eb3 100644\n--- a/src/main/java/net/minecraftforge/common/loot/LootModifierManager.java\n+++ b/src/main/java/net/minecraftforge/common/loot/LootModifierManager.java\n\n@@ -160,18 +157,4 @@ public class LootModifierManager extends JsonReloadListener {\n     public Collection<IGlobalLootModifier> getAllLootMods() {\n         return registeredLootModifiers.values();\n     }\n-\n-    @SubscribeEvent\n-    public static void onResourceReload(AddReloadListenerEvent event)\n-    {\n-        INSTANCE = new LootModifierManager();\n-        event.addListener(INSTANCE);\n-    }\n-\n-    public static LootModifierManager getInstance()\n-    {\n-        if(INSTANCE == null)\n-            throw new IllegalStateException(\"Can not retrieve LootModifierManager until resources have loaded once.\");\n-        return INSTANCE;\n-    }\n }\n"}}, {"oid": "2eb51f8089d330db58173203d9b69e683719400b", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/2eb51f8089d330db58173203d9b69e683719400b", "message": "move LootModifierManager instance, getter & reloader", "committedDate": "2020-06-30T21:08:07Z", "type": "commit"}, {"oid": "c2105ad3ed918f1c368145fa91d5db2add395eec", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/c2105ad3ed918f1c368145fa91d5db2add395eec", "message": "diff", "committedDate": "2020-06-30T21:11:38Z", "type": "commit"}, {"oid": "82a999f1baffbd41eab2beb745c73b25ade45f59", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/82a999f1baffbd41eab2beb745c73b25ade45f59", "message": "ugh", "committedDate": "2020-06-30T21:13:01Z", "type": "commit"}, {"oid": "dac6d23d5fdcf4f15f2dfee44a5a524586ae3814", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/dac6d23d5fdcf4f15f2dfee44a5a524586ae3814", "message": "ugh v2", "committedDate": "2020-06-30T21:13:45Z", "type": "commit"}, {"oid": "63420ca9910314f51df51fe5fb7b237d11df7a90", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/63420ca9910314f51df51fe5fb7b237d11df7a90", "message": "re enable global loot modifiers", "committedDate": "2020-06-30T22:36:52Z", "type": "commit"}]}