{"pr_number": 5814, "pr_title": "[WIP] Initial work on DBMSProcessor batch entry insertion into ENTRY table", "pr_createdAt": "2020-01-02T20:25:30Z", "pr_url": "https://github.com/JabRef/jabref/pull/5814", "timeline": [{"oid": "e701c623ac5b0bdf5c4b63c807e88949fc80024f", "url": "https://github.com/JabRef/jabref/commit/e701c623ac5b0bdf5c4b63c807e88949fc80024f", "message": "Initial work on DBMSProcessor entry insertion into ENTRY table", "committedDate": "2020-01-02T20:22:01Z", "type": "commit"}, {"oid": "a5bfc878ea467cbf34d33ade6d9411b0c9dd7b4b", "url": "https://github.com/JabRef/jabref/commit/a5bfc878ea467cbf34d33ade6d9411b0c9dd7b4b", "message": "Change syntax for Oracle multi-row insert SQL statement", "committedDate": "2020-01-17T15:36:41Z", "type": "commit"}, {"oid": "3027c5415edfab242287bdb8d6908ff8fd9e5544", "url": "https://github.com/JabRef/jabref/commit/3027c5415edfab242287bdb8d6908ff8fd9e5544", "message": "Merge branch 'master' into batch_DBMSProcessor_entries", "committedDate": "2020-01-17T16:25:33Z", "type": "commit"}, {"oid": "ae9d53c93c85d9d5efcca9b05b9c46b422d643c9", "url": "https://github.com/JabRef/jabref/commit/ae9d53c93c85d9d5efcca9b05b9c46b422d643c9", "message": "Run tests also when source files changed", "committedDate": "2020-01-17T18:31:55Z", "type": "commit"}, {"oid": "ed675a2596d181ac17ed1b66976221b31b277687", "url": "https://github.com/JabRef/jabref/commit/ed675a2596d181ac17ed1b66976221b31b277687", "message": "Add to comment about Oracle", "committedDate": "2020-01-21T23:47:18Z", "type": "commit"}, {"oid": "4e80030db9d2e00eef29476e1ee60d8a33ed27ce", "url": "https://github.com/JabRef/jabref/commit/4e80030db9d2e00eef29476e1ee60d8a33ed27ce", "message": "Assume ResultSet is in order for setting shared IDs", "committedDate": "2020-01-22T02:24:00Z", "type": "commit"}, {"oid": "67fdf27e7e318c7a1272ba05e33f6f072d02efc2", "url": "https://github.com/JabRef/jabref/commit/67fdf27e7e318c7a1272ba05e33f6f072d02efc2", "message": "Add insertEntry for DBMSProcessor tests and fix PostgresSQLProcessor", "committedDate": "2020-01-22T15:29:12Z", "type": "commit"}, {"oid": "8aaf774f6fc338f6d2abd5070d553f262dab303a", "url": "https://github.com/JabRef/jabref/commit/8aaf774f6fc338f6d2abd5070d553f262dab303a", "message": "Fix SQL typo", "committedDate": "2020-01-25T18:19:33Z", "type": "commit"}, {"oid": "bbc81abfdd877c83a6c63103dd45a9876419be36", "url": "https://github.com/JabRef/jabref/commit/bbc81abfdd877c83a6c63103dd45a9876419be36", "message": "Separate table drops in Oracle tests", "committedDate": "2020-01-27T15:05:27Z", "type": "commit"}, {"oid": "74ab816b917cd84c46cd7e9bd9b6221518a25b8a", "url": "https://github.com/JabRef/jabref/commit/74ab816b917cd84c46cd7e9bd9b6221518a25b8a", "message": "Merge remote-tracking branch 'fork/fix_fields_sql' into fix_fields_sql", "committedDate": "2020-01-27T15:08:01Z", "type": "commit"}, {"oid": "17de560bb6c1ae4c03956d0f0176872cdb4ab841", "url": "https://github.com/JabRef/jabref/commit/17de560bb6c1ae4c03956d0f0176872cdb4ab841", "message": "Remove CI tests that were added in branch", "committedDate": "2020-01-27T15:10:04Z", "type": "commit"}, {"oid": "5f23e030d920d901a9c51416df58605610880a0f", "url": "https://github.com/JabRef/jabref/commit/5f23e030d920d901a9c51416df58605610880a0f", "message": "Work on unit test for DBMSProcessor insertEntries", "committedDate": "2020-01-30T23:59:35Z", "type": "commit"}, {"oid": "402a9cc0b63b024da6f472a8c7592ac651efed00", "url": "https://github.com/JabRef/jabref/commit/402a9cc0b63b024da6f472a8c7592ac651efed00", "message": "Fix bug in DBMSProcessorTest and simplify DBMSProcessor.FilterForBibEntryExistence", "committedDate": "2020-01-31T19:22:57Z", "type": "commit"}, {"oid": "a37129ac0996d82b8ee3328e8227367f74a7b77b", "url": "https://github.com/JabRef/jabref/commit/a37129ac0996d82b8ee3328e8227367f74a7b77b", "message": "Remove Oracle connection bug with wrong port", "committedDate": "2020-01-31T19:32:06Z", "type": "commit"}, {"oid": "94a75cd36330d6440a997054f2ad91af686b06b9", "url": "https://github.com/JabRef/jabref/commit/94a75cd36330d6440a997054f2ad91af686b06b9", "message": "Add Oracle insertIntoEntryTable", "committedDate": "2020-01-31T19:56:07Z", "type": "commit"}, {"oid": "fbf1d3336fded32fb8ea242b98352f47d4816a6a", "url": "https://github.com/JabRef/jabref/commit/fbf1d3336fded32fb8ea242b98352f47d4816a6a", "message": "Oracle connection fix - taken from fix_fields_sql branch", "committedDate": "2020-01-31T19:59:19Z", "type": "commit"}, {"oid": "dbbfe00163f4e1c8ce7fd2cac104932bb55e4896", "url": "https://github.com/JabRef/jabref/commit/dbbfe00163f4e1c8ce7fd2cac104932bb55e4896", "message": "Fix typo bug", "committedDate": "2020-01-31T20:10:07Z", "type": "commit"}, {"oid": "a5ab4e5d1b6a03a725bea19f648cc54847546b54", "url": "https://github.com/JabRef/jabref/commit/a5ab4e5d1b6a03a725bea19f648cc54847546b54", "message": "Clean up code", "committedDate": "2020-01-31T20:29:37Z", "type": "commit"}, {"oid": "2279464524c883a9454aa5aef22a319c9e44a7b5", "url": "https://github.com/JabRef/jabref/commit/2279464524c883a9454aa5aef22a319c9e44a7b5", "message": "Remove commented blocks", "committedDate": "2020-01-31T20:31:06Z", "type": "commit"}, {"oid": "926473abbc00267b808271add3e7c096c3f41d49", "url": "https://github.com/JabRef/jabref/commit/926473abbc00267b808271add3e7c096c3f41d49", "message": "Remove comment about needing a test that probably isn't necessary", "committedDate": "2020-01-31T20:32:58Z", "type": "commit"}, {"oid": "9d5960fa3fef9b9f53ca23330f402c744fe919ef", "url": "https://github.com/JabRef/jabref/commit/9d5960fa3fef9b9f53ca23330f402c744fe919ef", "message": "Manually merge fix_fields_sql OracleProcessor (just add method)", "committedDate": "2020-01-31T20:36:07Z", "type": "commit"}, {"oid": "a2fcb7787fe02b00f9491a19848dd0b83bd5348c", "url": "https://github.com/JabRef/jabref/commit/a2fcb7787fe02b00f9491a19848dd0b83bd5348c", "message": "Merge fix_fields_sql", "committedDate": "2020-01-31T20:39:24Z", "type": "commit"}, {"oid": "3bdf2d815e362c3353577e060094b182659f2193", "url": "https://github.com/JabRef/jabref/commit/3bdf2d815e362c3353577e060094b182659f2193", "message": "Emphasize todo", "committedDate": "2020-01-31T20:49:46Z", "type": "commit"}, {"oid": "85f9196cfc8bb0b2798a9212474f51790eead777", "url": "https://github.com/JabRef/jabref/commit/85f9196cfc8bb0b2798a9212474f51790eead777", "message": "setSharedID into OracleProcessor entry table method", "committedDate": "2020-02-01T17:50:24Z", "type": "commit"}, {"oid": "245c48e233a53defd1097b1706cf32a17784eb05", "url": "https://github.com/JabRef/jabref/commit/245c48e233a53defd1097b1706cf32a17784eb05", "message": "Add shared id to preparedEntryStatement", "committedDate": "2020-02-02T22:30:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDg0NjE5NQ==", "url": "https://github.com/JabRef/jabref/pull/5814#discussion_r374846195", "bodyText": "I am not sure, but this looks odd to me with the String[]", "author": "Siedlerchr", "createdAt": "2020-02-04T18:30:09Z", "path": "src/main/java/org/jabref/logic/shared/OracleProcessor.java", "diffHunk": "@@ -118,7 +118,8 @@ protected void insertIntoEntryTable(List<BibEntry> entries) {\n             }\n             insertEntryQuery.append(\" SELECT * FROM DUAL\");\n             LOGGER.info(insertEntryQuery.toString());\n-            try (PreparedStatement preparedEntryStatement = connection.prepareStatement(insertEntryQuery.toString())) {\n+            try (PreparedStatement preparedEntryStatement = connection.prepareStatement(insertEntryQuery.toString(),\n+                    new String[]{\"SHARED_ID\"})) {", "originalCommit": "245c48e233a53defd1097b1706cf32a17784eb05", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTI1NDQwMQ==", "url": "https://github.com/JabRef/jabref/pull/5814#discussion_r375254401", "bodyText": "This just indicates the column where we want to put the auto-generated keys. See https://docs.oracle.com/javase/7/docs/api/java/sql/Connection.html#prepareStatement(java.lang.String,%20int[])", "author": "abepolk", "createdAt": "2020-02-05T13:30:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDg0NjE5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTEyMDM4Mg==", "url": "https://github.com/JabRef/jabref/pull/5814#discussion_r379120382", "bodyText": "I looked into Stack Overflow and the Oracle JDBC driver source code and it looks like the Oracle JDBC doesn't support getGeneratedKeys on INSERT ALL statements. So I'll have to find another way of getting the shared IDs.", "author": "abepolk", "createdAt": "2020-02-13T21:11:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDg0NjE5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTE0NDkwMA==", "url": "https://github.com/JabRef/jabref/pull/5814#discussion_r381144900", "bodyText": "OMG. This sounds like we should really drop Oracle support. There is no need for Oracle in 2020, is it? - Postgres is the way to go, isn't it?\nWe should IMHO also drop MySQL support as it does not offer automatic updates on changes on the server.", "author": "koppor", "createdAt": "2020-02-19T08:40:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDg0NjE5NQ=="}], "type": "inlineReview", "revised_code": {"commit": "79d8354fe49ffa91c309706300b791e11f243bd5", "chunk": "diff --git a/src/main/java/org/jabref/logic/shared/OracleProcessor.java b/src/main/java/org/jabref/logic/shared/OracleProcessor.java\nindex f7eb23241..1914496eb 100644\n--- a/src/main/java/org/jabref/logic/shared/OracleProcessor.java\n+++ b/src/main/java/org/jabref/logic/shared/OracleProcessor.java\n\n@@ -106,34 +106,24 @@ public class OracleProcessor extends DBMSProcessor {\n     @Override\n     protected void insertIntoEntryTable(List<BibEntry> entries) {\n         try {\n-            // Inserting into ENTRY table\n-            StringBuilder insertEntryQuery = new StringBuilder()\n-                    .append(\"INSERT ALL\");\n             for (BibEntry entry : entries) {\n-                insertEntryQuery.append(\" INTO \")\n-                                .append(escape(\"ENTRY\"))\n-                                .append(\" (\")\n-                                .append(escape(\"TYPE\"))\n-                                .append(\") VALUES (?)\");\n-            }\n-            insertEntryQuery.append(\" SELECT * FROM DUAL\");\n-            LOGGER.info(insertEntryQuery.toString());\n-            try (PreparedStatement preparedEntryStatement = connection.prepareStatement(insertEntryQuery.toString(),\n-                    new String[]{\"SHARED_ID\"})) {\n-                for (int i = 0; i < entries.size(); i++) {\n-                    // columnIndex starts with 1\n-                    preparedEntryStatement.setString(i + 1, entries.get(i).getType().getName());\n-                }\n-                preparedEntryStatement.executeUpdate();\n-                try (ResultSet generatedKeys = preparedEntryStatement.getGeneratedKeys()) {\n-                    // The following assumes that we get the generated keys in the order the entries were inserted\n-                    // This should be the case\n-                    for (BibEntry entry : entries) {\n-                        generatedKeys.next();\n-                        entry.getSharedBibEntryData().setSharedID(generatedKeys.getInt(1));\n-                    }\n-                    if (generatedKeys.next()) {\n-                        LOGGER.error(\"Error: Some shared IDs left unassigned\");\n+                String insertIntoEntryQuery =\n+                        \"INSERT INTO \" +\n+                                escape(\"ENTRY\") +\n+                                \"(\" +\n+                                escape(\"TYPE\") +\n+                                \") VALUES(?)\";\n+\n+                try (PreparedStatement preparedEntryStatement = connection.prepareStatement(insertIntoEntryQuery,\n+                        new String[]{\"SHARED_ID\"})) {\n+\n+                    preparedEntryStatement.setString(1, entry.getType().getName());\n+                    preparedEntryStatement.executeUpdate();\n+\n+                    try (ResultSet generatedKeys = preparedEntryStatement.getGeneratedKeys()) {\n+                        if (generatedKeys.next()) {\n+                            entry.getSharedBibEntryData().setSharedID(generatedKeys.getInt(1)); // set generated ID locally\n+                        }\n                     }\n                 }\n             }\n"}}, {"oid": "79d8354fe49ffa91c309706300b791e11f243bd5", "url": "https://github.com/JabRef/jabref/commit/79d8354fe49ffa91c309706300b791e11f243bd5", "message": "Make Oracle insertIntoEntryTable iterative - pasted from master - not yet tested", "committedDate": "2020-02-19T15:39:35Z", "type": "commit"}, {"oid": "c31583816fa56c23d1d2caa4efcc2aa33891d047", "url": "https://github.com/JabRef/jabref/commit/c31583816fa56c23d1d2caa4efcc2aa33891d047", "message": "Add fields to fields table in parallel", "committedDate": "2020-02-19T19:00:41Z", "type": "commit"}, {"oid": "c073b8f39d25b782ab906f44211409d5514b2588", "url": "https://github.com/JabRef/jabref/commit/c073b8f39d25b782ab906f44211409d5514b2588", "message": "Merge master", "committedDate": "2020-02-19T19:09:28Z", "type": "commit"}, {"oid": "934acb2091efc4d5fecbe70147421e38da95b3c4", "url": "https://github.com/JabRef/jabref/commit/934acb2091efc4d5fecbe70147421e38da95b3c4", "message": "Reset test trace length", "committedDate": "2020-02-19T19:29:40Z", "type": "commit"}, {"oid": "bd32ecd2e249612211070ac9eae79d1561c7692f", "url": "https://github.com/JabRef/jabref/commit/bd32ecd2e249612211070ac9eae79d1561c7692f", "message": "Fix checkStyle", "committedDate": "2020-02-19T19:51:51Z", "type": "commit"}, {"oid": "99191ff765551ce83d396aa0b1e654ba508940d0", "url": "https://github.com/JabRef/jabref/commit/99191ff765551ce83d396aa0b1e654ba508940d0", "message": "Revert port setting", "committedDate": "2020-02-19T23:56:15Z", "type": "commit"}]}