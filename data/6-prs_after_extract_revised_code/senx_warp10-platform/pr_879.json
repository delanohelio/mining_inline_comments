{"pr_number": 879, "pr_title": "Support dumping file based tokens when custom keys are not in use", "pr_createdAt": "2020-11-26T21:15:05Z", "pr_url": "https://github.com/senx/warp10-platform/pull/879", "timeline": [{"oid": "e3616d6ab99821c1a7f464e064d32c59e4c7f6b3", "url": "https://github.com/senx/warp10-platform/commit/e3616d6ab99821c1a7f464e064d32c59e4c7f6b3", "message": "Modified token decoding when custom keys are not used so file based tokens can be correctly dumped", "committedDate": "2020-11-26T21:14:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTY2ODM2OA==", "url": "https://github.com/senx/warp10-platform/pull/879#discussion_r531668368", "bodyText": "Thus customKeys == multikey. You could replace every use of customKeys by multikey.", "author": "ftence", "createdAt": "2020-11-27T15:41:46Z", "path": "warp10/src/main/java/io/warp10/script/ext/token/TOKENDUMP.java", "diffHunk": "@@ -102,6 +104,7 @@ public Object apply(WarpScriptStack stack) throws WarpScriptException {\n \n       AESKey = (byte[]) top;\n \n+      customKeys = true;", "originalCommit": "e3616d6ab99821c1a7f464e064d32c59e4c7f6b3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "994f9ec811a2b6a42dfceabb8f945bce081a9d17", "chunk": "diff --git a/warp10/src/main/java/io/warp10/script/ext/token/TOKENDUMP.java b/warp10/src/main/java/io/warp10/script/ext/token/TOKENDUMP.java\nindex 25e135c7..8fba5e74 100644\n--- a/warp10/src/main/java/io/warp10/script/ext/token/TOKENDUMP.java\n+++ b/warp10/src/main/java/io/warp10/script/ext/token/TOKENDUMP.java\n\n@@ -104,7 +102,6 @@ public class TOKENDUMP extends NamedWarpScriptFunction implements WarpScriptStac\n \n       AESKey = (byte[]) top;\n \n-      customKeys = true;\n       top = stack.pop();\n     } else {\n       //\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTY2ODQ4Ng==", "url": "https://github.com/senx/warp10-platform/pull/879#discussion_r531668486", "bodyText": "Update copyright notice.", "author": "ftence", "createdAt": "2020-11-27T15:42:00Z", "path": "warp10/src/main/java/io/warp10/script/ext/token/TOKENDUMP.java", "diffHunk": "@@ -85,6 +85,8 @@ public Object apply(WarpScriptStack stack) throws WarpScriptException {\n \n     Object top = null;\n \n+    boolean customKeys = false;", "originalCommit": "e3616d6ab99821c1a7f464e064d32c59e4c7f6b3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "994f9ec811a2b6a42dfceabb8f945bce081a9d17", "chunk": "diff --git a/warp10/src/main/java/io/warp10/script/ext/token/TOKENDUMP.java b/warp10/src/main/java/io/warp10/script/ext/token/TOKENDUMP.java\nindex 25e135c7..8fba5e74 100644\n--- a/warp10/src/main/java/io/warp10/script/ext/token/TOKENDUMP.java\n+++ b/warp10/src/main/java/io/warp10/script/ext/token/TOKENDUMP.java\n\n@@ -85,8 +85,6 @@ public class TOKENDUMP extends NamedWarpScriptFunction implements WarpScriptStac\n \n     Object top = null;\n \n-    boolean customKeys = false;\n-\n     if (this.multikey) {\n       top = stack.pop();\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTY3NTExNg==", "url": "https://github.com/senx/warp10-platform/pull/879#discussion_r531675116", "bodyText": "In case customKeys and thus multikey, decoder is always null so you can replace this block with\nlong[] lkey = SipHashInline.getKey(SipHashKey);\nQuasarTokenDecoder dec = new QuasarTokenDecoder(lkey[0], lkey[1], AESKey);", "author": "ftence", "createdAt": "2020-11-27T15:55:59Z", "path": "warp10/src/main/java/io/warp10/script/ext/token/TOKENDUMP.java", "diffHunk": "@@ -131,22 +134,34 @@ public Object apply(WarpScriptStack stack) throws WarpScriptException {\n     ReadToken rtoken = null;\n     WriteToken wtoken = null;\n \n-    byte[] token = OrderPreservingBase64.decode(tokenstr.getBytes(StandardCharsets.UTF_8));\n+    if (!customKeys) {\n+      try {\n+        rtoken = Tokens.extractReadToken(tokenstr);\n+      } catch (WarpScriptException wse) {\n+        try {\n+          wtoken = Tokens.extractWriteToken(tokenstr);\n+        } catch (Exception e) {\n+          throw new WarpScriptException(getName() + \" invalid token.\", e);\n+        }\n+      }\n+    } else {\n+      byte[] token = OrderPreservingBase64.decode(tokenstr.getBytes(StandardCharsets.UTF_8));\n \n-    QuasarTokenDecoder dec = decoder;\n+      QuasarTokenDecoder dec = decoder;\n \n-    if (null == dec) {\n-      long[] lkey = SipHashInline.getKey(SipHashKey);\n-      dec = new QuasarTokenDecoder(lkey[0], lkey[1], AESKey);\n-    }\n+      if (null == dec) {\n+        long[] lkey = SipHashInline.getKey(SipHashKey);\n+        dec = new QuasarTokenDecoder(lkey[0], lkey[1], AESKey);\n+      }", "originalCommit": "e3616d6ab99821c1a7f464e064d32c59e4c7f6b3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "994f9ec811a2b6a42dfceabb8f945bce081a9d17", "chunk": "diff --git a/warp10/src/main/java/io/warp10/script/ext/token/TOKENDUMP.java b/warp10/src/main/java/io/warp10/script/ext/token/TOKENDUMP.java\nindex 25e135c7..8fba5e74 100644\n--- a/warp10/src/main/java/io/warp10/script/ext/token/TOKENDUMP.java\n+++ b/warp10/src/main/java/io/warp10/script/ext/token/TOKENDUMP.java\n\n@@ -134,7 +131,7 @@ public class TOKENDUMP extends NamedWarpScriptFunction implements WarpScriptStac\n     ReadToken rtoken = null;\n     WriteToken wtoken = null;\n \n-    if (!customKeys) {\n+    if (!this.multikey) {\n       try {\n         rtoken = Tokens.extractReadToken(tokenstr);\n       } catch (WarpScriptException wse) {\n"}}, {"oid": "994f9ec811a2b6a42dfceabb8f945bce081a9d17", "url": "https://github.com/senx/warp10-platform/commit/994f9ec811a2b6a42dfceabb8f945bce081a9d17", "message": "Addressed PR comments", "committedDate": "2020-11-27T21:27:23Z", "type": "commit"}, {"oid": "06f05f142ceb3936eac61f64ccab06a9c2f556f7", "url": "https://github.com/senx/warp10-platform/commit/06f05f142ceb3936eac61f64ccab06a9c2f556f7", "message": "Removed unused decoder", "committedDate": "2020-12-02T15:04:37Z", "type": "commit"}, {"oid": "4723bd4f92ec8c7486ccbef8d28158d2ea61533f", "url": "https://github.com/senx/warp10-platform/commit/4723bd4f92ec8c7486ccbef8d28158d2ea61533f", "message": "Merge pull request #9 from ftence/tokendump.files.nodecoder\n\nRemoved unused decoder", "committedDate": "2020-12-02T15:35:43Z", "type": "commit"}]}