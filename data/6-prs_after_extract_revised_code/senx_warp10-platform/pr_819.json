{"pr_number": 819, "pr_title": "Add RUNR to run macros from registers and make ASREGS use it", "pr_createdAt": "2020-09-01T12:02:25Z", "pr_url": "https://github.com/senx/warp10-platform/pull/819", "timeline": [{"oid": "8ce39fe4b34d98d17cb4314ae5550546013159fa", "url": "https://github.com/senx/warp10-platform/commit/8ce39fe4b34d98d17cb4314ae5550546013159fa", "message": "Add RUNR to run macros from registers and make ASREGS use it", "committedDate": "2020-09-01T11:41:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTc3MDY0MQ==", "url": "https://github.com/senx/warp10-platform/pull/819#discussion_r481770641", "bodyText": "What is the typical case when this option would be used?", "author": "hbs", "createdAt": "2020-09-02T06:15:43Z", "path": "warp10/src/main/java/io/warp10/script/functions/VARS.java", "diffHunk": "@@ -43,32 +43,42 @@ public VARS(String name) {\n   \n   @Override\n   public Object apply(WarpScriptStack stack) throws WarpScriptException {\n-    \n     Object top = stack.pop();\n-    \n+\n+    boolean onlyStoreAndPopr = false;\n+    if (top instanceof Boolean) {\n+      onlyStoreAndPopr = (Boolean) top;\n+      top = stack.pop();\n+    }\n+\n     if (!(top instanceof Macro)) {\n       throw new WarpScriptException(getName() + \" operates on a macro.\");\n     }\n \n     Macro macro = (Macro) top;\n \n     try {\n-      stack.push(getVars(macro));\n+      stack.push(getVars(macro, onlyStoreAndPopr));\n     } catch (WarpScriptException wse) {\n       throw new WarpScriptException(getName() + \" failed.\", wse);\n     }\n \n     return stack;\n   }\n \n+  public static List<Object> getVars(Macro macro) throws WarpScriptException {\n+    return getVars(macro, false);\n+  }\n+\n   /**\n    * Loop over the macro statements, in a recursive manner, extracting all variable names.\n    *\n    * @param macro The root macro to extract the variable names from.\n+   * @param onlyStoreAndPopr Return only variables used for storage.", "originalCommit": "8ce39fe4b34d98d17cb4314ae5550546013159fa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg2NzQ5Mw==", "url": "https://github.com/senx/warp10-platform/pull/819#discussion_r481867493", "bodyText": "As stated in ASREGS\n// If variables are not defined, only get variables and registers used by STORE and POPR\n// to avoid global varaibles.\n\nIf a variable is only used by a LOAD, this must not be converted to a register because it is most certainly a global variable. Converting it to a register will only break the code.", "author": "ftence", "createdAt": "2020-09-02T08:11:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTc3MDY0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg3MDMxOQ==", "url": "https://github.com/senx/warp10-platform/pull/819#discussion_r481870319", "bodyText": "What I meant was that this case should be described next to the parameter in the javadoc for clarity purposes.", "author": "hbs", "createdAt": "2020-09-02T08:14:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTc3MDY0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg3ODcxMQ==", "url": "https://github.com/senx/warp10-platform/pull/819#discussion_r481878711", "bodyText": "Done.", "author": "ftence", "createdAt": "2020-09-02T08:23:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTc3MDY0MQ=="}], "type": "inlineReview", "revised_code": {"commit": "c0251aeaa849fec9b5163156f3203b72f761a390", "chunk": "diff --git a/warp10/src/main/java/io/warp10/script/functions/VARS.java b/warp10/src/main/java/io/warp10/script/functions/VARS.java\nindex 4806ee84..694cfbd3 100644\n--- a/warp10/src/main/java/io/warp10/script/functions/VARS.java\n+++ b/warp10/src/main/java/io/warp10/script/functions/VARS.java\n\n@@ -74,7 +81,7 @@ public class VARS extends NamedWarpScriptFunction implements WarpScriptStackFunc\n    * Loop over the macro statements, in a recursive manner, extracting all variable names.\n    *\n    * @param macro The root macro to extract the variable names from.\n-   * @param onlyStoreAndPopr Return only variables used for storage.\n+   * @param onlyStoreAndPopr Return only variables used for storage. Useful for ASREGS to avoid replacing \"global\" variables.\n    * @return The list of variable names.\n    * @throws WarpScriptException If a STORE call is found to be using neither a String, Long or a list thereof.\n    */\n"}}, {"oid": "69731861409afa6e9478503f9ed7c737894b1181", "url": "https://github.com/senx/warp10-platform/commit/69731861409afa6e9478503f9ed7c737894b1181", "message": "More doc on onlyStoreAndPopr and fix typo", "committedDate": "2020-09-02T08:20:46Z", "type": "commit"}, {"oid": "c0251aeaa849fec9b5163156f3203b72f761a390", "url": "https://github.com/senx/warp10-platform/commit/c0251aeaa849fec9b5163156f3203b72f761a390", "message": "Again more doc on onlyStoreAndPopr", "committedDate": "2020-09-02T08:23:18Z", "type": "commit"}]}