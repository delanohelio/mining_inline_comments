{"pr_number": 814, "pr_title": "Add utility functions to check and set keys in keystore\u2026", "pr_createdAt": "2020-08-05T15:35:36Z", "pr_url": "https://github.com/senx/warp10-platform/pull/814", "timeline": [{"oid": "5296a5ec9f9f893385461419a662bce8c3c35a48", "url": "https://github.com/senx/warp10-platform/commit/5296a5ec9f9f893385461419a662bce8c3c35a48", "message": "Add utility functions to check and set keys in keystore and fix some keystore.forget()", "committedDate": "2020-08-05T15:33:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTgyMjI1Nw==", "url": "https://github.com/senx/warp10-platform/pull/814#discussion_r465822257", "bodyText": "bit -> bits", "author": "hbs", "createdAt": "2020-08-05T15:43:11Z", "path": "crypto/src/main/java/io/warp10/crypto/KeyStore.java", "diffHunk": "@@ -220,4 +224,65 @@\n    * Forget.\n    */\n   public void forget();\n+\n+\n+\n+  /**\n+   * Get a key from the configuration, add, if it exists and if the number of bits of the key is in the given values,\n+   * add it to the key store.\n+   * @param keystore The KeyStore to add the key to.\n+   * @param keyname The key name under which to add the key in the key store.\n+   * @param props The properties from which to get the key.\n+   * @param configurationKey The configuration key holding the key value.\n+   * @param sizeInBits The valid number of bits of the key. Typically 128 or 128, 192, 256.\n+   * @return The key.\n+   */\n+  public static byte[] checkAndSetKey(KeyStore keystore, String keystoreKey, Properties props, String configurationKey, int... sizeInBits) {\n+    return checkAndSetKey(keystore, keystoreKey, props, configurationKey, null, sizeInBits);\n+  }\n+\n+  /**\n+   * Get a key from the configuration, add, if it exists or has a non-null default and if the number of bits of the key\n+   * is in the given values, add it to the key store.\n+   * @param keystore The KeyStore to add the key to.\n+   * @param keyname The key name under which to add the key in the key store.\n+   * @param props The properties from which to get the key.\n+   * @param configurationKey The configuration key holding the key value.\n+   * @param defaultKeyValue The default key in case it is not found in the properties.\n+   * @param sizeInBits The valid number of bits of the key. Typically 128 or 128, 192, 256.\n+   * @return The key.\n+   */\n+  public static byte[] checkAndSetKey(KeyStore keystore, String keyname, Properties props, String configurationKey, String defaultKeyValue, int... sizeInBits) {\n+    String keyspec = props.getProperty(configurationKey, defaultKeyValue);\n+\n+    if (null != keyspec) {\n+      byte[] key = keystore.decodeKey(keyspec);\n+\n+      // Check the size of the key\n+      StringBuilder sizesStr = new StringBuilder();\n+      boolean correctSize = false;\n+      for (int sizeIndex = 0; sizeIndex < sizeInBits.length; sizeIndex++) {\n+        if (sizeInBits[sizeIndex] == key.length * 8) {\n+          correctSize = true;\n+          break;\n+        }\n+\n+        if (sizeIndex > 0) {\n+          if (sizeIndex == sizeInBits.length - 1) {\n+            sizesStr.append(\" or \");\n+          } else {\n+            sizesStr.append(\", \");\n+          }\n+        }\n+        sizesStr.append(sizeInBits[sizeIndex]);\n+      }\n+      Preconditions.checkArgument(correctSize, \"Key %s MUST be %s bit long.\", configurationKey, sizesStr);", "originalCommit": "5296a5ec9f9f893385461419a662bce8c3c35a48", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "58adc2041e6922b307e7e85c6d5ae0cd6b24088d", "chunk": "diff --git a/crypto/src/main/java/io/warp10/crypto/KeyStore.java b/crypto/src/main/java/io/warp10/crypto/KeyStore.java\nindex 5d3f7f6d..4f49e775 100644\n--- a/crypto/src/main/java/io/warp10/crypto/KeyStore.java\n+++ b/crypto/src/main/java/io/warp10/crypto/KeyStore.java\n\n@@ -228,10 +228,10 @@ public interface KeyStore {\n \n \n   /**\n-   * Get a key from the configuration, add, if it exists and if the number of bits of the key is in the given values,\n-   * add it to the key store.\n+   * Get a key from the configuration, and, if it exists and if the number of bits of the key is in the given values,\n+   * add it to the keystore.\n    * @param keystore The KeyStore to add the key to.\n-   * @param keyname The key name under which to add the key in the key store.\n+   * @param keyname The key name under which to add the key in the keystore.\n    * @param props The properties from which to get the key.\n    * @param configurationKey The configuration key holding the key value.\n    * @param sizeInBits The valid number of bits of the key. Typically 128 or 128, 192, 256.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzA5NDg1Nw==", "url": "https://github.com/senx/warp10-platform/pull/814#discussion_r467094857", "bodyText": "extraneous add", "author": "hbs", "createdAt": "2020-08-07T14:58:54Z", "path": "crypto/src/main/java/io/warp10/crypto/KeyStore.java", "diffHunk": "@@ -220,4 +224,65 @@\n    * Forget.\n    */\n   public void forget();\n+\n+\n+\n+  /**\n+   * Get a key from the configuration, add, if it exists and if the number of bits of the key is in the given values,", "originalCommit": "5296a5ec9f9f893385461419a662bce8c3c35a48", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "58adc2041e6922b307e7e85c6d5ae0cd6b24088d", "chunk": "diff --git a/crypto/src/main/java/io/warp10/crypto/KeyStore.java b/crypto/src/main/java/io/warp10/crypto/KeyStore.java\nindex 5d3f7f6d..4f49e775 100644\n--- a/crypto/src/main/java/io/warp10/crypto/KeyStore.java\n+++ b/crypto/src/main/java/io/warp10/crypto/KeyStore.java\n\n@@ -228,10 +228,10 @@ public interface KeyStore {\n \n \n   /**\n-   * Get a key from the configuration, add, if it exists and if the number of bits of the key is in the given values,\n-   * add it to the key store.\n+   * Get a key from the configuration, and, if it exists and if the number of bits of the key is in the given values,\n+   * add it to the keystore.\n    * @param keystore The KeyStore to add the key to.\n-   * @param keyname The key name under which to add the key in the key store.\n+   * @param keyname The key name under which to add the key in the keystore.\n    * @param props The properties from which to get the key.\n    * @param configurationKey The configuration key holding the key value.\n    * @param sizeInBits The valid number of bits of the key. Typically 128 or 128, 192, 256.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzA5NTA0Mw==", "url": "https://github.com/senx/warp10-platform/pull/814#discussion_r467095043", "bodyText": "keystore", "author": "hbs", "createdAt": "2020-08-07T14:59:14Z", "path": "crypto/src/main/java/io/warp10/crypto/KeyStore.java", "diffHunk": "@@ -220,4 +224,65 @@\n    * Forget.\n    */\n   public void forget();\n+\n+\n+\n+  /**\n+   * Get a key from the configuration, add, if it exists and if the number of bits of the key is in the given values,\n+   * add it to the key store.\n+   * @param keystore The KeyStore to add the key to.\n+   * @param keyname The key name under which to add the key in the key store.", "originalCommit": "5296a5ec9f9f893385461419a662bce8c3c35a48", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "58adc2041e6922b307e7e85c6d5ae0cd6b24088d", "chunk": "diff --git a/crypto/src/main/java/io/warp10/crypto/KeyStore.java b/crypto/src/main/java/io/warp10/crypto/KeyStore.java\nindex 5d3f7f6d..4f49e775 100644\n--- a/crypto/src/main/java/io/warp10/crypto/KeyStore.java\n+++ b/crypto/src/main/java/io/warp10/crypto/KeyStore.java\n\n@@ -228,10 +228,10 @@ public interface KeyStore {\n \n \n   /**\n-   * Get a key from the configuration, add, if it exists and if the number of bits of the key is in the given values,\n-   * add it to the key store.\n+   * Get a key from the configuration, and, if it exists and if the number of bits of the key is in the given values,\n+   * add it to the keystore.\n    * @param keystore The KeyStore to add the key to.\n-   * @param keyname The key name under which to add the key in the key store.\n+   * @param keyname The key name under which to add the key in the keystore.\n    * @param props The properties from which to get the key.\n    * @param configurationKey The configuration key holding the key value.\n    * @param sizeInBits The valid number of bits of the key. Typically 128 or 128, 192, 256.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzA5NTU4NA==", "url": "https://github.com/senx/warp10-platform/pull/814#discussion_r467095584", "bodyText": "extraneous add", "author": "hbs", "createdAt": "2020-08-07T15:00:06Z", "path": "crypto/src/main/java/io/warp10/crypto/KeyStore.java", "diffHunk": "@@ -220,4 +224,65 @@\n    * Forget.\n    */\n   public void forget();\n+\n+\n+\n+  /**\n+   * Get a key from the configuration, add, if it exists and if the number of bits of the key is in the given values,\n+   * add it to the key store.\n+   * @param keystore The KeyStore to add the key to.\n+   * @param keyname The key name under which to add the key in the key store.\n+   * @param props The properties from which to get the key.\n+   * @param configurationKey The configuration key holding the key value.\n+   * @param sizeInBits The valid number of bits of the key. Typically 128 or 128, 192, 256.\n+   * @return The key.\n+   */\n+  public static byte[] checkAndSetKey(KeyStore keystore, String keystoreKey, Properties props, String configurationKey, int... sizeInBits) {\n+    return checkAndSetKey(keystore, keystoreKey, props, configurationKey, null, sizeInBits);\n+  }\n+\n+  /**\n+   * Get a key from the configuration, add, if it exists or has a non-null default and if the number of bits of the key", "originalCommit": "5296a5ec9f9f893385461419a662bce8c3c35a48", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "58adc2041e6922b307e7e85c6d5ae0cd6b24088d", "chunk": "diff --git a/crypto/src/main/java/io/warp10/crypto/KeyStore.java b/crypto/src/main/java/io/warp10/crypto/KeyStore.java\nindex 5d3f7f6d..4f49e775 100644\n--- a/crypto/src/main/java/io/warp10/crypto/KeyStore.java\n+++ b/crypto/src/main/java/io/warp10/crypto/KeyStore.java\n\n@@ -228,10 +228,10 @@ public interface KeyStore {\n \n \n   /**\n-   * Get a key from the configuration, add, if it exists and if the number of bits of the key is in the given values,\n-   * add it to the key store.\n+   * Get a key from the configuration, and, if it exists and if the number of bits of the key is in the given values,\n+   * add it to the keystore.\n    * @param keystore The KeyStore to add the key to.\n-   * @param keyname The key name under which to add the key in the key store.\n+   * @param keyname The key name under which to add the key in the keystore.\n    * @param props The properties from which to get the key.\n    * @param configurationKey The configuration key holding the key value.\n    * @param sizeInBits The valid number of bits of the key. Typically 128 or 128, 192, 256.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTk0NTI2Ng==", "url": "https://github.com/senx/warp10-platform/pull/814#discussion_r479945266", "bodyText": "Incorrect parameters.", "author": "hbs", "createdAt": "2020-08-31T07:25:38Z", "path": "warp10/src/main/java/io/warp10/WarpDist.java", "diffHunk": "@@ -345,4 +307,19 @@ public static boolean isEgress() {\n   public static void setEgress(boolean egress) {\n     hasEgress = egress;\n   }\n+\n+  public static void extractKeys(KeyStore keystore, Properties properties) {\n+    KeyStore.checkAndSetKey(keystore, KeyStore.SIPHASH_CLASS, properties, Configuration.WARP_HASH_CLASS, 128);\n+    KeyStore.checkAndSetKey(keystore, KeyStore.SIPHASH_LABELS, properties, Configuration.WARP_HASH_LABELS, 128);\n+    KeyStore.checkAndSetKey(keystore, KeyStore.SIPHASH_TOKEN, properties, Configuration.WARP_HASH_TOKEN, 128);\n+    KeyStore.checkAndSetKey(keystore, KeyStore.SIPHASH_APPID, properties, Configuration.WARP_HASH_APP, 128);\n+    KeyStore.checkAndSetKey(keystore, KeyStore.AES_TOKEN, properties, Configuration.WARP_AES_TOKEN, 128, 192, 256);\n+    KeyStore.checkAndSetKey(keystore, KeyStore.AES_SECURESCRIPTS, properties, Configuration.WARP_AES_SCRIPTS, 128, 192, 256);\n+    KeyStore.checkAndSetKey(keystore, KeyStore.AES_METASETS, properties, Configuration.WARP_AES_METASETS, 128, 192, 256);\n+    KeyStore.checkAndSetKey(keystore, KeyStore.SIPHASH_CLASS, properties, Configuration.WARP_HASH_CLASS, Configuration.WARP_DEFAULT_AES_LOGGING, 128, 192, 256);", "originalCommit": "5296a5ec9f9f893385461419a662bce8c3c35a48", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDA4MjI0Nw==", "url": "https://github.com/senx/warp10-platform/pull/814#discussion_r480082247", "bodyText": "Nice catch. I went again through the changes and it's now highly unlikely that there is another error of this kind.", "author": "ftence", "createdAt": "2020-08-31T11:59:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTk0NTI2Ng=="}], "type": "inlineReview", "revised_code": {"commit": "58adc2041e6922b307e7e85c6d5ae0cd6b24088d", "chunk": "diff --git a/warp10/src/main/java/io/warp10/WarpDist.java b/warp10/src/main/java/io/warp10/WarpDist.java\nindex a95fa97a..ade87daf 100644\n--- a/warp10/src/main/java/io/warp10/WarpDist.java\n+++ b/warp10/src/main/java/io/warp10/WarpDist.java\n\n@@ -316,7 +316,7 @@ public class WarpDist {\n     KeyStore.checkAndSetKey(keystore, KeyStore.AES_TOKEN, properties, Configuration.WARP_AES_TOKEN, 128, 192, 256);\n     KeyStore.checkAndSetKey(keystore, KeyStore.AES_SECURESCRIPTS, properties, Configuration.WARP_AES_SCRIPTS, 128, 192, 256);\n     KeyStore.checkAndSetKey(keystore, KeyStore.AES_METASETS, properties, Configuration.WARP_AES_METASETS, 128, 192, 256);\n-    KeyStore.checkAndSetKey(keystore, KeyStore.SIPHASH_CLASS, properties, Configuration.WARP_HASH_CLASS, Configuration.WARP_DEFAULT_AES_LOGGING, 128, 192, 256);\n+    KeyStore.checkAndSetKey(keystore, KeyStore.AES_LOGGING, properties, Configuration.WARP_AES_LOGGING, Configuration.WARP_DEFAULT_AES_LOGGING, 128, 192, 256);\n \n     // Generate secondary keys. We use the ones' complement of the primary keys\n     keystore.setKey(KeyStore.SIPHASH_CLASS_SECONDARY, CryptoUtils.invert(keystore.getKey(KeyStore.SIPHASH_CLASS)));\n"}}, {"oid": "58adc2041e6922b307e7e85c6d5ae0cd6b24088d", "url": "https://github.com/senx/warp10-platform/commit/58adc2041e6922b307e7e85c6d5ae0cd6b24088d", "message": "Fix checkAndSetKey parameters and typos", "committedDate": "2020-08-31T09:39:40Z", "type": "commit"}]}