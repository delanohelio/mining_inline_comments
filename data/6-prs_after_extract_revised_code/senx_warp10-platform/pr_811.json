{"pr_number": 811, "pr_title": "Make REMOVE work on GTS using point index", "pr_createdAt": "2020-07-31T15:12:21Z", "pr_url": "https://github.com/senx/warp10-platform/pull/811", "timeline": [{"oid": "b3e35eedf32c681d9c2b2cfc70aadd27fac88248", "url": "https://github.com/senx/warp10-platform/commit/b3e35eedf32c681d9c2b2cfc70aadd27fac88248", "message": "Make REMOVE work on GTS using point index", "committedDate": "2020-07-31T15:11:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzY3MDU3Mw==", "url": "https://github.com/senx/warp10-platform/pull/811#discussion_r463670573", "bodyText": "Update copyright notice", "author": "hbs", "createdAt": "2020-07-31T15:14:06Z", "path": "warp10/src/main/java/io/warp10/script/functions/REMOVE.java", "diffHunk": "@@ -16,6 +16,8 @@\n \n package io.warp10.script.functions;\n \n+import io.warp10.continuum.gts.GTSHelper;", "originalCommit": "b3e35eedf32c681d9c2b2cfc70aadd27fac88248", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f2faa48b1d3c9b6da57205b30e88daf10674df9f", "chunk": "diff --git a/warp10/src/main/java/io/warp10/script/functions/REMOVE.java b/warp10/src/main/java/io/warp10/script/functions/REMOVE.java\nindex a8fc93b7..2687a3a6 100644\n--- a/warp10/src/main/java/io/warp10/script/functions/REMOVE.java\n+++ b/warp10/src/main/java/io/warp10/script/functions/REMOVE.java\n\n@@ -23,11 +23,12 @@ import io.warp10.script.WarpScriptStackFunction;\n import io.warp10.script.WarpScriptException;\n import io.warp10.script.WarpScriptStack;\n \n+import java.util.ArrayList;\n import java.util.List;\n import java.util.Map;\n \n /**\n- * Remove an entry from a map or from a list\n+ * Remove an entry from a map, a list or a GTS.\n  */\n public class REMOVE extends NamedWarpScriptFunction implements WarpScriptStackFunction {\n   \n"}}, {"oid": "f7d80d723ecf1e4c916cbad8f862bb339c901669", "url": "https://github.com/senx/warp10-platform/commit/f7d80d723ecf1e4c916cbad8f862bb339c901669", "message": "Update copyright notice and comment", "committedDate": "2020-08-03T08:26:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDI3MDQ2MQ==", "url": "https://github.com/senx/warp10-platform/pull/811#discussion_r464270461", "bodyText": "Shouldn't REMOVE behave similarly on a GTS as it does on a list or map? i.e. leave on the stack the data point tuple it just removed? With [ 0 NaN NaN NaN NULL ] if the datapoint did not exist?", "author": "hbs", "createdAt": "2020-08-03T08:34:50Z", "path": "warp10/src/main/java/io/warp10/script/functions/REMOVE.java", "diffHunk": "@@ -67,8 +69,33 @@ public Object apply(WarpScriptStack stack) throws WarpScriptException {\n       \n       stack.push(coll);\n       stack.push(o);\n+    } else if (coll instanceof GeoTimeSerie) {\n+      if (!(key instanceof Long) && !(key instanceof Integer)) {\n+        throw new WarpScriptException(getName() + \" expects an integer as key.\");\n+      }\n+      int idx = ((Number) key).intValue();\n+\n+      GeoTimeSerie gts = (GeoTimeSerie) coll;\n+\n+      int n = GTSHelper.nvalues(gts);\n+\n+      if (idx < 0) {\n+        idx += n;\n+      }\n+\n+      GeoTimeSerie pruned = gts.cloneEmpty(n);\n+\n+      for (int i = 0; i < n; i++) {\n+        if (i == idx) {\n+          continue;\n+        }\n+\n+        GTSHelper.setValue(pruned, GTSHelper.tickAtIndex(gts, i), GTSHelper.locationAtIndex(gts, i), GTSHelper.elevationAtIndex(gts, i), GTSHelper.valueAtIndex(gts, i), false);\n+      }\n+\n+      stack.push(pruned);", "originalCommit": "f7d80d723ecf1e4c916cbad8f862bb339c901669", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDI3MTc2OQ==", "url": "https://github.com/senx/warp10-platform/pull/811#discussion_r464271769", "bodyText": "You're right, fixing this.", "author": "ftence", "createdAt": "2020-08-03T08:37:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDI3MDQ2MQ=="}], "type": "inlineReview", "revised_code": {"commit": "f2faa48b1d3c9b6da57205b30e88daf10674df9f", "chunk": "diff --git a/warp10/src/main/java/io/warp10/script/functions/REMOVE.java b/warp10/src/main/java/io/warp10/script/functions/REMOVE.java\nindex 06f310fc..2687a3a6 100644\n--- a/warp10/src/main/java/io/warp10/script/functions/REMOVE.java\n+++ b/warp10/src/main/java/io/warp10/script/functions/REMOVE.java\n\n@@ -79,21 +80,30 @@ public class REMOVE extends NamedWarpScriptFunction implements WarpScriptStackFu\n \n       int n = GTSHelper.nvalues(gts);\n \n+      // Handle negative indexing.\n       if (idx < 0) {\n         idx += n;\n       }\n \n-      GeoTimeSerie pruned = gts.cloneEmpty(n);\n-\n-      for (int i = 0; i < n; i++) {\n-        if (i == idx) {\n-          continue;\n+      // If the requested index is outside the valid range, just push a clone of the GTS.\n+      if (idx < 0 || idx >= n) {\n+        stack.push(gts.clone());\n+      } else {\n+        // The point is inside the valid range, copy all but the point at index and push the copy.\n+        GeoTimeSerie pruned = gts.cloneEmpty(n - 1);\n+\n+        for (int i = 0; i < n; i++) {\n+          if (i == idx) {\n+            continue;\n+          }\n+          GTSHelper.setValue(pruned, GTSHelper.tickAtIndex(gts, i), GTSHelper.locationAtIndex(gts, i), GTSHelper.elevationAtIndex(gts, i), GTSHelper.valueAtIndex(gts, i), false);\n         }\n \n-        GTSHelper.setValue(pruned, GTSHelper.tickAtIndex(gts, i), GTSHelper.locationAtIndex(gts, i), GTSHelper.elevationAtIndex(gts, i), GTSHelper.valueAtIndex(gts, i), false);\n+        stack.push(pruned);\n       }\n \n-      stack.push(pruned);\n+      // Push the removed datapoint.\n+      stack.push(ATINDEX.getTupleAtIndex(gts, idx));\n     } else {\n       throw new WarpScriptException(getName() + \" operates on a map, a list or a GTS.\");\n     }\n"}}, {"oid": "f2faa48b1d3c9b6da57205b30e88daf10674df9f", "url": "https://github.com/senx/warp10-platform/commit/f2faa48b1d3c9b6da57205b30e88daf10674df9f", "message": "Also push removed point and some optimization", "committedDate": "2020-08-03T08:59:49Z", "type": "commit"}]}