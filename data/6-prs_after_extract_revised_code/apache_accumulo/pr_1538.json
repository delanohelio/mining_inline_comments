{"pr_number": 1538, "pr_title": "Fix DatafileManager MajC for empty files. Closes #1535", "pr_createdAt": "2020-02-28T19:25:09Z", "pr_url": "https://github.com/apache/accumulo/pull/1538", "timeline": [{"oid": "0e2fdea5dc19cda2577950ee29ebaadc9423a42b", "url": "https://github.com/apache/accumulo/commit/0e2fdea5dc19cda2577950ee29ebaadc9423a42b", "message": "Fix DatafileManager MajC for empty files. Closes #1535\n\n* Don't rename the file if it is empty\n* Don't add the file to the list of files if it is empty", "committedDate": "2020-02-28T19:22:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTkzNDAyOA==", "url": "https://github.com/apache/accumulo/pull/1538#discussion_r385934028", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  tablet.getTabletServer().getFileSystem().deleteRecursively(newDatafile.getPath());\n          \n          \n            \n                  tablet.getTabletServer().getFileSystem().deleteRecursively(tmpDatafile.getPath());", "author": "keith-turner", "createdAt": "2020-02-28T21:37:37Z", "path": "server/tserver/src/main/java/org/apache/accumulo/tserver/tablet/DatafileManager.java", "diffHunk": "@@ -500,12 +500,13 @@ StoredTabletFile bringMajorCompactionOnline(Set<StoredTabletFile> oldDatafiles,\n       throw new IllegalStateException(\"Target map file already exist \" + newDatafile);\n     }\n \n-    // rename before putting in metadata table, so files in metadata table should\n-    // always exist\n-    rename(tablet.getTabletServer().getFileSystem(), tmpDatafile.getPath(), newDatafile.getPath());\n-\n     if (dfv.getNumEntries() == 0) {\n       tablet.getTabletServer().getFileSystem().deleteRecursively(newDatafile.getPath());", "originalCommit": "0e2fdea5dc19cda2577950ee29ebaadc9423a42b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "23e56fdb7ca142bd9519c08b404b6d94ecca2659", "chunk": "diff --git a/server/tserver/src/main/java/org/apache/accumulo/tserver/tablet/DatafileManager.java b/server/tserver/src/main/java/org/apache/accumulo/tserver/tablet/DatafileManager.java\nindex b446db0267..776b99a9c4 100644\n--- a/server/tserver/src/main/java/org/apache/accumulo/tserver/tablet/DatafileManager.java\n+++ b/server/tserver/src/main/java/org/apache/accumulo/tserver/tablet/DatafileManager.java\n\n@@ -501,7 +501,7 @@ class DatafileManager {\n     }\n \n     if (dfv.getNumEntries() == 0) {\n-      tablet.getTabletServer().getFileSystem().deleteRecursively(newDatafile.getPath());\n+      tablet.getTabletServer().getFileSystem().deleteRecursively(tmpDatafile.getPath());\n     } else {\n       // rename before putting in metadata table, so files in metadata table should\n       // always exist\n"}}, {"oid": "23e56fdb7ca142bd9519c08b404b6d94ecca2659", "url": "https://github.com/apache/accumulo/commit/23e56fdb7ca142bd9519c08b404b6d94ecca2659", "message": "Update server/tserver/src/main/java/org/apache/accumulo/tserver/tablet/DatafileManager.java\n\nCo-Authored-By: Keith Turner <kturner@apache.org>", "committedDate": "2020-03-02T13:18:57Z", "type": "commit"}]}