{"pr_number": 1572, "pr_title": "Refactor use of ServerConfigurationFactory", "pr_createdAt": "2020-03-26T14:14:22Z", "pr_url": "https://github.com/apache/accumulo/pull/1572", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODYwNjk5Nw==", "url": "https://github.com/apache/accumulo/pull/1572#discussion_r398606997", "bodyText": "Method was never used.", "author": "milleruntime", "createdAt": "2020-03-26T14:16:50Z", "path": "server/base/src/main/java/org/apache/accumulo/server/conf/TableConfiguration.java", "diffHunk": "@@ -140,13 +140,6 @@ public TableId getTableId() {\n     return tableId;\n   }\n \n-  /**\n-   * returns the actual NamespaceConfiguration that corresponds to the current parent namespace.\n-   */\n-  public NamespaceConfiguration getNamespaceConfiguration() {\n-    return context.getServerConfFactory().getNamespaceConfiguration(parent.namespaceId);\n-  }\n-", "originalCommit": "48bd7946a89508b6fc5c87e510d30d61887fa3cf", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY3MzkxOA==", "url": "https://github.com/apache/accumulo/pull/1572#discussion_r398673918", "bodyText": "Another option for this update would be to call the new init method:\ninit(((ServerConfigurationFactory) conf).getServerContext());\nBut I put the exception to prevent calling this in Accumulo.  If a user extends this class, I don't think they should be calling this method.  The init currently gets called in TabletServerResourceManager here.", "author": "milleruntime", "createdAt": "2020-03-26T15:40:49Z", "path": "server/base/src/main/java/org/apache/accumulo/server/tabletserver/LargestFirstMemoryManager.java", "diffHunk": "@@ -121,18 +122,16 @@ public void remove(Long key) {\n     }\n   }\n \n-  LargestFirstMemoryManager(long maxMemory, int maxConcurrentMincs, int numWaitingMultiplier) {\n-    this();\n-    this.maxMemory = maxMemory;\n-    this.maxConcurrentMincs = maxConcurrentMincs;\n-    this.numWaitingMultiplier = numWaitingMultiplier;\n+  @Override\n+  public void init(ServerConfiguration conf) {\n+    throw new IllegalStateException(\"Deprecated method, no longer should be used.\");", "originalCommit": "efb503ac50fe6b0a424006f3449316d755313d9b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTAyNDM5MA==", "url": "https://github.com/apache/accumulo/pull/1572#discussion_r399024390", "bodyText": "Rather than override it or call the other method (which won't do anything, since we never call the deprecated one in the tserver), you could make it a deprecated default method in the interface that throws the exception. The exception message, as well as the deprecation message can say that it is scheduled for removal in 3.0.0. Since default methods don't need to be overridden, people can safely delete their current implementation to prepare for its eventual removal.\nHowever, I'm not sure the replacement accepting a ServerContext is any safer. It's still a leak of an internal type (ServerContext) that is subject to change, into what is effectively SPI. We should probably have some other specific MemoryManagerEnvironment type for this.", "author": "ctubbsii", "createdAt": "2020-03-27T04:07:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY3MzkxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI1Mjg4MQ==", "url": "https://github.com/apache/accumulo/pull/1572#discussion_r399252881", "bodyText": "I like throwing an exception on the default implementation, not sure why I didn't just do that.\nSounds like this interface might be a good candidate to move to the SPI since it deals more with performance and not user data.", "author": "milleruntime", "createdAt": "2020-03-27T13:12:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY3MzkxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ1NDMyOA==", "url": "https://github.com/apache/accumulo/pull/1572#discussion_r399454328", "bodyText": "I made the change in 1824acd but I made the new method not have a default impl.  My thinking was that since we won't have a way to make them backward compatible, it would be better to error during compilation than runtime in the tserver.", "author": "milleruntime", "createdAt": "2020-03-27T18:14:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY3MzkxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ1NTE1MA==", "url": "https://github.com/apache/accumulo/pull/1572#discussion_r399455150", "bodyText": "Also, I could make the MemoryManager change in a separate PR, since its the only contentious change here.", "author": "milleruntime", "createdAt": "2020-03-27T18:15:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY3MzkxOA=="}], "type": "inlineReview", "revised_code": {"commit": "e23a904f0ffc85c1a41e40e4d4c118e4c2ed74e9", "chunk": "diff --git a/server/base/src/main/java/org/apache/accumulo/server/tabletserver/LargestFirstMemoryManager.java b/server/base/src/main/java/org/apache/accumulo/server/tabletserver/LargestFirstMemoryManager.java\nindex b7497be8f4..dedc4a6c81 100644\n--- a/server/base/src/main/java/org/apache/accumulo/server/tabletserver/LargestFirstMemoryManager.java\n+++ b/server/base/src/main/java/org/apache/accumulo/server/tabletserver/LargestFirstMemoryManager.java\n\n@@ -124,14 +123,9 @@ public class LargestFirstMemoryManager implements MemoryManager {\n \n   @Override\n   public void init(ServerConfiguration conf) {\n-    throw new IllegalStateException(\"Deprecated method, no longer should be used.\");\n-  }\n-\n-  @Override\n-  public void init(ServerContext context) {\n-    this.context = context;\n-    maxMemory = context.getConfiguration().getAsBytes(Property.TSERV_MAXMEM);\n-    maxConcurrentMincs = context.getConfiguration().getCount(Property.TSERV_MINC_MAXCONCURRENT);\n+    this.config = conf;\n+    maxMemory = conf.getSystemConfiguration().getAsBytes(Property.TSERV_MAXMEM);\n+    maxConcurrentMincs = conf.getSystemConfiguration().getCount(Property.TSERV_MINC_MAXCONCURRENT);\n     numWaitingMultiplier = TSERV_MINC_MAXCONCURRENT_NUMWAITING_MULTIPLIER;\n   }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ0OTQ1Nw==", "url": "https://github.com/apache/accumulo/pull/1572#discussion_r399449457", "bodyText": "I don't think there's any reason to load this singleton lazily.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (defaultConfig == null) {\n          \n          \n            \n                  defaultConfig = DefaultConfiguration.getInstance();\n          \n          \n            \n                }\n          \n          \n            \n                return defaultConfig;\n          \n          \n            \n                return DefaultConfiguration.getInstance();", "author": "ctubbsii", "createdAt": "2020-03-27T18:05:41Z", "path": "server/base/src/main/java/org/apache/accumulo/server/ServerContext.java", "diffHunk": "@@ -112,7 +125,26 @@ public synchronized ServerConfigurationFactory getServerConfFactory() {\n \n   @Override\n   public AccumuloConfiguration getConfiguration() {\n-    return getServerConfFactory().getSystemConfiguration();\n+    if (systemConfig == null) {\n+      ZooCache propCache = new ZooCache(getZooKeepers(), getZooKeepersSessionTimeOut());\n+      systemConfig = new ZooConfiguration(this, propCache, getSiteConfiguration());\n+    }\n+    return systemConfig;\n+  }\n+\n+  public TableConfiguration getTableConfiguration(TableId id) {\n+    return getServerConfFactory().getTableConfiguration(id);\n+  }\n+\n+  public NamespaceConfiguration getNamespaceConfiguration(NamespaceId namespaceId) {\n+    return getServerConfFactory().getNamespaceConfiguration(namespaceId);\n+  }\n+\n+  public DefaultConfiguration getDefaultConfiguration() {\n+    if (defaultConfig == null) {\n+      defaultConfig = DefaultConfiguration.getInstance();\n+    }\n+    return defaultConfig;", "originalCommit": "1824acdfed11fd8d8aebc3d09e3c752470dc7833", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ2OTI1OQ==", "url": "https://github.com/apache/accumulo/pull/1572#discussion_r399469259", "bodyText": "Perhaps this method is poorly named because it just returns a new object:\npublic static DefaultConfiguration getInstance() {\n    return new DefaultConfiguration();\n  }\n\nI think it is worth storing a local copy to prevent creating too many identical objects.", "author": "milleruntime", "createdAt": "2020-03-27T18:41:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ0OTQ1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU0MjIxOQ==", "url": "https://github.com/apache/accumulo/pull/1572#discussion_r399542219", "bodyText": "The class is documented as a singleton... but that appears to have stopped being the case as of 37f900b ; it should be a singleton. It doesn't need to do all the synchronization that the commit cleaned up, but it should still save and reuse the single instance.", "author": "ctubbsii", "createdAt": "2020-03-27T21:17:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ0OTQ1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU0NzI5NA==", "url": "https://github.com/apache/accumulo/pull/1572#discussion_r399547294", "bodyText": "Yeah and since it anything loading the class will use it, I think it could just be created once during class load as a static variable.", "author": "milleruntime", "createdAt": "2020-03-27T21:30:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ0OTQ1Nw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ1ODYwOA==", "url": "https://github.com/apache/accumulo/pull/1572#discussion_r399458608", "bodyText": "I'd add the note about scheduled for removal in this javadoc tag also.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               * @deprecated since 2.1 use {@link #init(ServerContext)}\n          \n          \n            \n               * @deprecated since 2.1 use {@link #init(ServerContext)}; to be removed in 3.0.0", "author": "ctubbsii", "createdAt": "2020-03-27T18:22:03Z", "path": "server/base/src/main/java/org/apache/accumulo/server/tabletserver/MemoryManager.java", "diffHunk": "@@ -32,8 +33,22 @@\n \n   /**\n    * Initialize the memory manager.\n+   *\n+   * @deprecated since 2.1 use {@link #init(ServerContext)}", "originalCommit": "1824acdfed11fd8d8aebc3d09e3c752470dc7833", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e23a904f0ffc85c1a41e40e4d4c118e4c2ed74e9", "chunk": "diff --git a/server/base/src/main/java/org/apache/accumulo/server/tabletserver/MemoryManager.java b/server/base/src/main/java/org/apache/accumulo/server/tabletserver/MemoryManager.java\nindex ceecae9243..8d3c06bbcf 100644\n--- a/server/base/src/main/java/org/apache/accumulo/server/tabletserver/MemoryManager.java\n+++ b/server/base/src/main/java/org/apache/accumulo/server/tabletserver/MemoryManager.java\n\n@@ -33,22 +32,8 @@ public interface MemoryManager {\n \n   /**\n    * Initialize the memory manager.\n-   *\n-   * @deprecated since 2.1 use {@link #init(ServerContext)}\n-   */\n-  @Deprecated\n-  default void init(ServerConfiguration conf) {\n-    throw new IllegalStateException(\"Deprecated method scheduled for removal in 3.0.0\");\n-  }\n-\n-  /**\n-   * Initialize the memory manager.\n-   *\n-   * @param context\n-   *          ServerContext passed from the Tablet server\n-   * @since 2.1\n    */\n-  void init(ServerContext context);\n+  void init(ServerConfiguration conf);\n \n   /**\n    * An implementation of this function will be called periodically by accumulo and should return a\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ1OTY0Nw==", "url": "https://github.com/apache/accumulo/pull/1572#discussion_r399459647", "bodyText": "My only concern with this is that context is not public API any more than ServerConfiguration was. The object has already changed from a ServerConfiguration object to a ServerConfigurationFactory object (which implemented ServerConfiguration, just to make this API happy), and now ServerContext.\nWhile it's unlikely that too many people have implemented their own MemoryManager, it is configurable, and this churn in the API isn't good for implementers. I think it would be cool if we could follow up on this PR with one that promotes this interface to SPI, and uses a stable MemoryManagerEnvironment object to inject here in place of the internal ServerContext.", "author": "ctubbsii", "createdAt": "2020-03-27T18:23:49Z", "path": "server/base/src/main/java/org/apache/accumulo/server/tabletserver/MemoryManager.java", "diffHunk": "@@ -32,8 +33,22 @@\n \n   /**\n    * Initialize the memory manager.\n+   *\n+   * @deprecated since 2.1 use {@link #init(ServerContext)}\n+   */\n+  @Deprecated\n+  default void init(ServerConfiguration conf) {\n+    throw new IllegalStateException(\"Deprecated method scheduled for removal in 3.0.0\");\n+  }\n+\n+  /**\n+   * Initialize the memory manager.\n+   *\n+   * @param context\n+   *          ServerContext passed from the Tablet server\n+   * @since 2.1\n    */\n-  void init(ServerConfiguration conf);\n+  void init(ServerContext context);", "originalCommit": "1824acdfed11fd8d8aebc3d09e3c752470dc7833", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ3MDU1Nw==", "url": "https://github.com/apache/accumulo/pull/1572#discussion_r399470557", "bodyText": "I will back out the changes to MemoryManager (which won't be hard since I separated the commits) for something better in another PR.", "author": "milleruntime", "createdAt": "2020-03-27T18:44:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ1OTY0Nw=="}], "type": "inlineReview", "revised_code": {"commit": "e23a904f0ffc85c1a41e40e4d4c118e4c2ed74e9", "chunk": "diff --git a/server/base/src/main/java/org/apache/accumulo/server/tabletserver/MemoryManager.java b/server/base/src/main/java/org/apache/accumulo/server/tabletserver/MemoryManager.java\nindex ceecae9243..8d3c06bbcf 100644\n--- a/server/base/src/main/java/org/apache/accumulo/server/tabletserver/MemoryManager.java\n+++ b/server/base/src/main/java/org/apache/accumulo/server/tabletserver/MemoryManager.java\n\n@@ -33,22 +32,8 @@ public interface MemoryManager {\n \n   /**\n    * Initialize the memory manager.\n-   *\n-   * @deprecated since 2.1 use {@link #init(ServerContext)}\n-   */\n-  @Deprecated\n-  default void init(ServerConfiguration conf) {\n-    throw new IllegalStateException(\"Deprecated method scheduled for removal in 3.0.0\");\n-  }\n-\n-  /**\n-   * Initialize the memory manager.\n-   *\n-   * @param context\n-   *          ServerContext passed from the Tablet server\n-   * @since 2.1\n    */\n-  void init(ServerContext context);\n+  void init(ServerConfiguration conf);\n \n   /**\n    * An implementation of this function will be called periodically by accumulo and should return a\n"}}, {"oid": "e23a904f0ffc85c1a41e40e4d4c118e4c2ed74e9", "url": "https://github.com/apache/accumulo/commit/e23a904f0ffc85c1a41e40e4d4c118e4c2ed74e9", "message": "Minimize calls to ServerConfFactory by inlining methods in ServerContext", "committedDate": "2020-03-27T19:42:07Z", "type": "commit"}, {"oid": "7f95bc5e65fdbea41b7889b79672d3106e50b896", "url": "https://github.com/apache/accumulo/commit/7f95bc5e65fdbea41b7889b79672d3106e50b896", "message": "Fix TableLoadBalancerTest", "committedDate": "2020-03-27T20:25:06Z", "type": "commit"}, {"oid": "68aa1070afd576c45c7b98d36d98766dd62d847e", "url": "https://github.com/apache/accumulo/commit/68aa1070afd576c45c7b98d36d98766dd62d847e", "message": "Fix 2 more tests", "committedDate": "2020-03-27T20:25:06Z", "type": "commit"}, {"oid": "68aa1070afd576c45c7b98d36d98766dd62d847e", "url": "https://github.com/apache/accumulo/commit/68aa1070afd576c45c7b98d36d98766dd62d847e", "message": "Fix 2 more tests", "committedDate": "2020-03-27T20:25:06Z", "type": "forcePushed"}]}