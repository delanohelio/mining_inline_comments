{"pr_number": 1551, "pr_title": "Use sets instead of arrays for volumes", "pr_createdAt": "2020-03-06T03:39:26Z", "pr_url": "https://github.com/apache/accumulo/pull/1551", "timeline": [{"oid": "d886d869e628874054379f2b5ecdad702d9e0881", "url": "https://github.com/apache/accumulo/commit/d886d869e628874054379f2b5ecdad702d9e0881", "message": "Use sets instead of arrays for volumes\n\nOriginally ACCUMULO-3376, this change replaces the use of `String[]`\nwith `Set<String>` throughout the VolumeChooser and VolumeManager code.\nThis makes the API for VolumeChooser a bit more friendly, making it\neasier to use Streams and lambdas to filter and transform volumes\nthroughout the code.\n\nThis change also adds some more sanity checks on the instance volumes\nconfiguration (checking for empty list and duplicates).\n\nThis also includes a utility to warn about planned API changes in\ninternal pluggable code (such as the VolumeChooser), but without being\ntoo spammy.\n\nUpdate the default `VolumeChooser.choosable()` to return the full set of\nvolumes, so that all are checked for flush and sync support on tserver\nstartup. This choosable mechanism is a bit dubious anyway, because\nchoosers could make different decisions over time (in response to\nconfiguration changes, for example) than they do at startup. So,\ndefaulting to checking for the maximal set seems like a better strategy\nout-of-the-box.\n\nMake ServerConstants.baseUris unmodifiable.", "committedDate": "2020-03-06T03:35:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODk1Mzg1Mw==", "url": "https://github.com/apache/accumulo/pull/1551#discussion_r388953853", "bodyText": "Could use sl4j parameterized log statement.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                log.info(\"Looking for matching filesystem for \" + exportDir + \" from options \" + tableDirs);\n          \n          \n            \n                log.info(\"Looking for matching filesystem for {} from options {}\", exportDir, tableDirs);", "author": "milleruntime", "createdAt": "2020-03-06T15:03:25Z", "path": "server/master/src/main/java/org/apache/accumulo/master/tableOps/tableImport/CreateImportDir.java", "diffHunk": "@@ -47,10 +47,9 @@\n     UniqueNameAllocator namer = master.getContext().getUniqueNameAllocator();\n \n     Path exportDir = new Path(tableInfo.exportDir);\n-    String[] tableDirs = ServerConstants.getTablesDirs(master.getContext());\n+    Set<String> tableDirs = ServerConstants.getTablesDirs(master.getContext());\n \n-    log.info(\"Looking for matching filesystem for \" + exportDir + \" from options \"\n-        + Arrays.toString(tableDirs));\n+    log.info(\"Looking for matching filesystem for \" + exportDir + \" from options \" + tableDirs);", "originalCommit": "d886d869e628874054379f2b5ecdad702d9e0881", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTAyMTYyMw==", "url": "https://github.com/apache/accumulo/pull/1551#discussion_r389021623", "bodyText": "This was preexisting, but good to change while we're in there.", "author": "ctubbsii", "createdAt": "2020-03-06T16:56:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODk1Mzg1Mw=="}], "type": "inlineReview", "revised_code": {"commit": "f9db0963603439a648af2f8a7aa8942f18c247e0", "chunk": "diff --git a/server/master/src/main/java/org/apache/accumulo/master/tableOps/tableImport/CreateImportDir.java b/server/master/src/main/java/org/apache/accumulo/master/tableOps/tableImport/CreateImportDir.java\nindex 0688c64ae6..a6ae987682 100644\n--- a/server/master/src/main/java/org/apache/accumulo/master/tableOps/tableImport/CreateImportDir.java\n+++ b/server/master/src/main/java/org/apache/accumulo/master/tableOps/tableImport/CreateImportDir.java\n\n@@ -49,7 +49,7 @@ class CreateImportDir extends MasterRepo {\n     Path exportDir = new Path(tableInfo.exportDir);\n     Set<String> tableDirs = ServerConstants.getTablesDirs(master.getContext());\n \n-    log.info(\"Looking for matching filesystem for \" + exportDir + \" from options \" + tableDirs);\n+    log.info(\"Looking for matching filesystem for {} from options {}\", exportDir, tableDirs);\n     Path base = master.getFileSystem().matchingFileSystem(exportDir, tableDirs);\n     if (base == null) {\n       throw new IOException(tableInfo.exportDir + \" is not in a volume configured for Accumulo\");\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODk1Njg3MQ==", "url": "https://github.com/apache/accumulo/pull/1551#discussion_r388956871", "bodyText": "Could make ViewFSUtils take a Set as well.  Looks like this is the only class that uses it.", "author": "milleruntime", "createdAt": "2020-03-06T15:08:49Z", "path": "server/base/src/main/java/org/apache/accumulo/server/fs/VolumeManagerImpl.java", "diffHunk": "@@ -385,10 +385,10 @@ public boolean isReady() throws IOException {\n   }\n \n   @Override\n-  public Path matchingFileSystem(Path source, String[] options) {\n+  public Path matchingFileSystem(Path source, Set<String> options) {\n     try {\n       if (ViewFSUtils.isViewFS(source, hadoopConf)) {\n-        return ViewFSUtils.matchingFileSystem(source, options, hadoopConf);\n+        return ViewFSUtils.matchingFileSystem(source, options.toArray(new String[0]), hadoopConf);", "originalCommit": "d886d869e628874054379f2b5ecdad702d9e0881", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTAyMjAzOA==", "url": "https://github.com/apache/accumulo/pull/1551#discussion_r389022038", "bodyText": "I'm going to deal with this class separately... I think we can rip out the viewfs support tooling... since we explicitly ban it.", "author": "ctubbsii", "createdAt": "2020-03-06T16:57:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODk1Njg3MQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODk2NjIzMg==", "url": "https://github.com/apache/accumulo/pull/1551#discussion_r388966232", "bodyText": "This is neat.  The name is a little long though, could just call it ApiWarner or ApiNotifier.  I wonder if there are other deprecated APIs that we want to warn about?  Could be a follow on task.", "author": "milleruntime", "createdAt": "2020-03-06T15:23:50Z", "path": "server/base/src/main/java/org/apache/accumulo/server/fs/InterfaceEvolutionWarner.java", "diffHunk": "@@ -0,0 +1,42 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.accumulo.server.fs;\n+\n+import java.util.concurrent.ConcurrentHashMap;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class InterfaceEvolutionWarner {", "originalCommit": "d886d869e628874054379f2b5ecdad702d9e0881", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTAyMzI0Mg==", "url": "https://github.com/apache/accumulo/pull/1551#discussion_r389023242", "bodyText": "Nothing is tied to the name, not even its logger, so we can rename, move, and reuse it however we want, as needed.", "author": "ctubbsii", "createdAt": "2020-03-06T16:58:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODk2NjIzMg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODk2OTYyNA==", "url": "https://github.com/apache/accumulo/pull/1551#discussion_r388969624", "bodyText": "Can never have enough sanity checks!  Could create unit tests for these checks, one where two configured Volumes get normalized to the same Path.", "author": "milleruntime", "createdAt": "2020-03-06T15:29:30Z", "path": "core/src/main/java/org/apache/accumulo/core/volume/VolumeConfiguration.java", "diffHunk": "@@ -107,29 +110,31 @@ public static String getConfiguredBaseDir(AccumuloConfiguration conf,\n \n         try {\n           // pass through URI to unescape hex encoded chars (e.g. convert %2C to \",\" char)\n-          configuredBaseDirs[i++] = new Path(new URI(namespace)).toString();\n+          configuredBaseDirs.add(new Path(new URI(namespace)).toString());\n         } catch (URISyntaxException e) {\n           throw new IllegalArgumentException(Property.INSTANCE_VOLUMES.getKey() + \" contains \"\n               + namespace + \" which has a syntax error\", e);\n         }\n       }\n     }\n \n-    return configuredBaseDirs;\n+    LinkedHashSet<String> deduplicated = new LinkedHashSet<>();\n+    deduplicated.addAll(configuredBaseDirs);\n+    if (deduplicated.isEmpty()) {\n+      throw new IllegalArgumentException(\n+          Property.INSTANCE_VOLUMES.getKey() + \" contains no volumes (\" + ns + \")\");\n+    }\n+    if (deduplicated.size() < configuredBaseDirs.size()) {\n+      throw new IllegalArgumentException(\n+          Property.INSTANCE_VOLUMES.getKey() + \" contains duplicate volumes (\" + ns + \")\");", "originalCommit": "d886d869e628874054379f2b5ecdad702d9e0881", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTAyNjE4MQ==", "url": "https://github.com/apache/accumulo/pull/1551#discussion_r389026181", "bodyText": "This code is likely to change with #1397, so I didn't want to spend too much time adding more stuff like that just yet, but can do so with #1397.", "author": "ctubbsii", "createdAt": "2020-03-06T17:01:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODk2OTYyNA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "f9db0963603439a648af2f8a7aa8942f18c247e0", "url": "https://github.com/apache/accumulo/commit/f9db0963603439a648af2f8a7aa8942f18c247e0", "message": "Update server/master/src/main/java/org/apache/accumulo/master/tableOps/tableImport/CreateImportDir.java\n\nCo-Authored-By: Mike Miller <mmiller@apache.org>", "committedDate": "2020-03-06T16:56:06Z", "type": "commit"}]}