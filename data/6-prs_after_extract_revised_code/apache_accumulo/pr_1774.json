{"pr_number": 1774, "pr_title": "Refactor Tablet state classes", "pr_createdAt": "2020-11-10T23:07:22Z", "pr_url": "https://github.com/apache/accumulo/pull/1774", "timeline": [{"oid": "80a5d253249359f8863ad1b54126852e958820d4", "url": "https://github.com/apache/accumulo/commit/80a5d253249359f8863ad1b54126852e958820d4", "message": "Refactor Tablet state classes\n\n* Move TabletState, TabletLocationState, TServerInstance and\nSuspendingTServer from master to core.metadata package\n* Make ample TabletMetadata.Location extend TServerInstance\n* Rewrite GroupBalancer getLocationProvider() method\n* Modify GroupBalancerTest to override new method", "committedDate": "2020-11-10T22:57:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTA2NjQ2MA==", "url": "https://github.com/apache/accumulo/pull/1774#discussion_r521066460", "bodyText": "This seems like a regression. In general, unless you're printing something, it's better to use a more specific type than a String type, and a more specific method name than toString(), since toString() should not be relied upon to not change over time.", "author": "ctubbsii", "createdAt": "2020-11-11T03:06:17Z", "path": "core/src/main/java/org/apache/accumulo/core/clientImpl/TableOperationsImpl.java", "diffHunk": "@@ -1301,7 +1301,7 @@ private void waitForTableStateTransition(TableId tableId, TableState expectedSta\n           lastRow = tablet.getExtent().toMetaRow();\n \n           if (loc != null) {\n-            serverCounts.increment(loc.getId(), 1);\n+            serverCounts.increment(loc.toString(), 1);", "originalCommit": "80a5d253249359f8863ad1b54126852e958820d4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjI2NjYwNw==", "url": "https://github.com/apache/accumulo/pull/1774#discussion_r522266607", "bodyText": "They should be returning the same thing, but I don't think either method name is appropriate.  Looking at the impl, they both ultimately return hostPort() + \"[\" + session + \"]\".\nMaybe something very explicit like getHostPortSession() would be better.  Then it will be clear what parts of the code we need to change if we drop/change the session.", "author": "milleruntime", "createdAt": "2020-11-12T17:03:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTA2NjQ2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI3Mzg1NQ==", "url": "https://github.com/apache/accumulo/pull/1774#discussion_r525273855", "bodyText": "Maybe something very explicit like getHostPortSession() would be better. Then it will be clear what parts of the code we need to change if we drop/change the session.\n\n\ud83d\udc4d", "author": "ctubbsii", "createdAt": "2020-11-17T15:54:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTA2NjQ2MA=="}], "type": "inlineReview", "revised_code": {"commit": "6893e012510c1a02aebbd42fbbc040406456ba09", "chunk": "diff --git a/core/src/main/java/org/apache/accumulo/core/clientImpl/TableOperationsImpl.java b/core/src/main/java/org/apache/accumulo/core/clientImpl/TableOperationsImpl.java\nindex 361c684c25..4ad395a880 100644\n--- a/core/src/main/java/org/apache/accumulo/core/clientImpl/TableOperationsImpl.java\n+++ b/core/src/main/java/org/apache/accumulo/core/clientImpl/TableOperationsImpl.java\n\n@@ -1301,7 +1301,7 @@ public class TableOperationsImpl extends TableOperationsHelper {\n           lastRow = tablet.getExtent().toMetaRow();\n \n           if (loc != null) {\n-            serverCounts.increment(loc.toString(), 1);\n+            serverCounts.increment(loc.getHostPortSession(), 1);\n           }\n         }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTA2OTA2Ng==", "url": "https://github.com/apache/accumulo/pull/1774#discussion_r521069066", "bodyText": "getLocation().getLocation() seems funny here. Too many types known as 'location'.", "author": "ctubbsii", "createdAt": "2020-11-11T03:09:08Z", "path": "core/src/test/java/org/apache/accumulo/core/metadata/schema/TabletMetadataTest.java", "diffHunk": "@@ -145,7 +145,7 @@ public void testFuture() {\n         EnumSet.allOf(ColumnType.class), false);\n \n     assertEquals(extent, tm.getExtent());\n-    assertEquals(HostAndPort.fromParts(\"server1\", 8555), tm.getLocation().getHostAndPort());\n+    assertEquals(HostAndPort.fromParts(\"server1\", 8555), tm.getLocation().getLocation());", "originalCommit": "80a5d253249359f8863ad1b54126852e958820d4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjI2NzkyMg==", "url": "https://github.com/apache/accumulo/pull/1774#discussion_r522267922", "bodyText": "Yes.  This is holdover from the temp interface in Ample.  I thought I had dropped this but I got side tracked.  I will drop this interface in the next commit.", "author": "milleruntime", "createdAt": "2020-11-12T17:05:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTA2OTA2Ng=="}], "type": "inlineReview", "revised_code": {"commit": "6893e012510c1a02aebbd42fbbc040406456ba09", "chunk": "diff --git a/core/src/test/java/org/apache/accumulo/core/metadata/schema/TabletMetadataTest.java b/core/src/test/java/org/apache/accumulo/core/metadata/schema/TabletMetadataTest.java\nindex d827a7fdec..c0e92694f4 100644\n--- a/core/src/test/java/org/apache/accumulo/core/metadata/schema/TabletMetadataTest.java\n+++ b/core/src/test/java/org/apache/accumulo/core/metadata/schema/TabletMetadataTest.java\n\n@@ -145,7 +145,7 @@ public class TabletMetadataTest {\n         EnumSet.allOf(ColumnType.class), false);\n \n     assertEquals(extent, tm.getExtent());\n-    assertEquals(HostAndPort.fromParts(\"server1\", 8555), tm.getLocation().getLocation());\n+    assertEquals(HostAndPort.fromParts(\"server1\", 8555), tm.getLocation().getHostAndPort());\n     assertEquals(\"s001\", tm.getLocation().getSession());\n     assertEquals(LocationType.FUTURE, tm.getLocation().getType());\n     assertFalse(tm.hasCurrent());\n"}}, {"oid": "6893e012510c1a02aebbd42fbbc040406456ba09", "url": "https://github.com/apache/accumulo/commit/6893e012510c1a02aebbd42fbbc040406456ba09", "message": "Drop temporary Ample interface and rename methods in TServerInstance.java", "committedDate": "2020-11-12T19:19:55Z", "type": "commit"}, {"oid": "2c2b91d6825aed44884bae250554524424af054e", "url": "https://github.com/apache/accumulo/commit/2c2b91d6825aed44884bae250554524424af054e", "message": "Cleanup variables in TServerInstance and stop extra calls to toString", "committedDate": "2020-11-12T19:51:10Z", "type": "commit"}, {"oid": "b735d2291bc59c416c049079b8f182d08511828f", "url": "https://github.com/apache/accumulo/commit/b735d2291bc59c416c049079b8f182d08511828f", "message": "Drop serialization from TServerInstance\n\n* Serialize HostAndPort and string in ShutdownTServer master op instead\nof TserverInstance so we can drop custom serialization\n* Update ShutdownTServerTest", "committedDate": "2020-11-16T21:31:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDY0ODAyMg==", "url": "https://github.com/apache/accumulo/pull/1774#discussion_r524648022", "bodyText": "The constructor can still use this type, since that won't affect serialization. The fields can be derived from the constructor parameter, rather than passed in as separate parameters.", "author": "ctubbsii", "createdAt": "2020-11-16T22:01:04Z", "path": "server/manager/src/main/java/org/apache/accumulo/master/MasterClientServiceHandler.java", "diffHunk": "@@ -278,7 +278,9 @@ public void shutdownTabletServer(TInfo info, TCredentials c, String tabletServer\n \n     log.debug(\"Seeding FATE op to shutdown \" + tabletServer + \" with tid \" + tid);\n \n-    master.fate.seedTransaction(tid, new TraceRepo<>(new ShutdownTServer(doomed, force)), false);\n+    master.fate.seedTransaction(tid,\n+        new TraceRepo<>(new ShutdownTServer(doomed.getHostAndPort(), doomed.getSession(), force)),", "originalCommit": "b735d2291bc59c416c049079b8f182d08511828f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI0MDU3MQ==", "url": "https://github.com/apache/accumulo/pull/1774#discussion_r525240571", "bodyText": "Oh yeah, good idea.", "author": "milleruntime", "createdAt": "2020-11-17T15:22:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDY0ODAyMg=="}], "type": "inlineReview", "revised_code": {"commit": "3f85258ebfa3b80ad3b209704a4072d57b8676b7", "chunk": "diff --git a/server/manager/src/main/java/org/apache/accumulo/master/MasterClientServiceHandler.java b/server/manager/src/main/java/org/apache/accumulo/master/MasterClientServiceHandler.java\nindex f0677b8a95..74d69dea1e 100644\n--- a/server/manager/src/main/java/org/apache/accumulo/master/MasterClientServiceHandler.java\n+++ b/server/manager/src/main/java/org/apache/accumulo/master/MasterClientServiceHandler.java\n\n@@ -278,9 +278,7 @@ public class MasterClientServiceHandler extends FateServiceHandler\n \n     log.debug(\"Seeding FATE op to shutdown \" + tabletServer + \" with tid \" + tid);\n \n-    master.fate.seedTransaction(tid,\n-        new TraceRepo<>(new ShutdownTServer(doomed.getHostAndPort(), doomed.getSession(), force)),\n-        false);\n+    master.fate.seedTransaction(tid, new TraceRepo<>(new ShutdownTServer(doomed, force)), false);\n     master.fate.waitForCompletion(tid);\n     master.fate.delete(tid);\n \n"}}, {"oid": "3f85258ebfa3b80ad3b209704a4072d57b8676b7", "url": "https://github.com/apache/accumulo/commit/3f85258ebfa3b80ad3b209704a4072d57b8676b7", "message": "Keep ShutdownTServer constructor and revert some changes", "committedDate": "2020-11-17T15:57:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTMxNTE5Mg==", "url": "https://github.com/apache/accumulo/pull/1774#discussion_r525315192", "bodyText": "Nice cleanup here.", "author": "ctubbsii", "createdAt": "2020-11-17T16:46:07Z", "path": "server/base/src/main/java/org/apache/accumulo/server/master/balancer/GroupBalancer.java", "diffHunk": "@@ -79,21 +79,13 @@ public GroupBalancer(TableId tableId) {\n     this.tableId = tableId;\n   }\n \n-  protected Iterable<Pair<KeyExtent,Location>> getLocationProvider() {\n-    return () -> {\n-      try {\n-        return TabletsMetadata.builder().forTable(tableId).fetch(LOCATION, PREV_ROW).build(context)\n-            .stream().map(tm -> {\n-              Location loc = Location.NONE;\n-              if (tm.hasCurrent()) {\n-                loc = new Location(new TServerInstance(tm.getLocation()));\n-              }\n-              return new Pair<>(tm.getExtent(), loc);\n-            }).iterator();\n-      } catch (Exception e) {\n-        throw new RuntimeException(e);\n-      }\n-    };\n+  protected Map<KeyExtent,TServerInstance> getLocationProvider() {\n+    Map<KeyExtent,TServerInstance> tablets = new LinkedHashMap<>();\n+    for (var tm : TabletsMetadata.builder().forTable(tableId).fetch(LOCATION, PREV_ROW)\n+        .build(context)) {\n+      tablets.put(tm.getExtent(), tm.getLocation());\n+    }\n+    return tablets;", "originalCommit": "3f85258ebfa3b80ad3b209704a4072d57b8676b7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "1e138dafce3cf714cdecb1b35c77d59cebed34b8", "url": "https://github.com/apache/accumulo/commit/1e138dafce3cf714cdecb1b35c77d59cebed34b8", "message": "Replace mock object in test with real object\n\n* Also remove serialID no longer needed on Location", "committedDate": "2020-11-17T18:01:18Z", "type": "commit"}]}