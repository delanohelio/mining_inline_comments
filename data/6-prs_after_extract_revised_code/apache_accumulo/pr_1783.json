{"pr_number": 1783, "pr_title": "Fix #1764 Parallelize listcompactions in shell", "pr_createdAt": "2020-11-16T20:10:40Z", "pr_url": "https://github.com/apache/accumulo/pull/1783", "timeline": [{"oid": "0e578132127a3db7e5055e0d655e32e5ad065953", "url": "https://github.com/apache/accumulo/commit/0e578132127a3db7e5055e0d655e32e5ad065953", "message": "Fix #1764 Parallelize listcompactions in shell\n\nReplace `ActiveCompactionIterator` with `ActiveCompactionHelper` that\nparallelizes calls to `InstanceOperations.getActiveCompactions()` in\nsupport of a more efficient `listcompactions` command in the shell.", "committedDate": "2020-11-16T21:07:43Z", "type": "commit"}, {"oid": "0e578132127a3db7e5055e0d655e32e5ad065953", "url": "https://github.com/apache/accumulo/commit/0e578132127a3db7e5055e0d655e32e5ad065953", "message": "Fix #1764 Parallelize listcompactions in shell\n\nReplace `ActiveCompactionIterator` with `ActiveCompactionHelper` that\nparallelizes calls to `InstanceOperations.getActiveCompactions()` in\nsupport of a more efficient `listcompactions` command in the shell.", "committedDate": "2020-11-16T21:07:43Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDg4NjY0Mg==", "url": "https://github.com/apache/accumulo/pull/1783#discussion_r524886642", "bodyText": "I like how this is handled.", "author": "keith-turner", "createdAt": "2020-11-17T05:05:32Z", "path": "shell/src/main/java/org/apache/accumulo/shell/commands/ActiveCompactionHelper.java", "diffHunk": "@@ -0,0 +1,119 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.accumulo.shell.commands;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.Executors;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import org.apache.accumulo.core.client.IteratorSetting;\n+import org.apache.accumulo.core.client.TableNotFoundException;\n+import org.apache.accumulo.core.client.admin.ActiveCompaction;\n+import org.apache.accumulo.core.client.admin.InstanceOperations;\n+import org.apache.accumulo.core.util.Duration;\n+import org.apache.accumulo.core.util.NamingThreadFactory;\n+\n+class ActiveCompactionHelper {\n+\n+  private static String maxDecimal(double count) {\n+    if (count < 9.995)\n+      return String.format(\"%.2f\", count);\n+    if (count < 99.95)\n+      return String.format(\"%.1f\", count);\n+    return String.format(\"%.0f\", count);\n+  }\n+\n+  private static String shortenCount(long count) {\n+    if (count < 1_000)\n+      return count + \"\";\n+    if (count < 1_000_000)\n+      return maxDecimal(count / 1_000.0) + \"K\";\n+    if (count < 1_000_000_000)\n+      return maxDecimal(count / 1_000_000.0) + \"M\";\n+    return maxDecimal(count / 1_000_000_000.0) + \"B\";\n+  }\n+\n+  private static String formatActiveCompactionLine(String tserver, ActiveCompaction ac)\n+      throws TableNotFoundException {\n+    String output = ac.getOutputFile();\n+    int index = output.indexOf(\"tables\");\n+    if (index > 0) {\n+      output = output.substring(index + 6);\n+    }\n+\n+    List<String> iterList = new ArrayList<>();\n+    Map<String,Map<String,String>> iterOpts = new HashMap<>();\n+    for (IteratorSetting is : ac.getIterators()) {\n+      iterList.add(is.getName() + \"=\" + is.getPriority() + \",\" + is.getIteratorClass());\n+      iterOpts.put(is.getName(), is.getOptions());\n+    }\n+\n+    return String.format(\n+        \"%21s | %9s | %5s | %6s | %5s | %5s | %15s | %-40s | %5s | %35s | %9s | %s\", tserver,\n+        Duration.format(ac.getAge(), \"\", \"-\"), ac.getType(), ac.getReason(),\n+        shortenCount(ac.getEntriesRead()), shortenCount(ac.getEntriesWritten()), ac.getTable(),\n+        ac.getTablet(), ac.getInputFiles().size(), output, iterList, iterOpts);\n+  }\n+\n+  private static List<String> activeCompactionsForServer(String tserver,\n+      InstanceOperations instanceOps) {\n+    List<String> compactions = new ArrayList<>();\n+    try {\n+      List<ActiveCompaction> acl = new ArrayList<>(instanceOps.getActiveCompactions(tserver));\n+      acl.sort((o1, o2) -> (int) (o2.getAge() - o1.getAge()));\n+      for (ActiveCompaction ac : acl) {\n+        compactions.add(formatActiveCompactionLine(tserver, ac));\n+      }\n+    } catch (Exception e) {\n+      compactions.add(tserver + \" ERROR \" + e.getMessage());", "originalCommit": "0e578132127a3db7e5055e0d655e32e5ad065953", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTIzNDEyMw==", "url": "https://github.com/apache/accumulo/pull/1783#discussion_r525234123", "bodyText": "I'm pretty sure you wrote that code. I just moved it. \ud83d\ude3a", "author": "ctubbsii", "createdAt": "2020-11-17T15:14:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDg4NjY0Mg=="}], "type": "inlineReview", "revised_code": {"commit": "df66c0a23aa933fb4b206b4e8a98ffdb2689b946", "chunk": "diff --git a/shell/src/main/java/org/apache/accumulo/shell/commands/ActiveCompactionHelper.java b/shell/src/main/java/org/apache/accumulo/shell/commands/ActiveCompactionHelper.java\nindex bce88aba77..592e2c3f25 100644\n--- a/shell/src/main/java/org/apache/accumulo/shell/commands/ActiveCompactionHelper.java\n+++ b/shell/src/main/java/org/apache/accumulo/shell/commands/ActiveCompactionHelper.java\n\n@@ -97,9 +97,10 @@ class ActiveCompactionHelper {\n         \"TABLET SERVER\", \"AGE\", \"TYPE\", \"REASON\", \"READ\", \"WROTE\", \"TABLE\", \"TABLET\", \"INPUT\",\n         \"OUTPUT\", \"ITERATORS\", \"ITERATOR OPTIONS\"));\n \n+    // use at least 4 threads (if needed), but no more than 256\n+    int numThreads = Math.max(4, Math.min(tservers.size() / 10, 256));\n     var threadFactory = new NamingThreadFactory(\"shell-listcompactions\");\n-    var executorService =\n-        Executors.newFixedThreadPool(Runtime.getRuntime().availableProcessors(), threadFactory);\n+    var executorService = Executors.newFixedThreadPool(numThreads, threadFactory);\n     try {\n       Stream<String> activeCompactionLines = tservers.stream()\n           // submit each tserver to executor\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDg4ODIyOQ==", "url": "https://github.com/apache/accumulo/pull/1783#discussion_r524888229", "bodyText": "Since the parallelism is to lessen the impact of RPC latency and is not CPU bound I would use a lot of threads.  Number of threads could be a function of the # tservers, maybe something like :\n   int numThreads = Math.max(1,Math.min(tservers.size()/10, 256));", "author": "keith-turner", "createdAt": "2020-11-17T05:11:50Z", "path": "shell/src/main/java/org/apache/accumulo/shell/commands/ActiveCompactionHelper.java", "diffHunk": "@@ -0,0 +1,119 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.accumulo.shell.commands;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.Executors;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import org.apache.accumulo.core.client.IteratorSetting;\n+import org.apache.accumulo.core.client.TableNotFoundException;\n+import org.apache.accumulo.core.client.admin.ActiveCompaction;\n+import org.apache.accumulo.core.client.admin.InstanceOperations;\n+import org.apache.accumulo.core.util.Duration;\n+import org.apache.accumulo.core.util.NamingThreadFactory;\n+\n+class ActiveCompactionHelper {\n+\n+  private static String maxDecimal(double count) {\n+    if (count < 9.995)\n+      return String.format(\"%.2f\", count);\n+    if (count < 99.95)\n+      return String.format(\"%.1f\", count);\n+    return String.format(\"%.0f\", count);\n+  }\n+\n+  private static String shortenCount(long count) {\n+    if (count < 1_000)\n+      return count + \"\";\n+    if (count < 1_000_000)\n+      return maxDecimal(count / 1_000.0) + \"K\";\n+    if (count < 1_000_000_000)\n+      return maxDecimal(count / 1_000_000.0) + \"M\";\n+    return maxDecimal(count / 1_000_000_000.0) + \"B\";\n+  }\n+\n+  private static String formatActiveCompactionLine(String tserver, ActiveCompaction ac)\n+      throws TableNotFoundException {\n+    String output = ac.getOutputFile();\n+    int index = output.indexOf(\"tables\");\n+    if (index > 0) {\n+      output = output.substring(index + 6);\n+    }\n+\n+    List<String> iterList = new ArrayList<>();\n+    Map<String,Map<String,String>> iterOpts = new HashMap<>();\n+    for (IteratorSetting is : ac.getIterators()) {\n+      iterList.add(is.getName() + \"=\" + is.getPriority() + \",\" + is.getIteratorClass());\n+      iterOpts.put(is.getName(), is.getOptions());\n+    }\n+\n+    return String.format(\n+        \"%21s | %9s | %5s | %6s | %5s | %5s | %15s | %-40s | %5s | %35s | %9s | %s\", tserver,\n+        Duration.format(ac.getAge(), \"\", \"-\"), ac.getType(), ac.getReason(),\n+        shortenCount(ac.getEntriesRead()), shortenCount(ac.getEntriesWritten()), ac.getTable(),\n+        ac.getTablet(), ac.getInputFiles().size(), output, iterList, iterOpts);\n+  }\n+\n+  private static List<String> activeCompactionsForServer(String tserver,\n+      InstanceOperations instanceOps) {\n+    List<String> compactions = new ArrayList<>();\n+    try {\n+      List<ActiveCompaction> acl = new ArrayList<>(instanceOps.getActiveCompactions(tserver));\n+      acl.sort((o1, o2) -> (int) (o2.getAge() - o1.getAge()));\n+      for (ActiveCompaction ac : acl) {\n+        compactions.add(formatActiveCompactionLine(tserver, ac));\n+      }\n+    } catch (Exception e) {\n+      compactions.add(tserver + \" ERROR \" + e.getMessage());\n+    }\n+    return compactions;\n+  }\n+\n+  public static Stream<String> stream(List<String> tservers, InstanceOperations instanceOps) {\n+    Stream<String> header = Stream.of(String.format(\n+        \" %-21s| %-9s | %-5s | %-6s | %-5s | %-5s | %-15s | %-40s | %-5s | %-35s | %-9s | %s\",\n+        \"TABLET SERVER\", \"AGE\", \"TYPE\", \"REASON\", \"READ\", \"WROTE\", \"TABLE\", \"TABLET\", \"INPUT\",\n+        \"OUTPUT\", \"ITERATORS\", \"ITERATOR OPTIONS\"));\n+\n+    var threadFactory = new NamingThreadFactory(\"shell-listcompactions\");\n+    var executorService =\n+        Executors.newFixedThreadPool(Runtime.getRuntime().availableProcessors(), threadFactory);", "originalCommit": "0e578132127a3db7e5055e0d655e32e5ad065953", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTIzNDcwNQ==", "url": "https://github.com/apache/accumulo/pull/1783#discussion_r525234705", "bodyText": "Okay, cool. I will do this.", "author": "ctubbsii", "createdAt": "2020-11-17T15:15:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDg4ODIyOQ=="}], "type": "inlineReview", "revised_code": {"commit": "df66c0a23aa933fb4b206b4e8a98ffdb2689b946", "chunk": "diff --git a/shell/src/main/java/org/apache/accumulo/shell/commands/ActiveCompactionHelper.java b/shell/src/main/java/org/apache/accumulo/shell/commands/ActiveCompactionHelper.java\nindex bce88aba77..592e2c3f25 100644\n--- a/shell/src/main/java/org/apache/accumulo/shell/commands/ActiveCompactionHelper.java\n+++ b/shell/src/main/java/org/apache/accumulo/shell/commands/ActiveCompactionHelper.java\n\n@@ -97,9 +97,10 @@ class ActiveCompactionHelper {\n         \"TABLET SERVER\", \"AGE\", \"TYPE\", \"REASON\", \"READ\", \"WROTE\", \"TABLE\", \"TABLET\", \"INPUT\",\n         \"OUTPUT\", \"ITERATORS\", \"ITERATOR OPTIONS\"));\n \n+    // use at least 4 threads (if needed), but no more than 256\n+    int numThreads = Math.max(4, Math.min(tservers.size() / 10, 256));\n     var threadFactory = new NamingThreadFactory(\"shell-listcompactions\");\n-    var executorService =\n-        Executors.newFixedThreadPool(Runtime.getRuntime().availableProcessors(), threadFactory);\n+    var executorService = Executors.newFixedThreadPool(numThreads, threadFactory);\n     try {\n       Stream<String> activeCompactionLines = tservers.stream()\n           // submit each tserver to executor\n"}}, {"oid": "df66c0a23aa933fb4b206b4e8a98ffdb2689b946", "url": "https://github.com/apache/accumulo/commit/df66c0a23aa933fb4b206b4e8a98ffdb2689b946", "message": "Code review feedback: use numThreads based on tservers", "committedDate": "2020-11-17T16:13:22Z", "type": "commit"}]}