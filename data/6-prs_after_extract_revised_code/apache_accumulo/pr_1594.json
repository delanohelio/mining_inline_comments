{"pr_number": 1594, "pr_title": "Handle spurious failure were rename succeeded but reported it failed (#1588)", "pr_createdAt": "2020-04-24T00:17:17Z", "pr_url": "https://github.com/apache/accumulo/pull/1594", "timeline": [{"oid": "690b3d022180f24cabb559907c512cd345d243c8", "url": "https://github.com/apache/accumulo/commit/690b3d022180f24cabb559907c512cd345d243c8", "message": "Fix #1588 Refine rename During Minor Compaction (1588)\nPR addresses a few issues:\nSpurious rename failures where rename failed but actually succeeded\nThe check for file existence should only be done before attempting rename\nShould not delete file if it exists (an admin may want to investigate).", "committedDate": "2020-04-24T00:30:37Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDI3ODQ1Ng==", "url": "https://github.com/apache/accumulo/pull/1594#discussion_r414278456", "bodyText": "@tushardhadiwal some minor comments:\n\nPlease modify the placement of this curly brace to match the project's expected style, otherwise the CI fails. The patch submission steps are very useful - mvn clean verify -DskipTests will usually auto-format code and fix this\nRelated to above - personally I'd also remove the // i.e. dfv.getNumEntries() > 0 comment :-)", "author": "arvindshmicrosoft", "createdAt": "2020-04-24T04:11:23Z", "path": "server/tserver/src/main/java/org/apache/accumulo/tserver/tablet/DatafileManager.java", "diffHunk": "@@ -329,23 +329,34 @@ void bringMinorCompactionOnline(TabletFile tmpDatafile, TabletFile newDatafile,\n     StoredTabletFile newFile;\n     // rename before putting in metadata table, so files in metadata table should\n     // always exist\n+    boolean attemptedRename = false;\n     do {\n       try {\n         if (dfv.getNumEntries() == 0) {\n+\n           tablet.getTabletServer().getFileSystem().deleteRecursively(tmpDatafile.getPath());\n-        } else {\n-          if (tablet.getTabletServer().getFileSystem().exists(newDatafile.getPath())) {\n+        } else // i.e. dfv.getNumEntries() > 0\n+        {", "originalCommit": "690b3d022180f24cabb559907c512cd345d243c8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc4OTkwNg==", "url": "https://github.com/apache/accumulo/pull/1594#discussion_r414789906", "bodyText": "@arvindshmicrosoft I have removed the comment & fixed the curly brace.", "author": "tushardhadiwal", "createdAt": "2020-04-24T18:47:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDI3ODQ1Ng=="}], "type": "inlineReview", "revised_code": {"commit": "08254447e481ca26151786682a39e875c4f64f1f", "chunk": "diff --git a/server/tserver/src/main/java/org/apache/accumulo/tserver/tablet/DatafileManager.java b/server/tserver/src/main/java/org/apache/accumulo/tserver/tablet/DatafileManager.java\nindex 195c945f60..f94ccf1fab 100644\n--- a/server/tserver/src/main/java/org/apache/accumulo/tserver/tablet/DatafileManager.java\n+++ b/server/tserver/src/main/java/org/apache/accumulo/tserver/tablet/DatafileManager.java\n\n@@ -335,28 +335,27 @@ class DatafileManager {\n         if (dfv.getNumEntries() == 0) {\n \n           tablet.getTabletServer().getFileSystem().deleteRecursively(tmpDatafile.getPath());\n-        } else // i.e. dfv.getNumEntries() > 0\n-        {\n+        } else {\n           if (!attemptedRename\n-                  && tablet.getTabletServer().getFileSystem().exists(newDatafile.getPath())) {\n+              && tablet.getTabletServer().getFileSystem().exists(newDatafile.getPath())) {\n             log.warn(\"Target map file already exist {}\", newDatafile);\n             throw new RuntimeException(\"File unexpectedly exists \" + newDatafile.getPath());\n           }\n           // the following checks for spurious rename failures that succeeded but gave an IoE\n           if (attemptedRename\n-                  && tablet.getTabletServer().getFileSystem().exists(newDatafile.getPath())\n-                  && !tablet.getTabletServer().getFileSystem().exists(tmpDatafile.getPath())) {\n+              && tablet.getTabletServer().getFileSystem().exists(newDatafile.getPath())\n+              && !tablet.getTabletServer().getFileSystem().exists(tmpDatafile.getPath())) {\n             // seems like previous rename succeeded, so break\n             break;\n           }\n           attemptedRename = true;\n           rename(tablet.getTabletServer().getFileSystem(), tmpDatafile.getPath(),\n-                  newDatafile.getPath());\n+              newDatafile.getPath());\n         }\n         break;\n       } catch (IOException ioe) {\n         log.warn(\"Tablet \" + tablet.getExtent() + \" failed to rename \" + newDatafile\n-                + \" after MinC, will retry in 60 secs...\", ioe);\n+            + \" after MinC, will retry in 60 secs...\", ioe);\n         sleepUninterruptibly(1, TimeUnit.MINUTES);\n       }\n     } while (true);\n"}}, {"oid": "08254447e481ca26151786682a39e875c4f64f1f", "url": "https://github.com/apache/accumulo/commit/08254447e481ca26151786682a39e875c4f64f1f", "message": "    Handle spurious failure were rename succeeded but reported it failed (#1588)\n    PR addresses a few issues:\n    Spurious rename failures where rename failed but actually succeeded\n    The check for file existence should only be done before attempting rename\n    Should not delete file if it exists (an admin may want to investigate).", "committedDate": "2020-04-24T18:37:55Z", "type": "commit"}, {"oid": "08254447e481ca26151786682a39e875c4f64f1f", "url": "https://github.com/apache/accumulo/commit/08254447e481ca26151786682a39e875c4f64f1f", "message": "    Handle spurious failure were rename succeeded but reported it failed (#1588)\n    PR addresses a few issues:\n    Spurious rename failures where rename failed but actually succeeded\n    The check for file existence should only be done before attempting rename\n    Should not delete file if it exists (an admin may want to investigate).", "committedDate": "2020-04-24T18:37:55Z", "type": "forcePushed"}]}