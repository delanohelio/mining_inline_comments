{"pr_number": 1586, "pr_title": "Fix Accumulo hanging when TLS enabled on ZooKeeper", "pr_createdAt": "2020-04-13T22:31:21Z", "pr_url": "https://github.com/apache/accumulo/pull/1586", "timeline": [{"oid": "786caf1aab78a5c0170df1c36e920a31d721aafe", "url": "https://github.com/apache/accumulo/commit/786caf1aab78a5c0170df1c36e920a31d721aafe", "message": "Fix for #1578", "committedDate": "2020-04-13T21:57:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzgzMTQ0MQ==", "url": "https://github.com/apache/accumulo/pull/1586#discussion_r407831441", "bodyText": "As I understand it, the basis of this pull request is to create this CLOSED mode. What is this CLOSED mode for? This could use a javadoc similar to the other modes.", "author": "ctubbsii", "createdAt": "2020-04-14T02:38:47Z", "path": "core/src/main/java/org/apache/accumulo/core/singletons/SingletonManager.java", "diffHunk": "@@ -65,7 +65,8 @@\n      * In this mode singletons are never disabled unless the mode is set back to CLIENT. The user\n      * can do this by using util.CleanUp (an old API created for users).\n      */\n-    CONNECTOR\n+    CONNECTOR,\n+    CLOSED", "originalCommit": "65dbef8c227a0527840a9c347db5b407339937b4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM4ODg2NA==", "url": "https://github.com/apache/accumulo/pull/1586#discussion_r408388864", "bodyText": "Added comments to explain CLOSED mode, also updated the CLIENT mode comments.", "author": "karthick-rn", "createdAt": "2020-04-14T19:41:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzgzMTQ0MQ=="}], "type": "inlineReview", "revised_code": {"commit": "c5fccb4b2db688009f49350ec09d0c727612b2b0", "chunk": "diff --git a/core/src/main/java/org/apache/accumulo/core/singletons/SingletonManager.java b/core/src/main/java/org/apache/accumulo/core/singletons/SingletonManager.java\nindex 949ed0263f..25272eaf9f 100644\n--- a/core/src/main/java/org/apache/accumulo/core/singletons/SingletonManager.java\n+++ b/core/src/main/java/org/apache/accumulo/core/singletons/SingletonManager.java\n\n@@ -58,7 +58,7 @@ public class SingletonManager {\n      */\n     CLIENT,\n     /**\n-     * In this mode singletons are never disabled.\n+     * In this mode singletons are never disabled, unless the CLOSED mode is entered.\n      */\n     SERVER,\n     /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzgzMzEzNQ==", "url": "https://github.com/apache/accumulo/pull/1586#discussion_r407833135", "bodyText": "Would it be okay to just return if the mode parameter is already the current mode?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (SingletonManager.mode == Mode.CLOSED && mode != Mode.CLOSED)\n          \n          \n            \n                  throw new IllegalStateException(\"Cannot leave closed mode once entered\");\n          \n          \n            \n                if (SingletonManager.mode == mode)\n          \n          \n            \n                  return;\n          \n          \n            \n                if (SingletonManager.mode == Mode.CLOSED)\n          \n          \n            \n                  throw new IllegalStateException(\"Cannot leave closed mode once entered\");\n          \n      \n    \n    \n  \n\nOr is it necessary to fall through and do something if they are both CLOSED already?", "author": "ctubbsii", "createdAt": "2020-04-14T02:45:07Z", "path": "core/src/main/java/org/apache/accumulo/core/singletons/SingletonManager.java", "diffHunk": "@@ -148,6 +149,8 @@ public static long getReservationCount() {\n    * Change how singletons are managed. The default mode is {@link Mode#CLIENT}\n    */\n   public static synchronized void setMode(Mode mode) {\n+    if (SingletonManager.mode == Mode.CLOSED && mode != Mode.CLOSED)\n+      throw new IllegalStateException(\"Cannot leave closed mode once entered\");", "originalCommit": "65dbef8c227a0527840a9c347db5b407339937b4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c5fccb4b2db688009f49350ec09d0c727612b2b0", "chunk": "diff --git a/core/src/main/java/org/apache/accumulo/core/singletons/SingletonManager.java b/core/src/main/java/org/apache/accumulo/core/singletons/SingletonManager.java\nindex 949ed0263f..25272eaf9f 100644\n--- a/core/src/main/java/org/apache/accumulo/core/singletons/SingletonManager.java\n+++ b/core/src/main/java/org/apache/accumulo/core/singletons/SingletonManager.java\n\n@@ -149,7 +154,9 @@ public class SingletonManager {\n    * Change how singletons are managed. The default mode is {@link Mode#CLIENT}\n    */\n   public static synchronized void setMode(Mode mode) {\n-    if (SingletonManager.mode == Mode.CLOSED && mode != Mode.CLOSED)\n+    if (SingletonManager.mode == mode)\n+      return;\n+    if (SingletonManager.mode == Mode.CLOSED)\n       throw new IllegalStateException(\"Cannot leave closed mode once entered\");\n     if (SingletonManager.mode == Mode.CLIENT && mode == Mode.CONNECTOR) {\n       if (transitionedFromClientToConnector) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzgzNDA2OA==", "url": "https://github.com/apache/accumulo/pull/1586#discussion_r407834068", "bodyText": "The comment above this line covers the left hand side, but doesn't explain the right hand side of this || expression. Should it say something about always allow changing state to CLOSED?", "author": "ctubbsii", "createdAt": "2020-04-14T02:48:39Z", "path": "core/src/main/java/org/apache/accumulo/core/singletons/SingletonManager.java", "diffHunk": "@@ -161,7 +164,7 @@ public static synchronized void setMode(Mode mode) {\n     }\n \n     // do not change from server mode, its a terminal mode that can not be left once entered\n-    if (SingletonManager.mode != Mode.SERVER) {\n+    if (SingletonManager.mode != Mode.SERVER || mode == Mode.CLOSED) {", "originalCommit": "65dbef8c227a0527840a9c347db5b407339937b4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c5fccb4b2db688009f49350ec09d0c727612b2b0", "chunk": "diff --git a/core/src/main/java/org/apache/accumulo/core/singletons/SingletonManager.java b/core/src/main/java/org/apache/accumulo/core/singletons/SingletonManager.java\nindex 949ed0263f..25272eaf9f 100644\n--- a/core/src/main/java/org/apache/accumulo/core/singletons/SingletonManager.java\n+++ b/core/src/main/java/org/apache/accumulo/core/singletons/SingletonManager.java\n\n@@ -163,7 +170,8 @@ public class SingletonManager {\n       transitionedFromClientToConnector = true;\n     }\n \n-    // do not change from server mode, its a terminal mode that can not be left once entered\n+    // always allow transition to closed and only allow transition to client/connector when the\n+    // current mode is not server\n     if (SingletonManager.mode != Mode.SERVER || mode == Mode.CLOSED) {\n       SingletonManager.mode = mode;\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzgzNDc1Nw==", "url": "https://github.com/apache/accumulo/pull/1586#discussion_r407834757", "bodyText": "Does this prevent this code from being called from a process that might have other Accumulo client Connectors? If so, this is a bit concerning as a restriction.\n(Same comment for ZooZap and SetGoalState)", "author": "ctubbsii", "createdAt": "2020-04-14T02:51:02Z", "path": "server/base/src/main/java/org/apache/accumulo/server/util/Admin.java", "diffHunk": "@@ -275,6 +277,8 @@ public void execute(final String[] args) {\n     } catch (Exception e) {\n       log.error(\"{}\", e.getMessage(), e);\n       System.exit(3);\n+    } finally {\n+      SingletonManager.setMode(Mode.CLOSED);", "originalCommit": "65dbef8c227a0527840a9c347db5b407339937b4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODE1MDg1Mw==", "url": "https://github.com/apache/accumulo/pull/1586#discussion_r408150853", "bodyText": "Does this prevent this code from being called from a process that might have other Accumulo client Connectors?\n\nYes I think it would.  I don't think this situation happens currently.  If it ever did in the future, a clear error message would occur making it easy to track down.  Since this not public API, its always easy to change this code later if the hypothetical situation does happen.", "author": "keith-turner", "createdAt": "2020-04-14T13:49:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzgzNDc1Nw=="}], "type": "inlineReview", "revised_code": null}, {"oid": "c5fccb4b2db688009f49350ec09d0c727612b2b0", "url": "https://github.com/apache/accumulo/commit/c5fccb4b2db688009f49350ec09d0c727612b2b0", "message": "Update based on Christopher's comments\n\nThe comment section of SingletonManager Java class has been updated based on Christopher's comments", "committedDate": "2020-04-14T19:19:11Z", "type": "commit"}, {"oid": "c5fccb4b2db688009f49350ec09d0c727612b2b0", "url": "https://github.com/apache/accumulo/commit/c5fccb4b2db688009f49350ec09d0c727612b2b0", "message": "Update based on Christopher's comments\n\nThe comment section of SingletonManager Java class has been updated based on Christopher's comments", "committedDate": "2020-04-14T19:19:11Z", "type": "forcePushed"}, {"oid": "3df1011e210663fd11e330bd5b5f215e213b3080", "url": "https://github.com/apache/accumulo/commit/3df1011e210663fd11e330bd5b5f215e213b3080", "message": "Replace single-line with multi-line comment", "committedDate": "2020-04-14T19:49:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM5NDgxNw==", "url": "https://github.com/apache/accumulo/pull/1586#discussion_r408394817", "bodyText": "This isn't a javadoc comment.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                /**\n          \n          \n            \n                /*", "author": "ctubbsii", "createdAt": "2020-04-14T19:52:11Z", "path": "core/src/main/java/org/apache/accumulo/core/singletons/SingletonManager.java", "diffHunk": "@@ -170,8 +170,10 @@ public static synchronized void setMode(Mode mode) {\n       transitionedFromClientToConnector = true;\n     }\n \n-    // always allow transition to closed and only allow transition to client/connector when the\n-    // current mode is not server\n+    /**", "originalCommit": "3df1011e210663fd11e330bd5b5f215e213b3080", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d765a92c07c6682ce8ec8bfd7f04594df870d4f3", "chunk": "diff --git a/core/src/main/java/org/apache/accumulo/core/singletons/SingletonManager.java b/core/src/main/java/org/apache/accumulo/core/singletons/SingletonManager.java\nindex 3bfd110b9f..1b4fe1b769 100644\n--- a/core/src/main/java/org/apache/accumulo/core/singletons/SingletonManager.java\n+++ b/core/src/main/java/org/apache/accumulo/core/singletons/SingletonManager.java\n\n@@ -170,7 +170,7 @@ public class SingletonManager {\n       transitionedFromClientToConnector = true;\n     }\n \n-    /**\n+    /*\n      * Always allow transition to closed and only allow transition to client/connector when the\n      * current mode is not server.\n      */\n"}}, {"oid": "d765a92c07c6682ce8ec8bfd7f04594df870d4f3", "url": "https://github.com/apache/accumulo/commit/d765a92c07c6682ce8ec8bfd7f04594df870d4f3", "message": "Apply suggestions from code review", "committedDate": "2020-04-14T19:53:50Z", "type": "commit"}, {"oid": "a6763e3a118de2686fdd50205bd0e18b06c268d8", "url": "https://github.com/apache/accumulo/commit/a6763e3a118de2686fdd50205bd0e18b06c268d8", "message": "Fix import ordering", "committedDate": "2020-04-14T20:25:49Z", "type": "commit"}]}