{"pr_number": 1524, "pr_title": "[SCB-1716] Fix high cpu load when there are too many instances", "pr_createdAt": "2020-01-11T03:47:55Z", "pr_url": "https://github.com/apache/servicecomb-java-chassis/pull/1524", "timeline": [{"oid": "5235085a94e0f91acd662414fe5cd0ea866f3269", "url": "https://github.com/apache/servicecomb-java-chassis/commit/5235085a94e0f91acd662414fe5cd0ea866f3269", "message": "[SCB-1716] Fix high cpu load when there are too many instances", "committedDate": "2020-01-11T03:22:55Z", "type": "commit"}, {"oid": "19c9c40e1e918586aafba0a99082bd2c88997f76", "url": "https://github.com/apache/servicecomb-java-chassis/commit/19c9c40e1e918586aafba0a99082bd2c88997f76", "message": "Fix typos", "committedDate": "2020-01-11T03:46:38Z", "type": "commit"}, {"oid": "61ba0671f5a07eb25e2443cd88062a6624c62b07", "url": "https://github.com/apache/servicecomb-java-chassis/commit/61ba0671f5a07eb25e2443cd88062a6624c62b07", "message": "Add alias for servicecomb.loadbalance.stats.timerIntervalInMilis", "committedDate": "2020-01-11T07:09:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTYyNTg4NA==", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1524#discussion_r365625884", "bodyText": "change to timerIntervalInMillis", "author": "liubao68", "createdAt": "2020-01-13T01:00:18Z", "path": "handlers/handler-loadbalance/src/main/java/org/apache/servicecomb/loadbalance/Configuration.java", "diffHunk": "@@ -31,9 +31,9 @@\n   //// 2.1 configuration items\n   public static final String PROP_ROOT = \"servicecomb.loadbalance.\";\n \n-  public static final String RPOP_SERVER_EXPIRED_IN_SECONDS = \"servicecomb.loadbalance.stats.serverExpiredInSeconds\";\n+  public static final String PROP_SERVER_EXPIRED_IN_SECONDS = \"servicecomb.loadbalance.stats.serverExpiredInSeconds\";\n \n-  public static final String RPOP_TIMER_INTERVAL_IN_MINIS = \"servicecomb.loadbalance.stats.timerIntervalInMilis\";\n+  public static final String PROP_TIMER_INTERVAL_IN_MILLIS = \"servicecomb.loadbalance.stats.timerIntervalInMilis\";", "originalCommit": "61ba0671f5a07eb25e2443cd88062a6624c62b07", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTY2ODE0MA==", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1524#discussion_r365668140", "bodyText": "done", "author": "AngLi2", "createdAt": "2020-01-13T07:24:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTYyNTg4NA=="}], "type": "inlineReview", "revised_code": {"commit": "6dd9dd3890afda4eb8e0430d3ca153a42c2ebcf6", "chunk": "diff --git a/handlers/handler-loadbalance/src/main/java/org/apache/servicecomb/loadbalance/Configuration.java b/handlers/handler-loadbalance/src/main/java/org/apache/servicecomb/loadbalance/Configuration.java\nindex 072b4f1de..0720ca57d 100644\n--- a/handlers/handler-loadbalance/src/main/java/org/apache/servicecomb/loadbalance/Configuration.java\n+++ b/handlers/handler-loadbalance/src/main/java/org/apache/servicecomb/loadbalance/Configuration.java\n\n@@ -29,25 +29,25 @@ import com.netflix.config.DynamicPropertyFactory;\n  */\n public final class Configuration {\n   //// 2.1 configuration items\n-  public static final String PROP_ROOT = \"servicecomb.loadbalance.\";\n+  public static final String ROOT = \"servicecomb.loadbalance.\";\n \n-  public static final String PROP_SERVER_EXPIRED_IN_SECONDS = \"servicecomb.loadbalance.stats.serverExpiredInSeconds\";\n+  public static final String SERVER_EXPIRED_IN_SECONDS = \"servicecomb.loadbalance.stats.serverExpiredInSeconds\";\n \n-  public static final String PROP_TIMER_INTERVAL_IN_MILLIS = \"servicecomb.loadbalance.stats.timerIntervalInMilis\";\n+  public static final String TIMER_INTERVAL_IN_MILLIS = \"servicecomb.loadbalance.stats.timerIntervalInMillis\";\n \n-  public static final String PROP_RULE_STRATEGY_NAME = \"strategy.name\";\n+  public static final String RULE_STRATEGY_NAME = \"strategy.name\";\n \n   // 2.0 configuration items\n-  public static final String PROP_ROOT_20 = \"ribbon.\";\n+  public static final String ROOT_20 = \"ribbon.\";\n \n   // retry configurations\n-  public static final String PROP_RETRY_HANDLER = \"retryHandler\";\n+  public static final String RETRY_HANDLER = \"retryHandler\";\n \n-  public static final String PROP_RETRY_ENABLED = \"retryEnabled\";\n+  public static final String RETRY_ENABLED = \"retryEnabled\";\n \n-  public static final String PROP_RETRY_ONNEXT = \"retryOnNext\";\n+  public static final String RETRY_ON_NEXT = \"retryOnNext\";\n \n-  public static final String PROP_RETRY_ONSAME = \"retryOnSame\";\n+  public static final String RETRY_ON_SAME = \"retryOnSame\";\n \n   // SessionStickinessRule configruation\n   public static final String SESSION_TIMEOUT_IN_SECONDS = \"SessionStickinessRule.sessionTimeoutInSeconds\";\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTYyNTk1OQ==", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1524#discussion_r365625959", "bodyText": "getRetry can change to a better name", "author": "liubao68", "createdAt": "2020-01-13T01:01:37Z", "path": "handlers/handler-loadbalance/src/main/java/org/apache/servicecomb/loadbalance/Configuration.java", "diffHunk": "@@ -122,10 +122,14 @@ public boolean isRetryEnabled(String microservice) {\n   }\n \n   public int getRetryOnNext(String microservice) {\n+    return getRetry(microservice, PROP_RETRY_ONNEXT);\n+  }\n+\n+  private int getRetry(String microservice, String propRetry) {", "originalCommit": "61ba0671f5a07eb25e2443cd88062a6624c62b07", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTY2ODEwNQ==", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1524#discussion_r365668105", "bodyText": "Name changing takes com.netflix.client.DefaultLoadBalanceRetryHandler naming as reference.", "author": "AngLi2", "createdAt": "2020-01-13T07:23:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTYyNTk1OQ=="}], "type": "inlineReview", "revised_code": {"commit": "6dd9dd3890afda4eb8e0430d3ca153a42c2ebcf6", "chunk": "diff --git a/handlers/handler-loadbalance/src/main/java/org/apache/servicecomb/loadbalance/Configuration.java b/handlers/handler-loadbalance/src/main/java/org/apache/servicecomb/loadbalance/Configuration.java\nindex 072b4f1de..0720ca57d 100644\n--- a/handlers/handler-loadbalance/src/main/java/org/apache/servicecomb/loadbalance/Configuration.java\n+++ b/handlers/handler-loadbalance/src/main/java/org/apache/servicecomb/loadbalance/Configuration.java\n\n@@ -110,26 +110,30 @@ public final class Configuration {\n \n   public String getRetryHandler(String microservice) {\n     return getStringProperty(\"default\",\n-        PROP_ROOT + microservice + \".\" + PROP_RETRY_HANDLER,\n-        PROP_ROOT + PROP_RETRY_HANDLER);\n+        ROOT + microservice + \".\" + RETRY_HANDLER,\n+        ROOT + RETRY_HANDLER);\n   }\n \n   public boolean isRetryEnabled(String microservice) {\n     String p = getStringProperty(\"false\",\n-        PROP_ROOT + microservice + \".\" + PROP_RETRY_ENABLED,\n-        PROP_ROOT + PROP_RETRY_ENABLED);\n+        ROOT + microservice + \".\" + RETRY_ENABLED,\n+        ROOT + RETRY_ENABLED);\n     return Boolean.parseBoolean(p);\n   }\n \n-  public int getRetryOnNext(String microservice) {\n-    return getRetry(microservice, PROP_RETRY_ONNEXT);\n+  public int getRetryNextServer(String microservice) {\n+    return getRetryServer(microservice, RETRY_ON_NEXT);\n   }\n \n-  private int getRetry(String microservice, String propRetry) {\n+  public int getRetrySameServer(String microservice) {\n+    return getRetryServer(microservice, RETRY_ON_SAME);\n+  }\n+\n+  private int getRetryServer(String microservice, String retryType) {\n     final int defaultValue = 0;\n     String p = getStringProperty(\"0\",\n-        PROP_ROOT + microservice + \".\" + propRetry,\n-        PROP_ROOT + propRetry);\n+        ROOT + microservice + \".\" + retryType,\n+        ROOT + retryType);\n     try {\n       int result = Integer.parseInt(p);\n       if (result > 0) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTYyNjIwMA==", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1524#discussion_r365626200", "bodyText": "getServiceCombServerOld is never used", "author": "liubao68", "createdAt": "2020-01-13T01:05:25Z", "path": "handlers/handler-loadbalance/src/main/java/org/apache/servicecomb/loadbalance/ServiceCombLoadBalancerStats.java", "diffHunk": "@@ -104,6 +106,10 @@ public ServiceCombServerStats getServiceCombServerStats(ServiceCombServer server\n   }\n \n   public ServiceCombServer getServiceCombServer(MicroserviceInstance instance) {\n+    return serviceCombServers.get(instance.getInstanceId());\n+  }\n+\n+  public ServiceCombServer getServiceCombServerOld(MicroserviceInstance instance) {", "originalCommit": "5235085a94e0f91acd662414fe5cd0ea866f3269", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTY2NzQzMw==", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1524#discussion_r365667433", "bodyText": "deleted.", "author": "AngLi2", "createdAt": "2020-01-13T07:20:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTYyNjIwMA=="}], "type": "inlineReview", "revised_code": {"commit": "6dd9dd3890afda4eb8e0430d3ca153a42c2ebcf6", "chunk": "diff --git a/handlers/handler-loadbalance/src/main/java/org/apache/servicecomb/loadbalance/ServiceCombLoadBalancerStats.java b/handlers/handler-loadbalance/src/main/java/org/apache/servicecomb/loadbalance/ServiceCombLoadBalancerStats.java\nindex bdcd0dc7c..fd8bf906e 100644\n--- a/handlers/handler-loadbalance/src/main/java/org/apache/servicecomb/loadbalance/ServiceCombLoadBalancerStats.java\n+++ b/handlers/handler-loadbalance/src/main/java/org/apache/servicecomb/loadbalance/ServiceCombLoadBalancerStats.java\n\n@@ -109,23 +107,14 @@ public class ServiceCombLoadBalancerStats {\n     return serviceCombServers.get(instance.getInstanceId());\n   }\n \n-  public ServiceCombServer getServiceCombServerOld(MicroserviceInstance instance) {\n-    for (ServiceCombServer server : serverStatsCache.asMap().keySet()) {\n-      if (server.getInstance().equals(instance)) {\n-        return server;\n-      }\n-    }\n-    return null;\n-  }\n-\n   @VisibleForTesting\n   void setServerExpireInSeconds(int sec) {\n     this.serverExpireInSeconds = sec;\n   }\n \n   @VisibleForTesting\n-  void setTimerIntervalInMilis(int milis) {\n-    this.timerIntervalInMilis = milis;\n+  void setTimerIntervalInMillis(int millis) {\n+    this.timerIntervalInMillis = millis;\n   }\n \n   @VisibleForTesting\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTYzMDk3Nw==", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1524#discussion_r365630977", "bodyText": "timerIntervalInMilis not changed", "author": "liubao68", "createdAt": "2020-01-13T02:10:05Z", "path": "handlers/handler-loadbalance/src/main/java/org/apache/servicecomb/loadbalance/Configuration.java", "diffHunk": "@@ -29,25 +29,25 @@\n  */\n public final class Configuration {\n   //// 2.1 configuration items\n-  public static final String PROP_ROOT = \"servicecomb.loadbalance.\";\n+  public static final String ROOT = \"servicecomb.loadbalance.\";\n \n-  public static final String PROP_SERVER_EXPIRED_IN_SECONDS = \"servicecomb.loadbalance.stats.serverExpiredInSeconds\";\n+  public static final String SERVER_EXPIRED_IN_SECONDS = \"servicecomb.loadbalance.stats.serverExpiredInSeconds\";\n \n-  public static final String PROP_TIMER_INTERVAL_IN_MILLIS = \"servicecomb.loadbalance.stats.timerIntervalInMilis\";\n+  public static final String TIMER_INTERVAL_IN_MILLIS = \"servicecomb.loadbalance.stats.timerIntervalInMilis\";", "originalCommit": "7e1aa0024d2d762e29de83a8581d41bab0b04794", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTY2ODE4MQ==", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1524#discussion_r365668181", "bodyText": "done", "author": "AngLi2", "createdAt": "2020-01-13T07:24:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTYzMDk3Nw=="}], "type": "inlineReview", "revised_code": {"commit": "6dd9dd3890afda4eb8e0430d3ca153a42c2ebcf6", "chunk": "diff --git a/handlers/handler-loadbalance/src/main/java/org/apache/servicecomb/loadbalance/Configuration.java b/handlers/handler-loadbalance/src/main/java/org/apache/servicecomb/loadbalance/Configuration.java\nindex d386d81f9..0720ca57d 100644\n--- a/handlers/handler-loadbalance/src/main/java/org/apache/servicecomb/loadbalance/Configuration.java\n+++ b/handlers/handler-loadbalance/src/main/java/org/apache/servicecomb/loadbalance/Configuration.java\n\n@@ -33,7 +33,7 @@ public final class Configuration {\n \n   public static final String SERVER_EXPIRED_IN_SECONDS = \"servicecomb.loadbalance.stats.serverExpiredInSeconds\";\n \n-  public static final String TIMER_INTERVAL_IN_MILLIS = \"servicecomb.loadbalance.stats.timerIntervalInMilis\";\n+  public static final String TIMER_INTERVAL_IN_MILLIS = \"servicecomb.loadbalance.stats.timerIntervalInMillis\";\n \n   public static final String RULE_STRATEGY_NAME = \"strategy.name\";\n \n"}}, {"oid": "6dd9dd3890afda4eb8e0430d3ca153a42c2ebcf6", "url": "https://github.com/apache/servicecomb-java-chassis/commit/6dd9dd3890afda4eb8e0430d3ca153a42c2ebcf6", "message": "Rename configurations, remove unused method", "committedDate": "2020-01-13T02:14:21Z", "type": "forcePushed"}, {"oid": "e568e37ecff3068665b6af6b156b109c4995d203", "url": "https://github.com/apache/servicecomb-java-chassis/commit/e568e37ecff3068665b6af6b156b109c4995d203", "message": "Rename configurations, remove unused method, add UT", "committedDate": "2020-01-13T07:18:05Z", "type": "forcePushed"}, {"oid": "b5bf1301822fe0edc9c93646d183425fbd292041", "url": "https://github.com/apache/servicecomb-java-chassis/commit/b5bf1301822fe0edc9c93646d183425fbd292041", "message": "Rename configurations, remove unused method, add UT", "committedDate": "2020-01-13T07:27:28Z", "type": "forcePushed"}, {"oid": "714a4a05984c94a0438cc30dc336bf19c2ea844d", "url": "https://github.com/apache/servicecomb-java-chassis/commit/714a4a05984c94a0438cc30dc336bf19c2ea844d", "message": "Rename configurations, remove unused method, add UT, refactoring\nConfigMapping.java", "committedDate": "2020-01-13T07:47:22Z", "type": "commit"}, {"oid": "714a4a05984c94a0438cc30dc336bf19c2ea844d", "url": "https://github.com/apache/servicecomb-java-chassis/commit/714a4a05984c94a0438cc30dc336bf19c2ea844d", "message": "Rename configurations, remove unused method, add UT, refactoring\nConfigMapping.java", "committedDate": "2020-01-13T07:47:22Z", "type": "forcePushed"}]}