{"pr_number": 2103, "pr_title": "[SCB-2145]fix local yaml unsafe parse problem", "pr_createdAt": "2020-12-04T09:25:57Z", "pr_url": "https://github.com/apache/servicecomb-java-chassis/pull/2103", "timeline": [{"oid": "dd50a97c7686e13d71bb4200dc76b76050b38dfc", "url": "https://github.com/apache/servicecomb-java-chassis/commit/dd50a97c7686e13d71bb4200dc76b76050b38dfc", "message": "[SCB-2145]fix local yaml unsafe parse problem", "committedDate": "2020-12-04T09:23:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQ4NzU5NQ==", "url": "https://github.com/apache/servicecomb-java-chassis/pull/2103#discussion_r536487595", "bodyText": "try (InputStream is = url.openStream()) {\n    if (is != null) {\n      beans.addAll(initFromData(is));\n    }\n  }", "author": "wujimin", "createdAt": "2020-12-05T02:43:40Z", "path": "service-registry/registry-local/src/main/java/org/apache/servicecomb/localregistry/LocalRegistryStore.java", "diffHunk": "@@ -111,37 +111,38 @@ public MicroserviceInstance getSelfMicroserviceInstance() {\n   private List<RegistryBean> loadYamlBeans() {\n     List<RegistryBean> beans = new ArrayList<>();\n \n-    InputStream is = null;\n-\n     try {\n       ClassLoader loader = JvmUtils.findClassLoader();\n       Enumeration<URL> urls = loader.getResources(REGISTRY_FILE_NAME);\n+\n       while (urls.hasMoreElements()) {\n         URL url = urls.nextElement();\n-        is = url.openStream();\n-        if (is != null) {\n-          beans.addAll(initFromData(is));\n+\n+        InputStream is = null;\n+        try {\n+          is = url.openStream();\n+          if (is != null) {\n+            beans.addAll(initFromData(is));\n+          }\n+        } finally {\n+          if (is != null) {\n+            try {\n+              is.close();\n+            } catch (IOException e) {\n+              // nothing to do\n+            }\n+          }", "originalCommit": "dd50a97c7686e13d71bb4200dc76b76050b38dfc", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5b511190fdd9c33cd3e4e363daced8dad8ddc6cd", "chunk": "diff --git a/service-registry/registry-local/src/main/java/org/apache/servicecomb/localregistry/LocalRegistryStore.java b/service-registry/registry-local/src/main/java/org/apache/servicecomb/localregistry/LocalRegistryStore.java\nindex 98c43f4d5..4e6cba555 100644\n--- a/service-registry/registry-local/src/main/java/org/apache/servicecomb/localregistry/LocalRegistryStore.java\n+++ b/service-registry/registry-local/src/main/java/org/apache/servicecomb/localregistry/LocalRegistryStore.java\n\n@@ -118,20 +118,10 @@ public class LocalRegistryStore {\n       while (urls.hasMoreElements()) {\n         URL url = urls.nextElement();\n \n-        InputStream is = null;\n-        try {\n-          is = url.openStream();\n+        try (InputStream is = url.openStream()) {\n           if (is != null) {\n             beans.addAll(initFromData(is));\n           }\n-        } finally {\n-          if (is != null) {\n-            try {\n-              is.close();\n-            } catch (IOException e) {\n-              // nothing to do\n-            }\n-          }\n         }\n       }\n     } catch (IOException e) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQ4ODczNQ==", "url": "https://github.com/apache/servicecomb-java-chassis/pull/2103#discussion_r536488735", "bodyText": "\u521b\u5efastream\u7684\u5730\u65b9\u7528try-with-resource\uff0c\u5e94\u8be5\u66f4\u5408\u9002", "author": "wujimin", "createdAt": "2020-12-05T02:50:30Z", "path": "service-registry/registry-service-center/src/test/java/org/apache/servicecomb/serviceregistry/client/LocalServiceRegistryClientImpl.java", "diffHunk": "@@ -94,10 +95,16 @@ public LocalServiceRegistryClientImpl(Map<String, Object> data) {\n   }\n \n   private void initFromData(InputStream is) {\n-    Yaml yaml = new Yaml();\n-    @SuppressWarnings(\"unchecked\")\n-    Map<String, Object> data = yaml.loadAs(is, Map.class);\n-    initFromData(data);\n+    try {\n+      Map<String, Object> data = YAMLUtil.yaml2Properties(is);\n+      initFromData(data);\n+    } finally {\n+      try {\n+        is.close();\n+      } catch (IOException e) {\n+        LOGGER.error(\"\", e);\n+      }\n+    }", "originalCommit": "dd50a97c7686e13d71bb4200dc76b76050b38dfc", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5b511190fdd9c33cd3e4e363daced8dad8ddc6cd", "chunk": "diff --git a/service-registry/registry-service-center/src/test/java/org/apache/servicecomb/serviceregistry/client/LocalServiceRegistryClientImpl.java b/service-registry/registry-service-center/src/test/java/org/apache/servicecomb/serviceregistry/client/LocalServiceRegistryClientImpl.java\nindex 202e301ae..f2827b1e3 100644\n--- a/service-registry/registry-service-center/src/test/java/org/apache/servicecomb/serviceregistry/client/LocalServiceRegistryClientImpl.java\n+++ b/service-registry/registry-service-center/src/test/java/org/apache/servicecomb/serviceregistry/client/LocalServiceRegistryClientImpl.java\n\n@@ -78,33 +79,26 @@ public class LocalServiceRegistryClientImpl implements ServiceRegistryClient {\n       return;\n     }\n \n-    InputStream is = this.getClass().getClassLoader().getResourceAsStream(localFile);\n-    if (is == null) {\n-      return;\n+    try {\n+      try (InputStream is = this.getClass().getClassLoader().getResourceAsStream(localFile)) {\n+        if (is == null) {\n+          return;\n+        }\n+        initFromData(is);\n+      }\n+    } catch (IOException e) {\n+      LOGGER.error(\"\", e);\n     }\n-\n-    initFromData(is);\n   }\n \n-  public LocalServiceRegistryClientImpl(InputStream is) {\n+  @VisibleForTesting\n+  LocalServiceRegistryClientImpl(InputStream is) {\n     initFromData(is);\n   }\n \n-  public LocalServiceRegistryClientImpl(Map<String, Object> data) {\n-    initFromData(data);\n-  }\n-\n   private void initFromData(InputStream is) {\n-    try {\n-      Map<String, Object> data = YAMLUtil.yaml2Properties(is);\n-      initFromData(data);\n-    } finally {\n-      try {\n-        is.close();\n-      } catch (IOException e) {\n-        LOGGER.error(\"\", e);\n-      }\n-    }\n+    Map<String, Object> data = YAMLUtil.yaml2Properties(is);\n+    initFromData(data);\n   }\n \n   private void initFromData(Map<String, Object> data) {\n"}}, {"oid": "5b511190fdd9c33cd3e4e363daced8dad8ddc6cd", "url": "https://github.com/apache/servicecomb-java-chassis/commit/5b511190fdd9c33cd3e4e363daced8dad8ddc6cd", "message": "[SCB-2145]fix review comments", "committedDate": "2020-12-05T03:10:58Z", "type": "commit"}]}