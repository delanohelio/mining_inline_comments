{"pr_number": 1521, "pr_title": "[SCB-1715] Fix idleTimeout not work in client side without keepaliveT\u2026", "pr_createdAt": "2020-01-11T01:45:22Z", "pr_url": "https://github.com/apache/servicecomb-java-chassis/pull/1521", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTYyNTY4MA==", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1521#discussion_r365625680", "bodyText": "Maybe http2 will also need to modify, see", "author": "liubao68", "createdAt": "2020-01-13T00:57:09Z", "path": "transports/transport-rest/transport-rest-client/src/main/java/org/apache/servicecomb/transport/rest/client/RestTransportClient.java", "diffHunk": "@@ -77,6 +77,7 @@ private static HttpClientOptions createHttpClientOptions() {\n     HttpClientOptions httpClientOptions = new HttpClientOptions();\n     httpClientOptions.setMaxPoolSize(TransportClientConfig.getConnectionMaxPoolSize())\n         .setIdleTimeout(TransportClientConfig.getConnectionIdleTimeoutInSeconds())\n+        .setKeepAliveTimeout(TransportClientConfig.getConnectionIdleTimeoutInSeconds())", "originalCommit": "ffffdafda07261cbc1a1fb337153acd645ab6551", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c3f06dc57d0c7a23d930222320302ee9fbb460c7", "chunk": "diff --git a/transports/transport-rest/transport-rest-client/src/main/java/org/apache/servicecomb/transport/rest/client/RestTransportClient.java b/transports/transport-rest/transport-rest-client/src/main/java/org/apache/servicecomb/transport/rest/client/RestTransportClient.java\nindex 278214685..7baab729f 100644\n--- a/transports/transport-rest/transport-rest-client/src/main/java/org/apache/servicecomb/transport/rest/client/RestTransportClient.java\n+++ b/transports/transport-rest/transport-rest-client/src/main/java/org/apache/servicecomb/transport/rest/client/RestTransportClient.java\n\n@@ -57,47 +58,39 @@ public class RestTransportClient {\n   public void init(Vertx vertx) throws Exception {\n     httpClientFilters = SPIServiceUtils.getSortedService(HttpClientFilter.class);\n \n-    HttpClientOptions httpClientOptions = createHttpClientOptions();\n+    HttpClientOptions httpClientOptions = createHttpClientOptions(false);\n     clientMgr = new ClientPoolManager<>(vertx, new HttpClientPoolFactory(httpClientOptions));\n \n-    HttpClientOptions httpClientOptionshttp2 = createHttp2ClientOptions();\n+    HttpClientOptions httpClientOptionsHttp2 = createHttpClientOptions(true);\n \n-    clientMgrHttp2 = new ClientPoolManager<>(vertx, new HttpClientPoolFactory(httpClientOptionshttp2));\n+    clientMgrHttp2 = new ClientPoolManager<>(vertx, new HttpClientPoolFactory(httpClientOptionsHttp2));\n \n     DeploymentOptions deployOptions = VertxUtils.createClientDeployOptions(clientMgr,\n         TransportClientConfig.getThreadCount());\n     VertxUtils.blockDeploy(vertx, ClientVerticle.class, deployOptions);\n \n-    DeploymentOptions deployOptionshttp2 = VertxUtils.createClientDeployOptions(clientMgrHttp2,\n+    DeploymentOptions deployOptionsHttp2 = VertxUtils.createClientDeployOptions(clientMgrHttp2,\n         TransportClientConfig.getThreadCount());\n-    VertxUtils.blockDeploy(vertx, ClientVerticle.class, deployOptionshttp2);\n+    VertxUtils.blockDeploy(vertx, ClientVerticle.class, deployOptionsHttp2);\n   }\n \n-  private static HttpClientOptions createHttpClientOptions() {\n+  private static HttpClientOptions createHttpClientOptions(boolean http2) {\n     HttpClientOptions httpClientOptions = new HttpClientOptions();\n-    httpClientOptions.setMaxPoolSize(TransportClientConfig.getConnectionMaxPoolSize())\n-        .setIdleTimeout(TransportClientConfig.getConnectionIdleTimeoutInSeconds())\n+    httpClientOptions.setIdleTimeout(TransportClientConfig.getConnectionIdleTimeoutInSeconds())\n         .setKeepAliveTimeout(TransportClientConfig.getConnectionIdleTimeoutInSeconds())\n-        .setKeepAlive(TransportClientConfig.getConnectionKeepAlive())\n         .setTryUseCompression(TransportClientConfig.getConnectionCompression())\n-        .setMaxHeaderSize(TransportClientConfig.getMaxHeaderSize())\n         .setMaxWaitQueueSize(TransportClientConfig.getMaxWaitQueueSize());\n-\n-    VertxTLSBuilder.buildHttpClientOptions(SSL_KEY, httpClientOptions);\n-    return httpClientOptions;\n-  }\n-\n-  private static HttpClientOptions createHttp2ClientOptions() {\n-    HttpClientOptions httpClientOptions = new HttpClientOptions();\n-    httpClientOptions.setUseAlpn(TransportClientConfig.getUseAlpn())\n-        .setHttp2ClearTextUpgrade(false)\n-        .setProtocolVersion(HttpVersion.HTTP_2)\n-        .setIdleTimeout(TransportClientConfig.getHttp2ConnectionIdleTimeoutInSeconds())\n-        .setHttp2MultiplexingLimit(TransportClientConfig.getHttp2MultiplexingLimit())\n-        .setHttp2MaxPoolSize(TransportClientConfig.getHttp2ConnectionMaxPoolSize())\n-        .setTryUseCompression(TransportClientConfig.getConnectionCompression())\n-        .setMaxWaitQueueSize(TransportClientConfig.getMaxWaitQueueSize());\n-\n+    if (http2) {\n+      httpClientOptions.setUseAlpn(TransportClientConfig.getUseAlpn())\n+          .setHttp2ClearTextUpgrade(false)\n+          .setProtocolVersion(HttpVersion.HTTP_2)\n+          .setHttp2MultiplexingLimit(TransportClientConfig.getHttp2MultiplexingLimit())\n+          .setHttp2MaxPoolSize(TransportClientConfig.getHttp2ConnectionMaxPoolSize());\n+    } else {\n+      httpClientOptions.setMaxPoolSize(TransportClientConfig.getConnectionMaxPoolSize())\n+          .setKeepAlive(TransportClientConfig.getConnectionKeepAlive())\n+          .setMaxHeaderSize(TransportClientConfig.getMaxHeaderSize());\n+    }\n     VertxTLSBuilder.buildHttpClientOptions(SSL_KEY, httpClientOptions);\n     return httpClientOptions;\n   }\n"}}, {"oid": "c3f06dc57d0c7a23d930222320302ee9fbb460c7", "url": "https://github.com/apache/servicecomb-java-chassis/commit/c3f06dc57d0c7a23d930222320302ee9fbb460c7", "message": "[SCB-1715] Fix idleTimeout not work in client side without keepaliveTimeout set", "committedDate": "2020-01-13T01:28:19Z", "type": "forcePushed"}, {"oid": "9eaed2025588abdc7c3e44639ad8ccbf7a713e15", "url": "https://github.com/apache/servicecomb-java-chassis/commit/9eaed2025588abdc7c3e44639ad8ccbf7a713e15", "message": "[SCB-1715] Fix idleTimeout not work in client side without keepaliveTimeout set", "committedDate": "2020-01-13T01:29:57Z", "type": "forcePushed"}, {"oid": "d3ca5034374831567fcc11db7babb5806912a96a", "url": "https://github.com/apache/servicecomb-java-chassis/commit/d3ca5034374831567fcc11db7babb5806912a96a", "message": "[SCB-1715] Fix idleTimeout not work in client side without keepaliveTimeout set", "committedDate": "2020-01-13T02:09:31Z", "type": "commit"}, {"oid": "d3ca5034374831567fcc11db7babb5806912a96a", "url": "https://github.com/apache/servicecomb-java-chassis/commit/d3ca5034374831567fcc11db7babb5806912a96a", "message": "[SCB-1715] Fix idleTimeout not work in client side without keepaliveTimeout set", "committedDate": "2020-01-13T02:09:31Z", "type": "forcePushed"}]}