{"pr_number": 1561, "pr_title": "[SCB-1748] support colon in path value", "pr_createdAt": "2020-02-07T06:50:13Z", "pr_url": "https://github.com/apache/servicecomb-java-chassis/pull/1561", "timeline": [{"oid": "5c1733733facffe4a4c78d0d90e29d4bb43f0ae7", "url": "https://github.com/apache/servicecomb-java-chassis/commit/5c1733733facffe4a4c78d0d90e29d4bb43f0ae7", "message": "[SCB-1748] support colon", "committedDate": "2020-02-07T07:12:39Z", "type": "commit"}, {"oid": "5c1733733facffe4a4c78d0d90e29d4bb43f0ae7", "url": "https://github.com/apache/servicecomb-java-chassis/commit/5c1733733facffe4a4c78d0d90e29d4bb43f0ae7", "message": "[SCB-1748] support colon", "committedDate": "2020-02-07T07:12:39Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjI2Nzg3OA==", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1561#discussion_r376267878", "bodyText": "I think this modification is not correct. You can add a test case for HttpUtils, like\n  @Test\n  public void uriEncode_sss() {\n    String encoded = HttpUtils.uriEncodePath(\"a:b\");\n    Assert.assertEquals(\"a:b\", encoded);\n    Assert.assertEquals(\"a:b\", HttpUtils.uriDecodePath(encoded));\n  }\n\n\nAnd make this case pass.", "author": "liubao68", "createdAt": "2020-02-07T08:33:07Z", "path": "common/common-rest/src/main/java/org/apache/servicecomb/common/rest/codec/param/PathProcessorCreator.java", "diffHunk": "@@ -52,6 +54,9 @@ public Object getValue(HttpServletRequest request) {\n       if (value == null) {\n         return null;\n       }\n+      if (value.contains(\":\")) {\n+        return convertValue(URLDecoder.decode(value, \"UTF-8\"), targetType);", "originalCommit": "5c1733733facffe4a4c78d0d90e29d4bb43f0ae7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjI3NTE1Mg==", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1561#discussion_r376275152", "bodyText": "I notic there is a case org.apache.servicecomb.foundation.common.http.TestHttpUtils#uriDecode_failed\nto show a error when the param of HttpUtils.uriDecodePath contain \":\".\nI think modify  the HttpUtils.uriDecodePat will change the previous  logic.", "author": "GuoYL123", "createdAt": "2020-02-07T08:50:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjI2Nzg3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjMwMjY5Mg==", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1561#discussion_r376302692", "bodyText": "Maybe this test case is not correct. Checked the RFC\n3.3. Path Component\n\n   The path component contains data, specific to the authority (or the\n   scheme if there is no authority component), identifying the resource\n   within the scope of that scheme and authority.\n\n      path          = [ abs_path | opaque_part ]\n\n      path_segments = segment *( \"/\" segment )\n      segment       = *pchar *( \";\" param )\n      param         = *pchar\n\n      pchar         = unreserved | escaped |\n                      \":\" | \"@\" | \"&\" | \"=\" | \"+\" | \"$\" | \",\"\n\n   The path may consist of a sequence of path segments separated by a\n   single slash \"/\" character.  Within a path segment, the characters\n   \"/\", \";\", \"=\", and \"?\" are reserved.  Each path segment may include a\n   sequence of parameters, indicated by the semicolon \";\" character.\n   The parameters are not significant to the parsing of relative\n   references.\n\nyou can also query @wujimin for the reason of the test case.", "author": "liubao68", "createdAt": "2020-02-07T09:51:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjI2Nzg3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjMwNTQzOQ==", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1561#discussion_r376305439", "bodyText": "I checked the code again. May be \"encodePathParam\" and \"decodePathParam\" should be used here. You need check details usage of \"uriEncodePath\" and \"uriDecodePath\". They are different.", "author": "liubao68", "createdAt": "2020-02-07T09:57:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjI2Nzg3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njg0NjE2MA==", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1561#discussion_r376846160", "bodyText": "Add decodePathParam method.", "author": "GuoYL123", "createdAt": "2020-02-10T02:26:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjI2Nzg3OA=="}], "type": "inlineReview", "revised_code": {"commit": "6940be2bd887d55f2b3520587cc6410840f43a76", "chunk": "diff --git a/common/common-rest/src/main/java/org/apache/servicecomb/common/rest/codec/param/PathProcessorCreator.java b/common/common-rest/src/main/java/org/apache/servicecomb/common/rest/codec/param/PathProcessorCreator.java\nindex 896e87068..75fc3179b 100644\n--- a/common/common-rest/src/main/java/org/apache/servicecomb/common/rest/codec/param/PathProcessorCreator.java\n+++ b/common/common-rest/src/main/java/org/apache/servicecomb/common/rest/codec/param/PathProcessorCreator.java\n\n@@ -54,10 +54,7 @@ public class PathProcessorCreator implements ParamValueProcessorCreator {\n       if (value == null) {\n         return null;\n       }\n-      if (value.contains(\":\")) {\n-        return convertValue(URLDecoder.decode(value, \"UTF-8\"), targetType);\n-      }\n-      return convertValue(HttpUtils.uriDecodePath(value), targetType);\n+      return convertValue(HttpUtils.decodePathParam(value), targetType);\n     }\n \n     @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk5NzIwNQ==", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1561#discussion_r377997205", "bodyText": "remove unused import", "author": "liubao68", "createdAt": "2020-02-12T01:35:19Z", "path": "common/common-rest/src/main/java/org/apache/servicecomb/common/rest/codec/param/PathProcessorCreator.java", "diffHunk": "@@ -17,7 +17,9 @@\n \n package org.apache.servicecomb.common.rest.codec.param;\n \n+import java.io.UnsupportedEncodingException;\n import java.lang.reflect.Type;\n+import java.net.URLDecoder;", "originalCommit": "bcdbfc4668ca42addfba988bde611a8efc67d752", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODAzNTI5Mw==", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1561#discussion_r378035293", "bodyText": "done", "author": "GuoYL123", "createdAt": "2020-02-12T04:26:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk5NzIwNQ=="}], "type": "inlineReview", "revised_code": {"commit": "d12e34122c0e8723df67c802eaf618360cdf7760", "chunk": "diff --git a/common/common-rest/src/main/java/org/apache/servicecomb/common/rest/codec/param/PathProcessorCreator.java b/common/common-rest/src/main/java/org/apache/servicecomb/common/rest/codec/param/PathProcessorCreator.java\nindex 75fc3179b..cffb1f470 100644\n--- a/common/common-rest/src/main/java/org/apache/servicecomb/common/rest/codec/param/PathProcessorCreator.java\n+++ b/common/common-rest/src/main/java/org/apache/servicecomb/common/rest/codec/param/PathProcessorCreator.java\n\n@@ -17,22 +17,22 @@\n \n package org.apache.servicecomb.common.rest.codec.param;\n \n-import java.io.UnsupportedEncodingException;\n import java.lang.reflect.Type;\n-import java.net.URLDecoder;\n+import java.nio.charset.Charset;\n+import java.nio.charset.StandardCharsets;\n import java.util.Map;\n \n import javax.servlet.http.HttpServletRequest;\n \n import org.apache.servicecomb.common.rest.RestConst;\n import org.apache.servicecomb.common.rest.codec.RestClientRequest;\n-import org.apache.servicecomb.foundation.common.http.HttpUtils;\n \n import com.fasterxml.jackson.databind.JavaType;\n import com.fasterxml.jackson.databind.type.TypeFactory;\n \n import io.swagger.models.parameters.Parameter;\n import io.swagger.models.parameters.PathParameter;\n+import org.springframework.util.StringUtils;\n \n public class PathProcessorCreator implements ParamValueProcessorCreator {\n   public static final String PARAMTYPE = \"path\";\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk5ODcyNg==", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1561#discussion_r377998726", "bodyText": "Is  URLDecoder.decode(pathParam, \"UTF-8\"); is enough?  I think it is enough to use URLEncoder and URLDecoder to encode/decode path segments, and use URI to encode/decode path.", "author": "liubao68", "createdAt": "2020-02-12T01:41:01Z", "path": "foundations/foundation-common/src/main/java/org/apache/servicecomb/foundation/common/http/HttpUtils.java", "diffHunk": "@@ -94,6 +97,14 @@ public static String encodePathParam(String pathParam) {\n     return UrlEscapers.urlPathSegmentEscaper().escape(pathParam);\n   }\n \n+  public static String decodePathParam(String pathParam) throws UnsupportedEncodingException {\n+    String res = uriDecodePath(pathParam);\n+    if (StringUtils.isEmpty(res)) {\n+      return URLDecoder.decode(pathParam, \"UTF-8\");", "originalCommit": "bcdbfc4668ca42addfba988bde611a8efc67d752", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODAzNDQyOA==", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1561#discussion_r378034428", "bodyText": "URLDecoder.decode(pathParam, \"UTF-8\")  can not handle the '+' .\nthere is a ut show that : org.apache.servicecomb.common.rest.codec.param.TestPathProcessor#testGetPlus.", "author": "GuoYL123", "createdAt": "2020-02-12T04:22:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk5ODcyNg=="}], "type": "inlineReview", "revised_code": {"commit": "d12e34122c0e8723df67c802eaf618360cdf7760", "chunk": "diff --git a/foundations/foundation-common/src/main/java/org/apache/servicecomb/foundation/common/http/HttpUtils.java b/foundations/foundation-common/src/main/java/org/apache/servicecomb/foundation/common/http/HttpUtils.java\nindex 21060ebf3..2e32bc15e 100644\n--- a/foundations/foundation-common/src/main/java/org/apache/servicecomb/foundation/common/http/HttpUtils.java\n+++ b/foundations/foundation-common/src/main/java/org/apache/servicecomb/foundation/common/http/HttpUtils.java\n\n@@ -97,14 +92,6 @@ public final class HttpUtils {\n     return UrlEscapers.urlPathSegmentEscaper().escape(pathParam);\n   }\n \n-  public static String decodePathParam(String pathParam) throws UnsupportedEncodingException {\n-    String res = uriDecodePath(pathParam);\n-    if (StringUtils.isEmpty(res)) {\n-      return URLDecoder.decode(pathParam, \"UTF-8\");\n-    }\n-    return res;\n-  }\n-\n   public static String uriDecodePath(String path) {\n     if (path == null) {\n       return null;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk5OTAzMw==", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1561#discussion_r377999033", "bodyText": "This function seems not correct. According to the java docs, URL(path) will not parse the path, users should use\nnew URI(null, null, path, null); to parse the parse", "author": "liubao68", "createdAt": "2020-02-12T01:42:16Z", "path": "foundations/foundation-common/src/main/java/org/apache/servicecomb/foundation/common/http/HttpUtils.java", "diffHunk": "@@ -94,6 +97,14 @@ public static String encodePathParam(String pathParam) {\n     return UrlEscapers.urlPathSegmentEscaper().escape(pathParam);\n   }\n \n+  public static String decodePathParam(String pathParam) throws UnsupportedEncodingException {\n+    String res = uriDecodePath(pathParam);\n+    if (StringUtils.isEmpty(res)) {\n+      return URLDecoder.decode(pathParam, \"UTF-8\");\n+    }\n+    return res;\n+  }\n+\n   public static String uriDecodePath(String path) {\n     if (path == null) {", "originalCommit": "bcdbfc4668ca42addfba988bde611a8efc67d752", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODAzNTA2OA==", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1561#discussion_r378035068", "bodyText": "use new URI(null, null, path, null); will cause ut failed:\norg.apache.servicecomb.common.rest.codec.param.TestPathProcessor#testGetSpaceEncoded\nnew URI(null, null, path, null); can not convert '%20' to ' '", "author": "GuoYL123", "createdAt": "2020-02-12T04:25:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk5OTAzMw=="}], "type": "inlineReview", "revised_code": {"commit": "d12e34122c0e8723df67c802eaf618360cdf7760", "chunk": "diff --git a/foundations/foundation-common/src/main/java/org/apache/servicecomb/foundation/common/http/HttpUtils.java b/foundations/foundation-common/src/main/java/org/apache/servicecomb/foundation/common/http/HttpUtils.java\nindex 21060ebf3..2e32bc15e 100644\n--- a/foundations/foundation-common/src/main/java/org/apache/servicecomb/foundation/common/http/HttpUtils.java\n+++ b/foundations/foundation-common/src/main/java/org/apache/servicecomb/foundation/common/http/HttpUtils.java\n\n@@ -97,14 +92,6 @@ public final class HttpUtils {\n     return UrlEscapers.urlPathSegmentEscaper().escape(pathParam);\n   }\n \n-  public static String decodePathParam(String pathParam) throws UnsupportedEncodingException {\n-    String res = uriDecodePath(pathParam);\n-    if (StringUtils.isEmpty(res)) {\n-      return URLDecoder.decode(pathParam, \"UTF-8\");\n-    }\n-    return res;\n-  }\n-\n   public static String uriDecodePath(String path) {\n     if (path == null) {\n       return null;\n"}}, {"oid": "6940be2bd887d55f2b3520587cc6410840f43a76", "url": "https://github.com/apache/servicecomb-java-chassis/commit/6940be2bd887d55f2b3520587cc6410840f43a76", "message": "[SCB-1748] modify as comment", "committedDate": "2020-02-12T04:26:23Z", "type": "commit"}, {"oid": "6940be2bd887d55f2b3520587cc6410840f43a76", "url": "https://github.com/apache/servicecomb-java-chassis/commit/6940be2bd887d55f2b3520587cc6410840f43a76", "message": "[SCB-1748] modify as comment", "committedDate": "2020-02-12T04:26:23Z", "type": "forcePushed"}, {"oid": "90a0e38dee162ce7c491f73c33d67e031eee24d0", "url": "https://github.com/apache/servicecomb-java-chassis/commit/90a0e38dee162ce7c491f73c33d67e031eee24d0", "message": "Merge remote-tracking branch 'remotes/origin/master' into maohao", "committedDate": "2020-02-12T06:25:58Z", "type": "commit"}, {"oid": "f324478374a65502ee4280efe0fdb77f14e20dc2", "url": "https://github.com/apache/servicecomb-java-chassis/commit/f324478374a65502ee4280efe0fdb77f14e20dc2", "message": "test IT", "committedDate": "2020-02-12T08:33:13Z", "type": "commit"}, {"oid": "d12e34122c0e8723df67c802eaf618360cdf7760", "url": "https://github.com/apache/servicecomb-java-chassis/commit/d12e34122c0e8723df67c802eaf618360cdf7760", "message": "use spring way", "committedDate": "2020-02-12T10:40:28Z", "type": "commit"}, {"oid": "d12e34122c0e8723df67c802eaf618360cdf7760", "url": "https://github.com/apache/servicecomb-java-chassis/commit/d12e34122c0e8723df67c802eaf618360cdf7760", "message": "use spring way", "committedDate": "2020-02-12T10:40:28Z", "type": "forcePushed"}]}