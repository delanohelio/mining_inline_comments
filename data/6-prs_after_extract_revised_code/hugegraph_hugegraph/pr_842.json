{"pr_number": 842, "pr_title": "Fix mysql backend openWithoutDB ssl-mode not work", "pr_createdAt": "2020-01-22T02:49:39Z", "pr_url": "https://github.com/hugegraph/hugegraph/pull/842", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTQ5MTI2OQ==", "url": "https://github.com/hugegraph/hugegraph/pull/842#discussion_r369491269", "bodyText": "the origin logic is autoReconnect=false", "author": "javeme", "createdAt": "2020-01-22T10:52:40Z", "path": "hugegraph-mysql/src/main/java/com/baidu/hugegraph/backend/store/mysql/MysqlSessions.java", "diffHunk": "@@ -183,43 +183,35 @@ protected String buildExistsTable(String table) {\n      * Connect DB without specified database\n      */\n     protected Connection openWithoutDB(int timeout) {\n-        String jdbcUrl = this.config.get(MysqlOptions.JDBC_URL);\n-        String url = new URIBuilder().setPath(jdbcUrl)\n-                                     .setParameter(\"socketTimeout\",\n-                                                   String.valueOf(timeout))\n-                                     .toString();\n+        String url = this.buildUri(true, timeout);\n         try {\n             return this.connect(url);\n         } catch (SQLException e) {\n-            throw new BackendException(\"Failed to access %s\", e, jdbcUrl);\n+            throw new BackendException(\"Failed to access %s\", e, url);\n         }\n     }\n \n     /**\n      * Connect DB with specified database, but won't auto reconnect\n      */\n     protected Connection openWithDB(int timeout) {\n-        String jdbcUrl = this.config.get(MysqlOptions.JDBC_URL);\n-        if (jdbcUrl.endsWith(\"/\")) {\n-            jdbcUrl = String.format(\"%s%s\", jdbcUrl, this.database());\n-        } else {\n-            jdbcUrl = String.format(\"%s/%s\", jdbcUrl, this.database());\n-        }\n-        String url = new URIBuilder().setPath(jdbcUrl)\n-                                     .setParameter(\"socketTimeout\",\n-                                                   String.valueOf(timeout))\n-                                     .toString();\n+        String url = this.buildUri(true, timeout);", "originalCommit": "a4802a8980d3ee49db3289b5d8f3741cee6c6e8c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "40e962f53039921084f1d3e0908a00778a5b01d8", "chunk": "diff --git a/hugegraph-mysql/src/main/java/com/baidu/hugegraph/backend/store/mysql/MysqlSessions.java b/hugegraph-mysql/src/main/java/com/baidu/hugegraph/backend/store/mysql/MysqlSessions.java\nindex 2bb7c1e5..479aa6f2 100644\n--- a/hugegraph-mysql/src/main/java/com/baidu/hugegraph/backend/store/mysql/MysqlSessions.java\n+++ b/hugegraph-mysql/src/main/java/com/baidu/hugegraph/backend/store/mysql/MysqlSessions.java\n\n@@ -183,7 +183,7 @@ public class MysqlSessions extends BackendSessionPool {\n      * Connect DB without specified database\n      */\n     protected Connection openWithoutDB(int timeout) {\n-        String url = this.buildUri(true, timeout);\n+        String url = this.buildUri(false, timeout);\n         try {\n             return this.connect(url);\n         } catch (SQLException e) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTQ5MTcyOA==", "url": "https://github.com/hugegraph/hugegraph/pull/842#discussion_r369491728", "bodyText": "the origin logic is autoReconnect=false and no database parameter", "author": "javeme", "createdAt": "2020-01-22T10:53:37Z", "path": "hugegraph-mysql/src/main/java/com/baidu/hugegraph/backend/store/mysql/MysqlSessions.java", "diffHunk": "@@ -183,43 +183,35 @@ protected String buildExistsTable(String table) {\n      * Connect DB without specified database\n      */\n     protected Connection openWithoutDB(int timeout) {\n-        String jdbcUrl = this.config.get(MysqlOptions.JDBC_URL);\n-        String url = new URIBuilder().setPath(jdbcUrl)\n-                                     .setParameter(\"socketTimeout\",\n-                                                   String.valueOf(timeout))\n-                                     .toString();\n+        String url = this.buildUri(true, timeout);", "originalCommit": "a4802a8980d3ee49db3289b5d8f3741cee6c6e8c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDQ5NTU3OA==", "url": "https://github.com/hugegraph/hugegraph/pull/842#discussion_r380495578", "bodyText": "autoReconnect really do not need, but need useSSL param", "author": "Linary", "createdAt": "2020-02-18T07:24:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTQ5MTcyOA=="}], "type": "inlineReview", "revised_code": {"commit": "40e962f53039921084f1d3e0908a00778a5b01d8", "chunk": "diff --git a/hugegraph-mysql/src/main/java/com/baidu/hugegraph/backend/store/mysql/MysqlSessions.java b/hugegraph-mysql/src/main/java/com/baidu/hugegraph/backend/store/mysql/MysqlSessions.java\nindex 2bb7c1e5..479aa6f2 100644\n--- a/hugegraph-mysql/src/main/java/com/baidu/hugegraph/backend/store/mysql/MysqlSessions.java\n+++ b/hugegraph-mysql/src/main/java/com/baidu/hugegraph/backend/store/mysql/MysqlSessions.java\n\n@@ -183,7 +183,7 @@ public class MysqlSessions extends BackendSessionPool {\n      * Connect DB without specified database\n      */\n     protected Connection openWithoutDB(int timeout) {\n-        String url = this.buildUri(true, timeout);\n+        String url = this.buildUri(false, timeout);\n         try {\n             return this.connect(url);\n         } catch (SQLException e) {\n"}}, {"oid": "a75edf27e701b6c20ae2c42fa889838c05685f44", "url": "https://github.com/hugegraph/hugegraph/commit/a75edf27e701b6c20ae2c42fa889838c05685f44", "message": "Fix mysql backend openWithoutDB ssl-mode not work\n\nChange-Id: I3bf5ef9deae121a51f4e1b4ce8132958194bde31", "committedDate": "2020-02-18T07:03:48Z", "type": "commit"}, {"oid": "40e962f53039921084f1d3e0908a00778a5b01d8", "url": "https://github.com/hugegraph/hugegraph/commit/40e962f53039921084f1d3e0908a00778a5b01d8", "message": "improve\n\nChange-Id: I542c42cb6cb5ead6f3046661f66ea0583ff1c671", "committedDate": "2020-02-18T07:34:50Z", "type": "forcePushed"}, {"oid": "8937e389c367043fa8d3db9853a5d0ef1803afac", "url": "https://github.com/hugegraph/hugegraph/commit/8937e389c367043fa8d3db9853a5d0ef1803afac", "message": "improve\n\nChange-Id: I542c42cb6cb5ead6f3046661f66ea0583ff1c671", "committedDate": "2020-02-19T08:39:44Z", "type": "commit"}, {"oid": "8937e389c367043fa8d3db9853a5d0ef1803afac", "url": "https://github.com/hugegraph/hugegraph/commit/8937e389c367043fa8d3db9853a5d0ef1803afac", "message": "improve\n\nChange-Id: I542c42cb6cb5ead6f3046661f66ea0583ff1c671", "committedDate": "2020-02-19T08:39:44Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTE0NjAwNg==", "url": "https://github.com/hugegraph/hugegraph/pull/842#discussion_r381146006", "bodyText": "rename to withDB\nand prefer to set withConnParams as first param", "author": "javeme", "createdAt": "2020-02-19T08:43:13Z", "path": "hugegraph-mysql/src/main/java/com/baidu/hugegraph/backend/store/mysql/MysqlSessions.java", "diffHunk": "@@ -207,35 +207,39 @@ protected Connection openWithDB(int timeout) {\n      * Connect DB with specified database\n      */\n     private Connection open(boolean autoReconnect) throws SQLException {\n-        String url = this.buildUri(autoReconnect, null);\n+        String url = this.buildUri(true, true, autoReconnect, null);\n         return this.connect(url);\n     }\n \n-    protected String buildUri(boolean autoReconnect, Integer timeout) {\n+    protected String buildUri(boolean withdb, boolean withConnParams,", "originalCommit": "8937e389c367043fa8d3db9853a5d0ef1803afac", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1e46ed05b7e6a78b70ffe3d4d9241cdeeb3270f7", "chunk": "diff --git a/hugegraph-mysql/src/main/java/com/baidu/hugegraph/backend/store/mysql/MysqlSessions.java b/hugegraph-mysql/src/main/java/com/baidu/hugegraph/backend/store/mysql/MysqlSessions.java\nindex bce90c25..9fddb4f4 100644\n--- a/hugegraph-mysql/src/main/java/com/baidu/hugegraph/backend/store/mysql/MysqlSessions.java\n+++ b/hugegraph-mysql/src/main/java/com/baidu/hugegraph/backend/store/mysql/MysqlSessions.java\n\n@@ -211,10 +211,10 @@ public class MysqlSessions extends BackendSessionPool {\n         return this.connect(url);\n     }\n \n-    protected String buildUri(boolean withdb, boolean withConnParams,\n+    protected String buildUri(boolean withConnParams, boolean withDB,\n                               boolean autoReconnect, Integer timeout) {\n         String url = this.config.get(MysqlOptions.JDBC_URL);\n-        if (withdb) {\n+        if (withDB) {\n             if (url.endsWith(\"/\")) {\n                 url = String.format(\"%s%s\", url, this.database());\n             } else {\n"}}, {"oid": "1e46ed05b7e6a78b70ffe3d4d9241cdeeb3270f7", "url": "https://github.com/hugegraph/hugegraph/commit/1e46ed05b7e6a78b70ffe3d4d9241cdeeb3270f7", "message": "tiny improve\n\nChange-Id: I457247da404b2dea44f272e9eec60345baa048d6", "committedDate": "2020-02-19T09:07:26Z", "type": "commit"}]}