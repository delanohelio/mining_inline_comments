{"pr_number": 868, "pr_title": "speed up hbase truncate with disableTableAsync()", "pr_createdAt": "2020-02-25T16:44:34Z", "pr_url": "https://github.com/hugegraph/hugegraph/pull/868", "timeline": [{"oid": "8c15140c31b343d1b7e094b94fe1e457d0772478", "url": "https://github.com/hugegraph/hugegraph/commit/8c15140c31b343d1b7e094b94fe1e457d0772478", "message": "speed up hbase truncate with disableTableAsync()\n\nOptimized hbase clear() cost time from 19s to 6s\n\nimprove: #770\nChange-Id: Ie4da8b77a4ce63d388322c838415870e7225ae21", "committedDate": "2020-02-25T16:45:29Z", "type": "commit"}, {"oid": "52d02fc87a7bd34603c3a6785018143e77dc9766", "url": "https://github.com/hugegraph/hugegraph/commit/52d02fc87a7bd34603c3a6785018143e77dc9766", "message": "improve error resume and remove empty table optimize\n\nChange-Id: I701f2e105648dcd9b639c263a260a193ee00040e", "committedDate": "2020-02-25T19:10:56Z", "type": "commit"}, {"oid": "52d02fc87a7bd34603c3a6785018143e77dc9766", "url": "https://github.com/hugegraph/hugegraph/commit/52d02fc87a7bd34603c3a6785018143e77dc9766", "message": "improve error resume and remove empty table optimize\n\nChange-Id: I701f2e105648dcd9b639c263a260a193ee00040e", "committedDate": "2020-02-25T19:10:56Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDI1NzY3NQ==", "url": "https://github.com/hugegraph/hugegraph/pull/868#discussion_r384257675", "bodyText": "try( => try (", "author": "Linary", "createdAt": "2020-02-26T03:30:24Z", "path": "hugegraph-hbase/src/main/java/com/baidu/hugegraph/backend/store/hbase/HbaseSessions.java", "diffHunk": "@@ -202,15 +203,23 @@ public void dropTable(String table) throws IOException {\n         }\n     }\n \n-    public Future<Void> truncateTable(String table) throws IOException {\n+    public Future<Void> disableTable(String table) throws IOException {\n         assert this.existsTable(table);\n         TableName tableName = TableName.valueOf(this.namespace, table);\n         try(Admin admin = this.hbase.getAdmin()) {", "originalCommit": "8c15140c31b343d1b7e094b94fe1e457d0772478", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d3742bc3915c1740ce47b19a0eccf13a999a7647", "chunk": "diff --git a/hugegraph-hbase/src/main/java/com/baidu/hugegraph/backend/store/hbase/HbaseSessions.java b/hugegraph-hbase/src/main/java/com/baidu/hugegraph/backend/store/hbase/HbaseSessions.java\nindex e0388f8c..953f8dc0 100644\n--- a/hugegraph-hbase/src/main/java/com/baidu/hugegraph/backend/store/hbase/HbaseSessions.java\n+++ b/hugegraph-hbase/src/main/java/com/baidu/hugegraph/backend/store/hbase/HbaseSessions.java\n\n@@ -203,10 +204,25 @@ public class HbaseSessions extends BackendSessionPool {\n         }\n     }\n \n-    public Future<Void> disableTable(String table) throws IOException {\n+    public void enableTable(String table) throws IOException {\n         assert this.existsTable(table);\n         TableName tableName = TableName.valueOf(this.namespace, table);\n-        try(Admin admin = this.hbase.getAdmin()) {\n+        try (Admin admin = this.hbase.getAdmin()) {\n+            if (admin.isTableEnabled(tableName)) {\n+                return;\n+            }\n+            try {\n+                admin.enableTable(tableName);\n+            } catch (TableNotDisabledException ignored) {\n+                // pass\n+            }\n+        }\n+    }\n+\n+    public Future<Void> disableTableAsync(String table) throws IOException {\n+        assert this.existsTable(table);\n+        TableName tableName = TableName.valueOf(this.namespace, table);\n+        try (Admin admin = this.hbase.getAdmin()) {\n             try {\n                 return admin.disableTableAsync(tableName);\n             } catch (TableNotEnabledException ignored) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDI1NzcyMg==", "url": "https://github.com/hugegraph/hugegraph/pull/868#discussion_r384257722", "bodyText": "ditto", "author": "Linary", "createdAt": "2020-02-26T03:30:38Z", "path": "hugegraph-hbase/src/main/java/com/baidu/hugegraph/backend/store/hbase/HbaseSessions.java", "diffHunk": "@@ -202,15 +203,23 @@ public void dropTable(String table) throws IOException {\n         }\n     }\n \n-    public Future<Void> truncateTable(String table) throws IOException {\n+    public Future<Void> disableTable(String table) throws IOException {\n         assert this.existsTable(table);\n         TableName tableName = TableName.valueOf(this.namespace, table);\n         try(Admin admin = this.hbase.getAdmin()) {\n             try {\n-                admin.disableTable(tableName);\n+                return admin.disableTableAsync(tableName);\n             } catch (TableNotEnabledException ignored) {\n-                // pass\n+                // Ignore if it's disabled\n+                return Futures.immediateFuture(null);\n             }\n+        }\n+    }\n+\n+    public Future<Void> truncateTable(String table) throws IOException {\n+        assert this.existsTable(table);\n+        TableName tableName = TableName.valueOf(this.namespace, table);\n+        try(Admin admin = this.hbase.getAdmin()) {", "originalCommit": "8c15140c31b343d1b7e094b94fe1e457d0772478", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d3742bc3915c1740ce47b19a0eccf13a999a7647", "chunk": "diff --git a/hugegraph-hbase/src/main/java/com/baidu/hugegraph/backend/store/hbase/HbaseSessions.java b/hugegraph-hbase/src/main/java/com/baidu/hugegraph/backend/store/hbase/HbaseSessions.java\nindex e0388f8c..953f8dc0 100644\n--- a/hugegraph-hbase/src/main/java/com/baidu/hugegraph/backend/store/hbase/HbaseSessions.java\n+++ b/hugegraph-hbase/src/main/java/com/baidu/hugegraph/backend/store/hbase/HbaseSessions.java\n\n@@ -203,10 +204,25 @@ public class HbaseSessions extends BackendSessionPool {\n         }\n     }\n \n-    public Future<Void> disableTable(String table) throws IOException {\n+    public void enableTable(String table) throws IOException {\n         assert this.existsTable(table);\n         TableName tableName = TableName.valueOf(this.namespace, table);\n-        try(Admin admin = this.hbase.getAdmin()) {\n+        try (Admin admin = this.hbase.getAdmin()) {\n+            if (admin.isTableEnabled(tableName)) {\n+                return;\n+            }\n+            try {\n+                admin.enableTable(tableName);\n+            } catch (TableNotDisabledException ignored) {\n+                // pass\n+            }\n+        }\n+    }\n+\n+    public Future<Void> disableTableAsync(String table) throws IOException {\n+        assert this.existsTable(table);\n+        TableName tableName = TableName.valueOf(this.namespace, table);\n+        try (Admin admin = this.hbase.getAdmin()) {\n             try {\n                 return admin.disableTableAsync(tableName);\n             } catch (TableNotEnabledException ignored) {\n"}}, {"oid": "d3742bc3915c1740ce47b19a0eccf13a999a7647", "url": "https://github.com/hugegraph/hugegraph/commit/d3742bc3915c1740ce47b19a0eccf13a999a7647", "message": "add a space after 'try'\n\nChange-Id: I82647d7635ce328581150b66c879d9ac202796c9", "committedDate": "2020-02-26T17:14:46Z", "type": "commit"}]}