{"pr_number": 1275, "pr_title": "Write snapshot explicity after truncate backend", "pr_createdAt": "2020-11-20T07:16:10Z", "pr_url": "https://github.com/hugegraph/hugegraph/pull/1275", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzQ5NTY4Ng==", "url": "https://github.com/hugegraph/hugegraph/pull/1275#discussion_r527495686", "bodyText": "at the same time, the store has been cleared(truncate) but init-store has not been completed", "author": "javeme", "createdAt": "2020-11-20T07:46:03Z", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/StandardHugeGraph.java", "diffHunk": "@@ -307,6 +307,16 @@ public void truncateBackend() {\n             this.storeProvider.initSystemInfo(this);\n             this.serverStarted(this.serverInfoManager().selfServerId(),\n                                this.serverInfoManager().selfServerRole());\n+            /*\n+             * Take the initiative to generate a snapshot, it can avoid this\n+             * situation: when the server restart need to read the database\n+             * (such as checkBackendVersionInfo), it happens that raft replays\n+             * the truncate log, at this time, the library has been cleared,", "originalCommit": "8c01d645b7594e1e1c5fd3830d6fa454e8f012e9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5dd76e6270251cf2619f517948d680624a242e8d", "chunk": "diff --git a/hugegraph-core/src/main/java/com/baidu/hugegraph/StandardHugeGraph.java b/hugegraph-core/src/main/java/com/baidu/hugegraph/StandardHugeGraph.java\nindex 907b5a96..adfb8d60 100644\n--- a/hugegraph-core/src/main/java/com/baidu/hugegraph/StandardHugeGraph.java\n+++ b/hugegraph-core/src/main/java/com/baidu/hugegraph/StandardHugeGraph.java\n\n@@ -311,8 +311,9 @@ public class StandardHugeGraph implements HugeGraph {\n              * Take the initiative to generate a snapshot, it can avoid this\n              * situation: when the server restart need to read the database\n              * (such as checkBackendVersionInfo), it happens that raft replays\n-             * the truncate log, at this time, the library has been cleared,\n-             * which will cause reading errors.\n+             * the truncate log, at the same time, the store has been cleared\n+             * (truncate) but init-store has not been completed, which will\n+             * cause reading errors.\n              * When restarting, load the snapshot first and then read backend,\n              * will not encounter such an intermediate state.\n              */\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzUwNTg4OQ==", "url": "https://github.com/hugegraph/hugegraph/pull/1275#discussion_r527505889", "bodyText": "set store=null if type == StoreType.ALL", "author": "javeme", "createdAt": "2020-11-20T08:05:05Z", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/StoreStateMachine.java", "diffHunk": "@@ -182,9 +195,14 @@ public void onApply(Iterator iter) {\n \n     private Object applyCommand(StoreType type, StoreAction action,\n                                 BytesBuffer buffer) {\n-        BackendStore store = this.store(type);\n-        BiConsumer<BackendStore, BytesBuffer> func = this.funcs.get(action);\n-        func.accept(store, buffer);\n+        if (type != StoreType.ALL) {\n+            BackendStore store = this.store(type);", "originalCommit": "8c01d645b7594e1e1c5fd3830d6fa454e8f012e9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5dd76e6270251cf2619f517948d680624a242e8d", "chunk": "diff --git a/hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/StoreStateMachine.java b/hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/StoreStateMachine.java\nindex 7fc14e96..73710e23 100644\n--- a/hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/StoreStateMachine.java\n+++ b/hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/StoreStateMachine.java\n\n@@ -195,14 +186,9 @@ public class StoreStateMachine extends StateMachineAdapter {\n \n     private Object applyCommand(StoreType type, StoreAction action,\n                                 BytesBuffer buffer) {\n-        if (type != StoreType.ALL) {\n-            BackendStore store = this.store(type);\n-            BiConsumer<BackendStore, BytesBuffer> func = this.biFuncs.get(action);\n-            func.accept(store, buffer);\n-        } else {\n-            Consumer<BytesBuffer> func = this.funcs.get(action);\n-            func.accept(buffer);\n-        }\n+        BackendStore store = type != StoreType.ALL ? this.store(type) : null;\n+        BiConsumer<BackendStore, BytesBuffer> func = this.funcs.get(action);\n+        func.accept(store, buffer);\n         return null;\n     }\n \n"}}, {"oid": "4268abde03a79aba7850bebfab464495000d70c5", "url": "https://github.com/hugegraph/hugegraph/commit/4268abde03a79aba7850bebfab464495000d70c5", "message": "Write snapshot explicity after truncate backend\n\nChange-Id: Ifa11b36bebcd7e702327e79d51ec68fe1fd2eebb", "committedDate": "2020-11-20T09:55:18Z", "type": "commit"}, {"oid": "5dd76e6270251cf2619f517948d680624a242e8d", "url": "https://github.com/hugegraph/hugegraph/commit/5dd76e6270251cf2619f517948d680624a242e8d", "message": "tiny improve\n\nChange-Id: I68a5314859e4a933ce3e7247797decfe712b854f", "committedDate": "2020-11-20T09:55:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU3ODM5Mg==", "url": "https://github.com/hugegraph/hugegraph/pull/1275#discussion_r527578392", "bodyText": "typo: genearet", "author": "javeme", "createdAt": "2020-11-20T09:56:51Z", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/RaftNode.java", "diffHunk": "@@ -98,6 +98,19 @@ public void shutdown() {\n         this.node.shutdown();\n     }\n \n+    public void snapshot() {\n+        if (!this.context.useSnapshot()) {\n+            return;\n+        }\n+        RaftClosure<?> future = new RaftClosure<>();\n+        try {\n+            this.node().snapshot(future);\n+            future.waitFinished();\n+        } catch (Throwable e) {\n+            throw new BackendException(\"Failed to genearet snapshot\", e);", "originalCommit": "a747f4602825c45787539d9903cf0cba0b2861e3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "cefc52555d1e39c189f9301f37632e271efb7b88", "chunk": "diff --git a/hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/RaftNode.java b/hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/RaftNode.java\nindex 1eba099a..9a7b3ee9 100644\n--- a/hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/RaftNode.java\n+++ b/hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/RaftNode.java\n\n@@ -107,7 +107,7 @@ public class RaftNode {\n             this.node().snapshot(future);\n             future.waitFinished();\n         } catch (Throwable e) {\n-            throw new BackendException(\"Failed to genearet snapshot\", e);\n+            throw new BackendException(\"Failed to generate snapshot\", e);\n         }\n     }\n \n"}}, {"oid": "cefc52555d1e39c189f9301f37632e271efb7b88", "url": "https://github.com/hugegraph/hugegraph/commit/cefc52555d1e39c189f9301f37632e271efb7b88", "message": "fix typo\n\nChange-Id: I43fde591d69274dfafe7f7e41792cdf7cd8d2715", "committedDate": "2020-11-20T10:03:38Z", "type": "commit"}, {"oid": "cefc52555d1e39c189f9301f37632e271efb7b88", "url": "https://github.com/hugegraph/hugegraph/commit/cefc52555d1e39c189f9301f37632e271efb7b88", "message": "fix typo\n\nChange-Id: I43fde591d69274dfafe7f7e41792cdf7cd8d2715", "committedDate": "2020-11-20T10:03:38Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU4OTgwMQ==", "url": "https://github.com/hugegraph/hugegraph/pull/1275#discussion_r527589801", "bodyText": "set submitAndWait protected", "author": "javeme", "createdAt": "2020-11-20T10:15:58Z", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/RaftBackendStoreProvider.java", "diffHunk": "@@ -188,6 +189,20 @@ public void initSystemInfo(HugeGraph graph) {\n         LOG.debug(\"Graph '{}' system info has been initialized\", this.graph());\n     }\n \n+    @Override\n+    public void writeSnapshot() {\n+        StoreCommand command = new StoreCommand(StoreType.ALL,\n+                                                StoreAction.SNAPSHOT, null);\n+        StoreClosure closure = new StoreClosure(command);\n+        this.context.node().submitAndWait(command, closure);", "originalCommit": "cefc52555d1e39c189f9301f37632e271efb7b88", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzYxNTA3MQ==", "url": "https://github.com/hugegraph/hugegraph/pull/1275#discussion_r527615071", "bodyText": "StoreCommandProcessor used it", "author": "Linary", "createdAt": "2020-11-20T11:00:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU4OTgwMQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU5MjU5MQ==", "url": "https://github.com/hugegraph/hugegraph/pull/1275#discussion_r527592591", "bodyText": "keep func", "author": "javeme", "createdAt": "2020-11-20T10:20:49Z", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/StoreStateMachine.java", "diffHunk": "@@ -123,8 +127,8 @@ private void updateCacheIfNeeded(BackendMutation mutation) {\n     }\n \n     private void register(StoreAction action,\n-                          BiConsumer<BackendStore, BytesBuffer> func) {\n-        this.funcs.put(action, func);\n+                          BiConsumer<BackendStore, BytesBuffer> biFunc) {", "originalCommit": "cefc52555d1e39c189f9301f37632e271efb7b88", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "67d9a452358ed7ef042150ce2fae2712f8997615", "chunk": "diff --git a/hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/StoreStateMachine.java b/hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/StoreStateMachine.java\nindex 73710e23..f51048b7 100644\n--- a/hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/StoreStateMachine.java\n+++ b/hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/StoreStateMachine.java\n\n@@ -127,8 +127,8 @@ public class StoreStateMachine extends StateMachineAdapter {\n     }\n \n     private void register(StoreAction action,\n-                          BiConsumer<BackendStore, BytesBuffer> biFunc) {\n-        this.funcs.put(action, biFunc);\n+                          BiConsumer<BackendStore, BytesBuffer> func) {\n+        this.funcs.put(action, func);\n     }\n \n     @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU5MjgzNQ==", "url": "https://github.com/hugegraph/hugegraph/pull/1275#discussion_r527592835", "bodyText": "keep @SuppressWarnings(\"unused\")", "author": "javeme", "createdAt": "2020-11-20T10:21:13Z", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/rpc/RaftRequests.java", "diffHunk": "@@ -3,14 +3,13 @@\n \n package com.baidu.hugegraph.backend.store.raft.rpc;\n \n-@SuppressWarnings(\"unused\")", "originalCommit": "cefc52555d1e39c189f9301f37632e271efb7b88", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "67d9a452358ed7ef042150ce2fae2712f8997615", "chunk": "diff --git a/hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/rpc/RaftRequests.java b/hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/rpc/RaftRequests.java\nindex b4e6c703..6bcc9aa7 100644\n--- a/hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/rpc/RaftRequests.java\n+++ b/hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/rpc/RaftRequests.java\n\n@@ -3,6 +3,7 @@\n \n package com.baidu.hugegraph.backend.store.raft.rpc;\n \n+@SuppressWarnings(\"unused\")\n public final class RaftRequests {\n   private RaftRequests() {}\n   public static void registerAllExtensions(\n"}}, {"oid": "67d9a452358ed7ef042150ce2fae2712f8997615", "url": "https://github.com/hugegraph/hugegraph/commit/67d9a452358ed7ef042150ce2fae2712f8997615", "message": "tiny improve\n\nChange-Id: Idf3dad865c9baf181227ad063233bef2b548b2d8", "committedDate": "2020-11-20T11:03:17Z", "type": "commit"}]}