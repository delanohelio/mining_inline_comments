{"pr_number": 1207, "pr_title": "FINERACT-1095 Added status parameter in Clients API", "pr_createdAt": "2020-07-28T23:57:48Z", "pr_url": "https://github.com/apache/fineract/pull/1207", "timeline": [{"oid": "aa0f65d8ba6103d60040f4bd209f1374704c8e6b", "url": "https://github.com/apache/fineract/commit/aa0f65d8ba6103d60040f4bd209f1374704c8e6b", "message": "Added Integration test for onlyPending parameter", "committedDate": "2020-07-29T01:04:17Z", "type": "forcePushed"}, {"oid": "c39f21712aecddea4251436d032b322bef6e1b00", "url": "https://github.com/apache/fineract/commit/c39f21712aecddea4251436d032b322bef6e1b00", "message": "Added Integration test for onlyPending parameter", "committedDate": "2020-07-29T01:56:53Z", "type": "forcePushed"}, {"oid": "74757288c3db15ee09f36180a4c8aa20a004278c", "url": "https://github.com/apache/fineract/commit/74757288c3db15ee09f36180a4c8aa20a004278c", "message": "FINERACT-1095 Added status parameter in Clients API", "committedDate": "2020-07-29T20:26:19Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM4OTMxOA==", "url": "https://github.com/apache/fineract/pull/1207#discussion_r463389318", "bodyText": "If you look at org.apache.fineract.portfolio.client.domain.ClientStatus, there seems to be more values for this enum than shown here. Was there a reason why only this subset is relevant for this?\nAlso for mapping from string to value,  would it make sense to put this into the ClientStatus class and make it reusable? The same way as for example for GLAccountType.fromString() or CalendarFrequencyType.fromString()? That way we would be maintaining the logic in one place only...", "author": "ptuomola", "createdAt": "2020-07-31T03:42:21Z", "path": "fineract-provider/src/main/java/org/apache/fineract/portfolio/client/service/ClientReadPlatformServiceImpl.java", "diffHunk": "@@ -258,6 +261,19 @@ private String buildSqlStringFromClientCriteria(String schemaSql, final SearchPa\n             extraCriteria += \" and c.display_name like ? \";\n         }\n \n+        if (status != null) {\n+            final String lowerCaseStatus = status.toLowerCase();\n+            Map<String, Integer> statusNumber = new HashMap<String, Integer>();\n+            statusNumber.put(\"active\", 300);\n+            statusNumber.put(\"withdrawn\", 800);\n+            statusNumber.put(\"closed\", 600);\n+            statusNumber.put(\"rejected\", 700);\n+            statusNumber.put(\"pending\", 100);", "originalCommit": "74757288c3db15ee09f36180a4c8aa20a004278c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg4MjQyMQ==", "url": "https://github.com/apache/fineract/pull/1207#discussion_r463882421", "bodyText": "@ptuomola updated!", "author": "thesmallstar", "createdAt": "2020-07-31T23:13:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM4OTMxOA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDAyNDk0OA==", "url": "https://github.com/apache/fineract/pull/1207#discussion_r464024948", "bodyText": "Should we not check that we receive at least some clients? As far as I can see, this test will still pass if the search doesn't actually work and returns nothing...\nIdeally we should check that we receive some of the same clients that we set to status pending above - but at the very least we should check that we've received something...", "author": "ptuomola", "createdAt": "2020-08-02T03:13:28Z", "path": "fineract-provider/src/integrationTest/java/org/apache/fineract/integrationtests/ClientTest.java", "diffHunk": "@@ -143,4 +143,36 @@ public void testClientAsEntityStatus() {\n \n     }\n \n+    @SuppressWarnings(\"unchecked\")\n+    @Test\n+    public void testPendingOnlyClientRequest() {\n+\n+        Random rand = new Random();\n+        // Add a few clients to the server and activate a random amount of them\n+        for (int i = 0; i < 15; i++) {\n+            final Integer clientId = ClientHelper.createClientAsEntity(this.requestSpec, this.responseSpec);\n+            if (rand.nextInt(10) % 2 == 0) {\n+                // Takes Client to pending status\n+                this.clientHelper.closeClient(clientId);\n+                this.clientHelper.reactivateClient(clientId);\n+            }\n+            // Other clients stay in Active status\n+        }\n+        List<HashMap<String, Object>> clientsRecieved = (List<HashMap<String, Object>>) clientHelper.getClientWithStatus(50, \"pending\");\n+", "originalCommit": "2dc58ce4c883b463735fef8ec48bfe4a0248dfd3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDAyNDk4OA==", "url": "https://github.com/apache/fineract/pull/1207#discussion_r464024988", "bodyText": "Same here as above - shouldn't we check we received at least one active client?", "author": "ptuomola", "createdAt": "2020-08-02T03:14:01Z", "path": "fineract-provider/src/integrationTest/java/org/apache/fineract/integrationtests/ClientTest.java", "diffHunk": "@@ -143,4 +143,36 @@ public void testClientAsEntityStatus() {\n \n     }\n \n+    @SuppressWarnings(\"unchecked\")\n+    @Test\n+    public void testPendingOnlyClientRequest() {\n+\n+        Random rand = new Random();\n+        // Add a few clients to the server and activate a random amount of them\n+        for (int i = 0; i < 15; i++) {\n+            final Integer clientId = ClientHelper.createClientAsEntity(this.requestSpec, this.responseSpec);\n+            if (rand.nextInt(10) % 2 == 0) {\n+                // Takes Client to pending status\n+                this.clientHelper.closeClient(clientId);\n+                this.clientHelper.reactivateClient(clientId);\n+            }\n+            // Other clients stay in Active status\n+        }\n+        List<HashMap<String, Object>> clientsRecieved = (List<HashMap<String, Object>>) clientHelper.getClientWithStatus(50, \"pending\");\n+\n+        for (int i = 0; i < clientsRecieved.size(); i++) {\n+            HashMap<String, Object> clientStatus = ClientHelper.getClientStatus(requestSpec, responseSpec,\n+                    String.valueOf(clientsRecieved.get(i).get(\"id\")));\n+            ClientStatusChecker.verifyClientPending(clientStatus);\n+        }\n+\n+        clientsRecieved = (List<HashMap<String, Object>>) clientHelper.getClientWithStatus(50, \"active\");\n+\n+        for (int i = 0; i < clientsRecieved.size(); i++) {\n+            HashMap<String, Object> clientStatus = ClientHelper.getClientStatus(requestSpec, responseSpec,", "originalCommit": "2dc58ce4c883b463735fef8ec48bfe4a0248dfd3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDAyNTIzNQ==", "url": "https://github.com/apache/fineract/pull/1207#discussion_r464025235", "bodyText": "Hmm... couldn't spot any difference except removal of the formatting (one status per line) - was there something changed here?", "author": "ptuomola", "createdAt": "2020-08-02T03:15:45Z", "path": "fineract-provider/src/main/java/org/apache/fineract/portfolio/client/domain/ClientStatus.java", "diffHunk": "@@ -18,17 +18,17 @@\n  */\n package org.apache.fineract.portfolio.client.domain;\n \n+import org.springframework.util.StringUtils;\n+\n /**\n  * Enum representation of client status states.\n  */\n public enum ClientStatus {\n \n-    INVALID(0, \"clientStatusType.invalid\"), //\n-    PENDING(100, \"clientStatusType.pending\"), //\n-    ACTIVE(300, \"clientStatusType.active\"), //\n-    TRANSFER_IN_PROGRESS(303, \"clientStatusType.transfer.in.progress\"), //\n-    TRANSFER_ON_HOLD(304, \"clientStatusType.transfer.on.hold\"), //\n-    CLOSED(600, \"clientStatusType.closed\"), REJECTED(700, \"clientStatusType.rejected\"), WITHDRAWN(800, \"clientStatusType.withdraw\");\n+    INVALID(0, \"clientStatusType.invalid\"), PENDING(100, \"clientStatusType.pending\"), ACTIVE(300,\n+            \"clientStatusType.active\"), TRANSFER_IN_PROGRESS(303, \"clientStatusType.transfer.in.progress\"), TRANSFER_ON_HOLD(304,\n+                    \"clientStatusType.transfer.on.hold\"), CLOSED(600, \"clientStatusType.closed\"), REJECTED(700,\n+                            \"clientStatusType.rejected\"), WITHDRAWN(800, \"clientStatusType.withdraw\");\n ", "originalCommit": "2dc58ce4c883b463735fef8ec48bfe4a0248dfd3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTIzMjIzOQ==", "url": "https://github.com/apache/fineract/pull/1207#discussion_r465232239", "bodyText": "I removed the useless comments, that made it happen.\nWeird, we might need to change some spotless rules.", "author": "thesmallstar", "createdAt": "2020-08-04T18:02:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDAyNTIzNQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDAyNTMxNg==", "url": "https://github.com/apache/fineract/pull/1207#discussion_r464025316", "bodyText": "Hmmm... how does this actually work now? Here we are comparing to the strings as defined in the enum (e.g. clientStatusType.active) but the test is passing in just \"active\". So it should not match / return anything. What did I miss here?", "author": "ptuomola", "createdAt": "2020-08-02T03:17:19Z", "path": "fineract-provider/src/main/java/org/apache/fineract/portfolio/client/domain/ClientStatus.java", "diffHunk": "@@ -63,6 +63,33 @@ public static ClientStatus fromInt(final Integer statusValue) {\n         return enumeration;\n     }\n \n+    public static ClientStatus fromString(final String clientString) {", "originalCommit": "2dc58ce4c883b463735fef8ec48bfe4a0248dfd3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDAyNTQxMw==", "url": "https://github.com/apache/fineract/pull/1207#discussion_r464025413", "bodyText": "So this would mean you can't search for clients with status = INVALID. Is this correct behaviour - shouldn't we still allow searching even if the value you pass in is INVALID? I.e. to find any INVALID entries (if any)...\nAt the same time it would be good to validate the provided input string to ensure it has actually mapped to a valid value, and throw PlatformValidationException if it doesn't.\nSo you should be able to search for any invalid entries by sending in clientStatusType.invalid - but if you send in clientStatusType.blah then you should get a validation exception.", "author": "ptuomola", "createdAt": "2020-08-02T03:19:12Z", "path": "fineract-provider/src/main/java/org/apache/fineract/portfolio/client/service/ClientReadPlatformServiceImpl.java", "diffHunk": "@@ -258,6 +259,13 @@ private String buildSqlStringFromClientCriteria(String schemaSql, final SearchPa\n             extraCriteria += \" and c.display_name like ? \";\n         }\n \n+        if (status != null) {\n+            ClientStatus clientStatus = ClientStatus.fromString(status);\n+            if (clientStatus.getValue() != 0) {", "originalCommit": "2dc58ce4c883b463735fef8ec48bfe4a0248dfd3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "e5aa70a14555ec1cf96a038a9408fe535a627fed", "url": "https://github.com/apache/fineract/commit/e5aa70a14555ec1cf96a038a9408fe535a627fed", "message": "FINERACT-1095 Added status parameter in Clients API", "committedDate": "2020-08-05T11:25:37Z", "type": "forcePushed"}, {"oid": "4735e32f454b189276aa48dd910f38682b12a78c", "url": "https://github.com/apache/fineract/commit/4735e32f454b189276aa48dd910f38682b12a78c", "message": "FINERACT-1095 Added status parameter in Clients API", "committedDate": "2020-08-05T11:28:23Z", "type": "forcePushed"}, {"oid": "b7ebed0b0e5bcd3d09d542a9663087611274b618", "url": "https://github.com/apache/fineract/commit/b7ebed0b0e5bcd3d09d542a9663087611274b618", "message": "FINERACT-1095 Added status parameter in Clients API", "committedDate": "2020-08-05T19:14:07Z", "type": "forcePushed"}, {"oid": "8906d5802eef120dec4ea63339c80be45a891973", "url": "https://github.com/apache/fineract/commit/8906d5802eef120dec4ea63339c80be45a891973", "message": "FINERACT-1095 Added status parameter in Clients API", "committedDate": "2020-08-14T20:28:28Z", "type": "commit"}, {"oid": "bd35edf145a70686955bbbfedf1ce0e2f79a5b05", "url": "https://github.com/apache/fineract/commit/bd35edf145a70686955bbbfedf1ce0e2f79a5b05", "message": "Removed duplicate status values to check status parameter validity", "committedDate": "2020-08-14T20:28:28Z", "type": "commit"}, {"oid": "bd35edf145a70686955bbbfedf1ce0e2f79a5b05", "url": "https://github.com/apache/fineract/commit/bd35edf145a70686955bbbfedf1ce0e2f79a5b05", "message": "Removed duplicate status values to check status parameter validity", "committedDate": "2020-08-14T20:28:28Z", "type": "forcePushed"}]}