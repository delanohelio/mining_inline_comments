{"pr_number": 1286, "pr_title": "Removed string concatenated SQL & sqlSearch from Staff (Fineract-854)", "pr_createdAt": "2020-08-26T10:37:46Z", "pr_url": "https://github.com/apache/fineract/pull/1286", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Nzk0MDE5NQ==", "url": "https://github.com/apache/fineract/pull/1286#discussion_r477940195", "bodyText": "Are we sure that no client is calling this - i.e. will this change make an impact to one of the UIs?", "author": "ptuomola", "createdAt": "2020-08-27T02:19:01Z", "path": "fineract-provider/src/main/java/org/apache/fineract/organisation/staff/api/StaffApiResource.java", "diffHunk": "@@ -118,7 +118,6 @@ public StaffApiResource(final PlatformSecurityContext context, final StaffReadPl\n             @ApiResponse(responseCode = \"200\", description = \"OK\", content = @Content(array = @ArraySchema(schema = @Schema(implementation = StaffApiResourceSwagger.GetStaffResponse.class)))),\n             @ApiResponse(responseCode = \"200\", description = \"GET https://DomainName/api/v1/staff?status={ACTIVE|INACTIVE|ALL}\", content = @Content(schema = @Schema(implementation = StaffApiResourceSwagger.GetStaffResponse.class))) })\n     public String retrieveStaff(@Context final UriInfo uriInfo,\n-            @QueryParam(\"sqlSearch\") @Parameter(description = \"sqlSearch\") final String sqlSearch,\n             @QueryParam(\"officeId\") @Parameter(description = \"officeId\") final Long officeId,", "originalCommit": "3c1f5722e21ec0807da5fa7cd15ed006a5361204", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODI4MDgyOQ==", "url": "https://github.com/apache/fineract/pull/1286#discussion_r478280829", "bodyText": "Yes, we already confirmed that.\nIt was only used in loans and clients, for which I added extra status param,", "author": "thesmallstar", "createdAt": "2020-08-27T09:25:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Nzk0MDE5NQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Nzk0NDY2NQ==", "url": "https://github.com/apache/fineract/pull/1286#discussion_r477944665", "bodyText": "Would we not want to do this \"magic\" of adding the condition for hierarchy and then executing the JDBC template only in one place? I.e. would it not be better to keep this code still in retrieveAllStaff and just call retrieveAllStaff with the right SQLBuilder from here? Or is there a reason why we want to duplicate the code here?", "author": "ptuomola", "createdAt": "2020-08-27T02:22:14Z", "path": "fineract-provider/src/main/java/org/apache/fineract/organisation/staff/service/StaffReadPlatformServiceImpl.java", "diffHunk": "@@ -159,7 +159,18 @@ public StaffData mapRow(final ResultSet rs, @SuppressWarnings(\"unused\") final in\n \n     @Override\n     public Collection<StaffData> retrieveAllLoanOfficersInOfficeById(final Long officeId) {\n-        return retrieveAllStaff(\" office_id = ? and is_loan_officer=1 and o.hierarchy like ?\", officeId);\n+        final StaffMapper rm = new StaffMapper();\n+        String sql = \"select \" + rm.schema();\n+        SQLBuilder extraCriteria = new SQLBuilder();\n+        extraCriteria.addCriteria(\" office_id = \", officeId);\n+        extraCriteria.addCriteria(\" is_loan_officer= = \", 1);\n+        final String hierarchy = this.context.authenticatedUser().getOffice().getHierarchy() + \"%\";\n+        extraCriteria.addCriteria(\" o.hierarchy like \", hierarchy);\n+\n+        sql += \" \" + extraCriteria.getSQLTemplate();\n+        sql = sql + \" order by s.lastname \";\n+\n+        return this.jdbcTemplate.query(sql, rm, extraCriteria.getArguments());", "originalCommit": "3c1f5722e21ec0807da5fa7cd15ed006a5361204", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Nzk0Nzk3Mw==", "url": "https://github.com/apache/fineract/pull/1286#discussion_r477947973", "bodyText": "I think it would have actually been good to leave looking up hierarchy and adding the condition for it here. That way, regardless of how you call retrieveAllStaff, you can't retrieve things you are not allowed to see. Otherwise we are relying on the caller to add the condition for hierarchy - which they may forget...", "author": "ptuomola", "createdAt": "2020-08-27T02:24:43Z", "path": "fineract-provider/src/main/java/org/apache/fineract/organisation/staff/service/StaffReadPlatformServiceImpl.java", "diffHunk": "@@ -204,49 +215,38 @@ public StaffData retrieveStaff(final Long staffId) {\n     }\n \n     @Override\n-    public Collection<StaffData> retrieveAllStaff(final String sqlSearch, final Long officeId, final boolean loanOfficersOnly,\n-            final String status) {\n-        final String extraCriteria = getStaffCriteria(sqlSearch, officeId, loanOfficersOnly, status);\n-        return retrieveAllStaff(extraCriteria, officeId);\n+    public Collection<StaffData> retrieveAllStaff(final Long officeId, final boolean loanOfficersOnly, final String status) {\n+        final SQLBuilder extraCriteria = getStaffCriteria(officeId, loanOfficersOnly, status);\n+        return retrieveAllStaff(extraCriteria);\n     }\n \n-    private Collection<StaffData> retrieveAllStaff(final String extraCriteria, Long officeId) {\n+    private Collection<StaffData> retrieveAllStaff(final SQLBuilder extraCriteria) {\n \n         final StaffMapper rm = new StaffMapper();\n         String sql = \"select \" + rm.schema();\n-        final String hierarchy = this.context.authenticatedUser().getOffice().getHierarchy() + \"%\";\n-        if (StringUtils.isNotBlank(extraCriteria)) {", "originalCommit": "3c1f5722e21ec0807da5fa7cd15ed006a5361204", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "baed1f0b39a1061d1486599e462ace79e229acd1", "url": "https://github.com/apache/fineract/commit/baed1f0b39a1061d1486599e462ace79e229acd1", "message": "Removed string concatenated SQL & sqlSearch from Staff (Fineract-854)", "committedDate": "2020-08-30T13:14:54Z", "type": "forcePushed"}, {"oid": "a88f2f91ede770803a934ee49aeac1f8fcc7eee5", "url": "https://github.com/apache/fineract/commit/a88f2f91ede770803a934ee49aeac1f8fcc7eee5", "message": "Removed string concatenated SQL & sqlSearch from Staff (Fineract-854)", "committedDate": "2020-08-30T13:24:19Z", "type": "forcePushed"}, {"oid": "4570eb6c88620f218369db4c775ea0dabc30b69d", "url": "https://github.com/apache/fineract/commit/4570eb6c88620f218369db4c775ea0dabc30b69d", "message": "Removed string concatenated SQL & sqlSearch from Staff (Fineract-854)", "committedDate": "2020-08-30T14:50:27Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTg1NTcxNg==", "url": "https://github.com/apache/fineract/pull/1286#discussion_r479855716", "bodyText": "I think this comment is now in the wrong place and should be moved to retrieveAllStaff(), right?", "author": "ptuomola", "createdAt": "2020-08-31T02:20:44Z", "path": "fineract-provider/src/main/java/org/apache/fineract/organisation/staff/service/StaffReadPlatformServiceImpl.java", "diffHunk": "@@ -257,14 +252,7 @@ private String getStaffCriteria(final String sqlSearch, final Long officeId, fin\n         // employee who does not belong to his office or a sub office for his\n         // office.\n ", "originalCommit": "4570eb6c88620f218369db4c775ea0dabc30b69d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "813d8c693361a8af0cc5ebe214975ee89be7b3a0", "url": "https://github.com/apache/fineract/commit/813d8c693361a8af0cc5ebe214975ee89be7b3a0", "message": "Removed string concatenated SQL & sqlSearch from Staff (Fineract-854)", "committedDate": "2020-09-05T19:42:53Z", "type": "commit"}, {"oid": "813d8c693361a8af0cc5ebe214975ee89be7b3a0", "url": "https://github.com/apache/fineract/commit/813d8c693361a8af0cc5ebe214975ee89be7b3a0", "message": "Removed string concatenated SQL & sqlSearch from Staff (Fineract-854)", "committedDate": "2020-09-05T19:42:53Z", "type": "forcePushed"}]}