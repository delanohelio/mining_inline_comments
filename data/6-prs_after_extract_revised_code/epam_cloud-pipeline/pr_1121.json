{"pr_number": 1121, "pr_title": "Issue 1117 systemd for centos based images", "pr_createdAt": "2020-05-20T14:33:13Z", "pr_url": "https://github.com/epam/cloud-pipeline/pull/1121", "timeline": [{"oid": "98000933878b970d763c597d88e7c2b20f007a7d", "url": "https://github.com/epam/cloud-pipeline/commit/98000933878b970d763c597d88e7c2b20f007a7d", "message": "issue #1117 include cgroup mount for run if user enabled systemd integration", "committedDate": "2020-05-19T13:01:09Z", "type": "commit"}, {"oid": "19b5a56632160b3f2033cecbe880ffffd6d39d60", "url": "https://github.com/epam/cloud-pipeline/commit/19b5a56632160b3f2033cecbe880ffffd6d39d60", "message": "issue #1117 launch systemd for centos on startup if requested", "committedDate": "2020-05-20T11:06:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODE2NTQ3NQ==", "url": "https://github.com/epam/cloud-pipeline/pull/1121#discussion_r428165475", "bodyText": "Maybe we should extract method isParameterEnabled and use it here and for lines 163-166?", "author": "mzueva", "createdAt": "2020-05-20T16:55:19Z", "path": "api/src/main/java/com/epam/pipeline/manager/execution/PipelineExecutor.java", "diffHunk": "@@ -160,14 +164,18 @@ private PodSpec getPodSpec(PipelineRun run, List<EnvVar> envVars, String secretN\n                 .stream()\n                 .anyMatch(env -> KubernetesConstants.CP_CAP_DIND_NATIVE.equals(env.getName()) &&\n                         TRUE.equals(env.getValue()));\n-        spec.setVolumes(getVolumes(isDockerInDockerEnabled));\n+        boolean isSystemdEnabled = ListUtils.emptyIfNull(envVars)", "originalCommit": "19b5a56632160b3f2033cecbe880ffffd6d39d60", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3e27cef3978e34268058aeb7a7fd8e5116317ceb", "chunk": "diff --git a/api/src/main/java/com/epam/pipeline/manager/execution/PipelineExecutor.java b/api/src/main/java/com/epam/pipeline/manager/execution/PipelineExecutor.java\nindex 0b978a5ec..e26006f29 100644\n--- a/api/src/main/java/com/epam/pipeline/manager/execution/PipelineExecutor.java\n+++ b/api/src/main/java/com/epam/pipeline/manager/execution/PipelineExecutor.java\n\n@@ -160,14 +160,9 @@ public class PipelineExecutor {\n         if (!StringUtils.isEmpty(secretName)) {\n             spec.setImagePullSecrets(Collections.singletonList(new LocalObjectReference(secretName)));\n         }\n-        boolean isDockerInDockerEnabled = authManager.isAdmin() && ListUtils.emptyIfNull(envVars)\n-                .stream()\n-                .anyMatch(env -> KubernetesConstants.CP_CAP_DIND_NATIVE.equals(env.getName()) &&\n-                        TRUE.equals(env.getValue()));\n-        boolean isSystemdEnabled = ListUtils.emptyIfNull(envVars)\n-                .stream()\n-                .anyMatch(env -> KubernetesConstants.CP_CAP_SYSTEMD_CONTAINER.equals(env.getName()) &&\n-                        TRUE.equals(env.getValue()));\n+        boolean isDockerInDockerEnabled = authManager.isAdmin() && isParameterEnabled(envVars, KubernetesConstants.CP_CAP_DIND_NATIVE);\n+        boolean isSystemdEnabled = isParameterEnabled(envVars, KubernetesConstants.CP_CAP_SYSTEMD_CONTAINER);\n+\n         spec.setVolumes(getVolumes(isDockerInDockerEnabled, isSystemdEnabled));\n \n         if (envVars.stream().anyMatch(envVar -> envVar.getName().equals(USE_HOST_NETWORK))){\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODE2NTgwOA==", "url": "https://github.com/epam/cloud-pipeline/pull/1121#discussion_r428165808", "bodyText": "missing final", "author": "mzueva", "createdAt": "2020-05-20T16:55:50Z", "path": "api/src/main/java/com/epam/pipeline/manager/execution/PipelineExecutor.java", "diffHunk": "@@ -235,7 +243,7 @@ private ContainerResources buildCpuRequests(List<EnvVar> envVars) {\n                 .orElse(ContainerResources.empty());\n     }\n \n-    private List<Volume> getVolumes(final boolean isDockerInDockerEnabled) {\n+    private List<Volume> getVolumes(final boolean isDockerInDockerEnabled, boolean isSystemdEnabled) {", "originalCommit": "19b5a56632160b3f2033cecbe880ffffd6d39d60", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3e27cef3978e34268058aeb7a7fd8e5116317ceb", "chunk": "diff --git a/api/src/main/java/com/epam/pipeline/manager/execution/PipelineExecutor.java b/api/src/main/java/com/epam/pipeline/manager/execution/PipelineExecutor.java\nindex 0b978a5ec..e26006f29 100644\n--- a/api/src/main/java/com/epam/pipeline/manager/execution/PipelineExecutor.java\n+++ b/api/src/main/java/com/epam/pipeline/manager/execution/PipelineExecutor.java\n\n@@ -243,7 +244,7 @@ public class PipelineExecutor {\n                 .orElse(ContainerResources.empty());\n     }\n \n-    private List<Volume> getVolumes(final boolean isDockerInDockerEnabled, boolean isSystemdEnabled) {\n+    private List<Volume> getVolumes(final boolean isDockerInDockerEnabled, final boolean isSystemdEnabled) {\n         final List<Volume> volumes = new ArrayList<>();\n         volumes.add(createVolume(REF_DATA_MOUNT, \"/ebs/reference\"));\n         volumes.add(createVolume(RUNS_DATA_MOUNT, \"/ebs/runs\"));\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODE2NTg4Mw==", "url": "https://github.com/epam/cloud-pipeline/pull/1121#discussion_r428165883", "bodyText": "missing final", "author": "mzueva", "createdAt": "2020-05-20T16:55:58Z", "path": "api/src/main/java/com/epam/pipeline/manager/execution/PipelineExecutor.java", "diffHunk": "@@ -246,10 +254,13 @@ private ContainerResources buildCpuRequests(List<EnvVar> envVars) {\n                 CollectionUtils.isNotEmpty(dockerMounts)) {\n             dockerMounts.forEach(mount -> volumes.add(createVolume(mount.getName(), mount.getHostPath())));\n         }\n+        if (isSystemdEnabled) {\n+            volumes.add(createVolume(HOST_CGROUP_MOUNT.getName(), HOST_CGROUP_MOUNT.getHostPath()));\n+        }\n         return volumes;\n     }\n \n-    private List<VolumeMount> getMounts(final boolean isDockerInDockerEnabled) {\n+    private List<VolumeMount> getMounts(final boolean isDockerInDockerEnabled, boolean isSystemdEnabled) {", "originalCommit": "19b5a56632160b3f2033cecbe880ffffd6d39d60", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3e27cef3978e34268058aeb7a7fd8e5116317ceb", "chunk": "diff --git a/api/src/main/java/com/epam/pipeline/manager/execution/PipelineExecutor.java b/api/src/main/java/com/epam/pipeline/manager/execution/PipelineExecutor.java\nindex 0b978a5ec..e26006f29 100644\n--- a/api/src/main/java/com/epam/pipeline/manager/execution/PipelineExecutor.java\n+++ b/api/src/main/java/com/epam/pipeline/manager/execution/PipelineExecutor.java\n\n@@ -260,7 +261,7 @@ public class PipelineExecutor {\n         return volumes;\n     }\n \n-    private List<VolumeMount> getMounts(final boolean isDockerInDockerEnabled, boolean isSystemdEnabled) {\n+    private List<VolumeMount> getMounts(final boolean isDockerInDockerEnabled, final boolean isSystemdEnabled) {\n         final List<VolumeMount> mounts = new ArrayList<>();\n         mounts.add(getVolumeMount(REF_DATA_MOUNT, \"/common\"));\n         mounts.add(getVolumeMount(RUNS_DATA_MOUNT, \"/runs\"));\n"}}, {"oid": "3e27cef3978e34268058aeb7a7fd8e5116317ceb", "url": "https://github.com/epam/cloud-pipeline/commit/3e27cef3978e34268058aeb7a7fd8e5116317ceb", "message": "changes according to review", "committedDate": "2020-05-20T17:34:25Z", "type": "commit"}, {"oid": "c124dc7b383161a8f6260e333043e212091fc465", "url": "https://github.com/epam/cloud-pipeline/commit/c124dc7b383161a8f6260e333043e212091fc465", "message": "add passToWorker param", "committedDate": "2020-05-21T11:10:30Z", "type": "commit"}]}