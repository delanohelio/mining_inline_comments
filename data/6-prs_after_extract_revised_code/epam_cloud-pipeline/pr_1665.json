{"pr_number": 1665, "pr_title": "Issue #1652: VMMonitor shall handle pool nodes", "pr_createdAt": "2020-12-18T11:54:43Z", "pr_url": "https://github.com/epam/cloud-pipeline/pull/1665", "timeline": [{"oid": "0531209ba38e986bc176947a1be07168e24c4483", "url": "https://github.com/epam/cloud-pipeline/commit/0531209ba38e986bc176947a1be07168e24c4483", "message": "Issue #1652: Pool entity added to common module", "committedDate": "2020-12-18T11:32:38Z", "type": "commit"}, {"oid": "d30ccb6684c3dd6420676da9e47f2ce02b5550cd", "url": "https://github.com/epam/cloud-pipeline/commit/d30ccb6684c3dd6420676da9e47f2ce02b5550cd", "message": "Issue #1652: Pool id check added for nodes with non-numeric run id", "committedDate": "2020-12-18T11:37:10Z", "type": "commit"}, {"oid": "c4f96fa6f083f6e29436d9860e2a6a2a3334a224", "url": "https://github.com/epam/cloud-pipeline/commit/c4f96fa6f083f6e29436d9860e2a6a2a3334a224", "message": "Issue #1652: Added tests for monitor pool id check", "committedDate": "2020-12-18T11:38:24Z", "type": "commit"}, {"oid": "fac095dc1ee05be0fb3b95de8f55f2e9bae035f4", "url": "https://github.com/epam/cloud-pipeline/commit/fac095dc1ee05be0fb3b95de8f55f2e9bae035f4", "message": "Issue #1652: pool_id label moved to properties", "committedDate": "2020-12-21T11:01:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzM5ODIzOQ==", "url": "https://github.com/epam/cloud-pipeline/pull/1665#discussion_r547398239", "bodyText": "Pool label exists only on kubernetes nodes, so we shall check it in checkLabels method, which operates kubernetes Node instead of AWS VirtualMachine", "author": "mzueva", "createdAt": "2020-12-22T17:14:38Z", "path": "vm-monitor/src/main/java/com/epam/pipeline/vmmonitor/service/vm/VMMonitor.java", "diffHunk": "@@ -102,7 +106,7 @@ private void checkVmState(final VirtualMachine vm) {\n                 checkMatchingNodes(nodes, vm);\n             } else {\n                 log.debug(\"No matching nodes were found for VM {} {}.\", vm.getInstanceId(), vm.getCloudProvider());\n-                if (!matchingRunExists(vm)) {\n+                if (!matchingRunExists(vm) && !poolIdExists(vm)) {", "originalCommit": "fac095dc1ee05be0fb3b95de8f55f2e9bae035f4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "67688d7804c4689aef360cd49fcd0b9d099913fd", "chunk": "diff --git a/vm-monitor/src/main/java/com/epam/pipeline/vmmonitor/service/vm/VMMonitor.java b/vm-monitor/src/main/java/com/epam/pipeline/vmmonitor/service/vm/VMMonitor.java\nindex 1b514f8c4..a1b0479de 100644\n--- a/vm-monitor/src/main/java/com/epam/pipeline/vmmonitor/service/vm/VMMonitor.java\n+++ b/vm-monitor/src/main/java/com/epam/pipeline/vmmonitor/service/vm/VMMonitor.java\n\n@@ -106,7 +106,7 @@ public class VMMonitor {\n                 checkMatchingNodes(nodes, vm);\n             } else {\n                 log.debug(\"No matching nodes were found for VM {} {}.\", vm.getInstanceId(), vm.getCloudProvider());\n-                if (!matchingRunExists(vm) && !poolIdExists(vm)) {\n+                if (!matchingRunExists(vm)) {\n                     notifier.notifyMissingNode(vm);\n                 }\n             }\n"}}, {"oid": "67688d7804c4689aef360cd49fcd0b9d099913fd", "url": "https://github.com/epam/cloud-pipeline/commit/67688d7804c4689aef360cd49fcd0b9d099913fd", "message": "Issue #1652: Removed poolId check from checkVmState", "committedDate": "2020-12-23T10:46:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTM1MzA3NA==", "url": "https://github.com/epam/cloud-pipeline/pull/1665#discussion_r549353074", "bodyText": "As I mentioned previously VirtualMachine  doesn't have pool label, we need to check  NodeInstance  tags instead.", "author": "mzueva", "createdAt": "2020-12-28T13:45:01Z", "path": "vm-monitor/src/main/java/com/epam/pipeline/vmmonitor/service/vm/VMMonitor.java", "diffHunk": "@@ -124,6 +128,23 @@ private boolean matchingRunExists(final VirtualMachine vm) {\n         return false;\n     }\n \n+    private boolean poolIdExists(final VirtualMachine vm) {\n+        log.debug(\"Checking whether a node pool with corresponding pool id exists.\");", "originalCommit": "fac095dc1ee05be0fb3b95de8f55f2e9bae035f4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c62f3734b48276f4a195c21b6446fdfa49f6b46f", "chunk": "diff --git a/vm-monitor/src/main/java/com/epam/pipeline/vmmonitor/service/vm/VMMonitor.java b/vm-monitor/src/main/java/com/epam/pipeline/vmmonitor/service/vm/VMMonitor.java\nindex 1b514f8c4..641dff9f7 100644\n--- a/vm-monitor/src/main/java/com/epam/pipeline/vmmonitor/service/vm/VMMonitor.java\n+++ b/vm-monitor/src/main/java/com/epam/pipeline/vmmonitor/service/vm/VMMonitor.java\n\n@@ -128,13 +128,13 @@ public class VMMonitor {\n         return false;\n     }\n \n-    private boolean poolIdExists(final VirtualMachine vm) {\n+    private boolean poolIdExists(final NodeInstance node) {\n         log.debug(\"Checking whether a node pool with corresponding pool id exists.\");\n-        final String poolIdValue = MapUtils.emptyIfNull(vm.getTags()).get(poolIdLabel);\n+        final String poolIdValue = MapUtils.emptyIfNull(node.getLabels()).get(poolIdLabel);\n         if (StringUtils.isNotBlank(poolIdValue) && NumberUtils.isDigits(poolIdValue)) {\n             final long poolId = Long.parseLong(poolIdValue);\n-            log.debug(\"VM {} {} is associated with pool id {}. Checking node pool existence.\",\n-                    vm.getInstanceId(), vm.getCloudProvider(), poolId);\n+            log.debug(\"NodeInstance {} {} is associated with pool id {}. Checking node pool existence.\",\n+                    node.getUid(), node.getClusterName(), poolId);\n             return isNodePoolExists(poolId);\n         }\n         return false;\n"}}, {"oid": "c62f3734b48276f4a195c21b6446fdfa49f6b46f", "url": "https://github.com/epam/cloud-pipeline/commit/c62f3734b48276f4a195c21b6446fdfa49f6b46f", "message": "Issue #1652: Moved poolId label check to NodeInstance", "committedDate": "2020-12-29T11:40:03Z", "type": "commit"}]}