{"pr_number": 1530, "pr_title": "Issue #1526 Billing improvements", "pr_createdAt": "2020-10-29T18:08:56Z", "pr_url": "https://github.com/epam/cloud-pipeline/pull/1530", "timeline": [{"oid": "b6b81304b3bbc82a8e36930a596dbf1290ec9af1", "url": "https://github.com/epam/cloud-pipeline/commit/b6b81304b3bbc82a8e36930a596dbf1290ec9af1", "message": "Issue #1526 Allow to configure billing start date in billing-report-agent properties", "committedDate": "2020-10-29T14:05:05Z", "type": "commit"}, {"oid": "71e84cb3bf3f99bce0eba14013a0354cd7b5c9b7", "url": "https://github.com/epam/cloud-pipeline/commit/71e84cb3bf3f99bce0eba14013a0354cd7b5c9b7", "message": "Issue #1526 Implement historical storage billing generation", "committedDate": "2020-10-29T16:44:47Z", "type": "commit"}, {"oid": "837a38f1c08c271f6621f768edef0326035ecb6f", "url": "https://github.com/epam/cloud-pipeline/commit/837a38f1c08c271f6621f768edef0326035ecb6f", "message": "Issue #1526 Rename property to `sync.billing.initial.date`", "committedDate": "2020-10-29T16:47:12Z", "type": "commit"}, {"oid": "d0519117a2cbe877f86755dd335fc03528a4b7f1", "url": "https://github.com/epam/cloud-pipeline/commit/d0519117a2cbe877f86755dd335fc03528a4b7f1", "message": "Issue #1526 Add configurable billing properties to deployment config", "committedDate": "2020-10-29T16:58:10Z", "type": "commit"}, {"oid": "57b0b272227a5f1a14db672e96796f7920c28907", "url": "https://github.com/epam/cloud-pipeline/commit/57b0b272227a5f1a14db672e96796f7920c28907", "message": "Issue #1526 Change date creation verification for storage billing, modify tests - assign creation date to storage", "committedDate": "2020-10-29T17:43:29Z", "type": "commit"}, {"oid": "376b957f279a1666fce9e254999d4e1f73283b02", "url": "https://github.com/epam/cloud-pipeline/commit/376b957f279a1666fce9e254999d4e1f73283b02", "message": "Issue #1526 AWS storage price loading: filter out rates without USD cost specified to avoid NPE", "committedDate": "2020-10-29T18:04:35Z", "type": "commit"}, {"oid": "76965bc319c3d1f854bf2896547b2a1b15947561", "url": "https://github.com/epam/cloud-pipeline/commit/76965bc319c3d1f854bf2896547b2a1b15947561", "message": "Issue #1526 Fix checkstyle violations", "committedDate": "2020-10-30T08:42:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDk3NTMyOQ==", "url": "https://github.com/epam/cloud-pipeline/pull/1530#discussion_r514975329", "bodyText": "Could you please make this behaviour configurable, by default we create documents only for current date, and optionally for the period", "author": "mzueva", "createdAt": "2020-10-30T09:41:13Z", "path": "billing-report-agent/src/main/java/com/epam/pipeline/billingreportagent/service/impl/converter/StorageToBillingRequestConverter.java", "diffHunk": "@@ -97,10 +102,13 @@ public StorageToBillingRequestConverter(final AbstractEntityMapper<StorageBillin\n                                                          final LocalDateTime syncStart) {\n         final Long storageId = storageContainer.getEntity().getId();\n         final DataStorageType storageType = storageContainer.getEntity().getType();\n-        final LocalDate reportDate = syncStart.toLocalDate().minusDays(1);\n-        final String fullIndex = indexPrefix + parseDateToString(reportDate);\n         return requestSumAggregationForStorage(storageId, storageType)\n-            .map(searchResponse -> buildRequestFromAggregation(storageContainer, syncStart, searchResponse, fullIndex))\n+            .map(searchResponse -> Stream.iterate(previousSync.plusDays(1L), date -> date.plusDays(1))", "originalCommit": "76965bc319c3d1f854bf2896547b2a1b15947561", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8bf8638910fd39e96041a8355760312c26fd56b0", "chunk": "diff --git a/billing-report-agent/src/main/java/com/epam/pipeline/billingreportagent/service/impl/converter/StorageToBillingRequestConverter.java b/billing-report-agent/src/main/java/com/epam/pipeline/billingreportagent/service/impl/converter/StorageToBillingRequestConverter.java\nindex 9adda2a45..49044554c 100644\n--- a/billing-report-agent/src/main/java/com/epam/pipeline/billingreportagent/service/impl/converter/StorageToBillingRequestConverter.java\n+++ b/billing-report-agent/src/main/java/com/epam/pipeline/billingreportagent/service/impl/converter/StorageToBillingRequestConverter.java\n\n@@ -103,12 +108,11 @@ public class StorageToBillingRequestConverter implements EntityToBillingRequestC\n         final Long storageId = storageContainer.getEntity().getId();\n         final DataStorageType storageType = storageContainer.getEntity().getType();\n         return requestSumAggregationForStorage(storageId, storageType)\n-            .map(searchResponse -> Stream.iterate(previousSync.plusDays(1L), date -> date.plusDays(1))\n-                .limit(ChronoUnit.DAYS.between(previousSync, syncStart))\n-                .filter(reportDate -> storageExistsOnBillingDate(storageContainer, reportDate))\n-                .map(date -> buildRequestsForGivenDate(storageContainer, indexPrefix, searchResponse, date))\n-                .flatMap(Collection::stream)\n-                .collect(Collectors.toList()))\n+            .map(searchResponse -> enableStorageHistoricalBillingGeneration\n+                                   ? buildRequestsForGivenPeriod(storageContainer, indexPrefix, previousSync, syncStart,\n+                                                                 searchResponse)\n+                                   : buildRequestsForGivenDate(storageContainer, indexPrefix, searchResponse,\n+                                                               syncStart))\n             .orElse(Collections.emptyList());\n     }\n \n"}}, {"oid": "f3c576cf5a762bd8b295759e79f00af776e8bff6", "url": "https://github.com/epam/cloud-pipeline/commit/f3c576cf5a762bd8b295759e79f00af776e8bff6", "message": "Issue #1526 Allow to set billing schedule via env var in deployment config", "committedDate": "2020-10-30T09:51:38Z", "type": "commit"}, {"oid": "8bf8638910fd39e96041a8355760312c26fd56b0", "url": "https://github.com/epam/cloud-pipeline/commit/8bf8638910fd39e96041a8355760312c26fd56b0", "message": "Issue #1526 Make historical billing report generation for storage configurable", "committedDate": "2020-10-30T10:50:03Z", "type": "commit"}]}