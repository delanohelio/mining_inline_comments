{"pr_number": 1882, "pr_title": "[#1865] Hono resource limits : add timeout for Prometheus queries", "pr_createdAt": "2020-04-06T23:14:46Z", "pr_url": "https://github.com/eclipse/hono/pull/1882", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDU2NzQwMA==", "url": "https://github.com/eclipse/hono/pull/1882#discussion_r404567400", "bodyText": "IMHO this should also be done in the newQueryRequest method, shouldn't it? It should also only be set if the config value is > 0, right?", "author": "sophokles73", "createdAt": "2020-04-07T06:35:17Z", "path": "service-base/src/main/java/org/eclipse/hono/service/resourcelimits/PrometheusBasedResourceLimitChecks.java", "diffHunk": "@@ -488,7 +488,9 @@ private void checkMessageLimit(\n \n         final Promise<Long> result = Promise.promise();\n         LOG.trace(\"running Prometheus query [URL: {}, query: {}]\", url, query);\n-        newQueryRequest(query).send(sendAttempt -> {\n+        newQueryRequest(query)\n+                .timeout(config.getQueryTimeout())", "originalCommit": "ed3ff7cdedce42407be7e5184f6498c4a1d3d676", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODkxMTY1NA==", "url": "https://github.com/eclipse/hono/pull/1882#discussion_r408911654", "bodyText": "Vertx web-client have already the logic for timeout when is zero or negative the timeout is disabled. But anyway,  I followed your suggestion and   I putted the timeout  in the newQueryRequest .", "author": "bordeuax", "createdAt": "2020-04-15T15:00:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDU2NzQwMA=="}], "type": "inlineReview", "revised_code": {"commit": "fb6a10bf1c0fcf7a715396adeb42372dbddffe3e", "chunk": "diff --git a/service-base/src/main/java/org/eclipse/hono/service/resourcelimits/PrometheusBasedResourceLimitChecks.java b/service-base/src/main/java/org/eclipse/hono/service/resourcelimits/PrometheusBasedResourceLimitChecks.java\nindex 0b1dbef4a..597225088 100644\n--- a/service-base/src/main/java/org/eclipse/hono/service/resourcelimits/PrometheusBasedResourceLimitChecks.java\n+++ b/service-base/src/main/java/org/eclipse/hono/service/resourcelimits/PrometheusBasedResourceLimitChecks.java\n\n@@ -488,9 +488,7 @@ public final class PrometheusBasedResourceLimitChecks implements ResourceLimitCh\n \n         final Promise<Long> result = Promise.promise();\n         LOG.trace(\"running Prometheus query [URL: {}, query: {}]\", url, query);\n-        newQueryRequest(query)\n-                .timeout(config.getQueryTimeout())\n-                .send(sendAttempt -> {\n+        newQueryRequest(query).send(sendAttempt -> {\n             if (sendAttempt.succeeded()) {\n                 final HttpResponse<JsonObject> response = sendAttempt.result();\n                 result.complete(extractLongValue(response.body(), span));\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDU2ODYxMQ==", "url": "https://github.com/eclipse/hono/pull/1882#discussion_r404568611", "bodyText": "My understanding is that the query will run on Prometheus for hte given amount of time. However, since the query will be started after the request has been sent, I assume that we can run into situations where the WebClient stops waiting for the response while the query is still running. I therefore think that the timeout set on the WebClient should serve as a backstop only, i.e. it should wait for some additional time in order to allow for the query to finish in any case. WDYT?", "author": "sophokles73", "createdAt": "2020-04-07T06:38:16Z", "path": "service-base/src/main/java/org/eclipse/hono/service/resourcelimits/PrometheusBasedResourceLimitChecks.java", "diffHunk": "@@ -515,6 +517,10 @@ private void checkMessageLimit(\n                 .expect(ResponsePredicate.SC_OK)\n                 .as(BodyCodec.jsonObject());\n \n+        if (config.getQueryTimeout() > 0) {\n+           request.addQueryParam(\"timeout\", String.format(\"%dms\", config.getQueryTimeout()));", "originalCommit": "ed3ff7cdedce42407be7e5184f6498c4a1d3d676", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ4NjQ1OA==", "url": "https://github.com/eclipse/hono/pull/1882#discussion_r409486458", "bodyText": "You are totally right, such edge case will definitely happen. Here I see several options :\n\nadd some additional time (for example can be 20 or 50 percentage more than web client timeout ) to timeout query parameter ;  In my understating this will reduce probability of such edge case but still this will happen, because  this additional time  will certainly depend on network and maybe some Prometheus configuration.\ndo not set timeout query parameter; Prometheus already have a global query timeout\nhave additional configuration section like query HONO_RESOURCELIMITS_PROMETHEUSBASED_QUERYPARAMETERS_TIMEOUT, that will give for user directly access and configuration for this value.\nkeep timeout query parameter with the value as for web client and put additional query parameter time   that indicate when the execution have been started (at least this is my understating regarding time parameter );  for more info see https://gitlab.cncf.ci/prometheus/prometheus/blob/3bce14db85998b48dde4066d9490b4f3eb4223e1/docs/querying/api.md\n@sophokles73, WDYT?", "author": "bordeuax", "createdAt": "2020-04-16T11:34:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDU2ODYxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTU3MDgwNQ==", "url": "https://github.com/eclipse/hono/pull/1882#discussion_r409570805", "bodyText": "IMHO we should rely on Prometheus' global query timeout and use the vert.x WebClient's timeout property as a backstop. The backstop should be configurable using e.g. the HONO_RESOURCELIMITS_PROMETHEUSBASED_QUERYTIMEOUT variable.", "author": "sophokles73", "createdAt": "2020-04-16T13:49:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDU2ODYxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDA5MDgyNQ==", "url": "https://github.com/eclipse/hono/pull/1882#discussion_r410090825", "bodyText": "OK. Fixed , followed your suggestions.", "author": "bordeuax", "createdAt": "2020-04-17T09:03:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDU2ODYxMQ=="}], "type": "inlineReview", "revised_code": {"commit": "fb6a10bf1c0fcf7a715396adeb42372dbddffe3e", "chunk": "diff --git a/service-base/src/main/java/org/eclipse/hono/service/resourcelimits/PrometheusBasedResourceLimitChecks.java b/service-base/src/main/java/org/eclipse/hono/service/resourcelimits/PrometheusBasedResourceLimitChecks.java\nindex 0b1dbef4a..597225088 100644\n--- a/service-base/src/main/java/org/eclipse/hono/service/resourcelimits/PrometheusBasedResourceLimitChecks.java\n+++ b/service-base/src/main/java/org/eclipse/hono/service/resourcelimits/PrometheusBasedResourceLimitChecks.java\n\n@@ -518,7 +516,10 @@ public final class PrometheusBasedResourceLimitChecks implements ResourceLimitCh\n                 .as(BodyCodec.jsonObject());\n \n         if (config.getQueryTimeout() > 0) {\n-           request.addQueryParam(\"timeout\", String.format(\"%dms\", config.getQueryTimeout()));\n+            // enables timeout for HTTP request\n+            request.timeout(config.getQueryTimeout());\n+            // sets timeout for prometheus as query parameters, for more info see https://prometheus.io/docs/prometheus/latest/querying/api/#instant-queries\n+            request.addQueryParam(\"timeout\", String.format(\"%dms\", config.getQueryTimeout()));\n         }\n \n         if (!Strings.isNullOrEmpty(config.getUsername()) && !Strings.isNullOrEmpty(config.getPassword())) {\n"}}, {"oid": "fb6a10bf1c0fcf7a715396adeb42372dbddffe3e", "url": "https://github.com/eclipse/hono/commit/fb6a10bf1c0fcf7a715396adeb42372dbddffe3e", "message": "[#1865] Hono resource limits : add timeout for Prometheus queries\n\nSigned-off-by: Sergiu Bordeianu <sergiu.bordeianu@bosch-si.com>", "committedDate": "2020-04-15T14:52:54Z", "type": "forcePushed"}, {"oid": "aed4ed5626d1182074a82548549155207e413f75", "url": "https://github.com/eclipse/hono/commit/aed4ed5626d1182074a82548549155207e413f75", "message": "[#1865] Hono resource limits : add timeout for Prometheus queries\n\nSigned-off-by: Sergiu Bordeianu <sergiu.bordeianu@bosch-si.com>", "committedDate": "2020-04-17T09:01:17Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDEzNTU3OQ==", "url": "https://github.com/eclipse/hono/pull/1882#discussion_r410135579", "bodyText": "how about using a request instead of the request since you are not referring to a particular request? e.g\n\nGets the period of time after which a request to a Prometheus server is closed", "author": "Alfusainey", "createdAt": "2020-04-17T10:27:45Z", "path": "service-base/src/main/java/org/eclipse/hono/service/resourcelimits/PrometheusBasedResourceLimitChecksConfig.java", "diffHunk": "@@ -138,4 +144,28 @@ public void setCacheTimeout(final long timeout) {\n         this.cacheTimeout = timeout;\n     }\n \n+    /**\n+     * Gets the period of time after which the request to a Prometheus server are closed.\n+     * <p>", "originalCommit": "aed4ed5626d1182074a82548549155207e413f75", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8dc5a7567f7c3696421c22a7ad5401829f58139a", "chunk": "diff --git a/service-base/src/main/java/org/eclipse/hono/service/resourcelimits/PrometheusBasedResourceLimitChecksConfig.java b/service-base/src/main/java/org/eclipse/hono/service/resourcelimits/PrometheusBasedResourceLimitChecksConfig.java\nindex 0eddcbb07..46171fdfd 100644\n--- a/service-base/src/main/java/org/eclipse/hono/service/resourcelimits/PrometheusBasedResourceLimitChecksConfig.java\n+++ b/service-base/src/main/java/org/eclipse/hono/service/resourcelimits/PrometheusBasedResourceLimitChecksConfig.java\n\n@@ -145,7 +145,7 @@ public final class PrometheusBasedResourceLimitChecksConfig extends Authenticati\n     }\n \n     /**\n-     * Gets the period of time after which the request to a Prometheus server are closed.\n+     * Gets the period of time after which a request to a Prometheus server are closed.\n      * <p>\n      * The default value of this property is {@link #DEFAULT_QUERY_TIMEOUT}.\n      *\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDEzNjA4NA==", "url": "https://github.com/eclipse/hono/pull/1882#discussion_r410136084", "bodyText": "same as above", "author": "Alfusainey", "createdAt": "2020-04-17T10:28:49Z", "path": "service-base/src/main/java/org/eclipse/hono/service/resourcelimits/PrometheusBasedResourceLimitChecksConfig.java", "diffHunk": "@@ -138,4 +144,28 @@ public void setCacheTimeout(final long timeout) {\n         this.cacheTimeout = timeout;\n     }\n \n+    /**\n+     * Gets the period of time after which the request to a Prometheus server are closed.\n+     * <p>\n+     * The default value of this property is {@link #DEFAULT_QUERY_TIMEOUT}.\n+     *\n+     * @return The timeout for the request to a remote server in milliseconds, zero or negative value is for disabled timeout.\n+     */\n+    public long getQueryTimeout() {\n+        return queryTimeout;\n+    }\n+\n+    /**\n+     * Sets the period of time after which the request to a Prometheus server are closed.", "originalCommit": "aed4ed5626d1182074a82548549155207e413f75", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8dc5a7567f7c3696421c22a7ad5401829f58139a", "chunk": "diff --git a/service-base/src/main/java/org/eclipse/hono/service/resourcelimits/PrometheusBasedResourceLimitChecksConfig.java b/service-base/src/main/java/org/eclipse/hono/service/resourcelimits/PrometheusBasedResourceLimitChecksConfig.java\nindex 0eddcbb07..46171fdfd 100644\n--- a/service-base/src/main/java/org/eclipse/hono/service/resourcelimits/PrometheusBasedResourceLimitChecksConfig.java\n+++ b/service-base/src/main/java/org/eclipse/hono/service/resourcelimits/PrometheusBasedResourceLimitChecksConfig.java\n\n@@ -145,7 +145,7 @@ public final class PrometheusBasedResourceLimitChecksConfig extends Authenticati\n     }\n \n     /**\n-     * Gets the period of time after which the request to a Prometheus server are closed.\n+     * Gets the period of time after which a request to a Prometheus server are closed.\n      * <p>\n      * The default value of this property is {@link #DEFAULT_QUERY_TIMEOUT}.\n      *\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDEzNjM4Nw==", "url": "https://github.com/eclipse/hono/pull/1882#discussion_r410136387", "bodyText": "has occured", "author": "Alfusainey", "createdAt": "2020-04-17T10:29:28Z", "path": "service-base/src/test/java/org/eclipse/hono/service/resourcelimits/PrometheusBasedResourceLimitChecksTest.java", "diffHunk": "@@ -519,6 +545,35 @@ public void testConnectionDurationLimitExceeded(final VertxTestContext ctx) {\n                 }));\n     }\n \n+    /**\n+     * Verifies that the message limit check returns {@code false} if a timeout is occurred.", "originalCommit": "aed4ed5626d1182074a82548549155207e413f75", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8dc5a7567f7c3696421c22a7ad5401829f58139a", "chunk": "diff --git a/service-base/src/test/java/org/eclipse/hono/service/resourcelimits/PrometheusBasedResourceLimitChecksTest.java b/service-base/src/test/java/org/eclipse/hono/service/resourcelimits/PrometheusBasedResourceLimitChecksTest.java\nindex 524169986..f90f79e71 100644\n--- a/service-base/src/test/java/org/eclipse/hono/service/resourcelimits/PrometheusBasedResourceLimitChecksTest.java\n+++ b/service-base/src/test/java/org/eclipse/hono/service/resourcelimits/PrometheusBasedResourceLimitChecksTest.java\n\n@@ -546,7 +546,7 @@ public class PrometheusBasedResourceLimitChecksTest {\n     }\n \n     /**\n-     * Verifies that the message limit check returns {@code false} if a timeout is occurred.\n+     * Verifies that the message limit check returns {@code false} if a timeout has occurred.\n      *\n      * @param ctx The vert.x test context.\n      */\n"}}, {"oid": "8dc5a7567f7c3696421c22a7ad5401829f58139a", "url": "https://github.com/eclipse/hono/commit/8dc5a7567f7c3696421c22a7ad5401829f58139a", "message": "[#1865] Hono resource limits : add timeout for Prometheus queries\n\nSigned-off-by: Sergiu Bordeianu <sergiu.bordeianu@bosch-si.com>", "committedDate": "2020-04-21T13:41:51Z", "type": "commit"}, {"oid": "8dc5a7567f7c3696421c22a7ad5401829f58139a", "url": "https://github.com/eclipse/hono/commit/8dc5a7567f7c3696421c22a7ad5401829f58139a", "message": "[#1865] Hono resource limits : add timeout for Prometheus queries\n\nSigned-off-by: Sergiu Bordeianu <sergiu.bordeianu@bosch-si.com>", "committedDate": "2020-04-21T13:41:51Z", "type": "forcePushed"}]}