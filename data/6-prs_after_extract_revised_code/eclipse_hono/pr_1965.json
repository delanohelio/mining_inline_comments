{"pr_number": 1965, "pr_title": "[#1951] Close all command consumers on connection close", "pr_createdAt": "2020-05-18T05:05:51Z", "pr_url": "https://github.com/eclipse/hono/pull/1965", "timeline": [{"oid": "d50aeceab8f000b32b7d9e922b139d6f6155d638", "url": "https://github.com/eclipse/hono/commit/d50aeceab8f000b32b7d9e922b139d6f6155d638", "message": "[#1951] Close all command consumers on connection close.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>", "committedDate": "2020-05-18T05:04:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzEyNDY1Mw==", "url": "https://github.com/eclipse/hono/pull/1965#discussion_r427124653", "bodyText": "does ProtonConnection.attachments() always return a non-null value?", "author": "sophokles73", "createdAt": "2020-05-19T08:32:49Z", "path": "adapters/amqp-vertx/src/main/java/org/eclipse/hono/adapter/amqp/impl/VertxBasedAmqpProtocolAdapter.java", "diffHunk": "@@ -1250,23 +1255,37 @@ private void reportSentCommand(final TenantObject tenantObject, final CommandCon\n         }\n     }\n \n-    private static void setConnectionLossHandler(final ProtonConnection con, final Handler<Void> handler) {\n-\n-        con.attachments().set(\"connectionLossHandler\", Handler.class, handler);\n+    private static void setConnectionLossHandler(final ProtonConnection con, final String key, final Function<Span, Future<Void>> handler) {\n+        @SuppressWarnings(\"unchecked\")\n+        final Map<String, Function<Span, Future<Void>>> handlers = Optional\n+                .ofNullable(con.attachments().get(KEY_CONNECTION_LOSS_HANDLERS, Map.class))\n+                .orElse(new HashMap<>());\n+        handlers.put(key, handler);\n+        con.attachments().set(KEY_CONNECTION_LOSS_HANDLERS, Map.class, handlers);\n     }\n \n-    @SuppressWarnings(\"unchecked\")\n-    private static Handler<Void> getConnectionLossHandler(final ProtonConnection con) {\n+    private static Collection<Function<Span, Future<Void>>> getConnectionLossHandlers(final ProtonConnection con) {\n+        @SuppressWarnings(\"unchecked\")\n+        final Map<String, Function<Span, Future<Void>>> handlers = con.attachments().get(KEY_CONNECTION_LOSS_HANDLERS, Map.class);\n+        return handlers != null ? handlers.values() : Collections.emptyList();\n+    }\n \n-        return con.attachments().get(\"connectionLossHandler\", Handler.class);\n+    private static boolean removeConnectionLossHandler(final ProtonConnection con, final String key) {\n+        @SuppressWarnings(\"unchecked\")\n+        final Map<String, Function<Span, Future<Void>>> handlers = con.attachments().get(KEY_CONNECTION_LOSS_HANDLERS, Map.class);\n+        return handlers != null && handlers.remove(key) != null;\n     }\n \n     private static Device getAuthenticatedDevice(final ProtonConnection con) {\n-        return Optional.ofNullable(con.attachments())\n-                .map(attachments -> attachments.get(AmqpAdapterConstants.KEY_CLIENT_DEVICE, Device.class))\n+        return Optional.ofNullable(con.attachments().get(AmqpAdapterConstants.KEY_CLIENT_DEVICE, Device.class))", "originalCommit": "d50aeceab8f000b32b7d9e922b139d6f6155d638", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzI2NTcwNw==", "url": "https://github.com/eclipse/hono/pull/1965#discussion_r427265707", "bodyText": "With the current Proton implementation classes, yes. And besides, it would be inconsistent having the null check here, but not in the many other places where the attachments are used.", "author": "calohmn", "createdAt": "2020-05-19T12:34:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzEyNDY1Mw=="}], "type": "inlineReview", "revised_code": null}]}