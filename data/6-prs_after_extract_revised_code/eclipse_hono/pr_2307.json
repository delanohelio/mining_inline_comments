{"pr_number": 2307, "pr_title": "Fix search devices operation and integration tests", "pr_createdAt": "2020-11-19T22:34:26Z", "pr_url": "https://github.com/eclipse/hono/pull/2307", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzQ4NTg4NA==", "url": "https://github.com/eclipse/hono/pull/2307#discussion_r527485884", "bodyText": "would you mind creating an issue for this that we can refer to in this PR as this seems to be clearly a bug, right?", "author": "sophokles73", "createdAt": "2020-11-20T07:21:07Z", "path": "services/device-registry-mongodb/src/main/java/org/eclipse/hono/deviceregistry/mongodb/utils/MongoDbDocumentBuilder.java", "diffHunk": "@@ -207,12 +207,9 @@ public MongoDbDocumentBuilder withDeviceFilters(final List<Filter> filters) {\n         filters.forEach(filter -> {\n             if (filter.getValue() instanceof String) {\n                 final String value = (String) filter.getValue();\n-                if (value.contains(\"*\") || value.contains(\"?\")) {\n-                    // if the value contains * and ? then use regex matching\n-                    document.put(mapDeviceField(filter.getField()),\n-                            new JsonObject().put(\"$regex\",\n-                                    DeviceRegistryUtils.getRegexExpressionForSearchOperation(value)));\n-                }\n+                document.put(mapDeviceField(filter.getField()),", "originalCommit": "15df141531d790177957c6dca99d11c6aac8c751", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzUzNzU4Mw==", "url": "https://github.com/eclipse/hono/pull/2307#discussion_r527537583", "bodyText": "I have created an issue  #2308 for the above.", "author": "kaniyan", "createdAt": "2020-11-20T08:59:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzQ4NTg4NA=="}], "type": "inlineReview", "revised_code": {"commit": "e63c7d68cce6914267c053887c0bdd57394faac3", "chunk": "diff --git a/services/device-registry-mongodb/src/main/java/org/eclipse/hono/deviceregistry/mongodb/utils/MongoDbDocumentBuilder.java b/services/device-registry-mongodb/src/main/java/org/eclipse/hono/deviceregistry/mongodb/utils/MongoDbDocumentBuilder.java\nindex e5730945d..c796b3fe6 100644\n--- a/services/device-registry-mongodb/src/main/java/org/eclipse/hono/deviceregistry/mongodb/utils/MongoDbDocumentBuilder.java\n+++ b/services/device-registry-mongodb/src/main/java/org/eclipse/hono/deviceregistry/mongodb/utils/MongoDbDocumentBuilder.java\n\n@@ -207,9 +207,12 @@ public final class MongoDbDocumentBuilder {\n         filters.forEach(filter -> {\n             if (filter.getValue() instanceof String) {\n                 final String value = (String) filter.getValue();\n-                document.put(mapDeviceField(filter.getField()),\n-                        new JsonObject().put(\"$regex\",\n-                                DeviceRegistryUtils.getRegexExpressionForSearchOperation(value)));\n+                if (value.contains(\"*\") || value.contains(\"?\")) {\n+                    // if the value contains * and ? then use regex matching\n+                    document.put(mapDeviceField(filter.getField()),\n+                            new JsonObject().put(\"$regex\",\n+                                    DeviceRegistryUtils.getRegexExpressionForSearchOperation(value)));\n+                }\n             } else {\n                 document.put(mapDeviceField(filter.getField()), filter.getValue());\n             }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzQ4Njc2NQ==", "url": "https://github.com/eclipse/hono/pull/2307#discussion_r527486765", "bodyText": "nice catch \ud83d\udc4d", "author": "sophokles73", "createdAt": "2020-11-20T07:23:31Z", "path": "tests/src/test/java/org/eclipse/hono/tests/registry/DeviceManagementIT.java", "diffHunk": "@@ -403,7 +401,7 @@ public void testDeregisterDeviceFailsForNonExistingDevice(final VertxTestContext\n      *      Device Registry Management API - Search Devices</a>\n      */\n     @Nested\n-    @EnabledIfSystemProperty(named = \"hono.deviceregistry.supportsSearchDevices\", matches = \"true\")\n+    @EnabledIfSystemProperty(named = \"deviceregistry.supportsSearchDevices\", matches = \"true\")", "originalCommit": "15df141531d790177957c6dca99d11c6aac8c751", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e63c7d68cce6914267c053887c0bdd57394faac3", "chunk": "diff --git a/tests/src/test/java/org/eclipse/hono/tests/registry/DeviceManagementIT.java b/tests/src/test/java/org/eclipse/hono/tests/registry/DeviceManagementIT.java\nindex 8549c2581..5114de586 100644\n--- a/tests/src/test/java/org/eclipse/hono/tests/registry/DeviceManagementIT.java\n+++ b/tests/src/test/java/org/eclipse/hono/tests/registry/DeviceManagementIT.java\n\n@@ -401,7 +403,7 @@ public class DeviceManagementIT extends DeviceRegistryTestBase {\n      *      Device Registry Management API - Search Devices</a>\n      */\n     @Nested\n-    @EnabledIfSystemProperty(named = \"deviceregistry.supportsSearchDevices\", matches = \"true\")\n+    @EnabledIfSystemProperty(named = \"hono.deviceregistry.supportsSearchDevices\", matches = \"true\")\n     class SearchDevicesIT {\n         /**\n          * Verifies that a request to search devices fails with a {@value HttpURLConnection#HTTP_NOT_FOUND}\n"}}, {"oid": "e63c7d68cce6914267c053887c0bdd57394faac3", "url": "https://github.com/eclipse/hono/commit/e63c7d68cce6914267c053887c0bdd57394faac3", "message": "Disable search devices integration tests for JDBC based device registry\n\n* Integration tests corresponding to the search devices operation have been disabled for the\n JDBC based device registry as it doesn't implement this operation.\n\nSigned-off-by: Kartheeswaran Kalidass <kartheeswaran.kalidass@bosch.io>", "committedDate": "2020-11-20T11:34:30Z", "type": "commit"}, {"oid": "37f2a94b4caa8effce210b4e39844665334e75cc", "url": "https://github.com/eclipse/hono/commit/37f2a94b4caa8effce210b4e39844665334e75cc", "message": "[#2308] Fix search devices operation and corresponding integration tests\n\n* The integration tests for the search devices operation have not been running as it expects\n  the system property `hono.deviceregistry.supportsSearchDevices` set to true. This property\n  has been renamed to  `deviceregistry.supportsSearchDevices` in the `pom.xml` of tests\n  module but not in the corresponding test class. This has been fixed now to use the renamed\n  property in the test class.\n\n* When the data type of a filter value is string and the value doesn't contain any search wild\n  card characters then that filter has been ignored by the MongoDB device registry. This has\n  been fixed.\n\n* When there are no filters specified in the request, then at least the results should be\n  filtered based on the tenant identifier in the request URL. This has been fixed.\n\n* Fix integration tests corresponding to the search devices operation.\n\nSigned-off-by: Kartheeswaran Kalidass <kartheeswaran.kalidass@bosch.io>", "committedDate": "2020-11-20T11:34:30Z", "type": "commit"}, {"oid": "37f2a94b4caa8effce210b4e39844665334e75cc", "url": "https://github.com/eclipse/hono/commit/37f2a94b4caa8effce210b4e39844665334e75cc", "message": "[#2308] Fix search devices operation and corresponding integration tests\n\n* The integration tests for the search devices operation have not been running as it expects\n  the system property `hono.deviceregistry.supportsSearchDevices` set to true. This property\n  has been renamed to  `deviceregistry.supportsSearchDevices` in the `pom.xml` of tests\n  module but not in the corresponding test class. This has been fixed now to use the renamed\n  property in the test class.\n\n* When the data type of a filter value is string and the value doesn't contain any search wild\n  card characters then that filter has been ignored by the MongoDB device registry. This has\n  been fixed.\n\n* When there are no filters specified in the request, then at least the results should be\n  filtered based on the tenant identifier in the request URL. This has been fixed.\n\n* Fix integration tests corresponding to the search devices operation.\n\nSigned-off-by: Kartheeswaran Kalidass <kartheeswaran.kalidass@bosch.io>", "committedDate": "2020-11-20T11:34:30Z", "type": "forcePushed"}]}