{"pr_number": 2223, "pr_title": "Remove auth-id and credentials type regex pattern from API", "pr_createdAt": "2020-09-29T13:23:46Z", "pr_url": "https://github.com/eclipse/hono/pull/2223", "timeline": [{"oid": "7f4a6a85828b37d5fabe3aff85f178cb1f4b6860", "url": "https://github.com/eclipse/hono/commit/7f4a6a85828b37d5fabe3aff85f178cb1f4b6860", "message": "Remove auth-id and credentials type regex pattern from API\n\nAlso removed obsolete parameter type and improved documentation of\ncredentials and secrets objects.\n\nSigned-off-by: Kai Hudalla <kai.hudalla@bosch.io>", "committedDate": "2020-09-30T11:44:52Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzQ1NjE0Ng==", "url": "https://github.com/eclipse/hono/pull/2223#discussion_r497456146", "bodyText": "final?", "author": "calohmn", "createdAt": "2020-09-30T12:06:26Z", "path": "services/device-registry-base/src/main/java/org/eclipse/hono/service/management/credentials/CommonCredential.java", "diffHunk": "@@ -39,21 +37,6 @@\n @JsonTypeIdResolver(CredentialTypeResolver.class)\n public abstract class CommonCredential {\n \n-    /**\n-     * A predicate for matching authentication identifiers against the\n-     * {@linkplain CredentialsConstants#PATTERN_AUTH_ID_VALUE default pattern}.\n-     */\n-    protected static final Predicate<String> AUTH_ID_VALIDATOR_DEFAULT = authId -> {\n-        final Matcher matcher = CredentialsConstants.PATTERN_AUTH_ID_VALUE.matcher(authId);\n-        if (matcher.matches()) {\n-            return true;\n-        } else {\n-            throw new IllegalArgumentException(\"authentication identifier must match pattern \"\n-                    + CredentialsConstants.PATTERN_AUTH_ID_VALUE.pattern());\n-        }\n-    };\n-\n-    @JsonProperty(value = RegistryManagementConstants.FIELD_AUTH_ID)\n     private String authId;", "originalCommit": "7f4a6a85828b37d5fabe3aff85f178cb1f4b6860", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "02d929702c113e3e1675e6a979039cdb6857a224", "chunk": "diff --git a/services/device-registry-base/src/main/java/org/eclipse/hono/service/management/credentials/CommonCredential.java b/services/device-registry-base/src/main/java/org/eclipse/hono/service/management/credentials/CommonCredential.java\nindex 468b23b78..3f94d5e5a 100644\n--- a/services/device-registry-base/src/main/java/org/eclipse/hono/service/management/credentials/CommonCredential.java\n+++ b/services/device-registry-base/src/main/java/org/eclipse/hono/service/management/credentials/CommonCredential.java\n\n@@ -37,7 +37,8 @@ import com.google.common.base.Strings;\n @JsonTypeIdResolver(CredentialTypeResolver.class)\n public abstract class CommonCredential {\n \n-    private String authId;\n+    private final String authId;\n+\n     @JsonProperty(RegistryManagementConstants.FIELD_ENABLED)\n     private Boolean enabled;\n     @JsonProperty(RegistryManagementConstants.FIELD_COMMENT)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzQ2MTA5NA==", "url": "https://github.com/eclipse/hono/pull/2223#discussion_r497461094", "bodyText": "Now that is validator isn't used as default anymore and is only used for a PasswordCredential, I think the CredentialsConstants.PATTERN_AUTH_ID_VALUE constant should be moved to the PasswordCredential class as well, or the javadoc there should be adapted to not give the impression that this pattern is used for all auth-id values in all kinds of credentials.", "author": "calohmn", "createdAt": "2020-09-30T12:15:25Z", "path": "services/device-registry-base/src/main/java/org/eclipse/hono/service/management/credentials/CommonCredential.java", "diffHunk": "@@ -39,21 +37,6 @@\n @JsonTypeIdResolver(CredentialTypeResolver.class)\n public abstract class CommonCredential {\n \n-    /**\n-     * A predicate for matching authentication identifiers against the\n-     * {@linkplain CredentialsConstants#PATTERN_AUTH_ID_VALUE default pattern}.\n-     */\n-    protected static final Predicate<String> AUTH_ID_VALIDATOR_DEFAULT = authId -> {\n-        final Matcher matcher = CredentialsConstants.PATTERN_AUTH_ID_VALUE.matcher(authId);", "originalCommit": "7f4a6a85828b37d5fabe3aff85f178cb1f4b6860", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzUxMTk5OA==", "url": "https://github.com/eclipse/hono/pull/2223#discussion_r497511998", "bodyText": "I agree. I will move the constant to the PasswordCredential class.", "author": "sophokles73", "createdAt": "2020-09-30T13:32:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzQ2MTA5NA=="}], "type": "inlineReview", "revised_code": {"commit": "02d929702c113e3e1675e6a979039cdb6857a224", "chunk": "diff --git a/services/device-registry-base/src/main/java/org/eclipse/hono/service/management/credentials/CommonCredential.java b/services/device-registry-base/src/main/java/org/eclipse/hono/service/management/credentials/CommonCredential.java\nindex 468b23b78..3f94d5e5a 100644\n--- a/services/device-registry-base/src/main/java/org/eclipse/hono/service/management/credentials/CommonCredential.java\n+++ b/services/device-registry-base/src/main/java/org/eclipse/hono/service/management/credentials/CommonCredential.java\n\n@@ -37,7 +37,8 @@ import com.google.common.base.Strings;\n @JsonTypeIdResolver(CredentialTypeResolver.class)\n public abstract class CommonCredential {\n \n-    private String authId;\n+    private final String authId;\n+\n     @JsonProperty(RegistryManagementConstants.FIELD_ENABLED)\n     private Boolean enabled;\n     @JsonProperty(RegistryManagementConstants.FIELD_COMMENT)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzQ2MjQ0Mw==", "url": "https://github.com/eclipse/hono/pull/2223#discussion_r497462443", "bodyText": "With this change the javadoc mentioning the IllegalArgumentException in the PskCredential and GenericCredential constructors isn't correct anymore.", "author": "calohmn", "createdAt": "2020-09-30T12:17:47Z", "path": "services/device-registry-base/src/main/java/org/eclipse/hono/service/management/credentials/CommonCredential.java", "diffHunk": "@@ -110,23 +93,15 @@ protected CommonCredential(final String authId) {\n      * @return The predicate.\n      */\n     protected Predicate<String> getAuthIdValidator() {\n-        return AUTH_ID_VALIDATOR_DEFAULT;\n+        return s -> true;", "originalCommit": "7f4a6a85828b37d5fabe3aff85f178cb1f4b6860", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzQ2NTY4NA==", "url": "https://github.com/eclipse/hono/pull/2223#discussion_r497465684", "bodyText": "PATTERN_AUTH_ID_VALUE not generally used anymore, so I would suggest:\nInstead of \"to match the ...\", using something like \"to pass the corresponding authIdValidator check\".", "author": "calohmn", "createdAt": "2020-09-30T12:23:25Z", "path": "services/device-registry-base/src/test/java/org/eclipse/hono/service/management/credentials/CredentialsTest.java", "diffHunk": "@@ -497,39 +492,38 @@ public void testMergeSucceedsForMatchingSecretIds() {\n     /**\n      * Verifies that a credentials object requires the authentication identifier to match\n      * the {@linkplain org.eclipse.hono.util.CredentialsConstants#PATTERN_AUTH_ID_VALUE auth id regex}.", "originalCommit": "7f4a6a85828b37d5fabe3aff85f178cb1f4b6860", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "02d929702c113e3e1675e6a979039cdb6857a224", "chunk": "diff --git a/services/device-registry-base/src/test/java/org/eclipse/hono/service/management/credentials/CredentialsTest.java b/services/device-registry-base/src/test/java/org/eclipse/hono/service/management/credentials/CredentialsTest.java\nindex 81cb60043..13ec66f7d 100644\n--- a/services/device-registry-base/src/test/java/org/eclipse/hono/service/management/credentials/CredentialsTest.java\n+++ b/services/device-registry-base/src/test/java/org/eclipse/hono/service/management/credentials/CredentialsTest.java\n\n@@ -490,13 +490,13 @@ public class CredentialsTest {\n     }\n \n     /**\n-     * Verifies that a credentials object requires the authentication identifier to match\n-     * the {@linkplain org.eclipse.hono.util.CredentialsConstants#PATTERN_AUTH_ID_VALUE auth id regex}.\n+     * Verifies that PasswordCredentials and X.509CertificateCredentials require the authentication\n+     * identifier to match type specific patterns.\n      */\n     @Test\n     public void testInstantiationFailsForIllegalAuthId() {\n \n-        illegalAuthIds().forEach(authId -> {\n+        illegalPasswordCredentialAuthIds().forEach(authId -> {\n             assertThatThrownBy(() -> new PasswordCredential(authId, List.of(new PasswordSecret())))\n                 .isInstanceOf(IllegalArgumentException.class);\n         });\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzQ3MDk2Ng==", "url": "https://github.com/eclipse/hono/pull/2223#discussion_r497470966", "bodyText": "\"PSK credential\" not used in this test.", "author": "calohmn", "createdAt": "2020-09-30T12:32:13Z", "path": "services/device-registry-base/src/test/java/org/eclipse/hono/service/management/credentials/CredentialsTest.java", "diffHunk": "@@ -497,39 +492,38 @@ public void testMergeSucceedsForMatchingSecretIds() {\n     /**\n      * Verifies that a credentials object requires the authentication identifier to match\n      * the {@linkplain org.eclipse.hono.util.CredentialsConstants#PATTERN_AUTH_ID_VALUE auth id regex}.\n-     *\n-     * @param illegalAuthId An auth-id that does not comply with the pattern.\n      */\n-    @MethodSource(\"illegalAuthIds\")\n-    @ParameterizedTest\n-    public void testInstantiationFailsForIllegalAuthId(final String illegalAuthId) {\n-        assertThatThrownBy(() -> new GenericCredential(\"custom\", illegalAuthId, List.of(new GenericSecret())))\n-            .isInstanceOf(IllegalArgumentException.class);\n-        assertThatThrownBy(() -> new PasswordCredential(illegalAuthId, List.of(new PasswordSecret())))\n-            .isInstanceOf(IllegalArgumentException.class);\n-        assertThatThrownBy(() -> new PskCredential(illegalAuthId, List.of(new PskSecret())))\n-            .isInstanceOf(IllegalArgumentException.class);\n-        assertThatThrownBy(() -> new X509CertificateCredential(illegalAuthId, List.of(new X509CertificateSecret())))\n+    @Test\n+    public void testInstantiationFailsForIllegalAuthId() {\n+\n+        illegalAuthIds().forEach(authId -> {\n+            assertThatThrownBy(() -> new PasswordCredential(authId, List.of(new PasswordSecret())))\n+                .isInstanceOf(IllegalArgumentException.class);\n+        });\n+\n+        assertThatThrownBy(() -> new X509CertificateCredential(\"not-a-subject-DN\", List.of(new X509CertificateSecret())))\n             .isInstanceOf(IllegalArgumentException.class);\n     }\n \n     /**\n      * Verifies that decoding of a JSON object to a PSK credential\n      * fails if the authentication identifier does not match the auth ID regex.", "originalCommit": "7f4a6a85828b37d5fabe3aff85f178cb1f4b6860", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "02d929702c113e3e1675e6a979039cdb6857a224", "chunk": "diff --git a/services/device-registry-base/src/test/java/org/eclipse/hono/service/management/credentials/CredentialsTest.java b/services/device-registry-base/src/test/java/org/eclipse/hono/service/management/credentials/CredentialsTest.java\nindex 81cb60043..13ec66f7d 100644\n--- a/services/device-registry-base/src/test/java/org/eclipse/hono/service/management/credentials/CredentialsTest.java\n+++ b/services/device-registry-base/src/test/java/org/eclipse/hono/service/management/credentials/CredentialsTest.java\n\n@@ -490,13 +490,13 @@ public class CredentialsTest {\n     }\n \n     /**\n-     * Verifies that a credentials object requires the authentication identifier to match\n-     * the {@linkplain org.eclipse.hono.util.CredentialsConstants#PATTERN_AUTH_ID_VALUE auth id regex}.\n+     * Verifies that PasswordCredentials and X.509CertificateCredentials require the authentication\n+     * identifier to match type specific patterns.\n      */\n     @Test\n     public void testInstantiationFailsForIllegalAuthId() {\n \n-        illegalAuthIds().forEach(authId -> {\n+        illegalPasswordCredentialAuthIds().forEach(authId -> {\n             assertThatThrownBy(() -> new PasswordCredential(authId, List.of(new PasswordSecret())))\n                 .isInstanceOf(IllegalArgumentException.class);\n         });\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzQ3MzcyNQ==", "url": "https://github.com/eclipse/hono/pull/2223#discussion_r497473725", "bodyText": "The IllegalArgumentException thrown here doesn't seem to come from the auth-id validation (\"Missing required creator property 'secrets' (index 1)\").\nSame for the code below.", "author": "calohmn", "createdAt": "2020-09-30T12:36:39Z", "path": "services/device-registry-base/src/test/java/org/eclipse/hono/service/management/credentials/CredentialsTest.java", "diffHunk": "@@ -497,39 +492,38 @@ public void testMergeSucceedsForMatchingSecretIds() {\n     /**\n      * Verifies that a credentials object requires the authentication identifier to match\n      * the {@linkplain org.eclipse.hono.util.CredentialsConstants#PATTERN_AUTH_ID_VALUE auth id regex}.\n-     *\n-     * @param illegalAuthId An auth-id that does not comply with the pattern.\n      */\n-    @MethodSource(\"illegalAuthIds\")\n-    @ParameterizedTest\n-    public void testInstantiationFailsForIllegalAuthId(final String illegalAuthId) {\n-        assertThatThrownBy(() -> new GenericCredential(\"custom\", illegalAuthId, List.of(new GenericSecret())))\n-            .isInstanceOf(IllegalArgumentException.class);\n-        assertThatThrownBy(() -> new PasswordCredential(illegalAuthId, List.of(new PasswordSecret())))\n-            .isInstanceOf(IllegalArgumentException.class);\n-        assertThatThrownBy(() -> new PskCredential(illegalAuthId, List.of(new PskSecret())))\n-            .isInstanceOf(IllegalArgumentException.class);\n-        assertThatThrownBy(() -> new X509CertificateCredential(illegalAuthId, List.of(new X509CertificateSecret())))\n+    @Test\n+    public void testInstantiationFailsForIllegalAuthId() {\n+\n+        illegalAuthIds().forEach(authId -> {\n+            assertThatThrownBy(() -> new PasswordCredential(authId, List.of(new PasswordSecret())))\n+                .isInstanceOf(IllegalArgumentException.class);\n+        });\n+\n+        assertThatThrownBy(() -> new X509CertificateCredential(\"not-a-subject-DN\", List.of(new X509CertificateSecret())))\n             .isInstanceOf(IllegalArgumentException.class);\n     }\n \n     /**\n      * Verifies that decoding of a JSON object to a PSK credential\n      * fails if the authentication identifier does not match the auth ID regex.\n-     *\n-     * @param illegalAuthId An auth-id that does not comply with the pattern.\n      */\n-    @MethodSource(\"illegalAuthIds\")\n-    @ParameterizedTest\n-    public void testDecodeFailsForIllegalAuthId(final String illegalAuthId) {\n+    @Test\n+    public void testDecodeFailsForIllegalAuthId() {\n \n-        Arrays.stream(CREDENTIAL_TYPES).forEach(type -> {\n+        illegalAuthIds().forEach(illegalAuthId -> {\n             final JsonObject jsonCredential = new JsonObject()\n-                    .put(RegistryManagementConstants.FIELD_TYPE, type)\n+                    .put(RegistryManagementConstants.FIELD_TYPE, RegistryManagementConstants.SECRETS_TYPE_HASHED_PASSWORD)\n                     .put(RegistryManagementConstants.FIELD_AUTH_ID, illegalAuthId);\n             assertThatThrownBy(() -> jsonCredential.mapTo(CommonCredential.class))\n                 .isInstanceOf(IllegalArgumentException.class);", "originalCommit": "7f4a6a85828b37d5fabe3aff85f178cb1f4b6860", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "02d929702c113e3e1675e6a979039cdb6857a224", "chunk": "diff --git a/services/device-registry-base/src/test/java/org/eclipse/hono/service/management/credentials/CredentialsTest.java b/services/device-registry-base/src/test/java/org/eclipse/hono/service/management/credentials/CredentialsTest.java\nindex 81cb60043..13ec66f7d 100644\n--- a/services/device-registry-base/src/test/java/org/eclipse/hono/service/management/credentials/CredentialsTest.java\n+++ b/services/device-registry-base/src/test/java/org/eclipse/hono/service/management/credentials/CredentialsTest.java\n\n@@ -490,13 +490,13 @@ public class CredentialsTest {\n     }\n \n     /**\n-     * Verifies that a credentials object requires the authentication identifier to match\n-     * the {@linkplain org.eclipse.hono.util.CredentialsConstants#PATTERN_AUTH_ID_VALUE auth id regex}.\n+     * Verifies that PasswordCredentials and X.509CertificateCredentials require the authentication\n+     * identifier to match type specific patterns.\n      */\n     @Test\n     public void testInstantiationFailsForIllegalAuthId() {\n \n-        illegalAuthIds().forEach(authId -> {\n+        illegalPasswordCredentialAuthIds().forEach(authId -> {\n             assertThatThrownBy(() -> new PasswordCredential(authId, List.of(new PasswordSecret())))\n                 .isInstanceOf(IllegalArgumentException.class);\n         });\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzQ3NTM0MQ==", "url": "https://github.com/eclipse/hono/pull/2223#discussion_r497475341", "bodyText": "Maybe rename to illegalPasswordCredentialAuthIds to be more clear here.", "author": "calohmn", "createdAt": "2020-09-30T12:39:00Z", "path": "services/device-registry-base/src/test/java/org/eclipse/hono/service/management/credentials/CredentialsTest.java", "diffHunk": "@@ -48,15 +44,14 @@\n  */\n public class CredentialsTest {\n \n-    private static final String[] CREDENTIAL_TYPES = { CredentialsConstants.SECRETS_TYPE_X509_CERT, CredentialsConstants.SECRETS_TYPE_HASHED_PASSWORD, CredentialsConstants.SECRETS_TYPE_PRESHARED_KEY, \"custom\" };\n     private static final String NOT_BEFORE_STRING = \"2020-08-11T11:38:00Z\";\n     private static final Instant NOT_BEFORE = Instant.parse(NOT_BEFORE_STRING);\n     private static final String NOT_AFTER_STRING = \"2031-09-11T11:38:00Z\";\n     private static final Instant NOT_AFTER = Instant.parse(NOT_AFTER_STRING);\n     private static final String SECRET_COMMENT = \"secret comment\";\n \n     static Stream<String> illegalAuthIds() {", "originalCommit": "7f4a6a85828b37d5fabe3aff85f178cb1f4b6860", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "02d929702c113e3e1675e6a979039cdb6857a224", "chunk": "diff --git a/services/device-registry-base/src/test/java/org/eclipse/hono/service/management/credentials/CredentialsTest.java b/services/device-registry-base/src/test/java/org/eclipse/hono/service/management/credentials/CredentialsTest.java\nindex 81cb60043..13ec66f7d 100644\n--- a/services/device-registry-base/src/test/java/org/eclipse/hono/service/management/credentials/CredentialsTest.java\n+++ b/services/device-registry-base/src/test/java/org/eclipse/hono/service/management/credentials/CredentialsTest.java\n\n@@ -50,7 +50,7 @@ public class CredentialsTest {\n     private static final Instant NOT_AFTER = Instant.parse(NOT_AFTER_STRING);\n     private static final String SECRET_COMMENT = \"secret comment\";\n \n-    static Stream<String> illegalAuthIds() {\n+    static Stream<String> illegalPasswordCredentialAuthIds() {\n         return Stream.of(\"$\", \"#\", \"%\", \"!\", \"(\", \")\", \"?\", \",\", \";\", \":\", \"@\", \" \", \"\");\n     }\n \n"}}, {"oid": "fae80c317b2f70963e79526f3a8368ce80cdb75e", "url": "https://github.com/eclipse/hono/commit/fae80c317b2f70963e79526f3a8368ce80cdb75e", "message": "Remove auth-id and credentials type regex pattern from API\n\nAlso removed obsolete parameter type and improved documentation of\ncredentials and secrets objects.\n\nSigned-off-by: Kai Hudalla <kai.hudalla@bosch.io>", "committedDate": "2020-10-01T07:52:27Z", "type": "commit"}, {"oid": "02d929702c113e3e1675e6a979039cdb6857a224", "url": "https://github.com/eclipse/hono/commit/02d929702c113e3e1675e6a979039cdb6857a224", "message": "Incorporate feedback\n\nSigned-off-by: Kai Hudalla <kai.hudalla@bosch.io>", "committedDate": "2020-10-01T07:52:27Z", "type": "commit"}, {"oid": "02d929702c113e3e1675e6a979039cdb6857a224", "url": "https://github.com/eclipse/hono/commit/02d929702c113e3e1675e6a979039cdb6857a224", "message": "Incorporate feedback\n\nSigned-off-by: Kai Hudalla <kai.hudalla@bosch.io>", "committedDate": "2020-10-01T07:52:27Z", "type": "forcePushed"}]}