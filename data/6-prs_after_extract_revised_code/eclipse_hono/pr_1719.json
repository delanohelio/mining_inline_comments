{"pr_number": 1719, "pr_title": "[#1718] Add exception handling; improve link creation logic", "pr_createdAt": "2020-01-24T12:25:47Z", "pr_url": "https://github.com/eclipse/hono/pull/1719", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDY1OTE0MA==", "url": "https://github.com/eclipse/hono/pull/1719#discussion_r370659140", "bodyText": "IMHO you also nee to verify that at this point the result is not completed/failed yet ...", "author": "sophokles73", "createdAt": "2020-01-24T14:25:04Z", "path": "client/src/test/java/org/eclipse/hono/client/impl/HonoConnectionImplTest.java", "diffHunk": "@@ -648,6 +648,47 @@ public void testCreateReceiverFailsOnTimeout(final TestContext ctx) {\n         verify(remoteCloseHook, never()).handle(anyString());\n     }\n \n+    /**\n+     * Verifies that the attempt to create a receiver fails with a\n+     * {@code ServerErrorException} if the connection gets disconnected\n+     * before the remote peer has sent its attach frame. It is verified\n+     * that this is done before the link establishment timeout.\n+     *\n+     * @param ctx The vert.x test context.\n+     */\n+    @Test\n+    public void testCreateReceiverFailsOnDisconnectBeforeOpen(final TestContext ctx) {\n+\n+        final long linkEstablishmentTimeout = 444L; // choose a distinct value here\n+        props.setLinkEstablishmentTimeout(linkEstablishmentTimeout);\n+        // don't run linkEstablishmentTimeout timer handler\n+        when(vertx.setTimer(eq(linkEstablishmentTimeout), any(Handler.class))).thenAnswer(invocation -> 0L);\n+\n+        // GIVEN an established connection\n+        final Async connectAttempt = ctx.async();\n+        honoConnection.connect().setHandler(ctx.asyncAssertSuccess(ok -> connectAttempt.complete()));\n+        connectAttempt.await();\n+        final Source source = mock(Source.class);\n+        when(source.getAddress()).thenReturn(\"source/address\");\n+        final ProtonReceiver receiver = mock(ProtonReceiver.class);\n+        when(receiver.isOpen()).thenReturn(Boolean.TRUE);\n+        when(receiver.getSource()).thenReturn(source);\n+        when(receiver.getRemoteSource()).thenReturn(source);\n+        when(con.createReceiver(anyString())).thenReturn(receiver);\n+\n+        // WHEN creating a receiver link with a close hook\n+        final Handler<String> remoteCloseHook = mock(Handler.class);\n+\n+        final Future<ProtonReceiver> result = honoConnection.createReceiver(\"source\", ProtonQoS.AT_LEAST_ONCE,\n+                mock(ProtonMessageHandler.class), remoteCloseHook);", "originalCommit": "ba82817e66481831564a6b3a886ab02ac752d44c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8950ea76d1aba287b943425c3b2678f4caf98dff", "chunk": "diff --git a/client/src/test/java/org/eclipse/hono/client/impl/HonoConnectionImplTest.java b/client/src/test/java/org/eclipse/hono/client/impl/HonoConnectionImplTest.java\nindex d10537341..df0fdfb14 100644\n--- a/client/src/test/java/org/eclipse/hono/client/impl/HonoConnectionImplTest.java\n+++ b/client/src/test/java/org/eclipse/hono/client/impl/HonoConnectionImplTest.java\n\n@@ -644,7 +645,6 @@ public class HonoConnectionImplTest {\n         assertThat(((ServerErrorException) result.cause()).getErrorCode(), is(HttpURLConnection.HTTP_UNAVAILABLE));\n         verify(receiver).open();\n         verify(receiver).close();\n-        verify(receiver).free();\n         verify(remoteCloseHook, never()).handle(anyString());\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDY1OTMzMw==", "url": "https://github.com/eclipse/hono/pull/1719#discussion_r370659333", "bodyText": "same here", "author": "sophokles73", "createdAt": "2020-01-24T14:25:26Z", "path": "client/src/test/java/org/eclipse/hono/client/impl/HonoConnectionImplTest.java", "diffHunk": "@@ -905,4 +946,44 @@ public void testCreateSenderThatGetsDelayedCredits(final TestContext ctx) {\n                     });\n                 });\n     }\n+\n+    /**\n+     * Verifies that the attempt to create a sender fails with a\n+     * {@code ServerErrorException} if the connection gets disconnected\n+     * before the remote peer has sent its attach frame. It is verified\n+     * that this is done before the link establishment timeout.\n+     *\n+     * @param ctx The vert.x test context.\n+     */\n+    @Test\n+    public void testCreateSenderFailsOnDisconnectBeforeOpen(final TestContext ctx) {\n+        final long linkEstablishmentTimeout = 444L; // choose a distinct value here\n+        props.setLinkEstablishmentTimeout(linkEstablishmentTimeout);\n+        // don't run linkEstablishmentTimeout timer handler\n+        when(vertx.setTimer(eq(linkEstablishmentTimeout), any(Handler.class))).thenAnswer(invocation -> 0L);\n+\n+        final ProtonSender sender = mock(ProtonSender.class);\n+        when(sender.isOpen()).thenReturn(Boolean.TRUE);\n+        when(con.createSender(anyString())).thenReturn(sender);\n+        final Target target = new Target();\n+        target.setAddress(\"someAddress\");\n+        when(sender.getRemoteTarget()).thenReturn(target);\n+        when(sender.getCredit()).thenReturn(0);\n+        // mock handlers\n+        final Handler<String> remoteCloseHook = mock(Handler.class);\n+\n+        // GIVEN an established connection\n+        final Async connectAttempt = ctx.async();\n+        honoConnection.connect().setHandler(ctx.asyncAssertSuccess(ok -> connectAttempt.complete()));\n+        connectAttempt.await();\n+\n+        final Future<ProtonSender> result = honoConnection.createSender(\n+                \"target\", ProtonQoS.AT_LEAST_ONCE, remoteCloseHook);", "originalCommit": "ba82817e66481831564a6b3a886ab02ac752d44c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8950ea76d1aba287b943425c3b2678f4caf98dff", "chunk": "diff --git a/client/src/test/java/org/eclipse/hono/client/impl/HonoConnectionImplTest.java b/client/src/test/java/org/eclipse/hono/client/impl/HonoConnectionImplTest.java\nindex d10537341..df0fdfb14 100644\n--- a/client/src/test/java/org/eclipse/hono/client/impl/HonoConnectionImplTest.java\n+++ b/client/src/test/java/org/eclipse/hono/client/impl/HonoConnectionImplTest.java\n\n@@ -980,6 +981,8 @@ public class HonoConnectionImplTest {\n         final Future<ProtonSender> result = honoConnection.createSender(\n                 \"target\", ProtonQoS.AT_LEAST_ONCE, remoteCloseHook);\n \n+        assertFalse(result.isComplete());\n+\n         // WHEN the downstream connection fails\n         connectionFactory.getDisconnectHandler().handle(con);\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDY2MDIxOA==", "url": "https://github.com/eclipse/hono/pull/1719#discussion_r370660218", "bodyText": "didn't one of the stack traces you showed me that a runtime exception had been thrown while executing the free() method?", "author": "sophokles73", "createdAt": "2020-01-24T14:27:01Z", "path": "core/src/main/java/org/eclipse/hono/util/HonoProtonHelper.java", "diffHunk": "@@ -60,7 +65,11 @@ private HonoProtonHelper() {\n         Objects.requireNonNull(handler);\n \n         final Handler<AsyncResult<T>> wrappedHandler = remoteDetach -> {\n-            handler.handle(remoteDetach);\n+            try {\n+                handler.handle(remoteDetach);\n+            } catch (final Exception ex) {\n+                LOG.warn(\"error running detachHandler\", ex);\n+            }\n             link.free();", "originalCommit": "ba82817e66481831564a6b3a886ab02ac752d44c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQ2NDEyNQ==", "url": "https://github.com/eclipse/hono/pull/1719#discussion_r373464125", "bodyText": "yes, but now these exceptions in free() shouldn't happen anymore.", "author": "calohmn", "createdAt": "2020-01-31T12:51:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDY2MDIxOA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "2ff922e35e75ec1b211d3812b773ddde3bdf389b", "url": "https://github.com/eclipse/hono/commit/2ff922e35e75ec1b211d3812b773ddde3bdf389b", "message": "[#1718] Add exception handling; improve link creation logic.\n\nFix onLinkEstablishmentTimeout(), not calling link.free()\nthere anymore (has caused session to get into invalid state).\nExceptions now get caught in disconnect/detach/close handlers\nused in HonoConnectionImpl. A disconnect during link creation\nnow causes the creation attempt to be failed directly,\nwithout waiting for the link establishment timeout.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>", "committedDate": "2020-01-31T11:54:11Z", "type": "forcePushed"}, {"oid": "8950ea76d1aba287b943425c3b2678f4caf98dff", "url": "https://github.com/eclipse/hono/commit/8950ea76d1aba287b943425c3b2678f4caf98dff", "message": "[#1718] Add exception handling; improve link creation logic.\n\nFix onLinkEstablishmentTimeout(), not calling link.free()\nthere anymore (has caused session to get into invalid state).\nExceptions now get caught in disconnect/detach/close handlers\nused in HonoConnectionImpl. A disconnect during link creation\nnow causes the creation attempt to be failed directly,\nwithout waiting for the link establishment timeout.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>", "committedDate": "2020-01-31T12:05:37Z", "type": "forcePushed"}, {"oid": "d1df97221b303fe6c95130be388674606d4f9590", "url": "https://github.com/eclipse/hono/commit/d1df97221b303fe6c95130be388674606d4f9590", "message": "[#1718] Add exception handling; improve link creation logic.\n\nFix onLinkEstablishmentTimeout(), not calling link.free()\nthere anymore (has caused session to get into invalid state).\nExceptions now get caught in disconnect/detach/close handlers\nused in HonoConnectionImpl. A disconnect during link creation\nnow causes the creation attempt to be failed directly,\nwithout waiting for the link establishment timeout.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>", "committedDate": "2020-01-31T12:47:44Z", "type": "commit"}, {"oid": "d1df97221b303fe6c95130be388674606d4f9590", "url": "https://github.com/eclipse/hono/commit/d1df97221b303fe6c95130be388674606d4f9590", "message": "[#1718] Add exception handling; improve link creation logic.\n\nFix onLinkEstablishmentTimeout(), not calling link.free()\nthere anymore (has caused session to get into invalid state).\nExceptions now get caught in disconnect/detach/close handlers\nused in HonoConnectionImpl. A disconnect during link creation\nnow causes the creation attempt to be failed directly,\nwithout waiting for the link establishment timeout.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>", "committedDate": "2020-01-31T12:47:44Z", "type": "forcePushed"}]}