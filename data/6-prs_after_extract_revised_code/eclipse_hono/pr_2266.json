{"pr_number": 2266, "pr_title": "[#2115] Fix wrong exception if tenant not found in PreCredentialsValidationHandler", "pr_createdAt": "2020-10-26T16:10:29Z", "pr_url": "https://github.com/eclipse/hono/pull/2266", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ3MzI2Nw==", "url": "https://github.com/eclipse/hono/pull/2266#discussion_r512473267", "bodyText": "WHEN a device of a non-existing tenant tries to connect", "author": "sophokles73", "createdAt": "2020-10-27T07:46:03Z", "path": "tests/src/test/java/org/eclipse/hono/tests/amqp/AmqpConnectionIT.java", "diffHunk": "@@ -175,11 +176,37 @@ public void testConnectFailsForWrongCredentials(final VertxTestContext ctx) {\n         .compose(ok -> connectToAdapter(IntegrationTestSupport.getUsername(deviceId, tenantId), \"wrong password\"))\n         .onComplete(ctx.failing(t -> {\n             // THEN the connection is refused\n-            ctx.verify(() -> assertThat(t).isInstanceOf(SaslException.class));\n+            ctx.verify(() -> assertThat(t).isInstanceOf(AuthenticationException.class));\n             ctx.completeNow();\n         }));\n     }\n \n+    /**\n+     * Verifies that the adapter rejects connection attempts from devices\n+     * using credentials that contain a non-existing tenant.\n+     *\n+     * @param ctx The test context\n+     */\n+    @Test\n+    public void testConnectFailsForNonExistingTenant(final VertxTestContext ctx) {\n+\n+        // GIVEN a registered device\n+        final String tenantId = helper.getRandomTenantId();\n+        final String deviceId = helper.getRandomDeviceId(tenantId);\n+        final String password = \"secret\";\n+        final Tenant tenant = new Tenant();\n+\n+        helper.registry\n+                .addDeviceForTenant(tenantId, tenant, deviceId, password)\n+                // WHEN the device tries to connect using a wrong password", "originalCommit": "108252aca7915b083550ae0589a66fcd469fbe96", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "94a48996a4d24834e83b12bbfc8f98b21dcf1350", "chunk": "diff --git a/tests/src/test/java/org/eclipse/hono/tests/amqp/AmqpConnectionIT.java b/tests/src/test/java/org/eclipse/hono/tests/amqp/AmqpConnectionIT.java\nindex b94f0064f..5ddc785b2 100644\n--- a/tests/src/test/java/org/eclipse/hono/tests/amqp/AmqpConnectionIT.java\n+++ b/tests/src/test/java/org/eclipse/hono/tests/amqp/AmqpConnectionIT.java\n\n@@ -198,7 +198,7 @@ public class AmqpConnectionIT extends AmqpAdapterTestBase {\n \n         helper.registry\n                 .addDeviceForTenant(tenantId, tenant, deviceId, password)\n-                // WHEN the device tries to connect using a wrong password\n+                // WHEN a device of a non-existing tenant tries to connect\n                 .compose(ok -> connectToAdapter(IntegrationTestSupport.getUsername(deviceId, \"nonExistingTenant\"), password))\n                 .onComplete(ctx.failing(t -> {\n                     // THEN the connection is refused\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ3Mzc5Ng==", "url": "https://github.com/eclipse/hono/pull/2266#discussion_r512473796", "bodyText": "see above", "author": "sophokles73", "createdAt": "2020-10-27T07:47:05Z", "path": "tests/src/test/java/org/eclipse/hono/tests/mqtt/MqttConnectionIT.java", "diffHunk": "@@ -223,6 +223,32 @@ public void testConnectFailsForWrongCredentials(final VertxTestContext ctx) {\n         }));\n     }\n \n+    /**\n+     * Verifies that the adapter rejects connection attempts from devices\n+     * using credentials that contain a non-existing tenant.\n+     *\n+     * @param ctx The test context\n+     */\n+    @Test\n+    public void testConnectFailsForNonExistingTenant(final VertxTestContext ctx) {\n+\n+        // GIVEN a registered device\n+        final Tenant tenant = new Tenant();\n+\n+        helper.registry\n+                .addDeviceForTenant(tenantId, tenant, deviceId, password)\n+                // WHEN the device tries to connect using a wrong password", "originalCommit": "108252aca7915b083550ae0589a66fcd469fbe96", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "94a48996a4d24834e83b12bbfc8f98b21dcf1350", "chunk": "diff --git a/tests/src/test/java/org/eclipse/hono/tests/mqtt/MqttConnectionIT.java b/tests/src/test/java/org/eclipse/hono/tests/mqtt/MqttConnectionIT.java\nindex 27e09ea3a..524cf9b1e 100644\n--- a/tests/src/test/java/org/eclipse/hono/tests/mqtt/MqttConnectionIT.java\n+++ b/tests/src/test/java/org/eclipse/hono/tests/mqtt/MqttConnectionIT.java\n\n@@ -237,7 +237,7 @@ public class MqttConnectionIT extends MqttTestBase {\n \n         helper.registry\n                 .addDeviceForTenant(tenantId, tenant, deviceId, password)\n-                // WHEN the device tries to connect using a wrong password\n+                // WHEN a device of a non-existing tenant tries to connect\n                 .compose(ok -> connectToAdapter(IntegrationTestSupport.getUsername(deviceId, \"nonExistingTenant\"), \"secret\"))\n                 .onComplete(ctx.failing(t -> {\n                     // THEN the connection is refused\n"}}, {"oid": "94a48996a4d24834e83b12bbfc8f98b21dcf1350", "url": "https://github.com/eclipse/hono/commit/94a48996a4d24834e83b12bbfc8f98b21dcf1350", "message": "[#2115] Fix wrong exception if tenant not found.\n\nA 404 error when fetching the tenant in the\nPreCredentialsValidationHandler should be interpreted\nas a \"bad credentials\" error.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>", "committedDate": "2020-10-27T07:53:54Z", "type": "commit"}, {"oid": "94a48996a4d24834e83b12bbfc8f98b21dcf1350", "url": "https://github.com/eclipse/hono/commit/94a48996a4d24834e83b12bbfc8f98b21dcf1350", "message": "[#2115] Fix wrong exception if tenant not found.\n\nA 404 error when fetching the tenant in the\nPreCredentialsValidationHandler should be interpreted\nas a \"bad credentials\" error.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>", "committedDate": "2020-10-27T07:53:54Z", "type": "forcePushed"}]}