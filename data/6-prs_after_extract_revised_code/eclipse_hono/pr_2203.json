{"pr_number": 2203, "pr_title": "[#2115] Use PreCredentialsValidationHandler in AMQP adapter", "pr_createdAt": "2020-09-23T14:45:02Z", "pr_url": "https://github.com/eclipse/hono/pull/2203", "timeline": [{"oid": "ff505f99e91a1c939d2f29da00a361d7e557a3c8", "url": "https://github.com/eclipse/hono/commit/ff505f99e91a1c939d2f29da00a361d7e557a3c8", "message": "[#2115] Use PreCredentialsValidationHandler in AMQP adapter.\n\nSetting the trace-sampling-priority according to the tenant\nconfiguration when processing a telemetry/event message in\nthe AMQP adapter is now done via the new\nPreCredentialsValidationHandler. This removes duplicate\ncode related to extracting the tenant information from\nthe authentication data.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>", "committedDate": "2020-09-23T14:42:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDEyOTkzMQ==", "url": "https://github.com/eclipse/hono/pull/2203#discussion_r494129931", "bodyText": "FMPOV we should not rely on the internal structure of the SaslResponseContext here but instead simply invoke something like SaslResponseContext.setTraceSamplingPriority(TenantObject) to improve encapsulation ...", "author": "sophokles73", "createdAt": "2020-09-24T08:24:10Z", "path": "adapters/amqp-vertx/src/main/java/org/eclipse/hono/adapter/amqp/impl/VertxBasedAmqpProtocolAdapter.java", "diffHunk": "@@ -197,6 +196,37 @@ protected void doStart(final Promise<Void> startPromise) {\n         .onComplete(startPromise);\n     }\n \n+    /**\n+     * Handles any operations that should be invoked as part of the authentication process after the credentials got\n+     * determined and before they get validated. Can be used to perform checks using the credentials and tenant\n+     * information before the potentially expensive credentials validation is done\n+     * <p>\n+     * The default implementation updates the trace sampling priority in the execution context tracing span.\n+     * <p>\n+     * Subclasses should override this method in order to perform additional operations after calling this super method.\n+     *\n+     * @param credentials The credentials.\n+     * @param executionContext The execution context, including the TenantObject.\n+     * @return A future indicating the outcome of the operation. A failed future will fail the authentication attempt.\n+     */\n+    protected Future<Void> handleBeforeCredentialsValidation(final DeviceCredentials credentials,\n+            final SaslResponseContext executionContext) {\n+\n+        final String tenantId = credentials.getTenantId();\n+        final Span span = executionContext.getTracingSpan();\n+        final String authId = credentials.getAuthId();\n+\n+        return getTenantConfiguration(tenantId, span.context())\n+                .compose(tenantObject -> {\n+                    TracingHelper.setDeviceTags(span, tenantId, null, authId);\n+                    final OptionalInt traceSamplingPriority = TenantTraceSamplingHelper.applyTraceSamplingPriority(\n+                            tenantObject, authId, span);\n+                    executionContext.getProtonConnection().attachments().set(", "originalCommit": "ff505f99e91a1c939d2f29da00a361d7e557a3c8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDMyODcxOA==", "url": "https://github.com/eclipse/hono/pull/2203#discussion_r494328718", "bodyText": "Yes, however it's not so straightforward at the moment because the places where you would want to call getTraceSamplingPriority don't have the SaslResponseContext object available.\nI wanted to replace the various different objects being put into the connection attachments with one single \"ConnectionContext\" object anyway. I would rather do this in a follow-up PR then though.", "author": "calohmn", "createdAt": "2020-09-24T13:44:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDEyOTkzMQ=="}], "type": "inlineReview", "revised_code": null}]}