{"pr_number": 1920, "pr_title": "[#1848] Fix limit verification outcomes in AMQP adapter.", "pr_createdAt": "2020-04-23T12:03:47Z", "pr_url": "https://github.com/eclipse/hono/pull/1920", "timeline": [{"oid": "eebfcc4e4dc7dbe4f35dc456f11e2c4c4ef5057d", "url": "https://github.com/eclipse/hono/commit/eebfcc4e4dc7dbe4f35dc456f11e2c4c4ef5057d", "message": "[#1848] Fix limit verification outcomes in AMQP adapter.\n\nSigned-off-by: Kartheeswaran Kalidass <kartheeswaran.kalidass@bosch.io>", "committedDate": "2020-04-23T13:20:33Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTYwMjk0OA==", "url": "https://github.com/eclipse/hono/pull/1920#discussion_r415602948", "bodyText": "what about\n// we still need to verify that\n// the adapter is enabled for the tenant,\n// the device/gateway exists and is enabled and\n// that the connection limit for the tenant and the adapter are not exceeded.", "author": "sophokles73", "createdAt": "2020-04-27T08:11:34Z", "path": "adapters/amqp-vertx/src/main/java/org/eclipse/hono/adapter/amqp/impl/VertxBasedAmqpProtocolAdapter.java", "diffHunk": "@@ -357,18 +357,26 @@ private void processRemoteOpen(final ProtonConnection con) {\n         if (getConfig().isAuthenticationRequired()) {\n \n             if (authenticatedDevice == null) {\n-                connectAuthorizationCheck.fail(new ClientErrorException(HttpURLConnection.HTTP_UNAUTHORIZED, \"anonymous devices not supported\"));\n+                connectAuthorizationCheck.fail(new ClientErrorException(HttpURLConnection.HTTP_UNAUTHORIZED,\n+                        \"anonymous devices not supported\"));\n             } else {\n                 log.trace(\"received connection request from {}\", authenticatedDevice);\n                 // the SASL handshake will already have authenticated the device\n-                // and will have verified that the adapter is enabled for the tenant\n-                // we still need to check if the device/gateway exists and is enabled\n-                checkDeviceRegistration(authenticatedDevice, span.context())\n-                .map(ok -> {\n-                    log.debug(\"{} is registered and enabled\", authenticatedDevice);\n-                    span.log(\"device is registered and enabled\");\n-                    return ok;\n-                }).setHandler(connectAuthorizationCheck);\n+                // and verify if the adapter is enabled for the tenant", "originalCommit": "eebfcc4e4dc7dbe4f35dc456f11e2c4c4ef5057d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjU0MTEyNQ==", "url": "https://github.com/eclipse/hono/pull/1920#discussion_r416541125", "bodyText": "Done.", "author": "kaniyan", "createdAt": "2020-04-28T11:34:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTYwMjk0OA=="}], "type": "inlineReview", "revised_code": {"commit": "77802e253e7fa636210577406f714e5d570fccf2", "chunk": "diff --git a/adapters/amqp-vertx/src/main/java/org/eclipse/hono/adapter/amqp/impl/VertxBasedAmqpProtocolAdapter.java b/adapters/amqp-vertx/src/main/java/org/eclipse/hono/adapter/amqp/impl/VertxBasedAmqpProtocolAdapter.java\nindex 7389302a9..39723647f 100644\n--- a/adapters/amqp-vertx/src/main/java/org/eclipse/hono/adapter/amqp/impl/VertxBasedAmqpProtocolAdapter.java\n+++ b/adapters/amqp-vertx/src/main/java/org/eclipse/hono/adapter/amqp/impl/VertxBasedAmqpProtocolAdapter.java\n\n@@ -362,9 +363,10 @@ public final class VertxBasedAmqpProtocolAdapter extends AbstractProtocolAdapter\n             } else {\n                 log.trace(\"received connection request from {}\", authenticatedDevice);\n                 // the SASL handshake will already have authenticated the device\n-                // and verify if the adapter is enabled for the tenant\n-                // and verify if the device/gateway exists and is enabled\n-                // and verify if the connection limit for the tenant and the adapter are not exceeded.\n+                // we still need to verify that\n+                // the adapter is enabled for the tenant,\n+                // the device/gateway exists and is enabled and\n+                // that the connection limit for the tenant and the adapter are not exceeded.\n \n                 CompositeFuture.all(checkDeviceRegistration(authenticatedDevice, span.context()),\n                         getTenantConfiguration(authenticatedDevice.getTenantId(), span.context())\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTYwNjY1Ng==", "url": "https://github.com/eclipse/hono/pull/1920#discussion_r415606656", "bodyText": "can you please refactor the tests to use assertj instead?", "author": "sophokles73", "createdAt": "2020-04-27T08:17:01Z", "path": "adapters/amqp-vertx/src/test/java/org/eclipse/hono/adapter/amqp/impl/VertxBasedAmqpProtocolAdapterTest.java", "diffHunk": "@@ -13,6 +13,7 @@\n package org.eclipse.hono.adapter.amqp.impl;\n \n import static org.assertj.core.api.Assertions.assertThat;\n+import static org.junit.jupiter.api.Assertions.assertEquals;", "originalCommit": "eebfcc4e4dc7dbe4f35dc456f11e2c4c4ef5057d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQ4Mzk3Mg==", "url": "https://github.com/eclipse/hono/pull/1920#discussion_r416483972", "bodyText": "assertThat(errorConditionCaptor.getValue().getCondition().toString())\n                .isEqualTo(AmqpError.UNAUTHORIZED_ACCESS.toString());\n\n assertEquals(AmqpError.UNAUTHORIZED_ACCESS, \n                errorConditionCaptor.getValue().getCondition());\n\nIMHO in the above context, asserEquals(...) suited better as there is no need to explicitly convert to string and then compare it as in the case of asserThat(...) as it doesn't allow Symbol  as an argument. Also we widely use assertEquals(...) in other tests too and hence I used it here. I could also refactor it to use assertThat(...). WDYT?", "author": "kaniyan", "createdAt": "2020-04-28T09:54:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTYwNjY1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjU2MDgxMQ==", "url": "https://github.com/eclipse/hono/pull/1920#discussion_r416560811", "bodyText": "I see. Let's keep it like this, then ...", "author": "sophokles73", "createdAt": "2020-04-28T12:10:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTYwNjY1Ng=="}], "type": "inlineReview", "revised_code": null}, {"oid": "77802e253e7fa636210577406f714e5d570fccf2", "url": "https://github.com/eclipse/hono/commit/77802e253e7fa636210577406f714e5d570fccf2", "message": "[#1848] Fix limit verification outcomes in AMQP adapter.\n\nSigned-off-by: Kartheeswaran Kalidass <kartheeswaran.kalidass@bosch.io>", "committedDate": "2020-04-28T09:16:22Z", "type": "commit"}, {"oid": "97eb6b62aef18bc10a30eaafd0027ba4a4edd3fb", "url": "https://github.com/eclipse/hono/commit/97eb6b62aef18bc10a30eaafd0027ba4a4edd3fb", "message": "[#1848] Update user guide and release notes.\n\nSigned-off-by: Kartheeswaran Kalidass <kartheeswaran.kalidass@bosch.io>", "committedDate": "2020-04-28T11:31:32Z", "type": "commit"}, {"oid": "97eb6b62aef18bc10a30eaafd0027ba4a4edd3fb", "url": "https://github.com/eclipse/hono/commit/97eb6b62aef18bc10a30eaafd0027ba4a4edd3fb", "message": "[#1848] Update user guide and release notes.\n\nSigned-off-by: Kartheeswaran Kalidass <kartheeswaran.kalidass@bosch.io>", "committedDate": "2020-04-28T11:31:32Z", "type": "forcePushed"}]}