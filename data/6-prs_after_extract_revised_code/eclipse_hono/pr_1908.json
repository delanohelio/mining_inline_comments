{"pr_number": 1908, "pr_title": "[#1858] Add lifespan to setCommandHandlingAdapterInstance", "pr_createdAt": "2020-04-16T10:21:38Z", "pr_url": "https://github.com/eclipse/hono/pull/1908", "timeline": [{"oid": "d9ffbe4f2387f2c9f8ea348d64d3e6f5ba9dec6e", "url": "https://github.com/eclipse/hono/commit/d9ffbe4f2387f2c9f8ea348d64d3e6f5ba9dec6e", "message": "[#1858] Add lifespan to setCommandHandlingAdapterInstance.\n\nThis makes it possible to restrict the lifespan of\nentries set via the setCommandHandlingAdapterInstance\nmethod of the Device Connection API.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>", "committedDate": "2020-04-16T14:48:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTcxNjA5NA==", "url": "https://github.com/eclipse/hono/pull/1908#discussion_r409716094", "bodyText": "it might be easier to use a Caffeine Cache instead which already supports limiting size and defining a time-based eviction strategy ...", "author": "sophokles73", "createdAt": "2020-04-16T17:09:35Z", "path": "services/device-registry-base/src/main/java/org/eclipse/hono/deviceregistry/service/deviceconnection/MapBasedDeviceConnectionService.java", "diffHunk": "@@ -43,15 +47,15 @@\n  */\n @Repository\n @Qualifier(\"backend\")\n-public final class MapBasedDeviceConnectionService implements DeviceConnectionService {\n+public class MapBasedDeviceConnectionService implements DeviceConnectionService {\n \n     private static final Logger log = LoggerFactory.getLogger(MapBasedDeviceConnectionService.class);\n \n     // <tenantId, <deviceId, lastKnownGatewayJson>>\n     private final Map<String, Map<String, JsonObject>> lastKnownGatewaysMap = new HashMap<>();\n \n     // <tenantId, <deviceId, adapterInstanceIdJson>>\n-    private final Map<String, Map<String, JsonObject>> commandHandlingAdapterInstancesMap = new HashMap<>();\n+    private final Map<String, Map<String, ExpiringValue<JsonObject>>> commandHandlingAdapterInstancesMap = new HashMap<>();", "originalCommit": "d9ffbe4f2387f2c9f8ea348d64d3e6f5ba9dec6e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDExNzIwMw==", "url": "https://github.com/eclipse/hono/pull/1908#discussion_r410117203", "bodyText": "I've committed a change so that a Caffeine Cache is now used, letting it do the eviction.\nI've haven't used the size limited feature though (maximumSize on cache builder) because that would change the behaviour. When the max size is (about to get) reached on a Caffeine Cache, some existing entry gets evicted. What we want here is to keep the existing entries and prevent addition of new entries if the max size has been reached.", "author": "calohmn", "createdAt": "2020-04-17T09:51:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTcxNjA5NA=="}], "type": "inlineReview", "revised_code": {"commit": "796c5438d119b2a66bc8535fb03fc461fe3ed492", "chunk": "diff --git a/services/device-registry-base/src/main/java/org/eclipse/hono/deviceregistry/service/deviceconnection/MapBasedDeviceConnectionService.java b/services/device-registry-base/src/main/java/org/eclipse/hono/deviceregistry/service/deviceconnection/MapBasedDeviceConnectionService.java\nindex 47e58e74b..05ea8dedb 100644\n--- a/services/device-registry-base/src/main/java/org/eclipse/hono/deviceregistry/service/deviceconnection/MapBasedDeviceConnectionService.java\n+++ b/services/device-registry-base/src/main/java/org/eclipse/hono/deviceregistry/service/deviceconnection/MapBasedDeviceConnectionService.java\n\n@@ -52,10 +53,10 @@ public class MapBasedDeviceConnectionService implements DeviceConnectionService\n     private static final Logger log = LoggerFactory.getLogger(MapBasedDeviceConnectionService.class);\n \n     // <tenantId, <deviceId, lastKnownGatewayJson>>\n-    private final Map<String, Map<String, JsonObject>> lastKnownGatewaysMap = new HashMap<>();\n+    private final Map<String, ConcurrentMap<String, JsonObject>> lastKnownGatewaysMap = new HashMap<>();\n \n     // <tenantId, <deviceId, adapterInstanceIdJson>>\n-    private final Map<String, Map<String, ExpiringValue<JsonObject>>> commandHandlingAdapterInstancesMap = new HashMap<>();\n+    private final Map<String, ConcurrentMap<String, ExpiringValue<JsonObject>>> commandHandlingAdapterInstancesMap = new HashMap<>();\n \n     private MapBasedDeviceConnectionsConfigProperties config;\n \n"}}, {"oid": "796c5438d119b2a66bc8535fb03fc461fe3ed492", "url": "https://github.com/eclipse/hono/commit/796c5438d119b2a66bc8535fb03fc461fe3ed492", "message": "[#1858] Add lifespan to setCommandHandlingAdapterInstance.\n\nThis makes it possible to restrict the lifespan of\nentries set via the setCommandHandlingAdapterInstance\nmethod of the Device Connection API.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>", "committedDate": "2020-04-17T09:32:45Z", "type": "forcePushed"}, {"oid": "c2a9039f45eebc473d8b137a7931d7c258945117", "url": "https://github.com/eclipse/hono/commit/c2a9039f45eebc473d8b137a7931d7c258945117", "message": "[#1858] Add lifespan to setCommandHandlingAdapterInstance.\n\nThis makes it possible to restrict the lifespan of\nentries set via the setCommandHandlingAdapterInstance\nmethod of the Device Connection API.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>", "committedDate": "2020-04-21T10:52:49Z", "type": "commit"}, {"oid": "c2a9039f45eebc473d8b137a7931d7c258945117", "url": "https://github.com/eclipse/hono/commit/c2a9039f45eebc473d8b137a7931d7c258945117", "message": "[#1858] Add lifespan to setCommandHandlingAdapterInstance.\n\nThis makes it possible to restrict the lifespan of\nentries set via the setCommandHandlingAdapterInstance\nmethod of the Device Connection API.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>", "committedDate": "2020-04-21T10:52:49Z", "type": "forcePushed"}]}