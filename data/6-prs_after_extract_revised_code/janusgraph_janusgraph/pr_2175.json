{"pr_number": 2175, "pr_title": "Add mixed index support for has(key) query", "pr_createdAt": "2020-07-25T05:49:03Z", "pr_url": "https://github.com/JanusGraph/janusgraph/pull/2175", "timeline": [{"oid": "7b25885c5b969b980d5898ee43d52d4d50660403", "url": "https://github.com/JanusGraph/janusgraph/commit/7b25885c5b969b980d5898ee43d52d4d50660403", "message": "Add mixed index support for has(key) query\n\nCurrently, has(key) query does not use index at all. This commit\ntries to use mixed index if possible. Composite index support,\nhowever, is not possible due to the data modeling design of composite\nindex.\n\nRelated to #284\n\nSigned-off-by: Boxuan Li <liboxuan@connect.hku.hk>", "committedDate": "2020-07-25T10:58:09Z", "type": "forcePushed"}, {"oid": "8daaed39d245d3e0bf3ffc48aac2b16756e73888", "url": "https://github.com/JanusGraph/janusgraph/commit/8daaed39d245d3e0bf3ffc48aac2b16756e73888", "message": "Add mixed index support for has(key) query\n\nCurrently, has(key) query does not use index at all. This commit\ntries to use mixed index if possible. Composite index support,\nhowever, is not possible due to the data modeling design of composite\nindex.\n\nRelated to #284\n\nSigned-off-by: Boxuan Li <liboxuan@connect.hku.hk>", "committedDate": "2020-07-25T12:45:20Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDQ4MTQwNA==", "url": "https://github.com/JanusGraph/janusgraph/pull/2175#discussion_r460481404", "bodyText": "This uncovers an existing issue (#2176), which causes CI to fail. If we drop this part, OR fix #2176, OR comment out the flaky assertion, the CI should pass.", "author": "li-boxuan", "createdAt": "2020-07-26T05:36:39Z", "path": "janusgraph-core/src/main/java/org/janusgraph/graphdb/query/index/AbstractIndexSelectionStrategy.java", "diffHunk": "@@ -215,7 +216,12 @@ private boolean coversAll(final MixedIndexType index, Condition<JanusGraphElemen\n             .filter(field -> field.getStatus() == SchemaStatus.ENABLED)\n             .filter(field -> field.getFieldKey().equals(key))\n             .findAny().orElse(null);\n-        return match != null && indexInfo.supports(index, match, atom.getPredicate());\n+        if (match == null) {\n+            return false;\n+        }\n+        // Although Full-text search does not support NOT_EQUAL query, NOT_EQUAL(null) is an exception since it matches all\n+        boolean isAllMatch = atom.getPredicate() == Cmp.NOT_EQUAL && atom.getValue() == null;\n+        return isAllMatch || indexInfo.supports(index, match, atom.getPredicate());", "originalCommit": "8daaed39d245d3e0bf3ffc48aac2b16756e73888", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDkzNDAyMg==", "url": "https://github.com/JanusGraph/janusgraph/pull/2175#discussion_r470934022", "bodyText": "This PR is based on PR #2182", "author": "li-boxuan", "createdAt": "2020-08-15T03:59:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDQ4MTQwNA=="}], "type": "inlineReview", "revised_code": {"commit": "907134b8a2c778197c434913a40a5704ca6b79f1", "chunk": "diff --git a/janusgraph-core/src/main/java/org/janusgraph/graphdb/query/index/AbstractIndexSelectionStrategy.java b/janusgraph-core/src/main/java/org/janusgraph/graphdb/query/index/AbstractIndexSelectionStrategy.java\nindex c5a68adc1..98142d73f 100644\n--- a/janusgraph-core/src/main/java/org/janusgraph/graphdb/query/index/AbstractIndexSelectionStrategy.java\n+++ b/janusgraph-core/src/main/java/org/janusgraph/graphdb/query/index/AbstractIndexSelectionStrategy.java\n\n@@ -219,9 +219,8 @@ public abstract class AbstractIndexSelectionStrategy implements IndexSelectionSt\n         if (match == null) {\n             return false;\n         }\n-        // Although Full-text search does not support NOT_EQUAL query, NOT_EQUAL(null) is an exception since it matches all\n-        boolean isAllMatch = atom.getPredicate() == Cmp.NOT_EQUAL && atom.getValue() == null;\n-        return isAllMatch || indexInfo.supports(index, match, atom.getPredicate());\n+        boolean existsQuery = atom.getValue() == null && atom.getPredicate() == Cmp.NOT_EQUAL && indexInfo.supportsExistsQuery(index, match);\n+        return existsQuery || indexInfo.supports(index, match, atom.getPredicate());\n     }\n \n     private Map.Entry<Condition,Collection<Object>> getEqualityConditionValues(\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDA5NDY5NQ==", "url": "https://github.com/JanusGraph/janusgraph/pull/2175#discussion_r464094695", "bodyText": "But document may not contain field with this key name", "author": "mad", "createdAt": "2020-08-02T16:03:21Z", "path": "janusgraph-lucene/src/main/java/org/janusgraph/diskstorage/lucene/LuceneIndex.java", "diffHunk": "@@ -702,7 +702,9 @@ private SearchParams convertQuery(Condition<?> condition, final KeyInformation.S\n             final String key = atom.getKey();\n             KeyInformation ki = information.get(key);\n             final JanusGraphPredicate janusgraphPredicate = atom.getPredicate();\n-            if (value instanceof Number) {\n+            if (value == null && janusgraphPredicate == Cmp.NOT_EQUAL) {\n+                params.addQuery(new MatchAllDocsQuery(), BooleanClause.Occur.MUST);", "originalCommit": "8daaed39d245d3e0bf3ffc48aac2b16756e73888", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc0NzUxNA==", "url": "https://github.com/JanusGraph/janusgraph/pull/2175#discussion_r464747514", "bodyText": "Thanks for the review. I am not sure If I got you, can you elaborate a bit / give an example? Are you talking about the case when a mixed index is built, but reindexing not yet done?", "author": "li-boxuan", "createdAt": "2020-08-04T01:32:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDA5NDY5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc1NzE1MQ==", "url": "https://github.com/JanusGraph/janusgraph/pull/2175#discussion_r467757151", "bodyText": "Suppose next vertex schema\nid\nname\nphone\n\nand query has('phone')\nSome vertices has phone field, some none. But lucene index build query with MatchAllDocsQuery and ignore specific filed phone. All vertices will be retrieved", "author": "mad", "createdAt": "2020-08-10T08:30:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDA5NDY5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc1OTA1Nw==", "url": "https://github.com/JanusGraph/janusgraph/pull/2175#discussion_r467759057", "bodyText": "thanks! I shouldn't have overlooked this scenario. I will look into it.", "author": "li-boxuan", "createdAt": "2020-08-10T08:34:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDA5NDY5NQ=="}], "type": "inlineReview", "revised_code": {"commit": "907134b8a2c778197c434913a40a5704ca6b79f1", "chunk": "diff --git a/janusgraph-lucene/src/main/java/org/janusgraph/diskstorage/lucene/LuceneIndex.java b/janusgraph-lucene/src/main/java/org/janusgraph/diskstorage/lucene/LuceneIndex.java\nindex 245ed6549..de08929e1 100644\n--- a/janusgraph-lucene/src/main/java/org/janusgraph/diskstorage/lucene/LuceneIndex.java\n+++ b/janusgraph-lucene/src/main/java/org/janusgraph/diskstorage/lucene/LuceneIndex.java\n\n@@ -703,7 +703,10 @@ public class LuceneIndex implements IndexProvider {\n             KeyInformation ki = information.get(key);\n             final JanusGraphPredicate janusgraphPredicate = atom.getPredicate();\n             if (value == null && janusgraphPredicate == Cmp.NOT_EQUAL) {\n-                params.addQuery(new MatchAllDocsQuery(), BooleanClause.Occur.MUST);\n+                // some fields like Integer omit norms but have docValues\n+                params.addQuery(new DocValuesFieldExistsQuery(key), BooleanClause.Occur.SHOULD);\n+                // some fields like Text have no docValue but have norms\n+                params.addQuery(new NormsFieldExistsQuery(key), BooleanClause.Occur.SHOULD);\n             } else if (value instanceof Number) {\n                 Preconditions.checkArgument(janusgraphPredicate instanceof Cmp, \"Relation not supported on numeric types: \" + janusgraphPredicate);\n                 params.addQuery(numericQuery(key, (Cmp) janusgraphPredicate, (Number) value));\n"}}, {"oid": "907134b8a2c778197c434913a40a5704ca6b79f1", "url": "https://github.com/JanusGraph/janusgraph/commit/907134b8a2c778197c434913a40a5704ca6b79f1", "message": "Add mixed index support for has(key) query\n\nCurrently, has(key) query does not use index at all. This commit\ntries to use mixed index if possible. Composite index support,\nhowever, is not possible due to the data modeling design of composite\nindex.\n\nRelated to #284\n\nSigned-off-by: Boxuan Li <liboxuan@connect.hku.hk>", "committedDate": "2020-08-13T14:47:50Z", "type": "forcePushed"}, {"oid": "de0921305c83ee3b3816f775f34da6814c06317a", "url": "https://github.com/JanusGraph/janusgraph/commit/de0921305c83ee3b3816f775f34da6814c06317a", "message": "Add mixed index support for has(key) query\n\nCurrently, has(key) query does not use index at all. This commit\ntries to use mixed index if possible. Composite index support,\nhowever, is not possible due to the data modeling design of composite\nindex.\n\nRelated to #284\n\nSigned-off-by: Boxuan Li <liboxuan@connect.hku.hk>", "committedDate": "2020-08-13T14:49:07Z", "type": "forcePushed"}, {"oid": "ed92164ff45ef52eeb27ece095e91c2cbda5ce6f", "url": "https://github.com/JanusGraph/janusgraph/commit/ed92164ff45ef52eeb27ece095e91c2cbda5ce6f", "message": "Add mixed index support for has(key) query\n\nCurrently, has(key) query does not use index at all. This commit\ntries to use mixed index if possible. Geoshape type exists query\nis not supported by Lucene and Solr index backends.\n\nRelated to #284\n\nSigned-off-by: Boxuan Li <liboxuan@connect.hku.hk>", "committedDate": "2020-08-14T17:14:10Z", "type": "forcePushed"}, {"oid": "8d0c33bc45d1d11b4254131af06151ddf73843ae", "url": "https://github.com/JanusGraph/janusgraph/commit/8d0c33bc45d1d11b4254131af06151ddf73843ae", "message": "Add mixed index support for has(key) query\n\nCurrently, has(key) query does not use index at all. This commit\ntries to use mixed index if possible. Geoshape type exists query\nis not supported by Lucene and Solr index backends.\n\nRelated to #284\n\nSigned-off-by: Boxuan Li <liboxuan@connect.hku.hk>", "committedDate": "2020-08-30T15:37:38Z", "type": "forcePushed"}, {"oid": "bf22a5fa5feb044a989125c7faf056b159dc10cb", "url": "https://github.com/JanusGraph/janusgraph/commit/bf22a5fa5feb044a989125c7faf056b159dc10cb", "message": "Add mixed index support for has(key) query\n\nCurrently, has(key) query does not use index at all. This commit\ntries to use mixed index if possible. Geoshape type exists query\nis not supported by Lucene and Solr index backends.\n\nRelated to #284\n\nSigned-off-by: Boxuan Li <liboxuan@connect.hku.hk>", "committedDate": "2020-09-01T14:40:04Z", "type": "forcePushed"}, {"oid": "d8042dc9822f81fb37e23cc0e2ee6c2c56329713", "url": "https://github.com/JanusGraph/janusgraph/commit/d8042dc9822f81fb37e23cc0e2ee6c2c56329713", "message": "Add mixed index support for has(key) query\n\nCurrently, has(key) query does not use index at all. This commit\ntries to use mixed index if possible. Geoshape type exists query\nis not supported by Lucene and Solr index backends.\n\nRelated to #284\n\nSigned-off-by: Boxuan Li <liboxuan@connect.hku.hk>", "committedDate": "2020-09-03T14:40:56Z", "type": "forcePushed"}, {"oid": "324b4f52ef1dc1da22d3a4dab96f4a3395a13410", "url": "https://github.com/JanusGraph/janusgraph/commit/324b4f52ef1dc1da22d3a4dab96f4a3395a13410", "message": "Add mixed index support for has(key) query\n\nCurrently, has(key) query does not use index at all. This commit\ntries to use mixed index if possible. Geoshape type exists query\nis not supported by Lucene and Solr index backends.\n\nRelated to #284\n\nSigned-off-by: Boxuan Li <liboxuan@connect.hku.hk>", "committedDate": "2020-09-06T13:48:17Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODU4MTk2NA==", "url": "https://github.com/JanusGraph/janusgraph/pull/2175#discussion_r488581964", "bodyText": "This should be checked in isHasFilterStep, too", "author": "rngcntr", "createdAt": "2020-09-15T11:11:12Z", "path": "janusgraph-core/src/main/java/org/janusgraph/graphdb/tinkerpop/optimize/HasStepFolder.java", "diffHunk": "@@ -212,6 +221,41 @@ static boolean validFoldInHasContainer(final Step<?, ?>  tinkerpopStep, final bo\n         return Boolean.TRUE.equals(toReturn);\n     }\n \n+    /**\n+     * Check if a given step is a has(key) step\n+     * Tinkerpop translates has(key) gremlin query into TraversalFilterStep(PropertiesStep)\n+     * @param step\n+     * @return true if given step is essentially a \"has(key)\" step\n+     */\n+    static boolean isHasFilterStep(final Step<?, ?> step) {\n+        if (step instanceof TraversalFilterStep) {\n+            List<Traversal.Admin> traversals = ((TraversalFilterStep) step).getLocalChildren();\n+            assert (traversals.size() == 1);\n+            List<Step> steps = traversals.get(0).getSteps();\n+            return steps.size() == 1 && steps.get(0) instanceof PropertiesStep;\n+        }\n+        return false;\n+    }\n+\n+    /**\n+     * Convert a TraversalFilterStep that is essentially \"has(key)\" into a normal HasStep\n+     * @param traversal local traversal\n+     * @param currentStep\n+     */\n+    static void foldInHasFilter(final Traversal.Admin<?, ?> traversal, final TraversalFilterStep<?> currentStep) {\n+        List<? extends Traversal.Admin<?, ?>> traversals = currentStep.getLocalChildren();\n+        assert(traversals.size() == 1);\n+        List<Step> steps = traversals.get(0).getSteps();\n+        assert(steps.size() == 1 && steps.get(0) instanceof  PropertiesStep);\n+        String[] propertyKeys = ((PropertiesStep) steps.get(0)).getPropertyKeys();\n+        assert(propertyKeys.length == 1);", "originalCommit": "324b4f52ef1dc1da22d3a4dab96f4a3395a13410", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "489195eb6e7407dac8ed674d904819ca5100ac6a", "chunk": "diff --git a/janusgraph-core/src/main/java/org/janusgraph/graphdb/tinkerpop/optimize/HasStepFolder.java b/janusgraph-core/src/main/java/org/janusgraph/graphdb/tinkerpop/optimize/HasStepFolder.java\nindex 51f878879..915f0cbbc 100644\n--- a/janusgraph-core/src/main/java/org/janusgraph/graphdb/tinkerpop/optimize/HasStepFolder.java\n+++ b/janusgraph-core/src/main/java/org/janusgraph/graphdb/tinkerpop/optimize/HasStepFolder.java\n\n@@ -222,17 +224,18 @@ public interface HasStepFolder<S, E> extends Step<S, E> {\n     }\n \n     /**\n-     * Check if a given step is a has(key) step\n+     * Check if a given step is an \"exists\" step, i.e. has(key) step\n      * Tinkerpop translates has(key) gremlin query into TraversalFilterStep(PropertiesStep)\n      * @param step\n-     * @return true if given step is essentially a \"has(key)\" step\n+     * @return true if given step is essentially an \"exists\" step\n      */\n-    static boolean isHasFilterStep(final Step<?, ?> step) {\n+    static boolean isExistsStep(final Step<?, ?> step) {\n         if (step instanceof TraversalFilterStep) {\n             List<Traversal.Admin> traversals = ((TraversalFilterStep) step).getLocalChildren();\n             assert (traversals.size() == 1);\n             List<Step> steps = traversals.get(0).getSteps();\n-            return steps.size() == 1 && steps.get(0) instanceof PropertiesStep;\n+            if (!(steps.size() == 1 && steps.get(0) instanceof PropertiesStep)) return false;\n+            return ((PropertiesStep) steps.get(0)).getPropertyKeys().length == 1;\n         }\n         return false;\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODU4MzgzMA==", "url": "https://github.com/JanusGraph/janusgraph/pull/2175#discussion_r488583830", "bodyText": "Why is the currentStep's successor set here, if that step is removed anyway?", "author": "rngcntr", "createdAt": "2020-09-15T11:14:53Z", "path": "janusgraph-core/src/main/java/org/janusgraph/graphdb/tinkerpop/optimize/HasStepFolder.java", "diffHunk": "@@ -212,6 +221,41 @@ static boolean validFoldInHasContainer(final Step<?, ?>  tinkerpopStep, final bo\n         return Boolean.TRUE.equals(toReturn);\n     }\n \n+    /**\n+     * Check if a given step is a has(key) step\n+     * Tinkerpop translates has(key) gremlin query into TraversalFilterStep(PropertiesStep)\n+     * @param step\n+     * @return true if given step is essentially a \"has(key)\" step\n+     */\n+    static boolean isHasFilterStep(final Step<?, ?> step) {\n+        if (step instanceof TraversalFilterStep) {\n+            List<Traversal.Admin> traversals = ((TraversalFilterStep) step).getLocalChildren();\n+            assert (traversals.size() == 1);\n+            List<Step> steps = traversals.get(0).getSteps();\n+            return steps.size() == 1 && steps.get(0) instanceof PropertiesStep;\n+        }\n+        return false;\n+    }\n+\n+    /**\n+     * Convert a TraversalFilterStep that is essentially \"has(key)\" into a normal HasStep\n+     * @param traversal local traversal\n+     * @param currentStep\n+     */\n+    static void foldInHasFilter(final Traversal.Admin<?, ?> traversal, final TraversalFilterStep<?> currentStep) {\n+        List<? extends Traversal.Admin<?, ?>> traversals = currentStep.getLocalChildren();\n+        assert(traversals.size() == 1);\n+        List<Step> steps = traversals.get(0).getSteps();\n+        assert(steps.size() == 1 && steps.get(0) instanceof  PropertiesStep);\n+        String[] propertyKeys = ((PropertiesStep) steps.get(0)).getPropertyKeys();\n+        assert(propertyKeys.length == 1);\n+        HasStep hasStep = new HasStep(traversal, new HasContainer(propertyKeys[0], P.neq(null)));\n+        currentStep.getLabels().forEach(hasStep::addLabel);\n+        traversal.addStep(TraversalHelper.stepIndex(currentStep, traversal), hasStep);\n+        currentStep.setNextStep(hasStep);", "originalCommit": "324b4f52ef1dc1da22d3a4dab96f4a3395a13410", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "489195eb6e7407dac8ed674d904819ca5100ac6a", "chunk": "diff --git a/janusgraph-core/src/main/java/org/janusgraph/graphdb/tinkerpop/optimize/HasStepFolder.java b/janusgraph-core/src/main/java/org/janusgraph/graphdb/tinkerpop/optimize/HasStepFolder.java\nindex 51f878879..915f0cbbc 100644\n--- a/janusgraph-core/src/main/java/org/janusgraph/graphdb/tinkerpop/optimize/HasStepFolder.java\n+++ b/janusgraph-core/src/main/java/org/janusgraph/graphdb/tinkerpop/optimize/HasStepFolder.java\n\n@@ -222,17 +224,18 @@ public interface HasStepFolder<S, E> extends Step<S, E> {\n     }\n \n     /**\n-     * Check if a given step is a has(key) step\n+     * Check if a given step is an \"exists\" step, i.e. has(key) step\n      * Tinkerpop translates has(key) gremlin query into TraversalFilterStep(PropertiesStep)\n      * @param step\n-     * @return true if given step is essentially a \"has(key)\" step\n+     * @return true if given step is essentially an \"exists\" step\n      */\n-    static boolean isHasFilterStep(final Step<?, ?> step) {\n+    static boolean isExistsStep(final Step<?, ?> step) {\n         if (step instanceof TraversalFilterStep) {\n             List<Traversal.Admin> traversals = ((TraversalFilterStep) step).getLocalChildren();\n             assert (traversals.size() == 1);\n             List<Step> steps = traversals.get(0).getSteps();\n-            return steps.size() == 1 && steps.get(0) instanceof PropertiesStep;\n+            if (!(steps.size() == 1 && steps.get(0) instanceof PropertiesStep)) return false;\n+            return ((PropertiesStep) steps.get(0)).getPropertyKeys().length == 1;\n         }\n         return false;\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODU4NDIzMw==", "url": "https://github.com/JanusGraph/janusgraph/pull/2175#discussion_r488584233", "bodyText": "You could use TraversalHelper.replaceStep(currentStep, hasStep, traversal)", "author": "rngcntr", "createdAt": "2020-09-15T11:15:39Z", "path": "janusgraph-core/src/main/java/org/janusgraph/graphdb/tinkerpop/optimize/HasStepFolder.java", "diffHunk": "@@ -212,6 +221,41 @@ static boolean validFoldInHasContainer(final Step<?, ?>  tinkerpopStep, final bo\n         return Boolean.TRUE.equals(toReturn);\n     }\n \n+    /**\n+     * Check if a given step is a has(key) step\n+     * Tinkerpop translates has(key) gremlin query into TraversalFilterStep(PropertiesStep)\n+     * @param step\n+     * @return true if given step is essentially a \"has(key)\" step\n+     */\n+    static boolean isHasFilterStep(final Step<?, ?> step) {\n+        if (step instanceof TraversalFilterStep) {\n+            List<Traversal.Admin> traversals = ((TraversalFilterStep) step).getLocalChildren();\n+            assert (traversals.size() == 1);\n+            List<Step> steps = traversals.get(0).getSteps();\n+            return steps.size() == 1 && steps.get(0) instanceof PropertiesStep;\n+        }\n+        return false;\n+    }\n+\n+    /**\n+     * Convert a TraversalFilterStep that is essentially \"has(key)\" into a normal HasStep\n+     * @param traversal local traversal\n+     * @param currentStep\n+     */\n+    static void foldInHasFilter(final Traversal.Admin<?, ?> traversal, final TraversalFilterStep<?> currentStep) {\n+        List<? extends Traversal.Admin<?, ?>> traversals = currentStep.getLocalChildren();\n+        assert(traversals.size() == 1);\n+        List<Step> steps = traversals.get(0).getSteps();\n+        assert(steps.size() == 1 && steps.get(0) instanceof  PropertiesStep);\n+        String[] propertyKeys = ((PropertiesStep) steps.get(0)).getPropertyKeys();\n+        assert(propertyKeys.length == 1);\n+        HasStep hasStep = new HasStep(traversal, new HasContainer(propertyKeys[0], P.neq(null)));\n+        currentStep.getLabels().forEach(hasStep::addLabel);\n+        traversal.addStep(TraversalHelper.stepIndex(currentStep, traversal), hasStep);", "originalCommit": "324b4f52ef1dc1da22d3a4dab96f4a3395a13410", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "489195eb6e7407dac8ed674d904819ca5100ac6a", "chunk": "diff --git a/janusgraph-core/src/main/java/org/janusgraph/graphdb/tinkerpop/optimize/HasStepFolder.java b/janusgraph-core/src/main/java/org/janusgraph/graphdb/tinkerpop/optimize/HasStepFolder.java\nindex 51f878879..915f0cbbc 100644\n--- a/janusgraph-core/src/main/java/org/janusgraph/graphdb/tinkerpop/optimize/HasStepFolder.java\n+++ b/janusgraph-core/src/main/java/org/janusgraph/graphdb/tinkerpop/optimize/HasStepFolder.java\n\n@@ -222,17 +224,18 @@ public interface HasStepFolder<S, E> extends Step<S, E> {\n     }\n \n     /**\n-     * Check if a given step is a has(key) step\n+     * Check if a given step is an \"exists\" step, i.e. has(key) step\n      * Tinkerpop translates has(key) gremlin query into TraversalFilterStep(PropertiesStep)\n      * @param step\n-     * @return true if given step is essentially a \"has(key)\" step\n+     * @return true if given step is essentially an \"exists\" step\n      */\n-    static boolean isHasFilterStep(final Step<?, ?> step) {\n+    static boolean isExistsStep(final Step<?, ?> step) {\n         if (step instanceof TraversalFilterStep) {\n             List<Traversal.Admin> traversals = ((TraversalFilterStep) step).getLocalChildren();\n             assert (traversals.size() == 1);\n             List<Step> steps = traversals.get(0).getSteps();\n-            return steps.size() == 1 && steps.get(0) instanceof PropertiesStep;\n+            if (!(steps.size() == 1 && steps.get(0) instanceof PropertiesStep)) return false;\n+            return ((PropertiesStep) steps.get(0)).getPropertyKeys().length == 1;\n         }\n         return false;\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODU5MDc2NQ==", "url": "https://github.com/JanusGraph/janusgraph/pull/2175#discussion_r488590765", "bodyText": "Nit: A nicer solution would be to split this test up into two separate methods and have one of them test Geoshape and one everything else but Geoshape. You can then @disable the Geoshape test in the Lucene and Solr implementations of JanusGraphIndexTest.\nThis way, the abstract test class stays free of backend related stuff. For examples, have a look at JanusGraphTest and it's implementing classes for different storage backends.", "author": "rngcntr", "createdAt": "2020-09-15T11:27:30Z", "path": "janusgraph-backend-testutils/src/main/java/org/janusgraph/graphdb/JanusGraphIndexTest.java", "diffHunk": "@@ -212,6 +214,111 @@ private static void assertStorageExists(Backend backend, boolean exists) throws\n         }\n     }\n \n+    /**\n+     * Test that has(key) query utilizes mixed index if possible\n+     * All data types supported by mixed index are tested\n+     */\n+    @Test\n+    public void testHasKeyQuery() {\n+        VertexLabel person = mgmt.makeVertexLabel(\"person\").make();\n+        PropertyKey name = mgmt.makePropertyKey(\"name\").dataType(String.class).make();\n+        PropertyKey nickname = mgmt.makePropertyKey(\"nickname\").dataType(String.class).make();\n+        PropertyKey age = mgmt.makePropertyKey(\"age\").dataType(Integer.class).make();\n+        PropertyKey houses = mgmt.makePropertyKey(\"houses\").dataType(Integer.class).make();\n+        PropertyKey sex = mgmt.makePropertyKey(\"sex\").dataType(String.class).make();\n+        PropertyKey single = mgmt.makePropertyKey(\"single\").dataType(Boolean.class).make();\n+        PropertyKey phone = mgmt.makePropertyKey(\"phone\").dataType(Long.class).make();\n+        PropertyKey flag = mgmt.makePropertyKey(\"flag\").dataType(Boolean.class).make();\n+        PropertyKey byteKey = mgmt.makePropertyKey(\"byte\").dataType(Byte.class).make();\n+        PropertyKey cars = mgmt.makePropertyKey(\"cars\").dataType(Short.class).make();\n+        PropertyKey deposit = mgmt.makePropertyKey(\"deposit\").dataType(Float.class).make();\n+        PropertyKey address = mgmt.makePropertyKey(\"address\").dataType(Geoshape.class).make();\n+        PropertyKey birthday = mgmt.makePropertyKey(\"birthday\").dataType(Date.class).make();\n+        PropertyKey instant = mgmt.makePropertyKey(\"instant\").dataType(Instant.class).make();\n+        PropertyKey uuid = mgmt.makePropertyKey(\"uuid\").dataType(UUID.class).make();\n+\n+        mgmt.buildIndex(\"age\", Vertex.class).addKey(age).buildCompositeIndex();\n+        mgmt.buildIndex(\"namev\", Vertex.class).addKey(name, Mapping.STRING.asParameter())\n+            .buildMixedIndex(INDEX);\n+        mgmt.buildIndex(\"nameidx\", Vertex.class).addKey(nickname, Mapping.TEXT.asParameter())\n+            .buildMixedIndex(INDEX);\n+        mgmt.buildIndex(\"mixed\", Vertex.class).addKey(sex, Mapping.TEXT.asParameter()).addKey(phone)\n+            .addKey(instant).addKey(single).buildMixedIndex(INDEX);\n+        mgmt.buildIndex(\"mi\", Vertex.class).addKey(houses).addKey(deposit).addKey(uuid).buildMixedIndex(INDEX);\n+        mgmt.buildIndex(\"theIndex\", Vertex.class).addKey(address).addKey(deposit).addKey(byteKey)\n+            .addKey(cars).addKey(birthday).buildMixedIndex(INDEX);\n+        finishSchema();\n+\n+        JanusGraphVertex v = tx.addVertex(T.label, \"person\", \"name\", \"\", \"age\", 30, \"sex\", \"male\", \"houses\", 0,\n+            \"cars\", 0, \"deposit\", 0.0, \"birthday\", new Date(), \"instant\", Instant.ofEpochMilli(1), \"uuid\", UUID.randomUUID());\n+        v.property(\"age\").property(\"flag\", true);\n+        tx.addVertex(T.label, \"person\", \"name\", \"robert\", \"nickname\", \"bob\", \"sex\", \"female\", \"phone\", 12345678L,\n+            \"deposit\", 100000.5, \"instant\", Instant.ofEpochMilli(100), \"uuid\", UUID.randomUUID(), \"single\", true);\n+        tx.addVertex(T.label, \"person\", \"nickname\", \"anonym is my name\", \"phone\", 23456789L,\n+            \"byte\", Byte.MIN_VALUE, \"uuid\", UUID.randomUUID());\n+        tx.addVertex(T.label, \"person\", \"houses\", 2, \"cars\", 1, \"address\", Geoshape.point(37.97, 23.72));\n+        tx.commit();\n+\n+        /* force index to be used */\n+        clopen(option(FORCE_INDEX_USAGE), true);\n+\n+        // test has(key) -> has(key, NOT_EQUAL, null) (exists query) transformation in JanusGraph GraphCentricQuery\n+        assertCount(2, tx.query().has(\"name\").vertices());\n+        assertCount(2, tx.query().has(\"nickname\").vertices());\n+        assertCount(2, tx.query().has(\"houses\").vertices());\n+        assertCount(2, tx.query().has(\"cars\").vertices());\n+        assertCount(1, tx.query().has(\"byte\").vertices());\n+        assertCount(2, tx.query().has(\"deposit\").vertices());\n+        assertCount(1, tx.query().has(\"birthday\").vertices());\n+        assertCount(2, tx.query().has(\"instant\").vertices());\n+        assertCount(3, tx.query().has(\"uuid\").vertices());\n+        assertCount(1, tx.query().has(\"single\").vertices());\n+\n+        // test has(key) -> has(key, neq(null)) transformation in Gremlin query\n+        assertEquals(2, graph.traversal().V().has(\"name\").count().next());\n+        assertEquals(2, graph.traversal().V().has(\"nickname\").count().next());\n+        assertEquals(2, graph.traversal().V().has(\"houses\").count().next());\n+        assertEquals(2, graph.traversal().V().has(\"cars\").count().next());\n+        assertEquals(1, graph.traversal().V().has(\"byte\").count().next());\n+        assertEquals(2, graph.traversal().V().has(\"deposit\").count().next());\n+        assertEquals(1, graph.traversal().V().has(\"birthday\").count().next());\n+        assertEquals(2, graph.traversal().V().has(\"instant\").count().next());\n+        assertEquals(3, graph.traversal().V().has(\"uuid\").count().next());\n+        assertEquals(1, graph.traversal().V().has(\"single\").count().next());\n+\n+        final String backend = readConfig.get(INDEX_BACKEND, INDEX);\n+        if (!backend.equals(\"lucene\") && !backend.equals(\"solr\")) {", "originalCommit": "324b4f52ef1dc1da22d3a4dab96f4a3395a13410", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "489195eb6e7407dac8ed674d904819ca5100ac6a", "chunk": "diff --git a/janusgraph-backend-testutils/src/main/java/org/janusgraph/graphdb/JanusGraphIndexTest.java b/janusgraph-backend-testutils/src/main/java/org/janusgraph/graphdb/JanusGraphIndexTest.java\nindex 08f43bbd1..fc68b84fd 100644\n--- a/janusgraph-backend-testutils/src/main/java/org/janusgraph/graphdb/JanusGraphIndexTest.java\n+++ b/janusgraph-backend-testutils/src/main/java/org/janusgraph/graphdb/JanusGraphIndexTest.java\n\n@@ -214,109 +216,118 @@ public abstract class JanusGraphIndexTest extends JanusGraphBaseTest {\n         }\n     }\n \n+    @Test\n+    public void testGeoshapeExistsQuery() {\n+        if (!supportsGeoPointExistsQuery()) return;\n+\n+        PropertyKey geoshape = mgmt.makePropertyKey(\"geoshape\").dataType(Geoshape.class).make();\n+        mgmt.buildIndex(\"theIndex\", Vertex.class).addKey(geoshape).buildMixedIndex(INDEX);\n+        finishSchema();\n+\n+        tx.addVertex(\"geoshape\", Geoshape.point(37.97, 23.72));\n+        tx.addVertex();\n+        tx.commit();\n+\n+        clopen(option(FORCE_INDEX_USAGE), true);\n+        assertEquals(1, graph.traversal().V().has(\"geoshape\").count().next());\n+    }\n+\n     /**\n-     * Test that has(key) query utilizes mixed index if possible\n-     * All data types supported by mixed index are tested\n+     * test exists query, i.e., has(key) query using all data types supported by mixed index, except\n+     * Geoshape which has a separate test case\n      */\n     @Test\n-    public void testHasKeyQuery() {\n-        VertexLabel person = mgmt.makeVertexLabel(\"person\").make();\n-        PropertyKey name = mgmt.makePropertyKey(\"name\").dataType(String.class).make();\n-        PropertyKey nickname = mgmt.makePropertyKey(\"nickname\").dataType(String.class).make();\n-        PropertyKey age = mgmt.makePropertyKey(\"age\").dataType(Integer.class).make();\n-        PropertyKey houses = mgmt.makePropertyKey(\"houses\").dataType(Integer.class).make();\n-        PropertyKey sex = mgmt.makePropertyKey(\"sex\").dataType(String.class).make();\n-        PropertyKey single = mgmt.makePropertyKey(\"single\").dataType(Boolean.class).make();\n-        PropertyKey phone = mgmt.makePropertyKey(\"phone\").dataType(Long.class).make();\n-        PropertyKey flag = mgmt.makePropertyKey(\"flag\").dataType(Boolean.class).make();\n+    public void testExistsQuery() {\n+        PropertyKey compositeInt = mgmt.makePropertyKey(\"compositeInt\").dataType(Integer.class).make();\n+        PropertyKey mixedInt = mgmt.makePropertyKey(\"mixedInt\").dataType(Integer.class).make();\n+        PropertyKey stringKey = mgmt.makePropertyKey(\"string\").dataType(String.class).make();\n+        PropertyKey textKey = mgmt.makePropertyKey(\"text\").dataType(String.class).make();\n+        PropertyKey boolKey = mgmt.makePropertyKey(\"bool\").dataType(Boolean.class).make();\n+        PropertyKey longKey = mgmt.makePropertyKey(\"long\").dataType(Long.class).make();\n         PropertyKey byteKey = mgmt.makePropertyKey(\"byte\").dataType(Byte.class).make();\n-        PropertyKey cars = mgmt.makePropertyKey(\"cars\").dataType(Short.class).make();\n-        PropertyKey deposit = mgmt.makePropertyKey(\"deposit\").dataType(Float.class).make();\n-        PropertyKey address = mgmt.makePropertyKey(\"address\").dataType(Geoshape.class).make();\n-        PropertyKey birthday = mgmt.makePropertyKey(\"birthday\").dataType(Date.class).make();\n+        PropertyKey shortKey = mgmt.makePropertyKey(\"short\").dataType(Short.class).make();\n+        PropertyKey floatKey = mgmt.makePropertyKey(\"float\").dataType(Float.class).make();\n+        PropertyKey dateKey = mgmt.makePropertyKey(\"date\").dataType(Date.class).make();\n         PropertyKey instant = mgmt.makePropertyKey(\"instant\").dataType(Instant.class).make();\n         PropertyKey uuid = mgmt.makePropertyKey(\"uuid\").dataType(UUID.class).make();\n \n-        mgmt.buildIndex(\"age\", Vertex.class).addKey(age).buildCompositeIndex();\n-        mgmt.buildIndex(\"namev\", Vertex.class).addKey(name, Mapping.STRING.asParameter())\n-            .buildMixedIndex(INDEX);\n-        mgmt.buildIndex(\"nameidx\", Vertex.class).addKey(nickname, Mapping.TEXT.asParameter())\n+        mgmt.buildIndex(\"int\", Vertex.class).addKey(compositeInt).buildCompositeIndex();\n+        mgmt.buildIndex(\"namev\", Vertex.class).addKey(stringKey, Mapping.STRING.asParameter())\n             .buildMixedIndex(INDEX);\n-        mgmt.buildIndex(\"mixed\", Vertex.class).addKey(sex, Mapping.TEXT.asParameter()).addKey(phone)\n-            .addKey(instant).addKey(single).buildMixedIndex(INDEX);\n-        mgmt.buildIndex(\"mi\", Vertex.class).addKey(houses).addKey(deposit).addKey(uuid).buildMixedIndex(INDEX);\n-        mgmt.buildIndex(\"theIndex\", Vertex.class).addKey(address).addKey(deposit).addKey(byteKey)\n-            .addKey(cars).addKey(birthday).buildMixedIndex(INDEX);\n+        mgmt.buildIndex(\"mixed\", Vertex.class).addKey(textKey, Mapping.TEXT.asParameter()).addKey(longKey)\n+            .addKey(instant).addKey(boolKey).buildMixedIndex(INDEX);\n+        mgmt.buildIndex(\"mi\", Vertex.class).addKey(mixedInt).addKey(floatKey).addKey(uuid).buildMixedIndex(INDEX);\n+        mgmt.buildIndex(\"theIndex\", Vertex.class).addKey(floatKey).addKey(byteKey)\n+            .addKey(shortKey).addKey(dateKey).buildMixedIndex(INDEX);\n         finishSchema();\n \n-        JanusGraphVertex v = tx.addVertex(T.label, \"person\", \"name\", \"\", \"age\", 30, \"sex\", \"male\", \"houses\", 0,\n-            \"cars\", 0, \"deposit\", 0.0, \"birthday\", new Date(), \"instant\", Instant.ofEpochMilli(1), \"uuid\", UUID.randomUUID());\n-        v.property(\"age\").property(\"flag\", true);\n-        tx.addVertex(T.label, \"person\", \"name\", \"robert\", \"nickname\", \"bob\", \"sex\", \"female\", \"phone\", 12345678L,\n-            \"deposit\", 100000.5, \"instant\", Instant.ofEpochMilli(100), \"uuid\", UUID.randomUUID(), \"single\", true);\n-        tx.addVertex(T.label, \"person\", \"nickname\", \"anonym is my name\", \"phone\", 23456789L,\n+        JanusGraphVertex v = tx.addVertex(\"string\", \"\", \"compositeInt\", 30, \"text\", \"male\", \"mixedInt\", 0,\n+            \"short\", 0, \"float\", 0.0, \"date\", new Date(), \"instant\", Instant.ofEpochMilli(1), \"uuid\", UUID.randomUUID());\n+        v.property(\"compositeInt\").property(\"bool2\", true);\n+        tx.addVertex(\"string\", \"robert\", \"text\", \"female\", \"long\", 12345678L,\n+            \"float\", 100000.5, \"instant\", Instant.ofEpochMilli(100), \"uuid\", UUID.randomUUID(), \"bool\", true);\n+        tx.addVertex(\"text\", \"prefer not to say\", \"long\", 23456789L,\n             \"byte\", Byte.MIN_VALUE, \"uuid\", UUID.randomUUID());\n-        tx.addVertex(T.label, \"person\", \"houses\", 2, \"cars\", 1, \"address\", Geoshape.point(37.97, 23.72));\n+        tx.addVertex(T.label, \"person\", \"mixedInt\", 2, \"short\", 1);\n         tx.commit();\n \n         /* force index to be used */\n         clopen(option(FORCE_INDEX_USAGE), true);\n \n         // test has(key) -> has(key, NOT_EQUAL, null) (exists query) transformation in JanusGraph GraphCentricQuery\n-        assertCount(2, tx.query().has(\"name\").vertices());\n-        assertCount(2, tx.query().has(\"nickname\").vertices());\n-        assertCount(2, tx.query().has(\"houses\").vertices());\n-        assertCount(2, tx.query().has(\"cars\").vertices());\n+        assertCount(2, tx.query().has(\"string\").vertices());\n+        assertCount(3, tx.query().has(\"text\").vertices());\n+        assertCount(2, tx.query().has(\"mixedInt\").vertices());\n+        assertCount(2, tx.query().has(\"short\").vertices());\n         assertCount(1, tx.query().has(\"byte\").vertices());\n-        assertCount(2, tx.query().has(\"deposit\").vertices());\n-        assertCount(1, tx.query().has(\"birthday\").vertices());\n+        assertCount(2, tx.query().has(\"float\").vertices());\n+        assertCount(1, tx.query().has(\"date\").vertices());\n         assertCount(2, tx.query().has(\"instant\").vertices());\n         assertCount(3, tx.query().has(\"uuid\").vertices());\n-        assertCount(1, tx.query().has(\"single\").vertices());\n+        assertCount(1, tx.query().has(\"bool\").vertices());\n \n         // test has(key) -> has(key, neq(null)) transformation in Gremlin query\n-        assertEquals(2, graph.traversal().V().has(\"name\").count().next());\n-        assertEquals(2, graph.traversal().V().has(\"nickname\").count().next());\n-        assertEquals(2, graph.traversal().V().has(\"houses\").count().next());\n-        assertEquals(2, graph.traversal().V().has(\"cars\").count().next());\n+        assertEquals(2, graph.traversal().V().has(\"string\").as(\"v\").select(\"v\").count().next());\n+        assertEquals(3, graph.traversal().V().has(\"text\").count().next());\n+        assertEquals(2, graph.traversal().V().has(\"mixedInt\").count().next());\n+        assertEquals(2, graph.traversal().V().has(\"short\").count().next());\n         assertEquals(1, graph.traversal().V().has(\"byte\").count().next());\n-        assertEquals(2, graph.traversal().V().has(\"deposit\").count().next());\n-        assertEquals(1, graph.traversal().V().has(\"birthday\").count().next());\n+        assertEquals(2, graph.traversal().V().has(\"float\").count().next());\n+        assertEquals(1, graph.traversal().V().has(\"date\").count().next());\n         assertEquals(2, graph.traversal().V().has(\"instant\").count().next());\n         assertEquals(3, graph.traversal().V().has(\"uuid\").count().next());\n-        assertEquals(1, graph.traversal().V().has(\"single\").count().next());\n-\n-        final String backend = readConfig.get(INDEX_BACKEND, INDEX);\n-        if (!backend.equals(\"lucene\") && !backend.equals(\"solr\")) {\n-            assertEquals(1, graph.traversal().V().has(\"address\").count().next());\n-        }\n+        assertEquals(1, graph.traversal().V().has(\"bool\").count().next());\n \n         // test has(key) transformations in OR/AND clauses where all conditions can use mixed index\n-        assertEquals(3, graph.traversal().V().or(__.has(\"name\"), __.has(\"nickname\")).count().next());\n-        assertEquals(1, graph.traversal().V().and(__.has(\"name\"), __.has(\"nickname\")).count().next());\n+        assertEquals(3, graph.traversal().V().or(__.has(\"string\"), __.has(\"text\")).count().next());\n+        assertEquals(2, graph.traversal().V().and(__.has(\"string\"), __.has(\"text\")).count().next());\n \n         // test mixed index for multiple fields, especially when some fields are missing in some vertices\n-        assertEquals(2, graph.traversal().V().has(\"sex\").count().next());\n-        assertEquals(2, graph.traversal().V().has(\"phone\").count().next());\n-        assertEquals(3, graph.traversal().V().or(__.has(\"sex\"), __.has(\"phone\")).count().next());\n-        assertEquals(1, graph.traversal().V().and(__.has(\"sex\"), __.has(\"phone\")).count().next());\n-\n-        /* lucene and solr do not support exists query for Geoshape */\n-        clopen(option(FORCE_INDEX_USAGE), false);\n-        assertEquals(1, graph.traversal().V().has(\"address\").count().next());\n+        assertEquals(3, graph.traversal().V().has(\"text\").count().next());\n+        assertEquals(2, graph.traversal().V().has(\"long\").count().next());\n+        assertEquals(3, graph.traversal().V().or(__.has(\"text\"), __.has(\"long\")).count().next());\n+        assertEquals(2, graph.traversal().V().and(__.has(\"text\"), __.has(\"long\")).count().next());\n \n         /* composite index does not support exists query */\n         clopen(option(FORCE_INDEX_USAGE), false);\n \n-        assertEquals(1, graph.traversal().V().has(\"age\").count().next());\n+        assertEquals(1, graph.traversal().V().has(\"compositeInt\").count().next());\n+\n+        Vertex vertex = graph.traversal().V().has(\"compositeInt\").next();\n+        assertEquals(1, graph.traversal().V().hasId(vertex.id()).has(\"string\").count().next());\n+        assertEquals(1, graph.traversal().V(vertex).has(\"string\").count().next());\n+        assertEquals(0, graph.traversal().V().hasId(vertex.id()).has(\"byte\").count().next());\n+        assertEquals(0, graph.traversal().V(vertex).has(\"byte\").count().next());\n+        assertEquals(1, graph.traversal().V().hasLabel(\"person\").has(\"short\").count().next());\n+        assertEquals(0, graph.traversal().V().hasLabel(\"person\").has(\"string\").count().next());\n \n         // test has(key) transformations in OR/AND clauses where one of conditions can use mixed index\n-        assertEquals(2, graph.traversal().V().or(__.has(\"name\"), __.has(\"age\")).count().next());\n-        assertEquals(1, graph.traversal().V().and(__.has(\"name\"), __.has(\"age\")).count().next());\n+        assertEquals(2, graph.traversal().V().or(__.has(\"string\"), __.has(\"compositeInt\")).count().next());\n+        assertEquals(1, graph.traversal().V().and(__.has(\"string\"), __.has(\"compositeInt\")).count().next());\n \n         // test has(key) transformations for meta-properties\n-        assertNotNull(graph.traversal().V().has(\"age\").properties(\"age\").has(\"flag\").next());\n-        assertNotNull(graph.traversal().V().has(\"age\").properties(\"age\").as(\"p\").has(\"flag\").select(\"p\").next());\n+        assertNotNull(graph.traversal().V().has(\"compositeInt\").properties(\"compositeInt\").has(\"bool2\").next());\n+        assertNotNull(graph.traversal().V().has(\"compositeInt\").properties(\"compositeInt\").as(\"p\").has(\"bool2\").select(\"p\").next());\n     }\n \n     @Test\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODU5MjM5NA==", "url": "https://github.com/JanusGraph/janusgraph/pull/2175#discussion_r488592394", "bodyText": "I find it easier to understand what these different properties are used for, if each one is named by the data type it uses. In addition, the selection of properties can be trimmed down to only contain a single property per data type.", "author": "rngcntr", "createdAt": "2020-09-15T11:30:24Z", "path": "janusgraph-backend-testutils/src/main/java/org/janusgraph/graphdb/JanusGraphIndexTest.java", "diffHunk": "@@ -212,6 +214,111 @@ private static void assertStorageExists(Backend backend, boolean exists) throws\n         }\n     }\n \n+    /**\n+     * Test that has(key) query utilizes mixed index if possible\n+     * All data types supported by mixed index are tested\n+     */\n+    @Test\n+    public void testHasKeyQuery() {\n+        VertexLabel person = mgmt.makeVertexLabel(\"person\").make();\n+        PropertyKey name = mgmt.makePropertyKey(\"name\").dataType(String.class).make();\n+        PropertyKey nickname = mgmt.makePropertyKey(\"nickname\").dataType(String.class).make();\n+        PropertyKey age = mgmt.makePropertyKey(\"age\").dataType(Integer.class).make();\n+        PropertyKey houses = mgmt.makePropertyKey(\"houses\").dataType(Integer.class).make();", "originalCommit": "324b4f52ef1dc1da22d3a4dab96f4a3395a13410", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "489195eb6e7407dac8ed674d904819ca5100ac6a", "chunk": "diff --git a/janusgraph-backend-testutils/src/main/java/org/janusgraph/graphdb/JanusGraphIndexTest.java b/janusgraph-backend-testutils/src/main/java/org/janusgraph/graphdb/JanusGraphIndexTest.java\nindex 08f43bbd1..fc68b84fd 100644\n--- a/janusgraph-backend-testutils/src/main/java/org/janusgraph/graphdb/JanusGraphIndexTest.java\n+++ b/janusgraph-backend-testutils/src/main/java/org/janusgraph/graphdb/JanusGraphIndexTest.java\n\n@@ -214,109 +216,118 @@ public abstract class JanusGraphIndexTest extends JanusGraphBaseTest {\n         }\n     }\n \n+    @Test\n+    public void testGeoshapeExistsQuery() {\n+        if (!supportsGeoPointExistsQuery()) return;\n+\n+        PropertyKey geoshape = mgmt.makePropertyKey(\"geoshape\").dataType(Geoshape.class).make();\n+        mgmt.buildIndex(\"theIndex\", Vertex.class).addKey(geoshape).buildMixedIndex(INDEX);\n+        finishSchema();\n+\n+        tx.addVertex(\"geoshape\", Geoshape.point(37.97, 23.72));\n+        tx.addVertex();\n+        tx.commit();\n+\n+        clopen(option(FORCE_INDEX_USAGE), true);\n+        assertEquals(1, graph.traversal().V().has(\"geoshape\").count().next());\n+    }\n+\n     /**\n-     * Test that has(key) query utilizes mixed index if possible\n-     * All data types supported by mixed index are tested\n+     * test exists query, i.e., has(key) query using all data types supported by mixed index, except\n+     * Geoshape which has a separate test case\n      */\n     @Test\n-    public void testHasKeyQuery() {\n-        VertexLabel person = mgmt.makeVertexLabel(\"person\").make();\n-        PropertyKey name = mgmt.makePropertyKey(\"name\").dataType(String.class).make();\n-        PropertyKey nickname = mgmt.makePropertyKey(\"nickname\").dataType(String.class).make();\n-        PropertyKey age = mgmt.makePropertyKey(\"age\").dataType(Integer.class).make();\n-        PropertyKey houses = mgmt.makePropertyKey(\"houses\").dataType(Integer.class).make();\n-        PropertyKey sex = mgmt.makePropertyKey(\"sex\").dataType(String.class).make();\n-        PropertyKey single = mgmt.makePropertyKey(\"single\").dataType(Boolean.class).make();\n-        PropertyKey phone = mgmt.makePropertyKey(\"phone\").dataType(Long.class).make();\n-        PropertyKey flag = mgmt.makePropertyKey(\"flag\").dataType(Boolean.class).make();\n+    public void testExistsQuery() {\n+        PropertyKey compositeInt = mgmt.makePropertyKey(\"compositeInt\").dataType(Integer.class).make();\n+        PropertyKey mixedInt = mgmt.makePropertyKey(\"mixedInt\").dataType(Integer.class).make();\n+        PropertyKey stringKey = mgmt.makePropertyKey(\"string\").dataType(String.class).make();\n+        PropertyKey textKey = mgmt.makePropertyKey(\"text\").dataType(String.class).make();\n+        PropertyKey boolKey = mgmt.makePropertyKey(\"bool\").dataType(Boolean.class).make();\n+        PropertyKey longKey = mgmt.makePropertyKey(\"long\").dataType(Long.class).make();\n         PropertyKey byteKey = mgmt.makePropertyKey(\"byte\").dataType(Byte.class).make();\n-        PropertyKey cars = mgmt.makePropertyKey(\"cars\").dataType(Short.class).make();\n-        PropertyKey deposit = mgmt.makePropertyKey(\"deposit\").dataType(Float.class).make();\n-        PropertyKey address = mgmt.makePropertyKey(\"address\").dataType(Geoshape.class).make();\n-        PropertyKey birthday = mgmt.makePropertyKey(\"birthday\").dataType(Date.class).make();\n+        PropertyKey shortKey = mgmt.makePropertyKey(\"short\").dataType(Short.class).make();\n+        PropertyKey floatKey = mgmt.makePropertyKey(\"float\").dataType(Float.class).make();\n+        PropertyKey dateKey = mgmt.makePropertyKey(\"date\").dataType(Date.class).make();\n         PropertyKey instant = mgmt.makePropertyKey(\"instant\").dataType(Instant.class).make();\n         PropertyKey uuid = mgmt.makePropertyKey(\"uuid\").dataType(UUID.class).make();\n \n-        mgmt.buildIndex(\"age\", Vertex.class).addKey(age).buildCompositeIndex();\n-        mgmt.buildIndex(\"namev\", Vertex.class).addKey(name, Mapping.STRING.asParameter())\n-            .buildMixedIndex(INDEX);\n-        mgmt.buildIndex(\"nameidx\", Vertex.class).addKey(nickname, Mapping.TEXT.asParameter())\n+        mgmt.buildIndex(\"int\", Vertex.class).addKey(compositeInt).buildCompositeIndex();\n+        mgmt.buildIndex(\"namev\", Vertex.class).addKey(stringKey, Mapping.STRING.asParameter())\n             .buildMixedIndex(INDEX);\n-        mgmt.buildIndex(\"mixed\", Vertex.class).addKey(sex, Mapping.TEXT.asParameter()).addKey(phone)\n-            .addKey(instant).addKey(single).buildMixedIndex(INDEX);\n-        mgmt.buildIndex(\"mi\", Vertex.class).addKey(houses).addKey(deposit).addKey(uuid).buildMixedIndex(INDEX);\n-        mgmt.buildIndex(\"theIndex\", Vertex.class).addKey(address).addKey(deposit).addKey(byteKey)\n-            .addKey(cars).addKey(birthday).buildMixedIndex(INDEX);\n+        mgmt.buildIndex(\"mixed\", Vertex.class).addKey(textKey, Mapping.TEXT.asParameter()).addKey(longKey)\n+            .addKey(instant).addKey(boolKey).buildMixedIndex(INDEX);\n+        mgmt.buildIndex(\"mi\", Vertex.class).addKey(mixedInt).addKey(floatKey).addKey(uuid).buildMixedIndex(INDEX);\n+        mgmt.buildIndex(\"theIndex\", Vertex.class).addKey(floatKey).addKey(byteKey)\n+            .addKey(shortKey).addKey(dateKey).buildMixedIndex(INDEX);\n         finishSchema();\n \n-        JanusGraphVertex v = tx.addVertex(T.label, \"person\", \"name\", \"\", \"age\", 30, \"sex\", \"male\", \"houses\", 0,\n-            \"cars\", 0, \"deposit\", 0.0, \"birthday\", new Date(), \"instant\", Instant.ofEpochMilli(1), \"uuid\", UUID.randomUUID());\n-        v.property(\"age\").property(\"flag\", true);\n-        tx.addVertex(T.label, \"person\", \"name\", \"robert\", \"nickname\", \"bob\", \"sex\", \"female\", \"phone\", 12345678L,\n-            \"deposit\", 100000.5, \"instant\", Instant.ofEpochMilli(100), \"uuid\", UUID.randomUUID(), \"single\", true);\n-        tx.addVertex(T.label, \"person\", \"nickname\", \"anonym is my name\", \"phone\", 23456789L,\n+        JanusGraphVertex v = tx.addVertex(\"string\", \"\", \"compositeInt\", 30, \"text\", \"male\", \"mixedInt\", 0,\n+            \"short\", 0, \"float\", 0.0, \"date\", new Date(), \"instant\", Instant.ofEpochMilli(1), \"uuid\", UUID.randomUUID());\n+        v.property(\"compositeInt\").property(\"bool2\", true);\n+        tx.addVertex(\"string\", \"robert\", \"text\", \"female\", \"long\", 12345678L,\n+            \"float\", 100000.5, \"instant\", Instant.ofEpochMilli(100), \"uuid\", UUID.randomUUID(), \"bool\", true);\n+        tx.addVertex(\"text\", \"prefer not to say\", \"long\", 23456789L,\n             \"byte\", Byte.MIN_VALUE, \"uuid\", UUID.randomUUID());\n-        tx.addVertex(T.label, \"person\", \"houses\", 2, \"cars\", 1, \"address\", Geoshape.point(37.97, 23.72));\n+        tx.addVertex(T.label, \"person\", \"mixedInt\", 2, \"short\", 1);\n         tx.commit();\n \n         /* force index to be used */\n         clopen(option(FORCE_INDEX_USAGE), true);\n \n         // test has(key) -> has(key, NOT_EQUAL, null) (exists query) transformation in JanusGraph GraphCentricQuery\n-        assertCount(2, tx.query().has(\"name\").vertices());\n-        assertCount(2, tx.query().has(\"nickname\").vertices());\n-        assertCount(2, tx.query().has(\"houses\").vertices());\n-        assertCount(2, tx.query().has(\"cars\").vertices());\n+        assertCount(2, tx.query().has(\"string\").vertices());\n+        assertCount(3, tx.query().has(\"text\").vertices());\n+        assertCount(2, tx.query().has(\"mixedInt\").vertices());\n+        assertCount(2, tx.query().has(\"short\").vertices());\n         assertCount(1, tx.query().has(\"byte\").vertices());\n-        assertCount(2, tx.query().has(\"deposit\").vertices());\n-        assertCount(1, tx.query().has(\"birthday\").vertices());\n+        assertCount(2, tx.query().has(\"float\").vertices());\n+        assertCount(1, tx.query().has(\"date\").vertices());\n         assertCount(2, tx.query().has(\"instant\").vertices());\n         assertCount(3, tx.query().has(\"uuid\").vertices());\n-        assertCount(1, tx.query().has(\"single\").vertices());\n+        assertCount(1, tx.query().has(\"bool\").vertices());\n \n         // test has(key) -> has(key, neq(null)) transformation in Gremlin query\n-        assertEquals(2, graph.traversal().V().has(\"name\").count().next());\n-        assertEquals(2, graph.traversal().V().has(\"nickname\").count().next());\n-        assertEquals(2, graph.traversal().V().has(\"houses\").count().next());\n-        assertEquals(2, graph.traversal().V().has(\"cars\").count().next());\n+        assertEquals(2, graph.traversal().V().has(\"string\").as(\"v\").select(\"v\").count().next());\n+        assertEquals(3, graph.traversal().V().has(\"text\").count().next());\n+        assertEquals(2, graph.traversal().V().has(\"mixedInt\").count().next());\n+        assertEquals(2, graph.traversal().V().has(\"short\").count().next());\n         assertEquals(1, graph.traversal().V().has(\"byte\").count().next());\n-        assertEquals(2, graph.traversal().V().has(\"deposit\").count().next());\n-        assertEquals(1, graph.traversal().V().has(\"birthday\").count().next());\n+        assertEquals(2, graph.traversal().V().has(\"float\").count().next());\n+        assertEquals(1, graph.traversal().V().has(\"date\").count().next());\n         assertEquals(2, graph.traversal().V().has(\"instant\").count().next());\n         assertEquals(3, graph.traversal().V().has(\"uuid\").count().next());\n-        assertEquals(1, graph.traversal().V().has(\"single\").count().next());\n-\n-        final String backend = readConfig.get(INDEX_BACKEND, INDEX);\n-        if (!backend.equals(\"lucene\") && !backend.equals(\"solr\")) {\n-            assertEquals(1, graph.traversal().V().has(\"address\").count().next());\n-        }\n+        assertEquals(1, graph.traversal().V().has(\"bool\").count().next());\n \n         // test has(key) transformations in OR/AND clauses where all conditions can use mixed index\n-        assertEquals(3, graph.traversal().V().or(__.has(\"name\"), __.has(\"nickname\")).count().next());\n-        assertEquals(1, graph.traversal().V().and(__.has(\"name\"), __.has(\"nickname\")).count().next());\n+        assertEquals(3, graph.traversal().V().or(__.has(\"string\"), __.has(\"text\")).count().next());\n+        assertEquals(2, graph.traversal().V().and(__.has(\"string\"), __.has(\"text\")).count().next());\n \n         // test mixed index for multiple fields, especially when some fields are missing in some vertices\n-        assertEquals(2, graph.traversal().V().has(\"sex\").count().next());\n-        assertEquals(2, graph.traversal().V().has(\"phone\").count().next());\n-        assertEquals(3, graph.traversal().V().or(__.has(\"sex\"), __.has(\"phone\")).count().next());\n-        assertEquals(1, graph.traversal().V().and(__.has(\"sex\"), __.has(\"phone\")).count().next());\n-\n-        /* lucene and solr do not support exists query for Geoshape */\n-        clopen(option(FORCE_INDEX_USAGE), false);\n-        assertEquals(1, graph.traversal().V().has(\"address\").count().next());\n+        assertEquals(3, graph.traversal().V().has(\"text\").count().next());\n+        assertEquals(2, graph.traversal().V().has(\"long\").count().next());\n+        assertEquals(3, graph.traversal().V().or(__.has(\"text\"), __.has(\"long\")).count().next());\n+        assertEquals(2, graph.traversal().V().and(__.has(\"text\"), __.has(\"long\")).count().next());\n \n         /* composite index does not support exists query */\n         clopen(option(FORCE_INDEX_USAGE), false);\n \n-        assertEquals(1, graph.traversal().V().has(\"age\").count().next());\n+        assertEquals(1, graph.traversal().V().has(\"compositeInt\").count().next());\n+\n+        Vertex vertex = graph.traversal().V().has(\"compositeInt\").next();\n+        assertEquals(1, graph.traversal().V().hasId(vertex.id()).has(\"string\").count().next());\n+        assertEquals(1, graph.traversal().V(vertex).has(\"string\").count().next());\n+        assertEquals(0, graph.traversal().V().hasId(vertex.id()).has(\"byte\").count().next());\n+        assertEquals(0, graph.traversal().V(vertex).has(\"byte\").count().next());\n+        assertEquals(1, graph.traversal().V().hasLabel(\"person\").has(\"short\").count().next());\n+        assertEquals(0, graph.traversal().V().hasLabel(\"person\").has(\"string\").count().next());\n \n         // test has(key) transformations in OR/AND clauses where one of conditions can use mixed index\n-        assertEquals(2, graph.traversal().V().or(__.has(\"name\"), __.has(\"age\")).count().next());\n-        assertEquals(1, graph.traversal().V().and(__.has(\"name\"), __.has(\"age\")).count().next());\n+        assertEquals(2, graph.traversal().V().or(__.has(\"string\"), __.has(\"compositeInt\")).count().next());\n+        assertEquals(1, graph.traversal().V().and(__.has(\"string\"), __.has(\"compositeInt\")).count().next());\n \n         // test has(key) transformations for meta-properties\n-        assertNotNull(graph.traversal().V().has(\"age\").properties(\"age\").has(\"flag\").next());\n-        assertNotNull(graph.traversal().V().has(\"age\").properties(\"age\").as(\"p\").has(\"flag\").select(\"p\").next());\n+        assertNotNull(graph.traversal().V().has(\"compositeInt\").properties(\"compositeInt\").has(\"bool2\").next());\n+        assertNotNull(graph.traversal().V().has(\"compositeInt\").properties(\"compositeInt\").as(\"p\").has(\"bool2\").select(\"p\").next());\n     }\n \n     @Test\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc5NzEzOQ==", "url": "https://github.com/JanusGraph/janusgraph/pull/2175#discussion_r488797139", "bodyText": "has(\"key\").as(\"label\") should also be tested", "author": "li-boxuan", "createdAt": "2020-09-15T16:21:10Z", "path": "janusgraph-backend-testutils/src/main/java/org/janusgraph/graphdb/JanusGraphIndexTest.java", "diffHunk": "@@ -212,6 +214,111 @@ private static void assertStorageExists(Backend backend, boolean exists) throws\n         }\n     }\n \n+    /**\n+     * Test that has(key) query utilizes mixed index if possible\n+     * All data types supported by mixed index are tested\n+     */\n+    @Test\n+    public void testHasKeyQuery() {\n+        VertexLabel person = mgmt.makeVertexLabel(\"person\").make();\n+        PropertyKey name = mgmt.makePropertyKey(\"name\").dataType(String.class).make();\n+        PropertyKey nickname = mgmt.makePropertyKey(\"nickname\").dataType(String.class).make();\n+        PropertyKey age = mgmt.makePropertyKey(\"age\").dataType(Integer.class).make();\n+        PropertyKey houses = mgmt.makePropertyKey(\"houses\").dataType(Integer.class).make();\n+        PropertyKey sex = mgmt.makePropertyKey(\"sex\").dataType(String.class).make();\n+        PropertyKey single = mgmt.makePropertyKey(\"single\").dataType(Boolean.class).make();\n+        PropertyKey phone = mgmt.makePropertyKey(\"phone\").dataType(Long.class).make();\n+        PropertyKey flag = mgmt.makePropertyKey(\"flag\").dataType(Boolean.class).make();\n+        PropertyKey byteKey = mgmt.makePropertyKey(\"byte\").dataType(Byte.class).make();\n+        PropertyKey cars = mgmt.makePropertyKey(\"cars\").dataType(Short.class).make();\n+        PropertyKey deposit = mgmt.makePropertyKey(\"deposit\").dataType(Float.class).make();\n+        PropertyKey address = mgmt.makePropertyKey(\"address\").dataType(Geoshape.class).make();\n+        PropertyKey birthday = mgmt.makePropertyKey(\"birthday\").dataType(Date.class).make();\n+        PropertyKey instant = mgmt.makePropertyKey(\"instant\").dataType(Instant.class).make();\n+        PropertyKey uuid = mgmt.makePropertyKey(\"uuid\").dataType(UUID.class).make();\n+\n+        mgmt.buildIndex(\"age\", Vertex.class).addKey(age).buildCompositeIndex();\n+        mgmt.buildIndex(\"namev\", Vertex.class).addKey(name, Mapping.STRING.asParameter())\n+            .buildMixedIndex(INDEX);\n+        mgmt.buildIndex(\"nameidx\", Vertex.class).addKey(nickname, Mapping.TEXT.asParameter())\n+            .buildMixedIndex(INDEX);\n+        mgmt.buildIndex(\"mixed\", Vertex.class).addKey(sex, Mapping.TEXT.asParameter()).addKey(phone)\n+            .addKey(instant).addKey(single).buildMixedIndex(INDEX);\n+        mgmt.buildIndex(\"mi\", Vertex.class).addKey(houses).addKey(deposit).addKey(uuid).buildMixedIndex(INDEX);\n+        mgmt.buildIndex(\"theIndex\", Vertex.class).addKey(address).addKey(deposit).addKey(byteKey)\n+            .addKey(cars).addKey(birthday).buildMixedIndex(INDEX);\n+        finishSchema();\n+\n+        JanusGraphVertex v = tx.addVertex(T.label, \"person\", \"name\", \"\", \"age\", 30, \"sex\", \"male\", \"houses\", 0,\n+            \"cars\", 0, \"deposit\", 0.0, \"birthday\", new Date(), \"instant\", Instant.ofEpochMilli(1), \"uuid\", UUID.randomUUID());\n+        v.property(\"age\").property(\"flag\", true);\n+        tx.addVertex(T.label, \"person\", \"name\", \"robert\", \"nickname\", \"bob\", \"sex\", \"female\", \"phone\", 12345678L,\n+            \"deposit\", 100000.5, \"instant\", Instant.ofEpochMilli(100), \"uuid\", UUID.randomUUID(), \"single\", true);\n+        tx.addVertex(T.label, \"person\", \"nickname\", \"anonym is my name\", \"phone\", 23456789L,\n+            \"byte\", Byte.MIN_VALUE, \"uuid\", UUID.randomUUID());\n+        tx.addVertex(T.label, \"person\", \"houses\", 2, \"cars\", 1, \"address\", Geoshape.point(37.97, 23.72));\n+        tx.commit();\n+\n+        /* force index to be used */\n+        clopen(option(FORCE_INDEX_USAGE), true);\n+\n+        // test has(key) -> has(key, NOT_EQUAL, null) (exists query) transformation in JanusGraph GraphCentricQuery\n+        assertCount(2, tx.query().has(\"name\").vertices());", "originalCommit": "324b4f52ef1dc1da22d3a4dab96f4a3395a13410", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "489195eb6e7407dac8ed674d904819ca5100ac6a", "chunk": "diff --git a/janusgraph-backend-testutils/src/main/java/org/janusgraph/graphdb/JanusGraphIndexTest.java b/janusgraph-backend-testutils/src/main/java/org/janusgraph/graphdb/JanusGraphIndexTest.java\nindex 08f43bbd1..fc68b84fd 100644\n--- a/janusgraph-backend-testutils/src/main/java/org/janusgraph/graphdb/JanusGraphIndexTest.java\n+++ b/janusgraph-backend-testutils/src/main/java/org/janusgraph/graphdb/JanusGraphIndexTest.java\n\n@@ -214,109 +216,118 @@ public abstract class JanusGraphIndexTest extends JanusGraphBaseTest {\n         }\n     }\n \n+    @Test\n+    public void testGeoshapeExistsQuery() {\n+        if (!supportsGeoPointExistsQuery()) return;\n+\n+        PropertyKey geoshape = mgmt.makePropertyKey(\"geoshape\").dataType(Geoshape.class).make();\n+        mgmt.buildIndex(\"theIndex\", Vertex.class).addKey(geoshape).buildMixedIndex(INDEX);\n+        finishSchema();\n+\n+        tx.addVertex(\"geoshape\", Geoshape.point(37.97, 23.72));\n+        tx.addVertex();\n+        tx.commit();\n+\n+        clopen(option(FORCE_INDEX_USAGE), true);\n+        assertEquals(1, graph.traversal().V().has(\"geoshape\").count().next());\n+    }\n+\n     /**\n-     * Test that has(key) query utilizes mixed index if possible\n-     * All data types supported by mixed index are tested\n+     * test exists query, i.e., has(key) query using all data types supported by mixed index, except\n+     * Geoshape which has a separate test case\n      */\n     @Test\n-    public void testHasKeyQuery() {\n-        VertexLabel person = mgmt.makeVertexLabel(\"person\").make();\n-        PropertyKey name = mgmt.makePropertyKey(\"name\").dataType(String.class).make();\n-        PropertyKey nickname = mgmt.makePropertyKey(\"nickname\").dataType(String.class).make();\n-        PropertyKey age = mgmt.makePropertyKey(\"age\").dataType(Integer.class).make();\n-        PropertyKey houses = mgmt.makePropertyKey(\"houses\").dataType(Integer.class).make();\n-        PropertyKey sex = mgmt.makePropertyKey(\"sex\").dataType(String.class).make();\n-        PropertyKey single = mgmt.makePropertyKey(\"single\").dataType(Boolean.class).make();\n-        PropertyKey phone = mgmt.makePropertyKey(\"phone\").dataType(Long.class).make();\n-        PropertyKey flag = mgmt.makePropertyKey(\"flag\").dataType(Boolean.class).make();\n+    public void testExistsQuery() {\n+        PropertyKey compositeInt = mgmt.makePropertyKey(\"compositeInt\").dataType(Integer.class).make();\n+        PropertyKey mixedInt = mgmt.makePropertyKey(\"mixedInt\").dataType(Integer.class).make();\n+        PropertyKey stringKey = mgmt.makePropertyKey(\"string\").dataType(String.class).make();\n+        PropertyKey textKey = mgmt.makePropertyKey(\"text\").dataType(String.class).make();\n+        PropertyKey boolKey = mgmt.makePropertyKey(\"bool\").dataType(Boolean.class).make();\n+        PropertyKey longKey = mgmt.makePropertyKey(\"long\").dataType(Long.class).make();\n         PropertyKey byteKey = mgmt.makePropertyKey(\"byte\").dataType(Byte.class).make();\n-        PropertyKey cars = mgmt.makePropertyKey(\"cars\").dataType(Short.class).make();\n-        PropertyKey deposit = mgmt.makePropertyKey(\"deposit\").dataType(Float.class).make();\n-        PropertyKey address = mgmt.makePropertyKey(\"address\").dataType(Geoshape.class).make();\n-        PropertyKey birthday = mgmt.makePropertyKey(\"birthday\").dataType(Date.class).make();\n+        PropertyKey shortKey = mgmt.makePropertyKey(\"short\").dataType(Short.class).make();\n+        PropertyKey floatKey = mgmt.makePropertyKey(\"float\").dataType(Float.class).make();\n+        PropertyKey dateKey = mgmt.makePropertyKey(\"date\").dataType(Date.class).make();\n         PropertyKey instant = mgmt.makePropertyKey(\"instant\").dataType(Instant.class).make();\n         PropertyKey uuid = mgmt.makePropertyKey(\"uuid\").dataType(UUID.class).make();\n \n-        mgmt.buildIndex(\"age\", Vertex.class).addKey(age).buildCompositeIndex();\n-        mgmt.buildIndex(\"namev\", Vertex.class).addKey(name, Mapping.STRING.asParameter())\n-            .buildMixedIndex(INDEX);\n-        mgmt.buildIndex(\"nameidx\", Vertex.class).addKey(nickname, Mapping.TEXT.asParameter())\n+        mgmt.buildIndex(\"int\", Vertex.class).addKey(compositeInt).buildCompositeIndex();\n+        mgmt.buildIndex(\"namev\", Vertex.class).addKey(stringKey, Mapping.STRING.asParameter())\n             .buildMixedIndex(INDEX);\n-        mgmt.buildIndex(\"mixed\", Vertex.class).addKey(sex, Mapping.TEXT.asParameter()).addKey(phone)\n-            .addKey(instant).addKey(single).buildMixedIndex(INDEX);\n-        mgmt.buildIndex(\"mi\", Vertex.class).addKey(houses).addKey(deposit).addKey(uuid).buildMixedIndex(INDEX);\n-        mgmt.buildIndex(\"theIndex\", Vertex.class).addKey(address).addKey(deposit).addKey(byteKey)\n-            .addKey(cars).addKey(birthday).buildMixedIndex(INDEX);\n+        mgmt.buildIndex(\"mixed\", Vertex.class).addKey(textKey, Mapping.TEXT.asParameter()).addKey(longKey)\n+            .addKey(instant).addKey(boolKey).buildMixedIndex(INDEX);\n+        mgmt.buildIndex(\"mi\", Vertex.class).addKey(mixedInt).addKey(floatKey).addKey(uuid).buildMixedIndex(INDEX);\n+        mgmt.buildIndex(\"theIndex\", Vertex.class).addKey(floatKey).addKey(byteKey)\n+            .addKey(shortKey).addKey(dateKey).buildMixedIndex(INDEX);\n         finishSchema();\n \n-        JanusGraphVertex v = tx.addVertex(T.label, \"person\", \"name\", \"\", \"age\", 30, \"sex\", \"male\", \"houses\", 0,\n-            \"cars\", 0, \"deposit\", 0.0, \"birthday\", new Date(), \"instant\", Instant.ofEpochMilli(1), \"uuid\", UUID.randomUUID());\n-        v.property(\"age\").property(\"flag\", true);\n-        tx.addVertex(T.label, \"person\", \"name\", \"robert\", \"nickname\", \"bob\", \"sex\", \"female\", \"phone\", 12345678L,\n-            \"deposit\", 100000.5, \"instant\", Instant.ofEpochMilli(100), \"uuid\", UUID.randomUUID(), \"single\", true);\n-        tx.addVertex(T.label, \"person\", \"nickname\", \"anonym is my name\", \"phone\", 23456789L,\n+        JanusGraphVertex v = tx.addVertex(\"string\", \"\", \"compositeInt\", 30, \"text\", \"male\", \"mixedInt\", 0,\n+            \"short\", 0, \"float\", 0.0, \"date\", new Date(), \"instant\", Instant.ofEpochMilli(1), \"uuid\", UUID.randomUUID());\n+        v.property(\"compositeInt\").property(\"bool2\", true);\n+        tx.addVertex(\"string\", \"robert\", \"text\", \"female\", \"long\", 12345678L,\n+            \"float\", 100000.5, \"instant\", Instant.ofEpochMilli(100), \"uuid\", UUID.randomUUID(), \"bool\", true);\n+        tx.addVertex(\"text\", \"prefer not to say\", \"long\", 23456789L,\n             \"byte\", Byte.MIN_VALUE, \"uuid\", UUID.randomUUID());\n-        tx.addVertex(T.label, \"person\", \"houses\", 2, \"cars\", 1, \"address\", Geoshape.point(37.97, 23.72));\n+        tx.addVertex(T.label, \"person\", \"mixedInt\", 2, \"short\", 1);\n         tx.commit();\n \n         /* force index to be used */\n         clopen(option(FORCE_INDEX_USAGE), true);\n \n         // test has(key) -> has(key, NOT_EQUAL, null) (exists query) transformation in JanusGraph GraphCentricQuery\n-        assertCount(2, tx.query().has(\"name\").vertices());\n-        assertCount(2, tx.query().has(\"nickname\").vertices());\n-        assertCount(2, tx.query().has(\"houses\").vertices());\n-        assertCount(2, tx.query().has(\"cars\").vertices());\n+        assertCount(2, tx.query().has(\"string\").vertices());\n+        assertCount(3, tx.query().has(\"text\").vertices());\n+        assertCount(2, tx.query().has(\"mixedInt\").vertices());\n+        assertCount(2, tx.query().has(\"short\").vertices());\n         assertCount(1, tx.query().has(\"byte\").vertices());\n-        assertCount(2, tx.query().has(\"deposit\").vertices());\n-        assertCount(1, tx.query().has(\"birthday\").vertices());\n+        assertCount(2, tx.query().has(\"float\").vertices());\n+        assertCount(1, tx.query().has(\"date\").vertices());\n         assertCount(2, tx.query().has(\"instant\").vertices());\n         assertCount(3, tx.query().has(\"uuid\").vertices());\n-        assertCount(1, tx.query().has(\"single\").vertices());\n+        assertCount(1, tx.query().has(\"bool\").vertices());\n \n         // test has(key) -> has(key, neq(null)) transformation in Gremlin query\n-        assertEquals(2, graph.traversal().V().has(\"name\").count().next());\n-        assertEquals(2, graph.traversal().V().has(\"nickname\").count().next());\n-        assertEquals(2, graph.traversal().V().has(\"houses\").count().next());\n-        assertEquals(2, graph.traversal().V().has(\"cars\").count().next());\n+        assertEquals(2, graph.traversal().V().has(\"string\").as(\"v\").select(\"v\").count().next());\n+        assertEquals(3, graph.traversal().V().has(\"text\").count().next());\n+        assertEquals(2, graph.traversal().V().has(\"mixedInt\").count().next());\n+        assertEquals(2, graph.traversal().V().has(\"short\").count().next());\n         assertEquals(1, graph.traversal().V().has(\"byte\").count().next());\n-        assertEquals(2, graph.traversal().V().has(\"deposit\").count().next());\n-        assertEquals(1, graph.traversal().V().has(\"birthday\").count().next());\n+        assertEquals(2, graph.traversal().V().has(\"float\").count().next());\n+        assertEquals(1, graph.traversal().V().has(\"date\").count().next());\n         assertEquals(2, graph.traversal().V().has(\"instant\").count().next());\n         assertEquals(3, graph.traversal().V().has(\"uuid\").count().next());\n-        assertEquals(1, graph.traversal().V().has(\"single\").count().next());\n-\n-        final String backend = readConfig.get(INDEX_BACKEND, INDEX);\n-        if (!backend.equals(\"lucene\") && !backend.equals(\"solr\")) {\n-            assertEquals(1, graph.traversal().V().has(\"address\").count().next());\n-        }\n+        assertEquals(1, graph.traversal().V().has(\"bool\").count().next());\n \n         // test has(key) transformations in OR/AND clauses where all conditions can use mixed index\n-        assertEquals(3, graph.traversal().V().or(__.has(\"name\"), __.has(\"nickname\")).count().next());\n-        assertEquals(1, graph.traversal().V().and(__.has(\"name\"), __.has(\"nickname\")).count().next());\n+        assertEquals(3, graph.traversal().V().or(__.has(\"string\"), __.has(\"text\")).count().next());\n+        assertEquals(2, graph.traversal().V().and(__.has(\"string\"), __.has(\"text\")).count().next());\n \n         // test mixed index for multiple fields, especially when some fields are missing in some vertices\n-        assertEquals(2, graph.traversal().V().has(\"sex\").count().next());\n-        assertEquals(2, graph.traversal().V().has(\"phone\").count().next());\n-        assertEquals(3, graph.traversal().V().or(__.has(\"sex\"), __.has(\"phone\")).count().next());\n-        assertEquals(1, graph.traversal().V().and(__.has(\"sex\"), __.has(\"phone\")).count().next());\n-\n-        /* lucene and solr do not support exists query for Geoshape */\n-        clopen(option(FORCE_INDEX_USAGE), false);\n-        assertEquals(1, graph.traversal().V().has(\"address\").count().next());\n+        assertEquals(3, graph.traversal().V().has(\"text\").count().next());\n+        assertEquals(2, graph.traversal().V().has(\"long\").count().next());\n+        assertEquals(3, graph.traversal().V().or(__.has(\"text\"), __.has(\"long\")).count().next());\n+        assertEquals(2, graph.traversal().V().and(__.has(\"text\"), __.has(\"long\")).count().next());\n \n         /* composite index does not support exists query */\n         clopen(option(FORCE_INDEX_USAGE), false);\n \n-        assertEquals(1, graph.traversal().V().has(\"age\").count().next());\n+        assertEquals(1, graph.traversal().V().has(\"compositeInt\").count().next());\n+\n+        Vertex vertex = graph.traversal().V().has(\"compositeInt\").next();\n+        assertEquals(1, graph.traversal().V().hasId(vertex.id()).has(\"string\").count().next());\n+        assertEquals(1, graph.traversal().V(vertex).has(\"string\").count().next());\n+        assertEquals(0, graph.traversal().V().hasId(vertex.id()).has(\"byte\").count().next());\n+        assertEquals(0, graph.traversal().V(vertex).has(\"byte\").count().next());\n+        assertEquals(1, graph.traversal().V().hasLabel(\"person\").has(\"short\").count().next());\n+        assertEquals(0, graph.traversal().V().hasLabel(\"person\").has(\"string\").count().next());\n \n         // test has(key) transformations in OR/AND clauses where one of conditions can use mixed index\n-        assertEquals(2, graph.traversal().V().or(__.has(\"name\"), __.has(\"age\")).count().next());\n-        assertEquals(1, graph.traversal().V().and(__.has(\"name\"), __.has(\"age\")).count().next());\n+        assertEquals(2, graph.traversal().V().or(__.has(\"string\"), __.has(\"compositeInt\")).count().next());\n+        assertEquals(1, graph.traversal().V().and(__.has(\"string\"), __.has(\"compositeInt\")).count().next());\n \n         // test has(key) transformations for meta-properties\n-        assertNotNull(graph.traversal().V().has(\"age\").properties(\"age\").has(\"flag\").next());\n-        assertNotNull(graph.traversal().V().has(\"age\").properties(\"age\").as(\"p\").has(\"flag\").select(\"p\").next());\n+        assertNotNull(graph.traversal().V().has(\"compositeInt\").properties(\"compositeInt\").has(\"bool2\").next());\n+        assertNotNull(graph.traversal().V().has(\"compositeInt\").properties(\"compositeInt\").as(\"p\").has(\"bool2\").select(\"p\").next());\n     }\n \n     @Test\n"}}, {"oid": "489195eb6e7407dac8ed674d904819ca5100ac6a", "url": "https://github.com/JanusGraph/janusgraph/commit/489195eb6e7407dac8ed674d904819ca5100ac6a", "message": "Add mixed index support for has(key) query\n\nCurrently, has(key) query does not use index at all. This commit\ntries to use mixed index if possible. Geoshape type exists query\nis not supported by Lucene and Solr index backends.\n\nRelated to #284\n\nSigned-off-by: Boxuan Li <liboxuan@connect.hku.hk>", "committedDate": "2020-09-20T03:55:50Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTg2Njk1Mg==", "url": "https://github.com/JanusGraph/janusgraph/pull/2175#discussion_r495866952", "bodyText": "I'm not sure .has(\"prop\", P.neq(null)) and .has(\"prop\") are equal. At least, in TinkerPop 3.5.0 null values are supported.\nThat said, I didn't check this PR much. Maybe I just miss something", "author": "porunov", "createdAt": "2020-09-28T11:22:34Z", "path": "janusgraph-core/src/main/java/org/janusgraph/graphdb/tinkerpop/optimize/HasStepFolder.java", "diffHunk": "@@ -212,6 +223,41 @@ static boolean validFoldInHasContainer(final Step<?, ?>  tinkerpopStep, final bo\n         return Boolean.TRUE.equals(toReturn);\n     }\n \n+    /**\n+     * Check if a given step is an \"exists\" step, i.e. has(key) step\n+     * Tinkerpop translates has(key) gremlin query into TraversalFilterStep(PropertiesStep)\n+     * @param step\n+     * @return true if given step is essentially an \"exists\" step\n+     */\n+    static boolean isExistsStep(final Step<?, ?> step) {\n+        if (step instanceof TraversalFilterStep) {\n+            List<Traversal.Admin> traversals = ((TraversalFilterStep) step).getLocalChildren();\n+            assert (traversals.size() == 1);\n+            List<Step> steps = traversals.get(0).getSteps();\n+            if (!(steps.size() == 1 && steps.get(0) instanceof PropertiesStep)) return false;\n+            return ((PropertiesStep) steps.get(0)).getPropertyKeys().length == 1;\n+        }\n+        return false;\n+    }\n+\n+    /**\n+     * Convert a TraversalFilterStep that is essentially \"has(key)\" into a normal HasStep\n+     * @param traversal local traversal\n+     * @param currentStep\n+     */\n+    static Step foldInHasFilter(final Traversal.Admin<?, ?> traversal, final TraversalFilterStep<?> currentStep) {\n+        List<? extends Traversal.Admin<?, ?>> traversals = currentStep.getLocalChildren();\n+        assert(traversals.size() == 1);\n+        List<Step> steps = traversals.get(0).getSteps();\n+        assert(steps.size() == 1 && steps.get(0) instanceof PropertiesStep);\n+        String[] propertyKeys = ((PropertiesStep) steps.get(0)).getPropertyKeys();\n+        assert(propertyKeys.length == 1);\n+        HasStep hasStep = new HasStep(traversal, new HasContainer(propertyKeys[0], P.neq(null)));", "originalCommit": "489195eb6e7407dac8ed674d904819ca5100ac6a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA0MTAyMw==", "url": "https://github.com/JanusGraph/janusgraph/pull/2175#discussion_r496041023", "bodyText": "This is the semantics JanusGraph has been following:\n\n  \n    \n      janusgraph/janusgraph-core/src/main/java/org/janusgraph/graphdb/query/graph/GraphCentricQueryBuilder.java\n    \n    \n        Lines 132 to 135\n      in\n      6785f76\n    \n    \n    \n    \n\n        \n          \n           @Override \n        \n\n        \n          \n           public GraphCentricQueryBuilder has(String key) { \n        \n\n        \n          \n               return has(key, Cmp.NOT_EQUAL, null); \n        \n\n        \n          \n           } \n        \n    \n  \n\n\nI read https://tinkerpop.apache.org/docs/3.5.0-SNAPSHOT/upgrade/#_null_semantics, but I don't think we are gonna support null values in the near future. There are some obstacles, for example, Cassandra does not support null values, unless we come up with some fixed custom value that can represent \"null\" values. If that happens, then we can translate .has(\"prop\") into .has(\"prop\", P.neq(NULL_VALUE)) without many changes here.", "author": "li-boxuan", "createdAt": "2020-09-28T15:28:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTg2Njk1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA3MjE5MQ==", "url": "https://github.com/JanusGraph/janusgraph/pull/2175#discussion_r496072191", "bodyText": "Great explanation @li-boxuan !\nAgree, we don't need to support null values as for now because it is an optional feature in TinkerPop", "author": "porunov", "createdAt": "2020-09-28T16:15:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTg2Njk1Mg=="}], "type": "inlineReview", "revised_code": {"commit": "728ad10f1b8e096adc559657d7ac7d623f012cb6", "chunk": "diff --git a/janusgraph-core/src/main/java/org/janusgraph/graphdb/tinkerpop/optimize/HasStepFolder.java b/janusgraph-core/src/main/java/org/janusgraph/graphdb/tinkerpop/optimize/step/HasStepFolder.java\nsimilarity index 99%\nrename from janusgraph-core/src/main/java/org/janusgraph/graphdb/tinkerpop/optimize/HasStepFolder.java\nrename to janusgraph-core/src/main/java/org/janusgraph/graphdb/tinkerpop/optimize/step/HasStepFolder.java\nindex 915f0cbbc..aea91047a 100644\n--- a/janusgraph-core/src/main/java/org/janusgraph/graphdb/tinkerpop/optimize/HasStepFolder.java\n+++ b/janusgraph-core/src/main/java/org/janusgraph/graphdb/tinkerpop/optimize/step/HasStepFolder.java\n\n@@ -232,7 +233,7 @@ public interface HasStepFolder<S, E> extends Step<S, E> {\n     static boolean isExistsStep(final Step<?, ?> step) {\n         if (step instanceof TraversalFilterStep) {\n             List<Traversal.Admin> traversals = ((TraversalFilterStep) step).getLocalChildren();\n-            assert (traversals.size() == 1);\n+            assert traversals.size() == 1;\n             List<Step> steps = traversals.get(0).getSteps();\n             if (!(steps.size() == 1 && steps.get(0) instanceof PropertiesStep)) return false;\n             return ((PropertiesStep) steps.get(0)).getPropertyKeys().length == 1;\n"}}, {"oid": "c971dc7b7bcb9381ded9968cf264a18a2c26ccf2", "url": "https://github.com/JanusGraph/janusgraph/commit/c971dc7b7bcb9381ded9968cf264a18a2c26ccf2", "message": "Add mixed index support for has(key) query\n\nCurrently, has(key) query does not use index at all. This commit\ntries to use mixed index if possible. Geoshape type exists query\nis not supported by Lucene and Solr index backends.\n\nRelated to #284\n\nSigned-off-by: Boxuan Li <liboxuan@connect.hku.hk>", "committedDate": "2020-10-06T13:02:03Z", "type": "forcePushed"}, {"oid": "8caec946f0af96b197abf4cb478db35f5ff17809", "url": "https://github.com/JanusGraph/janusgraph/commit/8caec946f0af96b197abf4cb478db35f5ff17809", "message": "Add mixed index support for has(key) query\n\nCurrently, has(key) query does not use index at all. This commit\ntries to use mixed index if possible. Geoshape type exists query\nis not supported by Lucene and Solr index backends.\n\nRelated to #284\n\nSigned-off-by: Boxuan Li <liboxuan@connect.hku.hk>", "committedDate": "2020-10-08T16:20:05Z", "type": "forcePushed"}, {"oid": "5e1c8566933b8d3eed2d7eb31c931622c41e95a1", "url": "https://github.com/JanusGraph/janusgraph/commit/5e1c8566933b8d3eed2d7eb31c931622c41e95a1", "message": "Add mixed index support for has(key) query\n\nCurrently, has(key) query does not use index at all. This commit\ntries to use mixed index if possible. Geoshape type exists query\nis not supported by Lucene and Solr index backends.\n\nRelated to #284\n\nSigned-off-by: Boxuan Li <liboxuan@connect.hku.hk>", "committedDate": "2020-11-02T13:36:43Z", "type": "forcePushed"}, {"oid": "728ad10f1b8e096adc559657d7ac7d623f012cb6", "url": "https://github.com/JanusGraph/janusgraph/commit/728ad10f1b8e096adc559657d7ac7d623f012cb6", "message": "Add mixed index support for has(key) query\n\nCurrently, has(key) query does not use index at all. This commit\ntries to use mixed index if possible. Geoshape type exists query\nis not supported by Lucene and Solr index backends.\n\nRelated to #284\n\nSigned-off-by: Boxuan Li <liboxuan@connect.hku.hk>", "committedDate": "2021-01-02T14:48:23Z", "type": "commit"}, {"oid": "728ad10f1b8e096adc559657d7ac7d623f012cb6", "url": "https://github.com/JanusGraph/janusgraph/commit/728ad10f1b8e096adc559657d7ac7d623f012cb6", "message": "Add mixed index support for has(key) query\n\nCurrently, has(key) query does not use index at all. This commit\ntries to use mixed index if possible. Geoshape type exists query\nis not supported by Lucene and Solr index backends.\n\nRelated to #284\n\nSigned-off-by: Boxuan Li <liboxuan@connect.hku.hk>", "committedDate": "2021-01-02T14:48:23Z", "type": "forcePushed"}]}