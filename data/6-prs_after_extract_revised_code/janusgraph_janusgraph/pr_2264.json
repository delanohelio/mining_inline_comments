{"pr_number": 2264, "pr_title": "Rewrite testConcurrentConsistencyEnforcement to properly test lock contention", "pr_createdAt": "2020-12-06T03:09:23Z", "pr_url": "https://github.com/JanusGraph/janusgraph/pull/2264", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzEzMTc1Mw==", "url": "https://github.com/JanusGraph/janusgraph/pull/2264#discussion_r537131753", "bodyText": "It would cool to replace these lines with assertThrows.", "author": "farodin91", "createdAt": "2020-12-06T21:52:50Z", "path": "janusgraph-backend-testutils/src/main/java/org/janusgraph/graphdb/JanusGraphTest.java", "diffHunk": "@@ -2959,17 +2960,31 @@ private void executeLockConflictingTransactionJobs(JanusGraph graph, Transaction\n                 tx2.commit();\n                 fail(\"Storage backend does not abort conflicting transactions\");\n             } catch (JanusGraphException ignored) {\n+                Throwable rootCause = ignored.getCause().getCause();\n+                assertTrue(rootCause instanceof PermanentLockingException);\n+                assertTrue(rootCause.getMessage().contains(\"Expected value mismatch for\"));\n             }\n         } else {\n             try {", "originalCommit": "83fbdf7d901f075a5dbca75c0e8bada8959069a4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzE4MzA4OQ==", "url": "https://github.com/JanusGraph/janusgraph/pull/2264#discussion_r537183089", "bodyText": "AFAIK, assertThrows can only assert the outmost exception but not inner exception(s).", "author": "li-boxuan", "createdAt": "2020-12-07T02:05:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzEzMTc1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDQ5NjYzMA==", "url": "https://github.com/JanusGraph/janusgraph/pull/2264#discussion_r550496630", "bodyText": "JanusGraphException janusGraphException = assertThrows(JanusGraphException.class, () -> tx2.commit());\nThrowable rootCause = janusGraphException.getCause().getCause();\nassertTrue(rootCause instanceof PermanentLockingException);\nassertTrue(rootCause.getMessage().contains(\"Expected value mismatch for\"));", "author": "farodin91", "createdAt": "2020-12-31T14:42:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzEzMTc1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDQ5NjY1Ng==", "url": "https://github.com/JanusGraph/janusgraph/pull/2264#discussion_r550496656", "bodyText": "This was my idea.", "author": "farodin91", "createdAt": "2020-12-31T14:42:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzEzMTc1Mw=="}], "type": "inlineReview", "revised_code": {"commit": "d68b8d94ade3c628282e0b486d5e9dad2b2d597e", "chunk": "diff --git a/janusgraph-backend-testutils/src/main/java/org/janusgraph/graphdb/JanusGraphTest.java b/janusgraph-backend-testutils/src/main/java/org/janusgraph/graphdb/JanusGraphTest.java\nindex a373b26bf..04fc31f98 100644\n--- a/janusgraph-backend-testutils/src/main/java/org/janusgraph/graphdb/JanusGraphTest.java\n+++ b/janusgraph-backend-testutils/src/main/java/org/janusgraph/graphdb/JanusGraphTest.java\n\n@@ -2954,27 +2954,17 @@ public abstract class JanusGraphTest extends JanusGraphBaseTest {\n          * Under pessimistic locking, tx1 should abort and tx2 should commit.\n          * Under optimistic locking, tx1 may commit and tx2 may abort.\n          */\n+        JanusGraphException janusGraphException;\n         if (isLockingOptimistic()) {\n             tx1.commit();\n-            try {\n-                tx2.commit();\n-                fail(\"Storage backend does not abort conflicting transactions\");\n-            } catch (JanusGraphException ignored) {\n-                Throwable rootCause = ignored.getCause().getCause();\n-                assertTrue(rootCause instanceof PermanentLockingException);\n-                assertTrue(rootCause.getMessage().contains(\"Expected value mismatch for\"));\n-            }\n+            janusGraphException = assertThrows(JanusGraphException.class, () -> tx2.commit());\n         } else {\n-            try {\n-                tx1.commit();\n-                fail(\"Storage backend does not abort conflicting transactions\");\n-            } catch (JanusGraphException ignored) {\n-                Throwable rootCause = ignored.getCause().getCause();\n-                assertTrue(rootCause instanceof PermanentLockingException);\n-                assertTrue(rootCause.getMessage().contains(\"Expected value mismatch for\"));\n-            }\n+            janusGraphException = assertThrows(JanusGraphException.class, () -> tx1.commit());\n             tx2.commit();\n         }\n+        Throwable rootCause = janusGraphException.getCause().getCause();\n+        assertTrue(rootCause instanceof PermanentLockingException);\n+        assertTrue(rootCause.getMessage().contains(\"Expected value mismatch for\"));\n     }\n \n     /**\n"}}, {"oid": "98ab0776a9d3deceffd91dcca5cc80ded53afa3f", "url": "https://github.com/JanusGraph/janusgraph/commit/98ab0776a9d3deceffd91dcca5cc80ded53afa3f", "message": "Rewrite testConcurrentConsistencyEnforcement to properly test lock contention\n\nSigned-off-by: Boxuan Li <liboxuan@connect.hku.hk>", "committedDate": "2020-12-30T14:18:23Z", "type": "forcePushed"}, {"oid": "d68b8d94ade3c628282e0b486d5e9dad2b2d597e", "url": "https://github.com/JanusGraph/janusgraph/commit/d68b8d94ade3c628282e0b486d5e9dad2b2d597e", "message": "Rewrite testConcurrentConsistencyEnforcement to properly test lock contention\n\nSigned-off-by: Boxuan Li <liboxuan@connect.hku.hk>", "committedDate": "2021-01-01T02:56:19Z", "type": "commit"}, {"oid": "d68b8d94ade3c628282e0b486d5e9dad2b2d597e", "url": "https://github.com/JanusGraph/janusgraph/commit/d68b8d94ade3c628282e0b486d5e9dad2b2d597e", "message": "Rewrite testConcurrentConsistencyEnforcement to properly test lock contention\n\nSigned-off-by: Boxuan Li <liboxuan@connect.hku.hk>", "committedDate": "2021-01-01T02:56:19Z", "type": "forcePushed"}]}