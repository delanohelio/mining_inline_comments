{"pr_number": 2198, "pr_title": "Allow nesting CONTAIN predicates with and/or", "pr_createdAt": "2020-09-01T12:57:15Z", "pr_url": "https://github.com/JanusGraph/janusgraph/pull/2198", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzM2ODAwMQ==", "url": "https://github.com/JanusGraph/janusgraph/pull/2198#discussion_r487368001", "bodyText": "This would fail the test\nassertEquals(3, g.V().or(__.has(\"id\", P.within(2, 3, 4)), __.has(\"id\", P.within())).count().next());", "author": "li-boxuan", "createdAt": "2020-09-12T04:51:46Z", "path": "janusgraph-core/src/main/java/org/janusgraph/graphdb/query/QueryUtil.java", "diffHunk": "@@ -241,7 +262,29 @@ public static boolean isEmpty(Condition<?> condition) {\n     private static <E extends JanusGraphElement> Or<E> addConstraint(final RelationType type, OrJanusPredicate predicate, List<Object> values, Or<E> or, StandardJanusGraphTx tx) {\n         for (int i = 0 ; i < values.size(); i++) {\n             final JanusGraphPredicate janusGraphPredicate = predicate.get(i);\n-            if (janusGraphPredicate instanceof AndJanusPredicate) {\n+            if (janusGraphPredicate instanceof Contain) {\n+                //Rewrite contains conditions\n+                final Collection childValues = (Collection) values.get(i);\n+                if (janusGraphPredicate == Contain.NOT_IN) {\n+                    if (childValues.isEmpty()) continue; //Simply ignore since trivially satisfied\n+                    if (childValues.size() == 1) {\n+                        addConstraint(type, Cmp.NOT_EQUAL, childValues.iterator().next(), or, tx);\n+                    }\n+                    final And<E> nested = new And<>(childValues.size());\n+                    for (final Object inValue : childValues) {\n+                        addConstraint(type, Cmp.NOT_EQUAL, inValue, nested, tx);\n+                    }\n+                    or.add(nested);\n+                } else {\n+                    Preconditions.checkArgument(janusGraphPredicate == Contain.IN);\n+                    if (childValues.isEmpty()) {\n+                        return null; //Cannot be satisfied", "originalCommit": "6f6b481e19e5332896a9ca12ef5bdccd08b25bc6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzY2MDE3Mg==", "url": "https://github.com/JanusGraph/janusgraph/pull/2198#discussion_r487660172", "bodyText": "Thanks for the review. Basically needed to change two lines within the definition of OR to catch that bug. I updated the branch by pushing a separate commit containing the fix so it is easier to review.\nAlso added 14 new test cases which cover all of the empty argument cases as well as some previously untested combinations of with and without cases. If you can find different combinations worth testing, please let me know.", "author": "rngcntr", "createdAt": "2020-09-14T05:31:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzM2ODAwMQ=="}], "type": "inlineReview", "revised_code": {"commit": "73fa20aba135ac7f98e033eb4f0c3a156bc6f106", "chunk": "diff --git a/janusgraph-core/src/main/java/org/janusgraph/graphdb/query/QueryUtil.java b/janusgraph-core/src/main/java/org/janusgraph/graphdb/query/QueryUtil.java\nindex 409b5f504..68c8e223d 100644\n--- a/janusgraph-core/src/main/java/org/janusgraph/graphdb/query/QueryUtil.java\n+++ b/janusgraph-core/src/main/java/org/janusgraph/graphdb/query/QueryUtil.java\n\n@@ -266,10 +266,11 @@ public class QueryUtil {\n                 //Rewrite contains conditions\n                 final Collection childValues = (Collection) values.get(i);\n                 if (janusGraphPredicate == Contain.NOT_IN) {\n-                    if (childValues.isEmpty()) continue; //Simply ignore since trivially satisfied\n                     if (childValues.size() == 1) {\n                         addConstraint(type, Cmp.NOT_EQUAL, childValues.iterator().next(), or, tx);\n                     }\n+                    // Don't need to handle the case where childValues is empty, because it defaults to\n+                    // an or(and()) is added, which is a tautology\n                     final And<E> nested = new And<>(childValues.size());\n                     for (final Object inValue : childValues) {\n                         addConstraint(type, Cmp.NOT_EQUAL, inValue, nested, tx);\n"}}, {"oid": "73fa20aba135ac7f98e033eb4f0c3a156bc6f106", "url": "https://github.com/JanusGraph/janusgraph/commit/73fa20aba135ac7f98e033eb4f0c3a156bc6f106", "message": "Fix broken logic for or() constraints in QueryUtil\n\nSigned-off-by: Florian Grieskamp <florian.grieskamp@gdata.de>", "committedDate": "2020-09-14T05:32:11Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQ5MjkzOQ==", "url": "https://github.com/JanusGraph/janusgraph/pull/2198#discussion_r489492939", "bodyText": "I wonder if there is any performance difference between:\nOR(NOT_EQUAL(x) AND NOT_EQUAL(y))\nv.s.\nOR(NOT_EQUAL(x)) OR(NOT_EQUAL(y))?", "author": "li-boxuan", "createdAt": "2020-09-16T14:42:25Z", "path": "janusgraph-core/src/main/java/org/janusgraph/graphdb/query/QueryUtil.java", "diffHunk": "@@ -241,7 +262,30 @@ public static boolean isEmpty(Condition<?> condition) {\n     private static <E extends JanusGraphElement> Or<E> addConstraint(final RelationType type, OrJanusPredicate predicate, List<Object> values, Or<E> or, StandardJanusGraphTx tx) {\n         for (int i = 0 ; i < values.size(); i++) {\n             final JanusGraphPredicate janusGraphPredicate = predicate.get(i);\n-            if (janusGraphPredicate instanceof AndJanusPredicate) {\n+            if (janusGraphPredicate instanceof Contain) {\n+                //Rewrite contains conditions\n+                final Collection childValues = (Collection) values.get(i);\n+                if (janusGraphPredicate == Contain.NOT_IN) {\n+                    if (childValues.size() == 1) {\n+                        addConstraint(type, Cmp.NOT_EQUAL, childValues.iterator().next(), or, tx);\n+                    }\n+                    // Don't need to handle the case where childValues is empty, because it defaults to\n+                    // an or(and()) is added, which is a tautology\n+                    final And<E> nested = new And<>(childValues.size());\n+                    for (final Object inValue : childValues) {\n+                        addConstraint(type, Cmp.NOT_EQUAL, inValue, nested, tx);\n+                    }\n+                    or.add(nested);", "originalCommit": "73fa20aba135ac7f98e033eb4f0c3a156bc6f106", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTk3ODg2Mw==", "url": "https://github.com/JanusGraph/janusgraph/pull/2198#discussion_r489978863", "bodyText": "I don't quite get your point here. It looks like your second case is missing a logical operator between the two ORs. Anyway, I can't spot what kind of possible change in the code you refer to, in order to create one or the other of your examples.", "author": "rngcntr", "createdAt": "2020-09-17T05:27:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQ5MjkzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDE5MzM5NQ==", "url": "https://github.com/JanusGraph/janusgraph/pull/2198#discussion_r490193395", "bodyText": "Oh never mind, I got it wrong", "author": "li-boxuan", "createdAt": "2020-09-17T12:10:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQ5MjkzOQ=="}], "type": "inlineReview", "revised_code": {"commit": "aa522d55751503ea33408c82cbf82a1349d276a7", "chunk": "diff --git a/janusgraph-core/src/main/java/org/janusgraph/graphdb/query/QueryUtil.java b/janusgraph-core/src/main/java/org/janusgraph/graphdb/query/QueryUtil.java\nindex 68c8e223d..04e7d673e 100644\n--- a/janusgraph-core/src/main/java/org/janusgraph/graphdb/query/QueryUtil.java\n+++ b/janusgraph-core/src/main/java/org/janusgraph/graphdb/query/QueryUtil.java\n\n@@ -279,7 +279,7 @@ public class QueryUtil {\n                 } else {\n                     Preconditions.checkArgument(janusGraphPredicate == Contain.IN);\n                     if (childValues.isEmpty()) {\n-                        continue; // Handle unsatisfiable condition within or like it does not exist\n+                        continue; // Handle any unsatisfiable condition that occurs within an OR statement like it does not exist\n                     }\n                     for (final Object inValue : childValues) {\n                         addConstraint(type, Cmp.EQUAL, inValue, or, tx);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQ5Mzc5MQ==", "url": "https://github.com/JanusGraph/janusgraph/pull/2198#discussion_r489493791", "bodyText": "I understand they are semantically the same, but will there be a performance difference (even if very little)?", "author": "li-boxuan", "createdAt": "2020-09-16T14:43:33Z", "path": "janusgraph-core/src/main/java/org/janusgraph/graphdb/query/QueryUtil.java", "diffHunk": "@@ -241,7 +262,30 @@ public static boolean isEmpty(Condition<?> condition) {\n     private static <E extends JanusGraphElement> Or<E> addConstraint(final RelationType type, OrJanusPredicate predicate, List<Object> values, Or<E> or, StandardJanusGraphTx tx) {\n         for (int i = 0 ; i < values.size(); i++) {\n             final JanusGraphPredicate janusGraphPredicate = predicate.get(i);\n-            if (janusGraphPredicate instanceof AndJanusPredicate) {\n+            if (janusGraphPredicate instanceof Contain) {\n+                //Rewrite contains conditions\n+                final Collection childValues = (Collection) values.get(i);\n+                if (janusGraphPredicate == Contain.NOT_IN) {\n+                    if (childValues.size() == 1) {\n+                        addConstraint(type, Cmp.NOT_EQUAL, childValues.iterator().next(), or, tx);\n+                    }\n+                    // Don't need to handle the case where childValues is empty, because it defaults to\n+                    // an or(and()) is added, which is a tautology", "originalCommit": "73fa20aba135ac7f98e033eb4f0c3a156bc6f106", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTk3NjExOQ==", "url": "https://github.com/JanusGraph/janusgraph/pull/2198#discussion_r489976119", "bodyText": "There may be a little difference in performance, but the empty and actually serves a functional purpose. Otherwise the surrounding or can be empty which results in or() being evaluated as false instead of or(and()) which is true.", "author": "rngcntr", "createdAt": "2020-09-17T05:17:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQ5Mzc5MQ=="}], "type": "inlineReview", "revised_code": {"commit": "aa522d55751503ea33408c82cbf82a1349d276a7", "chunk": "diff --git a/janusgraph-core/src/main/java/org/janusgraph/graphdb/query/QueryUtil.java b/janusgraph-core/src/main/java/org/janusgraph/graphdb/query/QueryUtil.java\nindex 68c8e223d..04e7d673e 100644\n--- a/janusgraph-core/src/main/java/org/janusgraph/graphdb/query/QueryUtil.java\n+++ b/janusgraph-core/src/main/java/org/janusgraph/graphdb/query/QueryUtil.java\n\n@@ -279,7 +279,7 @@ public class QueryUtil {\n                 } else {\n                     Preconditions.checkArgument(janusGraphPredicate == Contain.IN);\n                     if (childValues.isEmpty()) {\n-                        continue; // Handle unsatisfiable condition within or like it does not exist\n+                        continue; // Handle any unsatisfiable condition that occurs within an OR statement like it does not exist\n                     }\n                     for (final Object inValue : childValues) {\n                         addConstraint(type, Cmp.EQUAL, inValue, or, tx);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQ5NjYyNg==", "url": "https://github.com/JanusGraph/janusgraph/pull/2198#discussion_r489496626", "bodyText": "nitpick: it took me a while to understand the comment. I guess you mean \"Handle unsatisfiable condition or(within()) like it does not exist\"", "author": "li-boxuan", "createdAt": "2020-09-16T14:47:08Z", "path": "janusgraph-core/src/main/java/org/janusgraph/graphdb/query/QueryUtil.java", "diffHunk": "@@ -241,7 +262,30 @@ public static boolean isEmpty(Condition<?> condition) {\n     private static <E extends JanusGraphElement> Or<E> addConstraint(final RelationType type, OrJanusPredicate predicate, List<Object> values, Or<E> or, StandardJanusGraphTx tx) {\n         for (int i = 0 ; i < values.size(); i++) {\n             final JanusGraphPredicate janusGraphPredicate = predicate.get(i);\n-            if (janusGraphPredicate instanceof AndJanusPredicate) {\n+            if (janusGraphPredicate instanceof Contain) {\n+                //Rewrite contains conditions\n+                final Collection childValues = (Collection) values.get(i);\n+                if (janusGraphPredicate == Contain.NOT_IN) {\n+                    if (childValues.size() == 1) {\n+                        addConstraint(type, Cmp.NOT_EQUAL, childValues.iterator().next(), or, tx);\n+                    }\n+                    // Don't need to handle the case where childValues is empty, because it defaults to\n+                    // an or(and()) is added, which is a tautology\n+                    final And<E> nested = new And<>(childValues.size());\n+                    for (final Object inValue : childValues) {\n+                        addConstraint(type, Cmp.NOT_EQUAL, inValue, nested, tx);\n+                    }\n+                    or.add(nested);\n+                } else {\n+                    Preconditions.checkArgument(janusGraphPredicate == Contain.IN);\n+                    if (childValues.isEmpty()) {\n+                        continue; // Handle unsatisfiable condition within or like it does not exist", "originalCommit": "73fa20aba135ac7f98e033eb4f0c3a156bc6f106", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTk3OTMxMw==", "url": "https://github.com/JanusGraph/janusgraph/pull/2198#discussion_r489979313", "bodyText": "It was actually meant to say \"Handle any unsatisfiable condition within an OR statement like it does not exist.\"", "author": "rngcntr", "createdAt": "2020-09-17T05:28:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQ5NjYyNg=="}], "type": "inlineReview", "revised_code": {"commit": "aa522d55751503ea33408c82cbf82a1349d276a7", "chunk": "diff --git a/janusgraph-core/src/main/java/org/janusgraph/graphdb/query/QueryUtil.java b/janusgraph-core/src/main/java/org/janusgraph/graphdb/query/QueryUtil.java\nindex 68c8e223d..04e7d673e 100644\n--- a/janusgraph-core/src/main/java/org/janusgraph/graphdb/query/QueryUtil.java\n+++ b/janusgraph-core/src/main/java/org/janusgraph/graphdb/query/QueryUtil.java\n\n@@ -279,7 +279,7 @@ public class QueryUtil {\n                 } else {\n                     Preconditions.checkArgument(janusGraphPredicate == Contain.IN);\n                     if (childValues.isEmpty()) {\n-                        continue; // Handle unsatisfiable condition within or like it does not exist\n+                        continue; // Handle any unsatisfiable condition that occurs within an OR statement like it does not exist\n                     }\n                     for (final Object inValue : childValues) {\n                         addConstraint(type, Cmp.EQUAL, inValue, or, tx);\n"}}, {"oid": "aa522d55751503ea33408c82cbf82a1349d276a7", "url": "https://github.com/JanusGraph/janusgraph/commit/aa522d55751503ea33408c82cbf82a1349d276a7", "message": "Fix broken logic for or() constraints in QueryUtil\n\nSigned-off-by: Florian Grieskamp <florian.grieskamp@gdata.de>", "committedDate": "2020-09-17T05:31:39Z", "type": "forcePushed"}, {"oid": "d728a4784460f44fedc04983478850422466f961", "url": "https://github.com/JanusGraph/janusgraph/commit/d728a4784460f44fedc04983478850422466f961", "message": "Allow nesting CONTAIN predicates with and/or\n\nSigned-off-by: Florian Grieskamp <florian.grieskamp@gdata.de>", "committedDate": "2020-09-17T13:15:26Z", "type": "commit"}, {"oid": "d728a4784460f44fedc04983478850422466f961", "url": "https://github.com/JanusGraph/janusgraph/commit/d728a4784460f44fedc04983478850422466f961", "message": "Allow nesting CONTAIN predicates with and/or\n\nSigned-off-by: Florian Grieskamp <florian.grieskamp@gdata.de>", "committedDate": "2020-09-17T13:15:26Z", "type": "forcePushed"}]}