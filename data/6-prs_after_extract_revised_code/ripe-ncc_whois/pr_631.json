{"pr_number": 631, "pr_title": "Fulltext search optimize", "pr_createdAt": "2020-05-07T10:24:15Z", "pr_url": "https://github.com/RIPE-NCC/whois/pull/631", "timeline": [{"oid": "a0ab06f9a92733c49828a04f0e51ed394bd2e837", "url": "https://github.com/RIPE-NCC/whois/commit/a0ab06f9a92733c49828a04f0e51ed394bd2e837", "message": "get rpslobject from database", "committedDate": "2020-04-30T10:20:28Z", "type": "commit"}, {"oid": "7a0ea0e012e97161159c32afeff72e24aad4e4b0", "url": "https://github.com/RIPE-NCC/whois/commit/7a0ea0e012e97161159c32afeff72e24aad4e4b0", "message": "highlight string in lucene", "committedDate": "2020-04-30T14:12:11Z", "type": "commit"}, {"oid": "f3e0696dc89db1882c67e4853cde561703bb52ff", "url": "https://github.com/RIPE-NCC/whois/commit/f3e0696dc89db1882c67e4853cde561703bb52ff", "message": "fulltext search AutoComplete", "committedDate": "2020-05-04T08:50:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk0MDMxNg==", "url": "https://github.com/RIPE-NCC/whois/pull/631#discussion_r430940316", "bodyText": "Rename to rpslObjectDao for consistency", "author": "eshryane", "createdAt": "2020-05-27T08:20:41Z", "path": "whois-api/src/main/java/net/ripe/db/whois/api/autocomplete/AutocompleteSearch.java", "diffHunk": "@@ -52,9 +56,12 @@\n \n     private final FullTextIndex fullTextIndex;\n \n+    private final RpslObjectDao objectDao;\n+\n     @Autowired\n-    public AutocompleteSearch(final FullTextIndex fullTextIndex) {\n+    public AutocompleteSearch(final FullTextIndex fullTextIndex, @Qualifier(\"jdbcRpslObjectSlaveDao\") final RpslObjectDao objectDao) {", "originalCommit": "f3e0696dc89db1882c67e4853cde561703bb52ff", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e49e76220e1ae14c0cf14ca407ace62279dfcd80", "chunk": "diff --git a/whois-api/src/main/java/net/ripe/db/whois/api/autocomplete/AutocompleteSearch.java b/whois-api/src/main/java/net/ripe/db/whois/api/autocomplete/AutocompleteSearch.java\nindex 09dc8d62b..78ab218a7 100644\n--- a/whois-api/src/main/java/net/ripe/db/whois/api/autocomplete/AutocompleteSearch.java\n+++ b/whois-api/src/main/java/net/ripe/db/whois/api/autocomplete/AutocompleteSearch.java\n\n@@ -59,9 +60,9 @@ public class AutocompleteSearch {\n     private final RpslObjectDao objectDao;\n \n     @Autowired\n-    public AutocompleteSearch(final FullTextIndex fullTextIndex, @Qualifier(\"jdbcRpslObjectSlaveDao\") final RpslObjectDao objectDao) {\n+    public AutocompleteSearch(final FullTextIndex fullTextIndex, @Qualifier(\"jdbcRpslObjectSlaveDao\") final RpslObjectDao rpslObjectDao) {\n         this.fullTextIndex = fullTextIndex;\n-        this.objectDao = objectDao;\n+        this.objectDao = rpslObjectDao;\n     }\n \n     public List<Map<String, Object>> search(\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk0MTg0MQ==", "url": "https://github.com/RIPE-NCC/whois/pull/631#discussion_r430941841", "bodyText": "Handle EmptyResultDataAccessException here (MariaDB and Lucene may be out of sync)", "author": "eshryane", "createdAt": "2020-05-27T08:23:18Z", "path": "whois-api/src/main/java/net/ripe/db/whois/api/autocomplete/AutocompleteSearch.java", "diffHunk": "@@ -88,17 +95,22 @@ public AutocompleteSearch(final FullTextIndex fullTextIndex) {\n                 for (ScoreDoc scoreDoc : topDocs.scoreDocs) {\n                     final Document doc = indexSearcher.doc(scoreDoc.doc);\n                     final Map<String, Object> result = Maps.newLinkedHashMap();\n-                    result.put(\"key\", doc.get(FullTextIndex.LOOKUP_KEY_FIELD_NAME));\n-                    result.put(\"type\", doc.get(FullTextIndex.OBJECT_TYPE_FIELD_NAME));\n+\n+                    final RpslObject rpslObject =   objectDao.getByKey(", "originalCommit": "f3e0696dc89db1882c67e4853cde561703bb52ff", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e49e76220e1ae14c0cf14ca407ace62279dfcd80", "chunk": "diff --git a/whois-api/src/main/java/net/ripe/db/whois/api/autocomplete/AutocompleteSearch.java b/whois-api/src/main/java/net/ripe/db/whois/api/autocomplete/AutocompleteSearch.java\nindex 09dc8d62b..78ab218a7 100644\n--- a/whois-api/src/main/java/net/ripe/db/whois/api/autocomplete/AutocompleteSearch.java\n+++ b/whois-api/src/main/java/net/ripe/db/whois/api/autocomplete/AutocompleteSearch.java\n\n@@ -95,11 +96,18 @@ public class AutocompleteSearch {\n                 for (ScoreDoc scoreDoc : topDocs.scoreDocs) {\n                     final Document doc = indexSearcher.doc(scoreDoc.doc);\n                     final Map<String, Object> result = Maps.newLinkedHashMap();\n+                    final RpslObject rpslObject;\n \n-                    final RpslObject rpslObject =   objectDao.getByKey(\n-                                                                ObjectType.getByName(doc.get(FullTextIndex.OBJECT_TYPE_FIELD_NAME)),\n-                                                                doc.get(FullTextIndex.LOOKUP_KEY_FIELD_NAME)\n-                                                              );\n+                    try {\n+                        rpslObject =   objectDao.getByKey(\n+                                            ObjectType.getByName(doc.get(FullTextIndex.OBJECT_TYPE_FIELD_NAME)),\n+                                            doc.get(FullTextIndex.LOOKUP_KEY_FIELD_NAME)\n+                                        );\n+\n+                    } catch (EmptyResultDataAccessException ex) {\n+                        LOGGER.info(\"seems like object has been deleted from database\");\n+                        continue;\n+                    }\n \n                     result.put(\"key\", rpslObject.getKey().toString());\n                     result.put(\"type\", rpslObject.getType().getName());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk0MzA3NQ==", "url": "https://github.com/RIPE-NCC/whois/pull/631#discussion_r430943075", "bodyText": "Rename to rpslObjectDao for consistency", "author": "eshryane", "createdAt": "2020-05-27T08:25:15Z", "path": "whois-api/src/main/java/net/ripe/db/whois/api/fulltextsearch/FullTextSearch.java", "diffHunk": "@@ -69,15 +75,18 @@\n     private final AccessControlListManager accessControlListManager;\n     private final Source source;\n     private final Version version;\n+    private final RpslObjectDao objectDao;\n \n     @Autowired\n     public FullTextSearch(final FullTextIndex fullTextIndex,\n+                          @Qualifier(\"jdbcRpslObjectSlaveDao\") final RpslObjectDao objectDao,", "originalCommit": "f3e0696dc89db1882c67e4853cde561703bb52ff", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e49e76220e1ae14c0cf14ca407ace62279dfcd80", "chunk": "diff --git a/whois-api/src/main/java/net/ripe/db/whois/api/fulltextsearch/FullTextSearch.java b/whois-api/src/main/java/net/ripe/db/whois/api/fulltextsearch/FullTextSearch.java\nindex a2c35e1f0..6e34cff41 100644\n--- a/whois-api/src/main/java/net/ripe/db/whois/api/fulltextsearch/FullTextSearch.java\n+++ b/whois-api/src/main/java/net/ripe/db/whois/api/fulltextsearch/FullTextSearch.java\n\n@@ -79,14 +79,14 @@ public class FullTextSearch {\n \n     @Autowired\n     public FullTextSearch(final FullTextIndex fullTextIndex,\n-                          @Qualifier(\"jdbcRpslObjectSlaveDao\") final RpslObjectDao objectDao,\n+                          @Qualifier(\"jdbcRpslObjectSlaveDao\") final RpslObjectDao rpslObjectDao,\n                           final AccessControlListManager accessControlListManager,\n                           final SourceContext sourceContext,\n                           final ApplicationVersion applicationVersion) {\n         this.fullTextIndex = fullTextIndex;\n         this.accessControlListManager = accessControlListManager;\n         this.source = sourceContext.getCurrentSource();\n-        this.objectDao = objectDao;\n+        this.objectDao = rpslObjectDao;\n         this.version = new Version(\n             applicationVersion.getVersion(),\n             applicationVersion.getTimestamp(),\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk1MjMwNw==", "url": "https://github.com/RIPE-NCC/whois/pull/631#discussion_r430952307", "bodyText": "I would flip this Map around (document with a matching RpslObject) or create a list of \"pairs\"", "author": "eshryane", "createdAt": "2020-05-27T08:40:16Z", "path": "whois-api/src/main/java/net/ripe/db/whois/api/fulltextsearch/FullTextSearch.java", "diffHunk": "@@ -164,23 +173,24 @@ protected SearchResponse doSearch(final IndexReader indexReader, final TaxonomyR\n \n                     indexSearcher.search(query, MultiCollector.wrap(topFieldCollector, facetsCollector));\n \n-                    final List<Document> documents = Lists.newArrayList();\n+                    final Map<RpslObject, Document> rpslObjectToDocument = Maps.newHashMap();", "originalCommit": "f3e0696dc89db1882c67e4853cde561703bb52ff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTcxNTAyMg==", "url": "https://github.com/RIPE-NCC/whois/pull/631#discussion_r431715022", "bodyText": "I would rely on Rpslobject as key  rather then luecene document. As Rpslobject have our own implementation of  equals and hashcode", "author": "maggarwal13", "createdAt": "2020-05-28T09:49:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk1MjMwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjMwODg0NA==", "url": "https://github.com/RIPE-NCC/whois/pull/631#discussion_r432308844", "bodyText": "Good point, thanks!", "author": "eshryane", "createdAt": "2020-05-29T07:39:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk1MjMwNw=="}], "type": "inlineReview", "revised_code": {"commit": "a36039a6f4b10063559e6474c04edc058dcf9e0c", "chunk": "diff --git a/whois-api/src/main/java/net/ripe/db/whois/api/fulltextsearch/FullTextSearch.java b/whois-api/src/main/java/net/ripe/db/whois/api/fulltextsearch/FullTextSearch.java\nindex a2c35e1f0..1f796a9db 100644\n--- a/whois-api/src/main/java/net/ripe/db/whois/api/fulltextsearch/FullTextSearch.java\n+++ b/whois-api/src/main/java/net/ripe/db/whois/api/fulltextsearch/FullTextSearch.java\n\n@@ -167,8 +170,7 @@ public class FullTextSearch {\n                 @Override\n                 protected SearchResponse doSearch(final IndexReader indexReader, final TaxonomyReader taxonomyReader, final IndexSearcher indexSearcher) throws IOException {\n \n-                    final int maxResults = Math.max(MAX_RESULTS, indexReader.numDocs());\n-                    final TopFieldCollector topFieldCollector = TopFieldCollector.create(SORT_BY_OBJECT_TYPE, maxResults, false, false, false, true);\n+                    final TopFieldCollector topFieldCollector = TopFieldCollector.create(SORT_BY_OBJECT_TYPE, maxResultSize, false, false, false, true);\n                     final FacetsCollector facetsCollector = new FacetsCollector();\n \n                     indexSearcher.search(query, MultiCollector.wrap(topFieldCollector, facetsCollector));\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk1MzIzNA==", "url": "https://github.com/RIPE-NCC/whois/pull/631#discussion_r430953234", "bodyText": "If this should never happen, then Throw IllegalStateException", "author": "eshryane", "createdAt": "2020-05-27T08:41:50Z", "path": "whois-api/src/main/java/net/ripe/db/whois/api/fulltextsearch/IndexTemplate.java", "diffHunk": "@@ -229,24 +229,17 @@ protected void account(final RpslObject rpslObject) {\n             }\n         }\n \n-        protected RpslObject convertToRpslObject(Document document) {\n-            final List<RpslAttribute> attributes = Lists.newArrayList();\n-            int objectId = 0;\n-\n+        protected int getObjectId(Document document) {\n             for (final IndexableField field : document.getFields()) {\n                 if (SEARCH_INDEX_FIELDS_NOT_MAPPED_TO_RPSL_OBJECT.contains(field.name())) {\n                     if (\"primary-key\".equals(field.name())) {\n-                        objectId = Integer.parseInt(field.stringValue());\n+                        return  Integer.parseInt(field.stringValue());\n                     }\n-                } else {\n-                    attributes.add(new RpslAttribute(AttributeType.getByName(field.name()), field.stringValue()));\n                 }\n             }\n \n-            attributes.add(new RpslAttribute(AttributeType.SOURCE, source.getName()));\n-            return new RpslObject(objectId, attributes);\n+           return 0;", "originalCommit": "f3e0696dc89db1882c67e4853cde561703bb52ff", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e49e76220e1ae14c0cf14ca407ace62279dfcd80", "chunk": "diff --git a/whois-api/src/main/java/net/ripe/db/whois/api/fulltextsearch/IndexTemplate.java b/whois-api/src/main/java/net/ripe/db/whois/api/fulltextsearch/IndexTemplate.java\nindex 95eeee1e6..782b4f79f 100644\n--- a/whois-api/src/main/java/net/ripe/db/whois/api/fulltextsearch/IndexTemplate.java\n+++ b/whois-api/src/main/java/net/ripe/db/whois/api/fulltextsearch/IndexTemplate.java\n\n@@ -238,7 +238,7 @@ public class IndexTemplate implements Closeable {\n                 }\n             }\n \n-           return 0;\n+           throw new IllegalStateException(\"luecene index should always have a primary key stored\");\n         }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk2MTA2NQ==", "url": "https://github.com/RIPE-NCC/whois/pull/631#discussion_r430961065", "bodyText": "Remove this commented block altogether?", "author": "eshryane", "createdAt": "2020-05-27T08:54:34Z", "path": "whois-api/src/main/java/net/ripe/db/whois/api/fulltextsearch/FullTextIndex.java", "diffHunk": "@@ -289,30 +293,54 @@ private void addEntry(final IndexWriter indexWriter, final TaxonomyWriter taxono\n         document.add(new SortedDocValuesField(LOOKUP_KEY_FIELD_NAME, new BytesRef(rpslObject.getKey().toString())));\n         document.add(new StringField(LOOKUP_KEY_FIELD_NAME, rpslObject.getKey().toString(), Field.Store.YES));\n \n-        for (final RpslAttribute attribute : rpslObject.getAttributes()) {\n-            if (FILTERED_ATTRIBUTES.contains(attribute.getType())) {\n-                document.add(new Field(attribute.getKey(), sanitise(filterAttribute(attribute.getValue().trim())), FILTERED_ATTRIBUTE_FIELD_TYPE));\n-\n-            } else if (!SKIPPED_ATTRIBUTES.contains(attribute.getType())) {\n-                document.add(new Field(attribute.getKey(), sanitise(attribute.getValue().trim()), ATTRIBUTE_FIELD_TYPE));\n-            }\n+        for (final RpslAttribute attribute : filterRpslObject(rpslObject).getAttributes()) {\n+            document.add(new Field(attribute.getKey(), attribute.getValue().trim(), FILTERED_ATTRIBUTES.contains(attribute.getType()) ? FILTERED_ATTRIBUTE_FIELD_TYPE : ATTRIBUTE_FIELD_TYPE));\n         }\n \n         document.add(new FacetField(OBJECT_TYPE_FIELD_NAME, rpslObject.getType().getName()));\n \n         indexWriter.addDocument(facetsConfig.build(taxonomyWriter, document));\n     }\n \n+    public RpslObject filterRpslObject(final RpslObject rpslObject) {\n+\n+        List<RpslAttribute> attributes = Lists.newArrayList();\n+\n+        for (final RpslAttribute attribute : rpslObject.getAttributes()) {\n+            if (SKIPPED_ATTRIBUTES.contains(attribute.getType())) {\n+                continue;\n+            }\n+\n+            attributes.add(new RpslAttribute(attribute.getKey(), filterRpslAttribute(attribute.getType(), attribute.getValue())));\n+        }\n+\n+        return new RpslObject(rpslObject.getObjectId(), attributes);\n+    }\n+\n+    //need to filter as list (not set) as two AUTH MD5 after filter will return 1 entry in set", "originalCommit": "f3e0696dc89db1882c67e4853cde561703bb52ff", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e49e76220e1ae14c0cf14ca407ace62279dfcd80", "chunk": "diff --git a/whois-api/src/main/java/net/ripe/db/whois/api/fulltextsearch/FullTextIndex.java b/whois-api/src/main/java/net/ripe/db/whois/api/fulltextsearch/FullTextIndex.java\nindex 1aac74ade..c103ca740 100644\n--- a/whois-api/src/main/java/net/ripe/db/whois/api/fulltextsearch/FullTextIndex.java\n+++ b/whois-api/src/main/java/net/ripe/db/whois/api/fulltextsearch/FullTextIndex.java\n\n@@ -316,12 +316,7 @@ public class FullTextIndex extends RebuildableIndex {\n \n         return new RpslObject(rpslObject.getObjectId(), attributes);\n     }\n-\n-    //need to filter as list (not set) as two AUTH MD5 after filter will return 1 entry in set\n-   /* public List<String> filterRpslAttribute(final AttributeType attributeType, final Set<String> attributeValues) {\n-        return attributeValues.stream().map((value) -> filterRpslAttribute(attributeType, value)).collect(Collectors.toList());\n-    }*/\n-\n+    \n     public String filterRpslAttribute(final AttributeType attributeType, final String attributeValue) {\n \n         if (FILTERED_ATTRIBUTES.contains(attributeType)) {\n"}}, {"oid": "e49e76220e1ae14c0cf14ca407ace62279dfcd80", "url": "https://github.com/RIPE-NCC/whois/commit/e49e76220e1ae14c0cf14ca407ace62279dfcd80", "message": "Ed suggestions", "committedDate": "2020-05-28T09:52:33Z", "type": "commit"}, {"oid": "a36039a6f4b10063559e6474c04edc058dcf9e0c", "url": "https://github.com/RIPE-NCC/whois/commit/a36039a6f4b10063559e6474c04edc058dcf9e0c", "message": "Rdap query limit (#632)\n\n* rdap limit query result\r\n\r\n* add test cases and notice banner for rdap\r\n\r\n* correct typo mistake\r\n\r\n* fulltext search limit 100\r\n\r\n* add test\r\n\r\n* implement Ed suggestions\r\n\r\n* change comment text", "committedDate": "2020-05-29T08:13:13Z", "type": "commit"}]}