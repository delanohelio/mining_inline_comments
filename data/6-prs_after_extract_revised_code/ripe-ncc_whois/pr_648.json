{"pr_number": 648, "pr_title": "Rdap cors changes", "pr_createdAt": "2020-08-04T09:34:43Z", "pr_url": "https://github.com/RIPE-NCC/whois/pull/648", "timeline": [{"oid": "6b8f4998d91f9257f46dbccf37dd466df903e360", "url": "https://github.com/RIPE-NCC/whois/commit/6b8f4998d91f9257f46dbccf37dd466df903e360", "message": "rdap cors changes", "committedDate": "2020-08-03T11:15:48Z", "type": "commit"}, {"oid": "99e154f55e7e9673fd9daca62fe9054ba3b6b57b", "url": "https://github.com/RIPE-NCC/whois/commit/99e154f55e7e9673fd9daca62fe9054ba3b6b57b", "message": "fix tests", "committedDate": "2020-08-03T13:00:51Z", "type": "commit"}, {"oid": "f06efd931bb98d2be88965e3430a576e369caf3a", "url": "https://github.com/RIPE-NCC/whois/commit/f06efd931bb98d2be88965e3430a576e369caf3a", "message": "Resolved TODO", "committedDate": "2020-08-04T13:02:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTAyNjgwNw==", "url": "https://github.com/RIPE-NCC/whois/pull/648#discussion_r465026807", "bodyText": "Remove setting ALLOWED_ORIGINS_PARAM if \"*\" already the default", "author": "eshryane", "createdAt": "2020-08-04T12:52:37Z", "path": "whois-api/src/main/java/net/ripe/db/whois/api/rdap/WhoisRdapServletDeployer.java", "diffHunk": "@@ -33,7 +35,10 @@ public void deploy(final WebAppContext context) {\n         rdapJsonProvider.configure(SerializationFeature.INDENT_OUTPUT, true);\n \n         // allow cross-origin requests from ANY origin (by default)\n-        context.addFilter(org.eclipse.jetty.servlets.CrossOriginFilter.class, \"/rdap/*\", EnumSet.allOf(DispatcherType.class));\n+        final FilterHolder crossOriginFilterHolder = context.addFilter(org.eclipse.jetty.servlets.CrossOriginFilter.class, \"/rdap/*\", EnumSet.allOf(DispatcherType.class));\n+        crossOriginFilterHolder.setInitParameter(CrossOriginFilter.ALLOW_CREDENTIALS_PARAM, \"false\");\n+        crossOriginFilterHolder.setInitParameter(CrossOriginFilter.ALLOWED_METHODS_PARAM, \"GET, OPTIONS\");\n+        crossOriginFilterHolder.setInitParameter(CrossOriginFilter.ALLOWED_ORIGINS_PARAM, \"*\");", "originalCommit": "99e154f55e7e9673fd9daca62fe9054ba3b6b57b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5be68ee699cb3442bc669bc72599929f0ac12569", "chunk": "diff --git a/whois-api/src/main/java/net/ripe/db/whois/api/rdap/WhoisRdapServletDeployer.java b/whois-api/src/main/java/net/ripe/db/whois/api/rdap/WhoisRdapServletDeployer.java\nindex ea938112e..151aac06d 100644\n--- a/whois-api/src/main/java/net/ripe/db/whois/api/rdap/WhoisRdapServletDeployer.java\n+++ b/whois-api/src/main/java/net/ripe/db/whois/api/rdap/WhoisRdapServletDeployer.java\n\n@@ -38,7 +38,6 @@ public class WhoisRdapServletDeployer implements ServletDeployer {\n         final FilterHolder crossOriginFilterHolder = context.addFilter(org.eclipse.jetty.servlets.CrossOriginFilter.class, \"/rdap/*\", EnumSet.allOf(DispatcherType.class));\n         crossOriginFilterHolder.setInitParameter(CrossOriginFilter.ALLOW_CREDENTIALS_PARAM, \"false\");\n         crossOriginFilterHolder.setInitParameter(CrossOriginFilter.ALLOWED_METHODS_PARAM, \"GET, OPTIONS\");\n-        crossOriginFilterHolder.setInitParameter(CrossOriginFilter.ALLOWED_ORIGINS_PARAM, \"*\");\n \n         final ResourceConfig resourceConfig = new ResourceConfig();\n         resourceConfig.register(whoisRDAPService);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTAyNzcyNw==", "url": "https://github.com/RIPE-NCC/whois/pull/648#discussion_r465027727", "bodyText": "Can you use the same pattern as the other tests, i.e.\nassertThat(response.getHeaderString(HttpHeaders.ACCESS_CONTROL_ALLOW_CREDENTIALS), is(nullValue());", "author": "eshryane", "createdAt": "2020-08-04T12:54:07Z", "path": "whois-api/src/test/java/net/ripe/db/whois/api/rdap/WhoisRdapServiceTestIntegration.java", "diffHunk": "@@ -1778,7 +1779,7 @@ public void cross_origin_preflight_request_from_apps_db_ripe_net_is_allowed() {\n                 .options();\n \n         assertThat(response.getHeaderString(HttpHeaders.ACCESS_CONTROL_ALLOW_ORIGIN), is(\"https://apps.db.ripe.net\"));\n-        assertThat(response.getHeaderString(HttpHeaders.ACCESS_CONTROL_ALLOW_CREDENTIALS), is(\"true\"));\n+        assertNull(response.getHeaderString(HttpHeaders.ACCESS_CONTROL_ALLOW_CREDENTIALS));", "originalCommit": "99e154f55e7e9673fd9daca62fe9054ba3b6b57b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5be68ee699cb3442bc669bc72599929f0ac12569", "chunk": "diff --git a/whois-api/src/test/java/net/ripe/db/whois/api/rdap/WhoisRdapServiceTestIntegration.java b/whois-api/src/test/java/net/ripe/db/whois/api/rdap/WhoisRdapServiceTestIntegration.java\nindex 8de5f110c..a7efd2c0d 100644\n--- a/whois-api/src/test/java/net/ripe/db/whois/api/rdap/WhoisRdapServiceTestIntegration.java\n+++ b/whois-api/src/test/java/net/ripe/db/whois/api/rdap/WhoisRdapServiceTestIntegration.java\n\n@@ -1779,7 +1779,7 @@ public class WhoisRdapServiceTestIntegration extends AbstractRdapIntegrationTest\n                 .options();\n \n         assertThat(response.getHeaderString(HttpHeaders.ACCESS_CONTROL_ALLOW_ORIGIN), is(\"https://apps.db.ripe.net\"));\n-        assertNull(response.getHeaderString(HttpHeaders.ACCESS_CONTROL_ALLOW_CREDENTIALS));\n+        assertThat(response.getHeaderString(HttpHeaders.ACCESS_CONTROL_ALLOW_CREDENTIALS), is(nullValue()));\n     }\n \n     @Test\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTAyODExNA==", "url": "https://github.com/RIPE-NCC/whois/pull/648#discussion_r465028114", "bodyText": "Use assertThat.. nullValue() rather than assertNull", "author": "eshryane", "createdAt": "2020-08-04T12:54:41Z", "path": "whois-api/src/test/java/net/ripe/db/whois/api/rdap/WhoisRdapServiceTestIntegration.java", "diffHunk": "@@ -1790,7 +1791,7 @@ public void cross_origin_preflight_request_from_outside_ripe_net_is_allowed() {\n                 .options();\n \n         assertThat(response.getHeaderString(HttpHeaders.ACCESS_CONTROL_ALLOW_ORIGIN), is(\"http://www.foo.net\"));\n-        assertThat(response.getHeaderString(HttpHeaders.ACCESS_CONTROL_ALLOW_CREDENTIALS), is(\"true\"));\n+        assertNull(response.getHeaderString(HttpHeaders.ACCESS_CONTROL_ALLOW_CREDENTIALS));", "originalCommit": "99e154f55e7e9673fd9daca62fe9054ba3b6b57b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f06efd931bb98d2be88965e3430a576e369caf3a", "chunk": "diff --git a/whois-api/src/test/java/net/ripe/db/whois/api/rdap/WhoisRdapServiceTestIntegration.java b/whois-api/src/test/java/net/ripe/db/whois/api/rdap/WhoisRdapServiceTestIntegration.java\nindex 8de5f110c..6e863a6cd 100644\n--- a/whois-api/src/test/java/net/ripe/db/whois/api/rdap/WhoisRdapServiceTestIntegration.java\n+++ b/whois-api/src/test/java/net/ripe/db/whois/api/rdap/WhoisRdapServiceTestIntegration.java\n\n@@ -1795,16 +1796,18 @@ public class WhoisRdapServiceTestIntegration extends AbstractRdapIntegrationTest\n     }\n \n     @Test\n-    public void cross_origin_preflight_post_request_from_outside_ripe_net_is_allowed() {\n+    public void cross_origin_preflight_post_request_from_outside_ripe_net_is_not_allowed() {\n         final Response response = createResource(\"entity/PP1-TEST\")\n                 .request(MediaType.APPLICATION_JSON_TYPE)\n                 .header(HttpHeaders.ORIGIN, \"http://www.foo.net\")\n                 .header(HttpHeaders.HOST, \"rdap.db.ripe.net\")\n                 .header(HttpHeaders.ACCESS_CONTROL_REQUEST_METHOD, HttpMethod.POST)\n                 .options();\n-        //TODO: POST is not allowed, how toi check????\n-        assertNull(response.getHeaderString(HttpHeaders.ACCESS_CONTROL_ALLOW_ORIGIN));\n-        assertNull(response.getHeaderString(HttpHeaders.ACCESS_CONTROL_ALLOW_METHODS));\n+\n+        assertThat(response.getHeaderString(HttpHeaders.ACCESS_CONTROL_ALLOW_ORIGIN), is(nullValue()));\n+        assertThat(response.getHeaderString(HttpHeaders.ACCESS_CONTROL_ALLOW_METHODS), is(nullValue()));\n+        assertThat(response.getHeaderString(HttpHeaders.ALLOW), containsString(\"GET\"));\n+        assertThat(response.getHeaderString(HttpHeaders.ALLOW), not(containsString(\"POST\")));\n     }\n \n     @Test\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTAzMzkxMA==", "url": "https://github.com/RIPE-NCC/whois/pull/648#discussion_r465033910", "bodyText": "N.B. I changed this test method as POST is not allowed", "author": "eshryane", "createdAt": "2020-08-04T13:04:03Z", "path": "whois-api/src/test/java/net/ripe/db/whois/api/rdap/WhoisRdapServiceTestIntegration.java", "diffHunk": "@@ -1790,20 +1792,49 @@ public void cross_origin_preflight_request_from_outside_ripe_net_is_allowed() {\n                 .options();\n \n         assertThat(response.getHeaderString(HttpHeaders.ACCESS_CONTROL_ALLOW_ORIGIN), is(\"http://www.foo.net\"));\n-        assertThat(response.getHeaderString(HttpHeaders.ACCESS_CONTROL_ALLOW_CREDENTIALS), is(\"true\"));\n+        assertNull(response.getHeaderString(HttpHeaders.ACCESS_CONTROL_ALLOW_CREDENTIALS));\n     }\n \n     @Test\n-    public void cross_origin_preflight_post_request_from_outside_ripe_net_is_allowed() {\n+    public void cross_origin_preflight_post_request_from_outside_ripe_net_is_not_allowed() {", "originalCommit": "f06efd931bb98d2be88965e3430a576e369caf3a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5be68ee699cb3442bc669bc72599929f0ac12569", "chunk": "diff --git a/whois-api/src/test/java/net/ripe/db/whois/api/rdap/WhoisRdapServiceTestIntegration.java b/whois-api/src/test/java/net/ripe/db/whois/api/rdap/WhoisRdapServiceTestIntegration.java\nindex 6e863a6cd..a7efd2c0d 100644\n--- a/whois-api/src/test/java/net/ripe/db/whois/api/rdap/WhoisRdapServiceTestIntegration.java\n+++ b/whois-api/src/test/java/net/ripe/db/whois/api/rdap/WhoisRdapServiceTestIntegration.java\n\n@@ -1792,7 +1791,7 @@ public class WhoisRdapServiceTestIntegration extends AbstractRdapIntegrationTest\n                 .options();\n \n         assertThat(response.getHeaderString(HttpHeaders.ACCESS_CONTROL_ALLOW_ORIGIN), is(\"http://www.foo.net\"));\n-        assertNull(response.getHeaderString(HttpHeaders.ACCESS_CONTROL_ALLOW_CREDENTIALS));\n+        assertThat(response.getHeaderString(HttpHeaders.ACCESS_CONTROL_ALLOW_CREDENTIALS), is(nullValue()));\n     }\n \n     @Test\n"}}, {"oid": "5be68ee699cb3442bc669bc72599929f0ac12569", "url": "https://github.com/RIPE-NCC/whois/commit/5be68ee699cb3442bc669bc72599929f0ac12569", "message": "Implement Ed suggestions", "committedDate": "2020-08-04T13:12:46Z", "type": "commit"}]}