{"pr_number": 699, "pr_title": "managed attribute country code for org", "pr_createdAt": "2020-11-20T12:40:23Z", "pr_url": "https://github.com/RIPE-NCC/whois/pull/699", "timeline": [{"oid": "cfde8dccc347f3f3a822a84e2fcfafa38a400361", "url": "https://github.com/RIPE-NCC/whois/commit/cfde8dccc347f3f3a822a84e2fcfafa38a400361", "message": "managed attribute country code for org", "committedDate": "2020-11-19T12:11:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUxMTcwMw==", "url": "https://github.com/RIPE-NCC/whois/pull/699#discussion_r528511703", "bodyText": "typo: orgnasation -> organisation\nThis test is for testing the validation of country code updating only being allowed by RIPE NCC, not for the attribute being flagged as managed?", "author": "sbusk", "createdAt": "2020-11-23T07:38:37Z", "path": "whois-api/src/test/java/net/ripe/db/whois/api/rest/WhoisRestServiceTestIntegration.java", "diffHunk": "@@ -1563,6 +1563,79 @@ public void lookup_inetnum_managed_attributes_resource_holder_abuse_contact() {\n         assertThat(response.getWhoisObjects().get(0).getAttributes().get(5).getManaged(), is(true));    // source\n     }\n \n+    @Test\n+    public void validate_country_managed_attribute_only_for_organisation() {\n+        databaseHelper.addObject(\n+                \"mntner:       RIPE-NCC-HM-MNT\\n\" +\n+                        \"source:   TEST\");\n+        databaseHelper.addObject(\n+                \"organisation: ORG-TO1-TEST\\n\" +\n+                        \"org-name:     Test Organisation\\n\" +\n+                        \"org-type:     LIR\\n\" +\n+                        \"country:      NL\\n\" +\n+                        \"abuse-c:      TR1-TEST\\n\" +\n+                        \"source:       TEST\");\n+        databaseHelper.addObject(\n+                \"inetnum:       10.0.0.0 - 10.0.0.255\\n\" +\n+                        \"status:   ALLOCATED PA\\n\" +\n+                        \"org:      ORG-TO1-TEST\\n\" +\n+                        \"country:  NL\\n\" +\n+                        \"mnt-by:   OWNER-MNT\\n\" +\n+                        \"mnt-by:   RIPE-NCC-HM-MNT\\n\" +\n+                        \"source:   TEST\");\n+\n+\n+        final WhoisResources searchOrg = RestTest.target(getPort(), \"whois/test/organisation/ORG-TO1-TEST?managed-attributes\")\n+                .request(MediaType.APPLICATION_XML_TYPE)\n+                .get(WhoisResources.class);\n+\n+        assertThat(searchOrg.getWhoisObjects(), hasSize(1));\n+        assertThat(searchOrg.getWhoisObjects().get(0).getPrimaryKey().get(0).getValue(), is(\"ORG-TO1-TEST\"));\n+        assertThat(searchOrg.getWhoisObjects().get(0).isManaged(), is(true));\n+        assertThat(searchOrg.getWhoisObjects().get(0).getAttributes().get(3).getName(), is(\"country\"));\n+        assertThat(searchOrg.getWhoisObjects().get(0).getAttributes().get(3).getManaged(), is(true));\n+\n+\n+        final WhoisResources searchinetnum = RestTest.target(getPort(), \"whois/test/inetnum/10.0.0.0%20-%2010.0.0.255?managed-attributes&resource-holder&abuse-contact\")\n+                .request(MediaType.APPLICATION_XML_TYPE)\n+                .get(WhoisResources.class);\n+\n+        assertThat(searchinetnum.getWhoisObjects(), hasSize(1));\n+        assertThat(searchinetnum.getWhoisObjects().get(0).getPrimaryKey().get(0).getValue(), is(\"10.0.0.0 - 10.0.0.255\"));\n+        assertThat(searchinetnum.getWhoisObjects().get(0).getAttributes().get(3).getName(), is(\"country\"));\n+        assertThat(searchinetnum.getWhoisObjects().get(0).getAttributes().get(3).getManaged(), is(nullValue()));\n+    }\n+\n+    @Test\n+    public void update_orgnasation_country_code_fails() {", "originalCommit": "cfde8dccc347f3f3a822a84e2fcfafa38a400361", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUxMjYyNg==", "url": "https://github.com/RIPE-NCC/whois/pull/699#discussion_r528512626", "bodyText": "I see the test case tests specifically that country code value can only be changed by RIPE NCC.\nCan you add a test also where you do authenticate as RIPE and change the attribute value?", "author": "sbusk", "createdAt": "2020-11-23T07:41:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUxMTcwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUzNTUxOQ==", "url": "https://github.com/RIPE-NCC/whois/pull/699#discussion_r528535519", "bodyText": "There is separate test case to test that country code is shown as managed attribute  for organisation (validate_country_managed_attribute_only_for_organisation) and not as managed attribute for other object type.", "author": "maggarwal13", "createdAt": "2020-11-23T08:32:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUxMTcwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUzNTY2NA==", "url": "https://github.com/RIPE-NCC/whois/pull/699#discussion_r528535664", "bodyText": "I will add a test case that country code can be updated using overrides", "author": "maggarwal13", "createdAt": "2020-11-23T08:33:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUxMTcwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODYxMTkxNQ==", "url": "https://github.com/RIPE-NCC/whois/pull/699#discussion_r528611915", "bodyText": "Done", "author": "maggarwal13", "createdAt": "2020-11-23T10:44:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUxMTcwMw=="}], "type": "inlineReview", "revised_code": {"commit": "e742e3b7c662ab23417519f184035af129ed9adc", "chunk": "diff --git a/whois-api/src/test/java/net/ripe/db/whois/api/rest/WhoisRestServiceTestIntegration.java b/whois-api/src/test/java/net/ripe/db/whois/api/rest/WhoisRestServiceTestIntegration.java\nindex d62cf12dc..42d4a4964 100644\n--- a/whois-api/src/test/java/net/ripe/db/whois/api/rest/WhoisRestServiceTestIntegration.java\n+++ b/whois-api/src/test/java/net/ripe/db/whois/api/rest/WhoisRestServiceTestIntegration.java\n\n@@ -1607,7 +1607,7 @@ public class WhoisRestServiceTestIntegration extends AbstractIntegrationTest {\n     }\n \n     @Test\n-    public void update_orgnasation_country_code_fails() {\n+    public void update_organisation_country_code_fails() {\n         databaseHelper.addObject(SSO_AND_PASSWORD_MNT);\n \n         final RpslObject ORGANISATION_COUNTRY = RpslObject.parse(\"\" +\n"}}, {"oid": "e742e3b7c662ab23417519f184035af129ed9adc", "url": "https://github.com/RIPE-NCC/whois/commit/e742e3b7c662ab23417519f184035af129ed9adc", "message": "add test case", "committedDate": "2020-11-23T10:44:01Z", "type": "commit"}, {"oid": "ef2e0f604919331ea86c362e67f44f706ca7a310", "url": "https://github.com/RIPE-NCC/whois/commit/ef2e0f604919331ea86c362e67f44f706ca7a310", "message": "Merge branch 'master' into country_managed_attribute", "committedDate": "2020-11-26T13:40:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTAzOTYxOA==", "url": "https://github.com/RIPE-NCC/whois/pull/699#discussion_r531039618", "bodyText": "This validation is already done in CountryRipeMaintainedValidator.java. If you add it here also, there may be duplicate error messages in the response.\nI don't mind if you want to move it here for consistency, but then please delete the other validator.", "author": "eshryane", "createdAt": "2020-11-26T13:46:11Z", "path": "whois-update/src/main/java/net/ripe/db/whois/update/handler/validator/organisation/LirRipeMaintainedAttributesValidator.java", "diffHunk": "@@ -30,7 +30,8 @@\n     private static final List<AttributeType> RIPE_NCC_MANAGED_ATTRIBUTES = ImmutableList.of(\n             AttributeType.MNT_BY,\n             AttributeType.ORG,\n-            AttributeType.ORG_TYPE);\n+            AttributeType.ORG_TYPE,\n+            AttributeType.COUNTRY);", "originalCommit": "ef2e0f604919331ea86c362e67f44f706ca7a310", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b88b2b9b94d992f5b580c12fcc997238f6a84dc3", "chunk": "diff --git a/whois-update/src/main/java/net/ripe/db/whois/update/handler/validator/organisation/LirRipeMaintainedAttributesValidator.java b/whois-update/src/main/java/net/ripe/db/whois/update/handler/validator/organisation/LirRipeMaintainedAttributesValidator.java\nindex 2ab55e964..94442419a 100644\n--- a/whois-update/src/main/java/net/ripe/db/whois/update/handler/validator/organisation/LirRipeMaintainedAttributesValidator.java\n+++ b/whois-update/src/main/java/net/ripe/db/whois/update/handler/validator/organisation/LirRipeMaintainedAttributesValidator.java\n\n@@ -30,8 +30,7 @@ public class LirRipeMaintainedAttributesValidator implements BusinessRuleValidat\n     private static final List<AttributeType> RIPE_NCC_MANAGED_ATTRIBUTES = ImmutableList.of(\n             AttributeType.MNT_BY,\n             AttributeType.ORG,\n-            AttributeType.ORG_TYPE,\n-            AttributeType.COUNTRY);\n+            AttributeType.ORG_TYPE);\n \n     @Override\n     public void validate(final PreparedUpdate update, final UpdateContext updateContext) {\n"}}, {"oid": "b88b2b9b94d992f5b580c12fcc997238f6a84dc3", "url": "https://github.com/RIPE-NCC/whois/commit/b88b2b9b94d992f5b580c12fcc997238f6a84dc3", "message": "remove validator for country", "committedDate": "2020-11-26T14:21:39Z", "type": "commit"}, {"oid": "225e9285fe3414835cc0ae4f62da15b71cb40936", "url": "https://github.com/RIPE-NCC/whois/commit/225e9285fe3414835cc0ae4f62da15b71cb40936", "message": "Merge branch 'country_managed_attribute' of github.com:RIPE-NCC/whois into country_managed_attribute\n\n* 'country_managed_attribute' of github.com:RIPE-NCC/whois:\n  Bump springockito-annotations from 1.0.5 to 1.0.9 (#698)\n  Bump log4j.version from 2.13.2 to 2.14.0 (#697)\n  Sonar coverage (#690)", "committedDate": "2020-11-26T14:21:51Z", "type": "commit"}, {"oid": "66a58d8398358f148839805a7c5a445ab2408d80", "url": "https://github.com/RIPE-NCC/whois/commit/66a58d8398358f148839805a7c5a445ab2408d80", "message": "Merge branch 'master' into country_managed_attribute", "committedDate": "2020-11-30T13:42:18Z", "type": "commit"}]}