{"pr_number": 651, "pr_title": "Return remark in rdap response when abuse mailbox validation has failed.", "pr_createdAt": "2020-08-06T20:36:32Z", "pr_url": "https://github.com/RIPE-NCC/whois/pull/651", "timeline": [{"oid": "abaa1a8c546e7e5fdab62e98fca0e3611e8bb36f", "url": "https://github.com/RIPE-NCC/whois/commit/abaa1a8c546e7e5fdab62e98fca0e3611e8bb36f", "message": "Return remark in rdap response when abuse mailbox validation has failed.", "committedDate": "2020-08-06T20:25:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODQ5ODI4MA==", "url": "https://github.com/RIPE-NCC/whois/pull/651#discussion_r468498280", "bodyText": "Mixing Nullable and Optional in the same method arguments? Can we choose one style for consistency?", "author": "eshryane", "createdAt": "2020-08-11T11:02:48Z", "path": "whois-api/src/main/java/net/ripe/db/whois/api/rdap/RdapObjectMapper.java", "diffHunk": "@@ -161,7 +160,11 @@ public RdapObject mapHelp(final String requestUrl) {\n         return mapCommons(new RdapObject(), requestUrl);\n     }\n \n-    private RdapObject getRdapObject(final String requestUrl, final RpslObject rpslObject, final LocalDateTime lastChangedTimestamp, @Nullable final RpslObject abuseContact) {\n+    private RdapObject getRdapObject(final String requestUrl,\n+                                     final RpslObject rpslObject,\n+                                     final LocalDateTime lastChangedTimestamp,\n+                                     @Nullable final RpslObject abuseRoleObject,", "originalCommit": "abaa1a8c546e7e5fdab62e98fca0e3611e8bb36f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQwODE5Mg==", "url": "https://github.com/RIPE-NCC/whois/pull/651#discussion_r471408192", "bodyText": "We use just the AbuseContact now.", "author": "sbusk", "createdAt": "2020-08-17T11:12:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODQ5ODI4MA=="}], "type": "inlineReview", "revised_code": {"commit": "5550905a431eac32e1e082097948d1c35b1bb580", "chunk": "diff --git a/whois-api/src/main/java/net/ripe/db/whois/api/rdap/RdapObjectMapper.java b/whois-api/src/main/java/net/ripe/db/whois/api/rdap/RdapObjectMapper.java\nindex 6ac71e911..31b06cce5 100644\n--- a/whois-api/src/main/java/net/ripe/db/whois/api/rdap/RdapObjectMapper.java\n+++ b/whois-api/src/main/java/net/ripe/db/whois/api/rdap/RdapObjectMapper.java\n\n@@ -163,7 +162,6 @@ class RdapObjectMapper {\n     private RdapObject getRdapObject(final String requestUrl,\n                                      final RpslObject rpslObject,\n                                      final LocalDateTime lastChangedTimestamp,\n-                                     @Nullable final RpslObject abuseRoleObject,\n                                      final Optional<AbuseContact> optionalAbuseContact) {\n         RdapObject rdapResponse;\n         final ObjectType rpslObjectType = rpslObject.getType();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODQ5ODUxMg==", "url": "https://github.com/RIPE-NCC/whois/pull/651#discussion_r468498512", "bodyText": "Can the TODO be resolved?", "author": "eshryane", "createdAt": "2020-08-11T11:03:18Z", "path": "whois-api/src/main/java/net/ripe/db/whois/api/rdap/RdapObjectMapper.java", "diffHunk": "@@ -296,7 +305,12 @@ private static Remark createRemark(final RpslObject rpslObject) {\n         return new Remark(descriptions);\n     }\n \n-    private static boolean hasRemark(final RpslObject rpslObject) {\n+    private static Remark createRemark(final CIString key, final AbuseContact abuseContact) {\n+        // TODO message duplicated from QueryMessages.unvalidatedAbuseCShown", "originalCommit": "abaa1a8c546e7e5fdab62e98fca0e3611e8bb36f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA1MzE1OA==", "url": "https://github.com/RIPE-NCC/whois/pull/651#discussion_r472053158", "bodyText": "Done.", "author": "sbusk", "createdAt": "2020-08-18T09:44:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODQ5ODUxMg=="}], "type": "inlineReview", "revised_code": {"commit": "3bd97905a836525f0008e3728e6afe6deb78e8c1", "chunk": "diff --git a/whois-api/src/main/java/net/ripe/db/whois/api/rdap/RdapObjectMapper.java b/whois-api/src/main/java/net/ripe/db/whois/api/rdap/RdapObjectMapper.java\nindex 6ac71e911..aee7588bb 100644\n--- a/whois-api/src/main/java/net/ripe/db/whois/api/rdap/RdapObjectMapper.java\n+++ b/whois-api/src/main/java/net/ripe/db/whois/api/rdap/RdapObjectMapper.java\n\n@@ -306,8 +303,11 @@ class RdapObjectMapper {\n     }\n \n     private static Remark createRemark(final CIString key, final AbuseContact abuseContact) {\n-        // TODO message duplicated from QueryMessages.unvalidatedAbuseCShown\n-        return new Remark(Lists.newArrayList(String.format(\"Abuse-mailbox validation failed. Please refer to %s for further information.\", abuseContact.getOrgId())));\n+        return new Remark(\n+           Lists.newArrayList(\n+               QueryMessages.unvalidatedAbuseCShown(key, abuseContact.getAbuseMailbox(), abuseContact.getOrgId()).toString().replaceAll(\"% \", \"\")\n+           )\n+        );\n     }\n \n     private static boolean hasDescriptions(final RpslObject rpslObject) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODQ5OTE5MA==", "url": "https://github.com/RIPE-NCC/whois/pull/651#discussion_r468499190", "bodyText": "Do we need two separate calls to the abuseCFinder? can you read the abuse-mailbox from the RpslObject from the  getAbuseContactRole() ?", "author": "eshryane", "createdAt": "2020-08-11T11:04:48Z", "path": "whois-api/src/main/java/net/ripe/db/whois/api/rdap/WhoisRdapService.java", "diffHunk": "@@ -276,7 +276,8 @@ private Response getResponse(HttpServletRequest request, List<RpslObject> result\n                         getRequestUrl(request),\n                         resultObject,\n                         objectDao.getLastUpdated(resultObject.getObjectId()),\n-                        abuseCFinder.getAbuseContactRole(resultObject)))\n+                        abuseCFinder.getAbuseContactRole(resultObject),", "originalCommit": "abaa1a8c546e7e5fdab62e98fca0e3611e8bb36f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQwODA0Nw==", "url": "https://github.com/RIPE-NCC/whois/pull/651#discussion_r471408047", "bodyText": "I've added the abuse role object to the AbuseContact so we don't need multiple lookups and we have all the information we need in one place.", "author": "sbusk", "createdAt": "2020-08-17T11:12:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODQ5OTE5MA=="}], "type": "inlineReview", "revised_code": {"commit": "5550905a431eac32e1e082097948d1c35b1bb580", "chunk": "diff --git a/whois-api/src/main/java/net/ripe/db/whois/api/rdap/WhoisRdapService.java b/whois-api/src/main/java/net/ripe/db/whois/api/rdap/WhoisRdapService.java\nindex 1f882eae0..252d16121 100644\n--- a/whois-api/src/main/java/net/ripe/db/whois/api/rdap/WhoisRdapService.java\n+++ b/whois-api/src/main/java/net/ripe/db/whois/api/rdap/WhoisRdapService.java\n\n@@ -276,7 +276,6 @@ public class WhoisRdapService {\n                         getRequestUrl(request),\n                         resultObject,\n                         objectDao.getLastUpdated(resultObject.getObjectId()),\n-                        abuseCFinder.getAbuseContactRole(resultObject),\n                         abuseCFinder.getAbuseContact(resultObject)))\n                 .header(CONTENT_TYPE, CONTENT_TYPE_RDAP_JSON)\n                 .build();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODQ5OTYwNA==", "url": "https://github.com/RIPE-NCC/whois/pull/651#discussion_r468499604", "bodyText": "Can you add a negative test in a different test case? (i.e. the messages doesn't appear)", "author": "eshryane", "createdAt": "2020-08-11T11:05:43Z", "path": "whois-api/src/test/java/net/ripe/db/whois/api/rdap/RdapObjectMapperTest.java", "diffHunk": "@@ -591,14 +599,49 @@ public void help() {\n         assertThat(result.getPort43(), is(\"whois.ripe.net\"));\n     }\n \n+    @Test\n+    public void abuse_validation_failed() {\n+        when(abuseContact.isSuspect()).thenReturn(true);\n+        when(abuseContact.getOrgId()).thenReturn(ciString(\"ORG-NCC1-RIPE\"));\n+        when(abuseContact.getAbuseMailbox()).thenReturn(ciString(\"abuse@test.com\"));\n+        when(abuseContact.getNicHandle()).thenReturn(ciString(\"AB-TEST\"));\n+\n+        final Autnum result = (Autnum) map(\n+                RpslObject.parse(\"\" +\n+                    \"aut-num:        AS102\\n\" +\n+                    \"as-name:        End-User-2\\n\" +\n+                    \"org:            ORG-NCC1-RIPE\\n\" +\n+                    \"admin-c:        AP1-TEST\\n\" +\n+                    \"tech-c:         AP1-TEST\\n\" +\n+                    \"abuse-c:        AB-TEST\\n\" +\n+                    \"notify:         noreply@ripe.net\\n\" +\n+                    \"mnt-by:         UPD-MNT\\n\" +\n+                    \"source:         TEST\\n\"\n+                ),\n+                RpslObject.parse(\n+                    \"role:           Abuse Contact\\n\" +\n+                    \"nic-hdl:        AB-TEST\\n\" +\n+                    \"mnt-by:         TEST-MNT\\n\" +\n+                    \"abuse-mailbox:  abuse@test.com\\n\" +\n+                    \"admin-c:        TP1-TEST\\n\" +\n+                    \"tech-c:         TP2-TEST\\n\" +\n+                    \"phone:          +31 12345678\\n\" +\n+                    \"source:         TEST\"\n+                ),\n+                Optional.of(abuseContact)\n+        );\n+\n+        assertThat(result.getRemarks().get(0).getDescription().get(0), is(\"Abuse-mailbox validation failed. Please refer to ORG-NCC1-RIPE for further information.\"));", "originalCommit": "abaa1a8c546e7e5fdab62e98fca0e3611e8bb36f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjEyNjg4Nw==", "url": "https://github.com/RIPE-NCC/whois/pull/651#discussion_r472126887", "bodyText": "I've added a bunch of test cases (message doesn't appear, responsible org not found, IT).", "author": "sbusk", "createdAt": "2020-08-18T12:05:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODQ5OTYwNA=="}], "type": "inlineReview", "revised_code": {"commit": "5550905a431eac32e1e082097948d1c35b1bb580", "chunk": "diff --git a/whois-api/src/test/java/net/ripe/db/whois/api/rdap/RdapObjectMapperTest.java b/whois-api/src/test/java/net/ripe/db/whois/api/rdap/RdapObjectMapperTest.java\nindex 03da6e898..90b6da797 100644\n--- a/whois-api/src/test/java/net/ripe/db/whois/api/rdap/RdapObjectMapperTest.java\n+++ b/whois-api/src/test/java/net/ripe/db/whois/api/rdap/RdapObjectMapperTest.java\n\n@@ -601,10 +603,20 @@ public class RdapObjectMapperTest {\n \n     @Test\n     public void abuse_validation_failed() {\n-        when(abuseContact.isSuspect()).thenReturn(true);\n-        when(abuseContact.getOrgId()).thenReturn(ciString(\"ORG-NCC1-RIPE\"));\n-        when(abuseContact.getAbuseMailbox()).thenReturn(ciString(\"abuse@test.com\"));\n-        when(abuseContact.getNicHandle()).thenReturn(ciString(\"AB-TEST\"));\n+        final AbuseContact abuseContact = new AbuseContact(\n+            RpslObject.parse(\n+                \"role:           Abuse Contact\\n\" +\n+                \"nic-hdl:        AB-TEST\\n\" +\n+                \"mnt-by:         TEST-MNT\\n\" +\n+                \"abuse-mailbox:  abuse@test.com\\n\" +\n+                \"admin-c:        TP1-TEST\\n\" +\n+                \"tech-c:         TP2-TEST\\n\" +\n+                \"phone:          +31 12345678\\n\" +\n+                \"source:         TEST\"\n+            ),\n+            true,\n+            ciString(\"ORG-NCC1-RIPE\")\n+        );\n \n         final Autnum result = (Autnum) map(\n                 RpslObject.parse(\"\" +\n"}}, {"oid": "5550905a431eac32e1e082097948d1c35b1bb580", "url": "https://github.com/RIPE-NCC/whois/commit/5550905a431eac32e1e082097948d1c35b1bb580", "message": "AbuseContact now contains abuse-c role object so we don't require multiple lookups.", "committedDate": "2020-08-17T11:09:46Z", "type": "commit"}, {"oid": "3bd97905a836525f0008e3728e6afe6deb78e8c1", "url": "https://github.com/RIPE-NCC/whois/commit/3bd97905a836525f0008e3728e6afe6deb78e8c1", "message": "Use existing abuse mailbox failed message.\nAdded tests.", "committedDate": "2020-08-18T10:38:49Z", "type": "commit"}]}