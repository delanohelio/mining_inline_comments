{"pr_number": 2726, "pr_title": "RHDM-1189: 'Unable to expand' exception with from condition in Guided Rule Editor with DSL option checked", "pr_createdAt": "2020-01-16T16:27:05Z", "pr_url": "https://github.com/kiegroup/drools/pull/2726", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzc4MTUwOA==", "url": "https://github.com/kiegroup/drools/pull/2726#discussion_r367781508", "bodyText": "Please do not introduce new public api method as there is single occurence of it, in the same class.", "author": "jomarko", "createdAt": "2020-01-17T06:06:10Z", "path": "drools-workbench-models/drools-workbench-models-commons/src/main/java/org/drools/workbench/models/commons/backend/rule/RuleModelDRLPersistenceImpl.java", "diffHunk": "@@ -634,22 +634,34 @@ public void visitFactPattern(final FactPattern pattern) {\n         }\n \n         public void visitFreeFormLine(final FreeFormLine ffl) {\n+            visitFreeFormLine(ffl,\n+                              generatorContextFactory.getMaximumPatternDepth() > 1);\n+        }\n+\n+        public void visitFreeFormLine(final FreeFormLine ffl,", "originalCommit": "7d4985d7b847769174283b542e53d1cbb48fdbc0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzg1NDczNQ==", "url": "https://github.com/kiegroup/drools/pull/2726#discussion_r367854735", "bodyText": "OK.. the single parameter form of these methods (visitXYZ) are called by a relection-based visitor however the two parameter versions are only called internally but could be overridden so I've made them all protected. I hope that is more acceptable.", "author": "manstis", "createdAt": "2020-01-17T10:00:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzc4MTUwOA=="}], "type": "inlineReview", "revised_code": {"commit": "9f7ebcf1877ea8a37e27779a009d7b1a0625945d", "chunk": "diff --git a/drools-workbench-models/drools-workbench-models-commons/src/main/java/org/drools/workbench/models/commons/backend/rule/RuleModelDRLPersistenceImpl.java b/drools-workbench-models/drools-workbench-models-commons/src/main/java/org/drools/workbench/models/commons/backend/rule/RuleModelDRLPersistenceImpl.java\nindex 2b9e85049f..e645b7cc14 100644\n--- a/drools-workbench-models/drools-workbench-models-commons/src/main/java/org/drools/workbench/models/commons/backend/rule/RuleModelDRLPersistenceImpl.java\n+++ b/drools-workbench-models/drools-workbench-models-commons/src/main/java/org/drools/workbench/models/commons/backend/rule/RuleModelDRLPersistenceImpl.java\n\n@@ -630,19 +639,25 @@ public class RuleModelDRLPersistenceImpl\n             }\n \n             postGeneratePattern(gctx);\n-            buf.append(\"\\n\");\n+            if (!isSubPattern) {\n+                buf.append(\"\\n\");\n+            }\n         }\n \n         public void visitFreeFormLine(final FreeFormLine ffl) {\n             visitFreeFormLine(ffl,\n-                              generatorContextFactory.getMaximumPatternDepth() > 1);\n+                              rootContext);\n         }\n \n-        public void visitFreeFormLine(final FreeFormLine ffl,\n-                                      final boolean isSubPattern) {\n+        protected void visitFreeFormLine(final FreeFormLine ffl,\n+                                         final LHSGeneratorContext parentContext) {\n             if (ffl.getText() == null) {\n                 return;\n             }\n+\n+            final LHSGeneratorContext gctx = generatorContextFactory.newPeerGeneratorContext(parentContext, ffl);\n+            final boolean isSubPattern = gctx.getDepth() > 0;\n+\n             String[] lines = ffl.getText().split(\"\\\\n|\\\\r\\\\n\");\n             for (String line : lines) {\n                 this.buf.append(indentation);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzc4MjkzMQ==", "url": "https://github.com/kiegroup/drools/pull/2726#discussion_r367782931", "bodyText": "Does this return true means we are saving rdslr file? I though it means the rules combine drools and dsl sentences, however I was wrong probably.\nCan we please add test where a from expression and DSL sentence is present? Or do we have such test please?", "author": "jomarko", "createdAt": "2020-01-17T06:14:00Z", "path": "drools-workbench-models/drools-workbench-models-commons/src/test/java/org/drools/workbench/models/commons/backend/rule/RuleModelDRLPersistenceTest.java", "diffHunk": "@@ -4763,4 +4763,160 @@ public void testRHSDateInsertActionWithoutSystemProperty() {\n             }\n         }\n     }\n+\n+    @Test\n+    public void testFromCompositeFactPatternWithDSLAlthoughModelHasNoDSLSentences() {\n+        final RuleModel model = new RuleModel() {\n+            @Override\n+            public boolean hasDSLSentences() {\n+                return true;", "originalCommit": "7d4985d7b847769174283b542e53d1cbb48fdbc0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzg1Njc2NQ==", "url": "https://github.com/kiegroup/drools/pull/2726#discussion_r367856765", "bodyText": "It replicates the state of validating a model when it was created as a rdslr file but has no actual DSL elements (as per https://issues.redhat.com/browse/RHDM-1189). Validation is called here and the source obtained here. RuleModelWrapper constructor set to true when the file is  .rdslr. It is used by RuleModelWrapper as the hasDSLSentences here.\nLet me check about the test (or add one)....", "author": "manstis", "createdAt": "2020-01-17T10:05:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzc4MjkzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzkzMTYwMg==", "url": "https://github.com/kiegroup/drools/pull/2726#discussion_r367931602", "bodyText": "@jomarko New tests added.. what a can of worms that opened.. but good they were added as it highlighted a bug (not only relating to my changes but also existing tests that contained from).", "author": "manstis", "createdAt": "2020-01-17T13:21:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzc4MjkzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzkzMjM2Mw==", "url": "https://github.com/kiegroup/drools/pull/2726#discussion_r367932363", "bodyText": "This requirement was not being adhered to in all scenarios.", "author": "manstis", "createdAt": "2020-01-17T13:23:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzc4MjkzMQ=="}], "type": "inlineReview", "revised_code": {"commit": "9f7ebcf1877ea8a37e27779a009d7b1a0625945d", "chunk": "diff --git a/drools-workbench-models/drools-workbench-models-commons/src/test/java/org/drools/workbench/models/commons/backend/rule/RuleModelDRLPersistenceTest.java b/drools-workbench-models/drools-workbench-models-commons/src/test/java/org/drools/workbench/models/commons/backend/rule/RuleModelDRLPersistenceTest.java\nindex a85e6db212..bded574ed8 100644\n--- a/drools-workbench-models/drools-workbench-models-commons/src/test/java/org/drools/workbench/models/commons/backend/rule/RuleModelDRLPersistenceTest.java\n+++ b/drools-workbench-models/drools-workbench-models-commons/src/test/java/org/drools/workbench/models/commons/backend/rule/RuleModelDRLPersistenceTest.java\n\n@@ -4764,6 +4763,145 @@ public class RuleModelDRLPersistenceTest extends BaseRuleModelTest {\n         }\n     }\n \n+    @Test\n+    public void testFromCompositeFactPatternWithDSLWhenModelHasDSLSentences() {\n+        final RuleModel model = new RuleModel() {\n+            @Override\n+            public boolean hasDSLSentences() {\n+                return true;\n+            }\n+        };\n+        model.name = \"r1\";\n+\n+        final String dslDefinition = \"There is a Person aged 20\";\n+        final DSLSentence dsl = new DSLSentence();\n+        dsl.setDefinition(dslDefinition);\n+\n+        model.addLhsItem(dsl);\n+\n+        final FromCompositeFactPattern from = new FromCompositeFactPattern();\n+        from.setFactPattern(new FactPattern(\"Person\"));\n+        from.setExpression(new ExpressionFormLine(new ExpressionText(\"$p.siblings\")));\n+\n+        model.addLhsItem(from);\n+\n+        final String expected = \"rule \\\"r1\\\"\\n\" +\n+                \"dialect \\\"mvel\\\"\\n\" +\n+                \"when\\n\" +\n+                dslDefinition + \"\\n\" +\n+                \">(Person( ) from $p.siblings)\\n\" +\n+                \"then\\n\" +\n+                \"end\\n\";\n+\n+        checkMarshalling(expected, model);\n+    }\n+\n+    @Test\n+    public void testFromCollectCompositeFactPatternWithDSLWhenModelHasDSLSentences() {\n+        final RuleModel model = new RuleModel() {\n+            @Override\n+            public boolean hasDSLSentences() {\n+                return true;\n+            }\n+        };\n+        model.name = \"r1\";\n+\n+        final String dslDefinition = \"There is a Person aged 20\";\n+        final DSLSentence dsl = new DSLSentence();\n+        dsl.setDefinition(dslDefinition);\n+\n+        model.addLhsItem(dsl);\n+\n+        final FromCollectCompositeFactPattern collect = new FromCollectCompositeFactPattern();\n+        collect.setFactPattern(new FactPattern(\"Person\"));\n+        final FreeFormLine ffl = new FreeFormLine();\n+        ffl.setText(\"$p.siblings\");\n+        collect.setRightPattern(ffl);\n+\n+        model.addLhsItem(collect);\n+\n+        final String expected = \"rule \\\"r1\\\"\\n\" +\n+                \"dialect \\\"mvel\\\"\\n\" +\n+                \"when\\n\" +\n+                dslDefinition + \"\\n\" +\n+                \">Person( ) from collect ( $p.siblings\\n\" +\n+                \">) \\n\" +\n+                \"then\\n\" +\n+                \"end\\n\";\n+\n+        checkMarshalling(expected, model);\n+    }\n+\n+    @Test\n+    public void testFromAccumulateWithDSLWhenModelHasDSLSentences() {\n+        final RuleModel model = new RuleModel() {\n+            @Override\n+            public boolean hasDSLSentences() {\n+                return true;\n+            }\n+        };\n+        model.name = \"r1\";\n+\n+        final String dslDefinition = \"There is a Person aged 20\";\n+        final DSLSentence dsl = new DSLSentence();\n+        dsl.setDefinition(dslDefinition);\n+\n+        model.addLhsItem(dsl);\n+\n+        final FromAccumulateCompositeFactPattern accumulate = new FromAccumulateCompositeFactPattern();\n+        final FactPattern accumulatePerson = new FactPattern(\"Person\");\n+        accumulatePerson.setBoundName(\"$p\");\n+        accumulate.setSourcePattern(accumulatePerson);\n+        accumulate.setFactPattern(new FactPattern(\"java.util.Number\"));\n+        accumulate.setFunction(\"count($p)\");\n+\n+        model.addLhsItem(accumulate);\n+\n+        final String expected = \"rule \\\"r1\\\"\\n\" +\n+                \"dialect \\\"mvel\\\"\\n\" +\n+                \"when\\n\" +\n+                dslDefinition + \"\\n\" +\n+                \">java.util.Number( ) from accumulate ( $p : Person( ),\\n\" +\n+                \">count($p)) \\n\" +\n+                \"then\\n\" +\n+                \"end\\n\";\n+\n+        checkMarshalling(expected, model);\n+    }\n+\n+    @Test\n+    public void testFromEntryPointFactPatternWithDSLWhenModelHasDSLSentences() {\n+        final RuleModel model = new RuleModel() {\n+            @Override\n+            public boolean hasDSLSentences() {\n+                return true;\n+            }\n+        };\n+        model.name = \"r1\";\n+\n+        final String dslDefinition = \"There is a Person aged 20\";\n+        final DSLSentence dsl = new DSLSentence();\n+        dsl.setDefinition(dslDefinition);\n+\n+        model.addLhsItem(dsl);\n+\n+        final FromEntryPointFactPattern from = new FromEntryPointFactPattern();\n+        from.setFactPattern(new FactPattern(\"Person\"));\n+        from.setEntryPointName(\"entry-point\");\n+\n+        model.addLhsItem(from);\n+\n+        final String expected = \"rule \\\"r1\\\"\\n\" +\n+                \"dialect \\\"mvel\\\"\\n\" +\n+                \"when\\n\" +\n+                dslDefinition + \"\\n\" +\n+                \">Person( ) from entry-point \\\"entry-point\\\"\\n\" +\n+                \"then\\n\" +\n+                \"end\\n\";\n+\n+        checkMarshalling(expected, model);\n+    }\n+\n     @Test\n     public void testFromCompositeFactPatternWithDSLAlthoughModelHasNoDSLSentences() {\n         final RuleModel model = new RuleModel() {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODU2NjE1Mw==", "url": "https://github.com/kiegroup/drools/pull/2726#discussion_r368566153", "bodyText": "When I grep  RuleModelDRLPersistenceImpl class for occurrences of .append(\">\"); code snippet, I am now getting two kinds of occurrences:\n\n\">\" is add/not added according variables isSubPattern and isDSLEnhanced\n\">\" is add/not added according variable isDSLEnhanced\n\nShouldn't be \">\" added/not added always according to both variables?", "author": "jomarko", "createdAt": "2020-01-20T14:09:47Z", "path": "drools-workbench-models/drools-workbench-models-commons/src/main/java/org/drools/workbench/models/commons/backend/rule/RuleModelDRLPersistenceImpl.java", "diffHunk": "@@ -630,33 +639,54 @@ public void visitFactPattern(final FactPattern pattern) {\n             }\n \n             postGeneratePattern(gctx);\n-            buf.append(\"\\n\");\n+            if (!isSubPattern) {\n+                buf.append(\"\\n\");\n+            }\n         }\n \n         public void visitFreeFormLine(final FreeFormLine ffl) {\n+            visitFreeFormLine(ffl,\n+                              rootContext);\n+        }\n+\n+        protected void visitFreeFormLine(final FreeFormLine ffl,\n+                                         final LHSGeneratorContext parentContext) {\n             if (ffl.getText() == null) {\n                 return;\n             }\n+\n+            final LHSGeneratorContext gctx = generatorContextFactory.newPeerGeneratorContext(parentContext, ffl);\n+            final boolean isSubPattern = gctx.getDepth() > 0;\n+\n             String[] lines = ffl.getText().split(\"\\\\n|\\\\r\\\\n\");\n             for (String line : lines) {\n                 this.buf.append(indentation);\n-                if (isDSLEnhanced) {\n+                if (!isSubPattern && isDSLEnhanced) {\n                     buf.append(\">\");", "originalCommit": "ce572ed53028417d7117b21ca3082689ff569ede", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODYwMDE1Mw==", "url": "https://github.com/kiegroup/drools/pull/2726#discussion_r368600153", "bodyText": "@jomarko You are probably correct.. I can't think of any reason for it to be different.\nI've added a new commit to ensure use of isSubPattern is used consistently in LHSPatternVisitor. Some occurrences were in RHSActionVisitor however this has no concept of sub pattern and hence can remain unchanged.", "author": "manstis", "createdAt": "2020-01-20T15:17:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODU2NjE1Mw=="}], "type": "inlineReview", "revised_code": {"commit": "afea3447bf143c42237479e9f5b92e2d43d9821d", "chunk": "diff --git a/drools-workbench-models/drools-workbench-models-commons/src/main/java/org/drools/workbench/models/commons/backend/rule/RuleModelDRLPersistenceImpl.java b/drools-workbench-models/drools-workbench-models-commons/src/main/java/org/drools/workbench/models/commons/backend/rule/RuleModelDRLPersistenceImpl.java\nindex e645b7cc14..2b9e85049f 100644\n--- a/drools-workbench-models/drools-workbench-models-commons/src/main/java/org/drools/workbench/models/commons/backend/rule/RuleModelDRLPersistenceImpl.java\n+++ b/drools-workbench-models/drools-workbench-models-commons/src/main/java/org/drools/workbench/models/commons/backend/rule/RuleModelDRLPersistenceImpl.java\n\n@@ -639,25 +630,19 @@ public class RuleModelDRLPersistenceImpl\n             }\n \n             postGeneratePattern(gctx);\n-            if (!isSubPattern) {\n-                buf.append(\"\\n\");\n-            }\n+            buf.append(\"\\n\");\n         }\n \n         public void visitFreeFormLine(final FreeFormLine ffl) {\n             visitFreeFormLine(ffl,\n-                              rootContext);\n+                              generatorContextFactory.getMaximumPatternDepth() > 1);\n         }\n \n-        protected void visitFreeFormLine(final FreeFormLine ffl,\n-                                         final LHSGeneratorContext parentContext) {\n+        public void visitFreeFormLine(final FreeFormLine ffl,\n+                                      final boolean isSubPattern) {\n             if (ffl.getText() == null) {\n                 return;\n             }\n-\n-            final LHSGeneratorContext gctx = generatorContextFactory.newPeerGeneratorContext(parentContext, ffl);\n-            final boolean isSubPattern = gctx.getDepth() > 0;\n-\n             String[] lines = ffl.getText().split(\"\\\\n|\\\\r\\\\n\");\n             for (String line : lines) {\n                 this.buf.append(indentation);\n"}}, {"oid": "afea3447bf143c42237479e9f5b92e2d43d9821d", "url": "https://github.com/kiegroup/drools/commit/afea3447bf143c42237479e9f5b92e2d43d9821d", "message": "RHDM-1189: 'Unable to expand' exception with from condition in Guided Rule Editor with DSL option checked", "committedDate": "2020-01-20T15:05:36Z", "type": "commit"}, {"oid": "9f7ebcf1877ea8a37e27779a009d7b1a0625945d", "url": "https://github.com/kiegroup/drools/commit/9f7ebcf1877ea8a37e27779a009d7b1a0625945d", "message": "Updates following peer review.", "committedDate": "2020-01-20T15:05:36Z", "type": "commit"}, {"oid": "9f7ebcf1877ea8a37e27779a009d7b1a0625945d", "url": "https://github.com/kiegroup/drools/commit/9f7ebcf1877ea8a37e27779a009d7b1a0625945d", "message": "Updates following peer review.", "committedDate": "2020-01-20T15:05:36Z", "type": "forcePushed"}, {"oid": "93b44536404ffb5318ce5994053ba55d8f68ce8a", "url": "https://github.com/kiegroup/drools/commit/93b44536404ffb5318ce5994053ba55d8f68ce8a", "message": "Ensure use of isSubPattern is used consistently in LHSPatternVisitor", "committedDate": "2020-01-20T15:26:01Z", "type": "commit"}]}