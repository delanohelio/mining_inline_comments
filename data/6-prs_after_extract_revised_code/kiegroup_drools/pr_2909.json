{"pr_number": 2909, "pr_title": "[DROOLS-5353] Avoid ClassLoader retention in LambdaIntrospector", "pr_createdAt": "2020-05-22T07:10:42Z", "pr_url": "https://github.com/kiegroup/drools/pull/2909", "timeline": [{"oid": "c14b61a30ac9f08f4982b967087404d7675fa117", "url": "https://github.com/kiegroup/drools/commit/c14b61a30ac9f08f4982b967087404d7675fa117", "message": "[DROOLS-5353] Avoid ClassLoader retention in LambdaIntrospector", "committedDate": "2020-05-22T06:45:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTk0ODIxNg==", "url": "https://github.com/kiegroup/drools/pull/2909#discussion_r429948216", "bodyText": "I don't think it is a good idea to read the cache field via reflection in this way, even in a test. Please add a package private accessor method and use it instead.", "author": "mariofusco", "createdAt": "2020-05-25T13:55:57Z", "path": "drools-model/drools-model-compiler/src/test/java/org/drools/modelcompiler/util/LambdaIntrospectorTest.java", "diffHunk": "@@ -45,21 +45,23 @@ public boolean test(org.drools.modelcompiler.domain.Person p) {\n \n     @Test\n     public void testMethodFingerprintsMapCacheSize() throws Exception {\n-        // Because methodFingerprintsMap is static, this property can be testable when you run this test method only\n+        // To test system property, you need to run this test method only.\n         // (mvn test -Dtest=LambdaIntrospectorTest#testMethodFingerprintsMapCacheSize)\n         // System.setProperty(LambdaIntrospector.LAMBDA_INTROSPECTOR_CACHE_SIZE, \"0\");\n \n         LambdaIntrospector lambdaIntrospector = new LambdaIntrospector();\n \n-        Field field = LambdaIntrospector.class.getDeclaredField(\"methodFingerprintsMap\");\n+        Field field = LambdaIntrospector.class.getDeclaredField(\"methodFingerprintsMapPerClassLoader\");", "originalCommit": "c14b61a30ac9f08f4982b967087404d7675fa117", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDEyODI4Nw==", "url": "https://github.com/kiegroup/drools/pull/2909#discussion_r430128287", "bodyText": "Sure! Added a package private accessor so got rid of reflection.", "author": "tkobayas", "createdAt": "2020-05-26T02:38:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTk0ODIxNg=="}], "type": "inlineReview", "revised_code": {"commit": "01591892d46e30819ebdc6d18bd45f7f8fe8b50f", "chunk": "diff --git a/drools-model/drools-model-compiler/src/test/java/org/drools/modelcompiler/util/LambdaIntrospectorTest.java b/drools-model/drools-model-compiler/src/test/java/org/drools/modelcompiler/util/LambdaIntrospectorTest.java\nindex 3bca73d99b..662f866067 100644\n--- a/drools-model/drools-model-compiler/src/test/java/org/drools/modelcompiler/util/LambdaIntrospectorTest.java\n+++ b/drools-model/drools-model-compiler/src/test/java/org/drools/modelcompiler/util/LambdaIntrospectorTest.java\n\n@@ -49,14 +49,11 @@ public class LambdaIntrospectorTest {\n         // (mvn test -Dtest=LambdaIntrospectorTest#testMethodFingerprintsMapCacheSize)\n         // System.setProperty(LambdaIntrospector.LAMBDA_INTROSPECTOR_CACHE_SIZE, \"0\");\n \n-        LambdaIntrospector lambdaIntrospector = new LambdaIntrospector();\n-\n-        Field field = LambdaIntrospector.class.getDeclaredField(\"methodFingerprintsMapPerClassLoader\");\n-        field.setAccessible(true);\n-        // LambdaIntrospector.ClassIdentifier is not visible so the Map is not parameterized\n-        Map<ClassLoader, Map<String, Map<String, String>>> methodFingerprintsMapPerClassLoader = (Map<ClassLoader, Map<String, Map<String, String>>>) field.get(lambdaIntrospector);\n+        Map<ClassLoader, Map<String, Map<String, String>>> methodFingerprintsMapPerClassLoader = LambdaIntrospector.getMethodFingerprintsMapPerClassLoader();\n         methodFingerprintsMapPerClassLoader.clear();\n \n+        LambdaIntrospector lambdaIntrospector = new LambdaIntrospector();\n+\n         Predicate1<Person> predicate1 = p -> p.getAge() > 35;\n         lambdaIntrospector.getLambdaFingerprint(predicate1);\n \n"}}, {"oid": "01591892d46e30819ebdc6d18bd45f7f8fe8b50f", "url": "https://github.com/kiegroup/drools/commit/01591892d46e30819ebdc6d18bd45f7f8fe8b50f", "message": "- add package private accessor for testing", "committedDate": "2020-05-26T02:24:08Z", "type": "commit"}]}