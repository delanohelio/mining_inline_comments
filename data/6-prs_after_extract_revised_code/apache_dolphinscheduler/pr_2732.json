{"pr_number": 2732, "pr_title": "fix #2598::allow to update resource suffix,but if it is authorized to other users,it is not allowed", "pr_createdAt": "2020-05-18T02:50:07Z", "pr_url": "https://github.com/apache/dolphinscheduler/pull/2732", "timeline": [{"oid": "02457b74954037c3f78cf8def2803bbe89282c24", "url": "https://github.com/apache/dolphinscheduler/commit/02457b74954037c3f78cf8def2803bbe89282c24", "message": "fix #2598:allow to update resource suffix,but if it is authorized to other users,it is not allowed.", "committedDate": "2020-05-16T08:47:43Z", "type": "commit"}, {"oid": "d8b19e46008f266eb6ea2add17765f8ca8a80ede", "url": "https://github.com/apache/dolphinscheduler/commit/d8b19e46008f266eb6ea2add17765f8ca8a80ede", "message": "add RESOURCE_IS_AUTHORIZED status", "committedDate": "2020-05-18T02:29:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjM1NDQwNQ==", "url": "https://github.com/apache/dolphinscheduler/pull/2732#discussion_r426354405", "bodyText": "change the message the user name is better.", "author": "lenboo", "createdAt": "2020-05-18T03:40:00Z", "path": "dolphinscheduler-api/src/main/java/org/apache/dolphinscheduler/api/service/ResourcesService.java", "diffHunk": "@@ -355,12 +352,21 @@ public Result updateResource(User loginUser,\n         String nameWithSuffix = name;\n \n         if (!resource.isDirectory()) {\n-            //get the file suffix\n-            String suffix = originResourceName.substring(originResourceName.lastIndexOf(\".\"));\n-\n-            //if the name without suffix then add it ,else use the origin name\n-            if(!name.endsWith(suffix)){\n-                nameWithSuffix = nameWithSuffix + suffix;\n+            //get the origin file suffix\n+            String originSuffix = FileUtils.suffix(originFullName);\n+            String suffix = FileUtils.suffix(fullName);\n+            if (!suffix.equals(originSuffix)) {\n+                //need verify whether this resource is authorized to other users\n+                Map<String, Object> columnMap = new HashMap<String, Object>();\n+                columnMap.put(\"resources_id\", resourceId);\n+\n+                List<ResourcesUser> resourcesUsers = resourceUserMapper.selectByMap(columnMap);\n+                if (CollectionUtils.isNotEmpty(resourcesUsers)) {\n+                    String users = resourcesUsers.stream().map(t -> t.getUserId()).collect(Collectors.toList()).toString();\n+                    logger.error(\"resource is authorized to user {},suffix not allowed to be modified\", users);", "originalCommit": "d8b19e46008f266eb6ea2add17765f8ca8a80ede", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjM3MzA3Mg==", "url": "https://github.com/apache/dolphinscheduler/pull/2732#discussion_r426373072", "bodyText": "or do not print user name?", "author": "lenboo", "createdAt": "2020-05-18T05:12:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjM1NDQwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjQ1Nzg4MQ==", "url": "https://github.com/apache/dolphinscheduler/pull/2732#discussion_r426457881", "bodyText": "I agree with you,The message now shows  the user name instead of user id.", "author": "lgcareer", "createdAt": "2020-05-18T08:35:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjM1NDQwNQ=="}], "type": "inlineReview", "revised_code": {"commit": "ad33b8b14514d718d07687d5b166fcdafe7115f8", "chunk": "diff --git a/dolphinscheduler-api/src/main/java/org/apache/dolphinscheduler/api/service/ResourcesService.java b/dolphinscheduler-api/src/main/java/org/apache/dolphinscheduler/api/service/ResourcesService.java\nindex b114a43a4..7115f922f 100644\n--- a/dolphinscheduler-api/src/main/java/org/apache/dolphinscheduler/api/service/ResourcesService.java\n+++ b/dolphinscheduler-api/src/main/java/org/apache/dolphinscheduler/api/service/ResourcesService.java\n\n@@ -349,22 +349,30 @@ public class ResourcesService extends BaseService {\n             throw new ServiceException(Status.HDFS_OPERATION_ERROR);\n         }\n \n-        String nameWithSuffix = name;\n-\n         if (!resource.isDirectory()) {\n             //get the origin file suffix\n             String originSuffix = FileUtils.suffix(originFullName);\n             String suffix = FileUtils.suffix(fullName);\n-            if (!suffix.equals(originSuffix)) {\n+            boolean suffixIsChanged = false;\n+            if (StringUtils.isBlank(suffix) && StringUtils.isNotBlank(originSuffix)) {\n+                suffixIsChanged = true;\n+            }\n+            if (StringUtils.isNotBlank(suffix) && !suffix.equals(originSuffix)) {\n+                suffixIsChanged = true;\n+            }\n+            //verify whether suffix is changed\n+            if (suffixIsChanged) {\n                 //need verify whether this resource is authorized to other users\n                 Map<String, Object> columnMap = new HashMap<String, Object>();\n                 columnMap.put(\"resources_id\", resourceId);\n \n                 List<ResourcesUser> resourcesUsers = resourceUserMapper.selectByMap(columnMap);\n                 if (CollectionUtils.isNotEmpty(resourcesUsers)) {\n-                    String users = resourcesUsers.stream().map(t -> t.getUserId()).collect(Collectors.toList()).toString();\n-                    logger.error(\"resource is authorized to user {},suffix not allowed to be modified\", users);\n-                    putMsg(result,Status.RESOURCE_IS_AUTHORIZED,users);\n+                    List<Integer> userIds = resourcesUsers.stream().map(t -> t.getUserId()).collect(Collectors.toList());\n+                    List<User> users = userMapper.selectBatchIds(userIds);\n+                    String userNames = users.stream().map(t -> t.getUserName()).collect(Collectors.toList()).toString();\n+                    logger.error(\"resource is authorized to user {},suffix not allowed to be modified\", userNames);\n+                    putMsg(result,Status.RESOURCE_IS_AUTHORIZED,userNames);\n                     return result;\n                 }\n             }\n"}}, {"oid": "f06919c89fae726038078760f47dbb8176c04ea1", "url": "https://github.com/apache/dolphinscheduler/commit/f06919c89fae726038078760f47dbb8176c04ea1", "message": "Merge remote-tracking branch 'remotes/upstream/dev-1.3.0' into dev-1.3.0-fix-2598", "committedDate": "2020-05-18T06:23:25Z", "type": "commit"}, {"oid": "ad33b8b14514d718d07687d5b166fcdafe7115f8", "url": "https://github.com/apache/dolphinscheduler/commit/ad33b8b14514d718d07687d5b166fcdafe7115f8", "message": "verify whether the suffix is empty", "committedDate": "2020-05-18T06:50:53Z", "type": "commit"}, {"oid": "1686a862ab178950d38ec350e6441f63619502a4", "url": "https://github.com/apache/dolphinscheduler/commit/1686a862ab178950d38ec350e6441f63619502a4", "message": "Merge remote-tracking branch 'remotes/upstream/dev-1.3.0' into dev-1.3.0-fix-2598", "committedDate": "2020-05-18T08:17:45Z", "type": "commit"}, {"oid": "09cd91ef09b82720abe6deef38718c8c919629fa", "url": "https://github.com/apache/dolphinscheduler/commit/09cd91ef09b82720abe6deef38718c8c919629fa", "message": "remove extra variables", "committedDate": "2020-05-18T08:21:07Z", "type": "commit"}, {"oid": "a6ce6d28031729b3814ada3e8ae01819e019b168", "url": "https://github.com/apache/dolphinscheduler/commit/a6ce6d28031729b3814ada3e8ae01819e019b168", "message": "fix code smell", "committedDate": "2020-05-18T09:20:58Z", "type": "commit"}]}