{"pr_number": 4097, "pr_title": "[FIX-#4084][server]fix taskInstance state change error", "pr_createdAt": "2020-11-24T09:01:10Z", "pr_url": "https://github.com/apache/dolphinscheduler/pull/4097", "timeline": [{"oid": "5355927b79bb1b54b7a6b574726c0b349b01e8bd", "url": "https://github.com/apache/dolphinscheduler/commit/5355927b79bb1b54b7a6b574726c0b349b01e8bd", "message": "[FIX-#4083][server]fix taskInstance state change error\nConcurrent processing of ack message and result message causes the execution sequence to be wrong\n\n# this close # 4083", "committedDate": "2020-11-24T08:59:26Z", "type": "commit"}, {"oid": "b20a3d5474d5f2c66cf6a9d7eac44255b772c8e5", "url": "https://github.com/apache/dolphinscheduler/commit/b20a3d5474d5f2c66cf6a9d7eac44255b772c8e5", "message": "code style", "committedDate": "2020-11-24T09:15:48Z", "type": "commit"}, {"oid": "6c1a2ebeab13c425bd3667162e8d3ab857326e3d", "url": "https://github.com/apache/dolphinscheduler/commit/6c1a2ebeab13c425bd3667162e8d3ab857326e3d", "message": "add taskResponseTest", "committedDate": "2020-11-24T14:49:39Z", "type": "commit"}, {"oid": "9ef6b70696b7e4ede8c4026fbfdf72f4f78139fb", "url": "https://github.com/apache/dolphinscheduler/commit/9ef6b70696b7e4ede8c4026fbfdf72f4f78139fb", "message": "add taskResponseTest", "committedDate": "2020-11-24T15:13:01Z", "type": "commit"}, {"oid": "858c4f32875f2294bac5f1eae11142568bb0f367", "url": "https://github.com/apache/dolphinscheduler/commit/858c4f32875f2294bac5f1eae11142568bb0f367", "message": "code smell", "committedDate": "2020-11-25T01:20:58Z", "type": "commit"}, {"oid": "8286af79d3a77a5aa7b03e1241f56d38d7712f35", "url": "https://github.com/apache/dolphinscheduler/commit/8286af79d3a77a5aa7b03e1241f56d38d7712f35", "message": "Time is too small and the task is not finished", "committedDate": "2020-11-25T01:38:58Z", "type": "commit"}, {"oid": "a164d5f990c988cac7b45a2952f4d6eee5d17e44", "url": "https://github.com/apache/dolphinscheduler/commit/a164d5f990c988cac7b45a2952f4d6eee5d17e44", "message": "Time is too small and the task is not finished", "committedDate": "2020-11-25T02:23:54Z", "type": "commit"}, {"oid": "c6a686a71078638a5ebcdecb30fe5e173deac96d", "url": "https://github.com/apache/dolphinscheduler/commit/c6a686a71078638a5ebcdecb30fe5e173deac96d", "message": "Time is too small and the task is not finished", "committedDate": "2020-11-25T05:27:04Z", "type": "commit"}, {"oid": "b3991d9dee307191f200a6b660d7264d874d3cb9", "url": "https://github.com/apache/dolphinscheduler/commit/b3991d9dee307191f200a6b660d7264d874d3cb9", "message": "Time is too small and the task is not finished", "committedDate": "2020-11-25T05:43:14Z", "type": "commit"}, {"oid": "2a9e789f68d6aba2bdd8a8073ac0abb4b36cd51e", "url": "https://github.com/apache/dolphinscheduler/commit/2a9e789f68d6aba2bdd8a8073ac0abb4b36cd51e", "message": "test", "committedDate": "2020-11-25T06:47:00Z", "type": "commit"}, {"oid": "d5769999d557b834621604930654a3baabdf5372", "url": "https://github.com/apache/dolphinscheduler/commit/d5769999d557b834621604930654a3baabdf5372", "message": "remove assert", "committedDate": "2020-11-25T07:16:19Z", "type": "commit"}, {"oid": "cc14b24326acbbbecc1a93188a31e817667d9ea6", "url": "https://github.com/apache/dolphinscheduler/commit/cc14b24326acbbbecc1a93188a31e817667d9ea6", "message": "test", "committedDate": "2020-11-25T10:11:55Z", "type": "commit"}, {"oid": "0586e7b16004364e69e634e99dab8454ed187bed", "url": "https://github.com/apache/dolphinscheduler/commit/0586e7b16004364e69e634e99dab8454ed187bed", "message": "test", "committedDate": "2020-11-25T14:03:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDc0NDMxMA==", "url": "https://github.com/apache/dolphinscheduler/pull/4097#discussion_r530744310", "bodyText": "i think we should judge the task status finished: success/failed/stop...", "author": "lenboo", "createdAt": "2020-11-26T02:51:18Z", "path": "dolphinscheduler-server/src/main/java/org/apache/dolphinscheduler/server/master/processor/queue/TaskResponseService.java", "diffHunk": "@@ -126,51 +127,52 @@ public void run() {\n \n     /**\n      * persist  taskResponseEvent\n+     *\n      * @param taskResponseEvent taskResponseEvent\n      */\n-    private void persist(TaskResponseEvent taskResponseEvent){\n+    private void persist(TaskResponseEvent taskResponseEvent) {\n         Event event = taskResponseEvent.getEvent();\n         Channel channel = taskResponseEvent.getChannel();\n \n-        switch (event){\n+        switch (event) {\n             case ACK:\n                 try {\n                     TaskInstance taskInstance = processService.findTaskInstanceById(taskResponseEvent.getTaskInstanceId());\n-                    if (taskInstance != null){\n-                        processService.changeTaskState(taskResponseEvent.getState(),\n-                                taskResponseEvent.getStartTime(),\n-                                taskResponseEvent.getWorkerAddress(),\n-                                taskResponseEvent.getExecutePath(),\n-                                taskResponseEvent.getLogPath(),\n-                                taskResponseEvent.getTaskInstanceId());\n+                    if (taskInstance != null && ExecutionStatus.SUCCESS.getCode() != taskInstance.getState().getCode()) {", "originalCommit": "0586e7b16004364e69e634e99dab8454ed187bed", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDc1MDg2NQ==", "url": "https://github.com/apache/dolphinscheduler/pull/4097#discussion_r530750865", "bodyText": "Thx,I have corrected it", "author": "CalvinKirs", "createdAt": "2020-11-26T03:18:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDc0NDMxMA=="}], "type": "inlineReview", "revised_code": {"commit": "c9022680214ab80548102f4d1cf12a041635ecb5", "chunk": "diff --git a/dolphinscheduler-server/src/main/java/org/apache/dolphinscheduler/server/master/processor/queue/TaskResponseService.java b/dolphinscheduler-server/src/main/java/org/apache/dolphinscheduler/server/master/processor/queue/TaskResponseService.java\nindex 2678532b9..51ecf454e 100644\n--- a/dolphinscheduler-server/src/main/java/org/apache/dolphinscheduler/server/master/processor/queue/TaskResponseService.java\n+++ b/dolphinscheduler-server/src/main/java/org/apache/dolphinscheduler/server/master/processor/queue/TaskResponseService.java\n\n@@ -138,7 +138,7 @@ public class TaskResponseService {\n             case ACK:\n                 try {\n                     TaskInstance taskInstance = processService.findTaskInstanceById(taskResponseEvent.getTaskInstanceId());\n-                    if (taskInstance != null && ExecutionStatus.SUCCESS.getCode() != taskInstance.getState().getCode()) {\n+                    if (taskInstance != null && !taskInstance.getState().typeIsFinished()) {\n                         processService.changeTaskState(taskInstance, taskResponseEvent.getState(),\n                             taskResponseEvent.getStartTime(),\n                             taskResponseEvent.getWorkerAddress(),\n"}}, {"oid": "c9022680214ab80548102f4d1cf12a041635ecb5", "url": "https://github.com/apache/dolphinscheduler/commit/c9022680214ab80548102f4d1cf12a041635ecb5", "message": "fix task instance status judgment error", "committedDate": "2020-11-26T03:01:34Z", "type": "commit"}]}