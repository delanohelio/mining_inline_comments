{"pr_number": 2023, "pr_title": "Support worker server to run bat script", "pr_createdAt": "2020-02-26T09:57:09Z", "pr_url": "https://github.com/apache/dolphinscheduler/pull/2023", "timeline": [{"oid": "38cf4de031898f4a8bf1137ad6f6e9be4ca9705d", "url": "https://github.com/apache/dolphinscheduler/commit/38cf4de031898f4a8bf1137ad6f6e9be4ca9705d", "message": "Support worker server to run bat script\n\n1. Reimplement ProcessImpl.java, ProcessEnvironment.java and ProcessBuilder.java for Windows\n2. Modify shell task code for windows\n3. Add ASF License", "committedDate": "2020-02-26T09:47:24Z", "type": "commit"}, {"oid": "62307fb1deb6bba1a0c0f5d4b83d8781be890e03", "url": "https://github.com/apache/dolphinscheduler/commit/62307fb1deb6bba1a0c0f5d4b83d8781be890e03", "message": "Add Unit Test", "committedDate": "2020-02-27T09:56:50Z", "type": "commit"}, {"oid": "3f7c69b069d6512d864d7069b2fa5dc4029aaee0", "url": "https://github.com/apache/dolphinscheduler/commit/3f7c69b069d6512d864d7069b2fa5dc4029aaee0", "message": "Add Unit Test", "committedDate": "2020-02-28T01:42:42Z", "type": "commit"}, {"oid": "a82f2815d2b952a28d82c3b17b9a639460870c99", "url": "https://github.com/apache/dolphinscheduler/commit/a82f2815d2b952a28d82c3b17b9a639460870c99", "message": "Add ASF License", "committedDate": "2020-02-28T02:03:52Z", "type": "commit"}, {"oid": "a39e87f3a83a0944866724ad31b2fe0a62d6810e", "url": "https://github.com/apache/dolphinscheduler/commit/a39e87f3a83a0944866724ad31b2fe0a62d6810e", "message": "Add Unit Test", "committedDate": "2020-02-28T04:22:57Z", "type": "commit"}, {"oid": "a570a0db38da769bf09ce31680d720808b3bb8cb", "url": "https://github.com/apache/dolphinscheduler/commit/a570a0db38da769bf09ce31680d720808b3bb8cb", "message": "Add Unit Test", "committedDate": "2020-02-28T05:07:06Z", "type": "commit"}, {"oid": "0dcdae2c5338589cc7c1974060cd31bc6f60cac3", "url": "https://github.com/apache/dolphinscheduler/commit/0dcdae2c5338589cc7c1974060cd31bc6f60cac3", "message": "Add Unit Test", "committedDate": "2020-02-28T05:35:08Z", "type": "commit"}, {"oid": "e8f79ffb1e2af81c0ac3dccf8cf80cc1b7b4bdfd", "url": "https://github.com/apache/dolphinscheduler/commit/e8f79ffb1e2af81c0ac3dccf8cf80cc1b7b4bdfd", "message": "Add Unit Test", "committedDate": "2020-02-28T06:32:29Z", "type": "commit"}, {"oid": "1365070880438767e2e1acdb82de1b5c3032993d", "url": "https://github.com/apache/dolphinscheduler/commit/1365070880438767e2e1acdb82de1b5c3032993d", "message": "Add Unit Test", "committedDate": "2020-02-28T06:40:52Z", "type": "commit"}, {"oid": "7257db86125812a003aac84c11b335b8479159ca", "url": "https://github.com/apache/dolphinscheduler/commit/7257db86125812a003aac84c11b335b8479159ca", "message": "Add Unit Test", "committedDate": "2020-02-28T06:48:58Z", "type": "commit"}, {"oid": "1fe6b97d9437d5cae575542d62069bd495a75f1d", "url": "https://github.com/apache/dolphinscheduler/commit/1fe6b97d9437d5cae575542d62069bd495a75f1d", "message": "Add Unit Test", "committedDate": "2020-02-28T07:36:16Z", "type": "commit"}, {"oid": "f722eb7e9496f6e3524ca46bd967035e88144b7b", "url": "https://github.com/apache/dolphinscheduler/commit/f722eb7e9496f6e3524ca46bd967035e88144b7b", "message": "Add Unit Test", "committedDate": "2020-02-28T07:46:14Z", "type": "commit"}, {"oid": "772e0790133591fad9e290483b38d74d0c779370", "url": "https://github.com/apache/dolphinscheduler/commit/772e0790133591fad9e290483b38d74d0c779370", "message": "Add Unit Test", "committedDate": "2020-02-28T07:52:56Z", "type": "commit"}, {"oid": "ab1c27dbe6bfb4fd8d8f886e7810cedf3f5b3526", "url": "https://github.com/apache/dolphinscheduler/commit/ab1c27dbe6bfb4fd8d8f886e7810cedf3f5b3526", "message": "Add Unit Test", "committedDate": "2020-02-28T08:02:02Z", "type": "commit"}, {"oid": "01714367c7746265ac2d7d75b393631722e2c068", "url": "https://github.com/apache/dolphinscheduler/commit/01714367c7746265ac2d7d75b393631722e2c068", "message": "Add Unit Test", "committedDate": "2020-02-28T10:25:26Z", "type": "commit"}, {"oid": "0e1cedb4ad10efbfed9194e2144ed040a8d9d9ef", "url": "https://github.com/apache/dolphinscheduler/commit/0e1cedb4ad10efbfed9194e2144ed040a8d9d9ef", "message": "Add Unit Test", "committedDate": "2020-02-28T10:36:57Z", "type": "commit"}, {"oid": "6acbfb2f52eabb12e5074a0728106ee067a6e8ba", "url": "https://github.com/apache/dolphinscheduler/commit/6acbfb2f52eabb12e5074a0728106ee067a6e8ba", "message": "Add Unit Test", "committedDate": "2020-02-28T11:02:44Z", "type": "commit"}, {"oid": "b8d04f75a77dac4221738fb8d556fbc55cfdde0b", "url": "https://github.com/apache/dolphinscheduler/commit/b8d04f75a77dac4221738fb8d556fbc55cfdde0b", "message": "Add Unit Test", "committedDate": "2020-02-28T11:11:28Z", "type": "commit"}, {"oid": "d0b91c5629c9f2c891ba2521fabffc496d7d7556", "url": "https://github.com/apache/dolphinscheduler/commit/d0b91c5629c9f2c891ba2521fabffc496d7d7556", "message": "Add Unit Test", "committedDate": "2020-02-28T11:38:54Z", "type": "commit"}, {"oid": "6c42df5c7d41495f5dfcb6b36e23385714dbd148", "url": "https://github.com/apache/dolphinscheduler/commit/6c42df5c7d41495f5dfcb6b36e23385714dbd148", "message": "Modify", "committedDate": "2020-02-28T12:44:20Z", "type": "commit"}, {"oid": "bd26b716b1604ecad5f8fffae40cbdf86269d7e0", "url": "https://github.com/apache/dolphinscheduler/commit/bd26b716b1604ecad5f8fffae40cbdf86269d7e0", "message": "trigger GitHub actions", "committedDate": "2020-02-28T13:33:41Z", "type": "commit"}, {"oid": "3263b6337f431921e8ea1367e29e65849018fb50", "url": "https://github.com/apache/dolphinscheduler/commit/3263b6337f431921e8ea1367e29e65849018fb50", "message": "", "committedDate": "2020-03-02T01:04:15Z", "type": "commit"}, {"oid": "b1fad2b40ba3a405c9f9858d4a5c97f315a8e166", "url": "https://github.com/apache/dolphinscheduler/commit/b1fad2b40ba3a405c9f9858d4a5c97f315a8e166", "message": "Update frontend-maven-plugin version to 1.7.5", "committedDate": "2020-03-02T02:20:53Z", "type": "commit"}, {"oid": "1018f9d5694069ebfe7c48c74db9e7b11f17e5bc", "url": "https://github.com/apache/dolphinscheduler/commit/1018f9d5694069ebfe7c48c74db9e7b11f17e5bc", "message": "Update frontend-maven-plugin version to 1.9.1", "committedDate": "2020-03-02T08:23:13Z", "type": "commit"}, {"oid": "094e738725685630d439890d65c49f70febeff84", "url": "https://github.com/apache/dolphinscheduler/commit/094e738725685630d439890d65c49f70febeff84", "message": "Merge remote-tracking branch 'origin/dev' into dev-support-windows-bat-script", "committedDate": "2020-03-03T06:52:05Z", "type": "commit"}, {"oid": "847f38341c68ac83d8b1148a75f55d1db3020919", "url": "https://github.com/apache/dolphinscheduler/commit/847f38341c68ac83d8b1148a75f55d1db3020919", "message": "merge latest dev branch", "committedDate": "2020-03-03T06:54:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMzNzE5NA==", "url": "https://github.com/apache/dolphinscheduler/pull/2023#discussion_r389337194", "bodyText": "@dailidong what's the different between this class and the internal class? I would prefer remove all duplicated document, emphasize the difference and link to ProcessBuilder's build if there is nothing changed. Also at the beginning of the class document, it is possibly required that we mention it is copied from openjdk with modification, which will help reduce legal risk.", "author": "tisonkun", "createdAt": "2020-03-08T05:32:09Z", "path": "dolphinscheduler-common/src/main/java/org/apache/dolphinscheduler/common/utils/process/ProcessBuilderForWin32.java", "diffHunk": "@@ -0,0 +1,1065 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.dolphinscheduler.common.utils.process;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Map;\n+\n+/**\n+ * This class is used to create operating system processes.\n+ *\n+ * <p>Each {@code ProcessBuilderForWindows} instance manages a collection\n+ * of process attributes.  The {@link #start()} method creates a new\n+ * {@link Process} instance with those attributes.  The {@link\n+ * #start()} method can be invoked repeatedly from the same instance\n+ * to create new subprocesses with identical or related attributes.\n+ *\n+ * <p>Each process builder manages these process attributes:\n+ *\n+ * <ul>\n+ *\n+ * <li>a <i>command</i>, a list of strings which signifies the\n+ * external program file to be invoked and its arguments, if any.\n+ * Which string lists represent a valid operating system command is\n+ * system-dependent.  For example, it is common for each conceptual\n+ * argument to be an element in this list, but there are operating\n+ * systems where programs are expected to tokenize command line\n+ * strings themselves - on such a system a Java implementation might\n+ * require commands to contain exactly two elements.\n+ *\n+ * <li>an <i>environment</i>, which is a system-dependent mapping from\n+ * <i>variables</i> to <i>values</i>.  The initial value is a copy of\n+ * the environment of the current process (see {@link System#getenv()}).\n+ *\n+ * <li>a <i>working directory</i>.  The default value is the current\n+ * working directory of the current process, usually the directory\n+ * named by the system property {@code user.dir}.\n+ *\n+ * <li><a name=\"redirect-input\">a source of <i>standard input</i></a>.\n+ * By default, the subprocess reads input from a pipe.  Java code\n+ * can access this pipe via the output stream returned by\n+ * {@link Process#getOutputStream()}.  However, standard input may\n+ * be redirected to another source using\n+ * {@link #redirectInput(ProcessBuilderForWin32.Redirect) redirectInput}.\n+ * In this case, {@link Process#getOutputStream()} will return a\n+ * <i>null output stream</i>, for which:\n+ *\n+ * <ul>\n+ * <li>the {@link OutputStream#write(int) write} methods always\n+ * throw {@code IOException}\n+ * <li>the {@link OutputStream#close() close} method does nothing\n+ * </ul>\n+ *\n+ * <li><a name=\"redirect-output\">a destination for <i>standard output</i>\n+ * and <i>standard error</i></a>.  By default, the subprocess writes standard\n+ * output and standard error to pipes.  Java code can access these pipes\n+ * via the input streams returned by {@link Process#getInputStream()} and\n+ * {@link Process#getErrorStream()}.  However, standard output and\n+ * standard error may be redirected to other destinations using\n+ * {@link #redirectOutput(ProcessBuilderForWin32.Redirect) redirectOutput} and\n+ * {@link #redirectError(ProcessBuilderForWin32.Redirect) redirectError}.\n+ * In this case, {@link Process#getInputStream()} and/or\n+ * {@link Process#getErrorStream()} will return a <i>null input\n+ * stream</i>, for which:\n+ *\n+ * <ul>\n+ * <li>the {@link InputStream#read() read} methods always return\n+ * {@code -1}\n+ * <li>the {@link InputStream#available() available} method always returns\n+ * {@code 0}\n+ * <li>the {@link InputStream#close() close} method does nothing\n+ * </ul>\n+ *\n+ * <li>a <i>redirectErrorStream</i> property.  Initially, this property\n+ * is {@code false}, meaning that the standard output and error\n+ * output of a subprocess are sent to two separate streams, which can\n+ * be accessed using the {@link Process#getInputStream()} and {@link\n+ * Process#getErrorStream()} methods.\n+ *\n+ * <p>If the value is set to {@code true}, then:\n+ *\n+ * <ul>\n+ * <li>standard error is merged with the standard output and always sent\n+ * to the same destination (this makes it easier to correlate error\n+ * messages with the corresponding output)\n+ * <li>the common destination of standard error and standard output can be\n+ * redirected using\n+ * {@link #redirectOutput(ProcessBuilderForWin32.Redirect) redirectOutput}\n+ * <li>any redirection set by the\n+ * {@link #redirectError(ProcessBuilderForWin32.Redirect) redirectError}\n+ * method is ignored when creating a subprocess\n+ * <li>the stream returned from {@link Process#getErrorStream()} will\n+ * always be a <a href=\"#redirect-output\">null input stream</a>\n+ * </ul>\n+ *\n+ * </ul>\n+ *\n+ * <p>Modifying a process builder's attributes will affect processes\n+ * subsequently started by that object's {@link #start()} method, but\n+ * will never affect previously started processes or the Java process\n+ * itself.\n+ *\n+ * <p>Most error checking is performed by the {@link #start()} method.\n+ * It is possible to modify the state of an object so that {@link\n+ * #start()} will fail.  For example, setting the command attribute to\n+ * an empty list will not throw an exception unless {@link #start()}\n+ * is invoked.\n+ *\n+ * <p><strong>Note that this class is not synchronized.</strong>\n+ * If multiple threads access a {@code ProcessBuilderForWindows} instance\n+ * concurrently, and at least one of the threads modifies one of the\n+ * attributes structurally, it <i>must</i> be synchronized externally.\n+ *\n+ * <p>Starting a new process which uses the default working directory\n+ * and environment is easy:\n+ *\n+ * <pre> {@code\n+ * Process p = new ProcessBuilderForWindows(\"myCommand\", \"myArg\").start();\n+ * }</pre>\n+ *\n+ * <p>Here is an example that starts a process with a modified working\n+ * directory and environment, and redirects standard output and error\n+ * to be appended to a log file:\n+ *\n+ * <pre> {@code\n+ * ProcessBuilderForWindows pb =\n+ *   new ProcessBuilderForWindows(\"myCommand\", \"myArg1\", \"myArg2\");\n+ * Map<String, String> env = pb.environment();\n+ * env.put(\"VAR1\", \"myValue\");\n+ * env.remove(\"OTHERVAR\");\n+ * env.put(\"VAR2\", env.get(\"VAR1\") + \"suffix\");\n+ * pb.directory(new File(\"myDir\"));\n+ * File log = new File(\"log\");\n+ * pb.redirectErrorStream(true);\n+ * pb.redirectOutput(Redirect.appendTo(log));\n+ * Process p = pb.start();\n+ * assert pb.redirectInput() == Redirect.PIPE;\n+ * assert pb.redirectOutput().file() == log;\n+ * assert p.getInputStream().read() == -1;\n+ * }</pre>\n+ *\n+ * <p>To start a process with an explicit set of environment\n+ * variables, first call {@link Map#clear() Map.clear()}\n+ * before adding environment variables.\n+ *\n+ * @author Martin Buchholz\n+ * @since 1.5\n+ */\n+\n+public class ProcessBuilderForWin32 {", "originalCommit": "847f38341c68ac83d8b1148a75f55d1db3020919", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMzNzIwNQ==", "url": "https://github.com/apache/dolphinscheduler/pull/2023#discussion_r389337205", "bodyText": "ditto", "author": "tisonkun", "createdAt": "2020-03-08T05:32:32Z", "path": "dolphinscheduler-common/src/main/java/org/apache/dolphinscheduler/common/utils/process/ProcessEnvironmentForWin32.java", "diffHunk": "@@ -0,0 +1,286 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.dolphinscheduler.common.utils.process;\n+\n+import com.sun.jna.platform.win32.Kernel32Util;\n+\n+import java.util.*;\n+\n+final class ProcessEnvironmentForWin32 extends HashMap<String,String> {", "originalCommit": "847f38341c68ac83d8b1148a75f55d1db3020919", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMzNzIyNg==", "url": "https://github.com/apache/dolphinscheduler/pull/2023#discussion_r389337226", "bodyText": "ditto", "author": "tisonkun", "createdAt": "2020-03-08T05:32:49Z", "path": "dolphinscheduler-common/src/main/java/org/apache/dolphinscheduler/common/utils/process/ProcessImplForWin32.java", "diffHunk": "@@ -0,0 +1,752 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.dolphinscheduler.common.utils.process;\n+\n+import com.sun.jna.Pointer;\n+import com.sun.jna.platform.win32.*;\n+import com.sun.jna.ptr.IntByReference;\n+import sun.security.action.GetPropertyAction;\n+\n+import java.io.*;\n+import java.security.AccessController;\n+import java.security.PrivilegedAction;\n+import java.util.ArrayList;\n+import java.util.Locale;\n+import java.util.concurrent.TimeUnit;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n+import static com.sun.jna.platform.win32.WinBase.STILL_ACTIVE;\n+\n+public class ProcessImplForWin32 extends Process {", "originalCommit": "847f38341c68ac83d8b1148a75f55d1db3020919", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}