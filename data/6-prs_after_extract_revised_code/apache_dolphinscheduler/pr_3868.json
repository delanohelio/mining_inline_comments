{"pr_number": 3868, "pr_title": "[FIX_BUG_1.3#3789][remote]support netty heart beat", "pr_createdAt": "2020-10-05T13:51:58Z", "pr_url": "https://github.com/apache/dolphinscheduler/pull/3868", "timeline": [{"oid": "4b774f12b7179f49a315e08213605c194834e114", "url": "https://github.com/apache/dolphinscheduler/commit/4b774f12b7179f49a315e08213605c194834e114", "message": "[FIX_BUG_1.3#3789][remote]support netty heart beat", "committedDate": "2020-10-04T14:07:27Z", "type": "commit"}, {"oid": "72bb9c336b11d6ab9e0a5f8b30694830dd05ae22", "url": "https://github.com/apache/dolphinscheduler/commit/72bb9c336b11d6ab9e0a5f8b30694830dd05ae22", "message": " netty heart beat", "committedDate": "2020-10-05T13:50:05Z", "type": "commit"}, {"oid": "f14e6b94b870104c10d8ef54d1cd93a7cd833c25", "url": "https://github.com/apache/dolphinscheduler/commit/f14e6b94b870104c10d8ef54d1cd93a7cd833c25", "message": "code style", "committedDate": "2020-10-08T06:20:32Z", "type": "commit"}, {"oid": "aaf7ea0d74939a09223caae1ee9b662e66a4c6da", "url": "https://github.com/apache/dolphinscheduler/commit/aaf7ea0d74939a09223caae1ee9b662e66a4c6da", "message": "code style", "committedDate": "2020-10-08T06:40:55Z", "type": "commit"}, {"oid": "c3463483ab7f495e8eac25aff2f2bc791001dabc", "url": "https://github.com/apache/dolphinscheduler/commit/c3463483ab7f495e8eac25aff2f2bc791001dabc", "message": "code style", "committedDate": "2020-10-08T06:44:23Z", "type": "commit"}, {"oid": "e06e14151da4a08a6e88c87b731d105444bad65e", "url": "https://github.com/apache/dolphinscheduler/commit/e06e14151da4a08a6e88c87b731d105444bad65e", "message": "code style", "committedDate": "2020-10-08T09:20:42Z", "type": "commit"}, {"oid": "3932af57185d7db06c1e5fb84777db26193ec2f1", "url": "https://github.com/apache/dolphinscheduler/commit/3932af57185d7db06c1e5fb84777db26193ec2f1", "message": "code style", "committedDate": "2020-10-08T09:34:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjczMzE2MA==", "url": "https://github.com/apache/dolphinscheduler/pull/3868#discussion_r502733160", "bodyText": "It's better if we distinguish the READER_IDLE and WRITER_IDLE event", "author": "gabrywu", "createdAt": "2020-10-10T02:11:14Z", "path": "dolphinscheduler-remote/src/main/java/org/apache/dolphinscheduler/remote/handler/NettyClientHandler.java", "diffHunk": "@@ -175,4 +183,16 @@ public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws E\n         ctx.channel().close();\n     }\n \n+    @Override\n+    public void userEventTriggered(ChannelHandlerContext ctx, Object evt) throws Exception {\n+        if (evt instanceof IdleStateEvent) {\n+            Command heartBeat = new Command();", "originalCommit": "3932af57185d7db06c1e5fb84777db26193ec2f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjc0MDUzOQ==", "url": "https://github.com/apache/dolphinscheduler/pull/3868#discussion_r502740539", "bodyText": "As far as heartbeat detection is concerned, this seems to be redundant. Regardless of the read and write events, they are all the same events. What do you think?", "author": "CalvinKirs", "createdAt": "2020-10-10T03:35:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjczMzE2MA=="}], "type": "inlineReview", "revised_code": {"commit": "3801147d92a11fc0b13d286fefae8d48975ec9a7", "chunk": "diff --git a/dolphinscheduler-remote/src/main/java/org/apache/dolphinscheduler/remote/handler/NettyClientHandler.java b/dolphinscheduler-remote/src/main/java/org/apache/dolphinscheduler/remote/handler/NettyClientHandler.java\nindex cd4b53543..a988acfe1 100644\n--- a/dolphinscheduler-remote/src/main/java/org/apache/dolphinscheduler/remote/handler/NettyClientHandler.java\n+++ b/dolphinscheduler-remote/src/main/java/org/apache/dolphinscheduler/remote/handler/NettyClientHandler.java\n\n@@ -188,7 +191,9 @@ public class NettyClientHandler extends ChannelInboundHandlerAdapter {\n         if (evt instanceof IdleStateEvent) {\n             Command heartBeat = new Command();\n             heartBeat.setType(CommandType.HEART_BEAT);\n-            ctx.writeAndFlush(heartBeat);\n+            heartBeat.setBody(heartBeatData);\n+            ctx.writeAndFlush(heartBeat)\n+                .addListener(ChannelFutureListener.CLOSE_ON_FAILURE);\n \n         } else {\n             super.userEventTriggered(ctx, evt);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjczMzI1OQ==", "url": "https://github.com/apache/dolphinscheduler/pull/3868#discussion_r502733259", "bodyText": "It's better if we distinguish the READER_IDLE and WRITER_IDLE event", "author": "gabrywu", "createdAt": "2020-10-10T02:12:10Z", "path": "dolphinscheduler-remote/src/main/java/org/apache/dolphinscheduler/remote/handler/NettyServerHandler.java", "diffHunk": "@@ -158,16 +168,26 @@ public void channelWritabilityChanged(ChannelHandlerContext ctx) throws Exceptio\n         if (!ch.isWritable()) {\n             if (logger.isWarnEnabled()) {\n                 logger.warn(\"{} is not writable, over high water level : {}\",\n-                        ch, config.getWriteBufferHighWaterMark());\n+                    ch, config.getWriteBufferHighWaterMark());\n             }\n \n             config.setAutoRead(false);\n         } else {\n             if (logger.isWarnEnabled()) {\n                 logger.warn(\"{} is writable, to low water : {}\",\n-                        ch, config.getWriteBufferLowWaterMark());\n+                    ch, config.getWriteBufferLowWaterMark());\n             }\n             config.setAutoRead(true);\n         }\n     }\n+\n+    @Override\n+    public void userEventTriggered(ChannelHandlerContext ctx, Object evt) throws Exception {\n+        // send heartbeat when read idle.\n+        if (evt instanceof IdleStateEvent) {", "originalCommit": "3932af57185d7db06c1e5fb84777db26193ec2f1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "cadf8d56db1add1a45e54e36c8de7db1dd3cca58", "chunk": "diff --git a/dolphinscheduler-remote/src/main/java/org/apache/dolphinscheduler/remote/handler/NettyServerHandler.java b/dolphinscheduler-remote/src/main/java/org/apache/dolphinscheduler/remote/handler/NettyServerHandler.java\nindex 5a4497995..09e41e9b5 100644\n--- a/dolphinscheduler-remote/src/main/java/org/apache/dolphinscheduler/remote/handler/NettyServerHandler.java\n+++ b/dolphinscheduler-remote/src/main/java/org/apache/dolphinscheduler/remote/handler/NettyServerHandler.java\n\n@@ -183,7 +183,6 @@ public class NettyServerHandler extends ChannelInboundHandlerAdapter {\n \n     @Override\n     public void userEventTriggered(ChannelHandlerContext ctx, Object evt) throws Exception {\n-        // send heartbeat when read idle.\n         if (evt instanceof IdleStateEvent) {\n             ctx.channel().close();\n         } else {\n"}}, {"oid": "cadf8d56db1add1a45e54e36c8de7db1dd3cca58", "url": "https://github.com/apache/dolphinscheduler/commit/cadf8d56db1add1a45e54e36c8de7db1dd3cca58", "message": "delete code docs", "committedDate": "2020-10-10T03:33:04Z", "type": "commit"}, {"oid": "3801147d92a11fc0b13d286fefae8d48975ec9a7", "url": "https://github.com/apache/dolphinscheduler/commit/3801147d92a11fc0b13d286fefae8d48975ec9a7", "message": "client fail-close", "committedDate": "2020-10-12T02:52:52Z", "type": "commit"}]}