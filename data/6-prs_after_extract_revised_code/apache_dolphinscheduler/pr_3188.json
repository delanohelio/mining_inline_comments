{"pr_number": 3188, "pr_title": "[Bug-3187]close Heartbeat thread pool when MasterRegistry unRegistry", "pr_createdAt": "2020-07-10T17:38:10Z", "pr_url": "https://github.com/apache/dolphinscheduler/pull/3188", "timeline": [{"oid": "a4320a936143acbe0a211ed09434e40cda32da92", "url": "https://github.com/apache/dolphinscheduler/commit/a4320a936143acbe0a211ed09434e40cda32da92", "message": "[Bug-3187]close Heartbeat thread pool when MasterRegistry unRegistry", "committedDate": "2020-07-10T17:35:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjk5NDMxNw==", "url": "https://github.com/apache/dolphinscheduler/pull/3188#discussion_r452994317", "bodyText": "It\u2019s a bit redundant here. If it\u2019s just for testing, I don\u2019t think it\u2019s necessary.", "author": "CalvinKirs", "createdAt": "2020-07-10T18:04:41Z", "path": "dolphinscheduler-server/src/main/java/org/apache/dolphinscheduler/server/master/registry/MasterRegistry.java", "diffHunk": "@@ -137,4 +142,7 @@ private String getLocalAddress(){\n \n     }\n \n+    public ScheduledExecutorService getHeartBeatExecutor() {\n+        return heartBeatExecutor;\n+    }", "originalCommit": "a4320a936143acbe0a211ed09434e40cda32da92", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE0OTkwOQ==", "url": "https://github.com/apache/dolphinscheduler/pull/3188#discussion_r453149909", "bodyText": "It\u2019s a bit redundant here. If it\u2019s just for testing, I don\u2019t think it\u2019s necessary.\n\nI agree with @CalvinKirs .", "author": "yangyichao-mango", "createdAt": "2020-07-11T03:39:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjk5NDMxNw=="}], "type": "inlineReview", "revised_code": {"commit": "a97d8ecc1902e8e884d19e7541ab4550981bf74d", "chunk": "diff --git a/dolphinscheduler-server/src/main/java/org/apache/dolphinscheduler/server/master/registry/MasterRegistry.java b/dolphinscheduler-server/src/main/java/org/apache/dolphinscheduler/server/master/registry/MasterRegistry.java\nindex c32a7bfb0..04fb79f80 100644\n--- a/dolphinscheduler-server/src/main/java/org/apache/dolphinscheduler/server/master/registry/MasterRegistry.java\n+++ b/dolphinscheduler-server/src/main/java/org/apache/dolphinscheduler/server/master/registry/MasterRegistry.java\n\n@@ -142,7 +135,4 @@ public class MasterRegistry {\n \n     }\n \n-    public ScheduledExecutorService getHeartBeatExecutor() {\n-        return heartBeatExecutor;\n-    }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE0OTg1Nw==", "url": "https://github.com/apache/dolphinscheduler/pull/3188#discussion_r453149857", "bodyText": "Hi,\nGood job, is it better to refer to WorkerRegistry[1] to use heartBeatExecutor.shutdownNow()?\n[1] https://github.com/apache/incubator-dolphinscheduler/blob/dev/dolphinscheduler-server/src/main/java/org/apache/dolphinscheduler/server/worker/registry/WorkerRegistry.java", "author": "yangyichao-mango", "createdAt": "2020-07-11T03:39:24Z", "path": "dolphinscheduler-server/src/main/java/org/apache/dolphinscheduler/server/master/registry/MasterRegistry.java", "diffHunk": "@@ -113,6 +110,14 @@ public void stateChanged(CuratorFramework client, ConnectionState newState) {\n     public void unRegistry() {\n         String address = getLocalAddress();\n         String localNodePath = getMasterPath();\n+        heartBeatExecutor.shutdown();\n+        try {\n+            if (heartBeatExecutor.awaitTermination(masterConfig.getMasterHeartbeatInterval(), TimeUnit.SECONDS)) {\n+                logger.warn(\"The heartbeat executor does not shutdown\");\n+            }\n+        } catch (InterruptedException e) {\n+            logger.warn(\"The heartbeat executor is interrupted\");\n+        }", "originalCommit": "a4320a936143acbe0a211ed09434e40cda32da92", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzIxMjM4Mg==", "url": "https://github.com/apache/dolphinscheduler/pull/3188#discussion_r453212382", "bodyText": "solved", "author": "tswstarplanet", "createdAt": "2020-07-11T16:44:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE0OTg1Nw=="}], "type": "inlineReview", "revised_code": {"commit": "a97d8ecc1902e8e884d19e7541ab4550981bf74d", "chunk": "diff --git a/dolphinscheduler-server/src/main/java/org/apache/dolphinscheduler/server/master/registry/MasterRegistry.java b/dolphinscheduler-server/src/main/java/org/apache/dolphinscheduler/server/master/registry/MasterRegistry.java\nindex c32a7bfb0..04fb79f80 100644\n--- a/dolphinscheduler-server/src/main/java/org/apache/dolphinscheduler/server/master/registry/MasterRegistry.java\n+++ b/dolphinscheduler-server/src/main/java/org/apache/dolphinscheduler/server/master/registry/MasterRegistry.java\n\n@@ -110,14 +110,7 @@ public class MasterRegistry {\n     public void unRegistry() {\n         String address = getLocalAddress();\n         String localNodePath = getMasterPath();\n-        heartBeatExecutor.shutdown();\n-        try {\n-            if (heartBeatExecutor.awaitTermination(masterConfig.getMasterHeartbeatInterval(), TimeUnit.SECONDS)) {\n-                logger.warn(\"The heartbeat executor does not shutdown\");\n-            }\n-        } catch (InterruptedException e) {\n-            logger.warn(\"The heartbeat executor is interrupted\");\n-        }\n+        heartBeatExecutor.shutdownNow();\n         zookeeperRegistryCenter.getZookeeperCachedOperator().remove(localNodePath);\n         logger.info(\"master node : {} unRegistry to ZK.\", address);\n     }\n"}}, {"oid": "5b0e157b3c2833f05478c7dc4408e69f73a74008", "url": "https://github.com/apache/dolphinscheduler/commit/5b0e157b3c2833f05478c7dc4408e69f73a74008", "message": "Merge branch 'dev' into close_thread_pool", "committedDate": "2020-07-11T04:21:02Z", "type": "commit"}, {"oid": "a97d8ecc1902e8e884d19e7541ab4550981bf74d", "url": "https://github.com/apache/dolphinscheduler/commit/a97d8ecc1902e8e884d19e7541ab4550981bf74d", "message": "use shutdownNow; delete redundant code", "committedDate": "2020-07-11T04:27:43Z", "type": "commit"}, {"oid": "26f291078fd3c5522a08fbbf0703e765969c5fc2", "url": "https://github.com/apache/dolphinscheduler/commit/26f291078fd3c5522a08fbbf0703e765969c5fc2", "message": "Merge branch 'dev' into close_thread_pool", "committedDate": "2020-07-12T03:34:42Z", "type": "commit"}]}