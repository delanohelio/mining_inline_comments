{"pr_number": 3746, "pr_title": "[fix-3745][server] server get tasktype NPE exception", "pr_createdAt": "2020-09-15T04:41:56Z", "pr_url": "https://github.com/apache/dolphinscheduler/pull/3746", "timeline": [{"oid": "d10972ae40167b4f8d42de9de874c21e270fe851", "url": "https://github.com/apache/dolphinscheduler/commit/d10972ae40167b4f8d42de9de874c21e270fe851", "message": "server task type npe fix.", "committedDate": "2020-09-15T01:42:35Z", "type": "commit"}, {"oid": "b152c9c40f05f3d840c1da989cb49d30ff791d22", "url": "https://github.com/apache/dolphinscheduler/commit/b152c9c40f05f3d840c1da989cb49d30ff791d22", "message": "server task type npe fix.", "committedDate": "2020-09-15T04:28:13Z", "type": "commit"}, {"oid": "30f8f27643efeac8576983105db0fea37f7f0bb9", "url": "https://github.com/apache/dolphinscheduler/commit/30f8f27643efeac8576983105db0fea37f7f0bb9", "message": "add checkstyle.", "committedDate": "2020-09-15T05:23:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTE1OTg0NQ==", "url": "https://github.com/apache/dolphinscheduler/pull/3746#discussion_r489159845", "bodyText": "Why not throw InvalidArgumentException?", "author": "Technoboy-", "createdAt": "2020-09-16T04:51:00Z", "path": "dolphinscheduler-common/src/main/java/org/apache/dolphinscheduler/common/utils/TaskParametersUtils.java", "diffHunk": "@@ -55,41 +55,42 @@ private TaskParametersUtils() {\n      * @return task parameters\n      */\n     public static AbstractParameters getParameters(String taskType, String parameter) {\n-        try {\n-            switch (EnumUtils.getEnum(TaskType.class, taskType)) {\n-                case SUB_PROCESS:\n-                    return JSONUtils.parseObject(parameter, SubProcessParameters.class);\n-                case SHELL:\n-                case WATERDROP:\n-                    return JSONUtils.parseObject(parameter, ShellParameters.class);\n-                case PROCEDURE:\n-                    return JSONUtils.parseObject(parameter, ProcedureParameters.class);\n-                case SQL:\n-                    return JSONUtils.parseObject(parameter, SqlParameters.class);\n-                case MR:\n-                    return JSONUtils.parseObject(parameter, MapreduceParameters.class);\n-                case SPARK:\n-                    return JSONUtils.parseObject(parameter, SparkParameters.class);\n-                case PYTHON:\n-                    return JSONUtils.parseObject(parameter, PythonParameters.class);\n-                case DEPENDENT:\n-                    return JSONUtils.parseObject(parameter, DependentParameters.class);\n-                case FLINK:\n-                    return JSONUtils.parseObject(parameter, FlinkParameters.class);\n-                case HTTP:\n-                    return JSONUtils.parseObject(parameter, HttpParameters.class);\n-                case DATAX:\n-                    return JSONUtils.parseObject(parameter, DataxParameters.class);\n-                case CONDITIONS:\n-                    return JSONUtils.parseObject(parameter, ConditionsParameters.class);\n-                case SQOOP:\n-                    return JSONUtils.parseObject(parameter, SqoopParameters.class);\n-                default:\n-                    return null;\n-            }\n-        } catch (Exception e) {\n-            logger.error(e.getMessage(), e);\n+        TaskType anEnum = EnumUtils.getEnum(TaskType.class, taskType);\n+        if (anEnum == null) {\n+            logger.error(\"not support task type: {}\", taskType);\n+            return null;", "originalCommit": "30f8f27643efeac8576983105db0fea37f7f0bb9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTE2MDIyNw==", "url": "https://github.com/apache/dolphinscheduler/pull/3746#discussion_r489160227", "bodyText": "Why not throw InvalidArgumentException?\n\n+1\uff0c fail fast will be better.", "author": "yangyichao-mango", "createdAt": "2020-09-16T04:52:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTE1OTg0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTMwMjEwNQ==", "url": "https://github.com/apache/dolphinscheduler/pull/3746#discussion_r489302105", "bodyText": "This method is called by multiple methods in the project, which has a big impact. It still returns null according to the original logic of the method. This time, we mainly deal with the switch null pointer problem.\n\n\u8fd9\u4e2a\u65b9\u6cd5\u88ab\u9879\u76ee\u91cc\u9762\u591a\u4e2a\u65b9\u6cd5\u8c03\u7528\uff0c\u5f71\u54cd\u5927\uff0c\u8fd8\u662f\u6309\u65b9\u6cd5\u539f\u903b\u8f91\u8fd4\u56denull,\u672c\u6b21\u4e3b\u8981\u5904\u7406switch \u7a7a\u6307\u9488\u95ee\u9898\u3002", "author": "zhuangchong", "createdAt": "2020-09-16T09:36:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTE1OTg0NQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTE2MDIxMQ==", "url": "https://github.com/apache/dolphinscheduler/pull/3746#discussion_r489160211", "bodyText": "The best practice for this should be @test(expected= IllegalArgumentException.class)", "author": "Technoboy-", "createdAt": "2020-09-16T04:52:28Z", "path": "dolphinscheduler-server/src/test/java/org/apache/dolphinscheduler/server/worker/task/TaskManagerTest.java", "diffHunk": "@@ -95,9 +97,19 @@ public void testNewTask() {\n         Assert.assertNotNull(TaskManager.newTask(taskExecutionContext,taskLogger));\n         taskExecutionContext.setTaskType(\"SQOOP\");\n         Assert.assertNotNull(TaskManager.newTask(taskExecutionContext,taskLogger));\n-        //taskExecutionContext.setTaskType(null);\n-        //Assert.assertNull(TaskManager.newTask(taskExecutionContext,taskLogger));\n-        //taskExecutionContext.setTaskType(\"XXX\");\n-        //Assert.assertNotNull(TaskManager.newTask(taskExecutionContext,taskLogger));\n+        try {\n+            taskExecutionContext.setTaskType(null);\n+            TaskManager.newTask(taskExecutionContext,taskLogger);\n+        } catch (Exception e) {\n+            logger.error(e.getMessage());\n+        }\n+\n+        try {\n+            taskExecutionContext.setTaskType(\"XXX\");", "originalCommit": "30f8f27643efeac8576983105db0fea37f7f0bb9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTMwMDMwNg==", "url": "https://github.com/apache/dolphinscheduler/pull/3746#discussion_r489300306", "bodyText": "done", "author": "zhuangchong", "createdAt": "2020-09-16T09:33:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTE2MDIxMQ=="}], "type": "inlineReview", "revised_code": {"commit": "f9cb3cc9af23048c67a70ba087a0647c7d7cfccb", "chunk": "diff --git a/dolphinscheduler-server/src/test/java/org/apache/dolphinscheduler/server/worker/task/TaskManagerTest.java b/dolphinscheduler-server/src/test/java/org/apache/dolphinscheduler/server/worker/task/TaskManagerTest.java\nindex 812c7c9f5..eb0383979 100644\n--- a/dolphinscheduler-server/src/test/java/org/apache/dolphinscheduler/server/worker/task/TaskManagerTest.java\n+++ b/dolphinscheduler-server/src/test/java/org/apache/dolphinscheduler/server/worker/task/TaskManagerTest.java\n\n@@ -97,19 +97,18 @@ public class TaskManagerTest {\n         Assert.assertNotNull(TaskManager.newTask(taskExecutionContext,taskLogger));\n         taskExecutionContext.setTaskType(\"SQOOP\");\n         Assert.assertNotNull(TaskManager.newTask(taskExecutionContext,taskLogger));\n-        try {\n-            taskExecutionContext.setTaskType(null);\n-            TaskManager.newTask(taskExecutionContext,taskLogger);\n-        } catch (Exception e) {\n-            logger.error(e.getMessage());\n-        }\n-\n-        try {\n-            taskExecutionContext.setTaskType(\"XXX\");\n-            TaskManager.newTask(taskExecutionContext,taskLogger);\n-        } catch (Exception e) {\n-            logger.error(e.getMessage());\n-        }\n \n     }\n+\n+    @Test(expected = IllegalArgumentException.class)\n+    public void testNewTaskIsNull() {\n+        taskExecutionContext.setTaskType(null);\n+        TaskManager.newTask(taskExecutionContext,taskLogger);\n+    }\n+\n+    @Test(expected = IllegalArgumentException.class)\n+    public void testNewTaskIsNotExists() {\n+        taskExecutionContext.setTaskType(\"XXX\");\n+        TaskManager.newTask(taskExecutionContext,taskLogger);\n+    }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTE1OTc2Mg==", "url": "https://github.com/apache/dolphinscheduler/pull/3746#discussion_r489159762", "bodyText": "it will be better to use log pattern\uff0cnot string format.", "author": "yangyichao-mango", "createdAt": "2020-09-16T04:50:40Z", "path": "dolphinscheduler-server/src/main/java/org/apache/dolphinscheduler/server/worker/task/TaskManager.java", "diffHunk": "@@ -69,8 +74,9 @@ public static AbstractTask newTask(TaskExecutionContext taskExecutionContext, Lo\n             case SQOOP:\n                 return new SqoopTask(taskExecutionContext, logger);\n             default:\n-                logger.error(\"unsupport task type: {}\", taskExecutionContext.getTaskType());\n-                throw new IllegalArgumentException(\"not support task type\");\n+                String msg = String.format(\"not support task type: %s\", taskExecutionContext.getTaskType());", "originalCommit": "30f8f27643efeac8576983105db0fea37f7f0bb9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTMwMDM4Mg==", "url": "https://github.com/apache/dolphinscheduler/pull/3746#discussion_r489300382", "bodyText": "done", "author": "zhuangchong", "createdAt": "2020-09-16T09:33:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTE1OTc2Mg=="}], "type": "inlineReview", "revised_code": {"commit": "f9cb3cc9af23048c67a70ba087a0647c7d7cfccb", "chunk": "diff --git a/dolphinscheduler-server/src/main/java/org/apache/dolphinscheduler/server/worker/task/TaskManager.java b/dolphinscheduler-server/src/main/java/org/apache/dolphinscheduler/server/worker/task/TaskManager.java\nindex c399816f7..a9463336b 100644\n--- a/dolphinscheduler-server/src/main/java/org/apache/dolphinscheduler/server/worker/task/TaskManager.java\n+++ b/dolphinscheduler-server/src/main/java/org/apache/dolphinscheduler/server/worker/task/TaskManager.java\n\n@@ -74,9 +73,8 @@ public class TaskManager {\n             case SQOOP:\n                 return new SqoopTask(taskExecutionContext, logger);\n             default:\n-                String msg = String.format(\"not support task type: %s\", taskExecutionContext.getTaskType());\n-                logger.error(msg);\n-                throw new IllegalArgumentException(msg);\n+                logger.error(\"not support task type: {}\", taskExecutionContext.getTaskType());\n+                throw new IllegalArgumentException(\"not support task type\");\n         }\n     }\n }\n"}}, {"oid": "f9cb3cc9af23048c67a70ba087a0647c7d7cfccb", "url": "https://github.com/apache/dolphinscheduler/commit/f9cb3cc9af23048c67a70ba087a0647c7d7cfccb", "message": "update.", "committedDate": "2020-09-16T09:16:07Z", "type": "commit"}]}