{"pr_number": 1196, "pr_title": "gRPC memory leak fix + bench test app", "pr_createdAt": "2020-05-21T12:49:45Z", "pr_url": "https://github.com/elastic/apm-agent-java/pull/1196", "timeline": [{"oid": "ec94eb623c98822f2fa9102858e5fb1c5b23efcd", "url": "https://github.com/elastic/apm-agent-java/commit/ec94eb623c98822f2fa9102858e5fb1c5b23efcd", "message": "remove servercall leak", "committedDate": "2020-05-21T12:46:42Z", "type": "commit"}, {"oid": "fc40538e4c86a1496a7f1dffa729d98a48371fc9", "url": "https://github.com/elastic/apm-agent-java/commit/fc40538e4c86a1496a7f1dffa729d98a48371fc9", "message": "add benchmark to test app", "committedDate": "2020-05-27T15:39:37Z", "type": "commit"}, {"oid": "a0197a0e8cdfbb1b91e1b4ce6484f13536476f2f", "url": "https://github.com/elastic/apm-agent-java/commit/a0197a0e8cdfbb1b91e1b4ce6484f13536476f2f", "message": "update test app readme with new options", "committedDate": "2020-05-27T15:42:49Z", "type": "commit"}, {"oid": "b5540834404db59d569344c846b579323b40b74a", "url": "https://github.com/elastic/apm-agent-java/commit/b5540834404db59d569344c846b579323b40b74a", "message": "add wait option for interactive start/end", "committedDate": "2020-05-27T16:09:22Z", "type": "commit"}, {"oid": "3263c94cff0b106c1f9c880731e6f04e7d2f6323", "url": "https://github.com/elastic/apm-agent-java/commit/3263c94cff0b106c1f9c880731e6f04e7d2f6323", "message": "init server with limited pool", "committedDate": "2020-05-27T16:30:16Z", "type": "commit"}, {"oid": "921071fd53a00311a19ae4f31868510f659c637f", "url": "https://github.com/elastic/apm-agent-java/commit/921071fd53a00311a19ae4f31868510f659c637f", "message": "avoid infinite nested calls", "committedDate": "2020-05-29T08:13:13Z", "type": "commit"}, {"oid": "eadbbfad6dee0c96800c7999970edebdbe57d771", "url": "https://github.com/elastic/apm-agent-java/commit/eadbbfad6dee0c96800c7999970edebdbe57d771", "message": "add deadline and fix too deep nested calls", "committedDate": "2020-05-29T18:40:50Z", "type": "commit"}, {"oid": "71891016830d6f6dcbdf1844b57e98ddf2704adf", "url": "https://github.com/elastic/apm-agent-java/commit/71891016830d6f6dcbdf1844b57e98ddf2704adf", "message": "fix memory leak by terminating at 'onHalfClose'", "committedDate": "2020-06-03T14:18:23Z", "type": "commit"}, {"oid": "c81dd85afe98c3abe9ab498f8da9d655540e65aa", "url": "https://github.com/elastic/apm-agent-java/commit/c81dd85afe98c3abe9ab498f8da9d655540e65aa", "message": "relax deadline for CI", "committedDate": "2020-06-05T13:20:54Z", "type": "commit"}, {"oid": "c79a09878e46e562ae4efc02ba0fca0ce808569e", "url": "https://github.com/elastic/apm-agent-java/commit/c79a09878e46e562ae4efc02ba0fca0ce808569e", "message": "use random port for testing", "committedDate": "2020-06-08T08:37:23Z", "type": "commit"}, {"oid": "df4cf5cce44e4cff71877846a422182b1b3d9efd", "url": "https://github.com/elastic/apm-agent-java/commit/df4cf5cce44e4cff71877846a422182b1b3d9efd", "message": "move random port to core module", "committedDate": "2020-06-08T09:10:04Z", "type": "commit"}, {"oid": "9ebd149e6725ce921467cf2c3d41db5f09b956e7", "url": "https://github.com/elastic/apm-agent-java/commit/9ebd149e6725ce921467cf2c3d41db5f09b956e7", "message": "avoid using all server threads in tests", "committedDate": "2020-06-08T16:25:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjkyNzcyOA==", "url": "https://github.com/elastic/apm-agent-java/pull/1196#discussion_r436927728", "bodyText": "this change was the one that fixed the memory leak, as it seems that some calls to onComplete are not always executed at all, or are executed in an unexpected order.", "author": "SylvainJuge", "createdAt": "2020-06-08T19:02:22Z", "path": "apm-agent-plugins/apm-grpc/apm-grpc-plugin/src/main/java/co/elastic/apm/agent/grpc/ServerCallListenerInstrumentation.java", "diffHunk": "@@ -151,7 +148,14 @@ public FinalMethodCall(ElasticApmTracer tracer) {\n                 //\n                 // call complete (but client not guaranteed to get all messages)\n                 // --> end of unary call (success)\n-                .or(named(\"onComplete\"));\n+                .or(named(\"onComplete\"))\n+                //\n+                // client completed all message sending, but can still cancel the call\n+                // --> for unary calls, actual method invocation is done within 'onHalfClose' method, and there is no\n+                // call to 'onComplete', thus consider it as 'final' allows to properly perform cleanup as it's the last\n+                // method that will be invoked on the listener.\n+                //\n+                .or(named(\"onHalfClose\"));", "originalCommit": "9ebd149e6725ce921467cf2c3d41db5f09b956e7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzI0MTk0Mw==", "url": "https://github.com/elastic/apm-agent-java/pull/1196#discussion_r437241943", "bodyText": "I don't think that's the issue. The problem is that we're only instrumenting server call listeners, that contain Unary in the class name. The UnaryServerCallListener doesn't override the noop onComplete callback.\nAnother issue is that the transaction is ended in co.elastic.apm.agent.grpc.ServerCallInstrumentation#onExit (on ServerCall#close). The effect is that even when instrumenting io.grpc.ServerCall.Listener#onComplete, the helper is not called, because the transaction has already ended.\nFurthermore, the fact that inFlightServerListeners is of type WeakConcurrentMap<ServerCall.Listener<?>, ServerCall<?, ?>> imposes a risk of a memory leak as ServerCall is not a weak reference. Have you considered mapping directly to the transaction (WeakConcurrentMap<ServerCall.Listener<?>, Transaction>)?\nSimilar story for client instrumentation. Changing the signature to WeakConcurrentMap<ClientCall.Listener<?>, Span> inFlightClientListeners would eliminate the chance of leaks and allows direct lookup of a span given a listener.\nAnother simplification of the client instrumentation could be done by removing co.elastic.apm.agent.grpc.ClientCallImplInstrumentation.Constructor and doing that inside co.elastic.apm.agent.grpc.ChannelInstrumentation (which instruments io.grpc.Channel#newCall). That would be more in line with the server instrumentation in co.elastic.apm.agent.grpc.ServerCallHandlerInstrumentation (instrumenting io.grpc.ServerCallHandler#startCall). And allows you to start the span before the constructor is invoked. In the exit advice you can then use the return value.", "author": "felixbarny", "createdAt": "2020-06-09T08:49:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjkyNzcyOA=="}], "type": "inlineReview", "revised_code": {"commit": "e5855f0e268cb41d84d3cd06489c5679a0813502", "chunk": "diff --git a/apm-agent-plugins/apm-grpc/apm-grpc-plugin/src/main/java/co/elastic/apm/agent/grpc/ServerCallListenerInstrumentation.java b/apm-agent-plugins/apm-grpc/apm-grpc-plugin/src/main/java/co/elastic/apm/agent/grpc/ServerCallListenerInstrumentation.java\nindex 5b4a8cf56..43e7d4580 100644\n--- a/apm-agent-plugins/apm-grpc/apm-grpc-plugin/src/main/java/co/elastic/apm/agent/grpc/ServerCallListenerInstrumentation.java\n+++ b/apm-agent-plugins/apm-grpc/apm-grpc-plugin/src/main/java/co/elastic/apm/agent/grpc/ServerCallListenerInstrumentation.java\n\n@@ -148,14 +149,7 @@ public abstract class ServerCallListenerInstrumentation extends BaseInstrumentat\n                 //\n                 // call complete (but client not guaranteed to get all messages)\n                 // --> end of unary call (success)\n-                .or(named(\"onComplete\"))\n-                //\n-                // client completed all message sending, but can still cancel the call\n-                // --> for unary calls, actual method invocation is done within 'onHalfClose' method, and there is no\n-                // call to 'onComplete', thus consider it as 'final' allows to properly perform cleanup as it's the last\n-                // method that will be invoked on the listener.\n-                //\n-                .or(named(\"onHalfClose\"));\n+                .or(named(\"onComplete\"));\n         }\n \n         @Advice.OnMethodEnter(suppress = Throwable.class)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjkyODQzOQ==", "url": "https://github.com/elastic/apm-agent-java/pull/1196#discussion_r436928439", "bodyText": "this allows to have more than one test running on the same host without conflict.", "author": "SylvainJuge", "createdAt": "2020-06-08T19:03:09Z", "path": "apm-agent-plugins/apm-grpc/apm-grpc-plugin/src/test/java/co/elastic/apm/agent/grpc/GrpcTest.java", "diffHunk": "@@ -26,10 +26,11 @@\n \n import co.elastic.apm.agent.grpc.testapp.GrpcApp;\n import co.elastic.apm.agent.grpc.testapp.GrpcAppProvider;\n+import co.elastic.apm.agent.testutils.TestPort;\n \n public class GrpcTest {\n \n-    private static final int PORT = 50051;\n+    private static final int PORT = TestPort.getAvailableRandomPort();", "originalCommit": "9ebd149e6725ce921467cf2c3d41db5f09b956e7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjkzMDAyMw==", "url": "https://github.com/elastic/apm-agent-java/pull/1196#discussion_r436930023", "bodyText": "this one deserves a facepalm and was the cause of the failure on CI, as CI server has less cores than a decent laptop (likely 4), thus server was running with 2 threads in thread pool, which makes the 3rd nested call fail with a missed deadline.", "author": "SylvainJuge", "createdAt": "2020-06-08T19:05:06Z", "path": "apm-agent-plugins/apm-grpc/apm-grpc-plugin/src/test/java/co/elastic/apm/agent/grpc/testapp/AbstractGrpcAppTest.java", "diffHunk": "@@ -86,9 +87,15 @@ void simpleErrorCall() {\n     @Test\n     void nestedChecks() {\n         for (SendAndCheckMessageStrategy strategy : STRATEGIES) {\n-            strategy.sendAndCheckMessage(app, \"joe\", 0, \"hello(joe)\");\n-            strategy.sendAndCheckMessage(app, \"bob\", 1, \"nested(1)->hello(bob)\");\n-            strategy.sendAndCheckMessage(app, \"rob\", 2, \"nested(2)->nested(1)->hello(rob)\");\n+            // because nested call is done with a blocking call, we have to make sure that we don't use all sever\n+            // threads otherwise we get exceeded deadlines\n+            for (int depth = 0; depth < HelloServer.POOL_SIZE; depth++) {\n+                StringBuilder prefix = new StringBuilder();\n+                for (int i = 1; i <= depth; i++) {\n+                    prefix.insert(0, String.format(\"nested(%d)->\", i));\n+                }\n+                strategy.sendAndCheckMessage(app, \"joe\", depth, prefix + \"hello(joe)\");\n+            }", "originalCommit": "9ebd149e6725ce921467cf2c3d41db5f09b956e7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjkzMDUzMA==", "url": "https://github.com/elastic/apm-agent-java/pull/1196#discussion_r436930530", "bodyText": "adding a deadline makes remote calls fail with timeout instead of waiting forever.", "author": "SylvainJuge", "createdAt": "2020-06-08T19:05:39Z", "path": "apm-agent-plugins/apm-grpc/apm-grpc-plugin/src/test/java/co/elastic/apm/agent/grpc/testapp/HelloClient.java", "diffHunk": "@@ -37,17 +38,23 @@\n import java.util.concurrent.Future;\n import java.util.concurrent.TimeUnit;\n import java.util.concurrent.TimeoutException;\n+import java.util.concurrent.atomic.AtomicLong;\n import java.util.concurrent.atomic.AtomicReference;\n import java.util.stream.Collectors;\n \n public abstract class HelloClient<Req, Rep> {\n \n     private static final Logger logger = LoggerFactory.getLogger(HelloClient.class);\n-\n     private final ManagedChannel channel;\n+    private final AtomicLong errorCount;\n \n     protected HelloClient(ManagedChannel channel) {\n         this.channel = channel;\n+        this.errorCount = new AtomicLong(0);\n+    }\n+\n+    protected static Deadline getDeadline() {", "originalCommit": "9ebd149e6725ce921467cf2c3d41db5f09b956e7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1156b4821208e54af7fde663c0d2a15f9f430fd3", "chunk": "diff --git a/apm-agent-plugins/apm-grpc/apm-grpc-plugin/src/test/java/co/elastic/apm/agent/grpc/testapp/HelloClient.java b/apm-agent-plugins/apm-grpc/apm-grpc-plugin/src/test/java/co/elastic/apm/agent/grpc/testapp/HelloClient.java\nindex 79d18a58c..923cf2bb9 100644\n--- a/apm-agent-plugins/apm-grpc/apm-grpc-plugin/src/test/java/co/elastic/apm/agent/grpc/testapp/HelloClient.java\n+++ b/apm-agent-plugins/apm-grpc/apm-grpc-plugin/src/test/java/co/elastic/apm/agent/grpc/testapp/HelloClient.java\n\n@@ -47,10 +53,12 @@ public abstract class HelloClient<Req, Rep> {\n     private static final Logger logger = LoggerFactory.getLogger(HelloClient.class);\n     private final ManagedChannel channel;\n     private final AtomicLong errorCount;\n+    private final AtomicReference<String> exeptionMethod;\n \n     protected HelloClient(ManagedChannel channel) {\n         this.channel = channel;\n         this.errorCount = new AtomicLong(0);\n+        this.exeptionMethod = new AtomicReference<>();\n     }\n \n     protected static Deadline getDeadline() {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzI0MTkwNA==", "url": "https://github.com/elastic/apm-agent-java/pull/1196#discussion_r437241904", "bodyText": "You can also use port 0 which makes it open a random free port, without you having to manually try port after port.", "author": "felixbarny", "createdAt": "2020-06-09T08:49:41Z", "path": "apm-agent-core/src/test/java/co/elastic/apm/agent/testutils/TestPort.java", "diffHunk": "@@ -0,0 +1,59 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.testutils;\n+\n+import javax.net.ServerSocketFactory;\n+import java.net.InetAddress;\n+import java.net.ServerSocket;\n+import java.util.Random;\n+\n+public class TestPort {\n+\n+    private static final Random rand = new Random(System.currentTimeMillis());\n+\n+    private static final int MIN_PORT = 1024;\n+    private static final int MAX_PORT = 65536;\n+\n+    /**\n+     * @return random available TCP port\n+     */\n+    public static int getAvailableRandomPort() {\n+        int port;\n+        do {\n+            port = MIN_PORT + rand.nextInt(MAX_PORT - MIN_PORT + 1);\n+        } while (!isAvailablePort(port));\n+        return port;\n+    }\n+\n+    private static boolean isAvailablePort(int port) {\n+        try {\n+            ServerSocket serverSocket = ServerSocketFactory.getDefault().createServerSocket(port, 1, InetAddress.getByName(\"localhost\"));", "originalCommit": "9ebd149e6725ce921467cf2c3d41db5f09b956e7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "e5855f0e268cb41d84d3cd06489c5679a0813502", "url": "https://github.com/elastic/apm-agent-java/commit/e5855f0e268cb41d84d3cd06489c5679a0813502", "message": "implement changes suggested by felix after review", "committedDate": "2020-06-10T09:59:07Z", "type": "commit"}, {"oid": "569bc0adf1ef83a4acdae1f3cc060509f86ddddc", "url": "https://github.com/elastic/apm-agent-java/commit/569bc0adf1ef83a4acdae1f3cc060509f86ddddc", "message": "code update after latest version", "committedDate": "2020-06-10T09:59:33Z", "type": "commit"}, {"oid": "a94fc24316e438d07c975191f5a9bb7d8e3bb184", "url": "https://github.com/elastic/apm-agent-java/commit/a94fc24316e438d07c975191f5a9bb7d8e3bb184", "message": "simplify client side", "committedDate": "2020-06-10T15:43:06Z", "type": "commit"}, {"oid": "73eb77623999292a8ff054057b459deb019e344b", "url": "https://github.com/elastic/apm-agent-java/commit/73eb77623999292a8ff054057b459deb019e344b", "message": "make client part similar to server & simpler", "committedDate": "2020-06-10T19:22:47Z", "type": "commit"}, {"oid": "9532e73ca53b5c3ba131d4682104b10474182f9f", "url": "https://github.com/elastic/apm-agent-java/commit/9532e73ca53b5c3ba131d4682104b10474182f9f", "message": "Merge branch 'master' of github.com:elastic/apm-agent-java into fix-grpc-leak", "committedDate": "2020-06-10T19:37:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU2ODQ2MA==", "url": "https://github.com/elastic/apm-agent-java/pull/1196#discussion_r438568460", "bodyText": "Why do we only support unary calls?", "author": "felixbarny", "createdAt": "2020-06-11T06:27:32Z", "path": "apm-agent-plugins/apm-grpc/apm-grpc-plugin/src/main/java/co/elastic/apm/agent/grpc/ServerCallHandlerInstrumentation.java", "diffHunk": "@@ -69,35 +67,25 @@ public ServerCallHandlerInstrumentation(ElasticApmTracer tracer) {\n         return named(\"startCall\");\n     }\n \n-    @Advice.OnMethodEnter(suppress = Throwable.class)\n-    private static void onEnter(@Advice.Origin Class<?> clazz,\n-                                @Advice.Argument(0) ServerCall<?, ?> serverCall,\n-                                @Advice.Argument(1) Metadata headers,\n-                                @Advice.Local(\"transaction\") Transaction transaction) {\n+    @Advice.OnMethodExit(suppress = Throwable.class, onThrowable = Throwable.class)\n+    private static void onExit(@Advice.Origin Class<?> clazz,\n+                               @Advice.Thrown @Nullable Throwable thrown,\n+                               @Advice.Argument(0) ServerCall<?, ?> serverCall,\n+                               @Advice.Argument(1) Metadata headers,\n+                               @Advice.Return ServerCall.Listener<?> listener) {\n \n-        if (tracer == null || grpcHelperManager == null) {\n+        if (tracer == null || grpcHelperManager == null || thrown != null) {\n             return;\n         }\n \n-        GrpcHelper helper = grpcHelperManager.getForClassLoaderOfClass(ServerCall.class);\n-        if (helper != null) {\n-            transaction = helper.startTransaction(tracer, clazz.getClassLoader(), serverCall, headers);\n-        }\n-    }\n-\n-    @Advice.OnMethodExit(suppress = Throwable.class, onThrowable = Throwable.class)\n-    private static void onExit(@Advice.Thrown Throwable thrown,\n-                               @Advice.Argument(0) ServerCall<?, ?> serverCall,\n-                               @Advice.Return ServerCall.Listener<?> listener,\n-                               @Advice.Local(\"transaction\") @Nullable Transaction transaction) {\n-\n-        if (tracer == null || grpcHelperManager == null || transaction == null) {\n+        if (serverCall.getMethodDescriptor().getType() != MethodDescriptor.MethodType.UNARY) {", "originalCommit": "9532e73ca53b5c3ba131d4682104b10474182f9f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTI1MzM1MQ==", "url": "https://github.com/elastic/apm-agent-java/pull/1196#discussion_r439253351", "bodyText": "Good question, first, that's on par with what other elastic APM agents provide, avoid extra complexity when adding this feature, and then there was the case of bi-directional streaming which might not fit the concept of \"transaction\" if it's used as a long-lived communication channel, but that might really be a marginal use. Thus we could probably lift this limitation in the near future in a separate PR.", "author": "SylvainJuge", "createdAt": "2020-06-12T07:27:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU2ODQ2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDIwMzIwOQ==", "url": "https://github.com/elastic/apm-agent-java/pull/1196#discussion_r440203209", "bodyText": "Please create a follow-up issue for that.", "author": "felixbarny", "createdAt": "2020-06-15T14:09:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU2ODQ2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDIxNTk2Nw==", "url": "https://github.com/elastic/apm-agent-java/pull/1196#discussion_r440215967", "bodyText": "done: #1233", "author": "SylvainJuge", "createdAt": "2020-06-15T14:27:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU2ODQ2MA=="}], "type": "inlineReview", "revised_code": {"commit": "1fdab0f7f66b45e8e69fa482006ca8c11d4128ce", "chunk": "diff --git a/apm-agent-plugins/apm-grpc/apm-grpc-plugin/src/main/java/co/elastic/apm/agent/grpc/ServerCallHandlerInstrumentation.java b/apm-agent-plugins/apm-grpc/apm-grpc-plugin/src/main/java/co/elastic/apm/agent/grpc/ServerCallHandlerInstrumentation.java\nindex bf2dcc02a..92e1499cf 100644\n--- a/apm-agent-plugins/apm-grpc/apm-grpc-plugin/src/main/java/co/elastic/apm/agent/grpc/ServerCallHandlerInstrumentation.java\n+++ b/apm-agent-plugins/apm-grpc/apm-grpc-plugin/src/main/java/co/elastic/apm/agent/grpc/ServerCallHandlerInstrumentation.java\n\n@@ -67,25 +67,40 @@ public class ServerCallHandlerInstrumentation extends BaseInstrumentation {\n         return named(\"startCall\");\n     }\n \n+    @Advice.OnMethodEnter(suppress = Throwable.class)\n+    private static void onEnter(@Advice.Origin Class<?> clazz,\n+                                @Advice.Argument(0) ServerCall<?, ?> serverCall,\n+                                @Advice.Argument(1) Metadata headers,\n+                                @Advice.Local(\"transaction\") Transaction transaction) {\n+\n+        if (tracer == null || grpcHelperManager == null) {\n+            return;\n+        }\n+\n+        GrpcHelper helper = grpcHelperManager.getForClassLoaderOfClass(ServerCall.class);\n+        if (helper != null) {\n+            transaction = helper.startAndRegisterTransaction(tracer, clazz.getClassLoader(), serverCall, headers);\n+        }\n+    }\n+\n     @Advice.OnMethodExit(suppress = Throwable.class, onThrowable = Throwable.class)\n-    private static void onExit(@Advice.Origin Class<?> clazz,\n-                               @Advice.Thrown @Nullable Throwable thrown,\n+    private static void onExit(@Advice.Thrown @Nullable Throwable thrown,\n                                @Advice.Argument(0) ServerCall<?, ?> serverCall,\n-                               @Advice.Argument(1) Metadata headers,\n-                               @Advice.Return ServerCall.Listener<?> listener) {\n+                               @Advice.Return ServerCall.Listener<?> listener,\n+                               @Advice.Local(\"transaction\") @Nullable Transaction transaction) {\n \n-        if (tracer == null || grpcHelperManager == null || thrown != null) {\n+        if (transaction == null) {\n             return;\n         }\n-\n-        if (serverCall.getMethodDescriptor().getType() != MethodDescriptor.MethodType.UNARY) {\n-            // ignore non-unary calls\n+        if (thrown != null) {\n+            // terminate transaction in case of exception as it won't be stored\n+            transaction.end();\n             return;\n         }\n \n         GrpcHelper helper = grpcHelperManager.getForClassLoaderOfClass(ServerCall.class);\n         if (helper != null) {\n-            helper.startAndRegisterTransaction(tracer, clazz.getClassLoader(), serverCall, headers, listener);\n+            helper.registerTransaction(serverCall, listener, transaction);\n         }\n \n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU2OTA2Ng==", "url": "https://github.com/elastic/apm-agent-java/pull/1196#discussion_r438569066", "bodyText": "Why are we not starting the transaction onEnter anymore? That's what we also do for client calls. It also ensures we measure the time spent when preparing the call, including listener executions.", "author": "felixbarny", "createdAt": "2020-06-11T06:29:09Z", "path": "apm-agent-plugins/apm-grpc/apm-grpc-plugin/src/main/java/co/elastic/apm/agent/grpc/ServerCallHandlerInstrumentation.java", "diffHunk": "@@ -69,35 +67,25 @@ public ServerCallHandlerInstrumentation(ElasticApmTracer tracer) {\n         return named(\"startCall\");\n     }\n \n-    @Advice.OnMethodEnter(suppress = Throwable.class)\n-    private static void onEnter(@Advice.Origin Class<?> clazz,\n-                                @Advice.Argument(0) ServerCall<?, ?> serverCall,\n-                                @Advice.Argument(1) Metadata headers,\n-                                @Advice.Local(\"transaction\") Transaction transaction) {\n+    @Advice.OnMethodExit(suppress = Throwable.class, onThrowable = Throwable.class)\n+    private static void onExit(@Advice.Origin Class<?> clazz,\n+                               @Advice.Thrown @Nullable Throwable thrown,\n+                               @Advice.Argument(0) ServerCall<?, ?> serverCall,\n+                               @Advice.Argument(1) Metadata headers,\n+                               @Advice.Return ServerCall.Listener<?> listener) {\n \n-        if (tracer == null || grpcHelperManager == null) {\n+        if (tracer == null || grpcHelperManager == null || thrown != null) {\n             return;\n         }\n \n-        GrpcHelper helper = grpcHelperManager.getForClassLoaderOfClass(ServerCall.class);\n-        if (helper != null) {\n-            transaction = helper.startTransaction(tracer, clazz.getClassLoader(), serverCall, headers);", "originalCommit": "9532e73ca53b5c3ba131d4682104b10474182f9f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTI5MTQ5NQ==", "url": "https://github.com/elastic/apm-agent-java/pull/1196#discussion_r439291495", "bodyText": "fair point, it was a way to make instrumentation a bit simpler with only one single call to helper class. I've changed that in last commit.", "author": "SylvainJuge", "createdAt": "2020-06-12T08:48:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU2OTA2Ng=="}], "type": "inlineReview", "revised_code": {"commit": "1fdab0f7f66b45e8e69fa482006ca8c11d4128ce", "chunk": "diff --git a/apm-agent-plugins/apm-grpc/apm-grpc-plugin/src/main/java/co/elastic/apm/agent/grpc/ServerCallHandlerInstrumentation.java b/apm-agent-plugins/apm-grpc/apm-grpc-plugin/src/main/java/co/elastic/apm/agent/grpc/ServerCallHandlerInstrumentation.java\nindex bf2dcc02a..92e1499cf 100644\n--- a/apm-agent-plugins/apm-grpc/apm-grpc-plugin/src/main/java/co/elastic/apm/agent/grpc/ServerCallHandlerInstrumentation.java\n+++ b/apm-agent-plugins/apm-grpc/apm-grpc-plugin/src/main/java/co/elastic/apm/agent/grpc/ServerCallHandlerInstrumentation.java\n\n@@ -67,25 +67,40 @@ public class ServerCallHandlerInstrumentation extends BaseInstrumentation {\n         return named(\"startCall\");\n     }\n \n+    @Advice.OnMethodEnter(suppress = Throwable.class)\n+    private static void onEnter(@Advice.Origin Class<?> clazz,\n+                                @Advice.Argument(0) ServerCall<?, ?> serverCall,\n+                                @Advice.Argument(1) Metadata headers,\n+                                @Advice.Local(\"transaction\") Transaction transaction) {\n+\n+        if (tracer == null || grpcHelperManager == null) {\n+            return;\n+        }\n+\n+        GrpcHelper helper = grpcHelperManager.getForClassLoaderOfClass(ServerCall.class);\n+        if (helper != null) {\n+            transaction = helper.startAndRegisterTransaction(tracer, clazz.getClassLoader(), serverCall, headers);\n+        }\n+    }\n+\n     @Advice.OnMethodExit(suppress = Throwable.class, onThrowable = Throwable.class)\n-    private static void onExit(@Advice.Origin Class<?> clazz,\n-                               @Advice.Thrown @Nullable Throwable thrown,\n+    private static void onExit(@Advice.Thrown @Nullable Throwable thrown,\n                                @Advice.Argument(0) ServerCall<?, ?> serverCall,\n-                               @Advice.Argument(1) Metadata headers,\n-                               @Advice.Return ServerCall.Listener<?> listener) {\n+                               @Advice.Return ServerCall.Listener<?> listener,\n+                               @Advice.Local(\"transaction\") @Nullable Transaction transaction) {\n \n-        if (tracer == null || grpcHelperManager == null || thrown != null) {\n+        if (transaction == null) {\n             return;\n         }\n-\n-        if (serverCall.getMethodDescriptor().getType() != MethodDescriptor.MethodType.UNARY) {\n-            // ignore non-unary calls\n+        if (thrown != null) {\n+            // terminate transaction in case of exception as it won't be stored\n+            transaction.end();\n             return;\n         }\n \n         GrpcHelper helper = grpcHelperManager.getForClassLoaderOfClass(ServerCall.class);\n         if (helper != null) {\n-            helper.startAndRegisterTransaction(tracer, clazz.getClassLoader(), serverCall, headers, listener);\n+            helper.registerTransaction(serverCall, listener, transaction);\n         }\n \n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU3MTQyNQ==", "url": "https://github.com/elastic/apm-agent-java/pull/1196#discussion_r438571425", "bodyText": "Also instrument onReady to propagate context and to end the span if an exception occurs.", "author": "felixbarny", "createdAt": "2020-06-11T06:35:29Z", "path": "apm-agent-plugins/apm-grpc/apm-grpc-plugin/src/main/java/co/elastic/apm/agent/grpc/ServerCallListenerInstrumentation.java", "diffHunk": "@@ -90,7 +88,7 @@ public NonFinalMethodCall(ElasticApmTracer tracer) {\n             return named(\"onMessage\")\n                 //\n                 // client completed all message sending, but can still cancel the call\n-                // --> for unary calls, actual method invocation is done here (but it's an impl. detail)\n+                // --> for unary calls, actual method invocation is done within 'onHalfClose' method.\n                 .or(named(\"onHalfClose\"));", "originalCommit": "9532e73ca53b5c3ba131d4682104b10474182f9f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1fdab0f7f66b45e8e69fa482006ca8c11d4128ce", "chunk": "diff --git a/apm-agent-plugins/apm-grpc/apm-grpc-plugin/src/main/java/co/elastic/apm/agent/grpc/ServerCallListenerInstrumentation.java b/apm-agent-plugins/apm-grpc/apm-grpc-plugin/src/main/java/co/elastic/apm/agent/grpc/ServerCallListenerInstrumentation.java\nindex 43e7d4580..1d40de269 100644\n--- a/apm-agent-plugins/apm-grpc/apm-grpc-plugin/src/main/java/co/elastic/apm/agent/grpc/ServerCallListenerInstrumentation.java\n+++ b/apm-agent-plugins/apm-grpc/apm-grpc-plugin/src/main/java/co/elastic/apm/agent/grpc/ServerCallListenerInstrumentation.java\n\n@@ -83,9 +85,11 @@ public abstract class ServerCallListenerInstrumentation extends BaseInstrumentat\n \n         @Override\n         public ElementMatcher<? super MethodDescription> getMethodMatcher() {\n-            // message received --> indicates RPC start for unary call\n-            // actual method invocation is delayed until 'half close'\n-            return named(\"onMessage\")\n+            return named(\"onReady\")\n+                //\n+                // message received --> indicates RPC start for unary call\n+                // actual method invocation is delayed until 'half close'\n+                .or(named(\"onMessage\"))\n                 //\n                 // client completed all message sending, but can still cancel the call\n                 // --> for unary calls, actual method invocation is done within 'onHalfClose' method.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU3NDI3Mg==", "url": "https://github.com/elastic/apm-agent-java/pull/1196#discussion_r438574272", "bodyText": "don't we have to end the transaction in case of an exception?", "author": "felixbarny", "createdAt": "2020-06-11T06:43:11Z", "path": "apm-agent-plugins/apm-grpc/apm-grpc-plugin/src/main/java/co/elastic/apm/agent/grpc/helper/GrpcHelperImpl.java", "diffHunk": "@@ -185,22 +158,21 @@ public void exitServerListenerMethod(@Nullable Throwable thrown, ServerCall.List\n         if (null != thrown) {\n             // when there is a runtime exception thrown in one of the listener methods the calling code will catch it\n             // and set 'unknown' status, we just replicate this behavior as we don't instrument the part that does this\n-            endTransaction(Status.UNKNOWN, thrown, transaction);\n-\n-            // listener won't be called anymore\n-            inFlightServerListeners.remove(listener);\n+            setTransactionStatus(Status.UNKNOWN, thrown, transaction);", "originalCommit": "9532e73ca53b5c3ba131d4682104b10474182f9f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU3NTQxMQ==", "url": "https://github.com/elastic/apm-agent-java/pull/1196#discussion_r438575411", "bodyText": "Do we have a test that checks if other callbacks and/or io.grpc.ServerCall#close is called if an exception happens?", "author": "felixbarny", "createdAt": "2020-06-11T06:46:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU3NDI3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTUzMDgzNg==", "url": "https://github.com/elastic/apm-agent-java/pull/1196#discussion_r439530836", "bodyText": "server-side tests have been added in latest version of PR.", "author": "SylvainJuge", "createdAt": "2020-06-12T16:45:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU3NDI3Mg=="}], "type": "inlineReview", "revised_code": {"commit": "4411e82ac9bfca3d9a632b3516c634c978ea75c7", "chunk": "diff --git a/apm-agent-plugins/apm-grpc/apm-grpc-plugin/src/main/java/co/elastic/apm/agent/grpc/helper/GrpcHelperImpl.java b/apm-agent-plugins/apm-grpc/apm-grpc-plugin/src/main/java/co/elastic/apm/agent/grpc/helper/GrpcHelperImpl.java\nindex 1be1af85b..633e82bda 100644\n--- a/apm-agent-plugins/apm-grpc/apm-grpc-plugin/src/main/java/co/elastic/apm/agent/grpc/helper/GrpcHelperImpl.java\n+++ b/apm-agent-plugins/apm-grpc/apm-grpc-plugin/src/main/java/co/elastic/apm/agent/grpc/helper/GrpcHelperImpl.java\n\n@@ -155,12 +171,12 @@ public class GrpcHelperImpl implements GrpcHelper {\n \n         transaction.deactivate();\n \n-        if (null != thrown) {\n+        if (isLastMethod || null != thrown) {\n             // when there is a runtime exception thrown in one of the listener methods the calling code will catch it\n             // and set 'unknown' status, we just replicate this behavior as we don't instrument the part that does this\n-            setTransactionStatus(Status.UNKNOWN, thrown, transaction);\n-        } else if (isLastMethod) {\n-            // transaction status will be set by ServerCall.close instrumentation\n+            if (thrown != null) {\n+                setTransactionStatus(Status.UNKNOWN, thrown, transaction);\n+            }\n             transaction.end();\n             serverListenerTransactions.remove(listener);\n         }\n"}}, {"oid": "1fdab0f7f66b45e8e69fa482006ca8c11d4128ce", "url": "https://github.com/elastic/apm-agent-java/commit/1fdab0f7f66b45e8e69fa482006ca8c11d4128ce", "message": "another round of post-review changes", "committedDate": "2020-06-12T08:46:43Z", "type": "commit"}, {"oid": "4411e82ac9bfca3d9a632b3516c634c978ea75c7", "url": "https://github.com/elastic/apm-agent-java/commit/4411e82ac9bfca3d9a632b3516c634c978ea75c7", "message": "add more tests for listener + no nested tx", "committedDate": "2020-06-12T12:29:58Z", "type": "commit"}, {"oid": "1156b4821208e54af7fde663c0d2a15f9f430fd3", "url": "https://github.com/elastic/apm-agent-java/commit/1156b4821208e54af7fde663c0d2a15f9f430fd3", "message": "add client listener + more tests", "committedDate": "2020-06-12T16:43:15Z", "type": "commit"}, {"oid": "37b37e6308475f27c25712f61bf4fd398d0ada16", "url": "https://github.com/elastic/apm-agent-java/commit/37b37e6308475f27c25712f61bf4fd398d0ada16", "message": "add log4j2.xml to avoid log4j from complaining", "committedDate": "2020-06-15T13:07:19Z", "type": "commit"}, {"oid": "29057998e0c4565e1648190cc6767e22a356e6f3", "url": "https://github.com/elastic/apm-agent-java/commit/29057998e0c4565e1648190cc6767e22a356e6f3", "message": "minor javadoc/style fixes", "committedDate": "2020-06-15T13:21:57Z", "type": "commit"}, {"oid": "09ddc4ac68480e5b57ad9da579580b19d5f715aa", "url": "https://github.com/elastic/apm-agent-java/commit/09ddc4ac68480e5b57ad9da579580b19d5f715aa", "message": "update changelog", "committedDate": "2020-06-15T14:29:54Z", "type": "commit"}]}