{"pr_number": 1178, "pr_title": "2wp improvements", "pr_createdAt": "2020-02-26T14:02:07Z", "pr_url": "https://github.com/rsksmart/rskj/pull/1178", "timeline": [{"oid": "cebc2662c22791f4d85978cd89b90ad7afd0598b", "url": "https://github.com/rsksmart/rskj/commit/cebc2662c22791f4d85978cd89b90ad7afd0598b", "message": "Refactor BtcLockSender classes and interactions", "committedDate": "2020-02-26T18:10:44Z", "type": "forcePushed"}, {"oid": "36df238af56a8690b170a3a5b88d3ed2516d5568", "url": "https://github.com/rsksmart/rskj/commit/36df238af56a8690b170a3a5b88d3ed2516d5568", "message": "Fix double lock with segwit addresses", "committedDate": "2020-03-06T11:15:24Z", "type": "forcePushed"}, {"oid": "706b5b952d32557ca5250d719500160918d22922", "url": "https://github.com/rsksmart/rskj/commit/706b5b952d32557ca5250d719500160918d22922", "message": "Includes RSKIP143 into ConsensusRules files", "committedDate": "2020-03-06T11:34:09Z", "type": "commit"}, {"oid": "65710b5f2342a825ceb0ee134af2c7b270c1efa4", "url": "https://github.com/rsksmart/rskj/commit/65710b5f2342a825ceb0ee134af2c7b270c1efa4", "message": "Include new abstract class to can parse different kind of transaction and a new exception to be used for this class.", "committedDate": "2020-03-06T11:34:13Z", "type": "commit"}, {"oid": "28d5817b8e06873143525f8c6c3412c623687ff7", "url": "https://github.com/rsksmart/rskj/commit/28d5817b8e06873143525f8c6c3412c623687ff7", "message": "Adds P2pkhBtcLockSender class and unit tests", "committedDate": "2020-03-06T11:34:13Z", "type": "commit"}, {"oid": "497dc063865b179bd51281996502112f190cd80c", "url": "https://github.com/rsksmart/rskj/commit/497dc063865b179bd51281996502112f190cd80c", "message": "Add P2shP2wpkhBtcLockSender to parse 2wp locks using segwit compatible inputs", "committedDate": "2020-03-06T11:34:13Z", "type": "commit"}, {"oid": "434263180d7cfa4a55b396a31f2da461798e0ceb", "url": "https://github.com/rsksmart/rskj/commit/434263180d7cfa4a55b396a31f2da461798e0ceb", "message": "add BtcLockSenderProvider\n\n- Integrates P2shP2wpkhBtcLockSender instantiation\n- Integrates P2pkhBtcLockSender instantiation", "committedDate": "2020-03-06T11:34:13Z", "type": "commit"}, {"oid": "38ee084e5fb8c558e9c3a648a730eb595ec9804f", "url": "https://github.com/rsksmart/rskj/commit/38ee084e5fb8c558e9c3a648a730eb595ec9804f", "message": "Changed logic in registerBtcTransaction to use BtcLockSender", "committedDate": "2020-03-06T11:34:13Z", "type": "commit"}, {"oid": "252491cc308618354d38ccec9701a8d40cc3ff43", "url": "https://github.com/rsksmart/rskj/commit/252491cc308618354d38ccec9701a8d40cc3ff43", "message": "Includes a function in BridgeUtils to identify if a tx can be processed or not", "committedDate": "2020-03-06T11:34:13Z", "type": "commit"}, {"oid": "43d9916681648de0519721d763c44e0803b29d6f", "url": "https://github.com/rsksmart/rskj/commit/43d9916681648de0519721d763c44e0803b29d6f", "message": "Add CoinbaseInformation class and stored it in Bridge storage\n\nCoinbaseInformation will be used to store Witness commitment and Witness reserved value in the processing of segwit transactions", "committedDate": "2020-03-06T11:34:13Z", "type": "commit"}, {"oid": "d4cb16d83c3b7cb64006536cc35387990bd61150", "url": "https://github.com/rsksmart/rskj/commit/d4cb16d83c3b7cb64006536cc35387990bd61150", "message": "Add P2shMultisigBtcLockSender", "committedDate": "2020-03-06T11:34:13Z", "type": "commit"}, {"oid": "ad8e21096fa0092c8ce6a70219e67af1f7365d2d", "url": "https://github.com/rsksmart/rskj/commit/ad8e21096fa0092c8ce6a70219e67af1f7365d2d", "message": "Add P2shP2wshBtcLockSender", "committedDate": "2020-03-06T11:34:13Z", "type": "commit"}, {"oid": "a34bcec2f92b08c9e8b32630f140681747879846", "url": "https://github.com/rsksmart/rskj/commit/a34bcec2f92b08c9e8b32630f140681747879846", "message": "Refactor BtcLockSender tests to use the same raw txs in every test", "committedDate": "2020-03-06T11:34:13Z", "type": "commit"}, {"oid": "26fa233d280568bee72349023dff1d9b892de318", "url": "https://github.com/rsksmart/rskj/commit/26fa233d280568bee72349023dff1d9b892de318", "message": "Add logic in registerBtcTransaction to refund multisig addresses after RSKIP 143 activation", "committedDate": "2020-03-06T11:34:13Z", "type": "commit"}, {"oid": "68d99aab24a9e62e5619b254d0d5a28c460f6f22", "url": "https://github.com/rsksmart/rskj/commit/68d99aab24a9e62e5619b254d0d5a28c460f6f22", "message": "Add unit tests for multisig addresses lock refund on the bridge", "committedDate": "2020-03-06T11:34:13Z", "type": "commit"}, {"oid": "4df25b031d6513a88466842fdf06c97a86d9f2fb", "url": "https://github.com/rsksmart/rskj/commit/4df25b031d6513a88466842fdf06c97a86d9f2fb", "message": "Refactor registerBtcTransaction tests", "committedDate": "2020-03-06T11:34:13Z", "type": "commit"}, {"oid": "11512875899f7461bfa30265146a10b530175d23", "url": "https://github.com/rsksmart/rskj/commit/11512875899f7461bfa30265146a10b530175d23", "message": "Refactor BridgeSupport tests", "committedDate": "2020-03-06T11:34:13Z", "type": "commit"}, {"oid": "d1e6619a865974f7156e4e1ae106d6bff62a74b9", "url": "https://github.com/rsksmart/rskj/commit/d1e6619a865974f7156e4e1ae106d6bff62a74b9", "message": "Updates build.gradle to use bitcoinj 9", "committedDate": "2020-03-06T11:34:13Z", "type": "commit"}, {"oid": "c5003869ad62243ad5a0c2c28755c912347346c4", "url": "https://github.com/rsksmart/rskj/commit/c5003869ad62243ad5a0c2c28755c912347346c4", "message": "Fix repository issues in BridgePerformanceTestCase", "committedDate": "2020-03-06T11:34:13Z", "type": "commit"}, {"oid": "99ea0314ed813563fad17644e4588ddc9980f170", "url": "https://github.com/rsksmart/rskj/commit/99ea0314ed813563fad17644e4588ddc9980f170", "message": "Fix double lock with segwit addresses", "committedDate": "2020-03-06T11:34:14Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTY1MzM5NQ==", "url": "https://github.com/rsksmart/rskj/pull/1178#discussion_r389653395", "bodyText": "Throws exception if size != 1 but the message says it expects size to be 2", "author": "marcos-iov", "createdAt": "2020-03-09T13:18:55Z", "path": "rskj-core/src/main/java/co/rsk/peg/BridgeSerializationUtils.java", "diffHunk": "@@ -707,6 +708,30 @@ public static Integer deserializeInteger(byte[] data) {\n         return Optional.of(RLP.decodeBigInteger(data, 0).longValue());\n     }\n \n+    public static CoinbaseInformation deserializeCoinbaseInformation(byte[] data) {\n+        if (data == null) {\n+            return null;\n+        }\n+        RLPList rlpList = (RLPList)RLP.decode2(data).get(0);\n+\n+        if (rlpList.size() != 1) {\n+            throw new RuntimeException(String.format(\"Invalid serialized coinbase information, expected 2 values but got %n\", rlpList.size()));\n+        }", "originalCommit": "99ea0314ed813563fad17644e4588ddc9980f170", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "fb695173cf81f16238adf8c608401b2cbdba8e6f", "chunk": "diff --git a/rskj-core/src/main/java/co/rsk/peg/BridgeSerializationUtils.java b/rskj-core/src/main/java/co/rsk/peg/BridgeSerializationUtils.java\nindex 263fa72a7..c2b9f48db 100644\n--- a/rskj-core/src/main/java/co/rsk/peg/BridgeSerializationUtils.java\n+++ b/rskj-core/src/main/java/co/rsk/peg/BridgeSerializationUtils.java\n\n@@ -715,7 +715,7 @@ public class BridgeSerializationUtils {\n         RLPList rlpList = (RLPList)RLP.decode2(data).get(0);\n \n         if (rlpList.size() != 1) {\n-            throw new RuntimeException(String.format(\"Invalid serialized coinbase information, expected 2 values but got %n\", rlpList.size()));\n+            throw new RuntimeException(String.format(\"Invalid serialized coinbase information, expected 1 value but got %n\", rlpList.size()));\n         }\n \n         Sha256Hash witnessMerkleRoot = Sha256Hash.wrap(rlpList.get(0).getRLPData());\n"}}, {"oid": "fb695173cf81f16238adf8c608401b2cbdba8e6f", "url": "https://github.com/rsksmart/rskj/commit/fb695173cf81f16238adf8c608401b2cbdba8e6f", "message": "Add coinbase related methods to Bridge\n\nBridge methods\n- registerBtcCoinbaseTransaction: Given a blockHash, it registers the witness merkle root extracted from the coinbase\n- hasBtcBlockCoinbaseTransactionInformation: Given a blockhash, indicates if it contains coinbase information\n\nCreated performance tests for these methods", "committedDate": "2020-03-09T13:38:00Z", "type": "commit"}, {"oid": "cc81458b0564501ead26ce2ae8988f228a905a33", "url": "https://github.com/rsksmart/rskj/commit/cc81458b0564501ead26ce2ae8988f228a905a33", "message": "Refactor BtcLockSender classes and interactions", "committedDate": "2020-03-09T13:38:05Z", "type": "commit"}, {"oid": "7bf05fae41a038d84b37884da71b537bd87faf57", "url": "https://github.com/rsksmart/rskj/commit/7bf05fae41a038d84b37884da71b537bd87faf57", "message": "Fix bug in getBtcTrnsactionConfirmation test", "committedDate": "2020-03-09T13:38:05Z", "type": "commit"}, {"oid": "30ce67927474309bab74b28206d9b06c36b316f4", "url": "https://github.com/rsksmart/rskj/commit/30ce67927474309bab74b28206d9b06c36b316f4", "message": "Add test to verify Bridge lock event supports p2sh addresses", "committedDate": "2020-03-09T13:38:05Z", "type": "commit"}, {"oid": "e25f7de540c92555012917293463d5d6e5ab1654", "url": "https://github.com/rsksmart/rskj/commit/e25f7de540c92555012917293463d5d6e5ab1654", "message": "Improve logs for BridgeSupport", "committedDate": "2020-03-09T13:38:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTY2MTczMg==", "url": "https://github.com/rsksmart/rskj/pull/1178#discussion_r389661732", "bodyText": "Confusing comment", "author": "marcos-iov", "createdAt": "2020-03-09T13:27:04Z", "path": "rskj-core/src/main/java/co/rsk/peg/BridgeSupport.java", "diffHunk": "@@ -324,21 +337,26 @@ public void registerBtcTransaction(Transaction rskTx, byte[] btcTxSerialized, in\n         BtcTransaction btcTx = new BtcTransaction(bridgeConstants.getBtcParams(), btcTxSerialized);\n         btcTx.verify();\n \n+        // Check the again tx was not already processed but making sure to use the txid (no witness)", "originalCommit": "99ea0314ed813563fad17644e4588ddc9980f170", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "fb695173cf81f16238adf8c608401b2cbdba8e6f", "chunk": "diff --git a/rskj-core/src/main/java/co/rsk/peg/BridgeSupport.java b/rskj-core/src/main/java/co/rsk/peg/BridgeSupport.java\nindex 4d1616d82..eaa050a3d 100644\n--- a/rskj-core/src/main/java/co/rsk/peg/BridgeSupport.java\n+++ b/rskj-core/src/main/java/co/rsk/peg/BridgeSupport.java\n\n@@ -337,12 +337,6 @@ public class BridgeSupport {\n         BtcTransaction btcTx = new BtcTransaction(bridgeConstants.getBtcParams(), btcTxSerialized);\n         btcTx.verify();\n \n-        // Check the again tx was not already processed but making sure to use the txid (no witness)\n-        if (getBtcTxHashProcessedHeight(btcTx.getHash(false)) > -1L) {\n-            logger.warn(\"Supplied Btc Tx {} was already processed\", btcTx.getHash(false));\n-            return;\n-        }\n-\n         boolean locked = true;\n \n         Federation activeFederation = getActiveFederation();\n"}}, {"oid": "33fcf235acbe818154419ab037562917379c9205", "url": "https://github.com/rsksmart/rskj/commit/33fcf235acbe818154419ab037562917379c9205", "message": "Fix double lock with segwit addresses", "committedDate": "2020-03-09T14:02:27Z", "type": "commit"}, {"oid": "33fcf235acbe818154419ab037562917379c9205", "url": "https://github.com/rsksmart/rskj/commit/33fcf235acbe818154419ab037562917379c9205", "message": "Fix double lock with segwit addresses", "committedDate": "2020-03-09T14:02:27Z", "type": "forcePushed"}]}