{"pr_number": 1172, "pr_title": "initial queue commit", "pr_createdAt": "2020-02-14T19:42:33Z", "pr_url": "https://github.com/rsksmart/rskj/pull/1172", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDM1MTIzNg==", "url": "https://github.com/rsksmart/rskj/pull/1172#discussion_r380351236", "bodyText": "This condition is never true, as this.queue.offer never returns false:\n     * Inserts the specified element into this priority queue.\n     * As the queue is unbounded, this method will never return {@code false}.", "author": "joaquinlpereyra-iov", "createdAt": "2020-02-17T20:10:44Z", "path": "rskj-core/src/main/java/co/rsk/net/NodeMessageHandler.java", "diffHunk": "@@ -123,7 +124,10 @@ private void tryAddMessage(Peer sender, Message message) {\n                 }\n                 this.receivedMessages.add(encodedMessage);\n             }\n-            if (!this.queue.offer(new MessageTask(sender, message))){\n+\n+            double score = sender.score(System.currentTimeMillis(), message.getMessageType());\n+\n+            if (score >= 0 && !this.queue.offer(new MessageTask(sender, message, score))){", "originalCommit": "c4b9dcf694ae41ac065ff917367637915844a339", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f8f42c6636cf5642121b703fd10a172261f2bcf4", "chunk": "diff --git a/rskj-core/src/main/java/co/rsk/net/NodeMessageHandler.java b/rskj-core/src/main/java/co/rsk/net/NodeMessageHandler.java\nindex bc2a96e3d..02b5818c8 100644\n--- a/rskj-core/src/main/java/co/rsk/net/NodeMessageHandler.java\n+++ b/rskj-core/src/main/java/co/rsk/net/NodeMessageHandler.java\n\n@@ -127,8 +127,8 @@ public class NodeMessageHandler implements MessageHandler, InternalService, Runn\n \n             double score = sender.score(System.currentTimeMillis(), message.getMessageType());\n \n-            if (score >= 0 && !this.queue.offer(new MessageTask(sender, message, score))){\n-                logger.trace(\"Queue full, message not added to the queue\");\n+            if (score >= 0 && !this.queue.offer(new MessageTask(sender, message, score))) {\n+                logger.warn(\"Unexpected path. Is message queue bounded now?\");\n             }\n         } else {\n             recordEvent(sender, EventType.REPEATED_MESSAGE);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDM1NTE2NQ==", "url": "https://github.com/rsksmart/rskj/pull/1172#discussion_r380355165", "bodyText": "I think it's weird to have MessageTask be naturally ordered by their score. It certainly helps in this implementation, but it is weird to read taskA > taskB and assign it any meaning. Maybe use the other constructor to the queue which allows to define a Comparator<MessageTask>?\nMaybe I'm being too picky here, take just a note/discussion.", "author": "joaquinlpereyra-iov", "createdAt": "2020-02-17T20:26:07Z", "path": "rskj-core/src/main/java/co/rsk/net/NodeMessageHandler.java", "diffHunk": "@@ -236,6 +247,31 @@ public String toString() {\n                     \", message=\" + message +\n                     '}';\n         }\n+\n+        @Override\n+        public int compareTo(MessageTask messageTask) {", "originalCommit": "c4b9dcf694ae41ac065ff917367637915844a339", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f8f42c6636cf5642121b703fd10a172261f2bcf4", "chunk": "diff --git a/rskj-core/src/main/java/co/rsk/net/NodeMessageHandler.java b/rskj-core/src/main/java/co/rsk/net/NodeMessageHandler.java\nindex bc2a96e3d..02b5818c8 100644\n--- a/rskj-core/src/main/java/co/rsk/net/NodeMessageHandler.java\n+++ b/rskj-core/src/main/java/co/rsk/net/NodeMessageHandler.java\n\n@@ -248,30 +243,15 @@ public class NodeMessageHandler implements MessageHandler, InternalService, Runn\n                     '}';\n         }\n \n-        @Override\n-        public int compareTo(MessageTask messageTask) {\n-            if (this.score < messageTask.score) {\n-                return 1;\n-            }\n-            if (this.score > messageTask.score) {\n-                return -1;\n+        private static class TaskComparator implements Comparator<MessageTask> {\n+            @Override\n+            public int compare(MessageTask m1, MessageTask m2) {\n+                return Double.compare(m2.score, m1.score);\n             }\n-            return 0;\n         }\n \n-        @Override\n-        public boolean equals(Object o) {\n-            if (this == o) {\n-                return true;\n-            }\n-            if (o == null || getClass() != o.getClass()) {\n-                return false;\n-            }\n-            MessageTask that = (MessageTask) o;\n-            return Double.compare(that.score, score) == 0 &&\n-                    Objects.equals(sender, that.sender) &&\n-                    Objects.equals(message, that.message);\n-        }\n     }\n+\n+\n }\n \n"}}, {"oid": "f8f42c6636cf5642121b703fd10a172261f2bcf4", "url": "https://github.com/rsksmart/rskj/commit/f8f42c6636cf5642121b703fd10a172261f2bcf4", "message": "Initial priority queue work", "committedDate": "2020-02-18T14:51:29Z", "type": "commit"}]}