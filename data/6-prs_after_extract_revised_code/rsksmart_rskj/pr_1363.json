{"pr_number": 1363, "pr_title": "Changes in signature of the function of FastBridgeTransaction", "pr_createdAt": "2020-11-16T18:09:26Z", "pr_url": "https://github.com/rsksmart/rskj/pull/1363", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ3ODQ1OA==", "url": "https://github.com/rsksmart/rskj/pull/1363#discussion_r524478458", "bodyText": "Coukld we check if the argument is really an address? Now, the code discard the \"left-most\" bytes, that could contain anything.", "author": "ajlopezrsk", "createdAt": "2020-11-16T18:20:09Z", "path": "rskj-core/src/main/java/co/rsk/peg/Bridge.java", "diffHunk": "@@ -1094,20 +1095,20 @@ public boolean hasBtcBlockCoinbaseTransactionInformation(Object[] args) {\n         return bridgeSupport.hasBtcBlockCoinbaseTransactionInformation(blockHash);\n     }\n \n-    public int registerBtcTransfer(Object[] args) {\n-        logger.trace(\"registerBtcTransfer\");\n-\n-        byte[] btcTxSerialized = (byte[]) args[0];\n-        int height = ((BigInteger) args[1]).intValue();\n-        byte[] pmtSerialized = (byte[]) args[2];\n-        Sha256Hash derivationArgumentsHash = Sha256Hash.wrap((byte[]) args[3]);\n-        Address userRefundAddress = new Address(bridgeConstants.getBtcParams(), (byte[]) args[4]);\n-        RskAddress lbcAddress = new RskAddress((String) args[5]);\n-        Address lpBtcAddress = new Address(bridgeConstants.getBtcParams(), (byte[]) args[6]);\n-        boolean executionStatus = (Boolean) args[7];\n+    public int registerFastBridgeBtcTransaction(Object[] args) {\n+        logger.trace(\"registerFastBridgeBtcTransaction\");\n \n         try {\n-            return bridgeSupport.registerBtcTransfer(\n+            byte[] btcTxSerialized = (byte[]) args[0];\n+            int height = ((BigInteger) args[1]).intValue();\n+            byte[] pmtSerialized = (byte[]) args[2];\n+            Sha256Hash derivationArgumentsHash = Sha256Hash.wrap((byte[]) args[3]);\n+            Address userRefundAddress = new Address(bridgeConstants.getBtcParams(), (byte[]) args[4]);\n+            RskAddress lbcAddress = new RskAddress(((DataWord)args[5]).getLast20Bytes());", "originalCommit": "fc02bfbfce90e610bffc1bc060e17df8fb6a9f6b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDUwNzU3OQ==", "url": "https://github.com/rsksmart/rskj/pull/1363#discussion_r524507579", "bodyText": "I will modify it! thank you!", "author": "pamgonzalez", "createdAt": "2020-11-16T19:08:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ3ODQ1OA=="}], "type": "inlineReview", "revised_code": {"commit": "d4bd7cdc025258f2dbfe866d9b19758b7c11a1df", "chunk": "diff --git a/rskj-core/src/main/java/co/rsk/peg/Bridge.java b/rskj-core/src/main/java/co/rsk/peg/Bridge.java\nindex 2a0445b1f..a2d372240 100644\n--- a/rskj-core/src/main/java/co/rsk/peg/Bridge.java\n+++ b/rskj-core/src/main/java/co/rsk/peg/Bridge.java\n\n@@ -1104,7 +1104,7 @@ public class Bridge extends PrecompiledContracts.PrecompiledContract {\n             byte[] pmtSerialized = (byte[]) args[2];\n             Sha256Hash derivationArgumentsHash = Sha256Hash.wrap((byte[]) args[3]);\n             Address userRefundAddress = new Address(bridgeConstants.getBtcParams(), (byte[]) args[4]);\n-            RskAddress lbcAddress = new RskAddress(((DataWord)args[5]).getLast20Bytes());\n+            RskAddress lbcAddress = new RskAddress((byte[])args[5]);\n             Address lpBtcAddress = new Address(bridgeConstants.getBtcParams(), (byte[]) args[6]);\n             Coin valueToTransfer = BridgeUtils.getCoinFromBigInteger((BigInteger) args[7]);\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ3OTc4NA==", "url": "https://github.com/rsksmart/rskj/pull/1363#discussion_r524479784", "bodyText": "Why this change is NOT A HARD FORK? AFAIK, this change doesn't rerun previous sent transactions", "author": "ajlopezrsk", "createdAt": "2020-11-16T18:22:22Z", "path": "rskj-core/src/main/java/co/rsk/peg/BridgeMethods.java", "diffHunk": "@@ -577,14 +577,14 @@\n             activations -> activations.isActive(RSKIP143),\n             false\n     ),\n-    REGISTER_BTC_TRANSFER(\n+    REGISTER_FAST_BRIDGE_BTC_TRANSACTION(", "originalCommit": "fc02bfbfce90e610bffc1bc060e17df8fb6a9f6b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ5ODkyNg==", "url": "https://github.com/rsksmart/rskj/pull/1363#discussion_r524498926", "bodyText": "It is a HF. (RSKIP 176)", "author": "pamgonzalez", "createdAt": "2020-11-16T18:54:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ3OTc4NA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "d4bd7cdc025258f2dbfe866d9b19758b7c11a1df", "url": "https://github.com/rsksmart/rskj/commit/d4bd7cdc025258f2dbfe866d9b19758b7c11a1df", "message": "Changes in signature of the function of FastBridgeTransaction\n\nFunction named registerBtcTransfer has been renamed by registerFastBridgeBtcTransaction.\nParameter shouldTransferToContract (boolean type) has been replaced by transferToValue (Coin type).", "committedDate": "2020-11-16T19:21:39Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTIwNDIwMw==", "url": "https://github.com/rsksmart/rskj/pull/1363#discussion_r525204203", "bodyText": "RegisterBtcTransactionException should not be needed I think", "author": "guidohernan93", "createdAt": "2020-11-17T14:38:57Z", "path": "rskj-core/src/main/java/co/rsk/peg/Bridge.java", "diffHunk": "@@ -1116,10 +1117,11 @@ public int registerBtcTransfer(Object[] args) {\n                 userRefundAddress,\n                 lbcAddress,\n                 lpBtcAddress,\n-                executionStatus);\n-        } catch (BlockStoreException | RegisterBtcTransferException | IOException | RegisterBtcTransactionException e) {\n-            logger.warn(\"Exception in registerBtcTransfer\", e);\n-            throw new RuntimeException(\"Exception in registerBtcTransfer\", e);\n+                valueToTransfer\n+            );\n+        } catch (BlockStoreException | RegisterFastBridgeBtcTransactionException | IOException | RegisterBtcTransactionException e) {", "originalCommit": "d4bd7cdc025258f2dbfe866d9b19758b7c11a1df", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f2e185430e95e3fd524d44c27f2c4c69000df74d", "chunk": "diff --git a/rskj-core/src/main/java/co/rsk/peg/Bridge.java b/rskj-core/src/main/java/co/rsk/peg/Bridge.java\nindex a2d372240..9fef05c34 100644\n--- a/rskj-core/src/main/java/co/rsk/peg/Bridge.java\n+++ b/rskj-core/src/main/java/co/rsk/peg/Bridge.java\n\n@@ -1119,7 +1119,7 @@ public class Bridge extends PrecompiledContracts.PrecompiledContract {\n                 lpBtcAddress,\n                 valueToTransfer\n             );\n-        } catch (BlockStoreException | RegisterFastBridgeBtcTransactionException | IOException | RegisterBtcTransactionException e) {\n+        } catch (BlockStoreException | RegisterFastBridgeBtcTransactionException | IOException e) {\n             logger.warn(\"Exception in registerFastBridgeBtcTransaction\", e);\n             throw new RuntimeException(\"Exception in registerFastBridgeBtcTransaction\", e);\n         }\n"}}, {"oid": "f2e185430e95e3fd524d44c27f2c4c69000df74d", "url": "https://github.com/rsksmart/rskj/commit/f2e185430e95e3fd524d44c27f2c4c69000df74d", "message": "Changes in signature of the function of FastBridgeTransaction\n\nFunction named registerBtcTransfer has been renamed by registerFastBridgeBtcTransaction.\nParameter shouldTransferToContract (boolean type) has been replaced by transferToValue (Coin type).", "committedDate": "2020-11-18T16:27:38Z", "type": "forcePushed"}, {"oid": "54deb6a737adb2022076c92cca0fe6a1ef53ec2c", "url": "https://github.com/rsksmart/rskj/commit/54deb6a737adb2022076c92cca0fe6a1ef53ec2c", "message": "Changes in signature of the function of FastBridgeTransaction\n\nFunction named registerBtcTransfer has been renamed by registerFastBridgeBtcTransaction.\nParameter shouldTransferToContract (boolean type) has been replaced by transferToValue (Coin type).", "committedDate": "2020-11-19T14:25:11Z", "type": "commit"}, {"oid": "54deb6a737adb2022076c92cca0fe6a1ef53ec2c", "url": "https://github.com/rsksmart/rskj/commit/54deb6a737adb2022076c92cca0fe6a1ef53ec2c", "message": "Changes in signature of the function of FastBridgeTransaction\n\nFunction named registerBtcTransfer has been renamed by registerFastBridgeBtcTransaction.\nParameter shouldTransferToContract (boolean type) has been replaced by transferToValue (Coin type).", "committedDate": "2020-11-19T14:25:11Z", "type": "forcePushed"}]}