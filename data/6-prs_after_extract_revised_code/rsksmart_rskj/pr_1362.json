{"pr_number": 1362, "pr_title": "Implemented timestamp linking validation", "pr_createdAt": "2020-11-16T08:55:26Z", "pr_url": "https://github.com/rsksmart/rskj/pull/1362", "timeline": [{"oid": "69cda482a2b6703a16f82a3c812e6dfb045002d9", "url": "https://github.com/rsksmart/rskj/commit/69cda482a2b6703a16f82a3c812e6dfb045002d9", "message": "Implemented timestamp linking validation", "committedDate": "2020-12-17T13:48:03Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTEyMTMxOA==", "url": "https://github.com/rsksmart/rskj/pull/1362#discussion_r545121318", "bodyText": "2020?", "author": "patogallaiovlabs", "createdAt": "2020-12-17T14:14:46Z", "path": "rskj-core/src/main/java/co/rsk/util/TimeProvider.java", "diffHunk": "@@ -0,0 +1,25 @@\n+/*\n+ * This file is part of RskJ\n+ * Copyright (C) 2017 RSK Labs Ltd.", "originalCommit": "69cda482a2b6703a16f82a3c812e6dfb045002d9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjY5NDkxOA==", "url": "https://github.com/rsksmart/rskj/pull/1362#discussion_r546694918", "bodyText": "done", "author": "Vovchyk", "createdAt": "2020-12-21T13:06:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTEyMTMxOA=="}], "type": "inlineReview", "revised_code": {"commit": "de57eabf6ae94757eae194e650b6be1760704766", "chunk": "diff --git a/rskj-core/src/main/java/co/rsk/util/TimeProvider.java b/rskj-core/src/main/java/co/rsk/util/TimeProvider.java\nindex 0c05f1e41..3ad478fb8 100644\n--- a/rskj-core/src/main/java/co/rsk/util/TimeProvider.java\n+++ b/rskj-core/src/main/java/co/rsk/util/TimeProvider.java\n\n@@ -1,6 +1,6 @@\n /*\n  * This file is part of RskJ\n- * Copyright (C) 2017 RSK Labs Ltd.\n+ * Copyright (C) 2020 RSK Labs Ltd.\n  *\n  * This program is free software: you can redistribute it and/or modify\n  * it under the terms of the GNU Lesser General Public License as published by\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTM1MDUyNw==", "url": "https://github.com/rsksmart/rskj/pull/1362#discussion_r545350527", "bodyText": "Could you leave a comment here, telling what #179 is all about, short comment (title?)?\nWe are trying to identify faster whats the main reason behind the code.", "author": "patogallaiovlabs", "createdAt": "2020-12-17T19:34:01Z", "path": "rskj-core/src/main/java/org/ethereum/config/blockchain/upgrades/ConsensusRule.java", "diffHunk": "@@ -54,6 +54,7 @@\n     RSKIP171(\"rskip171\"),\n     RSKIP172(\"rskip172\"),\n     RSKIP174(\"rskip174\"),\n+    RSKIP179(\"rskip179\"),", "originalCommit": "69cda482a2b6703a16f82a3c812e6dfb045002d9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTgyNTkzOA==", "url": "https://github.com/rsksmart/rskj/pull/1362#discussion_r545825938", "bodyText": "you can find some details of this RSKIP here", "author": "Vovchyk", "createdAt": "2020-12-18T13:19:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTM1MDUyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjY5NDk5OQ==", "url": "https://github.com/rsksmart/rskj/pull/1362#discussion_r546694999", "bodyText": "done", "author": "Vovchyk", "createdAt": "2020-12-21T13:06:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTM1MDUyNw=="}], "type": "inlineReview", "revised_code": {"commit": "de57eabf6ae94757eae194e650b6be1760704766", "chunk": "diff --git a/rskj-core/src/main/java/org/ethereum/config/blockchain/upgrades/ConsensusRule.java b/rskj-core/src/main/java/org/ethereum/config/blockchain/upgrades/ConsensusRule.java\nindex e11108638..da00752ca 100644\n--- a/rskj-core/src/main/java/org/ethereum/config/blockchain/upgrades/ConsensusRule.java\n+++ b/rskj-core/src/main/java/org/ethereum/config/blockchain/upgrades/ConsensusRule.java\n\n@@ -54,7 +54,7 @@ public enum ConsensusRule {\n     RSKIP171(\"rskip171\"),\n     RSKIP172(\"rskip172\"),\n     RSKIP174(\"rskip174\"),\n-    RSKIP179(\"rskip179\"),\n+    RSKIP179(\"rskip179\"), // BTC-RSK timestamp linking\n     RSKIP180(\"rskip180\"),\n     RSKIPUMM(\"rskipUMM\");\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTM1NTI5Ng==", "url": "https://github.com/rsksmart/rskj/pull/1362#discussion_r545355296", "bodyText": "Its the same to use RegTestParams than MainNetParams in this logic class? Because I dont see any other use than this default constructor, so no matter which network we are, it will use regtest params.", "author": "patogallaiovlabs", "createdAt": "2020-12-17T19:41:57Z", "path": "rskj-core/src/main/java/co/rsk/validators/BlockTimeStampValidationRule.java", "diffHunk": "@@ -18,22 +18,51 @@\n \n package co.rsk.validators;\n \n+import co.rsk.bitcoinj.core.BtcBlock;\n+import co.rsk.bitcoinj.core.NetworkParameters;\n+import co.rsk.bitcoinj.params.RegTestParams;\n+import co.rsk.util.TimeProvider;\n+import org.ethereum.config.Constants;\n+import org.ethereum.config.blockchain.upgrades.ActivationConfig;\n+import org.ethereum.config.blockchain.upgrades.ConsensusRule;\n import org.ethereum.core.Block;\n import org.ethereum.core.BlockHeader;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n+import javax.annotation.Nonnull;\n+import javax.annotation.Nullable;\n+import java.util.Objects;\n+\n /**\n  * Created by mario on 23/01/17.\n  */\n public class BlockTimeStampValidationRule implements BlockParentDependantValidationRule, BlockHeaderParentDependantValidationRule, BlockValidationRule, BlockHeaderValidationRule {\n \n     private static final Logger logger = LoggerFactory.getLogger(\"blockvalidator\");\n \n-    private int validPeriodLength;\n+    private static final long MAX_TIMESTAMPS_DIFF_IN_SECS = Constants.getMaxTimestampsDiffInSecs();\n+\n+    private final int validPeriodLength;\n+    private final ActivationConfig activationConfig;\n+    private final TimeProvider timeProvider;\n+    private final NetworkParameters bitcoinNetworkParameters;\n \n-    public BlockTimeStampValidationRule(int validPeriodLength) {\n+    public BlockTimeStampValidationRule(int validPeriodLength, ActivationConfig activationConfig,\n+                                        TimeProvider timeProvider, NetworkParameters bitcoinNetworkParameters) {\n         this.validPeriodLength = validPeriodLength;\n+        this.activationConfig = Objects.requireNonNull(activationConfig);\n+        this.timeProvider = Objects.requireNonNull(timeProvider);\n+        this.bitcoinNetworkParameters = Objects.requireNonNull(bitcoinNetworkParameters);\n+    }\n+\n+    public BlockTimeStampValidationRule(int validPeriodLength, ActivationConfig activationConfig,\n+                                        TimeProvider timeProvider) {\n+        this(validPeriodLength, activationConfig, timeProvider, RegTestParams.get());", "originalCommit": "69cda482a2b6703a16f82a3c812e6dfb045002d9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTgyNzM5Mg==", "url": "https://github.com/rsksmart/rskj/pull/1362#discussion_r545827392", "bodyText": "Yes, this is bitcoin network params and only this RegTestParams is being used across our code base.", "author": "Vovchyk", "createdAt": "2020-12-18T13:22:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTM1NTI5Ng=="}], "type": "inlineReview", "revised_code": {"commit": "cfa3c45c1b3c5acef45a656978506aab241dad61", "chunk": "diff --git a/rskj-core/src/main/java/co/rsk/validators/BlockTimeStampValidationRule.java b/rskj-core/src/main/java/co/rsk/validators/BlockTimeStampValidationRule.java\nindex 120e104c5..645b3557d 100644\n--- a/rskj-core/src/main/java/co/rsk/validators/BlockTimeStampValidationRule.java\n+++ b/rskj-core/src/main/java/co/rsk/validators/BlockTimeStampValidationRule.java\n\n@@ -56,8 +56,7 @@ public class BlockTimeStampValidationRule implements BlockParentDependantValidat\n         this.bitcoinNetworkParameters = Objects.requireNonNull(bitcoinNetworkParameters);\n     }\n \n-    public BlockTimeStampValidationRule(int validPeriodLength, ActivationConfig activationConfig,\n-                                        TimeProvider timeProvider) {\n+    public BlockTimeStampValidationRule(int validPeriodLength, ActivationConfig activationConfig, TimeProvider timeProvider) {\n         this(validPeriodLength, activationConfig, timeProvider, RegTestParams.get());\n     }\n \n"}}, {"oid": "de57eabf6ae94757eae194e650b6be1760704766", "url": "https://github.com/rsksmart/rskj/commit/de57eabf6ae94757eae194e650b6be1760704766", "message": "Added a comment in ConsensusRule", "committedDate": "2020-12-21T12:50:29Z", "type": "forcePushed"}, {"oid": "de675eb67023baebbd61fb91a430104fe8b03c3c", "url": "https://github.com/rsksmart/rskj/commit/de675eb67023baebbd61fb91a430104fe8b03c3c", "message": "Added a comment in ConsensusRule", "committedDate": "2020-12-28T13:54:44Z", "type": "forcePushed"}, {"oid": "2d47c78792cdc3d25452642c66457417bf8daa3d", "url": "https://github.com/rsksmart/rskj/commit/2d47c78792cdc3d25452642c66457417bf8daa3d", "message": "Added a comment in ConsensusRule", "committedDate": "2020-12-29T08:30:17Z", "type": "forcePushed"}, {"oid": "cfa3c45c1b3c5acef45a656978506aab241dad61", "url": "https://github.com/rsksmart/rskj/commit/cfa3c45c1b3c5acef45a656978506aab241dad61", "message": "Implemented timestamp linking validation", "committedDate": "2020-12-29T10:09:16Z", "type": "commit"}, {"oid": "6f3cfcfcbf1468817eee96edffe2d804fa495958", "url": "https://github.com/rsksmart/rskj/commit/6f3cfcfcbf1468817eee96edffe2d804fa495958", "message": "Added a comment in ConsensusRule", "committedDate": "2020-12-29T10:09:18Z", "type": "commit"}, {"oid": "6f3cfcfcbf1468817eee96edffe2d804fa495958", "url": "https://github.com/rsksmart/rskj/commit/6f3cfcfcbf1468817eee96edffe2d804fa495958", "message": "Added a comment in ConsensusRule", "committedDate": "2020-12-29T10:09:18Z", "type": "forcePushed"}]}