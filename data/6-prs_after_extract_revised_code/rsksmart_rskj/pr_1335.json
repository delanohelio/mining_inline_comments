{"pr_number": 1335, "pr_title": "Process pegin information version1 fix", "pr_createdAt": "2020-10-12T19:15:08Z", "pr_url": "https://github.com/rsksmart/rskj/pull/1335", "timeline": [{"oid": "500209c6eb6503e741cabe096f8a8b939e398a27", "url": "https://github.com/rsksmart/rskj/commit/500209c6eb6503e741cabe096f8a8b939e398a27", "message": "Generte rejection release to refund address instead of sender", "committedDate": "2020-10-13T16:05:08Z", "type": "forcePushed"}, {"oid": "bdd4963a828fa2500a71062a75a3e26167257190", "url": "https://github.com/rsksmart/rskj/commit/bdd4963a828fa2500a71062a75a3e26167257190", "message": "Update lockBtc event in BridgeEventLogger to handle the case when sender is null\n\nIf senderBtcAddress is null because the sender could not be obtained, then put \"Undetermined\" string in the sender field of the event", "committedDate": "2020-10-13T18:56:24Z", "type": "commit"}, {"oid": "6fbf1b981e208a56209fea45255ed69e7457b2fc", "url": "https://github.com/rsksmart/rskj/commit/6fbf1b981e208a56209fea45255ed69e7457b2fc", "message": "Rename BtcLockSender TxType enum to TxSenderAddressType", "committedDate": "2020-10-13T18:56:24Z", "type": "commit"}, {"oid": "c4d57cf18d7c68f4b800498e4dbcfea2b0a402da", "url": "https://github.com/rsksmart/rskj/commit/c4d57cf18d7c68f4b800498e4dbcfea2b0a402da", "message": "Rename txIsProcessable to txIsProcessableInLegacyVersion in BridgeUtils", "committedDate": "2020-10-13T18:56:24Z", "type": "commit"}, {"oid": "d5b15854bceebfb84a0d98fb1303b9ad203d09b2", "url": "https://github.com/rsksmart/rskj/commit/d5b15854bceebfb84a0d98fb1303b9ad203d09b2", "message": "Generte rejection release to refund address instead of sender", "committedDate": "2020-10-13T18:56:24Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE4NTk0MA==", "url": "https://github.com/rsksmart/rskj/pull/1335#discussion_r504185940", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        logger.warn(\"Rejecting lock: return tx build for btc tx {} error. Return was to {}. Tx {}. Value {}\", btcTx.getHash(), btcRefundAddress, rskTx, totalAmount);\n          \n          \n            \n                        panicProcessor.panic(\"lock-refund\", String.format(\"whitelist money return tx build for btc tx %s error. Return was to %s. Tx %s. Value %s\", btcTx.getHash(), btcRefundAddress, rskTx, totalAmount));\n          \n          \n            \n                        logger.warn(\"Rejecting peg-in: return tx build for btc tx {} error. Return was to {}. Tx {}. Value {}\", btcTx.getHash(), btcRefundAddress, rskTx, totalAmount);\n          \n          \n            \n                        panicProcessor.panic(\"peg-in-refund\", String.format(\"peg-in money return tx build for btc tx %s error. Return was to %s. Tx %s. Value %s\", btcTx.getHash(), btcRefundAddress, rskTx, totalAmount));", "author": "josedahlquist", "createdAt": "2020-10-13T18:56:27Z", "path": "rskj-core/src/main/java/co/rsk/peg/BridgeSupport.java", "diffHunk": "@@ -2215,19 +2237,24 @@ private Address getParsedAddress(String base58Address) throws AddressFormatExcep\n         return Address.fromBase58(btcContext.getParams(), base58Address);\n     }\n \n-    private void generateRejectionRelease(BtcTransaction btcTx, Address senderBtcAddress, Transaction rskTx, Coin totalAmount) throws IOException {\n-        Optional<ReleaseTransactionBuilder.BuildResult> buildReturnResult = this.getRefundingTransaction(btcTx, senderBtcAddress);\n+    private void generateRejectionRelease(\n+        BtcTransaction btcTx,\n+        Address btcRefundAddress,\n+        Transaction rskTx,\n+        Coin totalAmount) throws IOException {\n+\n+        Optional<ReleaseTransactionBuilder.BuildResult> buildReturnResult = this.getRefundingTransaction(btcTx, btcRefundAddress);\n         if (buildReturnResult.isPresent()) {\n             if (activations.isActive(ConsensusRule.RSKIP146)) {\n                 provider.getReleaseTransactionSet().add(buildReturnResult.get().getBtcTx(), rskExecutionBlock.getNumber(), rskTx.getHash());\n                 eventLogger.logReleaseBtcRequested(rskTx.getHash().getBytes(), buildReturnResult.get().getBtcTx(), totalAmount);\n             } else {\n                 provider.getReleaseTransactionSet().add(buildReturnResult.get().getBtcTx(), rskExecutionBlock.getNumber());\n             }\n-            logger.info(\"Rejecting lock: return tx build successful to {}. Tx {}. Value {}.\", senderBtcAddress, rskTx, totalAmount);\n+            logger.info(\"Rejecting lock: return tx build successful to {}. Tx {}. Value {}.\", btcRefundAddress, rskTx, totalAmount);\n         } else {\n-            logger.warn(\"Rejecting lock: return tx build for btc tx {} error. Return was to {}. Tx {}. Value {}\", btcTx.getHash(), senderBtcAddress, rskTx, totalAmount);\n-            panicProcessor.panic(\"lock-refund\", String.format(\"whitelist money return tx build for btc tx %s error. Return was to %s. Tx %s. Value %s\", btcTx.getHash(), senderBtcAddress, rskTx, totalAmount));\n+            logger.warn(\"Rejecting lock: return tx build for btc tx {} error. Return was to {}. Tx {}. Value {}\", btcTx.getHash(), btcRefundAddress, rskTx, totalAmount);\n+            panicProcessor.panic(\"lock-refund\", String.format(\"whitelist money return tx build for btc tx %s error. Return was to %s. Tx %s. Value %s\", btcTx.getHash(), btcRefundAddress, rskTx, totalAmount));", "originalCommit": "500209c6eb6503e741cabe096f8a8b939e398a27", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a12caf3243fabf986d5dec2d491f0a50a3bd176d", "chunk": "diff --git a/rskj-core/src/main/java/co/rsk/peg/BridgeSupport.java b/rskj-core/src/main/java/co/rsk/peg/BridgeSupport.java\nindex f6782c284..938370ab6 100644\n--- a/rskj-core/src/main/java/co/rsk/peg/BridgeSupport.java\n+++ b/rskj-core/src/main/java/co/rsk/peg/BridgeSupport.java\n\n@@ -2251,10 +2251,10 @@ public class BridgeSupport {\n             } else {\n                 provider.getReleaseTransactionSet().add(buildReturnResult.get().getBtcTx(), rskExecutionBlock.getNumber());\n             }\n-            logger.info(\"Rejecting lock: return tx build successful to {}. Tx {}. Value {}.\", btcRefundAddress, rskTx, totalAmount);\n+            logger.info(\"Rejecting peg-in: return tx build successful to {}. Tx {}. Value {}.\", btcRefundAddress, rskTx, totalAmount);\n         } else {\n-            logger.warn(\"Rejecting lock: return tx build for btc tx {} error. Return was to {}. Tx {}. Value {}\", btcTx.getHash(), btcRefundAddress, rskTx, totalAmount);\n-            panicProcessor.panic(\"lock-refund\", String.format(\"whitelist money return tx build for btc tx %s error. Return was to %s. Tx %s. Value %s\", btcTx.getHash(), btcRefundAddress, rskTx, totalAmount));\n+            logger.warn(\"Rejecting peg-in: return tx build for btc tx {} error. Return was to {}. Tx {}. Value {}\", btcTx.getHash(), btcRefundAddress, rskTx, totalAmount);\n+            panicProcessor.panic(\"peg-in-refund\", String.format(\"peg-in money return tx build for btc tx %s error. Return was to %s. Tx %s. Value %s\", btcTx.getHash(), btcRefundAddress, rskTx, totalAmount));\n         }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE4NjAzMg==", "url": "https://github.com/rsksmart/rskj/pull/1335#discussion_r504186032", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        logger.info(\"Rejecting lock: return tx build successful to {}. Tx {}. Value {}.\", btcRefundAddress, rskTx, totalAmount);\n          \n          \n            \n                        logger.info(\"Rejecting peg-in: return tx build successful to {}. Tx {}. Value {}.\", btcRefundAddress, rskTx, totalAmount);", "author": "josedahlquist", "createdAt": "2020-10-13T18:56:36Z", "path": "rskj-core/src/main/java/co/rsk/peg/BridgeSupport.java", "diffHunk": "@@ -2215,19 +2237,24 @@ private Address getParsedAddress(String base58Address) throws AddressFormatExcep\n         return Address.fromBase58(btcContext.getParams(), base58Address);\n     }\n \n-    private void generateRejectionRelease(BtcTransaction btcTx, Address senderBtcAddress, Transaction rskTx, Coin totalAmount) throws IOException {\n-        Optional<ReleaseTransactionBuilder.BuildResult> buildReturnResult = this.getRefundingTransaction(btcTx, senderBtcAddress);\n+    private void generateRejectionRelease(\n+        BtcTransaction btcTx,\n+        Address btcRefundAddress,\n+        Transaction rskTx,\n+        Coin totalAmount) throws IOException {\n+\n+        Optional<ReleaseTransactionBuilder.BuildResult> buildReturnResult = this.getRefundingTransaction(btcTx, btcRefundAddress);\n         if (buildReturnResult.isPresent()) {\n             if (activations.isActive(ConsensusRule.RSKIP146)) {\n                 provider.getReleaseTransactionSet().add(buildReturnResult.get().getBtcTx(), rskExecutionBlock.getNumber(), rskTx.getHash());\n                 eventLogger.logReleaseBtcRequested(rskTx.getHash().getBytes(), buildReturnResult.get().getBtcTx(), totalAmount);\n             } else {\n                 provider.getReleaseTransactionSet().add(buildReturnResult.get().getBtcTx(), rskExecutionBlock.getNumber());\n             }\n-            logger.info(\"Rejecting lock: return tx build successful to {}. Tx {}. Value {}.\", senderBtcAddress, rskTx, totalAmount);\n+            logger.info(\"Rejecting lock: return tx build successful to {}. Tx {}. Value {}.\", btcRefundAddress, rskTx, totalAmount);", "originalCommit": "500209c6eb6503e741cabe096f8a8b939e398a27", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a12caf3243fabf986d5dec2d491f0a50a3bd176d", "chunk": "diff --git a/rskj-core/src/main/java/co/rsk/peg/BridgeSupport.java b/rskj-core/src/main/java/co/rsk/peg/BridgeSupport.java\nindex f6782c284..938370ab6 100644\n--- a/rskj-core/src/main/java/co/rsk/peg/BridgeSupport.java\n+++ b/rskj-core/src/main/java/co/rsk/peg/BridgeSupport.java\n\n@@ -2251,10 +2251,10 @@ public class BridgeSupport {\n             } else {\n                 provider.getReleaseTransactionSet().add(buildReturnResult.get().getBtcTx(), rskExecutionBlock.getNumber());\n             }\n-            logger.info(\"Rejecting lock: return tx build successful to {}. Tx {}. Value {}.\", btcRefundAddress, rskTx, totalAmount);\n+            logger.info(\"Rejecting peg-in: return tx build successful to {}. Tx {}. Value {}.\", btcRefundAddress, rskTx, totalAmount);\n         } else {\n-            logger.warn(\"Rejecting lock: return tx build for btc tx {} error. Return was to {}. Tx {}. Value {}\", btcTx.getHash(), btcRefundAddress, rskTx, totalAmount);\n-            panicProcessor.panic(\"lock-refund\", String.format(\"whitelist money return tx build for btc tx %s error. Return was to %s. Tx %s. Value %s\", btcTx.getHash(), btcRefundAddress, rskTx, totalAmount));\n+            logger.warn(\"Rejecting peg-in: return tx build for btc tx {} error. Return was to {}. Tx {}. Value {}\", btcTx.getHash(), btcRefundAddress, rskTx, totalAmount);\n+            panicProcessor.panic(\"peg-in-refund\", String.format(\"peg-in money return tx build for btc tx %s error. Return was to %s. Tx %s. Value %s\", btcTx.getHash(), btcRefundAddress, rskTx, totalAmount));\n         }\n     }\n \n"}}, {"oid": "a12caf3243fabf986d5dec2d491f0a50a3bd176d", "url": "https://github.com/rsksmart/rskj/commit/a12caf3243fabf986d5dec2d491f0a50a3bd176d", "message": "Generte rejection release to refund address instead of sender", "committedDate": "2020-10-13T19:10:23Z", "type": "commit"}, {"oid": "a12caf3243fabf986d5dec2d491f0a50a3bd176d", "url": "https://github.com/rsksmart/rskj/commit/a12caf3243fabf986d5dec2d491f0a50a3bd176d", "message": "Generte rejection release to refund address instead of sender", "committedDate": "2020-10-13T19:10:23Z", "type": "forcePushed"}]}