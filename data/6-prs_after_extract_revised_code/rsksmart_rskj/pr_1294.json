{"pr_number": 1294, "pr_title": "Log nanoseconds as seconds", "pr_createdAt": "2020-08-18T19:21:11Z", "pr_url": "https://github.com/rsksmart/rskj/pull/1294", "timeline": [{"oid": "8586239c912498f1e48c360d5bb4e07b521a62ce", "url": "https://github.com/rsksmart/rskj/commit/8586239c912498f1e48c360d5bb4e07b521a62ce", "message": "Warn if block process takes more than one minute", "committedDate": "2020-08-19T14:54:24Z", "type": "forcePushed"}, {"oid": "f2c48d17aca9c5a090d00dbc8bfba1a9c0cd46e6", "url": "https://github.com/rsksmart/rskj/commit/f2c48d17aca9c5a090d00dbc8bfba1a9c0cd46e6", "message": "Warn if block process takes more than one minute", "committedDate": "2020-08-26T13:41:06Z", "type": "forcePushed"}, {"oid": "91a86107862921e14dec88b596b923bfa738a1e0", "url": "https://github.com/rsksmart/rskj/commit/91a86107862921e14dec88b596b923bfa738a1e0", "message": "Warn if block process takes more than one minute", "committedDate": "2020-08-27T20:12:27Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTMyOTk5NQ==", "url": "https://github.com/rsksmart/rskj/pull/1294#discussion_r481329995", "bodyText": "final?", "author": "patogallaiovlabs", "createdAt": "2020-09-01T17:58:18Z", "path": "rskj-core/src/main/java/co/rsk/core/bc/BlockUtils.java", "diffHunk": "@@ -32,9 +32,14 @@\n  * Created by ajlopez on 19/08/2016.\n  */\n public class BlockUtils {\n+    private static long MAX_BLOCK_PROCESS_TIME_NANOSECONDS = 60_000_000_000L;", "originalCommit": "91a86107862921e14dec88b596b923bfa738a1e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA3MzMzMw==", "url": "https://github.com/rsksmart/rskj/pull/1294#discussion_r483073333", "bodyText": "done", "author": "ajlopezrsk", "createdAt": "2020-09-03T15:38:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTMyOTk5NQ=="}], "type": "inlineReview", "revised_code": {"commit": "66f3a40736615f3845ad24f66f422aace7b04cd2", "chunk": "diff --git a/rskj-core/src/main/java/co/rsk/core/bc/BlockUtils.java b/rskj-core/src/main/java/co/rsk/core/bc/BlockUtils.java\nindex b7b2bd944..afe66fd0a 100644\n--- a/rskj-core/src/main/java/co/rsk/core/bc/BlockUtils.java\n+++ b/rskj-core/src/main/java/co/rsk/core/bc/BlockUtils.java\n\n@@ -32,7 +32,7 @@ import java.util.stream.Collectors;\n  * Created by ajlopez on 19/08/2016.\n  */\n public class BlockUtils {\n-    private static long MAX_BLOCK_PROCESS_TIME_NANOSECONDS = 60_000_000_000L;\n+    private static final long MAX_BLOCK_PROCESS_TIME_NANOSECONDS = 60_000_000_000L;\n \n     private BlockUtils() { }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTMzMTA5NA==", "url": "https://github.com/rsksmart/rskj/pull/1294#discussion_r481331094", "bodyText": "I would add some tests for this method, seems to have some complexity.", "author": "patogallaiovlabs", "createdAt": "2020-09-01T18:00:09Z", "path": "rskj-core/src/main/java/co/rsk/net/BlockProcessResult.java", "diffHunk": "@@ -69,10 +71,17 @@ public boolean isInvalidBlock() {\n \n     private void logResult(String blockHash, Duration processingTime) {", "originalCommit": "91a86107862921e14dec88b596b923bfa738a1e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzIyNDA3MA==", "url": "https://github.com/rsksmart/rskj/pull/1294#discussion_r483224070", "bodyText": "Done", "author": "ajlopezrsk", "createdAt": "2020-09-03T20:05:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTMzMTA5NA=="}], "type": "inlineReview", "revised_code": {"commit": "66f3a40736615f3845ad24f66f422aace7b04cd2", "chunk": "diff --git a/rskj-core/src/main/java/co/rsk/net/BlockProcessResult.java b/rskj-core/src/main/java/co/rsk/net/BlockProcessResult.java\nindex d294f3407..3dd9ced36 100644\n--- a/rskj-core/src/main/java/co/rsk/net/BlockProcessResult.java\n+++ b/rskj-core/src/main/java/co/rsk/net/BlockProcessResult.java\n\n@@ -70,23 +71,39 @@ public class BlockProcessResult {\n     }\n \n     private void logResult(String blockHash, Duration processingTime) {\n-        if(result == null || result.isEmpty()) {\n-            long processTime =  processingTime.toNanos();\n+        String message = buildLogMessage(blockHash, processingTime, result);\n \n-            if (BlockUtils.tooMuchProcessTime(processTime)) {\n-                logger.warn(\"[MESSAGE PROCESS] Block[{}] After[{}] seconds, process result. No block connections were made\", FormatUtils.formatNanosecondsToSeconds(processTime), blockHash);\n-            }\n-            else {\n-                logger.debug(\"[MESSAGE PROCESS] Block[{}] After[{}] seconds, process result. No block connections were made\", FormatUtils.formatNanosecondsToSeconds(processTime), blockHash);\n-            }\n+        if (BlockUtils.tooMuchProcessTime(processingTime.getNano())) {\n+            logger.warn(message);\n+        }\n+        else {\n+            logger.debug(message);\n+        }\n+    }\n+\n+    @VisibleForTesting\n+    public static String buildLogMessage(String blockHash, Duration processingTime, Map<Keccak256, ImportResult> result) {\n+        StringBuilder sb = new StringBuilder(\"[MESSAGE PROCESS] Block[\")\n+                .append(blockHash)\n+                .append(\"] After[\")\n+                .append(FormatUtils.formatNanosecondsToSeconds(processingTime.toNanos()))\n+                .append(\"] seconds, process result.\");\n+\n+        if (result == null || result.isEmpty()) {\n+            sb.append(\" No block connections were made\");\n         } else {\n-            StringBuilder sb = new StringBuilder(\"[MESSAGE PROCESS] Block[\")\n-                    .append(blockHash).append(\"] After[\").append(FormatUtils.formatNanosecondsToSeconds(processingTime.toNanos())).append(\"] nano, process result. Connections attempts: \").append(result.size()).append(\" | \");\n+            sb.append(\" Connections attempts: \")\n+                    .append(result.size())\n+                    .append(\" | \");\n \n-            for(Map.Entry<Keccak256, ImportResult> entry : this.result.entrySet()) {\n-                sb.append(entry.getKey().toString()).append(\" - \").append(entry.getValue()).append(\" | \");\n+            for (Map.Entry<Keccak256, ImportResult> entry : result.entrySet()) {\n+                sb.append(entry.getKey().toString())\n+                        .append(\" - \")\n+                        .append(entry.getValue())\n+                        .append(\" | \");\n             }\n-            logger.debug(sb.toString());\n         }\n+\n+        return sb.toString();\n     }\n }\n"}}, {"oid": "278cca473857d83248851467d5cc2ae822d5262b", "url": "https://github.com/rsksmart/rskj/commit/278cca473857d83248851467d5cc2ae822d5262b", "message": "Warn if block process takes more than one minute", "committedDate": "2020-09-02T14:15:17Z", "type": "forcePushed"}, {"oid": "66f3a40736615f3845ad24f66f422aace7b04cd2", "url": "https://github.com/rsksmart/rskj/commit/66f3a40736615f3845ad24f66f422aace7b04cd2", "message": "BlockProcessorResult build log message", "committedDate": "2020-09-03T19:09:43Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzIzNDMzMg==", "url": "https://github.com/rsksmart/rskj/pull/1294#discussion_r483234332", "bodyText": "you don't need to add num and hash, MDC adds that to every logged line", "author": "nicops", "createdAt": "2020-09-03T20:24:11Z", "path": "rskj-core/src/main/java/co/rsk/core/bc/BlockChainImpl.java", "diffHunk": "@@ -156,7 +157,15 @@ public ImportResult tryToConnect(Block block) {\n                     long saveTime = System.nanoTime();\n                     ImportResult result = internalTryToConnect(block);\n                     long totalTime = System.nanoTime() - saveTime;\n-                    logger.info(\"block: num: [{}] hash: [{}], processed after: [{}]nano, result {}\", block.getNumber(), block.getPrintableHash(), totalTime, result);\n+                    String timeInSeconds = FormatUtils.formatNanosecondsToSeconds(totalTime);\n+\n+                    if (BlockUtils.tooMuchProcessTime(totalTime)) {\n+                        logger.warn(\"block: num: [{}] hash: [{}], processed after: [{}]seconds, result {}\", block.getNumber(), block.getPrintableHash(), timeInSeconds, result);", "originalCommit": "66f3a40736615f3845ad24f66f422aace7b04cd2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzI0OTI1OA==", "url": "https://github.com/rsksmart/rskj/pull/1294#discussion_r483249258", "bodyText": "OK, but why such messages were not changed in the pull request that adds the MDC? The above messages are only an improve over those messages", "author": "ajlopezrsk", "createdAt": "2020-09-03T20:55:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzIzNDMzMg=="}], "type": "inlineReview", "revised_code": {"commit": "4fae62f6f7ac6ee23d2a1a67888730f27608830c", "chunk": "diff --git a/rskj-core/src/main/java/co/rsk/core/bc/BlockChainImpl.java b/rskj-core/src/main/java/co/rsk/core/bc/BlockChainImpl.java\nindex 88a0df269..273a56d65 100644\n--- a/rskj-core/src/main/java/co/rsk/core/bc/BlockChainImpl.java\n+++ b/rskj-core/src/main/java/co/rsk/core/bc/BlockChainImpl.java\n\n@@ -157,15 +156,7 @@ public class BlockChainImpl implements Blockchain {\n                     long saveTime = System.nanoTime();\n                     ImportResult result = internalTryToConnect(block);\n                     long totalTime = System.nanoTime() - saveTime;\n-                    String timeInSeconds = FormatUtils.formatNanosecondsToSeconds(totalTime);\n-\n-                    if (BlockUtils.tooMuchProcessTime(totalTime)) {\n-                        logger.warn(\"block: num: [{}] hash: [{}], processed after: [{}]seconds, result {}\", block.getNumber(), block.getPrintableHash(), timeInSeconds, result);\n-                    }\n-                    else {\n-                        logger.info(\"block: num: [{}] hash: [{}], processed after: [{}]seconds, result {}\", block.getNumber(), block.getPrintableHash(), timeInSeconds, result);\n-                    }\n-\n+                    logger.info(\"block: num: [{}] hash: [{}], processed after: [{}]nano, result {}\", block.getNumber(), block.getPrintableHash(), totalTime, result);\n                     return result;\n                 }\n             } catch (Throwable t) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzIzNDg2MA==", "url": "https://github.com/rsksmart/rskj/pull/1294#discussion_r483234860", "bodyText": "same comment as above, you can dispense of the num and hash", "author": "nicops", "createdAt": "2020-09-03T20:25:16Z", "path": "rskj-core/src/main/java/co/rsk/core/bc/BlockChainImpl.java", "diffHunk": "@@ -257,7 +266,14 @@ private ImportResult internalTryToConnect(Block block) {\n             // to the parent's repository.\n \n             long totalTime = System.nanoTime() - saveTime;\n-            logger.trace(\"block: num: [{}] hash: [{}], executed after: [{}]nano\", block.getNumber(), block.getPrintableHash(), totalTime);\n+            String timeInSeconds = FormatUtils.formatNanosecondsToSeconds(totalTime);\n+\n+            if (BlockUtils.tooMuchProcessTime(totalTime)) {\n+                logger.warn(\"block: num: [{}] hash: [{}], executed after: [{}]seconds\", block.getNumber(), block.getPrintableHash(), timeInSeconds);", "originalCommit": "66f3a40736615f3845ad24f66f422aace7b04cd2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "4fae62f6f7ac6ee23d2a1a67888730f27608830c", "chunk": "diff --git a/rskj-core/src/main/java/co/rsk/core/bc/BlockChainImpl.java b/rskj-core/src/main/java/co/rsk/core/bc/BlockChainImpl.java\nindex 88a0df269..273a56d65 100644\n--- a/rskj-core/src/main/java/co/rsk/core/bc/BlockChainImpl.java\n+++ b/rskj-core/src/main/java/co/rsk/core/bc/BlockChainImpl.java\n\n@@ -266,14 +257,7 @@ public class BlockChainImpl implements Blockchain {\n             // to the parent's repository.\n \n             long totalTime = System.nanoTime() - saveTime;\n-            String timeInSeconds = FormatUtils.formatNanosecondsToSeconds(totalTime);\n-\n-            if (BlockUtils.tooMuchProcessTime(totalTime)) {\n-                logger.warn(\"block: num: [{}] hash: [{}], executed after: [{}]seconds\", block.getNumber(), block.getPrintableHash(), timeInSeconds);\n-            }\n-            else {\n-                logger.trace(\"block: num: [{}] hash: [{}], executed after: [{}]seconds\", block.getNumber(), block.getPrintableHash(), timeInSeconds);\n-            }\n+            logger.trace(\"block: num: [{}] hash: [{}], executed after: [{}]nano\", block.getNumber(), block.getPrintableHash(), totalTime);\n \n             // the block is valid at this point\n             stateRootHandler.register(block.getHeader(), result.getFinalState());\n"}}, {"oid": "ca80546f20446187ee720cdb56851a6fabdb43cf", "url": "https://github.com/rsksmart/rskj/commit/ca80546f20446187ee720cdb56851a6fabdb43cf", "message": "Conditional in some logs", "committedDate": "2020-09-03T21:40:56Z", "type": "forcePushed"}, {"oid": "4fae62f6f7ac6ee23d2a1a67888730f27608830c", "url": "https://github.com/rsksmart/rskj/commit/4fae62f6f7ac6ee23d2a1a67888730f27608830c", "message": "Format nanoseconds to seconds", "committedDate": "2020-09-07T13:13:04Z", "type": "commit"}, {"oid": "3c315c8f4c3fe8f19cd309a0c3b92dae3556ba72", "url": "https://github.com/rsksmart/rskj/commit/3c315c8f4c3fe8f19cd309a0c3b92dae3556ba72", "message": "Log messages in seconds", "committedDate": "2020-09-07T13:13:04Z", "type": "commit"}, {"oid": "db8c74372eca710f51b0a94f1f49b81362f4b444", "url": "https://github.com/rsksmart/rskj/commit/db8c74372eca710f51b0a94f1f49b81362f4b444", "message": "Fixing sonar issues", "committedDate": "2020-09-07T13:13:04Z", "type": "commit"}, {"oid": "1509b10bc7fc20682b4d558e3e1e6ad677548c35", "url": "https://github.com/rsksmart/rskj/commit/1509b10bc7fc20682b4d558e3e1e6ad677548c35", "message": "Warn if block process takes more than one minute", "committedDate": "2020-09-07T13:13:04Z", "type": "commit"}, {"oid": "41ee2a6c64827f40b8c57a568ea2ef9a67d12efb", "url": "https://github.com/rsksmart/rskj/commit/41ee2a6c64827f40b8c57a568ea2ef9a67d12efb", "message": "Static constant as final", "committedDate": "2020-09-07T13:13:04Z", "type": "commit"}, {"oid": "89f40bedef30a82a726017725cc21b691bf7981f", "url": "https://github.com/rsksmart/rskj/commit/89f40bedef30a82a726017725cc21b691bf7981f", "message": "BlockProcessorResult build log message", "committedDate": "2020-09-07T13:13:04Z", "type": "commit"}, {"oid": "da3d5f2ca0e440aa112edcbf5304ddf022c2e238", "url": "https://github.com/rsksmart/rskj/commit/da3d5f2ca0e440aa112edcbf5304ddf022c2e238", "message": "Conditional in some logs", "committedDate": "2020-09-07T13:13:04Z", "type": "commit"}, {"oid": "da3d5f2ca0e440aa112edcbf5304ddf022c2e238", "url": "https://github.com/rsksmart/rskj/commit/da3d5f2ca0e440aa112edcbf5304ddf022c2e238", "message": "Conditional in some logs", "committedDate": "2020-09-07T13:13:04Z", "type": "forcePushed"}]}