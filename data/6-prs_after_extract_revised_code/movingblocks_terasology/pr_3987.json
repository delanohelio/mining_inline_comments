{"pr_number": 3987, "pr_title": "feat: BlockFamily API enhancement", "pr_createdAt": "2020-05-25T11:27:56Z", "pr_url": "https://github.com/MovingBlocks/Terasology/pull/3987", "timeline": [{"oid": "e42e30b4898f0870ddd75bd1ce277eea8e6ee1f1", "url": "https://github.com/MovingBlocks/Terasology/commit/e42e30b4898f0870ddd75bd1ce277eea8e6ee1f1", "message": "Add a new block placement method to BlockFamily\n\nThe new method gets passed more data to determine the resulting\nblock orientation. The old method got deprecated.", "committedDate": "2020-05-25T11:09:32Z", "type": "commit"}, {"oid": "dfad910a54e81cb97e33b83fc41e7d8b639a59e8", "url": "https://github.com/MovingBlocks/Terasology/commit/dfad910a54e81cb97e33b83fc41e7d8b639a59e8", "message": "Add BlockPlacementData to wrap the parameters passed to BlockFamily for block placement", "committedDate": "2020-05-25T11:09:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTg4NTQ1NA==", "url": "https://github.com/MovingBlocks/Terasology/pull/3987#discussion_r429885454", "bodyText": "This is currently not null safe, I'm not sure if it has to be though.", "author": "kBlaszczyk", "createdAt": "2020-05-25T11:30:57Z", "path": "engine/src/main/java/org/terasology/world/block/family/BlockPlacementData.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Copyright 2020 MovingBlocks\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.terasology.world.block.family;\n+\n+import org.joml.Vector2f;\n+import org.joml.Vector2fc;\n+import org.joml.Vector3f;\n+import org.joml.Vector3fc;\n+import org.joml.Vector3i;\n+import org.joml.Vector3ic;\n+import org.terasology.math.Side;\n+\n+/**\n+ * BlockPlacementData represents data that is useful for determining the orientation of new block.\n+ * The data is supposed to be derived from the players state when placing the block.\n+ * BlockPlacementData is immutable.\n+ */\n+public class BlockPlacementData {\n+\n+    public final Vector3ic blockPosition;\n+    public final Side attachmentSide;\n+    public final Vector3fc viewingDirection;\n+    public final Vector2fc relativeAttachmentPosition;\n+\n+    /**\n+     * @param blockPosition     The block position, at which the block is going to be placed at.\n+     * @param attachmentSide    The side of the block which this block is being attached to, e.g. Top if the block is being placed on the ground\n+     */\n+    public BlockPlacementData(Vector3ic blockPosition, Side attachmentSide, Vector3fc viewingDirection) {\n+        this(blockPosition, attachmentSide, viewingDirection, new Vector2f());\n+    }\n+\n+    /**\n+     * @param blockPosition     The block position, at which the block is going to be placed at.\n+     * @param attachmentSide    The side of the block which this block is being attached to, e.g. Top if the block is being placed on the ground\n+     * @param relativeAttachmentPosition The position on the block surface that the user aimed at when placing the block. A value between (0, 0) and (1, 1).\n+     */\n+    public BlockPlacementData(Vector3ic blockPosition, Side attachmentSide, Vector3fc viewingDirection, Vector2fc relativeAttachmentPosition) {\n+        this.blockPosition = new Vector3i(blockPosition);", "originalCommit": "dfad910a54e81cb97e33b83fc41e7d8b639a59e8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTk4Njg0Nw==", "url": "https://github.com/MovingBlocks/Terasology/pull/3987#discussion_r431986847", "bodyText": "Good question. I'm tending to doing null-checks here to ensure that all values are non-null whenever something on usage side accesses them. I suspect that nobody will ever to a null-check there....\nCan use Guava's Preconditions here.", "author": "skaldarnar", "createdAt": "2020-05-28T16:59:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTg4NTQ1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTk5NTQwNg==", "url": "https://github.com/MovingBlocks/Terasology/pull/3987#discussion_r431995406", "bodyText": "The question is how we are going to react when null is being passed. Default to position zero? The client side doesn't have to worry about null checks here, because new Vector3i(null) would fail and crash on creation.", "author": "kBlaszczyk", "createdAt": "2020-05-28T17:13:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTg4NTQ1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjA0NTQzOQ==", "url": "https://github.com/MovingBlocks/Terasology/pull/3987#discussion_r432045439", "bodyText": "I think that Preconditions.checkNotNull() will throw a NPE if the check fails.\nI'd say it's good enough for now, and I don't expect us to run into serious problems. At least debugging NPEs is quite a relaxing exercise \ud83d\ude05", "author": "skaldarnar", "createdAt": "2020-05-28T18:43:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTg4NTQ1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjA0ODEzMg==", "url": "https://github.com/MovingBlocks/Terasology/pull/3987#discussion_r432048132", "bodyText": "NPE from Preconditions better then NPE from long call chain. You  can determinate which variable is null. At least", "author": "DarkWeird", "createdAt": "2020-05-28T18:48:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTg4NTQ1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjA2ODM2MQ==", "url": "https://github.com/MovingBlocks/Terasology/pull/3987#discussion_r432068361", "bodyText": "I agree. Done.", "author": "kBlaszczyk", "createdAt": "2020-05-28T19:26:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTg4NTQ1NA=="}], "type": "inlineReview", "revised_code": {"commit": "b398b66c7fbe0d99dc04cd16b6e2d46c27c8650d", "chunk": "diff --git a/engine/src/main/java/org/terasology/world/block/family/BlockPlacementData.java b/engine/src/main/java/org/terasology/world/block/family/BlockPlacementData.java\nindex cc06eae39..cc4c0db2d 100644\n--- a/engine/src/main/java/org/terasology/world/block/family/BlockPlacementData.java\n+++ b/engine/src/main/java/org/terasology/world/block/family/BlockPlacementData.java\n\n@@ -30,23 +30,40 @@\n  */\n public class BlockPlacementData {\n \n+    /**\n+     * The block position, at which the block is supposed to be placed at\n+     */\n     public final Vector3ic blockPosition;\n+\n+    /**\n+     * The block side, this block is being attached to, e.g. Top if the block is being placed on the ground\n+     */\n     public final Side attachmentSide;\n+\n+    /**\n+     * The player's viewing direction\n+     */\n     public final Vector3fc viewingDirection;\n+\n+    /**\n+     * The position on the block surface that the user aimed at when placing the block. A vector in the range (0..1, 0..1)\n+     */\n     public final Vector2fc relativeAttachmentPosition;\n \n     /**\n-     * @param blockPosition     The block position, at which the block is going to be placed at.\n+     * @param blockPosition     The block position, at which the block is supposed to be placed at\n      * @param attachmentSide    The side of the block which this block is being attached to, e.g. Top if the block is being placed on the ground\n+     * @param viewingDirection  The players viewing direction\n      */\n     public BlockPlacementData(Vector3ic blockPosition, Side attachmentSide, Vector3fc viewingDirection) {\n         this(blockPosition, attachmentSide, viewingDirection, new Vector2f());\n     }\n \n     /**\n-     * @param blockPosition     The block position, at which the block is going to be placed at.\n+     * @param blockPosition     The block position, at which the block is supposed to be placed at\n      * @param attachmentSide    The side of the block which this block is being attached to, e.g. Top if the block is being placed on the ground\n-     * @param relativeAttachmentPosition The position on the block surface that the user aimed at when placing the block. A value between (0, 0) and (1, 1).\n+     * @param viewingDirection  The players viewing direction\n+     * @param relativeAttachmentPosition The position on the block surface that the user aimed at when placing the block. A vector in the range (0..1, 0..1)\n      */\n     public BlockPlacementData(Vector3ic blockPosition, Side attachmentSide, Vector3fc viewingDirection, Vector2fc relativeAttachmentPosition) {\n         this.blockPosition = new Vector3i(blockPosition);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTk4NTIwMw==", "url": "https://github.com/MovingBlocks/Terasology/pull/3987#discussion_r431985203", "bodyText": "These public members should probably also have doc comments to explain what they are. Basically what you've used for the parameter descriptions.", "author": "skaldarnar", "createdAt": "2020-05-28T16:57:08Z", "path": "engine/src/main/java/org/terasology/world/block/family/BlockPlacementData.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Copyright 2020 MovingBlocks\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.terasology.world.block.family;\n+\n+import org.joml.Vector2f;\n+import org.joml.Vector2fc;\n+import org.joml.Vector3f;\n+import org.joml.Vector3fc;\n+import org.joml.Vector3i;\n+import org.joml.Vector3ic;\n+import org.terasology.math.Side;\n+\n+/**\n+ * BlockPlacementData represents data that is useful for determining the orientation of new block.\n+ * The data is supposed to be derived from the players state when placing the block.\n+ * BlockPlacementData is immutable.\n+ */\n+public class BlockPlacementData {\n+\n+    public final Vector3ic blockPosition;", "originalCommit": "dfad910a54e81cb97e33b83fc41e7d8b639a59e8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTk5NzU3OA==", "url": "https://github.com/MovingBlocks/Terasology/pull/3987#discussion_r431997578", "bodyText": "will be done.\n\nAlso, this will break some modules that define block families, right?\n\nIf defining block families is a thing, they would need to be updated, yes.\nI will check how many Omega modules are affected.", "author": "kBlaszczyk", "createdAt": "2020-05-28T17:17:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTk4NTIwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjA1Nzg3Nw==", "url": "https://github.com/MovingBlocks/Terasology/pull/3987#discussion_r432057877", "bodyText": "here is the list of modules that need to be fixed:\nSample\nMarcinScIncubator\nMultiBlock\nTutorialAssetSystem\nMachines\nMinesweeper\n\nIf you confirm the current API change, I'll roll out the fixes tomorrow.", "author": "kBlaszczyk", "createdAt": "2020-05-28T19:06:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTk4NTIwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjEyMDg1OQ==", "url": "https://github.com/MovingBlocks/Terasology/pull/3987#discussion_r432120859", "bodyText": "MarcinScIncubator still is a thing? \ud83e\udd14 Thought we archived it?\n@kBlaszczyk could you provide PRs for updating those modules (if not already happened), please \ud83d\ude43", "author": "skaldarnar", "createdAt": "2020-05-28T21:00:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTk4NTIwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjEyMTU5Mw==", "url": "https://github.com/MovingBlocks/Terasology/pull/3987#discussion_r432121593", "bodyText": "\"Thanks\" to the way GitHub leaves redirects in place to moved repos it'll probably be easily possible to not realize something got archived ... :-) Just still works. Or in this case breaks.", "author": "Cervator", "createdAt": "2020-05-28T21:02:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTk4NTIwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjEyNDY5Nw==", "url": "https://github.com/MovingBlocks/Terasology/pull/3987#discussion_r432124697", "bodyText": "@skaldarnar yes, will do.", "author": "kBlaszczyk", "createdAt": "2020-05-28T21:08:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTk4NTIwMw=="}], "type": "inlineReview", "revised_code": {"commit": "b398b66c7fbe0d99dc04cd16b6e2d46c27c8650d", "chunk": "diff --git a/engine/src/main/java/org/terasology/world/block/family/BlockPlacementData.java b/engine/src/main/java/org/terasology/world/block/family/BlockPlacementData.java\nindex cc06eae39..cc4c0db2d 100644\n--- a/engine/src/main/java/org/terasology/world/block/family/BlockPlacementData.java\n+++ b/engine/src/main/java/org/terasology/world/block/family/BlockPlacementData.java\n\n@@ -30,23 +30,40 @@\n  */\n public class BlockPlacementData {\n \n+    /**\n+     * The block position, at which the block is supposed to be placed at\n+     */\n     public final Vector3ic blockPosition;\n+\n+    /**\n+     * The block side, this block is being attached to, e.g. Top if the block is being placed on the ground\n+     */\n     public final Side attachmentSide;\n+\n+    /**\n+     * The player's viewing direction\n+     */\n     public final Vector3fc viewingDirection;\n+\n+    /**\n+     * The position on the block surface that the user aimed at when placing the block. A vector in the range (0..1, 0..1)\n+     */\n     public final Vector2fc relativeAttachmentPosition;\n \n     /**\n-     * @param blockPosition     The block position, at which the block is going to be placed at.\n+     * @param blockPosition     The block position, at which the block is supposed to be placed at\n      * @param attachmentSide    The side of the block which this block is being attached to, e.g. Top if the block is being placed on the ground\n+     * @param viewingDirection  The players viewing direction\n      */\n     public BlockPlacementData(Vector3ic blockPosition, Side attachmentSide, Vector3fc viewingDirection) {\n         this(blockPosition, attachmentSide, viewingDirection, new Vector2f());\n     }\n \n     /**\n-     * @param blockPosition     The block position, at which the block is going to be placed at.\n+     * @param blockPosition     The block position, at which the block is supposed to be placed at\n      * @param attachmentSide    The side of the block which this block is being attached to, e.g. Top if the block is being placed on the ground\n-     * @param relativeAttachmentPosition The position on the block surface that the user aimed at when placing the block. A value between (0, 0) and (1, 1).\n+     * @param viewingDirection  The players viewing direction\n+     * @param relativeAttachmentPosition The position on the block surface that the user aimed at when placing the block. A vector in the range (0..1, 0..1)\n      */\n     public BlockPlacementData(Vector3ic blockPosition, Side attachmentSide, Vector3fc viewingDirection, Vector2fc relativeAttachmentPosition) {\n         this.blockPosition = new Vector3i(blockPosition);\n"}}, {"oid": "b398b66c7fbe0d99dc04cd16b6e2d46c27c8650d", "url": "https://github.com/MovingBlocks/Terasology/commit/b398b66c7fbe0d99dc04cd16b6e2d46c27c8650d", "message": "Improve Javadoc in BlockPlacementData", "committedDate": "2020-05-28T17:26:26Z", "type": "commit"}, {"oid": "ae640e7b8d58587b2c785f9c83868b593e1d830c", "url": "https://github.com/MovingBlocks/Terasology/commit/ae640e7b8d58587b2c785f9c83868b593e1d830c", "message": "Add not-null-preconditions to BlockPlacementData arguments", "committedDate": "2020-05-28T19:25:42Z", "type": "commit"}]}