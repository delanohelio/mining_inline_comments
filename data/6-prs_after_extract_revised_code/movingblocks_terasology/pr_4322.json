{"pr_number": 4322, "pr_title": "feat(JOML): migrate world gen", "pr_createdAt": "2020-12-13T21:15:22Z", "pr_url": "https://github.com/MovingBlocks/Terasology/pull/4322", "timeline": [{"oid": "6bdf1f19428e5f08a3372e6d05a775f662946712", "url": "https://github.com/MovingBlocks/Terasology/commit/6bdf1f19428e5f08a3372e6d05a775f662946712", "message": "feat(JOML): migrate world gen", "committedDate": "2020-12-13T20:57:06Z", "type": "commit"}, {"oid": "a5b50e30761721c8d471623a49592edfaee3bf57", "url": "https://github.com/MovingBlocks/Terasology/commit/a5b50e30761721c8d471623a49592edfaee3bf57", "message": "Merge branch 'develop' into feat/joml-world-gen", "committedDate": "2020-12-17T08:34:43Z", "type": "commit"}, {"oid": "a6198a4cc0a30d19dbdf81aa9bb91e892bcc82c1", "url": "https://github.com/MovingBlocks/Terasology/commit/a6198a4cc0a30d19dbdf81aa9bb91e892bcc82c1", "message": "Merge branch 'develop' into feat/joml-world-gen", "committedDate": "2020-12-25T11:56:43Z", "type": "commit"}, {"oid": "0d1b93d88367c84e11b460ec776699fec050d41a", "url": "https://github.com/MovingBlocks/Terasology/commit/0d1b93d88367c84e11b460ec776699fec050d41a", "message": "feat(BlockRegion): align with recent BlockRegion changes", "committedDate": "2020-12-25T12:10:03Z", "type": "commit"}, {"oid": "8ace6c5425207325f7158320dc5e66bedda2ad19", "url": "https://github.com/MovingBlocks/Terasology/commit/8ace6c5425207325f7158320dc5e66bedda2ad19", "message": "feat(tests): align with recent BlockRegion changes", "committedDate": "2020-12-25T14:39:37Z", "type": "commit"}, {"oid": "5869cb809580b1c808764fe45482a9676f14434b", "url": "https://github.com/MovingBlocks/Terasology/commit/5869cb809580b1c808764fe45482a9676f14434b", "message": "test: use JOML vectors in sparse facet tests", "committedDate": "2020-12-25T20:43:41Z", "type": "commit"}, {"oid": "53d33adf323df621215df73fa3d324e56e89bc10", "url": "https://github.com/MovingBlocks/Terasology/commit/53d33adf323df621215df73fa3d324e56e89bc10", "message": "feat: accept Vector3ic in SparseFieldFacet3D", "committedDate": "2020-12-25T20:51:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODkxMDg2OQ==", "url": "https://github.com/MovingBlocks/Terasology/pull/4322#discussion_r548910869", "bodyText": "Unused import?", "author": "skaldarnar", "createdAt": "2020-12-25T20:53:28Z", "path": "engine-tests/src/test/java/org/terasology/world/generation/facets/BaseBooleanFacetTest.java", "diffHunk": "@@ -17,6 +17,7 @@\n package org.terasology.world.generation.facets;\n \n import org.terasology.math.Region3i;", "originalCommit": "53d33adf323df621215df73fa3d324e56e89bc10", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODkxMTUyNA==", "url": "https://github.com/MovingBlocks/Terasology/pull/4322#discussion_r548911524", "bodyText": "We can avoid the vector allocation here:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    Vector3i extent = region.getRegion().getSize(new Vector3i());\n          \n          \n            \n                    int width = extent.x;\n          \n          \n            \n                    int height = extent.z;\n          \n          \n            \n                    int width =  region.getRegion().getSizeX();\n          \n          \n            \n                    int height =  region.getRegion().getSizeZ();", "author": "skaldarnar", "createdAt": "2020-12-25T21:03:00Z", "path": "engine/src/main/java/org/terasology/rendering/nui/layers/mainMenu/preview/FacetLayerPreview.java", "diffHunk": "@@ -201,7 +201,7 @@ private static Rect2i worldToTileArea(Rect2i area) {\n      */\n     private BufferedImage rasterize(Region region) {\n \n-        Vector3i extent = region.getRegion().size();\n+        Vector3i extent = region.getRegion().getSize(new Vector3i());\n         int width = extent.x;\n         int height = extent.z;", "originalCommit": "53d33adf323df621215df73fa3d324e56e89bc10", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f774c4d7cf8001ad3b6b89e74ceb36ddab6e67a5", "chunk": "diff --git a/engine/src/main/java/org/terasology/rendering/nui/layers/mainMenu/preview/FacetLayerPreview.java b/engine/src/main/java/org/terasology/rendering/nui/layers/mainMenu/preview/FacetLayerPreview.java\nindex cf8f5f613..11c89a3ca 100644\n--- a/engine/src/main/java/org/terasology/rendering/nui/layers/mainMenu/preview/FacetLayerPreview.java\n+++ b/engine/src/main/java/org/terasology/rendering/nui/layers/mainMenu/preview/FacetLayerPreview.java\n\n@@ -200,10 +200,8 @@ private static Rect2i worldToTileArea(Rect2i area) {\n      * @return an image of that region\n      */\n     private BufferedImage rasterize(Region region) {\n-\n-        Vector3i extent = region.getRegion().getSize(new Vector3i());\n-        int width = extent.x;\n-        int height = extent.z;\n+        int width =  region.getRegion().getSizeX();\n+        int height =  region.getRegion().getSizeZ();\n \n         WritableRaster raster = colorModel.createCompatibleWritableRaster(width, height);\n         BufferedImage image = new BufferedImage(colorModel, raster, false, null);\n"}}, {"oid": "f774c4d7cf8001ad3b6b89e74ceb36ddab6e67a5", "url": "https://github.com/MovingBlocks/Terasology/commit/f774c4d7cf8001ad3b6b89e74ceb36ddab6e67a5", "message": "perf: avoid vector allocation", "committedDate": "2020-12-25T21:03:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODkxMTYzNg==", "url": "https://github.com/MovingBlocks/Terasology/pull/4322#discussion_r548911636", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    float[] fullData = new float[fullRegion.getSizeX() * fullRegion.getSizeY() * fullRegion.getSizeZ()];\n          \n          \n            \n                    float[] fullData = new float[fullRegion.volume()];", "author": "skaldarnar", "createdAt": "2020-12-25T21:04:32Z", "path": "engine/src/main/java/org/terasology/utilities/procedural/SubSampledNoise.java", "diffHunk": "@@ -178,11 +177,11 @@ public float noise(float x, float y, float z) {\n         }\n     }\n \n-    private float[] mapExpand(float[] keyData, Region3i fullRegion) {\n-        float[] fullData = new float[fullRegion.sizeX() * fullRegion.sizeY() * fullRegion.sizeZ()];\n-        int samplesX = fullRegion.sizeX() / sampleRate + 1;\n-        int samplesY = fullRegion.sizeY() / sampleRate + 1;\n-        int samplesZ = fullRegion.sizeZ() / sampleRate + 1;\n+    private float[] mapExpand(float[] keyData, BlockRegion fullRegion) {\n+        float[] fullData = new float[fullRegion.getSizeX() * fullRegion.getSizeY() * fullRegion.getSizeZ()];", "originalCommit": "53d33adf323df621215df73fa3d324e56e89bc10", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "65edbf804b0072b7fc589f3db3dd8ca334405e8e", "chunk": "diff --git a/engine/src/main/java/org/terasology/utilities/procedural/SubSampledNoise.java b/engine/src/main/java/org/terasology/utilities/procedural/SubSampledNoise.java\nindex e3a7a8a0a..58d90ef67 100644\n--- a/engine/src/main/java/org/terasology/utilities/procedural/SubSampledNoise.java\n+++ b/engine/src/main/java/org/terasology/utilities/procedural/SubSampledNoise.java\n\n@@ -178,7 +178,7 @@ public float noise(float x, float y, float z) {\n     }\n \n     private float[] mapExpand(float[] keyData, BlockRegion fullRegion) {\n-        float[] fullData = new float[fullRegion.getSizeX() * fullRegion.getSizeY() * fullRegion.getSizeZ()];\n+        float[] fullData = new float[fullRegion.volume()];\n         int samplesX = fullRegion.getSizeX() / sampleRate + 1;\n         int samplesY = fullRegion.getSizeY() / sampleRate + 1;\n         int samplesZ = fullRegion.getSizeZ() / sampleRate + 1;\n"}}, {"oid": "65edbf804b0072b7fc589f3db3dd8ca334405e8e", "url": "https://github.com/MovingBlocks/Terasology/commit/65edbf804b0072b7fc589f3db3dd8ca334405e8e", "message": "refactor: use `.volume` instead of manual computation", "committedDate": "2020-12-25T21:05:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODkxMjAzMA==", "url": "https://github.com/MovingBlocks/Terasology/pull/4322#discussion_r548912030", "bodyText": "avoid vector creation here and use the individual chunk extents directly.", "author": "skaldarnar", "createdAt": "2020-12-25T21:08:56Z", "path": "engine/src/main/java/org/terasology/world/chunks/internal/ChunkImpl.java", "diffHunk": "@@ -102,8 +102,8 @@ public ChunkImpl(Vector3i chunkPos, TeraArray blocks, TeraArray[] extra, BlockMa\n         lightData = new TeraDenseArray8Bit(getChunkSizeX(), getChunkSizeY(), getChunkSizeZ());\n         dirty = true;\n         this.blockManager = blockManager;\n-        region = Region3i.createFromMinAndSize(new Vector3i(chunkPos.x * ChunkConstants.SIZE_X, chunkPos.y * ChunkConstants.SIZE_Y, chunkPos.z * ChunkConstants.SIZE_Z),\n-                ChunkConstants.CHUNK_SIZE);\n+        region = new BlockRegion(chunkPos.x * ChunkConstants.SIZE_X, chunkPos.y * ChunkConstants.SIZE_Y,\n+                chunkPos.z * ChunkConstants.SIZE_Z).setSize(JomlUtil.from(ChunkConstants.CHUNK_SIZE));", "originalCommit": "53d33adf323df621215df73fa3d324e56e89bc10", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "310330fee4db7661cb7f2ca4fe02b91fdac58c9e", "chunk": "diff --git a/engine/src/main/java/org/terasology/world/chunks/internal/ChunkImpl.java b/engine/src/main/java/org/terasology/world/chunks/internal/ChunkImpl.java\nindex 5e3fec343..8cb59a45f 100644\n--- a/engine/src/main/java/org/terasology/world/chunks/internal/ChunkImpl.java\n+++ b/engine/src/main/java/org/terasology/world/chunks/internal/ChunkImpl.java\n\n@@ -102,8 +101,11 @@ public ChunkImpl(Vector3i chunkPos, TeraArray blocks, TeraArray[] extra, BlockMa\n         lightData = new TeraDenseArray8Bit(getChunkSizeX(), getChunkSizeY(), getChunkSizeZ());\n         dirty = true;\n         this.blockManager = blockManager;\n-        region = new BlockRegion(chunkPos.x * ChunkConstants.SIZE_X, chunkPos.y * ChunkConstants.SIZE_Y,\n-                chunkPos.z * ChunkConstants.SIZE_Z).setSize(JomlUtil.from(ChunkConstants.CHUNK_SIZE));\n+        region = new BlockRegion(\n+                chunkPos.x * ChunkConstants.SIZE_X,\n+                chunkPos.y * ChunkConstants.SIZE_Y,\n+                chunkPos.z * ChunkConstants.SIZE_Z)\n+                .setSize(ChunkConstants.SIZE_X, ChunkConstants.SIZE_Y, ChunkConstants.SIZE_Z);\n         ChunkMonitor.fireChunkCreated(this);\n     }\n \n"}}, {"oid": "310330fee4db7661cb7f2ca4fe02b91fdac58c9e", "url": "https://github.com/MovingBlocks/Terasology/commit/310330fee4db7661cb7f2ca4fe02b91fdac58c9e", "message": "perf: avoid vector allocation", "committedDate": "2020-12-25T21:09:00Z", "type": "commit"}, {"oid": "c5567eddc6124548f19c53e98fe67cefff5c464f", "url": "https://github.com/MovingBlocks/Terasology/commit/c5567eddc6124548f19c53e98fe67cefff5c464f", "message": "chore: remove unnecessary qualified name", "committedDate": "2020-12-25T21:12:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODkxMjQxMQ==", "url": "https://github.com/MovingBlocks/Terasology/pull/4322#discussion_r548912411", "bodyText": "Use .volume directly.", "author": "skaldarnar", "createdAt": "2020-12-25T21:15:22Z", "path": "engine/src/main/java/org/terasology/world/generation/facets/base/BaseFieldFacet3D.java", "diffHunk": "@@ -26,9 +27,9 @@\n \n     private float[] data;\n \n-    public BaseFieldFacet3D(Region3i targetRegion, Border3D border) {\n+    public BaseFieldFacet3D(BlockRegion targetRegion, Border3D border) {\n         super(targetRegion, border);\n-        Vector3i size = getRelativeRegion().size();\n+        Vector3i size = getRelativeRegion().getSize(new Vector3i());", "originalCommit": "53d33adf323df621215df73fa3d324e56e89bc10", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "681db9a67781b87c25b56fcae30238a56e6e552d", "chunk": "diff --git a/engine/src/main/java/org/terasology/world/generation/facets/base/BaseFieldFacet3D.java b/engine/src/main/java/org/terasology/world/generation/facets/base/BaseFieldFacet3D.java\nindex 4923bf76e..476343434 100644\n--- a/engine/src/main/java/org/terasology/world/generation/facets/base/BaseFieldFacet3D.java\n+++ b/engine/src/main/java/org/terasology/world/generation/facets/base/BaseFieldFacet3D.java\n\n@@ -29,8 +29,7 @@\n \n     public BaseFieldFacet3D(BlockRegion targetRegion, Border3D border) {\n         super(targetRegion, border);\n-        Vector3i size = getRelativeRegion().getSize(new Vector3i());\n-        this.data = new float[size.x * size.y * size.z];\n+        this.data = new float[getRelativeRegion().volume()];\n     }\n \n     @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODkxMjU5MA==", "url": "https://github.com/MovingBlocks/Terasology/pull/4322#discussion_r548912590", "bodyText": "same here, avoid allocation and use volume directly", "author": "skaldarnar", "createdAt": "2020-12-25T21:17:07Z", "path": "engine/src/main/java/org/terasology/world/generation/facets/base/BaseObjectFacet3D.java", "diffHunk": "@@ -32,9 +31,9 @@\n public abstract class BaseObjectFacet3D<T> extends BaseFacet3D implements ObjectFacet3D<T> {\n     private T[] data;\n \n-    public BaseObjectFacet3D(Region3i targetRegion, Border3D border, Class<T> objectType) {\n+    public BaseObjectFacet3D(BlockRegion targetRegion, Border3D border, Class<T> objectType) {\n         super(targetRegion, border);\n-        Vector3i size = getRelativeRegion().size();\n+        Vector3i size = getRelativeRegion().getSize(new Vector3i());", "originalCommit": "53d33adf323df621215df73fa3d324e56e89bc10", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "681db9a67781b87c25b56fcae30238a56e6e552d", "chunk": "diff --git a/engine/src/main/java/org/terasology/world/generation/facets/base/BaseObjectFacet3D.java b/engine/src/main/java/org/terasology/world/generation/facets/base/BaseObjectFacet3D.java\nindex 3fc4ad1f9..35d2faec9 100644\n--- a/engine/src/main/java/org/terasology/world/generation/facets/base/BaseObjectFacet3D.java\n+++ b/engine/src/main/java/org/terasology/world/generation/facets/base/BaseObjectFacet3D.java\n\n@@ -33,8 +33,7 @@\n \n     public BaseObjectFacet3D(BlockRegion targetRegion, Border3D border, Class<T> objectType) {\n         super(targetRegion, border);\n-        Vector3i size = getRelativeRegion().getSize(new Vector3i());\n-        this.data = (T[]) Array.newInstance(objectType, size.x * size.y * size.z);\n+        this.data = (T[]) Array.newInstance(objectType, getRelativeRegion().volume());\n     }\n \n     @Override\n"}}, {"oid": "681db9a67781b87c25b56fcae30238a56e6e552d", "url": "https://github.com/MovingBlocks/Terasology/commit/681db9a67781b87c25b56fcae30238a56e6e552d", "message": "perf: avoid vector allocation", "committedDate": "2020-12-25T21:17:15Z", "type": "commit"}, {"oid": "8543cbb825d4ccde924a026c3b763e98003164dd", "url": "https://github.com/MovingBlocks/Terasology/commit/8543cbb825d4ccde924a026c3b763e98003164dd", "message": "chore: remove unnecessary qualified name", "committedDate": "2020-12-25T21:18:53Z", "type": "commit"}, {"oid": "0387e3b5c3598e2094ce33c4f717eb337efda033", "url": "https://github.com/MovingBlocks/Terasology/commit/0387e3b5c3598e2094ce33c4f717eb337efda033", "message": "Merge branch 'develop' into feat/joml-world-gen", "committedDate": "2020-12-26T10:01:46Z", "type": "commit"}]}