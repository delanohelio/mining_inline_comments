{"pr_number": 677, "pr_title": "Rework prepared queries", "pr_createdAt": "2020-06-05T16:38:09Z", "pr_url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/677", "timeline": [{"oid": "7d1fcdf892b2c9ea39e0f67c16eff69075fdf9a3", "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/7d1fcdf892b2c9ea39e0f67c16eff69075fdf9a3", "message": "Prepared query flow improvements", "committedDate": "2020-06-05T16:43:16Z", "type": "forcePushed"}, {"oid": "f3f30566e8f9daf9e2c1c8a1088d8e31bf5a68ac", "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/f3f30566e8f9daf9e2c1c8a1088d8e31bf5a68ac", "message": "Rework pipeline execution", "committedDate": "2020-06-15T15:11:09Z", "type": "forcePushed"}, {"oid": "612e3d20939a4fb3edbdf4d8a6972f9fe92a2031", "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/612e3d20939a4fb3edbdf4d8a6972f9fe92a2031", "message": "Rework pipeline execution", "committedDate": "2020-06-15T20:41:00Z", "type": "forcePushed"}, {"oid": "9b0c9d667e53c1fd6e4b9b70def6ae8f2daae70f", "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/9b0c9d667e53c1fd6e4b9b70def6ae8f2daae70f", "message": "prepared_statements_instances is not available for MySQL 5.6 or MariahDB", "committedDate": "2020-06-16T11:30:32Z", "type": "forcePushed"}, {"oid": "bcdc97957b0b7e8ce1b5a86f958721631ed1a46e", "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/bcdc97957b0b7e8ce1b5a86f958721631ed1a46e", "message": "prepared_statements_instances is not available for MySQL 5.6 or MariahDB", "committedDate": "2020-06-16T15:26:03Z", "type": "forcePushed"}, {"oid": "098da739be58ebd3804da1eb580c73eed5ab1765", "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/098da739be58ebd3804da1eb580c73eed5ab1765", "message": "prepared_statements_instances is not available for MySQL 5.6 or MariahDB", "committedDate": "2020-06-18T10:06:10Z", "type": "forcePushed"}, {"oid": "b55f6905981699f05b6451cd6886edb0a3fb7dff", "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/b55f6905981699f05b6451cd6886edb0a3fb7dff", "message": "prepared_statements_instances is not available for MySQL 5.6 or MariahDB", "committedDate": "2020-06-18T10:20:15Z", "type": "forcePushed"}, {"oid": "82e8b405f71816974754f08307aac9455c310ada", "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/82e8b405f71816974754f08307aac9455c310ada", "message": "Rework pipeline", "committedDate": "2020-06-18T12:41:17Z", "type": "commit"}, {"oid": "e9cf4eab140b3e5e84bf557ea7008a1aa37adce3", "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/e9cf4eab140b3e5e84bf557ea7008a1aa37adce3", "message": "Fix incorrect pipelined inflight count", "committedDate": "2020-06-18T12:41:17Z", "type": "commit"}, {"oid": "2d462e1a3293d725c133bcd98144a8516d636bf6", "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/2d462e1a3293d725c133bcd98144a8516d636bf6", "message": "Rework prepared statement cache and management", "committedDate": "2020-06-18T12:41:17Z", "type": "commit"}, {"oid": "8721e2b51ccacdc4e97f6f7bc0787b30185e71ac", "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/8721e2b51ccacdc4e97f6f7bc0787b30185e71ac", "message": "Add more testing for postgres ephemeral prepared statements", "committedDate": "2020-06-18T12:41:17Z", "type": "commit"}, {"oid": "def5c2366a06520582d4a48bc2e20a6bfb4e5064", "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/def5c2366a06520582d4a48bc2e20a6bfb4e5064", "message": "Close MySQL prepared statement after usage", "committedDate": "2020-06-18T12:41:17Z", "type": "commit"}, {"oid": "1141abe76d18682d8899407baa6fc87c04491b5e", "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/1141abe76d18682d8899407baa6fc87c04491b5e", "message": "prepared_statements_instances is not available for MySQL 5.6 or MariahDB", "committedDate": "2020-06-18T12:41:17Z", "type": "commit"}, {"oid": "1141abe76d18682d8899407baa6fc87c04491b5e", "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/1141abe76d18682d8899407baa6fc87c04491b5e", "message": "prepared_statements_instances is not available for MySQL 5.6 or MariahDB", "committedDate": "2020-06-18T12:41:17Z", "type": "forcePushed"}, {"oid": "0e27d8f62a2d5a05ae33c38e24b0d5003f78fd96", "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/0e27d8f62a2d5a05ae33c38e24b0d5003f78fd96", "message": "make MySQL auto close statement for batching and minor docs\n\nSigned-off-by: Billy Yuan <billy112487983@gmail.com>", "committedDate": "2020-06-18T14:52:06Z", "type": "commit"}, {"oid": "6c47f68d01b8f1a4141aa29fbe8db8a97c0c5c66", "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/6c47f68d01b8f1a4141aa29fbe8db8a97c0c5c66", "message": "optimize the MySQL auto-closing logic\n\nSigned-off-by: Billy Yuan <billy112487983@gmail.com>", "committedDate": "2020-06-18T14:56:19Z", "type": "commit"}, {"oid": "18135537a63d700334c1808265b5686dfe9421e7", "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/18135537a63d700334c1808265b5686dfe9421e7", "message": "enable the table schema change test for Postgres and make it work\n\nSigned-off-by: Billy Yuan <billy112487983@gmail.com>", "committedDate": "2020-06-18T15:19:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjMyMzI3OQ==", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/677#discussion_r442323279", "bodyText": "we should use this option in the cache to make it work like before", "author": "BillyYccc", "createdAt": "2020-06-18T15:43:01Z", "path": "vertx-sql-client/src/main/java/io/vertx/sqlclient/impl/SocketConnectionBase.java", "diffHunk": "@@ -70,7 +72,8 @@ public SocketConnectionBase(NetSocketInternal socket,\n     this.socket = socket;\n     this.context = context;\n     this.pipeliningLimit = pipeliningLimit;\n-    this.psCache = cachePreparedStatements ? new PreparedStatementCache(this, preparedStatementCacheSize) : null;\n+    this.paused = false;\n+    this.psCache = cachePreparedStatements ? new PreparedStatementCache(preparedStatementCacheSize) : null;\n     this.preparedStatementCacheSqlLimit = preparedStatementCacheSqlLimit;", "originalCommit": "18135537a63d700334c1808265b5686dfe9421e7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjMyNDY4MQ==", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/677#discussion_r442324681", "bodyText": "I mean preparedStatementCacheSqlLimit here", "author": "BillyYccc", "createdAt": "2020-06-18T15:44:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjMyMzI3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjY1OTcyMg==", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/677#discussion_r442659722", "bodyText": "why is this feature useful ? can we just instead remove it ?", "author": "vietj", "createdAt": "2020-06-19T06:43:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjMyMzI3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjczMDYyNg==", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/677#discussion_r442730626", "bodyText": "I added a generic filter for this, see the latest commit", "author": "vietj", "createdAt": "2020-06-19T09:24:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjMyMzI3OQ=="}], "type": "inlineReview", "revised_code": {"commit": "8c90d18a1383c93545a1b7e6f69f526d4da4dc42", "chunk": "diff --git a/vertx-sql-client/src/main/java/io/vertx/sqlclient/impl/SocketConnectionBase.java b/vertx-sql-client/src/main/java/io/vertx/sqlclient/impl/SocketConnectionBase.java\nindex d18aadc6..10c68603 100644\n--- a/vertx-sql-client/src/main/java/io/vertx/sqlclient/impl/SocketConnectionBase.java\n+++ b/vertx-sql-client/src/main/java/io/vertx/sqlclient/impl/SocketConnectionBase.java\n\n@@ -66,7 +67,7 @@ public abstract class SocketConnectionBase implements Connection {\n   public SocketConnectionBase(NetSocketInternal socket,\n                               boolean cachePreparedStatements,\n                               int preparedStatementCacheSize,\n-                              int preparedStatementCacheSqlLimit,\n+                              Predicate<String> preparedStatementCacheSqlFilter,\n                               int pipeliningLimit,\n                               ContextInternal context) {\n     this.socket = socket;\n"}}, {"oid": "8c90d18a1383c93545a1b7e6f69f526d4da4dc42", "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/8c90d18a1383c93545a1b7e6f69f526d4da4dc42", "message": "Rework prepared statement cache filtering", "committedDate": "2020-06-19T09:46:58Z", "type": "commit"}, {"oid": "87b490ffe1ddfa7169d00687d910ce257bfe101a", "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/87b490ffe1ddfa7169d00687d910ce257bfe101a", "message": "Enable sql cache filter for MSSQL", "committedDate": "2020-06-19T09:46:58Z", "type": "commit"}, {"oid": "87b490ffe1ddfa7169d00687d910ce257bfe101a", "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/87b490ffe1ddfa7169d00687d910ce257bfe101a", "message": "Enable sql cache filter for MSSQL", "committedDate": "2020-06-19T09:46:58Z", "type": "forcePushed"}]}