{"pr_number": 580, "pr_title": "Add handling for ACCSEC error path", "pr_createdAt": "2020-04-10T15:28:40Z", "pr_url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/580", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjkwNDIyMA==", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/580#discussion_r406904220", "bodyText": "Are we guaranteed a non-null value for netSqlca before we call any methods?  I see in parseSQLCAGRP there is the possibility of a null value being returned.  Or is it ok if we throw a NPE at this point?", "author": "gjwatts", "createdAt": "2020-04-10T19:19:09Z", "path": "vertx-db2-client/src/main/java/io/vertx/db2client/impl/drda/DRDAConnectResponse.java", "diffHunk": "@@ -1154,6 +1154,191 @@ private void parseACCSECreply(int securityMechanism) {\n //        }\n     }\n     \n+    private void parseAccessSecurityError() {\n+        int peekCP = peekCodePoint();\n+        switch (peekCP) {\n+        case CodePoint.CMDCHKRM:\n+            parseCMDCHKRM();\n+            break;\n+        case CodePoint.RDBNFNRM:\n+            parseRDBNFNRM();\n+            break;\n+        case CodePoint.RDBAFLRM:\n+            parseRdbAccessFailed();\n+            break;\n+        default:\n+            parseCommonError(peekCP);\n+        }\n+    }\n+    \n+    // RDB Not Found Reply Message indicates that the target\n+    // server cannot find the specified relational database.\n+    // PROTOCOL architects an SQLSTATE of 08004.\n+    //\n+    // Messages\n+    // SQLSTATE : 8004\n+    //     The application server rejected establishment of the connection.\n+    //     SQLCODE : -30061\n+    //     The database alias or database name <name> was not found at the remote node.\n+    //     The statement cannot be processed.\n+    //\n+    //\n+    // Returned from Server:\n+    // SVRCOD - required  (8 - ERROR)\n+    // RDBNAM - required\n+    private void parseRDBNFNRM() {\n+        boolean svrcodReceived = false;\n+        int svrcod = CodePoint.SVRCOD_INFO;\n+        boolean rdbnamReceived = false;\n+        String rdbnam = null;\n+\n+        parseLengthAndMatchCodePoint(CodePoint.RDBNFNRM);\n+        pushLengthOnCollectionStack();\n+        int peekCP = peekCodePoint();\n+\n+        while (peekCP != END_OF_COLLECTION) {\n+\n+            boolean foundInPass = false;\n+\n+            if (peekCP == CodePoint.SVRCOD) {\n+                foundInPass = true;\n+                svrcodReceived = checkAndGetReceivedFlag(svrcodReceived);\n+                svrcod = parseSVRCOD(CodePoint.SVRCOD_ERROR, CodePoint.SVRCOD_ERROR);\n+                peekCP = peekCodePoint();\n+            }\n+\n+            if (peekCP == CodePoint.RDBNAM) {\n+                foundInPass = true;\n+                rdbnamReceived = checkAndGetReceivedFlag(rdbnamReceived);\n+                rdbnam = parseRDBNAM(true);\n+                peekCP = peekCodePoint();\n+            }\n+            \n+            if (peekCP == CodePoint.SRVDGN) {\n+            \tfoundInPass = true;\n+            \tString serverDiagnostics = parseSRVDGN();\n+            \t// TODO: @AGG Log the server diagnostics here\n+            \tpeekCP = peekCodePoint();\n+            }\n+\n+            if (!foundInPass) {\n+            \tthrowUnknownCodepoint(peekCP);\n+            }\n+\n+        }\n+        popCollectionStack();\n+        if (!svrcodReceived)\n+        \tthrowMissingRequiredCodepoint(\"SVRCOD\", CodePoint.SVRCOD);\n+        if (!rdbnamReceived)\n+        \tthrowMissingRequiredCodepoint(\"RDBNAM\", CodePoint.RDBNAM);\n+\n+//        netAgent_.setSvrcod(svrcod);\n+        throw new DB2Exception(\"The requested database was not found: \" + metadata.databaseName,\n+        \t\tSqlCode.RDB_NOT_FOUND, SQLState.NET_DATABASE_NOT_FOUND);\n+//        agent_.accumulateChainBreakingReadExceptionAndThrow(new DisconnectException(agent_,\n+//            new ClientMessageId(SQLState.NET_DATABASE_NOT_FOUND),\n+//            netConnection.databaseName_));\n+    }\n+    \n+    private void parseRdbAccessFailed() {\n+        parseRDBAFLRM();\n+\n+        // an SQLCARD is returned if an RDBALFRM is returned.\n+        // this SQLCARD always follows the RDBALFRM.\n+        // TYPDEFNAM and TYPDEFOVR are MTLINC\n+\n+        if (peekCodePoint() == CodePoint.TYPDEFNAM) {\n+            parseTYPDEFNAM();\n+            parseTYPDEFOVR();\n+        } else {\n+            parseTYPDEFOVR();\n+            parseTYPDEFNAM();\n+        }\n+\n+        NetSqlca netSqlca = parseSQLCARD(null);\n+        \n+        //Check if the SQLCARD has null SQLException\n+        if(netSqlca.getSqlErrmc() == null) {", "originalCommit": "c887ad48d8014a9e4595cd9ff9f1591fefc39ebf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjkyMDUzNw==", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/580#discussion_r406920537", "bodyText": "A non-null SQLCARD should always be returned if a normal DB error occurs (which excludes situations where the DB just closes the connection). On this code path we're still under \"normal\" error path situations since we only get to this point if we have previously found and matched a RDBAFLRM message which must be followed by a SQLCARD", "author": "aguibert", "createdAt": "2020-04-10T20:05:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjkwNDIyMA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjkwNzA2NA==", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/580#discussion_r406907064", "bodyText": "Please add a copyright header.", "author": "gjwatts", "createdAt": "2020-04-10T19:27:06Z", "path": "vertx-db2-client/src/test/java/io/vertx/db2client/tck/DB2ConnectionTest.java", "diffHunk": "@@ -1,10 +1,14 @@\n package io.vertx.db2client.tck;\n \n import io.vertx.sqlclient.tck.ConnectionTestBase;\n+import io.vertx.db2client.DB2Exception;", "originalCommit": "c887ad48d8014a9e4595cd9ff9f1591fefc39ebf", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f12cf6e4c30ee274c47f5e1346291feb661745e3", "chunk": "diff --git a/vertx-db2-client/src/test/java/io/vertx/db2client/tck/DB2ConnectionTest.java b/vertx-db2-client/src/test/java/io/vertx/db2client/tck/DB2ConnectionTest.java\nindex c5987b94..64d41f20 100644\n--- a/vertx-db2-client/src/test/java/io/vertx/db2client/tck/DB2ConnectionTest.java\n+++ b/vertx-db2-client/src/test/java/io/vertx/db2client/tck/DB2ConnectionTest.java\n\n@@ -1,3 +1,18 @@\n+/*\n+ * Copyright (C) 2019,2020 IBM Corporation\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n package io.vertx.db2client.tck;\n \n import io.vertx.sqlclient.tck.ConnectionTestBase;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjkxNTMzMA==", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/580#discussion_r406915330", "bodyText": "So here it sounds like we are able to hit the DB2 server, but it closes the connection because of an invalid DB name.  In the comments section of SQLState.java (around line 1737) they make a note that the 08001 errors are for when the client is unable to establish a connection with the server.  Here it seems we are able to connect to the server and they are rejecting the request because of the invalid DB name.  So my suggestion would be to use SQLState.NET_DATABASE_NOT_FOUND instead (which sends back value of \"08004*\")", "author": "gjwatts", "createdAt": "2020-04-10T19:50:40Z", "path": "vertx-db2-client/src/main/java/io/vertx/db2client/impl/codec/InitialHandshakeCommandCodec.java", "diffHunk": "@@ -54,7 +56,8 @@ void encode(DB2Encoder encoder) {\n             //Sometimes DB2 closes the connection when sending an invalid Database name.\n             //-4499 = A fatal error occurred that resulted in a disconnect from the data source.\n             //08001 = \"The connection was unable to be established\"\n-            cmd.fail(new DB2Exception(\"Socket closed during connection\", -4499,\"08001\"));           \n+            cmd.fail(new DB2Exception(\"The connection was closed by the database server.\", \n+            \t\tSqlCode.CONNECTION_REFUSED, SQLState.CONNECT_UNABLE_TO_CONNECT_TO_SERVER));           ", "originalCommit": "c887ad48d8014a9e4595cd9ff9f1591fefc39ebf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjkxODY0Mg==", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/580#discussion_r406918642", "bodyText": "Sounds reasonable, I cross checked with JDBC and they return an 08004 too I think that's the right call. I'll use SQLState.AUTH_DATABASE_CONNECTION_REFUSED which is 08004.C.3 (I'd like to keep it a bit more generic than NET_DATABASE_NOT_FOUND  because we don't know for sure at this point that the connection was refused because the DB was not found)", "author": "aguibert", "createdAt": "2020-04-10T19:59:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjkxNTMzMA=="}], "type": "inlineReview", "revised_code": {"commit": "f12cf6e4c30ee274c47f5e1346291feb661745e3", "chunk": "diff --git a/vertx-db2-client/src/main/java/io/vertx/db2client/impl/codec/InitialHandshakeCommandCodec.java b/vertx-db2-client/src/main/java/io/vertx/db2client/impl/codec/InitialHandshakeCommandCodec.java\nindex cb01658d..6366b980 100644\n--- a/vertx-db2-client/src/main/java/io/vertx/db2client/impl/codec/InitialHandshakeCommandCodec.java\n+++ b/vertx-db2-client/src/main/java/io/vertx/db2client/impl/codec/InitialHandshakeCommandCodec.java\n\n@@ -57,7 +57,7 @@ class InitialHandshakeCommandCodec extends AuthenticationCommandBaseCodec<Connec\n             //-4499 = A fatal error occurred that resulted in a disconnect from the data source.\n             //08001 = \"The connection was unable to be established\"\n             cmd.fail(new DB2Exception(\"The connection was closed by the database server.\", \n-            \t\tSqlCode.CONNECTION_REFUSED, SQLState.CONNECT_UNABLE_TO_CONNECT_TO_SERVER));           \n+            \t\tSqlCode.CONNECTION_REFUSED, SQLState.AUTH_DATABASE_CONNECTION_REFUSED));           \n           }\n         });\n         sendInitialHandshake();\n"}}, {"oid": "f12cf6e4c30ee274c47f5e1346291feb661745e3", "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/f12cf6e4c30ee274c47f5e1346291feb661745e3", "message": "Add handling for ACCSEC error path", "committedDate": "2020-04-10T20:07:30Z", "type": "commit"}, {"oid": "f12cf6e4c30ee274c47f5e1346291feb661745e3", "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/f12cf6e4c30ee274c47f5e1346291feb661745e3", "message": "Add handling for ACCSEC error path", "committedDate": "2020-04-10T20:07:30Z", "type": "forcePushed"}]}