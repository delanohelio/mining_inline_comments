{"pr_number": 7862, "pr_title": "SAK-43196 msgcntr: Deprecated utils.FormattedText, Validator => api.F\u2026", "pr_createdAt": "2020-02-08T10:54:19Z", "pr_url": "https://github.com/sakaiproject/sakai/pull/7862", "timeline": [{"oid": "a8f53dfc29fcd5429fe4a48ca54c6c31178db258", "url": "https://github.com/sakaiproject/sakai/commit/a8f53dfc29fcd5429fe4a48ca54c6c31178db258", "message": "SAK-43196 msgcntr: Deprecated utils.FormattedText, Validator => api.FormattedText", "committedDate": "2020-02-08T10:52:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzU2MjgzOA==", "url": "https://github.com/sakaiproject/sakai/pull/7862#discussion_r377562838", "bodyText": "I'd leave this where it was. It just introduces noise to this change when merging back. It's a small thing, I know :)", "author": "adrianfish", "createdAt": "2020-02-11T10:54:20Z", "path": "msgcntr/messageforums-app/src/java/org/sakaiproject/tool/messageforums/ForumsEmailService.java", "diffHunk": "@@ -30,17 +30,15 @@\n import java.util.Iterator;\n import java.util.List;\n \n-import lombok.extern.slf4j.Slf4j;\n-\n import org.sakaiproject.api.app.messageforums.AnonymousManager;\n import org.sakaiproject.api.app.messageforums.Attachment;\n import org.sakaiproject.api.app.messageforums.BaseForum;\n import org.sakaiproject.api.app.messageforums.Message;\n import org.sakaiproject.api.app.messageforums.Topic;\n import org.sakaiproject.component.cover.ComponentManager;\n import org.sakaiproject.component.cover.ServerConfigurationService;\n-import org.sakaiproject.content.api.ContentResource;\n import org.sakaiproject.content.api.ContentHostingService;\n+import org.sakaiproject.content.api.ContentResource;", "originalCommit": "a8f53dfc29fcd5429fe4a48ca54c6c31178db258", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzU5ODczNQ==", "url": "https://github.com/sakaiproject/sakai/pull/7862#discussion_r377598735", "bodyText": "OK", "author": "axxter99", "createdAt": "2020-02-11T12:16:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzU2MjgzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzYxNDQyNw==", "url": "https://github.com/sakaiproject/sakai/pull/7862#discussion_r377614427", "bodyText": "OK", "author": "axxter99", "createdAt": "2020-02-11T12:51:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzU2MjgzOA=="}], "type": "inlineReview", "revised_code": {"commit": "24667903c365b4eba0bea57a14351a017db43366", "chunk": "diff --git a/msgcntr/messageforums-app/src/java/org/sakaiproject/tool/messageforums/ForumsEmailService.java b/msgcntr/messageforums-app/src/java/org/sakaiproject/tool/messageforums/ForumsEmailService.java\nindex 99558e0871..7c3bce1500 100644\n--- a/msgcntr/messageforums-app/src/java/org/sakaiproject/tool/messageforums/ForumsEmailService.java\n+++ b/msgcntr/messageforums-app/src/java/org/sakaiproject/tool/messageforums/ForumsEmailService.java\n\n@@ -37,8 +37,8 @@ import org.sakaiproject.api.app.messageforums.Message;\n import org.sakaiproject.api.app.messageforums.Topic;\n import org.sakaiproject.component.cover.ComponentManager;\n import org.sakaiproject.component.cover.ServerConfigurationService;\n-import org.sakaiproject.content.api.ContentHostingService;\n import org.sakaiproject.content.api.ContentResource;\n+import org.sakaiproject.content.api.ContentHostingService;\n import org.sakaiproject.email.api.AddressValidationException;\n import org.sakaiproject.email.api.EmailAddress;\n import org.sakaiproject.email.api.EmailAddress.RecipientType;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzU2MzYwNw==", "url": "https://github.com/sakaiproject/sakai/pull/7862#discussion_r377563607", "bodyText": "Are you using the slf4j annotation anywhere?", "author": "adrianfish", "createdAt": "2020-02-11T10:55:58Z", "path": "msgcntr/messageforums-app/src/java/org/sakaiproject/tool/messageforums/ForumsEmailService.java", "diffHunk": "@@ -56,8 +54,10 @@\n import org.sakaiproject.time.api.UserTimeService;\n import org.sakaiproject.tool.api.ToolManager;\n import org.sakaiproject.tool.messageforums.ui.DiscussionMessageBean;\n-import org.sakaiproject.util.FormattedText;\n import org.sakaiproject.util.ResourceLoader;\n+import org.sakaiproject.util.api.FormattedText;\n+\n+import lombok.extern.slf4j.Slf4j;", "originalCommit": "a8f53dfc29fcd5429fe4a48ca54c6c31178db258", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzU5NzcyNw==", "url": "https://github.com/sakaiproject/sakai/pull/7862#discussion_r377597727", "bodyText": "@slf4j:  ForumsEmailService log. : 18 matches", "author": "axxter99", "createdAt": "2020-02-11T12:13:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzU2MzYwNw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzU2NjQzMA==", "url": "https://github.com/sakaiproject/sakai/pull/7862#discussion_r377566430", "bodyText": "I'm not sure this is right. Validator.escapeJavascript is marked as deprecated, but the doc says to use StringEscapeUtils (Apache) instead. FormattedText doesn't use StringEscapeUtils. I'd either leave Validator here, or move FormattedText to use Apache (with the testing that'll need).", "author": "adrianfish", "createdAt": "2020-02-11T11:02:02Z", "path": "msgcntr/messageforums-app/src/java/org/sakaiproject/tool/messageforums/PrivateMessagesTool.java", "diffHunk": "@@ -4159,7 +4161,7 @@ public String getAuthorString()\n     \n     public String getPlacementId() \n     {\n-       return Validator.escapeJavascript(\"Main\" + toolManager.getCurrentPlacement().getId());\n+       return formattedText.escapeJavascript(\"Main\" + toolManager.getCurrentPlacement().getId());", "originalCommit": "a8f53dfc29fcd5429fe4a48ca54c6c31178db258", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzYxNDI4MQ==", "url": "https://github.com/sakaiproject/sakai/pull/7862#discussion_r377614281", "bodyText": "commons-text: StringEscapeUtils.escapeEcmaScript(String)?", "author": "axxter99", "createdAt": "2020-02-11T12:51:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzU2NjQzMA=="}], "type": "inlineReview", "revised_code": {"commit": "24667903c365b4eba0bea57a14351a017db43366", "chunk": "diff --git a/msgcntr/messageforums-app/src/java/org/sakaiproject/tool/messageforums/PrivateMessagesTool.java b/msgcntr/messageforums-app/src/java/org/sakaiproject/tool/messageforums/PrivateMessagesTool.java\nindex 558d09e9d3..029a3002c2 100644\n--- a/msgcntr/messageforums-app/src/java/org/sakaiproject/tool/messageforums/PrivateMessagesTool.java\n+++ b/msgcntr/messageforums-app/src/java/org/sakaiproject/tool/messageforums/PrivateMessagesTool.java\n\n@@ -4161,7 +4162,7 @@ public void processChangeSelectView(ValueChangeEvent eve)\n     \n     public String getPlacementId() \n     {\n-       return formattedText.escapeJavascript(\"Main\" + toolManager.getCurrentPlacement().getId());\n+       return StringEscapeUtils.escapeEcmaScript(\"Main\" + toolManager.getCurrentPlacement().getId());\n     }\n \n     public boolean isSearchPvtMsgsEmpty()\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzU2NzQ2MQ==", "url": "https://github.com/sakaiproject/sakai/pull/7862#discussion_r377567461", "bodyText": "Again, I'd leave this as Validator. FormattedText should be using URLEncoder, as per the doc in Validator.java.", "author": "adrianfish", "createdAt": "2020-02-11T11:04:14Z", "path": "msgcntr/messageforums-component-impl/src/java/org/sakaiproject/component/app/messageforums/RankManagerImpl.java", "diffHunk": "@@ -362,7 +364,7 @@ private String resourceUrlEscaping(String url) {\n         String leftOfAttachment = url.substring(0, attIndex);\n         String rightOfAttachment = url.substring(attIndex);\n \n-        String finalUrl = leftOfAttachment.concat(Validator.escapeUrl(rightOfAttachment));\n+        String finalUrl = leftOfAttachment.concat(formattedText.escapeUrl(rightOfAttachment));", "originalCommit": "a8f53dfc29fcd5429fe4a48ca54c6c31178db258", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzYwOTA3Mg==", "url": "https://github.com/sakaiproject/sakai/pull/7862#discussion_r377609072", "bodyText": "OK", "author": "axxter99", "createdAt": "2020-02-11T12:39:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzU2NzQ2MQ=="}], "type": "inlineReview", "revised_code": {"commit": "24667903c365b4eba0bea57a14351a017db43366", "chunk": "diff --git a/msgcntr/messageforums-component-impl/src/java/org/sakaiproject/component/app/messageforums/RankManagerImpl.java b/msgcntr/messageforums-component-impl/src/java/org/sakaiproject/component/app/messageforums/RankManagerImpl.java\nindex 6d167c2bdd..1304fa9652 100644\n--- a/msgcntr/messageforums-component-impl/src/java/org/sakaiproject/component/app/messageforums/RankManagerImpl.java\n+++ b/msgcntr/messageforums-component-impl/src/java/org/sakaiproject/component/app/messageforums/RankManagerImpl.java\n\n@@ -363,8 +364,7 @@ public class RankManagerImpl extends HibernateDaoSupport implements RankManager\n         int attIndex = url.indexOf(\"attachment\");\n         String leftOfAttachment = url.substring(0, attIndex);\n         String rightOfAttachment = url.substring(attIndex);\n-\n-        String finalUrl = leftOfAttachment.concat(formattedText.escapeUrl(rightOfAttachment));\n+        String finalUrl = leftOfAttachment.concat(URLEncoder.encode(rightOfAttachment));\n         return finalUrl;\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzU2ODU3Mw==", "url": "https://github.com/sakaiproject/sakai/pull/7862#discussion_r377568573", "bodyText": "Why not go the whole hog and remove the setters for those other private vars in there? Just move @Setter to the class definition and strip those setters out. You may as well.", "author": "adrianfish", "createdAt": "2020-02-11T11:06:37Z", "path": "msgcntr/messageforums-component-impl/src/java/org/sakaiproject/component/app/messageforums/entity/MessageForumsEntityContentProducer.java", "diffHunk": "@@ -54,6 +56,8 @@\n \t// runtime dependency\n \tprivate List removeEvents = null;\n \t\n+\t@Setter private FormattedText formattedText;", "originalCommit": "a8f53dfc29fcd5429fe4a48ca54c6c31178db258", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzYyOTQ4NA==", "url": "https://github.com/sakaiproject/sakai/pull/7862#discussion_r377629484", "bodyText": "OK", "author": "axxter99", "createdAt": "2020-02-11T13:22:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzU2ODU3Mw=="}], "type": "inlineReview", "revised_code": {"commit": "24667903c365b4eba0bea57a14351a017db43366", "chunk": "diff --git a/msgcntr/messageforums-component-impl/src/java/org/sakaiproject/component/app/messageforums/entity/MessageForumsEntityContentProducer.java b/msgcntr/messageforums-component-impl/src/java/org/sakaiproject/component/app/messageforums/entity/MessageForumsEntityContentProducer.java\nindex 363266e3b9..3a444eadfa 100644\n--- a/msgcntr/messageforums-component-impl/src/java/org/sakaiproject/component/app/messageforums/entity/MessageForumsEntityContentProducer.java\n+++ b/msgcntr/messageforums-component-impl/src/java/org/sakaiproject/component/app/messageforums/entity/MessageForumsEntityContentProducer.java\n\n@@ -57,6 +57,19 @@ public class MessageForumsEntityContentProducer implements\n \tprivate List removeEvents = null;\n \t\n \t@Setter private FormattedText formattedText;\n+\t@Setter private DeveloperHelperService developerHelperService;\n+\t@Setter private ServerConfigurationService serverConfigurationService;\n+\t@Setter private SearchService searchService;\n+\t@Setter private EntityBroker entityBroker;\n+\t@Setter private String toolName = null;\n+\t@Setter private SearchIndexBuilder searchIndexBuilder = null;\n+\t/**\n+\t * Forums Services\n+\t */\n+\t@Setter private MessageForumsMessageManager messageForumsMessageManager;\n+\t@Setter private DiscussionForumManager discussionForumManager;\n+\t@Setter private UIPermissionsManager uIPermissionManager; \n+\t\n \t\n \t/**\n \t * @param addEvents\n"}}, {"oid": "24667903c365b4eba0bea57a14351a017db43366", "url": "https://github.com/sakaiproject/sakai/commit/24667903c365b4eba0bea57a14351a017db43366", "message": "SAK-43196 msgcntr", "committedDate": "2020-02-11T13:35:01Z", "type": "commit"}]}