{"pr_number": 8327, "pr_title": "SAK-43878 better handling when authzgroup does not exist", "pr_createdAt": "2020-07-01T19:27:17Z", "pr_url": "https://github.com/sakaiproject/sakai/pull/8327", "timeline": [{"oid": "049027bfbccdf4c72a5e4a8198ce40696aa3b1ef", "url": "https://github.com/sakaiproject/sakai/commit/049027bfbccdf4c72a5e4a8198ce40696aa3b1ef", "message": "SAK-43878 better handling when authzgroup does not exist", "committedDate": "2020-07-01T19:26:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYwMjQ1NA==", "url": "https://github.com/sakaiproject/sakai/pull/8327#discussion_r448602454", "bodyText": "Are we sure you want to see these as warnings in the log? how about debug?", "author": "ern", "createdAt": "2020-07-01T20:35:51Z", "path": "sitestats/sitestats-tool/src/java/org/sakaiproject/sitestats/tool/wicket/pages/ReportsEditPage.java", "diffHunk": "@@ -1127,19 +1127,18 @@ public IModel getModel(Object value) {\n \t\t\tLocator.getFacade().getSiteService().getSiteTypes().stream().map(s -> \"!site.template.\" + s).forEach(siteIdWithRoles::add);\n \t\t}\n \n-\t\tList<String> roles = new ArrayList<String>();\n-\t\ttry {\n-\t\t\tfor (String s : siteIdWithRoles) {\n+\t\tSet<String> roles = new HashSet<String>();\n+\t\tfor (String s : siteIdWithRoles) {\n+\t\t\ttry {\n \t\t\t\tSet<Role> roleSet = Locator.getFacade().getAuthzGroupService().getAuthzGroup(s).getRoles();\n \t\t\t\tfor (Role r : roleSet) {\n \t\t\t\t\troles.add(r.getId());\n \t\t\t\t}\n+\t\t\t} catch (GroupNotDefinedException e) {\n+\t\t\t\tlog.warn(\"AuthzGroup does not exist, skipping: {}\", s);", "originalCommit": "049027bfbccdf4c72a5e4a8198ce40696aa3b1ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYxNDUzMw==", "url": "https://github.com/sakaiproject/sakai/pull/8327#discussion_r448614533", "bodyText": "agree", "author": "ottenhoff", "createdAt": "2020-07-01T21:02:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYwMjQ1NA=="}], "type": "inlineReview", "revised_code": {"commit": "93ed5cb2cc4823cbb11f2fb590b85d786b811774", "chunk": "diff --git a/sitestats/sitestats-tool/src/java/org/sakaiproject/sitestats/tool/wicket/pages/ReportsEditPage.java b/sitestats/sitestats-tool/src/java/org/sakaiproject/sitestats/tool/wicket/pages/ReportsEditPage.java\nindex 655ac57e72..8f70881f10 100644\n--- a/sitestats/sitestats-tool/src/java/org/sakaiproject/sitestats/tool/wicket/pages/ReportsEditPage.java\n+++ b/sitestats/sitestats-tool/src/java/org/sakaiproject/sitestats/tool/wicket/pages/ReportsEditPage.java\n\n@@ -1130,12 +1130,9 @@ public class ReportsEditPage extends BasePage {\n \t\tSet<String> roles = new HashSet<String>();\n \t\tfor (String s : siteIdWithRoles) {\n \t\t\ttry {\n-\t\t\t\tSet<Role> roleSet = Locator.getFacade().getAuthzGroupService().getAuthzGroup(s).getRoles();\n-\t\t\t\tfor (Role r : roleSet) {\n-\t\t\t\t\troles.add(r.getId());\n-\t\t\t\t}\n+\t\t\t\tSet<Role> roleSet = Locator.getFacade().getAuthzGroupService().getAuthzGroup(s).getRoles().forEach(r -> roles.add(r.getId()));\n \t\t\t} catch (GroupNotDefinedException e) {\n-\t\t\t\tlog.warn(\"AuthzGroup does not exist, skipping: {}\", s);\n+\t\t\t\tlog.debug(\"AuthzGroup does not exist, skipping: {}\", s);\n \t\t\t}\n \t\t}\n \t\treturn new ArrayList<String>(roles);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYwNzM5OA==", "url": "https://github.com/sakaiproject/sakai/pull/8327#discussion_r448607398", "bodyText": "Reduce to one line:\nLocator.getFacade().getAuthzGroupService().getAuthzGroup(s).getRoles().forEach(r -> roles.add(r.getId()));", "author": "ern", "createdAt": "2020-07-01T20:46:30Z", "path": "sitestats/sitestats-tool/src/java/org/sakaiproject/sitestats/tool/wicket/pages/ReportsEditPage.java", "diffHunk": "@@ -1127,19 +1127,18 @@ public IModel getModel(Object value) {\n \t\t\tLocator.getFacade().getSiteService().getSiteTypes().stream().map(s -> \"!site.template.\" + s).forEach(siteIdWithRoles::add);\n \t\t}\n \n-\t\tList<String> roles = new ArrayList<String>();\n-\t\ttry {\n-\t\t\tfor (String s : siteIdWithRoles) {\n+\t\tSet<String> roles = new HashSet<String>();\n+\t\tfor (String s : siteIdWithRoles) {\n+\t\t\ttry {\n \t\t\t\tSet<Role> roleSet = Locator.getFacade().getAuthzGroupService().getAuthzGroup(s).getRoles();\n \t\t\t\tfor (Role r : roleSet) {\n \t\t\t\t\troles.add(r.getId());\n \t\t\t\t}", "originalCommit": "049027bfbccdf4c72a5e4a8198ce40696aa3b1ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYxNTI0Ng==", "url": "https://github.com/sakaiproject/sakai/pull/8327#discussion_r448615246", "bodyText": "done", "author": "ottenhoff", "createdAt": "2020-07-01T21:04:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYwNzM5OA=="}], "type": "inlineReview", "revised_code": {"commit": "93ed5cb2cc4823cbb11f2fb590b85d786b811774", "chunk": "diff --git a/sitestats/sitestats-tool/src/java/org/sakaiproject/sitestats/tool/wicket/pages/ReportsEditPage.java b/sitestats/sitestats-tool/src/java/org/sakaiproject/sitestats/tool/wicket/pages/ReportsEditPage.java\nindex 655ac57e72..8f70881f10 100644\n--- a/sitestats/sitestats-tool/src/java/org/sakaiproject/sitestats/tool/wicket/pages/ReportsEditPage.java\n+++ b/sitestats/sitestats-tool/src/java/org/sakaiproject/sitestats/tool/wicket/pages/ReportsEditPage.java\n\n@@ -1130,12 +1130,9 @@ public class ReportsEditPage extends BasePage {\n \t\tSet<String> roles = new HashSet<String>();\n \t\tfor (String s : siteIdWithRoles) {\n \t\t\ttry {\n-\t\t\t\tSet<Role> roleSet = Locator.getFacade().getAuthzGroupService().getAuthzGroup(s).getRoles();\n-\t\t\t\tfor (Role r : roleSet) {\n-\t\t\t\t\troles.add(r.getId());\n-\t\t\t\t}\n+\t\t\t\tSet<Role> roleSet = Locator.getFacade().getAuthzGroupService().getAuthzGroup(s).getRoles().forEach(r -> roles.add(r.getId()));\n \t\t\t} catch (GroupNotDefinedException e) {\n-\t\t\t\tlog.warn(\"AuthzGroup does not exist, skipping: {}\", s);\n+\t\t\t\tlog.debug(\"AuthzGroup does not exist, skipping: {}\", s);\n \t\t\t}\n \t\t}\n \t\treturn new ArrayList<String>(roles);\n"}}, {"oid": "93ed5cb2cc4823cbb11f2fb590b85d786b811774", "url": "https://github.com/sakaiproject/sakai/commit/93ed5cb2cc4823cbb11f2fb590b85d786b811774", "message": "@ern suggestions", "committedDate": "2020-07-01T21:03:57Z", "type": "commit"}, {"oid": "1774f9dca926dd71fdff2fb2a96482cc23367510", "url": "https://github.com/sakaiproject/sakai/commit/1774f9dca926dd71fdff2fb2a96482cc23367510", "message": "Fix return", "committedDate": "2020-07-21T15:35:28Z", "type": "commit"}]}