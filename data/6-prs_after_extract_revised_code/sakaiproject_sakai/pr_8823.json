{"pr_number": 8823, "pr_title": "SAK-44687 ElFinder don't produce thumbnails for images over 20MB", "pr_createdAt": "2020-11-18T15:33:59Z", "pr_url": "https://github.com/sakaiproject/sakai/pull/8823", "timeline": [{"oid": "cb24f865588015ad7cde872e509776ccbf96c4dd", "url": "https://github.com/sakaiproject/sakai/commit/cb24f865588015ad7cde872e509776ccbf96c4dd", "message": "SAK-44687 ElFinder free resources associated with BufferedImage", "committedDate": "2020-11-18T15:31:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjI1NjM0NQ==", "url": "https://github.com/sakaiproject/sakai/pull/8823#discussion_r526256345", "bodyText": "FY I didn't opt to creating a config option for this as it is simply a reasonable upper limit and injecting the services into these classes is not trivial due to the way they are instantiated.", "author": "ern", "createdAt": "2020-11-18T17:06:56Z", "path": "textarea/elfinder-sakai/src/java/org/sakaiproject/elfinder/controller/executors/SakaiTmbCommandExecutor.java", "diffHunk": "@@ -29,12 +29,14 @@\n     public void execute(FsService fsService, HttpServletRequest request, HttpServletResponse response, ServletContext servletContext) throws Exception {\n         String target = request.getParameter(\"target\");\n         FsItemEx fsi = super.findItem(fsService, target);\n-        int width = fsService.getServiceConfig().getTmbWidth();\n-        try (InputStream is = fsi.openInputStream()) {\n-            ByteArrayOutputStream baos = resize(is, width);\n-            response.setHeader(HttpHeaders.LAST_MODIFIED, DateTimeFormatter.RFC_1123_DATE_TIME.format(ZonedDateTime.now().withZoneSameInstant(ZoneId.of(\"GMT\"))));\n-            response.setHeader(HttpHeaders.EXPIRES, DateTimeFormatter.RFC_1123_DATE_TIME.format(ZonedDateTime.now().withZoneSameInstant(ZoneId.of(\"GMT\")).plus(2, ChronoUnit.YEARS)));\n-            response.getOutputStream().write(baos.toByteArray());\n+        if (fsi.getSize() < 20971520) { // image must be less than 20MB", "originalCommit": "2fde4e77e60fced79899556febb2888cde6d7274", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjI1NzAxNw==", "url": "https://github.com/sakaiproject/sakai/pull/8823#discussion_r526257017", "bodyText": "Okay, can we make this a constant at least?", "author": "bjones86", "createdAt": "2020-11-18T17:07:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjI1NjM0NQ=="}], "type": "inlineReview", "revised_code": {"commit": "ffd825a09531cd224e3ad90091e47c43711d3db7", "chunk": "diff --git a/textarea/elfinder-sakai/src/java/org/sakaiproject/elfinder/controller/executors/SakaiTmbCommandExecutor.java b/textarea/elfinder-sakai/src/java/org/sakaiproject/elfinder/controller/executors/SakaiTmbCommandExecutor.java\nindex c4ac92ac90..cc40d20a28 100644\n--- a/textarea/elfinder-sakai/src/java/org/sakaiproject/elfinder/controller/executors/SakaiTmbCommandExecutor.java\n+++ b/textarea/elfinder-sakai/src/java/org/sakaiproject/elfinder/controller/executors/SakaiTmbCommandExecutor.java\n\n@@ -25,11 +25,13 @@ import cn.bluejoe.elfinder.service.FsService;\n \n public class SakaiTmbCommandExecutor extends AbstractCommandExecutor implements CommandExecutor {\n \n+    public static final long MAX_TMB_SIZE_BYTES = 20971520;\n+\n     @Override\n     public void execute(FsService fsService, HttpServletRequest request, HttpServletResponse response, ServletContext servletContext) throws Exception {\n         String target = request.getParameter(\"target\");\n         FsItemEx fsi = super.findItem(fsService, target);\n-        if (fsi.getSize() < 20971520) { // image must be less than 20MB\n+        if (fsi.getSize() < MAX_TMB_SIZE_BYTES) { // image must be less than MAX_TMB_SIZE_BYTES\n             int width = fsService.getServiceConfig().getTmbWidth();\n             try (InputStream is = fsi.openInputStream()) {\n                 ByteArrayOutputStream baos = resize(is, width);\n"}}, {"oid": "ffd825a09531cd224e3ad90091e47c43711d3db7", "url": "https://github.com/sakaiproject/sakai/commit/ffd825a09531cd224e3ad90091e47c43711d3db7", "message": "Only produce thumbnails for images with a size less than 20MB", "committedDate": "2020-11-18T21:16:02Z", "type": "commit"}, {"oid": "ffd825a09531cd224e3ad90091e47c43711d3db7", "url": "https://github.com/sakaiproject/sakai/commit/ffd825a09531cd224e3ad90091e47c43711d3db7", "message": "Only produce thumbnails for images with a size less than 20MB", "committedDate": "2020-11-18T21:16:02Z", "type": "forcePushed"}]}