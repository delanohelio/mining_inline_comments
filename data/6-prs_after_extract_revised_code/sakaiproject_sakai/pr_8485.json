{"pr_number": 8485, "pr_title": "SAK-44168 Kernel antisamy should not sanitize content item links in the RTE", "pr_createdAt": "2020-08-27T21:32:02Z", "pr_url": "https://github.com/sakaiproject/sakai/pull/8485", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTM1NjExOQ==", "url": "https://github.com/sakaiproject/sakai/pull/8485#discussion_r479356119", "bodyText": "I'd extract that localhost url into a variable, poysonally.", "author": "adrianfish", "createdAt": "2020-08-28T14:50:46Z", "path": "kernel/kernel-impl/src/test/java/org/sakaiproject/util/impl/FormattedTextTest.java", "diffHunk": "@@ -1224,5 +1226,13 @@ public void getHtmlBodyTest() {\n         Assert.assertEquals(\"\", result);\n     }\n \n+    @Test\n+    public void testLocalIframeSrc() {\n+        String contentItemIframe = \"<iframe allowfullscreen=\\\"true\\\" class=\\\"lti-iframe\\\" height=\\\"402\\\" mozallowfullscreen=\\\"true\\\" src=\\\"http://localhost:8080/access/basiclti/site/0f68e843-1f0c-473d-b469-852a49ea0f05/content:62\\\" title=\\\"Test LTI Content Item Iframe\\\" webkitallowfullscreen=\\\"true\\\" width=\\\"608\\\"></iframe>\";", "originalCommit": "a79d1d5603c0d7856106533d619967c2973e7a8d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "da24037b409bd6132b547481b17b24c16da09c83", "chunk": "diff --git a/kernel/kernel-impl/src/test/java/org/sakaiproject/util/impl/FormattedTextTest.java b/kernel/kernel-impl/src/test/java/org/sakaiproject/util/impl/FormattedTextTest.java\nindex bb7cb07308..49d5a7549d 100644\n--- a/kernel/kernel-impl/src/test/java/org/sakaiproject/util/impl/FormattedTextTest.java\n+++ b/kernel/kernel-impl/src/test/java/org/sakaiproject/util/impl/FormattedTextTest.java\n\n@@ -1228,11 +1228,13 @@ public class FormattedTextTest {\n \n     @Test\n     public void testLocalIframeSrc() {\n-        String contentItemIframe = \"<iframe allowfullscreen=\\\"true\\\" class=\\\"lti-iframe\\\" height=\\\"402\\\" mozallowfullscreen=\\\"true\\\" src=\\\"http://localhost:8080/access/basiclti/site/0f68e843-1f0c-473d-b469-852a49ea0f05/content:62\\\" title=\\\"Test LTI Content Item Iframe\\\" webkitallowfullscreen=\\\"true\\\" width=\\\"608\\\"></iframe>\";\n+        String serverUrl = serverConfigurationService.getServerUrl();\n+        String contentItemIframe = \"<iframe allowfullscreen=\\\"true\\\" class=\\\"lti-iframe\\\" height=\\\"402\\\" mozallowfullscreen=\\\"true\\\" src=\\\"\"\n+                + serverUrl + \"/access/basiclti/site/0f68e843-1f0c-473d-b469-852a49ea0f05/content:62\\\" title=\\\"Test LTI Content Item Iframe\\\" webkitallowfullscreen=\\\"true\\\" width=\\\"608\\\"></iframe>\";\n         StringBuilder errorMessages = new StringBuilder();\n         String result = formattedText.processFormattedText(contentItemIframe, errorMessages, Level.HIGH);\n         Assert.assertTrue(errorMessages.indexOf(\"src\") == -1);\n-        Assert.assertTrue(result.contains(\"src=\\\"http://localhost:8080/access/basiclti/site/0f68e843-1f0c-473d-b469-852a49ea0f05/content:62\\\"\"));\n+        Assert.assertTrue(result.contains(\"src=\\\"\" + serverUrl + \"/access/basiclti/site/0f68e843-1f0c-473d-b469-852a49ea0f05/content:62\\\"\"));\n     }\n \n }\n"}}, {"oid": "da24037b409bd6132b547481b17b24c16da09c83", "url": "https://github.com/sakaiproject/sakai/commit/da24037b409bd6132b547481b17b24c16da09c83", "message": "SAK-44168 Kernel antisamy should not sanitize content item links in the RTE", "committedDate": "2020-08-28T15:49:23Z", "type": "forcePushed"}, {"oid": "dd730a1f02ee1300ef6d3f4f34939744873dd8a7", "url": "https://github.com/sakaiproject/sakai/commit/dd730a1f02ee1300ef6d3f4f34939744873dd8a7", "message": "SAK-44168 Kernel antisamy should not sanitize content item links in the RTE", "committedDate": "2020-08-28T15:59:07Z", "type": "commit"}, {"oid": "dd730a1f02ee1300ef6d3f4f34939744873dd8a7", "url": "https://github.com/sakaiproject/sakai/commit/dd730a1f02ee1300ef6d3f4f34939744873dd8a7", "message": "SAK-44168 Kernel antisamy should not sanitize content item links in the RTE", "committedDate": "2020-08-28T15:59:07Z", "type": "forcePushed"}]}