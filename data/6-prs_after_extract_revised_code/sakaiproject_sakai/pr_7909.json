{"pr_number": 7909, "pr_title": "SAK-42959 Default lang-datepicker to user's local timestamp", "pr_createdAt": "2020-02-18T20:27:50Z", "pr_url": "https://github.com/sakaiproject/sakai/pull/7909", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk0NzgyMg==", "url": "https://github.com/sakaiproject/sakai/pull/7909#discussion_r380947822", "bodyText": "Just one method called addUserTimezoneInfo ? And then we add 3-4 new vars around time?", "author": "ottenhoff", "createdAt": "2020-02-18T21:33:27Z", "path": "portal/portal-impl/impl/src/java/org/sakaiproject/portal/charon/handlers/SiteHandler.java", "diffHunk": "@@ -556,6 +556,10 @@ public void doSite(HttpServletRequest req, HttpServletResponse res, Session sess\n \t\trcontext.put(\"showFavStarsOnAllFavSites\",ServerConfigurationService.getBoolean(SAK_PROP_SHOW_FAV_STARS_ON_ALL, SAK_PROP_SHOW_FAV_STARS_ON_ALL_DFLT));\n \t\t\n \t\taddLocale(rcontext, site, session.getUserId());\n+\n+\t\taddServerTime(rcontext);\n+\n+\t\taddUserTimezoneOffset(rcontext);", "originalCommit": "f9af75b3e54be203c85db3ae6e700c56fdccf543", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "81f489eb9e280bc443ab2fbdd48fbd15d850ec15", "chunk": "diff --git a/portal/portal-impl/impl/src/java/org/sakaiproject/portal/charon/handlers/SiteHandler.java b/portal/portal-impl/impl/src/java/org/sakaiproject/portal/charon/handlers/SiteHandler.java\nindex 4922760cf4..eac4f31010 100644\n--- a/portal/portal-impl/impl/src/java/org/sakaiproject/portal/charon/handlers/SiteHandler.java\n+++ b/portal/portal-impl/impl/src/java/org/sakaiproject/portal/charon/handlers/SiteHandler.java\n\n@@ -557,9 +557,7 @@ public class SiteHandler extends WorksiteHandler\n \t\t\n \t\taddLocale(rcontext, site, session.getUserId());\n \n-\t\taddServerTime(rcontext);\n-\n-\t\taddUserTimezoneOffset(rcontext);\n+\t\taddTimeInfo(rcontext);\n \t\t\n \t\tincludeSiteNav(rcontext, req, session, siteId);\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk0ODM3OA==", "url": "https://github.com/sakaiproject/sakai/pull/7909#discussion_r380948378", "bodyText": "while we are here, why don't we add the user's current (localized) date/time as ISO-8601 .... and might as well add their preferred timezone (e.g., Europe/Stockholm) .......", "author": "ottenhoff", "createdAt": "2020-02-18T21:34:28Z", "path": "portal/portal-impl/impl/src/java/org/sakaiproject/portal/charon/handlers/BasePortalHandler.java", "diffHunk": "@@ -209,4 +210,14 @@ protected void addLocale(PortalRenderContext rcontext, Site site, String userId)\n \t\t\ttimeService.clearLocalTimeZone(userId);\n \t\t}\n \t}\n+\n+\tprotected void addServerTime(PortalRenderContext rcontext) {\n+\t\trcontext.put(\"serverTime\", Instant.now().toEpochMilli());\n+\t}\n+\n+\tprotected void addUserTimezoneOffset(PortalRenderContext rcontext) {\n+\n+\t\tint offset = timeService.getLocalTimeZone().getOffset(Instant.now().toEpochMilli());\n+\t\trcontext.put(\"userTimezoneOffset\", offset);\n+\t}", "originalCommit": "f9af75b3e54be203c85db3ae6e700c56fdccf543", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "81f489eb9e280bc443ab2fbdd48fbd15d850ec15", "chunk": "diff --git a/portal/portal-impl/impl/src/java/org/sakaiproject/portal/charon/handlers/BasePortalHandler.java b/portal/portal-impl/impl/src/java/org/sakaiproject/portal/charon/handlers/BasePortalHandler.java\nindex 94ec70d469..ee15f6527e 100644\n--- a/portal/portal-impl/impl/src/java/org/sakaiproject/portal/charon/handlers/BasePortalHandler.java\n+++ b/portal/portal-impl/impl/src/java/org/sakaiproject/portal/charon/handlers/BasePortalHandler.java\n\n@@ -211,13 +213,14 @@ public abstract class BasePortalHandler implements PortalHandler\n \t\t}\n \t}\n \n-\tprotected void addServerTime(PortalRenderContext rcontext) {\n-\t\trcontext.put(\"serverTime\", Instant.now().toEpochMilli());\n-\t}\n-\n-\tprotected void addUserTimezoneOffset(PortalRenderContext rcontext) {\n+\tprotected void addTimeInfo(PortalRenderContext rcontext) {\n \n-\t\tint offset = timeService.getLocalTimeZone().getOffset(Instant.now().toEpochMilli());\n-\t\trcontext.put(\"userTimezoneOffset\", offset);\n+\t\tlong now = Instant.now().toEpochMilli();\n+\t\trcontext.put(\"serverTimeMillis\", now);\n+\t\tTimeZone userTz = timeService.getLocalTimeZone();\n+\t\trcontext.put(\"userTimezone\", userTz.getID());\n+\t\trcontext.put(\"userTimezoneOffsetMillis\", userTz.getOffset(now));\n+\t\tString iso8601 = Instant.now().atZone(ZoneId.of(userTz.getID())).toLocalDateTime().toString();\n+\t\trcontext.put(\"userISO8601Timestamp\", iso8601);\n \t}\n }\n"}}, {"oid": "ab490516ab88bb2a21b51b4881989d26c42bc38d", "url": "https://github.com/sakaiproject/sakai/commit/ab490516ab88bb2a21b51b4881989d26c42bc38d", "message": "SAK-42959 Default lang-datepicker to user's local timestamp\n\nhttps://jira.sakaiproject.org/browse/SAK-42959", "committedDate": "2020-02-19T08:45:10Z", "type": "forcePushed"}, {"oid": "81f489eb9e280bc443ab2fbdd48fbd15d850ec15", "url": "https://github.com/sakaiproject/sakai/commit/81f489eb9e280bc443ab2fbdd48fbd15d850ec15", "message": "SAK-42959 Default lang-datepicker to user's local timestamp\n\nhttps://jira.sakaiproject.org/browse/SAK-42959", "committedDate": "2020-02-19T10:09:35Z", "type": "forcePushed"}, {"oid": "1af1ad207e5d9041367725ac15eeb5ce967d0d54", "url": "https://github.com/sakaiproject/sakai/commit/1af1ad207e5d9041367725ac15eeb5ce967d0d54", "message": "SAK-42959 Default lang-datepicker to user's local timestamp\n\nhttps://jira.sakaiproject.org/browse/SAK-42959", "committedDate": "2020-02-19T20:06:57Z", "type": "forcePushed"}, {"oid": "15288745b67d0a5f8976322907591b75d3f43b21", "url": "https://github.com/sakaiproject/sakai/commit/15288745b67d0a5f8976322907591b75d3f43b21", "message": "SAK-42959 Default lang-datepicker to user's local timestamp\n\nhttps://jira.sakaiproject.org/browse/SAK-42959", "committedDate": "2020-02-19T20:24:33Z", "type": "forcePushed"}, {"oid": "b67e16e3e1c1db3f5c997c42f20f294c2982c9f7", "url": "https://github.com/sakaiproject/sakai/commit/b67e16e3e1c1db3f5c997c42f20f294c2982c9f7", "message": "SAK-42959 Default lang-datepicker to user's local timestamp\n\nhttps://jira.sakaiproject.org/browse/SAK-42959", "committedDate": "2020-02-19T20:29:47Z", "type": "commit"}, {"oid": "b67e16e3e1c1db3f5c997c42f20f294c2982c9f7", "url": "https://github.com/sakaiproject/sakai/commit/b67e16e3e1c1db3f5c997c42f20f294c2982c9f7", "message": "SAK-42959 Default lang-datepicker to user's local timestamp\n\nhttps://jira.sakaiproject.org/browse/SAK-42959", "committedDate": "2020-02-19T20:29:47Z", "type": "forcePushed"}]}