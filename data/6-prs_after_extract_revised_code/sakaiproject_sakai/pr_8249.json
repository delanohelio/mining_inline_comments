{"pr_number": 8249, "pr_title": "SAK-43698 - Initial MVP of tool keyset URL", "pr_createdAt": "2020-05-26T22:58:16Z", "pr_url": "https://github.com/sakaiproject/sakai/pull/8249", "timeline": [{"oid": "f43db92e7cba43745144a929a1981216fccdefb6", "url": "https://github.com/sakaiproject/sakai/commit/f43db92e7cba43745144a929a1981216fccdefb6", "message": "SAK-43698 - Initial MVP of tool keyset URL\n\nThis still needs some testing (Deep Link)\nand a pass through the Admin UI and to\nturn off the auto creation of the public/private\ntool pair when there is a keyset.  Make it so\nnon-keyset support can fade off into the sunset.", "committedDate": "2020-05-26T22:54:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDc2MTk1Ng==", "url": "https://github.com/sakaiproject/sakai/pull/8249#discussion_r430761956", "bodyText": "just delete this code?", "author": "ottenhoff", "createdAt": "2020-05-26T23:28:42Z", "path": "basiclti/basiclti-common/src/java/org/sakaiproject/basiclti/util/SakaiBLTIUtil.java", "diffHunk": "@@ -1092,16 +1133,20 @@ public static DeepLinkResponse getDeepLinkFromToken(Map<String, Object> tool, St\n \t\t\tif (lti_errorlog != null) {\n \t\t\t\tlog.warn(lti_errorlog);\n \t\t\t}\n-\n+/*\n+\t\t\t// TODO: Remove this", "originalCommit": "f43db92e7cba43745144a929a1981216fccdefb6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTU3NTg1NA==", "url": "https://github.com/sakaiproject/sakai/pull/8249#discussion_r431575854", "bodyText": "Yup - It was my intent to delete", "author": "csev", "createdAt": "2020-05-28T04:33:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDc2MTk1Ng=="}], "type": "inlineReview", "revised_code": {"commit": "da4bf5174ba6bd7a3d2b841ebcb7c7881b17683e", "chunk": "diff --git a/basiclti/basiclti-common/src/java/org/sakaiproject/basiclti/util/SakaiBLTIUtil.java b/basiclti/basiclti-common/src/java/org/sakaiproject/basiclti/util/SakaiBLTIUtil.java\nindex 31508fdbd6..6498b76290 100644\n--- a/basiclti/basiclti-common/src/java/org/sakaiproject/basiclti/util/SakaiBLTIUtil.java\n+++ b/basiclti/basiclti-common/src/java/org/sakaiproject/basiclti/util/SakaiBLTIUtil.java\n\n@@ -1133,20 +1133,9 @@ public class SakaiBLTIUtil {\n \t\t\tif (lti_errorlog != null) {\n \t\t\t\tlog.warn(lti_errorlog);\n \t\t\t}\n-/*\n-\t\t\t// TODO: Remove this\n-\t\t\tString publicKeyStr = (String) tool.get(LTIService.LTI13_TOOL_PUBLIC);\n-\t\t\tif (publicKeyStr == null) {\n-\t\t\t\tthrow new RuntimeException(\"Could not find tool public key\");\n-\t\t\t}\n \n-\t\t\tKey publicKey = string2PublicKey(publicKeyStr);\n-\t\t\tif (publicKey == null) {\n-\t\t\t\tthrow new RuntimeException(\"Could not deserialize tool public key\");\n-\t\t\t}\n-*/\n \t\t\t// May throw a RunTimeException on our behalf :)\n-\t\t    Key publicKey = SakaiBLTIUtil.getPublicKey(tool, id_token);\n+\t\t\tKey publicKey = SakaiBLTIUtil.getPublicKey(tool, id_token);\n \n \t\t\t// Fill up the object, validate and return\n \t\t\tDeepLinkResponse dlr = new DeepLinkResponse(id_token);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDc2MjAzMg==", "url": "https://github.com/sakaiproject/sakai/pull/8249#discussion_r430762032", "bodyText": "indentation looks odd here", "author": "ottenhoff", "createdAt": "2020-05-26T23:28:57Z", "path": "basiclti/basiclti-common/src/java/org/sakaiproject/basiclti/util/SakaiBLTIUtil.java", "diffHunk": "@@ -1092,16 +1133,20 @@ public static DeepLinkResponse getDeepLinkFromToken(Map<String, Object> tool, St\n \t\t\tif (lti_errorlog != null) {\n \t\t\t\tlog.warn(lti_errorlog);\n \t\t\t}\n-\n+/*\n+\t\t\t// TODO: Remove this\n \t\t\tString publicKeyStr = (String) tool.get(LTIService.LTI13_TOOL_PUBLIC);\n \t\t\tif (publicKeyStr == null) {\n \t\t\t\tthrow new RuntimeException(\"Could not find tool public key\");\n \t\t\t}\n \n-\t\t\tKey publicKey = LTI13Util.string2PublicKey(publicKeyStr);\n+\t\t\tKey publicKey = string2PublicKey(publicKeyStr);\n \t\t\tif (publicKey == null) {\n \t\t\t\tthrow new RuntimeException(\"Could not deserialize tool public key\");\n \t\t\t}\n+*/\n+\t\t\t// May throw a RunTimeException on our behalf :)\n+\t\t    Key publicKey = SakaiBLTIUtil.getPublicKey(tool, id_token);", "originalCommit": "f43db92e7cba43745144a929a1981216fccdefb6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTU3NjMxMA==", "url": "https://github.com/sakaiproject/sakai/pull/8249#discussion_r431576310", "bodyText": "Yup", "author": "csev", "createdAt": "2020-05-28T04:35:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDc2MjAzMg=="}], "type": "inlineReview", "revised_code": {"commit": "da4bf5174ba6bd7a3d2b841ebcb7c7881b17683e", "chunk": "diff --git a/basiclti/basiclti-common/src/java/org/sakaiproject/basiclti/util/SakaiBLTIUtil.java b/basiclti/basiclti-common/src/java/org/sakaiproject/basiclti/util/SakaiBLTIUtil.java\nindex 31508fdbd6..6498b76290 100644\n--- a/basiclti/basiclti-common/src/java/org/sakaiproject/basiclti/util/SakaiBLTIUtil.java\n+++ b/basiclti/basiclti-common/src/java/org/sakaiproject/basiclti/util/SakaiBLTIUtil.java\n\n@@ -1133,20 +1133,9 @@ public class SakaiBLTIUtil {\n \t\t\tif (lti_errorlog != null) {\n \t\t\t\tlog.warn(lti_errorlog);\n \t\t\t}\n-/*\n-\t\t\t// TODO: Remove this\n-\t\t\tString publicKeyStr = (String) tool.get(LTIService.LTI13_TOOL_PUBLIC);\n-\t\t\tif (publicKeyStr == null) {\n-\t\t\t\tthrow new RuntimeException(\"Could not find tool public key\");\n-\t\t\t}\n \n-\t\t\tKey publicKey = string2PublicKey(publicKeyStr);\n-\t\t\tif (publicKey == null) {\n-\t\t\t\tthrow new RuntimeException(\"Could not deserialize tool public key\");\n-\t\t\t}\n-*/\n \t\t\t// May throw a RunTimeException on our behalf :)\n-\t\t    Key publicKey = SakaiBLTIUtil.getPublicKey(tool, id_token);\n+\t\t\tKey publicKey = SakaiBLTIUtil.getPublicKey(tool, id_token);\n \n \t\t\t// Fill up the object, validate and return\n \t\t\tDeepLinkResponse dlr = new DeepLinkResponse(id_token);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDc2MjI2Mg==", "url": "https://github.com/sakaiproject/sakai/pull/8249#discussion_r430762262", "bodyText": "tabs/spaces", "author": "ottenhoff", "createdAt": "2020-05-26T23:29:43Z", "path": "basiclti/tsugi-util/src/java/org/tsugi/lti13/LTI13KeySetUtil.java", "diffHunk": "@@ -75,4 +77,29 @@ public static String getKeySetJSON(RSAPublicKey key)\n \t\treturn getKeySetJSON(keys);\n \t}\n \n+\tpublic static RSAPublicKey getKeyFromKeySet(String kid, String url) \n+\t\tthrows java.text.ParseException, com.nimbusds.jose.JOSEException, java.net.MalformedURLException, java.io.IOException\n+\t{\n+\t\tcom.nimbusds.jose.jwk.JWKSet localKeys = com.nimbusds.jose.jwk.JWKSet.load(new java.net.URL(url));\n+\n+        com.nimbusds.jose.jwk.RSAKey nimbusPublic = (com.nimbusds.jose.jwk.RSAKey) localKeys.getKeyByKeyId(kid);\n+\n+        RSAPublicKey publicKey = nimbusPublic.toRSAPublicKey();\n+        java.security.interfaces.RSAKey rsaPublicKey = (java.security.interfaces.RSAKey) publicKey;\n+\n+\t\treturn publicKey;\n+\t}\n+\n+\tpublic static RSAPublicKey getKeyFromKeySetString(String kid, String json) \n+\t\tthrows java.text.ParseException, com.nimbusds.jose.JOSEException\n+\t{\n+\t\tcom.nimbusds.jose.jwk.JWKSet localKeys = com.nimbusds.jose.jwk.JWKSet.parse(json);\n+\n+        com.nimbusds.jose.jwk.RSAKey nimbusPublic = (com.nimbusds.jose.jwk.RSAKey) localKeys.getKeyByKeyId(kid);\n+\n+        RSAPublicKey publicKey = nimbusPublic.toRSAPublicKey();\n+        java.security.interfaces.RSAKey rsaPublicKey = (java.security.interfaces.RSAKey) publicKey;\n+\n+\t\treturn publicKey;", "originalCommit": "f43db92e7cba43745144a929a1981216fccdefb6", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "da4bf5174ba6bd7a3d2b841ebcb7c7881b17683e", "chunk": "diff --git a/basiclti/tsugi-util/src/java/org/tsugi/lti13/LTI13KeySetUtil.java b/basiclti/tsugi-util/src/java/org/tsugi/lti13/LTI13KeySetUtil.java\nindex 0670b6a11f..58ab2097d4 100644\n--- a/basiclti/tsugi-util/src/java/org/tsugi/lti13/LTI13KeySetUtil.java\n+++ b/basiclti/tsugi-util/src/java/org/tsugi/lti13/LTI13KeySetUtil.java\n\n@@ -82,10 +82,10 @@ public class LTI13KeySetUtil {\n \t{\n \t\tcom.nimbusds.jose.jwk.JWKSet localKeys = com.nimbusds.jose.jwk.JWKSet.load(new java.net.URL(url));\n \n-        com.nimbusds.jose.jwk.RSAKey nimbusPublic = (com.nimbusds.jose.jwk.RSAKey) localKeys.getKeyByKeyId(kid);\n+\t\tcom.nimbusds.jose.jwk.RSAKey nimbusPublic = (com.nimbusds.jose.jwk.RSAKey) localKeys.getKeyByKeyId(kid);\n \n-        RSAPublicKey publicKey = nimbusPublic.toRSAPublicKey();\n-        java.security.interfaces.RSAKey rsaPublicKey = (java.security.interfaces.RSAKey) publicKey;\n+\t\tRSAPublicKey publicKey = nimbusPublic.toRSAPublicKey();\n+\t\tjava.security.interfaces.RSAKey rsaPublicKey = (java.security.interfaces.RSAKey) publicKey;\n \n \t\treturn publicKey;\n \t}\n"}}, {"oid": "75908821b561f3b8900552806d06d619facf30ec", "url": "https://github.com/sakaiproject/sakai/commit/75908821b561f3b8900552806d06d619facf30ec", "message": "SAK-43698 - Add UI bits and auto updates", "committedDate": "2020-05-28T04:32:08Z", "type": "commit"}, {"oid": "da4bf5174ba6bd7a3d2b841ebcb7c7881b17683e", "url": "https://github.com/sakaiproject/sakai/commit/da4bf5174ba6bd7a3d2b841ebcb7c7881b17683e", "message": "SAK-43698 - Cleanup indentation and remove old code\n\nThanks Sam.", "committedDate": "2020-05-28T04:38:29Z", "type": "commit"}, {"oid": "3407ca668e77d3e0b28e47136c6c2748cd55aa01", "url": "https://github.com/sakaiproject/sakai/commit/3407ca668e77d3e0b28e47136c6c2748cd55aa01", "message": "SAK-43698 - Cleanup the UI, show issuer, cleanup codacy", "committedDate": "2020-05-28T13:30:20Z", "type": "commit"}, {"oid": "fafcb011d8c57b44d8d7ebdd50f8b39a4f994af0", "url": "https://github.com/sakaiproject/sakai/commit/fafcb011d8c57b44d8d7ebdd50f8b39a4f994af0", "message": "SAK-43698 - Moar codacy cleanup", "committedDate": "2020-05-28T16:06:30Z", "type": "commit"}, {"oid": "4a9e4280efb912b393da9cf4ba7399b03835af2a", "url": "https://github.com/sakaiproject/sakai/commit/4a9e4280efb912b393da9cf4ba7399b03835af2a", "message": "SAK-43698 - Update test plans", "committedDate": "2020-05-28T22:56:43Z", "type": "commit"}, {"oid": "006727f4725d0097db1b012a665337d19a468b15", "url": "https://github.com/sakaiproject/sakai/commit/006727f4725d0097db1b012a665337d19a468b15", "message": "More test plan updates", "committedDate": "2020-05-28T23:54:05Z", "type": "commit"}]}