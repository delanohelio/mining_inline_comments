{"pr_number": 8539, "pr_title": "SAK-43678 Assignments: Incorrect order in name column when downloading spreadsheet [XLSX]", "pr_createdAt": "2020-09-09T11:13:26Z", "pr_url": "https://github.com/sakaiproject/sakai/pull/8539", "timeline": [{"oid": "57b94e64dfb04d4ccf3f046574ce3ea16ba51ad4", "url": "https://github.com/sakaiproject/sakai/commit/57b94e64dfb04d4ccf3f046574ce3ea16ba51ad4", "message": "SAK-43678 Assignments: Incorrect order in name column when downloading spreadsheet [XLSX]", "committedDate": "2020-09-09T11:07:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTYxMjA1OA==", "url": "https://github.com/sakaiproject/sakai/pull/8539#discussion_r485612058", "bodyText": "Can produce an NPE either use a lambda to filter nulls or the NullSafeComparator i.e.\nreturn new NullSafeComparator<>(collator, false).compare(s1.getSortName(), s2.getSortName()", "author": "ern", "createdAt": "2020-09-09T13:30:07Z", "path": "assignment/impl/src/java/org/sakaiproject/assignment/impl/GradeSheetExporter.java", "diffHunk": "@@ -70,7 +74,28 @@\n     @Setter private FormattedText formattedText;\n \n     private ResourceLoader rb = new ResourceLoader(\"assignment\");\n+    \n+    /**\n+    * A comparator that sorts by student sortName\n+    */\n+    static final Comparator<Submitter> SUBMITTER_NAME_COMPARATOR = new Comparator<Submitter>() {\n+        Collator collator;\n+        {\n+            this.collator = Collator.getInstance();\n+            try {\n+                this.collator = new RuleBasedCollator(\n+                        ((RuleBasedCollator) this.collator).getRules().replaceAll(\"<'\\u005f'\", \"<' '<'\\u005f'\"));\n+            } catch (final ParseException e) {\n+                log.warn(this + \" Cannot init RuleBasedCollator. Will use the default Collator instead.\", e);\n+            }\n+        }\n \n+        @Override\n+        public int compare(final Submitter s1, final Submitter s2) {\n+            return this.collator.compare(s1.sortName, s2.sortName);", "originalCommit": "57b94e64dfb04d4ccf3f046574ce3ea16ba51ad4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjY1ODA1OQ==", "url": "https://github.com/sakaiproject/sakai/pull/8539#discussion_r492658059", "bodyText": "Done!", "author": "joaquinmarques", "createdAt": "2020-09-22T11:24:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTYxMjA1OA=="}], "type": "inlineReview", "revised_code": {"commit": "a18b3b5a2ce998893663458f951632c9557c067f", "chunk": "diff --git a/assignment/impl/src/java/org/sakaiproject/assignment/impl/GradeSheetExporter.java b/assignment/impl/src/java/org/sakaiproject/assignment/impl/GradeSheetExporter.java\nindex e9c45365e7..aaf2ea5ae9 100644\n--- a/assignment/impl/src/java/org/sakaiproject/assignment/impl/GradeSheetExporter.java\n+++ b/assignment/impl/src/java/org/sakaiproject/assignment/impl/GradeSheetExporter.java\n\n@@ -91,8 +92,8 @@ public class GradeSheetExporter {\n         }\n \n         @Override\n-        public int compare(final Submitter s1, final Submitter s2) {\n-            return this.collator.compare(s1.sortName, s2.sortName);\n+        public int compare(final Submitter s1, final Submitter s2) {            \n+            return new NullSafeComparator<>(collator, false).compare(s1.getSortName(), s2.getSortName());\n         }\n     };\n     \n"}}, {"oid": "a18b3b5a2ce998893663458f951632c9557c067f", "url": "https://github.com/sakaiproject/sakai/commit/a18b3b5a2ce998893663458f951632c9557c067f", "message": "SAK-43678 Assignments: Incorrect order in name column when downloading spreadsheet [XLSX]", "committedDate": "2020-09-22T11:25:42Z", "type": "commit"}, {"oid": "31709aed6f242b0db533ea37ff23399a0b616445", "url": "https://github.com/sakaiproject/sakai/commit/31709aed6f242b0db533ea37ff23399a0b616445", "message": "SAK-43678 Assignments: Incorrect order in name column when downloading spreadsheet [XLSX]", "committedDate": "2020-09-28T11:05:57Z", "type": "commit"}]}