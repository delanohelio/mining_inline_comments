{"pr_number": 8566, "pr_title": "SAK-44292: FORUMS: Error unique result while Automatically create multiple topics for groups", "pr_createdAt": "2020-09-14T11:32:15Z", "pr_url": "https://github.com/sakaiproject/sakai/pull/8566", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjgxNjQ0OQ==", "url": "https://github.com/sakaiproject/sakai/pull/8566#discussion_r492816449", "bodyText": "this should be a list() as more than one group/section should be returned.", "author": "ern", "createdAt": "2020-09-22T15:12:09Z", "path": "msgcntr/messageforums-component-impl/src/java/org/sakaiproject/component/app/messageforums/MessageForumsForumManagerImpl.java", "diffHunk": "@@ -1527,6 +1527,7 @@ public String getAllowedGroupForRestrictedTopic(final Long topicId, final String\n \t\t\t\t.getNamedQuery(\"findAllowedGroupInTopic\")\n \t\t\t\t.setLong(\"id\", topicId)\n \t\t\t\t.setString(\"permissionLevelName\", permissionName)\n+\t\t\t\t.setMaxResults(1)\n \t\t\t\t.uniqueResult();", "originalCommit": "8cddd595db4b6f186c7a327d68e09098ae91c384", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDIxNTQzMQ==", "url": "https://github.com/sakaiproject/sakai/pull/8566#discussion_r494215431", "bodyText": "Done!", "author": "feralvarez95", "createdAt": "2020-09-24T10:44:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjgxNjQ0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzMxNzIzOQ==", "url": "https://github.com/sakaiproject/sakai/pull/8566#discussion_r497317239", "bodyText": "@ern Is there any problem with the changes?", "author": "jesusmmp", "createdAt": "2020-09-30T08:02:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjgxNjQ0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzc1OTkxMg==", "url": "https://github.com/sakaiproject/sakai/pull/8566#discussion_r497759912", "bodyText": "Earle has a huge refactoring of msgcntr queued up ... with huge performance gains.\nAlso, I was never able to replicate the reported bug. I tried several times on my local trunk  .....", "author": "ottenhoff", "createdAt": "2020-09-30T19:48:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjgxNjQ0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODAwMjk2Ng==", "url": "https://github.com/sakaiproject/sakai/pull/8566#discussion_r498002966", "bodyText": "@ottenhoff I uploaded a video with the problem. Have you seen it?", "author": "jesusmmp", "createdAt": "2020-10-01T06:08:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjgxNjQ0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODI1MzI0Nw==", "url": "https://github.com/sakaiproject/sakai/pull/8566#discussion_r498253247", "bodyText": "Yes, I watched several times and followed the steps several times.", "author": "ottenhoff", "createdAt": "2020-10-01T13:41:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjgxNjQ0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDgxNzUxMA==", "url": "https://github.com/sakaiproject/sakai/pull/8566#discussion_r504817510", "bodyText": "We have reproduced this issue in our Sakai 20 in production. We introduced a new ticket (SAK-44462) but @jesusmmp has advised that our new ticket in fact duplicated SAK-44292 Maybe our testing plan in SAK-44462 can help to reproduce the issue", "author": "mateullas", "createdAt": "2020-10-14T16:34:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjgxNjQ0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDgzNjM1OQ==", "url": "https://github.com/sakaiproject/sakai/pull/8566#discussion_r504836359", "bodyText": "I was able to replicate today. @ern and I are looking at it", "author": "ottenhoff", "createdAt": "2020-10-14T17:04:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjgxNjQ0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk1MTc5OA==", "url": "https://github.com/sakaiproject/sakai/pull/8566#discussion_r504951798", "bodyText": "yes looking", "author": "ern", "createdAt": "2020-10-14T20:26:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjgxNjQ0OQ=="}], "type": "inlineReview", "revised_code": {"commit": "71db8e1f8e0a27ae5cad850d076c55cbbb2b5db8", "chunk": "diff --git a/msgcntr/messageforums-component-impl/src/java/org/sakaiproject/component/app/messageforums/MessageForumsForumManagerImpl.java b/msgcntr/messageforums-component-impl/src/java/org/sakaiproject/component/app/messageforums/MessageForumsForumManagerImpl.java\nindex c43e2e00ca..0d14f28ee3 100644\n--- a/msgcntr/messageforums-component-impl/src/java/org/sakaiproject/component/app/messageforums/MessageForumsForumManagerImpl.java\n+++ b/msgcntr/messageforums-component-impl/src/java/org/sakaiproject/component/app/messageforums/MessageForumsForumManagerImpl.java\n\n@@ -1519,28 +1519,27 @@ public class MessageForumsForumManagerImpl extends HibernateDaoSupport implement\n \t\t\treturn countRows.intValue() > 0;\n \t\t}\n \t\t\n-\t\tpublic String getAllowedGroupForRestrictedTopic(final Long topicId, final String permissionName) {\n+\t\tpublic List<String> getAllowedGroupForRestrictedTopic(final Long topicId, final String permissionName) {\n \t\t\tif (topicId == null) {\n \t\t\t\tthrow new IllegalArgumentException(\"Null Argument\");\n \t\t\t}\n-\t\t\tHibernateCallback<String> hcb = session -> (String) session\n+\t\t\tHibernateCallback<List<String>> hcb = session -> (List<String>) session\n \t\t\t\t.getNamedQuery(\"findAllowedGroupInTopic\")\n \t\t\t\t.setLong(\"id\", topicId)\n \t\t\t\t.setString(\"permissionLevelName\", permissionName)\n-\t\t\t\t.setMaxResults(1)\n-\t\t\t\t.uniqueResult();\n+\t\t\t\t.list();\n \t\t\treturn getHibernateTemplate().execute(hcb);\n \t\t}\n \n-\t\tpublic String getAllowedGroupForRestrictedForum(final Long forumId, final String permissionName) {\n+\t\tpublic List<String> getAllowedGroupForRestrictedForum(final Long forumId, final String permissionName) {\n \t\t\tif (forumId == null) {\n \t\t\t\tthrow new IllegalArgumentException(\"Null Argument\");\n \t\t\t}\n-\t\t\tHibernateCallback<String> hcb = session -> (String) session\n+\t\t\tHibernateCallback<List<String>> hcb = session -> (List<String>) session\n \t\t\t\t.getNamedQuery(\"findAllowedGroupInForum\")\n \t\t\t\t.setLong(\"id\", forumId)\n \t\t\t\t.setString(\"permissionLevelName\", permissionName)\n-\t\t\t\t.uniqueResult();\n+\t\t\t\t.list();\n \t\t\treturn getHibernateTemplate().execute(hcb);\n \t\t}\n }\n"}}, {"oid": "71db8e1f8e0a27ae5cad850d076c55cbbb2b5db8", "url": "https://github.com/sakaiproject/sakai/commit/71db8e1f8e0a27ae5cad850d076c55cbbb2b5db8", "message": "SAK-44292: FORUMS: Error unique result while Automatically create multiple topics for groups", "committedDate": "2020-09-24T10:40:53Z", "type": "forcePushed"}, {"oid": "5dc1d0689ff28812f7b7ae6fcf448c60f4431161", "url": "https://github.com/sakaiproject/sakai/commit/5dc1d0689ff28812f7b7ae6fcf448c60f4431161", "message": "SAK-44292: FORUMS: Error unique result while Automatically create multiple topics for groups", "committedDate": "2020-10-14T08:23:38Z", "type": "forcePushed"}, {"oid": "74f805cb1baaaf6b83454296f18fa333d38d8367", "url": "https://github.com/sakaiproject/sakai/commit/74f805cb1baaaf6b83454296f18fa333d38d8367", "message": "SAK-44292: FORUMS: Error unique result while Automatically create multiple topics for groups", "committedDate": "2020-10-14T08:40:21Z", "type": "commit"}, {"oid": "74f805cb1baaaf6b83454296f18fa333d38d8367", "url": "https://github.com/sakaiproject/sakai/commit/74f805cb1baaaf6b83454296f18fa333d38d8367", "message": "SAK-44292: FORUMS: Error unique result while Automatically create multiple topics for groups", "committedDate": "2020-10-14T08:40:21Z", "type": "forcePushed"}, {"oid": "f9661f9d2cce75d55b48f30ea8e0d94c305f49ad", "url": "https://github.com/sakaiproject/sakai/commit/f9661f9d2cce75d55b48f30ea8e0d94c305f49ad", "message": "Use siteId", "committedDate": "2020-10-14T19:27:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk2MjYwMA==", "url": "https://github.com/sakaiproject/sakai/pull/8566#discussion_r504962600", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        for(String group: groupTitle) {\n          \n          \n            \n                      \t  if(groups.stream().map(site::getGroup).anyMatch(g -> g.getTitle().equals(group)))\n          \n          \n            \n                      \t\t  return true;\n          \n          \n            \n                        }\n          \n          \n            \n                        return groups.stream().map(site::getGroup).anyMatch(g -> groupTitle.contains(g.getTitle()));", "author": "ern", "createdAt": "2020-10-14T20:47:35Z", "path": "msgcntr/messageforums-component-impl/src/java/org/sakaiproject/component/app/messageforums/ui/UIPermissionsManagerImpl.java", "diffHunk": "@@ -130,7 +130,10 @@ private boolean isInstructorForAllowedGroup(Long forumId, boolean isForum) {\n         try {\n             Site site = siteService.getSite(siteId);\n             Set<String> groups = getGroupsWithMember(site, getCurrentUserId());\n-            return groups.stream().map(site::getGroup).anyMatch(g -> g.getTitle().equals(groupTitle));\n+            for(String group: groupTitle) {\n+          \t  if(groups.stream().map(site::getGroup).anyMatch(g -> g.getTitle().equals(group)))\n+          \t\t  return true;\n+            }", "originalCommit": "f9661f9d2cce75d55b48f30ea8e0d94c305f49ad", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "4f7624b2b856f5775144cf09643888e8d16be499", "chunk": "diff --git a/msgcntr/messageforums-component-impl/src/java/org/sakaiproject/component/app/messageforums/ui/UIPermissionsManagerImpl.java b/msgcntr/messageforums-component-impl/src/java/org/sakaiproject/component/app/messageforums/ui/UIPermissionsManagerImpl.java\nindex 2bd87a2f6c..7e9a67fd8f 100644\n--- a/msgcntr/messageforums-component-impl/src/java/org/sakaiproject/component/app/messageforums/ui/UIPermissionsManagerImpl.java\n+++ b/msgcntr/messageforums-component-impl/src/java/org/sakaiproject/component/app/messageforums/ui/UIPermissionsManagerImpl.java\n\n@@ -130,10 +130,7 @@ public class UIPermissionsManagerImpl implements UIPermissionsManager {\n         try {\n             Site site = siteService.getSite(siteId);\n             Set<String> groups = getGroupsWithMember(site, getCurrentUserId());\n-            for(String group: groupTitle) {\n-          \t  if(groups.stream().map(site::getGroup).anyMatch(g -> g.getTitle().equals(group)))\n-          \t\t  return true;\n-            }\n+            return groups.stream().map(site::getGroup).anyMatch(g -> groupTitle.contains(g.getTitle()));\n         } catch (IdUnusedException iue) {\n             log.warn(\"Could not fetch site {}, {}\", siteId, iue.toString());\n         }\n"}}, {"oid": "4f7624b2b856f5775144cf09643888e8d16be499", "url": "https://github.com/sakaiproject/sakai/commit/4f7624b2b856f5775144cf09643888e8d16be499", "message": "updated lambda for matching group title", "committedDate": "2020-10-14T20:48:32Z", "type": "commit"}]}