{"pr_number": 8864, "pr_title": "SAK-44740 check for categoryId from the GB as the instructor can edit in both Samigo and GB", "pr_createdAt": "2020-12-03T20:27:45Z", "pr_url": "https://github.com/sakaiproject/sakai/pull/8864", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUxMzM3Mg==", "url": "https://github.com/sakaiproject/sakai/pull/8864#discussion_r537513372", "bodyText": "this reads as though 0 could be a valid category should these be (currentCategoryId > -1 || newCategoryId > -1)?", "author": "ern", "createdAt": "2020-12-07T13:40:30Z", "path": "samigo/samigo-app/src/java/org/sakaiproject/tool/assessment/ui/listener/author/SavePublishedSettingsListener.java", "diffHunk": "@@ -797,12 +788,17 @@ public boolean updateGB(PublishedAssessmentSettingsBean assessmentSettings, Publ\n \t\t\tInteger scoringType = evaluation.getScoringType();\n \t\t\tif (evaluation.getToGradeBook()!=null && \n \t\t\t\t\tevaluation.getToGradeBook().equals(EvaluationModelIfc.TO_DEFAULT_GRADEBOOK.toString())){\n-\t\t\t\tLong categoryId = null;\n+\n+\t\t\t\t// Can't trust the old assessment category id because the instructor could have changed inside Gradebook directly!\n+\t\t\t\tLong externalCategoryId = gbsHelper.getExternalAssessmentCategoryId(GradebookFacade.getGradebookUId(), assessment.getPublishedAssessmentId().toString(), g);\n+\t\t\t\tlong currentCategoryId =  externalCategoryId != null ? externalCategoryId : -1;\n+\t\t\t\tlong newCategoryId = NumberUtils.toLong(assessmentSettings.getCategorySelected(), -1);\n+\t\t\t\tboolean isCategoryChanged = (currentCategoryId > 0 || newCategoryId > 0) && currentCategoryId != newCategoryId;", "originalCommit": "f9815977a7bee5922b49602596c1a0f7b308deb8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUzODkzNg==", "url": "https://github.com/sakaiproject/sakai/pull/8864#discussion_r537538936", "bodyText": "0 would not indicate a valid categoryId. It must be greater than zero to indicate a selected category", "author": "ottenhoff", "createdAt": "2020-12-07T14:15:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUxMzM3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYyMjg2MA==", "url": "https://github.com/sakaiproject/sakai/pull/8864#discussion_r537622860", "bodyText": "ok cool", "author": "ern", "createdAt": "2020-12-07T16:01:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUxMzM3Mg=="}], "type": "inlineReview", "revised_code": {"commit": "6b3c823cf0c46bf731dcaa3dfc88404a990b1f26", "chunk": "diff --git a/samigo/samigo-app/src/java/org/sakaiproject/tool/assessment/ui/listener/author/SavePublishedSettingsListener.java b/samigo/samigo-app/src/java/org/sakaiproject/tool/assessment/ui/listener/author/SavePublishedSettingsListener.java\nindex fa7ccc2aa8..ac105f3aed 100644\n--- a/samigo/samigo-app/src/java/org/sakaiproject/tool/assessment/ui/listener/author/SavePublishedSettingsListener.java\n+++ b/samigo/samigo-app/src/java/org/sakaiproject/tool/assessment/ui/listener/author/SavePublishedSettingsListener.java\n\n@@ -788,17 +797,12 @@ implements ActionListener\n \t\t\tInteger scoringType = evaluation.getScoringType();\n \t\t\tif (evaluation.getToGradeBook()!=null && \n \t\t\t\t\tevaluation.getToGradeBook().equals(EvaluationModelIfc.TO_DEFAULT_GRADEBOOK.toString())){\n-\n-\t\t\t\t// Can't trust the old assessment category id because the instructor could have changed inside Gradebook directly!\n-\t\t\t\tLong externalCategoryId = gbsHelper.getExternalAssessmentCategoryId(GradebookFacade.getGradebookUId(), assessment.getPublishedAssessmentId().toString(), g);\n-\t\t\t\tlong currentCategoryId =  externalCategoryId != null ? externalCategoryId : -1;\n-\t\t\t\tlong newCategoryId = NumberUtils.toLong(assessmentSettings.getCategorySelected(), -1);\n-\t\t\t\tboolean isCategoryChanged = (currentCategoryId > 0 || newCategoryId > 0) && currentCategoryId != newCategoryId;\n-\n+\t\t\t\tLong categoryId = null;\n \t\t\t\tif (isTitleChanged || isScoringTypeChanged || isCategoryChanged) {\n \t\t\t\t\t// Because GB use title instead of id, we remove and re-add to GB if title changes.\n \t\t\t\t\ttry {\n-\t\t\t\t\t\tlog.debug(\"before gbsHelper.removeGradebook(), isTitleChanged={}, isScoringTypeChanged={}, isCategoryChanged={}\", isTitleChanged, isScoringTypeChanged, newCategoryId);\n+\t\t\t\t\t\tlog.debug(\"before gbsHelper.removeGradebook()\");\n+\t\t\t\t\t\tcategoryId = gbsHelper.getExternalAssessmentCategoryId(GradebookFacade.getGradebookUId(), assessment.getPublishedAssessmentId().toString(), g);\n \t\t\t\t\t\tgbsHelper.removeExternalAssessment(GradebookFacade.getGradebookUId(), assessment.getPublishedAssessmentId().toString(), g);\n \t\t\t\t\t} catch (Exception e1) {\n \t\t\t\t\t\t// Should be the external assessment doesn't exist in GB. So we quiet swallow the exception. Please check the log for the actual error.\n"}}, {"oid": "6b3c823cf0c46bf731dcaa3dfc88404a990b1f26", "url": "https://github.com/sakaiproject/sakai/commit/6b3c823cf0c46bf731dcaa3dfc88404a990b1f26", "message": "SAK-44450 clear caches after updating permissions so you don't get StaleObject errors", "committedDate": "2020-12-07T16:21:04Z", "type": "commit"}, {"oid": "15f2c0135481b60934447f114be6f9d7564c032a", "url": "https://github.com/sakaiproject/sakai/commit/15f2c0135481b60934447f114be6f9d7564c032a", "message": "fix baseForum issue", "committedDate": "2020-12-07T16:21:04Z", "type": "commit"}, {"oid": "01c28202d29d94f0afba2e6a6e04ee6699820761", "url": "https://github.com/sakaiproject/sakai/commit/01c28202d29d94f0afba2e6a6e04ee6699820761", "message": "revert cache clearing in prep for earle patch", "committedDate": "2020-12-07T16:21:05Z", "type": "commit"}, {"oid": "eee4d73c6704c1d06e927a46093051285f5dc1b7", "url": "https://github.com/sakaiproject/sakai/commit/eee4d73c6704c1d06e927a46093051285f5dc1b7", "message": "SAK-44740 check for categoryId from the GB as the instructor can edit in both Samigo and GB", "committedDate": "2020-12-07T16:21:05Z", "type": "commit"}, {"oid": "eee4d73c6704c1d06e927a46093051285f5dc1b7", "url": "https://github.com/sakaiproject/sakai/commit/eee4d73c6704c1d06e927a46093051285f5dc1b7", "message": "SAK-44740 check for categoryId from the GB as the instructor can edit in both Samigo and GB", "committedDate": "2020-12-07T16:21:05Z", "type": "forcePushed"}]}