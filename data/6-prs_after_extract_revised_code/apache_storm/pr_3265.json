{"pr_number": 3265, "pr_title": "[STORM-2687] Add network proximity needs based executor sorting method", "pr_createdAt": "2020-05-08T05:06:21Z", "pr_url": "https://github.com/apache/storm/pull/3265", "timeline": [{"oid": "fd7ecf35d029987501976a3488406c956cce374b", "url": "https://github.com/apache/storm/commit/fd7ecf35d029987501976a3488406c956cce374b", "message": "[STORM-2687] Add network proximity needs based executor sorting method", "committedDate": "2020-05-08T04:23:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjE5MTIyOA==", "url": "https://github.com/apache/storm/pull/3265#discussion_r422191228", "bodyText": "I think this would be good to add to defaults.yaml so users will see the value for their topology in the ui.  It might be nice to have schedule somewhere in the name, I think users might remember/see it more likely then.  Possibly topology.schedule.executors.by.proximity.needs?", "author": "agresch", "createdAt": "2020-05-08T14:56:00Z", "path": "storm-client/src/jvm/org/apache/storm/Config.java", "diffHunk": "@@ -312,6 +312,13 @@\n     // the topology.\n     public static final String TOPOLOGY_SCHEDULER_STRATEGY = \"topology.scheduler.strategy\";\n \n+    /**\n+     * When DefaultResourceAwareStrategy or GenericResourceAwareStrategy is used,\n+     * it will arrange unassigned executors based a particular order.\n+     * If this config is set to true, the arrangement will be made by network proximity needs.\n+     */\n+    public static final String TOPOLOGY_RAS_ORDER_EXECUTORS_BY_PROXIMITY_NEEDS = \"topology.ras.order.executors.by.proximity.needs\";", "originalCommit": "fd7ecf35d029987501976a3488406c956cce374b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjIyNzIzOA==", "url": "https://github.com/apache/storm/pull/3265#discussion_r422227238", "bodyText": "I was usingBoolean orderByProximity = (Boolean) td.getConf().getOrDefault(Config.TOPOLOGY_RAS_ORDER_EXECUTORS_BY_PROXIMITY_NEEDS, false); in BaseResourceAwareStrategy. That can also show this config in topology UI. Now I also added that to defaults.yaml as well\n\n\nChanged the name to include \"schedule\". I still keep \"ras\" since this is only used in RAS scheduling.", "author": "RuiLi8080", "createdAt": "2020-05-08T16:02:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjE5MTIyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTIxMDg2NQ==", "url": "https://github.com/apache/storm/pull/3265#discussion_r431210865", "bodyText": "Two places in the code set default values for the same config. Maybe we should delete this to avoid redundancy.", "author": "Ethanlm", "createdAt": "2020-05-27T15:02:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjE5MTIyOA=="}], "type": "inlineReview", "revised_code": {"commit": "06b3097560793f49536f572ac53993584f327938", "chunk": "diff --git a/storm-client/src/jvm/org/apache/storm/Config.java b/storm-client/src/jvm/org/apache/storm/Config.java\nindex c305a4f9f..d9d265fb2 100644\n--- a/storm-client/src/jvm/org/apache/storm/Config.java\n+++ b/storm-client/src/jvm/org/apache/storm/Config.java\n\n@@ -317,7 +317,7 @@ public class Config extends HashMap<String, Object> {\n      * it will arrange unassigned executors based a particular order.\n      * If this config is set to true, the arrangement will be made by network proximity needs.\n      */\n-    public static final String TOPOLOGY_RAS_ORDER_EXECUTORS_BY_PROXIMITY_NEEDS = \"topology.ras.order.executors.by.proximity.needs\";\n+    public static final String TOPOLOGY_RAS_SCHEDULE_EXECUTORS_BY_PROXIMITY_NEEDS = \"topology.ras.schedule.executors.by.proximity.needs\";\n \n     /**\n      * Declare scheduling constraints for a topology used by the constraint solver strategy. The format can be either\n"}}, {"oid": "06b3097560793f49536f572ac53993584f327938", "url": "https://github.com/apache/storm/commit/06b3097560793f49536f572ac53993584f327938", "message": "address comments", "committedDate": "2020-05-08T16:43:06Z", "type": "commit"}, {"oid": "06b3097560793f49536f572ac53993584f327938", "url": "https://github.com/apache/storm/commit/06b3097560793f49536f572ac53993584f327938", "message": "address comments", "committedDate": "2020-05-08T16:43:06Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDAwMjAyMw==", "url": "https://github.com/apache/storm/pull/3265#discussion_r424002023", "bodyText": "maybe a little more explanation on what it really is will help users", "author": "Ethanlm", "createdAt": "2020-05-12T20:07:33Z", "path": "storm-client/src/jvm/org/apache/storm/Config.java", "diffHunk": "@@ -312,6 +312,13 @@\n     // the topology.\n     public static final String TOPOLOGY_SCHEDULER_STRATEGY = \"topology.scheduler.strategy\";\n \n+    /**\n+     * When DefaultResourceAwareStrategy or GenericResourceAwareStrategy is used,\n+     * it will arrange unassigned executors based a particular order.\n+     * If this config is set to true, the arrangement will be made by network proximity needs.", "originalCommit": "06b3097560793f49536f572ac53993584f327938", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "7312eff13d0b71094fc9f94e6dc8499d26fe4344", "chunk": "diff --git a/storm-client/src/jvm/org/apache/storm/Config.java b/storm-client/src/jvm/org/apache/storm/Config.java\nindex d9d265fb2..c27b468c6 100644\n--- a/storm-client/src/jvm/org/apache/storm/Config.java\n+++ b/storm-client/src/jvm/org/apache/storm/Config.java\n\n@@ -314,10 +314,10 @@ public class Config extends HashMap<String, Object> {\n \n     /**\n      * When DefaultResourceAwareStrategy or GenericResourceAwareStrategy is used,\n-     * it will arrange unassigned executors based a particular order.\n-     * If this config is set to true, the arrangement will be made by network proximity needs.\n+     * scheduler will sort unassigned executors based on a particular order.\n+     * If this config is set to true, unassigned executors will be sorted by topological order with network proximity needs.\n      */\n-    public static final String TOPOLOGY_RAS_SCHEDULE_EXECUTORS_BY_PROXIMITY_NEEDS = \"topology.ras.schedule.executors.by.proximity.needs\";\n+    public static final String TOPOLOGY_RAS_ORDER_EXECUTORS_BY_PROXIMITY_NEEDS = \"topology.ras.order.executors.by.proximity.needs\";\n \n     /**\n      * Declare scheduling constraints for a topology used by the constraint solver strategy. The format can be either\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg2OTU1Mw==", "url": "https://github.com/apache/storm/pull/3265#discussion_r426869553", "bodyText": "We can use ObjectReader.getBoolean()", "author": "Ethanlm", "createdAt": "2020-05-18T20:15:31Z", "path": "storm-server/src/main/java/org/apache/storm/scheduler/resource/strategies/scheduling/BaseResourceAwareStrategy.java", "diffHunk": "@@ -511,6 +514,18 @@ protected String nodeToRack(RasNode node) {\n         return sortedComponents;\n     }\n \n+    protected List<ExecutorDetails> orderExecutors(\n+        TopologyDetails td, Collection<ExecutorDetails> unassignedExecutors) {\n+        Boolean orderByProximity = (Boolean) td.getConf()", "originalCommit": "06b3097560793f49536f572ac53993584f327938", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "7312eff13d0b71094fc9f94e6dc8499d26fe4344", "chunk": "diff --git a/storm-server/src/main/java/org/apache/storm/scheduler/resource/strategies/scheduling/BaseResourceAwareStrategy.java b/storm-server/src/main/java/org/apache/storm/scheduler/resource/strategies/scheduling/BaseResourceAwareStrategy.java\nindex 6ee702476..87345a0ce 100644\n--- a/storm-server/src/main/java/org/apache/storm/scheduler/resource/strategies/scheduling/BaseResourceAwareStrategy.java\n+++ b/storm-server/src/main/java/org/apache/storm/scheduler/resource/strategies/scheduling/BaseResourceAwareStrategy.java\n\n@@ -516,12 +517,12 @@ public abstract class BaseResourceAwareStrategy implements IStrategy {\n \n     protected List<ExecutorDetails> orderExecutors(\n         TopologyDetails td, Collection<ExecutorDetails> unassignedExecutors) {\n-        Boolean orderByProximity = (Boolean) td.getConf()\n-            .getOrDefault(Config.TOPOLOGY_RAS_SCHEDULE_EXECUTORS_BY_PROXIMITY_NEEDS, false);\n+        Boolean orderByProximity = ObjectReader.getBoolean(\n+            td.getConf().get(Config.TOPOLOGY_RAS_ORDER_EXECUTORS_BY_PROXIMITY_NEEDS), false);\n         if (!orderByProximity) {\n             return orderExecutorsDefault(td, unassignedExecutors);\n         } else {\n-            LOG.info(\"{} is set to true\", Config.TOPOLOGY_RAS_SCHEDULE_EXECUTORS_BY_PROXIMITY_NEEDS);\n+            LOG.info(\"{} is set to true\", Config.TOPOLOGY_RAS_ORDER_EXECUTORS_BY_PROXIMITY_NEEDS);\n             return orderExecutorsByProximityNeeds(td, unassignedExecutors);\n         }\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg3MjM4OA==", "url": "https://github.com/apache/storm/pull/3265#discussion_r426872388", "bodyText": "Maybe topology.ras.order.executors.by.proximity.needs has more accurate meaning. This only changes how the unassigned executors are sorted. How they are scheduled still depend on some other things too", "author": "Ethanlm", "createdAt": "2020-05-18T20:21:38Z", "path": "storm-client/src/jvm/org/apache/storm/Config.java", "diffHunk": "@@ -312,6 +312,13 @@\n     // the topology.\n     public static final String TOPOLOGY_SCHEDULER_STRATEGY = \"topology.scheduler.strategy\";\n \n+    /**\n+     * When DefaultResourceAwareStrategy or GenericResourceAwareStrategy is used,\n+     * it will arrange unassigned executors based a particular order.\n+     * If this config is set to true, the arrangement will be made by network proximity needs.\n+     */\n+    public static final String TOPOLOGY_RAS_SCHEDULE_EXECUTORS_BY_PROXIMITY_NEEDS = \"topology.ras.schedule.executors.by.proximity.needs\";", "originalCommit": "06b3097560793f49536f572ac53993584f327938", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUxMDIyMw==", "url": "https://github.com/apache/storm/pull/3265#discussion_r433510223", "bodyText": "Yes, fixed", "author": "RuiLi8080", "createdAt": "2020-06-01T21:52:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg3MjM4OA=="}], "type": "inlineReview", "revised_code": {"commit": "7312eff13d0b71094fc9f94e6dc8499d26fe4344", "chunk": "diff --git a/storm-client/src/jvm/org/apache/storm/Config.java b/storm-client/src/jvm/org/apache/storm/Config.java\nindex d9d265fb2..c27b468c6 100644\n--- a/storm-client/src/jvm/org/apache/storm/Config.java\n+++ b/storm-client/src/jvm/org/apache/storm/Config.java\n\n@@ -314,10 +314,10 @@ public class Config extends HashMap<String, Object> {\n \n     /**\n      * When DefaultResourceAwareStrategy or GenericResourceAwareStrategy is used,\n-     * it will arrange unassigned executors based a particular order.\n-     * If this config is set to true, the arrangement will be made by network proximity needs.\n+     * scheduler will sort unassigned executors based on a particular order.\n+     * If this config is set to true, unassigned executors will be sorted by topological order with network proximity needs.\n      */\n-    public static final String TOPOLOGY_RAS_SCHEDULE_EXECUTORS_BY_PROXIMITY_NEEDS = \"topology.ras.schedule.executors.by.proximity.needs\";\n+    public static final String TOPOLOGY_RAS_ORDER_EXECUTORS_BY_PROXIMITY_NEEDS = \"topology.ras.order.executors.by.proximity.needs\";\n \n     /**\n      * Declare scheduling constraints for a topology used by the constraint solver strategy. The format can be either\n"}}, {"oid": "7312eff13d0b71094fc9f94e6dc8499d26fe4344", "url": "https://github.com/apache/storm/commit/7312eff13d0b71094fc9f94e6dc8499d26fe4344", "message": "addressed comments", "committedDate": "2020-05-27T15:43:18Z", "type": "commit"}, {"oid": "7312eff13d0b71094fc9f94e6dc8499d26fe4344", "url": "https://github.com/apache/storm/commit/7312eff13d0b71094fc9f94e6dc8499d26fe4344", "message": "addressed comments", "committedDate": "2020-05-27T15:43:18Z", "type": "forcePushed"}, {"oid": "c79edc1719cdf7b86f63d956a9a378f4d05cddb2", "url": "https://github.com/apache/storm/commit/c79edc1719cdf7b86f63d956a9a378f4d05cddb2", "message": "address comment", "committedDate": "2020-06-01T21:51:35Z", "type": "commit"}]}