{"pr_number": 3237, "pr_title": "STORM-3259: Adds NUMA awareness to enable worker pinning", "pr_createdAt": "2020-03-25T22:54:55Z", "pr_url": "https://github.com/apache/storm/pull/3237", "timeline": [{"oid": "1e6e711e1c2fac5d54dc2a54ed423b7c3b45b9e0", "url": "https://github.com/apache/storm/commit/1e6e711e1c2fac5d54dc2a54ed423b7c3b45b9e0", "message": "STORM-3259: Adds NUMA awareness to enable worker pinning", "committedDate": "2020-03-26T16:59:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDk0ODkwMA==", "url": "https://github.com/apache/storm/pull/3237#discussion_r400948900", "bodyText": "port should just be int or Integer", "author": "Ethanlm", "createdAt": "2020-03-31T14:16:11Z", "path": "storm-client/src/jvm/org/apache/storm/utils/Utils.java", "diffHunk": "@@ -124,11 +124,47 @@\n     private static String memoizedLocalHostnameString = null;\n     public static final Pattern TOPOLOGY_KEY_PATTERN = Pattern.compile(\"^[\\\\w \\\\t\\\\._-]+$\", Pattern.UNICODE_CHARACTER_CLASS);\n \n+    public static final String NUMA_MEMORY_IN_MB = \"numa.memory.mb\";\n+    public static final String NUMA_CORES = \"numa.cores\";\n+    public static final String NUMA_PORTS = \"numa.ports\";\n+    public static final String NUMA_GENERIC_RESOURCES_MAP = \"numa.generic.resources.map\";\n+\n     static {\n         localConf = readStormConfig();\n         serializationDelegate = getSerializationDelegate(localConf);\n     }\n \n+    /**\n+     * Return supervisor numa configuration.\n+     * @param stormConf stormConf\n+     * @return getNumaMap\n+     */\n+    public static Map<String, Object> getNumaMap(Map<String, Object> stormConf) {\n+        Object numa = stormConf.get(Config.SUPERVISOR_NUMA_META);\n+        if (numa == null) {\n+            return Collections.emptyMap();\n+        }\n+        return (Map<String, Object>) numa;\n+    }\n+\n+    /**\n+     * getNumaIdForPort.\n+     * @param port port\n+     * @param stormConf stormConf\n+     * @return getNumaIdForPort\n+     */\n+    public static String getNumaIdForPort(Number port, Map<String, Object> stormConf) {", "originalCommit": "bde274c792efc3cea0eada85f9231236ff135554", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9514392cdf0de851e9bf4d45597aacb4c287ab4e", "chunk": "diff --git a/storm-client/src/jvm/org/apache/storm/utils/Utils.java b/storm-client/src/jvm/org/apache/storm/utils/Utils.java\nindex f9c569b76..80cf5d394 100644\n--- a/storm-client/src/jvm/org/apache/storm/utils/Utils.java\n+++ b/storm-client/src/jvm/org/apache/storm/utils/Utils.java\n\n@@ -153,10 +153,10 @@ public class Utils {\n      * @param stormConf stormConf\n      * @return getNumaIdForPort\n      */\n-    public static String getNumaIdForPort(Number port, Map<String, Object> stormConf) {\n+    public static String getNumaIdForPort(Integer port, Map<String, Object> stormConf) {\n         Map<String, Object> validatedNumaMap = getNumaMap(stormConf);\n         for (Entry<String, Object> numaEntry : validatedNumaMap.entrySet()) {\n-            Map numaMap  = (Map<String, Object>) numaEntry.getValue();\n+            Map<String, Object> numaMap  = (Map<String, Object>) numaEntry.getValue();\n             List<Integer> portList = (List<Integer>) numaMap.get(NUMA_PORTS);\n             if (portList.contains(port)) {\n                 return numaEntry.getKey();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDk0OTA3OQ==", "url": "https://github.com/apache/storm/pull/3237#discussion_r400949079", "bodyText": "Map should be Map<String, Object>", "author": "Ethanlm", "createdAt": "2020-03-31T14:16:24Z", "path": "storm-client/src/jvm/org/apache/storm/utils/Utils.java", "diffHunk": "@@ -124,11 +124,47 @@\n     private static String memoizedLocalHostnameString = null;\n     public static final Pattern TOPOLOGY_KEY_PATTERN = Pattern.compile(\"^[\\\\w \\\\t\\\\._-]+$\", Pattern.UNICODE_CHARACTER_CLASS);\n \n+    public static final String NUMA_MEMORY_IN_MB = \"numa.memory.mb\";\n+    public static final String NUMA_CORES = \"numa.cores\";\n+    public static final String NUMA_PORTS = \"numa.ports\";\n+    public static final String NUMA_GENERIC_RESOURCES_MAP = \"numa.generic.resources.map\";\n+\n     static {\n         localConf = readStormConfig();\n         serializationDelegate = getSerializationDelegate(localConf);\n     }\n \n+    /**\n+     * Return supervisor numa configuration.\n+     * @param stormConf stormConf\n+     * @return getNumaMap\n+     */\n+    public static Map<String, Object> getNumaMap(Map<String, Object> stormConf) {\n+        Object numa = stormConf.get(Config.SUPERVISOR_NUMA_META);\n+        if (numa == null) {\n+            return Collections.emptyMap();\n+        }\n+        return (Map<String, Object>) numa;\n+    }\n+\n+    /**\n+     * getNumaIdForPort.\n+     * @param port port\n+     * @param stormConf stormConf\n+     * @return getNumaIdForPort\n+     */\n+    public static String getNumaIdForPort(Number port, Map<String, Object> stormConf) {\n+        Map<String, Object> validatedNumaMap = getNumaMap(stormConf);\n+        for (Entry<String, Object> numaEntry : validatedNumaMap.entrySet()) {\n+            Map numaMap  = (Map<String, Object>) numaEntry.getValue();", "originalCommit": "bde274c792efc3cea0eada85f9231236ff135554", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9514392cdf0de851e9bf4d45597aacb4c287ab4e", "chunk": "diff --git a/storm-client/src/jvm/org/apache/storm/utils/Utils.java b/storm-client/src/jvm/org/apache/storm/utils/Utils.java\nindex f9c569b76..80cf5d394 100644\n--- a/storm-client/src/jvm/org/apache/storm/utils/Utils.java\n+++ b/storm-client/src/jvm/org/apache/storm/utils/Utils.java\n\n@@ -153,10 +153,10 @@ public class Utils {\n      * @param stormConf stormConf\n      * @return getNumaIdForPort\n      */\n-    public static String getNumaIdForPort(Number port, Map<String, Object> stormConf) {\n+    public static String getNumaIdForPort(Integer port, Map<String, Object> stormConf) {\n         Map<String, Object> validatedNumaMap = getNumaMap(stormConf);\n         for (Entry<String, Object> numaEntry : validatedNumaMap.entrySet()) {\n-            Map numaMap  = (Map<String, Object>) numaEntry.getValue();\n+            Map<String, Object> numaMap  = (Map<String, Object>) numaEntry.getValue();\n             List<Integer> portList = (List<Integer>) numaMap.get(NUMA_PORTS);\n             if (portList.contains(port)) {\n                 return numaEntry.getKey();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDk0OTg0NQ==", "url": "https://github.com/apache/storm/pull/3237#discussion_r400949845", "bodyText": "Map should be Map<String, Object>", "author": "Ethanlm", "createdAt": "2020-03-31T14:17:21Z", "path": "storm-client/src/jvm/org/apache/storm/validation/ConfigValidation.java", "diffHunk": "@@ -416,6 +423,41 @@ public void validateInteger(String name, Object o) {\n         }\n     }\n \n+    public static class NumaEntryValidator extends Validator {\n+\n+        @Override\n+        public void validateField(String name, Object o) {\n+            if (o == null) {\n+                return;\n+            }\n+            Map numa = (Map<String, Object>) o;", "originalCommit": "bde274c792efc3cea0eada85f9231236ff135554", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9514392cdf0de851e9bf4d45597aacb4c287ab4e", "chunk": "diff --git a/storm-client/src/jvm/org/apache/storm/validation/ConfigValidation.java b/storm-client/src/jvm/org/apache/storm/validation/ConfigValidation.java\nindex 402be2713..85d30a814 100644\n--- a/storm-client/src/jvm/org/apache/storm/validation/ConfigValidation.java\n+++ b/storm-client/src/jvm/org/apache/storm/validation/ConfigValidation.java\n\n@@ -430,7 +430,7 @@ public class ConfigValidation {\n             if (o == null) {\n                 return;\n             }\n-            Map numa = (Map<String, Object>) o;\n+            Map<String, Object> numa = (Map<String, Object>) o;\n             for (String key : new String[]{NUMA_CORES, NUMA_MEMORY_IN_MB, NUMA_PORTS}) {\n                 if (!numa.containsKey(key)) {\n                     throw new IllegalArgumentException(\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDk1MDc1Mg==", "url": "https://github.com/apache/storm/pull/3237#discussion_r400950752", "bodyText": "Set should be Set<Integer>;  HashSet should be HashSet<>", "author": "Ethanlm", "createdAt": "2020-03-31T14:18:29Z", "path": "storm-client/src/jvm/org/apache/storm/validation/ConfigValidation.java", "diffHunk": "@@ -416,6 +423,41 @@ public void validateInteger(String name, Object o) {\n         }\n     }\n \n+    public static class NumaEntryValidator extends Validator {\n+\n+        @Override\n+        public void validateField(String name, Object o) {\n+            if (o == null) {\n+                return;\n+            }\n+            Map numa = (Map<String, Object>) o;\n+            for (String key : new String[]{NUMA_CORES, NUMA_MEMORY_IN_MB, NUMA_PORTS}) {\n+                if (!numa.containsKey(key)) {\n+                    throw new IllegalArgumentException(\n+                            \"The numa configuration key [\" + key + \"] is missing!\"\n+                    );\n+                }\n+            }\n+\n+            List<Integer> cores = (List<Integer>) numa.get(NUMA_CORES);\n+            Set coreSet = new HashSet();", "originalCommit": "bde274c792efc3cea0eada85f9231236ff135554", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9514392cdf0de851e9bf4d45597aacb4c287ab4e", "chunk": "diff --git a/storm-client/src/jvm/org/apache/storm/validation/ConfigValidation.java b/storm-client/src/jvm/org/apache/storm/validation/ConfigValidation.java\nindex 402be2713..85d30a814 100644\n--- a/storm-client/src/jvm/org/apache/storm/validation/ConfigValidation.java\n+++ b/storm-client/src/jvm/org/apache/storm/validation/ConfigValidation.java\n\n@@ -430,7 +430,7 @@ public class ConfigValidation {\n             if (o == null) {\n                 return;\n             }\n-            Map numa = (Map<String, Object>) o;\n+            Map<String, Object> numa = (Map<String, Object>) o;\n             for (String key : new String[]{NUMA_CORES, NUMA_MEMORY_IN_MB, NUMA_PORTS}) {\n                 if (!numa.containsKey(key)) {\n                     throw new IllegalArgumentException(\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDk1MjU0Mg==", "url": "https://github.com/apache/storm/pull/3237#discussion_r400952542", "bodyText": "initialization can be removed here", "author": "Ethanlm", "createdAt": "2020-03-31T14:20:38Z", "path": "storm-server/src/main/java/org/apache/storm/container/cgroup/CgroupManager.java", "diffHunk": "@@ -50,6 +54,7 @@\n     private CgroupCommon rootCgroup;\n     private String rootDir;\n     private Map<String, Object> conf;\n+    protected Map<String, Object> validatedNumaMap = new ConcurrentHashMap();", "originalCommit": "bde274c792efc3cea0eada85f9231236ff135554", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "55917162935041ab0efc027890926b077122db38", "chunk": "diff --git a/storm-server/src/main/java/org/apache/storm/container/cgroup/CgroupManager.java b/storm-server/src/main/java/org/apache/storm/container/cgroup/CgroupManager.java\nindex 0d1be7e85..cc6c2b5c3 100644\n--- a/storm-server/src/main/java/org/apache/storm/container/cgroup/CgroupManager.java\n+++ b/storm-server/src/main/java/org/apache/storm/container/cgroup/CgroupManager.java\n\n@@ -54,6 +55,7 @@ public class CgroupManager implements ResourceIsolationInterface {\n     private CgroupCommon rootCgroup;\n     private String rootDir;\n     private Map<String, Object> conf;\n+    private Map<String, String> workerToNumaId = new ConcurrentHashMap();\n     protected Map<String, Object> validatedNumaMap = new ConcurrentHashMap();\n \n     static long getMemInfoFreeMb() throws IOException {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDk2NzA3NQ==", "url": "https://github.com/apache/storm/pull/3237#discussion_r400967075", "bodyText": "This changes Container attribute supervisorId when it mkLaunchCommand, which means the supervisorId is different depending on whether it calles mkLaunchCommand or not. I am afraid it might introduce confusions.", "author": "Ethanlm", "createdAt": "2020-03-31T14:39:14Z", "path": "storm-server/src/main/java/org/apache/storm/daemon/supervisor/BasicContainer.java", "diffHunk": "@@ -665,8 +666,10 @@ protected String javaCmd(String cmd) {\n         commandList.addAll(classPathParams);\n         commandList.add(getWorkerMain(topoVersion));\n         commandList.add(topologyId);\n+        if (numaId != null) {\n+            supervisorId += Constants.NUMA_ID_SEPARATOR + numaId;", "originalCommit": "bde274c792efc3cea0eada85f9231236ff135554", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTIyNzUzNw==", "url": "https://github.com/apache/storm/pull/3237#discussion_r401227537", "bodyText": "The mkLaunchCommand is in BasicContainer - is there a situation where it wouldn't be called?", "author": "govind-menon", "createdAt": "2020-03-31T21:31:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDk2NzA3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI0MDIzOQ==", "url": "https://github.com/apache/storm/pull/3237#discussion_r401240239", "bodyText": "I mostly worried about the order. If it's not called yet but accessed somewhere else, the result can be unexpected. We shouldn't implicitly change the meaning of the attribute supervisorId. If we want to attach \"numa\" to it, do it as earliest as possible so we know everywhere we see a supervisorId in Container, it has \"numa\"", "author": "Ethanlm", "createdAt": "2020-03-31T21:58:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDk2NzA3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzA4NTA3MA==", "url": "https://github.com/apache/storm/pull/3237#discussion_r403085070", "bodyText": "I'm putting this back here - there could be/are multiple implementations for how a ResourceIsolation manager could implement NUMA pinning but the supervisor ID MUST contain the numa id in the current implementation. But this supervisor id is effectively only used when the worker is launched. I feel it is appropriate to keep it here so that it's explicitly used as opposed to a super constructor where it can be missed when future changes are maded", "author": "govind-menon", "createdAt": "2020-04-03T15:26:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDk2NzA3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDg0MTQzNQ==", "url": "https://github.com/apache/storm/pull/3237#discussion_r404841435", "bodyText": "This way is also fine.  Originally it was\nif (numaId != null) {\n           this.supervisorId += Constants.NUMA_ID_SEPARATOR + numaId;\n}\n\nand it changed this.supervisorId.\nCurrently this.supervisorId is not changed, so it is fine.", "author": "Ethanlm", "createdAt": "2020-04-07T14:13:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDk2NzA3NQ=="}], "type": "inlineReview", "revised_code": {"commit": "01dbf8a06b8d3fe1205794aa69f4091e0783cd07", "chunk": "diff --git a/storm-server/src/main/java/org/apache/storm/daemon/supervisor/BasicContainer.java b/storm-server/src/main/java/org/apache/storm/daemon/supervisor/BasicContainer.java\nindex 3a26a0de5..de9412dfc 100644\n--- a/storm-server/src/main/java/org/apache/storm/daemon/supervisor/BasicContainer.java\n+++ b/storm-server/src/main/java/org/apache/storm/daemon/supervisor/BasicContainer.java\n\n@@ -666,9 +666,6 @@ public class BasicContainer extends Container {\n         commandList.addAll(classPathParams);\n         commandList.add(getWorkerMain(topoVersion));\n         commandList.add(topologyId);\n-        if (numaId != null) {\n-            supervisorId += Constants.NUMA_ID_SEPARATOR + numaId;\n-        }\n         commandList.add(supervisorId);\n         // supervisor port should be only presented to worker which supports RPC heartbeat\n         // unknown version should be treated as \"current version\", which supports RPC heartbeat\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDk5MjIzOA==", "url": "https://github.com/apache/storm/pull/3237#discussion_r400992238", "bodyText": "Is this a different implementation than what we have internally?\nInternally you used numactl. Here seems to be using cgroup directly. Is this well tested?", "author": "Ethanlm", "createdAt": "2020-03-31T15:10:53Z", "path": "storm-server/src/main/java/org/apache/storm/container/cgroup/CgroupManager.java", "diffHunk": "@@ -203,6 +209,30 @@ public void reserveResourcesForWorker(String workerId, Integer totalMem, Integer\n             }\n         }\n \n+        if (numaId != null) {", "originalCommit": "bde274c792efc3cea0eada85f9231236ff135554", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "571a758f6bd8016d47c7032c3519665c75109641", "chunk": "diff --git a/storm-server/src/main/java/org/apache/storm/container/cgroup/CgroupManager.java b/storm-server/src/main/java/org/apache/storm/container/cgroup/CgroupManager.java\nindex 0d1be7e85..21c98e6aa 100644\n--- a/storm-server/src/main/java/org/apache/storm/container/cgroup/CgroupManager.java\n+++ b/storm-server/src/main/java/org/apache/storm/container/cgroup/CgroupManager.java\n\n@@ -208,31 +212,7 @@ public class CgroupManager implements ResourceIsolationInterface {\n                 }\n             }\n         }\n-\n-        if (numaId != null) {\n-            Map<String, Object> numaIdEntry = (Map<String, Object>) validatedNumaMap.get(numaId);\n-            List<String> rawCores = ((List<Integer>) numaIdEntry.get(Utils.NUMA_CORES)).stream()\n-                    .map(rawCore -> String.valueOf(rawCore)).collect(Collectors.toList());\n-            CpusetCore cpusetCore = (CpusetCore) workerGroup.getCores().get(SubSystemType.cpuset);\n-\n-            try {\n-                cpusetCore.setCpus(\n-                        rawCores.stream().map(cpuString -> Integer.getInteger(cpuString)).mapToInt(i -> i.intValue()).toArray()\n-                );\n-            } catch (IOException e) {\n-                throw new RuntimeException(\"Cannot set cpuset.cpus! Exception: \", e);\n-            }\n-\n-            try {\n-\n-                cpusetCore.setMems(Collections.singletonList(\n-                        Integer.valueOf(numaId)\n-                ).stream().mapToInt(i -> i.intValue()).toArray());\n-            } catch (IOException e) {\n-                throw new RuntimeException(\"Cannot set cpuset.mems! Exception: \", e);\n-            }\n-        }\n-\n+        \n         if ((boolean) this.conf.get(DaemonConfig.STORM_CGROUP_INHERIT_CPUSET_CONFIGS)) {\n             if (workerGroup.getParent().getCores().containsKey(SubSystemType.cpuset)) {\n                 CpusetCore parentCpusetCore = (CpusetCore) workerGroup.getParent().getCores().get(SubSystemType.cpuset);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDk5Mjg0OQ==", "url": "https://github.com/apache/storm/pull/3237#discussion_r400992849", "bodyText": "Should be Map<String, Object>,  HashMap<>", "author": "Ethanlm", "createdAt": "2020-03-31T15:11:41Z", "path": "storm-server/src/test/java/org/apache/storm/TestCgroups.java", "diffHunk": "@@ -43,6 +45,16 @@\n     public void testSetupAndTearDown() throws IOException {\n         Config config = new Config();\n         config.putAll(Utils.readDefaultConfig());\n+\n+        Map numaNode = new HashMap();", "originalCommit": "bde274c792efc3cea0eada85f9231236ff135554", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9514392cdf0de851e9bf4d45597aacb4c287ab4e", "chunk": "diff --git a/storm-server/src/test/java/org/apache/storm/TestCgroups.java b/storm-server/src/test/java/org/apache/storm/TestCgroups.java\nindex ef2e8b1bc..e6794e6f4 100644\n--- a/storm-server/src/test/java/org/apache/storm/TestCgroups.java\n+++ b/storm-server/src/test/java/org/apache/storm/TestCgroups.java\n\n@@ -46,15 +46,7 @@ public class TestCgroups {\n         Config config = new Config();\n         config.putAll(Utils.readDefaultConfig());\n \n-        Map numaNode = new HashMap();\n-        numaNode.put(Utils.NUMA_CORES, Collections.singletonList(\"0\"));\n-        numaNode.put(Utils.NUMA_PORTS, Collections.singletonList(8081));\n-        numaNode.put(Utils.NUMA_MEMORY_IN_MB, 2048);\n-        Map numaMap = new HashMap();\n-        numaMap.put(\"0\", numaNode);\n-\n-        config.put(Config.SUPERVISOR_NUMA_META, numaMap);\n-\n+        \n         //We don't want to run the test is CGroups are not setup\n         Assume\n             .assumeTrue(\"Check if CGroups are setup\", ((boolean) config.get(DaemonConfig.STORM_RESOURCE_ISOLATION_PLUGIN_ENABLE)) == true);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDk5NDIzMA==", "url": "https://github.com/apache/storm/pull/3237#discussion_r400994230", "bodyText": "This should include key/value type too.", "author": "Ethanlm", "createdAt": "2020-03-31T15:13:27Z", "path": "storm-server/src/test/java/org/apache/storm/TestCgroups.java", "diffHunk": "@@ -43,6 +45,16 @@\n     public void testSetupAndTearDown() throws IOException {\n         Config config = new Config();\n         config.putAll(Utils.readDefaultConfig());\n+\n+        Map numaNode = new HashMap();\n+        numaNode.put(Utils.NUMA_CORES, Collections.singletonList(\"0\"));\n+        numaNode.put(Utils.NUMA_PORTS, Collections.singletonList(8081));\n+        numaNode.put(Utils.NUMA_MEMORY_IN_MB, 2048);\n+        Map numaMap = new HashMap();", "originalCommit": "bde274c792efc3cea0eada85f9231236ff135554", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9514392cdf0de851e9bf4d45597aacb4c287ab4e", "chunk": "diff --git a/storm-server/src/test/java/org/apache/storm/TestCgroups.java b/storm-server/src/test/java/org/apache/storm/TestCgroups.java\nindex ef2e8b1bc..e6794e6f4 100644\n--- a/storm-server/src/test/java/org/apache/storm/TestCgroups.java\n+++ b/storm-server/src/test/java/org/apache/storm/TestCgroups.java\n\n@@ -46,15 +46,7 @@ public class TestCgroups {\n         Config config = new Config();\n         config.putAll(Utils.readDefaultConfig());\n \n-        Map numaNode = new HashMap();\n-        numaNode.put(Utils.NUMA_CORES, Collections.singletonList(\"0\"));\n-        numaNode.put(Utils.NUMA_PORTS, Collections.singletonList(8081));\n-        numaNode.put(Utils.NUMA_MEMORY_IN_MB, 2048);\n-        Map numaMap = new HashMap();\n-        numaMap.put(\"0\", numaNode);\n-\n-        config.put(Config.SUPERVISOR_NUMA_META, numaMap);\n-\n+        \n         //We don't want to run the test is CGroups are not setup\n         Assume\n             .assumeTrue(\"Check if CGroups are setup\", ((boolean) config.get(DaemonConfig.STORM_RESOURCE_ISOLATION_PLUGIN_ENABLE)) == true);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDk3MTg0Ng==", "url": "https://github.com/apache/storm/pull/3237#discussion_r400971846", "bodyText": "Seems like all these file changes might be better added to SupervisorUtils?", "author": "agresch", "createdAt": "2020-03-31T14:45:09Z", "path": "storm-client/src/jvm/org/apache/storm/utils/Utils.java", "diffHunk": "@@ -124,11 +124,47 @@\n     private static String memoizedLocalHostnameString = null;\n     public static final Pattern TOPOLOGY_KEY_PATTERN = Pattern.compile(\"^[\\\\w \\\\t\\\\._-]+$\", Pattern.UNICODE_CHARACTER_CLASS);\n \n+    public static final String NUMA_MEMORY_IN_MB = \"numa.memory.mb\";\n+    public static final String NUMA_CORES = \"numa.cores\";\n+    public static final String NUMA_PORTS = \"numa.ports\";\n+    public static final String NUMA_GENERIC_RESOURCES_MAP = \"numa.generic.resources.map\";\n+\n     static {\n         localConf = readStormConfig();\n         serializationDelegate = getSerializationDelegate(localConf);\n     }\n \n+    /**\n+     * Return supervisor numa configuration.\n+     * @param stormConf stormConf\n+     * @return getNumaMap\n+     */\n+    public static Map<String, Object> getNumaMap(Map<String, Object> stormConf) {", "originalCommit": "bde274c792efc3cea0eada85f9231236ff135554", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTIyNTU1Mw==", "url": "https://github.com/apache/storm/pull/3237#discussion_r401225553", "bodyText": "These are used in the client side to do topology configuration so I think it's better to keep it here", "author": "govind-menon", "createdAt": "2020-03-31T21:27:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDk3MTg0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTY1MDA1Mg==", "url": "https://github.com/apache/storm/pull/3237#discussion_r401650052", "bodyText": "That makes sense.", "author": "agresch", "createdAt": "2020-04-01T14:16:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDk3MTg0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMyMTM4Ng==", "url": "https://github.com/apache/storm/pull/3237#discussion_r406321386", "bodyText": "As I looked again, I realized getNumaMap is only used in storm-server and Aaron's previous makes sense", "author": "Ethanlm", "createdAt": "2020-04-09T16:19:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDk3MTg0Ng=="}], "type": "inlineReview", "revised_code": {"commit": "9514392cdf0de851e9bf4d45597aacb4c287ab4e", "chunk": "diff --git a/storm-client/src/jvm/org/apache/storm/utils/Utils.java b/storm-client/src/jvm/org/apache/storm/utils/Utils.java\nindex f9c569b76..80cf5d394 100644\n--- a/storm-client/src/jvm/org/apache/storm/utils/Utils.java\n+++ b/storm-client/src/jvm/org/apache/storm/utils/Utils.java\n\n@@ -153,10 +153,10 @@ public class Utils {\n      * @param stormConf stormConf\n      * @return getNumaIdForPort\n      */\n-    public static String getNumaIdForPort(Number port, Map<String, Object> stormConf) {\n+    public static String getNumaIdForPort(Integer port, Map<String, Object> stormConf) {\n         Map<String, Object> validatedNumaMap = getNumaMap(stormConf);\n         for (Entry<String, Object> numaEntry : validatedNumaMap.entrySet()) {\n-            Map numaMap  = (Map<String, Object>) numaEntry.getValue();\n+            Map<String, Object> numaMap  = (Map<String, Object>) numaEntry.getValue();\n             List<Integer> portList = (List<Integer>) numaMap.get(NUMA_PORTS);\n             if (portList.contains(port)) {\n                 return numaEntry.getKey();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDk3NjI3OA==", "url": "https://github.com/apache/storm/pull/3237#discussion_r400976278", "bodyText": "I think we should add a doc describing this feature.", "author": "agresch", "createdAt": "2020-03-31T14:50:34Z", "path": "storm-client/src/jvm/org/apache/storm/Config.java", "diffHunk": "@@ -1096,6 +1096,24 @@\n     @IsPositiveNumber\n     @NotNull\n     public static final String SUPERVISOR_WORKER_TIMEOUT_SECS = \"supervisor.worker.timeout.secs\";\n+\n+    /**\n+     * A map with keys mapped to each NUMA Node on the supervisor that will be used", "originalCommit": "bde274c792efc3cea0eada85f9231236ff135554", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTIyMjcxOQ==", "url": "https://github.com/apache/storm/pull/3237#discussion_r401222719", "bodyText": "I'll put up a different PR for the documentation", "author": "govind-menon", "createdAt": "2020-03-31T21:21:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDk3NjI3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTY0ODYzMw==", "url": "https://github.com/apache/storm/pull/3237#discussion_r401648633", "bodyText": "Can we add a tracking JIRA?", "author": "agresch", "createdAt": "2020-04-01T14:14:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDk3NjI3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg5MzEwMA==", "url": "https://github.com/apache/storm/pull/3237#discussion_r401893100", "bodyText": "https://issues.apache.org/jira/browse/STORM-3615", "author": "govind-menon", "createdAt": "2020-04-01T20:35:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDk3NjI3OA=="}], "type": "inlineReview", "revised_code": {"commit": "9809635d75c3edb11adfb4f539cc40b7ef8f1503", "chunk": "diff --git a/storm-client/src/jvm/org/apache/storm/Config.java b/storm-client/src/jvm/org/apache/storm/Config.java\nindex 16468250e..64045a023 100644\n--- a/storm-client/src/jvm/org/apache/storm/Config.java\n+++ b/storm-client/src/jvm/org/apache/storm/Config.java\n\n@@ -1096,24 +1096,6 @@ public class Config extends HashMap<String, Object> {\n     @IsPositiveNumber\n     @NotNull\n     public static final String SUPERVISOR_WORKER_TIMEOUT_SECS = \"supervisor.worker.timeout.secs\";\n-\n-    /**\n-     * A map with keys mapped to each NUMA Node on the supervisor that will be used\n-     * by scheduler. CPUs, memory and ports available on each NUMA node will be provided.\n-     * Each supervisor will have different map of NUMAs.\n-     * Example: \"supervisor.numa.meta\": {\n-     *  \"0\": { \"numa.memory.mb\": 122880, \"numa.cores\": [ 0, 12, 1, 13, 2, 14, 3, 15, 4, 16, 5, 17],\n-     *      \"numa.ports\": [6700, 6701]},\n-     *  \"1\" : {\"numa.memory.mb\": 122880, \"numa.cores\": [ 6, 18, 7, 19, 8, 20, 9, 21, 10, 22, 11, 23],\n-     *      \"numa.ports\": [6702, 6703], \"numa.generic.resources.map\": {\"gpu.count\" : 1}}\n-     *  }\n-     */\n-    @IsMapEntryCustom(\n-            keyValidatorClasses = { ConfigValidation.StringValidator.class },\n-            valueValidatorClasses = { ConfigValidation.NumaEntryValidator.class}\n-    )\n-    public static final String SUPERVISOR_NUMA_META = \"supervisor.numa.meta\";\n-\n     /**\n      * Enforce maximum on {@link #TOPOLOGY_WORKER_TIMEOUT_SECS}.\n      */\n"}}, {"oid": "55917162935041ab0efc027890926b077122db38", "url": "https://github.com/apache/storm/commit/55917162935041ab0efc027890926b077122db38", "message": "STORM-3259: Properly sends supervisor assignments on topology kill. Originally done by Aaron Gresch.", "committedDate": "2020-03-31T21:18:28Z", "type": "forcePushed"}, {"oid": "9514392cdf0de851e9bf4d45597aacb4c287ab4e", "url": "https://github.com/apache/storm/commit/9514392cdf0de851e9bf4d45597aacb4c287ab4e", "message": "STORM-3259: Addresses review comments on NUMA pinning", "committedDate": "2020-03-31T21:33:06Z", "type": "forcePushed"}, {"oid": "8b5363ef7bd30ca4a27ed64b1a4bd524fe45e1af", "url": "https://github.com/apache/storm/commit/8b5363ef7bd30ca4a27ed64b1a4bd524fe45e1af", "message": "STORM-3259: Addresses review comments on NUMA pinning", "committedDate": "2020-03-31T21:34:27Z", "type": "forcePushed"}, {"oid": "cceb0e1152a4935d8cc48847a74eb2ed88cb7d61", "url": "https://github.com/apache/storm/commit/cceb0e1152a4935d8cc48847a74eb2ed88cb7d61", "message": "STORM-3259: Addresses review comments on NUMA pinning", "committedDate": "2020-03-31T21:35:05Z", "type": "forcePushed"}, {"oid": "571a758f6bd8016d47c7032c3519665c75109641", "url": "https://github.com/apache/storm/commit/571a758f6bd8016d47c7032c3519665c75109641", "message": "STORM-3259: Addresses review comments on NUMA pinning", "committedDate": "2020-03-31T21:57:11Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTY1MTg2OQ==", "url": "https://github.com/apache/storm/pull/3237#discussion_r401651869", "bodyText": "This one seems to be used only in storm-server.  Can we make this one SupervisorUtils?\nPlease update the java doc to indicate this is specific to a single supervisor.  stormConf could be renamed supervisorConf for clarity on this.", "author": "agresch", "createdAt": "2020-04-01T14:19:21Z", "path": "storm-client/src/jvm/org/apache/storm/utils/Utils.java", "diffHunk": "@@ -124,11 +124,47 @@\n     private static String memoizedLocalHostnameString = null;\n     public static final Pattern TOPOLOGY_KEY_PATTERN = Pattern.compile(\"^[\\\\w \\\\t\\\\._-]+$\", Pattern.UNICODE_CHARACTER_CLASS);\n \n+    public static final String NUMA_MEMORY_IN_MB = \"numa.memory.mb\";\n+    public static final String NUMA_CORES = \"numa.cores\";\n+    public static final String NUMA_PORTS = \"numa.ports\";\n+    public static final String NUMA_GENERIC_RESOURCES_MAP = \"numa.generic.resources.map\";\n+\n     static {\n         localConf = readStormConfig();\n         serializationDelegate = getSerializationDelegate(localConf);\n     }\n \n+    /**\n+     * Return supervisor numa configuration.\n+     * @param stormConf stormConf\n+     * @return getNumaMap\n+     */\n+    public static Map<String, Object> getNumaMap(Map<String, Object> stormConf) {\n+        Object numa = stormConf.get(Config.SUPERVISOR_NUMA_META);\n+        if (numa == null) {\n+            return Collections.emptyMap();\n+        }\n+        return (Map<String, Object>) numa;\n+    }\n+\n+    /**\n+     * getNumaIdForPort.", "originalCommit": "571a758f6bd8016d47c7032c3519665c75109641", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg0NzQwMQ==", "url": "https://github.com/apache/storm/pull/3237#discussion_r401847401", "bodyText": "https://issues.apache.org/jira/browse/STORM-3615", "author": "govind-menon", "createdAt": "2020-04-01T19:11:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTY1MTg2OQ=="}], "type": "inlineReview", "revised_code": {"commit": "01dbf8a06b8d3fe1205794aa69f4091e0783cd07", "chunk": "diff --git a/storm-client/src/jvm/org/apache/storm/utils/Utils.java b/storm-client/src/jvm/org/apache/storm/utils/Utils.java\nindex 80cf5d394..31253fe8d 100644\n--- a/storm-client/src/jvm/org/apache/storm/utils/Utils.java\n+++ b/storm-client/src/jvm/org/apache/storm/utils/Utils.java\n\n@@ -147,24 +147,6 @@ public class Utils {\n         return (Map<String, Object>) numa;\n     }\n \n-    /**\n-     * getNumaIdForPort.\n-     * @param port port\n-     * @param stormConf stormConf\n-     * @return getNumaIdForPort\n-     */\n-    public static String getNumaIdForPort(Integer port, Map<String, Object> stormConf) {\n-        Map<String, Object> validatedNumaMap = getNumaMap(stormConf);\n-        for (Entry<String, Object> numaEntry : validatedNumaMap.entrySet()) {\n-            Map<String, Object> numaMap  = (Map<String, Object>) numaEntry.getValue();\n-            List<Integer> portList = (List<Integer>) numaMap.get(NUMA_PORTS);\n-            if (portList.contains(port)) {\n-                return numaEntry.getKey();\n-            }\n-        }\n-        return null;\n-    }\n-\n     /**\n      * Provide an instance of this class for delegates to use.  To mock out delegated methods, provide an instance of a subclass that\n      * overrides the implementation of the delegated method.\n"}}, {"oid": "01dbf8a06b8d3fe1205794aa69f4091e0783cd07", "url": "https://github.com/apache/storm/commit/01dbf8a06b8d3fe1205794aa69f4091e0783cd07", "message": "STORM-3259: Addresses 2nd round of review comments", "committedDate": "2020-04-01T20:37:05Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjYxNDU4OQ==", "url": "https://github.com/apache/storm/pull/3237#discussion_r402614589", "bodyText": "L112 and L114 conflict.  And validatedNumaMap doesn't seem to be used anywhere", "author": "Ethanlm", "createdAt": "2020-04-02T21:46:10Z", "path": "storm-server/src/main/java/org/apache/storm/container/cgroup/CgroupManager.java", "diffHunk": "@@ -102,6 +109,9 @@ public void prepare(Map<String, Object> conf) throws IOException {\n             throw new RuntimeException(\"Cgroup error, please check /proc/cgroups\");\n         }\n         this.prepareSubSystem(this.conf);\n+        validatedNumaMap = Utils.getNumaMap(conf);\n+        workerToNumaId = new ConcurrentHashMap();\n+        validatedNumaMap = new ConcurrentHashMap();", "originalCommit": "01dbf8a06b8d3fe1205794aa69f4091e0783cd07", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "390a97a47faae8383aee4e9821d444225f1d6649", "chunk": "diff --git a/storm-server/src/main/java/org/apache/storm/container/cgroup/CgroupManager.java b/storm-server/src/main/java/org/apache/storm/container/cgroup/CgroupManager.java\nindex 21c98e6aa..e81cc4c10 100644\n--- a/storm-server/src/main/java/org/apache/storm/container/cgroup/CgroupManager.java\n+++ b/storm-server/src/main/java/org/apache/storm/container/cgroup/CgroupManager.java\n\n@@ -111,7 +111,6 @@ public class CgroupManager implements ResourceIsolationInterface {\n         this.prepareSubSystem(this.conf);\n         validatedNumaMap = Utils.getNumaMap(conf);\n         workerToNumaId = new ConcurrentHashMap();\n-        validatedNumaMap = new ConcurrentHashMap();\n     }\n \n     /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjYxNTE5Mw==", "url": "https://github.com/apache/storm/pull/3237#discussion_r402615193", "bodyText": "missing @param numaId", "author": "Ethanlm", "createdAt": "2020-04-02T21:47:32Z", "path": "storm-server/src/main/java/org/apache/storm/container/ResourceIsolationInterface.java", "diffHunk": "@@ -37,7 +37,7 @@\n      * @param workerMemory the amount of memory for the worker or null if not enforced\n      * @param workerCpu the amount of cpu for the worker or null if not enforced\n      */\n-    void reserveResourcesForWorker(String workerId, Integer workerMemory, Integer workerCpu);\n+    void reserveResourcesForWorker(String workerId, Integer workerMemory, Integer workerCpu, String numaId);", "originalCommit": "01dbf8a06b8d3fe1205794aa69f4091e0783cd07", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzA3NDg0MQ==", "url": "https://github.com/apache/storm/pull/3237#discussion_r403074841", "bodyText": "Added", "author": "govind-menon", "createdAt": "2020-04-03T15:10:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjYxNTE5Mw=="}], "type": "inlineReview", "revised_code": {"commit": "390a97a47faae8383aee4e9821d444225f1d6649", "chunk": "diff --git a/storm-server/src/main/java/org/apache/storm/container/ResourceIsolationInterface.java b/storm-server/src/main/java/org/apache/storm/container/ResourceIsolationInterface.java\nindex 1f665943f..ae30c290d 100644\n--- a/storm-server/src/main/java/org/apache/storm/container/ResourceIsolationInterface.java\n+++ b/storm-server/src/main/java/org/apache/storm/container/ResourceIsolationInterface.java\n\n@@ -36,6 +36,7 @@ public interface ResourceIsolationInterface {\n      * @param workerId worker id of the worker to start\n      * @param workerMemory the amount of memory for the worker or null if not enforced\n      * @param workerCpu the amount of cpu for the worker or null if not enforced\n+     * @param numaId NUMA zone if applicable the worker should be bound to\n      */\n     void reserveResourcesForWorker(String workerId, Integer workerMemory, Integer workerCpu, String numaId);\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjYxNzkwNA==", "url": "https://github.com/apache/storm/pull/3237#discussion_r402617904", "bodyText": "numaId not used anywhere?", "author": "Ethanlm", "createdAt": "2020-04-02T21:53:41Z", "path": "storm-server/src/main/java/org/apache/storm/daemon/supervisor/BasicContainer.java", "diffHunk": "@@ -615,7 +616,7 @@ protected String javaCmd(String cmd) {\n      * @throws IOException on any error.\n      */\n     private List<String> mkLaunchCommand(final int memOnheap, final String stormRoot,\n-                                         final String jlp) throws IOException {\n+                                         final String jlp, final String numaId) throws IOException {", "originalCommit": "01dbf8a06b8d3fe1205794aa69f4091e0783cd07", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "390a97a47faae8383aee4e9821d444225f1d6649", "url": "https://github.com/apache/storm/commit/390a97a47faae8383aee4e9821d444225f1d6649", "message": "STORM-3259: Addresses 2nd round of review comments", "committedDate": "2020-04-03T15:09:26Z", "type": "forcePushed"}, {"oid": "1a88d046ea8f92de7e064640a6317b6dc1fe3669", "url": "https://github.com/apache/storm/commit/1a88d046ea8f92de7e064640a6317b6dc1fe3669", "message": "STORM-3259: Addresses 2nd round of review comments", "committedDate": "2020-04-03T15:19:46Z", "type": "forcePushed"}, {"oid": "f45951c16f42c82d6f59d63db368dc0994c6d4e0", "url": "https://github.com/apache/storm/commit/f45951c16f42c82d6f59d63db368dc0994c6d4e0", "message": "STORM-3259: Addresses 2nd round of review comments", "committedDate": "2020-04-06T19:33:42Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDg1MTIyOA==", "url": "https://github.com/apache/storm/pull/3237#discussion_r404851228", "bodyText": "This should be removed according to the change in BasicContainer. mkLaunchCommand", "author": "Ethanlm", "createdAt": "2020-04-07T14:25:43Z", "path": "storm-server/src/main/java/org/apache/storm/daemon/supervisor/Container.java", "diffHunk": "@@ -130,6 +131,10 @@ protected Container(ContainerType type, Map<String, Object> conf, String supervi\n         this.ops = ops;\n         this.conf = conf;\n         this.supervisorId = supervisorId;\n+        String numaId = SupervisorUtils.getNumaIdForPort(port, conf);\n+        if (numaId != null) {\n+            this.supervisorId +=  Constants.NUMA_ID_SEPARATOR + numaId;", "originalCommit": "f45951c16f42c82d6f59d63db368dc0994c6d4e0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "10a2d1c03de04ea85e59184e0eff6d3a6a0ec6d7", "chunk": "diff --git a/storm-server/src/main/java/org/apache/storm/daemon/supervisor/Container.java b/storm-server/src/main/java/org/apache/storm/daemon/supervisor/Container.java\nindex d304517ba..a80d2519e 100644\n--- a/storm-server/src/main/java/org/apache/storm/daemon/supervisor/Container.java\n+++ b/storm-server/src/main/java/org/apache/storm/daemon/supervisor/Container.java\n\n@@ -131,10 +131,6 @@ public abstract class Container implements Killable {\n         this.ops = ops;\n         this.conf = conf;\n         this.supervisorId = supervisorId;\n-        String numaId = SupervisorUtils.getNumaIdForPort(port, conf);\n-        if (numaId != null) {\n-            this.supervisorId +=  Constants.NUMA_ID_SEPARATOR + numaId;\n-        }\n         this.supervisorPort = supervisorPort;\n         this.resourceIsolationManager = resourceIsolationManager;\n         this.assignment = assignment;\n"}}, {"oid": "10a2d1c03de04ea85e59184e0eff6d3a6a0ec6d7", "url": "https://github.com/apache/storm/commit/10a2d1c03de04ea85e59184e0eff6d3a6a0ec6d7", "message": "STORM-3259: Addresses 2nd round of review comments", "committedDate": "2020-04-07T15:23:06Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTAwNDY0OQ==", "url": "https://github.com/apache/storm/pull/3237#discussion_r405004649", "bodyText": "Is this used anywhere?", "author": "Ethanlm", "createdAt": "2020-04-07T17:57:49Z", "path": "storm-server/src/main/java/org/apache/storm/container/cgroup/CgroupManager.java", "diffHunk": "@@ -102,6 +109,8 @@ public void prepare(Map<String, Object> conf) throws IOException {\n             throw new RuntimeException(\"Cgroup error, please check /proc/cgroups\");\n         }\n         this.prepareSubSystem(this.conf);\n+        validatedNumaMap = Utils.getNumaMap(conf);", "originalCommit": "10a2d1c03de04ea85e59184e0eff6d3a6a0ec6d7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a56d727f46393493b7bd16b0bded31ef001fba3b", "chunk": "diff --git a/storm-server/src/main/java/org/apache/storm/container/cgroup/CgroupManager.java b/storm-server/src/main/java/org/apache/storm/container/cgroup/CgroupManager.java\nindex e81cc4c10..a8eb6424d 100644\n--- a/storm-server/src/main/java/org/apache/storm/container/cgroup/CgroupManager.java\n+++ b/storm-server/src/main/java/org/apache/storm/container/cgroup/CgroupManager.java\n\n@@ -109,7 +109,6 @@ public class CgroupManager implements ResourceIsolationInterface {\n             throw new RuntimeException(\"Cgroup error, please check /proc/cgroups\");\n         }\n         this.prepareSubSystem(this.conf);\n-        validatedNumaMap = Utils.getNumaMap(conf);\n         workerToNumaId = new ConcurrentHashMap();\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA5MTQzNg==", "url": "https://github.com/apache/storm/pull/3237#discussion_r405091436", "bodyText": "I think line should be pulled into buildSupervisorInfo(). It appears that the intent is to create as many supervisorInfo records as there are Config.SUPERVISOR_NUMA_META entries with any leftover creating another SupervisorInfo(). And private buildSupervisorInfo() method is never called with validatedNumaMap of null. Each of these supervisorInfos creating a heartbeat-er.", "author": "bipinprasad", "createdAt": "2020-04-07T20:27:47Z", "path": "storm-server/src/main/java/org/apache/storm/daemon/supervisor/timer/SupervisorHeartbeat.java", "diffHunk": "@@ -87,12 +153,16 @@ private SupervisorInfo buildSupervisorInfo(Map<String, Object> conf, Supervisor\n             ret.put(stringNumberEntry.getKey(), stringNumberEntry.getValue().doubleValue());\n         }\n \n+        LOG.debug(NormalizedResources.RESOURCE_NAME_NORMALIZER.normalizedResourceMap(ret).toString());\n         return NormalizedResources.RESOURCE_NAME_NORMALIZER.normalizedResourceMap(ret);\n     }\n \n     @Override\n     public void run() {\n-        SupervisorInfo supervisorInfo = buildSupervisorInfo(conf, supervisor);\n-        stormClusterState.supervisorHeartbeat(supervisorId, supervisorInfo);\n+        Map<String, Object> validatedNumaMap = Utils.getNumaMap(conf);", "originalCommit": "10a2d1c03de04ea85e59184e0eff6d3a6a0ec6d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI2NDI1OQ==", "url": "https://github.com/apache/storm/pull/3237#discussion_r406264259", "bodyText": "The supervisor info does one thing - it creates an object with information about the actual supervisor. I think it's better to not add something like the NUMA heartbeating to its purview.", "author": "govind-menon", "createdAt": "2020-04-09T14:53:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA5MTQzNg=="}], "type": "inlineReview", "revised_code": {"commit": "9809635d75c3edb11adfb4f539cc40b7ef8f1503", "chunk": "diff --git a/storm-server/src/main/java/org/apache/storm/daemon/supervisor/timer/SupervisorHeartbeat.java b/storm-server/src/main/java/org/apache/storm/daemon/supervisor/timer/SupervisorHeartbeat.java\nindex 741fbf56e..55a497b0b 100644\n--- a/storm-server/src/main/java/org/apache/storm/daemon/supervisor/timer/SupervisorHeartbeat.java\n+++ b/storm-server/src/main/java/org/apache/storm/daemon/supervisor/timer/SupervisorHeartbeat.java\n\n@@ -159,7 +159,7 @@ public class SupervisorHeartbeat implements Runnable {\n \n     @Override\n     public void run() {\n-        Map<String, Object> validatedNumaMap = Utils.getNumaMap(conf);\n+        Map<String, Object> validatedNumaMap = SupervisorUtils.getNumaMap(conf);\n         Map<String, SupervisorInfo> supervisorInfoList = buildSupervisorInfo(conf, supervisor, validatedNumaMap);\n         for (Map.Entry<String, SupervisorInfo> supervisorInfoEntry: supervisorInfoList.entrySet()) {\n             stormClusterState.supervisorHeartbeat(supervisorInfoEntry.getKey(), supervisorInfoEntry.getValue());\n"}}, {"oid": "a56d727f46393493b7bd16b0bded31ef001fba3b", "url": "https://github.com/apache/storm/commit/a56d727f46393493b7bd16b0bded31ef001fba3b", "message": "STORM-3259: Addresses 2nd round of review comments", "committedDate": "2020-04-09T14:55:54Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMyNDAzOQ==", "url": "https://github.com/apache/storm/pull/3237#discussion_r406324039", "bodyText": "can this be removed?", "author": "Ethanlm", "createdAt": "2020-04-09T16:23:44Z", "path": "storm-server/src/main/java/org/apache/storm/container/cgroup/CgroupManager.java", "diffHunk": "@@ -50,6 +55,8 @@\n     private CgroupCommon rootCgroup;\n     private String rootDir;\n     private Map<String, Object> conf;\n+    private Map<String, String> workerToNumaId;\n+    protected Map<String, Object> validatedNumaMap;", "originalCommit": "a56d727f46393493b7bd16b0bded31ef001fba3b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9bf1dbc51498f37b64bb7eb558d4973887e5f80b", "chunk": "diff --git a/storm-server/src/main/java/org/apache/storm/container/cgroup/CgroupManager.java b/storm-server/src/main/java/org/apache/storm/container/cgroup/CgroupManager.java\nindex a8eb6424d..c964e7ea5 100644\n--- a/storm-server/src/main/java/org/apache/storm/container/cgroup/CgroupManager.java\n+++ b/storm-server/src/main/java/org/apache/storm/container/cgroup/CgroupManager.java\n\n@@ -56,7 +56,6 @@ public class CgroupManager implements ResourceIsolationInterface {\n     private String rootDir;\n     private Map<String, Object> conf;\n     private Map<String, String> workerToNumaId;\n-    protected Map<String, Object> validatedNumaMap;\n \n     static long getMemInfoFreeMb() throws IOException {\n         //MemFree:        14367072 kB\n"}}, {"oid": "9bf1dbc51498f37b64bb7eb558d4973887e5f80b", "url": "https://github.com/apache/storm/commit/9bf1dbc51498f37b64bb7eb558d4973887e5f80b", "message": "STORM-3259: Addresses 2nd round of review comments", "committedDate": "2020-04-09T17:03:05Z", "type": "forcePushed"}, {"oid": "9809635d75c3edb11adfb4f539cc40b7ef8f1503", "url": "https://github.com/apache/storm/commit/9809635d75c3edb11adfb4f539cc40b7ef8f1503", "message": "STORM-3259: Creates separate storm-server specific constants and helper files and moves NUMA to them", "committedDate": "2020-04-10T18:07:19Z", "type": "forcePushed"}, {"oid": "d776127d1238852ddacd04fe53912856048bf95a", "url": "https://github.com/apache/storm/commit/d776127d1238852ddacd04fe53912856048bf95a", "message": "STORM-3259: Creates separate storm-server specific constants and helper files and moves NUMA to them", "committedDate": "2020-04-10T18:09:46Z", "type": "forcePushed"}, {"oid": "130a077a9f7ffcb9fd8eabe1465172f374c2e4d2", "url": "https://github.com/apache/storm/commit/130a077a9f7ffcb9fd8eabe1465172f374c2e4d2", "message": "STORM-3259: Adds NUMA awareness to enable worker pinning\n\nSTORM-3259: Properly sends supervisor assignments on topology kill. Originally done by Aaron Gresch.\n\nSTORM-3259: Addresses review comments on NUMA pinning\n\nSTORM-3259: Addresses 2nd round of review comments\n\nSTORM-3259: Moves getNumaConf to SupervisorUtils from Utils\n\nSTORM-3259: Cleanup of unnecessary changes\n\nSTORM-3259: Creates separate storm-server specific constants and helper files and moves NUMA to them", "committedDate": "2020-04-10T19:57:45Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzcxNTI0MQ==", "url": "https://github.com/apache/storm/pull/3237#discussion_r407715241", "bodyText": "remove unused import", "author": "kishorvpatil", "createdAt": "2020-04-13T20:54:39Z", "path": "storm-server/src/main/java/org/apache/storm/daemon/supervisor/Container.java", "diffHunk": "@@ -37,6 +37,7 @@\n import java.util.Set;\n import org.apache.commons.lang.StringUtils;\n import org.apache.storm.Config;\n+import org.apache.storm.Constants;", "originalCommit": "130a077a9f7ffcb9fd8eabe1465172f374c2e4d2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "632d32039031c7e6bbe29ecce2d9833c1a677b76", "chunk": "diff --git a/storm-server/src/main/java/org/apache/storm/daemon/supervisor/Container.java b/storm-server/src/main/java/org/apache/storm/daemon/supervisor/Container.java\nindex 9f909fc56..c09b6f2dc 100644\n--- a/storm-server/src/main/java/org/apache/storm/daemon/supervisor/Container.java\n+++ b/storm-server/src/main/java/org/apache/storm/daemon/supervisor/Container.java\n\n@@ -37,7 +37,6 @@ import java.util.Optional;\n import java.util.Set;\n import org.apache.commons.lang.StringUtils;\n import org.apache.storm.Config;\n-import org.apache.storm.Constants;\n import org.apache.storm.DaemonConfig;\n import org.apache.storm.container.ResourceIsolationInterface;\n import org.apache.storm.generated.LSWorkerHeartbeat;\n"}}, {"oid": "632d32039031c7e6bbe29ecce2d9833c1a677b76", "url": "https://github.com/apache/storm/commit/632d32039031c7e6bbe29ecce2d9833c1a677b76", "message": "STORM-3259: Adds NUMA awareness to enable worker pinning\n\nSTORM-3259: Properly sends supervisor assignments on topology kill. Originally done by Aaron Gresch.\n\nSTORM-3259: Addresses review comments on NUMA pinning\n\nSTORM-3259: Addresses 2nd round of review comments\n\nSTORM-3259: Moves getNumaConf to SupervisorUtils from Utils\n\nSTORM-3259: Cleanup of unnecessary changes\n\nSTORM-3259: Creates separate storm-server specific constants and helper files and moves NUMA to them", "committedDate": "2020-04-13T21:36:35Z", "type": "commit"}, {"oid": "632d32039031c7e6bbe29ecce2d9833c1a677b76", "url": "https://github.com/apache/storm/commit/632d32039031c7e6bbe29ecce2d9833c1a677b76", "message": "STORM-3259: Adds NUMA awareness to enable worker pinning\n\nSTORM-3259: Properly sends supervisor assignments on topology kill. Originally done by Aaron Gresch.\n\nSTORM-3259: Addresses review comments on NUMA pinning\n\nSTORM-3259: Addresses 2nd round of review comments\n\nSTORM-3259: Moves getNumaConf to SupervisorUtils from Utils\n\nSTORM-3259: Cleanup of unnecessary changes\n\nSTORM-3259: Creates separate storm-server specific constants and helper files and moves NUMA to them", "committedDate": "2020-04-13T21:36:35Z", "type": "forcePushed"}]}