{"pr_number": 3363, "pr_title": "STORM-3724 use blobstore modtime to prevent querying each remote file on update", "pr_createdAt": "2020-12-17T16:22:54Z", "pr_url": "https://github.com/apache/storm/pull/3363", "timeline": [{"oid": "04fa542fe93de95abcd67336baa2aab7880b59c8", "url": "https://github.com/apache/storm/commit/04fa542fe93de95abcd67336baa2aab7880b59c8", "message": "STORM-3724 refactory LocallyCachedBlob update", "committedDate": "2020-12-16T20:17:20Z", "type": "commit"}, {"oid": "a03635bfb73c1bb31fc6d7164413dd3a6a053d63", "url": "https://github.com/apache/storm/commit/a03635bfb73c1bb31fc6d7164413dd3a6a053d63", "message": "STORM-3724 use blobstore modtime to prevent querying each blob remote file on update", "committedDate": "2020-12-16T21:21:34Z", "type": "commit"}, {"oid": "c2545a9c4032da4b0d13956ff565df2de0523402", "url": "https://github.com/apache/storm/commit/c2545a9c4032da4b0d13956ff565df2de0523402", "message": "STORM-3724 Nimbus periodically ensures blobstore modTime is up to date", "committedDate": "2020-12-16T22:19:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njg1NTkwMQ==", "url": "https://github.com/apache/storm/pull/3363#discussion_r546855901", "bodyText": "For unsupported, the remoteBlobstoreModTime will be returned as -1. Does that need a special case processing here or line 337 ?", "author": "bipinprasad", "createdAt": "2020-12-21T18:14:57Z", "path": "storm-server/src/main/java/org/apache/storm/localizer/LocallyCachedBlob.java", "diffHunk": "@@ -295,6 +301,90 @@ public String getKey() {\n \n     public abstract boolean isFullyDownloaded();\n \n+    /**\n+     * Checks to see if the local blob requires update with respect to a remote blob.\n+     *\n+     * @param blobStore the client blobstore\n+     * @param remoteBlobstoreModTime last modification time of remote blobstore\n+     * @return true of the local blob requires update, false otherwise.\n+     *\n+     * @throws KeyNotFoundException if the remote blob is missing\n+     * @throws AuthorizationException if authorization is failed\n+     */\n+    boolean requiresUpdate(ClientBlobStore blobStore, long remoteBlobstoreModTime) throws KeyNotFoundException, AuthorizationException {\n+        if (!this.isUsed()) {\n+            return false;\n+        }\n+\n+        if (!this.isFullyDownloaded()) {\n+            return true;\n+        }\n+\n+        // If we are already up to date with respect to the remote blob store, don't query\n+        // the remote blobstore for the remote file.  This reduces Hadoop namenode impact of\n+        // 100's of supervisors querying multiple blobs.\n+        if (remoteBlobstoreModTime > 0 && this.updatedModTime == remoteBlobstoreModTime) {\n+            LOG.debug(\"{} is up to date, blob updatedModTime matches remote timestamp {}\", this, remoteBlobstoreModTime);\n+            return false;\n+        }\n+", "originalCommit": "c2545a9c4032da4b0d13956ff565df2de0523402", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njg4NDM2OA==", "url": "https://github.com/apache/storm/pull/3363#discussion_r546884368", "bodyText": "Line 326 is an early out that will only occur now for HDFS blobstores.  Unsupported blobstores with -1 remoteBlobstoreModTime should act the same as previous to this change, where they always check the local version against the remote version of the blob.\nLine 337 should work regardless of what value is passed for remoteBlobstoreModTime.", "author": "agresch", "createdAt": "2020-12-21T19:17:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njg1NTkwMQ=="}], "type": "inlineReview", "revised_code": {"commit": "0eca24e59a1e3aee1ea6ba56bd223513953c037d", "chunk": "diff --git a/storm-server/src/main/java/org/apache/storm/localizer/LocallyCachedBlob.java b/storm-server/src/main/java/org/apache/storm/localizer/LocallyCachedBlob.java\nindex 89e41a468..fe2385bd2 100644\n--- a/storm-server/src/main/java/org/apache/storm/localizer/LocallyCachedBlob.java\n+++ b/storm-server/src/main/java/org/apache/storm/localizer/LocallyCachedBlob.java\n\n@@ -305,13 +305,13 @@ public abstract class LocallyCachedBlob {\n      * Checks to see if the local blob requires update with respect to a remote blob.\n      *\n      * @param blobStore the client blobstore\n-     * @param remoteBlobstoreModTime last modification time of remote blobstore\n+     * @param remoteBlobstoreUpdateTime last update time of remote blobstore\n      * @return true of the local blob requires update, false otherwise.\n      *\n      * @throws KeyNotFoundException if the remote blob is missing\n      * @throws AuthorizationException if authorization is failed\n      */\n-    boolean requiresUpdate(ClientBlobStore blobStore, long remoteBlobstoreModTime) throws KeyNotFoundException, AuthorizationException {\n+    boolean requiresUpdate(ClientBlobStore blobStore, long remoteBlobstoreUpdateTime) throws KeyNotFoundException, AuthorizationException {\n         if (!this.isUsed()) {\n             return false;\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTEyMzkzNA==", "url": "https://github.com/apache/storm/pull/3363#discussion_r549123934", "bodyText": "This looks a little weird on how it switches between integer and long. It can be just integer.\n\n  \n    \n      storm/storm-server/src/main/java/org/apache/storm/DaemonConfig.java\n    \n    \n        Lines 769 to 770\n      in\n      6e37072\n    \n    \n    \n    \n\n        \n          \n           @IsInteger \n        \n\n        \n          \n           public static final String SUPERVISOR_LOCALIZER_UPDATE_BLOB_INTERVAL_SECS = \"supervisor.localizer.update.blob.interval.secs\";", "author": "Ethanlm", "createdAt": "2020-12-27T15:06:56Z", "path": "storm-server/src/main/java/org/apache/storm/utils/ServerConfigUtils.java", "diffHunk": "@@ -158,4 +158,9 @@ public LocalState supervisorStateImpl(Map<String, Object> conf) throws IOExcepti\n     public LocalState nimbusTopoHistoryStateImpl(Map<String, Object> conf) throws IOException {\n         return new LocalState((masterLocalDir(conf) + FILE_SEPARATOR + \"history\"), true);\n     }\n+\n+    public static long getLocalizerUpdateBlobInterval(Map<String, Object> conf) {\n+        return ObjectReader.getInt(conf.get(", "originalCommit": "c2545a9c4032da4b0d13956ff565df2de0523402", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bbb920cbceb7f67c67706af489541370c01eda9b", "chunk": "diff --git a/storm-server/src/main/java/org/apache/storm/utils/ServerConfigUtils.java b/storm-server/src/main/java/org/apache/storm/utils/ServerConfigUtils.java\nindex c80138071..a6b0ba6fe 100644\n--- a/storm-server/src/main/java/org/apache/storm/utils/ServerConfigUtils.java\n+++ b/storm-server/src/main/java/org/apache/storm/utils/ServerConfigUtils.java\n\n@@ -159,8 +159,8 @@ public class ServerConfigUtils {\n         return new LocalState((masterLocalDir(conf) + FILE_SEPARATOR + \"history\"), true);\n     }\n \n-    public static long getLocalizerUpdateBlobInterval(Map<String, Object> conf) {\n+    public static int getLocalizerUpdateBlobInterval(Map<String, Object> conf) {\n         return ObjectReader.getInt(conf.get(\n-                DaemonConfig.SUPERVISOR_LOCALIZER_UPDATE_BLOB_INTERVAL_SECS), 30).longValue();\n+                DaemonConfig.SUPERVISOR_LOCALIZER_UPDATE_BLOB_INTERVAL_SECS), 30);\n     }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTEyODE4OA==", "url": "https://github.com/apache/storm/pull/3363#discussion_r549128188", "bodyText": "This looks at the mod time of the bucketDir.  But the blob files can be updated.\nhttps://git.vzbuilders.com/storm/storm/blob/master/docs/distcache-blobstore.md#updating-a-cached-file\nWill this work properly in this case? Or does the code change at Nimbus.java serve the purpose?", "author": "Ethanlm", "createdAt": "2020-12-27T15:47:56Z", "path": "external/storm-hdfs-blobstore/src/main/java/org/apache/storm/hdfs/blobstore/HdfsBlobStoreImpl.java", "diffHunk": "@@ -312,4 +313,54 @@ public void shutdown() {\n             timer.cancel();\n         }\n     }\n+\n+    /**\n+     * Get the last modification time of any blob.\n+     *\n+     * @return the last modification time of blobs within the blobstore.\n+     * @throws IOException on any error\n+     */\n+    public long getLastModTime() throws IOException {\n+        long modtime =  fileSystem.getFileStatus(fullPath).getModificationTime();\n+        return modtime;\n+    }\n+\n+    /**\n+     * Updates the modification time of the blobstore to the current time.\n+     *\n+     * @throws IOException on any error\n+     */\n+    public void updateLastModTime() throws IOException {\n+        long timestamp = Time.currentTimeMillis();\n+        fileSystem.setTimes(fullPath, timestamp, timestamp);\n+        LOG.debug(\"Updated blobstore modtime of {} to {}\", fullPath, timestamp);\n+    }\n+\n+    /**\n+     * Validates that the modification time of the blobstore is up to date with the current existing blobs.\n+     *\n+     * @throws IOException on any error\n+     */\n+    public void validateModTime() throws IOException {\n+        int currentBucket = 0;\n+        long baseModTime = 0;\n+        while (currentBucket < BUCKETS) {\n+            String name = String.valueOf(currentBucket);\n+            Path bucketDir = new Path(fullPath, name);\n+\n+            // only consider bucket dirs that exist with files in them\n+            if (fileSystem.exists(bucketDir) && fileSystem.listStatus(bucketDir).length > 0) {\n+                long modtime = fileSystem.getFileStatus(bucketDir).getModificationTime();", "originalCommit": "c2545a9c4032da4b0d13956ff565df2de0523402", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDY4MjY4OA==", "url": "https://github.com/apache/storm/pull/3363#discussion_r550682688", "bodyText": "The modification timestamp of the directory updates when a blob in the directory changes or is deleted.", "author": "agresch", "createdAt": "2020-12-31T20:00:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTEyODE4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTE0NjgwNw==", "url": "https://github.com/apache/storm/pull/3363#discussion_r555146807", "bodyText": "Do you mean the modification timestamp of bucketDir?\nIts modification time will not change if the content of a blob in the directory changes.  If a blob is added or deleted in the directory, the modification time of the directory (bucketDir) will change. But here we ignore any directory that has none blobs, which means the following case is not captured: \"all blobs in the directory are deleted\"", "author": "Ethanlm", "createdAt": "2021-01-11T15:53:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTEyODE4OA=="}], "type": "inlineReview", "revised_code": {"commit": "bbb920cbceb7f67c67706af489541370c01eda9b", "chunk": "diff --git a/external/storm-hdfs-blobstore/src/main/java/org/apache/storm/hdfs/blobstore/HdfsBlobStoreImpl.java b/external/storm-hdfs-blobstore/src/main/java/org/apache/storm/hdfs/blobstore/HdfsBlobStoreImpl.java\nindex 9dea5eabd..bcb65d29c 100644\n--- a/external/storm-hdfs-blobstore/src/main/java/org/apache/storm/hdfs/blobstore/HdfsBlobStoreImpl.java\n+++ b/external/storm-hdfs-blobstore/src/main/java/org/apache/storm/hdfs/blobstore/HdfsBlobStoreImpl.java\n\n@@ -321,8 +329,20 @@ public class HdfsBlobStoreImpl {\n      * @throws IOException on any error\n      */\n     public long getLastModTime() throws IOException {\n-        long modtime =  fileSystem.getFileStatus(fullPath).getModificationTime();\n-        return modtime;\n+        Path modTimeFile = new Path(fullPath, BLOBSTORE_MOD_TIME_FILE);\n+        if (!fileSystem.exists(modTimeFile)) {\n+            return -1L;\n+        }\n+        FSDataInputStream inputStream = fileSystem.open(modTimeFile);\n+        String timestamp = IOUtils.toString(inputStream, \"UTF-8\");\n+        inputStream.close();\n+        try {\n+            long modTime = Long.parseLong(timestamp);\n+            return modTime;\n+        } catch (NumberFormatException e) {\n+            LOG.error(\"Invalid blobstore modtime {} in file {}\", timestamp, modTimeFile);\n+            return -1L;\n+        }\n     }\n \n     /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTI1MDM4NQ==", "url": "https://github.com/apache/storm/pull/3363#discussion_r549250385", "bodyText": "nit: space", "author": "Ethanlm", "createdAt": "2020-12-28T07:55:56Z", "path": "external/storm-hdfs-blobstore/src/main/java/org/apache/storm/hdfs/blobstore/HdfsBlobStoreImpl.java", "diffHunk": "@@ -312,4 +313,54 @@ public void shutdown() {\n             timer.cancel();\n         }\n     }\n+\n+    /**\n+     * Get the last modification time of any blob.\n+     *\n+     * @return the last modification time of blobs within the blobstore.\n+     * @throws IOException on any error\n+     */\n+    public long getLastModTime() throws IOException {\n+        long modtime =  fileSystem.getFileStatus(fullPath).getModificationTime();", "originalCommit": "c2545a9c4032da4b0d13956ff565df2de0523402", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bbb920cbceb7f67c67706af489541370c01eda9b", "chunk": "diff --git a/external/storm-hdfs-blobstore/src/main/java/org/apache/storm/hdfs/blobstore/HdfsBlobStoreImpl.java b/external/storm-hdfs-blobstore/src/main/java/org/apache/storm/hdfs/blobstore/HdfsBlobStoreImpl.java\nindex 9dea5eabd..bcb65d29c 100644\n--- a/external/storm-hdfs-blobstore/src/main/java/org/apache/storm/hdfs/blobstore/HdfsBlobStoreImpl.java\n+++ b/external/storm-hdfs-blobstore/src/main/java/org/apache/storm/hdfs/blobstore/HdfsBlobStoreImpl.java\n\n@@ -321,8 +329,20 @@ public class HdfsBlobStoreImpl {\n      * @throws IOException on any error\n      */\n     public long getLastModTime() throws IOException {\n-        long modtime =  fileSystem.getFileStatus(fullPath).getModificationTime();\n-        return modtime;\n+        Path modTimeFile = new Path(fullPath, BLOBSTORE_MOD_TIME_FILE);\n+        if (!fileSystem.exists(modTimeFile)) {\n+            return -1L;\n+        }\n+        FSDataInputStream inputStream = fileSystem.open(modTimeFile);\n+        String timestamp = IOUtils.toString(inputStream, \"UTF-8\");\n+        inputStream.close();\n+        try {\n+            long modTime = Long.parseLong(timestamp);\n+            return modTime;\n+        } catch (NumberFormatException e) {\n+            LOG.error(\"Invalid blobstore modtime {} in file {}\", timestamp, modTimeFile);\n+            return -1L;\n+        }\n     }\n \n     /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTI1MDQ3Mg==", "url": "https://github.com/apache/storm/pull/3363#discussion_r549250472", "bodyText": "I am not very sure if changing the mtime of the blobstore directory is a good idea. It breaks the semantics of modification time of a directory.", "author": "Ethanlm", "createdAt": "2020-12-28T07:56:10Z", "path": "external/storm-hdfs-blobstore/src/main/java/org/apache/storm/hdfs/blobstore/HdfsBlobStoreImpl.java", "diffHunk": "@@ -312,4 +313,54 @@ public void shutdown() {\n             timer.cancel();\n         }\n     }\n+\n+    /**\n+     * Get the last modification time of any blob.\n+     *\n+     * @return the last modification time of blobs within the blobstore.\n+     * @throws IOException on any error\n+     */\n+    public long getLastModTime() throws IOException {\n+        long modtime =  fileSystem.getFileStatus(fullPath).getModificationTime();\n+        return modtime;\n+    }\n+\n+    /**\n+     * Updates the modification time of the blobstore to the current time.\n+     *\n+     * @throws IOException on any error\n+     */\n+    public void updateLastModTime() throws IOException {\n+        long timestamp = Time.currentTimeMillis();\n+        fileSystem.setTimes(fullPath, timestamp, timestamp);", "originalCommit": "c2545a9c4032da4b0d13956ff565df2de0523402", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDY4MjgxMA==", "url": "https://github.com/apache/storm/pull/3363#discussion_r550682810", "bodyText": "I am not clear what the concern is.  Would you prefer I touch a file instead of directory?  Other suggestions?", "author": "agresch", "createdAt": "2020-12-31T20:01:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTI1MDQ3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjE2NjU1NQ==", "url": "https://github.com/apache/storm/pull/3363#discussion_r552166555", "bodyText": "I would personally prefer to use a separate file to record the metadata instead of modifying the mtime of a directory since it doesn't follow the semantics of mtime. It doesn't seem to be a problem currently but we don't know what we will do in the future so I'd rather not break the semantics and also this is to avoid confusion. It is a personal preference though.", "author": "Ethanlm", "createdAt": "2021-01-05T20:08:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTI1MDQ3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjE3MDMxNA==", "url": "https://github.com/apache/storm/pull/3363#discussion_r552170314", "bodyText": "will update the PR with your suggested change.", "author": "agresch", "createdAt": "2021-01-05T20:16:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTI1MDQ3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzYxMzgyNg==", "url": "https://github.com/apache/storm/pull/3363#discussion_r553613826", "bodyText": "Updated with this change and addressed your other comments.", "author": "agresch", "createdAt": "2021-01-07T21:56:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTI1MDQ3Mg=="}], "type": "inlineReview", "revised_code": {"commit": "bbb920cbceb7f67c67706af489541370c01eda9b", "chunk": "diff --git a/external/storm-hdfs-blobstore/src/main/java/org/apache/storm/hdfs/blobstore/HdfsBlobStoreImpl.java b/external/storm-hdfs-blobstore/src/main/java/org/apache/storm/hdfs/blobstore/HdfsBlobStoreImpl.java\nindex 9dea5eabd..bcb65d29c 100644\n--- a/external/storm-hdfs-blobstore/src/main/java/org/apache/storm/hdfs/blobstore/HdfsBlobStoreImpl.java\n+++ b/external/storm-hdfs-blobstore/src/main/java/org/apache/storm/hdfs/blobstore/HdfsBlobStoreImpl.java\n\n@@ -321,8 +329,20 @@ public class HdfsBlobStoreImpl {\n      * @throws IOException on any error\n      */\n     public long getLastModTime() throws IOException {\n-        long modtime =  fileSystem.getFileStatus(fullPath).getModificationTime();\n-        return modtime;\n+        Path modTimeFile = new Path(fullPath, BLOBSTORE_MOD_TIME_FILE);\n+        if (!fileSystem.exists(modTimeFile)) {\n+            return -1L;\n+        }\n+        FSDataInputStream inputStream = fileSystem.open(modTimeFile);\n+        String timestamp = IOUtils.toString(inputStream, \"UTF-8\");\n+        inputStream.close();\n+        try {\n+            long modTime = Long.parseLong(timestamp);\n+            return modTime;\n+        } catch (NumberFormatException e) {\n+            LOG.error(\"Invalid blobstore modtime {} in file {}\", timestamp, modTimeFile);\n+            return -1L;\n+        }\n     }\n \n     /**\n"}}, {"oid": "bbb920cbceb7f67c67706af489541370c01eda9b", "url": "https://github.com/apache/storm/commit/bbb920cbceb7f67c67706af489541370c01eda9b", "message": "STORM-3724 use file to store blobstore modification time", "committedDate": "2021-01-07T21:54:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTEzNjYxNQ==", "url": "https://github.com/apache/storm/pull/3363#discussion_r555136615", "bodyText": "Nit: This should be getLastModTime", "author": "Ethanlm", "createdAt": "2021-01-11T15:42:11Z", "path": "external/storm-hdfs-blobstore/src/main/java/org/apache/storm/hdfs/blobstore/HdfsBlobStore.java", "diffHunk": "@@ -404,4 +404,18 @@ public void writeMetadata(String key, SettableBlobMeta meta)\n     public void fullCleanup(long age) throws IOException {\n         hbs.fullCleanup(age);\n     }\n+\n+    public long getLastModeTime() throws IOException {", "originalCommit": "bbb920cbceb7f67c67706af489541370c01eda9b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "0eca24e59a1e3aee1ea6ba56bd223513953c037d", "chunk": "diff --git a/external/storm-hdfs-blobstore/src/main/java/org/apache/storm/hdfs/blobstore/HdfsBlobStore.java b/external/storm-hdfs-blobstore/src/main/java/org/apache/storm/hdfs/blobstore/HdfsBlobStore.java\nindex 70f10ef3e..7d957186a 100644\n--- a/external/storm-hdfs-blobstore/src/main/java/org/apache/storm/hdfs/blobstore/HdfsBlobStore.java\n+++ b/external/storm-hdfs-blobstore/src/main/java/org/apache/storm/hdfs/blobstore/HdfsBlobStore.java\n\n@@ -405,17 +405,17 @@ public class HdfsBlobStore extends BlobStore {\n         hbs.fullCleanup(age);\n     }\n \n-    public long getLastModeTime() throws IOException {\n-        return hbs.getLastModTime();\n+    public long getLastBlobUpdateTime() throws IOException {\n+        return hbs.getLastBlobUpdateTime();\n     }\n \n     @Override\n-    public void updateLastModTime() throws IOException {\n-        hbs.updateLastModTime();\n+    public void updateLastBlobUpdateTime() throws IOException {\n+        hbs.updateLastBlobUpdateTime();\n     }\n \n     @Override\n-    public void validateModTime() throws IOException {\n-        hbs.validateModTime();\n+    public void validateBlobUpdateTime() throws IOException {\n+        hbs.validateBlobUpdateTime();\n     }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTI3MTcyMQ==", "url": "https://github.com/apache/storm/pull/3363#discussion_r555271721", "bodyText": "What will happen if blobStore.setBlobMeta succeeds then blobStore.updateLastModTime() fails? Or nimbus crashed before blobStore.updateLastModTime() can run?\nLooks like supervisors will not be notified for this blob update. We should update the timestamp before doing the actual operation.\nAlso, do we need to update the timestamp in updateBlobReplication(String key, int replication)?", "author": "Ethanlm", "createdAt": "2021-01-11T19:01:13Z", "path": "storm-server/src/main/java/org/apache/storm/daemon/nimbus/Nimbus.java", "diffHunk": "@@ -3815,6 +3828,7 @@ public void setBlobMeta(String key, SettableBlobMeta meta)\n         throws AuthorizationException, KeyNotFoundException, TException {\n         try {\n             blobStore.setBlobMeta(key, meta, getSubject());\n+            blobStore.updateLastModTime();", "originalCommit": "bbb920cbceb7f67c67706af489541370c01eda9b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTI3ODUxNw==", "url": "https://github.com/apache/storm/pull/3363#discussion_r555278517", "bodyText": "If the updateLastModTime fails, eventually a Nimbus should get restarted or HDFS fixed, and Nimbus will call blobStore.validateModTime().  This should fix the issue.  During the period in-between, supervisors will remain on an older version of the blob.", "author": "agresch", "createdAt": "2021-01-11T19:13:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTI3MTcyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTI4NTU2NA==", "url": "https://github.com/apache/storm/pull/3363#discussion_r555285564", "bodyText": "Thanks. My biggest question is: will the bucketDir's modTime update when the content of a file under the bucketDir updates?\nI think your answer is yes.\nIf that's so, I agree that validateModTime will serve the purpose.", "author": "Ethanlm", "createdAt": "2021-01-11T19:26:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTI3MTcyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTI4Nzg4MA==", "url": "https://github.com/apache/storm/pull/3363#discussion_r555287880", "bodyText": "yes, validateModTime() should update the mod time if a file in the bucket dir is updated.  There will also be occasional false positive updates if a blob is deleted in a bucket dir that contains a different blob file.", "author": "agresch", "createdAt": "2021-01-11T19:30:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTI3MTcyMQ=="}], "type": "inlineReview", "revised_code": {"commit": "0eca24e59a1e3aee1ea6ba56bd223513953c037d", "chunk": "diff --git a/storm-server/src/main/java/org/apache/storm/daemon/nimbus/Nimbus.java b/storm-server/src/main/java/org/apache/storm/daemon/nimbus/Nimbus.java\nindex 07f2ca856..1676b9a19 100644\n--- a/storm-server/src/main/java/org/apache/storm/daemon/nimbus/Nimbus.java\n+++ b/storm-server/src/main/java/org/apache/storm/daemon/nimbus/Nimbus.java\n\n@@ -3828,7 +3828,7 @@ public class Nimbus implements Iface, Shutdownable, DaemonCommon {\n         throws AuthorizationException, KeyNotFoundException, TException {\n         try {\n             blobStore.setBlobMeta(key, meta, getSubject());\n-            blobStore.updateLastModTime();\n+            blobStore.updateLastBlobUpdateTime();\n         } catch (Exception e) {\n             LOG.warn(\"set blob meta exception.\", e);\n             if (e instanceof TException) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTI3OTAwMg==", "url": "https://github.com/apache/storm/pull/3363#discussion_r555279002", "bodyText": "What happens if this method is invoked in two threads in the same time? Do we need synchronization here?", "author": "Ethanlm", "createdAt": "2021-01-11T19:14:35Z", "path": "external/storm-hdfs-blobstore/src/main/java/org/apache/storm/hdfs/blobstore/HdfsBlobStoreImpl.java", "diffHunk": "@@ -312,4 +321,70 @@ public void shutdown() {\n             timer.cancel();\n         }\n     }\n+\n+    /**\n+     * Get the last modification time of any blob.\n+     *\n+     * @return the last modification time of blobs within the blobstore.\n+     * @throws IOException on any error\n+     */\n+    public long getLastModTime() throws IOException {\n+        Path modTimeFile = new Path(fullPath, BLOBSTORE_MOD_TIME_FILE);\n+        if (!fileSystem.exists(modTimeFile)) {\n+            return -1L;\n+        }\n+        FSDataInputStream inputStream = fileSystem.open(modTimeFile);\n+        String timestamp = IOUtils.toString(inputStream, \"UTF-8\");\n+        inputStream.close();\n+        try {\n+            long modTime = Long.parseLong(timestamp);\n+            return modTime;\n+        } catch (NumberFormatException e) {\n+            LOG.error(\"Invalid blobstore modtime {} in file {}\", timestamp, modTimeFile);\n+            return -1L;\n+        }\n+    }\n+\n+    /**\n+     * Updates the modification time of the blobstore to the current time.\n+     *\n+     * @throws IOException on any error\n+     */\n+    public void updateLastModTime() throws IOException {", "originalCommit": "bbb920cbceb7f67c67706af489541370c01eda9b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTI4ODEwMw==", "url": "https://github.com/apache/storm/pull/3363#discussion_r555288103", "bodyText": "validateModTime() would eventually fix things, but I will add synchronization.", "author": "agresch", "createdAt": "2021-01-11T19:31:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTI3OTAwMg=="}], "type": "inlineReview", "revised_code": {"commit": "0eca24e59a1e3aee1ea6ba56bd223513953c037d", "chunk": "diff --git a/external/storm-hdfs-blobstore/src/main/java/org/apache/storm/hdfs/blobstore/HdfsBlobStoreImpl.java b/external/storm-hdfs-blobstore/src/main/java/org/apache/storm/hdfs/blobstore/HdfsBlobStoreImpl.java\nindex bcb65d29c..f7607e4c6 100644\n--- a/external/storm-hdfs-blobstore/src/main/java/org/apache/storm/hdfs/blobstore/HdfsBlobStoreImpl.java\n+++ b/external/storm-hdfs-blobstore/src/main/java/org/apache/storm/hdfs/blobstore/HdfsBlobStoreImpl.java\n\n@@ -323,13 +323,13 @@ public class HdfsBlobStoreImpl {\n     }\n \n     /**\n-     * Get the last modification time of any blob.\n+     * Get the last update time of any blob.\n      *\n-     * @return the last modification time of blobs within the blobstore.\n+     * @return the last updated time of blobs within the blobstore.\n      * @throws IOException on any error\n      */\n-    public long getLastModTime() throws IOException {\n-        Path modTimeFile = new Path(fullPath, BLOBSTORE_MOD_TIME_FILE);\n+    public long getLastBlobUpdateTime() throws IOException {\n+        Path modTimeFile = new Path(fullPath, BLOBSTORE_UPDATE_TIME_FILE);\n         if (!fileSystem.exists(modTimeFile)) {\n             return -1L;\n         }\n"}}, {"oid": "0eca24e59a1e3aee1ea6ba56bd223513953c037d", "url": "https://github.com/apache/storm/commit/0eca24e59a1e3aee1ea6ba56bd223513953c037d", "message": "STORM-3724 rename methods to reflect update times to existing blobs rather than overall modification times.  Add synchronization to blob update time.", "committedDate": "2021-01-11T22:35:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTgzOTg4Ng==", "url": "https://github.com/apache/storm/pull/3363#discussion_r555839886", "bodyText": "nit: can be changed to updateTimeFile", "author": "Ethanlm", "createdAt": "2021-01-12T15:04:48Z", "path": "external/storm-hdfs-blobstore/src/main/java/org/apache/storm/hdfs/blobstore/HdfsBlobStoreImpl.java", "diffHunk": "@@ -312,4 +321,70 @@ public void shutdown() {\n             timer.cancel();\n         }\n     }\n+\n+    /**\n+     * Get the last update time of any blob.\n+     *\n+     * @return the last updated time of blobs within the blobstore.\n+     * @throws IOException on any error\n+     */\n+    public long getLastBlobUpdateTime() throws IOException {\n+        Path modTimeFile = new Path(fullPath, BLOBSTORE_UPDATE_TIME_FILE);", "originalCommit": "0eca24e59a1e3aee1ea6ba56bd223513953c037d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "fe38f29aa506de64e9e292738915c9141e4f433f", "chunk": "diff --git a/external/storm-hdfs-blobstore/src/main/java/org/apache/storm/hdfs/blobstore/HdfsBlobStoreImpl.java b/external/storm-hdfs-blobstore/src/main/java/org/apache/storm/hdfs/blobstore/HdfsBlobStoreImpl.java\nindex f7607e4c6..7f81c94ca 100644\n--- a/external/storm-hdfs-blobstore/src/main/java/org/apache/storm/hdfs/blobstore/HdfsBlobStoreImpl.java\n+++ b/external/storm-hdfs-blobstore/src/main/java/org/apache/storm/hdfs/blobstore/HdfsBlobStoreImpl.java\n\n@@ -329,18 +329,18 @@ public class HdfsBlobStoreImpl {\n      * @throws IOException on any error\n      */\n     public long getLastBlobUpdateTime() throws IOException {\n-        Path modTimeFile = new Path(fullPath, BLOBSTORE_UPDATE_TIME_FILE);\n-        if (!fileSystem.exists(modTimeFile)) {\n+        Path updateTimeFile = new Path(fullPath, BLOBSTORE_UPDATE_TIME_FILE);\n+        if (!fileSystem.exists(updateTimeFile)) {\n             return -1L;\n         }\n-        FSDataInputStream inputStream = fileSystem.open(modTimeFile);\n+        FSDataInputStream inputStream = fileSystem.open(updateTimeFile);\n         String timestamp = IOUtils.toString(inputStream, \"UTF-8\");\n         inputStream.close();\n         try {\n-            long modTime = Long.parseLong(timestamp);\n-            return modTime;\n+            long updateTime = Long.parseLong(timestamp);\n+            return updateTime;\n         } catch (NumberFormatException e) {\n-            LOG.error(\"Invalid blobstore modtime {} in file {}\", timestamp, modTimeFile);\n+            LOG.error(\"Invalid blobstore update time {} in file {}\", timestamp, updateTimeFile);\n             return -1L;\n         }\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTg0MDA2Mg==", "url": "https://github.com/apache/storm/pull/3363#discussion_r555840062", "bodyText": "nit: can be changed to updateTime", "author": "Ethanlm", "createdAt": "2021-01-12T15:05:03Z", "path": "external/storm-hdfs-blobstore/src/main/java/org/apache/storm/hdfs/blobstore/HdfsBlobStoreImpl.java", "diffHunk": "@@ -312,4 +321,70 @@ public void shutdown() {\n             timer.cancel();\n         }\n     }\n+\n+    /**\n+     * Get the last update time of any blob.\n+     *\n+     * @return the last updated time of blobs within the blobstore.\n+     * @throws IOException on any error\n+     */\n+    public long getLastBlobUpdateTime() throws IOException {\n+        Path modTimeFile = new Path(fullPath, BLOBSTORE_UPDATE_TIME_FILE);\n+        if (!fileSystem.exists(modTimeFile)) {\n+            return -1L;\n+        }\n+        FSDataInputStream inputStream = fileSystem.open(modTimeFile);\n+        String timestamp = IOUtils.toString(inputStream, \"UTF-8\");\n+        inputStream.close();\n+        try {\n+            long modTime = Long.parseLong(timestamp);", "originalCommit": "0eca24e59a1e3aee1ea6ba56bd223513953c037d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "fe38f29aa506de64e9e292738915c9141e4f433f", "chunk": "diff --git a/external/storm-hdfs-blobstore/src/main/java/org/apache/storm/hdfs/blobstore/HdfsBlobStoreImpl.java b/external/storm-hdfs-blobstore/src/main/java/org/apache/storm/hdfs/blobstore/HdfsBlobStoreImpl.java\nindex f7607e4c6..7f81c94ca 100644\n--- a/external/storm-hdfs-blobstore/src/main/java/org/apache/storm/hdfs/blobstore/HdfsBlobStoreImpl.java\n+++ b/external/storm-hdfs-blobstore/src/main/java/org/apache/storm/hdfs/blobstore/HdfsBlobStoreImpl.java\n\n@@ -329,18 +329,18 @@ public class HdfsBlobStoreImpl {\n      * @throws IOException on any error\n      */\n     public long getLastBlobUpdateTime() throws IOException {\n-        Path modTimeFile = new Path(fullPath, BLOBSTORE_UPDATE_TIME_FILE);\n-        if (!fileSystem.exists(modTimeFile)) {\n+        Path updateTimeFile = new Path(fullPath, BLOBSTORE_UPDATE_TIME_FILE);\n+        if (!fileSystem.exists(updateTimeFile)) {\n             return -1L;\n         }\n-        FSDataInputStream inputStream = fileSystem.open(modTimeFile);\n+        FSDataInputStream inputStream = fileSystem.open(updateTimeFile);\n         String timestamp = IOUtils.toString(inputStream, \"UTF-8\");\n         inputStream.close();\n         try {\n-            long modTime = Long.parseLong(timestamp);\n-            return modTime;\n+            long updateTime = Long.parseLong(timestamp);\n+            return updateTime;\n         } catch (NumberFormatException e) {\n-            LOG.error(\"Invalid blobstore modtime {} in file {}\", timestamp, modTimeFile);\n+            LOG.error(\"Invalid blobstore update time {} in file {}\", timestamp, updateTimeFile);\n             return -1L;\n         }\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTg0MDIzOA==", "url": "https://github.com/apache/storm/pull/3363#discussion_r555840238", "bodyText": "nit: can be changed to update time", "author": "Ethanlm", "createdAt": "2021-01-12T15:05:16Z", "path": "external/storm-hdfs-blobstore/src/main/java/org/apache/storm/hdfs/blobstore/HdfsBlobStoreImpl.java", "diffHunk": "@@ -312,4 +321,70 @@ public void shutdown() {\n             timer.cancel();\n         }\n     }\n+\n+    /**\n+     * Get the last update time of any blob.\n+     *\n+     * @return the last updated time of blobs within the blobstore.\n+     * @throws IOException on any error\n+     */\n+    public long getLastBlobUpdateTime() throws IOException {\n+        Path modTimeFile = new Path(fullPath, BLOBSTORE_UPDATE_TIME_FILE);\n+        if (!fileSystem.exists(modTimeFile)) {\n+            return -1L;\n+        }\n+        FSDataInputStream inputStream = fileSystem.open(modTimeFile);\n+        String timestamp = IOUtils.toString(inputStream, \"UTF-8\");\n+        inputStream.close();\n+        try {\n+            long modTime = Long.parseLong(timestamp);\n+            return modTime;\n+        } catch (NumberFormatException e) {\n+            LOG.error(\"Invalid blobstore modtime {} in file {}\", timestamp, modTimeFile);", "originalCommit": "0eca24e59a1e3aee1ea6ba56bd223513953c037d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "fe38f29aa506de64e9e292738915c9141e4f433f", "chunk": "diff --git a/external/storm-hdfs-blobstore/src/main/java/org/apache/storm/hdfs/blobstore/HdfsBlobStoreImpl.java b/external/storm-hdfs-blobstore/src/main/java/org/apache/storm/hdfs/blobstore/HdfsBlobStoreImpl.java\nindex f7607e4c6..7f81c94ca 100644\n--- a/external/storm-hdfs-blobstore/src/main/java/org/apache/storm/hdfs/blobstore/HdfsBlobStoreImpl.java\n+++ b/external/storm-hdfs-blobstore/src/main/java/org/apache/storm/hdfs/blobstore/HdfsBlobStoreImpl.java\n\n@@ -329,18 +329,18 @@ public class HdfsBlobStoreImpl {\n      * @throws IOException on any error\n      */\n     public long getLastBlobUpdateTime() throws IOException {\n-        Path modTimeFile = new Path(fullPath, BLOBSTORE_UPDATE_TIME_FILE);\n-        if (!fileSystem.exists(modTimeFile)) {\n+        Path updateTimeFile = new Path(fullPath, BLOBSTORE_UPDATE_TIME_FILE);\n+        if (!fileSystem.exists(updateTimeFile)) {\n             return -1L;\n         }\n-        FSDataInputStream inputStream = fileSystem.open(modTimeFile);\n+        FSDataInputStream inputStream = fileSystem.open(updateTimeFile);\n         String timestamp = IOUtils.toString(inputStream, \"UTF-8\");\n         inputStream.close();\n         try {\n-            long modTime = Long.parseLong(timestamp);\n-            return modTime;\n+            long updateTime = Long.parseLong(timestamp);\n+            return updateTime;\n         } catch (NumberFormatException e) {\n-            LOG.error(\"Invalid blobstore modtime {} in file {}\", timestamp, modTimeFile);\n+            LOG.error(\"Invalid blobstore update time {} in file {}\", timestamp, updateTimeFile);\n             return -1L;\n         }\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTg0MDM3Nw==", "url": "https://github.com/apache/storm/pull/3363#discussion_r555840377", "bodyText": "nit: can be changed to updateTimeFile", "author": "Ethanlm", "createdAt": "2021-01-12T15:05:28Z", "path": "external/storm-hdfs-blobstore/src/main/java/org/apache/storm/hdfs/blobstore/HdfsBlobStoreImpl.java", "diffHunk": "@@ -312,4 +321,70 @@ public void shutdown() {\n             timer.cancel();\n         }\n     }\n+\n+    /**\n+     * Get the last update time of any blob.\n+     *\n+     * @return the last updated time of blobs within the blobstore.\n+     * @throws IOException on any error\n+     */\n+    public long getLastBlobUpdateTime() throws IOException {\n+        Path modTimeFile = new Path(fullPath, BLOBSTORE_UPDATE_TIME_FILE);\n+        if (!fileSystem.exists(modTimeFile)) {\n+            return -1L;\n+        }\n+        FSDataInputStream inputStream = fileSystem.open(modTimeFile);\n+        String timestamp = IOUtils.toString(inputStream, \"UTF-8\");\n+        inputStream.close();\n+        try {\n+            long modTime = Long.parseLong(timestamp);\n+            return modTime;\n+        } catch (NumberFormatException e) {\n+            LOG.error(\"Invalid blobstore modtime {} in file {}\", timestamp, modTimeFile);\n+            return -1L;\n+        }\n+    }\n+\n+    /**\n+     * Updates the last updated time of existing blobstores to the current time.\n+     *\n+     * @throws IOException on any error\n+     */\n+    public synchronized void updateLastBlobUpdateTime() throws IOException {\n+        Long timestamp = Time.currentTimeMillis();\n+        Path modTimeFile = new Path(fullPath, BLOBSTORE_UPDATE_TIME_FILE);", "originalCommit": "0eca24e59a1e3aee1ea6ba56bd223513953c037d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "fe38f29aa506de64e9e292738915c9141e4f433f", "chunk": "diff --git a/external/storm-hdfs-blobstore/src/main/java/org/apache/storm/hdfs/blobstore/HdfsBlobStoreImpl.java b/external/storm-hdfs-blobstore/src/main/java/org/apache/storm/hdfs/blobstore/HdfsBlobStoreImpl.java\nindex f7607e4c6..7f81c94ca 100644\n--- a/external/storm-hdfs-blobstore/src/main/java/org/apache/storm/hdfs/blobstore/HdfsBlobStoreImpl.java\n+++ b/external/storm-hdfs-blobstore/src/main/java/org/apache/storm/hdfs/blobstore/HdfsBlobStoreImpl.java\n\n@@ -329,18 +329,18 @@ public class HdfsBlobStoreImpl {\n      * @throws IOException on any error\n      */\n     public long getLastBlobUpdateTime() throws IOException {\n-        Path modTimeFile = new Path(fullPath, BLOBSTORE_UPDATE_TIME_FILE);\n-        if (!fileSystem.exists(modTimeFile)) {\n+        Path updateTimeFile = new Path(fullPath, BLOBSTORE_UPDATE_TIME_FILE);\n+        if (!fileSystem.exists(updateTimeFile)) {\n             return -1L;\n         }\n-        FSDataInputStream inputStream = fileSystem.open(modTimeFile);\n+        FSDataInputStream inputStream = fileSystem.open(updateTimeFile);\n         String timestamp = IOUtils.toString(inputStream, \"UTF-8\");\n         inputStream.close();\n         try {\n-            long modTime = Long.parseLong(timestamp);\n-            return modTime;\n+            long updateTime = Long.parseLong(timestamp);\n+            return updateTime;\n         } catch (NumberFormatException e) {\n-            LOG.error(\"Invalid blobstore modtime {} in file {}\", timestamp, modTimeFile);\n+            LOG.error(\"Invalid blobstore update time {} in file {}\", timestamp, updateTimeFile);\n             return -1L;\n         }\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTg0MTg0MA==", "url": "https://github.com/apache/storm/pull/3363#discussion_r555841840", "bodyText": "nit: last updated", "author": "Ethanlm", "createdAt": "2021-01-12T15:07:21Z", "path": "storm-client/src/jvm/org/apache/storm/blobstore/ClientBlobStore.java", "diffHunk": "@@ -182,5 +183,12 @@ public final void setBlobMeta(String key, SettableBlobMeta meta) throws Authoriz\n         void run(ClientBlobStore blobStore) throws Exception;\n     }\n \n-\n+    /**\n+     * Client facing API to get the last update time of existing blobs in a blobstore.  This only required for use on\n+     * supervisors.\n+     *\n+     * @return the timestamp of when the blobstore was last modified.  -1L if the blobstore", "originalCommit": "0eca24e59a1e3aee1ea6ba56bd223513953c037d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "fe38f29aa506de64e9e292738915c9141e4f433f", "chunk": "diff --git a/storm-client/src/jvm/org/apache/storm/blobstore/ClientBlobStore.java b/storm-client/src/jvm/org/apache/storm/blobstore/ClientBlobStore.java\nindex 02808768d..02b284fcb 100644\n--- a/storm-client/src/jvm/org/apache/storm/blobstore/ClientBlobStore.java\n+++ b/storm-client/src/jvm/org/apache/storm/blobstore/ClientBlobStore.java\n\n@@ -184,10 +184,10 @@ public abstract class ClientBlobStore implements Shutdownable, AutoCloseable {\n     }\n \n     /**\n-     * Client facing API to get the last update time of existing blobs in a blobstore.  This only required for use on\n+     * Client facing API to get the last update time of existing blobs in a blobstore.  This is only required for use on\n      * supervisors.\n      *\n-     * @return the timestamp of when the blobstore was last modified.  -1L if the blobstore\n+     * @return the timestamp of when the blobstore was last updated.  -1L if the blobstore\n      *     does not support this.\n      */\n     public abstract long getRemoteBlobstoreUpdateTime() throws IOException;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTg0MjI0Mw==", "url": "https://github.com/apache/storm/pull/3363#discussion_r555842243", "bodyText": "nit: This is", "author": "Ethanlm", "createdAt": "2021-01-12T15:07:56Z", "path": "storm-client/src/jvm/org/apache/storm/blobstore/ClientBlobStore.java", "diffHunk": "@@ -182,5 +183,12 @@ public final void setBlobMeta(String key, SettableBlobMeta meta) throws Authoriz\n         void run(ClientBlobStore blobStore) throws Exception;\n     }\n \n-\n+    /**\n+     * Client facing API to get the last update time of existing blobs in a blobstore.  This only required for use on", "originalCommit": "0eca24e59a1e3aee1ea6ba56bd223513953c037d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "fe38f29aa506de64e9e292738915c9141e4f433f", "chunk": "diff --git a/storm-client/src/jvm/org/apache/storm/blobstore/ClientBlobStore.java b/storm-client/src/jvm/org/apache/storm/blobstore/ClientBlobStore.java\nindex 02808768d..02b284fcb 100644\n--- a/storm-client/src/jvm/org/apache/storm/blobstore/ClientBlobStore.java\n+++ b/storm-client/src/jvm/org/apache/storm/blobstore/ClientBlobStore.java\n\n@@ -184,10 +184,10 @@ public abstract class ClientBlobStore implements Shutdownable, AutoCloseable {\n     }\n \n     /**\n-     * Client facing API to get the last update time of existing blobs in a blobstore.  This only required for use on\n+     * Client facing API to get the last update time of existing blobs in a blobstore.  This is only required for use on\n      * supervisors.\n      *\n-     * @return the timestamp of when the blobstore was last modified.  -1L if the blobstore\n+     * @return the timestamp of when the blobstore was last updated.  -1L if the blobstore\n      *     does not support this.\n      */\n     public abstract long getRemoteBlobstoreUpdateTime() throws IOException;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTg0MzczNg==", "url": "https://github.com/apache/storm/pull/3363#discussion_r555843736", "bodyText": "nit: modtime  can be changed to \"update time\"", "author": "Ethanlm", "createdAt": "2021-01-12T15:10:02Z", "path": "storm-server/src/main/java/org/apache/storm/daemon/nimbus/Nimbus.java", "diffHunk": "@@ -1427,6 +1427,18 @@ public void launchServer() throws Exception {\n                     }\n                 });\n \n+            // Periodically make sure the blobstore modtime is up to date.  This could have failed if Nimbus encountered", "originalCommit": "0eca24e59a1e3aee1ea6ba56bd223513953c037d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "fe38f29aa506de64e9e292738915c9141e4f433f", "chunk": "diff --git a/storm-server/src/main/java/org/apache/storm/daemon/nimbus/Nimbus.java b/storm-server/src/main/java/org/apache/storm/daemon/nimbus/Nimbus.java\nindex 1676b9a19..54f2a6a0b 100644\n--- a/storm-server/src/main/java/org/apache/storm/daemon/nimbus/Nimbus.java\n+++ b/storm-server/src/main/java/org/apache/storm/daemon/nimbus/Nimbus.java\n\n@@ -1427,8 +1427,8 @@ public class Nimbus implements Iface, Shutdownable, DaemonCommon {\n                     }\n                 });\n \n-            // Periodically make sure the blobstore modtime is up to date.  This could have failed if Nimbus encountered\n-            // an exception updating the mod time, or due to bugs causing a missed update of the blobstore mod time on a blob\n+            // Periodically make sure the blobstore update time is up to date.  This could have failed if Nimbus encountered\n+            // an exception updating the update time, or due to bugs causing a missed update of the blobstore mod time on a blob\n             // update.\n             timer.scheduleRecurring(30, ServerConfigUtils.getLocalizerUpdateBlobInterval(conf) * 5,\n                 () -> {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTg0NDIyNQ==", "url": "https://github.com/apache/storm/pull/3363#discussion_r555844225", "bodyText": "nit: two\"mod time\" can be changed to \"update time\"", "author": "Ethanlm", "createdAt": "2021-01-12T15:10:41Z", "path": "storm-server/src/main/java/org/apache/storm/daemon/nimbus/Nimbus.java", "diffHunk": "@@ -1427,6 +1427,18 @@ public void launchServer() throws Exception {\n                     }\n                 });\n \n+            // Periodically make sure the blobstore modtime is up to date.  This could have failed if Nimbus encountered\n+            // an exception updating the mod time, or due to bugs causing a missed update of the blobstore mod time on a blob", "originalCommit": "0eca24e59a1e3aee1ea6ba56bd223513953c037d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "fe38f29aa506de64e9e292738915c9141e4f433f", "chunk": "diff --git a/storm-server/src/main/java/org/apache/storm/daemon/nimbus/Nimbus.java b/storm-server/src/main/java/org/apache/storm/daemon/nimbus/Nimbus.java\nindex 1676b9a19..54f2a6a0b 100644\n--- a/storm-server/src/main/java/org/apache/storm/daemon/nimbus/Nimbus.java\n+++ b/storm-server/src/main/java/org/apache/storm/daemon/nimbus/Nimbus.java\n\n@@ -1427,8 +1427,8 @@ public class Nimbus implements Iface, Shutdownable, DaemonCommon {\n                     }\n                 });\n \n-            // Periodically make sure the blobstore modtime is up to date.  This could have failed if Nimbus encountered\n-            // an exception updating the mod time, or due to bugs causing a missed update of the blobstore mod time on a blob\n+            // Periodically make sure the blobstore update time is up to date.  This could have failed if Nimbus encountered\n+            // an exception updating the update time, or due to bugs causing a missed update of the blobstore mod time on a blob\n             // update.\n             timer.scheduleRecurring(30, ServerConfigUtils.getLocalizerUpdateBlobInterval(conf) * 5,\n                 () -> {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTg0NDg2MA==", "url": "https://github.com/apache/storm/pull/3363#discussion_r555844860", "bodyText": "Do we need this on updateBlobReplication method too?", "author": "Ethanlm", "createdAt": "2021-01-12T15:11:31Z", "path": "storm-server/src/main/java/org/apache/storm/daemon/nimbus/Nimbus.java", "diffHunk": "@@ -3815,6 +3828,7 @@ public void setBlobMeta(String key, SettableBlobMeta meta)\n         throws AuthorizationException, KeyNotFoundException, TException {\n         try {\n             blobStore.setBlobMeta(key, meta, getSubject());\n+            blobStore.updateLastBlobUpdateTime();", "originalCommit": "0eca24e59a1e3aee1ea6ba56bd223513953c037d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTg0NTM3Mg==", "url": "https://github.com/apache/storm/pull/3363#discussion_r555845372", "bodyText": "nit: can change modtime to \"update time\"", "author": "Ethanlm", "createdAt": "2021-01-12T15:12:11Z", "path": "storm-server/src/main/java/org/apache/storm/localizer/AsyncLocalizer.java", "diffHunk": "@@ -312,6 +289,17 @@ private LocalizedResource getUserFile(String user, String key) {\n         return CompletableFuture.allOf(all);\n     }\n \n+    private long getRemoteBlobstoreUpdateTime() {\n+        try (ClientBlobStore blobStore = getClientBlobStore()) {\n+            try {\n+                return blobStore.getRemoteBlobstoreUpdateTime();\n+            } catch (IOException e) {\n+                LOG.error(\"Failed to get remote blobstore modtime\", e);", "originalCommit": "0eca24e59a1e3aee1ea6ba56bd223513953c037d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "fe38f29aa506de64e9e292738915c9141e4f433f", "chunk": "diff --git a/storm-server/src/main/java/org/apache/storm/localizer/AsyncLocalizer.java b/storm-server/src/main/java/org/apache/storm/localizer/AsyncLocalizer.java\nindex dc7c57bda..cb90b93f5 100644\n--- a/storm-server/src/main/java/org/apache/storm/localizer/AsyncLocalizer.java\n+++ b/storm-server/src/main/java/org/apache/storm/localizer/AsyncLocalizer.java\n\n@@ -294,7 +294,7 @@ public class AsyncLocalizer implements AutoCloseable {\n             try {\n                 return blobStore.getRemoteBlobstoreUpdateTime();\n             } catch (IOException e) {\n-                LOG.error(\"Failed to get remote blobstore modtime\", e);\n+                LOG.error(\"Failed to get remote blobstore update time\", e);\n                 return -1L;\n             }\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTg0NjkxMQ==", "url": "https://github.com/apache/storm/pull/3363#discussion_r555846911", "bodyText": "nit: updatedModTime can be changed to \"localUpdateTime\"", "author": "Ethanlm", "createdAt": "2021-01-12T15:14:12Z", "path": "storm-server/src/main/java/org/apache/storm/localizer/LocallyCachedBlob.java", "diffHunk": "@@ -295,6 +301,90 @@ public String getKey() {\n \n     public abstract boolean isFullyDownloaded();\n \n+    /**\n+     * Checks to see if the local blob requires update with respect to a remote blob.\n+     *\n+     * @param blobStore the client blobstore\n+     * @param remoteBlobstoreUpdateTime last update time of remote blobstore\n+     * @return true of the local blob requires update, false otherwise.\n+     *\n+     * @throws KeyNotFoundException if the remote blob is missing\n+     * @throws AuthorizationException if authorization is failed\n+     */\n+    boolean requiresUpdate(ClientBlobStore blobStore, long remoteBlobstoreUpdateTime) throws KeyNotFoundException, AuthorizationException {\n+        if (!this.isUsed()) {\n+            return false;\n+        }\n+\n+        if (!this.isFullyDownloaded()) {\n+            return true;\n+        }\n+\n+        // If we are already up to date with respect to the remote blob store, don't query\n+        // the remote blobstore for the remote file.  This reduces Hadoop namenode impact of\n+        // 100's of supervisors querying multiple blobs.\n+        if (remoteBlobstoreUpdateTime > 0 && this.localUpdateTime == remoteBlobstoreUpdateTime) {\n+            LOG.debug(\"{} is up to date, blob updatedModTime matches remote timestamp {}\", this, remoteBlobstoreUpdateTime);", "originalCommit": "0eca24e59a1e3aee1ea6ba56bd223513953c037d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "fe38f29aa506de64e9e292738915c9141e4f433f", "chunk": "diff --git a/storm-server/src/main/java/org/apache/storm/localizer/LocallyCachedBlob.java b/storm-server/src/main/java/org/apache/storm/localizer/LocallyCachedBlob.java\nindex fe2385bd2..07ebcb241 100644\n--- a/storm-server/src/main/java/org/apache/storm/localizer/LocallyCachedBlob.java\n+++ b/storm-server/src/main/java/org/apache/storm/localizer/LocallyCachedBlob.java\n\n@@ -324,7 +324,7 @@ public abstract class LocallyCachedBlob {\n         // the remote blobstore for the remote file.  This reduces Hadoop namenode impact of\n         // 100's of supervisors querying multiple blobs.\n         if (remoteBlobstoreUpdateTime > 0 && this.localUpdateTime == remoteBlobstoreUpdateTime) {\n-            LOG.debug(\"{} is up to date, blob updatedModTime matches remote timestamp {}\", this, remoteBlobstoreUpdateTime);\n+            LOG.debug(\"{} is up to date, blob localUpdateTime matches remote timestamp {}\", this, remoteBlobstoreUpdateTime);\n             return false;\n         }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTg0Nzc4Nw==", "url": "https://github.com/apache/storm/pull/3363#discussion_r555847787", "bodyText": "nit: change be changed to remoteBlobstoreModTime to remoteBlobstoreUpdateTime", "author": "Ethanlm", "createdAt": "2021-01-12T15:15:18Z", "path": "storm-server/src/main/java/org/apache/storm/localizer/AsyncLocalizer.java", "diffHunk": "@@ -261,6 +257,9 @@ private LocalizedResource getUserFile(String user, String key) {\n     }\n \n     private CompletableFuture<Void> downloadOrUpdate(Collection<? extends LocallyCachedBlob> blobs) {\n+\n+        final long remoteBlobstoreModTime = getRemoteBlobstoreUpdateTime();", "originalCommit": "0eca24e59a1e3aee1ea6ba56bd223513953c037d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "fe38f29aa506de64e9e292738915c9141e4f433f", "chunk": "diff --git a/storm-server/src/main/java/org/apache/storm/localizer/AsyncLocalizer.java b/storm-server/src/main/java/org/apache/storm/localizer/AsyncLocalizer.java\nindex dc7c57bda..cb90b93f5 100644\n--- a/storm-server/src/main/java/org/apache/storm/localizer/AsyncLocalizer.java\n+++ b/storm-server/src/main/java/org/apache/storm/localizer/AsyncLocalizer.java\n\n@@ -258,7 +258,7 @@ public class AsyncLocalizer implements AutoCloseable {\n \n     private CompletableFuture<Void> downloadOrUpdate(Collection<? extends LocallyCachedBlob> blobs) {\n \n-        final long remoteBlobstoreModTime = getRemoteBlobstoreUpdateTime();\n+        final long remoteBlobstoreUpdateTime = getRemoteBlobstoreUpdateTime();\n \n         CompletableFuture<Void>[] all = new CompletableFuture[blobs.size()];\n         int i = 0;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTg0ODAxMA==", "url": "https://github.com/apache/storm/pull/3363#discussion_r555848010", "bodyText": "nit: can be changed to remoteBlobstoreUpdateTime", "author": "Ethanlm", "createdAt": "2021-01-12T15:15:35Z", "path": "storm-server/src/main/java/org/apache/storm/localizer/AsyncLocalizer.java", "diffHunk": "@@ -271,29 +270,7 @@ private LocalizedResource getUserFile(String user, String key) {\n                     long failures = 0;\n                     while (!done) {\n                         try {\n-                            synchronized (blob) {\n-                                if (blob.isUsed()) {\n-                                    long localVersion = blob.getLocalVersion();\n-                                    long remoteVersion = blob.getRemoteVersion(blobStore);\n-                                    if (localVersion != remoteVersion || !blob.isFullyDownloaded()) {\n-                                        if (blob.isFullyDownloaded()) {\n-                                            //Avoid case of different blob version\n-                                            // when blob is not downloaded (first time download)\n-                                            numBlobUpdateVersionChanged.mark();\n-                                        }\n-                                        Timer.Context t = singleBlobLocalizationDuration.time();\n-                                        try {\n-                                            long newVersion = blob.fetchUnzipToTemp(blobStore);\n-                                            blob.informReferencesAndCommitNewVersion(newVersion);\n-                                            t.stop();\n-                                        } finally {\n-                                            blob.cleanupOrphanedData();\n-                                        }\n-                                    }\n-                                } else {\n-                                    LOG.debug(\"Skipping update of unused blob {}\", blob);\n-                                }\n-                            }\n+                            blob.update(blobStore, remoteBlobstoreModTime);", "originalCommit": "0eca24e59a1e3aee1ea6ba56bd223513953c037d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "fe38f29aa506de64e9e292738915c9141e4f433f", "chunk": "diff --git a/storm-server/src/main/java/org/apache/storm/localizer/AsyncLocalizer.java b/storm-server/src/main/java/org/apache/storm/localizer/AsyncLocalizer.java\nindex dc7c57bda..cb90b93f5 100644\n--- a/storm-server/src/main/java/org/apache/storm/localizer/AsyncLocalizer.java\n+++ b/storm-server/src/main/java/org/apache/storm/localizer/AsyncLocalizer.java\n\n@@ -270,7 +270,7 @@ public class AsyncLocalizer implements AutoCloseable {\n                     long failures = 0;\n                     while (!done) {\n                         try {\n-                            blob.update(blobStore, remoteBlobstoreModTime);\n+                            blob.update(blobStore, remoteBlobstoreUpdateTime);\n                             done = true;\n                         } catch (Exception e) {\n                             failures++;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTg0ODM4OA==", "url": "https://github.com/apache/storm/pull/3363#discussion_r555848388", "bodyText": "nit: can be changed to remoteBlobstoreUpdateTime", "author": "Ethanlm", "createdAt": "2021-01-12T15:16:01Z", "path": "storm-server/src/main/java/org/apache/storm/localizer/LocallyCachedBlob.java", "diffHunk": "@@ -295,6 +301,90 @@ public String getKey() {\n \n     public abstract boolean isFullyDownloaded();\n \n+    /**\n+     * Checks to see if the local blob requires update with respect to a remote blob.\n+     *\n+     * @param blobStore the client blobstore\n+     * @param remoteBlobstoreUpdateTime last update time of remote blobstore\n+     * @return true of the local blob requires update, false otherwise.\n+     *\n+     * @throws KeyNotFoundException if the remote blob is missing\n+     * @throws AuthorizationException if authorization is failed\n+     */\n+    boolean requiresUpdate(ClientBlobStore blobStore, long remoteBlobstoreUpdateTime) throws KeyNotFoundException, AuthorizationException {\n+        if (!this.isUsed()) {\n+            return false;\n+        }\n+\n+        if (!this.isFullyDownloaded()) {\n+            return true;\n+        }\n+\n+        // If we are already up to date with respect to the remote blob store, don't query\n+        // the remote blobstore for the remote file.  This reduces Hadoop namenode impact of\n+        // 100's of supervisors querying multiple blobs.\n+        if (remoteBlobstoreUpdateTime > 0 && this.localUpdateTime == remoteBlobstoreUpdateTime) {\n+            LOG.debug(\"{} is up to date, blob updatedModTime matches remote timestamp {}\", this, remoteBlobstoreUpdateTime);\n+            return false;\n+        }\n+\n+        long localVersion = this.getLocalVersion();\n+        long remoteVersion = this.getRemoteVersion(blobStore);\n+        if (localVersion != remoteVersion) {\n+            return true;\n+        } else {\n+            // track that we are now up to date with respect to last time the remote blobstore was updated\n+            this.localUpdateTime = remoteBlobstoreUpdateTime;\n+            return false;\n+        }\n+    }\n+\n+    /**\n+     * Downloads a blob locally.\n+     *\n+     * @param blobStore the client blobstore\n+     * @param remoteBlobstoreModTime last modification time of remote blobstore\n+     *\n+     * @throws KeyNotFoundException if the remote blob is missing\n+     * @throws AuthorizationException if authorization is failed\n+     * @throws IOException on errors\n+     */\n+    private void download(ClientBlobStore blobStore, long remoteBlobstoreModTime)", "originalCommit": "0eca24e59a1e3aee1ea6ba56bd223513953c037d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "fe38f29aa506de64e9e292738915c9141e4f433f", "chunk": "diff --git a/storm-server/src/main/java/org/apache/storm/localizer/LocallyCachedBlob.java b/storm-server/src/main/java/org/apache/storm/localizer/LocallyCachedBlob.java\nindex fe2385bd2..07ebcb241 100644\n--- a/storm-server/src/main/java/org/apache/storm/localizer/LocallyCachedBlob.java\n+++ b/storm-server/src/main/java/org/apache/storm/localizer/LocallyCachedBlob.java\n\n@@ -324,7 +324,7 @@ public abstract class LocallyCachedBlob {\n         // the remote blobstore for the remote file.  This reduces Hadoop namenode impact of\n         // 100's of supervisors querying multiple blobs.\n         if (remoteBlobstoreUpdateTime > 0 && this.localUpdateTime == remoteBlobstoreUpdateTime) {\n-            LOG.debug(\"{} is up to date, blob updatedModTime matches remote timestamp {}\", this, remoteBlobstoreUpdateTime);\n+            LOG.debug(\"{} is up to date, blob localUpdateTime matches remote timestamp {}\", this, remoteBlobstoreUpdateTime);\n             return false;\n         }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTg0ODY3NA==", "url": "https://github.com/apache/storm/pull/3363#discussion_r555848674", "bodyText": "nit: can be changed to remoteBlobstoreUpdateTime", "author": "Ethanlm", "createdAt": "2021-01-12T15:16:23Z", "path": "storm-server/src/main/java/org/apache/storm/localizer/LocallyCachedBlob.java", "diffHunk": "@@ -295,6 +301,90 @@ public String getKey() {\n \n     public abstract boolean isFullyDownloaded();\n \n+    /**\n+     * Checks to see if the local blob requires update with respect to a remote blob.\n+     *\n+     * @param blobStore the client blobstore\n+     * @param remoteBlobstoreUpdateTime last update time of remote blobstore\n+     * @return true of the local blob requires update, false otherwise.\n+     *\n+     * @throws KeyNotFoundException if the remote blob is missing\n+     * @throws AuthorizationException if authorization is failed\n+     */\n+    boolean requiresUpdate(ClientBlobStore blobStore, long remoteBlobstoreUpdateTime) throws KeyNotFoundException, AuthorizationException {\n+        if (!this.isUsed()) {\n+            return false;\n+        }\n+\n+        if (!this.isFullyDownloaded()) {\n+            return true;\n+        }\n+\n+        // If we are already up to date with respect to the remote blob store, don't query\n+        // the remote blobstore for the remote file.  This reduces Hadoop namenode impact of\n+        // 100's of supervisors querying multiple blobs.\n+        if (remoteBlobstoreUpdateTime > 0 && this.localUpdateTime == remoteBlobstoreUpdateTime) {\n+            LOG.debug(\"{} is up to date, blob updatedModTime matches remote timestamp {}\", this, remoteBlobstoreUpdateTime);\n+            return false;\n+        }\n+\n+        long localVersion = this.getLocalVersion();\n+        long remoteVersion = this.getRemoteVersion(blobStore);\n+        if (localVersion != remoteVersion) {\n+            return true;\n+        } else {\n+            // track that we are now up to date with respect to last time the remote blobstore was updated\n+            this.localUpdateTime = remoteBlobstoreUpdateTime;\n+            return false;\n+        }\n+    }\n+\n+    /**\n+     * Downloads a blob locally.\n+     *\n+     * @param blobStore the client blobstore\n+     * @param remoteBlobstoreModTime last modification time of remote blobstore\n+     *\n+     * @throws KeyNotFoundException if the remote blob is missing\n+     * @throws AuthorizationException if authorization is failed\n+     * @throws IOException on errors\n+     */\n+    private void download(ClientBlobStore blobStore, long remoteBlobstoreModTime)\n+            throws AuthorizationException, IOException, KeyNotFoundException {\n+        if (this.isFullyDownloaded()) {\n+            numBlobUpdateVersionChanged.mark();\n+        }\n+        Timer.Context timer = singleBlobLocalizationDuration.time();\n+        try {\n+            long newVersion = this.fetchUnzipToTemp(blobStore);\n+            this.informReferencesAndCommitNewVersion(newVersion);\n+            this.localUpdateTime = remoteBlobstoreModTime;\n+            LOG.debug(\"local blob {} downloaded, in sync with remote blobstore to time {}\", this, remoteBlobstoreModTime);\n+        } finally {\n+            timer.stop();\n+            this.cleanupOrphanedData();\n+        }\n+    }\n+\n+    /**\n+     * Checks and downloads a blob locally as necessary.\n+     *\n+     * @param blobStore the client blobstore\n+     * @param remoteBlobstoreModTime last modification time of remote blobstore\n+     *\n+     * @throws KeyNotFoundException if the remote blob is missing\n+     * @throws AuthorizationException if authorization is failed\n+     * @throws IOException on errors\n+     */\n+    public void update(ClientBlobStore blobStore, long remoteBlobstoreModTime)", "originalCommit": "0eca24e59a1e3aee1ea6ba56bd223513953c037d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "fe38f29aa506de64e9e292738915c9141e4f433f", "chunk": "diff --git a/storm-server/src/main/java/org/apache/storm/localizer/LocallyCachedBlob.java b/storm-server/src/main/java/org/apache/storm/localizer/LocallyCachedBlob.java\nindex fe2385bd2..07ebcb241 100644\n--- a/storm-server/src/main/java/org/apache/storm/localizer/LocallyCachedBlob.java\n+++ b/storm-server/src/main/java/org/apache/storm/localizer/LocallyCachedBlob.java\n\n@@ -324,7 +324,7 @@ public abstract class LocallyCachedBlob {\n         // the remote blobstore for the remote file.  This reduces Hadoop namenode impact of\n         // 100's of supervisors querying multiple blobs.\n         if (remoteBlobstoreUpdateTime > 0 && this.localUpdateTime == remoteBlobstoreUpdateTime) {\n-            LOG.debug(\"{} is up to date, blob updatedModTime matches remote timestamp {}\", this, remoteBlobstoreUpdateTime);\n+            LOG.debug(\"{} is up to date, blob localUpdateTime matches remote timestamp {}\", this, remoteBlobstoreUpdateTime);\n             return false;\n         }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTg0OTc1NA==", "url": "https://github.com/apache/storm/pull/3363#discussion_r555849754", "bodyText": "nit: can change modtime to update time", "author": "Ethanlm", "createdAt": "2021-01-12T15:17:44Z", "path": "storm-server/src/test/java/org/apache/storm/localizer/LocallyCachedBlobTest.java", "diffHunk": "@@ -0,0 +1,102 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one or more contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.  The ASF licenses this file to you under the Apache License, Version\n+ * 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions\n+ * and limitations under the License.\n+ */\n+\n+package org.apache.storm.localizer;\n+\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.HashMap;\n+import java.util.Map;\n+import org.apache.storm.blobstore.ClientBlobStore;\n+import org.apache.storm.daemon.supervisor.AdvancedFSOps;\n+import org.apache.storm.daemon.supervisor.IAdvancedFSOps;\n+import org.apache.storm.generated.AuthorizationException;\n+import org.apache.storm.generated.KeyNotFoundException;\n+import org.apache.storm.generated.LocalAssignment;\n+import org.apache.storm.metric.StormMetricsRegistry;\n+import org.junit.Assert;\n+import org.junit.Test;\n+import org.mockito.Mockito;\n+\n+public class LocallyCachedBlobTest {\n+    private static ClientBlobStore blobStore = Mockito.mock(ClientBlobStore.class);\n+    private static PortAndAssignment pna = new PortAndAssignmentImpl(6077, new LocalAssignment());\n+    private static Map<String, Object> conf = new HashMap<>();\n+\n+    @Test\n+    public void testNotUsed() throws KeyNotFoundException, AuthorizationException {\n+        LocallyCachedBlob blob = new LocalizedResource(\"key\", Paths.get(\"/bogus\"), false,\n+                AdvancedFSOps.make(conf), conf, \"user1\", new StormMetricsRegistry());\n+        Assert.assertFalse(blob.isUsed());\n+        Assert.assertFalse(blob.requiresUpdate(blobStore, -1L));\n+    }\n+\n+    @Test\n+    public void testNotDownloaded() throws KeyNotFoundException, AuthorizationException {\n+        LocallyCachedBlob blob = new LocalizedResource(\"key\", Paths.get(\"/bogus\"), false,\n+                AdvancedFSOps.make(conf), conf, \"user1\", new StormMetricsRegistry());\n+        blob.addReference(pna, null);\n+        Assert.assertTrue(blob.isUsed());\n+        Assert.assertFalse(blob.isFullyDownloaded());\n+        Assert.assertTrue(blob.requiresUpdate(blobStore, -1L));\n+    }\n+\n+    @Test\n+    public void testOutOfDate() throws KeyNotFoundException, AuthorizationException {\n+        TestableBlob blob = new TestableBlob(\"key\", Paths.get(\"/bogus\"), false,\n+                AdvancedFSOps.make(conf), conf, \"user1\", new StormMetricsRegistry());\n+        blob.addReference(pna, null);\n+        Assert.assertTrue(blob.isUsed());\n+        Assert.assertTrue(blob.isFullyDownloaded());\n+\n+        // validate blob needs update due to version mismatch\n+        Assert.assertTrue(blob.requiresUpdate(blobStore, -1L));\n+\n+        // when blob update time matches remote blobstore modtime, validate blob", "originalCommit": "0eca24e59a1e3aee1ea6ba56bd223513953c037d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "fe38f29aa506de64e9e292738915c9141e4f433f", "chunk": "diff --git a/storm-server/src/test/java/org/apache/storm/localizer/LocallyCachedBlobTest.java b/storm-server/src/test/java/org/apache/storm/localizer/LocallyCachedBlobTest.java\nindex a9fd372ee..a5cbf9b03 100644\n--- a/storm-server/src/test/java/org/apache/storm/localizer/LocallyCachedBlobTest.java\n+++ b/storm-server/src/test/java/org/apache/storm/localizer/LocallyCachedBlobTest.java\n\n@@ -61,16 +61,16 @@ public class LocallyCachedBlobTest {\n         // validate blob needs update due to version mismatch\n         Assert.assertTrue(blob.requiresUpdate(blobStore, -1L));\n \n-        // when blob update time matches remote blobstore modtime, validate blob\n+        // when blob update time matches remote blobstore update time, validate blob\n         // will skip looking at remote version and assume it's up to date\n         blob.localUpdateTime = 101L;\n         Assert.assertFalse(blob.requiresUpdate(blobStore, 101L));\n \n-        // now when the mod time on the remote blobstore differs, we should again see that the\n+        // now when the update time on the remote blobstore differs, we should again see that the\n         // blob version differs from the remote blobstore\n         Assert.assertTrue(blob.requiresUpdate(blobStore, 102L));\n \n-        // now validate we don't need any update as versions match, regardless of remote blobstore mod time\n+        // now validate we don't need any update as versions match, regardless of remote blobstore update time\n         blob.localVersion = blob.getRemoteVersion(blobStore);\n         Assert.assertFalse(blob.requiresUpdate(blobStore, -1L));\n         Assert.assertFalse(blob.requiresUpdate(blobStore, 101L));\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTg0OTg4NA==", "url": "https://github.com/apache/storm/pull/3363#discussion_r555849884", "bodyText": "nit: can change mod time to update time", "author": "Ethanlm", "createdAt": "2021-01-12T15:17:56Z", "path": "storm-server/src/test/java/org/apache/storm/localizer/LocallyCachedBlobTest.java", "diffHunk": "@@ -0,0 +1,102 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one or more contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.  The ASF licenses this file to you under the Apache License, Version\n+ * 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions\n+ * and limitations under the License.\n+ */\n+\n+package org.apache.storm.localizer;\n+\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.HashMap;\n+import java.util.Map;\n+import org.apache.storm.blobstore.ClientBlobStore;\n+import org.apache.storm.daemon.supervisor.AdvancedFSOps;\n+import org.apache.storm.daemon.supervisor.IAdvancedFSOps;\n+import org.apache.storm.generated.AuthorizationException;\n+import org.apache.storm.generated.KeyNotFoundException;\n+import org.apache.storm.generated.LocalAssignment;\n+import org.apache.storm.metric.StormMetricsRegistry;\n+import org.junit.Assert;\n+import org.junit.Test;\n+import org.mockito.Mockito;\n+\n+public class LocallyCachedBlobTest {\n+    private static ClientBlobStore blobStore = Mockito.mock(ClientBlobStore.class);\n+    private static PortAndAssignment pna = new PortAndAssignmentImpl(6077, new LocalAssignment());\n+    private static Map<String, Object> conf = new HashMap<>();\n+\n+    @Test\n+    public void testNotUsed() throws KeyNotFoundException, AuthorizationException {\n+        LocallyCachedBlob blob = new LocalizedResource(\"key\", Paths.get(\"/bogus\"), false,\n+                AdvancedFSOps.make(conf), conf, \"user1\", new StormMetricsRegistry());\n+        Assert.assertFalse(blob.isUsed());\n+        Assert.assertFalse(blob.requiresUpdate(blobStore, -1L));\n+    }\n+\n+    @Test\n+    public void testNotDownloaded() throws KeyNotFoundException, AuthorizationException {\n+        LocallyCachedBlob blob = new LocalizedResource(\"key\", Paths.get(\"/bogus\"), false,\n+                AdvancedFSOps.make(conf), conf, \"user1\", new StormMetricsRegistry());\n+        blob.addReference(pna, null);\n+        Assert.assertTrue(blob.isUsed());\n+        Assert.assertFalse(blob.isFullyDownloaded());\n+        Assert.assertTrue(blob.requiresUpdate(blobStore, -1L));\n+    }\n+\n+    @Test\n+    public void testOutOfDate() throws KeyNotFoundException, AuthorizationException {\n+        TestableBlob blob = new TestableBlob(\"key\", Paths.get(\"/bogus\"), false,\n+                AdvancedFSOps.make(conf), conf, \"user1\", new StormMetricsRegistry());\n+        blob.addReference(pna, null);\n+        Assert.assertTrue(blob.isUsed());\n+        Assert.assertTrue(blob.isFullyDownloaded());\n+\n+        // validate blob needs update due to version mismatch\n+        Assert.assertTrue(blob.requiresUpdate(blobStore, -1L));\n+\n+        // when blob update time matches remote blobstore modtime, validate blob\n+        // will skip looking at remote version and assume it's up to date\n+        blob.localUpdateTime = 101L;\n+        Assert.assertFalse(blob.requiresUpdate(blobStore, 101L));\n+\n+        // now when the mod time on the remote blobstore differs, we should again see that the", "originalCommit": "0eca24e59a1e3aee1ea6ba56bd223513953c037d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "fe38f29aa506de64e9e292738915c9141e4f433f", "chunk": "diff --git a/storm-server/src/test/java/org/apache/storm/localizer/LocallyCachedBlobTest.java b/storm-server/src/test/java/org/apache/storm/localizer/LocallyCachedBlobTest.java\nindex a9fd372ee..a5cbf9b03 100644\n--- a/storm-server/src/test/java/org/apache/storm/localizer/LocallyCachedBlobTest.java\n+++ b/storm-server/src/test/java/org/apache/storm/localizer/LocallyCachedBlobTest.java\n\n@@ -61,16 +61,16 @@ public class LocallyCachedBlobTest {\n         // validate blob needs update due to version mismatch\n         Assert.assertTrue(blob.requiresUpdate(blobStore, -1L));\n \n-        // when blob update time matches remote blobstore modtime, validate blob\n+        // when blob update time matches remote blobstore update time, validate blob\n         // will skip looking at remote version and assume it's up to date\n         blob.localUpdateTime = 101L;\n         Assert.assertFalse(blob.requiresUpdate(blobStore, 101L));\n \n-        // now when the mod time on the remote blobstore differs, we should again see that the\n+        // now when the update time on the remote blobstore differs, we should again see that the\n         // blob version differs from the remote blobstore\n         Assert.assertTrue(blob.requiresUpdate(blobStore, 102L));\n \n-        // now validate we don't need any update as versions match, regardless of remote blobstore mod time\n+        // now validate we don't need any update as versions match, regardless of remote blobstore update time\n         blob.localVersion = blob.getRemoteVersion(blobStore);\n         Assert.assertFalse(blob.requiresUpdate(blobStore, -1L));\n         Assert.assertFalse(blob.requiresUpdate(blobStore, 101L));\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTg1MDAxMQ==", "url": "https://github.com/apache/storm/pull/3363#discussion_r555850011", "bodyText": "nit: can change mod time to update time", "author": "Ethanlm", "createdAt": "2021-01-12T15:18:06Z", "path": "storm-server/src/test/java/org/apache/storm/localizer/LocallyCachedBlobTest.java", "diffHunk": "@@ -0,0 +1,102 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one or more contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.  The ASF licenses this file to you under the Apache License, Version\n+ * 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions\n+ * and limitations under the License.\n+ */\n+\n+package org.apache.storm.localizer;\n+\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.HashMap;\n+import java.util.Map;\n+import org.apache.storm.blobstore.ClientBlobStore;\n+import org.apache.storm.daemon.supervisor.AdvancedFSOps;\n+import org.apache.storm.daemon.supervisor.IAdvancedFSOps;\n+import org.apache.storm.generated.AuthorizationException;\n+import org.apache.storm.generated.KeyNotFoundException;\n+import org.apache.storm.generated.LocalAssignment;\n+import org.apache.storm.metric.StormMetricsRegistry;\n+import org.junit.Assert;\n+import org.junit.Test;\n+import org.mockito.Mockito;\n+\n+public class LocallyCachedBlobTest {\n+    private static ClientBlobStore blobStore = Mockito.mock(ClientBlobStore.class);\n+    private static PortAndAssignment pna = new PortAndAssignmentImpl(6077, new LocalAssignment());\n+    private static Map<String, Object> conf = new HashMap<>();\n+\n+    @Test\n+    public void testNotUsed() throws KeyNotFoundException, AuthorizationException {\n+        LocallyCachedBlob blob = new LocalizedResource(\"key\", Paths.get(\"/bogus\"), false,\n+                AdvancedFSOps.make(conf), conf, \"user1\", new StormMetricsRegistry());\n+        Assert.assertFalse(blob.isUsed());\n+        Assert.assertFalse(blob.requiresUpdate(blobStore, -1L));\n+    }\n+\n+    @Test\n+    public void testNotDownloaded() throws KeyNotFoundException, AuthorizationException {\n+        LocallyCachedBlob blob = new LocalizedResource(\"key\", Paths.get(\"/bogus\"), false,\n+                AdvancedFSOps.make(conf), conf, \"user1\", new StormMetricsRegistry());\n+        blob.addReference(pna, null);\n+        Assert.assertTrue(blob.isUsed());\n+        Assert.assertFalse(blob.isFullyDownloaded());\n+        Assert.assertTrue(blob.requiresUpdate(blobStore, -1L));\n+    }\n+\n+    @Test\n+    public void testOutOfDate() throws KeyNotFoundException, AuthorizationException {\n+        TestableBlob blob = new TestableBlob(\"key\", Paths.get(\"/bogus\"), false,\n+                AdvancedFSOps.make(conf), conf, \"user1\", new StormMetricsRegistry());\n+        blob.addReference(pna, null);\n+        Assert.assertTrue(blob.isUsed());\n+        Assert.assertTrue(blob.isFullyDownloaded());\n+\n+        // validate blob needs update due to version mismatch\n+        Assert.assertTrue(blob.requiresUpdate(blobStore, -1L));\n+\n+        // when blob update time matches remote blobstore modtime, validate blob\n+        // will skip looking at remote version and assume it's up to date\n+        blob.localUpdateTime = 101L;\n+        Assert.assertFalse(blob.requiresUpdate(blobStore, 101L));\n+\n+        // now when the mod time on the remote blobstore differs, we should again see that the\n+        // blob version differs from the remote blobstore\n+        Assert.assertTrue(blob.requiresUpdate(blobStore, 102L));\n+\n+        // now validate we don't need any update as versions match, regardless of remote blobstore mod time", "originalCommit": "0eca24e59a1e3aee1ea6ba56bd223513953c037d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "fe38f29aa506de64e9e292738915c9141e4f433f", "chunk": "diff --git a/storm-server/src/test/java/org/apache/storm/localizer/LocallyCachedBlobTest.java b/storm-server/src/test/java/org/apache/storm/localizer/LocallyCachedBlobTest.java\nindex a9fd372ee..a5cbf9b03 100644\n--- a/storm-server/src/test/java/org/apache/storm/localizer/LocallyCachedBlobTest.java\n+++ b/storm-server/src/test/java/org/apache/storm/localizer/LocallyCachedBlobTest.java\n\n@@ -61,16 +61,16 @@ public class LocallyCachedBlobTest {\n         // validate blob needs update due to version mismatch\n         Assert.assertTrue(blob.requiresUpdate(blobStore, -1L));\n \n-        // when blob update time matches remote blobstore modtime, validate blob\n+        // when blob update time matches remote blobstore update time, validate blob\n         // will skip looking at remote version and assume it's up to date\n         blob.localUpdateTime = 101L;\n         Assert.assertFalse(blob.requiresUpdate(blobStore, 101L));\n \n-        // now when the mod time on the remote blobstore differs, we should again see that the\n+        // now when the update time on the remote blobstore differs, we should again see that the\n         // blob version differs from the remote blobstore\n         Assert.assertTrue(blob.requiresUpdate(blobStore, 102L));\n \n-        // now validate we don't need any update as versions match, regardless of remote blobstore mod time\n+        // now validate we don't need any update as versions match, regardless of remote blobstore update time\n         blob.localVersion = blob.getRemoteVersion(blobStore);\n         Assert.assertFalse(blob.requiresUpdate(blobStore, -1L));\n         Assert.assertFalse(blob.requiresUpdate(blobStore, 101L));\n"}}, {"oid": "fe38f29aa506de64e9e292738915c9141e4f433f", "url": "https://github.com/apache/storm/commit/fe38f29aa506de64e9e292738915c9141e4f433f", "message": "STORM-3724 change mod time to update time, add update on setting blob replication", "committedDate": "2021-01-13T19:00:54Z", "type": "commit"}]}