{"pr_number": 3267, "pr_title": "STORM-3634 validate numa ports contained in supervisor.slots.ports", "pr_createdAt": "2020-05-12T19:44:00Z", "pr_url": "https://github.com/apache/storm/pull/3267", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA1NDQ2Ng==", "url": "https://github.com/apache/storm/pull/3267#discussion_r424054466", "bodyText": "Lately, we added NUMA support, so if getNumaPorts is configured and not empty, numaPorts should be used otherwise it can default to slots_ports. Since we are providing more than one place to configure ports, I think it is implied that NUMA one is newer and should win if configured. No need to stop supervisor daemon.", "author": "kishorvpatil", "createdAt": "2020-05-12T21:50:24Z", "path": "storm-server/src/main/java/org/apache/storm/daemon/supervisor/Supervisor.java", "diffHunk": "@@ -327,6 +330,15 @@ public void launch() throws Exception {\n         LOG.info(\"Starting supervisor with id {} at host {}.\", getId(), getHostName());\n     }\n \n+    private void validateConf() {\n+        List<Number> ports = (List<Number>) conf.get(DaemonConfig.SUPERVISOR_SLOTS_PORTS);\n+        Set<Integer> numaPorts = SupervisorUtils.getNumaPorts(conf);\n+        numaPorts.removeAll(ports);\n+        if (numaPorts.size() > 0) {", "originalCommit": "31fa0361724906d686a1895f74c6ee19e98adc13", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA1NTE0NA==", "url": "https://github.com/apache/storm/pull/3267#discussion_r424055144", "bodyText": "To avoid user confusion, we should update Java Documentation on configuration suggesting that if numa_ports are configured they take precedence over slots.ports.", "author": "kishorvpatil", "createdAt": "2020-05-12T21:51:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA1NDQ2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA2Mjc1OQ==", "url": "https://github.com/apache/storm/pull/3267#discussion_r424062759", "bodyText": "That's also fine with me. But yes we need documentation on this, as long as it is clear to users/maintainers", "author": "Ethanlm", "createdAt": "2020-05-12T22:09:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA1NDQ2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYzNzU0NA==", "url": "https://github.com/apache/storm/pull/3267#discussion_r424637544", "bodyText": "Updated comment in https://issues.apache.org/jira/browse/STORM-3615 to address as part of the NUMA feature documentation.", "author": "agresch", "createdAt": "2020-05-13T18:15:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA1NDQ2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY2MTkwMA==", "url": "https://github.com/apache/storm/pull/3267#discussion_r424661900", "bodyText": "@kishorvpatil - updated to add numa ports to slots ports config.", "author": "agresch", "createdAt": "2020-05-13T18:55:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA1NDQ2Ng=="}], "type": "inlineReview", "revised_code": {"commit": "2b36eae9385616a26dd0f84c3071b8c4908d57d4", "chunk": "diff --git a/storm-server/src/main/java/org/apache/storm/daemon/supervisor/Supervisor.java b/storm-server/src/main/java/org/apache/storm/daemon/supervisor/Supervisor.java\nindex ac16f40e4..ce597deba 100644\n--- a/storm-server/src/main/java/org/apache/storm/daemon/supervisor/Supervisor.java\n+++ b/storm-server/src/main/java/org/apache/storm/daemon/supervisor/Supervisor.java\n\n@@ -330,15 +327,6 @@ public class Supervisor implements DaemonCommon, AutoCloseable {\n         LOG.info(\"Starting supervisor with id {} at host {}.\", getId(), getHostName());\n     }\n \n-    private void validateConf() {\n-        List<Number> ports = (List<Number>) conf.get(DaemonConfig.SUPERVISOR_SLOTS_PORTS);\n-        Set<Integer> numaPorts = SupervisorUtils.getNumaPorts(conf);\n-        numaPorts.removeAll(ports);\n-        if (numaPorts.size() > 0) {\n-            throw new RuntimeException(\"numa ports \" + numaPorts + \" not configured in \" + DaemonConfig.SUPERVISOR_SLOTS_PORTS);\n-        }\n-    }\n-\n     /**\n      * start distribute supervisor.\n      */\n"}}, {"oid": "2b36eae9385616a26dd0f84c3071b8c4908d57d4", "url": "https://github.com/apache/storm/commit/2b36eae9385616a26dd0f84c3071b8c4908d57d4", "message": "STORM-3634 add missing numa ports to supervisor.slots.ports", "committedDate": "2020-05-14T16:46:14Z", "type": "commit"}, {"oid": "2b36eae9385616a26dd0f84c3071b8c4908d57d4", "url": "https://github.com/apache/storm/commit/2b36eae9385616a26dd0f84c3071b8c4908d57d4", "message": "STORM-3634 add missing numa ports to supervisor.slots.ports", "committedDate": "2020-05-14T16:46:14Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM0MjgwMQ==", "url": "https://github.com/apache/storm/pull/3267#discussion_r425342801", "bodyText": "Should we make them match?\nIf there are ports in SUPERVISOR_SLOTS_PORTS not specified in numa.ports, will there be any issue?\nOne issue I can see is it will create ports that will possibly never be used.", "author": "Ethanlm", "createdAt": "2020-05-14T18:21:59Z", "path": "storm-server/src/main/java/org/apache/storm/daemon/supervisor/SupervisorUtils.java", "diffHunk": "@@ -72,6 +75,33 @@ public static String getNumaIdForPort(Integer port, Map<String, Object> supervis\n         return null;\n     }\n \n+    /**\n+     * gets the set of all configured numa ports for a specific supervisor.\n+     * @param supervisorConf supervisorConf\n+     * @return set of all numa ports\n+     */\n+    public static Set<Integer> getNumaPorts(Map<String, Object> supervisorConf) {\n+        Set<Integer> numaPorts = new HashSet<>();\n+        Map<String, Object> validatedNumaMap = getNumaMap(supervisorConf);\n+        for (Map.Entry<String, Object> numaEntry : validatedNumaMap.entrySet()) {\n+            Map<String, Object> numaMap  = (Map<String, Object>) numaEntry.getValue();\n+            List<Integer> portList = (List<Integer>) numaMap.get(NUMA_PORTS);\n+            numaPorts.addAll(portList);\n+        }\n+        return numaPorts;\n+    }\n+\n+    public static List<Integer> getSlotsPorts(Map<String, Object> supervisorConf) {\n+        List<Integer> slotsPorts = (List<Integer>) supervisorConf.getOrDefault(DaemonConfig.SUPERVISOR_SLOTS_PORTS,\n+                new ArrayList<>());\n+        // It's possible we have numaPorts specified that weren't configured in SUPERVISOR_SLOTS_PORTS.  Make\n+        // sure we handle these ports as well.\n+        Set<Integer> numaPorts = SupervisorUtils.getNumaPorts(supervisorConf);\n+        numaPorts.removeAll(slotsPorts);\n+        slotsPorts.addAll(numaPorts);\n+        return slotsPorts;", "originalCommit": "2b36eae9385616a26dd0f84c3071b8c4908d57d4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}