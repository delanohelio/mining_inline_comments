{"pr_number": 3294, "pr_title": "STORM-3648 add meter to track worker heartbeat rate", "pr_createdAt": "2020-06-24T16:35:50Z", "pr_url": "https://github.com/apache/storm/pull/3294", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTc0MTU1NA==", "url": "https://github.com/apache/storm/pull/3294#discussion_r445741554", "bodyText": "It is better to not hardcode it. We can use SYSTEM_COMPONENT_ID, SYSTEM_TASK_ID. And it looks like it doesn't make much sense to have streamId here.", "author": "Ethanlm", "createdAt": "2020-06-25T18:03:36Z", "path": "storm-client/src/jvm/org/apache/storm/daemon/worker/Worker.java", "diffHunk": "@@ -196,6 +198,8 @@ private Object loadWorker(IStateStorage stateStorage, IStormClusterState stormCl\n         throws Exception {\n         workerState = new WorkerState(conf, context, topologyId, assignmentId, supervisorIfaceSupplier, port, workerId,\n                                       topologyConf, stateStorage, stormClusterState, autoCreds, metricRegistry);\n+        this.heatbeatMeter = metricRegistry.meter(\"doHeartbeat-calls\", workerState.getWorkerTopologyContext(),\n+                \"__system\", -1, \"default\");", "originalCommit": "330775c03478b7ca5b03a502bfe643d784ee863f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTc0OTU0Mg==", "url": "https://github.com/apache/storm/pull/3294#discussion_r445749542", "bodyText": "Would you prefer I pass in \"\" for streamId?  Or are you indicating we should have a metric name convention that allows skipping inclusion of stream?", "author": "agresch", "createdAt": "2020-06-25T18:18:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTc0MTU1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTc1MTc0MA==", "url": "https://github.com/apache/storm/pull/3294#discussion_r445751740", "bodyText": "I see there is already a metricName function https://github.com/apache/storm/blob/master/storm-client/src/jvm/org/apache/storm/metrics2/StormMetricRegistry.java#L244 which doesn't take streamId", "author": "Ethanlm", "createdAt": "2020-06-25T18:22:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTc0MTU1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTc1MjY3Mw==", "url": "https://github.com/apache/storm/pull/3294#discussion_r445752673", "bodyText": "Also I feel like the metrics should have the key before the value, for example, we now have\nxx.<compId>.<taskId>.yy.\nI think it should be xx.componentId.<compId>.taskId.<taskId>.yy so the values are more readable. But this is a separate issue.", "author": "Ethanlm", "createdAt": "2020-06-25T18:23:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTc0MTU1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjIyNTA1Ng==", "url": "https://github.com/apache/storm/pull/3294#discussion_r446225056", "bodyText": "@Ethanlm - updated", "author": "agresch", "createdAt": "2020-06-26T14:39:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTc0MTU1NA=="}], "type": "inlineReview", "revised_code": {"commit": "2643f6952c6258dcd45581aa8a9eadc7eb11ad8f", "chunk": "diff --git a/storm-client/src/jvm/org/apache/storm/daemon/worker/Worker.java b/storm-client/src/jvm/org/apache/storm/daemon/worker/Worker.java\nindex 7e2b5bb10..ee8e005a8 100644\n--- a/storm-client/src/jvm/org/apache/storm/daemon/worker/Worker.java\n+++ b/storm-client/src/jvm/org/apache/storm/daemon/worker/Worker.java\n\n@@ -199,7 +199,7 @@ public class Worker implements Shutdownable, DaemonCommon {\n         workerState = new WorkerState(conf, context, topologyId, assignmentId, supervisorIfaceSupplier, port, workerId,\n                                       topologyConf, stateStorage, stormClusterState, autoCreds, metricRegistry);\n         this.heatbeatMeter = metricRegistry.meter(\"doHeartbeat-calls\", workerState.getWorkerTopologyContext(),\n-                \"__system\", -1, \"default\");\n+                Constants.SYSTEM_COMPONENT_ID, (int) Constants.SYSTEM_TASK_ID);\n \n         // Heartbeat here so that worker process dies if this fails\n         // it's important that worker heartbeat to supervisor ASAP so that supervisor knows\n"}}, {"oid": "2643f6952c6258dcd45581aa8a9eadc7eb11ad8f", "url": "https://github.com/apache/storm/commit/2643f6952c6258dcd45581aa8a9eadc7eb11ad8f", "message": "STORM-3648 add meter to track worker heartbeat rate", "committedDate": "2020-06-26T14:37:57Z", "type": "commit"}, {"oid": "2643f6952c6258dcd45581aa8a9eadc7eb11ad8f", "url": "https://github.com/apache/storm/commit/2643f6952c6258dcd45581aa8a9eadc7eb11ad8f", "message": "STORM-3648 add meter to track worker heartbeat rate", "committedDate": "2020-06-26T14:37:57Z", "type": "forcePushed"}]}