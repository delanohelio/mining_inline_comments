{"pr_number": 4304, "pr_title": "Add rpc method 'getaddressbalance'", "pr_createdAt": "2020-06-14T17:34:08Z", "pr_url": "https://github.com/bisq-network/bisq/pull/4304", "timeline": [{"oid": "b1146fdd12ad89e94e38a8853e316f964824d67c", "url": "https://github.com/bisq-network/bisq/commit/b1146fdd12ad89e94e38a8853e316f964824d67c", "message": "Rename CoreWalletService -> CoreWalletsService\n\nThis change fixes the ambiguity in the original class name, which\nimplied it was a btc wallet service, not a bsq and btc wallets service.", "committedDate": "2020-06-12T18:24:01Z", "type": "commit"}, {"oid": "ec66b14986bb0a9f3369009aafc541add4e65f03", "url": "https://github.com/bisq-network/bisq/commit/ec66b14986bb0a9f3369009aafc541add4e65f03", "message": "Add rpc wallet(s) protection tests\n\nThis commit includes the following changes:\n\n * New tests for methods `lockwallet`, `unlockwallet`,\n   `removewalletpassword`, and `setwalletpassword`.\n\n * New `getbalance` method error handing tests to verify\n   error message correctness when wallet is locked.\n\n * Update to `getversion` method test -- now expects `1.3.4`.\n\n * Check for new `[params]` column header in help text.", "committedDate": "2020-06-12T18:56:19Z", "type": "commit"}, {"oid": "85c96764fb3adaa25e8366d547be9d05e635f1bc", "url": "https://github.com/bisq-network/bisq/commit/85c96764fb3adaa25e8366d547be9d05e635f1bc", "message": "Add rpc method 'getfundingaddresses'\n\nThis addresses task #1 in issue https://github.com/bisq-network/bisq/issues/4257.\n\nThis new gRPC WalletService method displays the BTC wallet's list of\nreceiving addresses.  The balance and number of confirmations\nfor the most recent transaction is displayed to the right of each\naddress.  Instead of returning a gRPC data structure to the client,\nthe service method returns a formatted String.\n\nIf the BTC wallet has no unused addresses, one will be created and\nincluded in the returned list, and it can be used to fund the wallet.\n\nThe new method required injection of the BtcWalletService into CoreWalletsService,\nand the usual boilerplate changes to grpc.proto, CliMain, and GrpcWalletService.\n\nSome of the next PRs (for #4257) will require some common functionality within\nCoreWalletsService, so these additional changes were included:\n\n  * a private, class level formatSatoshis function\n  * a public getNumConfirmationsForMostRecentTransaction method\n  * a public getAddressBalance method\n  * a private getAddressEntry method\n\nA unit test that verifies a successful return status was added to cli/test.sh.", "committedDate": "2020-06-13T22:59:45Z", "type": "commit"}, {"oid": "2e415de4adaf54a9f9c926fa4557af95e6fdfbe4", "url": "https://github.com/bisq-network/bisq/commit/2e415de4adaf54a9f9c926fa4557af95e6fdfbe4", "message": "Replace duplicate code in getFundingAddresses\n\nCleaned up the method body and improved the returned string's\nformatting.  Also added a line for this method in the CLI help text.", "committedDate": "2020-06-14T16:05:37Z", "type": "commit"}, {"oid": "b1228e5ea72211c9010943db1aa8bf46675417a6", "url": "https://github.com/bisq-network/bisq/commit/b1228e5ea72211c9010943db1aa8bf46675417a6", "message": "Add rpc method 'getaddressbalance'\n\nThis addresses task 2 in issue 4257\n\thttps://github.com/bisq-network/bisq/issues/4257\n\nThis new gRPC Wallet service method displays the balance and number\nof confimirmations of the most recent transaction for the given BTC\nwallet address.\n\nThe new method required the usual boilerplate changes to grpc.proto,\nCliMain, and GrpcWalletService.\n\nTwo unit tests to check error msgs was added to cli/test.sh.", "committedDate": "2020-06-14T17:23:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjkwOTQzMA==", "url": "https://github.com/bisq-network/bisq/pull/4304#discussion_r442909430", "bodyText": "A note: formatting logic in getAddressInfo and getFundingAddresses has a fair amount of duplication. Not making suggestions yet, will see what's in the next PRs.", "author": "dmos62", "createdAt": "2020-06-19T15:35:37Z", "path": "core/src/main/java/bisq/core/grpc/CoreWalletsService.java", "diffHunk": "@@ -80,6 +80,15 @@ public long getAddressBalance(String addressString) {\n         return btcWalletService.getBalanceForAddress(address).value;\n     }\n \n+    public String getAddressBalanceInfo(String addressString) {\n+        var satoshiBalance = getAddressBalance(addressString);\n+        var btcBalance = formatSatoshis.apply(satoshiBalance);\n+        var numConfirmations = getNumConfirmationsForMostRecentTransaction(addressString);\n+        return addressString\n+                + \"  balance: \" + format(\"%13s\", btcBalance)\n+                + ((numConfirmations > 0) ? (\"  confirmations: \" + format(\"%6d\", numConfirmations)) : \"\");", "originalCommit": "b1228e5ea72211c9010943db1aa8bf46675417a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk1NzUzOQ==", "url": "https://github.com/bisq-network/bisq/pull/4304#discussion_r442957539", "bodyText": "I am going to take a look at this next, and any changes I make will be in a new PR associated with a  5-getpaymentaccts sub branch.", "author": "ghubstan", "createdAt": "2020-06-19T17:15:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjkwOTQzMA=="}], "type": "inlineReview", "revised_code": null}]}