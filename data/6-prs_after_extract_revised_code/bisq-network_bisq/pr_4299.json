{"pr_number": 4299, "pr_title": "Add rpc method 'getfundingaddresses'", "pr_createdAt": "2020-06-13T23:12:30Z", "pr_url": "https://github.com/bisq-network/bisq/pull/4299", "timeline": [{"oid": "b1146fdd12ad89e94e38a8853e316f964824d67c", "url": "https://github.com/bisq-network/bisq/commit/b1146fdd12ad89e94e38a8853e316f964824d67c", "message": "Rename CoreWalletService -> CoreWalletsService\n\nThis change fixes the ambiguity in the original class name, which\nimplied it was a btc wallet service, not a bsq and btc wallets service.", "committedDate": "2020-06-12T18:24:01Z", "type": "commit"}, {"oid": "ec66b14986bb0a9f3369009aafc541add4e65f03", "url": "https://github.com/bisq-network/bisq/commit/ec66b14986bb0a9f3369009aafc541add4e65f03", "message": "Add rpc wallet(s) protection tests\n\nThis commit includes the following changes:\n\n * New tests for methods `lockwallet`, `unlockwallet`,\n   `removewalletpassword`, and `setwalletpassword`.\n\n * New `getbalance` method error handing tests to verify\n   error message correctness when wallet is locked.\n\n * Update to `getversion` method test -- now expects `1.3.4`.\n\n * Check for new `[params]` column header in help text.", "committedDate": "2020-06-12T18:56:19Z", "type": "commit"}, {"oid": "85c96764fb3adaa25e8366d547be9d05e635f1bc", "url": "https://github.com/bisq-network/bisq/commit/85c96764fb3adaa25e8366d547be9d05e635f1bc", "message": "Add rpc method 'getfundingaddresses'\n\nThis addresses task #1 in issue https://github.com/bisq-network/bisq/issues/4257.\n\nThis new gRPC WalletService method displays the BTC wallet's list of\nreceiving addresses.  The balance and number of confirmations\nfor the most recent transaction is displayed to the right of each\naddress.  Instead of returning a gRPC data structure to the client,\nthe service method returns a formatted String.\n\nIf the BTC wallet has no unused addresses, one will be created and\nincluded in the returned list, and it can be used to fund the wallet.\n\nThe new method required injection of the BtcWalletService into CoreWalletsService,\nand the usual boilerplate changes to grpc.proto, CliMain, and GrpcWalletService.\n\nSome of the next PRs (for #4257) will require some common functionality within\nCoreWalletsService, so these additional changes were included:\n\n  * a private, class level formatSatoshis function\n  * a public getNumConfirmationsForMostRecentTransaction method\n  * a public getAddressBalance method\n  * a private getAddressEntry method\n\nA unit test that verifies a successful return status was added to cli/test.sh.", "committedDate": "2020-06-13T22:59:45Z", "type": "commit"}, {"oid": "2e415de4adaf54a9f9c926fa4557af95e6fdfbe4", "url": "https://github.com/bisq-network/bisq/commit/2e415de4adaf54a9f9c926fa4557af95e6fdfbe4", "message": "Replace duplicate code in getFundingAddresses\n\nCleaned up the method body and improved the returned string's\nformatting.  Also added a line for this method in the CLI help text.", "committedDate": "2020-06-14T16:05:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDc2OTAzMg==", "url": "https://github.com/bisq-network/bisq/pull/4299#discussion_r440769032", "bodyText": "Checks of this type will probably be performed for most API endpoints. It would be nice to eventually see them moved into their own methods (checkThatWalletsAreAvailable(), etc.). Not requesting this change at this point.", "author": "dmos62", "createdAt": "2020-06-16T11:07:12Z", "path": "core/src/main/java/bisq/core/grpc/CoreWalletsService.java", "diffHunk": "@@ -50,6 +75,68 @@ public long getAvailableBalance() {\n         return balance.getValue();\n     }\n \n+    public long getAddressBalance(String addressString) {\n+        Address address = getAddressEntry(addressString).getAddress();\n+        return btcWalletService.getBalanceForAddress(address).value;\n+    }\n+\n+    public String getFundingAddresses() {\n+        if (!walletsManager.areWalletsAvailable())\n+            throw new IllegalStateException(\"wallet is not yet available\");\n+\n+        if (walletsManager.areWalletsEncrypted() && tempAesKey == null)\n+            throw new IllegalStateException(\"wallet is locked\");", "originalCommit": "2e415de4adaf54a9f9c926fa4557af95e6fdfbe4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDg5NDQzOA==", "url": "https://github.com/bisq-network/bisq/pull/4299#discussion_r440894438", "bodyText": "How about verifyEncryptedWalletIsUnlocked() , throwing the exception if the wallet is encrypted, but not temporarily unlocked by a call to unlockWallet(String password, long timeout) ?\n\"Available\" is taken;  it means the daemon is sufficiently warmed up and the btc & bsq wallets are not null. See walletsManager.areWalletsAvailable().\nGood call.  I'll create a new PR for this today.", "author": "ghubstan", "createdAt": "2020-06-16T14:27:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDc2OTAzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDkxNDg2OA==", "url": "https://github.com/bisq-network/bisq/pull/4299#discussion_r440914868", "bodyText": "What I see as a reusable and complex unit is not the predicate, but the pair of a predicate and the throwing of the exception. For example, checking if a wallet is locked and, if so, throwing an exception saying that it is locked. So the method I'm suggesting  would look like this:\nprivate void aGoodName() {\n  if (walletsManager.areWalletsEncrypted() && tempAesKey == null\n    throw new IllegalStateException(\"wallet is locked\");\n}\n\nDoes that make sense?", "author": "dmos62", "createdAt": "2020-06-16T14:54:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDc2OTAzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDkyNDE0Mg==", "url": "https://github.com/bisq-network/bisq/pull/4299#discussion_r440924142", "bodyText": "I'm preparing to test this now:\n   // Throws a RuntimeException if wallets are encrypted and locked.\n    private void verifyEncryptedWalletIsUnlocked() {\n        if (walletsManager.areWalletsEncrypted() && tempAesKey == null)\n            throw new IllegalStateException(\"wallet is locked\");\n    }", "author": "ghubstan", "createdAt": "2020-06-16T15:05:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDc2OTAzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk2NDM2OQ==", "url": "https://github.com/bisq-network/bisq/pull/4299#discussion_r440964369", "bodyText": "Requested change is in PR 4312.", "author": "ghubstan", "createdAt": "2020-06-16T15:58:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDc2OTAzMg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDc5ODE0NA==", "url": "https://github.com/bisq-network/bisq/pull/4299#discussion_r440798144", "bodyText": "The Tuple3 feels unnecessary. Its main use seems to be to cache the balances, which are needed for checking if we need to generate a new address, otherwise we could get all that while formatting and a structure to hold these intermediary results wouldn't be necessary. Since the problem is basically caching, we can just do that explicitly by memoizing getAddressBalance:\nvar balances = CacheLoader.from(getAddressBalance);\n// Usage:\nvar someBalance = balances.load(someAddress);\n\nhttps://guava.dev/releases/20.0/api/docs/com/google/common/cache/CacheLoader.html\nThat will make the rest of the method simpler and shorter.", "author": "dmos62", "createdAt": "2020-06-16T12:05:31Z", "path": "core/src/main/java/bisq/core/grpc/CoreWalletsService.java", "diffHunk": "@@ -50,6 +75,68 @@ public long getAvailableBalance() {\n         return balance.getValue();\n     }\n \n+    public long getAddressBalance(String addressString) {\n+        Address address = getAddressEntry(addressString).getAddress();\n+        return btcWalletService.getBalanceForAddress(address).value;\n+    }\n+\n+    public String getFundingAddresses() {\n+        if (!walletsManager.areWalletsAvailable())\n+            throw new IllegalStateException(\"wallet is not yet available\");\n+\n+        if (walletsManager.areWalletsEncrypted() && tempAesKey == null)\n+            throw new IllegalStateException(\"wallet is locked\");\n+\n+        // Create a new funding address if none exists.\n+        if (btcWalletService.getAvailableAddressEntries().size() == 0)\n+            btcWalletService.getFreshAddressEntry();\n+\n+        // Populate a list of Tuple3<AddressString, Balance, NumConfirmations>\n+        List<Tuple3<String, Long, Integer>> addrBalanceConfirms =\n+                btcWalletService.getAvailableAddressEntries().stream()\n+                        .map(a -> new Tuple3<>(a.getAddressString(),\n+                                getAddressBalance(a.getAddressString()),\n+                                getNumConfirmationsForMostRecentTransaction(a.getAddressString())))\n+                        .collect(Collectors.toList());\n+\n+        // Check to see if at least one of the existing addresses has a zero balance.\n+        boolean hasZeroBalance = false;\n+        for (Tuple3<String, Long, Integer> abc : addrBalanceConfirms) {\n+            if (abc.second == 0) {\n+                hasZeroBalance = true;\n+                break;\n+            }\n+        }\n+        if (!hasZeroBalance) {\n+            // None of the existing addresses have a zero balance, create a new address.\n+            addrBalanceConfirms.add(\n+                    new Tuple3<>(btcWalletService.getFreshAddressEntry().getAddressString(),\n+                            0L,\n+                            0));\n+        }\n+\n+        // Iterate the list of Tuple3<AddressString, Balance, NumConfirmations> objects\n+        // and build the formatted info string.\n+        StringBuilder addressInfoBuilder = new StringBuilder();\n+        addrBalanceConfirms.forEach(a -> {\n+            var btcBalance = formatSatoshis.apply(a.second);\n+            var numConfirmations = getNumConfirmationsForMostRecentTransaction(a.first);\n+            String addressInfo = \"\" + a.first\n+                    + \"  balance: \" + format(\"%13s\", btcBalance)\n+                    + ((a.second > 0) ? (\"  confirmations: \" + format(\"%6d\", numConfirmations)) : \"\")\n+                    + \"\\n\";\n+            addressInfoBuilder.append(addressInfo);\n+        });\n+\n+        return addressInfoBuilder.toString().trim();\n+    }", "originalCommit": "2e415de4adaf54a9f9c926fa4557af95e6fdfbe4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ0ODk0NQ==", "url": "https://github.com/bisq-network/bisq/pull/4299#discussion_r442448945", "bodyText": "Resolved in PR 4322.", "author": "ghubstan", "createdAt": "2020-06-18T19:20:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDc5ODE0NA=="}], "type": "inlineReview", "revised_code": null}]}