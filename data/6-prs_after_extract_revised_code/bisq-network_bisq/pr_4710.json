{"pr_number": 4710, "pr_title": "Segwit fee estimation", "pr_createdAt": "2020-10-26T23:40:49Z", "pr_url": "https://github.com/bisq-network/bisq/pull/4710", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzcxNDY5NQ==", "url": "https://github.com/bisq-network/bisq/pull/4710#discussion_r513714695", "bodyText": "I assume the motivation for treating the connectedOutput == null as legacyInput is that if we dont know the inputs we use the potentially higher fee estimation. If correct, maybe a comment could help to make it more clear.", "author": "chimp1984", "createdAt": "2020-10-28T19:43:51Z", "path": "core/src/main/java/bisq/core/btc/wallet/BtcWalletService.java", "diffHunk": "@@ -548,6 +577,23 @@ public Transaction completePreparedBsqTx(Transaction preparedBsqTx,\n         return resultTx;\n     }\n \n+    private Tuple2<Integer, Integer> getNumInputs(Transaction tx) {\n+        int numLegacyInputs = 0;\n+        int numSegwitInputs = 0;\n+        for (TransactionInput input : tx.getInputs()) {\n+            TransactionOutput connectedOutput = input.getConnectedOutput();\n+            if (connectedOutput == null || ScriptPattern.isP2PKH(connectedOutput.getScriptPubKey()) ||", "originalCommit": "e823db2c86d8e24474dfbf1d28290d1ed4fcb12b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "46f0a9e45e58e141135bdeabd9522401005bc3a2", "chunk": "diff --git a/core/src/main/java/bisq/core/btc/wallet/BtcWalletService.java b/core/src/main/java/bisq/core/btc/wallet/BtcWalletService.java\nindex c324d5808f..5a3b522d33 100644\n--- a/core/src/main/java/bisq/core/btc/wallet/BtcWalletService.java\n+++ b/core/src/main/java/bisq/core/btc/wallet/BtcWalletService.java\n\n@@ -584,6 +584,8 @@ public class BtcWalletService extends WalletService {\n             TransactionOutput connectedOutput = input.getConnectedOutput();\n             if (connectedOutput == null || ScriptPattern.isP2PKH(connectedOutput.getScriptPubKey()) ||\n                 ScriptPattern.isP2PK(connectedOutput.getScriptPubKey())) {\n+                // If connectedOutput is null, we don't know here the input type. To avoid underpaying fees,\n+                // we treat it as a legacy input which will result in a higher fee estimation.\n                 numLegacyInputs++;\n             } else if (ScriptPattern.isP2WPKH(connectedOutput.getScriptPubKey())) {\n                 numSegwitInputs++;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzcxNTc4MA==", "url": "https://github.com/bisq-network/bisq/pull/4710#discussion_r513715780", "bodyText": "PAYOUT_TX_SIZE is not used anymore and can be deleted.", "author": "chimp1984", "createdAt": "2020-10-28T19:45:47Z", "path": "core/src/main/java/bisq/core/btc/TxFeeEstimationService.java", "diffHunk": "@@ -41,9 +41,24 @@\n  */\n @Slf4j\n public class TxFeeEstimationService {\n-    public static int TYPICAL_TX_WITH_1_INPUT_SIZE = 260;\n-    private static int DEPOSIT_TX_SIZE = 320;\n-    private static int PAYOUT_TX_SIZE = 380;\n+\n+//  Size/vsize of typical trade txs\n+//  Real txs size/vsize may vary in 1 or 2 bytes from the estimated values.\n+//  Values calculated with https://gist.github.com/oscarguindzberg/3d1349cb65d9fd9af9de0feaa3fd27ac\n+//  legacy fee tx with 1 input, maker/taker fee paid in btc size/vsize = 258\n+//  legacy deposit tx without change size/vsize = 381\n+//  legacy deposit tx with change size/vsize = 414\n+//  legacy payout tx size/vsize = 337\n+//  legacy delayed payout tx size/vsize = 302\n+//  segwit fee tx with 1 input, maker/taker fee paid in btc vsize = 173\n+//  segwit deposit tx without change vsize = 232\n+//  segwit deposit tx with change vsize = 263\n+//  segwit payout tx vsize = 169\n+//  segwit delayed payout tx vsize = 139\n+    public static int TYPICAL_TX_WITH_1_INPUT_SIZE = 175;\n+    private static int DEPOSIT_TX_SIZE = 233;\n+    private static int PAYOUT_TX_SIZE = 169;", "originalCommit": "511137f0b9b3facefe34733b7b3c59f8e38ae9f3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzc2ODE0Nw==", "url": "https://github.com/bisq-network/bisq/pull/4710#discussion_r513768147", "bodyText": "Done", "author": "oscarguindzberg", "createdAt": "2020-10-28T21:20:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzcxNTc4MA=="}], "type": "inlineReview", "revised_code": {"commit": "46f0a9e45e58e141135bdeabd9522401005bc3a2", "chunk": "diff --git a/core/src/main/java/bisq/core/btc/TxFeeEstimationService.java b/core/src/main/java/bisq/core/btc/TxFeeEstimationService.java\nindex 71648011af..eeb5a545e2 100644\n--- a/core/src/main/java/bisq/core/btc/TxFeeEstimationService.java\n+++ b/core/src/main/java/bisq/core/btc/TxFeeEstimationService.java\n\n@@ -57,7 +57,6 @@ public class TxFeeEstimationService {\n //  segwit delayed payout tx vsize = 139\n     public static int TYPICAL_TX_WITH_1_INPUT_SIZE = 175;\n     private static int DEPOSIT_TX_SIZE = 233;\n-    private static int PAYOUT_TX_SIZE = 169;\n \n     private static int BSQ_INPUT_INCREASE = 150;\n     private static int MAX_ITERATIONS = 10;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzcxNzE0Nw==", "url": "https://github.com/bisq-network/bisq/pull/4710#discussion_r513717147", "bodyText": "Maybe change comment to: \"if we cannot do the estimation we use the largest of our txs which is the deposit tx", "author": "chimp1984", "createdAt": "2020-10-28T19:48:18Z", "path": "core/src/main/java/bisq/core/btc/TxFeeEstimationService.java", "diffHunk": "@@ -87,14 +102,14 @@ public TxFeeEstimationService(FeeService feeService,\n                                                            BtcWalletService btcWalletService,\n                                                            Preferences preferences) {\n         Coin txFeePerByte = feeService.getTxFeePerByte();\n-        // We start with min taker fee size of 260\n+        // We start with min taker fee size of 175\n         int estimatedTxSize = TYPICAL_TX_WITH_1_INPUT_SIZE;\n         try {\n             estimatedTxSize = getEstimatedTxSize(List.of(tradeFee, amount), estimatedTxSize, txFeePerByte, btcWalletService);\n         } catch (InsufficientMoneyException e) {\n             if (isTaker) {\n-                // if we cannot do the estimation we use the payout tx size\n-                estimatedTxSize = PAYOUT_TX_SIZE;\n+                // if we cannot do the estimation we use the deposit tx size", "originalCommit": "511137f0b9b3facefe34733b7b3c59f8e38ae9f3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzc2ODIyMg==", "url": "https://github.com/bisq-network/bisq/pull/4710#discussion_r513768222", "bodyText": "Done", "author": "oscarguindzberg", "createdAt": "2020-10-28T21:20:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzcxNzE0Nw=="}], "type": "inlineReview", "revised_code": {"commit": "46f0a9e45e58e141135bdeabd9522401005bc3a2", "chunk": "diff --git a/core/src/main/java/bisq/core/btc/TxFeeEstimationService.java b/core/src/main/java/bisq/core/btc/TxFeeEstimationService.java\nindex 71648011af..eeb5a545e2 100644\n--- a/core/src/main/java/bisq/core/btc/TxFeeEstimationService.java\n+++ b/core/src/main/java/bisq/core/btc/TxFeeEstimationService.java\n\n@@ -108,7 +107,7 @@ public class TxFeeEstimationService {\n             estimatedTxSize = getEstimatedTxSize(List.of(tradeFee, amount), estimatedTxSize, txFeePerByte, btcWalletService);\n         } catch (InsufficientMoneyException e) {\n             if (isTaker) {\n-                // if we cannot do the estimation we use the deposit tx size\n+                // If we cannot do the estimation, we use the size o the largest of our txs which is the deposit tx.\n                 estimatedTxSize = DEPOSIT_TX_SIZE;\n             }\n             log.info(\"We cannot do the fee estimation because there are not enough funds in the wallet. This is expected \" +\n"}}, {"oid": "46f0a9e45e58e141135bdeabd9522401005bc3a2", "url": "https://github.com/bisq-network/bisq/commit/46f0a9e45e58e141135bdeabd9522401005bc3a2", "message": "Fix comment", "committedDate": "2020-10-28T21:17:18Z", "type": "forcePushed"}, {"oid": "ef97daac8998da2ae72ef6a6ac209c33a4c2223a", "url": "https://github.com/bisq-network/bisq/commit/ef97daac8998da2ae72ef6a6ac209c33a4c2223a", "message": "Use bitcoinj 0.15.8 (commit fcec3da)", "committedDate": "2020-11-05T14:47:38Z", "type": "commit"}, {"oid": "161e220a4f5464f263639e93fdbb89f468f0106f", "url": "https://github.com/bisq-network/bisq/commit/161e220a4f5464f263639e93fdbb89f468f0106f", "message": "BtcWalletService: Use segwit addresses", "committedDate": "2020-11-05T14:47:40Z", "type": "commit"}, {"oid": "06e5091f79024e5739e8b496f2aad79cf5795483", "url": "https://github.com/bisq-network/bisq/commit/06e5091f79024e5739e8b496f2aad79cf5795483", "message": "TradeWalletService use P2WSH", "committedDate": "2020-11-05T14:47:40Z", "type": "commit"}, {"oid": "4a05b6d6d5ef1175f4a3918ed500b580c186ef9e", "url": "https://github.com/bisq-network/bisq/commit/4a05b6d6d5ef1175f4a3918ed500b580c186ef9e", "message": "Revert \"Construct dummy outputs with LegacyAddress\"\n\nThis reverts commit b8f5c6e970fc29b705478aac8a655a73bed52a7e.", "committedDate": "2020-11-05T14:47:40Z", "type": "commit"}, {"oid": "22ba9a898b5ad4db64f4cc1f3089347afbb5a6c0", "url": "https://github.com/bisq-network/bisq/commit/22ba9a898b5ad4db64f4cc1f3089347afbb5a6c0", "message": "Explain why bitcoinSerialize(false) is used", "committedDate": "2020-11-05T14:47:41Z", "type": "commit"}, {"oid": "3585dc95fcda1ef27ade1bd832ee35b7ab0b222c", "url": "https://github.com/bisq-network/bisq/commit/3585dc95fcda1ef27ade1bd832ee35b7ab0b222c", "message": "Create the scriptCode the right way", "committedDate": "2020-11-05T14:47:41Z", "type": "commit"}, {"oid": "953a5f0bb547c8c390af49c6c8dd74a55aa62bd6", "url": "https://github.com/bisq-network/bisq/commit/953a5f0bb547c8c390af49c6c8dd74a55aa62bd6", "message": "Deal with P2WPKH has empty scriptSig", "committedDate": "2020-11-05T14:47:41Z", "type": "commit"}, {"oid": "d1620c4fd76f7024d40a503c2b1eabea8a786134", "url": "https://github.com/bisq-network/bisq/commit/d1620c4fd76f7024d40a503c2b1eabea8a786134", "message": "Revert \"Validate AddressEntry.segwit\"\n\nThis reverts commit e49c56527825a443b794ab74cee24b12d5b9eb45.", "committedDate": "2020-11-05T14:47:41Z", "type": "commit"}, {"oid": "a3d7c71410f0ad0f6aa7476e6d2deba9c29dda5b", "url": "https://github.com/bisq-network/bisq/commit/a3d7c71410f0ad0f6aa7476e6d2deba9c29dda5b", "message": "Set TRADE_PROTOCOL_VERSION to 3", "committedDate": "2020-11-05T14:47:41Z", "type": "commit"}, {"oid": "dffa251e1dc160b7b1bfe334b759d2b08de2c3d9", "url": "https://github.com/bisq-network/bisq/commit/dffa251e1dc160b7b1bfe334b759d2b08de2c3d9", "message": "Remove unused imports", "committedDate": "2020-11-05T14:47:41Z", "type": "commit"}, {"oid": "6bba6a526f0404701cce7c33a1a75961e64df2f1", "url": "https://github.com/bisq-network/bisq/commit/6bba6a526f0404701cce7c33a1a75961e64df2f1", "message": "Use bitcoinj 0.15.8 (commit 60b4f2f)", "committedDate": "2020-11-05T14:51:43Z", "type": "commit"}, {"oid": "b2023e236692e6ad77afd6f9379de4e275393928", "url": "https://github.com/bisq-network/bisq/commit/b2023e236692e6ad77afd6f9379de4e275393928", "message": "Use tx.getVsize()\n\nReplace tx.bitcoinSerialize().length", "committedDate": "2020-11-05T14:51:43Z", "type": "commit"}, {"oid": "7a58bfbafa19fd155ae95ba5daf12fb4fe58ce12", "url": "https://github.com/bisq-network/bisq/commit/7a58bfbafa19fd155ae95ba5daf12fb4fe58ce12", "message": "Use SegwitAddress for fee estimation", "committedDate": "2020-11-05T14:51:43Z", "type": "commit"}, {"oid": "29f23fe50c6727f8784f3af7c8de3d988ba517ac", "url": "https://github.com/bisq-network/bisq/commit/29f23fe50c6727f8784f3af7c8de3d988ba517ac", "message": "Use segwit tx sizes", "committedDate": "2020-11-05T14:51:43Z", "type": "commit"}, {"oid": "327a3584463d0cb4dbe4b529441f7f893c543687", "url": "https://github.com/bisq-network/bisq/commit/327a3584463d0cb4dbe4b529441f7f893c543687", "message": "Split segwit from legacy inputs\n\nGoal: Have a more accurate fee calculation", "committedDate": "2020-11-05T14:51:43Z", "type": "commit"}, {"oid": "5f0009e1a4ef1100ed35f0311e530b4c21416d40", "url": "https://github.com/bisq-network/bisq/commit/5f0009e1a4ef1100ed35f0311e530b4c21416d40", "message": "Explain why legacy is used by default", "committedDate": "2020-11-05T14:51:43Z", "type": "commit"}, {"oid": "0d59d5e8725cc3241e8370b3f755e7df05c4f1ec", "url": "https://github.com/bisq-network/bisq/commit/0d59d5e8725cc3241e8370b3f755e7df05c4f1ec", "message": "Remove unused PAYOUT_TX_SIZE", "committedDate": "2020-11-05T14:51:44Z", "type": "commit"}, {"oid": "7740e3e56d397e94434460ad36eec6f482c1d3e8", "url": "https://github.com/bisq-network/bisq/commit/7740e3e56d397e94434460ad36eec6f482c1d3e8", "message": "Fix comment", "committedDate": "2020-11-05T14:51:44Z", "type": "commit"}, {"oid": "7740e3e56d397e94434460ad36eec6f482c1d3e8", "url": "https://github.com/bisq-network/bisq/commit/7740e3e56d397e94434460ad36eec6f482c1d3e8", "message": "Fix comment", "committedDate": "2020-11-05T14:51:44Z", "type": "forcePushed"}]}