{"pr_number": 4453, "pr_title": "Add support for user name for Revolut accounts", "pr_createdAt": "2020-08-30T21:12:38Z", "pr_url": "https://github.com/bisq-network/bisq/pull/4453", "timeline": [{"oid": "6c60e1739d97fd2b917e0feac46e9d76501e7037", "url": "https://github.com/bisq-network/bisq/commit/6c60e1739d97fd2b917e0feac46e9d76501e7037", "message": "Add support for user name for Revolut accounts\n\nIf a user has an existing account with phone number or email as\naccount ID we show a popup at startup where we require that he sets the\nuser name. This popup has no close button so he is forced to enter a\nvalue. If there are multiple account multiple popups will be shown.\n\nTo not break signed accounts we keep accountId as internal id used for signing.\nOld accounts get a popup to add the new required field userName but accountId is\nleft unchanged. Newly created accounts fill accountId with the value of userName.\nIn the UI we only use userName.\n\nInput validation does only check for length (5-100 chars). Not sure what\nare the requirements at Revolut. Can be changes easily if anyone gets\nthe specs.", "committedDate": "2020-08-30T17:58:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDA0NjIzNQ==", "url": "https://github.com/bisq-network/bisq/pull/4453#discussion_r480046235", "bodyText": "I would like someone with knowledge of this requirement to weigh in before merging.", "author": "sqrrm", "createdAt": "2020-08-31T10:49:02Z", "path": "desktop/src/main/java/bisq/desktop/util/validation/RevolutValidator.java", "diffHunk": "@@ -17,10 +17,13 @@\n \n package bisq.desktop.util.validation;\n \n-public final class RevolutValidator extends PhoneNumberValidator {\n+public final class RevolutValidator extends LengthValidator {", "originalCommit": "6c60e1739d97fd2b917e0feac46e9d76501e7037", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTIzOTMyNQ==", "url": "https://github.com/bisq-network/bisq/pull/4453#discussion_r481239325", "bodyText": "We have to consider that even the app forces users to set userName now at startup we should not cause bigger problems if the phone number or email is used (via getuserName). Not sure if validator is used in such a potential use case, but not worth to make usage of the account impossible just because of a more strict validator. Also requirements at Revolut might change and our validation would fail then. I think we should not have a close dependency on that.", "author": "chimp1984", "createdAt": "2020-09-01T15:40:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDA0NjIzNQ=="}], "type": "inlineReview", "revised_code": {"commit": "591011e5169d7f350f09a48bdb91a24f23902cfc", "chunk": "diff --git a/desktop/src/main/java/bisq/desktop/util/validation/RevolutValidator.java b/desktop/src/main/java/bisq/desktop/util/validation/RevolutValidator.java\nindex 6005dc681a..0cf464b30a 100644\n--- a/desktop/src/main/java/bisq/desktop/util/validation/RevolutValidator.java\n+++ b/desktop/src/main/java/bisq/desktop/util/validation/RevolutValidator.java\n\n@@ -20,6 +20,10 @@ package bisq.desktop.util.validation;\n public final class RevolutValidator extends LengthValidator {\n     public RevolutValidator() {\n         // Not sure what are requirements for Revolut user names\n+        // Please keep in mind that even we force users to set user name at startup we should handle also the case\n+        // that the old accountID as phone number or email is displayed at the username text field and we do not\n+        // want to break validation in those cases. So being too strict on the validators might cause more troubles\n+        // as its worth...\n         super(5, 100);\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDA0NjQxNA==", "url": "https://github.com/bisq-network/bisq/pull/4453#discussion_r480046414", "bodyText": "Keeping lines shorter helps the reviewer. and it would also be in accordance with our style guide.", "author": "sqrrm", "createdAt": "2020-08-31T10:49:25Z", "path": "desktop/src/main/java/bisq/desktop/main/overlays/windows/UpdateRevolutAccountWindow.java", "diffHunk": "@@ -0,0 +1,96 @@\n+/*\n+ * This file is part of Bisq.\n+ *\n+ * Bisq is free software: you can redistribute it and/or modify it\n+ * under the terms of the GNU Affero General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or (at\n+ * your option) any later version.\n+ *\n+ * Bisq is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public\n+ * License for more details.\n+ *\n+ * You should have received a copy of the GNU Affero General Public License\n+ * along with Bisq. If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package bisq.desktop.main.overlays.windows;\n+\n+import bisq.desktop.components.InputTextField;\n+import bisq.desktop.main.overlays.Overlay;\n+import bisq.desktop.util.Layout;\n+import bisq.desktop.util.validation.RevolutValidator;\n+\n+import bisq.core.locale.Res;\n+import bisq.core.payment.RevolutAccount;\n+import bisq.core.user.User;\n+\n+import javafx.scene.Scene;\n+\n+import static bisq.desktop.util.FormBuilder.addInputTextField;\n+import static bisq.desktop.util.FormBuilder.addLabel;\n+\n+public class UpdateRevolutAccountWindow extends Overlay<UpdateRevolutAccountWindow> {\n+    private final RevolutValidator revolutValidator;\n+    private final RevolutAccount revolutAccount;\n+    private final User user;\n+    private InputTextField userNameInputTextField;\n+\n+    public UpdateRevolutAccountWindow(RevolutAccount revolutAccount, User user) {\n+        super();\n+        this.revolutAccount = revolutAccount;\n+        this.user = user;\n+        type = Type.Attention;\n+        hideCloseButton = true;\n+        revolutValidator = new RevolutValidator();\n+        actionButtonText = Res.get(\"shared.save\");\n+    }\n+\n+    @Override\n+    protected void setupKeyHandler(Scene scene) {\n+        // We do not support enter or escape here\n+    }\n+\n+    @Override\n+    public void show() {\n+        if (headLine == null)\n+            headLine = Res.get(\"payment.revolut.addUserNameInfo.headLine\");\n+\n+        width = 868;\n+        createGridPane();\n+        addHeadLine();\n+        addContent();\n+        addButtons();\n+        applyStyles();\n+        display();\n+    }\n+\n+    private void addContent() {\n+        addLabel(gridPane, ++rowIndex, Res.get(\"payment.account.revolut.addUserNameInfo\", Res.get(\"payment.revolut.info\"), revolutAccount.getAccountName()));", "originalCommit": "6c60e1739d97fd2b917e0feac46e9d76501e7037", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDA0NzAyMw==", "url": "https://github.com/bisq-network/bisq/pull/4453#discussion_r480047023", "bodyText": "Is this safe now that accountId can be null as well?", "author": "sqrrm", "createdAt": "2020-08-31T10:50:36Z", "path": "core/src/main/java/bisq/core/payment/payload/RevolutAccountPayload.java", "diffHunk": "@@ -95,6 +109,26 @@ public String getPaymentDetailsForTradePopup() {\n \n     @Override\n     public byte[] getAgeWitnessInputData() {\n-        return super.getAgeWitnessInputData(accountId.getBytes(StandardCharsets.UTF_8));\n+        // getAgeWitnessInputData is called at new account creation when accountId is null, we use empty string as\n+        // it has been the case before\n+        String input = this.accountId == null ? \"\" : this.accountId;\n+        return super.getAgeWitnessInputData(input.getBytes(StandardCharsets.UTF_8));\n+    }\n+\n+    public void setUserName(@Nullable String userName) {\n+        this.userName = userName;\n+        // We only set accountId to userName for new accounts. Existing accounts have accountId set with email\n+        // or phone nr. and we keep that to not break account signing.\n+        if (accountId == null) {\n+            accountId = userName;\n+        }\n+    }\n+\n+    public String getUserName() {\n+        return userName != null ? userName : accountId;", "originalCommit": "6c60e1739d97fd2b917e0feac46e9d76501e7037", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDE4MjAwNg==", "url": "https://github.com/bisq-network/bisq/pull/4453#discussion_r480182006", "bodyText": "I reverted accountId to empty string. Is prob. more safe. getUserName returns then also empty string by default at account creation.", "author": "chimp1984", "createdAt": "2020-08-31T14:49:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDA0NzAyMw=="}], "type": "inlineReview", "revised_code": {"commit": "59ebefc7d9ffa03753f39757ebc666966502c7a6", "chunk": "diff --git a/core/src/main/java/bisq/core/payment/payload/RevolutAccountPayload.java b/core/src/main/java/bisq/core/payment/payload/RevolutAccountPayload.java\nindex 097b56f9ea..7c8926ab10 100644\n--- a/core/src/main/java/bisq/core/payment/payload/RevolutAccountPayload.java\n+++ b/core/src/main/java/bisq/core/payment/payload/RevolutAccountPayload.java\n\n@@ -109,17 +110,15 @@ public final class RevolutAccountPayload extends PaymentAccountPayload {\n \n     @Override\n     public byte[] getAgeWitnessInputData() {\n-        // getAgeWitnessInputData is called at new account creation when accountId is null, we use empty string as\n-        // it has been the case before\n-        String input = this.accountId == null ? \"\" : this.accountId;\n-        return super.getAgeWitnessInputData(input.getBytes(StandardCharsets.UTF_8));\n+        // getAgeWitnessInputData is called at new account creation when accountId is empty string.\n+        return super.getAgeWitnessInputData(accountId.getBytes(StandardCharsets.UTF_8));\n     }\n \n     public void setUserName(@Nullable String userName) {\n         this.userName = userName;\n         // We only set accountId to userName for new accounts. Existing accounts have accountId set with email\n         // or phone nr. and we keep that to not break account signing.\n-        if (accountId == null) {\n+        if (accountId.isEmpty()) {\n             accountId = userName;\n         }\n     }\n"}}, {"oid": "59ebefc7d9ffa03753f39757ebc666966502c7a6", "url": "https://github.com/bisq-network/bisq/commit/59ebefc7d9ffa03753f39757ebc666966502c7a6", "message": "Revert to use empty string as default for accountId instead of null.\n\nPrefer to keep old functionality here...", "committedDate": "2020-08-31T14:47:35Z", "type": "commit"}, {"oid": "591011e5169d7f350f09a48bdb91a24f23902cfc", "url": "https://github.com/bisq-network/bisq/commit/591011e5169d7f350f09a48bdb91a24f23902cfc", "message": "Add comment", "committedDate": "2020-08-31T14:51:53Z", "type": "commit"}]}