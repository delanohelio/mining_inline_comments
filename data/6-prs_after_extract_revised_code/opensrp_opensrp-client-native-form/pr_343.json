{"pr_number": 343, "pr_title": "Add relevance and calculations on repeating group", "pr_createdAt": "2020-01-21T14:12:38Z", "pr_url": "https://github.com/opensrp/opensrp-client-native-form/pull/343", "timeline": [{"oid": "bc90c5082788e85906f07d03277ee695df8fd079", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/bc90c5082788e85906f07d03277ee695df8fd079", "message": "add relevance repeating group question", "committedDate": "2020-01-16T08:58:58Z", "type": "commit"}, {"oid": "c9dea0ef9ea6dc050d5dad3f61028ec75d22336f", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/c9dea0ef9ea6dc050d5dad3f61028ec75d22336f", "message": "add repeating group section", "committedDate": "2020-01-16T09:01:50Z", "type": "commit"}, {"oid": "e312f75265ecae17fc8ded1b51b8b3fc0e0b661c", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/e312f75265ecae17fc8ded1b51b8b3fc0e0b661c", "message": "Merge branch 'master' of github.com:OpenSRP/opensrp-client-native-form into repeating_group_relevance_calculations", "committedDate": "2020-01-16T11:15:06Z", "type": "commit"}, {"oid": "60e6cf0e16602f2b18ba8e237b5e8d2f26e8300f", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/60e6cf0e16602f2b18ba8e237b5e8d2f26e8300f", "message": "fix issue with setting view tags for an already existing id", "committedDate": "2020-01-17T11:53:04Z", "type": "commit"}, {"oid": "1744e8560b6d2a42389dd793ddf60365653888e1", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/1744e8560b6d2a42389dd793ddf60365653888e1", "message": "add function to get dynamic rules engine address", "committedDate": "2020-01-17T13:23:52Z", "type": "commit"}, {"oid": "b7b2c872985fcf0358af5960ad3a61eaef4dc1a3", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/b7b2c872985fcf0358af5960ad3a61eaef4dc1a3", "message": "add function to get dynamic calculation", "committedDate": "2020-01-17T13:25:11Z", "type": "commit"}, {"oid": "f4e4cbb4d2f3abcf02e8913631b5252c34e4fd16", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/f4e4cbb4d2f3abcf02e8913631b5252c34e4fd16", "message": "build calculations with unique ids", "committedDate": "2020-01-17T13:26:37Z", "type": "commit"}, {"oid": "78491da2892ff6819b31959fc322e0058efde038", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/78491da2892ff6819b31959fc322e0058efde038", "message": "add relevance to repeating group sample form", "committedDate": "2020-01-21T14:08:44Z", "type": "commit"}, {"oid": "8ede7a5c9c980b48e11ffaa1972e9b93e3cca0a0", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/8ede7a5c9c980b48e11ffaa1972e9b93e3cca0a0", "message": "add calculation to repeating group sample form", "committedDate": "2020-01-21T14:09:12Z", "type": "commit"}, {"oid": "477a5b8234ae60e999ae14c21ee80fdde30ef389", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/477a5b8234ae60e999ae14c21ee80fdde30ef389", "message": "Merge branch 'master' of github.com:OpenSRP/opensrp-client-native-form into repeating_group_relevance_calculations", "committedDate": "2020-01-21T14:09:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTAyNzQxOA==", "url": "https://github.com/opensrp/opensrp-client-native-form/pull/343#discussion_r369027418", "bodyText": "Conventional naming of variables here", "author": "bennsimon", "createdAt": "2020-01-21T14:20:50Z", "path": "android-json-form-wizard/src/main/java/com/vijay/jsonwizard/activities/JsonFormActivity.java", "diffHunk": "@@ -309,7 +309,12 @@ public void refreshCalculationLogic(String parentKey, String childKey, boolean p\n \n                         String[] address = getAddressFromMap(widgetKey, stepName, JsonFormConstants.CALCULATION);\n                         if (address == null && curRelevance.has(JsonFormConstants.JSON_FORM_KEY.EX_RULES)) {\n-                            address = getRulesEngineAddress(curKey, curRelevance, curView, JsonFormConstants.CALCULATION);\n+                            JSONObject ex_rules = curRelevance.getJSONObject(JsonFormConstants.JSON_FORM_KEY.EX_RULES);", "originalCommit": "477a5b8234ae60e999ae14c21ee80fdde30ef389", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "929f7fe9cf1c9ffcdb4548b434ab0b4286ffcc80", "chunk": "diff --git a/android-json-form-wizard/src/main/java/com/vijay/jsonwizard/activities/JsonFormActivity.java b/android-json-form-wizard/src/main/java/com/vijay/jsonwizard/activities/JsonFormActivity.java\nindex b74bc9eb..b11e3cb6 100644\n--- a/android-json-form-wizard/src/main/java/com/vijay/jsonwizard/activities/JsonFormActivity.java\n+++ b/android-json-form-wizard/src/main/java/com/vijay/jsonwizard/activities/JsonFormActivity.java\n\n@@ -301,19 +301,19 @@ public class JsonFormActivity extends JsonFormBaseActivity implements JsonApi {\n                     while (keys.hasNext()) {\n                         String curKey = keys.next();\n \n-                        JSONObject curRelevance = calculation.getJSONObject(curKey);\n+                        JSONObject curCalculation = calculation.getJSONObject(curKey);\n                         JSONObject valueSource = new JSONObject();\n                         if (calculation.has(JsonFormConstants.SRC)) {\n                             valueSource = calculation.getJSONObject(JsonFormConstants.SRC);\n                         }\n \n                         String[] address = getAddressFromMap(widgetKey, stepName, JsonFormConstants.CALCULATION);\n-                        if (address == null && curRelevance.has(JsonFormConstants.JSON_FORM_KEY.EX_RULES)) {\n-                            JSONObject ex_rules = curRelevance.getJSONObject(JsonFormConstants.JSON_FORM_KEY.EX_RULES);\n-                            if (ex_rules.has(RuleConstant.RULES_DYNAMIC)) {\n-                                address = getDynamicRulesEngineAddress(curKey, curRelevance, curView, JsonFormConstants.CALCULATION);\n+                        if (address == null && curCalculation.has(JsonFormConstants.JSON_FORM_KEY.EX_RULES)) {\n+                            JSONObject exRulesObject = curCalculation.getJSONObject(JsonFormConstants.JSON_FORM_KEY.EX_RULES);\n+                            if (exRulesObject.has(RuleConstant.RULES_DYNAMIC)) {\n+                                address = getDynamicRulesEngineAddress(curKey, curCalculation, curView, JsonFormConstants.CALCULATION);\n                             } else {\n-                                address = getRulesEngineAddress(curKey, curRelevance, curView, JsonFormConstants.CALCULATION);\n+                                address = getRulesEngineAddress(curKey, curCalculation, curView, JsonFormConstants.CALCULATION);\n                             }\n                         }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTAyODA5Ng==", "url": "https://github.com/opensrp/opensrp-client-native-form/pull/343#discussion_r369028096", "bodyText": "change the name of rulesFile to a address", "author": "bennsimon", "createdAt": "2020-01-21T14:22:01Z", "path": "android-json-form-wizard/src/main/java/com/vijay/jsonwizard/activities/JsonFormActivity.java", "diffHunk": "@@ -1665,11 +1665,14 @@ private ExObjectResult isExObjectRelevant(Facts curValueMap, JSONObject object)\n         return Utils.getConditionKeys(condition);\n     }\n \n-    private void updateCalculation(Facts valueMap, View view, String rulesFile) {\n-\n+    private void updateCalculation(Facts valueMap, View view, String[] rulesFile) {", "originalCommit": "477a5b8234ae60e999ae14c21ee80fdde30ef389", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "929f7fe9cf1c9ffcdb4548b434ab0b4286ffcc80", "chunk": "diff --git a/android-json-form-wizard/src/main/java/com/vijay/jsonwizard/activities/JsonFormActivity.java b/android-json-form-wizard/src/main/java/com/vijay/jsonwizard/activities/JsonFormActivity.java\nindex b74bc9eb..b11e3cb6 100644\n--- a/android-json-form-wizard/src/main/java/com/vijay/jsonwizard/activities/JsonFormActivity.java\n+++ b/android-json-form-wizard/src/main/java/com/vijay/jsonwizard/activities/JsonFormActivity.java\n\n@@ -1665,13 +1665,13 @@ public class JsonFormActivity extends JsonFormBaseActivity implements JsonApi {\n         return Utils.getConditionKeys(condition);\n     }\n \n-    private void updateCalculation(Facts valueMap, View view, String[] rulesFile) {\n+    private void updateCalculation(Facts valueMap, View view, String[] address) {\n         String calculation;\n         try {\n-            if (rulesFile[0].equals(RuleConstant.RULES_DYNAMIC)) {\n-                calculation = getRulesEngineFactory().getDynamicCalculation(valueMap, new JSONArray(rulesFile[1]));\n+            if (address[0].equals(RuleConstant.RULES_DYNAMIC)) {\n+                calculation = getRulesEngineFactory().getDynamicCalculation(valueMap, new JSONArray(address[1]));\n             } else {\n-                calculation = getRulesEngineFactory().getCalculation(valueMap, rulesFile[1]);\n+                calculation = getRulesEngineFactory().getCalculation(valueMap, address[1]);\n             }\n \n             if (calculation != null) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTAyOTAwNw==", "url": "https://github.com/opensrp/opensrp-client-native-form/pull/343#discussion_r369029007", "bodyText": "any naming with relevance i guess should now be changed to calculation", "author": "bennsimon", "createdAt": "2020-01-21T14:23:42Z", "path": "android-json-form-wizard/src/main/java/com/vijay/jsonwizard/task/AttachRepeatingGroupTask.java", "diffHunk": "@@ -242,4 +244,58 @@ private void buildRelevanceWithUniqueIds(JSONObject element, String uniqueId) th\n         }\n \n     }\n+\n+    private void buildCalculationWithUniqueId(JSONObject element, String uniqueId) throws JSONException {\n+        JSONObject calculation = element.optJSONObject(CALCULATION);\n+        if (calculation != null) {\n+            if (calculation.has(RuleConstant.RULES_ENGINE) && widgetArgs != null) {\n+                JSONObject jsonRulesEngineObject = calculation.optJSONObject(RuleConstant.RULES_ENGINE);\n+                JSONObject jsonExRules = jsonRulesEngineObject.optJSONObject(JsonFormConstants.JSON_FORM_KEY.EX_RULES);\n+                String fileName = JsonFormConstants.RULE + jsonExRules.optString(RuleConstant.RULES_DYNAMIC);\n+\n+                if (!rulesFileMap.containsKey(fileName)) {\n+                    Iterable<Object> objectIterable = Utils.readYamlFile(fileName, widgetArgs.getContext());\n+                    List<Map<String, Object>> arrayList = new ArrayList<>();\n+                    while (objectIterable.iterator().hasNext()) {\n+                        Map<String, Object> map = (Map<String, Object>) objectIterable.iterator().next();\n+                        if (map != null) {\n+                            arrayList.add(map);\n+                        }\n+                    }\n+                    rulesFileMap.put(fileName, arrayList);\n+                }\n+\n+                List<Map<String, Object>> mapArrayList = rulesFileMap.get(fileName);\n+\n+                JSONArray jsonArrayRules = new JSONArray();\n+                JSONObject keyJsonObject = new JSONObject();\n+                keyJsonObject.put(KEY, uniqueId);\n+                jsonArrayRules.put(keyJsonObject);\n+                for (Map<String, Object> map : mapArrayList) {\n+                    JSONObject jsonRulesDynamicObject = new JSONObject();\n+                    String strCondition = (String) map.get(RuleConstant.CONDITION);\n+                    List<String> conditionKeys = Utils.getConditionKeys(strCondition);\n+                    for (String conditionKey : conditionKeys) {\n+                        strCondition = strCondition.replace(conditionKey, conditionKey + \"_\" + uniqueId);\n+                    }\n+                    jsonRulesDynamicObject.put(RuleConstant.NAME, String.valueOf(map.get(RuleConstant.NAME)).concat(\"_\").concat(uniqueId));\n+                    jsonRulesDynamicObject.put(RuleConstant.DESCRIPTION, String.valueOf(map.get(RuleConstant.DESCRIPTION)).concat(\"_\").concat(uniqueId));\n+                    jsonRulesDynamicObject.put(RuleConstant.PRIORITY, map.get(RuleConstant.PRIORITY));\n+                    jsonRulesDynamicObject.put(RuleConstant.ACTIONS, ((ArrayList<String>) map.get(RuleConstant.ACTIONS)).get(0));\n+                    jsonRulesDynamicObject.put(RuleConstant.CONDITION, String.valueOf(strCondition));\n+                    jsonArrayRules.put(jsonRulesDynamicObject);\n+                }\n+\n+                jsonExRules.put(RuleConstant.RULES_DYNAMIC, jsonArrayRules);\n+\n+            } else {\n+                String currRelevanceKey = calculation.keys().next();", "originalCommit": "477a5b8234ae60e999ae14c21ee80fdde30ef389", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "633ee98a34e017933246b858f5f1419d42258ff8", "chunk": "diff --git a/android-json-form-wizard/src/main/java/com/vijay/jsonwizard/task/AttachRepeatingGroupTask.java b/android-json-form-wizard/src/main/java/com/vijay/jsonwizard/task/AttachRepeatingGroupTask.java\nindex 83991a8b..daade10c 100644\n--- a/android-json-form-wizard/src/main/java/com/vijay/jsonwizard/task/AttachRepeatingGroupTask.java\n+++ b/android-json-form-wizard/src/main/java/com/vijay/jsonwizard/task/AttachRepeatingGroupTask.java\n\n@@ -289,11 +289,11 @@ public class AttachRepeatingGroupTask extends AsyncTask<Void, Void, List<View>>\n                 jsonExRules.put(RuleConstant.RULES_DYNAMIC, jsonArrayRules);\n \n             } else {\n-                String currRelevanceKey = calculation.keys().next();\n-                JSONObject relevanceObj = calculation.getJSONObject(currRelevanceKey);\n-                String newRelevanceKey = currRelevanceKey + \"_\" + uniqueId;\n-                calculation.remove(currRelevanceKey);\n-                calculation.put(newRelevanceKey, relevanceObj);\n+                String currCalculationKey = calculation.keys().next();\n+                JSONObject calculationObj = calculation.getJSONObject(currCalculationKey);\n+                String newRelevanceKey = currCalculationKey + \"_\" + uniqueId;\n+                calculation.remove(currCalculationKey);\n+                calculation.put(newRelevanceKey, calculationObj);\n             }\n         }\n \n"}}, {"oid": "633ee98a34e017933246b858f5f1419d42258ff8", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/633ee98a34e017933246b858f5f1419d42258ff8", "message": "Update variable naming as per review", "committedDate": "2020-01-21T14:31:28Z", "type": "commit"}, {"oid": "929f7fe9cf1c9ffcdb4548b434ab0b4286ffcc80", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/929f7fe9cf1c9ffcdb4548b434ab0b4286ffcc80", "message": "Update variable names", "committedDate": "2020-01-21T14:37:16Z", "type": "commit"}, {"oid": "d845094ee6d3dce124405ba5cdd0ebb91046c5a7", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/d845094ee6d3dce124405ba5cdd0ebb91046c5a7", "message": "Bump up version", "committedDate": "2020-01-21T14:38:02Z", "type": "commit"}, {"oid": "fbae9c6179f1fcd6398f74f221b795bedc828543", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/fbae9c6179f1fcd6398f74f221b795bedc828543", "message": "Remove Unnecessary use of fully qualified", "committedDate": "2020-01-22T07:45:05Z", "type": "commit"}, {"oid": "307539fee2284ffdbf3403b1068d7683489bf8b2", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/307539fee2284ffdbf3403b1068d7683489bf8b2", "message": "Update current calculation var name to a more relevant", "committedDate": "2020-01-22T08:39:24Z", "type": "commit"}, {"oid": "640fd3717e2cf43400bf2db1a435253df15be2d4", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/640fd3717e2cf43400bf2db1a435253df15be2d4", "message": "Merge branch 'master' of github.com:OpenSRP/opensrp-client-native-form into repeating_group_relevance_calculations\nBump up version", "committedDate": "2020-01-27T11:44:42Z", "type": "commit"}, {"oid": "f9b417dcb7618c986f77cfb41893311e7869d9dc", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/f9b417dcb7618c986f77cfb41893311e7869d9dc", "message": "code abstraction on getting rule uniqueid for relevance and calculation", "committedDate": "2020-01-27T14:21:25Z", "type": "commit"}, {"oid": "888039e5984d39cd534baaa565d8e7de20314296", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/888039e5984d39cd534baaa565d8e7de20314296", "message": "use relevant variable naming", "committedDate": "2020-01-27T14:33:33Z", "type": "commit"}, {"oid": "7692792bc8bc5037a8e337b278504d1873c25a52", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/7692792bc8bc5037a8e337b278504d1873c25a52", "message": "Merge branch 'master' of github.com:OpenSRP/opensrp-client-native-form into repeating_group_relevance_calculations", "committedDate": "2020-01-28T10:19:32Z", "type": "commit"}, {"oid": "8d55451f0af5a33b8b365fd73cacab61cc3b679f", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/8d55451f0af5a33b8b365fd73cacab61cc3b679f", "message": "added relevance decided id", "committedDate": "2020-01-28T18:15:00Z", "type": "commit"}, {"oid": "286117cf72d55ef4af0f0e6290337bb67ef1fbc0", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/286117cf72d55ef4af0f0e6290337bb67ef1fbc0", "message": "add relevance rules for repeating group question", "committedDate": "2020-01-28T18:16:14Z", "type": "commit"}, {"oid": "45cacaa2a528d3437e97436673590391ea4f1c42", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/45cacaa2a528d3437e97436673590391ea4f1c42", "message": "add repeating group rules file", "committedDate": "2020-01-28T18:16:57Z", "type": "commit"}, {"oid": "9b86ad2e4e0704435c18f31f32605ab27f91e7ff", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/9b86ad2e4e0704435c18f31f32605ab27f91e7ff", "message": "add calculations to sample form", "committedDate": "2020-01-28T18:17:32Z", "type": "commit"}, {"oid": "02740df8ec9c458da2ff3c550bae3ec6db450ac4", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/02740df8ec9c458da2ff3c550bae3ec6db450ac4", "message": "code clean up", "committedDate": "2020-01-28T18:18:11Z", "type": "commit"}, {"oid": "19ca65e89db2efcec97ed3615b69a9cc0cb15b23", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/19ca65e89db2efcec97ed3615b69a9cc0cb15b23", "message": "added tag on view called relevanced_decided (object of boolean) on JsonFormActivity:1899\nadded code to check when tag changes inside the RepeatingGroupFactory", "committedDate": "2020-01-28T18:18:56Z", "type": "commit"}, {"oid": "b2519cf588e3ac739af910933d2fb9595de86c46", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/b2519cf588e3ac739af910933d2fb9595de86c46", "message": "remove extra semicolon", "committedDate": "2020-01-28T18:56:45Z", "type": "commit"}]}