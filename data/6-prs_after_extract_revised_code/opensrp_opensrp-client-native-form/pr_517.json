{"pr_number": 517, "pr_title": "fix skip steps in jsonformfragment", "pr_createdAt": "2020-11-16T06:07:53Z", "pr_url": "https://github.com/opensrp/opensrp-client-native-form/pull/517", "timeline": [{"oid": "abbd892deb5a96c7bb836edd30b8cef8b69f805d", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/abbd892deb5a96c7bb836edd30b8cef8b69f805d", "message": "fix skip steps in jsonformfragment", "committedDate": "2020-11-16T06:04:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI1ODQwOA==", "url": "https://github.com/opensrp/opensrp-client-native-form/pull/517#discussion_r524258408", "bodyText": "Why do we need to subtract 1?", "author": "vincent-karuri", "createdAt": "2020-11-16T13:14:44Z", "path": "android-json-form-wizard/src/main/java/com/vijay/jsonwizard/fragments/JsonFormFragment.java", "diffHunk": "@@ -299,12 +299,8 @@ public void skipLoadedStepsOnNextPressed() {\n     private int getFormStepNumber(String nextFormNumber) {\n         int formNumber = 0;\n         if (StringUtils.isNotBlank(nextFormNumber)) {\n-            int currentFormNumber = Integer.parseInt(nextFormNumber.substring(4, 5)) - 1;\n-            if (currentFormNumber > 0) {\n-                formNumber = currentFormNumber;\n-            } else if (currentFormNumber == 0) {\n-                formNumber = 1;\n-            }\n+            int currentFormNumber = Integer.parseInt(nextFormNumber.substring(4)) - 1;", "originalCommit": "abbd892deb5a96c7bb836edd30b8cef8b69f805d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI2NTMyOQ==", "url": "https://github.com/opensrp/opensrp-client-native-form/pull/517#discussion_r524265329", "bodyText": "If we are trying to get the current step number, won't https://github.com/OpenSRP/opensrp-client-native-form/pull/407/files#diff-4af3b3a5f5179b96a2f8051da8ad980ec341e72fc18aa4bd23f0cbc2c2216845L739 suffice?\nThe current logic assumes that the next step will always be +1 which is not always certain to be true.", "author": "vincent-karuri", "createdAt": "2020-11-16T13:26:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI1ODQwOA=="}], "type": "inlineReview", "revised_code": {"commit": "9a7359cd68af138ab8a746e48332703227cd708e", "chunk": "diff --git a/android-json-form-wizard/src/main/java/com/vijay/jsonwizard/fragments/JsonFormFragment.java b/android-json-form-wizard/src/main/java/com/vijay/jsonwizard/fragments/JsonFormFragment.java\nindex d5d7411e..73efb087 100644\n--- a/android-json-form-wizard/src/main/java/com/vijay/jsonwizard/fragments/JsonFormFragment.java\n+++ b/android-json-form-wizard/src/main/java/com/vijay/jsonwizard/fragments/JsonFormFragment.java\n\n@@ -293,16 +293,10 @@ public class JsonFormFragment extends MvpFragment<JsonFormFragmentPresenter, Jso\n      * Returns the current form step number when given than steps next step number.\n      * This number is used to figure out which steps to pop when previous is clicked.\n      *\n-     * @param nextFormNumber {@link String}\n      * @return formNumber {@link Integer}\n      */\n-    private int getFormStepNumber(String nextFormNumber) {\n-        int formNumber = 0;\n-        if (StringUtils.isNotBlank(nextFormNumber)) {\n-            int currentFormNumber = Integer.parseInt(nextFormNumber.substring(4)) - 1;\n-            formNumber = currentFormNumber > 0 ? currentFormNumber : 1;\n-        }\n-        return formNumber;\n+    private int getFormStepNumber() {\n+        return Integer.parseInt(getArguments().getString(JsonFormConstants.STEPNAME).substring(4));\n     }\n \n     /***\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI1OTcyMw==", "url": "https://github.com/opensrp/opensrp-client-native-form/pull/517#discussion_r524259723", "bodyText": "Any reason this is removed?", "author": "vincent-karuri", "createdAt": "2020-11-16T13:17:02Z", "path": "android-json-form-wizard/src/main/java/com/vijay/jsonwizard/presenters/JsonFormFragmentPresenter.java", "diffHunk": "@@ -465,13 +462,30 @@ public boolean validateOnSubmit() {\n         return entireJsonForm.optBoolean(JsonFormConstants.VALIDATE_ON_SUBMIT, false);\n     }\n \n-    private boolean moveToNextStep() {\n-        if (!\"\".equals(mStepDetails.optString(JsonFormConstants.NEXT))) {\n-            JsonFormFragment next = JsonFormFragment\n-                    .getFormFragment(mStepDetails.optString(JsonFormConstants.NEXT));\n+    public void executeRefreshLogicForNextStep() {\n+        final String nextStep = getFormFragment().getJsonApi().nextStep();\n+        if (StringUtils.isNotBlank(nextStep)) {\n+            getmJsonFormInteractor().fetchFormElements(nextStep, getFormFragment(), getFormFragment().getJsonApi().getmJSONObject().optJSONObject(nextStep), getView().getCommonListener(), false);\n+            getFormFragment().getJsonApi().initializeDependencyMaps();\n+            cleanDataForNextStep();\n+            getFormFragment().getJsonApi().invokeRefreshLogic(null, false, null, null, nextStep, true);\n+            if (!getFormFragment().getJsonApi().isNextStepRelevant()) {\n+                Utils.checkIfStepHasNoSkipLogic(getFormFragment());\n+            }\n+            getFormFragment().skipStepsOnNextPressed(nextStep);\n+        }\n+    }\n+\n+    private void cleanDataForNextStep() {\n+        getFormFragment().getJsonApi().setNextStepRelevant(false);\n+    }\n+\n+    protected boolean moveToNextStep() {\n+        final String nextStep = getFormFragment().getJsonApi().nextStep();\n+        if (!\"\".equals(nextStep)) {\n+            JsonFormFragment next = JsonFormFragment.getFormFragment(nextStep);\n             getView().hideKeyBoard();\n             getView().transactThis(next);\n-            return true;", "originalCommit": "abbd892deb5a96c7bb836edd30b8cef8b69f805d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9a7359cd68af138ab8a746e48332703227cd708e", "chunk": "diff --git a/android-json-form-wizard/src/main/java/com/vijay/jsonwizard/presenters/JsonFormFragmentPresenter.java b/android-json-form-wizard/src/main/java/com/vijay/jsonwizard/presenters/JsonFormFragmentPresenter.java\nindex a413cc36..d5f013db 100644\n--- a/android-json-form-wizard/src/main/java/com/vijay/jsonwizard/presenters/JsonFormFragmentPresenter.java\n+++ b/android-json-form-wizard/src/main/java/com/vijay/jsonwizard/presenters/JsonFormFragmentPresenter.java\n\n@@ -486,6 +486,7 @@ public class JsonFormFragmentPresenter extends\n             JsonFormFragment next = JsonFormFragment.getFormFragment(nextStep);\n             getView().hideKeyBoard();\n             getView().transactThis(next);\n+            return true;\n         }\n         return false;\n     }\n"}}, {"oid": "9a7359cd68af138ab8a746e48332703227cd708e", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/9a7359cd68af138ab8a746e48332703227cd708e", "message": "code cleanup", "committedDate": "2020-11-17T06:22:25Z", "type": "commit"}, {"oid": "7779936526b6bb29b583731ebdd39b282510f355", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/7779936526b6bb29b583731ebdd39b282510f355", "message": "fix duplicate fragment on backstack issue", "committedDate": "2020-11-18T06:43:44Z", "type": "commit"}, {"oid": "29d1f5fc29f8c1306fdc2734b043c7195a636f46", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/29d1f5fc29f8c1306fdc2734b043c7195a636f46", "message": "Make creation of next jsonformfragment configurable", "committedDate": "2020-11-18T08:54:46Z", "type": "commit"}]}