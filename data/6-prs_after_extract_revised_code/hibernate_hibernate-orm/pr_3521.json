{"pr_number": 3521, "pr_title": "on H2 1.4.200 and above use localtime/localtimestamp (H5)", "pr_createdAt": "2020-08-25T11:55:18Z", "pr_url": "https://github.com/hibernate/hibernate-orm/pull/3521", "timeline": [{"oid": "75a66abf703608997d92735502b83024d0571068", "url": "https://github.com/hibernate/hibernate-orm/commit/75a66abf703608997d92735502b83024d0571068", "message": "on H2 1.4.200 and above use localtime/localtimestamp\n\nAs suggested by @famod we need to use localtime instead\nor current_time because of changes in H2.\n\nIn particular the JDBC driver now refuses to convert\nTIME/TIMESTAMP WITH TIME ZONE to plain TIME/TIMESTAMP.", "committedDate": "2020-08-25T16:55:11Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjYyNzQ3OQ==", "url": "https://github.com/hibernate/hibernate-orm/pull/3521#discussion_r476627479", "bodyText": "Shouldn't this (and the next line) be >=198 instead?\n#3412 (comment)\nMy sentence\n\nAs of 1.4.200 other functions also include the time zone and might fail as well but those changes might have been made after 1.4.198.\n\nmight have been a bit misleading. \"As of 1.4.200\" means that the current online documentation (which matches 1.4.200) is saying that even more functions include the time zone but I haven't checked whether those functions were added also in 198 or in 199 or 200.", "author": "famod", "createdAt": "2020-08-25T17:42:39Z", "path": "hibernate-core/src/main/java/org/hibernate/dialect/H2Dialect.java", "diffHunk": "@@ -210,8 +210,8 @@ public H2Dialect() {\n \t\tregisterFunction( \"curtime\", new NoArgSQLFunction( \"curtime\", StandardBasicTypes.TIME ) );\n \t\tregisterFunction( \"curtimestamp\", new NoArgSQLFunction( \"curtimestamp\", StandardBasicTypes.TIME ) );\n \t\tregisterFunction( \"current_date\", new NoArgSQLFunction( \"current_date\", StandardBasicTypes.DATE ) );\n-\t\tregisterFunction( \"current_time\", new NoArgSQLFunction( \"current_time\", StandardBasicTypes.TIME ) );\n-\t\tregisterFunction( \"current_timestamp\", new NoArgSQLFunction( \"current_timestamp\", StandardBasicTypes.TIMESTAMP ) );\n+\t\tregisterFunction( \"current_time\", new NoArgSQLFunction( buildId >= 200 ? \"localtime\" : \"current_time\", StandardBasicTypes.TIME ) );", "originalCommit": "75a66abf703608997d92735502b83024d0571068", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjYzOTcxMg==", "url": "https://github.com/hibernate/hibernate-orm/pull/3521#discussion_r476639712", "bodyText": "Well I know for sure that both forms work fine on 1.4.199 because I've tested them both in H6.\nIt's a bit harder to test them on H5 because there are other distracting test failures.", "author": "gavinking", "createdAt": "2020-08-25T18:03:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjYyNzQ3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY1OTA1Ng==", "url": "https://github.com/hibernate/hibernate-orm/pull/3521#discussion_r476659056", "bodyText": "I mean the real problem here is that he's insisting on not implicitly casting TIME WITH TIME ZONE to TIME, a cast which I'm pretty sure is implicit on most other databases.", "author": "gavinking", "createdAt": "2020-08-25T18:39:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjYyNzQ3OQ=="}], "type": "inlineReview", "revised_code": {"commit": "1416323b87d90bfd53aebdc55795005976b9068c", "chunk": "diff --git a/hibernate-core/src/main/java/org/hibernate/dialect/H2Dialect.java b/hibernate-core/src/main/java/org/hibernate/dialect/H2Dialect.java\nindex 8910aa50fa..319b64943d 100644\n--- a/hibernate-core/src/main/java/org/hibernate/dialect/H2Dialect.java\n+++ b/hibernate-core/src/main/java/org/hibernate/dialect/H2Dialect.java\n\n@@ -210,6 +210,10 @@ public class H2Dialect extends Dialect {\n \t\tregisterFunction( \"curtime\", new NoArgSQLFunction( \"curtime\", StandardBasicTypes.TIME ) );\n \t\tregisterFunction( \"curtimestamp\", new NoArgSQLFunction( \"curtimestamp\", StandardBasicTypes.TIME ) );\n \t\tregisterFunction( \"current_date\", new NoArgSQLFunction( \"current_date\", StandardBasicTypes.DATE ) );\n+\t\t// H2 made a nasty breaking change that changed the type of\n+\t\t// - current_timestamp to timestamp with time zone\n+\t\t// - current_time to time with time zone\n+\t\t// and also refuses to implicitly convert the type\n \t\tregisterFunction( \"current_time\", new NoArgSQLFunction( buildId >= 200 ? \"localtime\" : \"current_time\", StandardBasicTypes.TIME ) );\n \t\tregisterFunction( \"current_timestamp\", new NoArgSQLFunction( buildId >= 200 ? \"localtimestamp\" : \"current_timestamp\", StandardBasicTypes.TIMESTAMP ) );\n \t\tregisterFunction( \"datediff\", new StandardSQLFunction( \"datediff\", StandardBasicTypes.INTEGER ) );\n"}}, {"oid": "1416323b87d90bfd53aebdc55795005976b9068c", "url": "https://github.com/hibernate/hibernate-orm/commit/1416323b87d90bfd53aebdc55795005976b9068c", "message": "on H2 1.4.200 and above use localtime/localtimestamp\n\nAs suggested by @famod we need to use localtime instead\nor current_time because of changes in H2.\n\nIn particular the JDBC driver now refuses to convert\nTIME/TIMESTAMP WITH TIME ZONE to plain TIME/TIMESTAMP.", "committedDate": "2021-04-06T09:36:13Z", "type": "forcePushed"}, {"oid": "b259980989f59a4488c91fa338605efbcf77c20e", "url": "https://github.com/hibernate/hibernate-orm/commit/b259980989f59a4488c91fa338605efbcf77c20e", "message": "[HHH-14031] on H2 1.4.200 and above use localtime/localtimestamp\n\nAs suggested by @famod we need to use localtime instead\nor current_time because of changes in H2.\n\nIn particular the JDBC driver now refuses to convert\nTIME/TIMESTAMP WITH TIME ZONE to plain TIME/TIMESTAMP.", "committedDate": "2021-04-06T09:37:50Z", "type": "commit"}, {"oid": "b259980989f59a4488c91fa338605efbcf77c20e", "url": "https://github.com/hibernate/hibernate-orm/commit/b259980989f59a4488c91fa338605efbcf77c20e", "message": "[HHH-14031] on H2 1.4.200 and above use localtime/localtimestamp\n\nAs suggested by @famod we need to use localtime instead\nor current_time because of changes in H2.\n\nIn particular the JDBC driver now refuses to convert\nTIME/TIMESTAMP WITH TIME ZONE to plain TIME/TIMESTAMP.", "committedDate": "2021-04-06T09:37:50Z", "type": "forcePushed"}]}