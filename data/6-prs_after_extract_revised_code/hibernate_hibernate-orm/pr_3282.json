{"pr_number": 3282, "pr_title": "HHH-13619", "pr_createdAt": "2020-03-04T19:02:23Z", "pr_url": "https://github.com/hibernate/hibernate-orm/pull/3282", "timeline": [{"oid": "24cedfa6ec63105b423ec87f8dadca716d64190a", "url": "https://github.com/hibernate/hibernate-orm/commit/24cedfa6ec63105b423ec87f8dadca716d64190a", "message": "HHH-13619 : test cases", "committedDate": "2020-03-04T18:36:24Z", "type": "commit"}, {"oid": "692f19c83fef4339112e4fbabcc09437999a1bdf", "url": "https://github.com/hibernate/hibernate-orm/commit/692f19c83fef4339112e4fbabcc09437999a1bdf", "message": "HHH-13619 - Support for JPA's `size` function as a select expression\n\n- initial support", "committedDate": "2020-03-04T18:37:37Z", "type": "commit"}, {"oid": "336c3b9e30616bdfe024a2ce3d802037c54f0b60", "url": "https://github.com/hibernate/hibernate-orm/commit/336c3b9e30616bdfe024a2ce3d802037c54f0b60", "message": "HHH-13619 - Support for JPA's `size` function as a select expression\n\n- code cleanup", "committedDate": "2020-03-04T18:37:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODIzMDg3Mw==", "url": "https://github.com/hibernate/hibernate-orm/pull/3282#discussion_r388230873", "bodyText": "really a minor but probably we can initialize qualifierQueryPath and referencePath later\nif ( qualifier == null ) {\n   referencePath = referenceName;\n....}else{\n final String qualifierQueryPath = ( (FromReferenceNode) qualifier ).getPath();\n referencePath = qualifierQueryPath + \".\" + reference;\n}", "author": "dreab8", "createdAt": "2020-03-05T11:19:02Z", "path": "hibernate-core/src/main/java/org/hibernate/hql/internal/ast/tree/CollectionPathNode.java", "diffHunk": "@@ -0,0 +1,281 @@\n+/*\n+ * Hibernate, Relational Persistence for Idiomatic Java\n+ *\n+ * License: GNU Lesser General Public License (LGPL), version 2.1 or later\n+ * See the lgpl.txt file in the root directory or http://www.gnu.org/licenses/lgpl-2.1.html\n+ */\n+package org.hibernate.hql.internal.ast.tree;\n+\n+import java.util.List;\n+\n+import org.hibernate.QueryException;\n+import org.hibernate.hql.internal.ast.HqlSqlWalker;\n+import org.hibernate.hql.internal.ast.SqlASTFactory;\n+import org.hibernate.internal.util.StringHelper;\n+import org.hibernate.persister.collection.CollectionPersister;\n+import org.hibernate.persister.collection.QueryableCollection;\n+import org.hibernate.persister.entity.EntityPersister;\n+import org.hibernate.persister.entity.Joinable;\n+import org.hibernate.persister.entity.PropertyMapping;\n+import org.hibernate.type.CollectionType;\n+import org.hibernate.type.CompositeType;\n+import org.hibernate.type.EntityType;\n+import org.hibernate.type.Type;\n+\n+import antlr.SemanticException;\n+import antlr.collections.AST;\n+\n+/**\n+ * @author Steve Ebersole\n+ */\n+public class CollectionPathNode extends SqlNode {\n+\t/**\n+\t * Used to resolve the collection \"owner key\" columns\n+ \t */\n+\tprivate final FromElement ownerFromElement;\n+\n+\tprivate final CollectionPersister collectionDescriptor;\n+\n+\tprivate final String collectionPropertyName;\n+\tprivate final String collectionPropertyPath;\n+\tprivate final String collectionQueryPath;\n+\n+\tprivate final HqlSqlWalker walker;\n+\n+\n+\t/**\n+\t * Instantiate a `CollectionPathNode`\n+\t *\n+\t * @see #from(AST, AST, HqlSqlWalker)\n+\t */\n+\tpublic CollectionPathNode(\n+\t\t\tFromElement ownerFromElement,\n+\t\t\tCollectionPersister collectionDescriptor,\n+\t\t\tString collectionPropertyName,\n+\t\t\tString collectionQueryPath,\n+\t\t\tString collectionPropertyPath,\n+\t\t\tHqlSqlWalker walker) {\n+\t\tthis.ownerFromElement = ownerFromElement;\n+\t\tthis.collectionDescriptor = collectionDescriptor;\n+\t\tthis.collectionPropertyName = collectionPropertyName;\n+\t\tthis.collectionQueryPath = collectionQueryPath;\n+\t\tthis.collectionPropertyPath = collectionPropertyPath;\n+\t\tthis.walker = walker;\n+\n+\t\twalker.addQuerySpaces( collectionDescriptor.getCollectionSpaces() );\n+\n+\t\tsuper.setType( SqlASTFactory.COLL_PATH );\n+\t\tsuper.setDataType( collectionDescriptor.getCollectionType() );\n+\t\tsuper.setText( collectionDescriptor.getRole() );\n+\t}\n+\n+\t/**\n+\t * Factory for `CollectionPathNode` instances\n+\t *\n+\t * @param qualifier The left-hand-side of a dot-ident node - may be null to indicate an ident arg\n+\t * @param reference The right-hand-side of the dot-ident or the ident that is an unqualified reference\n+\t */\n+\tpublic static CollectionPathNode from(\n+\t\t\tAST qualifier,\n+\t\t\tAST reference,\n+\t\t\tHqlSqlWalker walker) {\n+\n+\t\tfinal String referenceName = reference.getText();\n+\t\tfinal String qualifierQueryPath = qualifier == null\n+\t\t\t\t? \"\"\n+\t\t\t\t: ( (FromReferenceNode) qualifier ).getPath();\n+\t\tfinal String referencePath = qualifier == null\n+\t\t\t\t? referenceName\n+\t\t\t\t: qualifierQueryPath + \".\" + reference;\n+", "originalCommit": "336c3b9e30616bdfe024a2ce3d802037c54f0b60", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "26ab3c536296193304e906bc478f58082d6f8420", "chunk": "diff --git a/hibernate-core/src/main/java/org/hibernate/hql/internal/ast/tree/CollectionPathNode.java b/hibernate-core/src/main/java/org/hibernate/hql/internal/ast/tree/CollectionPathNode.java\nindex 1c99ac1828..8a0e1dda7e 100644\n--- a/hibernate-core/src/main/java/org/hibernate/hql/internal/ast/tree/CollectionPathNode.java\n+++ b/hibernate-core/src/main/java/org/hibernate/hql/internal/ast/tree/CollectionPathNode.java\n\n@@ -48,6 +48,7 @@ public class CollectionPathNode extends SqlNode {\n \t *\n \t * @see #from(AST, AST, HqlSqlWalker)\n \t */\n+\t@SuppressWarnings(\"WeakerAccess\")\n \tpublic CollectionPathNode(\n \t\t\tFromElement ownerFromElement,\n \t\t\tCollectionPersister collectionDescriptor,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODIzMTUyMA==", "url": "https://github.com/hibernate/hibernate-orm/pull/3282#discussion_r388231520", "bodyText": "another minor, the ImpliedFromElement(FromClause fromClause, FromElement origin, String alias)  constructor is never used, may be it can be deleted", "author": "dreab8", "createdAt": "2020-03-05T11:20:32Z", "path": "hibernate-core/src/main/java/org/hibernate/hql/internal/ast/tree/ImpliedFromElement.java", "diffHunk": "@@ -23,6 +23,21 @@\n \t */\n \tprivate boolean inProjectionList;\n \n+\t/**\n+\t * Here to add debug breakpoints\n+\t */\n+\t@SuppressWarnings(\"unused\")\n+\tpublic ImpliedFromElement() {\n+\t\tsuper();\n+\t}\n+\n+\t/**\n+\t * Here to add debug breakpoints\n+\t */\n+\tpublic ImpliedFromElement(FromClause fromClause, FromElement origin, String alias) {\n+\t\tsuper( fromClause, origin, alias );\n+\t}\n+", "originalCommit": "336c3b9e30616bdfe024a2ce3d802037c54f0b60", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "26ab3c536296193304e906bc478f58082d6f8420", "chunk": "diff --git a/hibernate-core/src/main/java/org/hibernate/hql/internal/ast/tree/ImpliedFromElement.java b/hibernate-core/src/main/java/org/hibernate/hql/internal/ast/tree/ImpliedFromElement.java\nindex 5f6141e5bf..ccb3b240cb 100644\n--- a/hibernate-core/src/main/java/org/hibernate/hql/internal/ast/tree/ImpliedFromElement.java\n+++ b/hibernate-core/src/main/java/org/hibernate/hql/internal/ast/tree/ImpliedFromElement.java\n\n@@ -31,13 +31,6 @@ public class ImpliedFromElement extends FromElement {\n \t\tsuper();\n \t}\n \n-\t/**\n-\t * Here to add debug breakpoints\n-\t */\n-\tpublic ImpliedFromElement(FromClause fromClause, FromElement origin, String alias) {\n-\t\tsuper( fromClause, origin, alias );\n-\t}\n-\n \tpublic boolean isImplied() {\n \t\treturn true;\n \t}\n"}}, {"oid": "26ab3c536296193304e906bc478f58082d6f8420", "url": "https://github.com/hibernate/hibernate-orm/commit/26ab3c536296193304e906bc478f58082d6f8420", "message": "HHH-13619 - Support for JPA's `size` function as a select expression\n\n- PR revisions", "committedDate": "2020-03-05T15:58:35Z", "type": "commit"}]}