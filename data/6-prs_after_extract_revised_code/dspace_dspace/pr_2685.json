{"pr_number": 2685, "pr_title": "Workflow step definitions: action validation", "pr_createdAt": "2020-02-20T11:31:15Z", "pr_url": "https://github.com/DSpace/DSpace/pull/2685", "timeline": [{"oid": "2e8042e97d6d615f66a8650ca93c2ba4e6752005", "url": "https://github.com/DSpace/DSpace/commit/2e8042e97d6d615f66a8650ca93c2ba4e6752005", "message": "68726: Integration tests of Workflow in rest api - WIP,\nsome unexpected results in edit and final edit step, @ignore tests for now", "committedDate": "2020-02-11T12:08:12Z", "type": "commit"}, {"oid": "347606b6f12466a8d934a469732800cb67cc17be", "url": "https://github.com/DSpace/DSpace/commit/347606b6f12466a8d934a469732800cb67cc17be", "message": "68726: Workflow action options tests", "committedDate": "2020-02-17T15:03:18Z", "type": "commit"}, {"oid": "8845c02145a7355ca8f8cd552e4c6e372ada8197", "url": "https://github.com/DSpace/DSpace/commit/8845c02145a7355ca8f8cd552e4c6e372ada8197", "message": "68726: checkstyle", "committedDate": "2020-02-17T17:32:14Z", "type": "commit"}, {"oid": "743d35f098c2a03edab7acd995f615cfd4fa3a53", "url": "https://github.com/DSpace/DSpace/commit/743d35f098c2a03edab7acd995f615cfd4fa3a53", "message": "68821: check if submit button is in valid options for current action in workflow + previously @ignore tests now work as expected", "committedDate": "2020-02-18T10:33:48Z", "type": "commit"}, {"oid": "64900a8791e0dde3c4b89457ae52e92331cd8a70", "url": "https://github.com/DSpace/DSpace/commit/64900a8791e0dde3c4b89457ae52e92331cd8a70", "message": "68825: only allow patch/upload in workflow if claimed task w edit_metadata option", "committedDate": "2020-02-18T15:54:43Z", "type": "commit"}, {"oid": "4a12c658f6f6006c7904c406d7bdfb4fa406c4c9", "url": "https://github.com/DSpace/DSpace/commit/4a12c658f6f6006c7904c406d7bdfb4fa406c4c9", "message": "68825: checkstyle", "committedDate": "2020-02-18T17:42:39Z", "type": "commit"}, {"oid": "15abc3aeb5ad4907cc0ae446a02255afbad5790b", "url": "https://github.com/DSpace/DSpace/commit/15abc3aeb5ad4907cc0ae446a02255afbad5790b", "message": "68860: latest changes from workflow-step-definitions &\nsome exceptions restored except generic exception in upload so UnprocessableEntityException can be thrown in WorkflowItemRestRepository &\ncheckIfEditMetadataAllowedInCurrentStep works with xmlWorkflowItem instead of id", "committedDate": "2020-02-19T09:49:20Z", "type": "commit"}, {"oid": "50daac593737ef8089099a1bf3b4587771aa7b68", "url": "https://github.com/DSpace/DSpace/commit/50daac593737ef8089099a1bf3b4587771aa7b68", "message": "Merge remote-tracking branch 'dspace-origin/master' into w2p-68726_Workflow-IT-in-rest", "committedDate": "2020-02-19T09:51:43Z", "type": "commit"}, {"oid": "701144b10537e5bcd48b25beecfd0db5f3162ff5", "url": "https://github.com/DSpace/DSpace/commit/701144b10537e5bcd48b25beecfd0db5f3162ff5", "message": "68860: test fixes after merging latest dspace-origin/master", "committedDate": "2020-02-19T14:14:29Z", "type": "commit"}, {"oid": "c434124a385d15e5fd5db753ce2faf524df419d0", "url": "https://github.com/DSpace/DSpace/commit/c434124a385d15e5fd5db753ce2faf524df419d0", "message": "Merge branch 'workflow-step-definitions' into w2p-68726_Workflow-IT-in-rest", "committedDate": "2020-02-20T11:17:46Z", "type": "commit"}, {"oid": "d3680b1a3690c26bc6b0dfaf349f76ae7f467529", "url": "https://github.com/DSpace/DSpace/commit/d3680b1a3690c26bc6b0dfaf349f76ae7f467529", "message": "Merge branch 'workflow-step-definitions' into w2p-68726_Workflow-IT-in-rest", "committedDate": "2020-02-24T13:33:43Z", "type": "commit"}, {"oid": "de1076959561fa1a5e988271b4cb7a804f9b953c", "url": "https://github.com/DSpace/DSpace/commit/de1076959561fa1a5e988271b4cb7a804f9b953c", "message": "Merge branch 'workflow-step-definitions' into w2p-68726_Workflow-IT-in-rest", "committedDate": "2020-02-24T14:11:05Z", "type": "commit"}, {"oid": "928987b3935ffb46d69e64d4b90285aa9df154ea", "url": "https://github.com/DSpace/DSpace/commit/928987b3935ffb46d69e64d4b90285aa9df154ea", "message": "Merge branch 'workflow-step-definitions' into w2p-68726_Workflow-IT-in-rest", "committedDate": "2020-02-24T14:52:48Z", "type": "commit"}, {"oid": "3f43e3e807e968acbb89af92fec9e20cc1636cbb", "url": "https://github.com/DSpace/DSpace/commit/3f43e3e807e968acbb89af92fec9e20cc1636cbb", "message": "is(HttpStatus.SC_BAD_REQUEST) to isBadRequest()", "committedDate": "2020-02-25T09:38:28Z", "type": "commit"}, {"oid": "3f43e3e807e968acbb89af92fec9e20cc1636cbb", "url": "https://github.com/DSpace/DSpace/commit/3f43e3e807e968acbb89af92fec9e20cc1636cbb", "message": "is(HttpStatus.SC_BAD_REQUEST) to isBadRequest()", "committedDate": "2020-02-25T09:38:28Z", "type": "forcePushed"}, {"oid": "d33115fde9147b10d2ce528ffd2b2215253f0003", "url": "https://github.com/DSpace/DSpace/commit/d33115fde9147b10d2ce528ffd2b2215253f0003", "message": "Merge branch 'master' into w2p-68726_Workflow-IT-in-rest", "committedDate": "2020-02-26T15:29:40Z", "type": "commit"}, {"oid": "f0863a0505d38e532046f20f3908da63f5f18f3b", "url": "https://github.com/DSpace/DSpace/commit/f0863a0505d38e532046f20f3908da63f5f18f3b", "message": "only do step of workflow whose action is being tested", "committedDate": "2020-03-06T09:40:10Z", "type": "commit"}, {"oid": "222d769d375b5131f584ecfccdc36188ce4f5c19", "url": "https://github.com/DSpace/DSpace/commit/222d769d375b5131f584ecfccdc36188ce4f5c19", "message": "reinstated indents of master", "committedDate": "2020-03-06T09:55:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDYwNjE1NQ==", "url": "https://github.com/DSpace/DSpace/pull/2685#discussion_r390606155", "bodyText": "Tiny thing, but this method name is confusing to me.  The JavaDocs description makes sense, though.  Shouldn't this be named something like isOptionInParam(request)?   The current name sounds like we are checking whether the Request is in the list of Options.\nAlternatively, this could be named something like hasValidOption(request), because it seems like it's really meant to validate whether the request includes one of the Options available to the action.", "author": "tdonohue", "createdAt": "2020-03-10T20:57:13Z", "path": "dspace-api/src/main/java/org/dspace/xmlworkflow/state/actions/Action.java", "diffHunk": "@@ -50,6 +50,20 @@ public abstract ActionResult execute(Context c, XmlWorkflowItem wfi, Step step,\n      */\n     public abstract List<String> getOptions();\n \n+    /**\n+     * Returns true if one of the options is a parameter of the request\n+     * @param request   Action request\n+     * @return  true if one of the options is a parameter of the request; false if none was found\n+     */\n+    protected boolean isInOptions(HttpServletRequest request) {", "originalCommit": "222d769d375b5131f584ecfccdc36188ce4f5c19", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTYxNTM4OA==", "url": "https://github.com/DSpace/DSpace/pull/2685#discussion_r391615388", "bodyText": "Renamed", "author": "MarieVerdonck", "createdAt": "2020-03-12T13:21:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDYwNjE1NQ=="}], "type": "inlineReview", "revised_code": {"commit": "65943dc0d6dc1eccd74e97acdd0e0f7bd8f8cc59", "chunk": "diff --git a/dspace-api/src/main/java/org/dspace/xmlworkflow/state/actions/Action.java b/dspace-api/src/main/java/org/dspace/xmlworkflow/state/actions/Action.java\nindex b8273ebf9..c0c05b174 100644\n--- a/dspace-api/src/main/java/org/dspace/xmlworkflow/state/actions/Action.java\n+++ b/dspace-api/src/main/java/org/dspace/xmlworkflow/state/actions/Action.java\n\n@@ -55,7 +55,7 @@ public abstract class Action {\n      * @param request   Action request\n      * @return  true if one of the options is a parameter of the request; false if none was found\n      */\n-    protected boolean isInOptions(HttpServletRequest request) {\n+    protected boolean isOptionInParam(HttpServletRequest request) {\n         for (String option: this.getOptions()) {\n             if (request.getParameter(option) != null) {\n                 return true;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDYxMTAzOA==", "url": "https://github.com/DSpace/DSpace/pull/2685#discussion_r390611038", "bodyText": "This should provide a more useful error message or just be updated to new RuntimeException(e);  Simply returning e.getMessage() isn't useful here.", "author": "tdonohue", "createdAt": "2020-03-10T21:04:55Z", "path": "dspace-server-webapp/src/main/java/org/dspace/app/rest/repository/WorkflowItemRestRepository.java", "diffHunk": "@@ -294,4 +317,30 @@ protected void delete(Context context, Integer id) {\n             throw new RuntimeException(e.getMessage(), e);\n         }\n     }\n+\n+    /**\n+     * Checks if @link{SUBMIT_EDIT_METADATA} is a valid option in the workflow step this task is currently at.\n+     * Patching and uploading is only allowed if this is the case.\n+     * @param context               Context\n+     * @param xmlWorkflowItem       WorkflowItem of the task\n+     */\n+    private void checkIfEditMetadataAllowedInCurrentStep(Context context, XmlWorkflowItem xmlWorkflowItem) {\n+        try {\n+            ClaimedTask claimedTask = claimedTaskService.findByWorkflowIdAndEPerson(context, xmlWorkflowItem,\n+                context.getCurrentUser());\n+            if (claimedTask == null) {\n+                throw new UnprocessableEntityException(\"WorkflowItem with id \" + xmlWorkflowItem.getID()\n+                    + \" has not been claimed yet.\");\n+            }\n+            Workflow workflow = workflowFactory.getWorkflow(claimedTask.getWorkflowItem().getCollection());\n+            Step step = workflow.getStep(claimedTask.getStepID());\n+            WorkflowActionConfig currentActionConfig = step.getActionConfig(claimedTask.getActionID());\n+            if (!currentActionConfig.getProcessingAction().getOptions().contains(SUBMIT_EDIT_METADATA)) {\n+                throw new UnprocessableEntityException(SUBMIT_EDIT_METADATA + \" is not a valid option on this \" +\n+                    \"action (\" + currentActionConfig.getProcessingAction().getClass() + \").\");\n+            }\n+        } catch (SQLException | WorkflowConfigurationException e) {\n+            throw new RuntimeException(e.getMessage(), e);", "originalCommit": "222d769d375b5131f584ecfccdc36188ce4f5c19", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTYxNTczOA==", "url": "https://github.com/DSpace/DSpace/pull/2685#discussion_r391615738", "bodyText": "All generic exceptions in this repo given relevant messages", "author": "MarieVerdonck", "createdAt": "2020-03-12T13:22:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDYxMTAzOA=="}], "type": "inlineReview", "revised_code": {"commit": "65943dc0d6dc1eccd74e97acdd0e0f7bd8f8cc59", "chunk": "diff --git a/dspace-server-webapp/src/main/java/org/dspace/app/rest/repository/WorkflowItemRestRepository.java b/dspace-server-webapp/src/main/java/org/dspace/app/rest/repository/WorkflowItemRestRepository.java\nindex 9d42fabcb..0d3711a84 100644\n--- a/dspace-server-webapp/src/main/java/org/dspace/app/rest/repository/WorkflowItemRestRepository.java\n+++ b/dspace-server-webapp/src/main/java/org/dspace/app/rest/repository/WorkflowItemRestRepository.java\n\n@@ -313,8 +316,12 @@ public class WorkflowItemRestRepository extends DSpaceRestRepository<WorkflowIte\n             wfs.abort(context, witem, context.getCurrentUser());\n         } catch (AuthorizeException e) {\n             throw new RESTAuthorizationException(e);\n-        } catch (SQLException | IOException e) {\n-            throw new RuntimeException(e.getMessage(), e);\n+        } catch (SQLException e) {\n+            throw new RuntimeException(\"SQLException in \" + this.getClass() + \"#delete trying to retrieve or delete a\" +\n+                \" workflowitem from db.\", e);\n+        } catch (IOException e) {\n+            throw new RuntimeException(\"IOException in \" + this.getClass() + \"#delete trying to delete a workflowitem\" +\n+                \" from db (abort).\", e);\n         }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDYxMTQ4OA==", "url": "https://github.com/DSpace/DSpace/pull/2685#discussion_r390611488", "bodyText": "Not sure why this comment needs changing? It looked correct, so I think this change can be reverted.", "author": "tdonohue", "createdAt": "2020-03-10T21:05:48Z", "path": "dspace-server-webapp/src/test/java/org/dspace/app/rest/TaskRestRepositoriesIT.java", "diffHunk": "@@ -1439,7 +1449,7 @@ public void approvalForbiddenTest() throws Exception {\n                                            .withName(\"Sub Community\")\n                                            .build();\n \n-        // the reviewer2 is a reviewer in a different step for the col1 and with the same role than reviewer1 for\n+        // the reviewer2 is a reviewer in a different step for the colAA1 and with the same role than reviewer1 for", "originalCommit": "222d769d375b5131f584ecfccdc36188ce4f5c19", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTYxNjI1MA==", "url": "https://github.com/DSpace/DSpace/pull/2685#discussion_r391616250", "bodyText": "From restoring from (for the indentations), re-implemented correction", "author": "MarieVerdonck", "createdAt": "2020-03-12T13:23:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDYxMTQ4OA=="}], "type": "inlineReview", "revised_code": {"commit": "65943dc0d6dc1eccd74e97acdd0e0f7bd8f8cc59", "chunk": "diff --git a/dspace-server-webapp/src/test/java/org/dspace/app/rest/TaskRestRepositoriesIT.java b/dspace-server-webapp/src/test/java/org/dspace/app/rest/TaskRestRepositoriesIT.java\nindex 44bcc78fc..4ba94163a 100644\n--- a/dspace-server-webapp/src/test/java/org/dspace/app/rest/TaskRestRepositoriesIT.java\n+++ b/dspace-server-webapp/src/test/java/org/dspace/app/rest/TaskRestRepositoriesIT.java\n\n@@ -1449,7 +1449,7 @@ public class TaskRestRepositoriesIT extends AbstractControllerIntegrationTest {\n                                            .withName(\"Sub Community\")\n                                            .build();\n \n-        // the reviewer2 is a reviewer in a different step for the colAA1 and with the same role than reviewer1 for\n+        // the reviewer2 is a reviewer in a different step for the col1 and with the same role than reviewer1 for\n         // another collection\n         Collection col1 = CollectionBuilder.createCollection(context, child1).withName(\"Collection 1\")\n                 .withWorkflowGroup(1, reviewer1)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDYxMTYwMA==", "url": "https://github.com/DSpace/DSpace/pull/2685#discussion_r390611600", "bodyText": "Same here, this comment change can be reverted.", "author": "tdonohue", "createdAt": "2020-03-10T21:06:02Z", "path": "dspace-server-webapp/src/test/java/org/dspace/app/rest/TaskRestRepositoriesIT.java", "diffHunk": "@@ -1613,7 +1623,7 @@ public void rejectForbiddenTest() throws Exception {\n                                            .withName(\"Sub Community\")\n                                            .build();\n \n-        // the reviewer2 is a reviewer in a different step for the col1 and with the same role than reviewer1 for\n+        // the reviewer2 is a reviewer in a different step for the colAA1 and with the same role than reviewer1 for", "originalCommit": "222d769d375b5131f584ecfccdc36188ce4f5c19", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "65943dc0d6dc1eccd74e97acdd0e0f7bd8f8cc59", "chunk": "diff --git a/dspace-server-webapp/src/test/java/org/dspace/app/rest/TaskRestRepositoriesIT.java b/dspace-server-webapp/src/test/java/org/dspace/app/rest/TaskRestRepositoriesIT.java\nindex 44bcc78fc..4ba94163a 100644\n--- a/dspace-server-webapp/src/test/java/org/dspace/app/rest/TaskRestRepositoriesIT.java\n+++ b/dspace-server-webapp/src/test/java/org/dspace/app/rest/TaskRestRepositoriesIT.java\n\n@@ -1623,7 +1623,7 @@ public class TaskRestRepositoriesIT extends AbstractControllerIntegrationTest {\n                                            .withName(\"Sub Community\")\n                                            .build();\n \n-        // the reviewer2 is a reviewer in a different step for the colAA1 and with the same role than reviewer1 for\n+        // the reviewer2 is a reviewer in a different step for the col1 and with the same role than reviewer1 for\n         // another collection\n         Collection col1 = CollectionBuilder.createCollection(context, child1).withName(\"Collection 1\")\n                 .withWorkflowGroup(1, reviewer1)\n"}}, {"oid": "65943dc0d6dc1eccd74e97acdd0e0f7bd8f8cc59", "url": "https://github.com/DSpace/DSpace/commit/65943dc0d6dc1eccd74e97acdd0e0f7bd8f8cc59", "message": "Process feedback: Exception messages, renamed method & comment fix restored", "committedDate": "2020-03-12T09:52:05Z", "type": "commit"}]}