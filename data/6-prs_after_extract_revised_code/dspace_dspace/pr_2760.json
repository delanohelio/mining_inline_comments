{"pr_number": 2760, "pr_title": "DS-4042 Fix implementation and add integration test for wrong patch request to the submission endpoint", "pr_createdAt": "2020-05-11T15:19:08Z", "pr_url": "https://github.com/DSpace/DSpace/pull/2760", "timeline": [{"oid": "91d70d85cec585cae299aac972d2f1c7181957bf", "url": "https://github.com/DSpace/DSpace/commit/91d70d85cec585cae299aac972d2f1c7181957bf", "message": "added ITs to prove that patch request with wrong path or metadata must return 422", "committedDate": "2020-04-30T15:40:29Z", "type": "commit"}, {"oid": "676648568dd07360b29489210fc2df659833db52", "url": "https://github.com/DSpace/DSpace/commit/676648568dd07360b29489210fc2df659833db52", "message": "fix return http status for wrong patch request to the submission", "committedDate": "2020-04-30T16:58:52Z", "type": "commit"}, {"oid": "6ef11e491962dc5dbf2281752b13ca67ef9a923d", "url": "https://github.com/DSpace/DSpace/commit/6ef11e491962dc5dbf2281752b13ca67ef9a923d", "message": "added the missing parameter", "committedDate": "2020-05-04T07:18:22Z", "type": "commit"}, {"oid": "741357ece7ed121b421c6f8ab24442e1210badfe", "url": "https://github.com/DSpace/DSpace/commit/741357ece7ed121b421c6f8ab24442e1210badfe", "message": "Merge branch 'master' into DS-4042_ITs_WrongPatchRequest", "committedDate": "2020-05-05T07:47:03Z", "type": "commit"}, {"oid": "6fbc15486d14a0584c64dc51ce7e635d920f8289", "url": "https://github.com/DSpace/DSpace/commit/6fbc15486d14a0584c64dc51ce7e635d920f8289", "message": "dc.source metadata is not present in the upload section, so we con not apply patch remove request", "committedDate": "2020-05-11T12:52:02Z", "type": "commit"}, {"oid": "7b7e7cd14e79c074ae6e739b609070388d28f83e", "url": "https://github.com/DSpace/DSpace/commit/7b7e7cd14e79c074ae6e739b609070388d28f83e", "message": "added IT for patch request on metadata with qualdrop_value", "committedDate": "2020-05-14T08:44:14Z", "type": "commit"}, {"oid": "3a1982656a0dc418e2903fc44eab7b2034e390e4", "url": "https://github.com/DSpace/DSpace/commit/3a1982656a0dc418e2903fc44eab7b2034e390e4", "message": "this method should also check metadata with qualdrop_value", "committedDate": "2020-05-14T08:48:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA0OTIyOQ==", "url": "https://github.com/DSpace/DSpace/pull/2760#discussion_r426049229", "bodyText": "This entire if took me a moment to understand. I think we should add a comment here to describe why \"qualdrop_value\" has to be treated separately.  It might say something like:\n// If this is a \"qualdrop_value\" field, then the full field name is the field + dropdown qualifier", "author": "tdonohue", "createdAt": "2020-05-15T21:11:57Z", "path": "dspace-api/src/main/java/org/dspace/app/util/DCInputSet.java", "diffHunk": "@@ -107,9 +108,20 @@ public boolean isFieldPresent(String fieldName) {\n         for (int i = 0; i < inputs.length; i++) {\n             for (int j = 0; j < inputs[i].length; j++) {\n                 DCInput field = inputs[i][j];\n-                String fullName = field.getFieldName();\n-                if (fullName.equals(fieldName)) {\n-                    return true;\n+                if (field.getInputType().equals(\"qualdrop_value\")) {", "originalCommit": "3a1982656a0dc418e2903fc44eab7b2034e390e4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "98f2447cbb938e08ae3b805443747b8ef10555cb", "chunk": "diff --git a/dspace-api/src/main/java/org/dspace/app/util/DCInputSet.java b/dspace-api/src/main/java/org/dspace/app/util/DCInputSet.java\nindex e6a88895f..0f2333004 100644\n--- a/dspace-api/src/main/java/org/dspace/app/util/DCInputSet.java\n+++ b/dspace-api/src/main/java/org/dspace/app/util/DCInputSet.java\n\n@@ -108,6 +108,7 @@ public class DCInputSet {\n         for (int i = 0; i < inputs.length; i++) {\n             for (int j = 0; j < inputs[i].length; j++) {\n                 DCInput field = inputs[i][j];\n+                // If this is a \"qualdrop_value\" field, then the full field name is the field + dropdown qualifier\n                 if (field.getInputType().equals(\"qualdrop_value\")) {\n                     List<String> pairs = field.getPairs();\n                     for (int k = 0; k < pairs.size(); k += 2) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA1MDA4OA==", "url": "https://github.com/DSpace/DSpace/pull/2760#discussion_r426050088", "bodyText": "I think this error should say:  \"The field \" + split[0] + \" is not present in section \"", "author": "tdonohue", "createdAt": "2020-05-15T21:14:13Z", "path": "dspace-server-webapp/src/main/java/org/dspace/app/rest/submit/step/DescribeStep.java", "diffHunk": "@@ -110,13 +111,19 @@ private void readField(InProgressSubmission obj, SubmissionStepConfig config, Da\n     }\n \n     @Override\n-    public void doPatchProcessing(Context context, Request currentRequest, InProgressSubmission source, Operation op)\n-        throws Exception {\n+    public void doPatchProcessing(Context context, Request currentRequest, InProgressSubmission source, Operation op,\n+                                  SubmissionStepConfig stepConf) throws Exception {\n \n         PatchOperation<MetadataValueRest> patchOperation = new PatchOperationFactory()\n-            .instanceOf(DESCRIBE_STEP_METADATA_OPERATION_ENTRY, op.getOp());\n-        patchOperation.perform(context, currentRequest, source, op);\n-\n+                        .instanceOf(DESCRIBE_STEP_METADATA_OPERATION_ENTRY, op.getOp());\n+        DCInputSet inputConfig = inputReader.getInputsByFormName(stepConf.getId());\n+        String[] split = patchOperation.getAbsolutePath(op.getPath()).split(\"/\");\n+        if (inputConfig.isFieldPresent(split[0])) {\n+            patchOperation.perform(context, currentRequest, source, op);\n+        } else {\n+            throw new UnprocessableEntityException(\"The attribute \" + split[0] + \" does not present in section \"", "originalCommit": "3a1982656a0dc418e2903fc44eab7b2034e390e4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "76ff785b076cbb10e38892c7a60f885520534e9d", "chunk": "diff --git a/dspace-server-webapp/src/main/java/org/dspace/app/rest/submit/step/DescribeStep.java b/dspace-server-webapp/src/main/java/org/dspace/app/rest/submit/step/DescribeStep.java\nindex b0134973a..26e904f04 100644\n--- a/dspace-server-webapp/src/main/java/org/dspace/app/rest/submit/step/DescribeStep.java\n+++ b/dspace-server-webapp/src/main/java/org/dspace/app/rest/submit/step/DescribeStep.java\n\n@@ -114,16 +116,53 @@ public class DescribeStep extends org.dspace.submit.step.DescribeStep implements\n     public void doPatchProcessing(Context context, Request currentRequest, InProgressSubmission source, Operation op,\n                                   SubmissionStepConfig stepConf) throws Exception {\n \n-        PatchOperation<MetadataValueRest> patchOperation = new PatchOperationFactory()\n-                        .instanceOf(DESCRIBE_STEP_METADATA_OPERATION_ENTRY, op.getOp());\n+        String[] pathParts = op.getPath().substring(1).split(\"/\");\n         DCInputSet inputConfig = inputReader.getInputsByFormName(stepConf.getId());\n-        String[] split = patchOperation.getAbsolutePath(op.getPath()).split(\"/\");\n-        if (inputConfig.isFieldPresent(split[0])) {\n-            patchOperation.perform(context, currentRequest, source, op);\n+        if (\"remove\".equals(op.getOp()) && pathParts.length < 3) {\n+            // manage delete all step fields\n+            String[] path = op.getPath().substring(1).split(\"/\", 3);\n+            String configId = path[1];\n+            List<String> fieldsName = getInputFieldsName(inputConfig, configId);\n+            for (String fieldName : fieldsName) {\n+                String fieldPath = op.getPath() + \"/\" + fieldName;\n+                Operation fieldRemoveOp = new RemoveOperation(fieldPath);\n+                PatchOperation<MetadataValueRest> patchOperation = new PatchOperationFactory()\n+                     .instanceOf(DESCRIBE_STEP_METADATA_OPERATION_ENTRY, fieldRemoveOp.getOp());\n+                patchOperation.perform(context, currentRequest, source, fieldRemoveOp);\n+            }\n         } else {\n-            throw new UnprocessableEntityException(\"The attribute \" + split[0] + \" does not present in section \"\n-                                                                               + inputConfig.getFormName());\n+            PatchOperation<MetadataValueRest> patchOperation = new PatchOperationFactory()\n+                        .instanceOf(DESCRIBE_STEP_METADATA_OPERATION_ENTRY, op.getOp());\n+            String[] split = patchOperation.getAbsolutePath(op.getPath()).split(\"/\");\n+            if (inputConfig.isFieldPresent(split[0])) {\n+                patchOperation.perform(context, currentRequest, source, op);\n+            } else {\n+                throw new UnprocessableEntityException(\"The field \" + split[0] + \" is not present in section \"\n+                                                                                   + inputConfig.getFormName());\n+            }\n         }\n     }\n \n+    private List<String> getInputFieldsName(DCInputSet inputConfig, String configId) throws DCInputsReaderException {\n+        List<String> fieldsName = new ArrayList<String>();\n+        for (DCInput[] row : inputConfig.getFields()) {\n+            for (DCInput input : row) {\n+                if (input.isQualdropValue()) {\n+                    for (Object qualifier : input.getPairs()) {\n+                        fieldsName.add(input.getFieldName() + \".\" + (String) qualifier);\n+                    }\n+                } else if (StringUtils.equalsIgnoreCase(input.getInputType(), \"group\") ||\n+                        StringUtils.equalsIgnoreCase(input.getInputType(), \"inline-group\")) {\n+                    log.info(\"Called child form:\" + configId + \"-\" +\n+                        Utils.standardize(input.getSchema(), input.getElement(), input.getQualifier(), \"-\"));\n+                    DCInputSet inputConfigChild = inputReader.getInputsByFormName(configId + \"-\" + Utils\n+                        .standardize(input.getSchema(), input.getElement(), input.getQualifier(), \"-\"));\n+                    fieldsName.addAll(getInputFieldsName(inputConfigChild, configId));\n+                } else {\n+                    fieldsName.add(input.getFieldName());\n+                }\n+            }\n+        }\n+        return fieldsName;\n+    }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA1MTQwNw==", "url": "https://github.com/DSpace/DSpace/pull/2760#discussion_r426051407", "bodyText": "If I understand correctly, I think this should likely say \"The path\" + op.getPath() + \" cannot be patched\"", "author": "tdonohue", "createdAt": "2020-05-15T21:17:30Z", "path": "dspace-server-webapp/src/main/java/org/dspace/app/rest/submit/step/LicenseStep.java", "diffHunk": "@@ -50,15 +51,17 @@ public DataLicense getData(SubmissionService submissionService, InProgressSubmis\n     }\n \n     @Override\n-    public void doPatchProcessing(Context context, Request currentRequest, InProgressSubmission source, Operation op)\n-        throws Exception {\n+    public void doPatchProcessing(Context context, Request currentRequest, InProgressSubmission source, Operation op,\n+                                  SubmissionStepConfig stepConf) throws Exception {\n \n         if (op.getPath().endsWith(LICENSE_STEP_OPERATION_ENTRY)) {\n \n             PatchOperation<String> patchOperation = new PatchOperationFactory()\n                 .instanceOf(LICENSE_STEP_OPERATION_ENTRY, op.getOp());\n             patchOperation.perform(context, currentRequest, source, op);\n \n+        } else {\n+            throw new UnprocessableEntityException(\"This path : \" + op.getPath() + \" can not to be replaced\");", "originalCommit": "3a1982656a0dc418e2903fc44eab7b2034e390e4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "98f2447cbb938e08ae3b805443747b8ef10555cb", "chunk": "diff --git a/dspace-server-webapp/src/main/java/org/dspace/app/rest/submit/step/LicenseStep.java b/dspace-server-webapp/src/main/java/org/dspace/app/rest/submit/step/LicenseStep.java\nindex a57951d09..fd4ccc642 100644\n--- a/dspace-server-webapp/src/main/java/org/dspace/app/rest/submit/step/LicenseStep.java\n+++ b/dspace-server-webapp/src/main/java/org/dspace/app/rest/submit/step/LicenseStep.java\n\n@@ -61,7 +61,7 @@ public class LicenseStep extends org.dspace.submit.step.LicenseStep implements A\n             patchOperation.perform(context, currentRequest, source, op);\n \n         } else {\n-            throw new UnprocessableEntityException(\"This path : \" + op.getPath() + \" can not to be replaced\");\n+            throw new UnprocessableEntityException(\"The path \" + op.getPath() + \" cannot be patched\");\n         }\n     }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA1MTY0Nw==", "url": "https://github.com/DSpace/DSpace/pull/2760#discussion_r426051647", "bodyText": "Again, likely should say: \"The field \" + metadata + \" is not present in section \"", "author": "tdonohue", "createdAt": "2020-05-15T21:18:09Z", "path": "dspace-server-webapp/src/main/java/org/dspace/app/rest/submit/step/UploadStep.java", "diffHunk": "@@ -87,8 +98,28 @@ public void doPatchProcessing(Context context, Request currentRequest, InProgres\n             }\n         }\n         PatchOperation<?> patchOperation = new PatchOperationFactory().instanceOf(instance, op.getOp());\n-        patchOperation.perform(context, currentRequest, source, op);\n+        if (instance.equals(AbstractRestProcessingStep.UPLOAD_STEP_METADATA_OPERATION_ENTRY)) {\n+            DCInputSet inputConfig = inputReader.getInputsByFormName(UploadStep.UPLOAD_STEP_METADATA_SECTION);\n+            String[] split = patchOperation.getAbsolutePath(op.getPath()).split(\"/\");\n+            String metadata = findMetadata(split);\n+            if (inputConfig.isFieldPresent(metadata)) {\n+                patchOperation.perform(context, currentRequest, source, op);\n+            } else {\n+                throw new UnprocessableEntityException(\"The attribute \" + metadata + \" does not present in section \"", "originalCommit": "3a1982656a0dc418e2903fc44eab7b2034e390e4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "212985bed68611f7818cba689755af69fbc4c8a7", "chunk": "diff --git a/dspace-server-webapp/src/main/java/org/dspace/app/rest/submit/step/UploadStep.java b/dspace-server-webapp/src/main/java/org/dspace/app/rest/submit/step/UploadStep.java\nindex f32d686ef..11fd36935 100644\n--- a/dspace-server-webapp/src/main/java/org/dspace/app/rest/submit/step/UploadStep.java\n+++ b/dspace-server-webapp/src/main/java/org/dspace/app/rest/submit/step/UploadStep.java\n\n@@ -93,33 +85,16 @@ public class UploadStep extends org.dspace.submit.step.UploadStep\n         } else {\n             if (op.getPath().contains(UPLOAD_STEP_ACCESSCONDITIONS_OPERATION_ENTRY)) {\n                 instance = UPLOAD_STEP_ACCESSCONDITIONS_OPERATION_ENTRY;\n-            } else {\n+            } else if (op.getPath().contains(UPLOAD_STEP_METADATA_PATH)) {\n                 instance = UPLOAD_STEP_METADATA_OPERATION_ENTRY;\n             }\n         }\n-        PatchOperation<?> patchOperation = new PatchOperationFactory().instanceOf(instance, op.getOp());\n-        if (instance.equals(AbstractRestProcessingStep.UPLOAD_STEP_METADATA_OPERATION_ENTRY)) {\n-            DCInputSet inputConfig = inputReader.getInputsByFormName(UploadStep.UPLOAD_STEP_METADATA_SECTION);\n-            String[] split = patchOperation.getAbsolutePath(op.getPath()).split(\"/\");\n-            String metadata = findMetadata(split);\n-            if (inputConfig.isFieldPresent(metadata)) {\n-                patchOperation.perform(context, currentRequest, source, op);\n-            } else {\n-                throw new UnprocessableEntityException(\"The attribute \" + metadata + \" does not present in section \"\n-                                                                        + UploadStep.UPLOAD_STEP_METADATA_SECTION);\n-            }\n-        } else {\n-            patchOperation.perform(context, currentRequest, source, op);\n+        if (instance == null) {\n+            throw new UnprocessableEntityException(\"The path \" + op.getPath() + \" is not supported by the operation \"\n+                                                                              + op.getOp());\n         }\n-    }\n-\n-    private String findMetadata(String[] metadata) {\n-        for (String s : metadata) {\n-            if (s.contains(\"dc.\")) {\n-                return s;\n-            }\n-        }\n-        return null;\n+        PatchOperation<?> patchOperation = new PatchOperationFactory().instanceOf(instance, op.getOp());\n+        patchOperation.perform(context, currentRequest, source, op);\n     }\n \n     @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA1MjQ2Nw==", "url": "https://github.com/DSpace/DSpace/pull/2760#discussion_r426052467", "bodyText": "I'm confused by this method.  Why is it only returning metadata fields in the \"dc\" schema?  I think this needs code comments or JavaDocs to explain why this is needed.", "author": "tdonohue", "createdAt": "2020-05-15T21:20:09Z", "path": "dspace-server-webapp/src/main/java/org/dspace/app/rest/submit/step/UploadStep.java", "diffHunk": "@@ -87,8 +98,28 @@ public void doPatchProcessing(Context context, Request currentRequest, InProgres\n             }\n         }\n         PatchOperation<?> patchOperation = new PatchOperationFactory().instanceOf(instance, op.getOp());\n-        patchOperation.perform(context, currentRequest, source, op);\n+        if (instance.equals(AbstractRestProcessingStep.UPLOAD_STEP_METADATA_OPERATION_ENTRY)) {\n+            DCInputSet inputConfig = inputReader.getInputsByFormName(UploadStep.UPLOAD_STEP_METADATA_SECTION);\n+            String[] split = patchOperation.getAbsolutePath(op.getPath()).split(\"/\");\n+            String metadata = findMetadata(split);\n+            if (inputConfig.isFieldPresent(metadata)) {\n+                patchOperation.perform(context, currentRequest, source, op);\n+            } else {\n+                throw new UnprocessableEntityException(\"The attribute \" + metadata + \" does not present in section \"\n+                                                                        + UploadStep.UPLOAD_STEP_METADATA_SECTION);\n+            }\n+        } else {\n+            patchOperation.perform(context, currentRequest, source, op);\n+        }\n+    }\n \n+    private String findMetadata(String[] metadata) {\n+        for (String s : metadata) {\n+            if (s.contains(\"dc.\")) {\n+                return s;", "originalCommit": "3a1982656a0dc418e2903fc44eab7b2034e390e4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjEzODY5MQ==", "url": "https://github.com/DSpace/DSpace/pull/2760#discussion_r426138691", "bodyText": "I haven't noted that, yes it needs to be rewritten better. @Micheleboychuk I guess that you have introduced that to locate the metadata in the path string of the json patch operation. You can do that easily as the path must be /sections/uploads/files//metadata/xxxxxx/... so if the split has a length >= 6 the split[5] will contains the metadata. Anyway, we also need to check that the json path is valid, i.e. /sections/uploads/files//not-existing-prop/* should be rejected as well", "author": "abollini", "createdAt": "2020-05-16T09:54:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA1MjQ2Nw=="}], "type": "inlineReview", "revised_code": {"commit": "212985bed68611f7818cba689755af69fbc4c8a7", "chunk": "diff --git a/dspace-server-webapp/src/main/java/org/dspace/app/rest/submit/step/UploadStep.java b/dspace-server-webapp/src/main/java/org/dspace/app/rest/submit/step/UploadStep.java\nindex f32d686ef..11fd36935 100644\n--- a/dspace-server-webapp/src/main/java/org/dspace/app/rest/submit/step/UploadStep.java\n+++ b/dspace-server-webapp/src/main/java/org/dspace/app/rest/submit/step/UploadStep.java\n\n@@ -93,33 +85,16 @@ public class UploadStep extends org.dspace.submit.step.UploadStep\n         } else {\n             if (op.getPath().contains(UPLOAD_STEP_ACCESSCONDITIONS_OPERATION_ENTRY)) {\n                 instance = UPLOAD_STEP_ACCESSCONDITIONS_OPERATION_ENTRY;\n-            } else {\n+            } else if (op.getPath().contains(UPLOAD_STEP_METADATA_PATH)) {\n                 instance = UPLOAD_STEP_METADATA_OPERATION_ENTRY;\n             }\n         }\n-        PatchOperation<?> patchOperation = new PatchOperationFactory().instanceOf(instance, op.getOp());\n-        if (instance.equals(AbstractRestProcessingStep.UPLOAD_STEP_METADATA_OPERATION_ENTRY)) {\n-            DCInputSet inputConfig = inputReader.getInputsByFormName(UploadStep.UPLOAD_STEP_METADATA_SECTION);\n-            String[] split = patchOperation.getAbsolutePath(op.getPath()).split(\"/\");\n-            String metadata = findMetadata(split);\n-            if (inputConfig.isFieldPresent(metadata)) {\n-                patchOperation.perform(context, currentRequest, source, op);\n-            } else {\n-                throw new UnprocessableEntityException(\"The attribute \" + metadata + \" does not present in section \"\n-                                                                        + UploadStep.UPLOAD_STEP_METADATA_SECTION);\n-            }\n-        } else {\n-            patchOperation.perform(context, currentRequest, source, op);\n+        if (instance == null) {\n+            throw new UnprocessableEntityException(\"The path \" + op.getPath() + \" is not supported by the operation \"\n+                                                                              + op.getOp());\n         }\n-    }\n-\n-    private String findMetadata(String[] metadata) {\n-        for (String s : metadata) {\n-            if (s.contains(\"dc.\")) {\n-                return s;\n-            }\n-        }\n-        return null;\n+        PatchOperation<?> patchOperation = new PatchOperationFactory().instanceOf(instance, op.getOp());\n+        patchOperation.perform(context, currentRequest, source, op);\n     }\n \n     @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA1Mzg4OQ==", "url": "https://github.com/DSpace/DSpace/pull/2760#discussion_r426053889", "bodyText": "Is there a reason we switched this test to no longer remove dc.source and instead just verify it exists?  Just curious why we switched this test.", "author": "tdonohue", "createdAt": "2020-05-15T21:24:07Z", "path": "dspace-server-webapp/src/test/java/org/dspace/app/rest/WorkspaceItemRestRepositoryIT.java", "diffHunk": "@@ -2444,7 +2452,8 @@ public void patchUploadTest() throws Exception {\n         // check that changes persist\n         getClient(authToken).perform(get(\"/api/submission/workspaceitems/\" + witem.getID()))\n             .andExpect(status().isOk())\n-            .andExpect(jsonPath(\"$.sections.upload.files[0].metadata['dc.source']\").doesNotExist())\n+            .andExpect(jsonPath(\"$.sections.upload.files[0].metadata['dc.source'][0].value\",\n+                    is(\"/local/path/simple-article.pdf\")))", "originalCommit": "3a1982656a0dc418e2903fc44eab7b2034e390e4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjEzNjk4OQ==", "url": "https://github.com/DSpace/DSpace/pull/2760#discussion_r426136989", "bodyText": "this metadata is not included in the form definition https://github.com/DSpace/DSpace/blob/master/dspace/config/submission-forms.xml#L24 so as this PR has fixed the patch request to respect the configuration preventing to update not configured metadata the dc.source should remain untouched.\nOne related question/issue is: should we update also the GET method to respect the configuration exposing only the configured metadata? the rest contract seems to imply that\nhttps://github.com/DSpace/Rest7Contract/blob/master/workspaceitem-data-upload.md\nin this case the test should be changed to verify the dc.source using a separate call to the bitstream endpoint. It is a bit out-of-scope of this PR but if we agree it could be easier to just apply the change also to the \n  \n    \n      DSpace/dspace-server-webapp/src/main/java/org/dspace/app/rest/submit/SubmissionService.java\n    \n    \n         Line 154\n      in\n      8c234d1\n    \n    \n    \n    \n\n        \n          \n           for (MetadataValue md : source.getMetadata()) {", "author": "abollini", "createdAt": "2020-05-16T09:29:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA1Mzg4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc2MTg1OA==", "url": "https://github.com/DSpace/DSpace/pull/2760#discussion_r426761858", "bodyText": "Thanks for the explanation. I'm not sure about updating the GET, as that seems to imply that some metadata could be \"hidden\" (filtered out) in the GET if it's not in the current submission configuration. That seems like it could have side effects if some metadata if filtered out so that it is \"invisible\" to the client side.   In any case, I agree it should not be part of this PR & I think it needs more analysis.\nFor the purposes of this PR, your initial answer is good enough here. The dc.source is not in the default configuration, so it cannot be PATCHed.", "author": "tdonohue", "createdAt": "2020-05-18T16:46:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA1Mzg4OQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "f33bfac1958d9195674244d038f13af91fd37a71", "url": "https://github.com/DSpace/DSpace/commit/f33bfac1958d9195674244d038f13af91fd37a71", "message": "added ITs for upload patch request", "committedDate": "2020-05-20T10:54:08Z", "type": "commit"}, {"oid": "212985bed68611f7818cba689755af69fbc4c8a7", "url": "https://github.com/DSpace/DSpace/commit/212985bed68611f7818cba689755af69fbc4c8a7", "message": "refactoring doPatchProcessing of UploadStep", "committedDate": "2020-05-20T11:02:08Z", "type": "commit"}, {"oid": "98f2447cbb938e08ae3b805443747b8ef10555cb", "url": "https://github.com/DSpace/DSpace/commit/98f2447cbb938e08ae3b805443747b8ef10555cb", "message": "Implement community feedbacks", "committedDate": "2020-05-20T11:13:36Z", "type": "commit"}, {"oid": "ab0aec46984d15b466a19cc582f9a1468a79817e", "url": "https://github.com/DSpace/DSpace/commit/ab0aec46984d15b466a19cc582f9a1468a79817e", "message": "move bean to the right file", "committedDate": "2020-05-20T13:30:53Z", "type": "commit"}, {"oid": "9404e24c4e8d8f4774e7eb0b667deee47351bb3b", "url": "https://github.com/DSpace/DSpace/commit/9404e24c4e8d8f4774e7eb0b667deee47351bb3b", "message": "fix: wrong calling toString", "committedDate": "2020-05-20T13:51:12Z", "type": "commit"}, {"oid": "ccfbbfce9957cd15a2cdde5a281ee49b908026c0", "url": "https://github.com/DSpace/DSpace/commit/ccfbbfce9957cd15a2cdde5a281ee49b908026c0", "message": "added IT patchDeleteSection", "committedDate": "2020-05-20T13:55:13Z", "type": "commit"}, {"oid": "76ff785b076cbb10e38892c7a60f885520534e9d", "url": "https://github.com/DSpace/DSpace/commit/76ff785b076cbb10e38892c7a60f885520534e9d", "message": "added implementation for delete section", "committedDate": "2020-05-20T14:02:32Z", "type": "commit"}, {"oid": "bda1fb815b4615ca383608f7aeaeba706e18ced6", "url": "https://github.com/DSpace/DSpace/commit/bda1fb815b4615ca383608f7aeaeba706e18ced6", "message": "Merge branch 'master' into DS-4042_ITs_WrongPatchRequest", "committedDate": "2020-05-22T12:56:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjU5OTQ4NQ==", "url": "https://github.com/DSpace/DSpace/pull/2760#discussion_r432599485", "bodyText": "I'd appreciate an example or explanation in either the JavaDocs or in an inline comment to explain why we are looking for >=4 \"parts\" to the path.  It's not clear within this class what the path structure is expected to look like.  Also, there are no Unit Tests here to show the expected path structure, and which ones should validate and which should throw exceptions.", "author": "tdonohue", "createdAt": "2020-05-29T16:28:47Z", "path": "dspace-server-webapp/src/main/java/org/dspace/app/rest/utils/BitstreamMetadataValuePathUtils.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/**\n+ * The contents of this file are subject to the license and copyright\n+ * detailed in the LICENSE and NOTICE files at the root of the source\n+ * tree and available online at\n+ *\n+ * http://www.dspace.org/license/\n+ */\n+package org.dspace.app.rest.utils;\n+\n+import org.dspace.app.rest.exception.UnprocessableEntityException;\n+import org.dspace.app.rest.submit.step.UploadStep;\n+import org.dspace.app.util.DCInputSet;\n+import org.dspace.app.util.DCInputsReader;\n+import org.dspace.app.util.DCInputsReaderException;\n+\n+/**\n+ * Utils class offering methods to validate patch operations for bitstream metadata in the submission\n+ * \n+ * @author Mykhaylo Boychuk (mykhaylo.boychuk at 4science.it)\n+ */\n+public class BitstreamMetadataValuePathUtils {\n+\n+    private DCInputsReader inputReader;\n+\n+    BitstreamMetadataValuePathUtils() throws DCInputsReaderException {\n+        inputReader = new DCInputsReader();\n+    }\n+\n+    /**\n+     * Method to verify that the path included in the patch operation is supported\n+     * by the submission configuration of the upload section\n+     * \n+     * @param absolutePath the path in the json patch operation\n+     * @throws DCInputsReaderException      if an error occurs reading the\n+     *                                      submission configuration\n+     * @throws UnprocessableEntityException if the path is invalid\n+     */\n+    public void validate(String absolutePath) throws DCInputsReaderException {\n+        String[] split = absolutePath.split(\"/\");\n+        DCInputSet inputConfig = inputReader.getInputsByFormName(UploadStep.UPLOAD_STEP_METADATA_SECTION);\n+        if (split.length >= 4) {", "originalCommit": "bda1fb815b4615ca383608f7aeaeba706e18ced6", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a338526583e21d10058e5a75edda81f1c4681196", "chunk": "diff --git a/dspace-server-webapp/src/main/java/org/dspace/app/rest/utils/BitstreamMetadataValuePathUtils.java b/dspace-server-webapp/src/main/java/org/dspace/app/rest/utils/BitstreamMetadataValuePathUtils.java\nindex 4ff42d70c..dda661e49 100644\n--- a/dspace-server-webapp/src/main/java/org/dspace/app/rest/utils/BitstreamMetadataValuePathUtils.java\n+++ b/dspace-server-webapp/src/main/java/org/dspace/app/rest/utils/BitstreamMetadataValuePathUtils.java\n\n@@ -38,6 +38,7 @@ public class BitstreamMetadataValuePathUtils {\n     public void validate(String absolutePath) throws DCInputsReaderException {\n         String[] split = absolutePath.split(\"/\");\n         DCInputSet inputConfig = inputReader.getInputsByFormName(UploadStep.UPLOAD_STEP_METADATA_SECTION);\n+        // according to the rest contract the absolute path must be something like files/:idx/metadata/dc.title\n         if (split.length >= 4) {\n             if (!inputConfig.isFieldPresent(split[3])) {\n                 throw new UnprocessableEntityException(\"The field \" + split[3] + \" is not present in section \"\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjYwMjYzNg==", "url": "https://github.com/DSpace/DSpace/pull/2760#discussion_r432602636", "bodyText": "Could we add a test before this patch to verify that the dc.subject and dc.description.abstract both exist by default?  Otherwise, it's possible this test could succeed if they never existed in the first place (I know they do exist, but we should have a test to prove it).", "author": "tdonohue", "createdAt": "2020-05-29T16:34:55Z", "path": "dspace-server-webapp/src/test/java/org/dspace/app/rest/WorkspaceItemRestRepositoryIT.java", "diffHunk": "@@ -3196,4 +3205,507 @@ public void findByItemUuidUnAuthenticatedTest() throws Exception {\n                         .andExpect(status().isUnauthorized());\n     }\n \n+    @Test\n+    public void patchAddMetadataOnSectionNotExistentTest() throws Exception {\n+        context.turnOffAuthorisationSystem();\n+\n+        parentCommunity = CommunityBuilder.createCommunity(context)\n+                         .withName(\"Parent Community\")\n+                         .build();\n+\n+        Community child1 = CommunityBuilder.createSubCommunity(context, parentCommunity)\n+                          .withName(\"Sub Community\")\n+                          .build();\n+\n+        Collection col1 = CollectionBuilder.createCollection(context, child1)\n+                         .withName(\"Collection 1\")\n+                         .build();\n+\n+        WorkspaceItem witem = WorkspaceItemBuilder.createWorkspaceItem(context, col1)\n+                             .withIssueDate(\"2019-04-25\")\n+                             .withSubject(\"ExtraEntry\")\n+                             .build();\n+\n+        //disable file upload mandatory\n+        configurationService.setProperty(\"webui.submit.upload.required\", false);\n+\n+        context.restoreAuthSystemState();\n+\n+        String authToken = getAuthToken(eperson.getEmail(), password);\n+\n+        List<Operation> addTitle = new ArrayList<Operation>();\n+        List<Map<String, String>> values = new ArrayList<Map<String, String>>();\n+        Map<String, String> value = new HashMap<String, String>();\n+        value.put(\"value\", \"New Title\");\n+        values.add(value);\n+        addTitle.add(new AddOperation(\"/sections/not-existing-section/dc.title\", values));\n+\n+        String patchBody = getPatchContent(addTitle);\n+        getClient(authToken).perform(patch(\"/api/submission/workspaceitems/\" + witem.getID())\n+                 .content(patchBody)\n+                 .contentType(MediaType.APPLICATION_JSON_PATCH_JSON))\n+                 .andExpect(status().isUnprocessableEntity());\n+    }\n+\n+    @Test\n+    public void patchAddMetadataWrongAttributeTest() throws Exception {\n+        context.turnOffAuthorisationSystem();\n+\n+        parentCommunity = CommunityBuilder.createCommunity(context)\n+                         .withName(\"Parent Community\")\n+                         .build();\n+\n+        Community child1 = CommunityBuilder.createSubCommunity(context, parentCommunity)\n+                          .withName(\"Sub Community\")\n+                          .build();\n+\n+        Collection col1 = CollectionBuilder.createCollection(context, child1)\n+                         .withName(\"Collection 1\")\n+                         .build();\n+\n+        WorkspaceItem witem = WorkspaceItemBuilder.createWorkspaceItem(context, col1)\n+                             .withIssueDate(\"2019-04-25\")\n+                             .withSubject(\"ExtraEntry\")\n+                             .build();\n+\n+        //disable file upload mandatory\n+        configurationService.setProperty(\"webui.submit.upload.required\", false);\n+\n+        context.restoreAuthSystemState();\n+\n+        String authToken = getAuthToken(eperson.getEmail(), password);\n+\n+        List<Operation> addTitle = new ArrayList<Operation>();\n+        List<Map<String, String>> values = new ArrayList<Map<String, String>>();\n+        Map<String, String> value = new HashMap<String, String>();\n+        value.put(\"value\", \"New Title\");\n+        values.add(value);\n+        addTitle.add(new AddOperation(\"/sections/traditionalpageone/dc.not.existing\", values));\n+\n+        String patchBody = getPatchContent(addTitle);\n+        getClient(authToken).perform(patch(\"/api/submission/workspaceitems/\" + witem.getID())\n+                 .content(patchBody)\n+                 .contentType(MediaType.APPLICATION_JSON_PATCH_JSON))\n+                 .andExpect(status().isUnprocessableEntity());\n+    }\n+\n+    @Test\n+    // try to add Title on tradiotionalpagetwo, but attribute title is placed on tradiotionalpageone\n+    public void patchAddTitleOnSectionThatNotContainAttributeTitleTest() throws Exception {\n+        context.turnOffAuthorisationSystem();\n+\n+        parentCommunity = CommunityBuilder.createCommunity(context)\n+                         .withName(\"Parent Community\")\n+                         .build();\n+\n+        Community child1 = CommunityBuilder.createSubCommunity(context, parentCommunity)\n+                          .withName(\"Sub Community\")\n+                          .build();\n+\n+        Collection col1 = CollectionBuilder.createCollection(context, child1)\n+                         .withName(\"Collection 1\")\n+                         .build();\n+\n+        WorkspaceItem witem = WorkspaceItemBuilder.createWorkspaceItem(context, col1)\n+                             .withIssueDate(\"2019-11-21\")\n+                             .withSubject(\"ExtraEntry\")\n+                             .build();\n+\n+        //disable file upload mandatory\n+        configurationService.setProperty(\"webui.submit.upload.required\", false);\n+\n+        context.restoreAuthSystemState();\n+\n+        String authToken = getAuthToken(eperson.getEmail(), password);\n+\n+        List<Operation> addTitle = new ArrayList<Operation>();\n+        List<Map<String, String>> values = new ArrayList<Map<String, String>>();\n+        Map<String, String> value = new HashMap<String, String>();\n+        value.put(\"value\", \"New Title\");\n+        values.add(value);\n+        addTitle.add(new AddOperation(\"/sections/traditionalpagetwo/dc.title\", values));\n+\n+        String patchBody = getPatchContent(addTitle);\n+        getClient(authToken).perform(patch(\"/api/submission/workspaceitems/\" + witem.getID())\n+                 .content(patchBody)\n+                 .contentType(MediaType.APPLICATION_JSON_PATCH_JSON))\n+                 .andExpect(status().isUnprocessableEntity());\n+    }\n+\n+    @Test\n+    public void patchAcceptLicenseWrontPathTest() throws Exception {\n+        context.turnOffAuthorisationSystem();\n+\n+        parentCommunity = CommunityBuilder.createCommunity(context)\n+                         .withName(\"Parent Community\")\n+                         .build();\n+\n+        Community child1 = CommunityBuilder.createSubCommunity(context, parentCommunity)\n+                          .withName(\"Sub Community\")\n+                          .build();\n+\n+        Collection col1 = CollectionBuilder.createCollection(context, child1)\n+                         .withName(\"Collection 1\")\n+                         .build();\n+\n+        WorkspaceItem witem = WorkspaceItemBuilder.createWorkspaceItem(context, col1)\n+                             .withTitle(\"Example Title\")\n+                             .withIssueDate(\"2019-11-21\")\n+                             .withSubject(\"ExtraEntry\")\n+                             .build();\n+\n+        //disable file upload mandatory\n+        configurationService.setProperty(\"webui.submit.upload.required\", false);\n+\n+        context.restoreAuthSystemState();\n+\n+        String authToken = getAuthToken(eperson.getEmail(), password);\n+\n+        List<Operation> replaceGrant = new ArrayList<Operation>();\n+        replaceGrant.add(new ReplaceOperation(\"/sections/license/not-existing\", true));\n+\n+        String patchBody = getPatchContent(replaceGrant);\n+        getClient(authToken).perform(patch(\"/api/submission/workspaceitems/\" + witem.getID())\n+                 .content(patchBody)\n+                 .contentType(MediaType.APPLICATION_JSON_PATCH_JSON))\n+                 .andExpect(status().isUnprocessableEntity());\n+    }\n+\n+    @Test\n+    public void patchAcceptLicenseTryToChangeLicenseUrlTest() throws Exception {\n+        context.turnOffAuthorisationSystem();\n+\n+        parentCommunity = CommunityBuilder.createCommunity(context)\n+                         .withName(\"Parent Community\")\n+                         .build();\n+\n+        Community child1 = CommunityBuilder.createSubCommunity(context, parentCommunity)\n+                          .withName(\"Sub Community\")\n+                          .build();\n+\n+        Collection col1 = CollectionBuilder.createCollection(context, child1)\n+                         .withName(\"Collection 1\")\n+                         .build();\n+\n+        WorkspaceItem witem = WorkspaceItemBuilder.createWorkspaceItem(context, col1)\n+                             .withTitle(\"Example Title\")\n+                             .withIssueDate(\"2019-11-21\")\n+                             .withSubject(\"ExtraEntry\")\n+                             .build();\n+\n+        //disable file upload mandatory\n+        configurationService.setProperty(\"webui.submit.upload.required\", false);\n+\n+        context.restoreAuthSystemState();\n+\n+        String authToken = getAuthToken(eperson.getEmail(), password);\n+\n+        List<Operation> replaceGrant = new ArrayList<Operation>();\n+        replaceGrant.add(new ReplaceOperation(\"/sections/license/granted\", true));\n+\n+        String patchBody = getPatchContent(replaceGrant);\n+        getClient(authToken).perform(patch(\"/api/submission/workspaceitems/\" + witem.getID())\n+                 .content(patchBody)\n+                 .contentType(MediaType.APPLICATION_JSON_PATCH_JSON))\n+                 .andExpect(status().isOk());\n+\n+        List<Operation> replaceLicenseUrl = new ArrayList<Operation>();\n+        replaceLicenseUrl.add(new ReplaceOperation(\"/sections/license/url\", \"not.existing\"));\n+\n+        patchBody = getPatchContent(replaceLicenseUrl);\n+        getClient(authToken).perform(patch(\"/api/submission/workspaceitems/\" + witem.getID())\n+                 .content(patchBody)\n+                 .contentType(MediaType.APPLICATION_JSON_PATCH_JSON))\n+                 .andExpect(status().isUnprocessableEntity());\n+    }\n+\n+    @Test\n+    public void patchAcceptLicenseTryToChangeDateAccepteLicenseTest() throws Exception {\n+        context.turnOffAuthorisationSystem();\n+\n+        parentCommunity = CommunityBuilder.createCommunity(context)\n+                         .withName(\"Parent Community\")\n+                         .build();\n+\n+        Community child1 = CommunityBuilder.createSubCommunity(context, parentCommunity)\n+                          .withName(\"Sub Community\")\n+                          .build();\n+\n+        Collection col1 = CollectionBuilder.createCollection(context, child1)\n+                         .withName(\"Collection 1\")\n+                         .build();\n+\n+        WorkspaceItem witem = WorkspaceItemBuilder.createWorkspaceItem(context, col1)\n+                             .withTitle(\"Example Title\")\n+                             .withIssueDate(\"2019-11-21\")\n+                             .withSubject(\"ExtraEntry\")\n+                             .build();\n+\n+        //disable file upload mandatory\n+        configurationService.setProperty(\"webui.submit.upload.required\", false);\n+\n+        context.restoreAuthSystemState();\n+\n+        String authToken = getAuthToken(eperson.getEmail(), password);\n+\n+        List<Operation> replaceGrant = new ArrayList<Operation>();\n+        replaceGrant.add(new ReplaceOperation(\"/sections/license/granted\", true));\n+\n+        String patchBody = getPatchContent(replaceGrant);\n+        getClient(authToken).perform(patch(\"/api/submission/workspaceitems/\" + witem.getID())\n+                 .content(patchBody)\n+                 .contentType(MediaType.APPLICATION_JSON_PATCH_JSON))\n+                 .andExpect(status().isOk());\n+\n+        List<Operation> replaceLicenseUrl = new ArrayList<Operation>();\n+        replaceLicenseUrl.add(new ReplaceOperation(\"/sections/license/acceptanceDate\", \"2020-02-14\"));\n+\n+        patchBody = getPatchContent(replaceLicenseUrl);\n+        getClient(authToken).perform(patch(\"/api/submission/workspaceitems/\" + witem.getID())\n+                 .content(patchBody)\n+                 .contentType(MediaType.APPLICATION_JSON_PATCH_JSON))\n+                 .andExpect(status().isUnprocessableEntity());\n+    }\n+\n+    @Test\n+    public void patchUploadMetadatoNotExistTest() throws Exception {\n+        context.turnOffAuthorisationSystem();\n+\n+        parentCommunity = CommunityBuilder.createCommunity(context)\n+                                          .withName(\"Parent Community\")\n+                                          .build();\n+        Community child1 = CommunityBuilder.createSubCommunity(context, parentCommunity)\n+                                           .withName(\"Sub Community\")\n+                                           .build();\n+        Collection col1 = CollectionBuilder.createCollection(context, child1)\n+                                           .withName(\"Collection 1\")\n+                                           .build();\n+\n+        InputStream pdf = getClass().getResourceAsStream(\"simple-article.pdf\");\n+\n+        WorkspaceItem witem = WorkspaceItemBuilder.createWorkspaceItem(context, col1)\n+                 .withTitle(\"Test WorkspaceItem\")\n+                 .withIssueDate(\"2019-10-25\")\n+                 .withFulltext(\"simple-article.pdf\", \"/local/path/simple-article.pdf\", pdf)\n+                 .build();\n+\n+        context.restoreAuthSystemState();\n+\n+        String authToken = getAuthToken(eperson.getEmail(), password);\n+\n+        List<Operation> addOpts = new ArrayList<Operation>();\n+        Map<String, String> value = new HashMap<String, String>();\n+        value.put(\"value\", \"some text\");\n+        addOpts.add(new AddOperation(\"/sections/upload/files/0/metadata/dc.not.existing\", value));\n+\n+        String patchBody = getPatchContent(addOpts);\n+        getClient(authToken).perform(patch(\"/api/submission/workspaceitems/\" + witem.getID())\n+                            .content(patchBody)\n+                            .contentType(MediaType.APPLICATION_JSON_PATCH_JSON))\n+                            .andExpect(status().isUnprocessableEntity());\n+    }\n+\n+    @Test\n+    public void patchUploadWrongPathTest() throws Exception {\n+        context.turnOffAuthorisationSystem();\n+\n+        parentCommunity = CommunityBuilder.createCommunity(context)\n+                                          .withName(\"Parent Community\")\n+                                          .build();\n+        Community child1 = CommunityBuilder.createSubCommunity(context, parentCommunity)\n+                                           .withName(\"Sub Community\")\n+                                           .build();\n+        Collection col1 = CollectionBuilder.createCollection(context, child1)\n+                                           .withName(\"Collection 1\")\n+                                           .build();\n+\n+        InputStream pdf = getClass().getResourceAsStream(\"simple-article.pdf\");\n+\n+        WorkspaceItem witem = WorkspaceItemBuilder.createWorkspaceItem(context, col1)\n+                .withTitle(\"Test WorkspaceItem\")\n+                .withIssueDate(\"2017-10-17\")\n+                .withFulltext(\"simple-article.pdf\", \"/local/path/simple-article.pdf\", pdf)\n+                .build();\n+\n+        context.restoreAuthSystemState();\n+\n+        String authToken = getAuthToken(eperson.getEmail(), password);\n+\n+        List<Operation> addOpts = new ArrayList<Operation>();\n+        Map<String, String> value = new HashMap<String, String>();\n+        value.put(\"value\", \"2020-01-25\");\n+        addOpts.add(new AddOperation(\"/sections/upload/files/0/metadata/dc.date.issued\", value));\n+\n+        String patchBody = getPatchContent(addOpts);\n+        getClient(authToken).perform(patch(\"/api/submission/workspaceitems/\" + witem.getID())\n+                            .content(patchBody)\n+                            .contentType(MediaType.APPLICATION_JSON_PATCH_JSON))\n+                            .andExpect(status().isUnprocessableEntity());\n+    }\n+\n+    @Test\n+    public void patchUploadMissingFieldTest() throws Exception {\n+        context.turnOffAuthorisationSystem();\n+\n+        parentCommunity = CommunityBuilder.createCommunity(context)\n+                                          .withName(\"Parent Community\")\n+                                          .build();\n+        Community child1 = CommunityBuilder.createSubCommunity(context, parentCommunity)\n+                                           .withName(\"Sub Community\")\n+                                           .build();\n+        Collection col1 = CollectionBuilder.createCollection(context, child1)\n+                                           .withName(\"Collection 1\")\n+                                           .build();\n+\n+        InputStream pdf = getClass().getResourceAsStream(\"simple-article.pdf\");\n+\n+        WorkspaceItem witem = WorkspaceItemBuilder.createWorkspaceItem(context, col1)\n+                .withTitle(\"Test WorkspaceItem\")\n+                .withIssueDate(\"2017-10-17\")\n+                .withFulltext(\"simple-article.pdf\", \"/local/path/simple-article.pdf\", pdf)\n+                .build();\n+\n+        context.restoreAuthSystemState();\n+\n+        String authToken = getAuthToken(eperson.getEmail(), password);\n+\n+        List<Operation> addOpts = new ArrayList<Operation>();\n+        Map<String, String> value = new HashMap<String, String>();\n+        value.put(\"value\", \"test text\");\n+\n+        addOpts.add(new AddOperation(\"/sections/upload/files/0/metadata\", value));\n+\n+        String patchBody = getPatchContent(addOpts);\n+        getClient(authToken).perform(patch(\"/api/submission/workspaceitems/\" + witem.getID())\n+                .content(patchBody)\n+                .contentType(MediaType.APPLICATION_JSON_PATCH_JSON))\n+                            .andExpect(status().isUnprocessableEntity());\n+    }\n+\n+    @Test\n+    public void patchUploadNotExistingPropertyTest() throws Exception {\n+        context.turnOffAuthorisationSystem();\n+\n+        parentCommunity = CommunityBuilder.createCommunity(context)\n+                                          .withName(\"Parent Community\")\n+                                          .build();\n+        Community child1 = CommunityBuilder.createSubCommunity(context, parentCommunity)\n+                                           .withName(\"Sub Community\")\n+                                           .build();\n+        Collection col1 = CollectionBuilder.createCollection(context, child1)\n+                                           .withName(\"Collection 1\")\n+                                           .build();\n+\n+        InputStream pdf = getClass().getResourceAsStream(\"simple-article.pdf\");\n+\n+        WorkspaceItem witem = WorkspaceItemBuilder.createWorkspaceItem(context, col1)\n+                .withTitle(\"Test WorkspaceItem\")\n+                .withIssueDate(\"2017-10-17\")\n+                .withFulltext(\"simple-article.pdf\", \"/local/path/simple-article.pdf\", pdf)\n+                .build();\n+\n+        context.restoreAuthSystemState();\n+\n+        String authToken = getAuthToken(eperson.getEmail(), password);\n+\n+        List<Operation> addOpts = new ArrayList<Operation>();\n+        Map<String, String> value = new HashMap<String, String>();\n+        value.put(\"value\", \"test text\");\n+\n+        addOpts.add(new AddOperation(\"/sections/upload/files/0/not-existing-property/dc.title\", value));\n+\n+        String patchBody = getPatchContent(addOpts);\n+        getClient(authToken).perform(patch(\"/api/submission/workspaceitems/\" + witem.getID())\n+                .content(patchBody)\n+                .contentType(MediaType.APPLICATION_JSON_PATCH_JSON))\n+                            .andExpect(status().isUnprocessableEntity());\n+    }\n+\n+    @Test\n+    public void patchUploadWithWrongPathTest() throws Exception {\n+        context.turnOffAuthorisationSystem();\n+\n+        parentCommunity = CommunityBuilder.createCommunity(context)\n+                                          .withName(\"Parent Community\")\n+                                          .build();\n+        Community child1 = CommunityBuilder.createSubCommunity(context, parentCommunity)\n+                                           .withName(\"Sub Community\")\n+                                           .build();\n+        Collection col1 = CollectionBuilder.createCollection(context, child1)\n+                                           .withName(\"Collection 1\")\n+                                           .build();\n+\n+        InputStream pdf = getClass().getResourceAsStream(\"simple-article.pdf\");\n+\n+        WorkspaceItem witem = WorkspaceItemBuilder.createWorkspaceItem(context, col1)\n+                .withTitle(\"Test WorkspaceItem\")\n+                .withIssueDate(\"2017-10-17\")\n+                .withFulltext(\"simple-article.pdf\", \"/local/path/simple-article.pdf\", pdf)\n+                .build();\n+\n+        context.restoreAuthSystemState();\n+\n+        String authToken = getAuthToken(eperson.getEmail(), password);\n+\n+        List<Operation> addOpts = new ArrayList<Operation>();\n+        Map<String, String> value = new HashMap<String, String>();\n+        value.put(\"value\", \"test text\");\n+\n+        addOpts.add(new AddOperation(\"/sections/upload/files/0\", value));\n+\n+        String patchBody = getPatchContent(addOpts);\n+        getClient(authToken).perform(patch(\"/api/submission/workspaceitems/\" + witem.getID())\n+                .content(patchBody)\n+                .contentType(MediaType.APPLICATION_JSON_PATCH_JSON))\n+                            .andExpect(status().isUnprocessableEntity());\n+\n+        addOpts.add(new AddOperation(\"/sections/upload/files\", value));\n+        patchBody = getPatchContent(addOpts);\n+\n+        getClient(authToken).perform(patch(\"/api/submission/workspaceitems/\" + witem.getID())\n+                .content(patchBody)\n+                .contentType(MediaType.APPLICATION_JSON_PATCH_JSON))\n+                            .andExpect(status().isUnprocessableEntity());\n+    }\n+\n+    @Test\n+    public void patchDeleteSectionTest() throws Exception {\n+        context.turnOffAuthorisationSystem();\n+        parentCommunity = CommunityBuilder.createCommunity(context)\n+                                          .withName(\"Parent Community\")\n+                                          .build();\n+        Community child1 = CommunityBuilder.createSubCommunity(context, parentCommunity)\n+                                           .withName(\"Sub Community\")\n+                                           .build();\n+        Collection col1 = CollectionBuilder.createCollection(context, child1)\n+                                           .withName(\"Collection 1\")\n+                                           .build();\n+        WorkspaceItem witem = WorkspaceItemBuilder.createWorkspaceItem(context, col1)\n+                             .withTitle(\"Test WorkspaceItem\")\n+                             .withIssueDate(\"2020-01-21\")\n+                             .withSubject(\"Subject 1\")\n+                             .withSubject(\"Subject 2\")\n+                             .build();\n+\n+        context.restoreAuthSystemState();\n+\n+        List<Operation> operations = new ArrayList<Operation>();\n+        operations.add(new RemoveOperation(\"/sections/traditionalpagetwo\"));\n+        String patchBody = getPatchContent(operations);\n+\n+        String authToken = getAuthToken(eperson.getEmail(), password);\n+\n+        getClient(authToken).perform(patch(\"/api/submission/workspaceitems/\" + witem.getID())\n+                 .content(patchBody)\n+                 .contentType(MediaType.APPLICATION_JSON_PATCH_JSON))\n+                 .andExpect(status().isOk())\n+                 .andExpect(jsonPath(\"$.sections.traditionalpagetwo['dc.subject']\").doesNotExist())\n+                 .andExpect(jsonPath(\"$.sections.traditionalpagetwo['dc.description.abstract']\").doesNotExist());", "originalCommit": "bda1fb815b4615ca383608f7aeaeba706e18ced6", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a338526583e21d10058e5a75edda81f1c4681196", "chunk": "diff --git a/dspace-server-webapp/src/test/java/org/dspace/app/rest/WorkspaceItemRestRepositoryIT.java b/dspace-server-webapp/src/test/java/org/dspace/app/rest/WorkspaceItemRestRepositoryIT.java\nindex 4e848eb25..e18f06c1e 100644\n--- a/dspace-server-webapp/src/test/java/org/dspace/app/rest/WorkspaceItemRestRepositoryIT.java\n+++ b/dspace-server-webapp/src/test/java/org/dspace/app/rest/WorkspaceItemRestRepositoryIT.java\n\n@@ -3685,16 +3685,22 @@ public class WorkspaceItemRestRepositoryIT extends AbstractControllerIntegration\n                              .withIssueDate(\"2020-01-21\")\n                              .withSubject(\"Subject 1\")\n                              .withSubject(\"Subject 2\")\n+                             .withAbstract(\"Test description abstract\")\n                              .build();\n \n         context.restoreAuthSystemState();\n \n+        String authToken = getAuthToken(eperson.getEmail(), password);\n+\n+        getClient(authToken).perform(get(\"/api/submission/workspaceitems/\" + witem.getID()))\n+                 .andExpect(status().isOk())\n+                 .andExpect(jsonPath(\"$.sections.traditionalpagetwo['dc.subject']\").isNotEmpty())\n+                 .andExpect(jsonPath(\"$.sections.traditionalpagetwo['dc.description.abstract']\").isNotEmpty());\n+\n         List<Operation> operations = new ArrayList<Operation>();\n         operations.add(new RemoveOperation(\"/sections/traditionalpagetwo\"));\n         String patchBody = getPatchContent(operations);\n \n-        String authToken = getAuthToken(eperson.getEmail(), password);\n-\n         getClient(authToken).perform(patch(\"/api/submission/workspaceitems/\" + witem.getID())\n                  .content(patchBody)\n                  .contentType(MediaType.APPLICATION_JSON_PATCH_JSON))\n"}}, {"oid": "a338526583e21d10058e5a75edda81f1c4681196", "url": "https://github.com/DSpace/DSpace/commit/a338526583e21d10058e5a75edda81f1c4681196", "message": "Implement community feedbacks", "committedDate": "2020-06-03T13:39:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjgzMjQzNA==", "url": "https://github.com/DSpace/DSpace/pull/2760#discussion_r436832434", "bodyText": "Please log a more useful message here than e.getMessage(), e.g. the message in the line below", "author": "benbosman", "createdAt": "2020-06-08T16:21:21Z", "path": "dspace-server-webapp/src/main/java/org/dspace/app/rest/repository/WorkspaceItemRestRepository.java", "diffHunk": "@@ -326,12 +330,19 @@ private void evaluatePatch(Context context, HttpServletRequest request, Workspac\n                             \" Therefore it cannot be used by the Configurable Submission as the <processing-class>!\");\n                     }\n \n+                } catch (UnprocessableEntityException e) {\n+                    log.error(e.getMessage(), e);", "originalCommit": "a338526583e21d10058e5a75edda81f1c4681196", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "aa15d658178601ed121f527395edc7b22a9bda07", "chunk": "diff --git a/dspace-server-webapp/src/main/java/org/dspace/app/rest/repository/WorkspaceItemRestRepository.java b/dspace-server-webapp/src/main/java/org/dspace/app/rest/repository/WorkspaceItemRestRepository.java\nindex 0b5217405..a8b514ba0 100644\n--- a/dspace-server-webapp/src/main/java/org/dspace/app/rest/repository/WorkspaceItemRestRepository.java\n+++ b/dspace-server-webapp/src/main/java/org/dspace/app/rest/repository/WorkspaceItemRestRepository.java\n\n@@ -331,8 +331,7 @@ public class WorkspaceItemRestRepository extends DSpaceRestRepository<WorkspaceI\n                     }\n \n                 } catch (UnprocessableEntityException e) {\n-                    log.error(e.getMessage(), e);\n-                    throw new UnprocessableEntityException(\"Error processing the patch request\", e);\n+                    throw e;\n                 } catch (Exception e) {\n                     log.error(e.getMessage(), e);\n                     throw new PatchException(\"Error processing the patch request\", e);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjgzNjUzMQ==", "url": "https://github.com/DSpace/DSpace/pull/2760#discussion_r436836531", "bodyText": "this is not verified for remove. Does this imply the user can e.g. remove the item template, even if that metadata field is not adjustable in the form?\nCan you add an IT to prove the user can't remove a field not in the form?", "author": "benbosman", "createdAt": "2020-06-08T16:27:41Z", "path": "dspace-server-webapp/src/main/java/org/dspace/app/rest/submit/step/DescribeStep.java", "diffHunk": "@@ -110,13 +113,56 @@ private void readField(InProgressSubmission obj, SubmissionStepConfig config, Da\n     }\n \n     @Override\n-    public void doPatchProcessing(Context context, Request currentRequest, InProgressSubmission source, Operation op)\n-        throws Exception {\n-\n-        PatchOperation<MetadataValueRest> patchOperation = new PatchOperationFactory()\n-            .instanceOf(DESCRIBE_STEP_METADATA_OPERATION_ENTRY, op.getOp());\n-        patchOperation.perform(context, currentRequest, source, op);\n-\n+    public void doPatchProcessing(Context context, Request currentRequest, InProgressSubmission source, Operation op,\n+                                  SubmissionStepConfig stepConf) throws Exception {\n+\n+        String[] pathParts = op.getPath().substring(1).split(\"/\");\n+        DCInputSet inputConfig = inputReader.getInputsByFormName(stepConf.getId());\n+        if (\"remove\".equals(op.getOp()) && pathParts.length < 3) {\n+            // manage delete all step fields\n+            String[] path = op.getPath().substring(1).split(\"/\", 3);\n+            String configId = path[1];\n+            List<String> fieldsName = getInputFieldsName(inputConfig, configId);\n+            for (String fieldName : fieldsName) {\n+                String fieldPath = op.getPath() + \"/\" + fieldName;\n+                Operation fieldRemoveOp = new RemoveOperation(fieldPath);\n+                PatchOperation<MetadataValueRest> patchOperation = new PatchOperationFactory()\n+                     .instanceOf(DESCRIBE_STEP_METADATA_OPERATION_ENTRY, fieldRemoveOp.getOp());\n+                patchOperation.perform(context, currentRequest, source, fieldRemoveOp);\n+            }\n+        } else {\n+            PatchOperation<MetadataValueRest> patchOperation = new PatchOperationFactory()\n+                        .instanceOf(DESCRIBE_STEP_METADATA_OPERATION_ENTRY, op.getOp());\n+            String[] split = patchOperation.getAbsolutePath(op.getPath()).split(\"/\");\n+            if (inputConfig.isFieldPresent(split[0])) {\n+                patchOperation.perform(context, currentRequest, source, op);\n+            } else {\n+                throw new UnprocessableEntityException(\"The field \" + split[0] + \" is not present in section \"", "originalCommit": "a338526583e21d10058e5a75edda81f1c4681196", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjE3MzUxOQ==", "url": "https://github.com/DSpace/DSpace/pull/2760#discussion_r442173519", "bodyText": "@abollini can you also verify this feedback?", "author": "benbosman", "createdAt": "2020-06-18T12:01:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjgzNjUzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjMzNzI2Ng==", "url": "https://github.com/DSpace/DSpace/pull/2760#discussion_r442337266", "bodyText": "@benbosman I guess that this is the test that you have requested 4ff01ae#diff-38ba2da3dd74a1027593bbd62d684626R3792\nthe dc.title is not present in the traditionalpagetwo form so the remove patch fails and the dc.title is still here", "author": "abollini", "createdAt": "2020-06-18T16:03:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjgzNjUzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY3NjU1Mg==", "url": "https://github.com/DSpace/DSpace/pull/2760#discussion_r443676552", "bodyText": "Thanks, that's indeed the test I was looking for", "author": "benbosman", "createdAt": "2020-06-22T16:18:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjgzNjUzMQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjgzOTQ1Mw==", "url": "https://github.com/DSpace/DSpace/pull/2760#discussion_r436839453", "bodyText": "Can you also verify the dc.title is not created?", "author": "benbosman", "createdAt": "2020-06-08T16:32:17Z", "path": "dspace-server-webapp/src/test/java/org/dspace/app/rest/WorkspaceItemRestRepositoryIT.java", "diffHunk": "@@ -3196,4 +3205,513 @@ public void findByItemUuidUnAuthenticatedTest() throws Exception {\n                         .andExpect(status().isUnauthorized());\n     }\n \n+    @Test\n+    public void patchAddMetadataOnSectionNotExistentTest() throws Exception {\n+        context.turnOffAuthorisationSystem();\n+\n+        parentCommunity = CommunityBuilder.createCommunity(context)\n+                         .withName(\"Parent Community\")\n+                         .build();\n+\n+        Community child1 = CommunityBuilder.createSubCommunity(context, parentCommunity)\n+                          .withName(\"Sub Community\")\n+                          .build();\n+\n+        Collection col1 = CollectionBuilder.createCollection(context, child1)\n+                         .withName(\"Collection 1\")\n+                         .build();\n+\n+        WorkspaceItem witem = WorkspaceItemBuilder.createWorkspaceItem(context, col1)\n+                             .withIssueDate(\"2019-04-25\")\n+                             .withSubject(\"ExtraEntry\")\n+                             .build();\n+\n+        //disable file upload mandatory\n+        configurationService.setProperty(\"webui.submit.upload.required\", false);\n+\n+        context.restoreAuthSystemState();\n+\n+        String authToken = getAuthToken(eperson.getEmail(), password);\n+\n+        List<Operation> addTitle = new ArrayList<Operation>();\n+        List<Map<String, String>> values = new ArrayList<Map<String, String>>();\n+        Map<String, String> value = new HashMap<String, String>();\n+        value.put(\"value\", \"New Title\");\n+        values.add(value);\n+        addTitle.add(new AddOperation(\"/sections/not-existing-section/dc.title\", values));\n+\n+        String patchBody = getPatchContent(addTitle);\n+        getClient(authToken).perform(patch(\"/api/submission/workspaceitems/\" + witem.getID())", "originalCommit": "a338526583e21d10058e5a75edda81f1c4681196", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "aa15d658178601ed121f527395edc7b22a9bda07", "chunk": "diff --git a/dspace-server-webapp/src/test/java/org/dspace/app/rest/WorkspaceItemRestRepositoryIT.java b/dspace-server-webapp/src/test/java/org/dspace/app/rest/WorkspaceItemRestRepositoryIT.java\nindex e18f06c1e..b17c76f2f 100644\n--- a/dspace-server-webapp/src/test/java/org/dspace/app/rest/WorkspaceItemRestRepositoryIT.java\n+++ b/dspace-server-webapp/src/test/java/org/dspace/app/rest/WorkspaceItemRestRepositoryIT.java\n\n@@ -3245,6 +3245,11 @@ public class WorkspaceItemRestRepositoryIT extends AbstractControllerIntegration\n                  .content(patchBody)\n                  .contentType(MediaType.APPLICATION_JSON_PATCH_JSON))\n                  .andExpect(status().isUnprocessableEntity());\n+\n+        getClient(authToken).perform(get(\"/api/submission/workspaceitems/\" + witem.getID()))\n+                 .andExpect(status().isOk())\n+                 .andExpect(jsonPath(\"$.sections.traditionalpageone['dc.title']\").doesNotExist());\n+\n     }\n \n     @Test\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjgzOTgwMA==", "url": "https://github.com/DSpace/DSpace/pull/2760#discussion_r436839800", "bodyText": "Can you also verify the dc.title is not created?", "author": "benbosman", "createdAt": "2020-06-08T16:32:52Z", "path": "dspace-server-webapp/src/test/java/org/dspace/app/rest/WorkspaceItemRestRepositoryIT.java", "diffHunk": "@@ -3196,4 +3205,513 @@ public void findByItemUuidUnAuthenticatedTest() throws Exception {\n                         .andExpect(status().isUnauthorized());\n     }\n \n+    @Test\n+    public void patchAddMetadataOnSectionNotExistentTest() throws Exception {\n+        context.turnOffAuthorisationSystem();\n+\n+        parentCommunity = CommunityBuilder.createCommunity(context)\n+                         .withName(\"Parent Community\")\n+                         .build();\n+\n+        Community child1 = CommunityBuilder.createSubCommunity(context, parentCommunity)\n+                          .withName(\"Sub Community\")\n+                          .build();\n+\n+        Collection col1 = CollectionBuilder.createCollection(context, child1)\n+                         .withName(\"Collection 1\")\n+                         .build();\n+\n+        WorkspaceItem witem = WorkspaceItemBuilder.createWorkspaceItem(context, col1)\n+                             .withIssueDate(\"2019-04-25\")\n+                             .withSubject(\"ExtraEntry\")\n+                             .build();\n+\n+        //disable file upload mandatory\n+        configurationService.setProperty(\"webui.submit.upload.required\", false);\n+\n+        context.restoreAuthSystemState();\n+\n+        String authToken = getAuthToken(eperson.getEmail(), password);\n+\n+        List<Operation> addTitle = new ArrayList<Operation>();\n+        List<Map<String, String>> values = new ArrayList<Map<String, String>>();\n+        Map<String, String> value = new HashMap<String, String>();\n+        value.put(\"value\", \"New Title\");\n+        values.add(value);\n+        addTitle.add(new AddOperation(\"/sections/not-existing-section/dc.title\", values));\n+\n+        String patchBody = getPatchContent(addTitle);\n+        getClient(authToken).perform(patch(\"/api/submission/workspaceitems/\" + witem.getID())\n+                 .content(patchBody)\n+                 .contentType(MediaType.APPLICATION_JSON_PATCH_JSON))\n+                 .andExpect(status().isUnprocessableEntity());\n+    }\n+\n+    @Test\n+    public void patchAddMetadataWrongAttributeTest() throws Exception {\n+        context.turnOffAuthorisationSystem();\n+\n+        parentCommunity = CommunityBuilder.createCommunity(context)\n+                         .withName(\"Parent Community\")\n+                         .build();\n+\n+        Community child1 = CommunityBuilder.createSubCommunity(context, parentCommunity)\n+                          .withName(\"Sub Community\")\n+                          .build();\n+\n+        Collection col1 = CollectionBuilder.createCollection(context, child1)\n+                         .withName(\"Collection 1\")\n+                         .build();\n+\n+        WorkspaceItem witem = WorkspaceItemBuilder.createWorkspaceItem(context, col1)\n+                             .withIssueDate(\"2019-04-25\")\n+                             .withSubject(\"ExtraEntry\")\n+                             .build();\n+\n+        //disable file upload mandatory\n+        configurationService.setProperty(\"webui.submit.upload.required\", false);\n+\n+        context.restoreAuthSystemState();\n+\n+        String authToken = getAuthToken(eperson.getEmail(), password);\n+\n+        List<Operation> addTitle = new ArrayList<Operation>();\n+        List<Map<String, String>> values = new ArrayList<Map<String, String>>();\n+        Map<String, String> value = new HashMap<String, String>();\n+        value.put(\"value\", \"New Title\");\n+        values.add(value);\n+        addTitle.add(new AddOperation(\"/sections/traditionalpageone/dc.not.existing\", values));\n+\n+        String patchBody = getPatchContent(addTitle);\n+        getClient(authToken).perform(patch(\"/api/submission/workspaceitems/\" + witem.getID())\n+                 .content(patchBody)\n+                 .contentType(MediaType.APPLICATION_JSON_PATCH_JSON))\n+                 .andExpect(status().isUnprocessableEntity());\n+    }\n+\n+    @Test\n+    // try to add Title on tradiotionalpagetwo, but attribute title is placed on tradiotionalpageone\n+    public void patchAddTitleOnSectionThatNotContainAttributeTitleTest() throws Exception {\n+        context.turnOffAuthorisationSystem();\n+\n+        parentCommunity = CommunityBuilder.createCommunity(context)\n+                         .withName(\"Parent Community\")\n+                         .build();\n+\n+        Community child1 = CommunityBuilder.createSubCommunity(context, parentCommunity)\n+                          .withName(\"Sub Community\")\n+                          .build();\n+\n+        Collection col1 = CollectionBuilder.createCollection(context, child1)\n+                         .withName(\"Collection 1\")\n+                         .build();\n+\n+        WorkspaceItem witem = WorkspaceItemBuilder.createWorkspaceItem(context, col1)\n+                             .withIssueDate(\"2019-11-21\")\n+                             .withSubject(\"ExtraEntry\")\n+                             .build();\n+\n+        //disable file upload mandatory\n+        configurationService.setProperty(\"webui.submit.upload.required\", false);\n+\n+        context.restoreAuthSystemState();\n+\n+        String authToken = getAuthToken(eperson.getEmail(), password);\n+\n+        List<Operation> addTitle = new ArrayList<Operation>();\n+        List<Map<String, String>> values = new ArrayList<Map<String, String>>();\n+        Map<String, String> value = new HashMap<String, String>();\n+        value.put(\"value\", \"New Title\");\n+        values.add(value);\n+        addTitle.add(new AddOperation(\"/sections/traditionalpagetwo/dc.title\", values));\n+\n+        String patchBody = getPatchContent(addTitle);\n+        getClient(authToken).perform(patch(\"/api/submission/workspaceitems/\" + witem.getID())", "originalCommit": "a338526583e21d10058e5a75edda81f1c4681196", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "aa15d658178601ed121f527395edc7b22a9bda07", "chunk": "diff --git a/dspace-server-webapp/src/test/java/org/dspace/app/rest/WorkspaceItemRestRepositoryIT.java b/dspace-server-webapp/src/test/java/org/dspace/app/rest/WorkspaceItemRestRepositoryIT.java\nindex e18f06c1e..b17c76f2f 100644\n--- a/dspace-server-webapp/src/test/java/org/dspace/app/rest/WorkspaceItemRestRepositoryIT.java\n+++ b/dspace-server-webapp/src/test/java/org/dspace/app/rest/WorkspaceItemRestRepositoryIT.java\n\n@@ -3245,6 +3245,11 @@ public class WorkspaceItemRestRepositoryIT extends AbstractControllerIntegration\n                  .content(patchBody)\n                  .contentType(MediaType.APPLICATION_JSON_PATCH_JSON))\n                  .andExpect(status().isUnprocessableEntity());\n+\n+        getClient(authToken).perform(get(\"/api/submission/workspaceitems/\" + witem.getID()))\n+                 .andExpect(status().isOk())\n+                 .andExpect(jsonPath(\"$.sections.traditionalpageone['dc.title']\").doesNotExist());\n+\n     }\n \n     @Test\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg0MTg0Mg==", "url": "https://github.com/DSpace/DSpace/pull/2760#discussion_r436841842", "bodyText": "is this just a metadata field not configured for this bitstream?", "author": "benbosman", "createdAt": "2020-06-08T16:36:15Z", "path": "dspace-server-webapp/src/test/java/org/dspace/app/rest/WorkspaceItemRestRepositoryIT.java", "diffHunk": "@@ -3196,4 +3205,513 @@ public void findByItemUuidUnAuthenticatedTest() throws Exception {\n                         .andExpect(status().isUnauthorized());\n     }\n \n+    @Test\n+    public void patchAddMetadataOnSectionNotExistentTest() throws Exception {\n+        context.turnOffAuthorisationSystem();\n+\n+        parentCommunity = CommunityBuilder.createCommunity(context)\n+                         .withName(\"Parent Community\")\n+                         .build();\n+\n+        Community child1 = CommunityBuilder.createSubCommunity(context, parentCommunity)\n+                          .withName(\"Sub Community\")\n+                          .build();\n+\n+        Collection col1 = CollectionBuilder.createCollection(context, child1)\n+                         .withName(\"Collection 1\")\n+                         .build();\n+\n+        WorkspaceItem witem = WorkspaceItemBuilder.createWorkspaceItem(context, col1)\n+                             .withIssueDate(\"2019-04-25\")\n+                             .withSubject(\"ExtraEntry\")\n+                             .build();\n+\n+        //disable file upload mandatory\n+        configurationService.setProperty(\"webui.submit.upload.required\", false);\n+\n+        context.restoreAuthSystemState();\n+\n+        String authToken = getAuthToken(eperson.getEmail(), password);\n+\n+        List<Operation> addTitle = new ArrayList<Operation>();\n+        List<Map<String, String>> values = new ArrayList<Map<String, String>>();\n+        Map<String, String> value = new HashMap<String, String>();\n+        value.put(\"value\", \"New Title\");\n+        values.add(value);\n+        addTitle.add(new AddOperation(\"/sections/not-existing-section/dc.title\", values));\n+\n+        String patchBody = getPatchContent(addTitle);\n+        getClient(authToken).perform(patch(\"/api/submission/workspaceitems/\" + witem.getID())\n+                 .content(patchBody)\n+                 .contentType(MediaType.APPLICATION_JSON_PATCH_JSON))\n+                 .andExpect(status().isUnprocessableEntity());\n+    }\n+\n+    @Test\n+    public void patchAddMetadataWrongAttributeTest() throws Exception {\n+        context.turnOffAuthorisationSystem();\n+\n+        parentCommunity = CommunityBuilder.createCommunity(context)\n+                         .withName(\"Parent Community\")\n+                         .build();\n+\n+        Community child1 = CommunityBuilder.createSubCommunity(context, parentCommunity)\n+                          .withName(\"Sub Community\")\n+                          .build();\n+\n+        Collection col1 = CollectionBuilder.createCollection(context, child1)\n+                         .withName(\"Collection 1\")\n+                         .build();\n+\n+        WorkspaceItem witem = WorkspaceItemBuilder.createWorkspaceItem(context, col1)\n+                             .withIssueDate(\"2019-04-25\")\n+                             .withSubject(\"ExtraEntry\")\n+                             .build();\n+\n+        //disable file upload mandatory\n+        configurationService.setProperty(\"webui.submit.upload.required\", false);\n+\n+        context.restoreAuthSystemState();\n+\n+        String authToken = getAuthToken(eperson.getEmail(), password);\n+\n+        List<Operation> addTitle = new ArrayList<Operation>();\n+        List<Map<String, String>> values = new ArrayList<Map<String, String>>();\n+        Map<String, String> value = new HashMap<String, String>();\n+        value.put(\"value\", \"New Title\");\n+        values.add(value);\n+        addTitle.add(new AddOperation(\"/sections/traditionalpageone/dc.not.existing\", values));\n+\n+        String patchBody = getPatchContent(addTitle);\n+        getClient(authToken).perform(patch(\"/api/submission/workspaceitems/\" + witem.getID())\n+                 .content(patchBody)\n+                 .contentType(MediaType.APPLICATION_JSON_PATCH_JSON))\n+                 .andExpect(status().isUnprocessableEntity());\n+    }\n+\n+    @Test\n+    // try to add Title on tradiotionalpagetwo, but attribute title is placed on tradiotionalpageone\n+    public void patchAddTitleOnSectionThatNotContainAttributeTitleTest() throws Exception {\n+        context.turnOffAuthorisationSystem();\n+\n+        parentCommunity = CommunityBuilder.createCommunity(context)\n+                         .withName(\"Parent Community\")\n+                         .build();\n+\n+        Community child1 = CommunityBuilder.createSubCommunity(context, parentCommunity)\n+                          .withName(\"Sub Community\")\n+                          .build();\n+\n+        Collection col1 = CollectionBuilder.createCollection(context, child1)\n+                         .withName(\"Collection 1\")\n+                         .build();\n+\n+        WorkspaceItem witem = WorkspaceItemBuilder.createWorkspaceItem(context, col1)\n+                             .withIssueDate(\"2019-11-21\")\n+                             .withSubject(\"ExtraEntry\")\n+                             .build();\n+\n+        //disable file upload mandatory\n+        configurationService.setProperty(\"webui.submit.upload.required\", false);\n+\n+        context.restoreAuthSystemState();\n+\n+        String authToken = getAuthToken(eperson.getEmail(), password);\n+\n+        List<Operation> addTitle = new ArrayList<Operation>();\n+        List<Map<String, String>> values = new ArrayList<Map<String, String>>();\n+        Map<String, String> value = new HashMap<String, String>();\n+        value.put(\"value\", \"New Title\");\n+        values.add(value);\n+        addTitle.add(new AddOperation(\"/sections/traditionalpagetwo/dc.title\", values));\n+\n+        String patchBody = getPatchContent(addTitle);\n+        getClient(authToken).perform(patch(\"/api/submission/workspaceitems/\" + witem.getID())\n+                 .content(patchBody)\n+                 .contentType(MediaType.APPLICATION_JSON_PATCH_JSON))\n+                 .andExpect(status().isUnprocessableEntity());\n+    }\n+\n+    @Test\n+    public void patchAcceptLicenseWrontPathTest() throws Exception {\n+        context.turnOffAuthorisationSystem();\n+\n+        parentCommunity = CommunityBuilder.createCommunity(context)\n+                         .withName(\"Parent Community\")\n+                         .build();\n+\n+        Community child1 = CommunityBuilder.createSubCommunity(context, parentCommunity)\n+                          .withName(\"Sub Community\")\n+                          .build();\n+\n+        Collection col1 = CollectionBuilder.createCollection(context, child1)\n+                         .withName(\"Collection 1\")\n+                         .build();\n+\n+        WorkspaceItem witem = WorkspaceItemBuilder.createWorkspaceItem(context, col1)\n+                             .withTitle(\"Example Title\")\n+                             .withIssueDate(\"2019-11-21\")\n+                             .withSubject(\"ExtraEntry\")\n+                             .build();\n+\n+        //disable file upload mandatory\n+        configurationService.setProperty(\"webui.submit.upload.required\", false);\n+\n+        context.restoreAuthSystemState();\n+\n+        String authToken = getAuthToken(eperson.getEmail(), password);\n+\n+        List<Operation> replaceGrant = new ArrayList<Operation>();\n+        replaceGrant.add(new ReplaceOperation(\"/sections/license/not-existing\", true));\n+\n+        String patchBody = getPatchContent(replaceGrant);\n+        getClient(authToken).perform(patch(\"/api/submission/workspaceitems/\" + witem.getID())\n+                 .content(patchBody)\n+                 .contentType(MediaType.APPLICATION_JSON_PATCH_JSON))\n+                 .andExpect(status().isUnprocessableEntity());\n+    }\n+\n+    @Test\n+    public void patchAcceptLicenseTryToChangeLicenseUrlTest() throws Exception {\n+        context.turnOffAuthorisationSystem();\n+\n+        parentCommunity = CommunityBuilder.createCommunity(context)\n+                         .withName(\"Parent Community\")\n+                         .build();\n+\n+        Community child1 = CommunityBuilder.createSubCommunity(context, parentCommunity)\n+                          .withName(\"Sub Community\")\n+                          .build();\n+\n+        Collection col1 = CollectionBuilder.createCollection(context, child1)\n+                         .withName(\"Collection 1\")\n+                         .build();\n+\n+        WorkspaceItem witem = WorkspaceItemBuilder.createWorkspaceItem(context, col1)\n+                             .withTitle(\"Example Title\")\n+                             .withIssueDate(\"2019-11-21\")\n+                             .withSubject(\"ExtraEntry\")\n+                             .build();\n+\n+        //disable file upload mandatory\n+        configurationService.setProperty(\"webui.submit.upload.required\", false);\n+\n+        context.restoreAuthSystemState();\n+\n+        String authToken = getAuthToken(eperson.getEmail(), password);\n+\n+        List<Operation> replaceGrant = new ArrayList<Operation>();\n+        replaceGrant.add(new ReplaceOperation(\"/sections/license/granted\", true));\n+\n+        String patchBody = getPatchContent(replaceGrant);\n+        getClient(authToken).perform(patch(\"/api/submission/workspaceitems/\" + witem.getID())\n+                 .content(patchBody)\n+                 .contentType(MediaType.APPLICATION_JSON_PATCH_JSON))\n+                 .andExpect(status().isOk());\n+\n+        List<Operation> replaceLicenseUrl = new ArrayList<Operation>();\n+        replaceLicenseUrl.add(new ReplaceOperation(\"/sections/license/url\", \"not.existing\"));\n+\n+        patchBody = getPatchContent(replaceLicenseUrl);\n+        getClient(authToken).perform(patch(\"/api/submission/workspaceitems/\" + witem.getID())\n+                 .content(patchBody)\n+                 .contentType(MediaType.APPLICATION_JSON_PATCH_JSON))\n+                 .andExpect(status().isUnprocessableEntity());\n+    }\n+\n+    @Test\n+    public void patchAcceptLicenseTryToChangeDateAccepteLicenseTest() throws Exception {\n+        context.turnOffAuthorisationSystem();\n+\n+        parentCommunity = CommunityBuilder.createCommunity(context)\n+                         .withName(\"Parent Community\")\n+                         .build();\n+\n+        Community child1 = CommunityBuilder.createSubCommunity(context, parentCommunity)\n+                          .withName(\"Sub Community\")\n+                          .build();\n+\n+        Collection col1 = CollectionBuilder.createCollection(context, child1)\n+                         .withName(\"Collection 1\")\n+                         .build();\n+\n+        WorkspaceItem witem = WorkspaceItemBuilder.createWorkspaceItem(context, col1)\n+                             .withTitle(\"Example Title\")\n+                             .withIssueDate(\"2019-11-21\")\n+                             .withSubject(\"ExtraEntry\")\n+                             .build();\n+\n+        //disable file upload mandatory\n+        configurationService.setProperty(\"webui.submit.upload.required\", false);\n+\n+        context.restoreAuthSystemState();\n+\n+        String authToken = getAuthToken(eperson.getEmail(), password);\n+\n+        List<Operation> replaceGrant = new ArrayList<Operation>();\n+        replaceGrant.add(new ReplaceOperation(\"/sections/license/granted\", true));\n+\n+        String patchBody = getPatchContent(replaceGrant);\n+        getClient(authToken).perform(patch(\"/api/submission/workspaceitems/\" + witem.getID())\n+                 .content(patchBody)\n+                 .contentType(MediaType.APPLICATION_JSON_PATCH_JSON))\n+                 .andExpect(status().isOk());\n+\n+        List<Operation> replaceLicenseUrl = new ArrayList<Operation>();\n+        replaceLicenseUrl.add(new ReplaceOperation(\"/sections/license/acceptanceDate\", \"2020-02-14\"));\n+\n+        patchBody = getPatchContent(replaceLicenseUrl);\n+        getClient(authToken).perform(patch(\"/api/submission/workspaceitems/\" + witem.getID())\n+                 .content(patchBody)\n+                 .contentType(MediaType.APPLICATION_JSON_PATCH_JSON))\n+                 .andExpect(status().isUnprocessableEntity());\n+    }\n+\n+    @Test\n+    public void patchUploadMetadatoNotExistTest() throws Exception {\n+        context.turnOffAuthorisationSystem();\n+\n+        parentCommunity = CommunityBuilder.createCommunity(context)\n+                                          .withName(\"Parent Community\")\n+                                          .build();\n+        Community child1 = CommunityBuilder.createSubCommunity(context, parentCommunity)\n+                                           .withName(\"Sub Community\")\n+                                           .build();\n+        Collection col1 = CollectionBuilder.createCollection(context, child1)\n+                                           .withName(\"Collection 1\")\n+                                           .build();\n+\n+        InputStream pdf = getClass().getResourceAsStream(\"simple-article.pdf\");\n+\n+        WorkspaceItem witem = WorkspaceItemBuilder.createWorkspaceItem(context, col1)\n+                 .withTitle(\"Test WorkspaceItem\")\n+                 .withIssueDate(\"2019-10-25\")\n+                 .withFulltext(\"simple-article.pdf\", \"/local/path/simple-article.pdf\", pdf)\n+                 .build();\n+\n+        context.restoreAuthSystemState();\n+\n+        String authToken = getAuthToken(eperson.getEmail(), password);\n+\n+        List<Operation> addOpts = new ArrayList<Operation>();\n+        Map<String, String> value = new HashMap<String, String>();\n+        value.put(\"value\", \"some text\");\n+        addOpts.add(new AddOperation(\"/sections/upload/files/0/metadata/dc.not.existing\", value));\n+\n+        String patchBody = getPatchContent(addOpts);\n+        getClient(authToken).perform(patch(\"/api/submission/workspaceitems/\" + witem.getID())\n+                            .content(patchBody)\n+                            .contentType(MediaType.APPLICATION_JSON_PATCH_JSON))\n+                            .andExpect(status().isUnprocessableEntity());\n+    }\n+\n+    @Test\n+    public void patchUploadWrongPathTest() throws Exception {", "originalCommit": "a338526583e21d10058e5a75edda81f1c4681196", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "aa15d658178601ed121f527395edc7b22a9bda07", "chunk": "diff --git a/dspace-server-webapp/src/test/java/org/dspace/app/rest/WorkspaceItemRestRepositoryIT.java b/dspace-server-webapp/src/test/java/org/dspace/app/rest/WorkspaceItemRestRepositoryIT.java\nindex e18f06c1e..b17c76f2f 100644\n--- a/dspace-server-webapp/src/test/java/org/dspace/app/rest/WorkspaceItemRestRepositoryIT.java\n+++ b/dspace-server-webapp/src/test/java/org/dspace/app/rest/WorkspaceItemRestRepositoryIT.java\n\n@@ -3245,6 +3245,11 @@ public class WorkspaceItemRestRepositoryIT extends AbstractControllerIntegration\n                  .content(patchBody)\n                  .contentType(MediaType.APPLICATION_JSON_PATCH_JSON))\n                  .andExpect(status().isUnprocessableEntity());\n+\n+        getClient(authToken).perform(get(\"/api/submission/workspaceitems/\" + witem.getID()))\n+                 .andExpect(status().isOk())\n+                 .andExpect(jsonPath(\"$.sections.traditionalpageone['dc.title']\").doesNotExist());\n+\n     }\n \n     @Test\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg0MTk5Ng==", "url": "https://github.com/DSpace/DSpace/pull/2760#discussion_r436841996", "bodyText": "Can you also verify the dc.date.issued is not created?", "author": "benbosman", "createdAt": "2020-06-08T16:36:30Z", "path": "dspace-server-webapp/src/test/java/org/dspace/app/rest/WorkspaceItemRestRepositoryIT.java", "diffHunk": "@@ -3196,4 +3205,513 @@ public void findByItemUuidUnAuthenticatedTest() throws Exception {\n                         .andExpect(status().isUnauthorized());\n     }\n \n+    @Test\n+    public void patchAddMetadataOnSectionNotExistentTest() throws Exception {\n+        context.turnOffAuthorisationSystem();\n+\n+        parentCommunity = CommunityBuilder.createCommunity(context)\n+                         .withName(\"Parent Community\")\n+                         .build();\n+\n+        Community child1 = CommunityBuilder.createSubCommunity(context, parentCommunity)\n+                          .withName(\"Sub Community\")\n+                          .build();\n+\n+        Collection col1 = CollectionBuilder.createCollection(context, child1)\n+                         .withName(\"Collection 1\")\n+                         .build();\n+\n+        WorkspaceItem witem = WorkspaceItemBuilder.createWorkspaceItem(context, col1)\n+                             .withIssueDate(\"2019-04-25\")\n+                             .withSubject(\"ExtraEntry\")\n+                             .build();\n+\n+        //disable file upload mandatory\n+        configurationService.setProperty(\"webui.submit.upload.required\", false);\n+\n+        context.restoreAuthSystemState();\n+\n+        String authToken = getAuthToken(eperson.getEmail(), password);\n+\n+        List<Operation> addTitle = new ArrayList<Operation>();\n+        List<Map<String, String>> values = new ArrayList<Map<String, String>>();\n+        Map<String, String> value = new HashMap<String, String>();\n+        value.put(\"value\", \"New Title\");\n+        values.add(value);\n+        addTitle.add(new AddOperation(\"/sections/not-existing-section/dc.title\", values));\n+\n+        String patchBody = getPatchContent(addTitle);\n+        getClient(authToken).perform(patch(\"/api/submission/workspaceitems/\" + witem.getID())\n+                 .content(patchBody)\n+                 .contentType(MediaType.APPLICATION_JSON_PATCH_JSON))\n+                 .andExpect(status().isUnprocessableEntity());\n+    }\n+\n+    @Test\n+    public void patchAddMetadataWrongAttributeTest() throws Exception {\n+        context.turnOffAuthorisationSystem();\n+\n+        parentCommunity = CommunityBuilder.createCommunity(context)\n+                         .withName(\"Parent Community\")\n+                         .build();\n+\n+        Community child1 = CommunityBuilder.createSubCommunity(context, parentCommunity)\n+                          .withName(\"Sub Community\")\n+                          .build();\n+\n+        Collection col1 = CollectionBuilder.createCollection(context, child1)\n+                         .withName(\"Collection 1\")\n+                         .build();\n+\n+        WorkspaceItem witem = WorkspaceItemBuilder.createWorkspaceItem(context, col1)\n+                             .withIssueDate(\"2019-04-25\")\n+                             .withSubject(\"ExtraEntry\")\n+                             .build();\n+\n+        //disable file upload mandatory\n+        configurationService.setProperty(\"webui.submit.upload.required\", false);\n+\n+        context.restoreAuthSystemState();\n+\n+        String authToken = getAuthToken(eperson.getEmail(), password);\n+\n+        List<Operation> addTitle = new ArrayList<Operation>();\n+        List<Map<String, String>> values = new ArrayList<Map<String, String>>();\n+        Map<String, String> value = new HashMap<String, String>();\n+        value.put(\"value\", \"New Title\");\n+        values.add(value);\n+        addTitle.add(new AddOperation(\"/sections/traditionalpageone/dc.not.existing\", values));\n+\n+        String patchBody = getPatchContent(addTitle);\n+        getClient(authToken).perform(patch(\"/api/submission/workspaceitems/\" + witem.getID())\n+                 .content(patchBody)\n+                 .contentType(MediaType.APPLICATION_JSON_PATCH_JSON))\n+                 .andExpect(status().isUnprocessableEntity());\n+    }\n+\n+    @Test\n+    // try to add Title on tradiotionalpagetwo, but attribute title is placed on tradiotionalpageone\n+    public void patchAddTitleOnSectionThatNotContainAttributeTitleTest() throws Exception {\n+        context.turnOffAuthorisationSystem();\n+\n+        parentCommunity = CommunityBuilder.createCommunity(context)\n+                         .withName(\"Parent Community\")\n+                         .build();\n+\n+        Community child1 = CommunityBuilder.createSubCommunity(context, parentCommunity)\n+                          .withName(\"Sub Community\")\n+                          .build();\n+\n+        Collection col1 = CollectionBuilder.createCollection(context, child1)\n+                         .withName(\"Collection 1\")\n+                         .build();\n+\n+        WorkspaceItem witem = WorkspaceItemBuilder.createWorkspaceItem(context, col1)\n+                             .withIssueDate(\"2019-11-21\")\n+                             .withSubject(\"ExtraEntry\")\n+                             .build();\n+\n+        //disable file upload mandatory\n+        configurationService.setProperty(\"webui.submit.upload.required\", false);\n+\n+        context.restoreAuthSystemState();\n+\n+        String authToken = getAuthToken(eperson.getEmail(), password);\n+\n+        List<Operation> addTitle = new ArrayList<Operation>();\n+        List<Map<String, String>> values = new ArrayList<Map<String, String>>();\n+        Map<String, String> value = new HashMap<String, String>();\n+        value.put(\"value\", \"New Title\");\n+        values.add(value);\n+        addTitle.add(new AddOperation(\"/sections/traditionalpagetwo/dc.title\", values));\n+\n+        String patchBody = getPatchContent(addTitle);\n+        getClient(authToken).perform(patch(\"/api/submission/workspaceitems/\" + witem.getID())\n+                 .content(patchBody)\n+                 .contentType(MediaType.APPLICATION_JSON_PATCH_JSON))\n+                 .andExpect(status().isUnprocessableEntity());\n+    }\n+\n+    @Test\n+    public void patchAcceptLicenseWrontPathTest() throws Exception {\n+        context.turnOffAuthorisationSystem();\n+\n+        parentCommunity = CommunityBuilder.createCommunity(context)\n+                         .withName(\"Parent Community\")\n+                         .build();\n+\n+        Community child1 = CommunityBuilder.createSubCommunity(context, parentCommunity)\n+                          .withName(\"Sub Community\")\n+                          .build();\n+\n+        Collection col1 = CollectionBuilder.createCollection(context, child1)\n+                         .withName(\"Collection 1\")\n+                         .build();\n+\n+        WorkspaceItem witem = WorkspaceItemBuilder.createWorkspaceItem(context, col1)\n+                             .withTitle(\"Example Title\")\n+                             .withIssueDate(\"2019-11-21\")\n+                             .withSubject(\"ExtraEntry\")\n+                             .build();\n+\n+        //disable file upload mandatory\n+        configurationService.setProperty(\"webui.submit.upload.required\", false);\n+\n+        context.restoreAuthSystemState();\n+\n+        String authToken = getAuthToken(eperson.getEmail(), password);\n+\n+        List<Operation> replaceGrant = new ArrayList<Operation>();\n+        replaceGrant.add(new ReplaceOperation(\"/sections/license/not-existing\", true));\n+\n+        String patchBody = getPatchContent(replaceGrant);\n+        getClient(authToken).perform(patch(\"/api/submission/workspaceitems/\" + witem.getID())\n+                 .content(patchBody)\n+                 .contentType(MediaType.APPLICATION_JSON_PATCH_JSON))\n+                 .andExpect(status().isUnprocessableEntity());\n+    }\n+\n+    @Test\n+    public void patchAcceptLicenseTryToChangeLicenseUrlTest() throws Exception {\n+        context.turnOffAuthorisationSystem();\n+\n+        parentCommunity = CommunityBuilder.createCommunity(context)\n+                         .withName(\"Parent Community\")\n+                         .build();\n+\n+        Community child1 = CommunityBuilder.createSubCommunity(context, parentCommunity)\n+                          .withName(\"Sub Community\")\n+                          .build();\n+\n+        Collection col1 = CollectionBuilder.createCollection(context, child1)\n+                         .withName(\"Collection 1\")\n+                         .build();\n+\n+        WorkspaceItem witem = WorkspaceItemBuilder.createWorkspaceItem(context, col1)\n+                             .withTitle(\"Example Title\")\n+                             .withIssueDate(\"2019-11-21\")\n+                             .withSubject(\"ExtraEntry\")\n+                             .build();\n+\n+        //disable file upload mandatory\n+        configurationService.setProperty(\"webui.submit.upload.required\", false);\n+\n+        context.restoreAuthSystemState();\n+\n+        String authToken = getAuthToken(eperson.getEmail(), password);\n+\n+        List<Operation> replaceGrant = new ArrayList<Operation>();\n+        replaceGrant.add(new ReplaceOperation(\"/sections/license/granted\", true));\n+\n+        String patchBody = getPatchContent(replaceGrant);\n+        getClient(authToken).perform(patch(\"/api/submission/workspaceitems/\" + witem.getID())\n+                 .content(patchBody)\n+                 .contentType(MediaType.APPLICATION_JSON_PATCH_JSON))\n+                 .andExpect(status().isOk());\n+\n+        List<Operation> replaceLicenseUrl = new ArrayList<Operation>();\n+        replaceLicenseUrl.add(new ReplaceOperation(\"/sections/license/url\", \"not.existing\"));\n+\n+        patchBody = getPatchContent(replaceLicenseUrl);\n+        getClient(authToken).perform(patch(\"/api/submission/workspaceitems/\" + witem.getID())\n+                 .content(patchBody)\n+                 .contentType(MediaType.APPLICATION_JSON_PATCH_JSON))\n+                 .andExpect(status().isUnprocessableEntity());\n+    }\n+\n+    @Test\n+    public void patchAcceptLicenseTryToChangeDateAccepteLicenseTest() throws Exception {\n+        context.turnOffAuthorisationSystem();\n+\n+        parentCommunity = CommunityBuilder.createCommunity(context)\n+                         .withName(\"Parent Community\")\n+                         .build();\n+\n+        Community child1 = CommunityBuilder.createSubCommunity(context, parentCommunity)\n+                          .withName(\"Sub Community\")\n+                          .build();\n+\n+        Collection col1 = CollectionBuilder.createCollection(context, child1)\n+                         .withName(\"Collection 1\")\n+                         .build();\n+\n+        WorkspaceItem witem = WorkspaceItemBuilder.createWorkspaceItem(context, col1)\n+                             .withTitle(\"Example Title\")\n+                             .withIssueDate(\"2019-11-21\")\n+                             .withSubject(\"ExtraEntry\")\n+                             .build();\n+\n+        //disable file upload mandatory\n+        configurationService.setProperty(\"webui.submit.upload.required\", false);\n+\n+        context.restoreAuthSystemState();\n+\n+        String authToken = getAuthToken(eperson.getEmail(), password);\n+\n+        List<Operation> replaceGrant = new ArrayList<Operation>();\n+        replaceGrant.add(new ReplaceOperation(\"/sections/license/granted\", true));\n+\n+        String patchBody = getPatchContent(replaceGrant);\n+        getClient(authToken).perform(patch(\"/api/submission/workspaceitems/\" + witem.getID())\n+                 .content(patchBody)\n+                 .contentType(MediaType.APPLICATION_JSON_PATCH_JSON))\n+                 .andExpect(status().isOk());\n+\n+        List<Operation> replaceLicenseUrl = new ArrayList<Operation>();\n+        replaceLicenseUrl.add(new ReplaceOperation(\"/sections/license/acceptanceDate\", \"2020-02-14\"));\n+\n+        patchBody = getPatchContent(replaceLicenseUrl);\n+        getClient(authToken).perform(patch(\"/api/submission/workspaceitems/\" + witem.getID())\n+                 .content(patchBody)\n+                 .contentType(MediaType.APPLICATION_JSON_PATCH_JSON))\n+                 .andExpect(status().isUnprocessableEntity());\n+    }\n+\n+    @Test\n+    public void patchUploadMetadatoNotExistTest() throws Exception {\n+        context.turnOffAuthorisationSystem();\n+\n+        parentCommunity = CommunityBuilder.createCommunity(context)\n+                                          .withName(\"Parent Community\")\n+                                          .build();\n+        Community child1 = CommunityBuilder.createSubCommunity(context, parentCommunity)\n+                                           .withName(\"Sub Community\")\n+                                           .build();\n+        Collection col1 = CollectionBuilder.createCollection(context, child1)\n+                                           .withName(\"Collection 1\")\n+                                           .build();\n+\n+        InputStream pdf = getClass().getResourceAsStream(\"simple-article.pdf\");\n+\n+        WorkspaceItem witem = WorkspaceItemBuilder.createWorkspaceItem(context, col1)\n+                 .withTitle(\"Test WorkspaceItem\")\n+                 .withIssueDate(\"2019-10-25\")\n+                 .withFulltext(\"simple-article.pdf\", \"/local/path/simple-article.pdf\", pdf)\n+                 .build();\n+\n+        context.restoreAuthSystemState();\n+\n+        String authToken = getAuthToken(eperson.getEmail(), password);\n+\n+        List<Operation> addOpts = new ArrayList<Operation>();\n+        Map<String, String> value = new HashMap<String, String>();\n+        value.put(\"value\", \"some text\");\n+        addOpts.add(new AddOperation(\"/sections/upload/files/0/metadata/dc.not.existing\", value));\n+\n+        String patchBody = getPatchContent(addOpts);\n+        getClient(authToken).perform(patch(\"/api/submission/workspaceitems/\" + witem.getID())\n+                            .content(patchBody)\n+                            .contentType(MediaType.APPLICATION_JSON_PATCH_JSON))\n+                            .andExpect(status().isUnprocessableEntity());\n+    }\n+\n+    @Test\n+    public void patchUploadWrongPathTest() throws Exception {\n+        context.turnOffAuthorisationSystem();\n+\n+        parentCommunity = CommunityBuilder.createCommunity(context)\n+                                          .withName(\"Parent Community\")\n+                                          .build();\n+        Community child1 = CommunityBuilder.createSubCommunity(context, parentCommunity)\n+                                           .withName(\"Sub Community\")\n+                                           .build();\n+        Collection col1 = CollectionBuilder.createCollection(context, child1)\n+                                           .withName(\"Collection 1\")\n+                                           .build();\n+\n+        InputStream pdf = getClass().getResourceAsStream(\"simple-article.pdf\");\n+\n+        WorkspaceItem witem = WorkspaceItemBuilder.createWorkspaceItem(context, col1)\n+                .withTitle(\"Test WorkspaceItem\")\n+                .withIssueDate(\"2017-10-17\")\n+                .withFulltext(\"simple-article.pdf\", \"/local/path/simple-article.pdf\", pdf)\n+                .build();\n+\n+        context.restoreAuthSystemState();\n+\n+        String authToken = getAuthToken(eperson.getEmail(), password);\n+\n+        List<Operation> addOpts = new ArrayList<Operation>();\n+        Map<String, String> value = new HashMap<String, String>();\n+        value.put(\"value\", \"2020-01-25\");\n+        addOpts.add(new AddOperation(\"/sections/upload/files/0/metadata/dc.date.issued\", value));\n+\n+        String patchBody = getPatchContent(addOpts);\n+        getClient(authToken).perform(patch(\"/api/submission/workspaceitems/\" + witem.getID())", "originalCommit": "a338526583e21d10058e5a75edda81f1c4681196", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "aa15d658178601ed121f527395edc7b22a9bda07", "chunk": "diff --git a/dspace-server-webapp/src/test/java/org/dspace/app/rest/WorkspaceItemRestRepositoryIT.java b/dspace-server-webapp/src/test/java/org/dspace/app/rest/WorkspaceItemRestRepositoryIT.java\nindex e18f06c1e..b17c76f2f 100644\n--- a/dspace-server-webapp/src/test/java/org/dspace/app/rest/WorkspaceItemRestRepositoryIT.java\n+++ b/dspace-server-webapp/src/test/java/org/dspace/app/rest/WorkspaceItemRestRepositoryIT.java\n\n@@ -3245,6 +3245,11 @@ public class WorkspaceItemRestRepositoryIT extends AbstractControllerIntegration\n                  .content(patchBody)\n                  .contentType(MediaType.APPLICATION_JSON_PATCH_JSON))\n                  .andExpect(status().isUnprocessableEntity());\n+\n+        getClient(authToken).perform(get(\"/api/submission/workspaceitems/\" + witem.getID()))\n+                 .andExpect(status().isOk())\n+                 .andExpect(jsonPath(\"$.sections.traditionalpageone['dc.title']\").doesNotExist());\n+\n     }\n \n     @Test\n"}}, {"oid": "aa15d658178601ed121f527395edc7b22a9bda07", "url": "https://github.com/DSpace/DSpace/commit/aa15d658178601ed121f527395edc7b22a9bda07", "message": "Implement community feedbacks", "committedDate": "2020-06-11T08:47:37Z", "type": "commit"}, {"oid": "4ff01ae963a4bb765b3464600c005b4aa51d15c0", "url": "https://github.com/DSpace/DSpace/commit/4ff01ae963a4bb765b3464600c005b4aa51d15c0", "message": "added test", "committedDate": "2020-06-11T23:07:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjIwMTg2Ng==", "url": "https://github.com/DSpace/DSpace/pull/2760#discussion_r442201866", "bodyText": "When trying to test this PR, I got spring issues with this auto-wiring", "author": "benbosman", "createdAt": "2020-06-18T12:51:45Z", "path": "dspace-server-webapp/src/main/java/org/dspace/app/rest/submit/factory/impl/BitstreamMetadataValueMovePatchOperation.java", "diffHunk": "@@ -35,12 +36,17 @@\n     @Autowired\n     ItemService itemService;\n \n+    @Autowired\n+    BitstreamMetadataValuePathUtils bitstreamMetadataValuePathUtils;", "originalCommit": "4ff01ae963a4bb765b3464600c005b4aa51d15c0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY5MDc0MA==", "url": "https://github.com/DSpace/DSpace/pull/2760#discussion_r443690740", "bodyText": "This still seems to be occurring in my local installation:\n***************************\nAPPLICATION FAILED TO START\n***************************\n\nDescription:\n\nField bitstreamMetadataValuePathUtils in org.dspace.app.rest.submit.factory.impl.BitstreamMetadataValueMovePatchOperation required a single bean, but 2 were found:\n        - org.dspace.app.rest.utils.BitstreamMetadataValuePathUtils#0: a programmatically registered singleton  - org.dspace.app.rest.utils.BitstreamMetadataValuePathUtils#1: a programmatically registered singleton\n\nAction:\n\nConsider marking one of the beans as @Primary, updating the consumer to accept multiple beans, or using @Qualifier to identify the bean that should be consumed", "author": "benbosman", "createdAt": "2020-06-22T16:41:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjIwMTg2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzczMzQwNQ==", "url": "https://github.com/DSpace/DSpace/pull/2760#discussion_r443733405", "bodyText": "I think @benbosman may be hitting a problem here in how we are loading this bean.  See this comment that I just added inline.\nAlso, I'm able to reproduce the same error that Ben notes when I try to run this PR in Docker.", "author": "tdonohue", "createdAt": "2020-06-22T17:59:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjIwMTg2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTc1MjA0Nw==", "url": "https://github.com/DSpace/DSpace/pull/2760#discussion_r445752047", "bodyText": "This bug was resolved by the most recent changes \ud83c\udf89", "author": "tdonohue", "createdAt": "2020-06-25T18:22:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjIwMTg2Ng=="}], "type": "inlineReview", "revised_code": {"commit": "1e49e5877e53dce056ec1b4022a5e026dc70f6a1", "chunk": "diff --git a/dspace-server-webapp/src/main/java/org/dspace/app/rest/submit/factory/impl/BitstreamMetadataValueMovePatchOperation.java b/dspace-server-webapp/src/main/java/org/dspace/app/rest/submit/factory/impl/BitstreamMetadataValueMovePatchOperation.java\nindex d03d47c91..f0e764f97 100644\n--- a/dspace-server-webapp/src/main/java/org/dspace/app/rest/submit/factory/impl/BitstreamMetadataValueMovePatchOperation.java\n+++ b/dspace-server-webapp/src/main/java/org/dspace/app/rest/submit/factory/impl/BitstreamMetadataValueMovePatchOperation.java\n\n@@ -36,7 +36,7 @@ public class BitstreamMetadataValueMovePatchOperation extends MetadataValueMoveP\n     @Autowired\n     ItemService itemService;\n \n-    @Autowired\n+    // this is wired in the pring-dspace-core-services.xml\n     BitstreamMetadataValuePathUtils bitstreamMetadataValuePathUtils;\n \n     @Override\n"}}, {"oid": "1e49e5877e53dce056ec1b4022a5e026dc70f6a1", "url": "https://github.com/DSpace/DSpace/commit/1e49e5877e53dce056ec1b4022a5e026dc70f6a1", "message": "Fix injection to avoid issue with docker/double references", "committedDate": "2020-06-25T10:33:37Z", "type": "commit"}, {"oid": "06f9eb521c98fad98c5c7a6e1f4d31226e6c49e4", "url": "https://github.com/DSpace/DSpace/commit/06f9eb521c98fad98c5c7a6e1f4d31226e6c49e4", "message": "Fix checkstyle issue", "committedDate": "2020-06-25T12:02:00Z", "type": "commit"}, {"oid": "361610c73a73e608509d9710ed5087d3f83f09be", "url": "https://github.com/DSpace/DSpace/commit/361610c73a73e608509d9710ed5087d3f83f09be", "message": "Merge branch 'master' into DS-4042_ITs_WrongPatchRequest", "committedDate": "2020-06-25T16:46:59Z", "type": "commit"}, {"oid": "21e96f937c77bba576db67bb19fd93acabb8399a", "url": "https://github.com/DSpace/DSpace/commit/21e96f937c77bba576db67bb19fd93acabb8399a", "message": "added missing parameter", "committedDate": "2020-06-25T17:09:25Z", "type": "commit"}]}