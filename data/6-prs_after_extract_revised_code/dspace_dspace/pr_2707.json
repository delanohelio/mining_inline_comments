{"pr_number": 2707, "pr_title": "DS-4122 Create Integration Tests to prove access restricted Communities/Collections cannot be accessed anonymously", "pr_createdAt": "2020-03-09T17:28:05Z", "pr_url": "https://github.com/DSpace/DSpace/pull/2707", "timeline": [{"oid": "da48afa6b51bd088d2b266581a2e5a5c3d9eb871", "url": "https://github.com/DSpace/DSpace/commit/da48afa6b51bd088d2b266581a2e5a5c3d9eb871", "message": "added ITs to prove access restricted for /api/core/communities/<:uuid>", "committedDate": "2020-02-25T08:13:43Z", "type": "commit"}, {"oid": "1b0e21496af525924fd80102a06c569cdd2c059a", "url": "https://github.com/DSpace/DSpace/commit/1b0e21496af525924fd80102a06c569cdd2c059a", "message": "added ITs to prove access restricted for /api/core/communities/<:uuid>/subcommunities", "committedDate": "2020-02-25T11:23:06Z", "type": "commit"}, {"oid": "ee3d3791762b091973446d037a8870360f810275", "url": "https://github.com/DSpace/DSpace/commit/ee3d3791762b091973446d037a8870360f810275", "message": "added matcher for Collection", "committedDate": "2020-02-25T17:26:53Z", "type": "commit"}, {"oid": "3bc6346a5b716e5446bf47cfcff6ea6da8c51416", "url": "https://github.com/DSpace/DSpace/commit/3bc6346a5b716e5446bf47cfcff6ea6da8c51416", "message": "added ITs to prove access restricted for /api/core/communities/<:uuid>/collections", "committedDate": "2020-02-25T17:28:17Z", "type": "commit"}, {"oid": "00fe4b6bcbfdd6544d9cf378426f944e2dd8cb41", "url": "https://github.com/DSpace/DSpace/commit/00fe4b6bcbfdd6544d9cf378426f944e2dd8cb41", "message": "added check to prove that community/collection are public", "committedDate": "2020-02-25T17:32:32Z", "type": "commit"}, {"oid": "61e927ed946849d430fed4fee25e4de808cc5780", "url": "https://github.com/DSpace/DSpace/commit/61e927ed946849d430fed4fee25e4de808cc5780", "message": "refactored tests", "committedDate": "2020-02-26T10:23:53Z", "type": "commit"}, {"oid": "3bbe68cc73a59b2d9897e39451893e7c2187af8f", "url": "https://github.com/DSpace/DSpace/commit/3bbe68cc73a59b2d9897e39451893e7c2187af8f", "message": "added ITs to prove access restricted Communities/Collections cannot be accessed anonymously", "committedDate": "2020-02-28T15:01:26Z", "type": "commit"}, {"oid": "38b89d85aee756b3fcfff0f9899f80429d3d77b8", "url": "https://github.com/DSpace/DSpace/commit/38b89d85aee756b3fcfff0f9899f80429d3d77b8", "message": "implemented Solr query for SubCommunityLinkRepository", "committedDate": "2020-02-28T15:05:54Z", "type": "commit"}, {"oid": "67a48dbd7117aff13de7bfd6427a7526d444949d", "url": "https://github.com/DSpace/DSpace/commit/67a48dbd7117aff13de7bfd6427a7526d444949d", "message": "implemented Solr query for CommunityCollectionLinkRepository", "committedDate": "2020-02-28T15:07:27Z", "type": "commit"}, {"oid": "b15001b54ed2e8b7ef85af23372b590a73ce34df", "url": "https://github.com/DSpace/DSpace/commit/b15001b54ed2e8b7ef85af23372b590a73ce34df", "message": "added Solr query inside findAll() for Community/Collection Repositories", "committedDate": "2020-02-28T15:12:58Z", "type": "commit"}, {"oid": "f7a12ab3d3afa86f169a26174514c7f41b5c731f", "url": "https://github.com/DSpace/DSpace/commit/f7a12ab3d3afa86f169a26174514c7f41b5c731f", "message": "added indexing for ADMIN policies", "committedDate": "2020-02-28T15:16:18Z", "type": "commit"}, {"oid": "bece88f97784b8ef024639afabad00d3d0c2bc97", "url": "https://github.com/DSpace/DSpace/commit/bece88f97784b8ef024639afabad00d3d0c2bc97", "message": "implemented plugin for indexing parent object of Community/Collection/Item", "committedDate": "2020-02-28T15:19:34Z", "type": "commit"}, {"oid": "2b13edb14323253b61750368902ef55339278d4c", "url": "https://github.com/DSpace/DSpace/commit/2b13edb14323253b61750368902ef55339278d4c", "message": "fix typo in solr field name", "committedDate": "2020-03-02T17:44:32Z", "type": "commit"}, {"oid": "1f9f8510b40fbb62c5abfc95a5474df1313eb86a", "url": "https://github.com/DSpace/DSpace/commit/1f9f8510b40fbb62c5abfc95a5474df1313eb86a", "message": "added check for IndexableDSpaceObject & fix minor bugs", "committedDate": "2020-03-05T21:29:35Z", "type": "commit"}, {"oid": "87bc6a24ea6c77e2cb4584f92c139cec81e6934c", "url": "https://github.com/DSpace/DSpace/commit/87bc6a24ea6c77e2cb4584f92c139cec81e6934c", "message": "Merge branch 'master' of https://github.com/DSpace/DSpace into DS-4122_comcol_permissions\n\n# Conflicts:\n#\tdspace-api/src/test/data/dspaceFolder/config/spring/api/workflow.xml\n#\tdspace-api/src/test/java/org/dspace/xmlworkflow/XmlWorkflowFactoryTest.java\n#\tdspace-server-webapp/src/main/java/org/dspace/app/rest/repository/CollectionRestRepository.java\n#\tdspace-server-webapp/src/main/java/org/dspace/app/rest/repository/CommunityRestRepository.java\n#\tdspace-server-webapp/src/test/java/org/dspace/app/rest/ItemOwningCollectionUpdateRestControllerIT.java\n#\tdspace-server-webapp/src/test/java/org/dspace/app/rest/builder/CommunityBuilder.java", "committedDate": "2020-03-10T12:18:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTg5NDY2OA==", "url": "https://github.com/DSpace/DSpace/pull/2707#discussion_r391894668", "bodyText": "Please add JavaDocs to describe the purpose of this plugin.  It likely should say something like \"Indexes the UUID of the parent object for any Community, Collection and Item.\"\nI'd also recommend renaming this plugin to be SolrServiceParentObjectIndexingPlugin, as the would better describe its purpose.  It's not really filtering Communities, Collections or Items.  Instead it's indexing the parent object for these DSOs.", "author": "tdonohue", "createdAt": "2020-03-12T21:08:27Z", "path": "dspace-api/src/main/java/org/dspace/discovery/SolrServiceCommunityCollectionItemFilterPlugin.java", "diffHunk": "@@ -0,0 +1,40 @@\n+/**\n+ * The contents of this file are subject to the license and copyright\n+ * detailed in the LICENSE and NOTICE files at the root of the source\n+ * tree and available online at\n+ *\n+ * http://www.dspace.org/license/\n+ */\n+package org.dspace.discovery;\n+\n+import java.sql.SQLException;\n+\n+import org.apache.solr.common.SolrInputDocument;\n+import org.dspace.content.Collection;\n+import org.dspace.content.Community;\n+import org.dspace.content.DSpaceObject;\n+import org.dspace.content.Item;\n+import org.dspace.content.factory.ContentServiceFactory;\n+import org.dspace.core.Context;\n+import org.dspace.discovery.indexobject.IndexableDSpaceObject;\n+\n+public class SolrServiceCommunityCollectionItemFilterPlugin implements SolrServiceIndexPlugin {", "originalCommit": "87bc6a24ea6c77e2cb4584f92c139cec81e6934c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA3MTkwMA==", "url": "https://github.com/DSpace/DSpace/pull/2707#discussion_r397071900", "bodyText": "done here 9ce5c58#diff-9f487ddbf8c05ea7008d57b478507f1d", "author": "abollini", "createdAt": "2020-03-24T11:10:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTg5NDY2OA=="}], "type": "inlineReview", "revised_code": {"commit": "9ce5c586269ebdde32e87d1d7591be15734f7dd3", "chunk": "diff --git a/dspace-api/src/main/java/org/dspace/discovery/SolrServiceCommunityCollectionItemFilterPlugin.java b/dspace-api/src/main/java/org/dspace/discovery/SolrServiceParentObjectIndexingPlugin.java\nsimilarity index 86%\nrename from dspace-api/src/main/java/org/dspace/discovery/SolrServiceCommunityCollectionItemFilterPlugin.java\nrename to dspace-api/src/main/java/org/dspace/discovery/SolrServiceParentObjectIndexingPlugin.java\nindex 347d8b297..e4c3e0afc 100644\n--- a/dspace-api/src/main/java/org/dspace/discovery/SolrServiceCommunityCollectionItemFilterPlugin.java\n+++ b/dspace-api/src/main/java/org/dspace/discovery/SolrServiceParentObjectIndexingPlugin.java\n\n@@ -17,8 +17,12 @@ import org.dspace.content.Item;\n import org.dspace.content.factory.ContentServiceFactory;\n import org.dspace.core.Context;\n import org.dspace.discovery.indexobject.IndexableDSpaceObject;\n-\n-public class SolrServiceCommunityCollectionItemFilterPlugin implements SolrServiceIndexPlugin {\n+/**\n+ * Indexes the UUID of the parent object for any Community, Collection and Item\n+ * \n+ * @author Mykhaylo Boychuk (mykhaylo.boychuk at 4science.it)\n+ */\n+public class SolrServiceParentObjectIndexingPlugin implements SolrServiceIndexPlugin {\n \n     @Override\n     public void additionalIndex(Context context, IndexableObject idxObj, SolrInputDocument document) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTkwMTEwMw==", "url": "https://github.com/DSpace/DSpace/pull/2707#discussion_r391901103", "bodyText": "Could we add an inline comment here to describe the query we are running?  If I understand this correctly, we're looking for all Collections that the current user has access to?", "author": "tdonohue", "createdAt": "2020-03-12T21:22:53Z", "path": "dspace-server-webapp/src/main/java/org/dspace/app/rest/repository/CollectionRestRepository.java", "diffHunk": "@@ -93,11 +108,26 @@ public CollectionRest findOne(Context context, UUID id) {\n     @Override\n     public Page<CollectionRest> findAll(Context context, Pageable pageable) {\n         try {\n-            long total = cs.countTotal(context);\n-            List<Collection> collections = cs.findAll(context, pageable.getPageSize(),\n-                Math.toIntExact(pageable.getOffset()));\n-            return converter.toRestPage(collections, pageable, total, utils.obtainProjection());\n-        } catch (SQLException e) {\n+            if (authorizeService.isAdmin(context)) {\n+                long total = cs.countTotal(context);\n+                List<Collection> collections = cs.findAll(context, pageable.getPageSize(),\n+                    Math.toIntExact(pageable.getOffset()));\n+                return converter.toRestPage(collections, pageable, total, utils.obtainProjection());\n+            } else {\n+                List<Collection> collections = new LinkedList<Collection>();\n+                DiscoverQuery discoverQuery = new DiscoverQuery();", "originalCommit": "87bc6a24ea6c77e2cb4584f92c139cec81e6934c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA3MjM3OQ==", "url": "https://github.com/DSpace/DSpace/pull/2707#discussion_r397072379", "bodyText": "done here 9ce5c58#diff-c7c44609573d540f6f0c0efa196ed6ffR118", "author": "abollini", "createdAt": "2020-03-24T11:11:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTkwMTEwMw=="}], "type": "inlineReview", "revised_code": {"commit": "9ce5c586269ebdde32e87d1d7591be15734f7dd3", "chunk": "diff --git a/dspace-server-webapp/src/main/java/org/dspace/app/rest/repository/CollectionRestRepository.java b/dspace-server-webapp/src/main/java/org/dspace/app/rest/repository/CollectionRestRepository.java\nindex db9e7bf9d..15abe0d47 100644\n--- a/dspace-server-webapp/src/main/java/org/dspace/app/rest/repository/CollectionRestRepository.java\n+++ b/dspace-server-webapp/src/main/java/org/dspace/app/rest/repository/CollectionRestRepository.java\n\n@@ -115,6 +115,8 @@ public class CollectionRestRepository extends DSpaceObjectRestRepository<Collect\n                 return converter.toRestPage(collections, pageable, total, utils.obtainProjection());\n             } else {\n                 List<Collection> collections = new LinkedList<Collection>();\n+                // search for all the collections and let the SOLR security plugins to limit\n+                // what is returned to what the user can see\n                 DiscoverQuery discoverQuery = new DiscoverQuery();\n                 discoverQuery.setDSpaceObjectFilter(IndexableCollection.TYPE);\n                 discoverQuery.setStart(Math.toIntExact(pageable.getOffset()));\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTkwMTkzOA==", "url": "https://github.com/DSpace/DSpace/pull/2707#discussion_r391901938", "bodyText": "Again, it'd be useful to add an inline comment to describe the query we are building.  This looks to be searching for all Collections  (that the user has access to) under a specific Community?", "author": "tdonohue", "createdAt": "2020-03-12T21:23:57Z", "path": "dspace-server-webapp/src/main/java/org/dspace/app/rest/repository/CommunityCollectionLinkRepository.java", "diffHunk": "@@ -48,10 +60,25 @@\n             if (community == null) {\n                 throw new ResourceNotFoundException(\"No such community: \" + communityId);\n             }\n-            List<Collection> collections = community.getCollections();\n-            return converter.toRestPage(utils.getPage(collections, optionalPageable), projection);\n-        } catch (SQLException e) {\n-            throw new RuntimeException(e);\n+            Pageable pageable = utils.getPageable(optionalPageable);\n+            List<Collection> collections = new LinkedList<Collection>();\n+            IndexObjectFactoryFactory indexObjectFactory = IndexObjectFactoryFactory.getInstance();\n+            IndexableObject scopeObject = indexObjectFactory.getIndexableObjects(context, community).get(0);\n+            DiscoverQuery discoverQuery = new DiscoverQuery();", "originalCommit": "87bc6a24ea6c77e2cb4584f92c139cec81e6934c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA3ODY2Ng==", "url": "https://github.com/DSpace/DSpace/pull/2707#discussion_r397078666", "bodyText": "done here 94706cf#diff-c90f703886a8245f9a9e23f499cfca90R66", "author": "abollini", "createdAt": "2020-03-24T11:22:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTkwMTkzOA=="}], "type": "inlineReview", "revised_code": {"commit": "9ce5c586269ebdde32e87d1d7591be15734f7dd3", "chunk": "diff --git a/dspace-server-webapp/src/main/java/org/dspace/app/rest/repository/CommunityCollectionLinkRepository.java b/dspace-server-webapp/src/main/java/org/dspace/app/rest/repository/CommunityCollectionLinkRepository.java\nindex c50365fd4..5269a3a79 100644\n--- a/dspace-server-webapp/src/main/java/org/dspace/app/rest/repository/CommunityCollectionLinkRepository.java\n+++ b/dspace-server-webapp/src/main/java/org/dspace/app/rest/repository/CommunityCollectionLinkRepository.java\n\n@@ -60,6 +60,8 @@ public class CommunityCollectionLinkRepository extends AbstractDSpaceRestReposit\n             if (community == null) {\n                 throw new ResourceNotFoundException(\"No such community: \" + communityId);\n             }\n+            // search for all the collections direct children of our community\n+            // and let the SOLR security plugins to limit what is returned to what the user can see\n             Pageable pageable = utils.getPageable(optionalPageable);\n             List<Collection> collections = new LinkedList<Collection>();\n             IndexObjectFactoryFactory indexObjectFactory = IndexObjectFactoryFactory.getInstance();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTkwMjM0NA==", "url": "https://github.com/DSpace/DSpace/pull/2707#discussion_r391902344", "bodyText": "Same here, a comment to describe the query.  This looks to be searching for all Communities which the current user has access to.", "author": "tdonohue", "createdAt": "2020-03-12T21:24:29Z", "path": "dspace-server-webapp/src/main/java/org/dspace/app/rest/repository/CommunityRestRepository.java", "diffHunk": "@@ -147,11 +160,26 @@ public CommunityRest findOne(Context context, UUID id) {\n     @Override\n     public Page<CommunityRest> findAll(Context context, Pageable pageable) {\n         try {\n-            long total = cs.countTotal(context);\n-            List<Community> communities = cs.findAll(context, pageable.getPageSize(),\n+            if (authorizeService.isAdmin(context)) {\n+                long total = cs.countTotal(context);\n+                List<Community> communities = cs.findAll(context, pageable.getPageSize(),\n                     Math.toIntExact(pageable.getOffset()));\n-            return converter.toRestPage(communities, pageable, total, utils.obtainProjection());\n-        } catch (SQLException e) {\n+                return converter.toRestPage(communities, pageable, total, utils.obtainProjection());\n+            } else {\n+                List<Community> communities = new LinkedList<Community>();\n+                DiscoverQuery discoverQuery = new DiscoverQuery();", "originalCommit": "87bc6a24ea6c77e2cb4584f92c139cec81e6934c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA3MjU3MA==", "url": "https://github.com/DSpace/DSpace/pull/2707#discussion_r397072570", "bodyText": "done here 9ce5c58#diff-38aef90b55ad47e2a09766c3dedbf89dR169", "author": "abollini", "createdAt": "2020-03-24T11:11:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTkwMjM0NA=="}], "type": "inlineReview", "revised_code": {"commit": "9ce5c586269ebdde32e87d1d7591be15734f7dd3", "chunk": "diff --git a/dspace-server-webapp/src/main/java/org/dspace/app/rest/repository/CommunityRestRepository.java b/dspace-server-webapp/src/main/java/org/dspace/app/rest/repository/CommunityRestRepository.java\nindex 610e177e3..5ed465d42 100644\n--- a/dspace-server-webapp/src/main/java/org/dspace/app/rest/repository/CommunityRestRepository.java\n+++ b/dspace-server-webapp/src/main/java/org/dspace/app/rest/repository/CommunityRestRepository.java\n\n@@ -167,6 +166,8 @@ public class CommunityRestRepository extends DSpaceObjectRestRepository<Communit\n                 return converter.toRestPage(communities, pageable, total, utils.obtainProjection());\n             } else {\n                 List<Community> communities = new LinkedList<Community>();\n+                // search for all the communities and let the SOLR security plugins to limit\n+                // what is returned to what the user can see\n                 DiscoverQuery discoverQuery = new DiscoverQuery();\n                 discoverQuery.setDSpaceObjectFilter(IndexableCommunity.TYPE);\n                 discoverQuery.setStart(Math.toIntExact(pageable.getOffset()));\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTkwNDgwOA==", "url": "https://github.com/DSpace/DSpace/pull/2707#discussion_r391904808", "bodyText": "Same here, please add a comment to describe the query.  This looks to be searching for all Subcommunities which the current user has access to under a given Community.\nUPDATE: Is part of this query missing?  I'm not seeing the location.parent filter here to ensure we are filtering to subcommunities under one community.  In other words, I'd expect this query to be similar to the one in CommunityCollectionLinkRepository", "author": "tdonohue", "createdAt": "2020-03-12T21:27:36Z", "path": "dspace-server-webapp/src/main/java/org/dspace/app/rest/repository/CommunitySubcommunityLinkRepository.java", "diffHunk": "@@ -46,10 +58,24 @@\n             if (community == null) {\n                 throw new ResourceNotFoundException(\"No such community: \" + communityId);\n             }\n-            List<Community> subcommunities = community.getSubcommunities();\n-            return converter.toRestPage(utils.getPage(subcommunities, optionalPageable), projection);\n-        } catch (SQLException e) {\n-            throw new RuntimeException(e);\n+            Pageable pageable = utils.getPageable(optionalPageable);\n+            List<Community> publicSubcommunities = new LinkedList<Community>();\n+            IndexObjectFactoryFactory indexObjectFactory = IndexObjectFactoryFactory.getInstance();\n+            IndexableObject scopeObject = indexObjectFactory.getIndexableObjects(context, community).get(0);\n+            DiscoverQuery discoverQuery = new DiscoverQuery();", "originalCommit": "87bc6a24ea6c77e2cb4584f92c139cec81e6934c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA3MTIzNg==", "url": "https://github.com/DSpace/DSpace/pull/2707#discussion_r393071236", "bodyText": "@tdonohue you are right... investigating on that we have discovered that a proper test for the findAllSubCommunities normal scenario (i.e. all public resources) is missing or better the one that already exists is not related to what we expect, see \n  \n    \n      DSpace/dspace-server-webapp/src/test/java/org/dspace/app/rest/CommunityRestRepositoryIT.java\n    \n    \n         Line 733\n      in\n      880ed67\n    \n    \n    \n    \n\n        \n          \n           getClient().perform(get(\"/api/core/communities/search/subCommunities\") \n        \n    \n  \n\n\nAs you can see here it test a search method NOT the subcommunities path. We are going to add the missing test to demostrate the bug the you have found and proof the resolution but we are worrying about this search method, should we retain it? it is obviously a duplicate of the subcommunities path and actually it runs some duplicated code that need to be cleanup as well.\nIf we want to retain such search method\nhttps://github.com/DSpace/Rest7Contract/blob/master/communities.md#subcommunities-1\nof course we should add IT also for it about the security scenarios.", "author": "abollini", "createdAt": "2020-03-16T14:34:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTkwNDgwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA5NTgyNA==", "url": "https://github.com/DSpace/DSpace/pull/2707#discussion_r393095824", "bodyText": "@abollini : I suspect that the subCommunities search was added simply because this location.parent filter didn't exist (so it was an early attempt at a subcommunities endpoint).  However, I agree that, assuming we feel the location.parent filter is the better direction, we should likely remove the subCommunities search endpoint and just use /api/core/communities/[uuid]/subcommunities as the replacement.\nWe also should keep in mind that this change also might require minor modifications to the Angular UI, if it is using the subCommunities search endpoint.", "author": "tdonohue", "createdAt": "2020-03-16T15:08:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTkwNDgwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzUxNzIyMA==", "url": "https://github.com/DSpace/DSpace/pull/2707#discussion_r393517220", "bodyText": "@tdonohue @abollini\non angular side is only used the community's subcommunities link, the core/communities/search/subCommunities method is not used", "author": "atarix83", "createdAt": "2020-03-17T08:39:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTkwNDgwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzgzOTc4MA==", "url": "https://github.com/DSpace/DSpace/pull/2707#discussion_r393839780", "bodyText": "From the REST contract I also don't see any reasons why both endpoints exist, but there's little info on either endpoint.\nIs it possible that one endpoint only returns direct children and the other endpoint also returns indirect children?", "author": "benbosman", "createdAt": "2020-03-17T17:14:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTkwNDgwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTEwMDk2Mg==", "url": "https://github.com/DSpace/DSpace/pull/2707#discussion_r395100962", "bodyText": "we checked, both implementation were returning only direct children. So we have removed the search method", "author": "abollini", "createdAt": "2020-03-19T15:11:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTkwNDgwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA3NTY0MA==", "url": "https://github.com/DSpace/DSpace/pull/2707#discussion_r397075640", "bodyText": "the search method has been removed see 9ce5c58#diff-38aef90b55ad47e2a09766c3dedbf89dL202\nand the test fixed to use the right endpoint\n9ce5c58#diff-6622e3784efcad38a85da05b7dff958fR922\nthat has shown the issue caught by @tdonohue  here 9ce5c58#diff-61a40e01c781a6ddea21860116a7679fR68", "author": "abollini", "createdAt": "2020-03-24T11:17:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTkwNDgwOA=="}], "type": "inlineReview", "revised_code": {"commit": "9ce5c586269ebdde32e87d1d7591be15734f7dd3", "chunk": "diff --git a/dspace-server-webapp/src/main/java/org/dspace/app/rest/repository/CommunitySubcommunityLinkRepository.java b/dspace-server-webapp/src/main/java/org/dspace/app/rest/repository/CommunitySubcommunityLinkRepository.java\nindex b77ccbd52..b2aabcc76 100644\n--- a/dspace-server-webapp/src/main/java/org/dspace/app/rest/repository/CommunitySubcommunityLinkRepository.java\n+++ b/dspace-server-webapp/src/main/java/org/dspace/app/rest/repository/CommunitySubcommunityLinkRepository.java\n\n@@ -65,6 +65,7 @@ public class CommunitySubcommunityLinkRepository extends AbstractDSpaceRestRepos\n             DiscoverQuery discoverQuery = new DiscoverQuery();\n             discoverQuery.setQuery(\"*:*\");\n             discoverQuery.setDSpaceObjectFilter(IndexableCommunity.TYPE);\n+            discoverQuery.addFilterQueries(\"location.parent:\" + communityId);\n             discoverQuery.setStart(Math.toIntExact(pageable.getOffset()));\n             discoverQuery.setMaxResults(pageable.getPageSize());\n             DiscoverResult resp = searchService.search(context, scopeObject, discoverQuery);\n"}}, {"oid": "9ce5c586269ebdde32e87d1d7591be15734f7dd3", "url": "https://github.com/DSpace/DSpace/commit/9ce5c586269ebdde32e87d1d7591be15734f7dd3", "message": "Implement community feedback", "committedDate": "2020-03-17T16:46:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzgzMjk0Ng==", "url": "https://github.com/DSpace/DSpace/pull/2707#discussion_r393832946", "bodyText": "This implementation implies that if you create a community ADMIN group after the community contains items, those items will need to be re-indexed.\nI don't think that's a problem, as long as it's well-documented", "author": "benbosman", "createdAt": "2020-03-17T17:03:17Z", "path": "dspace-api/src/main/java/org/dspace/discovery/SolrServiceResourceRestrictionPlugin.java", "diffHunk": "@@ -77,6 +82,29 @@ public void additionalIndex(Context context, IndexableObject idxObj, SolrInputDo\n                     //remove the policy from the cache to save memory\n                     context.uncacheEntity(resourcePolicy);\n                 }\n+                 // also index ADMIN policies as ADMIN permissions provides READ access", "originalCommit": "9ce5c586269ebdde32e87d1d7591be15734f7dd3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTE0MTU3OQ==", "url": "https://github.com/DSpace/DSpace/pull/2707#discussion_r395141579", "bodyText": "You are right. We can easily note that in the rest contract for the subCommunities path we will open a PR for that. I also available, if you feel appropriate, to put on this page (rephrasing is welcome)\nhttps://wiki.lyrasis.org/display/DSDOC7x/Configuration+Reference#ConfigurationReference-DelegationAdministration:AuthorizationSystemConfiguration\nthis warning note once that the PR is merged.\n\"Please note that, to provide good performance, the REST API uses information flatten and stored in SOLR at the time of item indexing that could become stale when new delegation are enabled (i.e. a community or collection admin group are created). In such case you are advised to reindex your items. This doesn't apply when your delegation are already inplace and you only change the members of an admin group, these changes are immediately visible without any need to reindex.\"", "author": "abollini", "createdAt": "2020-03-19T16:06:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzgzMjk0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA4NTc1Mw==", "url": "https://github.com/DSpace/DSpace/pull/2707#discussion_r397085753", "bodyText": "I have create a PR to add these information in the rest contract DSpace/RestContract#116", "author": "abollini", "createdAt": "2020-03-24T11:35:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzgzMjk0Ng=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzgzNDQ0Mg==", "url": "https://github.com/DSpace/DSpace/pull/2707#discussion_r393834442", "bodyText": "I can see no discovery configuration is included here. If a local institution changes the default discovery behavior to exclude comm/coll from the discovery search results, will this functionality stop working?\n(the same applies for the other searches in this PR)", "author": "benbosman", "createdAt": "2020-03-17T17:05:38Z", "path": "dspace-server-webapp/src/main/java/org/dspace/app/rest/repository/CollectionRestRepository.java", "diffHunk": "@@ -93,11 +108,28 @@ public CollectionRest findOne(Context context, UUID id) {\n     @Override\n     public Page<CollectionRest> findAll(Context context, Pageable pageable) {\n         try {\n-            long total = cs.countTotal(context);\n-            List<Collection> collections = cs.findAll(context, pageable.getPageSize(),\n-                Math.toIntExact(pageable.getOffset()));\n-            return converter.toRestPage(collections, pageable, total, utils.obtainProjection());\n-        } catch (SQLException e) {\n+            if (authorizeService.isAdmin(context)) {\n+                long total = cs.countTotal(context);\n+                List<Collection> collections = cs.findAll(context, pageable.getPageSize(),\n+                    Math.toIntExact(pageable.getOffset()));\n+                return converter.toRestPage(collections, pageable, total, utils.obtainProjection());\n+            } else {\n+                List<Collection> collections = new LinkedList<Collection>();\n+                // search for all the collections and let the SOLR security plugins to limit\n+                // what is returned to what the user can see\n+                DiscoverQuery discoverQuery = new DiscoverQuery();\n+                discoverQuery.setDSpaceObjectFilter(IndexableCollection.TYPE);\n+                discoverQuery.setStart(Math.toIntExact(pageable.getOffset()));\n+                discoverQuery.setMaxResults(pageable.getPageSize());\n+                DiscoverResult resp = searchService.search(context, discoverQuery);", "originalCommit": "9ce5c586269ebdde32e87d1d7591be15734f7dd3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTEwMjI2Mw==", "url": "https://github.com/DSpace/DSpace/pull/2707#discussion_r395102263", "bodyText": "no, it will work anyway because it doesn't use a discovery configuration but build from scratch a discover query. It only use the new field intorduced via the plugin (similar to how the other security filters work)", "author": "abollini", "createdAt": "2020-03-19T15:13:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzgzNDQ0Mg=="}], "type": "inlineReview", "revised_code": null}, {"oid": "ef4a33b584f0694ea555f7f6b30fbcbb86c334e3", "url": "https://github.com/DSpace/DSpace/commit/ef4a33b584f0694ea555f7f6b30fbcbb86c334e3", "message": "Merge branch 'master' of https://github.com/DSpace/DSpace into DS-4122_comcol_permissions", "committedDate": "2020-03-24T11:18:16Z", "type": "commit"}, {"oid": "94706cfcc28e0d7a9b0d8affa1a4ad468b776e95", "url": "https://github.com/DSpace/DSpace/commit/94706cfcc28e0d7a9b0d8affa1a4ad468b776e95", "message": "Fix checkstyle issue after update to 8.30, move comments closer to the relevant code", "committedDate": "2020-03-24T11:21:29Z", "type": "commit"}]}