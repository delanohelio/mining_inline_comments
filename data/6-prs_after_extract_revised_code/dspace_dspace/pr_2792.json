{"pr_number": 2792, "pr_title": "Refactoring authority framework, value pairs and controlled vocabulary", "pr_createdAt": "2020-06-25T20:25:19Z", "pr_url": "https://github.com/DSpace/DSpace/pull/2792", "timeline": [{"oid": "e39c2a858281ed9530c9dc44c79fcfb2e1504aa6", "url": "https://github.com/DSpace/DSpace/commit/e39c2a858281ed9530c9dc44c79fcfb2e1504aa6", "message": "added ITs for Controlled Vocabularies", "committedDate": "2020-06-10T15:00:43Z", "type": "commit"}, {"oid": "5f6775a1223cf82cb7f34b5ab2e0883b9429e286", "url": "https://github.com/DSpace/DSpace/commit/5f6775a1223cf82cb7f34b5ab2e0883b9429e286", "message": "added ITs for Vocabulary Entries", "committedDate": "2020-06-10T19:30:10Z", "type": "commit"}, {"oid": "1765d2a161f6440d54f3f2ed808ec274e9d8c84c", "url": "https://github.com/DSpace/DSpace/commit/1765d2a161f6440d54f3f2ed808ec274e9d8c84c", "message": "added tests", "committedDate": "2020-06-15T09:53:50Z", "type": "commit"}, {"oid": "d794c1cdf0512ac45f1e9c5a5618646fee6d8c80", "url": "https://github.com/DSpace/DSpace/commit/d794c1cdf0512ac45f1e9c5a5618646fee6d8c80", "message": "update tests of Vocabulary", "committedDate": "2020-06-16T16:22:56Z", "type": "commit"}, {"oid": "8afa698e041b67134c9d92dba46bdf05b8aea80a", "url": "https://github.com/DSpace/DSpace/commit/8afa698e041b67134c9d92dba46bdf05b8aea80a", "message": "Initial refactoring for vocabularies (Draft)", "committedDate": "2020-06-16T16:35:04Z", "type": "commit"}, {"oid": "17c383364542672efaaa1d631bd13f29ef7dc5bd", "url": "https://github.com/DSpace/DSpace/commit/17c383364542672efaaa1d631bd13f29ef7dc5bd", "message": "Refactoring for vocabularies, second part (Draft)", "committedDate": "2020-06-17T08:45:34Z", "type": "commit"}, {"oid": "dc2f68655f7af2c657e3dc669b7f586d93f0304a", "url": "https://github.com/DSpace/DSpace/commit/dc2f68655f7af2c657e3dc669b7f586d93f0304a", "message": "Merge branch 'CST-3088' into draft_vocabulary", "committedDate": "2020-06-17T09:47:50Z", "type": "commit"}, {"oid": "9849d6c41e00257e3721043661934f020ec5fac9", "url": "https://github.com/DSpace/DSpace/commit/9849d6c41e00257e3721043661934f020ec5fac9", "message": "fix checkstyle", "committedDate": "2020-06-17T12:19:54Z", "type": "commit"}, {"oid": "4784d34066d32c1f75ce1afebfc36d6681118e16", "url": "https://github.com/DSpace/DSpace/commit/4784d34066d32c1f75ce1afebfc36d6681118e16", "message": "renamed classes", "committedDate": "2020-06-17T16:22:13Z", "type": "commit"}, {"oid": "d7ce794eab7ee7a658e9fb99734f9fd1705283ed", "url": "https://github.com/DSpace/DSpace/commit/d7ce794eab7ee7a658e9fb99734f9fd1705283ed", "message": "fix creation of the internal maps of authorities", "committedDate": "2020-06-18T08:14:56Z", "type": "commit"}, {"oid": "3e8b2f87b66f61b66c12ec41e11caa6a5a19ca5c", "url": "https://github.com/DSpace/DSpace/commit/3e8b2f87b66f61b66c12ec41e11caa6a5a19ca5c", "message": "Remove invalid test, cleanup", "committedDate": "2020-06-18T10:28:48Z", "type": "commit"}, {"oid": "be6f7f3bfd2edc3cd1513b075ab444a4fdae6f99", "url": "https://github.com/DSpace/DSpace/commit/be6f7f3bfd2edc3cd1513b075ab444a4fdae6f99", "message": "Update default to reflect the rest contract\n\nthe visualization is now responsability of the angular UI so it is better by default present a clean label as the hierarchy is still visible in the otherInformation", "committedDate": "2020-06-18T10:38:12Z", "type": "commit"}, {"oid": "ec3df2e523bed760fab64005ed879f147170e6c7", "url": "https://github.com/DSpace/DSpace/commit/ec3df2e523bed760fab64005ed879f147170e6c7", "message": "Fix test setup, update response code according to the contract", "committedDate": "2020-06-18T10:42:59Z", "type": "commit"}, {"oid": "94581761b91f703129d50803e5d0ec8c2991d031", "url": "https://github.com/DSpace/DSpace/commit/94581761b91f703129d50803e5d0ec8c2991d031", "message": "Fix typos", "committedDate": "2020-06-18T10:55:40Z", "type": "commit"}, {"oid": "ae60714f7d4035019f4581d39baa365333586d28", "url": "https://github.com/DSpace/DSpace/commit/ae60714f7d4035019f4581d39baa365333586d28", "message": "Align test with the contract", "committedDate": "2020-06-18T10:55:58Z", "type": "commit"}, {"oid": "f44b28a8f5855dcf89f0815544be03e73e228456", "url": "https://github.com/DSpace/DSpace/commit/f44b28a8f5855dcf89f0815544be03e73e228456", "message": "Implement check for mandatory parameters", "committedDate": "2020-06-18T10:56:23Z", "type": "commit"}, {"oid": "d38dfdb31fe92592f34f7a91c29c5a79737a784c", "url": "https://github.com/DSpace/DSpace/commit/d38dfdb31fe92592f34f7a91c29c5a79737a784c", "message": "Add support for : in string identifier", "committedDate": "2020-06-18T10:56:44Z", "type": "commit"}, {"oid": "61c346089e14429b8208ddc7c9a3a38eef94c972", "url": "https://github.com/DSpace/DSpace/commit/61c346089e14429b8208ddc7c9a3a38eef94c972", "message": "Cleanup authority service implementation", "committedDate": "2020-06-18T10:58:28Z", "type": "commit"}, {"oid": "e9abbc505b635120e25d6827063fc1b938fb2243", "url": "https://github.com/DSpace/DSpace/commit/e9abbc505b635120e25d6827063fc1b938fb2243", "message": "Add initial implementation for VocabularyEntryDetails repository", "committedDate": "2020-06-18T10:59:02Z", "type": "commit"}, {"oid": "53765394803768fd5639323a30401d2d502da9fb", "url": "https://github.com/DSpace/DSpace/commit/53765394803768fd5639323a30401d2d502da9fb", "message": "missing filling list of metadata", "committedDate": "2020-06-18T20:07:04Z", "type": "commit"}, {"oid": "1114903645deee131620eca0c95368560266dad4", "url": "https://github.com/DSpace/DSpace/commit/1114903645deee131620eca0c95368560266dad4", "message": "refactored tests", "committedDate": "2020-06-18T20:07:43Z", "type": "commit"}, {"oid": "ea9d5da7644f73e66a2f1dadfb304879949c13f0", "url": "https://github.com/DSpace/DSpace/commit/ea9d5da7644f73e66a2f1dadfb304879949c13f0", "message": "implemented search method byMetadataAndCollection", "committedDate": "2020-06-19T07:35:24Z", "type": "commit"}, {"oid": "fa2769036a6253fbd6802549edc0172da8d0ea78", "url": "https://github.com/DSpace/DSpace/commit/fa2769036a6253fbd6802549edc0172da8d0ea78", "message": "refactored search method byMetadataAndCollection", "committedDate": "2020-06-19T14:36:43Z", "type": "commit"}, {"oid": "52dfbfd95821546b2915b55b08af73f1ee9be55d", "url": "https://github.com/DSpace/DSpace/commit/52dfbfd95821546b2915b55b08af73f1ee9be55d", "message": "added VocabularyEntryResource", "committedDate": "2020-06-19T14:40:35Z", "type": "commit"}, {"oid": "cd842fd806a55a71a6966cdb9625b7aefca628dc", "url": "https://github.com/DSpace/DSpace/commit/cd842fd806a55a71a6966cdb9625b7aefca628dc", "message": "refactored RestResourceController", "committedDate": "2020-06-19T14:42:10Z", "type": "commit"}, {"oid": "056a0fbdae16f8e385255359d828336c460ec0d6", "url": "https://github.com/DSpace/DSpace/commit/056a0fbdae16f8e385255359d828336c460ec0d6", "message": "VocabularyEntryRest must implement RestModel", "committedDate": "2020-06-19T14:44:26Z", "type": "commit"}, {"oid": "f9f00672943f611b8bf909d3a3a26c495eb7aa19", "url": "https://github.com/DSpace/DSpace/commit/f9f00672943f611b8bf909d3a3a26c495eb7aa19", "message": "fix bug", "committedDate": "2020-06-19T16:45:37Z", "type": "commit"}, {"oid": "de49227b076a65720bb3b09c1e1ca3cd0f3e643d", "url": "https://github.com/DSpace/DSpace/commit/de49227b076a65720bb3b09c1e1ca3cd0f3e643d", "message": "fix tests", "committedDate": "2020-06-19T16:46:22Z", "type": "commit"}, {"oid": "e473f1170bb2007691a4bad885fbcc4365df6181", "url": "https://github.com/DSpace/DSpace/commit/e473f1170bb2007691a4bad885fbcc4365df6181", "message": "added test", "committedDate": "2020-06-19T16:47:04Z", "type": "commit"}, {"oid": "efb4f6a1be9fbbb566a82c336e42bdc29a9d65f6", "url": "https://github.com/DSpace/DSpace/commit/efb4f6a1be9fbbb566a82c336e42bdc29a9d65f6", "message": "renamed embedded link in tests", "committedDate": "2020-06-22T10:00:49Z", "type": "commit"}, {"oid": "73e0bd8759b69aa11bf54b6a4d3efe0a4ca17149", "url": "https://github.com/DSpace/DSpace/commit/73e0bd8759b69aa11bf54b6a4d3efe0a4ca17149", "message": "Avoid to expose the authority where not needed", "committedDate": "2020-06-22T10:15:00Z", "type": "commit"}, {"oid": "6c2ed0c0d917612eb54e251be077dcf8059724c7", "url": "https://github.com/DSpace/DSpace/commit/6c2ed0c0d917612eb54e251be077dcf8059724c7", "message": "Merge branch 'draft_vocabulary' of https://github.com/4Science/DSpace into draft_vocabulary", "committedDate": "2020-06-22T10:15:35Z", "type": "commit"}, {"oid": "de8def4418357b82b0425cdaf142bed48425f107", "url": "https://github.com/DSpace/DSpace/commit/de8def4418357b82b0425cdaf142bed48425f107", "message": "refactoring", "committedDate": "2020-06-22T12:44:41Z", "type": "commit"}, {"oid": "64a29b1b6050c94d50fc7676085ae82033ba437b", "url": "https://github.com/DSpace/DSpace/commit/64a29b1b6050c94d50fc7676085ae82033ba437b", "message": "update tests", "committedDate": "2020-06-22T12:45:44Z", "type": "commit"}, {"oid": "0c4985e1cf2634f775bd4cbf8551c46b439703b6", "url": "https://github.com/DSpace/DSpace/commit/0c4985e1cf2634f775bd4cbf8551c46b439703b6", "message": "added implementations for getChoicesByParent and getTopChoices", "committedDate": "2020-06-23T12:59:15Z", "type": "commit"}, {"oid": "ed5ea81241386b5abf10356857960486d7c5e24f", "url": "https://github.com/DSpace/DSpace/commit/ed5ea81241386b5abf10356857960486d7c5e24f", "message": "added implementations for link child and parent repositories", "committedDate": "2020-06-23T20:45:54Z", "type": "commit"}, {"oid": "b940e3d41a59bbf181b227942425d68367bc4ff2", "url": "https://github.com/DSpace/DSpace/commit/b940e3d41a59bbf181b227942425d68367bc4ff2", "message": "implemented search method top", "committedDate": "2020-06-23T20:48:54Z", "type": "commit"}, {"oid": "8c5dc56193910ed3cfdaae85cf4391046128f515", "url": "https://github.com/DSpace/DSpace/commit/8c5dc56193910ed3cfdaae85cf4391046128f515", "message": "updated tests of VocabularyEntryDetails", "committedDate": "2020-06-23T20:50:55Z", "type": "commit"}, {"oid": "13727fb49aee07e838a1b0951be38b598689af89", "url": "https://github.com/DSpace/DSpace/commit/13727fb49aee07e838a1b0951be38b598689af89", "message": "Added management of the parametr exact", "committedDate": "2020-06-24T10:36:34Z", "type": "commit"}, {"oid": "f39ce1cf54944ccbe7eae5aca4661f70669e7657", "url": "https://github.com/DSpace/DSpace/commit/f39ce1cf54944ccbe7eae5aca4661f70669e7657", "message": "Added ITs", "committedDate": "2020-06-24T10:37:09Z", "type": "commit"}, {"oid": "c69168b27def235ed3451f34423d187f98e37361", "url": "https://github.com/DSpace/DSpace/commit/c69168b27def235ed3451f34423d187f98e37361", "message": "Fix test and final cleanup", "committedDate": "2020-06-24T22:06:00Z", "type": "commit"}, {"oid": "6b923e0cb53cb344b8e8e3e7738c0b458c2b4e2b", "url": "https://github.com/DSpace/DSpace/commit/6b923e0cb53cb344b8e8e3e7738c0b458c2b4e2b", "message": "Fix test - DSpaceControlledVocabulary now honor the pagination", "committedDate": "2020-06-25T07:23:34Z", "type": "commit"}, {"oid": "82aae2395f22ca3d7631664ff4d14e56b77f5d8c", "url": "https://github.com/DSpace/DSpace/commit/82aae2395f22ca3d7631664ff4d14e56b77f5d8c", "message": "Remove unnecessary change in the MetadataAuthorityService", "committedDate": "2020-06-25T11:33:06Z", "type": "commit"}, {"oid": "76181a682919be046a4540a1c9ffe18d1a53dcbc", "url": "https://github.com/DSpace/DSpace/commit/76181a682919be046a4540a1c9ffe18d1a53dcbc", "message": "Restore test for authority as was before - no authorities for value pairs", "committedDate": "2020-06-25T15:37:24Z", "type": "commit"}, {"oid": "42dd930060cfaad1dc742c8b9821fa4453e523da", "url": "https://github.com/DSpace/DSpace/commit/42dd930060cfaad1dc742c8b9821fa4453e523da", "message": "Rename authority in controlledVocabulary, add related IT", "committedDate": "2020-06-25T15:47:17Z", "type": "commit"}, {"oid": "a8234f2004cfdd0fce7c496b8718379bb67f71ab", "url": "https://github.com/DSpace/DSpace/commit/a8234f2004cfdd0fce7c496b8718379bb67f71ab", "message": "Fix vocabulary related links test in the root endpoint", "committedDate": "2020-06-25T17:25:27Z", "type": "commit"}, {"oid": "ba150b1ec7e33e9a2c1cf38b94927f016ff03862", "url": "https://github.com/DSpace/DSpace/commit/ba150b1ec7e33e9a2c1cf38b94927f016ff03862", "message": "Fix cleanup testenv", "committedDate": "2020-06-25T17:26:52Z", "type": "commit"}, {"oid": "322b56b42275c0fdc2cdd7809ee653acab4392d7", "url": "https://github.com/DSpace/DSpace/commit/322b56b42275c0fdc2cdd7809ee653acab4392d7", "message": "Expose the vocabularyName to the submission form definition", "committedDate": "2020-06-25T18:14:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQyNzk5OQ==", "url": "https://github.com/DSpace/DSpace/pull/2792#discussion_r446427999", "bodyText": "@abollini : I'm curious about this change to make a ChoiceAuthority directly mapped to a SubmissionConfig (which is a Collection-specific submission configuration).  This seems to be the point in which we now must require a collection param in order to lookup the entries in a vocabulary.  This change is new as current master has the ChoiceAuthority only mapped to a metadata field, which would remove the requirement on a collection param.\nEssentially, I'm not sure I understand why we need to make collection required now -- it seems like this is new code whose purpose is unclear to me.", "author": "tdonohue", "createdAt": "2020-06-26T21:56:01Z", "path": "dspace-api/src/main/java/org/dspace/content/authority/ChoiceAuthorityServiceImpl.java", "diffHunk": "@@ -249,68 +301,89 @@ private void loadChoiceAuthorityConfigurations() {\n                     \"Skipping invalid configuration for \" + key + \" because named plugin not found: \" + authorityName);\n                 continue;\n             }\n-            if (!authorities.containsKey(authorityName)) {\n-                controller.put(fkey, ma);\n-                authorities.put(authorityName, fkey);\n+\n+            controller.put(fkey, ma);\n+            List<String> fkeys;\n+            if (authorities.containsKey(authorityName)) {\n+                fkeys = authorities.get(authorityName);\n             } else {\n-                log.warn(\n-                    \"Skipping invalid configuration for \" + key + \" because plugin is alredy in use: \" +\n-                        authorityName + \" used by \" + authorities\n-                        .get(authorityName));\n-                continue;\n+                fkeys = new ArrayList<String>();\n             }\n-\n+            fkeys.add(fkey);\n+            authorities.put(authorityName, fkeys);\n             log.debug(\"Choice Control: For field=\" + fkey + \", Plugin=\" + ma);\n         }\n         autoRegisterChoiceAuthorityFromInputReader();\n     }\n \n     private void autoRegisterChoiceAuthorityFromInputReader() {\n         try {\n+            List<SubmissionConfig> submissionConfigs = itemSubmissionConfigReader\n+                    .getAllSubmissionConfigs(Integer.MAX_VALUE, 0);\n             DCInputsReader dcInputsReader = new DCInputsReader();\n-            for (DCInputSet dcinputSet : dcInputsReader.getAllInputs(Integer.MAX_VALUE, 0)) {\n-                DCInput[][] dcinputs = dcinputSet.getFields();\n-                for (DCInput[] dcrows : dcinputs) {\n-                    for (DCInput dcinput : dcrows) {\n-                        if (StringUtils.isNotBlank(dcinput.getPairsType())\n-                            || StringUtils.isNotBlank(dcinput.getVocabulary())) {\n-                            String authorityName = dcinput.getPairsType();\n-                            if (StringUtils.isBlank(authorityName)) {\n-                                authorityName = dcinput.getVocabulary();\n-                            }\n-                            if (!StringUtils.equals(dcinput.getInputType(), \"qualdrop_value\")) {\n-                                String fieldKey = makeFieldKey(dcinput.getSchema(), dcinput.getElement(),\n-                                                               dcinput.getQualifier());\n-                                ChoiceAuthority ca = controller.get(authorityName);\n-                                if (ca == null) {\n-                                    InputFormSelfRegisterWrapperAuthority ifa = new\n-                                        InputFormSelfRegisterWrapperAuthority();\n-                                    if (controller.containsKey(fieldKey)) {\n-                                        ifa = (InputFormSelfRegisterWrapperAuthority) controller.get(fieldKey);\n+\n+            for (SubmissionConfig subCfg : submissionConfigs) {\n+                String submissionName = subCfg.getSubmissionName();\n+                List<DCInputSet> inputsBySubmissionName = dcInputsReader.getInputsBySubmissionName(submissionName);\n+                for (DCInputSet dcinputSet : inputsBySubmissionName) {\n+                    DCInput[][] dcinputs = dcinputSet.getFields();\n+                    for (DCInput[] dcrows : dcinputs) {\n+                        for (DCInput dcinput : dcrows) {\n+                            if (StringUtils.isNotBlank(dcinput.getPairsType())\n+                                || StringUtils.isNotBlank(dcinput.getVocabulary())) {\n+                                String authorityName = dcinput.getPairsType();\n+                                if (StringUtils.isBlank(authorityName)) {\n+                                    authorityName = dcinput.getVocabulary();\n+                                }\n+                                if (!StringUtils.equals(dcinput.getInputType(), \"qualdrop_value\")) {\n+                                    String fieldKey = makeFieldKey(dcinput.getSchema(), dcinput.getElement(),\n+                                                                   dcinput.getQualifier());\n+                                    ChoiceAuthority ca = controller.get(authorityName);\n+                                    if (ca == null) {\n+                                        ca = (ChoiceAuthority) pluginService\n+                                            .getNamedPlugin(ChoiceAuthority.class, authorityName);\n+                                        if (ca == null) {\n+                                            throw new IllegalStateException(\"Invalid configuration for \" + fieldKey\n+                                                    + \" in submission definition \" + submissionName\n+                                                    + \", form definition \" + dcinputSet.getFormName()\n+                                                    + \" no named plugin found: \" + authorityName);\n+                                        }\n                                     }\n \n-                                    ChoiceAuthority ma = (ChoiceAuthority) pluginService\n-                                        .getNamedPlugin(ChoiceAuthority.class, authorityName);\n-                                    if (ma == null) {\n-                                        log.warn(\"Skipping invalid configuration for \" + fieldKey\n-                                                     + \" because named plugin not found: \" + authorityName);\n-                                        continue;\n+                                    Map<String, ChoiceAuthority> definition2authority;\n+                                    if (controllerFormDefinitions.containsKey(fieldKey)) {\n+                                        definition2authority = controllerFormDefinitions.get(fieldKey);\n+                                    } else {\n+                                        definition2authority = new HashMap<String, ChoiceAuthority>();\n+                                    }\n+                                    definition2authority.put(submissionName, ca);\n+                                    controllerFormDefinitions.put(fieldKey, definition2authority);", "originalCommit": "322b56b42275c0fdc2cdd7809ee653acab4392d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjkxMzM4MA==", "url": "https://github.com/DSpace/DSpace/pull/2792#discussion_r446913380", "bodyText": "hi @tdonohue\nno this is used to fix the previous implementation where essentially we have forced all the metadata that were linked to a value-pairs to became really authority controlled (with also the side effect to store the authority) regardless to the collection. With this more flexible structure we know can discriminate between real authority controlled metadata and metadata that for specific collection (or better collection definitions) require controlled vocabularies (without storing the authority).\nThe collection and metadata params are required for the existing method signatures in the ChoiceAuthority that has been retained to avoid additional refactoring (see also my comment in the rest contract DSpace/RestContract#128 (comment) )", "author": "abollini", "createdAt": "2020-06-29T11:56:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQyNzk5OQ=="}], "type": "inlineReview", "revised_code": {"commit": "8fd328855a69c711ea48cecaff7c911788dc15ff", "chunk": "diff --git a/dspace-api/src/main/java/org/dspace/content/authority/ChoiceAuthorityServiceImpl.java b/dspace-api/src/main/java/org/dspace/content/authority/ChoiceAuthorityServiceImpl.java\nindex 5e15d4d74..7d4b2e0da 100644\n--- a/dspace-api/src/main/java/org/dspace/content/authority/ChoiceAuthorityServiceImpl.java\n+++ b/dspace-api/src/main/java/org/dspace/content/authority/ChoiceAuthorityServiceImpl.java\n\n@@ -316,66 +317,54 @@ public final class ChoiceAuthorityServiceImpl implements ChoiceAuthorityService\n         autoRegisterChoiceAuthorityFromInputReader();\n     }\n \n+    /**\n+     * This method will register all the authorities that are required due to the\n+     * submission forms configuration. This includes authorities for value pairs and\n+     * xml vocabularies\n+     */\n     private void autoRegisterChoiceAuthorityFromInputReader() {\n         try {\n             List<SubmissionConfig> submissionConfigs = itemSubmissionConfigReader\n                     .getAllSubmissionConfigs(Integer.MAX_VALUE, 0);\n             DCInputsReader dcInputsReader = new DCInputsReader();\n \n+            // loop over all the defined item submission configuration\n             for (SubmissionConfig subCfg : submissionConfigs) {\n                 String submissionName = subCfg.getSubmissionName();\n                 List<DCInputSet> inputsBySubmissionName = dcInputsReader.getInputsBySubmissionName(submissionName);\n+                // loop over the submission forms configuration eventually associated with the submission panel\n                 for (DCInputSet dcinputSet : inputsBySubmissionName) {\n                     DCInput[][] dcinputs = dcinputSet.getFields();\n                     for (DCInput[] dcrows : dcinputs) {\n                         for (DCInput dcinput : dcrows) {\n+                            // for each input in the form check if it is associated with a real value pairs\n+                            // or an xml vocabulary\n+                            String authorityName = null;\n                             if (StringUtils.isNotBlank(dcinput.getPairsType())\n-                                || StringUtils.isNotBlank(dcinput.getVocabulary())) {\n-                                String authorityName = dcinput.getPairsType();\n-                                if (StringUtils.isBlank(authorityName)) {\n-                                    authorityName = dcinput.getVocabulary();\n-                                }\n-                                if (!StringUtils.equals(dcinput.getInputType(), \"qualdrop_value\")) {\n-                                    String fieldKey = makeFieldKey(dcinput.getSchema(), dcinput.getElement(),\n-                                                                   dcinput.getQualifier());\n-                                    ChoiceAuthority ca = controller.get(authorityName);\n-                                    if (ca == null) {\n-                                        ca = (ChoiceAuthority) pluginService\n-                                            .getNamedPlugin(ChoiceAuthority.class, authorityName);\n-                                        if (ca == null) {\n-                                            throw new IllegalStateException(\"Invalid configuration for \" + fieldKey\n-                                                    + \" in submission definition \" + submissionName\n-                                                    + \", form definition \" + dcinputSet.getFormName()\n-                                                    + \" no named plugin found: \" + authorityName);\n-                                        }\n-                                    }\n-\n-                                    Map<String, ChoiceAuthority> definition2authority;\n-                                    if (controllerFormDefinitions.containsKey(fieldKey)) {\n-                                        definition2authority = controllerFormDefinitions.get(fieldKey);\n-                                    } else {\n-                                        definition2authority = new HashMap<String, ChoiceAuthority>();\n-                                    }\n-                                    definition2authority.put(submissionName, ca);\n-                                    controllerFormDefinitions.put(fieldKey, definition2authority);\n-\n-                                    Map<String, List<String>> authorityName2definitions;\n-                                    if (authoritiesFormDefinitions.containsKey(authorityName)) {\n-                                        authorityName2definitions = authoritiesFormDefinitions.get(authorityName);\n-                                    } else {\n-                                        authorityName2definitions = new HashMap<String, List<String>>();\n-                                    }\n+                                    && !StringUtils.equals(dcinput.getInputType(), \"qualdrop_value\")) {\n+                                authorityName = dcinput.getPairsType();\n+                            } else if (StringUtils.isNotBlank(dcinput.getVocabulary())) {\n+                                authorityName = dcinput.getVocabulary();\n+                            }\n \n-                                    List<String> fields;\n-                                    if (authorityName2definitions.containsKey(submissionName)) {\n-                                        fields = authorityName2definitions.get(submissionName);\n-                                    } else {\n-                                        fields = new ArrayList<String>();\n+                            // do we have an authority?\n+                            if (StringUtils.isNotBlank(authorityName)) {\n+                                String fieldKey = makeFieldKey(dcinput.getSchema(), dcinput.getElement(),\n+                                                               dcinput.getQualifier());\n+                                ChoiceAuthority ca = controller.get(authorityName);\n+                                if (ca == null) {\n+                                    ca = (ChoiceAuthority) pluginService\n+                                        .getNamedPlugin(ChoiceAuthority.class, authorityName);\n+                                    if (ca == null) {\n+                                        throw new IllegalStateException(\"Invalid configuration for \" + fieldKey\n+                                                + \" in submission definition \" + submissionName\n+                                                + \", form definition \" + dcinputSet.getFormName()\n+                                                + \" no named plugin found: \" + authorityName);\n                                     }\n-                                    fields.add(fieldKey);\n-                                    authorityName2definitions.put(submissionName, fields);\n-                                    authoritiesFormDefinitions.put(authorityName, authorityName2definitions);\n                                 }\n+\n+                                addAuthorityToFormCacheMap(submissionName, fieldKey, ca);\n+                                addFormDetailsToAuthorityCacheMap(submissionName, authorityName, fieldKey);\n                             }\n                         }\n                     }\n"}}, {"oid": "ff1b40d85998ebe6e2ec671dddcff0c20d228c7b", "url": "https://github.com/DSpace/DSpace/commit/ff1b40d85998ebe6e2ec671dddcff0c20d228c7b", "message": "remove unused attributes", "committedDate": "2020-06-29T14:18:05Z", "type": "commit"}, {"oid": "cfe8954a6b5f31e03482e1cb4878b7a1c79f0361", "url": "https://github.com/DSpace/DSpace/commit/cfe8954a6b5f31e03482e1cb4878b7a1c79f0361", "message": "Merge branch 'master' of https://github.com/DSpace/DSpace into draft_vocabulary", "committedDate": "2020-06-29T14:18:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzU0MzIwNA==", "url": "https://github.com/DSpace/DSpace/pull/2792#discussion_r447543204", "bodyText": "Can you add detail about what a non-selectable value is", "author": "benbosman", "createdAt": "2020-06-30T09:26:00Z", "path": "dspace-api/src/main/java/org/dspace/content/authority/Choice.java", "diffHunk": "@@ -33,6 +33,11 @@\n      */\n     public String value = null;\n \n+    /**\n+     * A boolean representing if choice entry value can selected", "originalCommit": "cfe8954a6b5f31e03482e1cb4878b7a1c79f0361", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5a0844429a8704826e4bd7d2c2454120b5765d9a", "chunk": "diff --git a/dspace-api/src/main/java/org/dspace/content/authority/Choice.java b/dspace-api/src/main/java/org/dspace/content/authority/Choice.java\nindex ff09e7553..697642798 100644\n--- a/dspace-api/src/main/java/org/dspace/content/authority/Choice.java\n+++ b/dspace-api/src/main/java/org/dspace/content/authority/Choice.java\n\n@@ -34,7 +34,10 @@ public class Choice {\n     public String value = null;\n \n     /**\n-     * A boolean representing if choice entry value can selected\n+     * A boolean representing if choice entry value can selected (usually true).\n+     * Hierarchical authority can flag some choice as not selectable to force the\n+     * use to choice a more detailed terms in the tree, such a leaf or a deeper\n+     * branch\n      */\n     public boolean selectable = true;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzU0NTk2OA==", "url": "https://github.com/DSpace/DSpace/pull/2792#discussion_r447545968", "bodyText": "This is missing JavaDocs", "author": "benbosman", "createdAt": "2020-06-30T09:30:23Z", "path": "dspace-api/src/main/java/org/dspace/content/authority/ChoiceAuthority.java", "diffHunk": "@@ -67,12 +70,27 @@\n      * This may get called many times while populating a Web page so it should\n      * be implemented as efficiently as possible.\n      *\n-     * @param field  being matched for\n      * @param key    authority key known to this authority.\n      * @param locale explicit localization key if available, or null\n      * @return descriptive label - should always return something, never null.\n      */\n-    public String getLabel(String field, String key, String locale);\n+    public String getLabel(String key, String locale);\n+\n+    /**\n+     * Get the canonical value to store for a key in the authority. Can be localized\n+     * given the implicit or explicit locale specification.\n+     *\n+     * @param key    authority key known to this authority.\n+     * @param locale explicit localization key if available, or null\n+     * @return value to store - should always return something, never null.\n+     */\n+    default String getValue(String key, String locale) {\n+        return getLabel(key, locale);\n+    }\n+\n+    default Map<String, String> getExtra(String key, String locale) {", "originalCommit": "cfe8954a6b5f31e03482e1cb4878b7a1c79f0361", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjgwNDYzMg==", "url": "https://github.com/DSpace/DSpace/pull/2792#discussion_r456804632", "bodyText": "added here https://github.com/DSpace/DSpace/pull/2792/files#diff-9c20f907127a0be2bb72deabb692ef38R88-R94", "author": "abollini", "createdAt": "2020-07-18T16:18:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzU0NTk2OA=="}], "type": "inlineReview", "revised_code": {"commit": "5a0844429a8704826e4bd7d2c2454120b5765d9a", "chunk": "diff --git a/dspace-api/src/main/java/org/dspace/content/authority/ChoiceAuthority.java b/dspace-api/src/main/java/org/dspace/content/authority/ChoiceAuthority.java\nindex a3bfeb9e8..ff196e2b7 100644\n--- a/dspace-api/src/main/java/org/dspace/content/authority/ChoiceAuthority.java\n+++ b/dspace-api/src/main/java/org/dspace/content/authority/ChoiceAuthority.java\n\n@@ -88,18 +88,45 @@ public interface ChoiceAuthority {\n         return getLabel(key, locale);\n     }\n \n+    /**\n+     * Get a map of additional information related to the specified key in the\n+     * authority.\n+     * \n+     * @param key    the key of the entry\n+     * @param locale explicit localization key if available, or null\n+     * @return a map of additional information related to the key\n+     */\n     default Map<String, String> getExtra(String key, String locale) {\n         return new HashMap<String, String>();\n     }\n \n+    /**\n+     * Return true for hierarchical authorities\n+     * \n+     * @return <code>true</code> if hierarchical, default <code>false</code>\n+     */\n     default boolean isHierarchical() {\n         return false;\n     }\n \n+    /**\n+     * Scrollable authorities allows the scroll of the entries without applying\n+     * filter/query to the\n+     * {@link #getMatches(String, String, Collection, int, int, String)}\n+     * \n+     * @return <code>true</code> if scrollable, default <code>false</code>\n+     */\n     default boolean isScrollable() {\n         return false;\n     }\n \n+    /**\n+     * Hierarchical authority can provide an hint for the UI about how many levels\n+     * preload to improve the UX. It provides a valid default for hierarchical\n+     * authorities\n+     * \n+     * @return <code>0</code> if hierarchical, null otherwise\n+     */\n     default Integer getPreloadLevel() {\n         return isHierarchical() ? 0 : null;\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg3Mzg1MQ==", "url": "https://github.com/DSpace/DSpace/pull/2792#discussion_r447873851", "bodyText": "Please add JavaDocs to explain preload level", "author": "tdonohue", "createdAt": "2020-06-30T17:54:04Z", "path": "dspace-api/src/main/java/org/dspace/content/authority/ChoiceAuthority.java", "diffHunk": "@@ -82,16 +100,16 @@ default boolean isScrollable() {\n         return false;\n     }\n \n-    default boolean hasIdentifier() {\n-        return true;\n+    default Integer getPreloadLevel() {", "originalCommit": "cfe8954a6b5f31e03482e1cb4878b7a1c79f0361", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjgwNDY3Ng==", "url": "https://github.com/DSpace/DSpace/pull/2792#discussion_r456804676", "bodyText": "added here https://github.com/DSpace/DSpace/pull/2792/files#diff-9c20f907127a0be2bb72deabb692ef38R119-R126", "author": "abollini", "createdAt": "2020-07-18T16:19:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg3Mzg1MQ=="}], "type": "inlineReview", "revised_code": {"commit": "5a0844429a8704826e4bd7d2c2454120b5765d9a", "chunk": "diff --git a/dspace-api/src/main/java/org/dspace/content/authority/ChoiceAuthority.java b/dspace-api/src/main/java/org/dspace/content/authority/ChoiceAuthority.java\nindex a3bfeb9e8..ff196e2b7 100644\n--- a/dspace-api/src/main/java/org/dspace/content/authority/ChoiceAuthority.java\n+++ b/dspace-api/src/main/java/org/dspace/content/authority/ChoiceAuthority.java\n\n@@ -88,18 +88,45 @@ public interface ChoiceAuthority {\n         return getLabel(key, locale);\n     }\n \n+    /**\n+     * Get a map of additional information related to the specified key in the\n+     * authority.\n+     * \n+     * @param key    the key of the entry\n+     * @param locale explicit localization key if available, or null\n+     * @return a map of additional information related to the key\n+     */\n     default Map<String, String> getExtra(String key, String locale) {\n         return new HashMap<String, String>();\n     }\n \n+    /**\n+     * Return true for hierarchical authorities\n+     * \n+     * @return <code>true</code> if hierarchical, default <code>false</code>\n+     */\n     default boolean isHierarchical() {\n         return false;\n     }\n \n+    /**\n+     * Scrollable authorities allows the scroll of the entries without applying\n+     * filter/query to the\n+     * {@link #getMatches(String, String, Collection, int, int, String)}\n+     * \n+     * @return <code>true</code> if scrollable, default <code>false</code>\n+     */\n     default boolean isScrollable() {\n         return false;\n     }\n \n+    /**\n+     * Hierarchical authority can provide an hint for the UI about how many levels\n+     * preload to improve the UX. It provides a valid default for hierarchical\n+     * authorities\n+     * \n+     * @return <code>0</code> if hierarchical, null otherwise\n+     */\n     default Integer getPreloadLevel() {\n         return isHierarchical() ? 0 : null;\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg3Mzk3MQ==", "url": "https://github.com/DSpace/DSpace/pull/2792#discussion_r447873971", "bodyText": "Please add Javadocs here too", "author": "tdonohue", "createdAt": "2020-06-30T17:54:15Z", "path": "dspace-api/src/main/java/org/dspace/content/authority/ChoiceAuthority.java", "diffHunk": "@@ -82,16 +100,16 @@ default boolean isScrollable() {\n         return false;\n     }\n \n-    default boolean hasIdentifier() {\n-        return true;\n+    default Integer getPreloadLevel() {\n+        return isHierarchical() ? 0 : null;\n     }\n \n-    default public Choice getChoice(String fieldKey, String authKey, String locale) {\n+    default public Choice getChoice(String authKey, String locale) {", "originalCommit": "cfe8954a6b5f31e03482e1cb4878b7a1c79f0361", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjgwNDcwMQ==", "url": "https://github.com/DSpace/DSpace/pull/2792#discussion_r456804701", "bodyText": "added here https://github.com/DSpace/DSpace/pull/2792/files#diff-9c20f907127a0be2bb72deabb692ef38R119-R126", "author": "abollini", "createdAt": "2020-07-18T16:19:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg3Mzk3MQ=="}], "type": "inlineReview", "revised_code": {"commit": "5a0844429a8704826e4bd7d2c2454120b5765d9a", "chunk": "diff --git a/dspace-api/src/main/java/org/dspace/content/authority/ChoiceAuthority.java b/dspace-api/src/main/java/org/dspace/content/authority/ChoiceAuthority.java\nindex a3bfeb9e8..ff196e2b7 100644\n--- a/dspace-api/src/main/java/org/dspace/content/authority/ChoiceAuthority.java\n+++ b/dspace-api/src/main/java/org/dspace/content/authority/ChoiceAuthority.java\n\n@@ -88,18 +88,45 @@ public interface ChoiceAuthority {\n         return getLabel(key, locale);\n     }\n \n+    /**\n+     * Get a map of additional information related to the specified key in the\n+     * authority.\n+     * \n+     * @param key    the key of the entry\n+     * @param locale explicit localization key if available, or null\n+     * @return a map of additional information related to the key\n+     */\n     default Map<String, String> getExtra(String key, String locale) {\n         return new HashMap<String, String>();\n     }\n \n+    /**\n+     * Return true for hierarchical authorities\n+     * \n+     * @return <code>true</code> if hierarchical, default <code>false</code>\n+     */\n     default boolean isHierarchical() {\n         return false;\n     }\n \n+    /**\n+     * Scrollable authorities allows the scroll of the entries without applying\n+     * filter/query to the\n+     * {@link #getMatches(String, String, Collection, int, int, String)}\n+     * \n+     * @return <code>true</code> if scrollable, default <code>false</code>\n+     */\n     default boolean isScrollable() {\n         return false;\n     }\n \n+    /**\n+     * Hierarchical authority can provide an hint for the UI about how many levels\n+     * preload to improve the UX. It provides a valid default for hierarchical\n+     * authorities\n+     * \n+     * @return <code>0</code> if hierarchical, null otherwise\n+     */\n     default Integer getPreloadLevel() {\n         return isHierarchical() ? 0 : null;\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg3NzM5Mw==", "url": "https://github.com/DSpace/DSpace/pull/2792#discussion_r447877393", "bodyText": "Could we add a description to this JavaDocs?  I'm not sure I know what a \"Parent Choice\" is....maybe the parent in the hierarchy?", "author": "tdonohue", "createdAt": "2020-06-30T17:59:52Z", "path": "dspace-api/src/main/java/org/dspace/content/authority/service/ChoiceAuthorityService.java", "diffHunk": "@@ -173,4 +172,47 @@ public Choices getBestMatch(String fieldKey, String query, Collection collection\n      */\n     public void clearCache();\n \n+    /**\n+     * Should we store the authority key (if any) for such field key and collection?\n+     * \n+     * @param fieldKey   single string identifying metadata field\n+     * @param collection Collection owner of Item or where the item is submitted to\n+     * @return true if the configuration allows to store the authority value\n+     */\n+    public boolean storeAuthority(String fieldKey, Collection collection);\n+\n+    /**\n+     * Wrapper that calls getChoicesByParent method of the plugin.\n+     *\n+     * @param authorityName authority name\n+     * @param parentId      parent Id\n+     * @param start         choice at which to start, 0 is first.\n+     * @param limit         maximum number of choices to return, 0 for no limit.\n+     * @param locale        explicit localization key if available, or null\n+     * @return a Choices object (never null).\n+     * @see org.dspace.content.authority.ChoiceAuthority#getChoicesByParent(java.lang.String, java.lang.String,\n+     *  int, int, java.lang.String)\n+     */\n+    public Choices getChoicesByParent(String authorityName, String parentId, int start, int limit, String locale);\n+\n+    /**\n+     * Wrapper that calls getTopChoices method of the plugin.\n+     *\n+     * @param authorityName authority name\n+     * @param start         choice at which to start, 0 is first.\n+     * @param limit         maximum number of choices to return, 0 for no limit.\n+     * @param locale        explicit localization key if available, or null\n+     * @return a Choices object (never null).\n+     * @see org.dspace.content.authority.ChoiceAuthority#getTopChoices(java.lang.String, int, int, java.lang.String)\n+     */\n+    public Choices getTopChoices(String authorityName, int start, int limit, String locale);\n+\n+    /**\n+     *\n+     * @param authorityName authority name\n+     * @param vocabularyId  child id\n+     * @param locale        explicit localization key if available, or null\n+     * @return the parent Choice object if any\n+     */\n+    public Choice getParentChoice(String authorityName, String vocabularyId, String locale);", "originalCommit": "cfe8954a6b5f31e03482e1cb4878b7a1c79f0361", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjgwNDc5Ng==", "url": "https://github.com/DSpace/DSpace/pull/2792#discussion_r456804796", "bodyText": "added here https://github.com/DSpace/DSpace/pull/2792/files#diff-52f85bc6d10ca3376c18c0d76e37dd0bR216-R219", "author": "abollini", "createdAt": "2020-07-18T16:20:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg3NzM5Mw=="}], "type": "inlineReview", "revised_code": {"commit": "5a0844429a8704826e4bd7d2c2454120b5765d9a", "chunk": "diff --git a/dspace-api/src/main/java/org/dspace/content/authority/service/ChoiceAuthorityService.java b/dspace-api/src/main/java/org/dspace/content/authority/service/ChoiceAuthorityService.java\nindex bfcee338b..335a837ee 100644\n--- a/dspace-api/src/main/java/org/dspace/content/authority/service/ChoiceAuthorityService.java\n+++ b/dspace-api/src/main/java/org/dspace/content/authority/service/ChoiceAuthorityService.java\n\n@@ -208,7 +208,9 @@ public interface ChoiceAuthorityService {\n     public Choices getTopChoices(String authorityName, int start, int limit, String locale);\n \n     /**\n-     *\n+     * Return the direct parent of an entry identified by its id in an hierarchical\n+     * authority.\n+     * \n      * @param authorityName authority name\n      * @param vocabularyId  child id\n      * @param locale        explicit localization key if available, or null\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg3OTIwMA==", "url": "https://github.com/DSpace/DSpace/pull/2792#discussion_r447879200", "bodyText": "Please add JavaDocs here too", "author": "tdonohue", "createdAt": "2020-06-30T18:02:55Z", "path": "dspace-api/src/main/java/org/dspace/content/authority/HierarchicalAuthority.java", "diffHunk": "@@ -0,0 +1,79 @@\n+/**\n+ * The contents of this file are subject to the license and copyright\n+ * detailed in the LICENSE and NOTICE files at the root of the source\n+ * tree and available online at\n+ *\n+ * http://www.dspace.org/license/\n+ */\n+package org.dspace.content.authority;\n+\n+/**\n+ * Plugin interface that supplies an authority control mechanism for\n+ * one metadata field.\n+ *\n+ * @author Larry Stone\n+ * @see ChoiceAuthority\n+ */\n+public interface HierarchicalAuthority extends ChoiceAuthority {\n+\n+    /**\n+     * Get all values from the authority that match the preferred value.\n+     * Note that the offering was entered by the user and may contain\n+     * mixed/incorrect case, whitespace, etc so the plugin should be careful\n+     * to clean up user data before making comparisons.\n+     *\n+     * Value of a \"Name\" field will be in canonical DSpace person name format,\n+     * which is \"Lastname, Firstname(s)\", e.g. \"Smith, John Q.\".\n+     *\n+     * Some authorities with a small set of values may simply return the whole\n+     * set for any sample value, although it's a good idea to set the\n+     * defaultSelected index in the Choices instance to the choice, if any,\n+     * that matches the value.\n+     *\n+     * @param authorityName  authority name\n+     * @param start          choice at which to start, 0 is first.\n+     * @param limit          maximum number of choices to return, 0 for no limit.\n+     * @param locale         explicit localization key if available, or null\n+     * @return a Choices object (never null).\n+     */\n+    public Choices getTopChoices(String authorityName, int start, int limit, String locale);\n+\n+    /**\n+     * Get all values from the authority that match the preferred value.\n+     * Note that the offering was entered by the user and may contain\n+     * mixed/incorrect case, whitespace, etc so the plugin should be careful\n+     * to clean up user data before making comparisons.\n+     *\n+     * Value of a \"Name\" field will be in canonical DSpace person name format,\n+     * which is \"Lastname, Firstname(s)\", e.g. \"Smith, John Q.\".\n+     *\n+     * Some authorities with a small set of values may simply return the whole\n+     * set for any sample value, although it's a good idea to set the\n+     * defaultSelected index in the Choices instance to the choice, if any,\n+     * that matches the value.\n+     *\n+     * @param authorityName  authority name\n+     * @param parentId       user's value to match\n+     * @param start          choice at which to start, 0 is first.\n+     * @param limit          maximum number of choices to return, 0 for no limit.\n+     * @param locale         explicit localization key if available, or null\n+     * @return a Choices object (never null).\n+     */\n+    public Choices getChoicesByParent(String authorityName, String parentId, int start, int limit, String locale);\n+\n+    /**\n+     *\n+     * @param authorityName  authority name\n+     * @param vocabularyId   user's value to match\n+     * @param locale         explicit localization key if available, or null\n+     * @return a Choice object\n+     */\n+    public Choice getParentChoice(String authorityName, String vocabularyId, String locale);\n+\n+    public Integer getPreloadLevel();", "originalCommit": "cfe8954a6b5f31e03482e1cb4878b7a1c79f0361", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjgwNDkzMg==", "url": "https://github.com/DSpace/DSpace/pull/2792#discussion_r456804932", "bodyText": "added here https://github.com/DSpace/DSpace/pull/2792/files#diff-9431ce54ec36c5dcf6b23ad8bad9ae9cR75-R76", "author": "abollini", "createdAt": "2020-07-18T16:21:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg3OTIwMA=="}], "type": "inlineReview", "revised_code": {"commit": "5a0844429a8704826e4bd7d2c2454120b5765d9a", "chunk": "diff --git a/dspace-api/src/main/java/org/dspace/content/authority/HierarchicalAuthority.java b/dspace-api/src/main/java/org/dspace/content/authority/HierarchicalAuthority.java\nindex 279f62d22..ac6c59e9d 100644\n--- a/dspace-api/src/main/java/org/dspace/content/authority/HierarchicalAuthority.java\n+++ b/dspace-api/src/main/java/org/dspace/content/authority/HierarchicalAuthority.java\n\n@@ -70,8 +70,13 @@ public interface HierarchicalAuthority extends ChoiceAuthority {\n      */\n     public Choice getParentChoice(String authorityName, String vocabularyId, String locale);\n \n+    /**\n+     * Provides an hint for the UI to preload some levels to improve the UX. It\n+     * usually mean that these preloaded level will be shown expanded by default\n+     */\n     public Integer getPreloadLevel();\n \n+    @Override\n     default boolean isHierarchical() {\n         return true;\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg3OTY4NA==", "url": "https://github.com/DSpace/DSpace/pull/2792#discussion_r447879684", "bodyText": "Can you add a description to these JavaDocs.  I realize this is likely just returning the parent choice of the given entry, but it'd be nice to add that to the description.", "author": "tdonohue", "createdAt": "2020-06-30T18:03:45Z", "path": "dspace-api/src/main/java/org/dspace/content/authority/HierarchicalAuthority.java", "diffHunk": "@@ -0,0 +1,79 @@\n+/**\n+ * The contents of this file are subject to the license and copyright\n+ * detailed in the LICENSE and NOTICE files at the root of the source\n+ * tree and available online at\n+ *\n+ * http://www.dspace.org/license/\n+ */\n+package org.dspace.content.authority;\n+\n+/**\n+ * Plugin interface that supplies an authority control mechanism for\n+ * one metadata field.\n+ *\n+ * @author Larry Stone\n+ * @see ChoiceAuthority\n+ */\n+public interface HierarchicalAuthority extends ChoiceAuthority {\n+\n+    /**\n+     * Get all values from the authority that match the preferred value.\n+     * Note that the offering was entered by the user and may contain\n+     * mixed/incorrect case, whitespace, etc so the plugin should be careful\n+     * to clean up user data before making comparisons.\n+     *\n+     * Value of a \"Name\" field will be in canonical DSpace person name format,\n+     * which is \"Lastname, Firstname(s)\", e.g. \"Smith, John Q.\".\n+     *\n+     * Some authorities with a small set of values may simply return the whole\n+     * set for any sample value, although it's a good idea to set the\n+     * defaultSelected index in the Choices instance to the choice, if any,\n+     * that matches the value.\n+     *\n+     * @param authorityName  authority name\n+     * @param start          choice at which to start, 0 is first.\n+     * @param limit          maximum number of choices to return, 0 for no limit.\n+     * @param locale         explicit localization key if available, or null\n+     * @return a Choices object (never null).\n+     */\n+    public Choices getTopChoices(String authorityName, int start, int limit, String locale);\n+\n+    /**\n+     * Get all values from the authority that match the preferred value.\n+     * Note that the offering was entered by the user and may contain\n+     * mixed/incorrect case, whitespace, etc so the plugin should be careful\n+     * to clean up user data before making comparisons.\n+     *\n+     * Value of a \"Name\" field will be in canonical DSpace person name format,\n+     * which is \"Lastname, Firstname(s)\", e.g. \"Smith, John Q.\".\n+     *\n+     * Some authorities with a small set of values may simply return the whole\n+     * set for any sample value, although it's a good idea to set the\n+     * defaultSelected index in the Choices instance to the choice, if any,\n+     * that matches the value.\n+     *\n+     * @param authorityName  authority name\n+     * @param parentId       user's value to match\n+     * @param start          choice at which to start, 0 is first.\n+     * @param limit          maximum number of choices to return, 0 for no limit.\n+     * @param locale         explicit localization key if available, or null\n+     * @return a Choices object (never null).\n+     */\n+    public Choices getChoicesByParent(String authorityName, String parentId, int start, int limit, String locale);\n+\n+    /**\n+     *\n+     * @param authorityName  authority name\n+     * @param vocabularyId   user's value to match\n+     * @param locale         explicit localization key if available, or null\n+     * @return a Choice object\n+     */\n+    public Choice getParentChoice(String authorityName, String vocabularyId, String locale);", "originalCommit": "cfe8954a6b5f31e03482e1cb4878b7a1c79f0361", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjgwNDg5OQ==", "url": "https://github.com/DSpace/DSpace/pull/2792#discussion_r456804899", "bodyText": "https://github.com/DSpace/DSpace/pull/2792/files#diff-9431ce54ec36c5dcf6b23ad8bad9ae9cR65", "author": "abollini", "createdAt": "2020-07-18T16:21:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg3OTY4NA=="}], "type": "inlineReview", "revised_code": {"commit": "5a0844429a8704826e4bd7d2c2454120b5765d9a", "chunk": "diff --git a/dspace-api/src/main/java/org/dspace/content/authority/HierarchicalAuthority.java b/dspace-api/src/main/java/org/dspace/content/authority/HierarchicalAuthority.java\nindex 279f62d22..ac6c59e9d 100644\n--- a/dspace-api/src/main/java/org/dspace/content/authority/HierarchicalAuthority.java\n+++ b/dspace-api/src/main/java/org/dspace/content/authority/HierarchicalAuthority.java\n\n@@ -70,8 +70,13 @@ public interface HierarchicalAuthority extends ChoiceAuthority {\n      */\n     public Choice getParentChoice(String authorityName, String vocabularyId, String locale);\n \n+    /**\n+     * Provides an hint for the UI to preload some levels to improve the UX. It\n+     * usually mean that these preloaded level will be shown expanded by default\n+     */\n     public Integer getPreloadLevel();\n \n+    @Override\n     default boolean isHierarchical() {\n         return true;\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg4MDA0OA==", "url": "https://github.com/DSpace/DSpace/pull/2792#discussion_r447880048", "bodyText": "Again, please add a description to this JavaDocs", "author": "tdonohue", "createdAt": "2020-06-30T18:04:23Z", "path": "dspace-api/src/main/java/org/dspace/content/authority/service/ChoiceAuthorityService.java", "diffHunk": "@@ -173,4 +172,47 @@ public Choices getBestMatch(String fieldKey, String query, Collection collection\n      */\n     public void clearCache();\n \n+    /**\n+     * Should we store the authority key (if any) for such field key and collection?\n+     * \n+     * @param fieldKey   single string identifying metadata field\n+     * @param collection Collection owner of Item or where the item is submitted to\n+     * @return true if the configuration allows to store the authority value\n+     */\n+    public boolean storeAuthority(String fieldKey, Collection collection);\n+\n+    /**\n+     * Wrapper that calls getChoicesByParent method of the plugin.\n+     *\n+     * @param authorityName authority name\n+     * @param parentId      parent Id\n+     * @param start         choice at which to start, 0 is first.\n+     * @param limit         maximum number of choices to return, 0 for no limit.\n+     * @param locale        explicit localization key if available, or null\n+     * @return a Choices object (never null).\n+     * @see org.dspace.content.authority.ChoiceAuthority#getChoicesByParent(java.lang.String, java.lang.String,\n+     *  int, int, java.lang.String)\n+     */\n+    public Choices getChoicesByParent(String authorityName, String parentId, int start, int limit, String locale);\n+\n+    /**\n+     * Wrapper that calls getTopChoices method of the plugin.\n+     *\n+     * @param authorityName authority name\n+     * @param start         choice at which to start, 0 is first.\n+     * @param limit         maximum number of choices to return, 0 for no limit.\n+     * @param locale        explicit localization key if available, or null\n+     * @return a Choices object (never null).\n+     * @see org.dspace.content.authority.ChoiceAuthority#getTopChoices(java.lang.String, int, int, java.lang.String)\n+     */\n+    public Choices getTopChoices(String authorityName, int start, int limit, String locale);\n+\n+    /**\n+     *\n+     * @param authorityName authority name\n+     * @param vocabularyId  child id\n+     * @param locale        explicit localization key if available, or null\n+     * @return the parent Choice object if any\n+     */\n+    public Choice getParentChoice(String authorityName, String vocabularyId, String locale);", "originalCommit": "cfe8954a6b5f31e03482e1cb4878b7a1c79f0361", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjgwNTAwNQ==", "url": "https://github.com/DSpace/DSpace/pull/2792#discussion_r456805005", "bodyText": "https://github.com/DSpace/DSpace/pull/2792/files#diff-52f85bc6d10ca3376c18c0d76e37dd0bR217-R218", "author": "abollini", "createdAt": "2020-07-18T16:22:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg4MDA0OA=="}], "type": "inlineReview", "revised_code": {"commit": "5a0844429a8704826e4bd7d2c2454120b5765d9a", "chunk": "diff --git a/dspace-api/src/main/java/org/dspace/content/authority/service/ChoiceAuthorityService.java b/dspace-api/src/main/java/org/dspace/content/authority/service/ChoiceAuthorityService.java\nindex bfcee338b..335a837ee 100644\n--- a/dspace-api/src/main/java/org/dspace/content/authority/service/ChoiceAuthorityService.java\n+++ b/dspace-api/src/main/java/org/dspace/content/authority/service/ChoiceAuthorityService.java\n\n@@ -208,7 +208,9 @@ public interface ChoiceAuthorityService {\n     public Choices getTopChoices(String authorityName, int start, int limit, String locale);\n \n     /**\n-     *\n+     * Return the direct parent of an entry identified by its id in an hierarchical\n+     * authority.\n+     * \n      * @param authorityName authority name\n      * @param vocabularyId  child id\n      * @param locale        explicit localization key if available, or null\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg4MjQ5Nw==", "url": "https://github.com/DSpace/DSpace/pull/2792#discussion_r447882497", "bodyText": "Please add JavaDocs to this new method", "author": "tdonohue", "createdAt": "2020-06-30T18:08:46Z", "path": "dspace-server-webapp/src/main/java/org/dspace/app/rest/utils/AuthorityUtils.java", "diffHunk": "@@ -62,9 +64,33 @@ public String getPresentation(String schema, String element, String qualifier) {\n      * @param projection the name of the projection to use, or {@code null}.\n      * @return\n      */\n-    public AuthorityEntryRest convertEntry(Choice choice, String authorityName, Projection projection) {\n-        AuthorityEntryRest entry = converter.toRest(choice, projection);\n-        entry.setAuthorityName(authorityName);\n+    public VocabularyEntryDetailsRest convertEntryDetails(Choice choice, String authorityName,\n+           boolean isHierarchical, Projection projection) {\n+        if (choice == null) {\n+            return null;\n+        }\n+        VocabularyEntryDetailsRest entry = converter.toRest(choice, projection);\n+        entry.setVocabularyName(authorityName);\n+        entry.setId(authorityName + \":\" + entry.getId());\n+        entry.setInHierarchicalVocabulary(isHierarchical);\n+        return entry;\n+    }\n+\n+    public VocabularyEntryRest convertEntry(Choice choice, String authorityName, boolean storeAuthority,", "originalCommit": "cfe8954a6b5f31e03482e1cb4878b7a1c79f0361", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjgwNTA0Mw==", "url": "https://github.com/DSpace/DSpace/pull/2792#discussion_r456805043", "bodyText": "https://github.com/DSpace/DSpace/pull/2792/files#diff-ce27772ea06f500b5b5d75b318f8369aR82-R92", "author": "abollini", "createdAt": "2020-07-18T16:23:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg4MjQ5Nw=="}], "type": "inlineReview", "revised_code": {"commit": "5a0844429a8704826e4bd7d2c2454120b5765d9a", "chunk": "diff --git a/dspace-server-webapp/src/main/java/org/dspace/app/rest/utils/AuthorityUtils.java b/dspace-server-webapp/src/main/java/org/dspace/app/rest/utils/AuthorityUtils.java\nindex 22e1ff610..fc54fe194 100644\n--- a/dspace-server-webapp/src/main/java/org/dspace/app/rest/utils/AuthorityUtils.java\n+++ b/dspace-server-webapp/src/main/java/org/dspace/app/rest/utils/AuthorityUtils.java\n\n@@ -76,6 +76,18 @@ public class AuthorityUtils {\n         return entry;\n     }\n \n+    /**\n+     * This utility method is currently a workaround to enrich the REST object with\n+     * information from the parent vocabulary that is not referenced by the Choice\n+     * model\n+     * \n+     * @param choice         the dspace-api choice to expose as vocabulary entry\n+     * @param authorityName  the name of the vocabulary\n+     * @param storeAuthority <code>true</code> if the entry id should be exposed as\n+     *                       an authority for storing it in the metadatavalue\n+     * @param projection     the rest projection to apply\n+     * @return the vocabulary entry rest reppresentation of the provided choice\n+     */\n     public VocabularyEntryRest convertEntry(Choice choice, String authorityName, boolean storeAuthority,\n             Projection projection) {\n         if (choice == null) {\n"}}, {"oid": "6333fdc499e73c23da778a51edac27d00be4ccda", "url": "https://github.com/DSpace/DSpace/commit/6333fdc499e73c23da778a51edac27d00be4ccda", "message": "Add test to check links in the vocabulary entry details and relative fix", "committedDate": "2020-06-30T19:43:57Z", "type": "commit"}, {"oid": "e4c98b4742309511eb96b2ed844a928508ba7dc0", "url": "https://github.com/DSpace/DSpace/commit/e4c98b4742309511eb96b2ed844a928508ba7dc0", "message": "Fixed issue with DSpaceControlledVocabulary getBestMatch", "committedDate": "2020-07-01T19:34:09Z", "type": "commit"}, {"oid": "5a0844429a8704826e4bd7d2c2454120b5765d9a", "url": "https://github.com/DSpace/DSpace/commit/5a0844429a8704826e4bd7d2c2454120b5765d9a", "message": "Add missing javadocs", "committedDate": "2020-07-01T21:12:34Z", "type": "commit"}, {"oid": "18bc3e1fcba23d00c3d113e7eb085d12f59d40ad", "url": "https://github.com/DSpace/DSpace/commit/18bc3e1fcba23d00c3d113e7eb085d12f59d40ad", "message": "Refactor the ChoiceAuthority to remove the unnecessary dependency from the field and collection", "committedDate": "2020-07-02T17:54:37Z", "type": "commit"}, {"oid": "675c975d2940fe48c15c71044b108668c5a86ea1", "url": "https://github.com/DSpace/DSpace/commit/675c975d2940fe48c15c71044b108668c5a86ea1", "message": "Use a more explicit name for the storeAuthorityInMetadata method", "committedDate": "2020-07-02T19:11:56Z", "type": "commit"}, {"oid": "e0f1991200150232e708cfbdeaf6ff9cc8d89c82", "url": "https://github.com/DSpace/DSpace/commit/e0f1991200150232e708cfbdeaf6ff9cc8d89c82", "message": "Merge pull request #157 from 4Science/vocabulary_withoutparams\n\nRefactor the ChoiceAuthority to remove the unnecessary dependency from the field and collection", "committedDate": "2020-07-09T11:28:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDI5NTY4Mg==", "url": "https://github.com/DSpace/DSpace/pull/2792#discussion_r454295682", "bodyText": "A public constructor needs JavaDocs", "author": "benbosman", "createdAt": "2020-07-14T11:42:39Z", "path": "dspace-api/src/main/java/org/dspace/content/authority/Choice.java", "diffHunk": "@@ -50,4 +55,11 @@ public Choice(String authority, String label, String value, Map<String, String>\n         this.value = value;\n         this.extras = extras;\n     }\n+\n+    public Choice(String authority, String label, String value, boolean selectable) {", "originalCommit": "cfe8954a6b5f31e03482e1cb4878b7a1c79f0361", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjgwNTEwMA==", "url": "https://github.com/DSpace/DSpace/pull/2792#discussion_r456805100", "bodyText": "added https://github.com/DSpace/DSpace/pull/2792/files#diff-6dccf7cd3668879cf16acce7548d638fR78-R87", "author": "abollini", "createdAt": "2020-07-18T16:23:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDI5NTY4Mg=="}], "type": "inlineReview", "revised_code": {"commit": "8fd328855a69c711ea48cecaff7c911788dc15ff", "chunk": "diff --git a/dspace-api/src/main/java/org/dspace/content/authority/Choice.java b/dspace-api/src/main/java/org/dspace/content/authority/Choice.java\nindex ff09e7553..6d73bdb5e 100644\n--- a/dspace-api/src/main/java/org/dspace/content/authority/Choice.java\n+++ b/dspace-api/src/main/java/org/dspace/content/authority/Choice.java\n\n@@ -43,12 +46,28 @@ public class Choice {\n     public Choice() {\n     }\n \n+    /**\n+     * Minimal constructor for this data object. It assumes an empty map of extras\n+     * information and a selected choice\n+     * \n+     * @param authority the authority key\n+     * @param value     the text value to store in the metadata\n+     * @param label     the value to display to the user\n+     */\n     public Choice(String authority, String value, String label) {\n         this.authority = authority;\n         this.value = value;\n         this.label = label;\n     }\n \n+    /**\n+     * Constructor to quickly setup the data object for basic authorities. The choice is assumed to be selectable.\n+     * \n+     * @param authority the authority key\n+     * @param value     the text value to store in the metadata\n+     * @param label     the value to display to the user\n+     * @param extras    a key value map of extra information related to this choice\n+     */\n     public Choice(String authority, String label, String value, Map<String, String> extras) {\n         this.authority = authority;\n         this.label = label;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDMwMzM1NQ==", "url": "https://github.com/DSpace/DSpace/pull/2792#discussion_r454303355", "bodyText": "Can you add a message, otherwise the stack trace is lost", "author": "benbosman", "createdAt": "2020-07-14T11:58:22Z", "path": "dspace-api/src/main/java/org/dspace/content/authority/ChoiceAuthorityServiceImpl.java", "diffHunk": "@@ -249,68 +301,89 @@ private void loadChoiceAuthorityConfigurations() {\n                     \"Skipping invalid configuration for \" + key + \" because named plugin not found: \" + authorityName);\n                 continue;\n             }\n-            if (!authorities.containsKey(authorityName)) {\n-                controller.put(fkey, ma);\n-                authorities.put(authorityName, fkey);\n+\n+            controller.put(fkey, ma);\n+            List<String> fkeys;\n+            if (authorities.containsKey(authorityName)) {\n+                fkeys = authorities.get(authorityName);\n             } else {\n-                log.warn(\n-                    \"Skipping invalid configuration for \" + key + \" because plugin is alredy in use: \" +\n-                        authorityName + \" used by \" + authorities\n-                        .get(authorityName));\n-                continue;\n+                fkeys = new ArrayList<String>();\n             }\n-\n+            fkeys.add(fkey);\n+            authorities.put(authorityName, fkeys);\n             log.debug(\"Choice Control: For field=\" + fkey + \", Plugin=\" + ma);\n         }\n         autoRegisterChoiceAuthorityFromInputReader();\n     }\n \n     private void autoRegisterChoiceAuthorityFromInputReader() {\n         try {\n+            List<SubmissionConfig> submissionConfigs = itemSubmissionConfigReader\n+                    .getAllSubmissionConfigs(Integer.MAX_VALUE, 0);\n             DCInputsReader dcInputsReader = new DCInputsReader();\n-            for (DCInputSet dcinputSet : dcInputsReader.getAllInputs(Integer.MAX_VALUE, 0)) {\n-                DCInput[][] dcinputs = dcinputSet.getFields();\n-                for (DCInput[] dcrows : dcinputs) {\n-                    for (DCInput dcinput : dcrows) {\n-                        if (StringUtils.isNotBlank(dcinput.getPairsType())\n-                            || StringUtils.isNotBlank(dcinput.getVocabulary())) {\n-                            String authorityName = dcinput.getPairsType();\n-                            if (StringUtils.isBlank(authorityName)) {\n-                                authorityName = dcinput.getVocabulary();\n-                            }\n-                            if (!StringUtils.equals(dcinput.getInputType(), \"qualdrop_value\")) {\n-                                String fieldKey = makeFieldKey(dcinput.getSchema(), dcinput.getElement(),\n-                                                               dcinput.getQualifier());\n-                                ChoiceAuthority ca = controller.get(authorityName);\n-                                if (ca == null) {\n-                                    InputFormSelfRegisterWrapperAuthority ifa = new\n-                                        InputFormSelfRegisterWrapperAuthority();\n-                                    if (controller.containsKey(fieldKey)) {\n-                                        ifa = (InputFormSelfRegisterWrapperAuthority) controller.get(fieldKey);\n+\n+            for (SubmissionConfig subCfg : submissionConfigs) {\n+                String submissionName = subCfg.getSubmissionName();\n+                List<DCInputSet> inputsBySubmissionName = dcInputsReader.getInputsBySubmissionName(submissionName);\n+                for (DCInputSet dcinputSet : inputsBySubmissionName) {\n+                    DCInput[][] dcinputs = dcinputSet.getFields();\n+                    for (DCInput[] dcrows : dcinputs) {\n+                        for (DCInput dcinput : dcrows) {\n+                            if (StringUtils.isNotBlank(dcinput.getPairsType())\n+                                || StringUtils.isNotBlank(dcinput.getVocabulary())) {\n+                                String authorityName = dcinput.getPairsType();\n+                                if (StringUtils.isBlank(authorityName)) {\n+                                    authorityName = dcinput.getVocabulary();\n+                                }\n+                                if (!StringUtils.equals(dcinput.getInputType(), \"qualdrop_value\")) {\n+                                    String fieldKey = makeFieldKey(dcinput.getSchema(), dcinput.getElement(),\n+                                                                   dcinput.getQualifier());\n+                                    ChoiceAuthority ca = controller.get(authorityName);\n+                                    if (ca == null) {\n+                                        ca = (ChoiceAuthority) pluginService\n+                                            .getNamedPlugin(ChoiceAuthority.class, authorityName);\n+                                        if (ca == null) {\n+                                            throw new IllegalStateException(\"Invalid configuration for \" + fieldKey\n+                                                    + \" in submission definition \" + submissionName\n+                                                    + \", form definition \" + dcinputSet.getFormName()\n+                                                    + \" no named plugin found: \" + authorityName);\n+                                        }\n                                     }\n \n-                                    ChoiceAuthority ma = (ChoiceAuthority) pluginService\n-                                        .getNamedPlugin(ChoiceAuthority.class, authorityName);\n-                                    if (ma == null) {\n-                                        log.warn(\"Skipping invalid configuration for \" + fieldKey\n-                                                     + \" because named plugin not found: \" + authorityName);\n-                                        continue;\n+                                    Map<String, ChoiceAuthority> definition2authority;\n+                                    if (controllerFormDefinitions.containsKey(fieldKey)) {\n+                                        definition2authority = controllerFormDefinitions.get(fieldKey);\n+                                    } else {\n+                                        definition2authority = new HashMap<String, ChoiceAuthority>();\n+                                    }\n+                                    definition2authority.put(submissionName, ca);\n+                                    controllerFormDefinitions.put(fieldKey, definition2authority);\n+\n+                                    Map<String, List<String>> authorityName2definitions;\n+                                    if (authoritiesFormDefinitions.containsKey(authorityName)) {\n+                                        authorityName2definitions = authoritiesFormDefinitions.get(authorityName);\n+                                    } else {\n+                                        authorityName2definitions = new HashMap<String, List<String>>();\n                                     }\n-                                    ifa.getDelegates().put(dcinputSet.getFormName(), ma);\n-                                    controller.put(fieldKey, ifa);\n-                                }\n \n-                                if (!authorities.containsKey(authorityName)) {\n-                                    authorities.put(authorityName, fieldKey);\n+                                    List<String> fields;\n+                                    if (authorityName2definitions.containsKey(submissionName)) {\n+                                        fields = authorityName2definitions.get(submissionName);\n+                                    } else {\n+                                        fields = new ArrayList<String>();\n+                                    }\n+                                    fields.add(fieldKey);\n+                                    authorityName2definitions.put(submissionName, fields);\n+                                    authoritiesFormDefinitions.put(authorityName, authorityName2definitions);\n                                 }\n-\n                             }\n                         }\n                     }\n                 }\n             }\n         } catch (DCInputsReaderException e) {\n-            throw new IllegalStateException(e.getMessage(), e);\n+            // the system is in an illegal state as the submission definition is not valid\n+            throw new IllegalStateException(e);", "originalCommit": "cfe8954a6b5f31e03482e1cb4878b7a1c79f0361", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjgwNTQ5NQ==", "url": "https://github.com/DSpace/DSpace/pull/2792#discussion_r456805495", "bodyText": "b232def", "author": "abollini", "createdAt": "2020-07-18T16:28:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDMwMzM1NQ=="}], "type": "inlineReview", "revised_code": {"commit": "8fd328855a69c711ea48cecaff7c911788dc15ff", "chunk": "diff --git a/dspace-api/src/main/java/org/dspace/content/authority/ChoiceAuthorityServiceImpl.java b/dspace-api/src/main/java/org/dspace/content/authority/ChoiceAuthorityServiceImpl.java\nindex 5e15d4d74..7d4b2e0da 100644\n--- a/dspace-api/src/main/java/org/dspace/content/authority/ChoiceAuthorityServiceImpl.java\n+++ b/dspace-api/src/main/java/org/dspace/content/authority/ChoiceAuthorityServiceImpl.java\n\n@@ -316,66 +317,54 @@ public final class ChoiceAuthorityServiceImpl implements ChoiceAuthorityService\n         autoRegisterChoiceAuthorityFromInputReader();\n     }\n \n+    /**\n+     * This method will register all the authorities that are required due to the\n+     * submission forms configuration. This includes authorities for value pairs and\n+     * xml vocabularies\n+     */\n     private void autoRegisterChoiceAuthorityFromInputReader() {\n         try {\n             List<SubmissionConfig> submissionConfigs = itemSubmissionConfigReader\n                     .getAllSubmissionConfigs(Integer.MAX_VALUE, 0);\n             DCInputsReader dcInputsReader = new DCInputsReader();\n \n+            // loop over all the defined item submission configuration\n             for (SubmissionConfig subCfg : submissionConfigs) {\n                 String submissionName = subCfg.getSubmissionName();\n                 List<DCInputSet> inputsBySubmissionName = dcInputsReader.getInputsBySubmissionName(submissionName);\n+                // loop over the submission forms configuration eventually associated with the submission panel\n                 for (DCInputSet dcinputSet : inputsBySubmissionName) {\n                     DCInput[][] dcinputs = dcinputSet.getFields();\n                     for (DCInput[] dcrows : dcinputs) {\n                         for (DCInput dcinput : dcrows) {\n+                            // for each input in the form check if it is associated with a real value pairs\n+                            // or an xml vocabulary\n+                            String authorityName = null;\n                             if (StringUtils.isNotBlank(dcinput.getPairsType())\n-                                || StringUtils.isNotBlank(dcinput.getVocabulary())) {\n-                                String authorityName = dcinput.getPairsType();\n-                                if (StringUtils.isBlank(authorityName)) {\n-                                    authorityName = dcinput.getVocabulary();\n-                                }\n-                                if (!StringUtils.equals(dcinput.getInputType(), \"qualdrop_value\")) {\n-                                    String fieldKey = makeFieldKey(dcinput.getSchema(), dcinput.getElement(),\n-                                                                   dcinput.getQualifier());\n-                                    ChoiceAuthority ca = controller.get(authorityName);\n-                                    if (ca == null) {\n-                                        ca = (ChoiceAuthority) pluginService\n-                                            .getNamedPlugin(ChoiceAuthority.class, authorityName);\n-                                        if (ca == null) {\n-                                            throw new IllegalStateException(\"Invalid configuration for \" + fieldKey\n-                                                    + \" in submission definition \" + submissionName\n-                                                    + \", form definition \" + dcinputSet.getFormName()\n-                                                    + \" no named plugin found: \" + authorityName);\n-                                        }\n-                                    }\n-\n-                                    Map<String, ChoiceAuthority> definition2authority;\n-                                    if (controllerFormDefinitions.containsKey(fieldKey)) {\n-                                        definition2authority = controllerFormDefinitions.get(fieldKey);\n-                                    } else {\n-                                        definition2authority = new HashMap<String, ChoiceAuthority>();\n-                                    }\n-                                    definition2authority.put(submissionName, ca);\n-                                    controllerFormDefinitions.put(fieldKey, definition2authority);\n-\n-                                    Map<String, List<String>> authorityName2definitions;\n-                                    if (authoritiesFormDefinitions.containsKey(authorityName)) {\n-                                        authorityName2definitions = authoritiesFormDefinitions.get(authorityName);\n-                                    } else {\n-                                        authorityName2definitions = new HashMap<String, List<String>>();\n-                                    }\n+                                    && !StringUtils.equals(dcinput.getInputType(), \"qualdrop_value\")) {\n+                                authorityName = dcinput.getPairsType();\n+                            } else if (StringUtils.isNotBlank(dcinput.getVocabulary())) {\n+                                authorityName = dcinput.getVocabulary();\n+                            }\n \n-                                    List<String> fields;\n-                                    if (authorityName2definitions.containsKey(submissionName)) {\n-                                        fields = authorityName2definitions.get(submissionName);\n-                                    } else {\n-                                        fields = new ArrayList<String>();\n+                            // do we have an authority?\n+                            if (StringUtils.isNotBlank(authorityName)) {\n+                                String fieldKey = makeFieldKey(dcinput.getSchema(), dcinput.getElement(),\n+                                                               dcinput.getQualifier());\n+                                ChoiceAuthority ca = controller.get(authorityName);\n+                                if (ca == null) {\n+                                    ca = (ChoiceAuthority) pluginService\n+                                        .getNamedPlugin(ChoiceAuthority.class, authorityName);\n+                                    if (ca == null) {\n+                                        throw new IllegalStateException(\"Invalid configuration for \" + fieldKey\n+                                                + \" in submission definition \" + submissionName\n+                                                + \", form definition \" + dcinputSet.getFormName()\n+                                                + \" no named plugin found: \" + authorityName);\n                                     }\n-                                    fields.add(fieldKey);\n-                                    authorityName2definitions.put(submissionName, fields);\n-                                    authoritiesFormDefinitions.put(authorityName, authorityName2definitions);\n                                 }\n+\n+                                addAuthorityToFormCacheMap(submissionName, fieldKey, ca);\n+                                addFormDetailsToAuthorityCacheMap(submissionName, authorityName, fieldKey);\n                             }\n                         }\n                     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDMwNTQwMw==", "url": "https://github.com/DSpace/DSpace/pull/2792#discussion_r454305403", "bodyText": "This method is implemented in a way that makes it hard to read\nCan you split it in sub methods (with a meaningful name) and add some inline comments", "author": "benbosman", "createdAt": "2020-07-14T12:02:19Z", "path": "dspace-api/src/main/java/org/dspace/content/authority/ChoiceAuthorityServiceImpl.java", "diffHunk": "@@ -249,68 +301,89 @@ private void loadChoiceAuthorityConfigurations() {\n                     \"Skipping invalid configuration for \" + key + \" because named plugin not found: \" + authorityName);\n                 continue;\n             }\n-            if (!authorities.containsKey(authorityName)) {\n-                controller.put(fkey, ma);\n-                authorities.put(authorityName, fkey);\n+\n+            controller.put(fkey, ma);\n+            List<String> fkeys;\n+            if (authorities.containsKey(authorityName)) {\n+                fkeys = authorities.get(authorityName);\n             } else {\n-                log.warn(\n-                    \"Skipping invalid configuration for \" + key + \" because plugin is alredy in use: \" +\n-                        authorityName + \" used by \" + authorities\n-                        .get(authorityName));\n-                continue;\n+                fkeys = new ArrayList<String>();\n             }\n-\n+            fkeys.add(fkey);\n+            authorities.put(authorityName, fkeys);\n             log.debug(\"Choice Control: For field=\" + fkey + \", Plugin=\" + ma);\n         }\n         autoRegisterChoiceAuthorityFromInputReader();\n     }\n \n     private void autoRegisterChoiceAuthorityFromInputReader() {\n         try {\n+            List<SubmissionConfig> submissionConfigs = itemSubmissionConfigReader", "originalCommit": "cfe8954a6b5f31e03482e1cb4878b7a1c79f0361", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjgwNTU4OA==", "url": "https://github.com/DSpace/DSpace/pull/2792#discussion_r456805588", "bodyText": "done", "author": "abollini", "createdAt": "2020-07-18T16:29:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDMwNTQwMw=="}], "type": "inlineReview", "revised_code": {"commit": "8fd328855a69c711ea48cecaff7c911788dc15ff", "chunk": "diff --git a/dspace-api/src/main/java/org/dspace/content/authority/ChoiceAuthorityServiceImpl.java b/dspace-api/src/main/java/org/dspace/content/authority/ChoiceAuthorityServiceImpl.java\nindex 5e15d4d74..7d4b2e0da 100644\n--- a/dspace-api/src/main/java/org/dspace/content/authority/ChoiceAuthorityServiceImpl.java\n+++ b/dspace-api/src/main/java/org/dspace/content/authority/ChoiceAuthorityServiceImpl.java\n\n@@ -316,66 +317,54 @@ public final class ChoiceAuthorityServiceImpl implements ChoiceAuthorityService\n         autoRegisterChoiceAuthorityFromInputReader();\n     }\n \n+    /**\n+     * This method will register all the authorities that are required due to the\n+     * submission forms configuration. This includes authorities for value pairs and\n+     * xml vocabularies\n+     */\n     private void autoRegisterChoiceAuthorityFromInputReader() {\n         try {\n             List<SubmissionConfig> submissionConfigs = itemSubmissionConfigReader\n                     .getAllSubmissionConfigs(Integer.MAX_VALUE, 0);\n             DCInputsReader dcInputsReader = new DCInputsReader();\n \n+            // loop over all the defined item submission configuration\n             for (SubmissionConfig subCfg : submissionConfigs) {\n                 String submissionName = subCfg.getSubmissionName();\n                 List<DCInputSet> inputsBySubmissionName = dcInputsReader.getInputsBySubmissionName(submissionName);\n+                // loop over the submission forms configuration eventually associated with the submission panel\n                 for (DCInputSet dcinputSet : inputsBySubmissionName) {\n                     DCInput[][] dcinputs = dcinputSet.getFields();\n                     for (DCInput[] dcrows : dcinputs) {\n                         for (DCInput dcinput : dcrows) {\n+                            // for each input in the form check if it is associated with a real value pairs\n+                            // or an xml vocabulary\n+                            String authorityName = null;\n                             if (StringUtils.isNotBlank(dcinput.getPairsType())\n-                                || StringUtils.isNotBlank(dcinput.getVocabulary())) {\n-                                String authorityName = dcinput.getPairsType();\n-                                if (StringUtils.isBlank(authorityName)) {\n-                                    authorityName = dcinput.getVocabulary();\n-                                }\n-                                if (!StringUtils.equals(dcinput.getInputType(), \"qualdrop_value\")) {\n-                                    String fieldKey = makeFieldKey(dcinput.getSchema(), dcinput.getElement(),\n-                                                                   dcinput.getQualifier());\n-                                    ChoiceAuthority ca = controller.get(authorityName);\n-                                    if (ca == null) {\n-                                        ca = (ChoiceAuthority) pluginService\n-                                            .getNamedPlugin(ChoiceAuthority.class, authorityName);\n-                                        if (ca == null) {\n-                                            throw new IllegalStateException(\"Invalid configuration for \" + fieldKey\n-                                                    + \" in submission definition \" + submissionName\n-                                                    + \", form definition \" + dcinputSet.getFormName()\n-                                                    + \" no named plugin found: \" + authorityName);\n-                                        }\n-                                    }\n-\n-                                    Map<String, ChoiceAuthority> definition2authority;\n-                                    if (controllerFormDefinitions.containsKey(fieldKey)) {\n-                                        definition2authority = controllerFormDefinitions.get(fieldKey);\n-                                    } else {\n-                                        definition2authority = new HashMap<String, ChoiceAuthority>();\n-                                    }\n-                                    definition2authority.put(submissionName, ca);\n-                                    controllerFormDefinitions.put(fieldKey, definition2authority);\n-\n-                                    Map<String, List<String>> authorityName2definitions;\n-                                    if (authoritiesFormDefinitions.containsKey(authorityName)) {\n-                                        authorityName2definitions = authoritiesFormDefinitions.get(authorityName);\n-                                    } else {\n-                                        authorityName2definitions = new HashMap<String, List<String>>();\n-                                    }\n+                                    && !StringUtils.equals(dcinput.getInputType(), \"qualdrop_value\")) {\n+                                authorityName = dcinput.getPairsType();\n+                            } else if (StringUtils.isNotBlank(dcinput.getVocabulary())) {\n+                                authorityName = dcinput.getVocabulary();\n+                            }\n \n-                                    List<String> fields;\n-                                    if (authorityName2definitions.containsKey(submissionName)) {\n-                                        fields = authorityName2definitions.get(submissionName);\n-                                    } else {\n-                                        fields = new ArrayList<String>();\n+                            // do we have an authority?\n+                            if (StringUtils.isNotBlank(authorityName)) {\n+                                String fieldKey = makeFieldKey(dcinput.getSchema(), dcinput.getElement(),\n+                                                               dcinput.getQualifier());\n+                                ChoiceAuthority ca = controller.get(authorityName);\n+                                if (ca == null) {\n+                                    ca = (ChoiceAuthority) pluginService\n+                                        .getNamedPlugin(ChoiceAuthority.class, authorityName);\n+                                    if (ca == null) {\n+                                        throw new IllegalStateException(\"Invalid configuration for \" + fieldKey\n+                                                + \" in submission definition \" + submissionName\n+                                                + \", form definition \" + dcinputSet.getFormName()\n+                                                + \" no named plugin found: \" + authorityName);\n                                     }\n-                                    fields.add(fieldKey);\n-                                    authorityName2definitions.put(submissionName, fields);\n-                                    authoritiesFormDefinitions.put(authorityName, authorityName2definitions);\n                                 }\n+\n+                                addAuthorityToFormCacheMap(submissionName, fieldKey, ca);\n+                                addFormDetailsToAuthorityCacheMap(submissionName, authorityName, fieldKey);\n                             }\n                         }\n                     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM1Mjk5MA==", "url": "https://github.com/DSpace/DSpace/pull/2792#discussion_r454352990", "bodyText": "When using &embed=children this is failing", "author": "benbosman", "createdAt": "2020-07-14T13:24:26Z", "path": "dspace-server-webapp/src/main/java/org/dspace/app/rest/repository/VocabularyEntryDetailsChildrenLinkRepository.java", "diffHunk": "@@ -0,0 +1,77 @@\n+/**\n+ * The contents of this file are subject to the license and copyright\n+ * detailed in the LICENSE and NOTICE files at the root of the source\n+ * tree and available online at\n+ *\n+ * http://www.dspace.org/license/\n+ */\n+package org.dspace.app.rest.repository;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import javax.annotation.Nullable;\n+import javax.servlet.http.HttpServletRequest;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.dspace.app.rest.exception.LinkNotFoundException;\n+import org.dspace.app.rest.model.VocabularyEntryDetailsRest;\n+import org.dspace.app.rest.model.VocabularyRest;\n+import org.dspace.app.rest.projection.Projection;\n+import org.dspace.app.rest.utils.AuthorityUtils;\n+import org.dspace.content.authority.Choice;\n+import org.dspace.content.authority.ChoiceAuthority;\n+import org.dspace.content.authority.Choices;\n+import org.dspace.content.authority.service.ChoiceAuthorityService;\n+import org.dspace.core.Context;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.data.domain.Page;\n+import org.springframework.data.domain.PageImpl;\n+import org.springframework.data.domain.Pageable;\n+import org.springframework.security.access.prepost.PreAuthorize;\n+import org.springframework.stereotype.Component;\n+\n+/**\n+ * Link repository to expose the parent of a vocabulary entry details in an hierarchical vocabulary\n+ *\n+ * @author Mykhaylo Boychuk (4Science.it)\n+ */\n+@Component(VocabularyRest.CATEGORY + \".\" + VocabularyEntryDetailsRest.NAME + \".\" + VocabularyEntryDetailsRest.CHILDREN)\n+public class VocabularyEntryDetailsChildrenLinkRepository extends AbstractDSpaceRestRepository\n+    implements LinkRestRepository {\n+\n+    @Autowired\n+    private ChoiceAuthorityService choiceAuthorityService;\n+\n+    @Autowired\n+    private AuthorityUtils authorityUtils;\n+\n+    @PreAuthorize(\"hasAuthority('AUTHENTICATED')\")\n+    public Page<VocabularyEntryDetailsRest> getChildren(@Nullable HttpServletRequest request, String name,", "originalCommit": "cfe8954a6b5f31e03482e1cb4878b7a1c79f0361", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjgwNTcyMA==", "url": "https://github.com/DSpace/DSpace/pull/2792#discussion_r456805720", "bodyText": "I have added IT to proof the bug and the resolution https://github.com/DSpace/DSpace/pull/2792/files#diff-419fb149a897e45c9aeca57bf5d51d78R370", "author": "abollini", "createdAt": "2020-07-18T16:31:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM1Mjk5MA=="}], "type": "inlineReview", "revised_code": {"commit": "8fd328855a69c711ea48cecaff7c911788dc15ff", "chunk": "diff --git a/dspace-server-webapp/src/main/java/org/dspace/app/rest/repository/VocabularyEntryDetailsChildrenLinkRepository.java b/dspace-server-webapp/src/main/java/org/dspace/app/rest/repository/VocabularyEntryDetailsChildrenLinkRepository.java\nindex f9e8e5a7a..044710d25 100644\n--- a/dspace-server-webapp/src/main/java/org/dspace/app/rest/repository/VocabularyEntryDetailsChildrenLinkRepository.java\n+++ b/dspace-server-webapp/src/main/java/org/dspace/app/rest/repository/VocabularyEntryDetailsChildrenLinkRepository.java\n\n@@ -47,7 +47,7 @@ public class VocabularyEntryDetailsChildrenLinkRepository extends AbstractDSpace\n \n     @PreAuthorize(\"hasAuthority('AUTHENTICATED')\")\n     public Page<VocabularyEntryDetailsRest> getChildren(@Nullable HttpServletRequest request, String name,\n-                                                        @Nullable Pageable pageable, Projection projection) {\n+                                                        @Nullable Pageable optionalPageable, Projection projection) {\n \n         Context context = obtainContext();\n         String[] parts = StringUtils.split(name, \":\", 2);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM1NzkxOQ==", "url": "https://github.com/DSpace/DSpace/pull/2792#discussion_r454357919", "bodyText": "Can you add a link to /server/api/submission/vocabularyEntryDetails/search in the main endpoint. /server/api/submission/vocabularyEntryDetails is not supported", "author": "benbosman", "createdAt": "2020-07-14T13:31:53Z", "path": "dspace-server-webapp/src/main/java/org/dspace/app/rest/repository/VocabularyEntryDetailsRestRepository.java", "diffHunk": "@@ -0,0 +1,94 @@\n+/**\n+ * The contents of this file are subject to the license and copyright\n+ * detailed in the LICENSE and NOTICE files at the root of the source\n+ * tree and available online at\n+ *\n+ * http://www.dspace.org/license/\n+ */\n+package org.dspace.app.rest.repository;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.dspace.app.rest.Parameter;\n+import org.dspace.app.rest.SearchRestMethod;\n+import org.dspace.app.rest.exception.LinkNotFoundException;\n+import org.dspace.app.rest.exception.RepositoryMethodNotImplementedException;\n+import org.dspace.app.rest.model.ResourcePolicyRest;\n+import org.dspace.app.rest.model.VocabularyEntryDetailsRest;\n+import org.dspace.app.rest.model.VocabularyRest;\n+import org.dspace.app.rest.utils.AuthorityUtils;\n+import org.dspace.content.authority.Choice;\n+import org.dspace.content.authority.ChoiceAuthority;\n+import org.dspace.content.authority.Choices;\n+import org.dspace.content.authority.service.ChoiceAuthorityService;\n+import org.dspace.core.Context;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.data.domain.Page;\n+import org.springframework.data.domain.PageImpl;\n+import org.springframework.data.domain.Pageable;\n+import org.springframework.security.access.prepost.PreAuthorize;\n+import org.springframework.stereotype.Component;\n+\n+/**\n+ * Controller for exposition of vocabularies entry details for the submission\n+ *\n+ * @author Andrea Bollini (andrea.bollini at 4science.it)\n+ */\n+@Component(VocabularyRest.CATEGORY + \".\" + VocabularyEntryDetailsRest.NAME)\n+public class VocabularyEntryDetailsRestRepository extends DSpaceRestRepository<VocabularyEntryDetailsRest, String> {\n+\n+    @Autowired\n+    private ChoiceAuthorityService cas;\n+\n+    @Autowired\n+    private AuthorityUtils authorityUtils;\n+\n+    @PreAuthorize(\"hasAuthority('AUTHENTICATED')\")\n+    @Override\n+    public Page<VocabularyEntryDetailsRest> findAll(Context context, Pageable pageable) {\n+        throw new RepositoryMethodNotImplementedException(ResourcePolicyRest.NAME, \"findAll\");\n+    }\n+\n+    @PreAuthorize(\"hasAuthority('AUTHENTICATED')\")\n+    @Override\n+    public VocabularyEntryDetailsRest findOne(Context context, String name) {\n+        String[] parts = StringUtils.split(name, \":\", 2);\n+        if (parts.length != 2) {\n+            return null;\n+        }\n+        String vocabularyName = parts[0];\n+        String vocabularyId = parts[1];\n+        ChoiceAuthority source = cas.getChoiceAuthorityByAuthorityName(vocabularyName);\n+        Choice choice = source.getChoice(vocabularyId, context.getCurrentLocale().toString());\n+        return authorityUtils.convertEntryDetails(choice, vocabularyName, source.isHierarchical(),\n+                utils.obtainProjection());\n+    }\n+\n+    @SearchRestMethod(name = \"top\")\n+    @PreAuthorize(\"hasAuthority('AUTHENTICATED')\")\n+    public Page<VocabularyEntryDetailsRest> findAllTop(@Parameter(value = \"vocabulary\", required = true)", "originalCommit": "cfe8954a6b5f31e03482e1cb4878b7a1c79f0361", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM1ODM4MA==", "url": "https://github.com/DSpace/DSpace/pull/2792#discussion_r454358380", "bodyText": "Also, when testing this feature, I noticed the top elements have parents. That doesn't sound logical to me", "author": "benbosman", "createdAt": "2020-07-14T13:32:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM1NzkxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjgwNjk1NA==", "url": "https://github.com/DSpace/DSpace/pull/2792#discussion_r456806954", "bodyText": "https://github.com/DSpace/DSpace/pull/2792/files#diff-419fb149a897e45c9aeca57bf5d51d78R32 (BTW doing that I noted the issue reported here #2890 - this -search link is correct)\nfix and test for top elements https://github.com/DSpace/DSpace/pull/2792/files#diff-419fb149a897e45c9aeca57bf5d51d78R362", "author": "abollini", "createdAt": "2020-07-18T16:46:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM1NzkxOQ=="}], "type": "inlineReview", "revised_code": {"commit": "9863b1c6d53bc3002a3d246bcf40339853a2af4b", "chunk": "diff --git a/dspace-server-webapp/src/main/java/org/dspace/app/rest/repository/VocabularyEntryDetailsRestRepository.java b/dspace-server-webapp/src/main/java/org/dspace/app/rest/repository/VocabularyEntryDetailsRestRepository.java\nindex 620bb527b..5ac17b385 100644\n--- a/dspace-server-webapp/src/main/java/org/dspace/app/rest/repository/VocabularyEntryDetailsRestRepository.java\n+++ b/dspace-server-webapp/src/main/java/org/dspace/app/rest/repository/VocabularyEntryDetailsRestRepository.java\n\n@@ -8,9 +8,11 @@\n package org.dspace.app.rest.repository;\n \n import java.util.ArrayList;\n+import java.util.Arrays;\n import java.util.List;\n \n import org.apache.commons.lang3.StringUtils;\n+import org.dspace.app.rest.DiscoverableEndpointsService;\n import org.dspace.app.rest.Parameter;\n import org.dspace.app.rest.SearchRestMethod;\n import org.dspace.app.rest.exception.LinkNotFoundException;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM2MTc1Mw==", "url": "https://github.com/DSpace/DSpace/pull/2792#discussion_r454361753", "bodyText": "Is this supposed to say they're mutually exclusive?", "author": "benbosman", "createdAt": "2020-07-14T13:37:46Z", "path": "dspace-server-webapp/src/main/java/org/dspace/app/rest/repository/VocabularyEntryLinkRepository.java", "diffHunk": "@@ -0,0 +1,114 @@\n+/**\n+ * The contents of this file are subject to the license and copyright\n+ * detailed in the LICENSE and NOTICE files at the root of the source\n+ * tree and available online at\n+ *\n+ * http://www.dspace.org/license/\n+ */\n+package org.dspace.app.rest.repository;\n+\n+import java.sql.SQLException;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.UUID;\n+import javax.annotation.Nullable;\n+import javax.servlet.http.HttpServletRequest;\n+\n+import org.apache.commons.lang3.BooleanUtils;\n+import org.apache.commons.lang3.StringUtils;\n+import org.dspace.app.rest.exception.UnprocessableEntityException;\n+import org.dspace.app.rest.model.VocabularyEntryRest;\n+import org.dspace.app.rest.model.VocabularyRest;\n+import org.dspace.app.rest.projection.Projection;\n+import org.dspace.app.rest.utils.AuthorityUtils;\n+import org.dspace.content.Collection;\n+import org.dspace.content.authority.Choice;\n+import org.dspace.content.authority.Choices;\n+import org.dspace.content.authority.service.ChoiceAuthorityService;\n+import org.dspace.content.service.CollectionService;\n+import org.dspace.core.Context;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.data.domain.Page;\n+import org.springframework.data.domain.PageImpl;\n+import org.springframework.data.domain.Pageable;\n+import org.springframework.security.access.prepost.PreAuthorize;\n+import org.springframework.stereotype.Component;\n+\n+/**\n+ * Controller for exposition of authority services\n+ *\n+ * @author Luigi Andrea Pascarelli (luigiandrea.pascarelli at 4science.it)\n+ */\n+@Component(VocabularyRest.CATEGORY + \".\" + VocabularyRest.NAME + \".\" + VocabularyRest.ENTRIES)\n+public class VocabularyEntryLinkRepository extends AbstractDSpaceRestRepository\n+    implements LinkRestRepository {\n+\n+    @Autowired\n+    private ChoiceAuthorityService cas;\n+\n+    @Autowired\n+    private CollectionService cs;\n+\n+    @Autowired\n+    private AuthorityUtils authorityUtils;\n+\n+    @PreAuthorize(\"hasAuthority('AUTHENTICATED')\")\n+    public Page<VocabularyEntryRest> filter(@Nullable HttpServletRequest request, String name,\n+                                          @Nullable Pageable optionalPageable, Projection projection) {\n+        Context context = obtainContext();\n+        String exact = request == null ? null : request.getParameter(\"exact\");\n+        String filter = request == null ? null : request.getParameter(\"filter\");\n+        String entryID = request == null ? null : request.getParameter(\"entryID\");\n+        String metadata = request == null ? null : request.getParameter(\"metadata\");\n+        String uuidCollect\u00econ = request == null ? null : request.getParameter(\"collection\");\n+\n+        if (StringUtils.isEmpty(metadata) || StringUtils.isEmpty(uuidCollect\u00econ)) {\n+            throw new IllegalArgumentException(\"the metadata and collection parameters are both required\");\n+        }\n+\n+        if (StringUtils.isNotBlank(filter) && StringUtils.isNotBlank(entryID)) {\n+            throw new IllegalArgumentException(\"required only one of the parameters: filter or entryID\");", "originalCommit": "cfe8954a6b5f31e03482e1cb4878b7a1c79f0361", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjgwNjk3MQ==", "url": "https://github.com/DSpace/DSpace/pull/2792#discussion_r456806971", "bodyText": "thanks reworded as by your suggestion", "author": "abollini", "createdAt": "2020-07-18T16:46:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM2MTc1Mw=="}], "type": "inlineReview", "revised_code": {"commit": "8fd328855a69c711ea48cecaff7c911788dc15ff", "chunk": "diff --git a/dspace-server-webapp/src/main/java/org/dspace/app/rest/repository/VocabularyEntryLinkRepository.java b/dspace-server-webapp/src/main/java/org/dspace/app/rest/repository/VocabularyEntryLinkRepository.java\nindex e18fc35d8..9d75ef87c 100644\n--- a/dspace-server-webapp/src/main/java/org/dspace/app/rest/repository/VocabularyEntryLinkRepository.java\n+++ b/dspace-server-webapp/src/main/java/org/dspace/app/rest/repository/VocabularyEntryLinkRepository.java\n\n@@ -7,10 +7,8 @@\n  */\n package org.dspace.app.rest.repository;\n \n-import java.sql.SQLException;\n import java.util.ArrayList;\n import java.util.List;\n-import java.util.UUID;\n import javax.annotation.Nullable;\n import javax.servlet.http.HttpServletRequest;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM2OTcwMg==", "url": "https://github.com/DSpace/DSpace/pull/2792#discussion_r454369702", "bodyText": "Can you also add a test for an actual authority control, e.g. the solr authority control", "author": "benbosman", "createdAt": "2020-07-14T13:48:55Z", "path": "dspace-server-webapp/src/test/java/org/dspace/app/rest/SubmissionFormsControllerIT.java", "diffHunk": "@@ -139,6 +139,32 @@ public void findTraditionalPageOneWithNewlyCreatedAccountTest() throws Exception\n                                         \"col-sm-8\",\"dc.publisher\"))));\n     }\n \n+    @Test\n+    public void findFieldWithValuePairsConfig() throws Exception {", "originalCommit": "cfe8954a6b5f31e03482e1cb4878b7a1c79f0361", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjgwNzA3MA==", "url": "https://github.com/DSpace/DSpace/pull/2792#discussion_r456807070", "bodyText": "https://github.com/DSpace/DSpace/pull/2792/files#diff-600cb0614b36ea51ac367c78c57a61d4R163", "author": "abollini", "createdAt": "2020-07-18T16:47:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM2OTcwMg=="}], "type": "inlineReview", "revised_code": {"commit": "769dd064d09fb90fe491dab8a397a040bc6ada4f", "chunk": "diff --git a/dspace-server-webapp/src/test/java/org/dspace/app/rest/SubmissionFormsControllerIT.java b/dspace-server-webapp/src/test/java/org/dspace/app/rest/SubmissionFormsControllerIT.java\nindex dee7d4c61..30e13c54d 100644\n--- a/dspace-server-webapp/src/test/java/org/dspace/app/rest/SubmissionFormsControllerIT.java\n+++ b/dspace-server-webapp/src/test/java/org/dspace/app/rest/SubmissionFormsControllerIT.java\n\n@@ -139,6 +159,95 @@ public class SubmissionFormsControllerIT extends AbstractControllerIntegrationTe\n                                         \"col-sm-8\",\"dc.publisher\"))));\n     }\n \n+    @Test\n+    public void findFieldWithAuthorityConfig() throws Exception {\n+        configurationService.setProperty(\"plugin.named.org.dspace.content.authority.ChoiceAuthority\",\n+                new String[] {\n+                    \"org.dspace.content.authority.SolrAuthority = SolrAuthorAuthority\",\n+                    \"org.dspace.content.authority.SolrAuthority = SolrEditorAuthority\",\n+                    \"org.dspace.content.authority.SolrAuthority = SolrSubjectAuthority\"\n+                });\n+\n+        configurationService.setProperty(\"solr.authority.server\",\n+                \"${solr.server}/authority\");\n+        configurationService.setProperty(\"choices.plugin.dc.contributor.author\",\n+                \"SolrAuthorAuthority\");\n+        configurationService.setProperty(\"choices.presentation.dc.contributor.author\",\n+                \"suggest\");\n+        configurationService.setProperty(\"authority.controlled.dc.contributor.author\",\n+                \"true\");\n+        configurationService.setProperty(\"authority.author.indexer.field.1\",\n+                \"dc.contributor.author\");\n+        configurationService.setProperty(\"choices.plugin.dc.contributor.editor\",\n+                \"SolrEditorAuthority\");\n+        configurationService.setProperty(\"choices.presentation.dc.contributor.editor\",\n+                \"authorLookup\");\n+        configurationService.setProperty(\"authority.controlled.dc.contributor.editor\",\n+                \"true\");\n+        configurationService.setProperty(\"authority.author.indexer.field.2\",\n+                \"dc.contributor.editor\");\n+        configurationService.setProperty(\"choices.plugin.dc.subject\",\n+                \"SolrSubjectAuthority\");\n+        configurationService.setProperty(\"choices.presentation.dc.subject\",\n+                \"lookup\");\n+        configurationService.setProperty(\"authority.controlled.dc.subject\",\n+                \"true\");\n+        configurationService.setProperty(\"authority.author.indexer.field.3\",\n+                \"dc.subject\");\n+\n+        // These clears have to happen so that the config is actually reloaded in those classes. This is needed for\n+        // the properties that we're altering above and this is only used within the tests\n+        submissionFormRestRepository.reload();\n+        DCInputAuthority.reset();\n+        pluginService.clearNamedPluginClasses();\n+        cas.clearCache();\n+\n+        String token = getAuthToken(admin.getEmail(), password);\n+\n+        getClient(token).perform(get(\"/api/config/submissionforms/sampleauthority\"))\n+                        //The status has to be 200 OK\n+                        .andExpect(status().isOk())\n+                        //We expect the content type to be \"application/hal+json;charset=UTF-8\"\n+                        .andExpect(content().contentType(contentType))\n+                        //Check that the JSON root matches the expected \"sampleauthority\" input forms\n+                        .andExpect(jsonPath(\"$.id\", is(\"sampleauthority\")))\n+                        .andExpect(jsonPath(\"$.name\", is(\"sampleauthority\")))\n+                        .andExpect(jsonPath(\"$.type\", is(\"submissionform\")))\n+                        .andExpect(jsonPath(\"$._links.self.href\", Matchers\n+                            .startsWith(REST_SERVER_URL + \"config/submissionforms/sampleauthority\")))\n+                        // our test configuration include the dc.contributor.author, dc.contributor.editor and\n+                        // dc.subject fields with in separate rows all linked to an authority with different\n+                        // presentation modes (suggestion, name-lookup, lookup)\n+                        .andExpect(jsonPath(\"$.rows[0].fields\", contains(\n+                                SubmissionFormFieldMatcher.matchFormFieldDefinition(\"onebox\", \"Author\",\n+                                        null, true,\n+                                \"Author field that can be associated with an authority providing suggestion\",\n+                                null, \"dc.contributor.author\", \"SolrAuthorAuthority\")\n+                            )))\n+                        .andExpect(jsonPath(\"$.rows[1].fields\", contains(\n+                                SubmissionFormFieldMatcher.matchFormFieldDefinition(\"lookup-name\", \"Editor\",\n+                                        null, false,\n+                                \"Editor field that can be associated with an authority \"\n+                                + \"providing the special name lookup\",\n+                                null, \"dc.contributor.editor\", \"SolrEditorAuthority\")\n+                            )))\n+                        .andExpect(jsonPath(\"$.rows[2].fields\", contains(\n+                                SubmissionFormFieldMatcher.matchFormFieldDefinition(\"lookup\", \"Subject\",\n+                                        null, true,\n+                                \"Subject field that can be associated with an authority providing lookup\",\n+                                null, \"dc.subject\", \"SolrSubjectAuthority\")\n+                            )))\n+                        ;\n+        // we need to force a reload of the config now to be able to reload also the cache of the other\n+        // authority related services. As this is needed just by this test method it is more efficient do it\n+        // here instead that force these reload for each method extending the destroy method\n+        configurationService.reloadConfig();\n+        submissionFormRestRepository.reload();\n+        DCInputAuthority.reset();\n+        pluginService.clearNamedPluginClasses();\n+        cas.clearCache();\n+    }\n+\n     @Test\n     public void findFieldWithValuePairsConfig() throws Exception {\n         String token = getAuthToken(admin.getEmail(), password);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM4MjM0Mg==", "url": "https://github.com/DSpace/DSpace/pull/2792#discussion_r454382342", "bodyText": "If the name contains a /, it seems this is not correctly escaped in the links to this endpoint (e.g. the entry-id in /api/submission/vocabularyEntryDetails/<:vocabulary-name>:<:entry-id> contains the /)", "author": "benbosman", "createdAt": "2020-07-14T14:06:40Z", "path": "dspace-server-webapp/src/main/java/org/dspace/app/rest/repository/VocabularyEntryDetailsRestRepository.java", "diffHunk": "@@ -0,0 +1,94 @@\n+/**\n+ * The contents of this file are subject to the license and copyright\n+ * detailed in the LICENSE and NOTICE files at the root of the source\n+ * tree and available online at\n+ *\n+ * http://www.dspace.org/license/\n+ */\n+package org.dspace.app.rest.repository;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.dspace.app.rest.Parameter;\n+import org.dspace.app.rest.SearchRestMethod;\n+import org.dspace.app.rest.exception.LinkNotFoundException;\n+import org.dspace.app.rest.exception.RepositoryMethodNotImplementedException;\n+import org.dspace.app.rest.model.ResourcePolicyRest;\n+import org.dspace.app.rest.model.VocabularyEntryDetailsRest;\n+import org.dspace.app.rest.model.VocabularyRest;\n+import org.dspace.app.rest.utils.AuthorityUtils;\n+import org.dspace.content.authority.Choice;\n+import org.dspace.content.authority.ChoiceAuthority;\n+import org.dspace.content.authority.Choices;\n+import org.dspace.content.authority.service.ChoiceAuthorityService;\n+import org.dspace.core.Context;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.data.domain.Page;\n+import org.springframework.data.domain.PageImpl;\n+import org.springframework.data.domain.Pageable;\n+import org.springframework.security.access.prepost.PreAuthorize;\n+import org.springframework.stereotype.Component;\n+\n+/**\n+ * Controller for exposition of vocabularies entry details for the submission\n+ *\n+ * @author Andrea Bollini (andrea.bollini at 4science.it)\n+ */\n+@Component(VocabularyRest.CATEGORY + \".\" + VocabularyEntryDetailsRest.NAME)\n+public class VocabularyEntryDetailsRestRepository extends DSpaceRestRepository<VocabularyEntryDetailsRest, String> {\n+\n+    @Autowired\n+    private ChoiceAuthorityService cas;\n+\n+    @Autowired\n+    private AuthorityUtils authorityUtils;\n+\n+    @PreAuthorize(\"hasAuthority('AUTHENTICATED')\")\n+    @Override\n+    public Page<VocabularyEntryDetailsRest> findAll(Context context, Pageable pageable) {\n+        throw new RepositoryMethodNotImplementedException(ResourcePolicyRest.NAME, \"findAll\");\n+    }\n+\n+    @PreAuthorize(\"hasAuthority('AUTHENTICATED')\")\n+    @Override\n+    public VocabularyEntryDetailsRest findOne(Context context, String name) {", "originalCommit": "cfe8954a6b5f31e03482e1cb4878b7a1c79f0361", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjgwNzgwNw==", "url": "https://github.com/DSpace/DSpace/pull/2792#discussion_r456807807", "bodyText": "I made some tests, it is not supported right now and it seems complex to manage (I have a branch here with some experiments - see last commits https://github.com/abollini/DSpace/tree/IDwithSlash ).\nThere are at least two different issues with that:\n\nspring boot set by default a filter that prevent / to be urlencoded to enhance security. This can be configured (disabled) and solved.\nalso doing that the spring url mapping is confused by the / as it is decoded before to check the mapping and this will lead to match against our /{rel} subpath (i.e. /api/submission/vocabularyEntryDetails/vname:entryidwith/something will search for link repository named something)\n\nas there are not authority implementations so far that have a / in the authority ID I recommend to avoid to deal with this extra complexity until we have a real use case. The solution could be to replace the / in the authority ID in the entry-id with another, less problematic chars like the pipe |", "author": "abollini", "createdAt": "2020-07-18T16:56:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM4MjM0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI2NDQ3OQ==", "url": "https://github.com/DSpace/DSpace/pull/2792#discussion_r462264479", "bodyText": "The controlled-vocabularies (such as the srsc.xml) can have a slash in their ID. There may be none in default DSpace, but this is intended to be used with local vocabularies.\nI understand this is indeed complicated, but it's important to create a ticket for this, and I think it should be solved prior to 7.0 release", "author": "benbosman", "createdAt": "2020-07-29T12:36:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM4MjM0Mg=="}], "type": "inlineReview", "revised_code": {"commit": "9863b1c6d53bc3002a3d246bcf40339853a2af4b", "chunk": "diff --git a/dspace-server-webapp/src/main/java/org/dspace/app/rest/repository/VocabularyEntryDetailsRestRepository.java b/dspace-server-webapp/src/main/java/org/dspace/app/rest/repository/VocabularyEntryDetailsRestRepository.java\nindex 620bb527b..5ac17b385 100644\n--- a/dspace-server-webapp/src/main/java/org/dspace/app/rest/repository/VocabularyEntryDetailsRestRepository.java\n+++ b/dspace-server-webapp/src/main/java/org/dspace/app/rest/repository/VocabularyEntryDetailsRestRepository.java\n\n@@ -8,9 +8,11 @@\n package org.dspace.app.rest.repository;\n \n import java.util.ArrayList;\n+import java.util.Arrays;\n import java.util.List;\n \n import org.apache.commons.lang3.StringUtils;\n+import org.dspace.app.rest.DiscoverableEndpointsService;\n import org.dspace.app.rest.Parameter;\n import org.dspace.app.rest.SearchRestMethod;\n import org.dspace.app.rest.exception.LinkNotFoundException;\n"}}, {"oid": "8fd328855a69c711ea48cecaff7c911788dc15ff", "url": "https://github.com/DSpace/DSpace/commit/8fd328855a69c711ea48cecaff7c911788dc15ff", "message": "code cleanup and fix for project in vocabulary entry details", "committedDate": "2020-07-17T15:07:20Z", "type": "commit"}, {"oid": "07ffb5fbad49f724472c3b25cc3cf9cf1b0abb6e", "url": "https://github.com/DSpace/DSpace/commit/07ffb5fbad49f724472c3b25cc3cf9cf1b0abb6e", "message": "Merge branch 'main' of https://github.com/DSpace/DSpace into draft_vocabulary", "committedDate": "2020-07-17T17:39:18Z", "type": "commit"}, {"oid": "9863b1c6d53bc3002a3d246bcf40339853a2af4b", "url": "https://github.com/DSpace/DSpace/commit/9863b1c6d53bc3002a3d246bcf40339853a2af4b", "message": "Add link to the vocabularyEntryDetails search methods from the root", "committedDate": "2020-07-18T14:07:04Z", "type": "commit"}, {"oid": "769dd064d09fb90fe491dab8a397a040bc6ada4f", "url": "https://github.com/DSpace/DSpace/commit/769dd064d09fb90fe491dab8a397a040bc6ada4f", "message": "Add support and test for locales on vocabularies", "committedDate": "2020-07-18T15:30:20Z", "type": "commit"}, {"oid": "769dd064d09fb90fe491dab8a397a040bc6ada4f", "url": "https://github.com/DSpace/DSpace/commit/769dd064d09fb90fe491dab8a397a040bc6ada4f", "message": "Add support and test for locales on vocabularies", "committedDate": "2020-07-18T15:30:20Z", "type": "forcePushed"}, {"oid": "b232def06ed59b9a7c2fcedb077dd1c7def12461", "url": "https://github.com/DSpace/DSpace/commit/b232def06ed59b9a7c2fcedb077dd1c7def12461", "message": "Keep the message rethrowing the exception", "committedDate": "2020-07-18T16:26:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjIxNjc0OQ==", "url": "https://github.com/DSpace/DSpace/pull/2792#discussion_r462216749", "bodyText": "This variable name sounds quite confusing. It seems to be a map from the submission name to the fields (and the authorityName is not the same as the submission name)", "author": "benbosman", "createdAt": "2020-07-29T11:03:37Z", "path": "dspace-api/src/main/java/org/dspace/content/authority/ChoiceAuthorityServiceImpl.java", "diffHunk": "@@ -316,75 +319,110 @@ private void loadChoiceAuthorityConfigurations() {\n         autoRegisterChoiceAuthorityFromInputReader();\n     }\n \n+    /**\n+     * This method will register all the authorities that are required due to the\n+     * submission forms configuration. This includes authorities for value pairs and\n+     * xml vocabularies\n+     */\n     private void autoRegisterChoiceAuthorityFromInputReader() {\n         try {\n             List<SubmissionConfig> submissionConfigs = itemSubmissionConfigReader\n                     .getAllSubmissionConfigs(Integer.MAX_VALUE, 0);\n             DCInputsReader dcInputsReader = new DCInputsReader();\n \n+            // loop over all the defined item submission configuration\n             for (SubmissionConfig subCfg : submissionConfigs) {\n                 String submissionName = subCfg.getSubmissionName();\n                 List<DCInputSet> inputsBySubmissionName = dcInputsReader.getInputsBySubmissionName(submissionName);\n+                // loop over the submission forms configuration eventually associated with the submission panel\n                 for (DCInputSet dcinputSet : inputsBySubmissionName) {\n                     DCInput[][] dcinputs = dcinputSet.getFields();\n                     for (DCInput[] dcrows : dcinputs) {\n                         for (DCInput dcinput : dcrows) {\n+                            // for each input in the form check if it is associated with a real value pairs\n+                            // or an xml vocabulary\n+                            String authorityName = null;\n                             if (StringUtils.isNotBlank(dcinput.getPairsType())\n-                                || StringUtils.isNotBlank(dcinput.getVocabulary())) {\n-                                String authorityName = dcinput.getPairsType();\n-                                if (StringUtils.isBlank(authorityName)) {\n-                                    authorityName = dcinput.getVocabulary();\n-                                }\n-                                if (!StringUtils.equals(dcinput.getInputType(), \"qualdrop_value\")) {\n-                                    String fieldKey = makeFieldKey(dcinput.getSchema(), dcinput.getElement(),\n-                                                                   dcinput.getQualifier());\n-                                    ChoiceAuthority ca = controller.get(authorityName);\n-                                    if (ca == null) {\n-                                        ca = (ChoiceAuthority) pluginService\n-                                            .getNamedPlugin(ChoiceAuthority.class, authorityName);\n-                                        if (ca == null) {\n-                                            throw new IllegalStateException(\"Invalid configuration for \" + fieldKey\n-                                                    + \" in submission definition \" + submissionName\n-                                                    + \", form definition \" + dcinputSet.getFormName()\n-                                                    + \" no named plugin found: \" + authorityName);\n-                                        }\n-                                    }\n-\n-                                    Map<String, ChoiceAuthority> definition2authority;\n-                                    if (controllerFormDefinitions.containsKey(fieldKey)) {\n-                                        definition2authority = controllerFormDefinitions.get(fieldKey);\n-                                    } else {\n-                                        definition2authority = new HashMap<String, ChoiceAuthority>();\n-                                    }\n-                                    definition2authority.put(submissionName, ca);\n-                                    controllerFormDefinitions.put(fieldKey, definition2authority);\n-\n-                                    Map<String, List<String>> authorityName2definitions;\n-                                    if (authoritiesFormDefinitions.containsKey(authorityName)) {\n-                                        authorityName2definitions = authoritiesFormDefinitions.get(authorityName);\n-                                    } else {\n-                                        authorityName2definitions = new HashMap<String, List<String>>();\n-                                    }\n+                                    && !StringUtils.equals(dcinput.getInputType(), \"qualdrop_value\")) {\n+                                authorityName = dcinput.getPairsType();\n+                            } else if (StringUtils.isNotBlank(dcinput.getVocabulary())) {\n+                                authorityName = dcinput.getVocabulary();\n+                            }\n \n-                                    List<String> fields;\n-                                    if (authorityName2definitions.containsKey(submissionName)) {\n-                                        fields = authorityName2definitions.get(submissionName);\n-                                    } else {\n-                                        fields = new ArrayList<String>();\n+                            // do we have an authority?\n+                            if (StringUtils.isNotBlank(authorityName)) {\n+                                String fieldKey = makeFieldKey(dcinput.getSchema(), dcinput.getElement(),\n+                                                               dcinput.getQualifier());\n+                                ChoiceAuthority ca = controller.get(authorityName);\n+                                if (ca == null) {\n+                                    ca = (ChoiceAuthority) pluginService\n+                                        .getNamedPlugin(ChoiceAuthority.class, authorityName);\n+                                    if (ca == null) {\n+                                        throw new IllegalStateException(\"Invalid configuration for \" + fieldKey\n+                                                + \" in submission definition \" + submissionName\n+                                                + \", form definition \" + dcinputSet.getFormName()\n+                                                + \" no named plugin found: \" + authorityName);\n                                     }\n-                                    fields.add(fieldKey);\n-                                    authorityName2definitions.put(submissionName, fields);\n-                                    authoritiesFormDefinitions.put(authorityName, authorityName2definitions);\n                                 }\n+\n+                                addAuthorityToFormCacheMap(submissionName, fieldKey, ca);\n+                                addFormDetailsToAuthorityCacheMap(submissionName, authorityName, fieldKey);\n                             }\n                         }\n                     }\n                 }\n             }\n         } catch (DCInputsReaderException e) {\n             // the system is in an illegal state as the submission definition is not valid\n-            throw new IllegalStateException(e);\n+            throw new IllegalStateException(\"Error reading the item submission configuration: \" + e.getMessage(),\n+                    e);\n+        }\n+    }\n+\n+    /**\n+     * Add the form/field to the cache map keeping track of which form/field are\n+     * associated with the specific authority name\n+     * \n+     * @param submissionName the form definition name\n+     * @param authorityName  the name of the authority plugin\n+     * @param fieldKey       the field key that use the authority\n+     */\n+    private void addFormDetailsToAuthorityCacheMap(String submissionName, String authorityName, String fieldKey) {\n+        Map<String, List<String>> authorityName2definitions;\n+        if (authoritiesFormDefinitions.containsKey(authorityName)) {\n+            authorityName2definitions = authoritiesFormDefinitions.get(authorityName);", "originalCommit": "b232def06ed59b9a7c2fcedb077dd1c7def12461", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ed58d44329c67b1810851d9795364c7acbc00d0b", "chunk": "diff --git a/dspace-api/src/main/java/org/dspace/content/authority/ChoiceAuthorityServiceImpl.java b/dspace-api/src/main/java/org/dspace/content/authority/ChoiceAuthorityServiceImpl.java\nindex ddce3331e..0e05852af 100644\n--- a/dspace-api/src/main/java/org/dspace/content/authority/ChoiceAuthorityServiceImpl.java\n+++ b/dspace-api/src/main/java/org/dspace/content/authority/ChoiceAuthorityServiceImpl.java\n\n@@ -388,22 +388,22 @@ public final class ChoiceAuthorityServiceImpl implements ChoiceAuthorityService\n      * @param fieldKey       the field key that use the authority\n      */\n     private void addFormDetailsToAuthorityCacheMap(String submissionName, String authorityName, String fieldKey) {\n-        Map<String, List<String>> authorityName2definitions;\n+        Map<String, List<String>> submissionDefinitionNames2fieldKeys;\n         if (authoritiesFormDefinitions.containsKey(authorityName)) {\n-            authorityName2definitions = authoritiesFormDefinitions.get(authorityName);\n+            submissionDefinitionNames2fieldKeys = authoritiesFormDefinitions.get(authorityName);\n         } else {\n-            authorityName2definitions = new HashMap<String, List<String>>();\n+            submissionDefinitionNames2fieldKeys = new HashMap<String, List<String>>();\n         }\n \n         List<String> fields;\n-        if (authorityName2definitions.containsKey(submissionName)) {\n-            fields = authorityName2definitions.get(submissionName);\n+        if (submissionDefinitionNames2fieldKeys.containsKey(submissionName)) {\n+            fields = submissionDefinitionNames2fieldKeys.get(submissionName);\n         } else {\n             fields = new ArrayList<String>();\n         }\n         fields.add(fieldKey);\n-        authorityName2definitions.put(submissionName, fields);\n-        authoritiesFormDefinitions.put(authorityName, authorityName2definitions);\n+        submissionDefinitionNames2fieldKeys.put(submissionName, fields);\n+        authoritiesFormDefinitions.put(authorityName, submissionDefinitionNames2fieldKeys);\n     }\n \n     /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI1NDE3Ng==", "url": "https://github.com/DSpace/DSpace/pull/2792#discussion_r462254176", "bodyText": "Can you add JavaDocs explaining what values and labels are now?\nIf values is a map, it's not clear what the keys and values of the map are (and similar for labels)", "author": "benbosman", "createdAt": "2020-07-29T12:17:56Z", "path": "dspace-api/src/main/java/org/dspace/content/authority/DCInputAuthority.java", "diffHunk": "@@ -44,10 +50,10 @@\n public class DCInputAuthority extends SelfNamedPlugin implements ChoiceAuthority {\n     private static Logger log = org.apache.logging.log4j.LogManager.getLogger(DCInputAuthority.class);\n \n-    private String values[] = null;\n-    private String labels[] = null;\n+    private Map<String, String[]> values = null;", "originalCommit": "b232def06ed59b9a7c2fcedb077dd1c7def12461", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzEwNjA2NA==", "url": "https://github.com/DSpace/DSpace/pull/2792#discussion_r463106064", "bodyText": "done", "author": "abollini", "createdAt": "2020-07-30T16:04:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI1NDE3Ng=="}], "type": "inlineReview", "revised_code": {"commit": "bd6982bb150ac87455b7ae4cb48cc61f36a3ef57", "chunk": "diff --git a/dspace-api/src/main/java/org/dspace/content/authority/DCInputAuthority.java b/dspace-api/src/main/java/org/dspace/content/authority/DCInputAuthority.java\nindex d95528524..b1d8cf36a 100644\n--- a/dspace-api/src/main/java/org/dspace/content/authority/DCInputAuthority.java\n+++ b/dspace-api/src/main/java/org/dspace/content/authority/DCInputAuthority.java\n\n@@ -50,9 +50,21 @@ import org.dspace.core.SelfNamedPlugin;\n public class DCInputAuthority extends SelfNamedPlugin implements ChoiceAuthority {\n     private static Logger log = org.apache.logging.log4j.LogManager.getLogger(DCInputAuthority.class);\n \n+    /**\n+     * The map of the values available for a specific language. Examples of keys are\n+     * \"en\", \"it\", \"uk\"\n+     */\n     private Map<String, String[]> values = null;\n+\n+    /**\n+     * The map of the labels available for a specific language. Examples of keys are\n+     * \"en\", \"it\", \"uk\"\n+     */\n     private Map<String, String[]> labels = null;\n \n+    /**\n+     * The map of the input form reader associated to use for a specific java locale\n+     */\n     private static Map<Locale, DCInputsReader> dcis = null;\n     private static String pluginNames[] = null;\n \n"}}, {"oid": "bd6982bb150ac87455b7ae4cb48cc61f36a3ef57", "url": "https://github.com/DSpace/DSpace/commit/bd6982bb150ac87455b7ae4cb48cc61f36a3ef57", "message": "Describe the structure of the map fields", "committedDate": "2020-07-30T15:53:39Z", "type": "commit"}, {"oid": "ed58d44329c67b1810851d9795364c7acbc00d0b", "url": "https://github.com/DSpace/DSpace/commit/ed58d44329c67b1810851d9795364c7acbc00d0b", "message": "Use a more meaningful variable name", "committedDate": "2020-07-30T16:02:53Z", "type": "commit"}, {"oid": "5e30cbe0eb517550f5e453c9cd2631d091a7459f", "url": "https://github.com/DSpace/DSpace/commit/5e30cbe0eb517550f5e453c9cd2631d091a7459f", "message": "Merge branch 'main' into draft_vocabulary", "committedDate": "2020-08-06T08:20:30Z", "type": "commit"}, {"oid": "70c861a9e9e88b6a852f04d1ed85022c6bb25bf7", "url": "https://github.com/DSpace/DSpace/commit/70c861a9e9e88b6a852f04d1ed85022c6bb25bf7", "message": "fix builder import", "committedDate": "2020-08-06T08:33:43Z", "type": "commit"}]}