{"pr_number": 3034, "pr_title": "Community admin should also be considered a Collection admin", "pr_createdAt": "2020-10-29T15:40:16Z", "pr_url": "https://github.com/DSpace/DSpace/pull/3034", "timeline": [{"oid": "d8d3aca995ec3c20a035494228b045501dc808b0", "url": "https://github.com/DSpace/DSpace/commit/d8d3aca995ec3c20a035494228b045501dc808b0", "message": "Community admin should also be considered a Collection admin", "committedDate": "2020-10-29T15:20:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg0NzUxMA==", "url": "https://github.com/DSpace/DSpace/pull/3034#discussion_r518847510", "bodyText": "Both of these tests should be using Builder classes to create all content.  Using a Builder will ensure that the content created is automatically deleted after the test completes.  Currently, these tests are not cleaning up after themselves.\nSo, please update these tests to use CollectionBuilder, CommunityBuilder and EPersonBuilder.  Note that you also don't need to create the Admin group, as you can use CollectionBuilder.withAdminGroup(Eperson) instead.", "author": "tdonohue", "createdAt": "2020-11-06T16:03:22Z", "path": "dspace-api/src/test/java/org/dspace/authorize/AuthorizeServiceTest.java", "diffHunk": "@@ -125,4 +128,39 @@ public void testauthorizeMethodRespectSpecialGroups() {\n             throw new AssertionError(ex);\n         }\n     }\n+\n+    @Test\n+    public void testIsCollectionAdmin() throws SQLException, AuthorizeException {\n+\n+        context.turnOffAuthorisationSystem();\n+\n+        Community community = communityService.create(null, context);\n+        Collection collection = collectionService.create(context, community);\n+        EPerson eperson = ePersonService.create(context);", "originalCommit": "d8d3aca995ec3c20a035494228b045501dc808b0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "79ee010a7a816d2494b9c1de6ac0e15118b09c72", "chunk": "diff --git a/dspace-api/src/test/java/org/dspace/authorize/AuthorizeServiceTest.java b/dspace-api/src/test/java/org/dspace/authorize/AuthorizeServiceTest.java\nindex 0ce391ae5..9d947847b 100644\n--- a/dspace-api/src/test/java/org/dspace/authorize/AuthorizeServiceTest.java\n+++ b/dspace-api/src/test/java/org/dspace/authorize/AuthorizeServiceTest.java\n\n@@ -130,37 +131,68 @@ public class AuthorizeServiceTest extends AbstractUnitTest {\n     }\n \n     @Test\n-    public void testIsCollectionAdmin() throws SQLException, AuthorizeException {\n+    public void testIsCollectionAdmin() throws SQLException, AuthorizeException, IOException {\n \n-        context.turnOffAuthorisationSystem();\n+        Community community = null;\n+        EPerson eperson = null;\n \n-        Community community = communityService.create(null, context);\n-        Collection collection = collectionService.create(context, community);\n-        EPerson eperson = ePersonService.create(context);\n+        try {\n+\n+            context.turnOffAuthorisationSystem();\n \n-        Group administrators = collectionService.createAdministrators(context, collection);\n-        groupService.addMember(context, administrators, eperson);\n+            community = communityService.create(null, context);\n+            Collection collection = collectionService.create(context, community);\n+            eperson = ePersonService.create(context);\n+\n+            Group administrators = collectionService.createAdministrators(context, collection);\n+            groupService.addMember(context, administrators, eperson);\n+            context.commit();\n \n-        context.restoreAuthSystemState();\n-        context.commit();\n+            Assert.assertTrue(authorizeService.isCollectionAdmin(context, eperson));\n \n-        Assert.assertTrue(authorizeService.isCollectionAdmin(context, eperson));\n+        } finally {\n+\n+            if (community != null) {\n+                communityService.delete(context, context.reloadEntity(community));\n+            }\n+            if (eperson != null) {\n+                ePersonService.delete(context, context.reloadEntity(eperson));\n+            }\n+\n+            context.restoreAuthSystemState();\n+        }\n     }\n \n     @Test\n-    public void testIsCollectionAdminReturnsTrueIfTheUserIsCommunityAdmin() throws SQLException, AuthorizeException {\n+    public void testIsCollectionAdminReturnsTrueIfTheUserIsCommunityAdmin()\n+        throws SQLException, AuthorizeException, IOException {\n \n-        context.turnOffAuthorisationSystem();\n+        Community community = null;\n+        EPerson eperson = null;\n \n-        Community community = communityService.create(null, context);\n-        EPerson eperson = ePersonService.create(context);\n+        try {\n+\n+            context.turnOffAuthorisationSystem();\n \n-        Group administrators = communityService.createAdministrators(context, community);\n-        groupService.addMember(context, administrators, eperson);\n+            community = communityService.create(null, context);\n+            eperson = ePersonService.create(context);\n+\n+            Group administrators = communityService.createAdministrators(context, community);\n+            groupService.addMember(context, administrators, eperson);\n+            context.commit();\n \n-        context.restoreAuthSystemState();\n-        context.commit();\n+            Assert.assertTrue(authorizeService.isCollectionAdmin(context, eperson));\n \n-        Assert.assertTrue(authorizeService.isCollectionAdmin(context, eperson));\n+        } finally {\n+\n+            if (community != null) {\n+                communityService.delete(context, context.reloadEntity(community));\n+            }\n+            if (eperson != null) {\n+                ePersonService.delete(context, context.reloadEntity(eperson));\n+            }\n+\n+            context.restoreAuthSystemState();\n+        }\n     }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg0ODkyNA==", "url": "https://github.com/DSpace/DSpace/pull/3034#discussion_r518848924", "bodyText": "Same here, use Builders please.\nAlso, for full test completion, would you be willing to add a testIsCommunityAdmin() method here...as it seems to be missing & it'd be good to also prove that a Community Admin also results in that method returning true, while a Collection Admin results in that method returning false.", "author": "tdonohue", "createdAt": "2020-11-06T16:05:36Z", "path": "dspace-api/src/test/java/org/dspace/authorize/AuthorizeServiceTest.java", "diffHunk": "@@ -125,4 +128,39 @@ public void testauthorizeMethodRespectSpecialGroups() {\n             throw new AssertionError(ex);\n         }\n     }\n+\n+    @Test\n+    public void testIsCollectionAdmin() throws SQLException, AuthorizeException {\n+\n+        context.turnOffAuthorisationSystem();\n+\n+        Community community = communityService.create(null, context);\n+        Collection collection = collectionService.create(context, community);\n+        EPerson eperson = ePersonService.create(context);\n+\n+        Group administrators = collectionService.createAdministrators(context, collection);\n+        groupService.addMember(context, administrators, eperson);\n+\n+        context.restoreAuthSystemState();\n+        context.commit();\n+\n+        Assert.assertTrue(authorizeService.isCollectionAdmin(context, eperson));\n+    }\n+\n+    @Test\n+    public void testIsCollectionAdminReturnsTrueIfTheUserIsCommunityAdmin() throws SQLException, AuthorizeException {\n+\n+        context.turnOffAuthorisationSystem();\n+\n+        Community community = communityService.create(null, context);\n+        EPerson eperson = ePersonService.create(context);\n+\n+        Group administrators = communityService.createAdministrators(context, community);\n+        groupService.addMember(context, administrators, eperson);", "originalCommit": "d8d3aca995ec3c20a035494228b045501dc808b0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "79ee010a7a816d2494b9c1de6ac0e15118b09c72", "chunk": "diff --git a/dspace-api/src/test/java/org/dspace/authorize/AuthorizeServiceTest.java b/dspace-api/src/test/java/org/dspace/authorize/AuthorizeServiceTest.java\nindex 0ce391ae5..9d947847b 100644\n--- a/dspace-api/src/test/java/org/dspace/authorize/AuthorizeServiceTest.java\n+++ b/dspace-api/src/test/java/org/dspace/authorize/AuthorizeServiceTest.java\n\n@@ -130,37 +131,68 @@ public class AuthorizeServiceTest extends AbstractUnitTest {\n     }\n \n     @Test\n-    public void testIsCollectionAdmin() throws SQLException, AuthorizeException {\n+    public void testIsCollectionAdmin() throws SQLException, AuthorizeException, IOException {\n \n-        context.turnOffAuthorisationSystem();\n+        Community community = null;\n+        EPerson eperson = null;\n \n-        Community community = communityService.create(null, context);\n-        Collection collection = collectionService.create(context, community);\n-        EPerson eperson = ePersonService.create(context);\n+        try {\n+\n+            context.turnOffAuthorisationSystem();\n \n-        Group administrators = collectionService.createAdministrators(context, collection);\n-        groupService.addMember(context, administrators, eperson);\n+            community = communityService.create(null, context);\n+            Collection collection = collectionService.create(context, community);\n+            eperson = ePersonService.create(context);\n+\n+            Group administrators = collectionService.createAdministrators(context, collection);\n+            groupService.addMember(context, administrators, eperson);\n+            context.commit();\n \n-        context.restoreAuthSystemState();\n-        context.commit();\n+            Assert.assertTrue(authorizeService.isCollectionAdmin(context, eperson));\n \n-        Assert.assertTrue(authorizeService.isCollectionAdmin(context, eperson));\n+        } finally {\n+\n+            if (community != null) {\n+                communityService.delete(context, context.reloadEntity(community));\n+            }\n+            if (eperson != null) {\n+                ePersonService.delete(context, context.reloadEntity(eperson));\n+            }\n+\n+            context.restoreAuthSystemState();\n+        }\n     }\n \n     @Test\n-    public void testIsCollectionAdminReturnsTrueIfTheUserIsCommunityAdmin() throws SQLException, AuthorizeException {\n+    public void testIsCollectionAdminReturnsTrueIfTheUserIsCommunityAdmin()\n+        throws SQLException, AuthorizeException, IOException {\n \n-        context.turnOffAuthorisationSystem();\n+        Community community = null;\n+        EPerson eperson = null;\n \n-        Community community = communityService.create(null, context);\n-        EPerson eperson = ePersonService.create(context);\n+        try {\n+\n+            context.turnOffAuthorisationSystem();\n \n-        Group administrators = communityService.createAdministrators(context, community);\n-        groupService.addMember(context, administrators, eperson);\n+            community = communityService.create(null, context);\n+            eperson = ePersonService.create(context);\n+\n+            Group administrators = communityService.createAdministrators(context, community);\n+            groupService.addMember(context, administrators, eperson);\n+            context.commit();\n \n-        context.restoreAuthSystemState();\n-        context.commit();\n+            Assert.assertTrue(authorizeService.isCollectionAdmin(context, eperson));\n \n-        Assert.assertTrue(authorizeService.isCollectionAdmin(context, eperson));\n+        } finally {\n+\n+            if (community != null) {\n+                communityService.delete(context, context.reloadEntity(community));\n+            }\n+            if (eperson != null) {\n+                ePersonService.delete(context, context.reloadEntity(eperson));\n+            }\n+\n+            context.restoreAuthSystemState();\n+        }\n     }\n }\n"}}, {"oid": "79ee010a7a816d2494b9c1de6ac0e15118b09c72", "url": "https://github.com/DSpace/DSpace/commit/79ee010a7a816d2494b9c1de6ac0e15118b09c72", "message": "Added tests cleanup", "committedDate": "2020-11-26T15:36:36Z", "type": "commit"}]}