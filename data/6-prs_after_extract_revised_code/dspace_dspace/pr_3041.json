{"pr_number": 3041, "pr_title": "Issue 2988: EPerson Password Replacement/addition with ADD Patch Operation instead of REPLACE", "pr_createdAt": "2020-11-02T09:22:34Z", "pr_url": "https://github.com/DSpace/DSpace/pull/3041", "timeline": [{"oid": "cd5be5b84fd0b4e50feae6a2e84022db077f0dd3", "url": "https://github.com/DSpace/DSpace/commit/cd5be5b84fd0b4e50feae6a2e84022db077f0dd3", "message": "74274: [Issue 2988]: EPersonPasswordReplaceOperation => AddOperation; eperson password can be added&replaced with this patch operation + test changes", "committedDate": "2020-10-28T15:07:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODU4MzAxMw==", "url": "https://github.com/DSpace/DSpace/pull/3041#discussion_r518583013", "bodyText": "the scenario in the original test is loss. What happen if we try to set an empty password?", "author": "abollini", "createdAt": "2020-11-06T08:07:16Z", "path": "dspace-server-webapp/src/test/java/org/dspace/app/rest/EPersonRestRepositoryIT.java", "diffHunk": "@@ -1410,14 +1411,14 @@ public void patchCertificateNonAdminUser() throws Exception {\n     }\n \n     @Test\n-    public void patchPasswordMissingValue() throws Exception {", "originalCommit": "cd5be5b84fd0b4e50feae6a2e84022db077f0dd3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg2NDM3NA==", "url": "https://github.com/DSpace/DSpace/pull/3041#discussion_r518864374", "bodyText": "I agree with @abollini that we should make sure to add a test here to prove what happens if you send an ADD with an empty password (I'd expect it to throw an error like before, but would be good to prove).\n(Sidenote: @Raf-atmire  I've already done a quick code review & this is looking great to me, other then this one missing test.  I'll be waiting to submit my review though until I test it alongside the frontend PR)", "author": "tdonohue", "createdAt": "2020-11-06T16:30:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODU4MzAxMw=="}], "type": "inlineReview", "revised_code": {"commit": "2c21703b5eab3b67e13e81a8595db5ee686df1a9", "chunk": "diff --git a/dspace-server-webapp/src/test/java/org/dspace/app/rest/EPersonRestRepositoryIT.java b/dspace-server-webapp/src/test/java/org/dspace/app/rest/EPersonRestRepositoryIT.java\nindex 2e2dbabdb..ec8a8a4ed 100644\n--- a/dspace-server-webapp/src/test/java/org/dspace/app/rest/EPersonRestRepositoryIT.java\n+++ b/dspace-server-webapp/src/test/java/org/dspace/app/rest/EPersonRestRepositoryIT.java\n\n@@ -1410,6 +1410,40 @@ public class EPersonRestRepositoryIT extends AbstractControllerIntegrationTest {\n \n     }\n \n+    @Test\n+    public void patchPasswordMissingValue() throws Exception {\n+        context.turnOffAuthorisationSystem();\n+\n+        String originalPw = \"testpass79bC\";\n+\n+        EPerson ePerson = EPersonBuilder.createEPerson(context)\n+                                        .withNameInMetadata(\"John\", \"Doe\")\n+                                        .withEmail(\"Johndoe@example.com\")\n+                                        .withPassword(originalPw)\n+                                        .build();\n+\n+        context.restoreAuthSystemState();\n+\n+        String token = getAuthToken(admin.getEmail(), password);\n+\n+        List<Operation> ops = new ArrayList<>();\n+        AddOperation addOperation = new AddOperation(\"/password\", null);\n+        ops.add(addOperation);\n+        String patchBody = getPatchContent(ops);\n+\n+        // adding null pw should return bad request\n+        getClient(token).perform(patch(\"/api/eperson/epersons/\" + ePerson.getID())\n+            .content(patchBody)\n+            .contentType(MediaType.APPLICATION_JSON_PATCH_JSON))\n+                        .andExpect(status().isBadRequest());\n+\n+        // login with original password\n+        token = getAuthToken(ePerson.getEmail(), originalPw);\n+        getClient(token).perform(get(\"/api/\"))\n+                        .andExpect(status().isOk());\n+\n+    }\n+\n     @Test\n     public void patchPasswordNotInitialised() throws Exception {\n \n"}}, {"oid": "2c21703b5eab3b67e13e81a8595db5ee686df1a9", "url": "https://github.com/DSpace/DSpace/commit/2c21703b5eab3b67e13e81a8595db5ee686df1a9", "message": "Test for null value patch added back in", "committedDate": "2020-11-09T10:39:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQwNDAwNA==", "url": "https://github.com/DSpace/DSpace/pull/3041#discussion_r525404004", "bodyText": "I have approved this PR but I want to note that this test is not exactly what I would expect. It would be better to test for the authn/status endpoint to verify that we are really loggedin. It is not documented what should happen trying to access a public endpoint with an invalid token. @tdonohue do you agree? should we open a ticket for that? again this PR can be merged as is as this is unrelated with the PR", "author": "abollini", "createdAt": "2020-11-17T18:49:11Z", "path": "dspace-server-webapp/src/test/java/org/dspace/app/rest/EPersonRestRepositoryIT.java", "diffHunk": "@@ -1411,49 +1412,70 @@ public void patchCertificateNonAdminUser() throws Exception {\n \n     @Test\n     public void patchPasswordMissingValue() throws Exception {\n-\n         context.turnOffAuthorisationSystem();\n \n+        String originalPw = \"testpass79bC\";\n+\n         EPerson ePerson = EPersonBuilder.createEPerson(context)\n                                         .withNameInMetadata(\"John\", \"Doe\")\n                                         .withEmail(\"Johndoe@example.com\")\n-                                        .withPassword(\"testpass79bC\")\n+                                        .withPassword(originalPw)\n                                         .build();\n \n         context.restoreAuthSystemState();\n \n         String token = getAuthToken(admin.getEmail(), password);\n \n-        String newPassword = \"newpass\";\n-\n-        List<Operation> ops = new ArrayList<Operation>();\n-        ReplaceOperation replaceOperation = new ReplaceOperation(\"/password\", newPassword);\n-        ops.add(replaceOperation);\n+        List<Operation> ops = new ArrayList<>();\n+        AddOperation addOperation = new AddOperation(\"/password\", null);\n+        ops.add(addOperation);\n         String patchBody = getPatchContent(ops);\n \n-        // initialize passwd\n+        // adding null pw should return bad request\n         getClient(token).perform(patch(\"/api/eperson/epersons/\" + ePerson.getID())\n-                .content(patchBody)\n-                .contentType(MediaType.APPLICATION_JSON_PATCH_JSON))\n+            .content(patchBody)\n+            .contentType(MediaType.APPLICATION_JSON_PATCH_JSON))\n+                        .andExpect(status().isBadRequest());\n+\n+        // login with original password\n+        token = getAuthToken(ePerson.getEmail(), originalPw);\n+        getClient(token).perform(get(\"/api/\"))\n                         .andExpect(status().isOk());\n \n+    }\n \n-        List<Operation> ops2 = new ArrayList<Operation>();\n-        ReplaceOperation replaceOperation2 = new ReplaceOperation(\"/password\", null);\n-        ops2.add(replaceOperation2);\n-        patchBody = getPatchContent(ops2);\n+    @Test\n+    public void patchPasswordNotInitialised() throws Exception {\n \n-        // should return bad request\n+        context.turnOffAuthorisationSystem();\n+\n+        EPerson ePerson = EPersonBuilder.createEPerson(context)\n+                                        .withNameInMetadata(\"John\", \"Doe\")\n+                                        .withEmail(\"userNotInitialised@example.com\")\n+                                        .withCanLogin(true)\n+                                        .build();\n+\n+        context.restoreAuthSystemState();\n+\n+        String token = getAuthToken(admin.getEmail(), password);\n+\n+        String newPassword = \"newpass\";\n+\n+        List<Operation> ops = new ArrayList<Operation>();\n+        AddOperation addOperation = new AddOperation(\"/password\", newPassword);\n+        ops.add(addOperation);\n+        String patchBody = getPatchContent(ops);\n+\n+        // initialize password with add operation, not set during creation\n         getClient(token).perform(patch(\"/api/eperson/epersons/\" + ePerson.getID())\n                 .content(patchBody)\n                 .contentType(MediaType.APPLICATION_JSON_PATCH_JSON))\n-                        .andExpect(status().isBadRequest());\n+                        .andExpect(status().isOk());\n \n-        // login with original password\n+        // login with new password => succeeds\n         token = getAuthToken(ePerson.getEmail(), newPassword);\n         getClient(token).perform(get(\"/api/\"))\n                         .andExpect(status().isOk());", "originalCommit": "2c21703b5eab3b67e13e81a8595db5ee686df1a9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTU2MDA2Mw==", "url": "https://github.com/DSpace/DSpace/pull/3041#discussion_r525560063", "bodyText": "@Raf-atmire : @abollini is correct (and I overlooked this).  I don't think this test is correct (and I see you've reused this same test in your changes to patchPasswordMissingValue()).\nInstead of doing a GET against /api/, we should be doing a GET against /api/authn/status and checking that it returns \"authenticated=true\". So, what you should be doing here is replace these two lines (starting with getClient( with somethin like this: https://github.com/DSpace/DSpace/blob/main/dspace-server-webapp/src/test/java/org/dspace/app/rest/AuthenticationRestControllerIT.java#L211-L216\nThat'd be a more accurate test to verify that the login works.  I'm actually not sure if running a GET against /api/ even requires authentication or not -- in fact based on the response of the demo REST API, it seems like that request would NOT require authentication: https://dspace7.4science.cloud/server/api/\nSo, if you could fix this check here and on line 1440 above, then this PR should be ready to merge.  Thanks!", "author": "tdonohue", "createdAt": "2020-11-17T22:13:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQwNDAwNA=="}], "type": "inlineReview", "revised_code": {"commit": "924b178dcf6e4469664dbdeee89ad5b2832b8af6", "chunk": "diff --git a/dspace-server-webapp/src/test/java/org/dspace/app/rest/EPersonRestRepositoryIT.java b/dspace-server-webapp/src/test/java/org/dspace/app/rest/EPersonRestRepositoryIT.java\nindex ec8a8a4ed..0255b9948 100644\n--- a/dspace-server-webapp/src/test/java/org/dspace/app/rest/EPersonRestRepositoryIT.java\n+++ b/dspace-server-webapp/src/test/java/org/dspace/app/rest/EPersonRestRepositoryIT.java\n\n@@ -1439,9 +1477,19 @@ public class EPersonRestRepositoryIT extends AbstractControllerIntegrationTest {\n \n         // login with original password\n         token = getAuthToken(ePerson.getEmail(), originalPw);\n-        getClient(token).perform(get(\"/api/\"))\n-                        .andExpect(status().isOk());\n+        getClient(token).perform(get(\"/api/authn/status\"))\n+                        .andExpect(status().isOk())\n+                        .andExpect(jsonPath(\"$.okay\", is(true)))\n+                        .andExpect(jsonPath(\"$.authenticated\", is(true)))\n+                        .andExpect(jsonPath(\"$.type\", is(\"status\")));\n \n+        // can't login with null password\n+        token = getAuthToken(ePerson.getEmail(), null);\n+        getClient(token).perform(get(\"/api/authn/status\"))\n+                        .andExpect(status().isOk())\n+                        .andExpect(jsonPath(\"$.okay\", is(true)))\n+                        .andExpect(jsonPath(\"$.authenticated\", is(false)))\n+                        .andExpect(jsonPath(\"$.type\", is(\"status\")));\n     }\n \n     @Test\n"}}, {"oid": "924b178dcf6e4469664dbdeee89ad5b2832b8af6", "url": "https://github.com/DSpace/DSpace/commit/924b178dcf6e4469664dbdeee89ad5b2832b8af6", "message": "74274: Refactor check success/failed authentication", "committedDate": "2020-11-20T16:00:45Z", "type": "commit"}]}