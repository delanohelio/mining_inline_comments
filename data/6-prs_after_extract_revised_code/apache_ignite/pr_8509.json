{"pr_number": 8509, "pr_title": "IGNITE-10075 .NET: Avoid binary configurations of Ignite Java service params", "pr_createdAt": "2020-11-29T16:48:41Z", "pr_url": "https://github.com/apache/ignite/pull/8509", "timeline": [{"oid": "15e64ae16fb79bfda9cec1dbacce001f948e6fec", "url": "https://github.com/apache/ignite/commit/15e64ae16fb79bfda9cec1dbacce001f948e6fec", "message": "IGNITE-10075: Test to reproduce issue", "committedDate": "2020-11-29T16:46:01Z", "type": "commit"}, {"oid": "ee27b973bb6aaf156d57ff18b78ef99b2fac94ee", "url": "https://github.com/apache/ignite/commit/ee27b973bb6aaf156d57ff18b78ef99b2fac94ee", "message": "IGNITE-10075: Test to reproduce issue", "committedDate": "2020-11-29T16:52:40Z", "type": "commit"}, {"oid": "af665b466dc1afea60818774e5e645672bbc9f35", "url": "https://github.com/apache/ignite/commit/af665b466dc1afea60818774e5e645672bbc9f35", "message": "IGNITE-10075: Test + patch.", "committedDate": "2020-11-30T10:21:59Z", "type": "commit"}, {"oid": "d8d45900f9a714caa8c0d13fd1e6e07f52c4fd7d", "url": "https://github.com/apache/ignite/commit/d8d45900f9a714caa8c0d13fd1e6e07f52c4fd7d", "message": "IGNITE-10075: Test + patch.", "committedDate": "2020-11-30T10:43:30Z", "type": "commit"}, {"oid": "c82b4f807c9747bf0cf60ec9e6ce62a09ead668d", "url": "https://github.com/apache/ignite/commit/c82b4f807c9747bf0cf60ec9e6ce62a09ead668d", "message": "IGNITE-10075: Test + patch.", "committedDate": "2020-11-30T10:44:59Z", "type": "commit"}, {"oid": "59defd174d4613155d027420d2085316c235e69d", "url": "https://github.com/apache/ignite/commit/59defd174d4613155d027420d2085316c235e69d", "message": "IGNITE-10075: Compilation error fix.", "committedDate": "2020-11-30T13:21:23Z", "type": "commit"}, {"oid": "f7275d351dde2ef7a123e50e61b8c63bbe781585", "url": "https://github.com/apache/ignite/commit/f7275d351dde2ef7a123e50e61b8c63bbe781585", "message": "IGNITE-10075: Tests fix", "committedDate": "2020-11-30T15:55:46Z", "type": "commit"}, {"oid": "f01ffdf044fff975d43eb536ba3138ef251f86a3", "url": "https://github.com/apache/ignite/commit/f01ffdf044fff975d43eb536ba3138ef251f86a3", "message": "IGNITE-10075: Tests fix", "committedDate": "2020-11-30T16:38:59Z", "type": "commit"}, {"oid": "7f3429b1c475d798d49c71c2698f11ced911cbc7", "url": "https://github.com/apache/ignite/commit/7f3429b1c475d798d49c71c2698f11ced911cbc7", "message": "IGNITE-10075: Tests fix", "committedDate": "2020-11-30T16:41:50Z", "type": "commit"}, {"oid": "6ba6af0b8c3cb2c98f87d5fbffeafed2f063866f", "url": "https://github.com/apache/ignite/commit/6ba6af0b8c3cb2c98f87d5fbffeafed2f063866f", "message": "IGNITE-10075: Tests fix", "committedDate": "2020-11-30T16:42:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjg1MzM0MQ==", "url": "https://github.com/apache/ignite/pull/8509#discussion_r532853341", "bodyText": "Let's not use exceptions for control flow - may be introduce an overload for MarshallerContext.getClassName that does not throw exceptions?", "author": "ptupitsyn", "createdAt": "2020-11-30T19:42:32Z", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/platform/binary/PlatformBinaryProcessor.java", "diffHunk": "@@ -126,16 +128,28 @@ public PlatformBinaryProcessor(PlatformContext platformCtx) {\n             case OP_GET_TYPE: {\n                 int typeId = reader.readInt();\n \n-                try {\n-                    String typeName = platformContext().kernalContext().marshallerContext()\n-                        .getClassName(MarshallerPlatformIds.DOTNET_ID, typeId);\n+                ClassNotFoundException err = null;\n \n-                    writer.writeString(typeName);\n-                }\n-                catch (ClassNotFoundException e) {\n-                    throw new BinaryObjectException(e);\n+                for (byte platformId : new byte[] {DOTNET_ID, JAVA_ID}) {\n+                    try {\n+                        String typeName = platformContext().kernalContext().marshallerContext()\n+                            .getClassName(platformId, typeId);\n+\n+                        writer.writeString(typeName);\n+\n+                        err = null;\n+\n+                        break;\n+                    }\n+                    catch (ClassNotFoundException e) {", "originalCommit": "6ba6af0b8c3cb2c98f87d5fbffeafed2f063866f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzI0ODI3OA==", "url": "https://github.com/apache/ignite/pull/8509#discussion_r533248278", "bodyText": "I see your point, but if we introduce a method that not throws then we should return a tuple from it - T2(className, errorMsg).\nMoreover, the second value of the tuple required in rare cases when we can't resolve the class name from type id.\nAFAIU getClassName executed several times on every interaction between DotNet and Java so the creation of an extra object on each invocation will hurt the performance.\nSo I propose to keep changes as is. What do you think?", "author": "nizhikov", "createdAt": "2020-12-01T09:52:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjg1MzM0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzI2MTM0Ng==", "url": "https://github.com/apache/ignite/pull/8509#discussion_r533261346", "bodyText": "The cost of throwing an exception is a lot higher than a tuple allocation.\ngetClassName is called from .NET once per type, then cached\n\nI'm not concerned about performance too much here because of (2). Exception-based control flow is just dirty.", "author": "ptupitsyn", "createdAt": "2020-12-01T10:02:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjg1MzM0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzMzNTgyNg==", "url": "https://github.com/apache/ignite/pull/8509#discussion_r533335826", "bodyText": "Fixed according to your proposal.", "author": "nizhikov", "createdAt": "2020-12-01T11:25:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjg1MzM0MQ=="}], "type": "inlineReview", "revised_code": {"commit": "a0e3d5050bfd75d0863c26280a1a6bdae1676c73", "chunk": "diff --git a/modules/core/src/main/java/org/apache/ignite/internal/processors/platform/binary/PlatformBinaryProcessor.java b/modules/core/src/main/java/org/apache/ignite/internal/processors/platform/binary/PlatformBinaryProcessor.java\nindex 00f45d531c..1a50deb738 100644\n--- a/modules/core/src/main/java/org/apache/ignite/internal/processors/platform/binary/PlatformBinaryProcessor.java\n+++ b/modules/core/src/main/java/org/apache/ignite/internal/processors/platform/binary/PlatformBinaryProcessor.java\n\n@@ -128,23 +129,19 @@ public class PlatformBinaryProcessor extends PlatformAbstractTarget {\n             case OP_GET_TYPE: {\n                 int typeId = reader.readInt();\n \n-                ClassNotFoundException err = null;\n+                String err = null;\n \n                 for (byte platformId : new byte[] {DOTNET_ID, JAVA_ID}) {\n-                    try {\n-                        String typeName = platformContext().kernalContext().marshallerContext()\n-                            .getClassName(platformId, typeId);\n+                    T2<String, String> res = platformContext().kernalContext().marshallerContext()\n+                        .getClassNameUnthrowable(platformId, typeId, false);\n \n-                        writer.writeString(typeName);\n-\n-                        err = null;\n+                    if (res.get1() != null) {\n+                        writer.writeString(res.get1());\n \n                         break;\n                     }\n-                    catch (ClassNotFoundException e) {\n-                        if (err == null)\n-                            err = e;\n-                    }\n+                    else if (err == null)\n+                        err = res.get2();\n                 }\n \n                 if (err != null)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjg1NjUyNg==", "url": "https://github.com/apache/ignite/pull/8509#discussion_r532856526", "bodyText": "JAVA_ID should come last - in most cases, platform type will be resolved, not a Java type.", "author": "ptupitsyn", "createdAt": "2020-11-30T19:47:37Z", "path": "modules/core/src/main/java/org/apache/ignite/internal/MarshallerContextImpl.java", "diffHunk": "@@ -368,12 +369,27 @@ public void onMappingAccepted(final MarshallerMappingItem item) {\n \n     /** {@inheritDoc} */\n     @Override public Class getClass(int typeId, ClassLoader ldr) throws ClassNotFoundException, IgniteCheckedException {\n-        String clsName = getClassName(JAVA_ID, typeId);\n+        String clsName;\n+\n+        ClassNotFoundException err = null;\n+\n+        for (byte platformId : new byte[] {JAVA_ID, DOTNET_ID}) {", "originalCommit": "6ba6af0b8c3cb2c98f87d5fbffeafed2f063866f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzIyNjA1OQ==", "url": "https://github.com/apache/ignite/pull/8509#discussion_r533226059", "bodyText": "Fixed", "author": "nizhikov", "createdAt": "2020-12-01T09:34:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjg1NjUyNg=="}], "type": "inlineReview", "revised_code": {"commit": "c8e40b97723271c3dcedfca502316d3b8118bf0f", "chunk": "diff --git a/modules/core/src/main/java/org/apache/ignite/internal/MarshallerContextImpl.java b/modules/core/src/main/java/org/apache/ignite/internal/MarshallerContextImpl.java\nindex 1f25519173..a633d87942 100644\n--- a/modules/core/src/main/java/org/apache/ignite/internal/MarshallerContextImpl.java\n+++ b/modules/core/src/main/java/org/apache/ignite/internal/MarshallerContextImpl.java\n\n@@ -373,7 +373,7 @@ public class MarshallerContextImpl implements MarshallerContext {\n \n         ClassNotFoundException err = null;\n \n-        for (byte platformId : new byte[] {JAVA_ID, DOTNET_ID}) {\n+        for (byte platformId : new byte[] {DOTNET_ID, JAVA_ID}) {\n             try {\n                 clsName = getClassName(platformId, typeId);\n \n"}}, {"oid": "18e1e1675bbd236e1f64edc95d88ae450c1cabf5", "url": "https://github.com/apache/ignite/commit/18e1e1675bbd236e1f64edc95d88ae450c1cabf5", "message": "IGNITE-10075: Inspection fix.", "committedDate": "2020-12-01T09:14:45Z", "type": "commit"}, {"oid": "ea5c209a54c468cf302e48b039b5c98df4e4bef0", "url": "https://github.com/apache/ignite/commit/ea5c209a54c468cf302e48b039b5c98df4e4bef0", "message": "IGNITE-10075: Tests fix", "committedDate": "2020-12-01T09:18:54Z", "type": "commit"}, {"oid": "c8e40b97723271c3dcedfca502316d3b8118bf0f", "url": "https://github.com/apache/ignite/commit/c8e40b97723271c3dcedfca502316d3b8118bf0f", "message": "IGNITE-10075: Code review fix.", "committedDate": "2020-12-01T09:43:10Z", "type": "commit"}, {"oid": "a0e3d5050bfd75d0863c26280a1a6bdae1676c73", "url": "https://github.com/apache/ignite/commit/a0e3d5050bfd75d0863c26280a1a6bdae1676c73", "message": "IGNITE-10075: Code review fix.", "committedDate": "2020-12-01T10:57:50Z", "type": "commit"}, {"oid": "9ba075cae15485fe458d8b2df2c214e7735478b4", "url": "https://github.com/apache/ignite/commit/9ba075cae15485fe458d8b2df2c214e7735478b4", "message": "IGNITE-10075: Code review fix.", "committedDate": "2020-12-01T10:59:28Z", "type": "commit"}, {"oid": "68ff425d91e1265d9bd6bb23209f7f6632cb8a55", "url": "https://github.com/apache/ignite/commit/68ff425d91e1265d9bd6bb23209f7f6632cb8a55", "message": "IGNITE-10075: Code review fix.", "committedDate": "2020-12-01T11:00:50Z", "type": "commit"}, {"oid": "41b5e42f82b117ea92e2814eb357925ac4839b99", "url": "https://github.com/apache/ignite/commit/41b5e42f82b117ea92e2814eb357925ac4839b99", "message": "IGNITE-10075: Code review fix.", "committedDate": "2020-12-01T11:02:18Z", "type": "commit"}, {"oid": "f561572c85b0e69fc3fd7bb3c454d4722eec46fd", "url": "https://github.com/apache/ignite/commit/f561572c85b0e69fc3fd7bb3c454d4722eec46fd", "message": "IGNITE-10075: Code review fix.", "committedDate": "2020-12-01T11:06:36Z", "type": "commit"}, {"oid": "0e4f4ec454fb5149b14bead2accc9650931bb200", "url": "https://github.com/apache/ignite/commit/0e4f4ec454fb5149b14bead2accc9650931bb200", "message": "IGNITE-10075: Code review fix.", "committedDate": "2020-12-01T11:14:25Z", "type": "commit"}, {"oid": "22ab566b74eb44f17940ced272a7d7b7b03cbfed", "url": "https://github.com/apache/ignite/commit/22ab566b74eb44f17940ced272a7d7b7b03cbfed", "message": "IGNITE-10075: Code review fix.", "committedDate": "2020-12-01T11:17:29Z", "type": "commit"}, {"oid": "cca4b9846166886412c630db5e1ebd6f59a5397b", "url": "https://github.com/apache/ignite/commit/cca4b9846166886412c630db5e1ebd6f59a5397b", "message": "IGNITE-10075: Code review fix.", "committedDate": "2020-12-01T11:19:15Z", "type": "commit"}, {"oid": "96b78669447aa49af56e7eb1378fd29b19ff1957", "url": "https://github.com/apache/ignite/commit/96b78669447aa49af56e7eb1378fd29b19ff1957", "message": "IGNITE-10075: Code review fix.", "committedDate": "2020-12-01T11:24:23Z", "type": "commit"}, {"oid": "73df4f8c4661ac2e4505b46d3985ae8400126af6", "url": "https://github.com/apache/ignite/commit/73df4f8c4661ac2e4505b46d3985ae8400126af6", "message": "IGNITE-10075: Code review fix.", "committedDate": "2020-12-01T11:30:22Z", "type": "commit"}, {"oid": "9df3e3d58a05d31ef1ce6a1daca8e0e80eb51654", "url": "https://github.com/apache/ignite/commit/9df3e3d58a05d31ef1ce6a1daca8e0e80eb51654", "message": "Merge branch 'master' into IGNITE-10075", "committedDate": "2020-12-01T14:43:37Z", "type": "commit"}, {"oid": "15d376ad4f9d378b395f7c62b5a96d4d952ea628", "url": "https://github.com/apache/ignite/commit/15d376ad4f9d378b395f7c62b5a96d4d952ea628", "message": "IGNITE-10075: Fix tests.", "committedDate": "2020-12-01T19:00:02Z", "type": "commit"}, {"oid": "dc068e366f24b982f2986147845ba747d863714c", "url": "https://github.com/apache/ignite/commit/dc068e366f24b982f2986147845ba747d863714c", "message": "IGNITE-10075: Fix tests.", "committedDate": "2020-12-02T09:04:05Z", "type": "commit"}, {"oid": "9af231f19052b4571f0f13e7530683cd34fb7156", "url": "https://github.com/apache/ignite/commit/9af231f19052b4571f0f13e7530683cd34fb7156", "message": "IGNITE-10075: Fix tests.", "committedDate": "2020-12-02T11:33:07Z", "type": "commit"}, {"oid": "a5470232aeec80cdaebf16e20609e28f363182fe", "url": "https://github.com/apache/ignite/commit/a5470232aeec80cdaebf16e20609e28f363182fe", "message": "Merge branch 'master' into IGNITE-10075", "committedDate": "2020-12-02T18:01:13Z", "type": "commit"}, {"oid": "b92eb31940dfb5ad9365868305fc14a13dbc6a3f", "url": "https://github.com/apache/ignite/commit/b92eb31940dfb5ad9365868305fc14a13dbc6a3f", "message": "IGNITE-10075: Fix reworked.", "committedDate": "2020-12-03T11:08:29Z", "type": "commit"}, {"oid": "8d7f4bb67e8d43d0388b31a65443b107c894750d", "url": "https://github.com/apache/ignite/commit/8d7f4bb67e8d43d0388b31a65443b107c894750d", "message": "IGNITE-10075: Fix reworked.", "committedDate": "2020-12-03T11:14:23Z", "type": "commit"}, {"oid": "d71e15ff93dc6be6f943becd613e29c5733e0468", "url": "https://github.com/apache/ignite/commit/d71e15ff93dc6be6f943becd613e29c5733e0468", "message": "IGNITE-10075: Fix reworked.", "committedDate": "2020-12-03T16:14:23Z", "type": "commit"}, {"oid": "6ce64905ab1ebd827dabd0c1646e784b2b57a58e", "url": "https://github.com/apache/ignite/commit/6ce64905ab1ebd827dabd0c1646e784b2b57a58e", "message": "IGNITE-10075: Fix reworked.", "committedDate": "2020-12-03T16:22:37Z", "type": "commit"}, {"oid": "6c528c87fbd2562ac4641a9b0db83c55592ea941", "url": "https://github.com/apache/ignite/commit/6c528c87fbd2562ac4641a9b0db83c55592ea941", "message": "IGNITE-10075: Fix reworked.", "committedDate": "2020-12-03T16:23:40Z", "type": "commit"}, {"oid": "91c9553dba401345bfb407710b67eedd52e97d0b", "url": "https://github.com/apache/ignite/commit/91c9553dba401345bfb407710b67eedd52e97d0b", "message": "IGNITE-10075: WIP", "committedDate": "2020-12-04T09:15:29Z", "type": "commit"}, {"oid": "d9df1605d5d48e5f2cf39187b0626f2f9307d309", "url": "https://github.com/apache/ignite/commit/d9df1605d5d48e5f2cf39187b0626f2f9307d309", "message": "IGNITE-10075: WIP", "committedDate": "2020-12-04T09:18:18Z", "type": "commit"}, {"oid": "96373c98352f029a4fcdd34aad607ee2e50dba5c", "url": "https://github.com/apache/ignite/commit/96373c98352f029a4fcdd34aad607ee2e50dba5c", "message": "IGNITE-10075: WIP", "committedDate": "2020-12-04T16:00:55Z", "type": "commit"}, {"oid": "c31749ed419fdf3eb96b84814b53404831ba5725", "url": "https://github.com/apache/ignite/commit/c31749ed419fdf3eb96b84814b53404831ba5725", "message": "IGNITE-10075: Code review fix.", "committedDate": "2020-12-07T09:22:49Z", "type": "commit"}, {"oid": "c17528d38b1b1d09225ced99bb32db4768cdf542", "url": "https://github.com/apache/ignite/commit/c17528d38b1b1d09225ced99bb32db4768cdf542", "message": "IGNITE-10075: Code review fix.", "committedDate": "2020-12-07T15:30:38Z", "type": "commit"}, {"oid": "6d9ecb22dec82e92b9f75ea51c2f2bbd00dc0249", "url": "https://github.com/apache/ignite/commit/6d9ecb22dec82e92b9f75ea51c2f2bbd00dc0249", "message": "IGNITE-10075: Code review fix.", "committedDate": "2020-12-07T15:32:15Z", "type": "commit"}, {"oid": "3b3199ff0e7550a960909710afa1bc1c49fdf74a", "url": "https://github.com/apache/ignite/commit/3b3199ff0e7550a960909710afa1bc1c49fdf74a", "message": "IGNITE-10075: Code review fix.", "committedDate": "2020-12-07T15:34:28Z", "type": "commit"}, {"oid": "38fb925911bf91c08117913d8f74cd91e247e7bf", "url": "https://github.com/apache/ignite/commit/38fb925911bf91c08117913d8f74cd91e247e7bf", "message": "IGNITE-10075: Code review fix.", "committedDate": "2020-12-07T16:31:27Z", "type": "commit"}, {"oid": "c1f94c1bc933572062b431fdd1a1c166b6698502", "url": "https://github.com/apache/ignite/commit/c1f94c1bc933572062b431fdd1a1c166b6698502", "message": "IGNITE-10075: Code review fix.", "committedDate": "2020-12-07T18:14:43Z", "type": "commit"}, {"oid": "24b51a7a6ae423e1d35ae393738e2ca2d95a3d13", "url": "https://github.com/apache/ignite/commit/24b51a7a6ae423e1d35ae393738e2ca2d95a3d13", "message": "IGNITE-10075: Compilation fix.", "committedDate": "2020-12-07T19:22:49Z", "type": "commit"}, {"oid": "52ffd39433804743cf2eed974f3e608d0755bc11", "url": "https://github.com/apache/ignite/commit/52ffd39433804743cf2eed974f3e608d0755bc11", "message": "IGNITE-10075: Compilation fix.", "committedDate": "2020-12-07T19:57:16Z", "type": "commit"}]}