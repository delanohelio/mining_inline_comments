{"pr_number": 7787, "pr_title": "IGNITE-12961: Add snapshot create command to control.sh", "pr_createdAt": "2020-05-08T15:34:00Z", "pr_url": "https://github.com/apache/ignite/pull/7787", "timeline": [{"oid": "c85361f7c61776febb3ac8ff85ec4b4804b6069e", "url": "https://github.com/apache/ignite/commit/c85361f7c61776febb3ac8ff85ec4b4804b6069e", "message": "IGNITE-12961: WIP", "committedDate": "2020-04-30T15:09:47Z", "type": "commit"}, {"oid": "5b434540cf2426d3435b67e64f9e8032a9273cf9", "url": "https://github.com/apache/ignite/commit/5b434540cf2426d3435b67e64f9e8032a9273cf9", "message": "IGNITE-12961: implement snapshot command", "committedDate": "2020-05-02T12:41:23Z", "type": "commit"}, {"oid": "25ae1baa892b85f00cbfa45b79e5b4aa528e2845", "url": "https://github.com/apache/ignite/commit/25ae1baa892b85f00cbfa45b79e5b4aa528e2845", "message": "Merge branch 'master' into ignite-12961", "committedDate": "2020-05-03T09:43:29Z", "type": "commit"}, {"oid": "e55031ca0022ec65ef952f07e432298f5bfe1f67", "url": "https://github.com/apache/ignite/commit/e55031ca0022ec65ef952f07e432298f5bfe1f67", "message": "IGNITE-12961: throw ex immediately", "committedDate": "2020-05-03T14:21:40Z", "type": "commit"}, {"oid": "8b1095e7df1886457e3758da1585966c33eb3286", "url": "https://github.com/apache/ignite/commit/8b1095e7df1886457e3758da1585966c33eb3286", "message": "Merge branch 'master' into ignite-12961", "committedDate": "2020-05-08T15:31:43Z", "type": "commit"}, {"oid": "7ac2e1baf4289346a2a7720e167c843abc705bec", "url": "https://github.com/apache/ignite/commit/7ac2e1baf4289346a2a7720e167c843abc705bec", "message": "Merge branch 'master' into ignite-12961", "committedDate": "2020-05-14T13:32:33Z", "type": "commit"}, {"oid": "218c312bef42753ede5fbb3754e7ac62992b05b9", "url": "https://github.com/apache/ignite/commit/218c312bef42753ede5fbb3754e7ac62992b05b9", "message": "Merge branch 'master' into ignite-12961", "committedDate": "2020-05-18T10:36:58Z", "type": "commit"}, {"oid": "d192284441843893206b9f9e3731c9dc95089830", "url": "https://github.com/apache/ignite/commit/d192284441843893206b9f9e3731c9dc95089830", "message": "IGNITE-12961: fix snapshot control.sh command", "committedDate": "2020-05-18T15:46:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjczNDYxNA==", "url": "https://github.com/apache/ignite/pull/7787#discussion_r426734614", "bodyText": "Let's check that a snapshot was created with provided name.", "author": "NSAmelchev", "createdAt": "2020-05-18T16:02:26Z", "path": "modules/core/src/test/java/org/apache/ignite/util/GridCommandHandlerTest.java", "diffHunk": "@@ -2089,4 +2089,28 @@ public void testMasterKeyChangeOnInactiveCluster() throws Exception {\n \n         assertContains(log, testOut.toString(), \"Master key change was rejected. The cluster is inactive.\");\n     }\n+\n+    /** @throws Exception If failed. */\n+    @Test\n+    public void testClusterSnapshotCreate() throws Exception {\n+        Ignite ignite = startGrids(2);\n+        ignite.cluster().state(ACTIVE);\n+\n+        createCacheAndPreload(ignite, 10);\n+\n+        CommandHandler h = new CommandHandler();\n+\n+        assertEquals(EXIT_CODE_OK, execute(h, \"--snapshot\", \"create\", \"snapshot_02052020\"));", "originalCommit": "d192284441843893206b9f9e3731c9dc95089830", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bcf7a4ccf46d0fc09f38b6ae30918c5680228aa3", "chunk": "diff --git a/modules/core/src/test/java/org/apache/ignite/util/GridCommandHandlerTest.java b/modules/core/src/test/java/org/apache/ignite/util/GridCommandHandlerTest.java\nindex 6514aa7b62..f5e3f0014c 100644\n--- a/modules/core/src/test/java/org/apache/ignite/util/GridCommandHandlerTest.java\n+++ b/modules/core/src/test/java/org/apache/ignite/util/GridCommandHandlerTest.java\n\n@@ -2093,14 +2100,51 @@ public class GridCommandHandlerTest extends GridCommandHandlerClusterPerMethodAb\n     /** @throws Exception If failed. */\n     @Test\n     public void testClusterSnapshotCreate() throws Exception {\n-        Ignite ignite = startGrids(2);\n+        int grids = 2;\n+        int keys = 100;\n+        String snpName = \"snapshot_02052020\";\n+\n+        ListeningTestLogger srv0Logger = new ListeningTestLogger(log);\n+        LogListener snpEndLsnr = LogListener.matches(\"Cluster-wide snapshot operation finished successfully\").build();\n+        srv0Logger.registerListener(snpEndLsnr);\n+\n+        logger = srv0Logger;\n+\n+        injectTestSystemOut();\n+\n+        Ignite ignite = startGrids(grids);\n         ignite.cluster().state(ACTIVE);\n \n-        createCacheAndPreload(ignite, 10);\n+        createCacheAndPreload(ignite, keys);\n \n         CommandHandler h = new CommandHandler();\n \n-        assertEquals(EXIT_CODE_OK, execute(h, \"--snapshot\", \"create\", \"snapshot_02052020\"));\n+        assertEquals(EXIT_CODE_OK, execute(h, \"--snapshot\", \"create\", snpName));\n+\n+        assertTrue(\"Snapshot operation hasn't been completed successfully.\",\n+            waitForCondition(snpEndLsnr::check, 5_000L));\n+\n+        assertContains(log, (String)h.getLastOperationResult(), snpName);\n+\n+        logger = null;\n+\n+        stopAllGrids();\n+\n+        for (int i = 0; i < grids; i++) {\n+            IgniteConfiguration cfg = optimize(getConfiguration(getTestIgniteInstanceName(i)));\n+\n+            cfg.setWorkDirectory(Paths.get(resolveSnapshotWorkDirectory(cfg).getAbsolutePath(), snpName).toString());\n+\n+            startGrid(cfg);\n+        }\n+\n+        grid(0).cluster().state(ACTIVE);\n+\n+        List<Integer> range = IntStream.range(0, keys).boxed().collect(Collectors.toList());\n+\n+        grid(0).cache(DEFAULT_CACHE_NAME).query(new ScanQuery<>(null))\n+            .forEach(e -> range.remove((Integer)e.getKey()));\n+        assertTrue(\"Snapshot must contains cache data [left=\" + range + ']', range.isEmpty());\n     }\n \n     /** @throws Exception If failed. */\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc0MjczOA==", "url": "https://github.com/apache/ignite/pull/7787#discussion_r426742738", "bodyText": "I suggest that success command execution prints an informative message. For example, the snapshot was(will be) created. And how to monitor the status.", "author": "NSAmelchev", "createdAt": "2020-05-18T16:14:56Z", "path": "modules/core/src/main/java/org/apache/ignite/internal/visor/snapshot/VisorSnapshotCreateTask.java", "diffHunk": "@@ -0,0 +1,62 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.ignite.internal.visor.snapshot;\n+\n+import org.apache.ignite.IgniteException;\n+import org.apache.ignite.IgniteSnapshot;\n+import org.apache.ignite.internal.commandline.snapshot.SnapshotCommand;\n+import org.apache.ignite.internal.processors.cache.persistence.snapshot.SnapshotMXBeanImpl;\n+import org.apache.ignite.internal.processors.task.GridInternal;\n+import org.apache.ignite.internal.visor.VisorJob;\n+import org.apache.ignite.internal.visor.VisorOneNodeTask;\n+\n+/**\n+ * @see SnapshotCommand\n+ * @see IgniteSnapshot#createSnapshot(String)\n+ */\n+@GridInternal\n+public class VisorSnapshotCreateTask extends VisorOneNodeTask<String, Void> {\n+    /** Serial version uid. */\n+    private static final long serialVersionUID = 0L;\n+\n+    /** {@inheritDoc} */\n+    @Override protected VisorJob<String, Void> job(String arg) {\n+        return new VisorSnapshotCreateJob(arg, debug);\n+    }\n+\n+    /** */\n+    private static class VisorSnapshotCreateJob extends VisorJob<String, Void> {\n+        /** Serial version uid. */\n+        private static final long serialVersionUID = 0L;\n+\n+        /**\n+         * @param name Snapshot name.\n+         * @param debug Flag indicating whether debug information should be printed into node log.\n+         */\n+        protected VisorSnapshotCreateJob(String name, boolean debug) {\n+            super(name, debug);\n+        }\n+\n+        /** {@inheritDoc} */\n+        @Override protected Void run(String name) throws IgniteException {\n+            new SnapshotMXBeanImpl(ignite.context()).createSnapshot(name);\n+\n+            return null;", "originalCommit": "d192284441843893206b9f9e3731c9dc95089830", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bcf7a4ccf46d0fc09f38b6ae30918c5680228aa3", "chunk": "diff --git a/modules/core/src/main/java/org/apache/ignite/internal/visor/snapshot/VisorSnapshotCreateTask.java b/modules/core/src/main/java/org/apache/ignite/internal/visor/snapshot/VisorSnapshotCreateTask.java\nindex b8dc65ef4b..16fccbaac8 100644\n--- a/modules/core/src/main/java/org/apache/ignite/internal/visor/snapshot/VisorSnapshotCreateTask.java\n+++ b/modules/core/src/main/java/org/apache/ignite/internal/visor/snapshot/VisorSnapshotCreateTask.java\n\n@@ -30,17 +30,17 @@ import org.apache.ignite.internal.visor.VisorOneNodeTask;\n  * @see IgniteSnapshot#createSnapshot(String)\n  */\n @GridInternal\n-public class VisorSnapshotCreateTask extends VisorOneNodeTask<String, Void> {\n+public class VisorSnapshotCreateTask extends VisorOneNodeTask<String, String> {\n     /** Serial version uid. */\n     private static final long serialVersionUID = 0L;\n \n     /** {@inheritDoc} */\n-    @Override protected VisorJob<String, Void> job(String arg) {\n+    @Override protected VisorJob<String, String> job(String arg) {\n         return new VisorSnapshotCreateJob(arg, debug);\n     }\n \n     /** */\n-    private static class VisorSnapshotCreateJob extends VisorJob<String, Void> {\n+    private static class VisorSnapshotCreateJob extends VisorJob<String, String> {\n         /** Serial version uid. */\n         private static final long serialVersionUID = 0L;\n \n"}}, {"oid": "bcf7a4ccf46d0fc09f38b6ae30918c5680228aa3", "url": "https://github.com/apache/ignite/commit/bcf7a4ccf46d0fc09f38b6ae30918c5680228aa3", "message": "IGNITE-12961: fix review comments", "committedDate": "2020-05-18T20:18:51Z", "type": "commit"}, {"oid": "340aecbc6a5fbad57aea8b12ec60046d2fd3854e", "url": "https://github.com/apache/ignite/commit/340aecbc6a5fbad57aea8b12ec60046d2fd3854e", "message": "IGNITE-12961: fix review comments 2", "committedDate": "2020-05-19T17:47:42Z", "type": "commit"}, {"oid": "d642397caafc57124b93b03edc7a0ed3a0a5b2f5", "url": "https://github.com/apache/ignite/commit/d642397caafc57124b93b03edc7a0ed3a0a5b2f5", "message": "Merge branch 'master' into ignite-12961", "committedDate": "2020-05-19T18:29:27Z", "type": "commit"}, {"oid": "5a9501759d4b4cb88cedecae0129d5888a5c4939", "url": "https://github.com/apache/ignite/commit/5a9501759d4b4cb88cedecae0129d5888a5c4939", "message": "IGNITE-12961: fix usage", "committedDate": "2020-05-19T18:50:42Z", "type": "commit"}, {"oid": "8390b16130f91cb3c4c9a597c1c907fbe0970727", "url": "https://github.com/apache/ignite/commit/8390b16130f91cb3c4c9a597c1c907fbe0970727", "message": "IGNITE-12961: fix flaky test", "committedDate": "2020-05-20T10:39:01Z", "type": "commit"}, {"oid": "ceffd82a660c429add6318ccec19cfdc72258388", "url": "https://github.com/apache/ignite/commit/ceffd82a660c429add6318ccec19cfdc72258388", "message": "IGNITE-12961: improve test err logging", "committedDate": "2020-05-20T16:45:06Z", "type": "commit"}, {"oid": "4849381426bfb74b280be1a4c3375ba24a206951", "url": "https://github.com/apache/ignite/commit/4849381426bfb74b280be1a4c3375ba24a206951", "message": "IGNITE-12961: set default test timeout", "committedDate": "2020-05-21T08:54:53Z", "type": "commit"}, {"oid": "9b617dade43d17f3a24423628dac97b269ddd64f", "url": "https://github.com/apache/ignite/commit/9b617dade43d17f3a24423628dac97b269ddd64f", "message": "IGNITE-12961: set jmx exporter locally", "committedDate": "2020-05-21T10:25:34Z", "type": "commit"}, {"oid": "5693d160214246627abab7eae187bc837b461f9a", "url": "https://github.com/apache/ignite/commit/5693d160214246627abab7eae187bc837b461f9a", "message": "IGNITE-12961: fix test", "committedDate": "2020-05-21T15:05:45Z", "type": "commit"}, {"oid": "d3f34c98def73893a4039e44ecd8cccd8ada11fc", "url": "https://github.com/apache/ignite/commit/d3f34c98def73893a4039e44ecd8cccd8ada11fc", "message": "IGNITE-12961: fix test 2", "committedDate": "2020-05-21T15:10:56Z", "type": "commit"}]}