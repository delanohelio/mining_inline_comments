{"pr_number": 8028, "pr_title": "IGNITE-13126: Reduce continuous query heap usage", "pr_createdAt": "2020-07-13T10:01:49Z", "pr_url": "https://github.com/apache/ignite/pull/8028", "timeline": [{"oid": "fd42c97c186c7c82239799db637d8148493fed9b", "url": "https://github.com/apache/ignite/commit/fd42c97c186c7c82239799db637d8148493fed9b", "message": "IGNITE-13126: change backupQ", "committedDate": "2020-07-13T10:00:58Z", "type": "commit"}, {"oid": "9bc7e0f8cbcaa6837b21d86821b72094604ae703", "url": "https://github.com/apache/ignite/commit/9bc7e0f8cbcaa6837b21d86821b72094604ae703", "message": "IGNITE-13126: wip", "committedDate": "2020-07-13T14:12:50Z", "type": "commit"}, {"oid": "6772765b7e83b0ef90a94ea7ee928bdf2c8398b2", "url": "https://github.com/apache/ignite/commit/6772765b7e83b0ef90a94ea7ee928bdf2c8398b2", "message": "IGNITE-13126: wip", "committedDate": "2020-07-13T14:22:48Z", "type": "commit"}, {"oid": "309c5c089e544f5aa7bd341288b4f2737ebf0725", "url": "https://github.com/apache/ignite/commit/309c5c089e544f5aa7bd341288b4f2737ebf0725", "message": "IGNITE-13126: wip", "committedDate": "2020-07-13T14:34:47Z", "type": "commit"}, {"oid": "c0ea34ae41725c1b973ccc9cce17a584641ef8f0", "url": "https://github.com/apache/ignite/commit/c0ea34ae41725c1b973ccc9cce17a584641ef8f0", "message": "IGNITE-13126: wip", "committedDate": "2020-07-13T14:40:19Z", "type": "commit"}, {"oid": "8fe5582938091adf21fe46651f83073d6e9c5fc5", "url": "https://github.com/apache/ignite/commit/8fe5582938091adf21fe46651f83073d6e9c5fc5", "message": "IGNITE-13126: wip", "committedDate": "2020-07-13T14:44:33Z", "type": "commit"}, {"oid": "fd5a08684f354f8c1af1d1126c717ca66f40dee1", "url": "https://github.com/apache/ignite/commit/fd5a08684f354f8c1af1d1126c717ca66f40dee1", "message": "IGNITE-13126: wip", "committedDate": "2020-07-13T15:48:30Z", "type": "commit"}, {"oid": "2f68ab75611e7ea053e6b546dc70e72f72ff6738", "url": "https://github.com/apache/ignite/commit/2f68ab75611e7ea053e6b546dc70e72f72ff6738", "message": "IGNITE-13126: wip", "committedDate": "2020-07-13T15:55:30Z", "type": "commit"}, {"oid": "dc22390258282bb23aaef2e69509bdb2812cd13c", "url": "https://github.com/apache/ignite/commit/dc22390258282bb23aaef2e69509bdb2812cd13c", "message": "IGNITE-13126: wip", "committedDate": "2020-07-14T11:07:00Z", "type": "commit"}, {"oid": "0f9356f5e64d47f5bfc4d18f27af9864ee6b42f9", "url": "https://github.com/apache/ignite/commit/0f9356f5e64d47f5bfc4d18f27af9864ee6b42f9", "message": "Merge branch 'master' into ignite-13126", "committedDate": "2020-07-23T17:30:56Z", "type": "commit"}, {"oid": "7f5ce67ffdaaf42c4087a1500bfb1a4d35e8e263", "url": "https://github.com/apache/ignite/commit/7f5ce67ffdaaf42c4087a1500bfb1a4d35e8e263", "message": "Merge branch 'master' into ignite-13126", "committedDate": "2020-08-03T09:38:20Z", "type": "commit"}, {"oid": "1750aa594bba7ad218cd2c753d1931544e8978d4", "url": "https://github.com/apache/ignite/commit/1750aa594bba7ad218cd2c753d1931544e8978d4", "message": "Merge branch 'master' into ignite-13126", "committedDate": "2020-08-03T11:59:36Z", "type": "commit"}, {"oid": "2da362530e79e8695cda570560f6857e93043710", "url": "https://github.com/apache/ignite/commit/2da362530e79e8695cda570560f6857e93043710", "message": "Merge branch 'master' into ignite-13126", "committedDate": "2020-08-05T13:14:29Z", "type": "commit"}, {"oid": "c365757516c71d5bc62e3c93098cb37c665b8419", "url": "https://github.com/apache/ignite/commit/c365757516c71d5bc62e3c93098cb37c665b8419", "message": "Merge branch 'master' into ignite-13126", "committedDate": "2020-09-04T19:46:03Z", "type": "commit"}, {"oid": "a1ce7db2c642dfad4345f72bef7eb4ae74b6713a", "url": "https://github.com/apache/ignite/commit/a1ce7db2c642dfad4345f72bef7eb4ae74b6713a", "message": "Merge branch 'master' into ignite-13126", "committedDate": "2020-09-04T19:58:56Z", "type": "commit"}, {"oid": "b8e497b96ee2d2b3b327b4fa148c5ace745e9ae1", "url": "https://github.com/apache/ignite/commit/b8e497b96ee2d2b3b327b4fa148c5ace745e9ae1", "message": "WIP", "committedDate": "2020-09-07T16:54:06Z", "type": "commit"}, {"oid": "24f1604dbd20006233502ebaed7a1f0ddb1eb930", "url": "https://github.com/apache/ignite/commit/24f1604dbd20006233502ebaed7a1f0ddb1eb930", "message": "Merge branch 'master' into ignite-13126", "committedDate": "2020-09-07T16:54:47Z", "type": "commit"}, {"oid": "9e7eeae6869c5ad2eb69ed88eb4f4f0b516290ba", "url": "https://github.com/apache/ignite/commit/9e7eeae6869c5ad2eb69ed88eb4f4f0b516290ba", "message": "IGNITE-13126 update cq filtered entries creation", "committedDate": "2020-09-08T16:48:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzAwMzg5OA==", "url": "https://github.com/apache/ignite/pull/8028#discussion_r487003898", "bodyText": "Add line break, please", "author": "NSAmelchev", "createdAt": "2020-09-11T12:13:32Z", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/query/continuous/CacheContinuousQueryEventBuffer.java", "diffHunk": "@@ -76,80 +78,58 @@\n     private final GridAtomicLong ackedUpdCntr = new GridAtomicLong(0);\n \n     /**\n-     * @param part Partition number.\n+     * @param currPartCntr Current partition counter.\n      * @param log Continuous query category logger.\n      */\n-    CacheContinuousQueryEventBuffer(int part, IgniteLogger log) {\n-        this.part = part;\n+    CacheContinuousQueryEventBuffer(LongUnaryOperator currPartCntr, IgniteLogger log) {\n+        this.currPartCntr = currPartCntr;\n         this.log = log;\n     }\n \n     /**\n-     * @param part Partition number.\n+     * @param log Continuous query category logger.\n      */\n-    CacheContinuousQueryEventBuffer(int part) {\n-        this(part, null);\n+    CacheContinuousQueryEventBuffer(IgniteLogger log) {\n+        this((backup) -> 0, log);\n     }\n \n     /**\n      * @param updateCntr Acknowledged counter.\n      */\n-    void cleanupBackupQueue(Long updateCntr) {\n-        Iterator<CacheContinuousQueryEntry> it = backupQ.iterator();\n-\n-        while (it.hasNext()) {\n-            CacheContinuousQueryEntry backupEntry = it.next();\n-\n-            if (backupEntry.updateCounter() <= updateCntr)\n-                it.remove();\n-        }\n-\n+    void cleanupOnAck(long updateCntr) {\n+        backupQ.removeIf(backupEntry -> backupEntry.updateCounter() <= updateCntr);", "originalCommit": "9e7eeae6869c5ad2eb69ed88eb4f4f0b516290ba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzc5MzI2Mg==", "url": "https://github.com/apache/ignite/pull/8028#discussion_r487793262", "bodyText": "Fixed", "author": "Mmuzaf", "createdAt": "2020-09-14T09:58:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzAwMzg5OA=="}], "type": "inlineReview", "revised_code": {"commit": "f60d29a5ddbac0db19f301242de7fa13b1735deb", "chunk": "diff --git a/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/query/continuous/CacheContinuousQueryEventBuffer.java b/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/query/continuous/CacheContinuousQueryEventBuffer.java\nindex 68ade442e6..6d9709d574 100644\n--- a/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/query/continuous/CacheContinuousQueryEventBuffer.java\n+++ b/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/query/continuous/CacheContinuousQueryEventBuffer.java\n\n@@ -98,6 +99,7 @@ public class CacheContinuousQueryEventBuffer {\n      */\n     void cleanupOnAck(long updateCntr) {\n         backupQ.removeIf(backupEntry -> backupEntry.updateCounter() <= updateCntr);\n+\n         ackedUpdCntr.setIfGreater(updateCntr);\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzAwNjYyNg==", "url": "https://github.com/apache/ignite/pull/8028#discussion_r487006626", "bodyText": "I suggest to revert this change. It's not related to the issue.", "author": "NSAmelchev", "createdAt": "2020-09-11T12:19:15Z", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/query/continuous/CacheContinuousQueryPartitionRecovery.java", "diffHunk": "@@ -155,8 +155,8 @@ void resetTopologyCache() {\n                     if (!entry.isFiltered())\n                         entries.add(new CacheContinuousQueryEvent<K, V>(cache, cctx, entry));\n \n-                    if (log.isDebugEnabled())\n-                        log.debug(\"Partition was lost [lastFiredEvt=\" + lastFiredEvt +\n+                    if (log.isInfoEnabled())", "originalCommit": "9e7eeae6869c5ad2eb69ed88eb4f4f0b516290ba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzc5MzM0NA==", "url": "https://github.com/apache/ignite/pull/8028#discussion_r487793344", "bodyText": "Reverted.", "author": "Mmuzaf", "createdAt": "2020-09-14T09:58:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzAwNjYyNg=="}], "type": "inlineReview", "revised_code": {"commit": "f60d29a5ddbac0db19f301242de7fa13b1735deb", "chunk": "diff --git a/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/query/continuous/CacheContinuousQueryPartitionRecovery.java b/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/query/continuous/CacheContinuousQueryPartitionRecovery.java\nindex d4bf610cf5..0b43c82188 100644\n--- a/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/query/continuous/CacheContinuousQueryPartitionRecovery.java\n+++ b/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/query/continuous/CacheContinuousQueryPartitionRecovery.java\n\n@@ -155,8 +155,8 @@ class CacheContinuousQueryPartitionRecovery {\n                     if (!entry.isFiltered())\n                         entries.add(new CacheContinuousQueryEvent<K, V>(cache, cctx, entry));\n \n-                    if (log.isInfoEnabled())\n-                        log.info(\"Partition was lost [lastFiredEvt=\" + lastFiredEvt +\n+                    if (log.isDebugEnabled())\n+                        log.debug(\"Partition was lost [lastFiredEvt=\" + lastFiredEvt +\n                             \", curTop=\" + curTop +\n                             \", entUpdCnt=\" + entry.updateCounter() +\n                             \", partId=\" + entry.partition() +\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA5Njg4Nw==", "url": "https://github.com/apache/ignite/pull/8028#discussion_r487096887", "bodyText": "Empty map can be returned if entries == null || filteredFactory == null", "author": "NSAmelchev", "createdAt": "2020-09-11T14:48:32Z", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/query/continuous/CacheContinuousQueryEventBuffer.java", "diffHunk": "@@ -376,34 +338,32 @@ private Batch initBatch(AffinityTopologyVersion topVer, boolean backup) {\n         /** */\n         private CacheContinuousQueryEntry[] entries;\n \n-        /** */\n-        private final AffinityTopologyVersion topVer;\n-\n         /**\n          * @param filtered Number of filtered events before this batch.\n          * @param entries Entries array.\n-         * @param topVer Current event topology version.\n          * @param startCntr Start counter.\n          */\n-        Batch(long startCntr, long filtered, CacheContinuousQueryEntry[] entries, AffinityTopologyVersion topVer) {\n+        Batch(long startCntr, long filtered, CacheContinuousQueryEntry[] entries) {\n             assert startCntr >= 0;\n             assert filtered >= 0;\n \n             this.startCntr = startCntr;\n             this.filtered = filtered;\n             this.entries = entries;\n-            this.topVer = topVer;\n \n             endCntr = startCntr + BUF_SIZE - 1;\n         }\n \n         /**\n-         * @param res Current entries.\n-         * @return Entries to send as part of backup queue.\n+         * @param filteredFactory Factory which produces filtered entries.\n+         * @return Map of collected entries.\n          */\n-        @Nullable synchronized TreeMap<Long, CacheContinuousQueryEntry> flushCurrentEntries(\n-            @Nullable TreeMap<Long, CacheContinuousQueryEntry> res) {\n-            if (entries == null)\n+        synchronized Map<Long, CacheContinuousQueryEntry> flushCurrentEntries(\n+            BiFunction<Long, Long, CacheContinuousQueryEntry> filteredFactory\n+        ) {\n+            Map<Long, CacheContinuousQueryEntry> res = new HashMap<>();", "originalCommit": "9e7eeae6869c5ad2eb69ed88eb4f4f0b516290ba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA5ODk1OQ==", "url": "https://github.com/apache/ignite/pull/8028#discussion_r487098959", "bodyText": "Can we estimate map size?", "author": "NSAmelchev", "createdAt": "2020-09-11T14:51:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA5Njg4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzc5MzQyNw==", "url": "https://github.com/apache/ignite/pull/8028#discussion_r487793427", "bodyText": "Agree, Fixed.", "author": "Mmuzaf", "createdAt": "2020-09-14T09:59:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA5Njg4Nw=="}], "type": "inlineReview", "revised_code": {"commit": "f60d29a5ddbac0db19f301242de7fa13b1735deb", "chunk": "diff --git a/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/query/continuous/CacheContinuousQueryEventBuffer.java b/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/query/continuous/CacheContinuousQueryEventBuffer.java\nindex 68ade442e6..6d9709d574 100644\n--- a/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/query/continuous/CacheContinuousQueryEventBuffer.java\n+++ b/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/query/continuous/CacheContinuousQueryEventBuffer.java\n\n@@ -361,10 +363,10 @@ public class CacheContinuousQueryEventBuffer {\n         synchronized Map<Long, CacheContinuousQueryEntry> flushCurrentEntries(\n             BiFunction<Long, Long, CacheContinuousQueryEntry> filteredFactory\n         ) {\n-            Map<Long, CacheContinuousQueryEntry> res = new HashMap<>();\n-\n             if (entries == null || filteredFactory == null)\n-                return res;\n+                return Collections.emptyMap();\n+\n+            Map<Long, CacheContinuousQueryEntry> res = new HashMap<>();\n \n             long filtered = this.filtered;\n             long cntr = startCntr;\n"}}, {"oid": "f60d29a5ddbac0db19f301242de7fa13b1735deb", "url": "https://github.com/apache/ignite/commit/f60d29a5ddbac0db19f301242de7fa13b1735deb", "message": "IGNITE-12126 fix review comments", "committedDate": "2020-09-14T09:57:39Z", "type": "commit"}, {"oid": "2425aa1e9ee3ac75f7c623a571d6d33d7b52b776", "url": "https://github.com/apache/ignite/commit/2425aa1e9ee3ac75f7c623a571d6d33d7b52b776", "message": "Merge branch 'master' into ignite-13126", "committedDate": "2020-09-14T10:01:22Z", "type": "commit"}]}