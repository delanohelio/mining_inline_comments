{"pr_number": 8350, "pr_title": "IGNITE-13567 Fixed incorrect value of the joiningNodeClient flag", "pr_createdAt": "2020-10-12T13:54:13Z", "pr_url": "https://github.com/apache/ignite/pull/8350", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzMzMzc2OA==", "url": "https://github.com/apache/ignite/pull/8350#discussion_r503333768", "bodyText": "Lets rename to dataPacket ?", "author": "NSAmelchev", "createdAt": "2020-10-12T14:27:23Z", "path": "modules/core/src/main/java/org/apache/ignite/spi/discovery/tcp/ClientImpl.java", "diffHunk": "@@ -763,8 +763,13 @@ private static void sleepEx(long millis, Runnable before, Runnable after) throws\n                         marshalCredentials(node);\n                     }\n \n-                    if (discoveryData == null)\n-                        discoveryData = spi.collectExchangeData(new DiscoveryDataPacket(getLocalNodeId()));\n+                    if (discoveryData == null) {\n+                        DiscoveryDataPacket discoveryDataPacket = new DiscoveryDataPacket(getLocalNodeId());", "originalCommit": "12e299d3ceeb9f8f77cec09484e0ae187c7c426a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9fe9f2b56aa829b64f51056d716179ae414376e1", "chunk": "diff --git a/modules/core/src/main/java/org/apache/ignite/spi/discovery/tcp/ClientImpl.java b/modules/core/src/main/java/org/apache/ignite/spi/discovery/tcp/ClientImpl.java\nindex 21f5ff0182..55adeda4e7 100644\n--- a/modules/core/src/main/java/org/apache/ignite/spi/discovery/tcp/ClientImpl.java\n+++ b/modules/core/src/main/java/org/apache/ignite/spi/discovery/tcp/ClientImpl.java\n\n@@ -764,11 +764,11 @@ class ClientImpl extends TcpDiscoveryImpl {\n                     }\n \n                     if (discoveryData == null) {\n-                        DiscoveryDataPacket discoveryDataPacket = new DiscoveryDataPacket(getLocalNodeId());\n+                        DiscoveryDataPacket dataPacket = new DiscoveryDataPacket(getLocalNodeId());\n \n-                        discoveryDataPacket.joiningNodeClient(true);\n+                        dataPacket.joiningNodeClient(true);\n \n-                        discoveryData = spi.collectExchangeData(discoveryDataPacket);\n+                        discoveryData = spi.collectExchangeData(dataPacket);\n                     }\n \n                     TcpDiscoveryJoinRequestMessage joinReqMsg = new TcpDiscoveryJoinRequestMessage(node, discoveryData);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzMzNjE4OA==", "url": "https://github.com/apache/ignite/pull/8350#discussion_r503336188", "bodyText": "Can we check that flag was added only once?", "author": "NSAmelchev", "createdAt": "2020-10-12T14:30:47Z", "path": "modules/core/src/test/java/org/apache/ignite/spi/discovery/tcp/TcpClientDiscoverySpiSelfTest.java", "diffHunk": "@@ -2564,6 +2596,21 @@ private void pauseResumeOperation(boolean isPause, AtomicBoolean... locks) {\n             }\n         }\n \n+        /** {@inheritDoc} */\n+        @Override public void setDataExchange(DiscoverySpiDataExchange delegate) {\n+            super.setDataExchange(new DiscoverySpiDataExchange() {\n+                @Override public DiscoveryDataBag collect(DiscoveryDataBag dataBag) {\n+                    joiningNodesClientFlag.putIfAbsent(dataBag.joiningNodeId(), dataBag.isJoiningNodeClient());", "originalCommit": "12e299d3ceeb9f8f77cec09484e0ae187c7c426a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9fe9f2b56aa829b64f51056d716179ae414376e1", "chunk": "diff --git a/modules/core/src/test/java/org/apache/ignite/spi/discovery/tcp/TcpClientDiscoverySpiSelfTest.java b/modules/core/src/test/java/org/apache/ignite/spi/discovery/tcp/TcpClientDiscoverySpiSelfTest.java\nindex 36a5d599bf..4a69d84add 100644\n--- a/modules/core/src/test/java/org/apache/ignite/spi/discovery/tcp/TcpClientDiscoverySpiSelfTest.java\n+++ b/modules/core/src/test/java/org/apache/ignite/spi/discovery/tcp/TcpClientDiscoverySpiSelfTest.java\n\n@@ -2600,7 +2636,8 @@ public class TcpClientDiscoverySpiSelfTest extends GridCommonAbstractTest {\n         @Override public void setDataExchange(DiscoverySpiDataExchange delegate) {\n             super.setDataExchange(new DiscoverySpiDataExchange() {\n                 @Override public DiscoveryDataBag collect(DiscoveryDataBag dataBag) {\n-                    joiningNodesClientFlag.putIfAbsent(dataBag.joiningNodeId(), dataBag.isJoiningNodeClient());\n+                    if (dataExchangeCollectClosure != null)\n+                        dataExchangeCollectClosure.accept(locNode, dataBag);\n \n                     return delegate.collect(dataBag);\n                 }\n"}}, {"oid": "9fe9f2b56aa829b64f51056d716179ae414376e1", "url": "https://github.com/apache/ignite/commit/9fe9f2b56aa829b64f51056d716179ae414376e1", "message": "IGNITE-13567 Test improvements.", "committedDate": "2020-10-13T12:28:01Z", "type": "forcePushed"}, {"oid": "dcc58ab1da314982d6534148431917cf258fc7a8", "url": "https://github.com/apache/ignite/commit/dcc58ab1da314982d6534148431917cf258fc7a8", "message": "IGNITE-13567 Test improvements.", "committedDate": "2020-10-13T12:33:05Z", "type": "forcePushed"}, {"oid": "51dde84e9695e87ca615f3ad0049f6a0aec9adac", "url": "https://github.com/apache/ignite/commit/51dde84e9695e87ca615f3ad0049f6a0aec9adac", "message": "IGNITE-13567 (minor) code cleanup.", "committedDate": "2020-10-14T19:16:01Z", "type": "forcePushed"}, {"oid": "58fd146a42e54a11d4df9dfc816d865870a8def2", "url": "https://github.com/apache/ignite/commit/58fd146a42e54a11d4df9dfc816d865870a8def2", "message": "IGNITE-13567 (minor) test javadocs.", "committedDate": "2020-10-15T21:19:34Z", "type": "forcePushed"}, {"oid": "67a8cf02fca3e1df65f26c73886ff074cb4bf5eb", "url": "https://github.com/apache/ignite/commit/67a8cf02fca3e1df65f26c73886ff074cb4bf5eb", "message": "IGNITE-13567 Fix test.", "committedDate": "2020-10-19T15:48:49Z", "type": "forcePushed"}, {"oid": "bbe9e7fdf4d70f13c0f0bfdaef7d74f0fb30d934", "url": "https://github.com/apache/ignite/commit/bbe9e7fdf4d70f13c0f0bfdaef7d74f0fb30d934", "message": "IGNITE-13567 Fix test.", "committedDate": "2020-10-20T19:58:20Z", "type": "forcePushed"}, {"oid": "a1d05b2a0fb76f3893589e6fcf04972f2655c765", "url": "https://github.com/apache/ignite/commit/a1d05b2a0fb76f3893589e6fcf04972f2655c765", "message": "IGNITE-13567 Fix test.", "committedDate": "2020-10-22T07:23:08Z", "type": "forcePushed"}, {"oid": "a16d46281e8775678eb8fb48242661a9276aa2a1", "url": "https://github.com/apache/ignite/commit/a16d46281e8775678eb8fb48242661a9276aa2a1", "message": "Revert \"IGNITE-13567 Ignore failing test.\"\n\nThis reverts commit 7d5e4e5bf93684b22726c4be906401d400824d9f.", "committedDate": "2020-12-02T13:47:19Z", "type": "forcePushed"}, {"oid": "6e3d8f092b8dc967c09c6076efe0d340efb59db9", "url": "https://github.com/apache/ignite/commit/6e3d8f092b8dc967c09c6076efe0d340efb59db9", "message": "Revert \"IGNITE-13567 Ignore failing test.\"\n\nThis reverts commit 7d5e4e5bf93684b22726c4be906401d400824d9f.", "committedDate": "2020-12-03T09:50:33Z", "type": "forcePushed"}, {"oid": "ca411d98ef05b5a77acefd15fddece202be68562", "url": "https://github.com/apache/ignite/commit/ca411d98ef05b5a77acefd15fddece202be68562", "message": "IGNITE-13567 Fixed incorrect value of the joiningNodeClient flag for the joining client.", "committedDate": "2021-01-19T11:07:54Z", "type": "commit"}, {"oid": "32ac1fd22777511ecdf3c259c12ce80037e04835", "url": "https://github.com/apache/ignite/commit/32ac1fd22777511ecdf3c259c12ce80037e04835", "message": "IGNITE-13567 Minor test improvement.", "committedDate": "2021-01-19T11:07:54Z", "type": "commit"}, {"oid": "1f54696db4c88d048754095c02cfb3813cd3e92f", "url": "https://github.com/apache/ignite/commit/1f54696db4c88d048754095c02cfb3813cd3e92f", "message": "IGNITE-13567 (minor) naming discoveryDataPacket => dataPacket", "committedDate": "2021-01-19T11:07:54Z", "type": "commit"}, {"oid": "8a69f19a76d9b66f0317a3ed6269a78f5d29b877", "url": "https://github.com/apache/ignite/commit/8a69f19a76d9b66f0317a3ed6269a78f5d29b877", "message": "IGNITE-13567 Test improvements.", "committedDate": "2021-01-19T11:07:54Z", "type": "commit"}, {"oid": "a5c0866839078f75734b16bd560209b11858c560", "url": "https://github.com/apache/ignite/commit/a5c0866839078f75734b16bd560209b11858c560", "message": "IGNITE-13567 Test improvement.", "committedDate": "2021-01-19T11:07:54Z", "type": "commit"}, {"oid": "30b41e24c53bef83f601cf2d9e4d58349fbffe8e", "url": "https://github.com/apache/ignite/commit/30b41e24c53bef83f601cf2d9e4d58349fbffe8e", "message": "IGNITE-13567 Add ZK test.", "committedDate": "2021-01-19T11:07:55Z", "type": "commit"}, {"oid": "e3171209fcbd204a9239faee4f45d767ef6f9065", "url": "https://github.com/apache/ignite/commit/e3171209fcbd204a9239faee4f45d767ef6f9065", "message": "IGNITE-13567 (minor) code cleanup.", "committedDate": "2021-01-19T11:07:55Z", "type": "commit"}, {"oid": "e538c9565736a817889214cc932102684d9501bb", "url": "https://github.com/apache/ignite/commit/e538c9565736a817889214cc932102684d9501bb", "message": "IGNITE-13567 Ignore failing test.", "committedDate": "2021-01-19T11:07:55Z", "type": "commit"}, {"oid": "89c0774214c1ffae58cc53f22a094e4fe0ad86f5", "url": "https://github.com/apache/ignite/commit/89c0774214c1ffae58cc53f22a094e4fe0ad86f5", "message": "IGNITE-13567 (minor) test javadocs.", "committedDate": "2021-01-19T11:07:55Z", "type": "commit"}, {"oid": "370f91fd21ed3480cee26acda3be301d1061fe3f", "url": "https://github.com/apache/ignite/commit/370f91fd21ed3480cee26acda3be301d1061fe3f", "message": "IGNITE-13567 Fix test.", "committedDate": "2021-01-19T11:07:55Z", "type": "commit"}, {"oid": "dfbed9f2407bf787ccd5d91fc4f42148131ea8f5", "url": "https://github.com/apache/ignite/commit/dfbed9f2407bf787ccd5d91fc4f42148131ea8f5", "message": "Revert \"IGNITE-13567 Ignore failing test.\"\n\nThis reverts commit 7d5e4e5bf93684b22726c4be906401d400824d9f.", "committedDate": "2021-01-19T11:07:55Z", "type": "commit"}, {"oid": "af6b149568613a23547bf85a653b59f89d724555", "url": "https://github.com/apache/ignite/commit/af6b149568613a23547bf85a653b59f89d724555", "message": "IGNITE-13567 Test code cleanup.", "committedDate": "2021-01-19T11:07:55Z", "type": "forcePushed"}, {"oid": "e0bad7b4d4066b8f6069df29d4f9f2f101608c81", "url": "https://github.com/apache/ignite/commit/e0bad7b4d4066b8f6069df29d4f9f2f101608c81", "message": "IGNITE-13567 Test code cleanup.", "committedDate": "2021-01-19T11:08:42Z", "type": "commit"}, {"oid": "e0bad7b4d4066b8f6069df29d4f9f2f101608c81", "url": "https://github.com/apache/ignite/commit/e0bad7b4d4066b8f6069df29d4f9f2f101608c81", "message": "IGNITE-13567 Test code cleanup.", "committedDate": "2021-01-19T11:08:42Z", "type": "forcePushed"}]}