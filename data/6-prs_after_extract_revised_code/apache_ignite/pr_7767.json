{"pr_number": 7767, "pr_title": "IGNITE-12967: Start cluster snapshot from client node", "pr_createdAt": "2020-05-02T15:35:45Z", "pr_url": "https://github.com/apache/ignite/pull/7767", "timeline": [{"oid": "eeb3161c4b38da00b718466a283b96581a8c4357", "url": "https://github.com/apache/ignite/commit/eeb3161c4b38da00b718466a283b96581a8c4357", "message": "IGNITE-12967: Start cluster snapshot from client node", "committedDate": "2020-05-02T15:35:10Z", "type": "commit"}, {"oid": "173965a9b5fed2cde32e19df1b2a0c5583140486", "url": "https://github.com/apache/ignite/commit/173965a9b5fed2cde32e19df1b2a0c5583140486", "message": "IGNITE-12967: fix client node snapshot start", "committedDate": "2020-05-02T15:45:46Z", "type": "commit"}, {"oid": "5802b49c092dc65adf45af2ac9a212409e199e5f", "url": "https://github.com/apache/ignite/commit/5802b49c092dc65adf45af2ac9a212409e199e5f", "message": "IGNITE-12967: add test with throwing ex on client node", "committedDate": "2020-05-03T08:40:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTA5NTA4Nw==", "url": "https://github.com/apache/ignite/pull/7767#discussion_r419095087", "bodyText": "If oldest node left cluster user will get not clear exception. What it mean?  Snapshot will be created or not? What user should to do? I suggest to clarify public exceptions.\nFor now, exception looks like:\nclass org.apache.ignite.cluster.ClusterGroupEmptyException: Cluster group is empty.\n\tat org.apache.ignite.internal.util.IgniteUtils$6.apply(IgniteUtils.java:921)\n\tat org.apache.ignite.internal.util.IgniteUtils$6.apply(IgniteUtils.java:919)\n\tat org.apache.ignite.internal.util.IgniteUtils.convertException(IgniteUtils.java:1077)\n\tat org.apache.ignite.internal.util.future.IgniteFutureImpl.convertException(IgniteFutureImpl.java:168)\n\tat org.apache.ignite.internal.util.future.IgniteFutureImpl.get(IgniteFutureImpl.java:137)\n\tat org.apache.ignite.internal.processors.cache.persistence.snapshot.IgniteClusterSnapshotSelfTest.testClusterSnapshotFromClientNodeStop(IgniteClusterSnapshotSelfTest.java:887)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n\tat java.lang.reflect.Method.invoke(Method.java:498)\n\tat org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:47)\n\tat org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)\n\tat org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:44)\n\tat org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:17)\n\tat org.junit.internal.runners.statements.RunBefores.evaluate(RunBefores.java:26)\n\tat org.junit.internal.runners.statements.RunAfters.evaluate(RunAfters.java:27)\n\tat org.apache.ignite.testframework.junits.GridAbstractTest$7.run(GridAbstractTest.java:2213)\n\tat java.lang.Thread.run(Thread.java:748)\nCaused by: class org.apache.ignite.internal.cluster.ClusterGroupEmptyCheckedException: Cluster group is empty.\n\tat org.apache.ignite.internal.util.IgniteUtils.emptyTopologyException(IgniteUtils.java:5062)\n\tat org.apache.ignite.internal.processors.closure.GridClosureProcessor.callAsync(GridClosureProcessor.java:694)\n\tat org.apache.ignite.internal.IgniteComputeImpl.applyAsync0(IgniteComputeImpl.java:773)\n\tat org.apache.ignite.internal.IgniteComputeImpl.applyAsync(IgniteComputeImpl.java:757)\n\tat org.apache.ignite.internal.processors.cache.persistence.snapshot.IgniteSnapshotManager.createSnapshot(IgniteSnapshotManager.java:659)\n\tat org.apache.ignite.internal.processors.cache.persistence.snapshot.IgniteClusterSnapshotSelfTest.lambda$testClusterSnapshotFromClientNodeStop$15(IgniteClusterSnapshotSelfTest.java:883)\n\tat org.apache.ignite.testframework.GridTestUtils.lambda$runAsync$2(GridTestUtils.java:1153)\n\tat org.apache.ignite.testframework.GridTestUtils$7.call(GridTestUtils.java:1474)\n\tat org.apache.ignite.testframework.GridTestThread.run(GridTestThread.java:84)", "author": "NSAmelchev", "createdAt": "2020-05-03T12:15:10Z", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/snapshot/IgniteSnapshotManager.java", "diffHunk": "@@ -648,6 +648,13 @@ public boolean isSnapshotCreating() {\n             if (!clusterState.hasBaselineTopology())\n                 throw new IgniteException(\"Snapshot operation has been rejected. The baseline topology is not configured for cluster.\");\n \n+            if (cctx.kernalContext().clientNode()) {\n+                return cctx.kernalContext().grid()\n+                    .compute(cctx.kernalContext().grid().cluster()\n+                        .forNodeId(U.oldest(cctx.kernalContext().discovery().aliveServerNodes(), null).id()))", "originalCommit": "5802b49c092dc65adf45af2ac9a212409e199e5f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTAxNjAwNg==", "url": "https://github.com/apache/ignite/pull/7767#discussion_r421016006", "bodyText": "Fixed.", "author": "Mmuzaf", "createdAt": "2020-05-06T18:50:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTA5NTA4Nw=="}], "type": "inlineReview", "revised_code": {"commit": "91f4cc417ae27eb3fba7237e48298305ab1e308c", "chunk": "diff --git a/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/snapshot/IgniteSnapshotManager.java b/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/snapshot/IgniteSnapshotManager.java\nindex c9cef17623..e9d0d2daee 100644\n--- a/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/snapshot/IgniteSnapshotManager.java\n+++ b/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/snapshot/IgniteSnapshotManager.java\n\n@@ -652,7 +653,16 @@ public class IgniteSnapshotManager extends GridCacheSharedManagerAdapter\n                 return cctx.kernalContext().grid()\n                     .compute(cctx.kernalContext().grid().cluster()\n                         .forNodeId(U.oldest(cctx.kernalContext().discovery().aliveServerNodes(), null).id()))\n-                    .applyAsync(new CreateSnapshotTask(), name);\n+                    .applyAsync(new CreateSnapshotTask(), name)\n+                    .chain(f -> {\n+                        try {\n+                            return f.get();\n+                        }\n+                        catch (ClusterTopologyException e) {\n+                            throw new IgniteException(\"Snapshot request has been sent to the remote node \" +\n+                                \"but the target server node left the cluster\", e);\n+                        }\n+                    });\n             }\n \n             ClusterSnapshotFuture snpFut0;\n"}}, {"oid": "91f4cc417ae27eb3fba7237e48298305ab1e308c", "url": "https://github.com/apache/ignite/commit/91f4cc417ae27eb3fba7237e48298305ab1e308c", "message": "IGNITE-12967: wip", "committedDate": "2020-05-04T13:21:29Z", "type": "commit"}, {"oid": "134a1a64ac8f9f8d96dd52dc13cb68f4c432b139", "url": "https://github.com/apache/ignite/commit/134a1a64ac8f9f8d96dd52dc13cb68f4c432b139", "message": "Merge branch 'master' into ignite-12967", "committedDate": "2020-05-06T18:30:26Z", "type": "commit"}, {"oid": "8281877c6903ba09bdc02e19913ab14a9f2041e3", "url": "https://github.com/apache/ignite/commit/8281877c6903ba09bdc02e19913ab14a9f2041e3", "message": "IGNITE-12967: fix minor issues", "committedDate": "2020-05-06T18:43:31Z", "type": "commit"}, {"oid": "bbce3760f12baceb94e5f1044ea5acb6548df749", "url": "https://github.com/apache/ignite/commit/bbce3760f12baceb94e5f1044ea5acb6548df749", "message": "IGNITE-12967: revert unnecessary changes", "committedDate": "2020-05-06T18:44:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTAzMjU5Ng==", "url": "https://github.com/apache/ignite/pull/7767#discussion_r421032596", "bodyText": "What happens if the client will be disconnected? U.oldest(..) can return null.", "author": "NSAmelchev", "createdAt": "2020-05-06T19:17:58Z", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/snapshot/IgniteSnapshotManager.java", "diffHunk": "@@ -648,6 +649,22 @@ public boolean isSnapshotCreating() {\n             if (!clusterState.hasBaselineTopology())\n                 throw new IgniteException(\"Snapshot operation has been rejected. The baseline topology is not configured for cluster.\");\n \n+            if (cctx.kernalContext().clientNode()) {", "originalCommit": "bbce3760f12baceb94e5f1044ea5acb6548df749", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY3NjY5MQ==", "url": "https://github.com/apache/ignite/pull/7767#discussion_r421676691", "bodyText": "Fixed.", "author": "Mmuzaf", "createdAt": "2020-05-07T17:36:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTAzMjU5Ng=="}], "type": "inlineReview", "revised_code": {"commit": "05334b6080e864ae062ab3a3e2dfd195d4467aa0", "chunk": "diff --git a/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/snapshot/IgniteSnapshotManager.java b/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/snapshot/IgniteSnapshotManager.java\nindex b007b709fc..078895bc7a 100644\n--- a/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/snapshot/IgniteSnapshotManager.java\n+++ b/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/snapshot/IgniteSnapshotManager.java\n\n@@ -650,9 +650,13 @@ public class IgniteSnapshotManager extends GridCacheSharedManagerAdapter\n                 throw new IgniteException(\"Snapshot operation has been rejected. The baseline topology is not configured for cluster.\");\n \n             if (cctx.kernalContext().clientNode()) {\n+                ClusterNode crd = U.oldest(cctx.kernalContext().discovery().aliveServerNodes(), null);\n+\n+                if (crd == null)\n+                    throw new IgniteException(\"There is no alive server nodes in the cluster\");\n+\n                 return cctx.kernalContext().grid()\n-                    .compute(cctx.kernalContext().grid().cluster()\n-                        .forNodeId(U.oldest(cctx.kernalContext().discovery().aliveServerNodes(), null).id()))\n+                    .compute(cctx.kernalContext().grid().cluster().forNodeId(crd.id()))\n                     .applyAsync(new CreateSnapshotTask(), name)\n                     .chain(f -> {\n                         try {\n"}}, {"oid": "05334b6080e864ae062ab3a3e2dfd195d4467aa0", "url": "https://github.com/apache/ignite/commit/05334b6080e864ae062ab3a3e2dfd195d4467aa0", "message": "IGNITE-12967: fix nullpointer exception if client node is the one", "committedDate": "2020-05-06T21:39:43Z", "type": "commit"}, {"oid": "3f77789643f85f06a45b1d8163d177d015fd89b9", "url": "https://github.com/apache/ignite/commit/3f77789643f85f06a45b1d8163d177d015fd89b9", "message": "IGNITE-12967: fix exception handling", "committedDate": "2020-05-07T13:44:42Z", "type": "commit"}, {"oid": "a058894255bc46d890dc9b1dad4c0ea2a5b67888", "url": "https://github.com/apache/ignite/commit/a058894255bc46d890dc9b1dad4c0ea2a5b67888", "message": "IGNITE-12967: fix user exceptions", "committedDate": "2020-05-07T17:34:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjAyMzEyMw==", "url": "https://github.com/apache/ignite/pull/7767#discussion_r422023123", "bodyText": "Should this task be marked as @GridInternal ?", "author": "NSAmelchev", "createdAt": "2020-05-08T08:43:09Z", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/snapshot/IgniteSnapshotManager.java", "diffHunk": "@@ -1230,4 +1245,37 @@ public ClusterSnapshotFuture(UUID rqId, String name) {\n             return super.onDone(res, err, cancel);\n         }\n     }\n+\n+    /** Start creation of cluster snapshot closure. */\n+    private static class CreateSnapshotClosure implements IgniteClosure<String, Void> {", "originalCommit": "a058894255bc46d890dc9b1dad4c0ea2a5b67888", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjAzMDcwNA==", "url": "https://github.com/apache/ignite/pull/7767#discussion_r422030704", "bodyText": "Added. Thank you!", "author": "Mmuzaf", "createdAt": "2020-05-08T08:59:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjAyMzEyMw=="}], "type": "inlineReview", "revised_code": {"commit": "df1274774caa42150ea40ff3e95eb0a14501721c", "chunk": "diff --git a/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/snapshot/IgniteSnapshotManager.java b/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/snapshot/IgniteSnapshotManager.java\nindex 01df44d172..153e1408dc 100644\n--- a/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/snapshot/IgniteSnapshotManager.java\n+++ b/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/snapshot/IgniteSnapshotManager.java\n\n@@ -1247,6 +1248,7 @@ public class IgniteSnapshotManager extends GridCacheSharedManagerAdapter\n     }\n \n     /** Start creation of cluster snapshot closure. */\n+    @GridInternal\n     private static class CreateSnapshotClosure implements IgniteClosure<String, Void> {\n         /** Serial version UID. */\n         private static final long serialVersionUID = 0L;\n"}}, {"oid": "df1274774caa42150ea40ff3e95eb0a14501721c", "url": "https://github.com/apache/ignite/commit/df1274774caa42150ea40ff3e95eb0a14501721c", "message": "IGNITE-12967: add annotation grid internal", "committedDate": "2020-05-08T08:59:18Z", "type": "commit"}]}