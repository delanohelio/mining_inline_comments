{"pr_number": 8317, "pr_title": "IGNITE-13520 Skip generating encryption keys on the client node.", "pr_createdAt": "2020-10-05T13:50:12Z", "pr_url": "https://github.com/apache/ignite/pull/8317", "timeline": [{"oid": "7ca0123b84b57deb9f0e2805668ba60b02ee430f", "url": "https://github.com/apache/ignite/commit/7ca0123b84b57deb9f0e2805668ba60b02ee430f", "message": "IGNITE-12843 Reject cache start without encryption key", "committedDate": "2020-10-07T16:34:17Z", "type": "forcePushed"}, {"oid": "8eafef5ef9fe0c2bcd8610ef196e56751cd9df71", "url": "https://github.com/apache/ignite/commit/8eafef5ef9fe0c2bcd8610ef196e56751cd9df71", "message": "IGNITE-12843 Reject cache start without encryption key", "committedDate": "2020-10-07T17:43:40Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY4MjA2OA==", "url": "https://github.com/apache/ignite/pull/8317#discussion_r501682068", "bodyText": "I think we should to write that cache will be started dynamically", "author": "NSAmelchev", "createdAt": "2020-10-08T12:31:17Z", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/ClusterCachesInfo.java", "diffHunk": "@@ -2003,6 +2003,12 @@ private String processJoiningNode(CacheJoinNodeDiscoveryData joinData, UUID node\n             if (!registeredCaches.containsKey(cfg.getName())) {\n                 String conflictErr = checkCacheConflict(cfg);\n \n+                if (conflictErr == null && cfg.isEncryptionEnabled() && !locJoin &&\n+                    ctx.encryption().groupKey(CU.cacheGroupId(cfg.getName(), cfg.getGroupName())) == null) {\n+                    conflictErr = \"Encryption key has not been generated. \" +\n+                        \"The client node must dynamically start this cache [cacheName=\" + cfg.getName() + \"]\";", "originalCommit": "8eafef5ef9fe0c2bcd8610ef196e56751cd9df71", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "0680ae5359c0851103b8299ae8195859175f0f5b", "chunk": "diff --git a/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/ClusterCachesInfo.java b/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/ClusterCachesInfo.java\nindex b9be28f40c..6aa6a17070 100644\n--- a/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/ClusterCachesInfo.java\n+++ b/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/ClusterCachesInfo.java\n\n@@ -2005,8 +2005,8 @@ public class ClusterCachesInfo {\n \n                 if (conflictErr == null && cfg.isEncryptionEnabled() && !locJoin &&\n                     ctx.encryption().groupKey(CU.cacheGroupId(cfg.getName(), cfg.getGroupName())) == null) {\n-                    conflictErr = \"Encryption key has not been generated. \" +\n-                        \"The client node must dynamically start this cache [cacheName=\" + cfg.getName() + \"]\";\n+                    conflictErr = \"Encryption key for the cache cannot be generated on the client node, this node \" +\n+                        \"will dynamically start this cache after join to topology [cacheName=\" + cfg.getName() + ']';\n                 }\n \n                 if (conflictErr != null) {\n"}}, {"oid": "0680ae5359c0851103b8299ae8195859175f0f5b", "url": "https://github.com/apache/ignite/commit/0680ae5359c0851103b8299ae8195859175f0f5b", "message": "IGNITE-13520 Minor (reworked warningg message).", "committedDate": "2020-10-08T13:11:30Z", "type": "forcePushed"}, {"oid": "38758f8b68329a63d9046c44a36b69d529dea578", "url": "https://github.com/apache/ignite/commit/38758f8b68329a63d9046c44a36b69d529dea578", "message": "IGNITE-12843 Don't send statically configured encrypted cache on join.", "committedDate": "2020-10-09T08:05:02Z", "type": "forcePushed"}, {"oid": "9dc55f7530c67c7df31eff6d30631d8b0b19b768", "url": "https://github.com/apache/ignite/commit/9dc55f7530c67c7df31eff6d30631d8b0b19b768", "message": "IGNITE-15320 Rework discovery to collect data,", "committedDate": "2020-10-19T15:39:16Z", "type": "forcePushed"}, {"oid": "7fa6a8d5cfebca749cf8eeb2b858186085473b1f", "url": "https://github.com/apache/ignite/commit/7fa6a8d5cfebca749cf8eeb2b858186085473b1f", "message": "IGNITE-15320 Rework discovery to collect data,", "committedDate": "2020-10-19T15:42:00Z", "type": "forcePushed"}, {"oid": "8f8334341826c822981e9eed633515eb791b48f6", "url": "https://github.com/apache/ignite/commit/8f8334341826c822981e9eed633515eb791b48f6", "message": "IGNITE-15320 Rework discovery to collect data,", "committedDate": "2020-10-20T06:01:50Z", "type": "forcePushed"}, {"oid": "6a5d9b273a82df5c91acbdeb1989e3e08ef18271", "url": "https://github.com/apache/ignite/commit/6a5d9b273a82df5c91acbdeb1989e3e08ef18271", "message": "IGNITE-13520 commonDataCollectedFor fix.", "committedDate": "2020-10-20T13:57:25Z", "type": "forcePushed"}, {"oid": "98305cba381db040a1a35173359bae5c30db0ac2", "url": "https://github.com/apache/ignite/commit/98305cba381db040a1a35173359bae5c30db0ac2", "message": "IGNITE-13520 commonDataCollectedFor fix.", "committedDate": "2020-10-20T19:58:01Z", "type": "forcePushed"}, {"oid": "0abac66537c9a46425d167cbe758c9b8660c4f1c", "url": "https://github.com/apache/ignite/commit/0abac66537c9a46425d167cbe758c9b8660c4f1c", "message": "IGNITE-13520 Skip generating encryption keys on the client node.", "committedDate": "2020-10-22T12:19:00Z", "type": "commit"}, {"oid": "d6f712e6e823672dffb087320d2da4de1bb11f9e", "url": "https://github.com/apache/ignite/commit/d6f712e6e823672dffb087320d2da4de1bb11f9e", "message": "IGNITE-12843 Reject cache start without encryption key", "committedDate": "2020-10-22T12:19:00Z", "type": "commit"}, {"oid": "fe3967d6f8050a501074beab83b4a5e7d3997791", "url": "https://github.com/apache/ignite/commit/fe3967d6f8050a501074beab83b4a5e7d3997791", "message": "IGNITE-13520 Minor (reworked warningg message).", "committedDate": "2020-10-22T12:19:00Z", "type": "commit"}, {"oid": "dce94014e73ba43651d25ca02d21113414ba1764", "url": "https://github.com/apache/ignite/commit/dce94014e73ba43651d25ca02d21113414ba1764", "message": "IGNITE-13520 (minor) Test updated.", "committedDate": "2020-10-22T12:19:00Z", "type": "commit"}, {"oid": "09ea68c3ca026310ff3e8fead890dd358a6b003a", "url": "https://github.com/apache/ignite/commit/09ea68c3ca026310ff3e8fead890dd358a6b003a", "message": "IGNITE-13520 Track generated on join keys on client node (wip).", "committedDate": "2020-10-22T12:19:00Z", "type": "commit"}, {"oid": "c94c4d7f2056070d57b9644f740e0e5d3ed3f798", "url": "https://github.com/apache/ignite/commit/c94c4d7f2056070d57b9644f740e0e5d3ed3f798", "message": "IGNITE-12843 Don't send statically configured encrypted cache on join.", "committedDate": "2020-10-22T12:19:00Z", "type": "commit"}, {"oid": "4cc2444727753732f2c0fa4200904cdde2e0ad9e", "url": "https://github.com/apache/ignite/commit/4cc2444727753732f2c0fa4200904cdde2e0ad9e", "message": "IGNITE-13520 Start cacjes after activation.", "committedDate": "2020-10-22T12:19:00Z", "type": "commit"}, {"oid": "f0caf2bdd772b3f3eb1cdc66e644601e0d7f397c", "url": "https://github.com/apache/ignite/commit/f0caf2bdd772b3f3eb1cdc66e644601e0d7f397c", "message": "IGNITE-13520 Rework discovery to collect data.", "committedDate": "2020-10-22T12:19:00Z", "type": "commit"}, {"oid": "89b3a8e4b8f0a1b802dc39a3e513dd9d9765fbd7", "url": "https://github.com/apache/ignite/commit/89b3a8e4b8f0a1b802dc39a3e513dd9d9765fbd7", "message": "IGNITE-13520 Revert changes.", "committedDate": "2020-10-22T12:20:42Z", "type": "commit"}, {"oid": "3f4fbdaeaf9d75717409db078458a6894a5e0de2", "url": "https://github.com/apache/ignite/commit/3f4fbdaeaf9d75717409db078458a6894a5e0de2", "message": "IGNITE-13520 Reject client node join with new static cache config.", "committedDate": "2020-10-22T18:35:32Z", "type": "commit"}, {"oid": "3f4fbdaeaf9d75717409db078458a6894a5e0de2", "url": "https://github.com/apache/ignite/commit/3f4fbdaeaf9d75717409db078458a6894a5e0de2", "message": "IGNITE-13520 Reject client node join with new static cache config.", "committedDate": "2020-10-22T18:35:32Z", "type": "forcePushed"}, {"oid": "a2bb81b95d13b05d6d5c646a4b24cdf1f23584bf", "url": "https://github.com/apache/ignite/commit/a2bb81b95d13b05d6d5c646a4b24cdf1f23584bf", "message": "IGNITE-13520 Check encryption flag.", "committedDate": "2020-10-22T19:29:54Z", "type": "commit"}, {"oid": "a2bb81b95d13b05d6d5c646a4b24cdf1f23584bf", "url": "https://github.com/apache/ignite/commit/a2bb81b95d13b05d6d5c646a4b24cdf1f23584bf", "message": "IGNITE-13520 Check encryption flag.", "committedDate": "2020-10-22T19:29:54Z", "type": "forcePushed"}, {"oid": "3bec80fd6035e58186b71a8527ca290dbefdf1c9", "url": "https://github.com/apache/ignite/commit/3bec80fd6035e58186b71a8527ca290dbefdf1c9", "message": "IGNITE-13520 Composite error message.", "committedDate": "2020-10-23T05:16:09Z", "type": "commit"}, {"oid": "44f81182f978edc1037e653bf3e06e200f177912", "url": "https://github.com/apache/ignite/commit/44f81182f978edc1037e653bf3e06e200f177912", "message": "IGNITE-12843 (minor) Check enc caches even if data present.", "committedDate": "2020-10-23T07:44:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDcyOTE2Mg==", "url": "https://github.com/apache/ignite/pull/8317#discussion_r510729162", "bodyText": "Unnecessary line break", "author": "NSAmelchev", "createdAt": "2020-10-23T08:42:51Z", "path": "modules/core/src/test/java/org/apache/ignite/internal/encryption/EncryptedCacheNodeJoinTest.java", "diffHunk": "@@ -204,6 +221,106 @@ public void testClientNodeJoin() throws Exception {\n         createEncryptedCache(client, grid0, cacheName(), null);\n     }\n \n+    /** */\n+    @Test\n+    public void testClientNodeJoinActiveClusterWithNewStaticCacheConfig() throws Exception {\n+        checkNodeJoinWithStaticCacheConfig(true, true, true);\n+    }\n+\n+    /** */\n+    @Test\n+    public void testClientNodeJoinActiveClusterWithExistingStaticCacheConfig() throws Exception {\n+        checkNodeJoinWithStaticCacheConfig(true, true, false);\n+    }\n+\n+    /** */\n+    @Test\n+    public void testClientNodeJoinInactiveClusterWithNewStaticCacheConfig() throws Exception {\n+        checkNodeJoinWithStaticCacheConfig(true, false, true);\n+    }\n+\n+    /** */\n+    @Test\n+    public void testClientNodeJoinInactiveClusterWithExistingStaticCacheConfig() throws Exception {\n+        checkNodeJoinWithStaticCacheConfig(true, false, false);\n+    }\n+\n+    /** */\n+    @Test\n+    public void testServerNodeJoinActiveClusterWithNewStaticCacheConfig() throws Exception {\n+        checkNodeJoinWithStaticCacheConfig(false, true, true);\n+    }\n+\n+    /** */\n+    @Test\n+    public void testServerNodeJoinInactiveClusterWithNewStaticCacheConfig() throws Exception {\n+        checkNodeJoinWithStaticCacheConfig(false, false, true);\n+    }\n+\n+    /**\n+     * @param client {@code True} to test client node join, {@code False} to test server node join.\n+     * @param activateBeforeJoin {@code True} to activate the server before joining the client node.\n+     * @param newCfg {@code True} to configure cache on the last joined node. {@code False} to configure on all nodes.\n+     */\n+    public void checkNodeJoinWithStaticCacheConfig(\n+        boolean client,\n+        boolean activateBeforeJoin,\n+        boolean newCfg\n+    ) throws Exception {\n+        if (!newCfg)\n+            configureCache = true;\n+\n+        startGrid(GRID_0);\n+        startGrid(GRID_6);\n+\n+        IgniteEx client1 = startClientGrid(\"client1\");\n+\n+        if (newCfg)\n+            configureCache = true;\n+\n+        if (activateBeforeJoin)\n+            grid(GRID_0).cluster().state(ClusterState.ACTIVE);\n+\n+        if (client && newCfg) {\n+", "originalCommit": "454a9c235501ef18713d92d691c7fe935884e0d3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDczNDEzNw==", "url": "https://github.com/apache/ignite/pull/8317#discussion_r510734137", "bodyText": "Done, thanks", "author": "xtern", "createdAt": "2020-10-23T08:50:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDcyOTE2Mg=="}], "type": "inlineReview", "revised_code": {"commit": "7f76f456ec45a87f641913d05a12d7db083a435a", "chunk": "diff --git a/modules/core/src/test/java/org/apache/ignite/internal/encryption/EncryptedCacheNodeJoinTest.java b/modules/core/src/test/java/org/apache/ignite/internal/encryption/EncryptedCacheNodeJoinTest.java\nindex 1319a80b9f..ed181e995c 100644\n--- a/modules/core/src/test/java/org/apache/ignite/internal/encryption/EncryptedCacheNodeJoinTest.java\n+++ b/modules/core/src/test/java/org/apache/ignite/internal/encryption/EncryptedCacheNodeJoinTest.java\n\n@@ -314,11 +314,9 @@ public class EncryptedCacheNodeJoinTest extends AbstractEncryptionTest {\n         if (client) {\n             checkEncryptedCaches(grid(GRID_0), grid(CLIENT));\n             checkData(grid(CLIENT));\n-\n-            return;\n         }\n-\n-        checkEncryptedCaches(grid(GRID_7), grid(GRID_0));\n+        else\n+            checkEncryptedCaches(grid(GRID_7), grid(GRID_0));\n     }\n \n     /** */\n"}}, {"oid": "7f76f456ec45a87f641913d05a12d7db083a435a", "url": "https://github.com/apache/ignite/commit/7f76f456ec45a87f641913d05a12d7db083a435a", "message": "IGNITE-12843 (minor) Fix message.", "committedDate": "2020-10-23T08:48:40Z", "type": "forcePushed"}, {"oid": "6217c168ec46e528378d85aa664e86891ad198e0", "url": "https://github.com/apache/ignite/commit/6217c168ec46e528378d85aa664e86891ad198e0", "message": "IGNITE-12843 (minor) Fix message.", "committedDate": "2020-10-23T08:49:57Z", "type": "commit"}, {"oid": "6217c168ec46e528378d85aa664e86891ad198e0", "url": "https://github.com/apache/ignite/commit/6217c168ec46e528378d85aa664e86891ad198e0", "message": "IGNITE-12843 (minor) Fix message.", "committedDate": "2020-10-23T08:49:57Z", "type": "forcePushed"}, {"oid": "bc0b25b1f10381f7f5bc9f7aea682bdd1eb41c05", "url": "https://github.com/apache/ignite/commit/bc0b25b1f10381f7f5bc9f7aea682bdd1eb41c05", "message": "Update ClusterCachesInfo.java", "committedDate": "2020-12-02T12:21:30Z", "type": "commit"}, {"oid": "468ae2aa3edeef077da4e10afc3759ae4d9a774e", "url": "https://github.com/apache/ignite/commit/468ae2aa3edeef077da4e10afc3759ae4d9a774e", "message": "Update EncryptedCacheNodeJoinTest.java", "committedDate": "2020-12-02T12:25:27Z", "type": "commit"}]}