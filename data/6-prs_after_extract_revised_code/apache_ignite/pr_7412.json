{"pr_number": 7412, "pr_title": "IGNITE-12067 User SQL query execution metrics", "pr_createdAt": "2020-02-12T07:54:31Z", "pr_url": "https://github.com/apache/ignite/pull/7412", "timeline": [{"oid": "594b76919aabe9f2f3d889cb0c571bc3cd5a1723", "url": "https://github.com/apache/ignite/commit/594b76919aabe9f2f3d889cb0c571bc3cd5a1723", "message": "IGNITE-12067 Metrics of execution of user SQL queries", "committedDate": "2020-02-11T16:03:11Z", "type": "commit"}, {"oid": "0e1cd7317f91033ac0d3f7fed77066e823cbbf2a", "url": "https://github.com/apache/ignite/commit/0e1cd7317f91033ac0d3f7fed77066e823cbbf2a", "message": "IGNITE-12067 Update metric description a little bit", "committedDate": "2020-02-12T08:37:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODExMzExNg==", "url": "https://github.com/apache/ignite/pull/7412#discussion_r378113116", "bodyText": "Load failure reason.", "author": "AMashenkov", "createdAt": "2020-02-12T08:56:25Z", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/bulkload/BulkLoadProcessor.java", "diffHunk": "@@ -51,6 +51,9 @@\n     /** Query id. */\n     private final Long qryId;\n \n+    /** Exception, current load process ended with, or {@code null} if in progress or if succeded. */\n+    private Exception failReason;", "originalCommit": "0e1cd7317f91033ac0d3f7fed77066e823cbbf2a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODExNDM5Nw==", "url": "https://github.com/apache/ignite/pull/7412#discussion_r378114397", "bodyText": "Failure callback.\n@param failReason Exception caused a failure.", "author": "AMashenkov", "createdAt": "2020-02-12T08:58:59Z", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/bulkload/BulkLoadProcessor.java", "diffHunk": "@@ -100,27 +103,36 @@ public void processBatch(byte[] batchData, boolean isLastBatch) throws IgniteChe\n         }\n     }\n \n+    /**\n+     * Is called to notify processor, that bulk load execution, this processor is performing, failed with specified", "originalCommit": "0e1cd7317f91033ac0d3f7fed77066e823cbbf2a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODExODMzMA==", "url": "https://github.com/apache/ignite/pull/7412#discussion_r378118330", "bodyText": "Failure callback.\n@param failReason Exception caused a failure.", "author": "AMashenkov", "createdAt": "2020-02-12T09:06:37Z", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/odbc/jdbc/JdbcBulkLoadProcessor.java", "diffHunk": "@@ -142,6 +142,15 @@ public void processBatch(JdbcBulkLoadBatchRequest req)\n         }\n     }\n \n+    /**\n+     * Gets notified if current bulk load failed.", "originalCommit": "0e1cd7317f91033ac0d3f7fed77066e823cbbf2a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODEyMDYzMg==", "url": "https://github.com/apache/ignite/pull/7412#discussion_r378120632", "bodyText": "I'm just curious.\nWhy LongAdderMetric is used for succeeded queries and AtomicLongMetric is used for failed\\canceled ones?", "author": "AMashenkov", "createdAt": "2020-02-12T09:11:27Z", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/query/RunningQueryManager.java", "diffHunk": "@@ -72,6 +77,18 @@\n     /** Query history tracker. */\n     private volatile QueryHistoryTracker qryHistTracker;\n \n+    /** Number of successfully executed queries. */\n+    private final LongAdderMetric successQrsCnt;", "originalCommit": "0e1cd7317f91033ac0d3f7fed77066e823cbbf2a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODEyMTgxNQ==", "url": "https://github.com/apache/ignite/pull/7412#discussion_r378121815", "bodyText": "Cancelled queries count metric.\nNote: Cancelled query is treated as failed one as well.", "author": "AMashenkov", "createdAt": "2020-02-12T09:13:37Z", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/query/RunningQueryManager.java", "diffHunk": "@@ -72,6 +77,18 @@\n     /** Query history tracker. */\n     private volatile QueryHistoryTracker qryHistTracker;\n \n+    /** Number of successfully executed queries. */\n+    private final LongAdderMetric successQrsCnt;\n+\n+    /** Number of failed queries in total by any reason. */\n+    private final AtomicLongMetric failedQrsCnt;\n+\n+    /**\n+     * Number of canceled queries. Canceled queries a treated as failed and counting twice: here and in {@link", "originalCommit": "0e1cd7317f91033ac0d3f7fed77066e823cbbf2a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODEyMjM0OQ==", "url": "https://github.com/apache/ignite/pull/7412#discussion_r378122349", "bodyText": "Failed and cancelled queries count metric.", "author": "AMashenkov", "createdAt": "2020-02-12T09:14:38Z", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/query/RunningQueryManager.java", "diffHunk": "@@ -72,6 +77,18 @@\n     /** Query history tracker. */\n     private volatile QueryHistoryTracker qryHistTracker;\n \n+    /** Number of successfully executed queries. */\n+    private final LongAdderMetric successQrsCnt;\n+\n+    /** Number of failed queries in total by any reason. */", "originalCommit": "0e1cd7317f91033ac0d3f7fed77066e823cbbf2a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODEyMzYyMA==", "url": "https://github.com/apache/ignite/pull/7412#discussion_r378123620", "bodyText": "Next statement makes no sense here \"so some memory is reserved.\"", "author": "AMashenkov", "createdAt": "2020-02-12T09:17:17Z", "path": "modules/indexing/src/test/java/org/apache/ignite/internal/metric/SqlStatisticsAbstractTest.java", "diffHunk": "@@ -0,0 +1,200 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.ignite.internal.metric;\n+\n+import java.util.Collections;\n+import java.util.UUID;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.TimeUnit;\n+import org.apache.ignite.Ignite;\n+import org.apache.ignite.IgniteCache;\n+import org.apache.ignite.IgniteDataStreamer;\n+import org.apache.ignite.cache.QueryEntity;\n+import org.apache.ignite.cache.query.annotations.QuerySqlFunction;\n+import org.apache.ignite.configuration.CacheConfiguration;\n+import org.apache.ignite.internal.IgniteInternalFuture;\n+import org.apache.ignite.testframework.GridTestUtils;\n+import org.apache.ignite.testframework.junits.common.GridCommonAbstractTest;\n+\n+/**\n+ * Abstract test for sql metrics tests.\n+ */\n+public class SqlStatisticsAbstractTest extends GridCommonAbstractTest {\n+    /**\n+     * Timeout for each wait on sync operation in seconds.\n+     */\n+    public static final long WAIT_OP_TIMEOUT_SEC = 15;\n+\n+    /**\n+     * Number of rows in the test table.\n+     */\n+    public static final int TABLE_SIZE = 10_000;\n+\n+    /**\n+     * Start the cache with a test table and test data.\n+     */\n+    protected IgniteCache createCacheFrom(Ignite node) {\n+        CacheConfiguration<Integer, String> ccfg = new CacheConfiguration<Integer, String>(DEFAULT_CACHE_NAME)\n+            .setSqlFunctionClasses(SuspendQuerySqlFunctions.class)\n+            .setQueryEntities(Collections.singleton(\n+                new QueryEntity(Integer.class.getName(), String.class.getName())\n+                    .setTableName(\"TAB\")\n+                    .addQueryField(\"id\", Integer.class.getName(), null)\n+                    .addQueryField(\"name\", String.class.getName(), null)\n+                    .setKeyFieldName(\"id\")\n+                    .setValueFieldName(\"name\")\n+            ));\n+\n+        IgniteCache<Integer, String> cache = node.createCache(ccfg);\n+\n+        try (IgniteDataStreamer<Object, Object> ds = node.dataStreamer(DEFAULT_CACHE_NAME)) {\n+            for (int i = 0; i < TABLE_SIZE; i++)\n+                ds.addData(i, UUID.randomUUID().toString());\n+        }\n+\n+        return cache;\n+    }\n+\n+    /**\n+     * Run async action and log if exception occured.\n+     *\n+     * @param act action to perform on other thread.\n+     * @return future object to \"action complited\" event.\n+     */\n+    protected IgniteInternalFuture runAsyncX(Runnable act) {\n+        return GridTestUtils.runAsync(() -> {\n+            try {\n+                act.run();\n+            }\n+            catch (Throwable th) {\n+                log.error(\"Failed to perform async action. Probably test is broken.\", th);\n+            }\n+        });\n+    }\n+\n+    /**\n+     * This class exports function to the sql engine. Function implementation allows us to suspend query execution on test\n+     * logic condition.\n+     */\n+    public static class SuspendQuerySqlFunctions {\n+        /**\n+         * How many rows should be processed (by all nodes in total)\n+         */\n+        private static final int DFLT_PROCESS_ROWS_TO_SUSPEND = TABLE_SIZE / 4;\n+\n+        /**\n+         * Latch to await till full scan query that uses this class function have done some job, so some memory is", "originalCommit": "0e1cd7317f91033ac0d3f7fed77066e823cbbf2a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "758a8a0d1bd3af32e7c5ecac294ad64adbc7cf4a", "url": "https://github.com/apache/ignite/commit/758a8a0d1bd3af32e7c5ecac294ad64adbc7cf4a", "message": "IGNITE-12067 Fix code style", "committedDate": "2020-02-12T16:01:53Z", "type": "commit"}, {"oid": "34c91c9c7f1341176868b9948cf2d6f22a3900bf", "url": "https://github.com/apache/ignite/commit/34c91c9c7f1341176868b9948cf2d6f22a3900bf", "message": "IGNITE-12067 Fix .NET CacheLinqTest.TestTimeout", "committedDate": "2020-02-13T12:03:17Z", "type": "commit"}, {"oid": "ee21648cd874d5573e1be62ff1e6984db0fdedfc", "url": "https://github.com/apache/ignite/commit/ee21648cd874d5573e1be62ff1e6984db0fdedfc", "message": "IGNITE-12067 Fix KillQueryTest", "committedDate": "2020-02-13T12:16:47Z", "type": "commit"}]}