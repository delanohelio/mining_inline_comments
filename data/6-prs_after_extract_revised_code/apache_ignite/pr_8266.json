{"pr_number": 8266, "pr_title": "IGNITE-13472 fix security context for JDBC bulkload operations", "pr_createdAt": "2020-09-22T09:40:07Z", "pr_url": "https://github.com/apache/ignite/pull/8266", "timeline": [{"oid": "a040b4bcee9e71650ba6f1a14793ed5e34dc6220", "url": "https://github.com/apache/ignite/commit/a040b4bcee9e71650ba6f1a14793ed5e34dc6220", "message": "IGNITE-13472 fix security context for JDBC bulkload operations", "committedDate": "2021-01-27T11:18:09Z", "type": "commit"}, {"oid": "a040b4bcee9e71650ba6f1a14793ed5e34dc6220", "url": "https://github.com/apache/ignite/commit/a040b4bcee9e71650ba6f1a14793ed5e34dc6220", "message": "IGNITE-13472 fix security context for JDBC bulkload operations", "committedDate": "2021-01-27T11:18:09Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjAwOTQwNA==", "url": "https://github.com/apache/ignite/pull/8266#discussion_r566009404", "bodyText": "It seems that we should check TEST_BULKLOAD_CACHE cache size here and check its size using equality.", "author": "ololo3000", "createdAt": "2021-01-28T11:09:59Z", "path": "modules/clients/src/test/java/org/apache/ignite/jdbc/JdbcAuthorizationTest.java", "diffHunk": "@@ -164,7 +169,11 @@ public void testCopyFrom() throws Exception {\n         assertAuthorizationFailed(sql, CACHE_READ_USER);\n         assertAuthorizationFailed(sql, CACHE_REMOVE_USER);\n \n+        int cnt = ignite(0).cache(DEFAULT_CACHE_NAME).size();", "originalCommit": "a040b4bcee9e71650ba6f1a14793ed5e34dc6220", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjA3NjgwNQ==", "url": "https://github.com/apache/ignite/pull/8266#discussion_r566076805", "bodyText": "Fixed.", "author": "SomeFire", "createdAt": "2021-01-28T13:03:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjAwOTQwNA=="}], "type": "inlineReview", "revised_code": {"commit": "b58334a5351403a90006cb59e6ac20271161c160", "chunk": "diff --git a/modules/clients/src/test/java/org/apache/ignite/jdbc/JdbcAuthorizationTest.java b/modules/clients/src/test/java/org/apache/ignite/jdbc/JdbcAuthorizationTest.java\nindex d56215c40f..7cef4c3357 100644\n--- a/modules/clients/src/test/java/org/apache/ignite/jdbc/JdbcAuthorizationTest.java\n+++ b/modules/clients/src/test/java/org/apache/ignite/jdbc/JdbcAuthorizationTest.java\n\n@@ -169,11 +169,11 @@ public class JdbcAuthorizationTest extends AbstractSecurityTest {\n         assertAuthorizationFailed(sql, CACHE_READ_USER);\n         assertAuthorizationFailed(sql, CACHE_REMOVE_USER);\n \n-        int cnt = ignite(0).cache(DEFAULT_CACHE_NAME).size();\n+        assertEquals(0, ignite(0).cache(TEST_BULKLOAD_CACHE).size());\n \n         execute(sql, CACHE_PUT_USER);\n \n-        assertTrue(ignite(0).cache(TEST_BULKLOAD_CACHE).size() > cnt);\n+        assertEquals(2, ignite(0).cache(TEST_BULKLOAD_CACHE).size());\n     }\n \n     /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjAxMDYwNw==", "url": "https://github.com/apache/ignite/pull/8266#discussion_r566010607", "bodyText": "Can we verify that the cache size has only increased by one?", "author": "ololo3000", "createdAt": "2021-01-28T11:12:01Z", "path": "modules/clients/src/test/java/org/apache/ignite/jdbc/JdbcAuthorizationTest.java", "diffHunk": "@@ -143,7 +144,11 @@ public void testInsert() throws Exception {\n         assertAuthorizationFailed(sql, CACHE_READ_USER);\n         assertAuthorizationFailed(sql, CACHE_REMOVE_USER);\n \n+        int cnt = ignite(0).cache(DEFAULT_CACHE_NAME).size();\n+\n         execute(sql, CACHE_PUT_USER);\n+\n+        assertTrue(ignite(0).cache(DEFAULT_CACHE_NAME).size() > cnt);", "originalCommit": "a040b4bcee9e71650ba6f1a14793ed5e34dc6220", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjA3NjY2Nw==", "url": "https://github.com/apache/ignite/pull/8266#discussion_r566076667", "bodyText": "Done.", "author": "SomeFire", "createdAt": "2021-01-28T13:03:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjAxMDYwNw=="}], "type": "inlineReview", "revised_code": {"commit": "b58334a5351403a90006cb59e6ac20271161c160", "chunk": "diff --git a/modules/clients/src/test/java/org/apache/ignite/jdbc/JdbcAuthorizationTest.java b/modules/clients/src/test/java/org/apache/ignite/jdbc/JdbcAuthorizationTest.java\nindex d56215c40f..7cef4c3357 100644\n--- a/modules/clients/src/test/java/org/apache/ignite/jdbc/JdbcAuthorizationTest.java\n+++ b/modules/clients/src/test/java/org/apache/ignite/jdbc/JdbcAuthorizationTest.java\n\n@@ -148,7 +148,7 @@ public class JdbcAuthorizationTest extends AbstractSecurityTest {\n \n         execute(sql, CACHE_PUT_USER);\n \n-        assertTrue(ignite(0).cache(DEFAULT_CACHE_NAME).size() > cnt);\n+        assertEquals(cnt + 1, ignite(0).cache(DEFAULT_CACHE_NAME).size());\n     }\n \n     /**\n"}}, {"oid": "b58334a5351403a90006cb59e6ac20271161c160", "url": "https://github.com/apache/ignite/commit/b58334a5351403a90006cb59e6ac20271161c160", "message": "IGNITE-13472 improve tests", "committedDate": "2021-01-28T13:00:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjEzNjY2NA==", "url": "https://github.com/apache/ignite/pull/8266#discussion_r566136664", "bodyText": "An operation can be performed without a security context if the worker was rejected.", "author": "NSAmelchev", "createdAt": "2021-01-28T14:29:21Z", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/closure/GridClosureProcessor.java", "diffHunk": "@@ -960,9 +962,11 @@ public void runLocalWithThreadPolicy(IgniteThread thread, Runnable c) {\n \n             final GridWorkerFuture<R> fut = new GridWorkerFuture<>();\n \n+            final SecurityContext secCtx = ctx.security().securityContext();", "originalCommit": "b58334a5351403a90006cb59e6ac20271161c160", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Njc2MDg1NA==", "url": "https://github.com/apache/ignite/pull/8266#discussion_r566760854", "bodyText": "No, it will be executed in current context, which we give to worker. So, in case of reject we already have proper context.", "author": "SomeFire", "createdAt": "2021-01-29T11:35:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjEzNjY2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjgwNzk3Nw==", "url": "https://github.com/apache/ignite/pull/8266#discussion_r566807977", "bodyText": "Got it, thanks.", "author": "NSAmelchev", "createdAt": "2021-01-29T13:07:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjEzNjY2NA=="}], "type": "inlineReview", "revised_code": null}]}