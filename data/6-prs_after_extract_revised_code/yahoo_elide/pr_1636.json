{"pr_number": 1636, "pr_title": "Entity Models support in MetaDataStore", "pr_createdAt": "2020-11-04T19:32:45Z", "pr_url": "https://github.com/yahoo/elide/pull/1636", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYxMTY5MQ==", "url": "https://github.com/yahoo/elide/pull/1636#discussion_r517611691", "bodyText": "Class scanning is really time consuming.  We don't want to scan 100% of the classes three times to do this.  In the past, this has caused build times to go through the roof.  We should make maybe a new method in ClassScanner that looks for the classes we need in one pass.", "author": "aklish", "createdAt": "2020-11-04T20:27:25Z", "path": "elide-datastore/elide-datastore-aggregation/src/main/java/com/yahoo/elide/datastores/aggregation/metadata/MetaDataStore.java", "diffHunk": "@@ -80,12 +84,29 @@ public HashMapDataStore apply(String key) {\n     private Map<String, HashMapDataStore> hashMapDataStores = new HashMap<>();\n \n     public MetaDataStore() {\n-        this(ClassScanner.getAnnotatedClasses(METADATA_STORE_ANNOTATIONS));\n+        this(getAllAnnotatedClasses());\n+    }\n+\n+    /**\n+     * get all MetaDataStore supported annotated classes.\n+     * @return Set of Class with specific annotations.\n+     */\n+    private static Set<Class<?>> getAllAnnotatedClasses() {\n+        Set<Class<?>> metadataStoreResult = ClassScanner.getAnnotatedClasses(METADATA_STORE_ANNOTATIONS);\n+\n+        Set<Class<?>> entityResult = ClassScanner.getAnnotatedClasses(METADATA_STORE_ENTITY_ANNOTATION);", "originalCommit": "d0816e7dafa0ecee046b81e78aae1f2249eb5894", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d6c02e3e4f8c1da209cdcbd3b2b7f3d787347897", "chunk": "diff --git a/elide-datastore/elide-datastore-aggregation/src/main/java/com/yahoo/elide/datastores/aggregation/metadata/MetaDataStore.java b/elide-datastore/elide-datastore-aggregation/src/main/java/com/yahoo/elide/datastores/aggregation/metadata/MetaDataStore.java\nindex 204d5b931..6ac1d4efd 100644\n--- a/elide-datastore/elide-datastore-aggregation/src/main/java/com/yahoo/elide/datastores/aggregation/metadata/MetaDataStore.java\n+++ b/elide-datastore/elide-datastore-aggregation/src/main/java/com/yahoo/elide/datastores/aggregation/metadata/MetaDataStore.java\n\n@@ -92,14 +92,16 @@ public class MetaDataStore implements DataStore {\n      * @return Set of Class with specific annotations.\n      */\n     private static Set<Class<?>> getAllAnnotatedClasses() {\n-        Set<Class<?>> metadataStoreResult = ClassScanner.getAnnotatedClasses(METADATA_STORE_ANNOTATIONS);\n-\n-        Set<Class<?>> entityResult = ClassScanner.getAnnotatedClasses(METADATA_STORE_ENTITY_ANNOTATION);\n-        Set<Class<?>> includeResult = ClassScanner.getAnnotatedClasses(Include.class);\n-        // Only entities which have Include annotation.\n-        entityResult.retainAll(includeResult);\n+        Set<Class<?>> metadataStoreResult = ClassScanner.getAnnotatedClasses(METADATA_STORE_ANNOTATIONS, (clazz) -> {\n+            if (clazz.getAnnotation(Entity.class) != null) {\n+                if (clazz.getAnnotation(Include.class) != null) {\n+                    return true;\n+                }\n+                return false;\n+             }\n+             return true;\n+       });\n \n-        metadataStoreResult.addAll(entityResult);\n         return metadataStoreResult;\n     }\n \n"}}, {"oid": "d6c02e3e4f8c1da209cdcbd3b2b7f3d787347897", "url": "https://github.com/yahoo/elide/commit/d6c02e3e4f8c1da209cdcbd3b2b7f3d787347897", "message": "Review Comments for avoiding multiple scans", "committedDate": "2020-11-04T21:29:04Z", "type": "forcePushed"}, {"oid": "11edd80001b57ca74912e42250dec9abb3e0384f", "url": "https://github.com/yahoo/elide/commit/11edd80001b57ca74912e42250dec9abb3e0384f", "message": "Review Comments for avoiding multiple scans", "committedDate": "2020-11-04T21:32:44Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzY3NzE3Nw==", "url": "https://github.com/yahoo/elide/pull/1636#discussion_r517677177", "bodyText": "nice", "author": "aklish", "createdAt": "2020-11-04T22:49:13Z", "path": "elide-core/src/main/java/com/yahoo/elide/utils/ClassScanner.java", "diffHunk": "@@ -83,4 +96,12 @@\n                     .collect(Collectors.toSet());\n         }\n     }\n+\n+    /**\n+     * Function which will be invoked for deciding to include the class in final results.\n+     */\n+    @FunctionalInterface", "originalCommit": "11edd80001b57ca74912e42250dec9abb3e0384f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "92fdf792125d25ebdc189ee6fa6d1df05f3bdb74", "chunk": "diff --git a/elide-core/src/main/java/com/yahoo/elide/utils/ClassScanner.java b/elide-core/src/main/java/com/yahoo/elide/utils/ClassScanner.java\nindex 8f8bdf039..90dcf8716 100644\n--- a/elide-core/src/main/java/com/yahoo/elide/utils/ClassScanner.java\n+++ b/elide-core/src/main/java/com/yahoo/elide/utils/ClassScanner.java\n\n@@ -96,12 +83,4 @@ public class ClassScanner {\n                     .collect(Collectors.toSet());\n         }\n     }\n-\n-    /**\n-     * Function which will be invoked for deciding to include the class in final results.\n-     */\n-    @FunctionalInterface\n-    public interface FilterExpression {\n-        public boolean include(Class clazz);\n-    }\n }\n"}}, {"oid": "92fdf792125d25ebdc189ee6fa6d1df05f3bdb74", "url": "https://github.com/yahoo/elide/commit/92fdf792125d25ebdc189ee6fa6d1df05f3bdb74", "message": "Entity Models support in MetaDataStore", "committedDate": "2020-11-05T21:31:14Z", "type": "commit"}, {"oid": "6517318aac0cc155ceeff07894f6317a1813bb86", "url": "https://github.com/yahoo/elide/commit/6517318aac0cc155ceeff07894f6317a1813bb86", "message": "Review Comments for avoiding multiple scans", "committedDate": "2020-11-05T21:31:14Z", "type": "commit"}, {"oid": "6517318aac0cc155ceeff07894f6317a1813bb86", "url": "https://github.com/yahoo/elide/commit/6517318aac0cc155ceeff07894f6317a1813bb86", "message": "Review Comments for avoiding multiple scans", "committedDate": "2020-11-05T21:31:14Z", "type": "forcePushed"}]}