{"pr_number": 1409, "pr_title": "Async change to use onReadPreSecurity Hook", "pr_createdAt": "2020-07-01T05:01:32Z", "pr_url": "https://github.com/yahoo/elide/pull/1409", "timeline": [{"oid": "7a7eec2778e0c21c572cf43e4a9e495b067e7160", "url": "https://github.com/yahoo/elide/commit/7a7eec2778e0c21c572cf43e4a9e495b067e7160", "message": "Fix for graphql async", "committedDate": "2020-06-30T22:42:42Z", "type": "commit"}, {"oid": "8c76470483640bdb5347c0ab2ed8e197db250156", "url": "https://github.com/yahoo/elide/commit/8c76470483640bdb5347c0ab2ed8e197db250156", "message": "Aysnc ReadPreSecurity Hook", "committedDate": "2020-07-01T04:55:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ0OTQ5MQ==", "url": "https://github.com/yahoo/elide/pull/1409#discussion_r448449491", "bodyText": "why would status ever be null?", "author": "aklish", "createdAt": "2020-07-01T15:37:08Z", "path": "elide-async/src/main/java/com/yahoo/elide/async/models/AsyncQuery.java", "diffHunk": "@@ -69,7 +69,10 @@\n \n     @PrePersist\n     public void prePersistStatus() {\n-        status = QueryStatus.QUEUED;\n+        if (status == null) {", "originalCommit": "8c76470483640bdb5347c0ab2ed8e197db250156", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "4a02947d5ec26926c342957517c84b34607655e8", "chunk": "diff --git a/elide-async/src/main/java/com/yahoo/elide/async/models/AsyncQuery.java b/elide-async/src/main/java/com/yahoo/elide/async/models/AsyncQuery.java\nindex 25dd7162c..aeacdcc32 100644\n--- a/elide-async/src/main/java/com/yahoo/elide/async/models/AsyncQuery.java\n+++ b/elide-async/src/main/java/com/yahoo/elide/async/models/AsyncQuery.java\n\n@@ -67,17 +67,6 @@ public class AsyncQuery extends AsyncBase implements PrincipalOwned {\n     @Transient\n     private AsyncQueryUpdateThread queryUpdateWorker = null;\n \n-    @PrePersist\n-    public void prePersistStatus() {\n-        if (status == null) {\n-            status = QueryStatus.QUEUED;\n-        }\n-\n-        if (id == null || id.isEmpty()) {\n-            id = UUID.randomUUID().toString();\n-        }\n-    }\n-\n     @Override\n     public String getPrincipalName() {\n         return principalName;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ1MDEyNg==", "url": "https://github.com/yahoo/elide/pull/1409#discussion_r448450126", "bodyText": "Let's revisit how prePersist and preUpdate work.", "author": "aklish", "createdAt": "2020-07-01T15:38:12Z", "path": "elide-async/src/main/java/com/yahoo/elide/async/models/AsyncBase.java", "diffHunk": "@@ -28,7 +28,14 @@\n \n     @PrePersist\n     public void prePersist() {\n-        createdOn = updatedOn = new Date();\n+", "originalCommit": "8c76470483640bdb5347c0ab2ed8e197db250156", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "4a02947d5ec26926c342957517c84b34607655e8", "chunk": "diff --git a/elide-async/src/main/java/com/yahoo/elide/async/models/AsyncBase.java b/elide-async/src/main/java/com/yahoo/elide/async/models/AsyncBase.java\nindex 4633a5b7d..f821fcd5a 100644\n--- a/elide-async/src/main/java/com/yahoo/elide/async/models/AsyncBase.java\n+++ b/elide-async/src/main/java/com/yahoo/elide/async/models/AsyncBase.java\n\n@@ -8,36 +8,25 @@ package com.yahoo.elide.async.models;\n import com.yahoo.elide.annotation.Exclude;\n \n import lombok.Getter;\n+import lombok.Setter;\n \n import java.util.Date;\n import java.util.UUID;\n \n import javax.persistence.MappedSuperclass;\n-import javax.persistence.PrePersist;\n+//import javax.persistence.PrePersist;\n import javax.persistence.PreUpdate;\n \n @MappedSuperclass\n public abstract class AsyncBase {\n \n-    @Getter private Date createdOn;\n+    @Getter private Date createdOn = new Date();\n \n-    @Getter private Date updatedOn;\n+    @Getter @Setter private Date updatedOn = new Date();\n \n     @Exclude\n     protected String naturalKey = UUID.randomUUID().toString();\n \n-    @PrePersist\n-    public void prePersist() {\n-\n-        if (createdOn == null) {\n-            createdOn = new Date();\n-        }\n-\n-        if (updatedOn == null) {\n-            updatedOn = new Date();\n-        }\n-    }\n-\n     @PreUpdate\n     public void preUpdate() {\n         this.updatedOn = new Date();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ1MDI4MQ==", "url": "https://github.com/yahoo/elide/pull/1409#discussion_r448450281", "bodyText": "I feel like this doesn't belong in this hook.", "author": "aklish", "createdAt": "2020-07-01T15:38:29Z", "path": "elide-async/src/main/java/com/yahoo/elide/async/hooks/ExecuteQueryHook.java", "diffHunk": "@@ -28,6 +29,9 @@ public ExecuteQueryHook (AsyncExecutorService asyncExecutorService) {\n     @Override\n     public void execute(LifeCycleHookBinding.Operation operation, AsyncQuery query,\n                         RequestScope requestScope, Optional<ChangeSpec> changes) {\n-        asyncExecutorService.executeQuery(query, requestScope.getUser(), requestScope.getApiVersion());\n+        if (query.getStatus() == QueryStatus.QUEUED && query.getResult() == null) {\n+            asyncExecutorService.executeQuery(query, requestScope.getUser(), requestScope.getApiVersion());\n+            query.prePersist();", "originalCommit": "8c76470483640bdb5347c0ab2ed8e197db250156", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "4a02947d5ec26926c342957517c84b34607655e8", "chunk": "diff --git a/elide-async/src/main/java/com/yahoo/elide/async/hooks/ExecuteQueryHook.java b/elide-async/src/main/java/com/yahoo/elide/async/hooks/ExecuteQueryHook.java\nindex 1af4f6991..f2873914f 100644\n--- a/elide-async/src/main/java/com/yahoo/elide/async/hooks/ExecuteQueryHook.java\n+++ b/elide-async/src/main/java/com/yahoo/elide/async/hooks/ExecuteQueryHook.java\n\n@@ -31,7 +31,6 @@ public class ExecuteQueryHook implements LifeCycleHook<AsyncQuery> {\n                         RequestScope requestScope, Optional<ChangeSpec> changes) {\n         if (query.getStatus() == QueryStatus.QUEUED && query.getResult() == null) {\n             asyncExecutorService.executeQuery(query, requestScope.getUser(), requestScope.getApiVersion());\n-            query.prePersist();\n         }\n     }\n }\n"}}, {"oid": "4a02947d5ec26926c342957517c84b34607655e8", "url": "https://github.com/yahoo/elide/commit/4a02947d5ec26926c342957517c84b34607655e8", "message": "Review comments", "committedDate": "2020-07-01T20:58:05Z", "type": "commit"}, {"oid": "6cc52da43c4aa6e1caa00bd65dad8746003ce371", "url": "https://github.com/yahoo/elide/commit/6cc52da43c4aa6e1caa00bd65dad8746003ce371", "message": "Review comments", "committedDate": "2020-07-01T22:38:30Z", "type": "commit"}, {"oid": "da782d7db0e34acebdf028276fc42f4e8c7168a3", "url": "https://github.com/yahoo/elide/commit/da782d7db0e34acebdf028276fc42f4e8c7168a3", "message": "Review comments", "committedDate": "2020-07-01T22:48:19Z", "type": "commit"}, {"oid": "b01c8a4268c39c9cf0e609599ac7a508c12547a4", "url": "https://github.com/yahoo/elide/commit/b01c8a4268c39c9cf0e609599ac7a508c12547a4", "message": "fix for NPE", "committedDate": "2020-07-02T14:17:04Z", "type": "commit"}, {"oid": "6f3ebea5c69e6396f4b26fe466d746775a714714", "url": "https://github.com/yahoo/elide/commit/6f3ebea5c69e6396f4b26fe466d746775a714714", "message": "checkstyle fix", "committedDate": "2020-07-02T14:38:25Z", "type": "commit"}]}