{"pr_number": 2192, "pr_title": "Fix mismatched attachments while editing a saved form ", "pr_createdAt": "2020-03-04T20:31:41Z", "pr_url": "https://github.com/dimagi/commcare-android/pull/2192", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM4NzA5OA==", "url": "https://github.com/dimagi/commcare-android/pull/2192#discussion_r388387098", "bodyText": "Shouldn't we check the value of the old and new widgets in this case and make sure they haven't changed? I think we call updateFormRelevencies in a number of situations beyond when media is discarded, and it could cause performance problems if we needed to save the form to disk frequently.", "author": "ctsims", "createdAt": "2020-03-05T15:56:08Z", "path": "app/src/org/commcare/activities/FormEntryActivityUIController.java", "diffHunk": "@@ -737,6 +738,12 @@ protected void updateFormRelevancies() {\n                 shouldRemoveFromView.add(i);\n                 continue;\n             }\n+\n+            //If there was change(in particular image-remove) in an image widget, then update the form\n+            if (oldWidgets.get(i) instanceof ImageWidget) {\n+                activity.updateFormMediaToDisk();", "originalCommit": "8e274f332e924462d02a5e092e2d35bcc8d5c0d6", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d0c2462f19b91d380a052c7aaa4bcc5e1fac0bfc", "chunk": "diff --git a/app/src/org/commcare/activities/FormEntryActivityUIController.java b/app/src/org/commcare/activities/FormEntryActivityUIController.java\nindex cb0133711..ead307a00 100644\n--- a/app/src/org/commcare/activities/FormEntryActivityUIController.java\n+++ b/app/src/org/commcare/activities/FormEntryActivityUIController.java\n\n@@ -738,12 +737,6 @@ public class FormEntryActivityUIController implements CommCareActivityUIControll\n                 shouldRemoveFromView.add(i);\n                 continue;\n             }\n-\n-            //If there was change(in particular image-remove) in an image widget, then update the form\n-            if (oldWidgets.get(i) instanceof ImageWidget) {\n-                activity.updateFormMediaToDisk();\n-            }\n-\n             FormEntryPrompt oldPrompt = oldWidgets.get(i).getPrompt();\n             String priorQuestionTextForThisWidget = oldQuestionTexts.get(i);\n             Vector<SelectChoice> priorSelectChoicesForThisWidget = oldSelectChoices.get(i);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM4OTI1Ng==", "url": "https://github.com/dimagi/commcare-android/pull/2192#discussion_r388389256", "bodyText": "I think the name is a bit confusing. Can I suggest calling it something like onFormMediaUpdated or onExternalAttachmentUpdated?\nWhat the method is doing is somewhat clear from the code, but the context about why we are doing it might be confusing to the next programmer, so this might be a good place to document why the method is called and what should be done.", "author": "ctsims", "createdAt": "2020-03-05T15:59:12Z", "path": "app/src/org/commcare/activities/FormEntryActivity.java", "diffHunk": "@@ -701,6 +703,18 @@ private void saveIncompleteFormToDisk() {\n         saveDataToDisk(FormEntryConstants.EXIT, false, null, true);\n     }\n \n+    protected void updateFormMediaToDisk() {", "originalCommit": "8e274f332e924462d02a5e092e2d35bcc8d5c0d6", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d0c2462f19b91d380a052c7aaa4bcc5e1fac0bfc", "chunk": "diff --git a/app/src/org/commcare/activities/FormEntryActivity.java b/app/src/org/commcare/activities/FormEntryActivity.java\nindex 9ae14b488..726753ba0 100644\n--- a/app/src/org/commcare/activities/FormEntryActivity.java\n+++ b/app/src/org/commcare/activities/FormEntryActivity.java\n\n@@ -703,7 +703,7 @@ public class FormEntryActivity extends SaveSessionCommCareActivity<FormEntryActi\n         saveDataToDisk(FormEntryConstants.EXIT, false, null, true);\n     }\n \n-    protected void updateFormMediaToDisk() {\n+    private void updateFormMediaToDisk() {\n         // Works only when we are editing a saved form.\n         FormRecord formRecord = FormRecord.getFormRecord(formRecordStorage, FormEntryInstanceState.mFormRecordPath);\n         if (formRecord == null) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODUyMjIwNQ==", "url": "https://github.com/dimagi/commcare-android/pull/2192#discussion_r388522205", "bodyText": "I'm really, really sorry for making this suggestion and then retracting it, but I'm almost positive that this change will have a much stronger runtime impact, since getting the answer from a widget can sometimes trigger deferred computation that results in other behavior. I think what you are doing here is the best way to do this check, though, so now that I see how we'd have to implement it, I think we should go back to making the save each time.\nSorry for the extra work.", "author": "ctsims", "createdAt": "2020-03-05T19:44:44Z", "path": "app/src/org/commcare/activities/FormEntryActivityUIController.java", "diffHunk": "@@ -716,6 +717,8 @@ protected void updateFormRelevancies() {\n                 FormRelevancyUpdating.getOldSelectChoicesForEachWidget(oldWidgets);\n         ArrayList<String> oldQuestionTexts =\n                 FormRelevancyUpdating.getOldQuestionTextsForEachWidget(oldWidgets);\n+        ArrayList<IAnswerData> oldAnswers =", "originalCommit": "12d92320552f267ba442a54930ce600845996430", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d0c2462f19b91d380a052c7aaa4bcc5e1fac0bfc", "chunk": "diff --git a/app/src/org/commcare/activities/FormEntryActivityUIController.java b/app/src/org/commcare/activities/FormEntryActivityUIController.java\nindex 091bff076..ead307a00 100644\n--- a/app/src/org/commcare/activities/FormEntryActivityUIController.java\n+++ b/app/src/org/commcare/activities/FormEntryActivityUIController.java\n\n@@ -717,8 +715,6 @@ public class FormEntryActivityUIController implements CommCareActivityUIControll\n                 FormRelevancyUpdating.getOldSelectChoicesForEachWidget(oldWidgets);\n         ArrayList<String> oldQuestionTexts =\n                 FormRelevancyUpdating.getOldQuestionTextsForEachWidget(oldWidgets);\n-        ArrayList<IAnswerData> oldAnswers =\n-                FormRelevancyUpdating.getOldAnswersForEachWidget(oldWidgets);\n \n         activity.saveAnswersForCurrentScreen(FormEntryConstants.DO_NOT_EVALUATE_CONSTRAINTS);\n \n"}}, {"oid": "d0c2462f19b91d380a052c7aaa4bcc5e1fac0bfc", "url": "https://github.com/dimagi/commcare-android/commit/d0c2462f19b91d380a052c7aaa4bcc5e1fac0bfc", "message": "Immediately update saved form when attachment is changed", "committedDate": "2020-03-05T20:22:56Z", "type": "commit"}, {"oid": "e484a929bab1d4c05041c8c2bb779ce8d9e35a4d", "url": "https://github.com/dimagi/commcare-android/commit/e484a929bab1d4c05041c8c2bb779ce8d9e35a4d", "message": "Update form to disk immediately when image is removed", "committedDate": "2020-03-05T20:22:56Z", "type": "commit"}, {"oid": "0f13ea48503681864721e131bbc418bbd4be242f", "url": "https://github.com/dimagi/commcare-android/commit/0f13ea48503681864721e131bbc418bbd4be242f", "message": "Add suggested changes", "committedDate": "2020-03-05T20:22:56Z", "type": "commit"}, {"oid": "6cb574e0eb19a5c293ded515a8468ab770591e21", "url": "https://github.com/dimagi/commcare-android/commit/6cb574e0eb19a5c293ded515a8468ab770591e21", "message": "Update saved form to disk everytime the image widget is changed", "committedDate": "2020-03-05T20:22:56Z", "type": "commit"}, {"oid": "6cb574e0eb19a5c293ded515a8468ab770591e21", "url": "https://github.com/dimagi/commcare-android/commit/6cb574e0eb19a5c293ded515a8468ab770591e21", "message": "Update saved form to disk everytime the image widget is changed", "committedDate": "2020-03-05T20:22:56Z", "type": "forcePushed"}]}