{"pr_number": 2411, "pr_title": "Text to speech support", "pr_createdAt": "2020-11-30T12:46:41Z", "pr_url": "https://github.com/dimagi/commcare-android/pull/2411", "timeline": [{"oid": "a7367cd8c4afce85aeb5702ffe3f54f06e37f9ca", "url": "https://github.com/dimagi/commcare-android/commit/a7367cd8c4afce85aeb5702ffe3f54f06e37f9ca", "message": "Add Text to speech engine", "committedDate": "2020-11-30T11:24:24Z", "type": "commit"}, {"oid": "0d18314bb3bcea0d10add5e3f7578ad9467d1699", "url": "https://github.com/dimagi/commcare-android/commit/0d18314bb3bcea0d10add5e3f7578ad9467d1699", "message": "Add app preference for text-to-speech", "committedDate": "2020-11-30T12:43:50Z", "type": "commit"}, {"oid": "1d9947b601770a50ea05d9e942c0b10c6d335679", "url": "https://github.com/dimagi/commcare-android/commit/1d9947b601770a50ea05d9e942c0b10c6d335679", "message": "Add tts button to question view", "committedDate": "2020-12-01T05:08:43Z", "type": "forcePushed"}, {"oid": "046ff1a184e3c051dcacbe59a5c97028495e3a3a", "url": "https://github.com/dimagi/commcare-android/commit/046ff1a184e3c051dcacbe59a5c97028495e3a3a", "message": "Add tts button to question view", "committedDate": "2020-12-01T05:23:44Z", "type": "commit"}, {"oid": "046ff1a184e3c051dcacbe59a5c97028495e3a3a", "url": "https://github.com/dimagi/commcare-android/commit/046ff1a184e3c051dcacbe59a5c97028495e3a3a", "message": "Add tts button to question view", "committedDate": "2020-12-01T05:23:44Z", "type": "forcePushed"}, {"oid": "9dda46be1986ed5e7d7da881b718cb0558002106", "url": "https://github.com/dimagi/commcare-android/commit/9dda46be1986ed5e7d7da881b718cb0558002106", "message": "Stop audio when app goes to background", "committedDate": "2020-12-01T05:54:16Z", "type": "commit"}, {"oid": "cf1aee3d2c3fb9ba064f37a43b6c10847f61df54", "url": "https://github.com/dimagi/commcare-android/commit/cf1aee3d2c3fb9ba064f37a43b6c10847f61df54", "message": "Use lazy initialization for TTS", "committedDate": "2020-12-01T10:14:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDc1NDY4NQ==", "url": "https://github.com/dimagi/commcare-android/pull/2411#discussion_r534754685", "bodyText": "I think tts should be shown irrespective of all other media content except the audioURI i.e. only when audioURI is present we don't want the TTS settings to take effect but in all other cases if TTS is enabled, we should show the TTS button.", "author": "shubham1g5", "createdAt": "2020-12-03T06:53:41Z", "path": "app/src/org/commcare/views/media/MediaLayout.java", "diffHunk": "@@ -103,9 +105,15 @@ public static MediaLayout buildComprehensiveLayout(Context context,\n                                                        TextView text, String audioURI, String imageURI,\n                                                        final String videoURI, final String bigImageURI,\n                                                        final String qrCodeContent, String inlineVideoURI,\n+                                                       final String ttsText,\n                                                        int questionIndex) {\n         MediaLayout mediaLayout = new MediaLayout(context);\n         mediaLayout.setAVT(text, audioURI, imageURI, videoURI, bigImageURI, qrCodeContent, inlineVideoURI, false, questionIndex);\n+        // Show TTS view only when no other media is present\n+        if (ttsText != null && audioURI == null && imageURI == null && videoURI == null", "originalCommit": "cf1aee3d2c3fb9ba064f37a43b6c10847f61df54", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTg0NTkxOA==", "url": "https://github.com/dimagi/commcare-android/pull/2411#discussion_r535845918", "bodyText": "Sure, will add this.", "author": "ShivamPokhriyal", "createdAt": "2020-12-04T05:28:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDc1NDY4NQ=="}], "type": "inlineReview", "revised_code": {"commit": "004fd3fa84cb1c43d397400153db4f8d5813dfd0", "chunk": "diff --git a/app/src/org/commcare/views/media/MediaLayout.java b/app/src/org/commcare/views/media/MediaLayout.java\nindex 1f6505249..2ef29d44b 100644\n--- a/app/src/org/commcare/views/media/MediaLayout.java\n+++ b/app/src/org/commcare/views/media/MediaLayout.java\n\n@@ -109,9 +109,8 @@ public class MediaLayout extends RelativeLayout {\n                                                        int questionIndex) {\n         MediaLayout mediaLayout = new MediaLayout(context);\n         mediaLayout.setAVT(text, audioURI, imageURI, videoURI, bigImageURI, qrCodeContent, inlineVideoURI, false, questionIndex);\n-        // Show TTS view only when no other media is present\n-        if (ttsText != null && audioURI == null && imageURI == null && videoURI == null\n-                && qrCodeContent == null && inlineVideoURI == null) {\n+        // Show TTS view only when audioURI is not present\n+        if (ttsText != null && audioURI == null) {\n             mediaLayout.showTtsButton(ttsText);\n         }\n         return mediaLayout;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDg4MzY2Mw==", "url": "https://github.com/dimagi/commcare-android/pull/2411#discussion_r534883663", "bodyText": "youc can just call dialog1.dismiss instead of re-querying for the dialog.", "author": "shubham1g5", "createdAt": "2020-12-03T08:12:57Z", "path": "app/src/org/commcare/activities/FormEntryActivity.java", "diffHunk": "@@ -167,6 +171,34 @@\n \n     private boolean fullFormProfilingEnabled = false;\n     private EvaluationTraceReporter traceReporter;\n+    private TextToSpeechCallback mTTSCallback = new TextToSpeechCallback() {\n+        @Override\n+        public void initFailed() {\n+            Toast.makeText(FormEntryActivity.this, Localization.get(\"tts.init.failed\"), Toast.LENGTH_LONG).show();\n+        }\n+\n+        @Override\n+        public void speakFailed() {\n+            Toast.makeText(FormEntryActivity.this, Localization.get(\"tts.speak.failed\"), Toast.LENGTH_LONG).show();\n+        }\n+\n+        @Override\n+        public void voiceDataMissing(String language) {\n+            StandardAlertDialog dialog = new StandardAlertDialog(\n+                    FormEntryActivity.this,\n+                    Localization.get(\"tts.data.missing.title\"),\n+                    Localization.get(\"tts.data.missing.message\", language));\n+            dialog.setPositiveButton(Localization.get(\"dialog.ok\"), (dialog1, which) -> {\n+                Intent installIntent = new Intent();\n+                installIntent.setAction(TextToSpeech.Engine.ACTION_INSTALL_TTS_DATA);\n+                startActivity(installIntent);\n+            });\n+            dialog.setNegativeButton(Localization.get(\"option.cancel\"), (dialog1, which) -> {\n+                dismissAlertDialog();", "originalCommit": "cf1aee3d2c3fb9ba064f37a43b6c10847f61df54", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "004fd3fa84cb1c43d397400153db4f8d5813dfd0", "chunk": "diff --git a/app/src/org/commcare/activities/FormEntryActivity.java b/app/src/org/commcare/activities/FormEntryActivity.java\nindex 8442588af..da1bb7517 100644\n--- a/app/src/org/commcare/activities/FormEntryActivity.java\n+++ b/app/src/org/commcare/activities/FormEntryActivity.java\n\n@@ -192,9 +192,10 @@ public class FormEntryActivity extends SaveSessionCommCareActivity<FormEntryActi\n                 Intent installIntent = new Intent();\n                 installIntent.setAction(TextToSpeech.Engine.ACTION_INSTALL_TTS_DATA);\n                 startActivity(installIntent);\n+                dialog1.dismiss();\n             });\n             dialog.setNegativeButton(Localization.get(\"option.cancel\"), (dialog1, which) -> {\n-                dismissAlertDialog();\n+                dialog1.dismiss();\n             });\n             showAlertDialog(dialog);\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDg4NDY0Ng==", "url": "https://github.com/dimagi/commcare-android/pull/2411#discussion_r534884646", "bodyText": "should dismiss the dialog once user has taken an action", "author": "shubham1g5", "createdAt": "2020-12-03T08:13:28Z", "path": "app/src/org/commcare/activities/FormEntryActivity.java", "diffHunk": "@@ -167,6 +171,34 @@\n \n     private boolean fullFormProfilingEnabled = false;\n     private EvaluationTraceReporter traceReporter;\n+    private TextToSpeechCallback mTTSCallback = new TextToSpeechCallback() {\n+        @Override\n+        public void initFailed() {\n+            Toast.makeText(FormEntryActivity.this, Localization.get(\"tts.init.failed\"), Toast.LENGTH_LONG).show();\n+        }\n+\n+        @Override\n+        public void speakFailed() {\n+            Toast.makeText(FormEntryActivity.this, Localization.get(\"tts.speak.failed\"), Toast.LENGTH_LONG).show();\n+        }\n+\n+        @Override\n+        public void voiceDataMissing(String language) {\n+            StandardAlertDialog dialog = new StandardAlertDialog(\n+                    FormEntryActivity.this,\n+                    Localization.get(\"tts.data.missing.title\"),\n+                    Localization.get(\"tts.data.missing.message\", language));\n+            dialog.setPositiveButton(Localization.get(\"dialog.ok\"), (dialog1, which) -> {\n+                Intent installIntent = new Intent();\n+                installIntent.setAction(TextToSpeech.Engine.ACTION_INSTALL_TTS_DATA);\n+                startActivity(installIntent);", "originalCommit": "cf1aee3d2c3fb9ba064f37a43b6c10847f61df54", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "004fd3fa84cb1c43d397400153db4f8d5813dfd0", "chunk": "diff --git a/app/src/org/commcare/activities/FormEntryActivity.java b/app/src/org/commcare/activities/FormEntryActivity.java\nindex 8442588af..da1bb7517 100644\n--- a/app/src/org/commcare/activities/FormEntryActivity.java\n+++ b/app/src/org/commcare/activities/FormEntryActivity.java\n\n@@ -192,9 +192,10 @@ public class FormEntryActivity extends SaveSessionCommCareActivity<FormEntryActi\n                 Intent installIntent = new Intent();\n                 installIntent.setAction(TextToSpeech.Engine.ACTION_INSTALL_TTS_DATA);\n                 startActivity(installIntent);\n+                dialog1.dismiss();\n             });\n             dialog.setNegativeButton(Localization.get(\"option.cancel\"), (dialog1, which) -> {\n-                dismissAlertDialog();\n+                dialog1.dismiss();\n             });\n             showAlertDialog(dialog);\n         }\n"}}, {"oid": "004fd3fa84cb1c43d397400153db4f8d5813dfd0", "url": "https://github.com/dimagi/commcare-android/commit/004fd3fa84cb1c43d397400153db4f8d5813dfd0", "message": "PR suggestions", "committedDate": "2020-12-04T06:36:59Z", "type": "commit"}, {"oid": "1d05bfda22685a7615752f95b3f856aaffe1f340", "url": "https://github.com/dimagi/commcare-android/commit/1d05bfda22685a7615752f95b3f856aaffe1f340", "message": "Return true when voice is null", "committedDate": "2020-12-04T07:15:55Z", "type": "commit"}, {"oid": "bcda13814c80d821c67806b156ef0c0d36a41f8a", "url": "https://github.com/dimagi/commcare-android/commit/bcda13814c80d821c67806b156ef0c0d36a41f8a", "message": "Use locale with country code", "committedDate": "2020-12-04T07:41:14Z", "type": "commit"}, {"oid": "3dd36a2f21a019dbb93dfb4fef2d637716cc9275", "url": "https://github.com/dimagi/commcare-android/commit/3dd36a2f21a019dbb93dfb4fef2d637716cc9275", "message": "Merge branch 'master' into text-to-speech", "committedDate": "2020-12-08T10:46:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjEzMTA5Nw==", "url": "https://github.com/dimagi/commcare-android/pull/2411#discussion_r542131097", "bodyText": "How does the layout look when you have TTS plus a videoURI ?", "author": "shubham1g5", "createdAt": "2020-12-14T05:59:29Z", "path": "app/src/org/commcare/views/media/MediaLayout.java", "diffHunk": "@@ -103,9 +105,14 @@ public static MediaLayout buildComprehensiveLayout(Context context,\n                                                        TextView text, String audioURI, String imageURI,\n                                                        final String videoURI, final String bigImageURI,\n                                                        final String qrCodeContent, String inlineVideoURI,\n+                                                       final String ttsText,\n                                                        int questionIndex) {\n         MediaLayout mediaLayout = new MediaLayout(context);\n         mediaLayout.setAVT(text, audioURI, imageURI, videoURI, bigImageURI, qrCodeContent, inlineVideoURI, false, questionIndex);\n+        // Show TTS view only when audioURI is not present\n+        if (ttsText != null && audioURI == null) {", "originalCommit": "3dd36a2f21a019dbb93dfb4fef2d637716cc9275", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA0MjQwOA==", "url": "https://github.com/dimagi/commcare-android/pull/2411#discussion_r543042408", "bodyText": "", "author": "ShivamPokhriyal", "createdAt": "2020-12-15T04:44:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjEzMTA5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA2NDUxMQ==", "url": "https://github.com/dimagi/commcare-android/pull/2411#discussion_r543064511", "bodyText": "thanks, this will work.", "author": "shubham1g5", "createdAt": "2020-12-15T05:48:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjEzMTA5Nw=="}], "type": "inlineReview", "revised_code": null}, {"oid": "d6adb96fc40c42bdb7bf0b74fc985a89713109a5", "url": "https://github.com/dimagi/commcare-android/commit/d6adb96fc40c42bdb7bf0b74fc985a89713109a5", "message": "Check for missing voice data only when we get error in speak\n\nOddly, TTS voice.getFeature returns notinstalled sometimes even when the data is installed. Because of this false positive we were showing a dialog to install voice data when it was already installed. With this change we now move the voice data check outside, and only report it when we get an error while speaking.", "committedDate": "2020-12-15T13:58:34Z", "type": "commit"}]}