{"pr_number": 620, "pr_title": "CXF-7996: TCK: Resolves FormParam-related failures", "pr_createdAt": "2020-01-06T00:10:18Z", "pr_url": "https://github.com/apache/cxf/pull/620", "timeline": [{"oid": "1f8a18008d35270b9987872e1ae6cbe7d45f99f1", "url": "https://github.com/apache/cxf/commit/1f8a18008d35270b9987872e1ae6cbe7d45f99f1", "message": "TCK: Resolves FormParam-related failures\n\nShould fix:\nallParamsInParamTest_from_standalone\nallParamsOnFieldTest_from_standalone\nformParamInParamTest_from_standalone\nformParamOnFieldTest_from_standalone\n\nSigned-off-by: Andy McCright <j.andrew.mccright@gmail.com>", "committedDate": "2020-01-05T01:48:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDUxMTgyOQ==", "url": "https://github.com/apache/cxf/pull/620#discussion_r364511829", "bodyText": "I am wondering if we have to close the source (origin) InputStream here, since we replace it (dangling?) with the copy , what do you think @andymc12 ?", "author": "reta", "createdAt": "2020-01-09T00:36:26Z", "path": "rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/utils/JAXRSUtils.java", "diffHunk": "@@ -1878,4 +1891,16 @@ public static String logMessageHandlerProblem(String name, Class<?> cls, MediaTy\n         return errorMessage;\n     }\n \n+    // copy the input stream so that it is not inadvertently closed\n+    private static InputStream copyAndGetEntityStream(Message m) {\n+        ByteArrayOutputStream baos = new ByteArrayOutputStream();\n+        try {\n+            IOUtils.copy(m.getContent(InputStream.class), baos);\n+        } catch (IOException e) {\n+            throw ExceptionUtils.toInternalServerErrorException(e, null);\n+        }\n+        final byte[] copiedBytes = baos.toByteArray();\n+        m.setContent(InputStream.class, new ByteArrayInputStream(copiedBytes));", "originalCommit": "1f8a18008d35270b9987872e1ae6cbe7d45f99f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTAwMjcxNg==", "url": "https://github.com/apache/cxf/pull/620#discussion_r365002716", "bodyText": "Good question.  I'm running that suggestion through our automated tests and the TCK - on the surface, I think it should be fine, but just want to be sure.  The change I added looks like this:\nInputStream origInputStream = m.getContent(InputStream.class);\n        try {\n            IOUtils.copy(origInputStream, baos);\n        } catch (IOException e) {\n            throw ExceptionUtils.toInternalServerErrorException(e, null);\n        } finally {\n            try {\n                origInputStream.close();\n            } catch (Throwable t) { /* AutoFFDC */ }\n        }\n\nI'm out of the office tomorrow, so I may not have the results until Monday.", "author": "andymc12", "createdAt": "2020-01-09T23:03:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDUxMTgyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTA2NTg1Ng==", "url": "https://github.com/apache/cxf/pull/620#discussion_r365065856", "bodyText": "\ud83d\udc4d thanks a lot!", "author": "reta", "createdAt": "2020-01-10T04:09:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDUxMTgyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTg0NTk5MA==", "url": "https://github.com/apache/cxf/pull/620#discussion_r365845990", "bodyText": "I see Dan already merged it (thanks Dan!), but just to followup, the change had no ill effects in our automated testing - the normal functional tests and TCK all passed.", "author": "andymc12", "createdAt": "2020-01-13T14:52:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDUxMTgyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjEwMjg2NA==", "url": "https://github.com/apache/cxf/pull/620#discussion_r366102864", "bodyText": "Yep, I also rerun TCK (https://issues.apache.org/jira/browse/CXF-7996) and these failure are gone, thanks @andymc12 !", "author": "reta", "createdAt": "2020-01-14T00:40:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDUxMTgyOQ=="}], "type": "inlineReview", "revised_code": null}]}