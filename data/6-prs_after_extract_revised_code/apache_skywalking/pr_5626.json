{"pr_number": 5626, "pr_title": "Limit Sql body size", "pr_createdAt": "2020-10-03T02:27:54Z", "pr_url": "https://github.com/apache/skywalking/pull/5626", "timeline": [{"oid": "bfa0097aa32bf3c3bb79371595e74ebf29e9f475", "url": "https://github.com/apache/skywalking/commit/bfa0097aa32bf3c3bb79371595e74ebf29e9f475", "message": "Add max limit for sql body", "committedDate": "2020-10-02T14:08:08Z", "type": "commit"}, {"oid": "d13f4a110845878f850913c1a0c46b572614f09c", "url": "https://github.com/apache/skywalking/commit/d13f4a110845878f850913c1a0c46b572614f09c", "message": "Limit sql body size", "committedDate": "2020-10-03T02:25:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTEyODUzNw==", "url": "https://github.com/apache/skywalking/pull/5626#discussion_r499128537", "bodyText": "I think we missed an annotation for this, this config would never be initialized. :)\nAlso, MySQL/POSTGRESQL/MARIADB seems the same, is there any reason to separate them? @ascrutae. I think the only case is, an app is using 2 kinds of DB, but wants to trace one but not for the other. Is this really reasonable?", "author": "wu-sheng", "createdAt": "2020-10-03T08:29:32Z", "path": "apm-sniffer/apm-sdk-plugin/jdbc-commons/src/main/java/org/apache/skywalking/apm/plugin/jdbc/JDBCPluginConfig.java", "diffHunk": "@@ -53,6 +60,13 @@\n              * Set a negative number to save the complete parameter string to the tag.\n              */\n             public static int SQL_PARAMETERS_MAX_LENGTH = 512;\n+            /**\n+             * For the sake of performance, SkyWalking won't save the entire sql body into the tag, but only the first\n+             * {@code SQL_BODY_MAX_LENGTH} characters.\n+             * <p>\n+             * Set a negative number to save the complete sql body to the tag.\n+             */\n+            public static int SQL_BODY_MAX_LENGTH = 2048;\n         }\n \n         public static class MARIADB {", "originalCommit": "d13f4a110845878f850913c1a0c46b572614f09c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTEzNjI3Ng==", "url": "https://github.com/apache/skywalking/pull/5626#discussion_r499136276", "bodyText": "Yes,  you found a \ud83d\udc1b , So can I uniform  MySQL/POSTGRESQL/MARIADB  config to a single one ?\nfor blew config\n\nTRACE_SQL_PARAMETERS\nSQL_PARAMETERS_MAX_LENGTH\nSQL_BODY_MAX_LENGTH", "author": "xbkaishui", "createdAt": "2020-10-03T10:28:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTEyODUzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTE0MTYxMQ==", "url": "https://github.com/apache/skywalking/pull/5626#discussion_r499141611", "bodyText": "I prefer so, waiting for @ascrutae 's idea.", "author": "wu-sheng", "createdAt": "2020-10-03T11:54:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTEyODUzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTE1MTY4Nw==", "url": "https://github.com/apache/skywalking/pull/5626#discussion_r499151687", "bodyText": "Me too, +1", "author": "ascrutae", "createdAt": "2020-10-03T14:18:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTEyODUzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTE1MjY4Ng==", "url": "https://github.com/apache/skywalking/pull/5626#discussion_r499152686", "bodyText": "@xbkaishui Seems these configs could be merged.", "author": "wu-sheng", "createdAt": "2020-10-03T14:31:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTEyODUzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTE1NzAxMw==", "url": "https://github.com/apache/skywalking/pull/5626#discussion_r499157013", "bodyText": "Ok, will change", "author": "xbkaishui", "createdAt": "2020-10-03T15:25:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTEyODUzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTIwNTI5NQ==", "url": "https://github.com/apache/skywalking/pull/5626#discussion_r499205295", "bodyText": "done", "author": "xbkaishui", "createdAt": "2020-10-04T04:42:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTEyODUzNw=="}], "type": "inlineReview", "revised_code": {"commit": "da41756d3b6905123a653f1275d2bd53a66129c9", "chunk": "diff --git a/apm-sniffer/apm-sdk-plugin/jdbc-commons/src/main/java/org/apache/skywalking/apm/plugin/jdbc/JDBCPluginConfig.java b/apm-sniffer/apm-sdk-plugin/jdbc-commons/src/main/java/org/apache/skywalking/apm/plugin/jdbc/JDBCPluginConfig.java\nindex 370809f746..8b8b953a0a 100644\n--- a/apm-sniffer/apm-sdk-plugin/jdbc-commons/src/main/java/org/apache/skywalking/apm/plugin/jdbc/JDBCPluginConfig.java\n+++ b/apm-sniffer/apm-sdk-plugin/jdbc-commons/src/main/java/org/apache/skywalking/apm/plugin/jdbc/JDBCPluginConfig.java\n\n@@ -44,52 +44,5 @@ public class JDBCPluginConfig {\n              */\n             public static int SQL_BODY_MAX_LENGTH = 2048;\n         }\n-\n-        @PluginConfig(root = JDBCPluginConfig.class)\n-        public static class POSTGRESQL {\n-            /**\n-             * If set to true, the parameters of the sql (typically {@link java.sql.PreparedStatement}) would be\n-             * collected.\n-             */\n-            public static boolean TRACE_SQL_PARAMETERS = false;\n-\n-            /**\n-             * For the sake of performance, SkyWalking won't save the entire parameters string into the tag, but only\n-             * the first {@code SQL_PARAMETERS_MAX_LENGTH} characters.\n-             * <p>\n-             * Set a negative number to save the complete parameter string to the tag.\n-             */\n-            public static int SQL_PARAMETERS_MAX_LENGTH = 512;\n-            /**\n-             * For the sake of performance, SkyWalking won't save the entire sql body into the tag, but only the first\n-             * {@code SQL_BODY_MAX_LENGTH} characters.\n-             * <p>\n-             * Set a negative number to save the complete sql body to the tag.\n-             */\n-            public static int SQL_BODY_MAX_LENGTH = 2048;\n-        }\n-\n-        public static class MARIADB {\n-            /**\n-             * If set to true, the parameters of the sql (typically {@link java.sql.PreparedStatement}) would be\n-             * collected.\n-             */\n-            public static boolean TRACE_SQL_PARAMETERS = false;\n-\n-            /**\n-             * For the sake of performance, SkyWalking won't save the entire parameters string into the tag, but only\n-             * the first {@code SQL_PARAMETERS_MAX_LENGTH} characters.\n-             * <p>\n-             * Set a negative number to save the complete parameter string to the tag.\n-             */\n-            public static int SQL_PARAMETERS_MAX_LENGTH = 512;\n-            /**\n-             * For the sake of performance, SkyWalking won't save the entire sql body into the tag, but only the first\n-             * {@code SQL_BODY_MAX_LENGTH} characters.\n-             * <p>\n-             * Set a negative number to save the complete sql body to the tag.\n-             */\n-            public static int SQL_BODY_MAX_LENGTH = 2048;\n-        }\n     }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTEyODgzNw==", "url": "https://github.com/apache/skywalking/pull/5626#discussion_r499128837", "bodyText": "If MySQL/POSTGRESQL/MARIADB configs are going to be merged, then we don't need to initial this class every time.", "author": "wu-sheng", "createdAt": "2020-10-03T08:34:40Z", "path": "apm-sniffer/apm-sdk-plugin/jdbc-commons/src/main/java/org/apache/skywalking/apm/plugin/jdbc/SqlBodyBuilder.java", "diffHunk": "@@ -0,0 +1,45 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.plugin.jdbc;\n+\n+public class SqlBodyBuilder {", "originalCommit": "d13f4a110845878f850913c1a0c46b572614f09c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTIwNTMwMA==", "url": "https://github.com/apache/skywalking/pull/5626#discussion_r499205300", "bodyText": "done", "author": "xbkaishui", "createdAt": "2020-10-04T04:42:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTEyODgzNw=="}], "type": "inlineReview", "revised_code": {"commit": "da41756d3b6905123a653f1275d2bd53a66129c9", "chunk": "diff --git a/apm-sniffer/apm-sdk-plugin/jdbc-commons/src/main/java/org/apache/skywalking/apm/plugin/jdbc/SqlBodyBuilder.java b/apm-sniffer/apm-sdk-plugin/jdbc-commons/src/main/java/org/apache/skywalking/apm/plugin/jdbc/SqlBodyUtil.java\nsimilarity index 68%\nrename from apm-sniffer/apm-sdk-plugin/jdbc-commons/src/main/java/org/apache/skywalking/apm/plugin/jdbc/SqlBodyBuilder.java\nrename to apm-sniffer/apm-sdk-plugin/jdbc-commons/src/main/java/org/apache/skywalking/apm/plugin/jdbc/SqlBodyUtil.java\nindex 97c25b6039..e8d4acc19f 100644\n--- a/apm-sniffer/apm-sdk-plugin/jdbc-commons/src/main/java/org/apache/skywalking/apm/plugin/jdbc/SqlBodyBuilder.java\n+++ b/apm-sniffer/apm-sdk-plugin/jdbc-commons/src/main/java/org/apache/skywalking/apm/plugin/jdbc/SqlBodyUtil.java\n\n@@ -18,27 +18,21 @@\n \n package org.apache.skywalking.apm.plugin.jdbc;\n \n-public class SqlBodyBuilder {\n+/**\n+ * Sql body utility\n+ */\n+public class SqlBodyUtil {\n     private static final String EMPTY_STRING = \"\";\n-    private int maxLength = 0;\n-    private String sql;\n-\n-    public SqlBodyBuilder setMaxLength(int maxLength) {\n-        this.maxLength = maxLength;\n-        return this;\n-    }\n-\n-    public SqlBodyBuilder setSqlBody(String sqlBody) {\n-        this.sql = sqlBody;\n-        return this;\n-    }\n \n-    public String build() {\n+    /**\n+     * Limit sql body size to specify {@link JDBCPluginConfig.Plugin.JDBC.SQL_BODY_MAX_LENGTH}\n+     */\n+    public static String limitSqlBodySize(String sql) {\n         if (sql == null) {\n             return EMPTY_STRING;\n         }\n-        if (maxLength > 0 && sql.length() > maxLength) {\n-            return sql.substring(0, maxLength) + \"...\";\n+        if (JDBCPluginConfig.Plugin.JDBC.SQL_BODY_MAX_LENGTH > 0 && sql.length() > JDBCPluginConfig.Plugin.JDBC.SQL_BODY_MAX_LENGTH) {\n+            return sql.substring(0, JDBCPluginConfig.Plugin.JDBC.SQL_BODY_MAX_LENGTH) + \"...\";\n         }\n         return sql;\n     }\n"}}, {"oid": "a07720898c1bbd9aeaabb31a23bf0fa371da49ea", "url": "https://github.com/apache/skywalking/commit/a07720898c1bbd9aeaabb31a23bf0fa371da49ea", "message": "Merge branch 'master' into limit-log-size", "committedDate": "2020-10-04T01:19:52Z", "type": "commit"}, {"oid": "da41756d3b6905123a653f1275d2bd53a66129c9", "url": "https://github.com/apache/skywalking/commit/da41756d3b6905123a653f1275d2bd53a66129c9", "message": "Refoctor, uniform MySQL/POSTGRESQL/MARIADB plugin config to a single one", "committedDate": "2020-10-04T04:40:54Z", "type": "commit"}, {"oid": "6c48d4ccb44f774c3f594489d3c1092f5cf123f4", "url": "https://github.com/apache/skywalking/commit/6c48d4ccb44f774c3f594489d3c1092f5cf123f4", "message": "change commnet", "committedDate": "2020-10-04T08:14:28Z", "type": "commit"}, {"oid": "d43f538a03f0dd169d40bd21b0b39cb7bea785d2", "url": "https://github.com/apache/skywalking/commit/d43f538a03f0dd169d40bd21b0b39cb7bea785d2", "message": "fix test case failure", "committedDate": "2020-10-04T09:35:22Z", "type": "commit"}, {"oid": "0b45424034e1846845cc8d7b99686b300bef2875", "url": "https://github.com/apache/skywalking/commit/0b45424034e1846845cc8d7b99686b300bef2875", "message": "fix e2e pg test case", "committedDate": "2020-10-04T10:58:30Z", "type": "commit"}, {"oid": "f0cedf8e0781b4e2cec5e26bfe53d9359b4ef343", "url": "https://github.com/apache/skywalking/commit/f0cedf8e0781b4e2cec5e26bfe53d9359b4ef343", "message": "Merge branch 'master' into limit-log-size", "committedDate": "2020-10-04T14:09:42Z", "type": "commit"}]}