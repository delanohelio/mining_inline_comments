{"pr_number": 4733, "pr_title": "New ReadWriteSafeCache. Rewrite the whole Window and Collection. Simplify codes", "pr_createdAt": "2020-04-29T08:41:08Z", "pr_url": "https://github.com/apache/skywalking/pull/4733", "timeline": [{"oid": "9762d88564266cc5111c6c1e9cedf78edb1f8c58", "url": "https://github.com/apache/skywalking/commit/9762d88564266cc5111c6c1e9cedf78edb1f8c58", "message": "Rewrite the whole window and collection to new ReadWriteSafeCache.", "committedDate": "2020-04-29T08:35:24Z", "type": "commit"}, {"oid": "c3d839a79a42d553460097e12a663015ab9b8077", "url": "https://github.com/apache/skywalking/commit/c3d839a79a42d553460097e12a663015ab9b8077", "message": "Merge branch 'master' into window-rewrite", "committedDate": "2020-04-29T11:41:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzI2MjE4NA==", "url": "https://github.com/apache/skywalking/pull/4733#discussion_r417262184", "bodyText": "Seems buffer1 and buffer2 are redundant", "author": "kezhenxu94", "createdAt": "2020-04-29T12:03:11Z", "path": "oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/analysis/data/ReadWriteSafeCache.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.core.analysis.data;\n+\n+import java.util.List;\n+import java.util.concurrent.locks.ReentrantLock;\n+\n+/**\n+ * ReadWriteSafeCache provides a read/write isolated cache.\n+ */\n+public class ReadWriteSafeCache<T> {\n+    /**\n+     * The buffer1 is used for read or write.\n+     */\n+    private BufferedData<T> buffer1;\n+    /**\n+     * The buffer2 is used for read or write.\n+     */\n+    private BufferedData<T> buffer2;", "originalCommit": "c3d839a79a42d553460097e12a663015ab9b8077", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzMxNDU1Mw==", "url": "https://github.com/apache/skywalking/pull/4733#discussion_r417314553", "bodyText": "Yes, I forgot to remove those from legacy codes. Have been removed now.", "author": "wu-sheng", "createdAt": "2020-04-29T13:29:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzI2MjE4NA=="}], "type": "inlineReview", "revised_code": {"commit": "b5814ea0b6812db9dbf53e207f872e36f8cca7c8", "chunk": "diff --git a/oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/analysis/data/ReadWriteSafeCache.java b/oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/analysis/data/ReadWriteSafeCache.java\nindex 0263334d23..33a4e0178f 100644\n--- a/oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/analysis/data/ReadWriteSafeCache.java\n+++ b/oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/analysis/data/ReadWriteSafeCache.java\n\n@@ -26,30 +26,27 @@ import java.util.concurrent.locks.ReentrantLock;\n  */\n public class ReadWriteSafeCache<T> {\n     /**\n-     * The buffer1 is used for read or write.\n-     */\n-    private BufferedData<T> buffer1;\n-    /**\n-     * The buffer2 is used for read or write.\n-     */\n-    private BufferedData<T> buffer2;\n-\n-    /**\n-     * Read pointer should be pointing to {@link #buffer1} or {@link #buffer2}, and always not NULL.\n+     * Pointer of read buffer.\n      */\n     private volatile BufferedData<T> readBufferPointer;\n     /**\n-     * Write pointer should be pointing to {@link #buffer1} or {@link #buffer2}, and always not NULL.\n+     * Pointer of write buffer.\n      */\n     private volatile BufferedData<T> writeBufferPointer;\n-\n+    /**\n+     * Read/Write lock.\n+     */\n     private final ReentrantLock lock;\n \n+    /**\n+     * Build the Cache through two given buffer instances.\n+     *\n+     * @param buffer1 read/write switchable buffer\n+     * @param buffer2 read/write switchable buffer. It is the write buffer at the beginning.\n+     */\n     public ReadWriteSafeCache(BufferedData<T> buffer1, BufferedData<T> buffer2) {\n-        this.buffer1 = buffer1;\n-        this.buffer2 = buffer2;\n-        readBufferPointer = this.buffer1;\n-        writeBufferPointer = this.buffer2;\n+        readBufferPointer = buffer1;\n+        writeBufferPointer = buffer2;\n         lock = new ReentrantLock();\n     }\n \n"}}, {"oid": "b5814ea0b6812db9dbf53e207f872e36f8cca7c8", "url": "https://github.com/apache/skywalking/commit/b5814ea0b6812db9dbf53e207f872e36f8cca7c8", "message": "Remove redundant fields.", "committedDate": "2020-04-29T13:27:34Z", "type": "commit"}, {"oid": "76a0753667225842ace1f26d5619b0b2bc680ee8", "url": "https://github.com/apache/skywalking/commit/76a0753667225842ace1f26d5619b0b2bc680ee8", "message": "Merge branch 'window-rewrite' of https://github.com/apache/skywalking into window-rewrite", "committedDate": "2020-04-29T13:28:37Z", "type": "commit"}]}