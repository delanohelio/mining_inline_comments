{"pr_number": 5028, "pr_title": "Fix no data bug of oap self observability instance_metrics_second_aggregation metrics.", "pr_createdAt": "2020-07-04T08:29:03Z", "pr_url": "https://github.com/apache/skywalking/pull/5028", "timeline": [{"oid": "1e6fe73c178d75d16883d6b33f3c39cd07d3b48a", "url": "https://github.com/apache/skywalking/commit/1e6fe73c178d75d16883d6b33f3c39cd07d3b48a", "message": "Fix no data bug of oap self observability instance_metrics_second_aggregation metrics.", "committedDate": "2020-07-04T08:10:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTc1NDA3NQ==", "url": "https://github.com/apache/skywalking/pull/5028#discussion_r449754075", "bodyText": "Why Change this?", "author": "wu-sheng", "createdAt": "2020-07-04T08:50:44Z", "path": "oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/analysis/worker/MetricsAggregateWorker.java", "diffHunk": "@@ -69,7 +69,7 @@\n                                                           .getService(MetricsCreator.class);\n         aggregationCounter = metricsCreator.createCounter(\n             \"metrics_aggregation\", \"The number of rows in aggregation\",\n-            new MetricsTag.Keys(\"metricName\", \"level\", \"dimensionality\"), new MetricsTag.Values(modelName, \"1\", \"min\")\n+            new MetricsTag.Keys(\"metricName\", \"level\", \"dimensionality\"), new MetricsTag.Values(modelName, \"1\", \"minute\")", "originalCommit": "1e6fe73c178d75d16883d6b33f3c39cd07d3b48a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTc1NDE1NQ==", "url": "https://github.com/apache/skywalking/pull/5028#discussion_r449754155", "bodyText": "Keep code style uniform.", "author": "Ax1an", "createdAt": "2020-07-04T08:51:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTc1NDA3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTc1NDQ3Ng==", "url": "https://github.com/apache/skywalking/pull/5028#discussion_r449754476", "bodyText": "@hanahmily You made the decision. I am not sure whether this is a suitable change. Basically, we don't have code style guidance about this.", "author": "wu-sheng", "createdAt": "2020-07-04T08:56:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTc1NDA3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTc2MTI1NQ==", "url": "https://github.com/apache/skywalking/pull/5028#discussion_r449761255", "bodyText": "From my perspective, some other references should be updated accordingly. One I can find is grafana.json at docs folder. But it's a bit overkill. I prefer to leave it alone", "author": "hanahmily", "createdAt": "2020-07-04T10:33:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTc1NDA3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTc2MTgxMA==", "url": "https://github.com/apache/skywalking/pull/5028#discussion_r449761810", "bodyText": "@Ax1an Pleasw update the Grafana config to adopt this.", "author": "wu-sheng", "createdAt": "2020-07-04T10:41:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTc1NDA3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTc2MjQ5MA==", "url": "https://github.com/apache/skywalking/pull/5028#discussion_r449762490", "bodyText": "From my perspective, minute is better than min. Because DownSampling enum is minute.\nI prefer to adjust grafana.json.", "author": "Ax1an", "createdAt": "2020-07-04T10:51:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTc1NDA3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTc2MzEyNA==", "url": "https://github.com/apache/skywalking/pull/5028#discussion_r449763124", "bodyText": "@wu-sheng Updated.", "author": "Ax1an", "createdAt": "2020-07-04T11:01:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTc1NDA3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgxMjM3OA==", "url": "https://github.com/apache/skywalking/pull/5028#discussion_r449812378", "bodyText": "After a talk with sheng, I agree with renaming it. Pls, to search and update other possible references more than grafana.json. Thanks.", "author": "hanahmily", "createdAt": "2020-07-04T23:04:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTc1NDA3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTk3MjEwNA==", "url": "https://github.com/apache/skywalking/pull/5028#discussion_r449972104", "bodyText": "@hanahmily I updated oap.yaml. Other references were not found.", "author": "Ax1an", "createdAt": "2020-07-06T03:59:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTc1NDA3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTk3MjIzMQ==", "url": "https://github.com/apache/skywalking/pull/5028#discussion_r449972231", "bodyText": "These are the metrics in grafana after this PR changed.", "author": "Ax1an", "createdAt": "2020-07-06T04:00:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTc1NDA3NQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTc1NDE2OQ==", "url": "https://github.com/apache/skywalking/pull/5028#discussion_r449754169", "bodyText": "Why remove all these? The downsampling is important.", "author": "wu-sheng", "createdAt": "2020-07-04T08:52:06Z", "path": "oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/analysis/worker/MetricsTransWorker.java", "diffHunk": "@@ -36,28 +32,12 @@\n     private final MetricsPersistentWorker hourPersistenceWorker;\n     private final MetricsPersistentWorker dayPersistenceWorker;\n \n-    private final CounterMetrics aggregationHourCounter;\n-    private final CounterMetrics aggregationDayCounter;\n-\n     public MetricsTransWorker(ModuleDefineHolder moduleDefineHolder,\n-                              String modelName,\n                               MetricsPersistentWorker hourPersistenceWorker,\n                               MetricsPersistentWorker dayPersistenceWorker) {\n         super(moduleDefineHolder);\n         this.hourPersistenceWorker = hourPersistenceWorker;\n         this.dayPersistenceWorker = dayPersistenceWorker;\n-\n-        MetricsCreator metricsCreator = moduleDefineHolder.find(TelemetryModule.NAME)\n-                                                          .provider()\n-                                                          .getService(MetricsCreator.class);\n-        aggregationHourCounter = metricsCreator.createCounter(\n-            \"metrics_aggregation\", \"The number of rows in aggregation\", new MetricsTag.Keys(\"metricName\", \"level\",\n-                                                                                            \"dimensionality\"\n-            ), new MetricsTag.Values(modelName, \"2\", \"hour\"));\n-        aggregationDayCounter = metricsCreator.createCounter(", "originalCommit": "1e6fe73c178d75d16883d6b33f3c39cd07d3b48a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTc1NDY2Mw==", "url": "https://github.com/apache/skywalking/pull/5028#discussion_r449754663", "bodyText": "I didn't remove it. I used model.getDownsampling().getName() in MetricsPersistentWorker class.\nThe metrics of minutes,hours and days can be exposed.\naggregationCounter = metricsCreator.createCounter(\n                \"metrics_aggregation\", \"The number of rows in aggregation\",\n                new MetricsTag.Keys(\"metricName\", \"level\", \"dimensionality\"), new MetricsTag.Values(model.getName(), \"2\", model.getDownsampling().getName())\n        );", "author": "Ax1an", "createdAt": "2020-07-04T08:59:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTc1NDE2OQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "fb5a65be0873d84e42f7f488aa35ed09caafd58f", "url": "https://github.com/apache/skywalking/commit/fb5a65be0873d84e42f7f488aa35ed09caafd58f", "message": "update grafana.json", "committedDate": "2020-07-04T10:58:10Z", "type": "commit"}, {"oid": "a6c8ddb584ab823370cef00446c1d8f95b01311f", "url": "https://github.com/apache/skywalking/commit/a6c8ddb584ab823370cef00446c1d8f95b01311f", "message": "Merge branch 'master' into master", "committedDate": "2020-07-06T00:39:43Z", "type": "commit"}, {"oid": "895340beeefcb1a8cb9a36e6bcd5dc93fa8dccae", "url": "https://github.com/apache/skywalking/commit/895340beeefcb1a8cb9a36e6bcd5dc93fa8dccae", "message": "update oap.yaml", "committedDate": "2020-07-06T03:53:44Z", "type": "commit"}]}