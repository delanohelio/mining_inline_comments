{"pr_number": 4187, "pr_title": "Fix plugin bug when Dubbo retries", "pr_createdAt": "2020-01-06T13:17:11Z", "pr_url": "https://github.com/apache/skywalking/pull/4187", "timeline": [{"oid": "b98032144f3b19297aecffffa358078513c48890", "url": "https://github.com/apache/skywalking/commit/b98032144f3b19297aecffffa358078513c48890", "message": "Merge pull request #1 from apache/master\n\nupdate", "committedDate": "2019-06-13T06:31:28Z", "type": "commit"}, {"oid": "83936563679a92bf6ede662fa924f3da377d260b", "url": "https://github.com/apache/skywalking/commit/83936563679a92bf6ede662fa924f3da377d260b", "message": "fix potential NullPointerException", "committedDate": "2019-06-13T07:09:45Z", "type": "commit"}, {"oid": "ae509f09a14fe16a749b861bd49d4bc4dcaa2cb1", "url": "https://github.com/apache/skywalking/commit/ae509f09a14fe16a749b861bd49d4bc4dcaa2cb1", "message": "Revert \"fix potential NullPointerException\"\n\nThis reverts commit 8393656", "committedDate": "2019-06-13T08:57:01Z", "type": "commit"}, {"oid": "507cdd6e2060cfb338f178821b25f47587cafa9f", "url": "https://github.com/apache/skywalking/commit/507cdd6e2060cfb338f178821b25f47587cafa9f", "message": "fix potential NullPointerException\nthe static paramater is best to use the class to reference", "committedDate": "2019-06-13T09:00:36Z", "type": "commit"}, {"oid": "2ac66b5cffbb8d749f100d5c62785e4376bebe8e", "url": "https://github.com/apache/skywalking/commit/2ac66b5cffbb8d749f100d5c62785e4376bebe8e", "message": "Merge branch 'master' into master", "committedDate": "2019-06-13T09:13:51Z", "type": "commit"}, {"oid": "1d01b8e2d8c734c87430d7ca6f68306fe4e1bdc9", "url": "https://github.com/apache/skywalking/commit/1d01b8e2d8c734c87430d7ca6f68306fe4e1bdc9", "message": "Merge branch 'master' into master", "committedDate": "2019-06-13T10:46:45Z", "type": "commit"}, {"oid": "37cd15d3f8aa5ae1a5bc91ea3b57cd37a3797f8b", "url": "https://github.com/apache/skywalking/commit/37cd15d3f8aa5ae1a5bc91ea3b57cd37a3797f8b", "message": "Merge pull request #2 from apache/master\n\nmerge master", "committedDate": "2019-06-14T02:29:03Z", "type": "commit"}, {"oid": "951da119b1599eaa542940780c991ee31194c047", "url": "https://github.com/apache/skywalking/commit/951da119b1599eaa542940780c991ee31194c047", "message": "Merge pull request #3 from apache/master\n\npull master", "committedDate": "2019-08-08T09:10:53Z", "type": "commit"}, {"oid": "d5ab0cffc9cc7c1b984d8e0d32133121526f9ea3", "url": "https://github.com/apache/skywalking/commit/d5ab0cffc9cc7c1b984d8e0d32133121526f9ea3", "message": "Merge pull request #4 from apache/master\n\nmerge master", "committedDate": "2019-08-20T06:59:14Z", "type": "commit"}, {"oid": "cab0af08fd483672f4e0d72f210eb23de8a78c48", "url": "https://github.com/apache/skywalking/commit/cab0af08fd483672f4e0d72f210eb23de8a78c48", "message": "Merge branch 'master' of https://github.com/apache/skywalking", "committedDate": "2020-01-06T13:08:36Z", "type": "commit"}, {"oid": "09b1ad28c88c0394a673ad1d854ab3c40b1f4d0e", "url": "https://github.com/apache/skywalking/commit/09b1ad28c88c0394a673ad1d854ab3c40b1f4d0e", "message": "fix dubbo plugin", "committedDate": "2020-01-06T13:12:57Z", "type": "commit"}, {"oid": "b13fa5971e51ada3c3e1efeb9351e43dee32e112", "url": "https://github.com/apache/skywalking/commit/b13fa5971e51ada3c3e1efeb9351e43dee32e112", "message": "fix dubbo plugin", "committedDate": "2020-01-07T01:36:33Z", "type": "commit"}, {"oid": "a46dd7eef11ff4b99413890e3809c0922fe9e4ad", "url": "https://github.com/apache/skywalking/commit/a46dd7eef11ff4b99413890e3809c0922fe9e4ad", "message": "fix dubbo plugin", "committedDate": "2020-01-07T01:44:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzU2NjE2Ng==", "url": "https://github.com/apache/skywalking/pull/4187#discussion_r363566166", "bodyText": "Remove should be something similar than this\n            CarrierItem next = contextCarrier.items();\n            while (next.hasNext()) {\n                next = next.next();\n                rpcContext.getAttachments().put(next.getHeadKey(), next.getHeadValue());\n            }\n\nKey is defined in there.", "author": "wu-sheng", "createdAt": "2020-01-07T02:14:21Z", "path": "apm-sniffer/apm-sdk-plugin/dubbo-plugin/src/main/java/org/apache/skywalking/apm/plugin/dubbo/DubboInterceptor.java", "diffHunk": "@@ -56,6 +57,9 @@ public void beforeMethod(EnhancedInstance objInst, Method method, Object[] allAr\n         Class<?>[] argumentsTypes, MethodInterceptResult result) throws Throwable {\n         Invoker invoker = (Invoker)allArguments[0];\n         Invocation invocation = (Invocation)allArguments[1];\n+        if (invocation.getAttachments().containsKey(SW3CarrierItem.HEADER_NAME)) {\n+            invocation.getAttachments().remove(SW3CarrierItem.HEADER_NAME);\n+        }", "originalCommit": "a46dd7eef11ff4b99413890e3809c0922fe9e4ad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzU5MzM0NA==", "url": "https://github.com/apache/skywalking/pull/4187#discussion_r363593344", "bodyText": "When dubbo retry, the parameter sw3 will not be updated.", "author": "tzy1316106836", "createdAt": "2020-01-07T05:10:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzU2NjE2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzU5Mzg0Nw==", "url": "https://github.com/apache/skywalking/pull/4187#discussion_r363593847", "bodyText": "Therefore, we should clear sw3 in the invocation first,  so that the latest sw3 will be placed according to the RpcContext", "author": "tzy1316106836", "createdAt": "2020-01-07T05:13:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzU2NjE2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzU5NDIyOQ==", "url": "https://github.com/apache/skywalking/pull/4187#discussion_r363594229", "bodyText": "When dubbo retry, the parameter sw3 will not be updated.\n\n@tzy1316106836 what @wu-sheng meant is that you should not simply use SW3CarrierItem.HEADER_NAME as key to remove the context, you should use something like\uff1a\n            CarrierItem next = contextCarrier.items();\n            while (next.hasNext()) {\n                next = next.next();\n                rpcContext.getAttachments().remove(next.getHeadKey()); // <<<==== HERE\n            }\nbecause there are chances that the users are using SkyWalking 6.x, which uses protocol v2 and the key is SW6CarrierItem.HEADER_NAME instead of SW3CarrierItem.HEADER_NAME, what's more, SW3CarrierItem will be removed soon", "author": "kezhenxu94", "createdAt": "2020-01-07T05:16:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzU2NjE2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzYxMjg5NA==", "url": "https://github.com/apache/skywalking/pull/4187#discussion_r363612894", "bodyText": "done", "author": "tzy1316106836", "createdAt": "2020-01-07T06:57:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzU2NjE2Ng=="}], "type": "inlineReview", "revised_code": {"commit": "cedf0322ea24f23583c9b464ac88246f7325c1cc", "chunk": "diff --git a/apm-sniffer/apm-sdk-plugin/dubbo-plugin/src/main/java/org/apache/skywalking/apm/plugin/dubbo/DubboInterceptor.java b/apm-sniffer/apm-sdk-plugin/dubbo-plugin/src/main/java/org/apache/skywalking/apm/plugin/dubbo/DubboInterceptor.java\nindex ca7dad63e9..346f316789 100644\n--- a/apm-sniffer/apm-sdk-plugin/dubbo-plugin/src/main/java/org/apache/skywalking/apm/plugin/dubbo/DubboInterceptor.java\n+++ b/apm-sniffer/apm-sdk-plugin/dubbo-plugin/src/main/java/org/apache/skywalking/apm/plugin/dubbo/DubboInterceptor.java\n\n@@ -57,9 +57,6 @@ public class DubboInterceptor implements InstanceMethodsAroundInterceptor {\n         Class<?>[] argumentsTypes, MethodInterceptResult result) throws Throwable {\n         Invoker invoker = (Invoker)allArguments[0];\n         Invocation invocation = (Invocation)allArguments[1];\n-        if (invocation.getAttachments().containsKey(SW3CarrierItem.HEADER_NAME)) {\n-            invocation.getAttachments().remove(SW3CarrierItem.HEADER_NAME);\n-        }\n         RpcContext rpcContext = RpcContext.getContext();\n         boolean isConsumer = rpcContext.isConsumerSide();\n         URL requestURL = invoker.getUrl();\n"}}, {"oid": "cedf0322ea24f23583c9b464ac88246f7325c1cc", "url": "https://github.com/apache/skywalking/commit/cedf0322ea24f23583c9b464ac88246f7325c1cc", "message": "fix dubbo plugin", "committedDate": "2020-01-07T06:56:37Z", "type": "commit"}, {"oid": "1f5e88fdcb9ca3713f46263ebc8961b82d81de19", "url": "https://github.com/apache/skywalking/commit/1f5e88fdcb9ca3713f46263ebc8961b82d81de19", "message": "fix dubbo plugin", "committedDate": "2020-01-07T06:59:43Z", "type": "commit"}, {"oid": "2fb00e72bbda612cbb58e682bd00469faeae6ce1", "url": "https://github.com/apache/skywalking/commit/2fb00e72bbda612cbb58e682bd00469faeae6ce1", "message": "Merge branch 'master' into master", "committedDate": "2020-01-07T07:33:39Z", "type": "commit"}]}