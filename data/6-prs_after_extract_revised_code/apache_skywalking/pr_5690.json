{"pr_number": 5690, "pr_title": "Add async-http-client plugin", "pr_createdAt": "2020-10-19T11:30:31Z", "pr_url": "https://github.com/apache/skywalking/pull/5690", "timeline": [{"oid": "dc6a57397fc1ab36e7376b61bf8dd91df1c4de8e", "url": "https://github.com/apache/skywalking/commit/dc6a57397fc1ab36e7376b61bf8dd91df1c4de8e", "message": "feat: async-http-client\u63d2\u4ef6\u5f00\u53d1", "committedDate": "2020-10-19T08:43:41Z", "type": "commit"}, {"oid": "5749e28a5e5eff719e7b374af19dbc7d690b52f3", "url": "https://github.com/apache/skywalking/commit/5749e28a5e5eff719e7b374af19dbc7d690b52f3", "message": "feat:del useless code", "committedDate": "2020-10-19T08:57:59Z", "type": "commit"}, {"oid": "1196f2bee879e61ebe4a95f923cd091182dd3ec6", "url": "https://github.com/apache/skywalking/commit/1196f2bee879e61ebe4a95f923cd091182dd3ec6", "message": "feat: add license", "committedDate": "2020-10-19T11:28:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzY5NDQ0Nw==", "url": "https://github.com/apache/skywalking/pull/5690#discussion_r507694447", "bodyText": "This one should be added to the skywalking/oap-server/server-bootstrap/src/main/resources/component-libraries.yml", "author": "kezhenxu94", "createdAt": "2020-10-19T12:10:01Z", "path": "apm-protocol/apm-network/src/main/java/org/apache/skywalking/apm/network/trace/component/ComponentsDefine.java", "diffHunk": "@@ -185,4 +185,7 @@\n \n     public static final OfficialComponent THRIFT_CLIENT = new OfficialComponent(101, \"thrift-client\");\n \n+    public static final OfficialComponent ASYNC_HTTP_CLIENT = new OfficialComponent(102, \"AsyncHttpClient\");", "originalCommit": "1196f2bee879e61ebe4a95f923cd091182dd3ec6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzY5OTc5MA==", "url": "https://github.com/apache/skywalking/pull/5690#discussion_r507699790", "bodyText": "OK,thanks.", "author": "zhentaoJin", "createdAt": "2020-10-19T12:19:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzY5NDQ0Nw=="}], "type": "inlineReview", "revised_code": null}, {"oid": "967b3564ced16663288b40854cb25e506b7e525f", "url": "https://github.com/apache/skywalking/commit/967b3564ced16663288b40854cb25e506b7e525f", "message": "feat# Add plugin test", "committedDate": "2020-10-26T03:21:42Z", "type": "commit"}, {"oid": "7203ff75a06bcb86fcc9a530db634a7ea8d095a3", "url": "https://github.com/apache/skywalking/commit/7203ff75a06bcb86fcc9a530db634a7ea8d095a3", "message": "feat: 8.3.0-SNAPSHOT version", "committedDate": "2020-10-26T03:37:17Z", "type": "commit"}, {"oid": "fcbfd4f00b72c71d93f9f802a39b2a83db670263", "url": "https://github.com/apache/skywalking/commit/fcbfd4f00b72c71d93f9f802a39b2a83db670263", "message": "Merge branch 'master' into master", "committedDate": "2020-10-26T04:42:57Z", "type": "commit"}, {"oid": "cdb9c2c561fdf6397132096b7073fa9efb2fb2e8", "url": "https://github.com/apache/skywalking/commit/cdb9c2c561fdf6397132096b7073fa9efb2fb2e8", "message": "feat:update plugin-list.md", "committedDate": "2020-10-26T07:39:07Z", "type": "commit"}, {"oid": "c8207e50b049ba7d826a6146341ac25c651f0b38", "url": "https://github.com/apache/skywalking/commit/c8207e50b049ba7d826a6146341ac25c651f0b38", "message": "Merge remote-tracking branch 'origin/master'", "committedDate": "2020-10-26T07:39:33Z", "type": "commit"}, {"oid": "583e92f5ba0b7d8b75ee813843679c8d76698cc0", "url": "https://github.com/apache/skywalking/commit/583e92f5ba0b7d8b75ee813843679c8d76698cc0", "message": "feat:Rename plugin and update plugin-list.md", "committedDate": "2020-10-26T07:53:41Z", "type": "commit"}, {"oid": "0ee430aa87bcfdcdd51305d7495670ebd82710d5", "url": "https://github.com/apache/skywalking/commit/0ee430aa87bcfdcdd51305d7495670ebd82710d5", "message": "feat# Rename asynchttpclient plugin package name", "committedDate": "2020-10-28T10:07:11Z", "type": "commit"}, {"oid": "2f5ec644887365b1f362cec06e979b11547ee8b6", "url": "https://github.com/apache/skywalking/commit/2f5ec644887365b1f362cec06e979b11547ee8b6", "message": "Merge branch 'master' into master", "committedDate": "2020-10-28T10:45:20Z", "type": "commit"}, {"oid": "79dce970225367eb06497a20390ba777412a76d0", "url": "https://github.com/apache/skywalking/commit/79dce970225367eb06497a20390ba777412a76d0", "message": "feat# add asynchttpclient-scenario,update Supported-list.md", "committedDate": "2020-11-02T11:54:57Z", "type": "commit"}, {"oid": "544885691ed850a283b8fb854ebafb647290706a", "url": "https://github.com/apache/skywalking/commit/544885691ed850a283b8fb854ebafb647290706a", "message": "Merge remote-tracking branch 'upstream/master'\n\n# Conflicts:\n#\tapm-sniffer/apm-sdk-plugin/pom.xml", "committedDate": "2020-11-02T14:36:50Z", "type": "commit"}, {"oid": "8a15d6fd695da4d534542c4b58d5b4cd63a920df", "url": "https://github.com/apache/skywalking/commit/8a15d6fd695da4d534542c4b58d5b4cd63a920df", "message": "feat# update asynchttpclient scenario", "committedDate": "2020-11-03T02:56:27Z", "type": "commit"}, {"oid": "66934bc59758213860f541047aaa7fb20dddc40d", "url": "https://github.com/apache/skywalking/commit/66934bc59758213860f541047aaa7fb20dddc40d", "message": "Merge branch 'master' into master", "committedDate": "2020-11-03T08:41:13Z", "type": "commit"}, {"oid": "af127b5c375a9569ebf6addb721d0de376fd16a7", "url": "https://github.com/apache/skywalking/commit/af127b5c375a9569ebf6addb721d0de376fd16a7", "message": "Polishing.", "committedDate": "2020-11-04T06:24:07Z", "type": "commit"}, {"oid": "244b581012f2423d3a91b6c1a1e3567017bbbc60", "url": "https://github.com/apache/skywalking/commit/244b581012f2423d3a91b6c1a1e3567017bbbc60", "message": "Merge branch 'master' into hanfei", "committedDate": "2020-11-04T06:25:57Z", "type": "commit"}, {"oid": "e8444c343ae4fd3c89b6434ce2adb9b874a2c1da", "url": "https://github.com/apache/skywalking/commit/e8444c343ae4fd3c89b6434ce2adb9b874a2c1da", "message": "Merge remote-tracking branch 'upstream/master'", "committedDate": "2020-11-04T07:16:55Z", "type": "commit"}, {"oid": "68baed32da6ce1ec248180d11c8ed85f6bfcb40b", "url": "https://github.com/apache/skywalking/commit/68baed32da6ce1ec248180d11c8ed85f6bfcb40b", "message": "Merge branch 'master' into master", "committedDate": "2020-11-04T08:05:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzE5NjQ1OQ==", "url": "https://github.com/apache/skywalking/pull/5690#discussion_r517196459", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    ContextManager.activeSpan().errorOccurred().log(t);\n          \n          \n            \n                    ContextManager.activeSpan()..log(t);\n          \n      \n    \n    \n  \n\nI think I have reminded this? log includes the error default today.", "author": "wu-sheng", "createdAt": "2020-11-04T09:14:15Z", "path": "apm-sniffer/apm-sdk-plugin/asynchttpclient-2.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/asynchttpclient/v1/ExecuteInterceptor.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.skywalking.apm.plugin.asynchttpclient.v1;\n+\n+import io.netty.handler.codec.http.HttpHeaders;\n+import java.lang.reflect.Method;\n+import org.apache.skywalking.apm.agent.core.context.CarrierItem;\n+import org.apache.skywalking.apm.agent.core.context.ContextCarrier;\n+import org.apache.skywalking.apm.agent.core.context.ContextManager;\n+import org.apache.skywalking.apm.agent.core.context.tag.Tags;\n+import org.apache.skywalking.apm.agent.core.context.trace.AbstractSpan;\n+import org.apache.skywalking.apm.agent.core.context.trace.SpanLayer;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.EnhancedInstance;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.InstanceMethodsAroundInterceptor;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.MethodInterceptResult;\n+import org.apache.skywalking.apm.network.trace.component.ComponentsDefine;\n+import org.asynchttpclient.Request;\n+import org.asynchttpclient.uri.Uri;\n+\n+public class ExecuteInterceptor implements InstanceMethodsAroundInterceptor {\n+\n+    @Override\n+    public void beforeMethod(EnhancedInstance objInst, Method method, Object[] allArguments,\n+                             Class<?>[] argumentsTypes, MethodInterceptResult result) throws Throwable {\n+\n+        final Request httpRequest = (Request) allArguments[0];\n+        final Uri requestUri = httpRequest.getUri();\n+\n+        AbstractSpan span = ContextManager.createExitSpan(\n+            \"AsyncHttpClient\" + requestUri.getPath(), requestUri.getHost() + \":\" + requestUri.getPort());\n+\n+        ContextCarrier contextCarrier = new ContextCarrier();\n+        ContextManager.inject(contextCarrier);\n+        span.setComponent(ComponentsDefine.ASYNC_HTTP_CLIENT);\n+        Tags.HTTP.METHOD.set(span, httpRequest.getMethod());\n+        Tags.URL.set(span, httpRequest.getUrl());\n+        SpanLayer.asHttp(span);\n+\n+        final HttpHeaders headers = httpRequest.getHeaders();\n+        CarrierItem next = contextCarrier.items();\n+        while (next.hasNext()) {\n+            next = next.next();\n+            headers.add(next.getHeadKey(), next.getHeadValue());\n+        }\n+    }\n+\n+    @Override\n+    public Object afterMethod(EnhancedInstance objInst, Method method, Object[] allArguments,\n+                              Class<?>[] argumentsTypes, Object ret) throws Throwable {\n+        ContextManager.stopSpan();\n+        return ret;\n+    }\n+\n+    @Override\n+    public void handleMethodException(EnhancedInstance objInst, Method method, Object[] allArguments,\n+                                      Class<?>[] argumentsTypes, Throwable t) {\n+        ContextManager.activeSpan().errorOccurred().log(t);", "originalCommit": "68baed32da6ce1ec248180d11c8ed85f6bfcb40b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzIwNjA0Mg==", "url": "https://github.com/apache/skywalking/pull/5690#discussion_r517206042", "bodyText": "this is my fault. i will fix it.", "author": "zifeihan", "createdAt": "2020-11-04T09:29:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzE5NjQ1OQ=="}], "type": "inlineReview", "revised_code": {"commit": "f14e98d8bf5cf877b470464e9c973ff5711abdd0", "chunk": "diff --git a/apm-sniffer/apm-sdk-plugin/asynchttpclient-2.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/asynchttpclient/v1/ExecuteInterceptor.java b/apm-sniffer/apm-sdk-plugin/asynchttpclient-2.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/asynchttpclient/v1/ExecuteInterceptor.java\nindex 5380facbfc..c4c38f6b50 100644\n--- a/apm-sniffer/apm-sdk-plugin/asynchttpclient-2.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/asynchttpclient/v1/ExecuteInterceptor.java\n+++ b/apm-sniffer/apm-sdk-plugin/asynchttpclient-2.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/asynchttpclient/v1/ExecuteInterceptor.java\n\n@@ -29,9 +29,14 @@ import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.EnhancedI\n import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.InstanceMethodsAroundInterceptor;\n import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.MethodInterceptResult;\n import org.apache.skywalking.apm.network.trace.component.ComponentsDefine;\n+import org.asynchttpclient.AsyncHandler;\n import org.asynchttpclient.Request;\n import org.asynchttpclient.uri.Uri;\n \n+/**\n+ * interceptor for intercept {@see org.asynchttpclient.DefaultAsyncHttpClient#execute},\n+ * we wrapper the args[0] for get the real time duration, and stop the span.\n+ */\n public class ExecuteInterceptor implements InstanceMethodsAroundInterceptor {\n \n     @Override\n"}}, {"oid": "a98d050cdce3ec8b170a2528193c8467b997f80b", "url": "https://github.com/apache/skywalking/commit/a98d050cdce3ec8b170a2528193c8467b997f80b", "message": "Merge remote-tracking branch 'origin/master'", "committedDate": "2020-11-04T09:31:19Z", "type": "commit"}, {"oid": "f14e98d8bf5cf877b470464e9c973ff5711abdd0", "url": "https://github.com/apache/skywalking/commit/f14e98d8bf5cf877b470464e9c973ff5711abdd0", "message": "Add AsyncHandlerWrapper for get the span real time duration, and stop the span.", "committedDate": "2020-11-05T02:28:05Z", "type": "commit"}, {"oid": "81bf3b0ed4d41e8da137952b571b0257def91ff9", "url": "https://github.com/apache/skywalking/commit/81bf3b0ed4d41e8da137952b571b0257def91ff9", "message": "Merge branch 'hanfei'", "committedDate": "2020-11-05T06:22:04Z", "type": "commit"}, {"oid": "83b3ab2bf7ce32a7ae62510820dfa958a70ef12e", "url": "https://github.com/apache/skywalking/commit/83b3ab2bf7ce32a7ae62510820dfa958a70ef12e", "message": "Polishing.", "committedDate": "2020-11-05T07:32:51Z", "type": "commit"}, {"oid": "08470b30716e274ad48389a2e2638b6801040da5", "url": "https://github.com/apache/skywalking/commit/08470b30716e274ad48389a2e2638b6801040da5", "message": "Merge branch 'master' into master", "committedDate": "2020-11-05T09:22:44Z", "type": "commit"}, {"oid": "65fdfe4da471f28b4c97279e0c11c8c97f92eb4b", "url": "https://github.com/apache/skywalking/commit/65fdfe4da471f28b4c97279e0c11c8c97f92eb4b", "message": "feat#update CHANGES.md", "committedDate": "2020-11-05T10:15:22Z", "type": "commit"}, {"oid": "aee9327b08203eb48c09963cb9947a4781c936a4", "url": "https://github.com/apache/skywalking/commit/aee9327b08203eb48c09963cb9947a4781c936a4", "message": "Merge remote-tracking branch 'upstream/master'", "committedDate": "2020-11-05T10:15:51Z", "type": "commit"}, {"oid": "0d78856032188562d4234ad48549ea73c95e7949", "url": "https://github.com/apache/skywalking/commit/0d78856032188562d4234ad48549ea73c95e7949", "message": "Merge remote-tracking branch 'origin/master'", "committedDate": "2020-11-05T10:16:05Z", "type": "commit"}, {"oid": "4d5404a5936ce9a0efec1ad1cee3c0ce07c35517", "url": "https://github.com/apache/skywalking/commit/4d5404a5936ce9a0efec1ad1cee3c0ce07c35517", "message": "feat#update CHANGES.md", "committedDate": "2020-11-05T10:25:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzk3NzgzNw==", "url": "https://github.com/apache/skywalking/pull/5690#discussion_r517977837", "bodyText": "Note that, must be avoided to interrupt the process of the application in the wrapper class.", "author": "dmsolr", "createdAt": "2020-11-05T11:23:36Z", "path": "apm-sniffer/apm-sdk-plugin/asynchttpclient-2.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/asynchttpclient/v1/AsyncHandlerWrapper.java", "diffHunk": "@@ -0,0 +1,148 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.skywalking.apm.plugin.asynchttpclient.v1;\n+\n+import io.netty.channel.Channel;\n+import io.netty.handler.codec.http.HttpHeaders;\n+import java.net.InetSocketAddress;\n+import java.util.List;\n+import javax.net.ssl.SSLSession;\n+import org.apache.skywalking.apm.agent.core.context.trace.AbstractSpan;\n+import org.asynchttpclient.AsyncCompletionHandlerBase;\n+import org.asynchttpclient.AsyncHandler;\n+import org.asynchttpclient.HttpResponseBodyPart;\n+import org.asynchttpclient.HttpResponseStatus;\n+import org.asynchttpclient.netty.request.NettyRequest;\n+\n+/**\n+ * {@link AsyncHandlerWrapper} wrapper the {@link AsyncHandler} object for tracing.\n+ * if userAsyncHandler is null, we will set {@link AsyncCompletionHandlerBase} to avoid NPE.\n+ */\n+public class AsyncHandlerWrapper implements AsyncHandler {\n+\n+    private final AsyncHandler userAsyncHandler;\n+    private final AbstractSpan asyncSpan;\n+\n+    public AsyncHandlerWrapper(AsyncHandler asyncHandler, AbstractSpan span) {\n+        this.userAsyncHandler = asyncHandler == null ? new AsyncCompletionHandlerBase() : asyncHandler;\n+        this.asyncSpan = span;\n+    }\n+\n+    @Override\n+    public State onStatusReceived(final HttpResponseStatus httpResponseStatus) throws Exception {\n+        return userAsyncHandler.onStatusReceived(httpResponseStatus);\n+    }\n+\n+    @Override\n+    public State onHeadersReceived(final HttpHeaders httpHeaders) throws Exception {\n+        return userAsyncHandler.onHeadersReceived(httpHeaders);\n+    }\n+\n+    @Override\n+    public State onBodyPartReceived(final HttpResponseBodyPart httpResponseBodyPart) throws Exception {\n+        return userAsyncHandler.onBodyPartReceived(httpResponseBodyPart);\n+    }\n+\n+    @Override\n+    public State onTrailingHeadersReceived(final HttpHeaders headers) throws Exception {\n+        return userAsyncHandler.onTrailingHeadersReceived(headers);\n+    }\n+\n+    @Override\n+    public void onThrowable(final Throwable throwable) {\n+        asyncSpan.log(throwable);\n+        asyncSpan.asyncFinish();\n+        userAsyncHandler.onThrowable(throwable);\n+    }\n+\n+    @Override\n+    public Object onCompleted() throws Exception {\n+        asyncSpan.asyncFinish();\n+        return userAsyncHandler.onCompleted();\n+    }", "originalCommit": "4d5404a5936ce9a0efec1ad1cee3c0ce07c35517", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODAyMTQ5Mw==", "url": "https://github.com/apache/skywalking/pull/5690#discussion_r518021493", "bodyText": "Thanks for reminding, it is really polished here", "author": "zhentaoJin", "createdAt": "2020-11-05T12:42:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzk3NzgzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODAyNDMyNQ==", "url": "https://github.com/apache/skywalking/pull/5690#discussion_r518024325", "bodyText": "done.", "author": "zifeihan", "createdAt": "2020-11-05T12:47:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzk3NzgzNw=="}], "type": "inlineReview", "revised_code": {"commit": "672bf38776cd1e4efb50d9bcc4856ca0d4b3f4c9", "chunk": "diff --git a/apm-sniffer/apm-sdk-plugin/asynchttpclient-2.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/asynchttpclient/v1/AsyncHandlerWrapper.java b/apm-sniffer/apm-sdk-plugin/asynchttpclient-2.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/asynchttpclient/v2/AsyncHandlerWrapper.java\nsimilarity index 88%\nrename from apm-sniffer/apm-sdk-plugin/asynchttpclient-2.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/asynchttpclient/v1/AsyncHandlerWrapper.java\nrename to apm-sniffer/apm-sdk-plugin/asynchttpclient-2.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/asynchttpclient/v2/AsyncHandlerWrapper.java\nindex 012a412dd4..0562d34fd5 100644\n--- a/apm-sniffer/apm-sdk-plugin/asynchttpclient-2.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/asynchttpclient/v1/AsyncHandlerWrapper.java\n+++ b/apm-sniffer/apm-sdk-plugin/asynchttpclient-2.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/asynchttpclient/v2/AsyncHandlerWrapper.java\n\n@@ -15,7 +15,7 @@\n  * limitations under the License.\n  */\n \n-package org.apache.skywalking.apm.plugin.asynchttpclient.v1;\n+package org.apache.skywalking.apm.plugin.asynchttpclient.v2;\n \n import io.netty.channel.Channel;\n import io.netty.handler.codec.http.HttpHeaders;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzk3OTY4Mw==", "url": "https://github.com/apache/skywalking/pull/5690#discussion_r517979683", "bodyText": "Change to single-line comment", "author": "dmsolr", "createdAt": "2020-11-05T11:26:55Z", "path": "apm-sniffer/apm-sdk-plugin/asynchttpclient-2.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/asynchttpclient/v1/ExecuteInterceptor.java", "diffHunk": "@@ -0,0 +1,87 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.skywalking.apm.plugin.asynchttpclient.v1;\n+\n+import io.netty.handler.codec.http.HttpHeaders;\n+import java.lang.reflect.Method;\n+import org.apache.skywalking.apm.agent.core.context.CarrierItem;\n+import org.apache.skywalking.apm.agent.core.context.ContextCarrier;\n+import org.apache.skywalking.apm.agent.core.context.ContextManager;\n+import org.apache.skywalking.apm.agent.core.context.tag.Tags;\n+import org.apache.skywalking.apm.agent.core.context.trace.AbstractSpan;\n+import org.apache.skywalking.apm.agent.core.context.trace.SpanLayer;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.EnhancedInstance;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.InstanceMethodsAroundInterceptor;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.MethodInterceptResult;\n+import org.apache.skywalking.apm.network.trace.component.ComponentsDefine;\n+import org.asynchttpclient.AsyncHandler;\n+import org.asynchttpclient.Request;\n+import org.asynchttpclient.uri.Uri;\n+\n+/**\n+ * interceptor for {@link org.asynchttpclient.DefaultAsyncHttpClient}\n+ */\n+public class ExecuteInterceptor implements InstanceMethodsAroundInterceptor {\n+\n+    @Override\n+    public void beforeMethod(EnhancedInstance objInst, Method method, Object[] allArguments,\n+                             Class<?>[] argumentsTypes, MethodInterceptResult result) throws Throwable {\n+\n+        final Request httpRequest = (Request) allArguments[0];\n+        final Uri requestUri = httpRequest.getUri();\n+\n+        AbstractSpan span = ContextManager.createExitSpan(\n+            \"AsyncHttpClient\" + requestUri.getPath(), requestUri.getHost() + \":\" + requestUri.getPort());\n+\n+        /**\n+         * We wrapper the allArguments[1] for get the real time duration, and stop the span.\n+         */", "originalCommit": "4d5404a5936ce9a0efec1ad1cee3c0ce07c35517", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODAyOTAxNQ==", "url": "https://github.com/apache/skywalking/pull/5690#discussion_r518029015", "bodyText": "done", "author": "zhentaoJin", "createdAt": "2020-11-05T12:55:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzk3OTY4Mw=="}], "type": "inlineReview", "revised_code": {"commit": "672bf38776cd1e4efb50d9bcc4856ca0d4b3f4c9", "chunk": "diff --git a/apm-sniffer/apm-sdk-plugin/asynchttpclient-2.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/asynchttpclient/v1/ExecuteInterceptor.java b/apm-sniffer/apm-sdk-plugin/asynchttpclient-2.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/asynchttpclient/v2/ExecuteInterceptor.java\nsimilarity index 95%\nrename from apm-sniffer/apm-sdk-plugin/asynchttpclient-2.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/asynchttpclient/v1/ExecuteInterceptor.java\nrename to apm-sniffer/apm-sdk-plugin/asynchttpclient-2.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/asynchttpclient/v2/ExecuteInterceptor.java\nindex 135588f996..f1a24855a3 100644\n--- a/apm-sniffer/apm-sdk-plugin/asynchttpclient-2.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/asynchttpclient/v1/ExecuteInterceptor.java\n+++ b/apm-sniffer/apm-sdk-plugin/asynchttpclient-2.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/asynchttpclient/v2/ExecuteInterceptor.java\n\n@@ -15,7 +15,7 @@\n  * limitations under the License.\n  */\n \n-package org.apache.skywalking.apm.plugin.asynchttpclient.v1;\n+package org.apache.skywalking.apm.plugin.asynchttpclient.v2;\n \n import io.netty.handler.codec.http.HttpHeaders;\n import java.lang.reflect.Method;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzk4MjYxMA==", "url": "https://github.com/apache/skywalking/pull/5690#discussion_r517982610", "bodyText": "what does the v1 mean?", "author": "dmsolr", "createdAt": "2020-11-05T11:32:00Z", "path": "apm-sniffer/apm-sdk-plugin/asynchttpclient-2.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/asynchttpclient/v1/AsyncHandlerWrapper.java", "diffHunk": "@@ -0,0 +1,148 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.skywalking.apm.plugin.asynchttpclient.v1;", "originalCommit": "4d5404a5936ce9a0efec1ad1cee3c0ce07c35517", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODAzMDM5NA==", "url": "https://github.com/apache/skywalking/pull/5690#discussion_r518030394", "bodyText": "The naming is really not very good, it has been modified", "author": "zhentaoJin", "createdAt": "2020-11-05T12:57:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzk4MjYxMA=="}], "type": "inlineReview", "revised_code": {"commit": "672bf38776cd1e4efb50d9bcc4856ca0d4b3f4c9", "chunk": "diff --git a/apm-sniffer/apm-sdk-plugin/asynchttpclient-2.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/asynchttpclient/v1/AsyncHandlerWrapper.java b/apm-sniffer/apm-sdk-plugin/asynchttpclient-2.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/asynchttpclient/v2/AsyncHandlerWrapper.java\nsimilarity index 88%\nrename from apm-sniffer/apm-sdk-plugin/asynchttpclient-2.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/asynchttpclient/v1/AsyncHandlerWrapper.java\nrename to apm-sniffer/apm-sdk-plugin/asynchttpclient-2.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/asynchttpclient/v2/AsyncHandlerWrapper.java\nindex 012a412dd4..0562d34fd5 100644\n--- a/apm-sniffer/apm-sdk-plugin/asynchttpclient-2.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/asynchttpclient/v1/AsyncHandlerWrapper.java\n+++ b/apm-sniffer/apm-sdk-plugin/asynchttpclient-2.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/asynchttpclient/v2/AsyncHandlerWrapper.java\n\n@@ -15,7 +15,7 @@\n  * limitations under the License.\n  */\n \n-package org.apache.skywalking.apm.plugin.asynchttpclient.v1;\n+package org.apache.skywalking.apm.plugin.asynchttpclient.v2;\n \n import io.netty.channel.Channel;\n import io.netty.handler.codec.http.HttpHeaders;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODAxMzQwNw==", "url": "https://github.com/apache/skywalking/pull/5690#discussion_r518013407", "bodyText": "This method should be try-catch. This could trigger the exception if the plugin has bug, or the target lib has bug.", "author": "wu-sheng", "createdAt": "2020-11-05T12:27:51Z", "path": "apm-sniffer/apm-sdk-plugin/asynchttpclient-2.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/asynchttpclient/v1/AsyncHandlerWrapper.java", "diffHunk": "@@ -0,0 +1,148 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.skywalking.apm.plugin.asynchttpclient.v1;\n+\n+import io.netty.channel.Channel;\n+import io.netty.handler.codec.http.HttpHeaders;\n+import java.net.InetSocketAddress;\n+import java.util.List;\n+import javax.net.ssl.SSLSession;\n+import org.apache.skywalking.apm.agent.core.context.trace.AbstractSpan;\n+import org.asynchttpclient.AsyncCompletionHandlerBase;\n+import org.asynchttpclient.AsyncHandler;\n+import org.asynchttpclient.HttpResponseBodyPart;\n+import org.asynchttpclient.HttpResponseStatus;\n+import org.asynchttpclient.netty.request.NettyRequest;\n+\n+/**\n+ * {@link AsyncHandlerWrapper} wrapper the {@link AsyncHandler} object for tracing.\n+ * if userAsyncHandler is null, we will set {@link AsyncCompletionHandlerBase} to avoid NPE.\n+ */\n+public class AsyncHandlerWrapper implements AsyncHandler {\n+\n+    private final AsyncHandler userAsyncHandler;\n+    private final AbstractSpan asyncSpan;\n+\n+    public AsyncHandlerWrapper(AsyncHandler asyncHandler, AbstractSpan span) {\n+        this.userAsyncHandler = asyncHandler == null ? new AsyncCompletionHandlerBase() : asyncHandler;\n+        this.asyncSpan = span;\n+    }\n+\n+    @Override\n+    public State onStatusReceived(final HttpResponseStatus httpResponseStatus) throws Exception {\n+        return userAsyncHandler.onStatusReceived(httpResponseStatus);\n+    }\n+\n+    @Override\n+    public State onHeadersReceived(final HttpHeaders httpHeaders) throws Exception {\n+        return userAsyncHandler.onHeadersReceived(httpHeaders);\n+    }\n+\n+    @Override\n+    public State onBodyPartReceived(final HttpResponseBodyPart httpResponseBodyPart) throws Exception {\n+        return userAsyncHandler.onBodyPartReceived(httpResponseBodyPart);\n+    }\n+\n+    @Override\n+    public State onTrailingHeadersReceived(final HttpHeaders headers) throws Exception {\n+        return userAsyncHandler.onTrailingHeadersReceived(headers);\n+    }\n+\n+    @Override\n+    public void onThrowable(final Throwable throwable) {\n+        asyncSpan.log(throwable);\n+        asyncSpan.asyncFinish();\n+        userAsyncHandler.onThrowable(throwable);\n+    }\n+\n+    @Override\n+    public Object onCompleted() throws Exception {\n+        asyncSpan.asyncFinish();", "originalCommit": "4d5404a5936ce9a0efec1ad1cee3c0ce07c35517", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODAyNTA4NQ==", "url": "https://github.com/apache/skywalking/pull/5690#discussion_r518025085", "bodyText": "done.", "author": "zifeihan", "createdAt": "2020-11-05T12:48:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODAxMzQwNw=="}], "type": "inlineReview", "revised_code": {"commit": "672bf38776cd1e4efb50d9bcc4856ca0d4b3f4c9", "chunk": "diff --git a/apm-sniffer/apm-sdk-plugin/asynchttpclient-2.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/asynchttpclient/v1/AsyncHandlerWrapper.java b/apm-sniffer/apm-sdk-plugin/asynchttpclient-2.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/asynchttpclient/v2/AsyncHandlerWrapper.java\nsimilarity index 88%\nrename from apm-sniffer/apm-sdk-plugin/asynchttpclient-2.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/asynchttpclient/v1/AsyncHandlerWrapper.java\nrename to apm-sniffer/apm-sdk-plugin/asynchttpclient-2.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/asynchttpclient/v2/AsyncHandlerWrapper.java\nindex 012a412dd4..0562d34fd5 100644\n--- a/apm-sniffer/apm-sdk-plugin/asynchttpclient-2.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/asynchttpclient/v1/AsyncHandlerWrapper.java\n+++ b/apm-sniffer/apm-sdk-plugin/asynchttpclient-2.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/asynchttpclient/v2/AsyncHandlerWrapper.java\n\n@@ -15,7 +15,7 @@\n  * limitations under the License.\n  */\n \n-package org.apache.skywalking.apm.plugin.asynchttpclient.v1;\n+package org.apache.skywalking.apm.plugin.asynchttpclient.v2;\n \n import io.netty.channel.Channel;\n import io.netty.handler.codec.http.HttpHeaders;\n"}}, {"oid": "672bf38776cd1e4efb50d9bcc4856ca0d4b3f4c9", "url": "https://github.com/apache/skywalking/commit/672bf38776cd1e4efb50d9bcc4856ca0d4b3f4c9", "message": "Polishing.", "committedDate": "2020-11-05T12:46:04Z", "type": "commit"}, {"oid": "a9ac2c50c6b3916deba8f6b638190fc0544b6909", "url": "https://github.com/apache/skywalking/commit/a9ac2c50c6b3916deba8f6b638190fc0544b6909", "message": "feat#Change to single-line comment", "committedDate": "2020-11-05T12:53:59Z", "type": "commit"}, {"oid": "b5c39788b52fa4d6e375b71e49f9658b2cfd4f2c", "url": "https://github.com/apache/skywalking/commit/b5c39788b52fa4d6e375b71e49f9658b2cfd4f2c", "message": "Merge branch 'master' into master", "committedDate": "2020-11-05T13:32:52Z", "type": "commit"}, {"oid": "ac1223ec635d5dd69ea03d77afa1da9e022a2c06", "url": "https://github.com/apache/skywalking/commit/ac1223ec635d5dd69ea03d77afa1da9e022a2c06", "message": "Merge remote-tracking branch 'upstream/master'", "committedDate": "2020-11-05T13:35:39Z", "type": "commit"}, {"oid": "3ce86be6bd9ee55d55d34701f549d02e04a372c3", "url": "https://github.com/apache/skywalking/commit/3ce86be6bd9ee55d55d34701f549d02e04a372c3", "message": "Merge remote-tracking branch 'origin/master'", "committedDate": "2020-11-05T13:36:49Z", "type": "commit"}, {"oid": "aa416304e6430fa77ba0f11028125ae7ca485d01", "url": "https://github.com/apache/skywalking/commit/aa416304e6430fa77ba0f11028125ae7ca485d01", "message": "feat#Change to single-line comment", "committedDate": "2020-11-05T13:38:28Z", "type": "commit"}, {"oid": "e114e00e0635f2a6c5f01668d135fdebff41759c", "url": "https://github.com/apache/skywalking/commit/e114e00e0635f2a6c5f01668d135fdebff41759c", "message": "feat#Change to single-line comment", "committedDate": "2020-11-05T13:41:19Z", "type": "commit"}, {"oid": "dbce5f5cce2cd8ed26ce6d662f2bd6d5a0886bc1", "url": "https://github.com/apache/skywalking/commit/dbce5f5cce2cd8ed26ce6d662f2bd6d5a0886bc1", "message": "Merge branch 'master' into master", "committedDate": "2020-11-05T15:13:29Z", "type": "commit"}]}