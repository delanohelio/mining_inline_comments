{"pr_number": 6066, "pr_title": "Improvement Influxdb query performance", "pr_createdAt": "2020-12-23T13:27:12Z", "pr_url": "https://github.com/apache/skywalking/pull/6066", "timeline": [{"oid": "30e3c07faa49dc3e84b9caf81de5dbf5c7e9c87b", "url": "https://github.com/apache/skywalking/commit/30e3c07faa49dc3e84b9caf81de5dbf5c7e9c87b", "message": "Improvement `MetricsDAO#get` performance", "committedDate": "2020-12-23T13:19:05Z", "type": "commit"}, {"oid": "38685726120c8571a6c2327bb37e288b0d397998", "url": "https://github.com/apache/skywalking/commit/38685726120c8571a6c2327bb37e288b0d397998", "message": "replace name to \"name\" in query statement", "committedDate": "2020-12-23T13:21:57Z", "type": "commit"}, {"oid": "ae020c06c8a695442c168555ca54b24e536b3474", "url": "https://github.com/apache/skywalking/commit/ae020c06c8a695442c168555ca54b24e536b3474", "message": "fix *_traffic table don't include time_bucket", "committedDate": "2020-12-23T14:00:36Z", "type": "commit"}, {"oid": "b5c205eb17afe5702607b4c87a2427395354d82e", "url": "https://github.com/apache/skywalking/commit/b5c205eb17afe5702607b4c87a2427395354d82e", "message": "query optimization", "committedDate": "2020-12-24T17:34:49Z", "type": "commit"}, {"oid": "0b62d71fce18a5c9c2f91b47c27ce5ff69cd8f2c", "url": "https://github.com/apache/skywalking/commit/0b62d71fce18a5c9c2f91b47c27ce5ff69cd8f2c", "message": "Merge branch 'master' into influxdb", "committedDate": "2020-12-25T00:33:24Z", "type": "commit"}, {"oid": "fd12547f984dbe0d1b00a96a9cacbce74a3d31f2", "url": "https://github.com/apache/skywalking/commit/fd12547f984dbe0d1b00a96a9cacbce74a3d31f2", "message": "Merge branch 'influxdb' of https://github.com/dmsolr/skywalking into influxdb", "committedDate": "2020-12-25T05:20:18Z", "type": "commit"}, {"oid": "39f8d7d4a4274426725e0bead0617c75f607365d", "url": "https://github.com/apache/skywalking/commit/39f8d7d4a4274426725e0bead0617c75f607365d", "message": "update CHANGES.md", "committedDate": "2020-12-25T05:20:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODgyMzYwNQ==", "url": "https://github.com/apache/skywalking/pull/6066#discussion_r548823605", "bodyText": "Are you sure about this? ES7 client needs recompiling.", "author": "wu-sheng", "createdAt": "2020-12-25T07:32:51Z", "path": "oap-server/server-storage-plugin/storage-elasticsearch7-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/elasticsearch7/dao/MetricsEs7DAO.java", "diffHunk": "@@ -20,30 +20,12 @@\n \n import org.apache.skywalking.oap.server.core.analysis.metrics.Metrics;\n import org.apache.skywalking.oap.server.core.storage.StorageBuilder;\n-import org.apache.skywalking.oap.server.core.storage.model.Model;\n import org.apache.skywalking.oap.server.library.client.elasticsearch.ElasticSearchClient;\n import org.apache.skywalking.oap.server.storage.plugin.elasticsearch.base.MetricsEsDAO;\n-import org.elasticsearch.action.search.SearchResponse;\n-\n-import java.io.IOException;\n-import java.util.ArrayList;\n-import java.util.List;\n \n public class MetricsEs7DAO extends MetricsEsDAO {\n \n     MetricsEs7DAO(final ElasticSearchClient client, final StorageBuilder<Metrics> storageBuilder) {\n         super(client, storageBuilder);\n     }\n-\n-    @Override\n-    public List<Metrics> multiGet(Model model, List<String> ids) throws IOException {\n-        SearchResponse response = getClient().ids(model.getName(), ids.toArray(new String[0]));\n-\n-        List<Metrics> result = new ArrayList<>(response.getHits().getHits().length);\n-        for (int i = 0; i < response.getHits().getHits().length; i++) {\n-            Metrics source = storageBuilder.map2Data(response.getHits().getAt(i).getSourceAsMap());\n-            result.add(source);\n-        }\n-        return result;\n-    }", "originalCommit": "39f8d7d4a4274426725e0bead0617c75f607365d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ea0f3ef6bc198a2285303c92f78698b86843eda1", "chunk": "diff --git a/oap-server/server-storage-plugin/storage-elasticsearch7-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/elasticsearch7/dao/MetricsEs7DAO.java b/oap-server/server-storage-plugin/storage-elasticsearch7-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/elasticsearch7/dao/MetricsEs7DAO.java\nindex 0a46dabd0..1be9e5f6a 100644\n--- a/oap-server/server-storage-plugin/storage-elasticsearch7-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/elasticsearch7/dao/MetricsEs7DAO.java\n+++ b/oap-server/server-storage-plugin/storage-elasticsearch7-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/elasticsearch7/dao/MetricsEs7DAO.java\n\n@@ -18,14 +18,32 @@\n \n package org.apache.skywalking.oap.server.storage.plugin.elasticsearch7.dao;\n \n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.List;\n import org.apache.skywalking.oap.server.core.analysis.metrics.Metrics;\n import org.apache.skywalking.oap.server.core.storage.StorageBuilder;\n+import org.apache.skywalking.oap.server.core.storage.model.Model;\n import org.apache.skywalking.oap.server.library.client.elasticsearch.ElasticSearchClient;\n import org.apache.skywalking.oap.server.storage.plugin.elasticsearch.base.MetricsEsDAO;\n+import org.elasticsearch.action.search.SearchResponse;\n \n public class MetricsEs7DAO extends MetricsEsDAO {\n \n     MetricsEs7DAO(final ElasticSearchClient client, final StorageBuilder<Metrics> storageBuilder) {\n         super(client, storageBuilder);\n     }\n+\n+    @Override\n+    public List<Metrics> multiGet(Model model, List<Metrics> metrics) throws IOException {\n+        String[] ids = metrics.stream().map(Metrics::id).toArray(String[]::new);\n+        SearchResponse response = getClient().ids(model.getName(), ids);\n+\n+        List<Metrics> result = new ArrayList<>(response.getHits().getHits().length);\n+        for (int i = 0; i < response.getHits().getHits().length; i++) {\n+            Metrics source = storageBuilder.map2Data(response.getHits().getAt(i).getSourceAsMap());\n+            result.add(source);\n+        }\n+        return result;\n+    }\n }\n"}}, {"oid": "ea0f3ef6bc198a2285303c92f78698b86843eda1", "url": "https://github.com/apache/skywalking/commit/ea0f3ef6bc198a2285303c92f78698b86843eda1", "message": "fix", "committedDate": "2020-12-25T08:32:34Z", "type": "commit"}, {"oid": "46a5c98e660d17e71e6bb2b1571618fcb11134a1", "url": "https://github.com/apache/skywalking/commit/46a5c98e660d17e71e6bb2b1571618fcb11134a1", "message": "fix", "committedDate": "2020-12-25T13:59:54Z", "type": "commit"}, {"oid": "97d8fbe4e8c817d60ffdf83d45c8b033b1fe3118", "url": "https://github.com/apache/skywalking/commit/97d8fbe4e8c817d60ffdf83d45c8b033b1fe3118", "message": "revert", "committedDate": "2020-12-25T15:23:29Z", "type": "commit"}, {"oid": "94281dbdee992aa39b8accdbb1f513726853937b", "url": "https://github.com/apache/skywalking/commit/94281dbdee992aa39b8accdbb1f513726853937b", "message": "update", "committedDate": "2020-12-25T16:25:14Z", "type": "commit"}, {"oid": "2d646ee98142584d6dcc50f8e3bd146b7f4be6ff", "url": "https://github.com/apache/skywalking/commit/2d646ee98142584d6dcc50f8e3bd146b7f4be6ff", "message": "_name is keyword in influxdb, which means the table name.", "committedDate": "2020-12-25T18:57:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODkzMDQ3Nw==", "url": "https://github.com/apache/skywalking/pull/6066#discussion_r548930477", "bodyText": "Don't format the unchanged codes", "author": "wu-sheng", "createdAt": "2020-12-26T01:40:17Z", "path": "oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/analysis/worker/MetricsPersistentWorker.java", "diffHunk": "@@ -91,11 +92,12 @@\n         this.dataCarrier.consume(ConsumerPoolFactory.INSTANCE.get(name), new PersistentConsumer());\n \n         MetricsCreator metricsCreator = moduleDefineHolder.find(TelemetryModule.NAME)\n-                .provider()\n-                .getService(MetricsCreator.class);\n+                                                          .provider()\n+                                                          .getService(MetricsCreator.class);\n         aggregationCounter = metricsCreator.createCounter(\n-                \"metrics_aggregation\", \"The number of rows in aggregation\",\n-                new MetricsTag.Keys(\"metricName\", \"level\", \"dimensionality\"), new MetricsTag.Values(model.getName(), \"2\", model.getDownsampling().getName())\n+            \"metrics_aggregation\", \"The number of rows in aggregation\",\n+            new MetricsTag.Keys(\"metricName\", \"level\", \"dimensionality\"),\n+            new MetricsTag.Values(model.getName(), \"2\", model.getDownsampling().getName())", "originalCommit": "2d646ee98142584d6dcc50f8e3bd146b7f4be6ff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODk2MzEwNw==", "url": "https://github.com/apache/skywalking/pull/6066#discussion_r548963107", "bodyText": "This is still changed.", "author": "wu-sheng", "createdAt": "2020-12-26T09:20:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODkzMDQ3Nw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODkzMDU1NQ==", "url": "https://github.com/apache/skywalking/pull/6066#discussion_r548930555", "bodyText": "final Stream<Metrics> metricsStream = metrics.stream().filter(m -> !context.containsKey(m));\nI think this stream is better choice for metricsDAO#multiGet, WDYT?", "author": "wu-sheng", "createdAt": "2020-12-26T01:41:58Z", "path": "oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/analysis/worker/MetricsPersistentWorker.java", "diffHunk": "@@ -209,15 +211,11 @@ private void loadFromStorage(List<Metrics> metrics) throws IOException {\n             context.clear();\n         }\n \n-        List<String> notInCacheIds = new ArrayList<>();\n-        for (Metrics metric : metrics) {\n-            if (!context.containsKey(metric)) {\n-                notInCacheIds.add(metric.id());\n-            }\n-        }\n-\n-        if (notInCacheIds.size() > 0) {\n-            List<Metrics> metricsList = metricsDAO.multiGet(model, notInCacheIds);\n+        List<Metrics> notInCacheMetrics = metrics.stream()\n+                                                 .filter(m -> !context.containsKey(m))\n+                                                 .collect(Collectors.toList());", "originalCommit": "2d646ee98142584d6dcc50f8e3bd146b7f4be6ff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODkzMDU3NQ==", "url": "https://github.com/apache/skywalking/pull/6066#discussion_r548930575", "bodyText": "This could avoid duplicated for loop before and inside metricsDAO#multiGet", "author": "wu-sheng", "createdAt": "2020-12-26T01:42:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODkzMDU1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODk2MjI3Ng==", "url": "https://github.com/apache/skywalking/pull/6066#discussion_r548962276", "bodyText": "Passing the stream as an argument is very dangerous. Because stream can be consumed only one time.", "author": "dmsolr", "createdAt": "2020-12-26T09:09:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODkzMDU1NQ=="}], "type": "inlineReview", "revised_code": {"commit": "3057925149d1996995f41b3fb86951a481db3579", "chunk": "diff --git a/oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/analysis/worker/MetricsPersistentWorker.java b/oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/analysis/worker/MetricsPersistentWorker.java\nindex f255d62ec..4d612fede 100644\n--- a/oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/analysis/worker/MetricsPersistentWorker.java\n+++ b/oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/analysis/worker/MetricsPersistentWorker.java\n\n@@ -211,15 +211,8 @@ public class MetricsPersistentWorker extends PersistenceWorker<Metrics> {\n             context.clear();\n         }\n \n-        List<Metrics> notInCacheMetrics = metrics.stream()\n-                                                 .filter(m -> !context.containsKey(m))\n-                                                 .collect(Collectors.toList());\n-        if (notInCacheMetrics.size() > 0) {\n-            List<Metrics> metricsList = metricsDAO.multiGet(model, notInCacheMetrics);\n-            for (Metrics metric : metricsList) {\n-                context.put(metric, metric);\n-            }\n-        }\n+        Stream<Metrics> stream = metrics.stream().filter(m -> !context.containsKey(m));\n+        metricsDAO.multiGet(model, stream).forEach(m -> context.put(m, m));\n     }\n \n     @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODkzNTI5NQ==", "url": "https://github.com/apache/skywalking/pull/6066#discussion_r548935295", "bodyText": "You added a Traffic interface, I thinks this part should be refactored by leveraging that interface?", "author": "kezhenxu94", "createdAt": "2020-12-26T02:54:33Z", "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/TableMetaInfo.java", "diffHunk": "@@ -54,7 +56,10 @@ public static void addModel(Model model) {\n             storageAndColumnMap.put(columnName.getStorageName(), columnName.getName());\n         });\n \n+        final boolean isTrafficTable;\n         if (model.getName().endsWith(\"_traffic\")) {\n+            isTrafficTable = true;\n+", "originalCommit": "2d646ee98142584d6dcc50f8e3bd146b7f4be6ff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODkzNjUzNA==", "url": "https://github.com/apache/skywalking/pull/6066#discussion_r548936534", "bodyText": "For now, there is no chance to declare this. Model is not related to this. From the design perspective, there is no concept called metadata anymore.\nRight now, there are several places in influxdb storage option having this kind of name based mechanism, sadly.", "author": "wu-sheng", "createdAt": "2020-12-26T03:13:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODkzNTI5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODkzOTI5OQ==", "url": "https://github.com/apache/skywalking/pull/6066#discussion_r548939299", "bodyText": "You added a Traffic interface, I thinks this part should be refactored by leveraging that interface?\n\nFor now, there is no chance to declare this. Model is not related to this. From the design perspective, there is no concept called metadata anymore.\nRight now, there are several places in influxdb storage option having this kind of name based mechanism, sadly.\n\n\n\n  \n    \n      skywalking/oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/base/MetricsDAO.java\n    \n    \n        Lines 66 to 68\n      in\n      2d646ee\n    \n    \n    \n    \n\n        \n          \n           if (metaInfo.isTrafficTable()) { \n        \n\n        \n          \n               queryStr = metrics.stream() \n        \n\n        \n          \n                                 .map(m -> (Traffic) m) \n        \n    \n  \n\n\nIf so, this part looks very strange, it casts the metrics as Traffic with a condition isTrafficTable(), seems to be fragile and error prone because isTrafficTable() has no guarantee that the metrics can be casted as Traffic.", "author": "kezhenxu94", "createdAt": "2020-12-26T03:54:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODkzNTI5NQ=="}], "type": "inlineReview", "revised_code": {"commit": "53cb1d981916687657f8f5781b260eab987cfb7f", "chunk": "diff --git a/oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/TableMetaInfo.java b/oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/TableMetaInfo.java\nindex 8364aa190..698ac9705 100644\n--- a/oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/TableMetaInfo.java\n+++ b/oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/TableMetaInfo.java\n\n@@ -56,10 +54,7 @@ public class TableMetaInfo {\n             storageAndColumnMap.put(columnName.getStorageName(), columnName.getName());\n         });\n \n-        final boolean isTrafficTable;\n         if (model.getName().endsWith(\"_traffic\")) {\n-            isTrafficTable = true;\n-\n             // instance_traffic name, service_id\n             // endpoint_traffic name, service_id\n             storageAndTagMap.put(InstanceTraffic.NAME, InfluxConstants.TagName.NAME);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODkzNzU1NA==", "url": "https://github.com/apache/skywalking/pull/6066#discussion_r548937554", "bodyText": "We have StorageData#id already.", "author": "wu-sheng", "createdAt": "2020-12-26T03:28:08Z", "path": "oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/analysis/Traffic.java", "diffHunk": "@@ -0,0 +1,27 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.core.analysis;\n+\n+public interface Traffic {\n+\n+    String id();", "originalCommit": "2d646ee98142584d6dcc50f8e3bd146b7f4be6ff", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "28c6145f06d3e7a791bc339195052ae022f5033e", "chunk": "diff --git a/oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/analysis/Traffic.java b/oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/analysis/Traffic.java\nindex 42b4a39ed8..82640da75d 100644\n--- a/oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/analysis/Traffic.java\n+++ b/oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/analysis/Traffic.java\n\n@@ -20,8 +20,6 @@ package org.apache.skywalking.oap.server.core.analysis;\n \n public interface Traffic {\n \n-    String id();\n-\n     String getName();\n \n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODkzNzY2OA==", "url": "https://github.com/apache/skywalking/pull/6066#discussion_r548937668", "bodyText": "Model has the getName. I can't see the point of Traffic interface.", "author": "wu-sheng", "createdAt": "2020-12-26T03:29:39Z", "path": "oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/analysis/Traffic.java", "diffHunk": "@@ -0,0 +1,27 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.core.analysis;\n+\n+public interface Traffic {\n+\n+    String id();\n+\n+    String getName();", "originalCommit": "2d646ee98142584d6dcc50f8e3bd146b7f4be6ff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODk1MDU4MQ==", "url": "https://github.com/apache/skywalking/pull/6066#discussion_r548950581", "bodyText": "In Model, getName represents the model name, not a field of model.", "author": "dmsolr", "createdAt": "2020-12-26T06:35:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODkzNzY2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODk2MzYyMw==", "url": "https://github.com/apache/skywalking/pull/6066#discussion_r548963623", "bodyText": "See my latest comment, still have concern about this.", "author": "wu-sheng", "createdAt": "2020-12-26T09:27:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODkzNzY2OA=="}], "type": "inlineReview", "revised_code": {"commit": "28c6145f06d3e7a791bc339195052ae022f5033e", "chunk": "diff --git a/oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/analysis/Traffic.java b/oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/analysis/Traffic.java\nindex 42b4a39ed8..82640da75d 100644\n--- a/oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/analysis/Traffic.java\n+++ b/oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/analysis/Traffic.java\n\n@@ -20,8 +20,6 @@ package org.apache.skywalking.oap.server.core.analysis;\n \n public interface Traffic {\n \n-    String id();\n-\n     String getName();\n \n }\n"}}, {"oid": "3057925149d1996995f41b3fb86951a481db3579", "url": "https://github.com/apache/skywalking/commit/3057925149d1996995f41b3fb86951a481db3579", "message": "adjust IMetricsDAO#multiGet signature", "committedDate": "2020-12-26T04:17:29Z", "type": "commit"}, {"oid": "53cb1d981916687657f8f5781b260eab987cfb7f", "url": "https://github.com/apache/skywalking/commit/53cb1d981916687657f8f5781b260eab987cfb7f", "message": "fix", "committedDate": "2020-12-26T05:08:07Z", "type": "commit"}, {"oid": "28c6145f06d3e7a791bc339195052ae022f5033e", "url": "https://github.com/apache/skywalking/commit/28c6145f06d3e7a791bc339195052ae022f5033e", "message": "fix following reviewers", "committedDate": "2020-12-26T06:36:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODk2MzIyOA==", "url": "https://github.com/apache/skywalking/pull/6066#discussion_r548963228", "bodyText": "I have a feeling, stream#count === a whole loop. Could you confirm?", "author": "wu-sheng", "createdAt": "2020-12-26T09:23:02Z", "path": "oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/analysis/worker/MetricsPersistentWorker.java", "diffHunk": "@@ -209,18 +211,9 @@ private void loadFromStorage(List<Metrics> metrics) throws IOException {\n             context.clear();\n         }\n \n-        List<String> notInCacheIds = new ArrayList<>();\n-        for (Metrics metric : metrics) {\n-            if (!context.containsKey(metric)) {\n-                notInCacheIds.add(metric.id());\n-            }\n-        }\n-\n-        if (notInCacheIds.size() > 0) {\n-            List<Metrics> metricsList = metricsDAO.multiGet(model, notInCacheIds);\n-            for (Metrics metric : metricsList) {\n-                context.put(metric, metric);\n-            }\n+        Stream<Metrics> stream = metrics.stream().filter(m -> !context.containsKey(m));\n+        if (stream.count() > 0) {", "originalCommit": "28c6145f06d3e7a791bc339195052ae022f5033e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "42ce9dda96d4472575946479bdb92fb91780c9fe", "chunk": "diff --git a/oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/analysis/worker/MetricsPersistentWorker.java b/oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/analysis/worker/MetricsPersistentWorker.java\nindex 6d9d0cfd9..5e483c401 100644\n--- a/oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/analysis/worker/MetricsPersistentWorker.java\n+++ b/oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/analysis/worker/MetricsPersistentWorker.java\n\n@@ -211,9 +211,11 @@ public class MetricsPersistentWorker extends PersistenceWorker<Metrics> {\n             context.clear();\n         }\n \n-        Stream<Metrics> stream = metrics.stream().filter(m -> !context.containsKey(m));\n-        if (stream.count() > 0) {\n-            metricsDAO.multiGet(model, stream).forEach(m -> context.put(m, m));\n+        List<Metrics> noInCacheMetrics = metrics.stream()\n+                                                .filter(m -> !context.containsKey(m))\n+                                                .collect(Collectors.toList());\n+        if (!noInCacheMetrics.isEmpty()) {\n+            metricsDAO.multiGet(model, noInCacheMetrics).forEach(m -> context.put(m, m));\n         }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODk2MzUxMA==", "url": "https://github.com/apache/skywalking/pull/6066#discussion_r548963510", "bodyText": "If you says this implementing Traffic#name, the name is exactly the id(as nodeType related to name logically). What is the point of doing this?", "author": "wu-sheng", "createdAt": "2020-12-26T09:26:10Z", "path": "oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/analysis/manual/endpoint/EndpointTraffic.java", "diffHunk": "@@ -39,7 +40,7 @@\n     builder = EndpointTraffic.Builder.class, processor = MetricsStreamProcessor.class)\n @MetricsExtension(supportDownSampling = false, supportUpdate = false)\n @EqualsAndHashCode\n-public class EndpointTraffic extends Metrics {\n+public class EndpointTraffic extends Metrics implements Traffic {", "originalCommit": "28c6145f06d3e7a791bc339195052ae022f5033e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTIwNDUzOQ==", "url": "https://github.com/apache/skywalking/pull/6066#discussion_r549204539", "bodyText": "After discussion, let's use @Metadata to separate this from real metrics.", "author": "wu-sheng", "createdAt": "2020-12-28T03:45:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODk2MzUxMA=="}], "type": "inlineReview", "revised_code": {"commit": "65e1a78293a3a49b73cc8220c66a9eac7ef77943", "chunk": "diff --git a/oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/analysis/manual/endpoint/EndpointTraffic.java b/oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/analysis/manual/endpoint/EndpointTraffic.java\nindex cd7983f1e..ab41ff43e 100644\n--- a/oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/analysis/manual/endpoint/EndpointTraffic.java\n+++ b/oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/analysis/manual/endpoint/EndpointTraffic.java\n\n@@ -40,7 +39,7 @@ import org.apache.skywalking.oap.server.core.storage.annotation.Column;\n     builder = EndpointTraffic.Builder.class, processor = MetricsStreamProcessor.class)\n @MetricsExtension(supportDownSampling = false, supportUpdate = false)\n @EqualsAndHashCode\n-public class EndpointTraffic extends Metrics implements Traffic {\n+public class EndpointTraffic extends Metrics {\n \n     public static final String INDEX_NAME = \"endpoint_traffic\";\n \n"}}, {"oid": "42ce9dda96d4472575946479bdb92fb91780c9fe", "url": "https://github.com/apache/skywalking/commit/42ce9dda96d4472575946479bdb92fb91780c9fe", "message": "fix", "committedDate": "2020-12-26T09:47:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODk3NjY1Ng==", "url": "https://github.com/apache/skywalking/pull/6066#discussion_r548976656", "bodyText": "Look like the codes back to double loops?", "author": "wu-sheng", "createdAt": "2020-12-26T12:10:27Z", "path": "oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/analysis/worker/MetricsPersistentWorker.java", "diffHunk": "@@ -209,18 +211,11 @@ private void loadFromStorage(List<Metrics> metrics) throws IOException {\n             context.clear();\n         }\n \n-        List<String> notInCacheIds = new ArrayList<>();\n-        for (Metrics metric : metrics) {\n-            if (!context.containsKey(metric)) {\n-                notInCacheIds.add(metric.id());\n-            }\n-        }\n-\n-        if (notInCacheIds.size() > 0) {\n-            List<Metrics> metricsList = metricsDAO.multiGet(model, notInCacheIds);\n-            for (Metrics metric : metricsList) {\n-                context.put(metric, metric);\n-            }\n+        List<Metrics> noInCacheMetrics = metrics.stream()\n+                                                .filter(m -> !context.containsKey(m))\n+                                                .collect(Collectors.toList());\n+        if (!noInCacheMetrics.isEmpty()) {\n+            metricsDAO.multiGet(model, noInCacheMetrics).forEach(m -> context.put(m, m));", "originalCommit": "42ce9dda96d4472575946479bdb92fb91780c9fe", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "65e1a78293a3a49b73cc8220c66a9eac7ef77943", "url": "https://github.com/apache/skywalking/commit/65e1a78293a3a49b73cc8220c66a9eac7ef77943", "message": "refactor", "committedDate": "2020-12-28T11:56:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTM1MDYxOA==", "url": "https://github.com/apache/skywalking/pull/6066#discussion_r549350618", "bodyText": "Don't like this, but seems don't have much better idea. Adding an interface seems not vey helpful. cc @kezhenxu94", "author": "wu-sheng", "createdAt": "2020-12-28T13:36:48Z", "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/base/MetricsDAO.java", "diffHunk": "@@ -57,11 +62,47 @@ public MetricsDAO(InfluxClient client, StorageBuilder<Metrics> storageBuilder) {\n     }\n \n     @Override\n-    public List<Metrics> multiGet(Model model, List<String> ids) throws IOException {\n-        final WhereQueryImpl<SelectQueryImpl> query = select()\n-            .raw(ALL_FIELDS)\n-            .from(client.getDatabase(), model.getName())\n-            .where(contains(\"id\", Joiner.on(\"|\").join(ids)));\n+    public List<Metrics> multiGet(Model model, List<Metrics> metrics) throws IOException {\n+        final TableMetaInfo metaInfo = TableMetaInfo.get(model.getName());\n+        final String queryStr;\n+        if (model.getName().endsWith(\"_traffic\")) {", "originalCommit": "65e1a78293a3a49b73cc8220c66a9eac7ef77943", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "78869515edfa89e11791ca80ea2335ef0bf47d15", "chunk": "diff --git a/oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/base/MetricsDAO.java b/oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/base/MetricsDAO.java\nindex e55a04419..9aa22601b 100644\n--- a/oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/base/MetricsDAO.java\n+++ b/oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/base/MetricsDAO.java\n\n@@ -66,27 +68,26 @@ public class MetricsDAO implements IMetricsDAO {\n         final TableMetaInfo metaInfo = TableMetaInfo.get(model.getName());\n         final String queryStr;\n         if (model.getName().endsWith(\"_traffic\")) {\n-            final Function<Metrics, String> tag;\n+            final Function<Metrics, Clause> clauseFunction;\n             switch (model.getName()) {\n                 case EndpointTraffic.INDEX_NAME: {\n-                    tag = m -> String.valueOf(((EndpointTraffic) m).getServiceId());\n+                    clauseFunction = m -> eq(TagName.SERVICE_ID, String.valueOf(((EndpointTraffic) m).getServiceId()));\n                     break;\n                 }\n                 case ServiceTraffic.INDEX_NAME: {\n-                    tag = m -> ((ServiceTraffic) m).getName();\n+                    clauseFunction = m -> eq(TagName.NAME, ((ServiceTraffic) m).getName());\n                     break;\n                 }\n                 case InstanceTraffic.INDEX_NAME: {\n-                    tag = m -> String.valueOf(((InstanceTraffic) m).getServiceId());\n+                    clauseFunction = m -> eq(TagName.SERVICE_ID, String.valueOf(((InstanceTraffic) m).getServiceId()));\n                     break;\n                 }\n                 default:\n-                    throw new IOException();\n+                    throw new IOException(\"Unknown metadata type, \" + model.getName());\n             }\n             queryStr = metrics.stream().map(m -> select().raw(ALL_FIELDS)\n                                                          .from(client.getDatabase(), model.getName())\n-                                                         .where(\n-                                                             eq(InfluxConstants.TagName.NAME, tag.apply(m)))\n+                                                         .where(clauseFunction.apply(m))\n                                                          .and(eq(ID_COLUMN, m.id()))\n                                                          .buildQueryString()\n             ).collect(Collectors.joining(\";\"));\n"}}, {"oid": "809cbaff4674a1266e66214a492db79bbf10499d", "url": "https://github.com/apache/skywalking/commit/809cbaff4674a1266e66214a492db79bbf10499d", "message": "Merge branch 'master' into influxdb", "committedDate": "2020-12-28T13:38:08Z", "type": "commit"}, {"oid": "78869515edfa89e11791ca80ea2335ef0bf47d15", "url": "https://github.com/apache/skywalking/commit/78869515edfa89e11791ca80ea2335ef0bf47d15", "message": "fix", "committedDate": "2020-12-29T02:34:52Z", "type": "commit"}, {"oid": "2bba9f3463f6a26f2be3893181b2e369a903a430", "url": "https://github.com/apache/skywalking/commit/2bba9f3463f6a26f2be3893181b2e369a903a430", "message": "Merge branch 'influxdb' of https://github.com/dmsolr/skywalking into influxdb", "committedDate": "2020-12-29T03:10:40Z", "type": "commit"}, {"oid": "1def2ad7b84e614264eaf7832dde2690b64c0e83", "url": "https://github.com/apache/skywalking/commit/1def2ad7b84e614264eaf7832dde2690b64c0e83", "message": "fix", "committedDate": "2020-12-29T06:16:28Z", "type": "commit"}, {"oid": "01959c30dd9722328f00e72dc8234123062f341e", "url": "https://github.com/apache/skywalking/commit/01959c30dd9722328f00e72dc8234123062f341e", "message": "Merge branch 'master' into influxdb", "committedDate": "2020-12-30T01:57:46Z", "type": "commit"}, {"oid": "1411fd598f7f340bb41cec65dff7a570ff23f4e4", "url": "https://github.com/apache/skywalking/commit/1411fd598f7f340bb41cec65dff7a570ff23f4e4", "message": "test", "committedDate": "2020-12-30T02:23:47Z", "type": "commit"}, {"oid": "7547d316b85ebe243733d41a663a96ad458a49b3", "url": "https://github.com/apache/skywalking/commit/7547d316b85ebe243733d41a663a96ad458a49b3", "message": "Merge branch 'influxdb' of https://github.com/dmsolr/skywalking into influxdb", "committedDate": "2020-12-30T02:23:59Z", "type": "commit"}, {"oid": "e5e16104788908ae9a41c18c1996be4b6f99723b", "url": "https://github.com/apache/skywalking/commit/e5e16104788908ae9a41c18c1996be4b6f99723b", "message": "test", "committedDate": "2020-12-30T03:20:29Z", "type": "commit"}, {"oid": "a03d225910f5826cda110b73e592ecbfb6275608", "url": "https://github.com/apache/skywalking/commit/a03d225910f5826cda110b73e592ecbfb6275608", "message": "test", "committedDate": "2020-12-30T06:19:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTk0ODU3Ng==", "url": "https://github.com/apache/skywalking/pull/6066#discussion_r549948576", "bodyText": "InstanceTraffic#Name is a big data set, are you sure you need this as a tag?", "author": "wu-sheng", "createdAt": "2020-12-30T06:25:18Z", "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/TableMetaInfo.java", "diffHunk": "@@ -54,15 +54,25 @@ public static void addModel(Model model) {\n             storageAndColumnMap.put(columnName.getStorageName(), columnName.getName());\n         });\n \n+        storageAndTagMap.put(InstanceTraffic.NAME, InfluxConstants.TagName.NAME);\n         if (model.getName().endsWith(\"_traffic\")) {\n-            // instance_traffic service_id, endpoint_traffic service_id\n-            if (InstanceTraffic.INDEX_NAME.equals(model.getName())\n-                || EndpointTraffic.INDEX_NAME.equals(model.getName())) {\n-                storageAndTagMap.put(EndpointTraffic.SERVICE_ID, InfluxConstants.TagName.SERVICE_ID);\n-            } else {\n+            switch (model.getName()) {\n+                // instance_traffic name, service_id\n+                case InstanceTraffic.INDEX_NAME: {\n+                    storageAndTagMap.put(InstanceTraffic.NAME, InfluxConstants.TagName.NAME);", "originalCommit": "a03d225910f5826cda110b73e592ecbfb6275608", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDA5MDk2OA==", "url": "https://github.com/apache/skywalking/pull/6066#discussion_r550090968", "bodyText": "MetadataQuery#getServiceInstances dependent on NAME to avoid duplication records.", "author": "dmsolr", "createdAt": "2020-12-30T09:46:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTk0ODU3Ng=="}], "type": "inlineReview", "revised_code": null}, {"oid": "ce3b14967d6c3caf34ff7dbe17209ccda06e7e43", "url": "https://github.com/apache/skywalking/commit/ce3b14967d6c3caf34ff7dbe17209ccda06e7e43", "message": "Merge branch 'master' into influxdb", "committedDate": "2020-12-30T07:24:38Z", "type": "commit"}]}