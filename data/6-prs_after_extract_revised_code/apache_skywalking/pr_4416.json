{"pr_number": 4416, "pr_title": "Provide profile exporter tool", "pr_createdAt": "2020-02-25T09:43:19Z", "pr_url": "https://github.com/apache/skywalking/pull/4416", "timeline": [{"oid": "d2330550ae73d767203e83f79737b5b4f6fffff3", "url": "https://github.com/apache/skywalking/commit/d2330550ae73d767203e83f79737b5b4f6fffff3", "message": "provide profile export tools", "committedDate": "2020-02-24T13:25:05Z", "type": "commit"}, {"oid": "7b0f0fa9c4a3392df00d637a8c9a3163e9043d2e", "url": "https://github.com/apache/skywalking/commit/7b0f0fa9c4a3392df00d637a8c9a3163e9043d2e", "message": "Merge remote-tracking branch 'remotes/upstream/master' into profile_exporter", "committedDate": "2020-02-25T03:58:31Z", "type": "commit"}, {"oid": "95cf9c2f570cc725aa329ffa4d30b2f6334b78c4", "url": "https://github.com/apache/skywalking/commit/95cf9c2f570cc725aa329ffa4d30b2f6334b78c4", "message": "add rand word on create h2 db file", "committedDate": "2020-02-25T05:32:42Z", "type": "commit"}, {"oid": "c001a9fd115db8050183d3014b03cd2afcf625b5", "url": "https://github.com/apache/skywalking/commit/c001a9fd115db8050183d3014b03cd2afcf625b5", "message": "add parsing code", "committedDate": "2020-02-25T08:24:11Z", "type": "commit"}, {"oid": "7a7850b2b35705788bfe2cfd90337eb6799d39eb", "url": "https://github.com/apache/skywalking/commit/7a7850b2b35705788bfe2cfd90337eb6799d39eb", "message": "rename docker file mapping base path", "committedDate": "2020-02-25T09:38:33Z", "type": "commit"}, {"oid": "4660678dfaa5c7df691add9868a938df1b891b52", "url": "https://github.com/apache/skywalking/commit/4660678dfaa5c7df691add9868a938df1b891b52", "message": "add none file block param on h2 storage", "committedDate": "2020-02-25T11:17:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDMzMjcwMQ==", "url": "https://github.com/apache/skywalking/pull/4416#discussion_r384332701", "bodyText": "what's \"replace recheck\"?", "author": "kezhenxu94", "createdAt": "2020-02-26T08:22:11Z", "path": "oap-server/server-tools/tool-profile-snapshot-bootstrap/src/main/java/org/apache/skywalking/oap/server/tool/profile/exporter/ExporterConfig.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.tool.profile.exporter;\n+\n+import lombok.Data;\n+\n+import java.io.File;\n+\n+@Data\n+public class ExporterConfig {\n+\n+    // profile task id\n+    private String taskId;\n+\n+    // profiled trace id\n+    private String traceId;\n+\n+    // export to file path\n+    private String analyzeResultDist;\n+\n+    /**\n+     * parse config from command line\n+     */\n+    public static ExporterConfig parse(String[] args) {\n+        if (args == null || args.length != 3) {\n+            throw new IllegalArgumentException(\"missing config, replace recheck\");", "originalCommit": "4660678dfaa5c7df691add9868a938df1b891b52", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA0NzU4NQ==", "url": "https://github.com/apache/skywalking/pull/4416#discussion_r385047585", "bodyText": "I mean \"please recheck\", has fixed.", "author": "mrproliu", "createdAt": "2020-02-27T10:44:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDMzMjcwMQ=="}], "type": "inlineReview", "revised_code": {"commit": "3ebdc4b6b44856e818cad412e51a39fc768586eb", "chunk": "diff --git a/oap-server/server-tools/tool-profile-snapshot-bootstrap/src/main/java/org/apache/skywalking/oap/server/tool/profile/exporter/ExporterConfig.java b/oap-server/server-tools/tool-profile-snapshot-bootstrap/src/main/java/org/apache/skywalking/oap/server/tool/profile/exporter/ExporterConfig.java\nindex 4640bb71c..2548268f6 100644\n--- a/oap-server/server-tools/tool-profile-snapshot-bootstrap/src/main/java/org/apache/skywalking/oap/server/tool/profile/exporter/ExporterConfig.java\n+++ b/oap-server/server-tools/tool-profile-snapshot-bootstrap/src/main/java/org/apache/skywalking/oap/server/tool/profile/exporter/ExporterConfig.java\n\n@@ -39,7 +39,7 @@ public class ExporterConfig {\n      */\n     public static ExporterConfig parse(String[] args) {\n         if (args == null || args.length != 3) {\n-            throw new IllegalArgumentException(\"missing config, replace recheck\");\n+            throw new IllegalArgumentException(\"missing config, please recheck\");\n         }\n \n         // build config\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDMzMjg5MA==", "url": "https://github.com/apache/skywalking/pull/4416#discussion_r384332890", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        throw new IllegalArgumentException(analyzeResultDist + \" must a directory\");\n          \n          \n            \n                        throw new IllegalArgumentException(analyzeResultDist + \" must be a directory\");", "author": "kezhenxu94", "createdAt": "2020-02-26T08:22:42Z", "path": "oap-server/server-tools/tool-profile-snapshot-bootstrap/src/main/java/org/apache/skywalking/oap/server/tool/profile/exporter/ExporterConfig.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.tool.profile.exporter;\n+\n+import lombok.Data;\n+\n+import java.io.File;\n+\n+@Data\n+public class ExporterConfig {\n+\n+    // profile task id\n+    private String taskId;\n+\n+    // profiled trace id\n+    private String traceId;\n+\n+    // export to file path\n+    private String analyzeResultDist;\n+\n+    /**\n+     * parse config from command line\n+     */\n+    public static ExporterConfig parse(String[] args) {\n+        if (args == null || args.length != 3) {\n+            throw new IllegalArgumentException(\"missing config, replace recheck\");\n+        }\n+\n+        // build config\n+        ExporterConfig config = new ExporterConfig();\n+        config.setTaskId(args[0]);\n+        config.setTraceId(args[1]);\n+        config.setAnalyzeResultDist(args[2]);\n+\n+        return config;\n+    }\n+\n+    /**\n+     * initialize config, such as check dist path\n+     */\n+    public void init() {\n+        File dist = new File(analyzeResultDist);\n+        if (!dist.exists()) {\n+            dist.mkdirs();\n+            return;\n+        }\n+\n+        if (dist.isFile()) {\n+            throw new IllegalArgumentException(analyzeResultDist + \" must a directory\");", "originalCommit": "4660678dfaa5c7df691add9868a938df1b891b52", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3ebdc4b6b44856e818cad412e51a39fc768586eb", "chunk": "diff --git a/oap-server/server-tools/tool-profile-snapshot-bootstrap/src/main/java/org/apache/skywalking/oap/server/tool/profile/exporter/ExporterConfig.java b/oap-server/server-tools/tool-profile-snapshot-bootstrap/src/main/java/org/apache/skywalking/oap/server/tool/profile/exporter/ExporterConfig.java\nindex 4640bb71c..2548268f6 100644\n--- a/oap-server/server-tools/tool-profile-snapshot-bootstrap/src/main/java/org/apache/skywalking/oap/server/tool/profile/exporter/ExporterConfig.java\n+++ b/oap-server/server-tools/tool-profile-snapshot-bootstrap/src/main/java/org/apache/skywalking/oap/server/tool/profile/exporter/ExporterConfig.java\n\n@@ -39,7 +39,7 @@ public class ExporterConfig {\n      */\n     public static ExporterConfig parse(String[] args) {\n         if (args == null || args.length != 3) {\n-            throw new IllegalArgumentException(\"missing config, replace recheck\");\n+            throw new IllegalArgumentException(\"missing config, please recheck\");\n         }\n \n         // build config\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDM1MDM5NQ==", "url": "https://github.com/apache/skywalking/pull/4416#discussion_r384350395", "bodyText": "Is this a test? if not, seems not suitable to put it here", "author": "kezhenxu94", "createdAt": "2020-02-26T08:58:47Z", "path": "oap-server/server-tools/tool-profile-snapshot-bootstrap/src/test/java/org/apache/skywalking/oap/server/tool/profile/exporter/ProfileExportedAnalyze.java", "diffHunk": "@@ -0,0 +1,49 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.tool.profile.exporter;\n+\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.skywalking.apm.network.language.profile.ThreadSnapshot;\n+import org.apache.skywalking.oap.server.core.query.entity.Span;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+\n+@Slf4j\n+public class ProfileExportedAnalyze {\n+\n+    public static void main(String[] args) throws IOException {", "originalCommit": "4660678dfaa5c7df691add9868a938df1b891b52", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQ0MzcxNA==", "url": "https://github.com/apache/skywalking/pull/4416#discussion_r384443714", "bodyText": "I will be working on analyze exported data files when getting some profile future feedback. If it not necessary, I will delete this file.", "author": "mrproliu", "createdAt": "2020-02-26T11:49:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDM1MDM5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQ1MTUyMA==", "url": "https://github.com/apache/skywalking/pull/4416#discussion_r384451520", "bodyText": "I will be working on analyze exported data files when getting some profile future feedback. If it not necessary, I will delete this file.\n\nWell, if this PR is still under construction, please use Draft a Pull Request, or add [WIP] in the title", "author": "kezhenxu94", "createdAt": "2020-02-26T12:07:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDM1MDM5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQ1ODU2MA==", "url": "https://github.com/apache/skywalking/pull/4416#discussion_r384458560", "bodyText": "I will be working on analyze exported data files when getting some profile future feedback. If it not necessary, I will delete this file.\n\nWell, if this PR is still under construction, please use Draft a Pull Request, or add [WIP] in the title\n\nSure. But this file is not in \"WIP\", maybe I need to delete it later.", "author": "mrproliu", "createdAt": "2020-02-26T12:23:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDM1MDM5NQ=="}], "type": "inlineReview", "revised_code": {"commit": "17ef6d8b29dbb7e73885b67f33d3dd944fe6a9e7", "chunk": "diff --git a/oap-server/server-tools/tool-profile-snapshot-bootstrap/src/test/java/org/apache/skywalking/oap/server/tool/profile/exporter/ProfileExportedAnalyze.java b/oap-server/server-tools/tool-profile-snapshot-bootstrap/src/test/java/org/apache/skywalking/oap/server/tool/profile/exporter/ProfileExportedAnalyze.java\nindex a654e6276..2d9fa09c8 100644\n--- a/oap-server/server-tools/tool-profile-snapshot-bootstrap/src/test/java/org/apache/skywalking/oap/server/tool/profile/exporter/ProfileExportedAnalyze.java\n+++ b/oap-server/server-tools/tool-profile-snapshot-bootstrap/src/test/java/org/apache/skywalking/oap/server/tool/profile/exporter/ProfileExportedAnalyze.java\n\n@@ -20,10 +20,21 @@ package org.apache.skywalking.oap.server.tool.profile.exporter;\n \n import lombok.extern.slf4j.Slf4j;\n import org.apache.skywalking.apm.network.language.profile.ThreadSnapshot;\n+import org.apache.skywalking.oap.server.core.CoreModuleConfig;\n+import org.apache.skywalking.oap.server.core.profile.analyze.ProfileAnalyzer;\n+import org.apache.skywalking.oap.server.core.query.entity.ProfileAnalyzation;\n+import org.apache.skywalking.oap.server.core.query.entity.ProfileAnalyzeTimeRange;\n+import org.apache.skywalking.oap.server.core.query.entity.ProfileStackElement;\n+import org.apache.skywalking.oap.server.core.query.entity.ProfileStackTree;\n import org.apache.skywalking.oap.server.core.query.entity.Span;\n+import org.apache.skywalking.oap.server.core.storage.profile.IProfileThreadSnapshotQueryDAO;\n+import org.apache.skywalking.oap.server.library.util.CollectionUtils;\n \n import java.io.File;\n import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.Comparator;\n import java.util.List;\n import java.util.Objects;\n import java.util.stream.Collectors;\n"}}, {"oid": "0a0d418afd2a46cbd964fad56ee6454840e4b760", "url": "https://github.com/apache/skywalking/commit/0a0d418afd2a46cbd964fad56ee6454840e4b760", "message": "Merge branch 'master' into profile_exporter", "committedDate": "2020-02-27T10:35:26Z", "type": "commit"}, {"oid": "3ebdc4b6b44856e818cad412e51a39fc768586eb", "url": "https://github.com/apache/skywalking/commit/3ebdc4b6b44856e818cad412e51a39fc768586eb", "message": "fix naming issues", "committedDate": "2020-02-27T10:42:36Z", "type": "commit"}, {"oid": "c3c23391dcaa70f135e0c149fec54b33294dfc07", "url": "https://github.com/apache/skywalking/commit/c3c23391dcaa70f135e0c149fec54b33294dfc07", "message": "fix profile exporter e2e test failure issue", "committedDate": "2020-02-28T02:40:50Z", "type": "commit"}, {"oid": "17ef6d8b29dbb7e73885b67f33d3dd944fe6a9e7", "url": "https://github.com/apache/skywalking/commit/17ef6d8b29dbb7e73885b67f33d3dd944fe6a9e7", "message": "add document, local debug main method", "committedDate": "2020-02-28T13:51:01Z", "type": "commit"}, {"oid": "3c4aea5a452a3e92c7346ec06f07b9922eada234", "url": "https://github.com/apache/skywalking/commit/3c4aea5a452a3e92c7346ec06f07b9922eada234", "message": "Merge branch 'master' into profile_exporter", "committedDate": "2020-02-28T13:53:41Z", "type": "commit"}, {"oid": "d36d2c81cbab427fd6087aef8081061cedfb9b2f", "url": "https://github.com/apache/skywalking/commit/d36d2c81cbab427fd6087aef8081061cedfb9b2f", "message": "using h2 dokcer to fix e2e test", "committedDate": "2020-02-29T02:56:32Z", "type": "commit"}, {"oid": "f9bc9b22dd9201fc1a4f97195a1914ca1b0099e1", "url": "https://github.com/apache/skywalking/commit/f9bc9b22dd9201fc1a4f97195a1914ca1b0099e1", "message": "fix code structure issue", "committedDate": "2020-02-29T03:46:28Z", "type": "commit"}, {"oid": "3426cc302a4c832e9c65737cd193a34e6e0723ad", "url": "https://github.com/apache/skywalking/commit/3426cc302a4c832e9c65737cd193a34e6e0723ad", "message": "fix maven child module declare", "committedDate": "2020-02-29T03:52:34Z", "type": "commit"}, {"oid": "01a12fb29028f81fd8e574c64a8b63c296acb5ee", "url": "https://github.com/apache/skywalking/commit/01a12fb29028f81fd8e574c64a8b63c296acb5ee", "message": "fix missing module package type declare", "committedDate": "2020-02-29T05:14:07Z", "type": "commit"}, {"oid": "defda8e793f46c54429e26e9343ee48fbbc1fe3b", "url": "https://github.com/apache/skywalking/commit/defda8e793f46c54429e26e9343ee48fbbc1fe3b", "message": "fix missing shell path commit", "committedDate": "2020-02-29T06:07:36Z", "type": "commit"}, {"oid": "4c5621ab831ba707f112c34427a9b1f3833acb50", "url": "https://github.com/apache/skywalking/commit/4c5621ab831ba707f112c34427a9b1f3833acb50", "message": "adding exporter unit test", "committedDate": "2020-02-29T08:54:40Z", "type": "commit"}, {"oid": "ccb0bca6716d9bad1710c4a810238826a883f8b5", "url": "https://github.com/apache/skywalking/commit/ccb0bca6716d9bad1710c4a810238826a883f8b5", "message": "change document", "committedDate": "2020-02-29T13:52:01Z", "type": "commit"}, {"oid": "263e5fcdd281ab8c7acdcc203d12a3940933ddc5", "url": "https://github.com/apache/skywalking/commit/263e5fcdd281ab8c7acdcc203d12a3940933ddc5", "message": "Merge branch 'master' into profile_exporter", "committedDate": "2020-02-29T14:39:05Z", "type": "commit"}, {"oid": "2be505549b0fc7cd0c47c79e25ebe4358b8c8430", "url": "https://github.com/apache/skywalking/commit/2be505549b0fc7cd0c47c79e25ebe4358b8c8430", "message": "remove auto generate tool config file", "committedDate": "2020-03-03T15:53:09Z", "type": "commit"}, {"oid": "8ca6f1146783d7a6ecf9d2d1d64a0f10655a3db0", "url": "https://github.com/apache/skywalking/commit/8ca6f1146783d7a6ecf9d2d1d64a0f10655a3db0", "message": "change document description", "committedDate": "2020-03-04T03:30:39Z", "type": "commit"}, {"oid": "0b2ee57f03b4a3df909496eb046f754cfec4b6d9", "url": "https://github.com/apache/skywalking/commit/0b2ee57f03b4a3df909496eb046f754cfec4b6d9", "message": "Merge branch 'master' into profile_exporter", "committedDate": "2020-03-04T03:31:02Z", "type": "commit"}, {"oid": "ad6bcdc82fdf1d9d61ab16c72763f983a6cf3ab3", "url": "https://github.com/apache/skywalking/commit/ad6bcdc82fdf1d9d61ab16c72763f983a6cf3ab3", "message": "Merge branch 'master' into profile_exporter", "committedDate": "2020-03-04T06:47:51Z", "type": "commit"}, {"oid": "e9a02436b2398ec67bcd16a12a5ecebdcdeb4248", "url": "https://github.com/apache/skywalking/commit/e9a02436b2398ec67bcd16a12a5ecebdcdeb4248", "message": "make CoreModuleConfig has public construct", "committedDate": "2020-03-04T07:05:02Z", "type": "commit"}, {"oid": "7a5cb6c8c0e4ce47432d6afa0cc9a56d27dd49e5", "url": "https://github.com/apache/skywalking/commit/7a5cb6c8c0e4ce47432d6afa0cc9a56d27dd49e5", "message": "Merge branch 'master' into profile_exporter", "committedDate": "2020-03-04T09:31:12Z", "type": "commit"}]}