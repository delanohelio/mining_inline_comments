{"pr_number": 6060, "pr_title": "Support building gRPC TLS channel but CA file is not required", "pr_createdAt": "2020-12-23T01:51:23Z", "pr_url": "https://github.com/apache/skywalking/pull/6060", "timeline": [{"oid": "7aabf4b6a1ede6c62425fb25fea2646aba091fe8", "url": "https://github.com/apache/skywalking/commit/7aabf4b6a1ede6c62425fb25fea2646aba091fe8", "message": "Support building TLS grpc channel and CA file is optional", "committedDate": "2020-12-22T15:50:00Z", "type": "commit"}, {"oid": "7cfb75128d71705f27fcd1ddfe713aecc6ed00ed", "url": "https://github.com/apache/skywalking/commit/7cfb75128d71705f27fcd1ddfe713aecc6ed00ed", "message": "Support building TLS grpc channel and CA file is optional\n\nSupport building TLS grpc channel and CA file is optional", "committedDate": "2020-12-23T01:33:43Z", "type": "commit"}, {"oid": "bc2f28cb6550ade537b1a1d8757c5f4ea2602eec", "url": "https://github.com/apache/skywalking/commit/bc2f28cb6550ade537b1a1d8757c5f4ea2602eec", "message": "Merge branch 'feature/tls_without_trust_manager' of https://github.com/buxingzhe/skywalking into feature/tls_without_trust_manager", "committedDate": "2020-12-23T01:34:08Z", "type": "commit"}, {"oid": "440239c51ce5c20f7a7c9e9e2887c293e8a3ed34", "url": "https://github.com/apache/skywalking/commit/440239c51ce5c20f7a7c9e9e2887c293e8a3ed34", "message": "Merge branch 'feature/tls_without_trust_manager' of https://github.com/buxingzhe/skywalking into feature/tls_without_trust_manager", "committedDate": "2020-12-23T01:47:25Z", "type": "commit"}, {"oid": "a99dffc28b20b36cecd83c4c26886deb717322fb", "url": "https://github.com/apache/skywalking/commit/a99dffc28b20b36cecd83c4c26886deb717322fb", "message": "Merge branch 'feature/tls_without_trust_manager' of https://github.com/buxingzhe/skywalking into feature/tls_without_trust_manager", "committedDate": "2020-12-23T01:48:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzU5OTgxOA==", "url": "https://github.com/apache/skywalking/pull/6060#discussion_r547599818", "bodyText": "Change this name to FORCE_TLS. There is only gRPC transport.", "author": "wu-sheng", "createdAt": "2020-12-23T02:07:02Z", "path": "apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/conf/Config.java", "diffHunk": "@@ -124,6 +124,11 @@\n          * Keep tracing even the backend is not available.\n          */\n         public static boolean KEEP_TRACING = false;\n+\n+        /**\n+         * Should TLS enabled for gRPC channels\n+         */\n+        public static boolean IS_GRPC_CHANNEL_TLS_FORCED = true;", "originalCommit": "a99dffc28b20b36cecd83c4c26886deb717322fb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzYwNzgwOQ==", "url": "https://github.com/apache/skywalking/pull/6060#discussion_r547607809", "bodyText": "This can't be open in default, because in many mode, the OAP is not open TLS.", "author": "wu-sheng", "createdAt": "2020-12-23T02:40:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzU5OTgxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzYxNjExMw==", "url": "https://github.com/apache/skywalking/pull/6060#discussion_r547616113", "bodyText": "Yes, I agree.", "author": "buxingzhe", "createdAt": "2020-12-23T03:13:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzU5OTgxOA=="}], "type": "inlineReview", "revised_code": {"commit": "60ca9818b7b5e747fb1317d04a7154cc16e2c75d", "chunk": "diff --git a/apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/conf/Config.java b/apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/conf/Config.java\nindex bee0bc184..1c88fbe21 100755\n--- a/apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/conf/Config.java\n+++ b/apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/conf/Config.java\n\n@@ -128,7 +128,7 @@ public class Config {\n         /**\n          * Should TLS enabled for gRPC channels\n          */\n-        public static boolean IS_GRPC_CHANNEL_TLS_FORCED = true;\n+        public static boolean FORCE_TLS = true;\n     }\n \n     public static class OsInfo {\n"}}, {"oid": "60ca9818b7b5e747fb1317d04a7154cc16e2c75d", "url": "https://github.com/apache/skywalking/commit/60ca9818b7b5e747fb1317d04a7154cc16e2c75d", "message": "Merge branch 'feature/tls_without_trust_manager' of https://github.com/buxingzhe/skywalking into feature/tls_without_trust_manager", "committedDate": "2020-12-23T03:01:45Z", "type": "commit"}, {"oid": "92a87b982c45d5e3d2380d4f56a6d09ab1d058ce", "url": "https://github.com/apache/skywalking/commit/92a87b982c45d5e3d2380d4f56a6d09ab1d058ce", "message": "Merge branch 'feature/tls_without_trust_manager' of https://github.com/buxingzhe/skywalking into feature/tls_without_trust_manager", "committedDate": "2020-12-23T03:01:57Z", "type": "commit"}, {"oid": "fb21d791520bb4e47e550d16f7992d255665ab89", "url": "https://github.com/apache/skywalking/commit/fb21d791520bb4e47e550d16f7992d255665ab89", "message": "Merge branch 'feature/tls_without_trust_manager' of https://github.com/buxingzhe/skywalking into feature/tls_without_trust_manager", "committedDate": "2020-12-23T03:15:02Z", "type": "commit"}, {"oid": "c53cdb5e55d4fc7032e5d796726d0c6dec4314f2", "url": "https://github.com/apache/skywalking/commit/c53cdb5e55d4fc7032e5d796726d0c6dec4314f2", "message": "Merge branch 'feature/tls_without_trust_manager' of https://github.com/buxingzhe/skywalking into feature/tls_without_trust_manager", "committedDate": "2020-12-23T03:15:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Nzc4NTkxNg==", "url": "https://github.com/apache/skywalking/pull/6060#discussion_r547785916", "bodyText": "I think if CA file exists, there is no need to change the FORCE_TLS=true manually.", "author": "wu-sheng", "createdAt": "2020-12-23T08:10:44Z", "path": "apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/remote/TLSChannelBuilder.java", "diffHunk": "@@ -37,10 +38,12 @@\n     @Override\n     public NettyChannelBuilder build(\n         NettyChannelBuilder managedChannelBuilder) throws AgentPackageNotFoundException, SSLException {\n-        File caFile = new File(AgentPackagePath.getPath(), CA_FILE_NAME);\n-        if (caFile.exists() && caFile.isFile()) {\n+        if (Config.Agent.FORCE_TLS) {\n             SslContextBuilder builder = GrpcSslContexts.forClient();\n-            builder.trustManager(caFile);\n+            File caFile = new File(AgentPackagePath.getPath(), CA_FILE_NAME);", "originalCommit": "c53cdb5e55d4fc7032e5d796726d0c6dec4314f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzkxODgwNA==", "url": "https://github.com/apache/skywalking/pull/6060#discussion_r547918804", "bodyText": "So either CA file exists or FORCE_TLS=true, TLS should be used?", "author": "buxingzhe", "createdAt": "2020-12-23T11:45:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Nzc4NTkxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzkyMzIyMA==", "url": "https://github.com/apache/skywalking/pull/6060#discussion_r547923220", "bodyText": "Yes, we don't have to set both 2 settings.", "author": "wu-sheng", "createdAt": "2020-12-23T11:57:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Nzc4NTkxNg=="}], "type": "inlineReview", "revised_code": {"commit": "dcb5547ffad2ec95eafd1d081c54faea3f1ff55c", "chunk": "diff --git a/apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/remote/TLSChannelBuilder.java b/apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/remote/TLSChannelBuilder.java\nindex b048238f9..8746aac97 100644\n--- a/apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/remote/TLSChannelBuilder.java\n+++ b/apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/remote/TLSChannelBuilder.java\n\n@@ -38,10 +38,11 @@ public class TLSChannelBuilder implements ChannelBuilder<NettyChannelBuilder> {\n     @Override\n     public NettyChannelBuilder build(\n         NettyChannelBuilder managedChannelBuilder) throws AgentPackageNotFoundException, SSLException {\n-        if (Config.Agent.FORCE_TLS) {\n+        File caFile = new File(AgentPackagePath.getPath(), CA_FILE_NAME);\n+\tboolean isCAFileExist = caFile.exists() && caFile.isFile();\n+        if (Config.Agent.FORCE_TLS || isCAFileExist) {\n             SslContextBuilder builder = GrpcSslContexts.forClient();\n-            File caFile = new File(AgentPackagePath.getPath(), CA_FILE_NAME);\n-            if (caFile.exists() && caFile.isFile()) {\n+            if (isCAFileExist) {\n                 builder.trustManager(caFile);\n             }\n             managedChannelBuilder = managedChannelBuilder.negotiationType(NegotiationType.TLS)\n"}}, {"oid": "dcb5547ffad2ec95eafd1d081c54faea3f1ff55c", "url": "https://github.com/apache/skywalking/commit/dcb5547ffad2ec95eafd1d081c54faea3f1ff55c", "message": "Merge branch 'feature/tls_without_trust_manager' of https://github.com/buxingzhe/skywalking into feature/tls_without_trust_manager", "committedDate": "2020-12-23T12:10:25Z", "type": "commit"}, {"oid": "c1e165041a87db8d66e3cfb50707388902a3239a", "url": "https://github.com/apache/skywalking/commit/c1e165041a87db8d66e3cfb50707388902a3239a", "message": "Merge branch 'feature/tls_without_trust_manager' of https://github.com/buxingzhe/skywalking into feature/tls_without_trust_manager", "committedDate": "2020-12-23T12:10:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzkzMzA2OA==", "url": "https://github.com/apache/skywalking/pull/6060#discussion_r547933068", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                     * Should TLS enabled for gRPC channels\n          \n          \n            \n                     * Force open TLS for gRPC channel if true.", "author": "wu-sheng", "createdAt": "2020-12-23T12:23:16Z", "path": "apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/conf/Config.java", "diffHunk": "@@ -124,6 +124,11 @@\n          * Keep tracing even the backend is not available.\n          */\n         public static boolean KEEP_TRACING = false;\n+\n+        /**\n+         * Should TLS enabled for gRPC channels", "originalCommit": "c1e165041a87db8d66e3cfb50707388902a3239a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1da9270537d5856aaa4be9039e6e5dd7f3478344", "chunk": "diff --git a/apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/conf/Config.java b/apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/conf/Config.java\nindex 161bc6036..36befcac1 100755\n--- a/apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/conf/Config.java\n+++ b/apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/conf/Config.java\n\n@@ -126,7 +126,7 @@ public class Config {\n         public static boolean KEEP_TRACING = false;\n \n         /**\n-         * Should TLS enabled for gRPC channels\n+         * Force open TLS for gRPC channel if true.\n          */\n         public static boolean FORCE_TLS = false;\n     }\n"}}, {"oid": "1da9270537d5856aaa4be9039e6e5dd7f3478344", "url": "https://github.com/apache/skywalking/commit/1da9270537d5856aaa4be9039e6e5dd7f3478344", "message": "Update apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/conf/Config.java", "committedDate": "2020-12-23T12:23:21Z", "type": "commit"}, {"oid": "dd1ebb4c9910ff6232d49437ac5c28985d760d46", "url": "https://github.com/apache/skywalking/commit/dd1ebb4c9910ff6232d49437ac5c28985d760d46", "message": "Merge branch 'feature/tls_without_trust_manager' of https://github.com/buxingzhe/skywalking into feature/tls_without_trust_manager", "committedDate": "2020-12-23T12:34:27Z", "type": "commit"}, {"oid": "82362040e6c671c8520e803b1d4ed0435ce79992", "url": "https://github.com/apache/skywalking/commit/82362040e6c671c8520e803b1d4ed0435ce79992", "message": "Merge branch 'feature/tls_without_trust_manager' of https://github.com/buxingzhe/skywalking into feature/tls_without_trust_manager", "committedDate": "2020-12-23T12:34:32Z", "type": "commit"}, {"oid": "1662ac433c3488fde7d747c0dbe94bb62d871847", "url": "https://github.com/apache/skywalking/commit/1662ac433c3488fde7d747c0dbe94bb62d871847", "message": "Update apm-sniffer/config/agent.config", "committedDate": "2020-12-23T12:44:22Z", "type": "commit"}]}