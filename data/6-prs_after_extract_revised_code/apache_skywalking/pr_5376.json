{"pr_number": 5376, "pr_title": "Hot reload gRPC certs of OAP.", "pr_createdAt": "2020-08-25T01:17:58Z", "pr_url": "https://github.com/apache/skywalking/pull/5376", "timeline": [{"oid": "cdadea55e12024ebe6e8d5af557cc82bea4cf97d", "url": "https://github.com/apache/skywalking/commit/cdadea55e12024ebe6e8d5af557cc82bea4cf97d", "message": "Hot reload gRPC certs of OAP.\n\nSigned-off-by: Gao Hongtao <hanahmily@gmail.com>", "committedDate": "2020-08-25T01:16:09Z", "type": "commit"}, {"oid": "dfcec7b86d3f873b9ccccccfa9dd3131da086843", "url": "https://github.com/apache/skywalking/commit/dfcec7b86d3f873b9ccccccfa9dd3131da086843", "message": "Support PKCS#1, update relevant documents.\n\nSigned-off-by: Gao Hongtao <hanahmily@gmail.com>", "committedDate": "2020-08-31T00:51:14Z", "type": "commit"}, {"oid": "2e1076e875d97b1e0e3bc3a5ed0cd17e2f9cd5bd", "url": "https://github.com/apache/skywalking/commit/2e1076e875d97b1e0e3bc3a5ed0cd17e2f9cd5bd", "message": "Merge branch 'master' into grpc-reload-crt", "committedDate": "2020-08-31T01:02:05Z", "type": "commit"}, {"oid": "c8e1e7c525f4e1c244db2acbc2dd8d8ee9c4003a", "url": "https://github.com/apache/skywalking/commit/c8e1e7c525f4e1c244db2acbc2dd8d8ee9c4003a", "message": "Merge branch 'master' into grpc-reload-crt", "committedDate": "2020-08-31T02:16:18Z", "type": "commit"}, {"oid": "9e5c08603665a8d941e819f21326ebd49d3bc606", "url": "https://github.com/apache/skywalking/commit/9e5c08603665a8d941e819f21326ebd49d3bc606", "message": "Start ssl context\n\nSigned-off-by: Gao Hongtao <hanahmily@gmail.com>", "committedDate": "2020-08-31T05:02:44Z", "type": "commit"}, {"oid": "7c63e1bc163417a55f3e98c5fb46c98be1ec085d", "url": "https://github.com/apache/skywalking/commit/7c63e1bc163417a55f3e98c5fb46c98be1ec085d", "message": "Merge branch 'grpc-reload-crt' of github.com:apache/skywalking into grpc-reload-crt", "committedDate": "2020-08-31T05:22:59Z", "type": "commit"}, {"oid": "7c63e1bc163417a55f3e98c5fb46c98be1ec085d", "url": "https://github.com/apache/skywalking/commit/7c63e1bc163417a55f3e98c5fb46c98be1ec085d", "message": "Merge branch 'grpc-reload-crt' of github.com:apache/skywalking into grpc-reload-crt", "committedDate": "2020-08-31T05:22:59Z", "type": "forcePushed"}, {"oid": "cca477e575382476d4d0e85ecde41b81876f94ad", "url": "https://github.com/apache/skywalking/commit/cca477e575382476d4d0e85ecde41b81876f94ad", "message": "Update sslcontext\n\nSigned-off-by: Gao Hongtao <hanahmily@gmail.com>", "committedDate": "2020-08-31T05:39:17Z", "type": "commit"}, {"oid": "4357c58a608be359fc1bff5a7bc3fe736c3d82c1", "url": "https://github.com/apache/skywalking/commit/4357c58a608be359fc1bff5a7bc3fe736c3d82c1", "message": "Merge branch 'master' into grpc-reload-crt", "committedDate": "2020-08-31T08:50:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDAwOTM3NQ==", "url": "https://github.com/apache/skywalking/pull/5376#discussion_r480009375", "bodyText": "The returned value is just ignored? If that's intentionally, do we need a null check in the following uses of ctx?", "author": "kezhenxu94", "createdAt": "2020-08-31T09:31:59Z", "path": "oap-server/server-library/library-server/src/main/java/org/apache/skywalking/oap/server/library/server/grpc/ssl/DynamicSslContext.java", "diffHunk": "@@ -0,0 +1,134 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.library.server.grpc.ssl;\n+\n+import io.grpc.netty.GrpcSslContexts;\n+import io.netty.buffer.ByteBufAllocator;\n+import io.netty.handler.ssl.ApplicationProtocolNegotiator;\n+import io.netty.handler.ssl.SslContext;\n+import io.netty.handler.ssl.SslContextBuilder;\n+import io.netty.handler.ssl.SslProvider;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.nio.file.Paths;\n+import java.security.GeneralSecurityException;\n+import java.util.List;\n+import javax.net.ssl.SSLEngine;\n+import javax.net.ssl.SSLException;\n+import javax.net.ssl.SSLSessionContext;\n+import org.apache.skywalking.oap.server.library.util.MultipleFilesChangeMonitor;\n+\n+/**\n+ * Load SslContext dynamically.\n+ */\n+public class DynamicSslContext extends SslContext {\n+    private final MultipleFilesChangeMonitor monitor;\n+    private volatile SslContext ctx;\n+\n+    public static DynamicSslContext forServer(final String privateKeyFile, final String certChainFile) {\n+        return new DynamicSslContext(privateKeyFile, certChainFile);\n+    }\n+\n+    public static DynamicSslContext forClient(final String caFile) {\n+        return new DynamicSslContext(caFile);\n+    }\n+\n+    private DynamicSslContext(final String privateKeyFile, final String certChainFile) {\n+        updateContext(privateKeyFile, certChainFile);\n+        monitor = new MultipleFilesChangeMonitor(\n+            10,\n+            readableContents -> updateContext(privateKeyFile, certChainFile),\n+            certChainFile,\n+            privateKeyFile);\n+    }\n+\n+    private DynamicSslContext(final String caFile) {\n+        updateContext(caFile);\n+        monitor = new MultipleFilesChangeMonitor(\n+            10,\n+            readableContents -> updateContext(caFile),\n+            caFile);\n+    }\n+\n+    private void updateContext(String caFile) {\n+        try {\n+            GrpcSslContexts.forClient().trustManager(Paths.get(caFile).toFile()).build();", "originalCommit": "4357c58a608be359fc1bff5a7bc3fe736c3d82c1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDAyMDk4NQ==", "url": "https://github.com/apache/skywalking/pull/5376#discussion_r480020985", "bodyText": "I think this is a lambda based on MultipleFilesChangeMonitor#FilesChangedNotifier#filesChanged. It is triggered by the file change monitor, I think there is nothing you could do.", "author": "wu-sheng", "createdAt": "2020-08-31T09:55:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDAwOTM3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDAyNDE1NQ==", "url": "https://github.com/apache/skywalking/pull/5376#discussion_r480024155", "bodyText": "I think this is a lambda based on MultipleFilesChangeMonitor#FilesChangedNotifier#filesChanged. It is triggered by the file change monitor, I think there is nothing you could do.\n\nThat's not what I meant, compare it with the other overloaded method updateContext", "author": "kezhenxu94", "createdAt": "2020-08-31T10:02:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDAwOTM3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDA5MjE4OA==", "url": "https://github.com/apache/skywalking/pull/5376#discussion_r480092188", "bodyText": "Got it, you mean this\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        GrpcSslContexts.forClient().trustManager(Paths.get(caFile).toFile()).build();\n          \n          \n            \n                        ctx = GrpcSslContexts.forClient().trustManager(Paths.get(caFile).toFile()).build();\n          \n      \n    \n    \n  \n\n@hanahmily Please take a look.", "author": "wu-sheng", "createdAt": "2020-08-31T12:20:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDAwOTM3NQ=="}], "type": "inlineReview", "revised_code": {"commit": "8bbe1c9ab529c89522ca336de81810ae8e5a9ec7", "chunk": "diff --git a/oap-server/server-library/library-server/src/main/java/org/apache/skywalking/oap/server/library/server/grpc/ssl/DynamicSslContext.java b/oap-server/server-library/library-server/src/main/java/org/apache/skywalking/oap/server/library/server/grpc/ssl/DynamicSslContext.java\nindex 7ae2639e86..80bc79ef2d 100644\n--- a/oap-server/server-library/library-server/src/main/java/org/apache/skywalking/oap/server/library/server/grpc/ssl/DynamicSslContext.java\n+++ b/oap-server/server-library/library-server/src/main/java/org/apache/skywalking/oap/server/library/server/grpc/ssl/DynamicSslContext.java\n\n@@ -68,7 +68,7 @@ public class DynamicSslContext extends SslContext {\n \n     private void updateContext(String caFile) {\n         try {\n-            GrpcSslContexts.forClient().trustManager(Paths.get(caFile).toFile()).build();\n+            ctx = GrpcSslContexts.forClient().trustManager(Paths.get(caFile).toFile()).build();\n         } catch (SSLException e) {\n             throw new IllegalArgumentException(e);\n         }\n"}}, {"oid": "8bbe1c9ab529c89522ca336de81810ae8e5a9ec7", "url": "https://github.com/apache/skywalking/commit/8bbe1c9ab529c89522ca336de81810ae8e5a9ec7", "message": "Update oap-server/server-library/library-server/src/main/java/org/apache/skywalking/oap/server/library/server/grpc/ssl/DynamicSslContext.java\n\nCo-authored-by: \u5434\u665f Wu Sheng <wu.sheng@foxmail.com>", "committedDate": "2020-08-31T12:40:35Z", "type": "commit"}]}