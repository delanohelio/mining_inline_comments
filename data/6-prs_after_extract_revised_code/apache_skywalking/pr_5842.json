{"pr_number": 5842, "pr_title": "Add the plugin for mssql-jtds 1.x plugin.", "pr_createdAt": "2020-11-14T05:49:31Z", "pr_url": "https://github.com/apache/skywalking/pull/5842", "timeline": [{"oid": "3980624951b6a3b0118ade6e805e66b0ab737191", "url": "https://github.com/apache/skywalking/commit/3980624951b6a3b0118ade6e805e66b0ab737191", "message": "Add the plugin for mssql-jtds 1.x plugin.", "committedDate": "2020-11-14T05:47:39Z", "type": "commit"}, {"oid": "7f1b07f972de29d9a3de7095dee1d0774a84cf3a", "url": "https://github.com/apache/skywalking/commit/7f1b07f972de29d9a3de7095dee1d0774a84cf3a", "message": "Polishing.", "committedDate": "2020-11-14T06:17:52Z", "type": "commit"}, {"oid": "fe1c1eeef19acc3cb4d2977ae99823d93a08e152", "url": "https://github.com/apache/skywalking/commit/fe1c1eeef19acc3cb4d2977ae99823d93a08e152", "message": "Polishing.", "committedDate": "2020-11-14T07:48:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzcwNjIyOA==", "url": "https://github.com/apache/skywalking/pull/5842#discussion_r523706228", "bodyText": "Why not use org.apache.skywalking.apm.agent.core.plugin.match.MultiClassNameMatch so that you don't need several subclasses?", "author": "kezhenxu94", "createdAt": "2020-11-15T04:33:33Z", "path": "apm-sniffer/apm-sdk-plugin/mssql-jtds-1.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/mssql/jtds/v1/define/ConnectionJDBC2Instrumentation.java", "diffHunk": "@@ -0,0 +1,35 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.plugin.mssql.jtds.v1.define;\n+\n+import org.apache.skywalking.apm.agent.core.plugin.match.ClassMatch;\n+\n+import static org.apache.skywalking.apm.agent.core.plugin.match.NameMatch.byName;\n+\n+/**\n+ * {@link ConnectionJDBC2Instrumentation} presents that skywalking intercepts {@link net.sourceforge.jtds.jdbc.ConnectionJDBC2}.\n+ */\n+public class ConnectionJDBC2Instrumentation extends AbstractConnectionInstrumentation {\n+    public static final String ENHANCE_CLASS = \"net.sourceforge.jtds.jdbc.ConnectionJDBC2\";\n+\n+    @Override\n+    protected ClassMatch enhanceClass() {\n+        return byName(ENHANCE_CLASS);", "originalCommit": "fe1c1eeef19acc3cb4d2977ae99823d93a08e152", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzcwODc3Mw==", "url": "https://github.com/apache/skywalking/pull/5842#discussion_r523708773", "bodyText": "fixed.", "author": "zifeihan", "createdAt": "2020-11-15T05:07:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzcwNjIyOA=="}], "type": "inlineReview", "revised_code": {"commit": "c75f2709ccd9b0c8f17fd52f63a7692400b112a5", "chunk": "diff --git a/apm-sniffer/apm-sdk-plugin/mssql-jtds-1.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/mssql/jtds/v1/define/ConnectionJDBC2Instrumentation.java b/apm-sniffer/apm-sdk-plugin/mssql-jtds-1.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/mssql/jtds/v1/define/ConnectionInstrumentation.java\nsimilarity index 64%\nrename from apm-sniffer/apm-sdk-plugin/mssql-jtds-1.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/mssql/jtds/v1/define/ConnectionJDBC2Instrumentation.java\nrename to apm-sniffer/apm-sdk-plugin/mssql-jtds-1.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/mssql/jtds/v1/define/ConnectionInstrumentation.java\nindex 222d190d1f..2fdde6c4fc 100644\n--- a/apm-sniffer/apm-sdk-plugin/mssql-jtds-1.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/mssql/jtds/v1/define/ConnectionJDBC2Instrumentation.java\n+++ b/apm-sniffer/apm-sdk-plugin/mssql-jtds-1.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/mssql/jtds/v1/define/ConnectionInstrumentation.java\n\n@@ -19,17 +19,17 @@\n package org.apache.skywalking.apm.plugin.mssql.jtds.v1.define;\n \n import org.apache.skywalking.apm.agent.core.plugin.match.ClassMatch;\n-\n-import static org.apache.skywalking.apm.agent.core.plugin.match.NameMatch.byName;\n+import org.apache.skywalking.apm.agent.core.plugin.match.MultiClassNameMatch;\n \n /**\n- * {@link ConnectionJDBC2Instrumentation} presents that skywalking intercepts {@link net.sourceforge.jtds.jdbc.ConnectionJDBC2}.\n+ * {@link ConnectionInstrumentation} presents that skywalking intercepts.\n  */\n-public class ConnectionJDBC2Instrumentation extends AbstractConnectionInstrumentation {\n-    public static final String ENHANCE_CLASS = \"net.sourceforge.jtds.jdbc.ConnectionJDBC2\";\n+public class ConnectionInstrumentation extends AbstractConnectionInstrumentation {\n+    public static final String ENHANCE_CONNECTION_JDBC2_CLASS = \"net.sourceforge.jtds.jdbc.ConnectionJDBC2\";\n+    public static final String ENHANCE_JTDS_CONNECTION_CLASS = \"net.sourceforge.jtds.jdbc.JtdsConnection\";\n \n     @Override\n     protected ClassMatch enhanceClass() {\n-        return byName(ENHANCE_CLASS);\n+        return MultiClassNameMatch.byMultiClassMatch(ENHANCE_CONNECTION_JDBC2_CLASS, ENHANCE_JTDS_CONNECTION_CLASS);\n     }\n }\n"}}, {"oid": "c75f2709ccd9b0c8f17fd52f63a7692400b112a5", "url": "https://github.com/apache/skywalking/commit/c75f2709ccd9b0c8f17fd52f63a7692400b112a5", "message": "Polishing.", "committedDate": "2020-11-15T05:05:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzcwOTE2OA==", "url": "https://github.com/apache/skywalking/pull/5842#discussion_r523709168", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * 1. Enhance <code>prepareStatement</code> by <code>org.apache.skywalking.apm.plugin.jdbc.define.JDBCPrepareStatementInterceptor</code>\n          \n          \n            \n             * 3. Enhance <code>prepareCall</code> by <code>org.apache.skywalking.apm.plugin.jdbc.define.JDBCPrepareCallInterceptor</code>\n          \n          \n            \n             * 4. Enhance <code>createStatement</code> by <code>org.apache.skywalking.apm.plugin.jdbc.define.JDBCStatementInterceptor</code>\n          \n          \n            \n             * 5. Enhance <code>commit, rollback, close, releaseSavepoint</code> by <code>org.apache.skywalking.apm.plugin.jdbc.define.ConnectionServiceMethodInterceptor</code>\n          \n          \n            \n             * 1. Enhance <code>prepareStatement</code> by <code>org.apache.skywalking.apm.plugin.jdbc.define.JDBCPrepareStatementInterceptor</code>\n          \n          \n            \n             * 2. Enhance <code>prepareCall</code> by <code>org.apache.skywalking.apm.plugin.jdbc.define.JDBCPrepareCallInterceptor</code>\n          \n          \n            \n             * 3. Enhance <code>createStatement</code> by <code>org.apache.skywalking.apm.plugin.jdbc.define.JDBCStatementInterceptor</code>\n          \n          \n            \n             * 4. Enhance <code>commit, rollback, close, releaseSavepoint</code> by <code>org.apache.skywalking.apm.plugin.jdbc.define.ConnectionServiceMethodInterceptor</code>", "author": "kezhenxu94", "createdAt": "2020-11-15T05:12:52Z", "path": "apm-sniffer/apm-sdk-plugin/mssql-jtds-1.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/mssql/jtds/v1/define/AbstractConnectionInstrumentation.java", "diffHunk": "@@ -0,0 +1,150 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.plugin.mssql.jtds.v1.define;\n+\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.matcher.ElementMatcher;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.ConstructorInterceptPoint;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.InstanceMethodsInterceptPoint;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.ClassInstanceMethodsEnhancePluginDefine;\n+import org.apache.skywalking.apm.plugin.jdbc.define.Constants;\n+\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+import static net.bytebuddy.matcher.ElementMatchers.takesArguments;\n+\n+/**\n+ * {@link AbstractConnectionInstrumentation} define how to enhance the following methods that the class which extend\n+ * {@link java.sql.Connection}.\n+ * <p>\n+ * 1. Enhance <code>prepareStatement</code> by <code>org.apache.skywalking.apm.plugin.jdbc.define.JDBCPrepareStatementInterceptor</code>\n+ * 3. Enhance <code>prepareCall</code> by <code>org.apache.skywalking.apm.plugin.jdbc.define.JDBCPrepareCallInterceptor</code>\n+ * 4. Enhance <code>createStatement</code> by <code>org.apache.skywalking.apm.plugin.jdbc.define.JDBCStatementInterceptor</code>\n+ * 5. Enhance <code>commit, rollback, close, releaseSavepoint</code> by <code>org.apache.skywalking.apm.plugin.jdbc.define.ConnectionServiceMethodInterceptor</code>", "originalCommit": "c75f2709ccd9b0c8f17fd52f63a7692400b112a5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9883ac84fbe4b0793ce6263044b7748c2c0d003f", "chunk": "diff --git a/apm-sniffer/apm-sdk-plugin/mssql-jtds-1.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/mssql/jtds/v1/define/AbstractConnectionInstrumentation.java b/apm-sniffer/apm-sdk-plugin/mssql-jtds-1.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/mssql/jtds/v1/define/AbstractConnectionInstrumentation.java\nindex 9ecb6a685e..2a3c2ab6fd 100644\n--- a/apm-sniffer/apm-sdk-plugin/mssql-jtds-1.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/mssql/jtds/v1/define/AbstractConnectionInstrumentation.java\n+++ b/apm-sniffer/apm-sdk-plugin/mssql-jtds-1.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/mssql/jtds/v1/define/AbstractConnectionInstrumentation.java\n\n@@ -33,9 +33,9 @@ import static net.bytebuddy.matcher.ElementMatchers.takesArguments;\n  * {@link java.sql.Connection}.\n  * <p>\n  * 1. Enhance <code>prepareStatement</code> by <code>org.apache.skywalking.apm.plugin.jdbc.define.JDBCPrepareStatementInterceptor</code>\n- * 3. Enhance <code>prepareCall</code> by <code>org.apache.skywalking.apm.plugin.jdbc.define.JDBCPrepareCallInterceptor</code>\n- * 4. Enhance <code>createStatement</code> by <code>org.apache.skywalking.apm.plugin.jdbc.define.JDBCStatementInterceptor</code>\n- * 5. Enhance <code>commit, rollback, close, releaseSavepoint</code> by <code>org.apache.skywalking.apm.plugin.jdbc.define.ConnectionServiceMethodInterceptor</code>\n+ * 2. Enhance <code>prepareCall</code> by <code>org.apache.skywalking.apm.plugin.jdbc.define.JDBCPrepareCallInterceptor</code>\n+ * 3. Enhance <code>createStatement</code> by <code>org.apache.skywalking.apm.plugin.jdbc.define.JDBCStatementInterceptor</code>\n+ * 4. Enhance <code>commit, rollback, close, releaseSavepoint</code> by <code>org.apache.skywalking.apm.plugin.jdbc.define.ConnectionServiceMethodInterceptor</code>\n  */\n public abstract class AbstractConnectionInstrumentation extends ClassInstanceMethodsEnhancePluginDefine {\n \n"}}, {"oid": "9883ac84fbe4b0793ce6263044b7748c2c0d003f", "url": "https://github.com/apache/skywalking/commit/9883ac84fbe4b0793ce6263044b7748c2c0d003f", "message": "Update apm-sniffer/apm-sdk-plugin/mssql-jtds-1.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/mssql/jtds/v1/define/AbstractConnectionInstrumentation.java\n\nCo-authored-by: Zhenxu Ke <kezhenxu94@163.com>", "committedDate": "2020-11-15T05:19:29Z", "type": "commit"}, {"oid": "1bbd2162fc87c53b7950e6cfb79e8416487f9f0e", "url": "https://github.com/apache/skywalking/commit/1bbd2162fc87c53b7950e6cfb79e8416487f9f0e", "message": "Merge branch 'master' into mssql", "committedDate": "2020-11-15T11:30:07Z", "type": "commit"}]}