{"pr_number": 5099, "pr_title": "Storage elasticsearch health check", "pr_createdAt": "2020-07-14T22:31:27Z", "pr_url": "https://github.com/apache/skywalking/pull/5099", "timeline": [{"oid": "f45a1276584a2a539e5e2fedc00af2d8a15022cb", "url": "https://github.com/apache/skywalking/commit/f45a1276584a2a539e5e2fedc00af2d8a15022cb", "message": "Update Elasticsearch client version to latest\n\nSigned-off-by: Gao Hongtao <hanahmily@gmail.com>", "committedDate": "2020-07-14T02:48:58Z", "type": "commit"}, {"oid": "8e16d6178c385d4dc123332c9d977336e7869994", "url": "https://github.com/apache/skywalking/commit/8e16d6178c385d4dc123332c9d977336e7869994", "message": "Add HealthChecker helper\n\nSigned-off-by: Gao Hongtao <hanahmily@gmail.com>", "committedDate": "2020-07-14T22:15:15Z", "type": "commit"}, {"oid": "2d3e2453d38af67fdbaf492832f4ed56d5ecfc39", "url": "https://github.com/apache/skywalking/commit/2d3e2453d38af67fdbaf492832f4ed56d5ecfc39", "message": "Merge branch 'master' into storage-elasticsearch-health", "committedDate": "2020-07-14T22:32:26Z", "type": "commit"}, {"oid": "40ef1007310166a953632c77fc5e1b7f0e655d7e", "url": "https://github.com/apache/skywalking/commit/40ef1007310166a953632c77fc5e1b7f0e655d7e", "message": "Revert \"Update Elasticsearch client version to latest\"\n\nThis reverts commit f45a1276", "committedDate": "2020-07-15T06:53:08Z", "type": "commit"}, {"oid": "587961db9a5a44b2d1f75f000fa1b3d589f65a9f", "url": "https://github.com/apache/skywalking/commit/587961db9a5a44b2d1f75f000fa1b3d589f65a9f", "message": "Merge branch 'storage-elasticsearch-health' of github.com:apache/skywalking into storage-elasticsearch-health", "committedDate": "2020-07-15T06:58:29Z", "type": "commit"}, {"oid": "17a2b93fa12f83436a2c190b4ce9c3587c554a4d", "url": "https://github.com/apache/skywalking/commit/17a2b93fa12f83436a2c190b4ce9c3587c554a4d", "message": "Merge branch 'master' into storage-elasticsearch-health", "committedDate": "2020-07-15T06:59:08Z", "type": "commit"}, {"oid": "0ea856b0874ff677ea36e2ca947fab97dcd09656", "url": "https://github.com/apache/skywalking/commit/0ea856b0874ff677ea36e2ca947fab97dcd09656", "message": "Merge branch 'master' into storage-elasticsearch-health", "committedDate": "2020-07-15T14:40:46Z", "type": "commit"}, {"oid": "d5e840a8a7bcb681dbb360b42e60bb901666799c", "url": "https://github.com/apache/skywalking/commit/d5e840a8a7bcb681dbb360b42e60bb901666799c", "message": "Add health check to elasticsearch7\n\nSigned-off-by: Gao Hongtao <hanahmily@gmail.com>", "committedDate": "2020-07-15T15:33:23Z", "type": "commit"}, {"oid": "9f50fa847cb68a71eff3bf8ee9c283d2dab054ad", "url": "https://github.com/apache/skywalking/commit/9f50fa847cb68a71eff3bf8ee9c283d2dab054ad", "message": "nits\n\nSigned-off-by: Gao Hongtao <hanahmily@gmail.com>", "committedDate": "2020-07-15T22:00:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQ2OTU0Mw==", "url": "https://github.com/apache/skywalking/pull/5099#discussion_r455469543", "bodyText": "CoreModule has depended on TelemetryModule, I think.", "author": "wu-sheng", "createdAt": "2020-07-16T02:17:27Z", "path": "oap-server/server-storage-plugin/storage-elasticsearch-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/elasticsearch/StorageModuleElasticsearchProvider.java", "diffHunk": "@@ -197,7 +208,7 @@ public void notifyAfterCompleted() {\n \n     @Override\n     public String[] requiredModules() {\n-        return new String[]{CoreModule.NAME};\n+        return new String[]{CoreModule.NAME, TelemetryModule.NAME};", "originalCommit": "9f50fa847cb68a71eff3bf8ee9c283d2dab054ad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjkxMTYwNw==", "url": "https://github.com/apache/skywalking/pull/5099#discussion_r456911607", "bodyText": "done", "author": "hanahmily", "createdAt": "2020-07-19T13:53:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQ2OTU0Mw=="}], "type": "inlineReview", "revised_code": {"commit": "48478d2831c926ab5818dcf9176bc4a6ec0450d4", "chunk": "diff --git a/oap-server/server-storage-plugin/storage-elasticsearch-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/elasticsearch/StorageModuleElasticsearchProvider.java b/oap-server/server-storage-plugin/storage-elasticsearch-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/elasticsearch/StorageModuleElasticsearchProvider.java\nindex 1372e58823..75f17f722d 100644\n--- a/oap-server/server-storage-plugin/storage-elasticsearch-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/elasticsearch/StorageModuleElasticsearchProvider.java\n+++ b/oap-server/server-storage-plugin/storage-elasticsearch-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/elasticsearch/StorageModuleElasticsearchProvider.java\n\n@@ -208,7 +204,7 @@ public class StorageModuleElasticsearchProvider extends ModuleProvider {\n \n     @Override\n     public String[] requiredModules() {\n-        return new String[]{CoreModule.NAME, TelemetryModule.NAME};\n+        return new String[]{CoreModule.NAME};\n     }\n \n     public static List<IndexNameConverter> indexNameConverters(String namespace) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQ3MjA0OA==", "url": "https://github.com/apache/skywalking/pull/5099#discussion_r455472048", "bodyText": "Why need HealthChecker as a kind of util? And keep in static final(DEFAULT_CHECKER)?\nAccording to #5046, Health check is a module/provider. So, the thing about the checker should be a service, which you could get a reference from ServiceManager in any module.", "author": "wu-sheng", "createdAt": "2020-07-16T02:27:01Z", "path": "oap-server/server-library/library-client/src/main/java/org/apache/skywalking/oap/server/library/client/healthcheck/HealthChecker.java", "diffHunk": "@@ -0,0 +1,49 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.library.client.healthcheck;\n+\n+import lombok.RequiredArgsConstructor;\n+import lombok.extern.slf4j.Slf4j;\n+\n+/**\n+ * HealthChecker could provide health status to the listener.\n+ */\n+@Slf4j\n+@RequiredArgsConstructor\n+public class HealthChecker {", "originalCommit": "9f50fa847cb68a71eff3bf8ee9c283d2dab054ad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQ3MjQ1Mw==", "url": "https://github.com/apache/skywalking/pull/5099#discussion_r455472453", "bodyText": "Also, based on the way you use this, it is likely, you should have this module up and running always.\nI think we need a little more discussion about health checker model behavior.", "author": "wu-sheng", "createdAt": "2020-07-16T02:28:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQ3MjA0OA=="}], "type": "inlineReview", "revised_code": {"commit": "0cf9633f50506d7b178a1974d1b976996244fab7", "chunk": "diff --git a/oap-server/server-library/library-client/src/main/java/org/apache/skywalking/oap/server/library/client/healthcheck/HealthChecker.java b/oap-server/server-telemetry/telemetry-api/src/main/java/org/apache/skywalking/oap/server/telemetry/api/HealthCheckMetrics.java\nsimilarity index 59%\nrename from oap-server/server-library/library-client/src/main/java/org/apache/skywalking/oap/server/library/client/healthcheck/HealthChecker.java\nrename to oap-server/server-telemetry/telemetry-api/src/main/java/org/apache/skywalking/oap/server/telemetry/api/HealthCheckMetrics.java\nindex 49de2b41d0..ccb2e91c48 100644\n--- a/oap-server/server-library/library-client/src/main/java/org/apache/skywalking/oap/server/library/client/healthcheck/HealthChecker.java\n+++ b/oap-server/server-telemetry/telemetry-api/src/main/java/org/apache/skywalking/oap/server/telemetry/api/HealthCheckMetrics.java\n\n@@ -16,34 +16,30 @@\n  *\n  */\n \n-package org.apache.skywalking.oap.server.library.client.healthcheck;\n+package org.apache.skywalking.oap.server.telemetry.api;\n \n-import lombok.RequiredArgsConstructor;\n import lombok.extern.slf4j.Slf4j;\n+import org.apache.skywalking.oap.server.library.util.HealthChecker;\n \n /**\n- * HealthChecker could provide health status to the listener.\n+ * HealthCheckMetrics intends to record health status.\n  */\n @Slf4j\n-@RequiredArgsConstructor\n-public class HealthChecker {\n-    public static final HealthChecker DEFAULT_CHECKER = new HealthChecker(health -> { });\n+public class HealthCheckMetrics implements HealthChecker {\n+    private final GaugeMetrics metrics;\n \n-    private final HealthListener listener;\n+    public HealthCheckMetrics(GaugeMetrics metrics) {\n+        this.metrics = metrics;\n+        // The initial status is unhealthy with -1 code.\n+        metrics.setValue(-1);\n+    }\n \n-    /**\n-     * Invoking when service is healthy.\n-     */\n     public void health() {\n-        listener.listen(true);\n+        metrics.setValue(0);\n     }\n \n-    /**\n-     * Invoking when service is unhealthy.\n-     * @param t the reason of unhealthy status.\n-     */\n     public void unHealth(Throwable t) {\n-        log.error(\"Elasticsearch health check is failed\", t);\n-        listener.listen(false);\n+        log.error(\"Health check fails\", t);\n+        metrics.setValue(1);\n     }\n }\n"}}, {"oid": "a5527de21d865786247ebfe0fa1806726cf1cfed", "url": "https://github.com/apache/skywalking/commit/a5527de21d865786247ebfe0fa1806726cf1cfed", "message": "Merge branch 'master' into storage-elasticsearch-health", "committedDate": "2020-07-18T14:31:50Z", "type": "commit"}, {"oid": "0cf9633f50506d7b178a1974d1b976996244fab7", "url": "https://github.com/apache/skywalking/commit/0cf9633f50506d7b178a1974d1b976996244fab7", "message": "Polish codes\n\nSigned-off-by: Gao Hongtao <hanahmily@gmail.com>", "committedDate": "2020-07-19T13:50:40Z", "type": "commit"}, {"oid": "0525a4ec76602b337958397dfeeb05a85a6290d7", "url": "https://github.com/apache/skywalking/commit/0525a4ec76602b337958397dfeeb05a85a6290d7", "message": "Merge branch 'master' into storage-elasticsearch-health", "committedDate": "2020-07-19T13:51:10Z", "type": "commit"}, {"oid": "48478d2831c926ab5818dcf9176bc4a6ec0450d4", "url": "https://github.com/apache/skywalking/commit/48478d2831c926ab5818dcf9176bc4a6ec0450d4", "message": "Polish codes\n\nSigned-off-by: Gao Hongtao <hanahmily@gmail.com>", "committedDate": "2020-07-19T13:52:44Z", "type": "commit"}, {"oid": "a6843b0d85ea35f415174efb35ec037dcf9d52f3", "url": "https://github.com/apache/skywalking/commit/a6843b0d85ea35f415174efb35ec037dcf9d52f3", "message": "Merge branch 'storage-elasticsearch-health' of github.com:apache/skywalking into storage-elasticsearch-health", "committedDate": "2020-07-19T13:53:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjkxNDM2Nw==", "url": "https://github.com/apache/skywalking/pull/5099#discussion_r456914367", "bodyText": "This seems a format issue.", "author": "wu-sheng", "createdAt": "2020-07-19T14:18:16Z", "path": "oap-server/server-storage-plugin/storage-elasticsearch7-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/elasticsearch7/client/ElasticSearch7Client.java", "diffHunk": "@@ -256,9 +292,9 @@ public void synchronousBulk(BulkRequest request) {\n             int size = request.requests().size();\n             BulkResponse responses = client.bulk(request, RequestOptions.DEFAULT);\n             log.info(\"Synchronous bulk took time: {} millis, size: {}\", responses.getTook().getMillis(), size);\n-        } catch (IOException e) {\n-            log.error(e.getMessage(), e);\n-        }\n+            healthChecker.health();\n+        } catch (Throwable t) {\n+            healthChecker.unHealth(t);        }", "originalCommit": "a6843b0d85ea35f415174efb35ec037dcf9d52f3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjkxNTE0OQ==", "url": "https://github.com/apache/skywalking/pull/5099#discussion_r456915149", "bodyText": "done", "author": "hanahmily", "createdAt": "2020-07-19T14:25:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjkxNDM2Nw=="}], "type": "inlineReview", "revised_code": {"commit": "929f455c2f9090b66b7892cdac722d834363e387", "chunk": "diff --git a/oap-server/server-storage-plugin/storage-elasticsearch7-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/elasticsearch7/client/ElasticSearch7Client.java b/oap-server/server-storage-plugin/storage-elasticsearch7-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/elasticsearch7/client/ElasticSearch7Client.java\nindex be5e000bd1..b1534b0a34 100644\n--- a/oap-server/server-storage-plugin/storage-elasticsearch7-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/elasticsearch7/client/ElasticSearch7Client.java\n+++ b/oap-server/server-storage-plugin/storage-elasticsearch7-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/elasticsearch7/client/ElasticSearch7Client.java\n\n@@ -294,7 +294,8 @@ public class ElasticSearch7Client extends ElasticSearchClient {\n             log.info(\"Synchronous bulk took time: {} millis, size: {}\", responses.getTook().getMillis(), size);\n             healthChecker.health();\n         } catch (Throwable t) {\n-            healthChecker.unHealth(t);        }\n+            healthChecker.unHealth(t);\n+        }\n     }\n \n     public BulkProcessor createBulkProcessor(int bulkActions, int flushInterval, int concurrentRequests) {\n"}}, {"oid": "929f455c2f9090b66b7892cdac722d834363e387", "url": "https://github.com/apache/skywalking/commit/929f455c2f9090b66b7892cdac722d834363e387", "message": "Fix some nits\n\nSigned-off-by: Gao Hongtao <hanahmily@gmail.com>", "committedDate": "2020-07-19T14:23:41Z", "type": "commit"}]}