{"pr_number": 4736, "pr_title": "Increase Vert.x Compatability", "pr_createdAt": "2020-04-29T17:15:19Z", "pr_url": "https://github.com/apache/skywalking/pull/4736", "timeline": [{"oid": "986db3c6fe206dd01df3840edfd126e0e2d1b321", "url": "https://github.com/apache/skywalking/commit/986db3c6fe206dd01df3840edfd126e0e2d1b321", "message": "vertx web plugin re-impl attempt", "committedDate": "2020-04-08T17:17:31Z", "type": "commit"}, {"oid": "cf3665681e1e9fe594529a939a06802dd874117e", "url": "https://github.com/apache/skywalking/commit/cf3665681e1e9fe594529a939a06802dd874117e", "message": "added license", "committedDate": "2020-04-09T06:11:59Z", "type": "commit"}, {"oid": "cc7ce775e70a9623f8bd8410b0d7f3465e66db91", "url": "https://github.com/apache/skywalking/commit/cc7ce775e70a9623f8bd8410b0d7f3465e66db91", "message": "Merge branch 'master' into master", "committedDate": "2020-04-11T08:09:29Z", "type": "commit"}, {"oid": "8d256d197d19be9a41d09d2f5a7412ae5a7646c9", "url": "https://github.com/apache/skywalking/commit/8d256d197d19be9a41d09d2f5a7412ae5a7646c9", "message": "Merge branch 'master' into master", "committedDate": "2020-04-12T02:42:36Z", "type": "commit"}, {"oid": "cc4e2b5f0e3f646cd27263c83d131d33f7a2de10", "url": "https://github.com/apache/skywalking/commit/cc4e2b5f0e3f646cd27263c83d131d33f7a2de10", "message": "Merge pull request #1 from apache/master\n\nmerge up", "committedDate": "2020-04-21T19:46:58Z", "type": "commit"}, {"oid": "87d22ab647a08bf2bb45c3951bbeb91376f0dfe2", "url": "https://github.com/apache/skywalking/commit/87d22ab647a08bf2bb45c3951bbeb91376f0dfe2", "message": "update test for new plugin structure", "committedDate": "2020-04-22T16:10:23Z", "type": "commit"}, {"oid": "85c6ccc815f864127104959db13a1ee01d2ec87e", "url": "https://github.com/apache/skywalking/commit/85c6ccc815f864127104959db13a1ee01d2ec87e", "message": "Merge branch 'master' into master", "committedDate": "2020-04-22T16:11:42Z", "type": "commit"}, {"oid": "300499b153a580780c2186d3f00ca2ab65a28582", "url": "https://github.com/apache/skywalking/commit/300499b153a580780c2186d3f00ca2ab65a28582", "message": "got rid of registryItems", "committedDate": "2020-04-22T16:16:17Z", "type": "commit"}, {"oid": "e5cc6aaf49ef3f010eb89512b055eb1c1fdbe1b1", "url": "https://github.com/apache/skywalking/commit/e5cc6aaf49ef3f010eb89512b055eb1c1fdbe1b1", "message": "Merge remote-tracking branch 'origin/master'", "committedDate": "2020-04-22T16:16:25Z", "type": "commit"}, {"oid": "81acb7ffea0850e938b70ed50f4abe063d450131", "url": "https://github.com/apache/skywalking/commit/81acb7ffea0850e938b70ed50f4abe063d450131", "message": "remove unnecessary dependencies", "committedDate": "2020-04-23T05:28:37Z", "type": "commit"}, {"oid": "2fd69d3095e3ae0e91b49f0c073c42f692659250", "url": "https://github.com/apache/skywalking/commit/2fd69d3095e3ae0e91b49f0c073c42f692659250", "message": "re-impl eventbus scenario", "committedDate": "2020-04-23T06:10:58Z", "type": "commit"}, {"oid": "959542d095f18d4e2a5fefd25c4b2f7c35c59adc", "url": "https://github.com/apache/skywalking/commit/959542d095f18d4e2a5fefd25c4b2f7c35c59adc", "message": "more precise naming", "committedDate": "2020-04-23T06:21:35Z", "type": "commit"}, {"oid": "aa0fd16adeee64c93874e0abde18cde37bd95583", "url": "https://github.com/apache/skywalking/commit/aa0fd16adeee64c93874e0abde18cde37bd95583", "message": "fix expected data", "committedDate": "2020-04-23T06:22:52Z", "type": "commit"}, {"oid": "6e11f68ad837f44121f5d875bb1d3732767c9d9d", "url": "https://github.com/apache/skywalking/commit/6e11f68ad837f44121f5d875bb1d3732767c9d9d", "message": "Merge branch 'master' into master", "committedDate": "2020-04-23T06:48:07Z", "type": "commit"}, {"oid": "db347e961176dc4c36871d38432d14b64352932c", "url": "https://github.com/apache/skywalking/commit/db347e961176dc4c36871d38432d14b64352932c", "message": "removed unsupported versions and removed vertx caching (avoids permission error)", "committedDate": "2020-04-23T06:54:35Z", "type": "commit"}, {"oid": "1483e31d3938c90a6f02a7fc4a3b24e49b79bd28", "url": "https://github.com/apache/skywalking/commit/1483e31d3938c90a6f02a7fc4a3b24e49b79bd28", "message": "Merge remote-tracking branch 'origin/master'", "committedDate": "2020-04-23T06:54:43Z", "type": "commit"}, {"oid": "4a877c01739fc119426bc3b097728f3a094ba9ce", "url": "https://github.com/apache/skywalking/commit/4a877c01739fc119426bc3b097728f3a094ba9ce", "message": "rewrote to remove copied code", "committedDate": "2020-04-23T07:41:20Z", "type": "commit"}, {"oid": "d465dd4d82bf15ef459bfd1071c4c20a07410ffc", "url": "https://github.com/apache/skywalking/commit/d465dd4d82bf15ef459bfd1071c4c20a07410ffc", "message": "Merge branch 'master' into master", "committedDate": "2020-04-23T15:35:33Z", "type": "commit"}, {"oid": "21cebc255e25dfe9e82f59da58ccc6c71f8c5722", "url": "https://github.com/apache/skywalking/commit/21cebc255e25dfe9e82f59da58ccc6c71f8c5722", "message": "Update plugins-test.3.yaml", "committedDate": "2020-04-24T08:11:24Z", "type": "commit"}, {"oid": "b4ad628209307c063cd77054fa5e03ab3ee9f422", "url": "https://github.com/apache/skywalking/commit/b4ad628209307c063cd77054fa5e03ab3ee9f422", "message": "fixes issue of .vertx files remaining on v3.0.0", "committedDate": "2020-04-24T09:44:28Z", "type": "commit"}, {"oid": "d313cb26db21ce4bc50d3fd436810927b5f612df", "url": "https://github.com/apache/skywalking/commit/d313cb26db21ce4bc50d3fd436810927b5f612df", "message": "Merge remote-tracking branch 'origin/master'", "committedDate": "2020-04-24T09:44:41Z", "type": "commit"}, {"oid": "b876173ef60dfc37de2c7315a08967c181648a26", "url": "https://github.com/apache/skywalking/commit/b876173ef60dfc37de2c7315a08967c181648a26", "message": "only present in v3.0.0", "committedDate": "2020-04-24T10:12:51Z", "type": "commit"}, {"oid": "d57a3c352c786afeefaec98628888b2698f94752", "url": "https://github.com/apache/skywalking/commit/d57a3c352c786afeefaec98628888b2698f94752", "message": "consistency", "committedDate": "2020-04-29T13:51:01Z", "type": "commit"}, {"oid": "2b614e9ffe7a84d3e62e18d33d5dd67e6b0731c4", "url": "https://github.com/apache/skywalking/commit/2b614e9ffe7a84d3e62e18d33d5dd67e6b0731c4", "message": "Merge branch 'master' of https://github.com/BFergerson/skywalking\n\n\u0001 Conflicts:\n\u0001\t.github/workflows/plugins-test.3.yaml\n\u0001\ttest/plugin/scenarios/vertx-web-3.x-scenario/config/expectedData.yaml", "committedDate": "2020-04-29T13:52:27Z", "type": "commit"}, {"oid": "b0b24b41b71c13665d335428e749bd7c4e8a1a96", "url": "https://github.com/apache/skywalking/commit/b0b24b41b71c13665d335428e749bd7c4e8a1a96", "message": "add more supported versions", "committedDate": "2020-04-29T13:54:28Z", "type": "commit"}, {"oid": "de1ef3c0ac4ba5330a628e3bf67d98026c06fce2", "url": "https://github.com/apache/skywalking/commit/de1ef3c0ac4ba5330a628e3bf67d98026c06fce2", "message": "track status code", "committedDate": "2020-04-29T15:00:35Z", "type": "commit"}, {"oid": "ac3d6e11d28c13916720a053a536999fd7b0acee", "url": "https://github.com/apache/skywalking/commit/ac3d6e11d28c13916720a053a536999fd7b0acee", "message": "spelling fix", "committedDate": "2020-04-29T15:00:57Z", "type": "commit"}, {"oid": "213f5a69e15a7e86b8b0a947d9c620b3fb5b8861", "url": "https://github.com/apache/skywalking/commit/213f5a69e15a7e86b8b0a947d9c620b3fb5b8861", "message": "track status code", "committedDate": "2020-04-29T15:20:23Z", "type": "commit"}, {"oid": "1a44db0dcc0c4a27fba24f3357bb9a1ff72cc6d6", "url": "https://github.com/apache/skywalking/commit/1a44db0dcc0c4a27fba24f3357bb9a1ff72cc6d6", "message": "more correct naming", "committedDate": "2020-04-29T15:42:26Z", "type": "commit"}, {"oid": "41c1ce2877a0137d8c9b678cdf3c2936ed0883e5", "url": "https://github.com/apache/skywalking/commit/41c1ce2877a0137d8c9b678cdf3c2936ed0883e5", "message": "reverts 213f5a69 (status code isn't sent at this point)", "committedDate": "2020-04-29T15:43:46Z", "type": "commit"}, {"oid": "ee394310dc5d0aa0b976a0794f70271a360b7091", "url": "https://github.com/apache/skywalking/commit/ee394310dc5d0aa0b976a0794f70271a360b7091", "message": "made HttpServerResponseImplEndInstrumentation more strict based on version\nadded status code tracking\nfixes issue not finishing async spans", "committedDate": "2020-04-29T16:53:41Z", "type": "commit"}, {"oid": "b267f860fa0ec07bb38b9ff51535786ab1f093b7", "url": "https://github.com/apache/skywalking/commit/b267f860fa0ec07bb38b9ff51535786ab1f093b7", "message": "works 3.0.0,3.7.0", "committedDate": "2020-04-29T17:00:59Z", "type": "commit"}, {"oid": "35c71a4c8fb140431d584c9e812e274a70fa1118", "url": "https://github.com/apache/skywalking/commit/35c71a4c8fb140431d584c9e812e274a70fa1118", "message": "increase compatibility", "committedDate": "2020-04-29T17:10:11Z", "type": "commit"}, {"oid": "75f578fc2eeb631e17ad311a8151813a4c6c06e5", "url": "https://github.com/apache/skywalking/commit/75f578fc2eeb631e17ad311a8151813a4c6c06e5", "message": "Merge branch 'master' into master", "committedDate": "2020-04-29T17:15:47Z", "type": "commit"}, {"oid": "d2c95773bb447da1036cb675e710450224a7cdb5", "url": "https://github.com/apache/skywalking/commit/d2c95773bb447da1036cb675e710450224a7cdb5", "message": "3.9.0 default", "committedDate": "2020-04-29T17:16:37Z", "type": "commit"}, {"oid": "cbc36b7a4b4f57414c66be12215738ff33488cd6", "url": "https://github.com/apache/skywalking/commit/cbc36b7a4b4f57414c66be12215738ff33488cd6", "message": "Merge remote-tracking branch 'origin/master'", "committedDate": "2020-04-29T17:16:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzcwODY2Mw==", "url": "https://github.com/apache/skywalking/pull/4736#discussion_r417708663", "bodyText": "This is an HTTP interceptor, I think instanceof is acceptable. Only remind you, using witness class to different versions is better. Because it has no payload at the runtime, even in the JDK8 instanceof is faster, but at least nothing is faster :)", "author": "wu-sheng", "createdAt": "2020-04-30T01:42:36Z", "path": "apm-sniffer/apm-sdk-plugin/vertx-plugins/vertx-core-3.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/vertx3/HttpClientRequestImplEndInterceptor.java", "diffHunk": "@@ -40,11 +40,17 @@ public void onConstruct(EnhancedInstance objInst, Object[] allArguments) {\n         String host;\n         int port;\n         if (allArguments[3] instanceof Integer) {\n+            //ver. 3.0.x - 3.3.x", "originalCommit": "cbc36b7a4b4f57414c66be12215738ff33488cd6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzc5OTE5MQ==", "url": "https://github.com/apache/skywalking/pull/4736#discussion_r417799191", "bodyText": "Wouldn't that mean creating three HttpClientRequestImplEndInterceptor classes? One for each version range", "author": "BFergerson", "createdAt": "2020-04-30T07:07:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzcwODY2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzgxOTIxNg==", "url": "https://github.com/apache/skywalking/pull/4736#discussion_r417819216", "bodyText": "Yeap. If they have a right witness class in each version range.", "author": "dmsolr", "createdAt": "2020-04-30T07:46:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzcwODY2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzgyOTA0OQ==", "url": "https://github.com/apache/skywalking/pull/4736#discussion_r417829049", "bodyText": "You could put three sub interceptors, as the difference is onlu about onConstruct. WDYT?", "author": "wu-sheng", "createdAt": "2020-04-30T08:04:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzcwODY2Mw=="}], "type": "inlineReview", "revised_code": {"commit": "288e571e8e14d8145eb5d4c2d7d37b8c63296763", "chunk": "diff --git a/apm-sniffer/apm-sdk-plugin/vertx-plugins/vertx-core-3.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/vertx3/HttpClientRequestImplEndInterceptor.java b/apm-sniffer/apm-sdk-plugin/vertx-plugins/vertx-core-3.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/vertx3/HttpClientRequestImplEndInterceptor.java\nindex 31493b17c..1cc863c14 100644\n--- a/apm-sniffer/apm-sdk-plugin/vertx-plugins/vertx-core-3.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/vertx3/HttpClientRequestImplEndInterceptor.java\n+++ b/apm-sniffer/apm-sdk-plugin/vertx-plugins/vertx-core-3.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/vertx3/HttpClientRequestImplEndInterceptor.java\n\n@@ -33,35 +33,42 @@ import org.apache.skywalking.apm.network.trace.component.ComponentsDefine;\n \n import java.lang.reflect.Method;\n \n-public class HttpClientRequestImplEndInterceptor implements InstanceMethodsAroundInterceptor, InstanceConstructorInterceptor {\n+public class HttpClientRequestImplEndInterceptor implements InstanceMethodsAroundInterceptor {\n \n-    @Override\n-    public void onConstruct(EnhancedInstance objInst, Object[] allArguments) {\n-        String host;\n-        int port;\n-        if (allArguments[3] instanceof Integer) {\n-            //ver. 3.0.x - 3.3.x\n-            host = (String) allArguments[2];\n-            port = (Integer) allArguments[3];\n-        } else if (allArguments[4] instanceof Integer) {\n-            //ver. 3.4.x - 3.7.x\n-            host = (String) allArguments[3];\n-            port = (Integer) allArguments[4];\n-        } else {\n-            //ver. 3.8.x+\n-            host = (String) allArguments[4];\n-            port = (Integer) allArguments[5];\n+    public static class Version30XTo33XConstructorInterceptor implements InstanceConstructorInterceptor {\n+        @Override\n+        public void onConstruct(EnhancedInstance objInst, Object[] allArguments) {\n+            String host = (String) allArguments[2];\n+            int port = (Integer) allArguments[3];\n+            objInst.setSkyWalkingDynamicField(host + \":\" + port);\n+        }\n+    }\n+\n+    public static class Version34XTo37XConstructorInterceptor implements InstanceConstructorInterceptor {\n+        @Override\n+        public void onConstruct(EnhancedInstance objInst, Object[] allArguments) {\n+            String host = (String) allArguments[3];\n+            int port = (Integer) allArguments[4];\n+            objInst.setSkyWalkingDynamicField(host + \":\" + port);\n+        }\n+    }\n+\n+    public static class Version38PlusConstructorInterceptor implements InstanceConstructorInterceptor {\n+        @Override\n+        public void onConstruct(EnhancedInstance objInst, Object[] allArguments) {\n+            String host = (String) allArguments[4];\n+            int port = (Integer) allArguments[5];\n+            objInst.setSkyWalkingDynamicField(host + \":\" + port);\n         }\n-        objInst.setSkyWalkingDynamicField(host + \":\" + port);\n     }\n \n     @Override\n-    @SuppressWarnings(\"unchecked\")\n     public void beforeMethod(EnhancedInstance objInst, Method method, Object[] allArguments, Class<?>[] argumentsTypes,\n-        MethodInterceptResult result) throws Throwable {\n+                             MethodInterceptResult result) {\n         HttpClientRequest request = (HttpClientRequest) objInst;\n         ContextCarrier contextCarrier = new ContextCarrier();\n-        AbstractSpan span = ContextManager.createExitSpan(toPath(request.uri()), contextCarrier, (String) objInst.getSkyWalkingDynamicField());\n+        AbstractSpan span = ContextManager.createExitSpan(toPath(request.uri()), contextCarrier,\n+                (String) objInst.getSkyWalkingDynamicField());\n         span.setComponent(ComponentsDefine.VERTX);\n         SpanLayer.asHttp(span);\n         Tags.HTTP.METHOD.set(span, request.method().toString());\n"}}, {"oid": "3edff1d1a4214b18d9fb1e444dfaf621f45949cd", "url": "https://github.com/apache/skywalking/commit/3edff1d1a4214b18d9fb1e444dfaf621f45949cd", "message": "Merge branch 'master' into master", "committedDate": "2020-04-30T09:30:17Z", "type": "commit"}, {"oid": "288e571e8e14d8145eb5d4c2d7d37b8c63296763", "url": "https://github.com/apache/skywalking/commit/288e571e8e14d8145eb5d4c2d7d37b8c63296763", "message": "versioned witness classes (advice from wu-sheng)", "committedDate": "2020-04-30T13:07:37Z", "type": "commit"}, {"oid": "64232f8600569c2e7f0b92a5971fd5c0a30b61e7", "url": "https://github.com/apache/skywalking/commit/64232f8600569c2e7f0b92a5971fd5c0a30b61e7", "message": "Merge remote-tracking branch 'origin/master'", "committedDate": "2020-04-30T13:07:47Z", "type": "commit"}]}