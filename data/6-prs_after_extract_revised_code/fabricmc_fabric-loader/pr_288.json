{"pr_number": 288, "pr_title": "Get LaunchWrapper / FabricTweaker working again", "pr_createdAt": "2020-07-26T12:48:48Z", "pr_url": "https://github.com/FabricMC/fabric-loader/pull/288", "timeline": [{"oid": "b2190cd5711b3f0412cd3718906c926f44f1018d", "url": "https://github.com/FabricMC/fabric-loader/commit/b2190cd5711b3f0412cd3718906c926f44f1018d", "message": "Fix improper initialization order in FabricTweaker", "committedDate": "2020-07-26T10:51:52Z", "type": "commit"}, {"oid": "49f6f49173fa59af07c24558e9031df58b7b6d2b", "url": "https://github.com/FabricMC/fabric-loader/commit/49f6f49173fa59af07c24558e9031df58b7b6d2b", "message": "Fix missing class loader exclusion for *ModInitializer\n\nThese interfaces are accessed from the Entrypoint* classes which themselves are\nexcluded from the LaunchClassLoader. Not excluding the interfaces will cause\nthose to be loaded by the LaunchClassLoader as well as its parent, leading to\ncasting errors when mod entry points are to be invoked.", "committedDate": "2020-07-26T10:52:54Z", "type": "commit"}, {"oid": "85a3b9ebbd2ab160687de4fe016b8739c17be992", "url": "https://github.com/FabricMC/fabric-loader/commit/85a3b9ebbd2ab160687de4fe016b8739c17be992", "message": "Allow FabricTweaker to operate as primary or secondary tweaker\n\nWhen operating as primary tweaker, it provides all launch arguments.\nWhen operating as secondary tweaker, it only provides the class transformer and\nmod loading functionality but not the launch arguments.\n\nThis distinction is necessary because two tweakers providing arguments will\ninvariably lead to arguments being passed multiple times which is not allowed\nfor some of them.", "committedDate": "2020-07-26T10:57:35Z", "type": "commit"}, {"oid": "35be2028270168730d73e3be4720abe55f09fba3", "url": "https://github.com/FabricMC/fabric-loader/commit/35be2028270168730d73e3be4720abe55f09fba3", "message": "Fix overwriting of third-party tranformations to entry point classes\n\nWe store (`patchedClasses`) and then completely substitute during loading\n(`FabricTransformer.lwTranformerHook`) the bytecode for any classes which our\n`EntrypointTransformer`s need to change.\n\nTherefore, when they ask for any classes, we must explicitly pass the raw\nbytecode through all other transformers in order to not miss out on their\nchanges.", "committedDate": "2020-07-26T11:01:33Z", "type": "commit"}, {"oid": "d90f00636f5f2a25ef4af4558e2fe5d1e69a3e07", "url": "https://github.com/FabricMC/fabric-loader/commit/d90f00636f5f2a25ef4af4558e2fe5d1e69a3e07", "message": "Fix loading of deobfuscated game with FabricTweaker\n\nSee comment on preloadRemappedJar.", "committedDate": "2020-07-26T11:13:08Z", "type": "commit"}, {"oid": "4525ea1ebd22b8c4b2f06cf33b728d657d730297", "url": "https://github.com/FabricMC/fabric-loader/commit/4525ea1ebd22b8c4b2f06cf33b728d657d730297", "message": "Add class loader exclusion for gson to FabricTweaker\n\nSee cc03fd09a786a5d8a84168fd3a88454e3e11eefc", "committedDate": "2020-07-26T12:36:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDUzMDc0MA==", "url": "https://github.com/FabricMC/fabric-loader/pull/288#discussion_r460530740", "bodyText": "ClientModInitializer and DedicatedServerModInitializers have @Environment annotations. Is this exclusion going to affect their class transformation?", "author": "JamiesWhiteShirt", "createdAt": "2020-07-26T13:54:58Z", "path": "src/main/java/net/fabricmc/loader/launch/FabricTweaker.java", "diffHunk": "@@ -88,13 +101,19 @@ public void injectIntoClassLoader(LaunchClassLoader launchClassLoader) {\n \n \t\tlaunchClassLoader.addClassLoaderExclusion(\"net.fabricmc.api.Environment\");\n \t\tlaunchClassLoader.addClassLoaderExclusion(\"net.fabricmc.api.EnvType\");\n+\t\tlaunchClassLoader.addClassLoaderExclusion(\"net.fabricmc.api.ModInitializer\");\n+\t\tlaunchClassLoader.addClassLoaderExclusion(\"net.fabricmc.api.ClientModInitializer\");\n+\t\tlaunchClassLoader.addClassLoaderExclusion(\"net.fabricmc.api.DedicatedServerModInitializer\");", "originalCommit": "4525ea1ebd22b8c4b2f06cf33b728d657d730297", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDUzMTA3Mw==", "url": "https://github.com/FabricMC/fabric-loader/pull/288#discussion_r460531073", "bodyText": "Nevermind, they don't.", "author": "JamiesWhiteShirt", "createdAt": "2020-07-26T13:58:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDUzMDc0MA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDUzOTc1Ng==", "url": "https://github.com/FabricMC/fabric-loader/pull/288#discussion_r460539756", "bodyText": "Why? I haven't looked at this in detail, but this looks at first glance like it might cause an infinite loop. I.e. EntrypointTransformer asks to run transformers which runs the EntrypointTransformer", "author": "Earthcomputer", "createdAt": "2020-07-26T15:19:49Z", "path": "src/main/java/net/fabricmc/loader/entrypoint/EntrypointTransformer.java", "diffHunk": "@@ -42,7 +42,7 @@ public EntrypointTransformer(Function<EntrypointTransformer, List<EntrypointPatc\n \t}\n \n \tClassNode loadClass(FabricLauncher launcher, String className) throws IOException {\n-\t\tbyte[] data = patchedClasses.containsKey(className) ? patchedClasses.get(className) : launcher.getClassByteArray(className, false);", "originalCommit": "4525ea1ebd22b8c4b2f06cf33b728d657d730297", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDU0MDg2Mw==", "url": "https://github.com/FabricMC/fabric-loader/pull/288#discussion_r460540863", "bodyText": "It's not. The EntrypointTransformer is not an actual tranformer, i.e. it's never called in response to class loading. It's merely called during bootstrap, loads the bytecode, applies its patch and then stores the result in a map.\nThe real transformer merely queries that map, if it has an entry (and at this point it won't), it returns that and otherwise it just delegates further.", "author": "Johni0702", "createdAt": "2020-07-26T15:30:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDUzOTc1Ng=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njc5MzQ1Mg==", "url": "https://github.com/FabricMC/fabric-loader/pull/288#discussion_r466793452", "bodyText": "Hmm is there a reason specifically why we need to exclude the mod initializers?", "author": "i509VCB", "createdAt": "2020-08-07T02:58:22Z", "path": "src/main/java/net/fabricmc/loader/launch/FabricTweaker.java", "diffHunk": "@@ -88,13 +101,19 @@ public void injectIntoClassLoader(LaunchClassLoader launchClassLoader) {\n \n \t\tlaunchClassLoader.addClassLoaderExclusion(\"net.fabricmc.api.Environment\");\n \t\tlaunchClassLoader.addClassLoaderExclusion(\"net.fabricmc.api.EnvType\");\n+\t\tlaunchClassLoader.addClassLoaderExclusion(\"net.fabricmc.api.ModInitializer\");", "originalCommit": "4525ea1ebd22b8c4b2f06cf33b728d657d730297", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njg0Nzg2Mw==", "url": "https://github.com/FabricMC/fabric-loader/pull/288#discussion_r466847863", "bodyText": "Yes, it's explained in the commit message:\n\nThese interfaces are accessed from the Entrypoint* classes which themselves are\nexcluded from the LaunchClassLoader. Not excluding the interfaces will cause\nthose to be loaded by the LaunchClassLoader as well as its parent, leading to\ncasting errors when mod entry points are to be invoked.\n\n49f6f49", "author": "Johni0702", "createdAt": "2020-08-07T06:32:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njc5MzQ1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njg2MTY1OQ==", "url": "https://github.com/FabricMC/fabric-loader/pull/288#discussion_r466861659", "bodyText": "I see. I've let modmuss and player know about this PR so they can look into it since they have a better grasp on loader internals than I do", "author": "i509VCB", "createdAt": "2020-08-07T07:09:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njc5MzQ1Mg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTY2NDM0OQ==", "url": "https://github.com/FabricMC/fabric-loader/pull/288#discussion_r469664349", "bodyText": "Is it safe to call the black board at this point, I wonder", "author": "liach", "createdAt": "2020-08-13T02:45:04Z", "path": "src/main/java/net/fabricmc/loader/launch/FabricTweaker.java", "diffHunk": "@@ -24,30 +24,43 @@\n import net.fabricmc.loader.game.MinecraftGameProvider;\n import net.fabricmc.loader.launch.common.FabricLauncherBase;\n import net.fabricmc.loader.launch.common.FabricMixinBootstrap;\n+import net.fabricmc.loader.util.Arguments;\n import net.fabricmc.loader.util.UrlConversionException;\n import net.fabricmc.loader.util.UrlUtil;\n+import net.minecraft.launchwrapper.IClassTransformer;\n import net.minecraft.launchwrapper.ITweaker;\n import net.minecraft.launchwrapper.Launch;\n import net.minecraft.launchwrapper.LaunchClassLoader;\n import org.apache.logging.log4j.LogManager;\n import org.apache.logging.log4j.Logger;\n import org.spongepowered.asm.launch.MixinBootstrap;\n import org.spongepowered.asm.mixin.MixinEnvironment;\n+import org.spongepowered.asm.mixin.transformer.Proxy;\n \n+import java.io.ByteArrayOutputStream;\n import java.io.File;\n+import java.io.FileInputStream;\n import java.io.IOException;\n import java.io.InputStream;\n+import java.lang.reflect.Field;\n import java.net.JarURLConnection;\n import java.net.URL;\n+import java.nio.file.Path;\n import java.util.Collection;\n import java.util.List;\n+import java.util.Map;\n+import java.util.jar.JarEntry;\n+import java.util.jar.JarInputStream;\n \n public abstract class FabricTweaker extends FabricLauncherBase implements ITweaker {\n \tprotected static Logger LOGGER = LogManager.getFormatterLogger(\"Fabric|Tweaker\");\n-\tprotected String[] arguments;\n+\tprotected Arguments arguments;\n \tprivate LaunchClassLoader launchClassLoader;\n \tprivate boolean isDevelopment;\n \n+\t@SuppressWarnings(\"unchecked\")\n+\tprivate final boolean isPrimaryTweaker = ((List<ITweaker>) Launch.blackboard.get(\"Tweaks\")).isEmpty();", "originalCommit": "4525ea1ebd22b8c4b2f06cf33b728d657d730297", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTY3MTcyNA==", "url": "https://github.com/FabricMC/fabric-loader/pull/288#discussion_r479671724", "bodyText": "should be, it is a very basic primitive", "author": "sfPlayer1", "createdAt": "2020-08-29T17:31:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTY2NDM0OQ=="}], "type": "inlineReview", "revised_code": null}]}