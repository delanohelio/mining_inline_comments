{"pr_number": 1015, "pr_title": "Response Server - Fixed issue #1005", "pr_createdAt": "2020-09-23T05:21:10Z", "pr_url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1015", "timeline": [{"oid": "c7035d3988efd0db3c89ee122a3961ecff52847f", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/c7035d3988efd0db3c89ee122a3961ecff52847f", "message": "Fixed issue #1005\n\nFixed issue #1005", "committedDate": "2020-09-23T05:17:14Z", "type": "commit"}, {"oid": "bc9ab11a690c33c66899fb7ed03294cfadf55f8a", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/bc9ab11a690c33c66899fb7ed03294cfadf55f8a", "message": "changed index names\n\nchanged index names", "committedDate": "2020-09-23T06:55:52Z", "type": "commit"}, {"oid": "41b631f29df9fa2df1c4767e1dc15e07229db667", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/41b631f29df9fa2df1c4767e1dc15e07229db667", "message": "Fixed Build issue\n\nFixed Build issue", "committedDate": "2020-09-23T15:11:48Z", "type": "commit"}, {"oid": "957c5192510e90b55d97d16a89df88189ea8b31a", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/957c5192510e90b55d97d16a89df88189ea8b31a", "message": "Merge branch 'response-server-audit-log-events' into response-server-issue#1005", "committedDate": "2020-09-23T15:13:22Z", "type": "commit"}, {"oid": "c6d49fc525edcde5bed8da240be67e2ca3800aad", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/c6d49fc525edcde5bed8da240be67e2ca3800aad", "message": "Merge branch 'develop' into response-server-issue#1005", "committedDate": "2020-09-25T07:13:48Z", "type": "commit"}, {"oid": "f43197fbfb2f1983db6f0f6f170c942451f2c573", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/f43197fbfb2f1983db6f0f6f170c942451f2c573", "message": "removed participant_info_participant_identifier_idx as it is unique\n\nremoved participant_info_participant_identifier_idx as it is unique", "committedDate": "2020-09-25T09:33:14Z", "type": "commit"}, {"oid": "d34c070b9d5e82041d75d4c17e23232bb80e9d87", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/d34c070b9d5e82041d75d4c17e23232bb80e9d87", "message": "Merge branch 'develop' into response-server-issue#1005", "committedDate": "2020-09-25T10:04:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTAzNzkyNw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1015#discussion_r495037927", "bodyText": "shouldn't participantId be a foreign key?", "author": "zohrehj", "createdAt": "2020-09-25T14:45:00Z", "path": "response-server-module/response-server-service/src/main/java/com/google/cloud/healthcare/fdamystudies/model/ParticipantActivitiesBo.java", "diffHunk": "@@ -15,14 +15,22 @@\n import javax.persistence.GeneratedValue;\n import javax.persistence.GenerationType;\n import javax.persistence.Id;\n+import javax.persistence.Index;\n import javax.persistence.Table;\n import lombok.Getter;\n import lombok.Setter;\n \n @Setter\n @Getter\n @Entity\n-@Table(name = \"participant_activities\")\n+@Table(\n+    name = \"participant_activities\",\n+    indexes = {\n+      @Index(\n+          name = \"participant_activities_participant_identifier_idx\",", "originalCommit": "d34c070b9d5e82041d75d4c17e23232bb80e9d87", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU4NzIzMw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1015#discussion_r497587233", "bodyText": "participantId can not be a foreign key in Response Server. This value is coming from Mobile during [POST] /participant/update-activity-state api endpoint.", "author": "monica-BTC", "createdAt": "2020-09-30T15:08:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTAzNzkyNw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTAzOTA5OQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1015#discussion_r495039099", "bodyText": "if token needs to be unique, please add the unique annotation to it and see if that generates the index. If hibernate/SQL creates the index already (as I think MySQL would), then that is the preferred approach.", "author": "zohrehj", "createdAt": "2020-09-25T14:46:50Z", "path": "response-server-module/response-server-service/src/main/java/com/google/cloud/healthcare/fdamystudies/model/ParticipantBo.java", "diffHunk": "@@ -16,10 +16,18 @@\n import javax.persistence.GeneratedValue;\n import javax.persistence.GenerationType;\n import javax.persistence.Id;\n+import javax.persistence.Index;\n import javax.persistence.Table;\n \n @Entity\n-@Table(name = \"participant_info\")\n+@Table(\n+    name = \"participant_info\",\n+    indexes = {\n+      @Index(\n+          name = \"participant_info_token_identifier_idx\",\n+          columnList = \"token_identifier\",\n+          unique = true)", "originalCommit": "d34c070b9d5e82041d75d4c17e23232bb80e9d87", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU4NzI4MA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1015#discussion_r497587280", "bodyText": "Removed unique from participant_info_token_identifier_idx as discussed with the team. Token identifier may not be unique. It is a hashed version of a user's enrollment token. There is no requirement that the enrollment token is unique across studies. This means that if there is a possibility that the token is not unique", "author": "monica-BTC", "createdAt": "2020-09-30T15:08:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTAzOTA5OQ=="}], "type": "inlineReview", "revised_code": {"commit": "a121f3df8e88812effb7ea4e570a57e336982924", "chunk": "diff --git a/response-server-module/response-server-service/src/main/java/com/google/cloud/healthcare/fdamystudies/model/ParticipantBo.java b/response-server-module/response-server-service/src/main/java/com/google/cloud/healthcare/fdamystudies/response/model/ParticipantBo.java\nsimilarity index 92%\nrename from response-server-module/response-server-service/src/main/java/com/google/cloud/healthcare/fdamystudies/model/ParticipantBo.java\nrename to response-server-module/response-server-service/src/main/java/com/google/cloud/healthcare/fdamystudies/response/model/ParticipantBo.java\nindex 2f9b3ec81..6bebeb42f 100644\n--- a/response-server-module/response-server-service/src/main/java/com/google/cloud/healthcare/fdamystudies/model/ParticipantBo.java\n+++ b/response-server-module/response-server-service/src/main/java/com/google/cloud/healthcare/fdamystudies/response/model/ParticipantBo.java\n\n@@ -23,10 +23,7 @@ import javax.persistence.Table;\n @Table(\n     name = \"participant_info\",\n     indexes = {\n-      @Index(\n-          name = \"participant_info_token_identifier_idx\",\n-          columnList = \"token_identifier\",\n-          unique = true)\n+      @Index(name = \"participant_info_token_identifier_idx\", columnList = \"token_identifier\")\n     })\n public class ParticipantBo implements Serializable {\n \n"}}, {"oid": "667cc35840d20657c8887bf348d94c1c931a6a06", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/667cc35840d20657c8887bf348d94c1c931a6a06", "message": "Merge branch 'develop' into response-server-issue#1005", "committedDate": "2020-09-25T18:05:04Z", "type": "commit"}, {"oid": "0a02e1357745339bb10af17fc8687e83fb959e46", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/0a02e1357745339bb10af17fc8687e83fb959e46", "message": "Merge branch 'develop' into response-server-issue#1005", "committedDate": "2020-09-29T04:47:33Z", "type": "commit"}, {"oid": "a121f3df8e88812effb7ea4e570a57e336982924", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/a121f3df8e88812effb7ea4e570a57e336982924", "message": "removed unique from participant_info_token_identifier_idx index\n\nremoved unique from participant_info_token_identifier_idx index", "committedDate": "2020-09-30T15:06:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU4NjI3Ng==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1015#discussion_r497586276", "bodyText": "[response-server Checks] reported by reviewdog \ud83d\udc36\n'package' should be separated from previous statement.", "author": "github-actions", "createdAt": "2020-09-30T15:07:14Z", "path": "response-server-module/response-server-service/src/main/java/com/google/cloud/healthcare/fdamystudies/response/model/ParticipantActivity.java", "diffHunk": "@@ -5,7 +5,7 @@\n  * license that can be found in the LICENSE file or at\n  * https://opensource.org/licenses/MIT.\n  */\n-package com.google.cloud.healthcare.fdamystudies.model;\n+package com.google.cloud.healthcare.fdamystudies.response.model;", "originalCommit": "a121f3df8e88812effb7ea4e570a57e336982924", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzczMTkxMQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1015#discussion_r497731911", "bodyText": "please fix", "author": "zohrehj", "createdAt": "2020-09-30T18:56:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU4NjI3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODMzNzk3NQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1015#discussion_r498337975", "bodyText": "looks like you missed this comment", "author": "zohrehj", "createdAt": "2020-10-01T15:34:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU4NjI3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODM1MTczNA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1015#discussion_r498351734", "bodyText": "I have already fixed this, hence merging this PR.", "author": "monica-BTC", "createdAt": "2020-10-01T15:54:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU4NjI3Ng=="}], "type": "inlineReview", "revised_code": {"commit": "3eb86be9baceca92f640abe8abcbf575247e4e1c", "chunk": "diff --git a/response-server-module/response-server-service/src/main/java/com/google/cloud/healthcare/fdamystudies/response/model/ParticipantActivity.java b/response-server-module/response-server-service/src/main/java/com/google/cloud/healthcare/fdamystudies/response/model/ParticipantActivity.java\nindex 18ad6b836..68b5a65fc 100644\n--- a/response-server-module/response-server-service/src/main/java/com/google/cloud/healthcare/fdamystudies/response/model/ParticipantActivity.java\n+++ b/response-server-module/response-server-service/src/main/java/com/google/cloud/healthcare/fdamystudies/response/model/ParticipantActivity.java\n\n@@ -5,6 +5,7 @@\n  * license that can be found in the LICENSE file or at\n  * https://opensource.org/licenses/MIT.\n  */\n+\n package com.google.cloud.healthcare.fdamystudies.response.model;\n \n import javax.persistence.CascadeType;\n"}}, {"oid": "3eb86be9baceca92f640abe8abcbf575247e4e1c", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/3eb86be9baceca92f640abe8abcbf575247e4e1c", "message": "Fixed reviewdog comment\n\nFixed reviewdog comment", "committedDate": "2020-09-30T15:10:32Z", "type": "commit"}, {"oid": "1419ea122dd026e06c8267db694eb53cb1b1cfff", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/1419ea122dd026e06c8267db694eb53cb1b1cfff", "message": "Merge branch 'develop' into response-server-issue#1005", "committedDate": "2020-09-30T15:13:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzczMzU3NA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1015#discussion_r497733574", "bodyText": "since the token is not unique, most likely your query includes more than just the token_identifier; so it is possible that a composite index might be a better solution.\nPlease document the query you need this index for so that I can verify if this is the appropriate index for it.", "author": "zohrehj", "createdAt": "2020-09-30T18:59:35Z", "path": "response-server-module/response-server-service/src/main/java/com/google/cloud/healthcare/fdamystudies/response/model/ParticipantBo.java", "diffHunk": "@@ -16,10 +16,15 @@\n import javax.persistence.GeneratedValue;\n import javax.persistence.GenerationType;\n import javax.persistence.Id;\n+import javax.persistence.Index;\n import javax.persistence.Table;\n \n @Entity\n-@Table(name = \"participant_info\")\n+@Table(\n+    name = \"participant_info\",\n+    indexes = {\n+      @Index(name = \"participant_info_token_identifier_idx\", columnList = \"token_identifier\")", "originalCommit": "1419ea122dd026e06c8267db694eb53cb1b1cfff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODE3MTQyNA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1015#discussion_r498171424", "bodyText": "Yes I had missed that, in the query we are fetching based on participant_identifier and token_identifier. Now made it composite index. Please refer below code snippet\npredicate[0] =\n          builder.equal(\n              root.get(AppConstants.PARTICIPANT_TOKEN_IDENTIFIER_KEY),\n              participantBo.getTokenIdentifier());\n      predicate[1] =\n          builder.equal(\n              root.get(AppConstants.PARTICIPANT_IDENTIFIER_KEY),\n              participantBo.getParticipantIdentifier());\n      participantBoCriteria.select(root).where(predicate);", "author": "monica-BTC", "createdAt": "2020-10-01T11:25:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzczMzU3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODMzOTA1Nw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1015#discussion_r498339057", "bodyText": "looks good, thanks for the fix.", "author": "zohrehj", "createdAt": "2020-10-01T15:36:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzczMzU3NA=="}], "type": "inlineReview", "revised_code": {"commit": "08bf6245fa236b96714ddc6eafd0f599e26408d5", "chunk": "diff --git a/response-server-module/response-server-service/src/main/java/com/google/cloud/healthcare/fdamystudies/response/model/ParticipantBo.java b/response-server-module/response-server-service/src/main/java/com/google/cloud/healthcare/fdamystudies/response/model/ParticipantBo.java\nindex 6bebeb42f..5cd7bca78 100644\n--- a/response-server-module/response-server-service/src/main/java/com/google/cloud/healthcare/fdamystudies/response/model/ParticipantBo.java\n+++ b/response-server-module/response-server-service/src/main/java/com/google/cloud/healthcare/fdamystudies/response/model/ParticipantBo.java\n\n@@ -23,7 +23,9 @@ import javax.persistence.Table;\n @Table(\n     name = \"participant_info\",\n     indexes = {\n-      @Index(name = \"participant_info_token_identifier_idx\", columnList = \"token_identifier\")\n+      @Index(\n+          name = \"participant_info_token_identifier_participant_identifier_idx\",\n+          columnList = \"token_identifier,participant_identifier\")\n     })\n public class ParticipantBo implements Serializable {\n \n"}}, {"oid": "774fecb6933640be71edd25de82165156d96f5c7", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/774fecb6933640be71edd25de82165156d96f5c7", "message": "Merge branch 'develop' into response-server-issue#1005", "committedDate": "2020-10-01T08:14:24Z", "type": "commit"}, {"oid": "08bf6245fa236b96714ddc6eafd0f599e26408d5", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/08bf6245fa236b96714ddc6eafd0f599e26408d5", "message": "Fixed Review comments\n\nFixed Review comments", "committedDate": "2020-10-01T11:21:45Z", "type": "commit"}, {"oid": "5352b709383b1a078d333642855d24b3a4d5dc27", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/5352b709383b1a078d333642855d24b3a4d5dc27", "message": "Merge branch 'develop' into response-server-issue#1005", "committedDate": "2020-10-01T15:39:41Z", "type": "commit"}]}