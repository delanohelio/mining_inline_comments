{"pr_number": 640, "pr_title": "Enroll token validation for one time use and restrict usage to mapped participant", "pr_createdAt": "2020-07-15T08:29:52Z", "pr_url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/640", "timeline": [{"oid": "0e15285c90599bc33c38bd643c0db2802f3d20b4", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/0e15285c90599bc33c38bd643c0db2802f3d20b4", "message": "token validation for one time use and restrict usage against unmapped participant", "committedDate": "2020-07-15T08:26:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDg4Mjk2Mw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/640#discussion_r454882963", "bodyText": "[enroll-mgmt Checks] reported by reviewdog \ud83d\udc36\nWrong lexicographical order for 'com.google.cloud.healthcare.fdamystudies.model.UserDetailsBO' import. Should be before 'org.springframework.stereotype.Service'.", "author": "github-actions", "createdAt": "2020-07-15T08:30:43Z", "path": "user-registration-server-ws/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/service/EnrollmentTokenServiceImpl.java", "diffHunk": "@@ -9,15 +9,18 @@\n package com.google.cloud.healthcare.fdamystudies.service;\n \n import javax.validation.constraints.NotNull;\n+\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n import org.springframework.beans.factory.annotation.Autowired;\n import org.springframework.stereotype.Service;\n+\n import com.google.cloud.healthcare.fdamystudies.beans.EnrollmentResponseBean;\n import com.google.cloud.healthcare.fdamystudies.dao.EnrollmentTokenDao;\n import com.google.cloud.healthcare.fdamystudies.exception.InvalidRequestException;\n import com.google.cloud.healthcare.fdamystudies.exception.SystemException;\n import com.google.cloud.healthcare.fdamystudies.exception.UnAuthorizedRequestException;\n+import com.google.cloud.healthcare.fdamystudies.model.UserDetailsBO;", "originalCommit": "0e15285c90599bc33c38bd643c0db2802f3d20b4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d3d243b3abc194a650e207150f9c10fbaf5265e0", "chunk": "diff --git a/user-registration-server-ws/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/service/EnrollmentTokenServiceImpl.java b/user-registration-server-ws/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/service/EnrollmentTokenServiceImpl.java\nindex ef758944b..df9182a09 100644\n--- a/user-registration-server-ws/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/service/EnrollmentTokenServiceImpl.java\n+++ b/user-registration-server-ws/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/service/EnrollmentTokenServiceImpl.java\n\n@@ -8,13 +8,6 @@\n \n package com.google.cloud.healthcare.fdamystudies.service;\n \n-import javax.validation.constraints.NotNull;\n-\n-import org.slf4j.Logger;\n-import org.slf4j.LoggerFactory;\n-import org.springframework.beans.factory.annotation.Autowired;\n-import org.springframework.stereotype.Service;\n-\n import com.google.cloud.healthcare.fdamystudies.beans.EnrollmentResponseBean;\n import com.google.cloud.healthcare.fdamystudies.dao.EnrollmentTokenDao;\n import com.google.cloud.healthcare.fdamystudies.exception.InvalidRequestException;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDg4Mjk2NA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/640#discussion_r454882964", "bodyText": "[enroll-mgmt Checks] reported by reviewdog \ud83d\udc36\nLine is longer than 100 characters (found 137).", "author": "github-actions", "createdAt": "2020-07-15T08:30:43Z", "path": "user-registration-server-ws/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/dao/EnrollmentTokenDaoImpl.java", "diffHunk": "@@ -120,7 +125,7 @@ public boolean hasParticipant(@NotNull String studyId, @NotNull String tokenValu\n               .createQuery(\n                   \"from ParticipantStudiesBO PS,StudyInfoBO SB, ParticipantRegistrySite PR\"\n                       + \" where SB.id =PS.studyInfo.id and PS.participantRegistrySite.id=PR.id\"\n-                      + \" and PS.status='Enrolled' and PR.enrollmentToken=:token and SB.customId=:studyId\")\n+                      + \" and PS.status in ('Enrolled','Withdrawn','inProgress') and PR.enrollmentToken=:token and SB.customId=:studyId\")", "originalCommit": "0e15285c90599bc33c38bd643c0db2802f3d20b4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTIxNTIxNA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/640#discussion_r455215214", "bodyText": "please fix.", "author": "zohrehj", "createdAt": "2020-07-15T17:28:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDg4Mjk2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzA4NzAzNA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/640#discussion_r457087034", "bodyText": "resolved this linter issue", "author": "aswinijena100", "createdAt": "2020-07-20T06:16:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDg4Mjk2NA=="}], "type": "inlineReview", "revised_code": {"commit": "50e9cb0c5a4a48c0dade149c2d6ee31e71148290", "chunk": "diff --git a/user-registration-server-ws/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/dao/EnrollmentTokenDaoImpl.java b/user-registration-server-ws/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/dao/EnrollmentTokenDaoImpl.java\nindex 1ecfbaaff..e7f7113e2 100644\n--- a/user-registration-server-ws/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/dao/EnrollmentTokenDaoImpl.java\n+++ b/user-registration-server-ws/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/dao/EnrollmentTokenDaoImpl.java\n\n@@ -125,7 +125,8 @@ public class EnrollmentTokenDaoImpl implements EnrollmentTokenDao {\n               .createQuery(\n                   \"from ParticipantStudiesBO PS,StudyInfoBO SB, ParticipantRegistrySite PR\"\n                       + \" where SB.id =PS.studyInfo.id and PS.participantRegistrySite.id=PR.id\"\n-                      + \" and PS.status in ('Enrolled','Withdrawn','inProgress') and PR.enrollmentToken=:token and SB.customId=:studyId\")\n+                      + \" and PS.status in ('Enrolled','Withdrawn','inProgress') \"\n+                      + \"and PR.enrollmentToken=:token and SB.customId=:studyId\")\n               .setParameter(\"token\", tokenValue)\n               .setParameter(\"studyId\", studyId)\n               .getResultList();\n"}}, {"oid": "c1794f273ee1bad1268617b8c0ff1ca1e98aff7e", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/c1794f273ee1bad1268617b8c0ff1ca1e98aff7e", "message": "Update data.sql", "committedDate": "2020-07-15T08:48:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTIxNDAyOA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/640#discussion_r455214028", "bodyText": "nit: rename emailId to email", "author": "zohrehj", "createdAt": "2020-07-15T17:26:56Z", "path": "user-registration-server-ws/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/dao/EnrollmentTokenDao.java", "diffHunk": "@@ -19,7 +21,8 @@\n \n   public boolean hasParticipant(@NotNull String shortName, @NotNull String tokenValue);\n \n-  public boolean isValidStudyToken(@NotNull String token, @NotNull String shortName);\n+  public boolean isValidStudyToken(\n+      @NotNull String token, @NotNull String shortName, @NotNull String emailId);", "originalCommit": "c1794f273ee1bad1268617b8c0ff1ca1e98aff7e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzA4NjgyNQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/640#discussion_r457086825", "bodyText": "changed to email", "author": "aswinijena100", "createdAt": "2020-07-20T06:15:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTIxNDAyOA=="}], "type": "inlineReview", "revised_code": {"commit": "ebb08b1e0b0662f6d84d44499ceb623facd79f15", "chunk": "diff --git a/user-registration-server-ws/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/dao/EnrollmentTokenDao.java b/user-registration-server-ws/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/dao/EnrollmentTokenDao.java\nindex 1b069f118..5587236d0 100644\n--- a/user-registration-server-ws/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/dao/EnrollmentTokenDao.java\n+++ b/user-registration-server-ws/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/dao/EnrollmentTokenDao.java\n\n@@ -22,7 +22,7 @@ public interface EnrollmentTokenDao {\n   public boolean hasParticipant(@NotNull String shortName, @NotNull String tokenValue);\n \n   public boolean isValidStudyToken(\n-      @NotNull String token, @NotNull String shortName, @NotNull String emailId);\n+      @NotNull String token, @NotNull String shortName, @NotNull String email);\n \n   public boolean enrollmentTokenRequired(@NotNull String shortName);\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTIxNjczMA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/640#discussion_r455216730", "bodyText": "change to studyID similar to above. please name params consistently.", "author": "zohrehj", "createdAt": "2020-07-15T17:29:44Z", "path": "user-registration-server-ws/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/service/EnrollmentTokenService.java", "diffHunk": "@@ -21,7 +23,8 @@\n \n   public boolean hasParticipant(@NotNull String shortName, @NotNull String tokenValue);", "originalCommit": "c1794f273ee1bad1268617b8c0ff1ca1e98aff7e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzA4NzMxMQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/640#discussion_r457087311", "bodyText": "changed this to studyId to make it consistent", "author": "aswinijena100", "createdAt": "2020-07-20T06:16:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTIxNjczMA=="}], "type": "inlineReview", "revised_code": {"commit": "50e9cb0c5a4a48c0dade149c2d6ee31e71148290", "chunk": "diff --git a/user-registration-server-ws/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/service/EnrollmentTokenService.java b/user-registration-server-ws/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/service/EnrollmentTokenService.java\nindex 86f9394d5..d8f999aa1 100644\n--- a/user-registration-server-ws/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/service/EnrollmentTokenService.java\n+++ b/user-registration-server-ws/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/service/EnrollmentTokenService.java\n\n@@ -19,16 +19,16 @@ import com.google.cloud.healthcare.fdamystudies.exception.UnAuthorizedRequestExc\n \n public interface EnrollmentTokenService {\n \n-  public boolean studyExists(@NotNull String shortName);\n+  public boolean studyExists(@NotNull String studyId);\n \n-  public boolean hasParticipant(@NotNull String shortName, @NotNull String tokenValue);\n+  public boolean hasParticipant(@NotNull String studyId, @NotNull String tokenValue);\n \n-  public boolean isValidStudyToken(\n-      @NotNull String token, @NotNull String shortName, @NotNull String userId);\n+  public boolean isEnrollmentTokenValid(\n+      @NotNull String token, @NotNull String studyId, @NotNull String userId);\n \n-  public boolean enrollmentTokenRequired(@NotNull String shortName);\n+  public boolean enrollmentTokenRequired(@NotNull String studyId);\n \n   public EnrollmentResponseBean enrollParticipant(\n-      @NotNull String shortName, @Nullable String tokenValue, String userId)\n+      @NotNull String studyId, @Nullable String tokenValue, String userId)\n       throws SystemException, InvalidRequestException, UnAuthorizedRequestException;\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTIyNzIxMQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/640#discussion_r455227211", "bodyText": "this query assumes that a token is unique within the context of a study_id.\nI do not see that as a constraint in the database, please add it, otherwise your token validation would take other participants into account and fail to validate.", "author": "zohrehj", "createdAt": "2020-07-15T17:40:42Z", "path": "user-registration-server-ws/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/dao/EnrollmentTokenDaoImpl.java", "diffHunk": "@@ -120,7 +125,7 @@ public boolean hasParticipant(@NotNull String studyId, @NotNull String tokenValu\n               .createQuery(\n                   \"from ParticipantStudiesBO PS,StudyInfoBO SB, ParticipantRegistrySite PR\"\n                       + \" where SB.id =PS.studyInfo.id and PS.participantRegistrySite.id=PR.id\"\n-                      + \" and PS.status='Enrolled' and PR.enrollmentToken=:token and SB.customId=:studyId\")\n+                      + \" and PS.status in ('Enrolled','Withdrawn','inProgress') and PR.enrollmentToken=:token and SB.customId=:studyId\")", "originalCommit": "c1794f273ee1bad1268617b8c0ff1ca1e98aff7e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzA4ODEwMA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/640#discussion_r457088100", "bodyText": "As we discussed database constraints will be taken care as part of data integrity issue fixes.", "author": "aswinijena100", "createdAt": "2020-07-20T06:18:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTIyNzIxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQ2NTkyNA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/640#discussion_r457465924", "bodyText": "let's fix the ones you are working on when you have the context fresh in your mind. It will probably take less time.", "author": "zohrehj", "createdAt": "2020-07-20T14:58:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTIyNzIxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDQ4ODkwMg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/640#discussion_r474488902", "bodyText": "Added the fixes to this PR now along with test case modification to accommodate the data integrity checks", "author": "aswinijena100", "createdAt": "2020-08-21T07:52:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTIyNzIxMQ=="}], "type": "inlineReview", "revised_code": {"commit": "50e9cb0c5a4a48c0dade149c2d6ee31e71148290", "chunk": "diff --git a/user-registration-server-ws/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/dao/EnrollmentTokenDaoImpl.java b/user-registration-server-ws/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/dao/EnrollmentTokenDaoImpl.java\nindex 1ecfbaaff..e7f7113e2 100644\n--- a/user-registration-server-ws/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/dao/EnrollmentTokenDaoImpl.java\n+++ b/user-registration-server-ws/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/dao/EnrollmentTokenDaoImpl.java\n\n@@ -125,7 +125,8 @@ public class EnrollmentTokenDaoImpl implements EnrollmentTokenDao {\n               .createQuery(\n                   \"from ParticipantStudiesBO PS,StudyInfoBO SB, ParticipantRegistrySite PR\"\n                       + \" where SB.id =PS.studyInfo.id and PS.participantRegistrySite.id=PR.id\"\n-                      + \" and PS.status in ('Enrolled','Withdrawn','inProgress') and PR.enrollmentToken=:token and SB.customId=:studyId\")\n+                      + \" and PS.status in ('Enrolled','Withdrawn','inProgress') \"\n+                      + \"and PR.enrollmentToken=:token and SB.customId=:studyId\")\n               .setParameter(\"token\", tokenValue)\n               .setParameter(\"studyId\", studyId)\n               .getResultList();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTIyNzMwOQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/640#discussion_r455227309", "bodyText": "nit: isEnrollmentTokenValid\nYou are using the term studyToken frequently here, whereas the correct term should be enrollmentToken", "author": "zohrehj", "createdAt": "2020-07-15T17:40:49Z", "path": "user-registration-server-ws/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/service/EnrollmentTokenService.java", "diffHunk": "@@ -21,7 +23,8 @@\n \n   public boolean hasParticipant(@NotNull String shortName, @NotNull String tokenValue);\n \n-  public boolean isValidStudyToken(@NotNull String token, @NotNull String shortName);\n+  public boolean isValidStudyToken(", "originalCommit": "c1794f273ee1bad1268617b8c0ff1ca1e98aff7e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzA4ODI0OA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/640#discussion_r457088248", "bodyText": "changed it isEnrollmentTokenValid", "author": "aswinijena100", "createdAt": "2020-07-20T06:18:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTIyNzMwOQ=="}], "type": "inlineReview", "revised_code": {"commit": "50e9cb0c5a4a48c0dade149c2d6ee31e71148290", "chunk": "diff --git a/user-registration-server-ws/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/service/EnrollmentTokenService.java b/user-registration-server-ws/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/service/EnrollmentTokenService.java\nindex 86f9394d5..d8f999aa1 100644\n--- a/user-registration-server-ws/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/service/EnrollmentTokenService.java\n+++ b/user-registration-server-ws/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/service/EnrollmentTokenService.java\n\n@@ -19,16 +19,16 @@ import com.google.cloud.healthcare.fdamystudies.exception.UnAuthorizedRequestExc\n \n public interface EnrollmentTokenService {\n \n-  public boolean studyExists(@NotNull String shortName);\n+  public boolean studyExists(@NotNull String studyId);\n \n-  public boolean hasParticipant(@NotNull String shortName, @NotNull String tokenValue);\n+  public boolean hasParticipant(@NotNull String studyId, @NotNull String tokenValue);\n \n-  public boolean isValidStudyToken(\n-      @NotNull String token, @NotNull String shortName, @NotNull String userId);\n+  public boolean isEnrollmentTokenValid(\n+      @NotNull String token, @NotNull String studyId, @NotNull String userId);\n \n-  public boolean enrollmentTokenRequired(@NotNull String shortName);\n+  public boolean enrollmentTokenRequired(@NotNull String studyId);\n \n   public EnrollmentResponseBean enrollParticipant(\n-      @NotNull String shortName, @Nullable String tokenValue, String userId)\n+      @NotNull String studyId, @Nullable String tokenValue, String userId)\n       throws SystemException, InvalidRequestException, UnAuthorizedRequestException;\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTIzNDI0NA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/640#discussion_r455234244", "bodyText": "I am confused with this code, why are you checking for participants associated with a token? and looking at their status?\nDoesn't it make more sense to simply flag a token as used and/or remove it after the user has registered?", "author": "zohrehj", "createdAt": "2020-07-15T17:52:40Z", "path": "user-registration-server-ws/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/controller/EnrollmentTokenController.java", "diffHunk": "@@ -159,7 +161,7 @@ else if (enrollmentTokenfService.enrollmentTokenRequired(enrollmentBean.getStudy\n                     enrollmentBean.getStudyId(), enrollmentBean.getToken())) {\n                   if (enrollManagementUtil.isChecksumValid(enrollmentBean.getToken())) {\n                     if (enrollmentTokenfService.isValidStudyToken(\n-                        enrollmentBean.getToken(), enrollmentBean.getStudyId())) {\n+                        enrollmentBean.getToken(), enrollmentBean.getStudyId(), userId)) {", "originalCommit": "c1794f273ee1bad1268617b8c0ff1ca1e98aff7e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzA5MTAwMQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/640#discussion_r457091001", "bodyText": "In the current scope the token cannot be removed as response server referred these tokens.  And the reason we added this check is to restrict the token usage against mapped to email id only .", "author": "aswinijena100", "createdAt": "2020-07-20T06:23:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTIzNDI0NA=="}], "type": "inlineReview", "revised_code": {"commit": "50e9cb0c5a4a48c0dade149c2d6ee31e71148290", "chunk": "diff --git a/user-registration-server-ws/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/controller/EnrollmentTokenController.java b/user-registration-server-ws/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/controller/EnrollmentTokenController.java\nindex 2fc17e1af..133d0e163 100644\n--- a/user-registration-server-ws/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/controller/EnrollmentTokenController.java\n+++ b/user-registration-server-ws/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/controller/EnrollmentTokenController.java\n\n@@ -160,7 +160,7 @@ public class EnrollmentTokenController {\n                 if (!enrollmentTokenfService.hasParticipant(\n                     enrollmentBean.getStudyId(), enrollmentBean.getToken())) {\n                   if (enrollManagementUtil.isChecksumValid(enrollmentBean.getToken())) {\n-                    if (enrollmentTokenfService.isValidStudyToken(\n+                    if (enrollmentTokenfService.isEnrollmentTokenValid(\n                         enrollmentBean.getToken(), enrollmentBean.getStudyId(), userId)) {\n                       respBean =\n                           enrollmentTokenfService.enrollParticipant(\n"}}, {"oid": "ebb08b1e0b0662f6d84d44499ceb623facd79f15", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/ebb08b1e0b0662f6d84d44499ceb623facd79f15", "message": "renamed email variable", "committedDate": "2020-07-17T04:38:54Z", "type": "commit"}, {"oid": "bef7c9c564e0a88a6168e9f7fea854a57ed8baa0", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/bef7c9c564e0a88a6168e9f7fea854a57ed8baa0", "message": "Revert \"renamed email variable\"\n\nThis reverts commit ebb08b1e0b0662f6d84d44499ceb623facd79f15.", "committedDate": "2020-07-17T04:48:52Z", "type": "commit"}, {"oid": "50e9cb0c5a4a48c0dade149c2d6ee31e71148290", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/50e9cb0c5a4a48c0dade149c2d6ee31e71148290", "message": "review comment issue fixes", "committedDate": "2020-07-20T06:13:37Z", "type": "commit"}, {"oid": "ed344613d51ed0f9367f79d5e833e556f624bc57", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/ed344613d51ed0f9367f79d5e833e556f624bc57", "message": "Merge branch 'early-access' into early-access-token-validation-issue-fix", "committedDate": "2020-07-22T05:02:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTUzNjA1Mg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/640#discussion_r471536052", "bodyText": "remove the extra space between import. Please refer to the styleguide on how to format imports.", "author": "zohrehj", "createdAt": "2020-08-17T14:55:36Z", "path": "user-registration-server-ws/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/controller/EnrollmentTokenController.java", "diffHunk": "@@ -22,6 +23,7 @@\n import org.springframework.web.bind.annotation.RequestHeader;\n import org.springframework.web.bind.annotation.RequestMapping;\n import org.springframework.web.bind.annotation.RestController;\n+", "originalCommit": "ed344613d51ed0f9367f79d5e833e556f624bc57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDQ4OTA5Ng==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/640#discussion_r474489096", "bodyText": "Fix the format issue now", "author": "aswinijena100", "createdAt": "2020-08-21T07:52:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTUzNjA1Mg=="}], "type": "inlineReview", "revised_code": {"commit": "d3d243b3abc194a650e207150f9c10fbaf5265e0", "chunk": "diff --git a/user-registration-server-ws/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/controller/EnrollmentTokenController.java b/user-registration-server-ws/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/controller/EnrollmentTokenController.java\nindex 133d0e163..c4194e8ac 100644\n--- a/user-registration-server-ws/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/controller/EnrollmentTokenController.java\n+++ b/user-registration-server-ws/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/controller/EnrollmentTokenController.java\n\n@@ -8,22 +8,6 @@\n \n package com.google.cloud.healthcare.fdamystudies.controller;\n \n-import javax.servlet.http.HttpServletResponse;\n-import javax.ws.rs.core.Context;\n-\n-import org.slf4j.Logger;\n-import org.slf4j.LoggerFactory;\n-import org.springframework.beans.factory.annotation.Autowired;\n-import org.springframework.http.HttpStatus;\n-import org.springframework.http.MediaType;\n-import org.springframework.http.ResponseEntity;\n-import org.springframework.util.StringUtils;\n-import org.springframework.web.bind.annotation.PostMapping;\n-import org.springframework.web.bind.annotation.RequestBody;\n-import org.springframework.web.bind.annotation.RequestHeader;\n-import org.springframework.web.bind.annotation.RequestMapping;\n-import org.springframework.web.bind.annotation.RestController;\n-\n import com.google.cloud.healthcare.fdamystudies.beans.EnrollmentBean;\n import com.google.cloud.healthcare.fdamystudies.beans.EnrollmentResponseBean;\n import com.google.cloud.healthcare.fdamystudies.beans.ErrorBean;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTUzNjU3OA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/640#discussion_r471536578", "bodyText": "same here; please fox the format", "author": "zohrehj", "createdAt": "2020-08-17T14:56:21Z", "path": "user-registration-server-ws/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/dao/EnrollmentTokenDao.java", "diffHunk": "@@ -9,22 +9,25 @@\n package com.google.cloud.healthcare.fdamystudies.dao;\n \n import javax.validation.constraints.NotNull;\n+", "originalCommit": "ed344613d51ed0f9367f79d5e833e556f624bc57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDQ4OTIzOA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/640#discussion_r474489238", "bodyText": "fixed", "author": "aswinijena100", "createdAt": "2020-08-21T07:53:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTUzNjU3OA=="}], "type": "inlineReview", "revised_code": {"commit": "d3d243b3abc194a650e207150f9c10fbaf5265e0", "chunk": "diff --git a/user-registration-server-ws/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/dao/EnrollmentTokenDao.java b/user-registration-server-ws/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/dao/EnrollmentTokenDao.java\nindex ad03fa82d..195d977bf 100644\n--- a/user-registration-server-ws/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/dao/EnrollmentTokenDao.java\n+++ b/user-registration-server-ws/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/dao/EnrollmentTokenDao.java\n\n@@ -8,12 +8,10 @@\n \n package com.google.cloud.healthcare.fdamystudies.dao;\n \n-import javax.validation.constraints.NotNull;\n-\n-import org.springframework.lang.Nullable;\n-\n import com.google.cloud.healthcare.fdamystudies.beans.EnrollmentResponseBean;\n import com.google.cloud.healthcare.fdamystudies.model.UserDetailsBO;\n+import javax.validation.constraints.NotNull;\n+import org.springframework.lang.Nullable;\n \n public interface EnrollmentTokenDao {\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU1NjUxOA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/640#discussion_r471556518", "bodyText": "these values should be passed from the enum values, not hardcoded in the query.", "author": "zohrehj", "createdAt": "2020-08-17T15:26:01Z", "path": "user-registration-server-ws/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/dao/EnrollmentTokenDaoImpl.java", "diffHunk": "@@ -120,7 +125,8 @@ public boolean hasParticipant(@NotNull String studyId, @NotNull String tokenValu\n               .createQuery(\n                   \"from ParticipantStudiesBO PS,StudyInfoBO SB, ParticipantRegistrySite PR\"\n                       + \" where SB.id =PS.studyInfo.id and PS.participantRegistrySite.id=PR.id\"\n-                      + \" and PS.status='Enrolled' and PR.enrollmentToken=:token and SB.customId=:studyId\")\n+                      + \" and PS.status in ('Enrolled','Withdrawn','inProgress') \"", "originalCommit": "ed344613d51ed0f9367f79d5e833e556f624bc57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDQ5MTAzNQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/640#discussion_r474491035", "bodyText": "created a ParticipantStudyStateStatus.java enum class  and replaced in the hasParticipant() DAO method", "author": "aswinijena100", "createdAt": "2020-08-21T07:55:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU1NjUxOA=="}], "type": "inlineReview", "revised_code": {"commit": "d3d243b3abc194a650e207150f9c10fbaf5265e0", "chunk": "diff --git a/user-registration-server-ws/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/dao/EnrollmentTokenDaoImpl.java b/user-registration-server-ws/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/dao/EnrollmentTokenDaoImpl.java\nindex e7f7113e2..b53bc2a66 100644\n--- a/user-registration-server-ws/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/dao/EnrollmentTokenDaoImpl.java\n+++ b/user-registration-server-ws/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/dao/EnrollmentTokenDaoImpl.java\n\n@@ -120,13 +118,18 @@ public class EnrollmentTokenDaoImpl implements EnrollmentTokenDao {\n     List<Object[]> participantList = null;\n     boolean hasParticipant = false;\n     try (Session session = entityManagerFactory.unwrap(SessionFactory.class).openSession()) {\n+      List studyStateStatus = new ArrayList();\n+      studyStateStatus.add(ParticipantStudyStateStatus.ENROLLED.getValue());\n+      studyStateStatus.add(ParticipantStudyStateStatus.WITHDRAWN.getValue());\n+      studyStateStatus.add(ParticipantStudyStateStatus.INPROGRESS.getValue());\n       participantList =\n           session\n               .createQuery(\n                   \"from ParticipantStudiesBO PS,StudyInfoBO SB, ParticipantRegistrySite PR\"\n                       + \" where SB.id =PS.studyInfo.id and PS.participantRegistrySite.id=PR.id\"\n-                      + \" and PS.status in ('Enrolled','Withdrawn','inProgress') \"\n+                      + \" and PS.status in (:studyStateStatus) \"\n                       + \"and PR.enrollmentToken=:token and SB.customId=:studyId\")\n+              .setParameter(\"studyStateStatus\", studyStateStatus)\n               .setParameter(\"token\", tokenValue)\n               .setParameter(\"studyId\", studyId)\n               .getResultList();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU1NjY5Mw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/640#discussion_r471556693", "bodyText": "please fix the format.", "author": "zohrehj", "createdAt": "2020-08-17T15:26:17Z", "path": "user-registration-server-ws/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/service/EnrollmentTokenService.java", "diffHunk": "@@ -9,23 +9,26 @@\n package com.google.cloud.healthcare.fdamystudies.service;\n \n import javax.validation.constraints.NotNull;\n+", "originalCommit": "ed344613d51ed0f9367f79d5e833e556f624bc57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDQ5MTEzOA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/640#discussion_r474491138", "bodyText": "fixed", "author": "aswinijena100", "createdAt": "2020-08-21T07:55:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU1NjY5Mw=="}], "type": "inlineReview", "revised_code": {"commit": "d3d243b3abc194a650e207150f9c10fbaf5265e0", "chunk": "diff --git a/user-registration-server-ws/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/service/EnrollmentTokenService.java b/user-registration-server-ws/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/service/EnrollmentTokenService.java\nindex d8f999aa1..e285af56b 100644\n--- a/user-registration-server-ws/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/service/EnrollmentTokenService.java\n+++ b/user-registration-server-ws/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/service/EnrollmentTokenService.java\n\n@@ -8,14 +8,12 @@\n \n package com.google.cloud.healthcare.fdamystudies.service;\n \n-import javax.validation.constraints.NotNull;\n-\n-import org.springframework.lang.Nullable;\n-\n import com.google.cloud.healthcare.fdamystudies.beans.EnrollmentResponseBean;\n import com.google.cloud.healthcare.fdamystudies.exception.InvalidRequestException;\n import com.google.cloud.healthcare.fdamystudies.exception.SystemException;\n import com.google.cloud.healthcare.fdamystudies.exception.UnAuthorizedRequestException;\n+import javax.validation.constraints.NotNull;\n+import org.springframework.lang.Nullable;\n \n public interface EnrollmentTokenService {\n \n"}}, {"oid": "3875def823d0f424d9da36edf1d3074def377672", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/3875def823d0f424d9da36edf1d3074def377672", "message": "Merge branch 'early-access' into early-access-token-validation-issue-fix", "committedDate": "2020-08-20T12:37:59Z", "type": "commit"}, {"oid": "d3d243b3abc194a650e207150f9c10fbaf5265e0", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/d3d243b3abc194a650e207150f9c10fbaf5265e0", "message": "Review Comment issue fixes\n\nReview Comment issue fixes", "committedDate": "2020-08-21T07:48:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDczNTE1NA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/640#discussion_r474735154", "bodyText": "these are all the values for ParticpantStudyStateStatus, are we missing a value?\nIf not, maybe we don't need to filter by the status, if all status values are allowed", "author": "zohrehj", "createdAt": "2020-08-21T14:29:55Z", "path": "user-registration-server-ws/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/dao/EnrollmentTokenDaoImpl.java", "diffHunk": "@@ -115,12 +118,18 @@ public boolean hasParticipant(@NotNull String studyId, @NotNull String tokenValu\n     List<Object[]> participantList = null;\n     boolean hasParticipant = false;\n     try (Session session = entityManagerFactory.unwrap(SessionFactory.class).openSession()) {\n+      List studyStateStatus = new ArrayList();\n+      studyStateStatus.add(ParticipantStudyStateStatus.ENROLLED.getValue());\n+      studyStateStatus.add(ParticipantStudyStateStatus.WITHDRAWN.getValue());\n+      studyStateStatus.add(ParticipantStudyStateStatus.INPROGRESS.getValue());", "originalCommit": "d3d243b3abc194a650e207150f9c10fbaf5265e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTIwNDU3MQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/640#discussion_r475204571", "bodyText": "Yes, we have few more status like notEligible,yetToJoin,etc. But those are not required in the current scope, hence did not added. However I will add those values in enum and merge the code for future usage.", "author": "aswinijena100", "createdAt": "2020-08-23T10:55:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDczNTE1NA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "5c047c9e7324a25694ea27b13d4dfac8031846d1", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/5c047c9e7324a25694ea27b13d4dfac8031846d1", "message": "added few more status in enum classes\n\nadded few more status in enum classes", "committedDate": "2020-08-23T11:06:45Z", "type": "commit"}]}