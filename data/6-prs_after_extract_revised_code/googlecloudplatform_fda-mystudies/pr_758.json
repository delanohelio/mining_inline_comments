{"pr_number": 758, "pr_title": "OAuth Scim Service - login/consent/error UI implementation with client/server-side validations and exception handling", "pr_createdAt": "2020-08-17T11:32:46Z", "pr_url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/758", "timeline": [{"oid": "f99eba1be3b3294e90fabacc8d21860fd65a656c", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/f99eba1be3b3294e90fabacc8d21860fd65a656c", "message": "Implementation of login/consent with actual UI, validations and exception handling\n\nRemoved DevicePlatform and error redirect URLs,\nRenamed view name variables,\nImplemented server side validation", "committedDate": "2020-08-16T16:27:27Z", "type": "commit"}, {"oid": "461d3cdc8ad61a046806bd81bab118001084b265", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/461d3cdc8ad61a046806bd81bab118001084b265", "message": "Replace DevicePlatform with MobilePlatform, Added mobileDevice attribute to model\n\nReplace DevicePlatform with MobilePlatform, Added mobileDevice attribute to model", "committedDate": "2020-08-16T17:04:02Z", "type": "commit"}, {"oid": "edf1907cc913500d897d8dd0258acb44957c138d", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/edf1907cc913500d897d8dd0258acb44957c138d", "message": "Fixed test failures\n\nFixed test failures", "committedDate": "2020-08-16T17:22:15Z", "type": "commit"}, {"oid": "f853564b0b3e23e91ac08cfd5d7f5cf53c6e8988", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/f853564b0b3e23e91ac08cfd5d7f5cf53c6e8988", "message": "Updated logger statement and added @JsonInclude(Include.NON_NULL) in BaseResponse\n\nUpdated logger statement and added @JsonInclude(Include.NON_NULL) in BaseResponse", "committedDate": "2020-08-16T17:59:51Z", "type": "commit"}, {"oid": "8c0caabfdd209faa4f6a9eccaa16434fb90e9cd1", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/8c0caabfdd209faa4f6a9eccaa16434fb90e9cd1", "message": "Added grant_scope in request to get refresh token for authorization_code grant\n\nWhen accepting the consent request, offline_access must be in the list of grant_scope to get the refresh_token", "committedDate": "2020-08-16T18:23:00Z", "type": "commit"}, {"oid": "849c5fd0de21285a3ee91902d2ebf741dd31dea9", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/849c5fd0de21285a3ee91902d2ebf741dd31dea9", "message": "Added mystudies_ prefix to cookies, added comments to grantScopes and code formatting\n\nAdded mystudies_ prefix to cookies, added comments to grantScopes and code formatting", "committedDate": "2020-08-17T06:44:52Z", "type": "commit"}, {"oid": "6bdc1a68ea7dc1231295a63b957be23edcf87e17", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/6bdc1a68ea7dc1231295a63b957be23edcf87e17", "message": "fixed ui design review feedback\n\nfixed ui design review feedback", "committedDate": "2020-08-17T10:35:46Z", "type": "commit"}, {"oid": "3cb62c5e3019fe9839ede95bd5b28f5dd4f91094", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/3cb62c5e3019fe9839ede95bd5b28f5dd4f91094", "message": "Removed Loader.gif and Loader.svg\n\nRemoved Loader.gif and Loader.svg", "committedDate": "2020-08-17T11:05:32Z", "type": "commit"}, {"oid": "a2eb97d9f34e78f37c33b6fa3756962ad98fee4f", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/a2eb97d9f34e78f37c33b6fa3756962ad98fee4f", "message": "Added animated loader.svg and css classnames, updated cmn_error\n\nAdded animated loader.svg and css classnames, updated cmn_error", "committedDate": "2020-08-17T11:07:01Z", "type": "commit"}, {"oid": "729b1b6e861b7f96ec978d815fabf5cb9da85f95", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/729b1b6e861b7f96ec978d815fabf5cb9da85f95", "message": "added . to error description\n\nadded . to error description", "committedDate": "2020-08-17T11:12:04Z", "type": "commit"}, {"oid": "86d0dcf8dc50f8b765cede55a6690eaf5a2e6e5e", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/86d0dcf8dc50f8b765cede55a6690eaf5a2e6e5e", "message": "Removed unused imports\n\nRemoved unused imports", "committedDate": "2020-08-17T13:44:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU4MTE5MQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/758#discussion_r471581191", "bodyText": "nit: no need to enforce size in regex since you already have min and max specified.", "author": "zohrehj", "createdAt": "2020-08-17T16:02:48Z", "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/beans/LoginRequest.java", "diffHunk": "@@ -0,0 +1,38 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+\n+package com.google.cloud.healthcare.fdamystudies.oauthscim.beans;\n+\n+import javax.validation.constraints.Email;\n+import javax.validation.constraints.Pattern;\n+import javax.validation.constraints.Size;\n+import lombok.Getter;\n+import lombok.Setter;\n+import lombok.ToString;\n+\n+@Getter\n+@Setter\n+public class LoginRequest {\n+\n+  private static final String PASSWORD_REGEX =\n+      \"^(?=.*[0-9])(?=.*[a-z])(?=.*[A-Z])(?=.*[!\\\\\\\\\\\\\\\"#$%&'()*+,-.:;<=>?@\\\\\\\\\\\\\\\\[\\\\\\\\\\\\\\\\]^_`{|}~]).{8,64}$\";", "originalCommit": "86d0dcf8dc50f8b765cede55a6690eaf5a2e6e5e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU4NTcwMA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/758#discussion_r471585700", "bodyText": "It doesn't look like we are requiring spacial characters in the password here, which I thought was a requirement.\nAlso not sure why we are limiting the spacial characters that the user can use?\nwhy not just accept whatever they provide, and just enforce the min character?", "author": "zohrehj", "createdAt": "2020-08-17T16:10:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU4MTE5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYwMzc1MA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/758#discussion_r471603750", "bodyText": "I copied this regex from old auth server to keep the password requirement AS-IS. This regex is used in create account, change password and authentication, kindly a create an issue if the password requirements has changed so that I can fix it in all 3 places together.\nI noticed so many slash () added by STS when the regex is copy-pasted, fixed this.", "author": "dhanyak-btc", "createdAt": "2020-08-17T16:41:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU4MTE5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjE3MTQyMQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/758#discussion_r472171421", "bodyText": "requirement has not changed, my feedback is to simplify the regex:\n\ncombine the first three groups with [A-Za-z0-9] instead of specifying them separately\ninstead of listing spacial characters one by one, use a simpler logic, e.g, [^A-Za-z0-9] which is the negation of the alphanumeric characters.", "author": "zohrehj", "createdAt": "2020-08-18T13:03:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU4MTE5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjIyOTU1NQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/758#discussion_r472229555", "bodyText": "Created an issue #769", "author": "dhanyak-btc", "createdAt": "2020-08-18T14:14:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU4MTE5MQ=="}], "type": "inlineReview", "revised_code": {"commit": "c0dd35fbf290f01981c41d9969933b39b99dd305", "chunk": "diff --git a/oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/beans/LoginRequest.java b/oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/beans/LoginRequest.java\nindex 636d8208a..e9ef6322e 100644\n--- a/oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/beans/LoginRequest.java\n+++ b/oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/beans/LoginRequest.java\n\n@@ -20,7 +20,7 @@ import lombok.ToString;\n public class LoginRequest {\n \n   private static final String PASSWORD_REGEX =\n-      \"^(?=.*[0-9])(?=.*[a-z])(?=.*[A-Z])(?=.*[!\\\\\\\\\\\\\\\"#$%&'()*+,-.:;<=>?@\\\\\\\\\\\\\\\\[\\\\\\\\\\\\\\\\]^_`{|}~]).{8,64}$\";\n+      \"^(?=.*[0-9])(?=.*[a-z])(?=.*[A-Z])(?=.*[!\\\\\\\"#$%&'()*+,-.:;<=>?@\\\\[\\\\]^_`{|}~]).{8,64}$\";\n \n   @ToString.Exclude\n   @Size(max = 320)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU4NzEzNg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/758#discussion_r471587136", "bodyText": "this is not adding the cookie prefix, it is removing it form the name before adding the cookie; the opposite of what I was referring to.", "author": "zohrehj", "createdAt": "2020-08-17T16:12:30Z", "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/common/CookieHelper.java", "diffHunk": "@@ -20,10 +21,17 @@\n \n   @Autowired private AppPropertyConfig appConfig;\n \n+  private static final String COOKIE_PREFIX = \"mystudies_\";\n+\n   public void addCookies(\n       HttpServletResponse response, MultiValueMap<String, String> params, String... cookieNames) {\n+    String paramName = null;\n     for (String cookieName : cookieNames) {\n-      addCookie(response, cookieName, params.getFirst(cookieName));\n+      paramName =\n+          StringUtils.startsWith(cookieName, COOKIE_PREFIX)\n+              ? cookieName.substring(cookieName.indexOf('_') + 1)\n+              : cookieName;\n+      addCookie(response, cookieName, params.getFirst(paramName));", "originalCommit": "86d0dcf8dc50f8b765cede55a6690eaf5a2e6e5e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYwNTg5MA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/758#discussion_r471605890", "bodyText": "I added a prefix \"mystudies_\" to previously used cookie variables. I've tested this in browser cookies tab, prefix is present in all cookie names. cookieName sets the name with prefix, paramName gets the value from params map for cookie value.", "author": "dhanyak-btc", "createdAt": "2020-08-17T16:45:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU4NzEzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjE3Mzg4Ng==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/758#discussion_r472173886", "bodyText": "I see. I was expecting you to be adding the cookie prefix here, instead of at each method; but that woks too.", "author": "zohrehj", "createdAt": "2020-08-18T13:06:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU4NzEzNg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU4Nzg5OQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/758#discussion_r471587899", "bodyText": "please log error here", "author": "zohrehj", "createdAt": "2020-08-17T16:13:56Z", "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/service/HydraOAuthServiceImpl.java", "diffHunk": "@@ -86,27 +89,33 @@ public void init() {\n \n   public ResponseEntity<?> getToken(MultiValueMap<String, String> paramMap, HttpHeaders headers)\n       throws JsonProcessingException {\n+    logger.entry(String.format(\"getToken() for grant_type=%s\", paramMap.getFirst(GRANT_TYPE)));\n+\n     headers.add(CONTENT_TYPE, APPLICATION_X_WWW_FORM_URLENCODED_CHARSET_UTF_8);\n \n-    if (REFRESH_TOKEN.equals(paramMap.getFirst(GRANT_TYPE))) {\n+    String grantType = paramMap.getFirst(GRANT_TYPE);\n+    if (REFRESH_TOKEN.equals(grantType) || AUTHORIZATION_CODE.equals(grantType)) {\n       headers.set(AUTHORIZATION, encodedAuthorization);\n     }\n \n     HttpEntity<Object> requestEntity = new HttpEntity<>(paramMap, headers);\n     ResponseEntity<JsonNode> response =\n         getRestTemplate().postForEntity(tokenEndpoint, requestEntity, JsonNode.class);\n \n-    String grantType = paramMap.getFirst(GRANT_TYPE);\n     if ((REFRESH_TOKEN.equals(grantType) || AUTHORIZATION_CODE.equals(grantType))\n         && response.getBody().hasNonNull(REFRESH_TOKEN)) {\n       String refreshToken = getTextValue(response.getBody(), REFRESH_TOKEN);\n       UserResponse userResponse =\n           userService.revokeAndReplaceRefreshToken(paramMap.getFirst(USER_ID), refreshToken);\n       if (!HttpStatus.valueOf(userResponse.getHttpStatusCode()).is2xxSuccessful()) {\n+        logger.exit(", "originalCommit": "86d0dcf8dc50f8b765cede55a6690eaf5a2e6e5e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYwNjM2NQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/758#discussion_r471606365", "bodyText": "Fixed review comment.", "author": "dhanyak-btc", "createdAt": "2020-08-17T16:45:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU4Nzg5OQ=="}], "type": "inlineReview", "revised_code": {"commit": "c0dd35fbf290f01981c41d9969933b39b99dd305", "chunk": "diff --git a/oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/service/HydraOAuthServiceImpl.java b/oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/service/HydraOAuthServiceImpl.java\nindex 4c18abdae..4359eefca 100644\n--- a/oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/service/HydraOAuthServiceImpl.java\n+++ b/oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/service/HydraOAuthServiceImpl.java\n\n@@ -108,7 +108,7 @@ class HydraOAuthServiceImpl extends BaseServiceImpl implements OAuthService {\n       UserResponse userResponse =\n           userService.revokeAndReplaceRefreshToken(paramMap.getFirst(USER_ID), refreshToken);\n       if (!HttpStatus.valueOf(userResponse.getHttpStatusCode()).is2xxSuccessful()) {\n-        logger.exit(\n+        logger.error(\n             String.format(\n                 \"revokeAndReplaceRefreshToken error=%s\", userResponse.getErrorDescription()));\n         return ResponseEntity.status(userResponse.getHttpStatusCode()).body(userResponse);\n"}}, {"oid": "c0dd35fbf290f01981c41d9969933b39b99dd305", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/c0dd35fbf290f01981c41d9969933b39b99dd305", "message": "Fixed review comments - extracted javascript code from html files into js files", "committedDate": "2020-08-17T17:17:45Z", "type": "commit"}, {"oid": "611960495e711ec3c262172c8f2e5e038f8455fe", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/611960495e711ec3c262172c8f2e5e038f8455fe", "message": "Fixed review comment and added TODO for Issue 769\n\nFixed review comment and added TODO for Issue 769", "committedDate": "2020-08-18T14:15:23Z", "type": "commit"}, {"oid": "6c93f01c8cf1de7567ad329be5ca822ab3ca3df1", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/6c93f01c8cf1de7567ad329be5ca822ab3ca3df1", "message": "Merge branch 'develop' into oauth_scim_ui_with_validations", "committedDate": "2020-08-18T14:58:28Z", "type": "commit"}]}