{"pr_number": 420, "pr_title": "Android- Alarm issue ", "pr_createdAt": "2020-05-27T12:35:08Z", "pr_url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/420", "timeline": [{"oid": "e5c1ccbb18908ed1b302140e8c9008edaf10f335", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/e5c1ccbb18908ed1b302140e8c9008edaf10f335", "message": "Notification issue fix for #410", "committedDate": "2020-05-25T05:11:04Z", "type": "commit"}, {"oid": "7ba1cc830224e7f6ce12a9c0bcacf910a46b55c6", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/7ba1cc830224e7f6ce12a9c0bcacf910a46b55c6", "message": "notification issue fixes", "committedDate": "2020-05-27T12:29:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTE4NjkwMg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/420#discussion_r431186902", "bodyText": "This logic appears to be duplicated from NotificationModuleSubscriber. Please extract it to a common utility function.", "author": "nikklassen", "createdAt": "2020-05-27T14:36:57Z", "path": "Android/app/src/main/java/com/harvard/notificationmodule/AlarmReceiver.java", "diffHunk": "@@ -53,154 +57,222 @@\n \n   @Override\n   public void onReceive(Context context, Intent intent) {\n-    Intent notificationIntent1 = new Intent(context, NotificationActivity.class);\n-\n-    TaskStackBuilder stackBuilder = TaskStackBuilder.create(context);\n-    stackBuilder.addParentStack(NotificationActivity.class);\n-    stackBuilder.addNextIntent(notificationIntent1);\n-\n-    String title = intent.getStringExtra(\"title\");\n-    String description = intent.getStringExtra(\"description\");\n-    String type = intent.getStringExtra(\"type\");\n-    String studyId = null;\n-    if (intent.getStringExtra(\"studyId\") != null) {\n-      studyId = intent.getStringExtra(\"studyId\");\n-    }\n \n-    String activityId = null;\n-    if (intent.getStringExtra(\"activityId\") != null) {\n-      activityId = intent.getStringExtra(\"activityId\");\n+    int pendingIntentId = 0;\n+    try {\n+      pendingIntentId = intent.getIntExtra(\"pendingIntentId\", 0);\n+    } catch (Exception e) {\n+      Logger.log(e);\n     }\n+    if (pendingIntentId == 1) {\n+      Realm mRealm = AppController.getRealmobj(context);\n+      DBServiceSubscriber dbServiceSubscriber = new DBServiceSubscriber();\n+      RealmResults<NotificationDb> notificationDbs =\n+          dbServiceSubscriber.getNotificationDbByCurrentDate(mRealm);\n+      NotificationModuleSubscriber notificationModuleSubscriber =\n+          new NotificationModuleSubscriber(dbServiceSubscriber, mRealm);\n+      if (notificationDbs != null && notificationDbs.size() > 0) {\n+        for (int i = 0; i < notificationDbs.size(); i++) {\n+          Calendar time = Calendar.getInstance();\n+          time.setTime(notificationDbs.get(i).getDateTime());\n+          notificationModuleSubscriber.setAlarm(\n+              context,\n+              notificationDbs.get(i).getTitle(),\n+              notificationDbs.get(i).getDescription(),\n+              notificationDbs.get(i).getType(),\n+              notificationDbs.get(i).getNotificationId(),\n+              notificationDbs.get(i).getStudyId(),\n+              notificationDbs.get(i).getActivityId(),\n+              time);\n+        }\n+      }\n+      Calendar calendar = Calendar.getInstance();", "originalCommit": "7ba1cc830224e7f6ce12a9c0bcacf910a46b55c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjA0MjI2OA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/420#discussion_r432042268", "bodyText": "updated in the latest commit.", "author": "naveenr-btc", "createdAt": "2020-05-28T18:38:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTE4NjkwMg=="}], "type": "inlineReview", "revised_code": {"commit": "91ddd774b776e07458c06ec87cb1131b29069579", "chunk": "diff --git a/Android/app/src/main/java/com/harvard/notificationmodule/AlarmReceiver.java b/Android/app/src/main/java/com/harvard/notificationmodule/AlarmReceiver.java\nindex ddaff240d..749effcf9 100644\n--- a/Android/app/src/main/java/com/harvard/notificationmodule/AlarmReceiver.java\n+++ b/Android/app/src/main/java/com/harvard/notificationmodule/AlarmReceiver.java\n\n@@ -65,214 +67,227 @@ public class AlarmReceiver extends BroadcastReceiver {\n       Logger.log(e);\n     }\n     if (pendingIntentId == 1) {\n-      Realm mRealm = AppController.getRealmobj(context);\n-      DBServiceSubscriber dbServiceSubscriber = new DBServiceSubscriber();\n-      RealmResults<NotificationDb> notificationDbs =\n-          dbServiceSubscriber.getNotificationDbByCurrentDate(mRealm);\n-      NotificationModuleSubscriber notificationModuleSubscriber =\n-          new NotificationModuleSubscriber(dbServiceSubscriber, mRealm);\n-      if (notificationDbs != null && notificationDbs.size() > 0) {\n-        for (int i = 0; i < notificationDbs.size(); i++) {\n-          Calendar time = Calendar.getInstance();\n-          time.setTime(notificationDbs.get(i).getDateTime());\n-          notificationModuleSubscriber.setAlarm(\n-              context,\n-              notificationDbs.get(i).getTitle(),\n-              notificationDbs.get(i).getDescription(),\n-              notificationDbs.get(i).getType(),\n-              notificationDbs.get(i).getNotificationId(),\n-              notificationDbs.get(i).getStudyId(),\n-              notificationDbs.get(i).getActivityId(),\n-              time);\n-        }\n-      }\n-      Calendar calendar = Calendar.getInstance();\n-      calendar.set(Calendar.HOUR_OF_DAY, 0);\n-      calendar.set(Calendar.MINUTE, 0);\n-      calendar.set(Calendar.SECOND, 0);\n-      calendar.set(Calendar.MILLISECOND, 0);\n-      calendar.add(Calendar.DATE, 1);\n-\n-      try {\n-        Intent notificationIntent = new Intent(context, AlarmReceiver.class);\n-        notificationIntent.setAction(\"android.media.action.DISPLAY_NOTIFICATION\");\n-        notificationIntent.addCategory(\"android.intent.category.DEFAULT\");\n-        notificationIntent.putExtra(\"pendingIntentId\", 1);\n-        AlarmManager alarmManager = (AlarmManager) context.getSystemService(Context.ALARM_SERVICE);\n-        PendingIntent broadcast =\n-            PendingIntent.getBroadcast(\n-                context, 1, notificationIntent, PendingIntent.FLAG_UPDATE_CURRENT);\n-        try {\n-          if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {\n-            alarmManager.setExactAndAllowWhileIdle(\n-                AlarmManager.RTC_WAKEUP, calendar.getTimeInMillis(), broadcast);\n-          } else {\n-            alarmManager.setExact(AlarmManager.RTC_WAKEUP, calendar.getTimeInMillis(), broadcast);\n-          }\n-        } catch (NullPointerException e) {\n-          Logger.log(e);\n-        }\n-      } catch (Exception e) {\n-        Logger.log(e);\n-      }\n-\n-      try {\n-        dbServiceSubscriber.closeRealmObj(mRealm);\n-      } catch (Exception e) {\n-        Logger.log(e);\n-      }\n+      notificationForTodayAnd24HrAlarm(context);\n     } else {\n+      showLocalNotification(context, intent);\n+    }\n+  }\n \n-      Intent notificationIntent1 = new Intent(context, NotificationActivity.class);\n+  private void showLocalNotification(Context context, Intent intent) {\n+    Intent notificationIntent1 = new Intent(context, NotificationActivity.class);\n \n-      TaskStackBuilder stackBuilder = TaskStackBuilder.create(context);\n-      stackBuilder.addParentStack(NotificationActivity.class);\n-      stackBuilder.addNextIntent(notificationIntent1);\n+    TaskStackBuilder stackBuilder = TaskStackBuilder.create(context);\n+    stackBuilder.addParentStack(NotificationActivity.class);\n+    stackBuilder.addNextIntent(notificationIntent1);\n \n-      String title = intent.getStringExtra(\"title\");\n-      String description = intent.getStringExtra(\"description\");\n-      String type = intent.getStringExtra(\"type\");\n-      String studyId = null;\n-      if (intent.getStringExtra(\"studyId\") != null) {\n-        studyId = intent.getStringExtra(\"studyId\");\n-      }\n+    String title = intent.getStringExtra(\"title\");\n+    String description = intent.getStringExtra(\"description\");\n+    String type = intent.getStringExtra(\"type\");\n+    String studyId = null;\n+    if (intent.getStringExtra(\"studyId\") != null) {\n+      studyId = intent.getStringExtra(\"studyId\");\n+    }\n \n-      String activityId = null;\n-      if (intent.getStringExtra(\"activityId\") != null) {\n-        activityId = intent.getStringExtra(\"activityId\");\n-      }\n+    String activityId = null;\n+    if (intent.getStringExtra(\"activityId\") != null) {\n+      activityId = intent.getStringExtra(\"activityId\");\n+    }\n \n-      int notificationId = intent.getIntExtra(\"notificationId\", 0);\n+    int notificationId = intent.getIntExtra(\"notificationId\", 0);\n \n-      Intent notificationIntent;\n-      if (AppConfig.AppType.equalsIgnoreCase(context.getString(R.string.app_gateway))) {\n-        notificationIntent = new Intent(context, StudyActivity.class);\n+    Intent notificationIntent;\n+    if (AppConfig.AppType.equalsIgnoreCase(context.getString(R.string.app_gateway))) {\n+      notificationIntent = new Intent(context, StudyActivity.class);\n+    } else {\n+      notificationIntent = new Intent(context, StandaloneActivity.class);\n+    }\n+    PendingIntent contentIntent = null;\n+    if (!type.equalsIgnoreCase(NotificationModuleSubscriber.NO_USE_NOTIFICATION)) {\n+      notificationIntent.putExtra(StudyActivity.FROM, NOTIFICATION_INTENT);\n+\n+      notificationIntent.putExtra(TYPE, \"Study\");\n+      if (type.equalsIgnoreCase(\"resources\")) {\n+        notificationIntent.putExtra(SUBTYPE, \"Resource\");\n       } else {\n-        notificationIntent = new Intent(context, StandaloneActivity.class);\n+        notificationIntent.putExtra(SUBTYPE, \"Activity\");\n       }\n-      PendingIntent contentIntent = null;\n-      if (!type.equalsIgnoreCase(NotificationModuleSubscriber.NO_USE_NOTIFICATION)) {\n-        notificationIntent.putExtra(StudyActivity.FROM, NOTIFICATION_INTENT);\n+      notificationIntent\n+              .putExtra(STUDYID, studyId)\n+              .putExtra(ACTIVITYID, activityId)\n+              .putExtra(AUDIENCE, \"\")\n+              .putExtra(LOCAL_NOTIFICATION, \"true\")\n+              .putExtra(TITLE, title)\n+              .putExtra(MESSAGE, description)\n+              .setFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP | Intent.FLAG_ACTIVITY_SINGLE_TOP);\n+      contentIntent =\n+              PendingIntent.getActivity(\n+                      context, notificationId, notificationIntent, PendingIntent.FLAG_UPDATE_CURRENT);\n+    }\n \n-        notificationIntent.putExtra(TYPE, \"Study\");\n-        if (type.equalsIgnoreCase(\"resources\")) {\n-          notificationIntent.putExtra(SUBTYPE, \"Resource\");\n-        } else {\n-          notificationIntent.putExtra(SUBTYPE, \"Activity\");\n+    int notifyIcon = R.mipmap.ic_launcher;\n+    Bitmap icon = BitmapFactory.decodeResource(context.getResources(), notifyIcon);\n+    Notification notification = null;\n+    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.LOLLIPOP) {\n+      notification =\n+              createNotificationForLollipopAndAbove(\n+                      context, type, title, description, icon, contentIntent);\n+    } else {\n+      notification =\n+              createNotificationForBelowLollipop(context, type, title, description, contentIntent);\n+    }\n+\n+    try {\n+      int count =\n+              Integer.parseInt(\n+                      AppController.getHelperSharedPreference()\n+                              .readPreference(\n+                                      context,\n+                                      context.getResources().getString(R.string.notificationCount),\n+                                      \"0\"))\n+                      + 1;\n+      AppController.getHelperSharedPreference()\n+              .writePreference(\n+                      context, context.getResources().getString(R.string.notificationCount), \"\" + count);\n+      NotificationManagerCompat notificationManager = NotificationManagerCompat.from(context);\n+\n+      Realm mRealm = AppController.getRealmobj(context);\n+      DBServiceSubscriber dbServiceSubscriber = new DBServiceSubscriber();\n+      UserProfileData mUserProfileData = dbServiceSubscriber.getUserProfileData(mRealm);\n+      StudyList studyList = dbServiceSubscriber.getStudiesDetails(studyId, mRealm);\n+      boolean isNotification = true;\n+      if (mUserProfileData != null) {\n+        isNotification = mUserProfileData.getSettings().isLocalNotifications();\n+      }\n+      if (!studyList.getStatus().equalsIgnoreCase(\"paused\")\n+              && (isNotification\n+              || type.equalsIgnoreCase(\n+              NotificationModuleSubscriber.NOTIFICATION_TURN_OFF_NOTIFICATION))) {\n+        notificationManager.notify(count, notification);\n+        if (type.equalsIgnoreCase(\n+                NotificationModuleSubscriber.NOTIFICATION_TURN_OFF_NOTIFICATION)) {\n+          NotificationModuleSubscriber notificationModuleSubscriber =\n+                  new NotificationModuleSubscriber(dbServiceSubscriber, mRealm);\n+          notificationModuleSubscriber.generateNotificationTurnOffNotification(\n+                  Calendar.getInstance().getTime(), context);\n         }\n-        notificationIntent.putExtra(STUDYID, studyId);\n-        notificationIntent.putExtra(ACTIVITYID, activityId);\n-        notificationIntent.putExtra(AUDIENCE, \"\");\n-        notificationIntent.putExtra(LOCAL_NOTIFICATION, \"true\");\n-        notificationIntent.putExtra(TITLE, title);\n-        notificationIntent.putExtra(MESSAGE, description);\n-        notificationIntent.setFlags(\n-            Intent.FLAG_ACTIVITY_CLEAR_TOP | Intent.FLAG_ACTIVITY_SINGLE_TOP);\n-        contentIntent =\n-            PendingIntent.getActivity(\n-                context, notificationId, notificationIntent, PendingIntent.FLAG_UPDATE_CURRENT);\n       }\n \n-      int notifyIcon = R.mipmap.ic_launcher;\n-      Bitmap icon = BitmapFactory.decodeResource(context.getResources(), notifyIcon);\n-      NotificationCompat.Builder builder = new NotificationCompat.Builder(context);\n-      Notification notification = null;\n-      if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.LOLLIPOP) {\n-        if (type.equalsIgnoreCase(NotificationModuleSubscriber.NO_USE_NOTIFICATION)) {\n-          notification =\n+      dbServiceSubscriber.closeRealmObj(mRealm);\n+    } catch (NumberFormatException | Resources.NotFoundException e) {\n+      Logger.log(e);\n+    } catch (Exception e) {\n+      Logger.log(e);\n+    }\n+  }\n+\n+  private Notification createNotificationForBelowLollipop(\n+          Context context, String type, String title, String description, PendingIntent contentIntent) {\n+    NotificationCompat.Builder builder = new NotificationCompat.Builder(context);\n+    Notification notification;\n+    if (type.equalsIgnoreCase(NotificationModuleSubscriber.NO_USE_NOTIFICATION)) {\n+      notification =\n               builder\n-                  .setContentTitle(title)\n-                  .setLargeIcon(Bitmap.createScaledBitmap(icon, 128, 128, false))\n-                  .setContentText(description)\n-                  .setChannelId(FDAApplication.NOTIFICATION_CHANNEL_ID_INFO)\n-                  .setStyle(new NotificationCompat.BigTextStyle().bigText(description))\n-                  .setSmallIcon(R.mipmap.ic_launcher)\n-                  .setAutoCancel(true)\n-                  .setGroup(\"group\")\n-                  .build();\n-        } else {\n-          notification =\n+                      .setContentTitle(title)\n+                      .setContentText(description)\n+                      .setChannelId(FDAApplication.NOTIFICATION_CHANNEL_ID_INFO)\n+                      .setStyle(new NotificationCompat.BigTextStyle().bigText(description))\n+                      .setSmallIcon(R.mipmap.ic_launcher)\n+                      .setAutoCancel(true)\n+                      .setGroup(\"group\")\n+                      .build();\n+    } else {\n+      notification =\n               builder\n-                  .setContentTitle(title)\n-                  .setLargeIcon(Bitmap.createScaledBitmap(icon, 128, 128, false))\n-                  .setContentText(description)\n-                  .setChannelId(FDAApplication.NOTIFICATION_CHANNEL_ID_INFO)\n-                  .setStyle(new NotificationCompat.BigTextStyle().bigText(description))\n-                  .setSmallIcon(R.mipmap.ic_launcher)\n-                  .setAutoCancel(true)\n-                  .setContentIntent(contentIntent)\n-                  .setGroup(\"group\")\n-                  .build();\n-        }\n-      } else {\n-        if (type.equalsIgnoreCase(NotificationModuleSubscriber.NO_USE_NOTIFICATION)) {\n-          notification =\n+                      .setContentTitle(title)\n+                      .setContentText(description)\n+                      .setChannelId(FDAApplication.NOTIFICATION_CHANNEL_ID_INFO)\n+                      .setStyle(new NotificationCompat.BigTextStyle().bigText(description))\n+                      .setSmallIcon(R.mipmap.ic_launcher)\n+                      .setAutoCancel(true)\n+                      .setContentIntent(contentIntent)\n+                      .setGroup(\"group\")\n+                      .build();\n+    }\n+    return notification;\n+  }\n+\n+  private Notification createNotificationForLollipopAndAbove(\n+          Context context,\n+          String type,\n+          String title,\n+          String description,\n+          Bitmap icon,\n+          PendingIntent contentIntent) {\n+    NotificationCompat.Builder builder = new NotificationCompat.Builder(context);\n+    Notification notification;\n+    if (type.equalsIgnoreCase(NotificationModuleSubscriber.NO_USE_NOTIFICATION)) {\n+      notification =\n               builder\n-                  .setContentTitle(title)\n-                  .setContentText(description)\n-                  .setChannelId(FDAApplication.NOTIFICATION_CHANNEL_ID_INFO)\n-                  .setStyle(new NotificationCompat.BigTextStyle().bigText(description))\n-                  .setSmallIcon(R.mipmap.ic_launcher)\n-                  .setAutoCancel(true)\n-                  .setGroup(\"group\")\n-                  .build();\n-        } else {\n-          notification =\n+                      .setContentTitle(title)\n+                      .setLargeIcon(Bitmap.createScaledBitmap(icon, 128, 128, false))\n+                      .setContentText(description)\n+                      .setChannelId(FDAApplication.NOTIFICATION_CHANNEL_ID_INFO)\n+                      .setStyle(new NotificationCompat.BigTextStyle().bigText(description))\n+                      .setSmallIcon(R.mipmap.ic_launcher)\n+                      .setAutoCancel(true)\n+                      .setGroup(\"group\")\n+                      .build();\n+    } else {\n+      notification =\n               builder\n-                  .setContentTitle(title)\n-                  .setContentText(description)\n-                  .setChannelId(FDAApplication.NOTIFICATION_CHANNEL_ID_INFO)\n-                  .setStyle(new NotificationCompat.BigTextStyle().bigText(description))\n-                  .setSmallIcon(R.mipmap.ic_launcher)\n-                  .setAutoCancel(true)\n-                  .setContentIntent(contentIntent)\n-                  .setGroup(\"group\")\n-                  .build();\n-        }\n-      }\n-\n-      try {\n-        int count =\n-            Integer.parseInt(\n-                    AppController.getHelperSharedPreference()\n-                        .readPreference(\n-                            context,\n-                            context.getResources().getString(R.string.notificationCount),\n-                            \"0\"))\n-                + 1;\n-        AppController.getHelperSharedPreference()\n-            .writePreference(\n-                context, context.getResources().getString(R.string.notificationCount), \"\" + count);\n-        NotificationManagerCompat notificationManager = NotificationManagerCompat.from(context);\n-\n-        Realm mRealm = AppController.getRealmobj(context);\n-        DBServiceSubscriber dbServiceSubscriber = new DBServiceSubscriber();\n-        UserProfileData mUserProfileData = dbServiceSubscriber.getUserProfileData(mRealm);\n-        StudyList studyList = dbServiceSubscriber.getStudiesDetails(studyId, mRealm);\n-        boolean isNotification = true;\n-        if (mUserProfileData != null) {\n-          isNotification = mUserProfileData.getSettings().isLocalNotifications();\n-        }\n-        if (!studyList.getStatus().equalsIgnoreCase(\"paused\")\n-            && (isNotification\n-                || type.equalsIgnoreCase(\n-                    NotificationModuleSubscriber.NOTIFICATION_TURN_OFF_NOTIFICATION))) {\n-          notificationManager.notify(count, notification);\n-          if (type.equalsIgnoreCase(\n-              NotificationModuleSubscriber.NOTIFICATION_TURN_OFF_NOTIFICATION)) {\n-            NotificationModuleSubscriber notificationModuleSubscriber =\n-                new NotificationModuleSubscriber(dbServiceSubscriber, mRealm);\n-            notificationModuleSubscriber.generateNotificationTurnOffNotification(\n-                Calendar.getInstance().getTime(), context);\n-          }\n-        }\n+                      .setContentTitle(title)\n+                      .setLargeIcon(Bitmap.createScaledBitmap(icon, 128, 128, false))\n+                      .setContentText(description)\n+                      .setChannelId(FDAApplication.NOTIFICATION_CHANNEL_ID_INFO)\n+                      .setStyle(new NotificationCompat.BigTextStyle().bigText(description))\n+                      .setSmallIcon(R.mipmap.ic_launcher)\n+                      .setAutoCancel(true)\n+                      .setContentIntent(contentIntent)\n+                      .setGroup(\"group\")\n+                      .build();\n+    }\n+    return notification;\n+  }\n \n-        dbServiceSubscriber.closeRealmObj(mRealm);\n-      } catch (NumberFormatException | Resources.NotFoundException e) {\n-        Logger.log(e);\n-      } catch (Exception e) {\n-        Logger.log(e);\n+  private void notificationForTodayAnd24HrAlarm(Context context) {\n+    Realm mRealm = AppController.getRealmobj(context);\n+    DBServiceSubscriber dbServiceSubscriber = new DBServiceSubscriber();\n+    RealmResults<NotificationDb> notificationDbs =\n+            dbServiceSubscriber.getNotificationDbByCurrentDate(mRealm);\n+    NotificationModuleSubscriber notificationModuleSubscriber =\n+            new NotificationModuleSubscriber(dbServiceSubscriber, mRealm);\n+    if (notificationDbs != null) {\n+      for (NotificationDb notificationDb : notificationDbs) {\n+        Calendar time = Calendar.getInstance();\n+        time.setTime(notificationDb.getDateTime());\n+        notificationModuleSubscriber.setAlarm(\n+                context,\n+                notificationDb.getTitle(),\n+                notificationDb.getDescription(),\n+                notificationDb.getType(),\n+                notificationDb.getNotificationId(),\n+                notificationDb.getStudyId(),\n+                notificationDb.getActivityId(),\n+                time);\n       }\n     }\n+    Calendar calendar = NotificationModuleSubscriber.getCalenderNextDay();\n+\n+    Intent notificationIntent =\n+            new Intent(context, AlarmReceiver.class)\n+                    .setAction(\"android.media.action.DISPLAY_NOTIFICATION\")\n+                    .addCategory(\"android.intent.category.DEFAULT\")\n+                    .putExtra(\"pendingIntentId\", 1);\n+    AlarmManager alarmManager = (AlarmManager) context.getSystemService(Context.ALARM_SERVICE);\n+    PendingIntent broadcast =\n+            PendingIntent.getBroadcast(\n+                    context, 1, notificationIntent, PendingIntent.FLAG_UPDATE_CURRENT);\n+    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {\n+      alarmManager.setExactAndAllowWhileIdle(\n+              AlarmManager.RTC_WAKEUP, calendar.getTimeInMillis(), broadcast);\n+    } else {\n+      alarmManager.setExact(AlarmManager.RTC_WAKEUP, calendar.getTimeInMillis(), broadcast);\n+    }\n+    dbServiceSubscriber.closeRealmObj(mRealm);\n   }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTE4NzY1Ng==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/420#discussion_r431187656", "bodyText": "Use foreach instead", "author": "nikklassen", "createdAt": "2020-05-27T14:37:42Z", "path": "Android/app/src/main/java/com/harvard/notificationmodule/AlarmReceiver.java", "diffHunk": "@@ -53,154 +57,222 @@\n \n   @Override\n   public void onReceive(Context context, Intent intent) {\n-    Intent notificationIntent1 = new Intent(context, NotificationActivity.class);\n-\n-    TaskStackBuilder stackBuilder = TaskStackBuilder.create(context);\n-    stackBuilder.addParentStack(NotificationActivity.class);\n-    stackBuilder.addNextIntent(notificationIntent1);\n-\n-    String title = intent.getStringExtra(\"title\");\n-    String description = intent.getStringExtra(\"description\");\n-    String type = intent.getStringExtra(\"type\");\n-    String studyId = null;\n-    if (intent.getStringExtra(\"studyId\") != null) {\n-      studyId = intent.getStringExtra(\"studyId\");\n-    }\n \n-    String activityId = null;\n-    if (intent.getStringExtra(\"activityId\") != null) {\n-      activityId = intent.getStringExtra(\"activityId\");\n+    int pendingIntentId = 0;\n+    try {\n+      pendingIntentId = intent.getIntExtra(\"pendingIntentId\", 0);\n+    } catch (Exception e) {\n+      Logger.log(e);\n     }\n+    if (pendingIntentId == 1) {\n+      Realm mRealm = AppController.getRealmobj(context);\n+      DBServiceSubscriber dbServiceSubscriber = new DBServiceSubscriber();\n+      RealmResults<NotificationDb> notificationDbs =\n+          dbServiceSubscriber.getNotificationDbByCurrentDate(mRealm);\n+      NotificationModuleSubscriber notificationModuleSubscriber =\n+          new NotificationModuleSubscriber(dbServiceSubscriber, mRealm);\n+      if (notificationDbs != null && notificationDbs.size() > 0) {\n+        for (int i = 0; i < notificationDbs.size(); i++) {", "originalCommit": "7ba1cc830224e7f6ce12a9c0bcacf910a46b55c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjA0MjM0Mg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/420#discussion_r432042342", "bodyText": "updated in the latest commit.", "author": "naveenr-btc", "createdAt": "2020-05-28T18:38:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTE4NzY1Ng=="}], "type": "inlineReview", "revised_code": {"commit": "91ddd774b776e07458c06ec87cb1131b29069579", "chunk": "diff --git a/Android/app/src/main/java/com/harvard/notificationmodule/AlarmReceiver.java b/Android/app/src/main/java/com/harvard/notificationmodule/AlarmReceiver.java\nindex ddaff240d..749effcf9 100644\n--- a/Android/app/src/main/java/com/harvard/notificationmodule/AlarmReceiver.java\n+++ b/Android/app/src/main/java/com/harvard/notificationmodule/AlarmReceiver.java\n\n@@ -65,214 +67,227 @@ public class AlarmReceiver extends BroadcastReceiver {\n       Logger.log(e);\n     }\n     if (pendingIntentId == 1) {\n-      Realm mRealm = AppController.getRealmobj(context);\n-      DBServiceSubscriber dbServiceSubscriber = new DBServiceSubscriber();\n-      RealmResults<NotificationDb> notificationDbs =\n-          dbServiceSubscriber.getNotificationDbByCurrentDate(mRealm);\n-      NotificationModuleSubscriber notificationModuleSubscriber =\n-          new NotificationModuleSubscriber(dbServiceSubscriber, mRealm);\n-      if (notificationDbs != null && notificationDbs.size() > 0) {\n-        for (int i = 0; i < notificationDbs.size(); i++) {\n-          Calendar time = Calendar.getInstance();\n-          time.setTime(notificationDbs.get(i).getDateTime());\n-          notificationModuleSubscriber.setAlarm(\n-              context,\n-              notificationDbs.get(i).getTitle(),\n-              notificationDbs.get(i).getDescription(),\n-              notificationDbs.get(i).getType(),\n-              notificationDbs.get(i).getNotificationId(),\n-              notificationDbs.get(i).getStudyId(),\n-              notificationDbs.get(i).getActivityId(),\n-              time);\n-        }\n-      }\n-      Calendar calendar = Calendar.getInstance();\n-      calendar.set(Calendar.HOUR_OF_DAY, 0);\n-      calendar.set(Calendar.MINUTE, 0);\n-      calendar.set(Calendar.SECOND, 0);\n-      calendar.set(Calendar.MILLISECOND, 0);\n-      calendar.add(Calendar.DATE, 1);\n-\n-      try {\n-        Intent notificationIntent = new Intent(context, AlarmReceiver.class);\n-        notificationIntent.setAction(\"android.media.action.DISPLAY_NOTIFICATION\");\n-        notificationIntent.addCategory(\"android.intent.category.DEFAULT\");\n-        notificationIntent.putExtra(\"pendingIntentId\", 1);\n-        AlarmManager alarmManager = (AlarmManager) context.getSystemService(Context.ALARM_SERVICE);\n-        PendingIntent broadcast =\n-            PendingIntent.getBroadcast(\n-                context, 1, notificationIntent, PendingIntent.FLAG_UPDATE_CURRENT);\n-        try {\n-          if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {\n-            alarmManager.setExactAndAllowWhileIdle(\n-                AlarmManager.RTC_WAKEUP, calendar.getTimeInMillis(), broadcast);\n-          } else {\n-            alarmManager.setExact(AlarmManager.RTC_WAKEUP, calendar.getTimeInMillis(), broadcast);\n-          }\n-        } catch (NullPointerException e) {\n-          Logger.log(e);\n-        }\n-      } catch (Exception e) {\n-        Logger.log(e);\n-      }\n-\n-      try {\n-        dbServiceSubscriber.closeRealmObj(mRealm);\n-      } catch (Exception e) {\n-        Logger.log(e);\n-      }\n+      notificationForTodayAnd24HrAlarm(context);\n     } else {\n+      showLocalNotification(context, intent);\n+    }\n+  }\n \n-      Intent notificationIntent1 = new Intent(context, NotificationActivity.class);\n+  private void showLocalNotification(Context context, Intent intent) {\n+    Intent notificationIntent1 = new Intent(context, NotificationActivity.class);\n \n-      TaskStackBuilder stackBuilder = TaskStackBuilder.create(context);\n-      stackBuilder.addParentStack(NotificationActivity.class);\n-      stackBuilder.addNextIntent(notificationIntent1);\n+    TaskStackBuilder stackBuilder = TaskStackBuilder.create(context);\n+    stackBuilder.addParentStack(NotificationActivity.class);\n+    stackBuilder.addNextIntent(notificationIntent1);\n \n-      String title = intent.getStringExtra(\"title\");\n-      String description = intent.getStringExtra(\"description\");\n-      String type = intent.getStringExtra(\"type\");\n-      String studyId = null;\n-      if (intent.getStringExtra(\"studyId\") != null) {\n-        studyId = intent.getStringExtra(\"studyId\");\n-      }\n+    String title = intent.getStringExtra(\"title\");\n+    String description = intent.getStringExtra(\"description\");\n+    String type = intent.getStringExtra(\"type\");\n+    String studyId = null;\n+    if (intent.getStringExtra(\"studyId\") != null) {\n+      studyId = intent.getStringExtra(\"studyId\");\n+    }\n \n-      String activityId = null;\n-      if (intent.getStringExtra(\"activityId\") != null) {\n-        activityId = intent.getStringExtra(\"activityId\");\n-      }\n+    String activityId = null;\n+    if (intent.getStringExtra(\"activityId\") != null) {\n+      activityId = intent.getStringExtra(\"activityId\");\n+    }\n \n-      int notificationId = intent.getIntExtra(\"notificationId\", 0);\n+    int notificationId = intent.getIntExtra(\"notificationId\", 0);\n \n-      Intent notificationIntent;\n-      if (AppConfig.AppType.equalsIgnoreCase(context.getString(R.string.app_gateway))) {\n-        notificationIntent = new Intent(context, StudyActivity.class);\n+    Intent notificationIntent;\n+    if (AppConfig.AppType.equalsIgnoreCase(context.getString(R.string.app_gateway))) {\n+      notificationIntent = new Intent(context, StudyActivity.class);\n+    } else {\n+      notificationIntent = new Intent(context, StandaloneActivity.class);\n+    }\n+    PendingIntent contentIntent = null;\n+    if (!type.equalsIgnoreCase(NotificationModuleSubscriber.NO_USE_NOTIFICATION)) {\n+      notificationIntent.putExtra(StudyActivity.FROM, NOTIFICATION_INTENT);\n+\n+      notificationIntent.putExtra(TYPE, \"Study\");\n+      if (type.equalsIgnoreCase(\"resources\")) {\n+        notificationIntent.putExtra(SUBTYPE, \"Resource\");\n       } else {\n-        notificationIntent = new Intent(context, StandaloneActivity.class);\n+        notificationIntent.putExtra(SUBTYPE, \"Activity\");\n       }\n-      PendingIntent contentIntent = null;\n-      if (!type.equalsIgnoreCase(NotificationModuleSubscriber.NO_USE_NOTIFICATION)) {\n-        notificationIntent.putExtra(StudyActivity.FROM, NOTIFICATION_INTENT);\n+      notificationIntent\n+              .putExtra(STUDYID, studyId)\n+              .putExtra(ACTIVITYID, activityId)\n+              .putExtra(AUDIENCE, \"\")\n+              .putExtra(LOCAL_NOTIFICATION, \"true\")\n+              .putExtra(TITLE, title)\n+              .putExtra(MESSAGE, description)\n+              .setFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP | Intent.FLAG_ACTIVITY_SINGLE_TOP);\n+      contentIntent =\n+              PendingIntent.getActivity(\n+                      context, notificationId, notificationIntent, PendingIntent.FLAG_UPDATE_CURRENT);\n+    }\n \n-        notificationIntent.putExtra(TYPE, \"Study\");\n-        if (type.equalsIgnoreCase(\"resources\")) {\n-          notificationIntent.putExtra(SUBTYPE, \"Resource\");\n-        } else {\n-          notificationIntent.putExtra(SUBTYPE, \"Activity\");\n+    int notifyIcon = R.mipmap.ic_launcher;\n+    Bitmap icon = BitmapFactory.decodeResource(context.getResources(), notifyIcon);\n+    Notification notification = null;\n+    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.LOLLIPOP) {\n+      notification =\n+              createNotificationForLollipopAndAbove(\n+                      context, type, title, description, icon, contentIntent);\n+    } else {\n+      notification =\n+              createNotificationForBelowLollipop(context, type, title, description, contentIntent);\n+    }\n+\n+    try {\n+      int count =\n+              Integer.parseInt(\n+                      AppController.getHelperSharedPreference()\n+                              .readPreference(\n+                                      context,\n+                                      context.getResources().getString(R.string.notificationCount),\n+                                      \"0\"))\n+                      + 1;\n+      AppController.getHelperSharedPreference()\n+              .writePreference(\n+                      context, context.getResources().getString(R.string.notificationCount), \"\" + count);\n+      NotificationManagerCompat notificationManager = NotificationManagerCompat.from(context);\n+\n+      Realm mRealm = AppController.getRealmobj(context);\n+      DBServiceSubscriber dbServiceSubscriber = new DBServiceSubscriber();\n+      UserProfileData mUserProfileData = dbServiceSubscriber.getUserProfileData(mRealm);\n+      StudyList studyList = dbServiceSubscriber.getStudiesDetails(studyId, mRealm);\n+      boolean isNotification = true;\n+      if (mUserProfileData != null) {\n+        isNotification = mUserProfileData.getSettings().isLocalNotifications();\n+      }\n+      if (!studyList.getStatus().equalsIgnoreCase(\"paused\")\n+              && (isNotification\n+              || type.equalsIgnoreCase(\n+              NotificationModuleSubscriber.NOTIFICATION_TURN_OFF_NOTIFICATION))) {\n+        notificationManager.notify(count, notification);\n+        if (type.equalsIgnoreCase(\n+                NotificationModuleSubscriber.NOTIFICATION_TURN_OFF_NOTIFICATION)) {\n+          NotificationModuleSubscriber notificationModuleSubscriber =\n+                  new NotificationModuleSubscriber(dbServiceSubscriber, mRealm);\n+          notificationModuleSubscriber.generateNotificationTurnOffNotification(\n+                  Calendar.getInstance().getTime(), context);\n         }\n-        notificationIntent.putExtra(STUDYID, studyId);\n-        notificationIntent.putExtra(ACTIVITYID, activityId);\n-        notificationIntent.putExtra(AUDIENCE, \"\");\n-        notificationIntent.putExtra(LOCAL_NOTIFICATION, \"true\");\n-        notificationIntent.putExtra(TITLE, title);\n-        notificationIntent.putExtra(MESSAGE, description);\n-        notificationIntent.setFlags(\n-            Intent.FLAG_ACTIVITY_CLEAR_TOP | Intent.FLAG_ACTIVITY_SINGLE_TOP);\n-        contentIntent =\n-            PendingIntent.getActivity(\n-                context, notificationId, notificationIntent, PendingIntent.FLAG_UPDATE_CURRENT);\n       }\n \n-      int notifyIcon = R.mipmap.ic_launcher;\n-      Bitmap icon = BitmapFactory.decodeResource(context.getResources(), notifyIcon);\n-      NotificationCompat.Builder builder = new NotificationCompat.Builder(context);\n-      Notification notification = null;\n-      if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.LOLLIPOP) {\n-        if (type.equalsIgnoreCase(NotificationModuleSubscriber.NO_USE_NOTIFICATION)) {\n-          notification =\n+      dbServiceSubscriber.closeRealmObj(mRealm);\n+    } catch (NumberFormatException | Resources.NotFoundException e) {\n+      Logger.log(e);\n+    } catch (Exception e) {\n+      Logger.log(e);\n+    }\n+  }\n+\n+  private Notification createNotificationForBelowLollipop(\n+          Context context, String type, String title, String description, PendingIntent contentIntent) {\n+    NotificationCompat.Builder builder = new NotificationCompat.Builder(context);\n+    Notification notification;\n+    if (type.equalsIgnoreCase(NotificationModuleSubscriber.NO_USE_NOTIFICATION)) {\n+      notification =\n               builder\n-                  .setContentTitle(title)\n-                  .setLargeIcon(Bitmap.createScaledBitmap(icon, 128, 128, false))\n-                  .setContentText(description)\n-                  .setChannelId(FDAApplication.NOTIFICATION_CHANNEL_ID_INFO)\n-                  .setStyle(new NotificationCompat.BigTextStyle().bigText(description))\n-                  .setSmallIcon(R.mipmap.ic_launcher)\n-                  .setAutoCancel(true)\n-                  .setGroup(\"group\")\n-                  .build();\n-        } else {\n-          notification =\n+                      .setContentTitle(title)\n+                      .setContentText(description)\n+                      .setChannelId(FDAApplication.NOTIFICATION_CHANNEL_ID_INFO)\n+                      .setStyle(new NotificationCompat.BigTextStyle().bigText(description))\n+                      .setSmallIcon(R.mipmap.ic_launcher)\n+                      .setAutoCancel(true)\n+                      .setGroup(\"group\")\n+                      .build();\n+    } else {\n+      notification =\n               builder\n-                  .setContentTitle(title)\n-                  .setLargeIcon(Bitmap.createScaledBitmap(icon, 128, 128, false))\n-                  .setContentText(description)\n-                  .setChannelId(FDAApplication.NOTIFICATION_CHANNEL_ID_INFO)\n-                  .setStyle(new NotificationCompat.BigTextStyle().bigText(description))\n-                  .setSmallIcon(R.mipmap.ic_launcher)\n-                  .setAutoCancel(true)\n-                  .setContentIntent(contentIntent)\n-                  .setGroup(\"group\")\n-                  .build();\n-        }\n-      } else {\n-        if (type.equalsIgnoreCase(NotificationModuleSubscriber.NO_USE_NOTIFICATION)) {\n-          notification =\n+                      .setContentTitle(title)\n+                      .setContentText(description)\n+                      .setChannelId(FDAApplication.NOTIFICATION_CHANNEL_ID_INFO)\n+                      .setStyle(new NotificationCompat.BigTextStyle().bigText(description))\n+                      .setSmallIcon(R.mipmap.ic_launcher)\n+                      .setAutoCancel(true)\n+                      .setContentIntent(contentIntent)\n+                      .setGroup(\"group\")\n+                      .build();\n+    }\n+    return notification;\n+  }\n+\n+  private Notification createNotificationForLollipopAndAbove(\n+          Context context,\n+          String type,\n+          String title,\n+          String description,\n+          Bitmap icon,\n+          PendingIntent contentIntent) {\n+    NotificationCompat.Builder builder = new NotificationCompat.Builder(context);\n+    Notification notification;\n+    if (type.equalsIgnoreCase(NotificationModuleSubscriber.NO_USE_NOTIFICATION)) {\n+      notification =\n               builder\n-                  .setContentTitle(title)\n-                  .setContentText(description)\n-                  .setChannelId(FDAApplication.NOTIFICATION_CHANNEL_ID_INFO)\n-                  .setStyle(new NotificationCompat.BigTextStyle().bigText(description))\n-                  .setSmallIcon(R.mipmap.ic_launcher)\n-                  .setAutoCancel(true)\n-                  .setGroup(\"group\")\n-                  .build();\n-        } else {\n-          notification =\n+                      .setContentTitle(title)\n+                      .setLargeIcon(Bitmap.createScaledBitmap(icon, 128, 128, false))\n+                      .setContentText(description)\n+                      .setChannelId(FDAApplication.NOTIFICATION_CHANNEL_ID_INFO)\n+                      .setStyle(new NotificationCompat.BigTextStyle().bigText(description))\n+                      .setSmallIcon(R.mipmap.ic_launcher)\n+                      .setAutoCancel(true)\n+                      .setGroup(\"group\")\n+                      .build();\n+    } else {\n+      notification =\n               builder\n-                  .setContentTitle(title)\n-                  .setContentText(description)\n-                  .setChannelId(FDAApplication.NOTIFICATION_CHANNEL_ID_INFO)\n-                  .setStyle(new NotificationCompat.BigTextStyle().bigText(description))\n-                  .setSmallIcon(R.mipmap.ic_launcher)\n-                  .setAutoCancel(true)\n-                  .setContentIntent(contentIntent)\n-                  .setGroup(\"group\")\n-                  .build();\n-        }\n-      }\n-\n-      try {\n-        int count =\n-            Integer.parseInt(\n-                    AppController.getHelperSharedPreference()\n-                        .readPreference(\n-                            context,\n-                            context.getResources().getString(R.string.notificationCount),\n-                            \"0\"))\n-                + 1;\n-        AppController.getHelperSharedPreference()\n-            .writePreference(\n-                context, context.getResources().getString(R.string.notificationCount), \"\" + count);\n-        NotificationManagerCompat notificationManager = NotificationManagerCompat.from(context);\n-\n-        Realm mRealm = AppController.getRealmobj(context);\n-        DBServiceSubscriber dbServiceSubscriber = new DBServiceSubscriber();\n-        UserProfileData mUserProfileData = dbServiceSubscriber.getUserProfileData(mRealm);\n-        StudyList studyList = dbServiceSubscriber.getStudiesDetails(studyId, mRealm);\n-        boolean isNotification = true;\n-        if (mUserProfileData != null) {\n-          isNotification = mUserProfileData.getSettings().isLocalNotifications();\n-        }\n-        if (!studyList.getStatus().equalsIgnoreCase(\"paused\")\n-            && (isNotification\n-                || type.equalsIgnoreCase(\n-                    NotificationModuleSubscriber.NOTIFICATION_TURN_OFF_NOTIFICATION))) {\n-          notificationManager.notify(count, notification);\n-          if (type.equalsIgnoreCase(\n-              NotificationModuleSubscriber.NOTIFICATION_TURN_OFF_NOTIFICATION)) {\n-            NotificationModuleSubscriber notificationModuleSubscriber =\n-                new NotificationModuleSubscriber(dbServiceSubscriber, mRealm);\n-            notificationModuleSubscriber.generateNotificationTurnOffNotification(\n-                Calendar.getInstance().getTime(), context);\n-          }\n-        }\n+                      .setContentTitle(title)\n+                      .setLargeIcon(Bitmap.createScaledBitmap(icon, 128, 128, false))\n+                      .setContentText(description)\n+                      .setChannelId(FDAApplication.NOTIFICATION_CHANNEL_ID_INFO)\n+                      .setStyle(new NotificationCompat.BigTextStyle().bigText(description))\n+                      .setSmallIcon(R.mipmap.ic_launcher)\n+                      .setAutoCancel(true)\n+                      .setContentIntent(contentIntent)\n+                      .setGroup(\"group\")\n+                      .build();\n+    }\n+    return notification;\n+  }\n \n-        dbServiceSubscriber.closeRealmObj(mRealm);\n-      } catch (NumberFormatException | Resources.NotFoundException e) {\n-        Logger.log(e);\n-      } catch (Exception e) {\n-        Logger.log(e);\n+  private void notificationForTodayAnd24HrAlarm(Context context) {\n+    Realm mRealm = AppController.getRealmobj(context);\n+    DBServiceSubscriber dbServiceSubscriber = new DBServiceSubscriber();\n+    RealmResults<NotificationDb> notificationDbs =\n+            dbServiceSubscriber.getNotificationDbByCurrentDate(mRealm);\n+    NotificationModuleSubscriber notificationModuleSubscriber =\n+            new NotificationModuleSubscriber(dbServiceSubscriber, mRealm);\n+    if (notificationDbs != null) {\n+      for (NotificationDb notificationDb : notificationDbs) {\n+        Calendar time = Calendar.getInstance();\n+        time.setTime(notificationDb.getDateTime());\n+        notificationModuleSubscriber.setAlarm(\n+                context,\n+                notificationDb.getTitle(),\n+                notificationDb.getDescription(),\n+                notificationDb.getType(),\n+                notificationDb.getNotificationId(),\n+                notificationDb.getStudyId(),\n+                notificationDb.getActivityId(),\n+                time);\n       }\n     }\n+    Calendar calendar = NotificationModuleSubscriber.getCalenderNextDay();\n+\n+    Intent notificationIntent =\n+            new Intent(context, AlarmReceiver.class)\n+                    .setAction(\"android.media.action.DISPLAY_NOTIFICATION\")\n+                    .addCategory(\"android.intent.category.DEFAULT\")\n+                    .putExtra(\"pendingIntentId\", 1);\n+    AlarmManager alarmManager = (AlarmManager) context.getSystemService(Context.ALARM_SERVICE);\n+    PendingIntent broadcast =\n+            PendingIntent.getBroadcast(\n+                    context, 1, notificationIntent, PendingIntent.FLAG_UPDATE_CURRENT);\n+    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {\n+      alarmManager.setExactAndAllowWhileIdle(\n+              AlarmManager.RTC_WAKEUP, calendar.getTimeInMillis(), broadcast);\n+    } else {\n+      alarmManager.setExact(AlarmManager.RTC_WAKEUP, calendar.getTimeInMillis(), broadcast);\n+    }\n+    dbServiceSubscriber.closeRealmObj(mRealm);\n   }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTE4OTI1Nw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/420#discussion_r431189257", "bodyText": "Size check is unnecessary when iterating through a list.", "author": "nikklassen", "createdAt": "2020-05-27T14:39:37Z", "path": "Android/app/src/main/java/com/harvard/notificationmodule/AlarmReceiver.java", "diffHunk": "@@ -53,154 +57,222 @@\n \n   @Override\n   public void onReceive(Context context, Intent intent) {\n-    Intent notificationIntent1 = new Intent(context, NotificationActivity.class);\n-\n-    TaskStackBuilder stackBuilder = TaskStackBuilder.create(context);\n-    stackBuilder.addParentStack(NotificationActivity.class);\n-    stackBuilder.addNextIntent(notificationIntent1);\n-\n-    String title = intent.getStringExtra(\"title\");\n-    String description = intent.getStringExtra(\"description\");\n-    String type = intent.getStringExtra(\"type\");\n-    String studyId = null;\n-    if (intent.getStringExtra(\"studyId\") != null) {\n-      studyId = intent.getStringExtra(\"studyId\");\n-    }\n \n-    String activityId = null;\n-    if (intent.getStringExtra(\"activityId\") != null) {\n-      activityId = intent.getStringExtra(\"activityId\");\n+    int pendingIntentId = 0;\n+    try {\n+      pendingIntentId = intent.getIntExtra(\"pendingIntentId\", 0);\n+    } catch (Exception e) {\n+      Logger.log(e);\n     }\n+    if (pendingIntentId == 1) {\n+      Realm mRealm = AppController.getRealmobj(context);\n+      DBServiceSubscriber dbServiceSubscriber = new DBServiceSubscriber();\n+      RealmResults<NotificationDb> notificationDbs =\n+          dbServiceSubscriber.getNotificationDbByCurrentDate(mRealm);\n+      NotificationModuleSubscriber notificationModuleSubscriber =\n+          new NotificationModuleSubscriber(dbServiceSubscriber, mRealm);\n+      if (notificationDbs != null && notificationDbs.size() > 0) {", "originalCommit": "7ba1cc830224e7f6ce12a9c0bcacf910a46b55c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjA0MjQwMw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/420#discussion_r432042403", "bodyText": "updated in the latest commit.", "author": "naveenr-btc", "createdAt": "2020-05-28T18:38:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTE4OTI1Nw=="}], "type": "inlineReview", "revised_code": {"commit": "91ddd774b776e07458c06ec87cb1131b29069579", "chunk": "diff --git a/Android/app/src/main/java/com/harvard/notificationmodule/AlarmReceiver.java b/Android/app/src/main/java/com/harvard/notificationmodule/AlarmReceiver.java\nindex ddaff240d..749effcf9 100644\n--- a/Android/app/src/main/java/com/harvard/notificationmodule/AlarmReceiver.java\n+++ b/Android/app/src/main/java/com/harvard/notificationmodule/AlarmReceiver.java\n\n@@ -65,214 +67,227 @@ public class AlarmReceiver extends BroadcastReceiver {\n       Logger.log(e);\n     }\n     if (pendingIntentId == 1) {\n-      Realm mRealm = AppController.getRealmobj(context);\n-      DBServiceSubscriber dbServiceSubscriber = new DBServiceSubscriber();\n-      RealmResults<NotificationDb> notificationDbs =\n-          dbServiceSubscriber.getNotificationDbByCurrentDate(mRealm);\n-      NotificationModuleSubscriber notificationModuleSubscriber =\n-          new NotificationModuleSubscriber(dbServiceSubscriber, mRealm);\n-      if (notificationDbs != null && notificationDbs.size() > 0) {\n-        for (int i = 0; i < notificationDbs.size(); i++) {\n-          Calendar time = Calendar.getInstance();\n-          time.setTime(notificationDbs.get(i).getDateTime());\n-          notificationModuleSubscriber.setAlarm(\n-              context,\n-              notificationDbs.get(i).getTitle(),\n-              notificationDbs.get(i).getDescription(),\n-              notificationDbs.get(i).getType(),\n-              notificationDbs.get(i).getNotificationId(),\n-              notificationDbs.get(i).getStudyId(),\n-              notificationDbs.get(i).getActivityId(),\n-              time);\n-        }\n-      }\n-      Calendar calendar = Calendar.getInstance();\n-      calendar.set(Calendar.HOUR_OF_DAY, 0);\n-      calendar.set(Calendar.MINUTE, 0);\n-      calendar.set(Calendar.SECOND, 0);\n-      calendar.set(Calendar.MILLISECOND, 0);\n-      calendar.add(Calendar.DATE, 1);\n-\n-      try {\n-        Intent notificationIntent = new Intent(context, AlarmReceiver.class);\n-        notificationIntent.setAction(\"android.media.action.DISPLAY_NOTIFICATION\");\n-        notificationIntent.addCategory(\"android.intent.category.DEFAULT\");\n-        notificationIntent.putExtra(\"pendingIntentId\", 1);\n-        AlarmManager alarmManager = (AlarmManager) context.getSystemService(Context.ALARM_SERVICE);\n-        PendingIntent broadcast =\n-            PendingIntent.getBroadcast(\n-                context, 1, notificationIntent, PendingIntent.FLAG_UPDATE_CURRENT);\n-        try {\n-          if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {\n-            alarmManager.setExactAndAllowWhileIdle(\n-                AlarmManager.RTC_WAKEUP, calendar.getTimeInMillis(), broadcast);\n-          } else {\n-            alarmManager.setExact(AlarmManager.RTC_WAKEUP, calendar.getTimeInMillis(), broadcast);\n-          }\n-        } catch (NullPointerException e) {\n-          Logger.log(e);\n-        }\n-      } catch (Exception e) {\n-        Logger.log(e);\n-      }\n-\n-      try {\n-        dbServiceSubscriber.closeRealmObj(mRealm);\n-      } catch (Exception e) {\n-        Logger.log(e);\n-      }\n+      notificationForTodayAnd24HrAlarm(context);\n     } else {\n+      showLocalNotification(context, intent);\n+    }\n+  }\n \n-      Intent notificationIntent1 = new Intent(context, NotificationActivity.class);\n+  private void showLocalNotification(Context context, Intent intent) {\n+    Intent notificationIntent1 = new Intent(context, NotificationActivity.class);\n \n-      TaskStackBuilder stackBuilder = TaskStackBuilder.create(context);\n-      stackBuilder.addParentStack(NotificationActivity.class);\n-      stackBuilder.addNextIntent(notificationIntent1);\n+    TaskStackBuilder stackBuilder = TaskStackBuilder.create(context);\n+    stackBuilder.addParentStack(NotificationActivity.class);\n+    stackBuilder.addNextIntent(notificationIntent1);\n \n-      String title = intent.getStringExtra(\"title\");\n-      String description = intent.getStringExtra(\"description\");\n-      String type = intent.getStringExtra(\"type\");\n-      String studyId = null;\n-      if (intent.getStringExtra(\"studyId\") != null) {\n-        studyId = intent.getStringExtra(\"studyId\");\n-      }\n+    String title = intent.getStringExtra(\"title\");\n+    String description = intent.getStringExtra(\"description\");\n+    String type = intent.getStringExtra(\"type\");\n+    String studyId = null;\n+    if (intent.getStringExtra(\"studyId\") != null) {\n+      studyId = intent.getStringExtra(\"studyId\");\n+    }\n \n-      String activityId = null;\n-      if (intent.getStringExtra(\"activityId\") != null) {\n-        activityId = intent.getStringExtra(\"activityId\");\n-      }\n+    String activityId = null;\n+    if (intent.getStringExtra(\"activityId\") != null) {\n+      activityId = intent.getStringExtra(\"activityId\");\n+    }\n \n-      int notificationId = intent.getIntExtra(\"notificationId\", 0);\n+    int notificationId = intent.getIntExtra(\"notificationId\", 0);\n \n-      Intent notificationIntent;\n-      if (AppConfig.AppType.equalsIgnoreCase(context.getString(R.string.app_gateway))) {\n-        notificationIntent = new Intent(context, StudyActivity.class);\n+    Intent notificationIntent;\n+    if (AppConfig.AppType.equalsIgnoreCase(context.getString(R.string.app_gateway))) {\n+      notificationIntent = new Intent(context, StudyActivity.class);\n+    } else {\n+      notificationIntent = new Intent(context, StandaloneActivity.class);\n+    }\n+    PendingIntent contentIntent = null;\n+    if (!type.equalsIgnoreCase(NotificationModuleSubscriber.NO_USE_NOTIFICATION)) {\n+      notificationIntent.putExtra(StudyActivity.FROM, NOTIFICATION_INTENT);\n+\n+      notificationIntent.putExtra(TYPE, \"Study\");\n+      if (type.equalsIgnoreCase(\"resources\")) {\n+        notificationIntent.putExtra(SUBTYPE, \"Resource\");\n       } else {\n-        notificationIntent = new Intent(context, StandaloneActivity.class);\n+        notificationIntent.putExtra(SUBTYPE, \"Activity\");\n       }\n-      PendingIntent contentIntent = null;\n-      if (!type.equalsIgnoreCase(NotificationModuleSubscriber.NO_USE_NOTIFICATION)) {\n-        notificationIntent.putExtra(StudyActivity.FROM, NOTIFICATION_INTENT);\n+      notificationIntent\n+              .putExtra(STUDYID, studyId)\n+              .putExtra(ACTIVITYID, activityId)\n+              .putExtra(AUDIENCE, \"\")\n+              .putExtra(LOCAL_NOTIFICATION, \"true\")\n+              .putExtra(TITLE, title)\n+              .putExtra(MESSAGE, description)\n+              .setFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP | Intent.FLAG_ACTIVITY_SINGLE_TOP);\n+      contentIntent =\n+              PendingIntent.getActivity(\n+                      context, notificationId, notificationIntent, PendingIntent.FLAG_UPDATE_CURRENT);\n+    }\n \n-        notificationIntent.putExtra(TYPE, \"Study\");\n-        if (type.equalsIgnoreCase(\"resources\")) {\n-          notificationIntent.putExtra(SUBTYPE, \"Resource\");\n-        } else {\n-          notificationIntent.putExtra(SUBTYPE, \"Activity\");\n+    int notifyIcon = R.mipmap.ic_launcher;\n+    Bitmap icon = BitmapFactory.decodeResource(context.getResources(), notifyIcon);\n+    Notification notification = null;\n+    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.LOLLIPOP) {\n+      notification =\n+              createNotificationForLollipopAndAbove(\n+                      context, type, title, description, icon, contentIntent);\n+    } else {\n+      notification =\n+              createNotificationForBelowLollipop(context, type, title, description, contentIntent);\n+    }\n+\n+    try {\n+      int count =\n+              Integer.parseInt(\n+                      AppController.getHelperSharedPreference()\n+                              .readPreference(\n+                                      context,\n+                                      context.getResources().getString(R.string.notificationCount),\n+                                      \"0\"))\n+                      + 1;\n+      AppController.getHelperSharedPreference()\n+              .writePreference(\n+                      context, context.getResources().getString(R.string.notificationCount), \"\" + count);\n+      NotificationManagerCompat notificationManager = NotificationManagerCompat.from(context);\n+\n+      Realm mRealm = AppController.getRealmobj(context);\n+      DBServiceSubscriber dbServiceSubscriber = new DBServiceSubscriber();\n+      UserProfileData mUserProfileData = dbServiceSubscriber.getUserProfileData(mRealm);\n+      StudyList studyList = dbServiceSubscriber.getStudiesDetails(studyId, mRealm);\n+      boolean isNotification = true;\n+      if (mUserProfileData != null) {\n+        isNotification = mUserProfileData.getSettings().isLocalNotifications();\n+      }\n+      if (!studyList.getStatus().equalsIgnoreCase(\"paused\")\n+              && (isNotification\n+              || type.equalsIgnoreCase(\n+              NotificationModuleSubscriber.NOTIFICATION_TURN_OFF_NOTIFICATION))) {\n+        notificationManager.notify(count, notification);\n+        if (type.equalsIgnoreCase(\n+                NotificationModuleSubscriber.NOTIFICATION_TURN_OFF_NOTIFICATION)) {\n+          NotificationModuleSubscriber notificationModuleSubscriber =\n+                  new NotificationModuleSubscriber(dbServiceSubscriber, mRealm);\n+          notificationModuleSubscriber.generateNotificationTurnOffNotification(\n+                  Calendar.getInstance().getTime(), context);\n         }\n-        notificationIntent.putExtra(STUDYID, studyId);\n-        notificationIntent.putExtra(ACTIVITYID, activityId);\n-        notificationIntent.putExtra(AUDIENCE, \"\");\n-        notificationIntent.putExtra(LOCAL_NOTIFICATION, \"true\");\n-        notificationIntent.putExtra(TITLE, title);\n-        notificationIntent.putExtra(MESSAGE, description);\n-        notificationIntent.setFlags(\n-            Intent.FLAG_ACTIVITY_CLEAR_TOP | Intent.FLAG_ACTIVITY_SINGLE_TOP);\n-        contentIntent =\n-            PendingIntent.getActivity(\n-                context, notificationId, notificationIntent, PendingIntent.FLAG_UPDATE_CURRENT);\n       }\n \n-      int notifyIcon = R.mipmap.ic_launcher;\n-      Bitmap icon = BitmapFactory.decodeResource(context.getResources(), notifyIcon);\n-      NotificationCompat.Builder builder = new NotificationCompat.Builder(context);\n-      Notification notification = null;\n-      if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.LOLLIPOP) {\n-        if (type.equalsIgnoreCase(NotificationModuleSubscriber.NO_USE_NOTIFICATION)) {\n-          notification =\n+      dbServiceSubscriber.closeRealmObj(mRealm);\n+    } catch (NumberFormatException | Resources.NotFoundException e) {\n+      Logger.log(e);\n+    } catch (Exception e) {\n+      Logger.log(e);\n+    }\n+  }\n+\n+  private Notification createNotificationForBelowLollipop(\n+          Context context, String type, String title, String description, PendingIntent contentIntent) {\n+    NotificationCompat.Builder builder = new NotificationCompat.Builder(context);\n+    Notification notification;\n+    if (type.equalsIgnoreCase(NotificationModuleSubscriber.NO_USE_NOTIFICATION)) {\n+      notification =\n               builder\n-                  .setContentTitle(title)\n-                  .setLargeIcon(Bitmap.createScaledBitmap(icon, 128, 128, false))\n-                  .setContentText(description)\n-                  .setChannelId(FDAApplication.NOTIFICATION_CHANNEL_ID_INFO)\n-                  .setStyle(new NotificationCompat.BigTextStyle().bigText(description))\n-                  .setSmallIcon(R.mipmap.ic_launcher)\n-                  .setAutoCancel(true)\n-                  .setGroup(\"group\")\n-                  .build();\n-        } else {\n-          notification =\n+                      .setContentTitle(title)\n+                      .setContentText(description)\n+                      .setChannelId(FDAApplication.NOTIFICATION_CHANNEL_ID_INFO)\n+                      .setStyle(new NotificationCompat.BigTextStyle().bigText(description))\n+                      .setSmallIcon(R.mipmap.ic_launcher)\n+                      .setAutoCancel(true)\n+                      .setGroup(\"group\")\n+                      .build();\n+    } else {\n+      notification =\n               builder\n-                  .setContentTitle(title)\n-                  .setLargeIcon(Bitmap.createScaledBitmap(icon, 128, 128, false))\n-                  .setContentText(description)\n-                  .setChannelId(FDAApplication.NOTIFICATION_CHANNEL_ID_INFO)\n-                  .setStyle(new NotificationCompat.BigTextStyle().bigText(description))\n-                  .setSmallIcon(R.mipmap.ic_launcher)\n-                  .setAutoCancel(true)\n-                  .setContentIntent(contentIntent)\n-                  .setGroup(\"group\")\n-                  .build();\n-        }\n-      } else {\n-        if (type.equalsIgnoreCase(NotificationModuleSubscriber.NO_USE_NOTIFICATION)) {\n-          notification =\n+                      .setContentTitle(title)\n+                      .setContentText(description)\n+                      .setChannelId(FDAApplication.NOTIFICATION_CHANNEL_ID_INFO)\n+                      .setStyle(new NotificationCompat.BigTextStyle().bigText(description))\n+                      .setSmallIcon(R.mipmap.ic_launcher)\n+                      .setAutoCancel(true)\n+                      .setContentIntent(contentIntent)\n+                      .setGroup(\"group\")\n+                      .build();\n+    }\n+    return notification;\n+  }\n+\n+  private Notification createNotificationForLollipopAndAbove(\n+          Context context,\n+          String type,\n+          String title,\n+          String description,\n+          Bitmap icon,\n+          PendingIntent contentIntent) {\n+    NotificationCompat.Builder builder = new NotificationCompat.Builder(context);\n+    Notification notification;\n+    if (type.equalsIgnoreCase(NotificationModuleSubscriber.NO_USE_NOTIFICATION)) {\n+      notification =\n               builder\n-                  .setContentTitle(title)\n-                  .setContentText(description)\n-                  .setChannelId(FDAApplication.NOTIFICATION_CHANNEL_ID_INFO)\n-                  .setStyle(new NotificationCompat.BigTextStyle().bigText(description))\n-                  .setSmallIcon(R.mipmap.ic_launcher)\n-                  .setAutoCancel(true)\n-                  .setGroup(\"group\")\n-                  .build();\n-        } else {\n-          notification =\n+                      .setContentTitle(title)\n+                      .setLargeIcon(Bitmap.createScaledBitmap(icon, 128, 128, false))\n+                      .setContentText(description)\n+                      .setChannelId(FDAApplication.NOTIFICATION_CHANNEL_ID_INFO)\n+                      .setStyle(new NotificationCompat.BigTextStyle().bigText(description))\n+                      .setSmallIcon(R.mipmap.ic_launcher)\n+                      .setAutoCancel(true)\n+                      .setGroup(\"group\")\n+                      .build();\n+    } else {\n+      notification =\n               builder\n-                  .setContentTitle(title)\n-                  .setContentText(description)\n-                  .setChannelId(FDAApplication.NOTIFICATION_CHANNEL_ID_INFO)\n-                  .setStyle(new NotificationCompat.BigTextStyle().bigText(description))\n-                  .setSmallIcon(R.mipmap.ic_launcher)\n-                  .setAutoCancel(true)\n-                  .setContentIntent(contentIntent)\n-                  .setGroup(\"group\")\n-                  .build();\n-        }\n-      }\n-\n-      try {\n-        int count =\n-            Integer.parseInt(\n-                    AppController.getHelperSharedPreference()\n-                        .readPreference(\n-                            context,\n-                            context.getResources().getString(R.string.notificationCount),\n-                            \"0\"))\n-                + 1;\n-        AppController.getHelperSharedPreference()\n-            .writePreference(\n-                context, context.getResources().getString(R.string.notificationCount), \"\" + count);\n-        NotificationManagerCompat notificationManager = NotificationManagerCompat.from(context);\n-\n-        Realm mRealm = AppController.getRealmobj(context);\n-        DBServiceSubscriber dbServiceSubscriber = new DBServiceSubscriber();\n-        UserProfileData mUserProfileData = dbServiceSubscriber.getUserProfileData(mRealm);\n-        StudyList studyList = dbServiceSubscriber.getStudiesDetails(studyId, mRealm);\n-        boolean isNotification = true;\n-        if (mUserProfileData != null) {\n-          isNotification = mUserProfileData.getSettings().isLocalNotifications();\n-        }\n-        if (!studyList.getStatus().equalsIgnoreCase(\"paused\")\n-            && (isNotification\n-                || type.equalsIgnoreCase(\n-                    NotificationModuleSubscriber.NOTIFICATION_TURN_OFF_NOTIFICATION))) {\n-          notificationManager.notify(count, notification);\n-          if (type.equalsIgnoreCase(\n-              NotificationModuleSubscriber.NOTIFICATION_TURN_OFF_NOTIFICATION)) {\n-            NotificationModuleSubscriber notificationModuleSubscriber =\n-                new NotificationModuleSubscriber(dbServiceSubscriber, mRealm);\n-            notificationModuleSubscriber.generateNotificationTurnOffNotification(\n-                Calendar.getInstance().getTime(), context);\n-          }\n-        }\n+                      .setContentTitle(title)\n+                      .setLargeIcon(Bitmap.createScaledBitmap(icon, 128, 128, false))\n+                      .setContentText(description)\n+                      .setChannelId(FDAApplication.NOTIFICATION_CHANNEL_ID_INFO)\n+                      .setStyle(new NotificationCompat.BigTextStyle().bigText(description))\n+                      .setSmallIcon(R.mipmap.ic_launcher)\n+                      .setAutoCancel(true)\n+                      .setContentIntent(contentIntent)\n+                      .setGroup(\"group\")\n+                      .build();\n+    }\n+    return notification;\n+  }\n \n-        dbServiceSubscriber.closeRealmObj(mRealm);\n-      } catch (NumberFormatException | Resources.NotFoundException e) {\n-        Logger.log(e);\n-      } catch (Exception e) {\n-        Logger.log(e);\n+  private void notificationForTodayAnd24HrAlarm(Context context) {\n+    Realm mRealm = AppController.getRealmobj(context);\n+    DBServiceSubscriber dbServiceSubscriber = new DBServiceSubscriber();\n+    RealmResults<NotificationDb> notificationDbs =\n+            dbServiceSubscriber.getNotificationDbByCurrentDate(mRealm);\n+    NotificationModuleSubscriber notificationModuleSubscriber =\n+            new NotificationModuleSubscriber(dbServiceSubscriber, mRealm);\n+    if (notificationDbs != null) {\n+      for (NotificationDb notificationDb : notificationDbs) {\n+        Calendar time = Calendar.getInstance();\n+        time.setTime(notificationDb.getDateTime());\n+        notificationModuleSubscriber.setAlarm(\n+                context,\n+                notificationDb.getTitle(),\n+                notificationDb.getDescription(),\n+                notificationDb.getType(),\n+                notificationDb.getNotificationId(),\n+                notificationDb.getStudyId(),\n+                notificationDb.getActivityId(),\n+                time);\n       }\n     }\n+    Calendar calendar = NotificationModuleSubscriber.getCalenderNextDay();\n+\n+    Intent notificationIntent =\n+            new Intent(context, AlarmReceiver.class)\n+                    .setAction(\"android.media.action.DISPLAY_NOTIFICATION\")\n+                    .addCategory(\"android.intent.category.DEFAULT\")\n+                    .putExtra(\"pendingIntentId\", 1);\n+    AlarmManager alarmManager = (AlarmManager) context.getSystemService(Context.ALARM_SERVICE);\n+    PendingIntent broadcast =\n+            PendingIntent.getBroadcast(\n+                    context, 1, notificationIntent, PendingIntent.FLAG_UPDATE_CURRENT);\n+    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {\n+      alarmManager.setExactAndAllowWhileIdle(\n+              AlarmManager.RTC_WAKEUP, calendar.getTimeInMillis(), broadcast);\n+    } else {\n+      alarmManager.setExact(AlarmManager.RTC_WAKEUP, calendar.getTimeInMillis(), broadcast);\n+    }\n+    dbServiceSubscriber.closeRealmObj(mRealm);\n   }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTE4OTQzNA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/420#discussion_r431189434", "bodyText": "Can you make each branch here a separate function?", "author": "nikklassen", "createdAt": "2020-05-27T14:39:51Z", "path": "Android/app/src/main/java/com/harvard/notificationmodule/AlarmReceiver.java", "diffHunk": "@@ -53,154 +57,222 @@\n \n   @Override\n   public void onReceive(Context context, Intent intent) {\n-    Intent notificationIntent1 = new Intent(context, NotificationActivity.class);\n-\n-    TaskStackBuilder stackBuilder = TaskStackBuilder.create(context);\n-    stackBuilder.addParentStack(NotificationActivity.class);\n-    stackBuilder.addNextIntent(notificationIntent1);\n-\n-    String title = intent.getStringExtra(\"title\");\n-    String description = intent.getStringExtra(\"description\");\n-    String type = intent.getStringExtra(\"type\");\n-    String studyId = null;\n-    if (intent.getStringExtra(\"studyId\") != null) {\n-      studyId = intent.getStringExtra(\"studyId\");\n-    }\n \n-    String activityId = null;\n-    if (intent.getStringExtra(\"activityId\") != null) {\n-      activityId = intent.getStringExtra(\"activityId\");\n+    int pendingIntentId = 0;\n+    try {\n+      pendingIntentId = intent.getIntExtra(\"pendingIntentId\", 0);\n+    } catch (Exception e) {\n+      Logger.log(e);\n     }\n+    if (pendingIntentId == 1) {", "originalCommit": "7ba1cc830224e7f6ce12a9c0bcacf910a46b55c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjA0MjQ2Mw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/420#discussion_r432042463", "bodyText": "updated in the latest commit.", "author": "naveenr-btc", "createdAt": "2020-05-28T18:38:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTE4OTQzNA=="}], "type": "inlineReview", "revised_code": {"commit": "91ddd774b776e07458c06ec87cb1131b29069579", "chunk": "diff --git a/Android/app/src/main/java/com/harvard/notificationmodule/AlarmReceiver.java b/Android/app/src/main/java/com/harvard/notificationmodule/AlarmReceiver.java\nindex ddaff240d..749effcf9 100644\n--- a/Android/app/src/main/java/com/harvard/notificationmodule/AlarmReceiver.java\n+++ b/Android/app/src/main/java/com/harvard/notificationmodule/AlarmReceiver.java\n\n@@ -65,214 +67,227 @@ public class AlarmReceiver extends BroadcastReceiver {\n       Logger.log(e);\n     }\n     if (pendingIntentId == 1) {\n-      Realm mRealm = AppController.getRealmobj(context);\n-      DBServiceSubscriber dbServiceSubscriber = new DBServiceSubscriber();\n-      RealmResults<NotificationDb> notificationDbs =\n-          dbServiceSubscriber.getNotificationDbByCurrentDate(mRealm);\n-      NotificationModuleSubscriber notificationModuleSubscriber =\n-          new NotificationModuleSubscriber(dbServiceSubscriber, mRealm);\n-      if (notificationDbs != null && notificationDbs.size() > 0) {\n-        for (int i = 0; i < notificationDbs.size(); i++) {\n-          Calendar time = Calendar.getInstance();\n-          time.setTime(notificationDbs.get(i).getDateTime());\n-          notificationModuleSubscriber.setAlarm(\n-              context,\n-              notificationDbs.get(i).getTitle(),\n-              notificationDbs.get(i).getDescription(),\n-              notificationDbs.get(i).getType(),\n-              notificationDbs.get(i).getNotificationId(),\n-              notificationDbs.get(i).getStudyId(),\n-              notificationDbs.get(i).getActivityId(),\n-              time);\n-        }\n-      }\n-      Calendar calendar = Calendar.getInstance();\n-      calendar.set(Calendar.HOUR_OF_DAY, 0);\n-      calendar.set(Calendar.MINUTE, 0);\n-      calendar.set(Calendar.SECOND, 0);\n-      calendar.set(Calendar.MILLISECOND, 0);\n-      calendar.add(Calendar.DATE, 1);\n-\n-      try {\n-        Intent notificationIntent = new Intent(context, AlarmReceiver.class);\n-        notificationIntent.setAction(\"android.media.action.DISPLAY_NOTIFICATION\");\n-        notificationIntent.addCategory(\"android.intent.category.DEFAULT\");\n-        notificationIntent.putExtra(\"pendingIntentId\", 1);\n-        AlarmManager alarmManager = (AlarmManager) context.getSystemService(Context.ALARM_SERVICE);\n-        PendingIntent broadcast =\n-            PendingIntent.getBroadcast(\n-                context, 1, notificationIntent, PendingIntent.FLAG_UPDATE_CURRENT);\n-        try {\n-          if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {\n-            alarmManager.setExactAndAllowWhileIdle(\n-                AlarmManager.RTC_WAKEUP, calendar.getTimeInMillis(), broadcast);\n-          } else {\n-            alarmManager.setExact(AlarmManager.RTC_WAKEUP, calendar.getTimeInMillis(), broadcast);\n-          }\n-        } catch (NullPointerException e) {\n-          Logger.log(e);\n-        }\n-      } catch (Exception e) {\n-        Logger.log(e);\n-      }\n-\n-      try {\n-        dbServiceSubscriber.closeRealmObj(mRealm);\n-      } catch (Exception e) {\n-        Logger.log(e);\n-      }\n+      notificationForTodayAnd24HrAlarm(context);\n     } else {\n+      showLocalNotification(context, intent);\n+    }\n+  }\n \n-      Intent notificationIntent1 = new Intent(context, NotificationActivity.class);\n+  private void showLocalNotification(Context context, Intent intent) {\n+    Intent notificationIntent1 = new Intent(context, NotificationActivity.class);\n \n-      TaskStackBuilder stackBuilder = TaskStackBuilder.create(context);\n-      stackBuilder.addParentStack(NotificationActivity.class);\n-      stackBuilder.addNextIntent(notificationIntent1);\n+    TaskStackBuilder stackBuilder = TaskStackBuilder.create(context);\n+    stackBuilder.addParentStack(NotificationActivity.class);\n+    stackBuilder.addNextIntent(notificationIntent1);\n \n-      String title = intent.getStringExtra(\"title\");\n-      String description = intent.getStringExtra(\"description\");\n-      String type = intent.getStringExtra(\"type\");\n-      String studyId = null;\n-      if (intent.getStringExtra(\"studyId\") != null) {\n-        studyId = intent.getStringExtra(\"studyId\");\n-      }\n+    String title = intent.getStringExtra(\"title\");\n+    String description = intent.getStringExtra(\"description\");\n+    String type = intent.getStringExtra(\"type\");\n+    String studyId = null;\n+    if (intent.getStringExtra(\"studyId\") != null) {\n+      studyId = intent.getStringExtra(\"studyId\");\n+    }\n \n-      String activityId = null;\n-      if (intent.getStringExtra(\"activityId\") != null) {\n-        activityId = intent.getStringExtra(\"activityId\");\n-      }\n+    String activityId = null;\n+    if (intent.getStringExtra(\"activityId\") != null) {\n+      activityId = intent.getStringExtra(\"activityId\");\n+    }\n \n-      int notificationId = intent.getIntExtra(\"notificationId\", 0);\n+    int notificationId = intent.getIntExtra(\"notificationId\", 0);\n \n-      Intent notificationIntent;\n-      if (AppConfig.AppType.equalsIgnoreCase(context.getString(R.string.app_gateway))) {\n-        notificationIntent = new Intent(context, StudyActivity.class);\n+    Intent notificationIntent;\n+    if (AppConfig.AppType.equalsIgnoreCase(context.getString(R.string.app_gateway))) {\n+      notificationIntent = new Intent(context, StudyActivity.class);\n+    } else {\n+      notificationIntent = new Intent(context, StandaloneActivity.class);\n+    }\n+    PendingIntent contentIntent = null;\n+    if (!type.equalsIgnoreCase(NotificationModuleSubscriber.NO_USE_NOTIFICATION)) {\n+      notificationIntent.putExtra(StudyActivity.FROM, NOTIFICATION_INTENT);\n+\n+      notificationIntent.putExtra(TYPE, \"Study\");\n+      if (type.equalsIgnoreCase(\"resources\")) {\n+        notificationIntent.putExtra(SUBTYPE, \"Resource\");\n       } else {\n-        notificationIntent = new Intent(context, StandaloneActivity.class);\n+        notificationIntent.putExtra(SUBTYPE, \"Activity\");\n       }\n-      PendingIntent contentIntent = null;\n-      if (!type.equalsIgnoreCase(NotificationModuleSubscriber.NO_USE_NOTIFICATION)) {\n-        notificationIntent.putExtra(StudyActivity.FROM, NOTIFICATION_INTENT);\n+      notificationIntent\n+              .putExtra(STUDYID, studyId)\n+              .putExtra(ACTIVITYID, activityId)\n+              .putExtra(AUDIENCE, \"\")\n+              .putExtra(LOCAL_NOTIFICATION, \"true\")\n+              .putExtra(TITLE, title)\n+              .putExtra(MESSAGE, description)\n+              .setFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP | Intent.FLAG_ACTIVITY_SINGLE_TOP);\n+      contentIntent =\n+              PendingIntent.getActivity(\n+                      context, notificationId, notificationIntent, PendingIntent.FLAG_UPDATE_CURRENT);\n+    }\n \n-        notificationIntent.putExtra(TYPE, \"Study\");\n-        if (type.equalsIgnoreCase(\"resources\")) {\n-          notificationIntent.putExtra(SUBTYPE, \"Resource\");\n-        } else {\n-          notificationIntent.putExtra(SUBTYPE, \"Activity\");\n+    int notifyIcon = R.mipmap.ic_launcher;\n+    Bitmap icon = BitmapFactory.decodeResource(context.getResources(), notifyIcon);\n+    Notification notification = null;\n+    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.LOLLIPOP) {\n+      notification =\n+              createNotificationForLollipopAndAbove(\n+                      context, type, title, description, icon, contentIntent);\n+    } else {\n+      notification =\n+              createNotificationForBelowLollipop(context, type, title, description, contentIntent);\n+    }\n+\n+    try {\n+      int count =\n+              Integer.parseInt(\n+                      AppController.getHelperSharedPreference()\n+                              .readPreference(\n+                                      context,\n+                                      context.getResources().getString(R.string.notificationCount),\n+                                      \"0\"))\n+                      + 1;\n+      AppController.getHelperSharedPreference()\n+              .writePreference(\n+                      context, context.getResources().getString(R.string.notificationCount), \"\" + count);\n+      NotificationManagerCompat notificationManager = NotificationManagerCompat.from(context);\n+\n+      Realm mRealm = AppController.getRealmobj(context);\n+      DBServiceSubscriber dbServiceSubscriber = new DBServiceSubscriber();\n+      UserProfileData mUserProfileData = dbServiceSubscriber.getUserProfileData(mRealm);\n+      StudyList studyList = dbServiceSubscriber.getStudiesDetails(studyId, mRealm);\n+      boolean isNotification = true;\n+      if (mUserProfileData != null) {\n+        isNotification = mUserProfileData.getSettings().isLocalNotifications();\n+      }\n+      if (!studyList.getStatus().equalsIgnoreCase(\"paused\")\n+              && (isNotification\n+              || type.equalsIgnoreCase(\n+              NotificationModuleSubscriber.NOTIFICATION_TURN_OFF_NOTIFICATION))) {\n+        notificationManager.notify(count, notification);\n+        if (type.equalsIgnoreCase(\n+                NotificationModuleSubscriber.NOTIFICATION_TURN_OFF_NOTIFICATION)) {\n+          NotificationModuleSubscriber notificationModuleSubscriber =\n+                  new NotificationModuleSubscriber(dbServiceSubscriber, mRealm);\n+          notificationModuleSubscriber.generateNotificationTurnOffNotification(\n+                  Calendar.getInstance().getTime(), context);\n         }\n-        notificationIntent.putExtra(STUDYID, studyId);\n-        notificationIntent.putExtra(ACTIVITYID, activityId);\n-        notificationIntent.putExtra(AUDIENCE, \"\");\n-        notificationIntent.putExtra(LOCAL_NOTIFICATION, \"true\");\n-        notificationIntent.putExtra(TITLE, title);\n-        notificationIntent.putExtra(MESSAGE, description);\n-        notificationIntent.setFlags(\n-            Intent.FLAG_ACTIVITY_CLEAR_TOP | Intent.FLAG_ACTIVITY_SINGLE_TOP);\n-        contentIntent =\n-            PendingIntent.getActivity(\n-                context, notificationId, notificationIntent, PendingIntent.FLAG_UPDATE_CURRENT);\n       }\n \n-      int notifyIcon = R.mipmap.ic_launcher;\n-      Bitmap icon = BitmapFactory.decodeResource(context.getResources(), notifyIcon);\n-      NotificationCompat.Builder builder = new NotificationCompat.Builder(context);\n-      Notification notification = null;\n-      if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.LOLLIPOP) {\n-        if (type.equalsIgnoreCase(NotificationModuleSubscriber.NO_USE_NOTIFICATION)) {\n-          notification =\n+      dbServiceSubscriber.closeRealmObj(mRealm);\n+    } catch (NumberFormatException | Resources.NotFoundException e) {\n+      Logger.log(e);\n+    } catch (Exception e) {\n+      Logger.log(e);\n+    }\n+  }\n+\n+  private Notification createNotificationForBelowLollipop(\n+          Context context, String type, String title, String description, PendingIntent contentIntent) {\n+    NotificationCompat.Builder builder = new NotificationCompat.Builder(context);\n+    Notification notification;\n+    if (type.equalsIgnoreCase(NotificationModuleSubscriber.NO_USE_NOTIFICATION)) {\n+      notification =\n               builder\n-                  .setContentTitle(title)\n-                  .setLargeIcon(Bitmap.createScaledBitmap(icon, 128, 128, false))\n-                  .setContentText(description)\n-                  .setChannelId(FDAApplication.NOTIFICATION_CHANNEL_ID_INFO)\n-                  .setStyle(new NotificationCompat.BigTextStyle().bigText(description))\n-                  .setSmallIcon(R.mipmap.ic_launcher)\n-                  .setAutoCancel(true)\n-                  .setGroup(\"group\")\n-                  .build();\n-        } else {\n-          notification =\n+                      .setContentTitle(title)\n+                      .setContentText(description)\n+                      .setChannelId(FDAApplication.NOTIFICATION_CHANNEL_ID_INFO)\n+                      .setStyle(new NotificationCompat.BigTextStyle().bigText(description))\n+                      .setSmallIcon(R.mipmap.ic_launcher)\n+                      .setAutoCancel(true)\n+                      .setGroup(\"group\")\n+                      .build();\n+    } else {\n+      notification =\n               builder\n-                  .setContentTitle(title)\n-                  .setLargeIcon(Bitmap.createScaledBitmap(icon, 128, 128, false))\n-                  .setContentText(description)\n-                  .setChannelId(FDAApplication.NOTIFICATION_CHANNEL_ID_INFO)\n-                  .setStyle(new NotificationCompat.BigTextStyle().bigText(description))\n-                  .setSmallIcon(R.mipmap.ic_launcher)\n-                  .setAutoCancel(true)\n-                  .setContentIntent(contentIntent)\n-                  .setGroup(\"group\")\n-                  .build();\n-        }\n-      } else {\n-        if (type.equalsIgnoreCase(NotificationModuleSubscriber.NO_USE_NOTIFICATION)) {\n-          notification =\n+                      .setContentTitle(title)\n+                      .setContentText(description)\n+                      .setChannelId(FDAApplication.NOTIFICATION_CHANNEL_ID_INFO)\n+                      .setStyle(new NotificationCompat.BigTextStyle().bigText(description))\n+                      .setSmallIcon(R.mipmap.ic_launcher)\n+                      .setAutoCancel(true)\n+                      .setContentIntent(contentIntent)\n+                      .setGroup(\"group\")\n+                      .build();\n+    }\n+    return notification;\n+  }\n+\n+  private Notification createNotificationForLollipopAndAbove(\n+          Context context,\n+          String type,\n+          String title,\n+          String description,\n+          Bitmap icon,\n+          PendingIntent contentIntent) {\n+    NotificationCompat.Builder builder = new NotificationCompat.Builder(context);\n+    Notification notification;\n+    if (type.equalsIgnoreCase(NotificationModuleSubscriber.NO_USE_NOTIFICATION)) {\n+      notification =\n               builder\n-                  .setContentTitle(title)\n-                  .setContentText(description)\n-                  .setChannelId(FDAApplication.NOTIFICATION_CHANNEL_ID_INFO)\n-                  .setStyle(new NotificationCompat.BigTextStyle().bigText(description))\n-                  .setSmallIcon(R.mipmap.ic_launcher)\n-                  .setAutoCancel(true)\n-                  .setGroup(\"group\")\n-                  .build();\n-        } else {\n-          notification =\n+                      .setContentTitle(title)\n+                      .setLargeIcon(Bitmap.createScaledBitmap(icon, 128, 128, false))\n+                      .setContentText(description)\n+                      .setChannelId(FDAApplication.NOTIFICATION_CHANNEL_ID_INFO)\n+                      .setStyle(new NotificationCompat.BigTextStyle().bigText(description))\n+                      .setSmallIcon(R.mipmap.ic_launcher)\n+                      .setAutoCancel(true)\n+                      .setGroup(\"group\")\n+                      .build();\n+    } else {\n+      notification =\n               builder\n-                  .setContentTitle(title)\n-                  .setContentText(description)\n-                  .setChannelId(FDAApplication.NOTIFICATION_CHANNEL_ID_INFO)\n-                  .setStyle(new NotificationCompat.BigTextStyle().bigText(description))\n-                  .setSmallIcon(R.mipmap.ic_launcher)\n-                  .setAutoCancel(true)\n-                  .setContentIntent(contentIntent)\n-                  .setGroup(\"group\")\n-                  .build();\n-        }\n-      }\n-\n-      try {\n-        int count =\n-            Integer.parseInt(\n-                    AppController.getHelperSharedPreference()\n-                        .readPreference(\n-                            context,\n-                            context.getResources().getString(R.string.notificationCount),\n-                            \"0\"))\n-                + 1;\n-        AppController.getHelperSharedPreference()\n-            .writePreference(\n-                context, context.getResources().getString(R.string.notificationCount), \"\" + count);\n-        NotificationManagerCompat notificationManager = NotificationManagerCompat.from(context);\n-\n-        Realm mRealm = AppController.getRealmobj(context);\n-        DBServiceSubscriber dbServiceSubscriber = new DBServiceSubscriber();\n-        UserProfileData mUserProfileData = dbServiceSubscriber.getUserProfileData(mRealm);\n-        StudyList studyList = dbServiceSubscriber.getStudiesDetails(studyId, mRealm);\n-        boolean isNotification = true;\n-        if (mUserProfileData != null) {\n-          isNotification = mUserProfileData.getSettings().isLocalNotifications();\n-        }\n-        if (!studyList.getStatus().equalsIgnoreCase(\"paused\")\n-            && (isNotification\n-                || type.equalsIgnoreCase(\n-                    NotificationModuleSubscriber.NOTIFICATION_TURN_OFF_NOTIFICATION))) {\n-          notificationManager.notify(count, notification);\n-          if (type.equalsIgnoreCase(\n-              NotificationModuleSubscriber.NOTIFICATION_TURN_OFF_NOTIFICATION)) {\n-            NotificationModuleSubscriber notificationModuleSubscriber =\n-                new NotificationModuleSubscriber(dbServiceSubscriber, mRealm);\n-            notificationModuleSubscriber.generateNotificationTurnOffNotification(\n-                Calendar.getInstance().getTime(), context);\n-          }\n-        }\n+                      .setContentTitle(title)\n+                      .setLargeIcon(Bitmap.createScaledBitmap(icon, 128, 128, false))\n+                      .setContentText(description)\n+                      .setChannelId(FDAApplication.NOTIFICATION_CHANNEL_ID_INFO)\n+                      .setStyle(new NotificationCompat.BigTextStyle().bigText(description))\n+                      .setSmallIcon(R.mipmap.ic_launcher)\n+                      .setAutoCancel(true)\n+                      .setContentIntent(contentIntent)\n+                      .setGroup(\"group\")\n+                      .build();\n+    }\n+    return notification;\n+  }\n \n-        dbServiceSubscriber.closeRealmObj(mRealm);\n-      } catch (NumberFormatException | Resources.NotFoundException e) {\n-        Logger.log(e);\n-      } catch (Exception e) {\n-        Logger.log(e);\n+  private void notificationForTodayAnd24HrAlarm(Context context) {\n+    Realm mRealm = AppController.getRealmobj(context);\n+    DBServiceSubscriber dbServiceSubscriber = new DBServiceSubscriber();\n+    RealmResults<NotificationDb> notificationDbs =\n+            dbServiceSubscriber.getNotificationDbByCurrentDate(mRealm);\n+    NotificationModuleSubscriber notificationModuleSubscriber =\n+            new NotificationModuleSubscriber(dbServiceSubscriber, mRealm);\n+    if (notificationDbs != null) {\n+      for (NotificationDb notificationDb : notificationDbs) {\n+        Calendar time = Calendar.getInstance();\n+        time.setTime(notificationDb.getDateTime());\n+        notificationModuleSubscriber.setAlarm(\n+                context,\n+                notificationDb.getTitle(),\n+                notificationDb.getDescription(),\n+                notificationDb.getType(),\n+                notificationDb.getNotificationId(),\n+                notificationDb.getStudyId(),\n+                notificationDb.getActivityId(),\n+                time);\n       }\n     }\n+    Calendar calendar = NotificationModuleSubscriber.getCalenderNextDay();\n+\n+    Intent notificationIntent =\n+            new Intent(context, AlarmReceiver.class)\n+                    .setAction(\"android.media.action.DISPLAY_NOTIFICATION\")\n+                    .addCategory(\"android.intent.category.DEFAULT\")\n+                    .putExtra(\"pendingIntentId\", 1);\n+    AlarmManager alarmManager = (AlarmManager) context.getSystemService(Context.ALARM_SERVICE);\n+    PendingIntent broadcast =\n+            PendingIntent.getBroadcast(\n+                    context, 1, notificationIntent, PendingIntent.FLAG_UPDATE_CURRENT);\n+    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {\n+      alarmManager.setExactAndAllowWhileIdle(\n+              AlarmManager.RTC_WAKEUP, calendar.getTimeInMillis(), broadcast);\n+    } else {\n+      alarmManager.setExact(AlarmManager.RTC_WAKEUP, calendar.getTimeInMillis(), broadcast);\n+    }\n+    dbServiceSubscriber.closeRealmObj(mRealm);\n   }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTE4OTk3Ng==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/420#discussion_r431189976", "bodyText": "You shouldn't be expecting NullPointerExceptions", "author": "nikklassen", "createdAt": "2020-05-27T14:40:33Z", "path": "Android/app/src/main/java/com/harvard/notificationmodule/AlarmReceiver.java", "diffHunk": "@@ -53,154 +57,222 @@\n \n   @Override\n   public void onReceive(Context context, Intent intent) {\n-    Intent notificationIntent1 = new Intent(context, NotificationActivity.class);\n-\n-    TaskStackBuilder stackBuilder = TaskStackBuilder.create(context);\n-    stackBuilder.addParentStack(NotificationActivity.class);\n-    stackBuilder.addNextIntent(notificationIntent1);\n-\n-    String title = intent.getStringExtra(\"title\");\n-    String description = intent.getStringExtra(\"description\");\n-    String type = intent.getStringExtra(\"type\");\n-    String studyId = null;\n-    if (intent.getStringExtra(\"studyId\") != null) {\n-      studyId = intent.getStringExtra(\"studyId\");\n-    }\n \n-    String activityId = null;\n-    if (intent.getStringExtra(\"activityId\") != null) {\n-      activityId = intent.getStringExtra(\"activityId\");\n+    int pendingIntentId = 0;\n+    try {\n+      pendingIntentId = intent.getIntExtra(\"pendingIntentId\", 0);\n+    } catch (Exception e) {\n+      Logger.log(e);\n     }\n+    if (pendingIntentId == 1) {\n+      Realm mRealm = AppController.getRealmobj(context);\n+      DBServiceSubscriber dbServiceSubscriber = new DBServiceSubscriber();\n+      RealmResults<NotificationDb> notificationDbs =\n+          dbServiceSubscriber.getNotificationDbByCurrentDate(mRealm);\n+      NotificationModuleSubscriber notificationModuleSubscriber =\n+          new NotificationModuleSubscriber(dbServiceSubscriber, mRealm);\n+      if (notificationDbs != null && notificationDbs.size() > 0) {\n+        for (int i = 0; i < notificationDbs.size(); i++) {\n+          Calendar time = Calendar.getInstance();\n+          time.setTime(notificationDbs.get(i).getDateTime());\n+          notificationModuleSubscriber.setAlarm(\n+              context,\n+              notificationDbs.get(i).getTitle(),\n+              notificationDbs.get(i).getDescription(),\n+              notificationDbs.get(i).getType(),\n+              notificationDbs.get(i).getNotificationId(),\n+              notificationDbs.get(i).getStudyId(),\n+              notificationDbs.get(i).getActivityId(),\n+              time);\n+        }\n+      }\n+      Calendar calendar = Calendar.getInstance();\n+      calendar.set(Calendar.HOUR_OF_DAY, 0);\n+      calendar.set(Calendar.MINUTE, 0);\n+      calendar.set(Calendar.SECOND, 0);\n+      calendar.set(Calendar.MILLISECOND, 0);\n+      calendar.add(Calendar.DATE, 1);\n \n-    int notificationId = intent.getIntExtra(\"notificationId\", 0);\n+      try {\n+        Intent notificationIntent = new Intent(context, AlarmReceiver.class);\n+        notificationIntent.setAction(\"android.media.action.DISPLAY_NOTIFICATION\");\n+        notificationIntent.addCategory(\"android.intent.category.DEFAULT\");\n+        notificationIntent.putExtra(\"pendingIntentId\", 1);\n+        AlarmManager alarmManager = (AlarmManager) context.getSystemService(Context.ALARM_SERVICE);\n+        PendingIntent broadcast =\n+            PendingIntent.getBroadcast(\n+                context, 1, notificationIntent, PendingIntent.FLAG_UPDATE_CURRENT);\n+        try {\n+          if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {\n+            alarmManager.setExactAndAllowWhileIdle(\n+                AlarmManager.RTC_WAKEUP, calendar.getTimeInMillis(), broadcast);\n+          } else {\n+            alarmManager.setExact(AlarmManager.RTC_WAKEUP, calendar.getTimeInMillis(), broadcast);\n+          }\n+        } catch (NullPointerException e) {", "originalCommit": "7ba1cc830224e7f6ce12a9c0bcacf910a46b55c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjA0MjUxMQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/420#discussion_r432042511", "bodyText": "updated in the latest commit.", "author": "naveenr-btc", "createdAt": "2020-05-28T18:38:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTE4OTk3Ng=="}], "type": "inlineReview", "revised_code": {"commit": "91ddd774b776e07458c06ec87cb1131b29069579", "chunk": "diff --git a/Android/app/src/main/java/com/harvard/notificationmodule/AlarmReceiver.java b/Android/app/src/main/java/com/harvard/notificationmodule/AlarmReceiver.java\nindex ddaff240d..749effcf9 100644\n--- a/Android/app/src/main/java/com/harvard/notificationmodule/AlarmReceiver.java\n+++ b/Android/app/src/main/java/com/harvard/notificationmodule/AlarmReceiver.java\n\n@@ -65,214 +67,227 @@ public class AlarmReceiver extends BroadcastReceiver {\n       Logger.log(e);\n     }\n     if (pendingIntentId == 1) {\n-      Realm mRealm = AppController.getRealmobj(context);\n-      DBServiceSubscriber dbServiceSubscriber = new DBServiceSubscriber();\n-      RealmResults<NotificationDb> notificationDbs =\n-          dbServiceSubscriber.getNotificationDbByCurrentDate(mRealm);\n-      NotificationModuleSubscriber notificationModuleSubscriber =\n-          new NotificationModuleSubscriber(dbServiceSubscriber, mRealm);\n-      if (notificationDbs != null && notificationDbs.size() > 0) {\n-        for (int i = 0; i < notificationDbs.size(); i++) {\n-          Calendar time = Calendar.getInstance();\n-          time.setTime(notificationDbs.get(i).getDateTime());\n-          notificationModuleSubscriber.setAlarm(\n-              context,\n-              notificationDbs.get(i).getTitle(),\n-              notificationDbs.get(i).getDescription(),\n-              notificationDbs.get(i).getType(),\n-              notificationDbs.get(i).getNotificationId(),\n-              notificationDbs.get(i).getStudyId(),\n-              notificationDbs.get(i).getActivityId(),\n-              time);\n-        }\n-      }\n-      Calendar calendar = Calendar.getInstance();\n-      calendar.set(Calendar.HOUR_OF_DAY, 0);\n-      calendar.set(Calendar.MINUTE, 0);\n-      calendar.set(Calendar.SECOND, 0);\n-      calendar.set(Calendar.MILLISECOND, 0);\n-      calendar.add(Calendar.DATE, 1);\n-\n-      try {\n-        Intent notificationIntent = new Intent(context, AlarmReceiver.class);\n-        notificationIntent.setAction(\"android.media.action.DISPLAY_NOTIFICATION\");\n-        notificationIntent.addCategory(\"android.intent.category.DEFAULT\");\n-        notificationIntent.putExtra(\"pendingIntentId\", 1);\n-        AlarmManager alarmManager = (AlarmManager) context.getSystemService(Context.ALARM_SERVICE);\n-        PendingIntent broadcast =\n-            PendingIntent.getBroadcast(\n-                context, 1, notificationIntent, PendingIntent.FLAG_UPDATE_CURRENT);\n-        try {\n-          if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {\n-            alarmManager.setExactAndAllowWhileIdle(\n-                AlarmManager.RTC_WAKEUP, calendar.getTimeInMillis(), broadcast);\n-          } else {\n-            alarmManager.setExact(AlarmManager.RTC_WAKEUP, calendar.getTimeInMillis(), broadcast);\n-          }\n-        } catch (NullPointerException e) {\n-          Logger.log(e);\n-        }\n-      } catch (Exception e) {\n-        Logger.log(e);\n-      }\n-\n-      try {\n-        dbServiceSubscriber.closeRealmObj(mRealm);\n-      } catch (Exception e) {\n-        Logger.log(e);\n-      }\n+      notificationForTodayAnd24HrAlarm(context);\n     } else {\n+      showLocalNotification(context, intent);\n+    }\n+  }\n \n-      Intent notificationIntent1 = new Intent(context, NotificationActivity.class);\n+  private void showLocalNotification(Context context, Intent intent) {\n+    Intent notificationIntent1 = new Intent(context, NotificationActivity.class);\n \n-      TaskStackBuilder stackBuilder = TaskStackBuilder.create(context);\n-      stackBuilder.addParentStack(NotificationActivity.class);\n-      stackBuilder.addNextIntent(notificationIntent1);\n+    TaskStackBuilder stackBuilder = TaskStackBuilder.create(context);\n+    stackBuilder.addParentStack(NotificationActivity.class);\n+    stackBuilder.addNextIntent(notificationIntent1);\n \n-      String title = intent.getStringExtra(\"title\");\n-      String description = intent.getStringExtra(\"description\");\n-      String type = intent.getStringExtra(\"type\");\n-      String studyId = null;\n-      if (intent.getStringExtra(\"studyId\") != null) {\n-        studyId = intent.getStringExtra(\"studyId\");\n-      }\n+    String title = intent.getStringExtra(\"title\");\n+    String description = intent.getStringExtra(\"description\");\n+    String type = intent.getStringExtra(\"type\");\n+    String studyId = null;\n+    if (intent.getStringExtra(\"studyId\") != null) {\n+      studyId = intent.getStringExtra(\"studyId\");\n+    }\n \n-      String activityId = null;\n-      if (intent.getStringExtra(\"activityId\") != null) {\n-        activityId = intent.getStringExtra(\"activityId\");\n-      }\n+    String activityId = null;\n+    if (intent.getStringExtra(\"activityId\") != null) {\n+      activityId = intent.getStringExtra(\"activityId\");\n+    }\n \n-      int notificationId = intent.getIntExtra(\"notificationId\", 0);\n+    int notificationId = intent.getIntExtra(\"notificationId\", 0);\n \n-      Intent notificationIntent;\n-      if (AppConfig.AppType.equalsIgnoreCase(context.getString(R.string.app_gateway))) {\n-        notificationIntent = new Intent(context, StudyActivity.class);\n+    Intent notificationIntent;\n+    if (AppConfig.AppType.equalsIgnoreCase(context.getString(R.string.app_gateway))) {\n+      notificationIntent = new Intent(context, StudyActivity.class);\n+    } else {\n+      notificationIntent = new Intent(context, StandaloneActivity.class);\n+    }\n+    PendingIntent contentIntent = null;\n+    if (!type.equalsIgnoreCase(NotificationModuleSubscriber.NO_USE_NOTIFICATION)) {\n+      notificationIntent.putExtra(StudyActivity.FROM, NOTIFICATION_INTENT);\n+\n+      notificationIntent.putExtra(TYPE, \"Study\");\n+      if (type.equalsIgnoreCase(\"resources\")) {\n+        notificationIntent.putExtra(SUBTYPE, \"Resource\");\n       } else {\n-        notificationIntent = new Intent(context, StandaloneActivity.class);\n+        notificationIntent.putExtra(SUBTYPE, \"Activity\");\n       }\n-      PendingIntent contentIntent = null;\n-      if (!type.equalsIgnoreCase(NotificationModuleSubscriber.NO_USE_NOTIFICATION)) {\n-        notificationIntent.putExtra(StudyActivity.FROM, NOTIFICATION_INTENT);\n+      notificationIntent\n+              .putExtra(STUDYID, studyId)\n+              .putExtra(ACTIVITYID, activityId)\n+              .putExtra(AUDIENCE, \"\")\n+              .putExtra(LOCAL_NOTIFICATION, \"true\")\n+              .putExtra(TITLE, title)\n+              .putExtra(MESSAGE, description)\n+              .setFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP | Intent.FLAG_ACTIVITY_SINGLE_TOP);\n+      contentIntent =\n+              PendingIntent.getActivity(\n+                      context, notificationId, notificationIntent, PendingIntent.FLAG_UPDATE_CURRENT);\n+    }\n \n-        notificationIntent.putExtra(TYPE, \"Study\");\n-        if (type.equalsIgnoreCase(\"resources\")) {\n-          notificationIntent.putExtra(SUBTYPE, \"Resource\");\n-        } else {\n-          notificationIntent.putExtra(SUBTYPE, \"Activity\");\n+    int notifyIcon = R.mipmap.ic_launcher;\n+    Bitmap icon = BitmapFactory.decodeResource(context.getResources(), notifyIcon);\n+    Notification notification = null;\n+    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.LOLLIPOP) {\n+      notification =\n+              createNotificationForLollipopAndAbove(\n+                      context, type, title, description, icon, contentIntent);\n+    } else {\n+      notification =\n+              createNotificationForBelowLollipop(context, type, title, description, contentIntent);\n+    }\n+\n+    try {\n+      int count =\n+              Integer.parseInt(\n+                      AppController.getHelperSharedPreference()\n+                              .readPreference(\n+                                      context,\n+                                      context.getResources().getString(R.string.notificationCount),\n+                                      \"0\"))\n+                      + 1;\n+      AppController.getHelperSharedPreference()\n+              .writePreference(\n+                      context, context.getResources().getString(R.string.notificationCount), \"\" + count);\n+      NotificationManagerCompat notificationManager = NotificationManagerCompat.from(context);\n+\n+      Realm mRealm = AppController.getRealmobj(context);\n+      DBServiceSubscriber dbServiceSubscriber = new DBServiceSubscriber();\n+      UserProfileData mUserProfileData = dbServiceSubscriber.getUserProfileData(mRealm);\n+      StudyList studyList = dbServiceSubscriber.getStudiesDetails(studyId, mRealm);\n+      boolean isNotification = true;\n+      if (mUserProfileData != null) {\n+        isNotification = mUserProfileData.getSettings().isLocalNotifications();\n+      }\n+      if (!studyList.getStatus().equalsIgnoreCase(\"paused\")\n+              && (isNotification\n+              || type.equalsIgnoreCase(\n+              NotificationModuleSubscriber.NOTIFICATION_TURN_OFF_NOTIFICATION))) {\n+        notificationManager.notify(count, notification);\n+        if (type.equalsIgnoreCase(\n+                NotificationModuleSubscriber.NOTIFICATION_TURN_OFF_NOTIFICATION)) {\n+          NotificationModuleSubscriber notificationModuleSubscriber =\n+                  new NotificationModuleSubscriber(dbServiceSubscriber, mRealm);\n+          notificationModuleSubscriber.generateNotificationTurnOffNotification(\n+                  Calendar.getInstance().getTime(), context);\n         }\n-        notificationIntent.putExtra(STUDYID, studyId);\n-        notificationIntent.putExtra(ACTIVITYID, activityId);\n-        notificationIntent.putExtra(AUDIENCE, \"\");\n-        notificationIntent.putExtra(LOCAL_NOTIFICATION, \"true\");\n-        notificationIntent.putExtra(TITLE, title);\n-        notificationIntent.putExtra(MESSAGE, description);\n-        notificationIntent.setFlags(\n-            Intent.FLAG_ACTIVITY_CLEAR_TOP | Intent.FLAG_ACTIVITY_SINGLE_TOP);\n-        contentIntent =\n-            PendingIntent.getActivity(\n-                context, notificationId, notificationIntent, PendingIntent.FLAG_UPDATE_CURRENT);\n       }\n \n-      int notifyIcon = R.mipmap.ic_launcher;\n-      Bitmap icon = BitmapFactory.decodeResource(context.getResources(), notifyIcon);\n-      NotificationCompat.Builder builder = new NotificationCompat.Builder(context);\n-      Notification notification = null;\n-      if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.LOLLIPOP) {\n-        if (type.equalsIgnoreCase(NotificationModuleSubscriber.NO_USE_NOTIFICATION)) {\n-          notification =\n+      dbServiceSubscriber.closeRealmObj(mRealm);\n+    } catch (NumberFormatException | Resources.NotFoundException e) {\n+      Logger.log(e);\n+    } catch (Exception e) {\n+      Logger.log(e);\n+    }\n+  }\n+\n+  private Notification createNotificationForBelowLollipop(\n+          Context context, String type, String title, String description, PendingIntent contentIntent) {\n+    NotificationCompat.Builder builder = new NotificationCompat.Builder(context);\n+    Notification notification;\n+    if (type.equalsIgnoreCase(NotificationModuleSubscriber.NO_USE_NOTIFICATION)) {\n+      notification =\n               builder\n-                  .setContentTitle(title)\n-                  .setLargeIcon(Bitmap.createScaledBitmap(icon, 128, 128, false))\n-                  .setContentText(description)\n-                  .setChannelId(FDAApplication.NOTIFICATION_CHANNEL_ID_INFO)\n-                  .setStyle(new NotificationCompat.BigTextStyle().bigText(description))\n-                  .setSmallIcon(R.mipmap.ic_launcher)\n-                  .setAutoCancel(true)\n-                  .setGroup(\"group\")\n-                  .build();\n-        } else {\n-          notification =\n+                      .setContentTitle(title)\n+                      .setContentText(description)\n+                      .setChannelId(FDAApplication.NOTIFICATION_CHANNEL_ID_INFO)\n+                      .setStyle(new NotificationCompat.BigTextStyle().bigText(description))\n+                      .setSmallIcon(R.mipmap.ic_launcher)\n+                      .setAutoCancel(true)\n+                      .setGroup(\"group\")\n+                      .build();\n+    } else {\n+      notification =\n               builder\n-                  .setContentTitle(title)\n-                  .setLargeIcon(Bitmap.createScaledBitmap(icon, 128, 128, false))\n-                  .setContentText(description)\n-                  .setChannelId(FDAApplication.NOTIFICATION_CHANNEL_ID_INFO)\n-                  .setStyle(new NotificationCompat.BigTextStyle().bigText(description))\n-                  .setSmallIcon(R.mipmap.ic_launcher)\n-                  .setAutoCancel(true)\n-                  .setContentIntent(contentIntent)\n-                  .setGroup(\"group\")\n-                  .build();\n-        }\n-      } else {\n-        if (type.equalsIgnoreCase(NotificationModuleSubscriber.NO_USE_NOTIFICATION)) {\n-          notification =\n+                      .setContentTitle(title)\n+                      .setContentText(description)\n+                      .setChannelId(FDAApplication.NOTIFICATION_CHANNEL_ID_INFO)\n+                      .setStyle(new NotificationCompat.BigTextStyle().bigText(description))\n+                      .setSmallIcon(R.mipmap.ic_launcher)\n+                      .setAutoCancel(true)\n+                      .setContentIntent(contentIntent)\n+                      .setGroup(\"group\")\n+                      .build();\n+    }\n+    return notification;\n+  }\n+\n+  private Notification createNotificationForLollipopAndAbove(\n+          Context context,\n+          String type,\n+          String title,\n+          String description,\n+          Bitmap icon,\n+          PendingIntent contentIntent) {\n+    NotificationCompat.Builder builder = new NotificationCompat.Builder(context);\n+    Notification notification;\n+    if (type.equalsIgnoreCase(NotificationModuleSubscriber.NO_USE_NOTIFICATION)) {\n+      notification =\n               builder\n-                  .setContentTitle(title)\n-                  .setContentText(description)\n-                  .setChannelId(FDAApplication.NOTIFICATION_CHANNEL_ID_INFO)\n-                  .setStyle(new NotificationCompat.BigTextStyle().bigText(description))\n-                  .setSmallIcon(R.mipmap.ic_launcher)\n-                  .setAutoCancel(true)\n-                  .setGroup(\"group\")\n-                  .build();\n-        } else {\n-          notification =\n+                      .setContentTitle(title)\n+                      .setLargeIcon(Bitmap.createScaledBitmap(icon, 128, 128, false))\n+                      .setContentText(description)\n+                      .setChannelId(FDAApplication.NOTIFICATION_CHANNEL_ID_INFO)\n+                      .setStyle(new NotificationCompat.BigTextStyle().bigText(description))\n+                      .setSmallIcon(R.mipmap.ic_launcher)\n+                      .setAutoCancel(true)\n+                      .setGroup(\"group\")\n+                      .build();\n+    } else {\n+      notification =\n               builder\n-                  .setContentTitle(title)\n-                  .setContentText(description)\n-                  .setChannelId(FDAApplication.NOTIFICATION_CHANNEL_ID_INFO)\n-                  .setStyle(new NotificationCompat.BigTextStyle().bigText(description))\n-                  .setSmallIcon(R.mipmap.ic_launcher)\n-                  .setAutoCancel(true)\n-                  .setContentIntent(contentIntent)\n-                  .setGroup(\"group\")\n-                  .build();\n-        }\n-      }\n-\n-      try {\n-        int count =\n-            Integer.parseInt(\n-                    AppController.getHelperSharedPreference()\n-                        .readPreference(\n-                            context,\n-                            context.getResources().getString(R.string.notificationCount),\n-                            \"0\"))\n-                + 1;\n-        AppController.getHelperSharedPreference()\n-            .writePreference(\n-                context, context.getResources().getString(R.string.notificationCount), \"\" + count);\n-        NotificationManagerCompat notificationManager = NotificationManagerCompat.from(context);\n-\n-        Realm mRealm = AppController.getRealmobj(context);\n-        DBServiceSubscriber dbServiceSubscriber = new DBServiceSubscriber();\n-        UserProfileData mUserProfileData = dbServiceSubscriber.getUserProfileData(mRealm);\n-        StudyList studyList = dbServiceSubscriber.getStudiesDetails(studyId, mRealm);\n-        boolean isNotification = true;\n-        if (mUserProfileData != null) {\n-          isNotification = mUserProfileData.getSettings().isLocalNotifications();\n-        }\n-        if (!studyList.getStatus().equalsIgnoreCase(\"paused\")\n-            && (isNotification\n-                || type.equalsIgnoreCase(\n-                    NotificationModuleSubscriber.NOTIFICATION_TURN_OFF_NOTIFICATION))) {\n-          notificationManager.notify(count, notification);\n-          if (type.equalsIgnoreCase(\n-              NotificationModuleSubscriber.NOTIFICATION_TURN_OFF_NOTIFICATION)) {\n-            NotificationModuleSubscriber notificationModuleSubscriber =\n-                new NotificationModuleSubscriber(dbServiceSubscriber, mRealm);\n-            notificationModuleSubscriber.generateNotificationTurnOffNotification(\n-                Calendar.getInstance().getTime(), context);\n-          }\n-        }\n+                      .setContentTitle(title)\n+                      .setLargeIcon(Bitmap.createScaledBitmap(icon, 128, 128, false))\n+                      .setContentText(description)\n+                      .setChannelId(FDAApplication.NOTIFICATION_CHANNEL_ID_INFO)\n+                      .setStyle(new NotificationCompat.BigTextStyle().bigText(description))\n+                      .setSmallIcon(R.mipmap.ic_launcher)\n+                      .setAutoCancel(true)\n+                      .setContentIntent(contentIntent)\n+                      .setGroup(\"group\")\n+                      .build();\n+    }\n+    return notification;\n+  }\n \n-        dbServiceSubscriber.closeRealmObj(mRealm);\n-      } catch (NumberFormatException | Resources.NotFoundException e) {\n-        Logger.log(e);\n-      } catch (Exception e) {\n-        Logger.log(e);\n+  private void notificationForTodayAnd24HrAlarm(Context context) {\n+    Realm mRealm = AppController.getRealmobj(context);\n+    DBServiceSubscriber dbServiceSubscriber = new DBServiceSubscriber();\n+    RealmResults<NotificationDb> notificationDbs =\n+            dbServiceSubscriber.getNotificationDbByCurrentDate(mRealm);\n+    NotificationModuleSubscriber notificationModuleSubscriber =\n+            new NotificationModuleSubscriber(dbServiceSubscriber, mRealm);\n+    if (notificationDbs != null) {\n+      for (NotificationDb notificationDb : notificationDbs) {\n+        Calendar time = Calendar.getInstance();\n+        time.setTime(notificationDb.getDateTime());\n+        notificationModuleSubscriber.setAlarm(\n+                context,\n+                notificationDb.getTitle(),\n+                notificationDb.getDescription(),\n+                notificationDb.getType(),\n+                notificationDb.getNotificationId(),\n+                notificationDb.getStudyId(),\n+                notificationDb.getActivityId(),\n+                time);\n       }\n     }\n+    Calendar calendar = NotificationModuleSubscriber.getCalenderNextDay();\n+\n+    Intent notificationIntent =\n+            new Intent(context, AlarmReceiver.class)\n+                    .setAction(\"android.media.action.DISPLAY_NOTIFICATION\")\n+                    .addCategory(\"android.intent.category.DEFAULT\")\n+                    .putExtra(\"pendingIntentId\", 1);\n+    AlarmManager alarmManager = (AlarmManager) context.getSystemService(Context.ALARM_SERVICE);\n+    PendingIntent broadcast =\n+            PendingIntent.getBroadcast(\n+                    context, 1, notificationIntent, PendingIntent.FLAG_UPDATE_CURRENT);\n+    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {\n+      alarmManager.setExactAndAllowWhileIdle(\n+              AlarmManager.RTC_WAKEUP, calendar.getTimeInMillis(), broadcast);\n+    } else {\n+      alarmManager.setExact(AlarmManager.RTC_WAKEUP, calendar.getTimeInMillis(), broadcast);\n+    }\n+    dbServiceSubscriber.closeRealmObj(mRealm);\n   }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTE5MTc3Mw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/420#discussion_r431191773", "bodyText": "More duplicated logic. Please extract to a helper function.", "author": "nikklassen", "createdAt": "2020-05-27T14:43:04Z", "path": "Android/app/src/main/java/com/harvard/notificationmodule/NotificationModuleSubscriber.java", "diffHunk": "@@ -252,61 +213,140 @@ public void generateActivityLocalNotification(\n           notificationDb.setId(1);\n           notificationDb.setEndDateTime(removeOffset(activityRun.getEndDate(), offset));\n           dbServiceSubscriber.updateNotificationToDb(context, notificationDb);\n+          set24hourScheduler(context);", "originalCommit": "7ba1cc830224e7f6ce12a9c0bcacf910a46b55c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjA0MjYwMQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/420#discussion_r432042601", "bodyText": "updated in the latest commit.", "author": "naveenr-btc", "createdAt": "2020-05-28T18:38:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTE5MTc3Mw=="}], "type": "inlineReview", "revised_code": {"commit": "91ddd774b776e07458c06ec87cb1131b29069579", "chunk": "diff --git a/Android/app/src/main/java/com/harvard/notificationmodule/NotificationModuleSubscriber.java b/Android/app/src/main/java/com/harvard/notificationmodule/NotificationModuleSubscriber.java\nindex c1ccff563..402ff3f5a 100644\n--- a/Android/app/src/main/java/com/harvard/notificationmodule/NotificationModuleSubscriber.java\n+++ b/Android/app/src/main/java/com/harvard/notificationmodule/NotificationModuleSubscriber.java\n\n@@ -67,217 +69,128 @@ public class NotificationModuleSubscriber {\n     Calendar time = Calendar.getInstance();\n     Calendar time1 = Calendar.getInstance();\n     ActivitiesWS activitiesWS =\n-        dbServiceSubscriber.getActivityItem(\n-            activityRun.getStudyId(), activityRun.getActivityId(), mRealm);\n-\n-    try {\n-      if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_ONE_TIME)) {\n-        Date date = removeOffset(activityRun.getEndDate(), offset);\n-        time.setTime(date);\n-        time.add(Calendar.HOUR_OF_DAY, -24);\n-\n-        Date date1 = removeOffset(activityRun.getStartDate(), offset);\n-        time1.setTime(date1);\n-\n-        description =\n-            context.getResources().getString(R.string.the_activity)\n-                + \" \"\n-                + activitiesWS.getTitle()\n-                + \" \"\n-                + context.getResources().getString(R.string.participation_is_important);\n-        description1 =\n-            context.getResources().getString(R.string.the_activity)\n-                + \" \"\n-                + activitiesWS.getTitle()\n-                + \", \"\n-                + context.getResources().getString(R.string.now_available_to_take);\n-      } else if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_MANUALLY_SCHEDULE)) {\n-        Date date = removeOffset(activityRun.getStartDate(), offset);\n-        time.setTime(date);\n-        description =\n-            context.getResources().getString(R.string.scheduled_activity)\n-                + \" \"\n-                + activitiesWS.getTitle()\n-                + \", \"\n-                + context.getResources().getString(R.string.valid_until)\n-                + \" \"\n-                + notificationFormat.format(activityRun.getEndDate())\n-                + context.getResources().getString(R.string.participation_is_important2);\n-      } else if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_WEEKLY)) {\n-        Date date = removeOffset(activityRun.getEndDate(), offset);\n-        time.setTime(date);\n-        time.add(Calendar.HOUR_OF_DAY, -24);\n-\n-        Date date1 = removeOffset(activityRun.getStartDate(), offset);\n-        time1.setTime(date1);\n-\n-        description =\n-            context.getResources().getString(R.string.weekly_activity)\n-                + \" \"\n-                + activitiesWS.getTitle()\n-                + \", \"\n-                + context.getResources().getString(R.string.participation_is_important);\n-        description1 =\n-            context.getResources().getString(R.string.new_run)\n-                + \" \"\n-                + activitiesWS.getTitle()\n-                + \", \"\n-                + context.getResources().getString(R.string.study_complete);\n-      } else if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_MONTHLY)) {\n-        Date date = removeOffset(activityRun.getEndDate(), offset);\n-        time.setTime(date);\n-        time.add(Calendar.HOUR_OF_DAY, -72);\n-\n-        Date date1 = removeOffset(activityRun.getStartDate(), offset);\n-        time1.setTime(date1);\n-\n-        description =\n-            context.getResources().getString(R.string.monthly_activity)\n-                + \" \"\n-                + activitiesWS.getTitle()\n-                + \", \"\n-                + context.getResources().getString(R.string.expire_in_three_days);\n-        description1 =\n-            context.getResources().getString(R.string.new_run_monthly_activity)\n-                + \" \"\n-                + activitiesWS.getTitle()\n-                + \", \"\n-                + context.getResources().getString(R.string.study_complete);\n-      } else if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_DAILY)) {\n-        Date date = removeOffset(activityRun.getStartDate(), offset);\n-        time.setTime(date);\n-        description =\n-            context.getResources().getString(R.string.new_run_daily_activity)\n-                + \" \"\n-                + activitiesWS.getTitle()\n-                + \", \"\n-                + context.getResources().getString(R.string.your_participation_important);\n-      } else if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_WITHIN_A_DAY)) {\n-        Date date = removeOffset(activityRun.getStartDate(), offset);\n-        time.setTime(date);\n-        description =\n-            context.getResources().getString(R.string.new_run_daily_activity)\n-                + \" \"\n-                + activitiesWS.getTitle()\n-                + \", \"\n-                + context.getResources().getString(R.string.valid_until)\n-                + \" \"\n-                + notificationFormat.format(activityRun.getEndDate())\n-                + context.getResources().getString(R.string.participation_is_important2);\n-      }\n-\n-      int notificationId;\n-\n-      if (time.getTime().after(new Date())) {\n-        notificationId = new Random().nextInt();\n-        NotificationDb notificationDb = new NotificationDb();\n-        notificationDb.setStudyId(activityRun.getStudyId());\n-        notificationDb.setActivityId(activityRun.getActivityId());\n-        notificationDb.setNotificationId(notificationId);\n-        notificationDb.setDateTime(time.getTime());\n-        notificationDb.setType(ACTIVITY);\n-        notificationDb.setId(1);\n-        notificationDb.setTitle(title);\n-        notificationDb.setDescription(description);\n-        notificationDb.setEndDateTime(removeOffset(activityRun.getEndDate(), offset));\n-        dbServiceSubscriber.updateNotificationToDb(context, notificationDb);\n-\n-        set24hourScheduler(context);\n-        if (isSameDay(new Date(), time.getTime())) {\n-          setAlarm(\n-              context,\n-              title,\n-              description,\n-              ACTIVITY,\n-              notificationId,\n-              activityRun.getStudyId(),\n-              activityRun.getActivityId(),\n-              time);\n-        }\n-      }\n-\n-      // Notification availability for monthly, weekly, One time\n-      if ((type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_MONTHLY)\n-          || type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_WEEKLY)\n-          || type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_ONE_TIME))) {\n-        if (time1.getTime().after(new Date())) {\n-          notificationId = new Random().nextInt();\n-          NotificationDb notificationDb = new NotificationDb();\n-          notificationDb.setStudyId(activityRun.getStudyId());\n-          notificationDb.setActivityId(activityRun.getActivityId());\n-          notificationDb.setNotificationId(notificationId);\n-          notificationDb.setDateTime(time1.getTime());\n-          notificationDb.setType(ACTIVITY);\n-          notificationDb.setTitle(title);\n-          notificationDb.setDescription(description1);\n-          notificationDb.setId(1);\n-          notificationDb.setEndDateTime(removeOffset(activityRun.getEndDate(), offset));\n-          dbServiceSubscriber.updateNotificationToDb(context, notificationDb);\n-          set24hourScheduler(context);\n-          if (isSameDay(new Date(), time1.getTime())) {\n-            setAlarm(\n-                context,\n-                title,\n-                description1,\n-                ACTIVITY,\n-                notificationId,\n-                activityRun.getStudyId(),\n-                activityRun.getActivityId(),\n-                time1);\n-          }\n-        }\n-      }\n-\n-    } catch (Exception e) {\n-      Logger.log(e);\n+            dbServiceSubscriber.getActivityItem(\n+                    activityRun.getStudyId(), activityRun.getActivityId(), mRealm);\n+\n+    if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_ONE_TIME)) {\n+      Date date = removeOffset(activityRun.getEndDate(), offset);\n+      time.setTime(date);\n+      time.add(Calendar.HOUR_OF_DAY, -24);\n+\n+      Date date1 = removeOffset(activityRun.getStartDate(), offset);\n+      time1.setTime(date1);\n+\n+      description =\n+              context.getResources().getString(R.string.the_activity)\n+                      + \" \"\n+                      + activitiesWS.getTitle()\n+                      + \" \"\n+                      + context.getResources().getString(R.string.participation_is_important);\n+      description1 =\n+              context.getResources().getString(R.string.the_activity)\n+                      + \" \"\n+                      + activitiesWS.getTitle()\n+                      + \", \"\n+                      + context.getResources().getString(R.string.now_available_to_take);\n+    } else if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_MANUALLY_SCHEDULE)) {\n+      Date date = removeOffset(activityRun.getStartDate(), offset);\n+      time.setTime(date);\n+      description =\n+              context.getResources().getString(R.string.scheduled_activity)\n+                      + \" \"\n+                      + activitiesWS.getTitle()\n+                      + \", \"\n+                      + context.getResources().getString(R.string.valid_until)\n+                      + \" \"\n+                      + notificationFormat.format(activityRun.getEndDate())\n+                      + context.getResources().getString(R.string.participation_is_important2);\n+    } else if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_WEEKLY)) {\n+      Date date = removeOffset(activityRun.getEndDate(), offset);\n+      time.setTime(date);\n+      time.add(Calendar.HOUR_OF_DAY, -24);\n+\n+      Date date1 = removeOffset(activityRun.getStartDate(), offset);\n+      time1.setTime(date1);\n+\n+      description =\n+              context.getResources().getString(R.string.weekly_activity)\n+                      + \" \"\n+                      + activitiesWS.getTitle()\n+                      + \", \"\n+                      + context.getResources().getString(R.string.participation_is_important);\n+      description1 =\n+              context.getResources().getString(R.string.new_run)\n+                      + \" \"\n+                      + activitiesWS.getTitle()\n+                      + \", \"\n+                      + context.getResources().getString(R.string.study_complete);\n+    } else if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_MONTHLY)) {\n+      Date date = removeOffset(activityRun.getEndDate(), offset);\n+      time.setTime(date);\n+      time.add(Calendar.HOUR_OF_DAY, -72);\n+\n+      Date date1 = removeOffset(activityRun.getStartDate(), offset);\n+      time1.setTime(date1);\n+\n+      description =\n+              context.getResources().getString(R.string.monthly_activity)\n+                      + \" \"\n+                      + activitiesWS.getTitle()\n+                      + \", \"\n+                      + context.getResources().getString(R.string.expire_in_three_days);\n+      description1 =\n+              context.getResources().getString(R.string.new_run_monthly_activity)\n+                      + \" \"\n+                      + activitiesWS.getTitle()\n+                      + \", \"\n+                      + context.getResources().getString(R.string.study_complete);\n+    } else if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_DAILY)) {\n+      Date date = removeOffset(activityRun.getStartDate(), offset);\n+      time.setTime(date);\n+      description =\n+              context.getResources().getString(R.string.new_run_daily_activity)\n+                      + \" \"\n+                      + activitiesWS.getTitle()\n+                      + \", \"\n+                      + context.getResources().getString(R.string.your_participation_important);\n+    } else if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_WITHIN_A_DAY)) {\n+      Date date = removeOffset(activityRun.getStartDate(), offset);\n+      time.setTime(date);\n+      description =\n+              context.getResources().getString(R.string.new_run_daily_activity)\n+                      + \" \"\n+                      + activitiesWS.getTitle()\n+                      + \", \"\n+                      + context.getResources().getString(R.string.valid_until)\n+                      + \" \"\n+                      + notificationFormat.format(activityRun.getEndDate())\n+                      + context.getResources().getString(R.string.participation_is_important2);\n+    }\n+    updateNotificationToDbAndSetAlarm(context, activityRun, time, title, description, offset);\n+    // Notification availability for monthly, weekly, One time\n+    if ((type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_MONTHLY)\n+            || type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_WEEKLY)\n+            || type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_ONE_TIME))) {\n+      updateNotificationToDbAndSetAlarm(context, activityRun, time1, title, description1, offset);\n     }\n   }\n \n   private void set24hourScheduler(Context context) {\n-    // checking if alram is working with pendingIntent\n-    boolean isWorking = false;\n-    try {\n-      Intent notificationIntent1 = new Intent(context, AlarmReceiver.class);\n-      notificationIntent1.setAction(\"android.media.action.DISPLAY_NOTIFICATION\");\n-      notificationIntent1.addCategory(\"android.intent.category.DEFAULT\");\n-      notificationIntent1.putExtra(\"pendingIntentId\", 1);\n-      isWorking =\n-          (PendingIntent.getBroadcast(context, 1, notificationIntent1, PendingIntent.FLAG_NO_CREATE)\n-              != null); // just changed the flag\n-    } catch (Exception e) {\n-      Logger.log(e);\n-    }\n-\n-    if (!isWorking) {\n-      Calendar calendar = Calendar.getInstance();\n-      calendar.set(Calendar.HOUR_OF_DAY, 0);\n-      calendar.set(Calendar.MINUTE, 0);\n-      calendar.set(Calendar.SECOND, 0);\n-      calendar.set(Calendar.MILLISECOND, 0);\n-      calendar.add(Calendar.DATE, 1);\n-\n-      try {\n-        Intent notificationIntent = new Intent(context, AlarmReceiver.class);\n-        notificationIntent.setAction(\"android.media.action.DISPLAY_NOTIFICATION\");\n-        notificationIntent.addCategory(\"android.intent.category.DEFAULT\");\n-        notificationIntent.putExtra(\"pendingIntentId\", 1);\n-        AlarmManager alarmManager = (AlarmManager) context.getSystemService(Context.ALARM_SERVICE);\n-        PendingIntent broadcast =\n+    Calendar calendar = getCalenderNextDay();\n+    Intent notificationIntent =\n+            new Intent(context, AlarmReceiver.class)\n+                    .setAction(\"android.media.action.DISPLAY_NOTIFICATION\")\n+                    .addCategory(\"android.intent.category.DEFAULT\")\n+                    .putExtra(\"pendingIntentId\", 1);\n+    AlarmManager alarmManager = (AlarmManager) context.getSystemService(Context.ALARM_SERVICE);\n+    PendingIntent broadcast =\n             PendingIntent.getBroadcast(\n-                context, 1, notificationIntent, PendingIntent.FLAG_UPDATE_CURRENT);\n-        try {\n-          if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {\n-            alarmManager.setExactAndAllowWhileIdle(\n-                AlarmManager.RTC_WAKEUP, calendar.getTimeInMillis(), broadcast);\n-          } else {\n-            alarmManager.setExact(AlarmManager.RTC_WAKEUP, calendar.getTimeInMillis(), broadcast);\n-          }\n-        } catch (NullPointerException e) {\n-          Logger.log(e);\n-        }\n-      } catch (Exception e) {\n-        Logger.log(e);\n-      }\n+                    context, 1, notificationIntent, PendingIntent.FLAG_UPDATE_CURRENT);\n+    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {\n+      alarmManager.setExactAndAllowWhileIdle(\n+              AlarmManager.RTC_WAKEUP, calendar.getTimeInMillis(), broadcast);\n+    } else {\n+      alarmManager.setExact(AlarmManager.RTC_WAKEUP, calendar.getTimeInMillis(), broadcast);\n     }\n   }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTE5MjE4NA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/420#discussion_r431192184", "bodyText": "nit: typo, alarm", "author": "nikklassen", "createdAt": "2020-05-27T14:43:35Z", "path": "Android/app/src/main/java/com/harvard/notificationmodule/NotificationModuleSubscriber.java", "diffHunk": "@@ -252,61 +213,140 @@ public void generateActivityLocalNotification(\n           notificationDb.setId(1);\n           notificationDb.setEndDateTime(removeOffset(activityRun.getEndDate(), offset));\n           dbServiceSubscriber.updateNotificationToDb(context, notificationDb);\n+          set24hourScheduler(context);\n+          if (isSameDay(new Date(), time1.getTime())) {\n+            setAlarm(\n+                context,\n+                title,\n+                description1,\n+                ACTIVITY,\n+                notificationId,\n+                activityRun.getStudyId(),\n+                activityRun.getActivityId(),\n+                time1);\n+          }\n+        }\n+      }\n+\n+    } catch (Exception e) {\n+      Logger.log(e);\n+    }\n+  }\n+\n+  private void set24hourScheduler(Context context) {\n+    // checking if alram is working with pendingIntent", "originalCommit": "7ba1cc830224e7f6ce12a9c0bcacf910a46b55c6", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "91ddd774b776e07458c06ec87cb1131b29069579", "chunk": "diff --git a/Android/app/src/main/java/com/harvard/notificationmodule/NotificationModuleSubscriber.java b/Android/app/src/main/java/com/harvard/notificationmodule/NotificationModuleSubscriber.java\nindex c1ccff563..402ff3f5a 100644\n--- a/Android/app/src/main/java/com/harvard/notificationmodule/NotificationModuleSubscriber.java\n+++ b/Android/app/src/main/java/com/harvard/notificationmodule/NotificationModuleSubscriber.java\n\n@@ -67,217 +69,128 @@ public class NotificationModuleSubscriber {\n     Calendar time = Calendar.getInstance();\n     Calendar time1 = Calendar.getInstance();\n     ActivitiesWS activitiesWS =\n-        dbServiceSubscriber.getActivityItem(\n-            activityRun.getStudyId(), activityRun.getActivityId(), mRealm);\n-\n-    try {\n-      if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_ONE_TIME)) {\n-        Date date = removeOffset(activityRun.getEndDate(), offset);\n-        time.setTime(date);\n-        time.add(Calendar.HOUR_OF_DAY, -24);\n-\n-        Date date1 = removeOffset(activityRun.getStartDate(), offset);\n-        time1.setTime(date1);\n-\n-        description =\n-            context.getResources().getString(R.string.the_activity)\n-                + \" \"\n-                + activitiesWS.getTitle()\n-                + \" \"\n-                + context.getResources().getString(R.string.participation_is_important);\n-        description1 =\n-            context.getResources().getString(R.string.the_activity)\n-                + \" \"\n-                + activitiesWS.getTitle()\n-                + \", \"\n-                + context.getResources().getString(R.string.now_available_to_take);\n-      } else if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_MANUALLY_SCHEDULE)) {\n-        Date date = removeOffset(activityRun.getStartDate(), offset);\n-        time.setTime(date);\n-        description =\n-            context.getResources().getString(R.string.scheduled_activity)\n-                + \" \"\n-                + activitiesWS.getTitle()\n-                + \", \"\n-                + context.getResources().getString(R.string.valid_until)\n-                + \" \"\n-                + notificationFormat.format(activityRun.getEndDate())\n-                + context.getResources().getString(R.string.participation_is_important2);\n-      } else if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_WEEKLY)) {\n-        Date date = removeOffset(activityRun.getEndDate(), offset);\n-        time.setTime(date);\n-        time.add(Calendar.HOUR_OF_DAY, -24);\n-\n-        Date date1 = removeOffset(activityRun.getStartDate(), offset);\n-        time1.setTime(date1);\n-\n-        description =\n-            context.getResources().getString(R.string.weekly_activity)\n-                + \" \"\n-                + activitiesWS.getTitle()\n-                + \", \"\n-                + context.getResources().getString(R.string.participation_is_important);\n-        description1 =\n-            context.getResources().getString(R.string.new_run)\n-                + \" \"\n-                + activitiesWS.getTitle()\n-                + \", \"\n-                + context.getResources().getString(R.string.study_complete);\n-      } else if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_MONTHLY)) {\n-        Date date = removeOffset(activityRun.getEndDate(), offset);\n-        time.setTime(date);\n-        time.add(Calendar.HOUR_OF_DAY, -72);\n-\n-        Date date1 = removeOffset(activityRun.getStartDate(), offset);\n-        time1.setTime(date1);\n-\n-        description =\n-            context.getResources().getString(R.string.monthly_activity)\n-                + \" \"\n-                + activitiesWS.getTitle()\n-                + \", \"\n-                + context.getResources().getString(R.string.expire_in_three_days);\n-        description1 =\n-            context.getResources().getString(R.string.new_run_monthly_activity)\n-                + \" \"\n-                + activitiesWS.getTitle()\n-                + \", \"\n-                + context.getResources().getString(R.string.study_complete);\n-      } else if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_DAILY)) {\n-        Date date = removeOffset(activityRun.getStartDate(), offset);\n-        time.setTime(date);\n-        description =\n-            context.getResources().getString(R.string.new_run_daily_activity)\n-                + \" \"\n-                + activitiesWS.getTitle()\n-                + \", \"\n-                + context.getResources().getString(R.string.your_participation_important);\n-      } else if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_WITHIN_A_DAY)) {\n-        Date date = removeOffset(activityRun.getStartDate(), offset);\n-        time.setTime(date);\n-        description =\n-            context.getResources().getString(R.string.new_run_daily_activity)\n-                + \" \"\n-                + activitiesWS.getTitle()\n-                + \", \"\n-                + context.getResources().getString(R.string.valid_until)\n-                + \" \"\n-                + notificationFormat.format(activityRun.getEndDate())\n-                + context.getResources().getString(R.string.participation_is_important2);\n-      }\n-\n-      int notificationId;\n-\n-      if (time.getTime().after(new Date())) {\n-        notificationId = new Random().nextInt();\n-        NotificationDb notificationDb = new NotificationDb();\n-        notificationDb.setStudyId(activityRun.getStudyId());\n-        notificationDb.setActivityId(activityRun.getActivityId());\n-        notificationDb.setNotificationId(notificationId);\n-        notificationDb.setDateTime(time.getTime());\n-        notificationDb.setType(ACTIVITY);\n-        notificationDb.setId(1);\n-        notificationDb.setTitle(title);\n-        notificationDb.setDescription(description);\n-        notificationDb.setEndDateTime(removeOffset(activityRun.getEndDate(), offset));\n-        dbServiceSubscriber.updateNotificationToDb(context, notificationDb);\n-\n-        set24hourScheduler(context);\n-        if (isSameDay(new Date(), time.getTime())) {\n-          setAlarm(\n-              context,\n-              title,\n-              description,\n-              ACTIVITY,\n-              notificationId,\n-              activityRun.getStudyId(),\n-              activityRun.getActivityId(),\n-              time);\n-        }\n-      }\n-\n-      // Notification availability for monthly, weekly, One time\n-      if ((type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_MONTHLY)\n-          || type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_WEEKLY)\n-          || type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_ONE_TIME))) {\n-        if (time1.getTime().after(new Date())) {\n-          notificationId = new Random().nextInt();\n-          NotificationDb notificationDb = new NotificationDb();\n-          notificationDb.setStudyId(activityRun.getStudyId());\n-          notificationDb.setActivityId(activityRun.getActivityId());\n-          notificationDb.setNotificationId(notificationId);\n-          notificationDb.setDateTime(time1.getTime());\n-          notificationDb.setType(ACTIVITY);\n-          notificationDb.setTitle(title);\n-          notificationDb.setDescription(description1);\n-          notificationDb.setId(1);\n-          notificationDb.setEndDateTime(removeOffset(activityRun.getEndDate(), offset));\n-          dbServiceSubscriber.updateNotificationToDb(context, notificationDb);\n-          set24hourScheduler(context);\n-          if (isSameDay(new Date(), time1.getTime())) {\n-            setAlarm(\n-                context,\n-                title,\n-                description1,\n-                ACTIVITY,\n-                notificationId,\n-                activityRun.getStudyId(),\n-                activityRun.getActivityId(),\n-                time1);\n-          }\n-        }\n-      }\n-\n-    } catch (Exception e) {\n-      Logger.log(e);\n+            dbServiceSubscriber.getActivityItem(\n+                    activityRun.getStudyId(), activityRun.getActivityId(), mRealm);\n+\n+    if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_ONE_TIME)) {\n+      Date date = removeOffset(activityRun.getEndDate(), offset);\n+      time.setTime(date);\n+      time.add(Calendar.HOUR_OF_DAY, -24);\n+\n+      Date date1 = removeOffset(activityRun.getStartDate(), offset);\n+      time1.setTime(date1);\n+\n+      description =\n+              context.getResources().getString(R.string.the_activity)\n+                      + \" \"\n+                      + activitiesWS.getTitle()\n+                      + \" \"\n+                      + context.getResources().getString(R.string.participation_is_important);\n+      description1 =\n+              context.getResources().getString(R.string.the_activity)\n+                      + \" \"\n+                      + activitiesWS.getTitle()\n+                      + \", \"\n+                      + context.getResources().getString(R.string.now_available_to_take);\n+    } else if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_MANUALLY_SCHEDULE)) {\n+      Date date = removeOffset(activityRun.getStartDate(), offset);\n+      time.setTime(date);\n+      description =\n+              context.getResources().getString(R.string.scheduled_activity)\n+                      + \" \"\n+                      + activitiesWS.getTitle()\n+                      + \", \"\n+                      + context.getResources().getString(R.string.valid_until)\n+                      + \" \"\n+                      + notificationFormat.format(activityRun.getEndDate())\n+                      + context.getResources().getString(R.string.participation_is_important2);\n+    } else if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_WEEKLY)) {\n+      Date date = removeOffset(activityRun.getEndDate(), offset);\n+      time.setTime(date);\n+      time.add(Calendar.HOUR_OF_DAY, -24);\n+\n+      Date date1 = removeOffset(activityRun.getStartDate(), offset);\n+      time1.setTime(date1);\n+\n+      description =\n+              context.getResources().getString(R.string.weekly_activity)\n+                      + \" \"\n+                      + activitiesWS.getTitle()\n+                      + \", \"\n+                      + context.getResources().getString(R.string.participation_is_important);\n+      description1 =\n+              context.getResources().getString(R.string.new_run)\n+                      + \" \"\n+                      + activitiesWS.getTitle()\n+                      + \", \"\n+                      + context.getResources().getString(R.string.study_complete);\n+    } else if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_MONTHLY)) {\n+      Date date = removeOffset(activityRun.getEndDate(), offset);\n+      time.setTime(date);\n+      time.add(Calendar.HOUR_OF_DAY, -72);\n+\n+      Date date1 = removeOffset(activityRun.getStartDate(), offset);\n+      time1.setTime(date1);\n+\n+      description =\n+              context.getResources().getString(R.string.monthly_activity)\n+                      + \" \"\n+                      + activitiesWS.getTitle()\n+                      + \", \"\n+                      + context.getResources().getString(R.string.expire_in_three_days);\n+      description1 =\n+              context.getResources().getString(R.string.new_run_monthly_activity)\n+                      + \" \"\n+                      + activitiesWS.getTitle()\n+                      + \", \"\n+                      + context.getResources().getString(R.string.study_complete);\n+    } else if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_DAILY)) {\n+      Date date = removeOffset(activityRun.getStartDate(), offset);\n+      time.setTime(date);\n+      description =\n+              context.getResources().getString(R.string.new_run_daily_activity)\n+                      + \" \"\n+                      + activitiesWS.getTitle()\n+                      + \", \"\n+                      + context.getResources().getString(R.string.your_participation_important);\n+    } else if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_WITHIN_A_DAY)) {\n+      Date date = removeOffset(activityRun.getStartDate(), offset);\n+      time.setTime(date);\n+      description =\n+              context.getResources().getString(R.string.new_run_daily_activity)\n+                      + \" \"\n+                      + activitiesWS.getTitle()\n+                      + \", \"\n+                      + context.getResources().getString(R.string.valid_until)\n+                      + \" \"\n+                      + notificationFormat.format(activityRun.getEndDate())\n+                      + context.getResources().getString(R.string.participation_is_important2);\n+    }\n+    updateNotificationToDbAndSetAlarm(context, activityRun, time, title, description, offset);\n+    // Notification availability for monthly, weekly, One time\n+    if ((type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_MONTHLY)\n+            || type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_WEEKLY)\n+            || type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_ONE_TIME))) {\n+      updateNotificationToDbAndSetAlarm(context, activityRun, time1, title, description1, offset);\n     }\n   }\n \n   private void set24hourScheduler(Context context) {\n-    // checking if alram is working with pendingIntent\n-    boolean isWorking = false;\n-    try {\n-      Intent notificationIntent1 = new Intent(context, AlarmReceiver.class);\n-      notificationIntent1.setAction(\"android.media.action.DISPLAY_NOTIFICATION\");\n-      notificationIntent1.addCategory(\"android.intent.category.DEFAULT\");\n-      notificationIntent1.putExtra(\"pendingIntentId\", 1);\n-      isWorking =\n-          (PendingIntent.getBroadcast(context, 1, notificationIntent1, PendingIntent.FLAG_NO_CREATE)\n-              != null); // just changed the flag\n-    } catch (Exception e) {\n-      Logger.log(e);\n-    }\n-\n-    if (!isWorking) {\n-      Calendar calendar = Calendar.getInstance();\n-      calendar.set(Calendar.HOUR_OF_DAY, 0);\n-      calendar.set(Calendar.MINUTE, 0);\n-      calendar.set(Calendar.SECOND, 0);\n-      calendar.set(Calendar.MILLISECOND, 0);\n-      calendar.add(Calendar.DATE, 1);\n-\n-      try {\n-        Intent notificationIntent = new Intent(context, AlarmReceiver.class);\n-        notificationIntent.setAction(\"android.media.action.DISPLAY_NOTIFICATION\");\n-        notificationIntent.addCategory(\"android.intent.category.DEFAULT\");\n-        notificationIntent.putExtra(\"pendingIntentId\", 1);\n-        AlarmManager alarmManager = (AlarmManager) context.getSystemService(Context.ALARM_SERVICE);\n-        PendingIntent broadcast =\n+    Calendar calendar = getCalenderNextDay();\n+    Intent notificationIntent =\n+            new Intent(context, AlarmReceiver.class)\n+                    .setAction(\"android.media.action.DISPLAY_NOTIFICATION\")\n+                    .addCategory(\"android.intent.category.DEFAULT\")\n+                    .putExtra(\"pendingIntentId\", 1);\n+    AlarmManager alarmManager = (AlarmManager) context.getSystemService(Context.ALARM_SERVICE);\n+    PendingIntent broadcast =\n             PendingIntent.getBroadcast(\n-                context, 1, notificationIntent, PendingIntent.FLAG_UPDATE_CURRENT);\n-        try {\n-          if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {\n-            alarmManager.setExactAndAllowWhileIdle(\n-                AlarmManager.RTC_WAKEUP, calendar.getTimeInMillis(), broadcast);\n-          } else {\n-            alarmManager.setExact(AlarmManager.RTC_WAKEUP, calendar.getTimeInMillis(), broadcast);\n-          }\n-        } catch (NullPointerException e) {\n-          Logger.log(e);\n-        }\n-      } catch (Exception e) {\n-        Logger.log(e);\n-      }\n+                    context, 1, notificationIntent, PendingIntent.FLAG_UPDATE_CURRENT);\n+    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {\n+      alarmManager.setExactAndAllowWhileIdle(\n+              AlarmManager.RTC_WAKEUP, calendar.getTimeInMillis(), broadcast);\n+    } else {\n+      alarmManager.setExact(AlarmManager.RTC_WAKEUP, calendar.getTimeInMillis(), broadcast);\n     }\n   }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTE5Mjc0NA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/420#discussion_r431192744", "bodyText": "Don't catch Exception. There are no checked exceptions in this code block", "author": "nikklassen", "createdAt": "2020-05-27T14:44:18Z", "path": "Android/app/src/main/java/com/harvard/notificationmodule/NotificationModuleSubscriber.java", "diffHunk": "@@ -252,61 +213,140 @@ public void generateActivityLocalNotification(\n           notificationDb.setId(1);\n           notificationDb.setEndDateTime(removeOffset(activityRun.getEndDate(), offset));\n           dbServiceSubscriber.updateNotificationToDb(context, notificationDb);\n+          set24hourScheduler(context);\n+          if (isSameDay(new Date(), time1.getTime())) {\n+            setAlarm(\n+                context,\n+                title,\n+                description1,\n+                ACTIVITY,\n+                notificationId,\n+                activityRun.getStudyId(),\n+                activityRun.getActivityId(),\n+                time1);\n+          }\n+        }\n+      }\n+\n+    } catch (Exception e) {\n+      Logger.log(e);\n+    }\n+  }\n+\n+  private void set24hourScheduler(Context context) {\n+    // checking if alram is working with pendingIntent\n+    boolean isWorking = false;\n+    try {\n+      Intent notificationIntent1 = new Intent(context, AlarmReceiver.class);\n+      notificationIntent1.setAction(\"android.media.action.DISPLAY_NOTIFICATION\");\n+      notificationIntent1.addCategory(\"android.intent.category.DEFAULT\");\n+      notificationIntent1.putExtra(\"pendingIntentId\", 1);\n+      isWorking =\n+          (PendingIntent.getBroadcast(context, 1, notificationIntent1, PendingIntent.FLAG_NO_CREATE)\n+              != null); // just changed the flag\n+    } catch (Exception e) {", "originalCommit": "7ba1cc830224e7f6ce12a9c0bcacf910a46b55c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjA0Mjc1MA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/420#discussion_r432042750", "bodyText": "updated in the latest commit.", "author": "naveenr-btc", "createdAt": "2020-05-28T18:39:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTE5Mjc0NA=="}], "type": "inlineReview", "revised_code": {"commit": "91ddd774b776e07458c06ec87cb1131b29069579", "chunk": "diff --git a/Android/app/src/main/java/com/harvard/notificationmodule/NotificationModuleSubscriber.java b/Android/app/src/main/java/com/harvard/notificationmodule/NotificationModuleSubscriber.java\nindex c1ccff563..402ff3f5a 100644\n--- a/Android/app/src/main/java/com/harvard/notificationmodule/NotificationModuleSubscriber.java\n+++ b/Android/app/src/main/java/com/harvard/notificationmodule/NotificationModuleSubscriber.java\n\n@@ -67,217 +69,128 @@ public class NotificationModuleSubscriber {\n     Calendar time = Calendar.getInstance();\n     Calendar time1 = Calendar.getInstance();\n     ActivitiesWS activitiesWS =\n-        dbServiceSubscriber.getActivityItem(\n-            activityRun.getStudyId(), activityRun.getActivityId(), mRealm);\n-\n-    try {\n-      if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_ONE_TIME)) {\n-        Date date = removeOffset(activityRun.getEndDate(), offset);\n-        time.setTime(date);\n-        time.add(Calendar.HOUR_OF_DAY, -24);\n-\n-        Date date1 = removeOffset(activityRun.getStartDate(), offset);\n-        time1.setTime(date1);\n-\n-        description =\n-            context.getResources().getString(R.string.the_activity)\n-                + \" \"\n-                + activitiesWS.getTitle()\n-                + \" \"\n-                + context.getResources().getString(R.string.participation_is_important);\n-        description1 =\n-            context.getResources().getString(R.string.the_activity)\n-                + \" \"\n-                + activitiesWS.getTitle()\n-                + \", \"\n-                + context.getResources().getString(R.string.now_available_to_take);\n-      } else if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_MANUALLY_SCHEDULE)) {\n-        Date date = removeOffset(activityRun.getStartDate(), offset);\n-        time.setTime(date);\n-        description =\n-            context.getResources().getString(R.string.scheduled_activity)\n-                + \" \"\n-                + activitiesWS.getTitle()\n-                + \", \"\n-                + context.getResources().getString(R.string.valid_until)\n-                + \" \"\n-                + notificationFormat.format(activityRun.getEndDate())\n-                + context.getResources().getString(R.string.participation_is_important2);\n-      } else if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_WEEKLY)) {\n-        Date date = removeOffset(activityRun.getEndDate(), offset);\n-        time.setTime(date);\n-        time.add(Calendar.HOUR_OF_DAY, -24);\n-\n-        Date date1 = removeOffset(activityRun.getStartDate(), offset);\n-        time1.setTime(date1);\n-\n-        description =\n-            context.getResources().getString(R.string.weekly_activity)\n-                + \" \"\n-                + activitiesWS.getTitle()\n-                + \", \"\n-                + context.getResources().getString(R.string.participation_is_important);\n-        description1 =\n-            context.getResources().getString(R.string.new_run)\n-                + \" \"\n-                + activitiesWS.getTitle()\n-                + \", \"\n-                + context.getResources().getString(R.string.study_complete);\n-      } else if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_MONTHLY)) {\n-        Date date = removeOffset(activityRun.getEndDate(), offset);\n-        time.setTime(date);\n-        time.add(Calendar.HOUR_OF_DAY, -72);\n-\n-        Date date1 = removeOffset(activityRun.getStartDate(), offset);\n-        time1.setTime(date1);\n-\n-        description =\n-            context.getResources().getString(R.string.monthly_activity)\n-                + \" \"\n-                + activitiesWS.getTitle()\n-                + \", \"\n-                + context.getResources().getString(R.string.expire_in_three_days);\n-        description1 =\n-            context.getResources().getString(R.string.new_run_monthly_activity)\n-                + \" \"\n-                + activitiesWS.getTitle()\n-                + \", \"\n-                + context.getResources().getString(R.string.study_complete);\n-      } else if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_DAILY)) {\n-        Date date = removeOffset(activityRun.getStartDate(), offset);\n-        time.setTime(date);\n-        description =\n-            context.getResources().getString(R.string.new_run_daily_activity)\n-                + \" \"\n-                + activitiesWS.getTitle()\n-                + \", \"\n-                + context.getResources().getString(R.string.your_participation_important);\n-      } else if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_WITHIN_A_DAY)) {\n-        Date date = removeOffset(activityRun.getStartDate(), offset);\n-        time.setTime(date);\n-        description =\n-            context.getResources().getString(R.string.new_run_daily_activity)\n-                + \" \"\n-                + activitiesWS.getTitle()\n-                + \", \"\n-                + context.getResources().getString(R.string.valid_until)\n-                + \" \"\n-                + notificationFormat.format(activityRun.getEndDate())\n-                + context.getResources().getString(R.string.participation_is_important2);\n-      }\n-\n-      int notificationId;\n-\n-      if (time.getTime().after(new Date())) {\n-        notificationId = new Random().nextInt();\n-        NotificationDb notificationDb = new NotificationDb();\n-        notificationDb.setStudyId(activityRun.getStudyId());\n-        notificationDb.setActivityId(activityRun.getActivityId());\n-        notificationDb.setNotificationId(notificationId);\n-        notificationDb.setDateTime(time.getTime());\n-        notificationDb.setType(ACTIVITY);\n-        notificationDb.setId(1);\n-        notificationDb.setTitle(title);\n-        notificationDb.setDescription(description);\n-        notificationDb.setEndDateTime(removeOffset(activityRun.getEndDate(), offset));\n-        dbServiceSubscriber.updateNotificationToDb(context, notificationDb);\n-\n-        set24hourScheduler(context);\n-        if (isSameDay(new Date(), time.getTime())) {\n-          setAlarm(\n-              context,\n-              title,\n-              description,\n-              ACTIVITY,\n-              notificationId,\n-              activityRun.getStudyId(),\n-              activityRun.getActivityId(),\n-              time);\n-        }\n-      }\n-\n-      // Notification availability for monthly, weekly, One time\n-      if ((type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_MONTHLY)\n-          || type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_WEEKLY)\n-          || type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_ONE_TIME))) {\n-        if (time1.getTime().after(new Date())) {\n-          notificationId = new Random().nextInt();\n-          NotificationDb notificationDb = new NotificationDb();\n-          notificationDb.setStudyId(activityRun.getStudyId());\n-          notificationDb.setActivityId(activityRun.getActivityId());\n-          notificationDb.setNotificationId(notificationId);\n-          notificationDb.setDateTime(time1.getTime());\n-          notificationDb.setType(ACTIVITY);\n-          notificationDb.setTitle(title);\n-          notificationDb.setDescription(description1);\n-          notificationDb.setId(1);\n-          notificationDb.setEndDateTime(removeOffset(activityRun.getEndDate(), offset));\n-          dbServiceSubscriber.updateNotificationToDb(context, notificationDb);\n-          set24hourScheduler(context);\n-          if (isSameDay(new Date(), time1.getTime())) {\n-            setAlarm(\n-                context,\n-                title,\n-                description1,\n-                ACTIVITY,\n-                notificationId,\n-                activityRun.getStudyId(),\n-                activityRun.getActivityId(),\n-                time1);\n-          }\n-        }\n-      }\n-\n-    } catch (Exception e) {\n-      Logger.log(e);\n+            dbServiceSubscriber.getActivityItem(\n+                    activityRun.getStudyId(), activityRun.getActivityId(), mRealm);\n+\n+    if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_ONE_TIME)) {\n+      Date date = removeOffset(activityRun.getEndDate(), offset);\n+      time.setTime(date);\n+      time.add(Calendar.HOUR_OF_DAY, -24);\n+\n+      Date date1 = removeOffset(activityRun.getStartDate(), offset);\n+      time1.setTime(date1);\n+\n+      description =\n+              context.getResources().getString(R.string.the_activity)\n+                      + \" \"\n+                      + activitiesWS.getTitle()\n+                      + \" \"\n+                      + context.getResources().getString(R.string.participation_is_important);\n+      description1 =\n+              context.getResources().getString(R.string.the_activity)\n+                      + \" \"\n+                      + activitiesWS.getTitle()\n+                      + \", \"\n+                      + context.getResources().getString(R.string.now_available_to_take);\n+    } else if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_MANUALLY_SCHEDULE)) {\n+      Date date = removeOffset(activityRun.getStartDate(), offset);\n+      time.setTime(date);\n+      description =\n+              context.getResources().getString(R.string.scheduled_activity)\n+                      + \" \"\n+                      + activitiesWS.getTitle()\n+                      + \", \"\n+                      + context.getResources().getString(R.string.valid_until)\n+                      + \" \"\n+                      + notificationFormat.format(activityRun.getEndDate())\n+                      + context.getResources().getString(R.string.participation_is_important2);\n+    } else if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_WEEKLY)) {\n+      Date date = removeOffset(activityRun.getEndDate(), offset);\n+      time.setTime(date);\n+      time.add(Calendar.HOUR_OF_DAY, -24);\n+\n+      Date date1 = removeOffset(activityRun.getStartDate(), offset);\n+      time1.setTime(date1);\n+\n+      description =\n+              context.getResources().getString(R.string.weekly_activity)\n+                      + \" \"\n+                      + activitiesWS.getTitle()\n+                      + \", \"\n+                      + context.getResources().getString(R.string.participation_is_important);\n+      description1 =\n+              context.getResources().getString(R.string.new_run)\n+                      + \" \"\n+                      + activitiesWS.getTitle()\n+                      + \", \"\n+                      + context.getResources().getString(R.string.study_complete);\n+    } else if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_MONTHLY)) {\n+      Date date = removeOffset(activityRun.getEndDate(), offset);\n+      time.setTime(date);\n+      time.add(Calendar.HOUR_OF_DAY, -72);\n+\n+      Date date1 = removeOffset(activityRun.getStartDate(), offset);\n+      time1.setTime(date1);\n+\n+      description =\n+              context.getResources().getString(R.string.monthly_activity)\n+                      + \" \"\n+                      + activitiesWS.getTitle()\n+                      + \", \"\n+                      + context.getResources().getString(R.string.expire_in_three_days);\n+      description1 =\n+              context.getResources().getString(R.string.new_run_monthly_activity)\n+                      + \" \"\n+                      + activitiesWS.getTitle()\n+                      + \", \"\n+                      + context.getResources().getString(R.string.study_complete);\n+    } else if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_DAILY)) {\n+      Date date = removeOffset(activityRun.getStartDate(), offset);\n+      time.setTime(date);\n+      description =\n+              context.getResources().getString(R.string.new_run_daily_activity)\n+                      + \" \"\n+                      + activitiesWS.getTitle()\n+                      + \", \"\n+                      + context.getResources().getString(R.string.your_participation_important);\n+    } else if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_WITHIN_A_DAY)) {\n+      Date date = removeOffset(activityRun.getStartDate(), offset);\n+      time.setTime(date);\n+      description =\n+              context.getResources().getString(R.string.new_run_daily_activity)\n+                      + \" \"\n+                      + activitiesWS.getTitle()\n+                      + \", \"\n+                      + context.getResources().getString(R.string.valid_until)\n+                      + \" \"\n+                      + notificationFormat.format(activityRun.getEndDate())\n+                      + context.getResources().getString(R.string.participation_is_important2);\n+    }\n+    updateNotificationToDbAndSetAlarm(context, activityRun, time, title, description, offset);\n+    // Notification availability for monthly, weekly, One time\n+    if ((type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_MONTHLY)\n+            || type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_WEEKLY)\n+            || type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_ONE_TIME))) {\n+      updateNotificationToDbAndSetAlarm(context, activityRun, time1, title, description1, offset);\n     }\n   }\n \n   private void set24hourScheduler(Context context) {\n-    // checking if alram is working with pendingIntent\n-    boolean isWorking = false;\n-    try {\n-      Intent notificationIntent1 = new Intent(context, AlarmReceiver.class);\n-      notificationIntent1.setAction(\"android.media.action.DISPLAY_NOTIFICATION\");\n-      notificationIntent1.addCategory(\"android.intent.category.DEFAULT\");\n-      notificationIntent1.putExtra(\"pendingIntentId\", 1);\n-      isWorking =\n-          (PendingIntent.getBroadcast(context, 1, notificationIntent1, PendingIntent.FLAG_NO_CREATE)\n-              != null); // just changed the flag\n-    } catch (Exception e) {\n-      Logger.log(e);\n-    }\n-\n-    if (!isWorking) {\n-      Calendar calendar = Calendar.getInstance();\n-      calendar.set(Calendar.HOUR_OF_DAY, 0);\n-      calendar.set(Calendar.MINUTE, 0);\n-      calendar.set(Calendar.SECOND, 0);\n-      calendar.set(Calendar.MILLISECOND, 0);\n-      calendar.add(Calendar.DATE, 1);\n-\n-      try {\n-        Intent notificationIntent = new Intent(context, AlarmReceiver.class);\n-        notificationIntent.setAction(\"android.media.action.DISPLAY_NOTIFICATION\");\n-        notificationIntent.addCategory(\"android.intent.category.DEFAULT\");\n-        notificationIntent.putExtra(\"pendingIntentId\", 1);\n-        AlarmManager alarmManager = (AlarmManager) context.getSystemService(Context.ALARM_SERVICE);\n-        PendingIntent broadcast =\n+    Calendar calendar = getCalenderNextDay();\n+    Intent notificationIntent =\n+            new Intent(context, AlarmReceiver.class)\n+                    .setAction(\"android.media.action.DISPLAY_NOTIFICATION\")\n+                    .addCategory(\"android.intent.category.DEFAULT\")\n+                    .putExtra(\"pendingIntentId\", 1);\n+    AlarmManager alarmManager = (AlarmManager) context.getSystemService(Context.ALARM_SERVICE);\n+    PendingIntent broadcast =\n             PendingIntent.getBroadcast(\n-                context, 1, notificationIntent, PendingIntent.FLAG_UPDATE_CURRENT);\n-        try {\n-          if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {\n-            alarmManager.setExactAndAllowWhileIdle(\n-                AlarmManager.RTC_WAKEUP, calendar.getTimeInMillis(), broadcast);\n-          } else {\n-            alarmManager.setExact(AlarmManager.RTC_WAKEUP, calendar.getTimeInMillis(), broadcast);\n-          }\n-        } catch (NullPointerException e) {\n-          Logger.log(e);\n-        }\n-      } catch (Exception e) {\n-        Logger.log(e);\n-      }\n+                    context, 1, notificationIntent, PendingIntent.FLAG_UPDATE_CURRENT);\n+    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {\n+      alarmManager.setExactAndAllowWhileIdle(\n+              AlarmManager.RTC_WAKEUP, calendar.getTimeInMillis(), broadcast);\n+    } else {\n+      alarmManager.setExact(AlarmManager.RTC_WAKEUP, calendar.getTimeInMillis(), broadcast);\n     }\n   }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTE5MzEwMg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/420#discussion_r431193102", "bodyText": "if (isWorking) {\n   return;\n}", "author": "nikklassen", "createdAt": "2020-05-27T14:44:47Z", "path": "Android/app/src/main/java/com/harvard/notificationmodule/NotificationModuleSubscriber.java", "diffHunk": "@@ -252,61 +213,140 @@ public void generateActivityLocalNotification(\n           notificationDb.setId(1);\n           notificationDb.setEndDateTime(removeOffset(activityRun.getEndDate(), offset));\n           dbServiceSubscriber.updateNotificationToDb(context, notificationDb);\n+          set24hourScheduler(context);\n+          if (isSameDay(new Date(), time1.getTime())) {\n+            setAlarm(\n+                context,\n+                title,\n+                description1,\n+                ACTIVITY,\n+                notificationId,\n+                activityRun.getStudyId(),\n+                activityRun.getActivityId(),\n+                time1);\n+          }\n+        }\n+      }\n+\n+    } catch (Exception e) {\n+      Logger.log(e);\n+    }\n+  }\n+\n+  private void set24hourScheduler(Context context) {\n+    // checking if alram is working with pendingIntent\n+    boolean isWorking = false;\n+    try {\n+      Intent notificationIntent1 = new Intent(context, AlarmReceiver.class);\n+      notificationIntent1.setAction(\"android.media.action.DISPLAY_NOTIFICATION\");\n+      notificationIntent1.addCategory(\"android.intent.category.DEFAULT\");\n+      notificationIntent1.putExtra(\"pendingIntentId\", 1);\n+      isWorking =\n+          (PendingIntent.getBroadcast(context, 1, notificationIntent1, PendingIntent.FLAG_NO_CREATE)\n+              != null); // just changed the flag\n+    } catch (Exception e) {\n+      Logger.log(e);\n+    }\n+\n+    if (!isWorking) {", "originalCommit": "7ba1cc830224e7f6ce12a9c0bcacf910a46b55c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjA0MzIxMg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/420#discussion_r432043212", "bodyText": "removed this condition as it's not required since we're are updating the notification.", "author": "naveenr-btc", "createdAt": "2020-05-28T18:39:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTE5MzEwMg=="}], "type": "inlineReview", "revised_code": {"commit": "91ddd774b776e07458c06ec87cb1131b29069579", "chunk": "diff --git a/Android/app/src/main/java/com/harvard/notificationmodule/NotificationModuleSubscriber.java b/Android/app/src/main/java/com/harvard/notificationmodule/NotificationModuleSubscriber.java\nindex c1ccff563..402ff3f5a 100644\n--- a/Android/app/src/main/java/com/harvard/notificationmodule/NotificationModuleSubscriber.java\n+++ b/Android/app/src/main/java/com/harvard/notificationmodule/NotificationModuleSubscriber.java\n\n@@ -67,217 +69,128 @@ public class NotificationModuleSubscriber {\n     Calendar time = Calendar.getInstance();\n     Calendar time1 = Calendar.getInstance();\n     ActivitiesWS activitiesWS =\n-        dbServiceSubscriber.getActivityItem(\n-            activityRun.getStudyId(), activityRun.getActivityId(), mRealm);\n-\n-    try {\n-      if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_ONE_TIME)) {\n-        Date date = removeOffset(activityRun.getEndDate(), offset);\n-        time.setTime(date);\n-        time.add(Calendar.HOUR_OF_DAY, -24);\n-\n-        Date date1 = removeOffset(activityRun.getStartDate(), offset);\n-        time1.setTime(date1);\n-\n-        description =\n-            context.getResources().getString(R.string.the_activity)\n-                + \" \"\n-                + activitiesWS.getTitle()\n-                + \" \"\n-                + context.getResources().getString(R.string.participation_is_important);\n-        description1 =\n-            context.getResources().getString(R.string.the_activity)\n-                + \" \"\n-                + activitiesWS.getTitle()\n-                + \", \"\n-                + context.getResources().getString(R.string.now_available_to_take);\n-      } else if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_MANUALLY_SCHEDULE)) {\n-        Date date = removeOffset(activityRun.getStartDate(), offset);\n-        time.setTime(date);\n-        description =\n-            context.getResources().getString(R.string.scheduled_activity)\n-                + \" \"\n-                + activitiesWS.getTitle()\n-                + \", \"\n-                + context.getResources().getString(R.string.valid_until)\n-                + \" \"\n-                + notificationFormat.format(activityRun.getEndDate())\n-                + context.getResources().getString(R.string.participation_is_important2);\n-      } else if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_WEEKLY)) {\n-        Date date = removeOffset(activityRun.getEndDate(), offset);\n-        time.setTime(date);\n-        time.add(Calendar.HOUR_OF_DAY, -24);\n-\n-        Date date1 = removeOffset(activityRun.getStartDate(), offset);\n-        time1.setTime(date1);\n-\n-        description =\n-            context.getResources().getString(R.string.weekly_activity)\n-                + \" \"\n-                + activitiesWS.getTitle()\n-                + \", \"\n-                + context.getResources().getString(R.string.participation_is_important);\n-        description1 =\n-            context.getResources().getString(R.string.new_run)\n-                + \" \"\n-                + activitiesWS.getTitle()\n-                + \", \"\n-                + context.getResources().getString(R.string.study_complete);\n-      } else if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_MONTHLY)) {\n-        Date date = removeOffset(activityRun.getEndDate(), offset);\n-        time.setTime(date);\n-        time.add(Calendar.HOUR_OF_DAY, -72);\n-\n-        Date date1 = removeOffset(activityRun.getStartDate(), offset);\n-        time1.setTime(date1);\n-\n-        description =\n-            context.getResources().getString(R.string.monthly_activity)\n-                + \" \"\n-                + activitiesWS.getTitle()\n-                + \", \"\n-                + context.getResources().getString(R.string.expire_in_three_days);\n-        description1 =\n-            context.getResources().getString(R.string.new_run_monthly_activity)\n-                + \" \"\n-                + activitiesWS.getTitle()\n-                + \", \"\n-                + context.getResources().getString(R.string.study_complete);\n-      } else if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_DAILY)) {\n-        Date date = removeOffset(activityRun.getStartDate(), offset);\n-        time.setTime(date);\n-        description =\n-            context.getResources().getString(R.string.new_run_daily_activity)\n-                + \" \"\n-                + activitiesWS.getTitle()\n-                + \", \"\n-                + context.getResources().getString(R.string.your_participation_important);\n-      } else if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_WITHIN_A_DAY)) {\n-        Date date = removeOffset(activityRun.getStartDate(), offset);\n-        time.setTime(date);\n-        description =\n-            context.getResources().getString(R.string.new_run_daily_activity)\n-                + \" \"\n-                + activitiesWS.getTitle()\n-                + \", \"\n-                + context.getResources().getString(R.string.valid_until)\n-                + \" \"\n-                + notificationFormat.format(activityRun.getEndDate())\n-                + context.getResources().getString(R.string.participation_is_important2);\n-      }\n-\n-      int notificationId;\n-\n-      if (time.getTime().after(new Date())) {\n-        notificationId = new Random().nextInt();\n-        NotificationDb notificationDb = new NotificationDb();\n-        notificationDb.setStudyId(activityRun.getStudyId());\n-        notificationDb.setActivityId(activityRun.getActivityId());\n-        notificationDb.setNotificationId(notificationId);\n-        notificationDb.setDateTime(time.getTime());\n-        notificationDb.setType(ACTIVITY);\n-        notificationDb.setId(1);\n-        notificationDb.setTitle(title);\n-        notificationDb.setDescription(description);\n-        notificationDb.setEndDateTime(removeOffset(activityRun.getEndDate(), offset));\n-        dbServiceSubscriber.updateNotificationToDb(context, notificationDb);\n-\n-        set24hourScheduler(context);\n-        if (isSameDay(new Date(), time.getTime())) {\n-          setAlarm(\n-              context,\n-              title,\n-              description,\n-              ACTIVITY,\n-              notificationId,\n-              activityRun.getStudyId(),\n-              activityRun.getActivityId(),\n-              time);\n-        }\n-      }\n-\n-      // Notification availability for monthly, weekly, One time\n-      if ((type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_MONTHLY)\n-          || type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_WEEKLY)\n-          || type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_ONE_TIME))) {\n-        if (time1.getTime().after(new Date())) {\n-          notificationId = new Random().nextInt();\n-          NotificationDb notificationDb = new NotificationDb();\n-          notificationDb.setStudyId(activityRun.getStudyId());\n-          notificationDb.setActivityId(activityRun.getActivityId());\n-          notificationDb.setNotificationId(notificationId);\n-          notificationDb.setDateTime(time1.getTime());\n-          notificationDb.setType(ACTIVITY);\n-          notificationDb.setTitle(title);\n-          notificationDb.setDescription(description1);\n-          notificationDb.setId(1);\n-          notificationDb.setEndDateTime(removeOffset(activityRun.getEndDate(), offset));\n-          dbServiceSubscriber.updateNotificationToDb(context, notificationDb);\n-          set24hourScheduler(context);\n-          if (isSameDay(new Date(), time1.getTime())) {\n-            setAlarm(\n-                context,\n-                title,\n-                description1,\n-                ACTIVITY,\n-                notificationId,\n-                activityRun.getStudyId(),\n-                activityRun.getActivityId(),\n-                time1);\n-          }\n-        }\n-      }\n-\n-    } catch (Exception e) {\n-      Logger.log(e);\n+            dbServiceSubscriber.getActivityItem(\n+                    activityRun.getStudyId(), activityRun.getActivityId(), mRealm);\n+\n+    if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_ONE_TIME)) {\n+      Date date = removeOffset(activityRun.getEndDate(), offset);\n+      time.setTime(date);\n+      time.add(Calendar.HOUR_OF_DAY, -24);\n+\n+      Date date1 = removeOffset(activityRun.getStartDate(), offset);\n+      time1.setTime(date1);\n+\n+      description =\n+              context.getResources().getString(R.string.the_activity)\n+                      + \" \"\n+                      + activitiesWS.getTitle()\n+                      + \" \"\n+                      + context.getResources().getString(R.string.participation_is_important);\n+      description1 =\n+              context.getResources().getString(R.string.the_activity)\n+                      + \" \"\n+                      + activitiesWS.getTitle()\n+                      + \", \"\n+                      + context.getResources().getString(R.string.now_available_to_take);\n+    } else if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_MANUALLY_SCHEDULE)) {\n+      Date date = removeOffset(activityRun.getStartDate(), offset);\n+      time.setTime(date);\n+      description =\n+              context.getResources().getString(R.string.scheduled_activity)\n+                      + \" \"\n+                      + activitiesWS.getTitle()\n+                      + \", \"\n+                      + context.getResources().getString(R.string.valid_until)\n+                      + \" \"\n+                      + notificationFormat.format(activityRun.getEndDate())\n+                      + context.getResources().getString(R.string.participation_is_important2);\n+    } else if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_WEEKLY)) {\n+      Date date = removeOffset(activityRun.getEndDate(), offset);\n+      time.setTime(date);\n+      time.add(Calendar.HOUR_OF_DAY, -24);\n+\n+      Date date1 = removeOffset(activityRun.getStartDate(), offset);\n+      time1.setTime(date1);\n+\n+      description =\n+              context.getResources().getString(R.string.weekly_activity)\n+                      + \" \"\n+                      + activitiesWS.getTitle()\n+                      + \", \"\n+                      + context.getResources().getString(R.string.participation_is_important);\n+      description1 =\n+              context.getResources().getString(R.string.new_run)\n+                      + \" \"\n+                      + activitiesWS.getTitle()\n+                      + \", \"\n+                      + context.getResources().getString(R.string.study_complete);\n+    } else if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_MONTHLY)) {\n+      Date date = removeOffset(activityRun.getEndDate(), offset);\n+      time.setTime(date);\n+      time.add(Calendar.HOUR_OF_DAY, -72);\n+\n+      Date date1 = removeOffset(activityRun.getStartDate(), offset);\n+      time1.setTime(date1);\n+\n+      description =\n+              context.getResources().getString(R.string.monthly_activity)\n+                      + \" \"\n+                      + activitiesWS.getTitle()\n+                      + \", \"\n+                      + context.getResources().getString(R.string.expire_in_three_days);\n+      description1 =\n+              context.getResources().getString(R.string.new_run_monthly_activity)\n+                      + \" \"\n+                      + activitiesWS.getTitle()\n+                      + \", \"\n+                      + context.getResources().getString(R.string.study_complete);\n+    } else if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_DAILY)) {\n+      Date date = removeOffset(activityRun.getStartDate(), offset);\n+      time.setTime(date);\n+      description =\n+              context.getResources().getString(R.string.new_run_daily_activity)\n+                      + \" \"\n+                      + activitiesWS.getTitle()\n+                      + \", \"\n+                      + context.getResources().getString(R.string.your_participation_important);\n+    } else if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_WITHIN_A_DAY)) {\n+      Date date = removeOffset(activityRun.getStartDate(), offset);\n+      time.setTime(date);\n+      description =\n+              context.getResources().getString(R.string.new_run_daily_activity)\n+                      + \" \"\n+                      + activitiesWS.getTitle()\n+                      + \", \"\n+                      + context.getResources().getString(R.string.valid_until)\n+                      + \" \"\n+                      + notificationFormat.format(activityRun.getEndDate())\n+                      + context.getResources().getString(R.string.participation_is_important2);\n+    }\n+    updateNotificationToDbAndSetAlarm(context, activityRun, time, title, description, offset);\n+    // Notification availability for monthly, weekly, One time\n+    if ((type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_MONTHLY)\n+            || type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_WEEKLY)\n+            || type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_ONE_TIME))) {\n+      updateNotificationToDbAndSetAlarm(context, activityRun, time1, title, description1, offset);\n     }\n   }\n \n   private void set24hourScheduler(Context context) {\n-    // checking if alram is working with pendingIntent\n-    boolean isWorking = false;\n-    try {\n-      Intent notificationIntent1 = new Intent(context, AlarmReceiver.class);\n-      notificationIntent1.setAction(\"android.media.action.DISPLAY_NOTIFICATION\");\n-      notificationIntent1.addCategory(\"android.intent.category.DEFAULT\");\n-      notificationIntent1.putExtra(\"pendingIntentId\", 1);\n-      isWorking =\n-          (PendingIntent.getBroadcast(context, 1, notificationIntent1, PendingIntent.FLAG_NO_CREATE)\n-              != null); // just changed the flag\n-    } catch (Exception e) {\n-      Logger.log(e);\n-    }\n-\n-    if (!isWorking) {\n-      Calendar calendar = Calendar.getInstance();\n-      calendar.set(Calendar.HOUR_OF_DAY, 0);\n-      calendar.set(Calendar.MINUTE, 0);\n-      calendar.set(Calendar.SECOND, 0);\n-      calendar.set(Calendar.MILLISECOND, 0);\n-      calendar.add(Calendar.DATE, 1);\n-\n-      try {\n-        Intent notificationIntent = new Intent(context, AlarmReceiver.class);\n-        notificationIntent.setAction(\"android.media.action.DISPLAY_NOTIFICATION\");\n-        notificationIntent.addCategory(\"android.intent.category.DEFAULT\");\n-        notificationIntent.putExtra(\"pendingIntentId\", 1);\n-        AlarmManager alarmManager = (AlarmManager) context.getSystemService(Context.ALARM_SERVICE);\n-        PendingIntent broadcast =\n+    Calendar calendar = getCalenderNextDay();\n+    Intent notificationIntent =\n+            new Intent(context, AlarmReceiver.class)\n+                    .setAction(\"android.media.action.DISPLAY_NOTIFICATION\")\n+                    .addCategory(\"android.intent.category.DEFAULT\")\n+                    .putExtra(\"pendingIntentId\", 1);\n+    AlarmManager alarmManager = (AlarmManager) context.getSystemService(Context.ALARM_SERVICE);\n+    PendingIntent broadcast =\n             PendingIntent.getBroadcast(\n-                context, 1, notificationIntent, PendingIntent.FLAG_UPDATE_CURRENT);\n-        try {\n-          if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {\n-            alarmManager.setExactAndAllowWhileIdle(\n-                AlarmManager.RTC_WAKEUP, calendar.getTimeInMillis(), broadcast);\n-          } else {\n-            alarmManager.setExact(AlarmManager.RTC_WAKEUP, calendar.getTimeInMillis(), broadcast);\n-          }\n-        } catch (NullPointerException e) {\n-          Logger.log(e);\n-        }\n-      } catch (Exception e) {\n-        Logger.log(e);\n-      }\n+                    context, 1, notificationIntent, PendingIntent.FLAG_UPDATE_CURRENT);\n+    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {\n+      alarmManager.setExactAndAllowWhileIdle(\n+              AlarmManager.RTC_WAKEUP, calendar.getTimeInMillis(), broadcast);\n+    } else {\n+      alarmManager.setExact(AlarmManager.RTC_WAKEUP, calendar.getTimeInMillis(), broadcast);\n     }\n   }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTE5NDA2MA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/420#discussion_r431194060", "bodyText": "Can you use a more meaningful name than isWorking? This doesn't help me understand what is going on here.", "author": "nikklassen", "createdAt": "2020-05-27T14:46:04Z", "path": "Android/app/src/main/java/com/harvard/notificationmodule/NotificationModuleSubscriber.java", "diffHunk": "@@ -252,61 +213,140 @@ public void generateActivityLocalNotification(\n           notificationDb.setId(1);\n           notificationDb.setEndDateTime(removeOffset(activityRun.getEndDate(), offset));\n           dbServiceSubscriber.updateNotificationToDb(context, notificationDb);\n+          set24hourScheduler(context);\n+          if (isSameDay(new Date(), time1.getTime())) {\n+            setAlarm(\n+                context,\n+                title,\n+                description1,\n+                ACTIVITY,\n+                notificationId,\n+                activityRun.getStudyId(),\n+                activityRun.getActivityId(),\n+                time1);\n+          }\n+        }\n+      }\n+\n+    } catch (Exception e) {\n+      Logger.log(e);\n+    }\n+  }\n+\n+  private void set24hourScheduler(Context context) {\n+    // checking if alram is working with pendingIntent\n+    boolean isWorking = false;", "originalCommit": "7ba1cc830224e7f6ce12a9c0bcacf910a46b55c6", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "91ddd774b776e07458c06ec87cb1131b29069579", "chunk": "diff --git a/Android/app/src/main/java/com/harvard/notificationmodule/NotificationModuleSubscriber.java b/Android/app/src/main/java/com/harvard/notificationmodule/NotificationModuleSubscriber.java\nindex c1ccff563..402ff3f5a 100644\n--- a/Android/app/src/main/java/com/harvard/notificationmodule/NotificationModuleSubscriber.java\n+++ b/Android/app/src/main/java/com/harvard/notificationmodule/NotificationModuleSubscriber.java\n\n@@ -67,217 +69,128 @@ public class NotificationModuleSubscriber {\n     Calendar time = Calendar.getInstance();\n     Calendar time1 = Calendar.getInstance();\n     ActivitiesWS activitiesWS =\n-        dbServiceSubscriber.getActivityItem(\n-            activityRun.getStudyId(), activityRun.getActivityId(), mRealm);\n-\n-    try {\n-      if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_ONE_TIME)) {\n-        Date date = removeOffset(activityRun.getEndDate(), offset);\n-        time.setTime(date);\n-        time.add(Calendar.HOUR_OF_DAY, -24);\n-\n-        Date date1 = removeOffset(activityRun.getStartDate(), offset);\n-        time1.setTime(date1);\n-\n-        description =\n-            context.getResources().getString(R.string.the_activity)\n-                + \" \"\n-                + activitiesWS.getTitle()\n-                + \" \"\n-                + context.getResources().getString(R.string.participation_is_important);\n-        description1 =\n-            context.getResources().getString(R.string.the_activity)\n-                + \" \"\n-                + activitiesWS.getTitle()\n-                + \", \"\n-                + context.getResources().getString(R.string.now_available_to_take);\n-      } else if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_MANUALLY_SCHEDULE)) {\n-        Date date = removeOffset(activityRun.getStartDate(), offset);\n-        time.setTime(date);\n-        description =\n-            context.getResources().getString(R.string.scheduled_activity)\n-                + \" \"\n-                + activitiesWS.getTitle()\n-                + \", \"\n-                + context.getResources().getString(R.string.valid_until)\n-                + \" \"\n-                + notificationFormat.format(activityRun.getEndDate())\n-                + context.getResources().getString(R.string.participation_is_important2);\n-      } else if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_WEEKLY)) {\n-        Date date = removeOffset(activityRun.getEndDate(), offset);\n-        time.setTime(date);\n-        time.add(Calendar.HOUR_OF_DAY, -24);\n-\n-        Date date1 = removeOffset(activityRun.getStartDate(), offset);\n-        time1.setTime(date1);\n-\n-        description =\n-            context.getResources().getString(R.string.weekly_activity)\n-                + \" \"\n-                + activitiesWS.getTitle()\n-                + \", \"\n-                + context.getResources().getString(R.string.participation_is_important);\n-        description1 =\n-            context.getResources().getString(R.string.new_run)\n-                + \" \"\n-                + activitiesWS.getTitle()\n-                + \", \"\n-                + context.getResources().getString(R.string.study_complete);\n-      } else if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_MONTHLY)) {\n-        Date date = removeOffset(activityRun.getEndDate(), offset);\n-        time.setTime(date);\n-        time.add(Calendar.HOUR_OF_DAY, -72);\n-\n-        Date date1 = removeOffset(activityRun.getStartDate(), offset);\n-        time1.setTime(date1);\n-\n-        description =\n-            context.getResources().getString(R.string.monthly_activity)\n-                + \" \"\n-                + activitiesWS.getTitle()\n-                + \", \"\n-                + context.getResources().getString(R.string.expire_in_three_days);\n-        description1 =\n-            context.getResources().getString(R.string.new_run_monthly_activity)\n-                + \" \"\n-                + activitiesWS.getTitle()\n-                + \", \"\n-                + context.getResources().getString(R.string.study_complete);\n-      } else if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_DAILY)) {\n-        Date date = removeOffset(activityRun.getStartDate(), offset);\n-        time.setTime(date);\n-        description =\n-            context.getResources().getString(R.string.new_run_daily_activity)\n-                + \" \"\n-                + activitiesWS.getTitle()\n-                + \", \"\n-                + context.getResources().getString(R.string.your_participation_important);\n-      } else if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_WITHIN_A_DAY)) {\n-        Date date = removeOffset(activityRun.getStartDate(), offset);\n-        time.setTime(date);\n-        description =\n-            context.getResources().getString(R.string.new_run_daily_activity)\n-                + \" \"\n-                + activitiesWS.getTitle()\n-                + \", \"\n-                + context.getResources().getString(R.string.valid_until)\n-                + \" \"\n-                + notificationFormat.format(activityRun.getEndDate())\n-                + context.getResources().getString(R.string.participation_is_important2);\n-      }\n-\n-      int notificationId;\n-\n-      if (time.getTime().after(new Date())) {\n-        notificationId = new Random().nextInt();\n-        NotificationDb notificationDb = new NotificationDb();\n-        notificationDb.setStudyId(activityRun.getStudyId());\n-        notificationDb.setActivityId(activityRun.getActivityId());\n-        notificationDb.setNotificationId(notificationId);\n-        notificationDb.setDateTime(time.getTime());\n-        notificationDb.setType(ACTIVITY);\n-        notificationDb.setId(1);\n-        notificationDb.setTitle(title);\n-        notificationDb.setDescription(description);\n-        notificationDb.setEndDateTime(removeOffset(activityRun.getEndDate(), offset));\n-        dbServiceSubscriber.updateNotificationToDb(context, notificationDb);\n-\n-        set24hourScheduler(context);\n-        if (isSameDay(new Date(), time.getTime())) {\n-          setAlarm(\n-              context,\n-              title,\n-              description,\n-              ACTIVITY,\n-              notificationId,\n-              activityRun.getStudyId(),\n-              activityRun.getActivityId(),\n-              time);\n-        }\n-      }\n-\n-      // Notification availability for monthly, weekly, One time\n-      if ((type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_MONTHLY)\n-          || type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_WEEKLY)\n-          || type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_ONE_TIME))) {\n-        if (time1.getTime().after(new Date())) {\n-          notificationId = new Random().nextInt();\n-          NotificationDb notificationDb = new NotificationDb();\n-          notificationDb.setStudyId(activityRun.getStudyId());\n-          notificationDb.setActivityId(activityRun.getActivityId());\n-          notificationDb.setNotificationId(notificationId);\n-          notificationDb.setDateTime(time1.getTime());\n-          notificationDb.setType(ACTIVITY);\n-          notificationDb.setTitle(title);\n-          notificationDb.setDescription(description1);\n-          notificationDb.setId(1);\n-          notificationDb.setEndDateTime(removeOffset(activityRun.getEndDate(), offset));\n-          dbServiceSubscriber.updateNotificationToDb(context, notificationDb);\n-          set24hourScheduler(context);\n-          if (isSameDay(new Date(), time1.getTime())) {\n-            setAlarm(\n-                context,\n-                title,\n-                description1,\n-                ACTIVITY,\n-                notificationId,\n-                activityRun.getStudyId(),\n-                activityRun.getActivityId(),\n-                time1);\n-          }\n-        }\n-      }\n-\n-    } catch (Exception e) {\n-      Logger.log(e);\n+            dbServiceSubscriber.getActivityItem(\n+                    activityRun.getStudyId(), activityRun.getActivityId(), mRealm);\n+\n+    if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_ONE_TIME)) {\n+      Date date = removeOffset(activityRun.getEndDate(), offset);\n+      time.setTime(date);\n+      time.add(Calendar.HOUR_OF_DAY, -24);\n+\n+      Date date1 = removeOffset(activityRun.getStartDate(), offset);\n+      time1.setTime(date1);\n+\n+      description =\n+              context.getResources().getString(R.string.the_activity)\n+                      + \" \"\n+                      + activitiesWS.getTitle()\n+                      + \" \"\n+                      + context.getResources().getString(R.string.participation_is_important);\n+      description1 =\n+              context.getResources().getString(R.string.the_activity)\n+                      + \" \"\n+                      + activitiesWS.getTitle()\n+                      + \", \"\n+                      + context.getResources().getString(R.string.now_available_to_take);\n+    } else if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_MANUALLY_SCHEDULE)) {\n+      Date date = removeOffset(activityRun.getStartDate(), offset);\n+      time.setTime(date);\n+      description =\n+              context.getResources().getString(R.string.scheduled_activity)\n+                      + \" \"\n+                      + activitiesWS.getTitle()\n+                      + \", \"\n+                      + context.getResources().getString(R.string.valid_until)\n+                      + \" \"\n+                      + notificationFormat.format(activityRun.getEndDate())\n+                      + context.getResources().getString(R.string.participation_is_important2);\n+    } else if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_WEEKLY)) {\n+      Date date = removeOffset(activityRun.getEndDate(), offset);\n+      time.setTime(date);\n+      time.add(Calendar.HOUR_OF_DAY, -24);\n+\n+      Date date1 = removeOffset(activityRun.getStartDate(), offset);\n+      time1.setTime(date1);\n+\n+      description =\n+              context.getResources().getString(R.string.weekly_activity)\n+                      + \" \"\n+                      + activitiesWS.getTitle()\n+                      + \", \"\n+                      + context.getResources().getString(R.string.participation_is_important);\n+      description1 =\n+              context.getResources().getString(R.string.new_run)\n+                      + \" \"\n+                      + activitiesWS.getTitle()\n+                      + \", \"\n+                      + context.getResources().getString(R.string.study_complete);\n+    } else if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_MONTHLY)) {\n+      Date date = removeOffset(activityRun.getEndDate(), offset);\n+      time.setTime(date);\n+      time.add(Calendar.HOUR_OF_DAY, -72);\n+\n+      Date date1 = removeOffset(activityRun.getStartDate(), offset);\n+      time1.setTime(date1);\n+\n+      description =\n+              context.getResources().getString(R.string.monthly_activity)\n+                      + \" \"\n+                      + activitiesWS.getTitle()\n+                      + \", \"\n+                      + context.getResources().getString(R.string.expire_in_three_days);\n+      description1 =\n+              context.getResources().getString(R.string.new_run_monthly_activity)\n+                      + \" \"\n+                      + activitiesWS.getTitle()\n+                      + \", \"\n+                      + context.getResources().getString(R.string.study_complete);\n+    } else if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_DAILY)) {\n+      Date date = removeOffset(activityRun.getStartDate(), offset);\n+      time.setTime(date);\n+      description =\n+              context.getResources().getString(R.string.new_run_daily_activity)\n+                      + \" \"\n+                      + activitiesWS.getTitle()\n+                      + \", \"\n+                      + context.getResources().getString(R.string.your_participation_important);\n+    } else if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_WITHIN_A_DAY)) {\n+      Date date = removeOffset(activityRun.getStartDate(), offset);\n+      time.setTime(date);\n+      description =\n+              context.getResources().getString(R.string.new_run_daily_activity)\n+                      + \" \"\n+                      + activitiesWS.getTitle()\n+                      + \", \"\n+                      + context.getResources().getString(R.string.valid_until)\n+                      + \" \"\n+                      + notificationFormat.format(activityRun.getEndDate())\n+                      + context.getResources().getString(R.string.participation_is_important2);\n+    }\n+    updateNotificationToDbAndSetAlarm(context, activityRun, time, title, description, offset);\n+    // Notification availability for monthly, weekly, One time\n+    if ((type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_MONTHLY)\n+            || type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_WEEKLY)\n+            || type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_ONE_TIME))) {\n+      updateNotificationToDbAndSetAlarm(context, activityRun, time1, title, description1, offset);\n     }\n   }\n \n   private void set24hourScheduler(Context context) {\n-    // checking if alram is working with pendingIntent\n-    boolean isWorking = false;\n-    try {\n-      Intent notificationIntent1 = new Intent(context, AlarmReceiver.class);\n-      notificationIntent1.setAction(\"android.media.action.DISPLAY_NOTIFICATION\");\n-      notificationIntent1.addCategory(\"android.intent.category.DEFAULT\");\n-      notificationIntent1.putExtra(\"pendingIntentId\", 1);\n-      isWorking =\n-          (PendingIntent.getBroadcast(context, 1, notificationIntent1, PendingIntent.FLAG_NO_CREATE)\n-              != null); // just changed the flag\n-    } catch (Exception e) {\n-      Logger.log(e);\n-    }\n-\n-    if (!isWorking) {\n-      Calendar calendar = Calendar.getInstance();\n-      calendar.set(Calendar.HOUR_OF_DAY, 0);\n-      calendar.set(Calendar.MINUTE, 0);\n-      calendar.set(Calendar.SECOND, 0);\n-      calendar.set(Calendar.MILLISECOND, 0);\n-      calendar.add(Calendar.DATE, 1);\n-\n-      try {\n-        Intent notificationIntent = new Intent(context, AlarmReceiver.class);\n-        notificationIntent.setAction(\"android.media.action.DISPLAY_NOTIFICATION\");\n-        notificationIntent.addCategory(\"android.intent.category.DEFAULT\");\n-        notificationIntent.putExtra(\"pendingIntentId\", 1);\n-        AlarmManager alarmManager = (AlarmManager) context.getSystemService(Context.ALARM_SERVICE);\n-        PendingIntent broadcast =\n+    Calendar calendar = getCalenderNextDay();\n+    Intent notificationIntent =\n+            new Intent(context, AlarmReceiver.class)\n+                    .setAction(\"android.media.action.DISPLAY_NOTIFICATION\")\n+                    .addCategory(\"android.intent.category.DEFAULT\")\n+                    .putExtra(\"pendingIntentId\", 1);\n+    AlarmManager alarmManager = (AlarmManager) context.getSystemService(Context.ALARM_SERVICE);\n+    PendingIntent broadcast =\n             PendingIntent.getBroadcast(\n-                context, 1, notificationIntent, PendingIntent.FLAG_UPDATE_CURRENT);\n-        try {\n-          if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {\n-            alarmManager.setExactAndAllowWhileIdle(\n-                AlarmManager.RTC_WAKEUP, calendar.getTimeInMillis(), broadcast);\n-          } else {\n-            alarmManager.setExact(AlarmManager.RTC_WAKEUP, calendar.getTimeInMillis(), broadcast);\n-          }\n-        } catch (NullPointerException e) {\n-          Logger.log(e);\n-        }\n-      } catch (Exception e) {\n-        Logger.log(e);\n-      }\n+                    context, 1, notificationIntent, PendingIntent.FLAG_UPDATE_CURRENT);\n+    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {\n+      alarmManager.setExactAndAllowWhileIdle(\n+              AlarmManager.RTC_WAKEUP, calendar.getTimeInMillis(), broadcast);\n+    } else {\n+      alarmManager.setExact(AlarmManager.RTC_WAKEUP, calendar.getTimeInMillis(), broadcast);\n     }\n   }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTE5Njk0OQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/420#discussion_r431196949", "bodyText": "Use chained setters.", "author": "nikklassen", "createdAt": "2020-05-27T14:49:53Z", "path": "Android/app/src/main/java/com/harvard/notificationmodule/NotificationModuleSubscriber.java", "diffHunk": "@@ -252,61 +213,140 @@ public void generateActivityLocalNotification(\n           notificationDb.setId(1);\n           notificationDb.setEndDateTime(removeOffset(activityRun.getEndDate(), offset));\n           dbServiceSubscriber.updateNotificationToDb(context, notificationDb);\n+          set24hourScheduler(context);\n+          if (isSameDay(new Date(), time1.getTime())) {\n+            setAlarm(\n+                context,\n+                title,\n+                description1,\n+                ACTIVITY,\n+                notificationId,\n+                activityRun.getStudyId(),\n+                activityRun.getActivityId(),\n+                time1);\n+          }\n+        }\n+      }\n+\n+    } catch (Exception e) {\n+      Logger.log(e);\n+    }\n+  }\n+\n+  private void set24hourScheduler(Context context) {\n+    // checking if alram is working with pendingIntent\n+    boolean isWorking = false;\n+    try {\n+      Intent notificationIntent1 = new Intent(context, AlarmReceiver.class);\n+      notificationIntent1.setAction(\"android.media.action.DISPLAY_NOTIFICATION\");\n+      notificationIntent1.addCategory(\"android.intent.category.DEFAULT\");\n+      notificationIntent1.putExtra(\"pendingIntentId\", 1);\n+      isWorking =\n+          (PendingIntent.getBroadcast(context, 1, notificationIntent1, PendingIntent.FLAG_NO_CREATE)\n+              != null); // just changed the flag\n+    } catch (Exception e) {\n+      Logger.log(e);\n+    }\n+\n+    if (!isWorking) {\n+      Calendar calendar = Calendar.getInstance();\n+      calendar.set(Calendar.HOUR_OF_DAY, 0);\n+      calendar.set(Calendar.MINUTE, 0);\n+      calendar.set(Calendar.SECOND, 0);\n+      calendar.set(Calendar.MILLISECOND, 0);\n+      calendar.add(Calendar.DATE, 1);\n \n-          Intent notificationIntent1 = new Intent(context, AlarmReceiver.class);\n-          notificationIntent1.setAction(\"android.media.action.DISPLAY_NOTIFICATION\");\n-          notificationIntent1.addCategory(\"android.intent.category.DEFAULT\");\n-          notificationIntent1.putExtra(\"title\", title);\n-          notificationIntent1.putExtra(\"description\", description1);\n-          notificationIntent1.putExtra(\"type\", ACTIVITY);\n-          notificationIntent1.putExtra(\"studyId\", activityRun.getStudyId());\n-          notificationIntent1.putExtra(\"activityId\", activityRun.getActivityId());\n-          notificationIntent1.putExtra(\"notificationId\", notificationId);\n-          notificationIntent1.putExtra(\n-              \"date\", AppController.getDateFormat().format(time1.getTime()));\n-          notificationIntent1.putExtra(\"notificationNumber\", notificationNumber);\n-          try {\n-            int pendingIntentId =\n-                Integer.parseInt(\n-                        AppController.getHelperSharedPreference()\n-                            .readPreference(\n-                                context,\n-                                context.getResources().getString(R.string.pendingCount),\n-                                \"0\"))\n-                    + 1;\n-            AppController.getHelperSharedPreference()\n-                .writePreference(\n-                    context,\n-                    context.getResources().getString(R.string.pendingCount),\n-                    \"\" + pendingIntentId);\n-            PendingIntent broadcast =\n-                PendingIntent.getBroadcast(\n-                    context,\n-                    pendingIntentId,\n-                    notificationIntent1,\n-                    PendingIntent.FLAG_UPDATE_CURRENT);\n-            PendingIntents pendingIntents = new PendingIntents();\n-            pendingIntents.setActivityId(activityRun.getActivityId());\n-            pendingIntents.setStudyId(activityRun.getStudyId());\n-            pendingIntents.setPendingIntentId(pendingIntentId);\n-            pendingIntents.setDescription(description1);\n-            pendingIntents.setTitle(title);\n-            pendingIntents.setType(ACTIVITY);\n-            pendingIntents.setNotificationId(notificationId);\n-\n-            dbServiceSubscriber.savePendingIntentId(context, pendingIntents);\n-            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {\n-              alarmManager.setExactAndAllowWhileIdle(\n-                  AlarmManager.RTC_WAKEUP, time1.getTimeInMillis(), broadcast);\n-            } else {\n-              alarmManager.setExact(AlarmManager.RTC_WAKEUP, time1.getTimeInMillis(), broadcast);\n-            }\n-          } catch (Exception e) {\n-            Logger.log(e);\n+      try {\n+        Intent notificationIntent = new Intent(context, AlarmReceiver.class);\n+        notificationIntent.setAction(\"android.media.action.DISPLAY_NOTIFICATION\");\n+        notificationIntent.addCategory(\"android.intent.category.DEFAULT\");\n+        notificationIntent.putExtra(\"pendingIntentId\", 1);\n+        AlarmManager alarmManager = (AlarmManager) context.getSystemService(Context.ALARM_SERVICE);\n+        PendingIntent broadcast =\n+            PendingIntent.getBroadcast(\n+                context, 1, notificationIntent, PendingIntent.FLAG_UPDATE_CURRENT);\n+        try {\n+          if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {\n+            alarmManager.setExactAndAllowWhileIdle(\n+                AlarmManager.RTC_WAKEUP, calendar.getTimeInMillis(), broadcast);\n+          } else {\n+            alarmManager.setExact(AlarmManager.RTC_WAKEUP, calendar.getTimeInMillis(), broadcast);\n           }\n+        } catch (NullPointerException e) {\n+          Logger.log(e);\n         }\n+      } catch (Exception e) {\n+        Logger.log(e);\n       }\n+    }\n+  }\n+\n+  private boolean isSameDay(Date date1, Date date2) {\n+    Calendar calendar1 = Calendar.getInstance();\n+    calendar1.setTime(date1);\n+    Calendar calendar2 = Calendar.getInstance();\n+    calendar2.setTime(date2);\n+    return calendar1.get(Calendar.YEAR) == calendar2.get(Calendar.YEAR)\n+        && calendar1.get(Calendar.MONTH) == calendar2.get(Calendar.MONTH)\n+        && calendar1.get(Calendar.DAY_OF_MONTH) == calendar2.get(Calendar.DAY_OF_MONTH);\n+  }\n \n+  public void setAlarm(\n+      Context context,\n+      String title,\n+      String description,\n+      String type,\n+      int notificationId,\n+      String studyId,\n+      String activityId,\n+      Calendar time) {\n+    AlarmManager alarmManager = (AlarmManager) context.getSystemService(Context.ALARM_SERVICE);\n+    int notificationNumber = 1;\n+    Intent notificationIntent = new Intent(context, AlarmReceiver.class);\n+    notificationIntent.setAction(\"android.media.action.DISPLAY_NOTIFICATION\");", "originalCommit": "7ba1cc830224e7f6ce12a9c0bcacf910a46b55c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjA0MzM3OA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/420#discussion_r432043378", "bodyText": "updated in the latest commit.", "author": "naveenr-btc", "createdAt": "2020-05-28T18:40:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTE5Njk0OQ=="}], "type": "inlineReview", "revised_code": {"commit": "91ddd774b776e07458c06ec87cb1131b29069579", "chunk": "diff --git a/Android/app/src/main/java/com/harvard/notificationmodule/NotificationModuleSubscriber.java b/Android/app/src/main/java/com/harvard/notificationmodule/NotificationModuleSubscriber.java\nindex c1ccff563..402ff3f5a 100644\n--- a/Android/app/src/main/java/com/harvard/notificationmodule/NotificationModuleSubscriber.java\n+++ b/Android/app/src/main/java/com/harvard/notificationmodule/NotificationModuleSubscriber.java\n\n@@ -67,217 +69,128 @@ public class NotificationModuleSubscriber {\n     Calendar time = Calendar.getInstance();\n     Calendar time1 = Calendar.getInstance();\n     ActivitiesWS activitiesWS =\n-        dbServiceSubscriber.getActivityItem(\n-            activityRun.getStudyId(), activityRun.getActivityId(), mRealm);\n-\n-    try {\n-      if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_ONE_TIME)) {\n-        Date date = removeOffset(activityRun.getEndDate(), offset);\n-        time.setTime(date);\n-        time.add(Calendar.HOUR_OF_DAY, -24);\n-\n-        Date date1 = removeOffset(activityRun.getStartDate(), offset);\n-        time1.setTime(date1);\n-\n-        description =\n-            context.getResources().getString(R.string.the_activity)\n-                + \" \"\n-                + activitiesWS.getTitle()\n-                + \" \"\n-                + context.getResources().getString(R.string.participation_is_important);\n-        description1 =\n-            context.getResources().getString(R.string.the_activity)\n-                + \" \"\n-                + activitiesWS.getTitle()\n-                + \", \"\n-                + context.getResources().getString(R.string.now_available_to_take);\n-      } else if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_MANUALLY_SCHEDULE)) {\n-        Date date = removeOffset(activityRun.getStartDate(), offset);\n-        time.setTime(date);\n-        description =\n-            context.getResources().getString(R.string.scheduled_activity)\n-                + \" \"\n-                + activitiesWS.getTitle()\n-                + \", \"\n-                + context.getResources().getString(R.string.valid_until)\n-                + \" \"\n-                + notificationFormat.format(activityRun.getEndDate())\n-                + context.getResources().getString(R.string.participation_is_important2);\n-      } else if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_WEEKLY)) {\n-        Date date = removeOffset(activityRun.getEndDate(), offset);\n-        time.setTime(date);\n-        time.add(Calendar.HOUR_OF_DAY, -24);\n-\n-        Date date1 = removeOffset(activityRun.getStartDate(), offset);\n-        time1.setTime(date1);\n-\n-        description =\n-            context.getResources().getString(R.string.weekly_activity)\n-                + \" \"\n-                + activitiesWS.getTitle()\n-                + \", \"\n-                + context.getResources().getString(R.string.participation_is_important);\n-        description1 =\n-            context.getResources().getString(R.string.new_run)\n-                + \" \"\n-                + activitiesWS.getTitle()\n-                + \", \"\n-                + context.getResources().getString(R.string.study_complete);\n-      } else if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_MONTHLY)) {\n-        Date date = removeOffset(activityRun.getEndDate(), offset);\n-        time.setTime(date);\n-        time.add(Calendar.HOUR_OF_DAY, -72);\n-\n-        Date date1 = removeOffset(activityRun.getStartDate(), offset);\n-        time1.setTime(date1);\n-\n-        description =\n-            context.getResources().getString(R.string.monthly_activity)\n-                + \" \"\n-                + activitiesWS.getTitle()\n-                + \", \"\n-                + context.getResources().getString(R.string.expire_in_three_days);\n-        description1 =\n-            context.getResources().getString(R.string.new_run_monthly_activity)\n-                + \" \"\n-                + activitiesWS.getTitle()\n-                + \", \"\n-                + context.getResources().getString(R.string.study_complete);\n-      } else if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_DAILY)) {\n-        Date date = removeOffset(activityRun.getStartDate(), offset);\n-        time.setTime(date);\n-        description =\n-            context.getResources().getString(R.string.new_run_daily_activity)\n-                + \" \"\n-                + activitiesWS.getTitle()\n-                + \", \"\n-                + context.getResources().getString(R.string.your_participation_important);\n-      } else if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_WITHIN_A_DAY)) {\n-        Date date = removeOffset(activityRun.getStartDate(), offset);\n-        time.setTime(date);\n-        description =\n-            context.getResources().getString(R.string.new_run_daily_activity)\n-                + \" \"\n-                + activitiesWS.getTitle()\n-                + \", \"\n-                + context.getResources().getString(R.string.valid_until)\n-                + \" \"\n-                + notificationFormat.format(activityRun.getEndDate())\n-                + context.getResources().getString(R.string.participation_is_important2);\n-      }\n-\n-      int notificationId;\n-\n-      if (time.getTime().after(new Date())) {\n-        notificationId = new Random().nextInt();\n-        NotificationDb notificationDb = new NotificationDb();\n-        notificationDb.setStudyId(activityRun.getStudyId());\n-        notificationDb.setActivityId(activityRun.getActivityId());\n-        notificationDb.setNotificationId(notificationId);\n-        notificationDb.setDateTime(time.getTime());\n-        notificationDb.setType(ACTIVITY);\n-        notificationDb.setId(1);\n-        notificationDb.setTitle(title);\n-        notificationDb.setDescription(description);\n-        notificationDb.setEndDateTime(removeOffset(activityRun.getEndDate(), offset));\n-        dbServiceSubscriber.updateNotificationToDb(context, notificationDb);\n-\n-        set24hourScheduler(context);\n-        if (isSameDay(new Date(), time.getTime())) {\n-          setAlarm(\n-              context,\n-              title,\n-              description,\n-              ACTIVITY,\n-              notificationId,\n-              activityRun.getStudyId(),\n-              activityRun.getActivityId(),\n-              time);\n-        }\n-      }\n-\n-      // Notification availability for monthly, weekly, One time\n-      if ((type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_MONTHLY)\n-          || type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_WEEKLY)\n-          || type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_ONE_TIME))) {\n-        if (time1.getTime().after(new Date())) {\n-          notificationId = new Random().nextInt();\n-          NotificationDb notificationDb = new NotificationDb();\n-          notificationDb.setStudyId(activityRun.getStudyId());\n-          notificationDb.setActivityId(activityRun.getActivityId());\n-          notificationDb.setNotificationId(notificationId);\n-          notificationDb.setDateTime(time1.getTime());\n-          notificationDb.setType(ACTIVITY);\n-          notificationDb.setTitle(title);\n-          notificationDb.setDescription(description1);\n-          notificationDb.setId(1);\n-          notificationDb.setEndDateTime(removeOffset(activityRun.getEndDate(), offset));\n-          dbServiceSubscriber.updateNotificationToDb(context, notificationDb);\n-          set24hourScheduler(context);\n-          if (isSameDay(new Date(), time1.getTime())) {\n-            setAlarm(\n-                context,\n-                title,\n-                description1,\n-                ACTIVITY,\n-                notificationId,\n-                activityRun.getStudyId(),\n-                activityRun.getActivityId(),\n-                time1);\n-          }\n-        }\n-      }\n-\n-    } catch (Exception e) {\n-      Logger.log(e);\n+            dbServiceSubscriber.getActivityItem(\n+                    activityRun.getStudyId(), activityRun.getActivityId(), mRealm);\n+\n+    if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_ONE_TIME)) {\n+      Date date = removeOffset(activityRun.getEndDate(), offset);\n+      time.setTime(date);\n+      time.add(Calendar.HOUR_OF_DAY, -24);\n+\n+      Date date1 = removeOffset(activityRun.getStartDate(), offset);\n+      time1.setTime(date1);\n+\n+      description =\n+              context.getResources().getString(R.string.the_activity)\n+                      + \" \"\n+                      + activitiesWS.getTitle()\n+                      + \" \"\n+                      + context.getResources().getString(R.string.participation_is_important);\n+      description1 =\n+              context.getResources().getString(R.string.the_activity)\n+                      + \" \"\n+                      + activitiesWS.getTitle()\n+                      + \", \"\n+                      + context.getResources().getString(R.string.now_available_to_take);\n+    } else if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_MANUALLY_SCHEDULE)) {\n+      Date date = removeOffset(activityRun.getStartDate(), offset);\n+      time.setTime(date);\n+      description =\n+              context.getResources().getString(R.string.scheduled_activity)\n+                      + \" \"\n+                      + activitiesWS.getTitle()\n+                      + \", \"\n+                      + context.getResources().getString(R.string.valid_until)\n+                      + \" \"\n+                      + notificationFormat.format(activityRun.getEndDate())\n+                      + context.getResources().getString(R.string.participation_is_important2);\n+    } else if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_WEEKLY)) {\n+      Date date = removeOffset(activityRun.getEndDate(), offset);\n+      time.setTime(date);\n+      time.add(Calendar.HOUR_OF_DAY, -24);\n+\n+      Date date1 = removeOffset(activityRun.getStartDate(), offset);\n+      time1.setTime(date1);\n+\n+      description =\n+              context.getResources().getString(R.string.weekly_activity)\n+                      + \" \"\n+                      + activitiesWS.getTitle()\n+                      + \", \"\n+                      + context.getResources().getString(R.string.participation_is_important);\n+      description1 =\n+              context.getResources().getString(R.string.new_run)\n+                      + \" \"\n+                      + activitiesWS.getTitle()\n+                      + \", \"\n+                      + context.getResources().getString(R.string.study_complete);\n+    } else if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_MONTHLY)) {\n+      Date date = removeOffset(activityRun.getEndDate(), offset);\n+      time.setTime(date);\n+      time.add(Calendar.HOUR_OF_DAY, -72);\n+\n+      Date date1 = removeOffset(activityRun.getStartDate(), offset);\n+      time1.setTime(date1);\n+\n+      description =\n+              context.getResources().getString(R.string.monthly_activity)\n+                      + \" \"\n+                      + activitiesWS.getTitle()\n+                      + \", \"\n+                      + context.getResources().getString(R.string.expire_in_three_days);\n+      description1 =\n+              context.getResources().getString(R.string.new_run_monthly_activity)\n+                      + \" \"\n+                      + activitiesWS.getTitle()\n+                      + \", \"\n+                      + context.getResources().getString(R.string.study_complete);\n+    } else if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_DAILY)) {\n+      Date date = removeOffset(activityRun.getStartDate(), offset);\n+      time.setTime(date);\n+      description =\n+              context.getResources().getString(R.string.new_run_daily_activity)\n+                      + \" \"\n+                      + activitiesWS.getTitle()\n+                      + \", \"\n+                      + context.getResources().getString(R.string.your_participation_important);\n+    } else if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_WITHIN_A_DAY)) {\n+      Date date = removeOffset(activityRun.getStartDate(), offset);\n+      time.setTime(date);\n+      description =\n+              context.getResources().getString(R.string.new_run_daily_activity)\n+                      + \" \"\n+                      + activitiesWS.getTitle()\n+                      + \", \"\n+                      + context.getResources().getString(R.string.valid_until)\n+                      + \" \"\n+                      + notificationFormat.format(activityRun.getEndDate())\n+                      + context.getResources().getString(R.string.participation_is_important2);\n+    }\n+    updateNotificationToDbAndSetAlarm(context, activityRun, time, title, description, offset);\n+    // Notification availability for monthly, weekly, One time\n+    if ((type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_MONTHLY)\n+            || type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_WEEKLY)\n+            || type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_ONE_TIME))) {\n+      updateNotificationToDbAndSetAlarm(context, activityRun, time1, title, description1, offset);\n     }\n   }\n \n   private void set24hourScheduler(Context context) {\n-    // checking if alram is working with pendingIntent\n-    boolean isWorking = false;\n-    try {\n-      Intent notificationIntent1 = new Intent(context, AlarmReceiver.class);\n-      notificationIntent1.setAction(\"android.media.action.DISPLAY_NOTIFICATION\");\n-      notificationIntent1.addCategory(\"android.intent.category.DEFAULT\");\n-      notificationIntent1.putExtra(\"pendingIntentId\", 1);\n-      isWorking =\n-          (PendingIntent.getBroadcast(context, 1, notificationIntent1, PendingIntent.FLAG_NO_CREATE)\n-              != null); // just changed the flag\n-    } catch (Exception e) {\n-      Logger.log(e);\n-    }\n-\n-    if (!isWorking) {\n-      Calendar calendar = Calendar.getInstance();\n-      calendar.set(Calendar.HOUR_OF_DAY, 0);\n-      calendar.set(Calendar.MINUTE, 0);\n-      calendar.set(Calendar.SECOND, 0);\n-      calendar.set(Calendar.MILLISECOND, 0);\n-      calendar.add(Calendar.DATE, 1);\n-\n-      try {\n-        Intent notificationIntent = new Intent(context, AlarmReceiver.class);\n-        notificationIntent.setAction(\"android.media.action.DISPLAY_NOTIFICATION\");\n-        notificationIntent.addCategory(\"android.intent.category.DEFAULT\");\n-        notificationIntent.putExtra(\"pendingIntentId\", 1);\n-        AlarmManager alarmManager = (AlarmManager) context.getSystemService(Context.ALARM_SERVICE);\n-        PendingIntent broadcast =\n+    Calendar calendar = getCalenderNextDay();\n+    Intent notificationIntent =\n+            new Intent(context, AlarmReceiver.class)\n+                    .setAction(\"android.media.action.DISPLAY_NOTIFICATION\")\n+                    .addCategory(\"android.intent.category.DEFAULT\")\n+                    .putExtra(\"pendingIntentId\", 1);\n+    AlarmManager alarmManager = (AlarmManager) context.getSystemService(Context.ALARM_SERVICE);\n+    PendingIntent broadcast =\n             PendingIntent.getBroadcast(\n-                context, 1, notificationIntent, PendingIntent.FLAG_UPDATE_CURRENT);\n-        try {\n-          if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {\n-            alarmManager.setExactAndAllowWhileIdle(\n-                AlarmManager.RTC_WAKEUP, calendar.getTimeInMillis(), broadcast);\n-          } else {\n-            alarmManager.setExact(AlarmManager.RTC_WAKEUP, calendar.getTimeInMillis(), broadcast);\n-          }\n-        } catch (NullPointerException e) {\n-          Logger.log(e);\n-        }\n-      } catch (Exception e) {\n-        Logger.log(e);\n-      }\n+                    context, 1, notificationIntent, PendingIntent.FLAG_UPDATE_CURRENT);\n+    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {\n+      alarmManager.setExactAndAllowWhileIdle(\n+              AlarmManager.RTC_WAKEUP, calendar.getTimeInMillis(), broadcast);\n+    } else {\n+      alarmManager.setExact(AlarmManager.RTC_WAKEUP, calendar.getTimeInMillis(), broadcast);\n     }\n   }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTIxMTg2NA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/420#discussion_r431211864", "bodyText": "Why 5?", "author": "nikklassen", "createdAt": "2020-05-27T15:03:36Z", "path": "Android/app/src/main/java/com/harvard/notificationmodule/NotificationModuleSubscriber.java", "diffHunk": "@@ -252,61 +213,140 @@ public void generateActivityLocalNotification(\n           notificationDb.setId(1);\n           notificationDb.setEndDateTime(removeOffset(activityRun.getEndDate(), offset));\n           dbServiceSubscriber.updateNotificationToDb(context, notificationDb);\n+          set24hourScheduler(context);\n+          if (isSameDay(new Date(), time1.getTime())) {\n+            setAlarm(\n+                context,\n+                title,\n+                description1,\n+                ACTIVITY,\n+                notificationId,\n+                activityRun.getStudyId(),\n+                activityRun.getActivityId(),\n+                time1);\n+          }\n+        }\n+      }\n+\n+    } catch (Exception e) {\n+      Logger.log(e);\n+    }\n+  }\n+\n+  private void set24hourScheduler(Context context) {\n+    // checking if alram is working with pendingIntent\n+    boolean isWorking = false;\n+    try {\n+      Intent notificationIntent1 = new Intent(context, AlarmReceiver.class);\n+      notificationIntent1.setAction(\"android.media.action.DISPLAY_NOTIFICATION\");\n+      notificationIntent1.addCategory(\"android.intent.category.DEFAULT\");\n+      notificationIntent1.putExtra(\"pendingIntentId\", 1);\n+      isWorking =\n+          (PendingIntent.getBroadcast(context, 1, notificationIntent1, PendingIntent.FLAG_NO_CREATE)\n+              != null); // just changed the flag\n+    } catch (Exception e) {\n+      Logger.log(e);\n+    }\n+\n+    if (!isWorking) {\n+      Calendar calendar = Calendar.getInstance();\n+      calendar.set(Calendar.HOUR_OF_DAY, 0);\n+      calendar.set(Calendar.MINUTE, 0);\n+      calendar.set(Calendar.SECOND, 0);\n+      calendar.set(Calendar.MILLISECOND, 0);\n+      calendar.add(Calendar.DATE, 1);\n \n-          Intent notificationIntent1 = new Intent(context, AlarmReceiver.class);\n-          notificationIntent1.setAction(\"android.media.action.DISPLAY_NOTIFICATION\");\n-          notificationIntent1.addCategory(\"android.intent.category.DEFAULT\");\n-          notificationIntent1.putExtra(\"title\", title);\n-          notificationIntent1.putExtra(\"description\", description1);\n-          notificationIntent1.putExtra(\"type\", ACTIVITY);\n-          notificationIntent1.putExtra(\"studyId\", activityRun.getStudyId());\n-          notificationIntent1.putExtra(\"activityId\", activityRun.getActivityId());\n-          notificationIntent1.putExtra(\"notificationId\", notificationId);\n-          notificationIntent1.putExtra(\n-              \"date\", AppController.getDateFormat().format(time1.getTime()));\n-          notificationIntent1.putExtra(\"notificationNumber\", notificationNumber);\n-          try {\n-            int pendingIntentId =\n-                Integer.parseInt(\n-                        AppController.getHelperSharedPreference()\n-                            .readPreference(\n-                                context,\n-                                context.getResources().getString(R.string.pendingCount),\n-                                \"0\"))\n-                    + 1;\n-            AppController.getHelperSharedPreference()\n-                .writePreference(\n-                    context,\n-                    context.getResources().getString(R.string.pendingCount),\n-                    \"\" + pendingIntentId);\n-            PendingIntent broadcast =\n-                PendingIntent.getBroadcast(\n-                    context,\n-                    pendingIntentId,\n-                    notificationIntent1,\n-                    PendingIntent.FLAG_UPDATE_CURRENT);\n-            PendingIntents pendingIntents = new PendingIntents();\n-            pendingIntents.setActivityId(activityRun.getActivityId());\n-            pendingIntents.setStudyId(activityRun.getStudyId());\n-            pendingIntents.setPendingIntentId(pendingIntentId);\n-            pendingIntents.setDescription(description1);\n-            pendingIntents.setTitle(title);\n-            pendingIntents.setType(ACTIVITY);\n-            pendingIntents.setNotificationId(notificationId);\n-\n-            dbServiceSubscriber.savePendingIntentId(context, pendingIntents);\n-            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {\n-              alarmManager.setExactAndAllowWhileIdle(\n-                  AlarmManager.RTC_WAKEUP, time1.getTimeInMillis(), broadcast);\n-            } else {\n-              alarmManager.setExact(AlarmManager.RTC_WAKEUP, time1.getTimeInMillis(), broadcast);\n-            }\n-          } catch (Exception e) {\n-            Logger.log(e);\n+      try {\n+        Intent notificationIntent = new Intent(context, AlarmReceiver.class);\n+        notificationIntent.setAction(\"android.media.action.DISPLAY_NOTIFICATION\");\n+        notificationIntent.addCategory(\"android.intent.category.DEFAULT\");\n+        notificationIntent.putExtra(\"pendingIntentId\", 1);\n+        AlarmManager alarmManager = (AlarmManager) context.getSystemService(Context.ALARM_SERVICE);\n+        PendingIntent broadcast =\n+            PendingIntent.getBroadcast(\n+                context, 1, notificationIntent, PendingIntent.FLAG_UPDATE_CURRENT);\n+        try {\n+          if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {\n+            alarmManager.setExactAndAllowWhileIdle(\n+                AlarmManager.RTC_WAKEUP, calendar.getTimeInMillis(), broadcast);\n+          } else {\n+            alarmManager.setExact(AlarmManager.RTC_WAKEUP, calendar.getTimeInMillis(), broadcast);\n           }\n+        } catch (NullPointerException e) {\n+          Logger.log(e);\n         }\n+      } catch (Exception e) {\n+        Logger.log(e);\n       }\n+    }\n+  }\n+\n+  private boolean isSameDay(Date date1, Date date2) {\n+    Calendar calendar1 = Calendar.getInstance();\n+    calendar1.setTime(date1);\n+    Calendar calendar2 = Calendar.getInstance();\n+    calendar2.setTime(date2);\n+    return calendar1.get(Calendar.YEAR) == calendar2.get(Calendar.YEAR)\n+        && calendar1.get(Calendar.MONTH) == calendar2.get(Calendar.MONTH)\n+        && calendar1.get(Calendar.DAY_OF_MONTH) == calendar2.get(Calendar.DAY_OF_MONTH);\n+  }\n \n+  public void setAlarm(\n+      Context context,\n+      String title,\n+      String description,\n+      String type,\n+      int notificationId,\n+      String studyId,\n+      String activityId,\n+      Calendar time) {\n+    AlarmManager alarmManager = (AlarmManager) context.getSystemService(Context.ALARM_SERVICE);\n+    int notificationNumber = 1;\n+    Intent notificationIntent = new Intent(context, AlarmReceiver.class);\n+    notificationIntent.setAction(\"android.media.action.DISPLAY_NOTIFICATION\");\n+    notificationIntent.addCategory(\"android.intent.category.DEFAULT\");\n+    notificationIntent.putExtra(\"title\", title);\n+    notificationIntent.putExtra(\"description\", description);\n+    notificationIntent.putExtra(\"type\", type);\n+    notificationIntent.putExtra(\"notificationId\", notificationId);\n+    notificationIntent.putExtra(\"studyId\", studyId);\n+    notificationIntent.putExtra(\"activityId\", activityId);\n+    notificationIntent.putExtra(\"date\", AppController.getDateFormat().format(time.getTime()));\n+    notificationIntent.putExtra(\"notificationNumber\", notificationNumber);\n+    try {\n+      int pendingIntentId =\n+          Integer.parseInt(\n+                  AppController.getHelperSharedPreference()\n+                      .readPreference(\n+                          context, context.getResources().getString(R.string.pendingCount), \"5\"))", "originalCommit": "7ba1cc830224e7f6ce12a9c0bcacf910a46b55c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjA0NTA5MQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/420#discussion_r432045091", "bodyText": "we have reserved 1-4 numbers for other type of notifications and so 5 is used for this", "author": "naveenr-btc", "createdAt": "2020-05-28T18:43:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTIxMTg2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjQ4NjQ5MA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/420#discussion_r432486490", "bodyText": "Can you make an enum to give readable names to what the notification types mean?", "author": "nikklassen", "createdAt": "2020-05-29T13:35:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTIxMTg2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjYyMDQxOQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/420#discussion_r432620419", "bodyText": "The alarm issue was happening because the app was scheduling all the alarm at once. After this fix, the app is going to schedule alarms for a day. The remaining alarm is going to set daily at a specified time with the help of 24 hour repeated alarm. For the repeating alarm, the app is setting an id which is 1. The ids 2,3 and 4 are reserved for future use, in case if we have to create alarm for a different use case. The ids from 5 will be incremented and used to create alarms for activities scheduled with daily, weakly and other types of frequency. Since these are not static value and has to be created dynamically, the option for using enum is ruled out.", "author": "rohitn-boston", "createdAt": "2020-05-29T17:05:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTIxMTg2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzIyMzM1Ng==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/420#discussion_r433223356", "bodyText": "It is probably not a good idea to use a single number for so many use cases. However, that's not really in scope here. For now just creating a variable called RECURRING_ALARM_START_ID or something is fine.", "author": "nikklassen", "createdAt": "2020-06-01T13:09:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTIxMTg2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzI5NDk4Mw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/420#discussion_r433294983", "bodyText": "updated in the latest commit.", "author": "naveenr-btc", "createdAt": "2020-06-01T15:14:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTIxMTg2NA=="}], "type": "inlineReview", "revised_code": {"commit": "91ddd774b776e07458c06ec87cb1131b29069579", "chunk": "diff --git a/Android/app/src/main/java/com/harvard/notificationmodule/NotificationModuleSubscriber.java b/Android/app/src/main/java/com/harvard/notificationmodule/NotificationModuleSubscriber.java\nindex c1ccff563..402ff3f5a 100644\n--- a/Android/app/src/main/java/com/harvard/notificationmodule/NotificationModuleSubscriber.java\n+++ b/Android/app/src/main/java/com/harvard/notificationmodule/NotificationModuleSubscriber.java\n\n@@ -67,217 +69,128 @@ public class NotificationModuleSubscriber {\n     Calendar time = Calendar.getInstance();\n     Calendar time1 = Calendar.getInstance();\n     ActivitiesWS activitiesWS =\n-        dbServiceSubscriber.getActivityItem(\n-            activityRun.getStudyId(), activityRun.getActivityId(), mRealm);\n-\n-    try {\n-      if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_ONE_TIME)) {\n-        Date date = removeOffset(activityRun.getEndDate(), offset);\n-        time.setTime(date);\n-        time.add(Calendar.HOUR_OF_DAY, -24);\n-\n-        Date date1 = removeOffset(activityRun.getStartDate(), offset);\n-        time1.setTime(date1);\n-\n-        description =\n-            context.getResources().getString(R.string.the_activity)\n-                + \" \"\n-                + activitiesWS.getTitle()\n-                + \" \"\n-                + context.getResources().getString(R.string.participation_is_important);\n-        description1 =\n-            context.getResources().getString(R.string.the_activity)\n-                + \" \"\n-                + activitiesWS.getTitle()\n-                + \", \"\n-                + context.getResources().getString(R.string.now_available_to_take);\n-      } else if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_MANUALLY_SCHEDULE)) {\n-        Date date = removeOffset(activityRun.getStartDate(), offset);\n-        time.setTime(date);\n-        description =\n-            context.getResources().getString(R.string.scheduled_activity)\n-                + \" \"\n-                + activitiesWS.getTitle()\n-                + \", \"\n-                + context.getResources().getString(R.string.valid_until)\n-                + \" \"\n-                + notificationFormat.format(activityRun.getEndDate())\n-                + context.getResources().getString(R.string.participation_is_important2);\n-      } else if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_WEEKLY)) {\n-        Date date = removeOffset(activityRun.getEndDate(), offset);\n-        time.setTime(date);\n-        time.add(Calendar.HOUR_OF_DAY, -24);\n-\n-        Date date1 = removeOffset(activityRun.getStartDate(), offset);\n-        time1.setTime(date1);\n-\n-        description =\n-            context.getResources().getString(R.string.weekly_activity)\n-                + \" \"\n-                + activitiesWS.getTitle()\n-                + \", \"\n-                + context.getResources().getString(R.string.participation_is_important);\n-        description1 =\n-            context.getResources().getString(R.string.new_run)\n-                + \" \"\n-                + activitiesWS.getTitle()\n-                + \", \"\n-                + context.getResources().getString(R.string.study_complete);\n-      } else if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_MONTHLY)) {\n-        Date date = removeOffset(activityRun.getEndDate(), offset);\n-        time.setTime(date);\n-        time.add(Calendar.HOUR_OF_DAY, -72);\n-\n-        Date date1 = removeOffset(activityRun.getStartDate(), offset);\n-        time1.setTime(date1);\n-\n-        description =\n-            context.getResources().getString(R.string.monthly_activity)\n-                + \" \"\n-                + activitiesWS.getTitle()\n-                + \", \"\n-                + context.getResources().getString(R.string.expire_in_three_days);\n-        description1 =\n-            context.getResources().getString(R.string.new_run_monthly_activity)\n-                + \" \"\n-                + activitiesWS.getTitle()\n-                + \", \"\n-                + context.getResources().getString(R.string.study_complete);\n-      } else if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_DAILY)) {\n-        Date date = removeOffset(activityRun.getStartDate(), offset);\n-        time.setTime(date);\n-        description =\n-            context.getResources().getString(R.string.new_run_daily_activity)\n-                + \" \"\n-                + activitiesWS.getTitle()\n-                + \", \"\n-                + context.getResources().getString(R.string.your_participation_important);\n-      } else if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_WITHIN_A_DAY)) {\n-        Date date = removeOffset(activityRun.getStartDate(), offset);\n-        time.setTime(date);\n-        description =\n-            context.getResources().getString(R.string.new_run_daily_activity)\n-                + \" \"\n-                + activitiesWS.getTitle()\n-                + \", \"\n-                + context.getResources().getString(R.string.valid_until)\n-                + \" \"\n-                + notificationFormat.format(activityRun.getEndDate())\n-                + context.getResources().getString(R.string.participation_is_important2);\n-      }\n-\n-      int notificationId;\n-\n-      if (time.getTime().after(new Date())) {\n-        notificationId = new Random().nextInt();\n-        NotificationDb notificationDb = new NotificationDb();\n-        notificationDb.setStudyId(activityRun.getStudyId());\n-        notificationDb.setActivityId(activityRun.getActivityId());\n-        notificationDb.setNotificationId(notificationId);\n-        notificationDb.setDateTime(time.getTime());\n-        notificationDb.setType(ACTIVITY);\n-        notificationDb.setId(1);\n-        notificationDb.setTitle(title);\n-        notificationDb.setDescription(description);\n-        notificationDb.setEndDateTime(removeOffset(activityRun.getEndDate(), offset));\n-        dbServiceSubscriber.updateNotificationToDb(context, notificationDb);\n-\n-        set24hourScheduler(context);\n-        if (isSameDay(new Date(), time.getTime())) {\n-          setAlarm(\n-              context,\n-              title,\n-              description,\n-              ACTIVITY,\n-              notificationId,\n-              activityRun.getStudyId(),\n-              activityRun.getActivityId(),\n-              time);\n-        }\n-      }\n-\n-      // Notification availability for monthly, weekly, One time\n-      if ((type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_MONTHLY)\n-          || type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_WEEKLY)\n-          || type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_ONE_TIME))) {\n-        if (time1.getTime().after(new Date())) {\n-          notificationId = new Random().nextInt();\n-          NotificationDb notificationDb = new NotificationDb();\n-          notificationDb.setStudyId(activityRun.getStudyId());\n-          notificationDb.setActivityId(activityRun.getActivityId());\n-          notificationDb.setNotificationId(notificationId);\n-          notificationDb.setDateTime(time1.getTime());\n-          notificationDb.setType(ACTIVITY);\n-          notificationDb.setTitle(title);\n-          notificationDb.setDescription(description1);\n-          notificationDb.setId(1);\n-          notificationDb.setEndDateTime(removeOffset(activityRun.getEndDate(), offset));\n-          dbServiceSubscriber.updateNotificationToDb(context, notificationDb);\n-          set24hourScheduler(context);\n-          if (isSameDay(new Date(), time1.getTime())) {\n-            setAlarm(\n-                context,\n-                title,\n-                description1,\n-                ACTIVITY,\n-                notificationId,\n-                activityRun.getStudyId(),\n-                activityRun.getActivityId(),\n-                time1);\n-          }\n-        }\n-      }\n-\n-    } catch (Exception e) {\n-      Logger.log(e);\n+            dbServiceSubscriber.getActivityItem(\n+                    activityRun.getStudyId(), activityRun.getActivityId(), mRealm);\n+\n+    if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_ONE_TIME)) {\n+      Date date = removeOffset(activityRun.getEndDate(), offset);\n+      time.setTime(date);\n+      time.add(Calendar.HOUR_OF_DAY, -24);\n+\n+      Date date1 = removeOffset(activityRun.getStartDate(), offset);\n+      time1.setTime(date1);\n+\n+      description =\n+              context.getResources().getString(R.string.the_activity)\n+                      + \" \"\n+                      + activitiesWS.getTitle()\n+                      + \" \"\n+                      + context.getResources().getString(R.string.participation_is_important);\n+      description1 =\n+              context.getResources().getString(R.string.the_activity)\n+                      + \" \"\n+                      + activitiesWS.getTitle()\n+                      + \", \"\n+                      + context.getResources().getString(R.string.now_available_to_take);\n+    } else if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_MANUALLY_SCHEDULE)) {\n+      Date date = removeOffset(activityRun.getStartDate(), offset);\n+      time.setTime(date);\n+      description =\n+              context.getResources().getString(R.string.scheduled_activity)\n+                      + \" \"\n+                      + activitiesWS.getTitle()\n+                      + \", \"\n+                      + context.getResources().getString(R.string.valid_until)\n+                      + \" \"\n+                      + notificationFormat.format(activityRun.getEndDate())\n+                      + context.getResources().getString(R.string.participation_is_important2);\n+    } else if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_WEEKLY)) {\n+      Date date = removeOffset(activityRun.getEndDate(), offset);\n+      time.setTime(date);\n+      time.add(Calendar.HOUR_OF_DAY, -24);\n+\n+      Date date1 = removeOffset(activityRun.getStartDate(), offset);\n+      time1.setTime(date1);\n+\n+      description =\n+              context.getResources().getString(R.string.weekly_activity)\n+                      + \" \"\n+                      + activitiesWS.getTitle()\n+                      + \", \"\n+                      + context.getResources().getString(R.string.participation_is_important);\n+      description1 =\n+              context.getResources().getString(R.string.new_run)\n+                      + \" \"\n+                      + activitiesWS.getTitle()\n+                      + \", \"\n+                      + context.getResources().getString(R.string.study_complete);\n+    } else if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_MONTHLY)) {\n+      Date date = removeOffset(activityRun.getEndDate(), offset);\n+      time.setTime(date);\n+      time.add(Calendar.HOUR_OF_DAY, -72);\n+\n+      Date date1 = removeOffset(activityRun.getStartDate(), offset);\n+      time1.setTime(date1);\n+\n+      description =\n+              context.getResources().getString(R.string.monthly_activity)\n+                      + \" \"\n+                      + activitiesWS.getTitle()\n+                      + \", \"\n+                      + context.getResources().getString(R.string.expire_in_three_days);\n+      description1 =\n+              context.getResources().getString(R.string.new_run_monthly_activity)\n+                      + \" \"\n+                      + activitiesWS.getTitle()\n+                      + \", \"\n+                      + context.getResources().getString(R.string.study_complete);\n+    } else if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_DAILY)) {\n+      Date date = removeOffset(activityRun.getStartDate(), offset);\n+      time.setTime(date);\n+      description =\n+              context.getResources().getString(R.string.new_run_daily_activity)\n+                      + \" \"\n+                      + activitiesWS.getTitle()\n+                      + \", \"\n+                      + context.getResources().getString(R.string.your_participation_important);\n+    } else if (type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_WITHIN_A_DAY)) {\n+      Date date = removeOffset(activityRun.getStartDate(), offset);\n+      time.setTime(date);\n+      description =\n+              context.getResources().getString(R.string.new_run_daily_activity)\n+                      + \" \"\n+                      + activitiesWS.getTitle()\n+                      + \", \"\n+                      + context.getResources().getString(R.string.valid_until)\n+                      + \" \"\n+                      + notificationFormat.format(activityRun.getEndDate())\n+                      + context.getResources().getString(R.string.participation_is_important2);\n+    }\n+    updateNotificationToDbAndSetAlarm(context, activityRun, time, title, description, offset);\n+    // Notification availability for monthly, weekly, One time\n+    if ((type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_MONTHLY)\n+            || type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_WEEKLY)\n+            || type.equalsIgnoreCase(SurveyScheduler.FREQUENCY_TYPE_ONE_TIME))) {\n+      updateNotificationToDbAndSetAlarm(context, activityRun, time1, title, description1, offset);\n     }\n   }\n \n   private void set24hourScheduler(Context context) {\n-    // checking if alram is working with pendingIntent\n-    boolean isWorking = false;\n-    try {\n-      Intent notificationIntent1 = new Intent(context, AlarmReceiver.class);\n-      notificationIntent1.setAction(\"android.media.action.DISPLAY_NOTIFICATION\");\n-      notificationIntent1.addCategory(\"android.intent.category.DEFAULT\");\n-      notificationIntent1.putExtra(\"pendingIntentId\", 1);\n-      isWorking =\n-          (PendingIntent.getBroadcast(context, 1, notificationIntent1, PendingIntent.FLAG_NO_CREATE)\n-              != null); // just changed the flag\n-    } catch (Exception e) {\n-      Logger.log(e);\n-    }\n-\n-    if (!isWorking) {\n-      Calendar calendar = Calendar.getInstance();\n-      calendar.set(Calendar.HOUR_OF_DAY, 0);\n-      calendar.set(Calendar.MINUTE, 0);\n-      calendar.set(Calendar.SECOND, 0);\n-      calendar.set(Calendar.MILLISECOND, 0);\n-      calendar.add(Calendar.DATE, 1);\n-\n-      try {\n-        Intent notificationIntent = new Intent(context, AlarmReceiver.class);\n-        notificationIntent.setAction(\"android.media.action.DISPLAY_NOTIFICATION\");\n-        notificationIntent.addCategory(\"android.intent.category.DEFAULT\");\n-        notificationIntent.putExtra(\"pendingIntentId\", 1);\n-        AlarmManager alarmManager = (AlarmManager) context.getSystemService(Context.ALARM_SERVICE);\n-        PendingIntent broadcast =\n+    Calendar calendar = getCalenderNextDay();\n+    Intent notificationIntent =\n+            new Intent(context, AlarmReceiver.class)\n+                    .setAction(\"android.media.action.DISPLAY_NOTIFICATION\")\n+                    .addCategory(\"android.intent.category.DEFAULT\")\n+                    .putExtra(\"pendingIntentId\", 1);\n+    AlarmManager alarmManager = (AlarmManager) context.getSystemService(Context.ALARM_SERVICE);\n+    PendingIntent broadcast =\n             PendingIntent.getBroadcast(\n-                context, 1, notificationIntent, PendingIntent.FLAG_UPDATE_CURRENT);\n-        try {\n-          if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {\n-            alarmManager.setExactAndAllowWhileIdle(\n-                AlarmManager.RTC_WAKEUP, calendar.getTimeInMillis(), broadcast);\n-          } else {\n-            alarmManager.setExact(AlarmManager.RTC_WAKEUP, calendar.getTimeInMillis(), broadcast);\n-          }\n-        } catch (NullPointerException e) {\n-          Logger.log(e);\n-        }\n-      } catch (Exception e) {\n-        Logger.log(e);\n-      }\n+                    context, 1, notificationIntent, PendingIntent.FLAG_UPDATE_CURRENT);\n+    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {\n+      alarmManager.setExactAndAllowWhileIdle(\n+              AlarmManager.RTC_WAKEUP, calendar.getTimeInMillis(), broadcast);\n+    } else {\n+      alarmManager.setExact(AlarmManager.RTC_WAKEUP, calendar.getTimeInMillis(), broadcast);\n     }\n   }\n \n"}}, {"oid": "91ddd774b776e07458c06ec87cb1131b29069579", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/91ddd774b776e07458c06ec87cb1131b29069579", "message": "code review updates for notification classes", "committedDate": "2020-05-28T18:36:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjQ4NDAyNA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/420#discussion_r432484024", "bodyText": "Do you know these will be in order? Otherwise this should use max", "author": "nikklassen", "createdAt": "2020-05-29T13:31:29Z", "path": "Android/app/src/main/java/com/harvard/notificationmodule/NotificationModuleSubscriber.java", "diffHunk": "@@ -287,194 +200,184 @@ private boolean isSameDay(Date date1, Date date2) {\n     Calendar calendar2 = Calendar.getInstance();\n     calendar2.setTime(date2);\n     return calendar1.get(Calendar.YEAR) == calendar2.get(Calendar.YEAR)\n-        && calendar1.get(Calendar.MONTH) == calendar2.get(Calendar.MONTH)\n-        && calendar1.get(Calendar.DAY_OF_MONTH) == calendar2.get(Calendar.DAY_OF_MONTH);\n+            && calendar1.get(Calendar.MONTH) == calendar2.get(Calendar.MONTH)\n+            && calendar1.get(Calendar.DAY_OF_MONTH) == calendar2.get(Calendar.DAY_OF_MONTH);\n   }\n \n   public void setAlarm(\n-      Context context,\n-      String title,\n-      String description,\n-      String type,\n-      int notificationId,\n-      String studyId,\n-      String activityId,\n-      Calendar time) {\n+          Context context,\n+          String title,\n+          String description,\n+          String type,\n+          int notificationId,\n+          String studyId,\n+          String activityId,\n+          Calendar time) {\n     AlarmManager alarmManager = (AlarmManager) context.getSystemService(Context.ALARM_SERVICE);\n     int notificationNumber = 1;\n-    Intent notificationIntent = new Intent(context, AlarmReceiver.class);\n-    notificationIntent.setAction(\"android.media.action.DISPLAY_NOTIFICATION\");\n-    notificationIntent.addCategory(\"android.intent.category.DEFAULT\");\n-    notificationIntent.putExtra(\"title\", title);\n-    notificationIntent.putExtra(\"description\", description);\n-    notificationIntent.putExtra(\"type\", type);\n-    notificationIntent.putExtra(\"notificationId\", notificationId);\n-    notificationIntent.putExtra(\"studyId\", studyId);\n-    notificationIntent.putExtra(\"activityId\", activityId);\n-    notificationIntent.putExtra(\"date\", AppController.getDateFormat().format(time.getTime()));\n-    notificationIntent.putExtra(\"notificationNumber\", notificationNumber);\n-    try {\n-      int pendingIntentId =\n-          Integer.parseInt(\n-                  AppController.getHelperSharedPreference()\n-                      .readPreference(\n-                          context, context.getResources().getString(R.string.pendingCount), \"5\"))\n-              + 1;\n-      AppController.getHelperSharedPreference()\n-          .writePreference(\n-              context,\n-              context.getResources().getString(R.string.pendingCount),\n-              \"\" + pendingIntentId);\n-\n-      notificationIntent.putExtra(\"pendingIntentId\", pendingIntentId);\n+    Intent notificationIntent =\n+            new Intent(context, AlarmReceiver.class)\n+                    .setAction(\"android.media.action.DISPLAY_NOTIFICATION\")\n+                    .addCategory(\"android.intent.category.DEFAULT\")\n+                    .putExtra(\"title\", title)\n+                    .putExtra(\"description\", description)\n+                    .putExtra(\"type\", type)\n+                    .putExtra(\"notificationId\", notificationId)\n+                    .putExtra(\"studyId\", studyId)\n+                    .putExtra(\"activityId\", activityId)\n+                    .putExtra(\"date\", AppController.getDateFormat().format(time.getTime()))\n+                    .putExtra(\"notificationNumber\", notificationNumber);\n+\n+    int pendingIntentId =\n+            Integer.parseInt(\n+                    AppController.getHelperSharedPreference()\n+                            .readPreference(\n+                                    context, context.getResources().getString(R.string.pendingCount), \"5\"))\n+                    + 1;\n+    AppController.getHelperSharedPreference()\n+            .writePreference(\n+                    context, context.getResources().getString(R.string.pendingCount), \"\" + pendingIntentId);\n \n-      PendingIntent broadcast =\n-          PendingIntent.getBroadcast(\n-              context, pendingIntentId, notificationIntent, PendingIntent.FLAG_UPDATE_CURRENT);\n-      PendingIntents pendingIntents = new PendingIntents();\n-      pendingIntents.setActivityId(activityId);\n-      pendingIntents.setStudyId(studyId);\n-      pendingIntents.setPendingIntentId(pendingIntentId);\n-      pendingIntents.setDescription(description);\n-      pendingIntents.setTitle(title);\n-      pendingIntents.setType(type);\n-      pendingIntents.setNotificationId(notificationId);\n+    notificationIntent.putExtra(\"pendingIntentId\", pendingIntentId);\n \n-      dbServiceSubscriber.savePendingIntentId(context, pendingIntents);\n-      if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {\n-        alarmManager.setExactAndAllowWhileIdle(\n-            AlarmManager.RTC_WAKEUP, time.getTimeInMillis(), broadcast);\n-      } else {\n-        alarmManager.setExact(AlarmManager.RTC_WAKEUP, time.getTimeInMillis(), broadcast);\n-      }\n-    } catch (Exception e) {\n-      Logger.log(e);\n+    PendingIntent broadcast =\n+            PendingIntent.getBroadcast(\n+                    context, pendingIntentId, notificationIntent, PendingIntent.FLAG_UPDATE_CURRENT);\n+    PendingIntents pendingIntents = new PendingIntents();\n+    pendingIntents.setActivityId(activityId);\n+    pendingIntents.setStudyId(studyId);\n+    pendingIntents.setPendingIntentId(pendingIntentId);\n+    pendingIntents.setDescription(description);\n+    pendingIntents.setTitle(title);\n+    pendingIntents.setType(type);\n+    pendingIntents.setNotificationId(notificationId);\n+\n+    dbServiceSubscriber.savePendingIntentId(context, pendingIntents);\n+    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {\n+      alarmManager.setExactAndAllowWhileIdle(\n+              AlarmManager.RTC_WAKEUP, time.getTimeInMillis(), broadcast);\n+    } else {\n+      alarmManager.setExact(AlarmManager.RTC_WAKEUP, time.getTimeInMillis(), broadcast);\n     }\n   }\n \n   public void generateTwoWeekNotification(Date date, Context context) {\n-    try {\n-      String title = context.getResources().getString(R.string.app_name);\n-      Calendar calendar = Calendar.getInstance();\n-      calendar.setTime(date);\n-      AlarmManager alarmManager = (AlarmManager) context.getSystemService(Context.ALARM_SERVICE);\n \n-      Intent notificationIntent = new Intent(context, AlarmReceiver.class);\n-      notificationIntent.setAction(\"android.media.action.DISPLAY_NOTIFICATION\");\n-      notificationIntent.addCategory(\"android.intent.category.DEFAULT\");\n-      notificationIntent.putExtra(\"title\", title);\n-      notificationIntent.putExtra(\n-          \"description\", context.getResources().getString(R.string.studie_your_enrolled));\n-      notificationIntent.putExtra(\"type\", NO_USE_NOTIFICATION);\n-      notificationIntent.putExtra(\"date\", AppController.getDateFormat().format(calendar.getTime()));\n+    String title = context.getResources().getString(R.string.app_name);\n+    Calendar calendar = Calendar.getInstance();\n+    calendar.setTime(date);\n+    AlarmManager alarmManager = (AlarmManager) context.getSystemService(Context.ALARM_SERVICE);\n \n-      PendingIntent broadcast =\n-          PendingIntent.getBroadcast(\n-              context, pendingId, notificationIntent, PendingIntent.FLAG_UPDATE_CURRENT);\n-      if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {\n-        alarmManager.setExactAndAllowWhileIdle(\n-            AlarmManager.RTC_WAKEUP, calendar.getTimeInMillis(), broadcast);\n-      } else {\n-        alarmManager.setExact(AlarmManager.RTC_WAKEUP, calendar.getTimeInMillis(), broadcast);\n-      }\n-    } catch (Exception e) {\n-      Logger.log(e);\n+    Intent notificationIntent =\n+            new Intent(context, AlarmReceiver.class)\n+                    .setAction(\"android.media.action.DISPLAY_NOTIFICATION\")\n+                    .addCategory(\"android.intent.category.DEFAULT\")\n+                    .putExtra(\"title\", title)\n+                    .putExtra(\n+                            \"description\", context.getResources().getString(R.string.studie_your_enrolled))\n+                    .putExtra(\"type\", NO_USE_NOTIFICATION)\n+                    .putExtra(\"date\", AppController.getDateFormat().format(calendar.getTime()));\n+\n+    PendingIntent broadcast =\n+            PendingIntent.getBroadcast(\n+                    context, pendingId, notificationIntent, PendingIntent.FLAG_UPDATE_CURRENT);\n+    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {\n+      alarmManager.setExactAndAllowWhileIdle(\n+              AlarmManager.RTC_WAKEUP, calendar.getTimeInMillis(), broadcast);\n+    } else {\n+      alarmManager.setExact(AlarmManager.RTC_WAKEUP, calendar.getTimeInMillis(), broadcast);\n     }\n   }\n \n   public void cancelTwoWeekNotification(Context context) {\n-    try {\n-      AlarmManager alarmManager = (AlarmManager) context.getSystemService(Context.ALARM_SERVICE);\n-      String title = context.getResources().getString(R.string.app_name);\n-      Intent notificationIntent = new Intent(context, AlarmReceiver.class);\n-      notificationIntent.setAction(\"android.media.action.DISPLAY_NOTIFICATION\");\n-      notificationIntent.addCategory(\"android.intent.category.DEFAULT\");\n-      notificationIntent.putExtra(\"title\", title);\n-      notificationIntent.putExtra(\n-          \"description\", context.getResources().getString(R.string.studie_your_enrolled));\n-      notificationIntent.putExtra(\"type\", NO_USE_NOTIFICATION);\n-      PendingIntent broadcast =\n-          PendingIntent.getBroadcast(\n-              context, pendingId, notificationIntent, PendingIntent.FLAG_UPDATE_CURRENT);\n-      broadcast.cancel();\n-      alarmManager.cancel(broadcast);\n-    } catch (Exception e) {\n-      Logger.log(e);\n-    }\n+\n+    AlarmManager alarmManager = (AlarmManager) context.getSystemService(Context.ALARM_SERVICE);\n+    String title = context.getResources().getString(R.string.app_name);\n+    Intent notificationIntent =\n+            new Intent(context, AlarmReceiver.class)\n+                    .setAction(\"android.media.action.DISPLAY_NOTIFICATION\")\n+                    .addCategory(\"android.intent.category.DEFAULT\")\n+                    .putExtra(\"title\", title)\n+                    .putExtra(\n+                            \"description\", context.getResources().getString(R.string.studie_your_enrolled))\n+                    .putExtra(\"type\", NO_USE_NOTIFICATION);\n+    PendingIntent broadcast =\n+            PendingIntent.getBroadcast(\n+                    context, pendingId, notificationIntent, PendingIntent.FLAG_UPDATE_CURRENT);\n+    broadcast.cancel();\n+    alarmManager.cancel(broadcast);\n   }\n \n   public void generateNotificationTurnOffNotification(Date date, Context context) {\n-    try {\n-      String title = context.getResources().getString(R.string.app_name);\n-      Calendar calendar = Calendar.getInstance();\n-      calendar.setTime(date);\n-      calendar.add(Calendar.DAY_OF_MONTH, 7);\n-      AlarmManager alarmManager = (AlarmManager) context.getSystemService(Context.ALARM_SERVICE);\n \n-      Intent notificationIntent = new Intent(context, AlarmReceiver.class);\n-      notificationIntent.setAction(\"android.media.action.DISPLAY_NOTIFICATION\");\n-      notificationIntent.addCategory(\"android.intent.category.DEFAULT\");\n-      notificationIntent.putExtra(\"title\", title);\n-      notificationIntent.putExtra(\n-          \"description\", context.getResources().getString(R.string.notificatinturnoffnotification));\n-      notificationIntent.putExtra(\"type\", NOTIFICATION_TURN_OFF_NOTIFICATION);\n-      notificationIntent.putExtra(\"date\", AppController.getDateFormat().format(calendar.getTime()));\n+    String title = context.getResources().getString(R.string.app_name);\n+    Calendar calendar = Calendar.getInstance();\n+    calendar.setTime(date);\n+    calendar.add(Calendar.DAY_OF_MONTH, 7);\n+    AlarmManager alarmManager = (AlarmManager) context.getSystemService(Context.ALARM_SERVICE);\n \n-      PendingIntent broadcast =\n-          PendingIntent.getBroadcast(\n-              context, pendingId1, notificationIntent, PendingIntent.FLAG_UPDATE_CURRENT);\n-      if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {\n-        alarmManager.setExactAndAllowWhileIdle(\n-            AlarmManager.RTC_WAKEUP, calendar.getTimeInMillis(), broadcast);\n-      } else {\n-        alarmManager.setExact(AlarmManager.RTC_WAKEUP, calendar.getTimeInMillis(), broadcast);\n-      }\n-    } catch (Exception e) {\n-      Logger.log(e);\n+    Intent notificationIntent =\n+            new Intent(context, AlarmReceiver.class)\n+                    .setAction(\"android.media.action.DISPLAY_NOTIFICATION\")\n+                    .addCategory(\"android.intent.category.DEFAULT\")\n+                    .putExtra(\"title\", title)\n+                    .putExtra(\n+                            \"description\",\n+                            context.getResources().getString(R.string.notificatinturnoffnotification))\n+                    .putExtra(\"type\", NOTIFICATION_TURN_OFF_NOTIFICATION)\n+                    .putExtra(\"date\", AppController.getDateFormat().format(calendar.getTime()));\n+\n+    PendingIntent broadcast =\n+            PendingIntent.getBroadcast(\n+                    context, pendingId1, notificationIntent, PendingIntent.FLAG_UPDATE_CURRENT);\n+    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {\n+      alarmManager.setExactAndAllowWhileIdle(\n+              AlarmManager.RTC_WAKEUP, calendar.getTimeInMillis(), broadcast);\n+    } else {\n+      alarmManager.setExact(AlarmManager.RTC_WAKEUP, calendar.getTimeInMillis(), broadcast);\n     }\n   }\n \n   public void cancelNotificationTurnOffNotification(Context context) {\n-    try {\n-      AlarmManager alarmManager = (AlarmManager) context.getSystemService(Context.ALARM_SERVICE);\n-      String title = context.getResources().getString(R.string.app_name);\n-      Intent notificationIntent = new Intent(context, AlarmReceiver.class);\n-      notificationIntent.setAction(\"android.media.action.DISPLAY_NOTIFICATION\");\n-      notificationIntent.addCategory(\"android.intent.category.DEFAULT\");\n-      notificationIntent.putExtra(\"title\", title);\n-      notificationIntent.putExtra(\n-          \"description\", context.getResources().getString(R.string.notificatinturnoffnotification));\n-      notificationIntent.putExtra(\"type\", NOTIFICATION_TURN_OFF_NOTIFICATION);\n-      PendingIntent broadcast =\n-          PendingIntent.getBroadcast(\n-              context, pendingId1, notificationIntent, PendingIntent.FLAG_UPDATE_CURRENT);\n-      broadcast.cancel();\n-      alarmManager.cancel(broadcast);\n-    } catch (Exception e) {\n-      Logger.log(e);\n-    }\n+\n+    AlarmManager alarmManager = (AlarmManager) context.getSystemService(Context.ALARM_SERVICE);\n+    String title = context.getResources().getString(R.string.app_name);\n+    Intent notificationIntent =\n+            new Intent(context, AlarmReceiver.class)\n+                    .setAction(\"android.media.action.DISPLAY_NOTIFICATION\")\n+                    .addCategory(\"android.intent.category.DEFAULT\")\n+                    .putExtra(\"title\", title)\n+                    .putExtra(\n+                            \"description\",\n+                            context.getResources().getString(R.string.notificatinturnoffnotification))\n+                    .putExtra(\"type\", NOTIFICATION_TURN_OFF_NOTIFICATION);\n+    PendingIntent broadcast =\n+            PendingIntent.getBroadcast(\n+                    context, pendingId1, notificationIntent, PendingIntent.FLAG_UPDATE_CURRENT);\n+    broadcast.cancel();\n+    alarmManager.cancel(broadcast);\n   }\n \n   public void generateAnchorDateLocalNotification(\n-      Date date,\n-      String activityId,\n-      String studyId,\n-      Context context,\n-      String notificationTest,\n-      String resourceId) {\n+          Date date,\n+          String activityId,\n+          String studyId,\n+          Context context,\n+          String notificationTest,\n+          String resourceId) {\n     String title = \"MyStudies\";\n     String description = \"\";\n     Calendar time = Calendar.getInstance();\n     NotificationDbResources notificationsDb = null;\n     RealmResults<NotificationDbResources> notificationsDbs =\n-        dbServiceSubscriber.getNotificationDbResources(activityId, studyId, RESOURCES, mRealm);\n+            dbServiceSubscriber.getNotificationDbResources(activityId, studyId, RESOURCES, mRealm);\n     int id = 0;\n-    if (notificationsDbs != null && notificationsDbs.size() > 0) {\n-      for (int i = 0; i < notificationsDbs.size(); i++) {\n-        if (notificationsDbs.get(i).getResourceId().equalsIgnoreCase(resourceId)) {\n-          notificationsDb = notificationsDbs.get(i);\n+    if (notificationsDbs != null) {\n+      for (NotificationDbResources notificationDbResources : notificationsDbs) {\n+        if (notificationDbResources.getResourceId().equalsIgnoreCase(resourceId)) {\n+          notificationsDb = notificationDbResources;\n         }\n-        id = notificationsDbs.get(i).getId();\n+        id = notificationDbResources.getId();", "originalCommit": "91ddd774b776e07458c06ec87cb1131b29069579", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjU5NDMzMQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/420#discussion_r432594331", "bodyText": "updated in the latest commit.", "author": "naveenr-btc", "createdAt": "2020-05-29T16:19:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjQ4NDAyNA=="}], "type": "inlineReview", "revised_code": {"commit": "acba04c0046ac8fc1de2b7383f9772e5126083a0", "chunk": "diff --git a/Android/app/src/main/java/com/harvard/notificationmodule/NotificationModuleSubscriber.java b/Android/app/src/main/java/com/harvard/notificationmodule/NotificationModuleSubscriber.java\nindex 402ff3f5a..2f80727af 100644\n--- a/Android/app/src/main/java/com/harvard/notificationmodule/NotificationModuleSubscriber.java\n+++ b/Android/app/src/main/java/com/harvard/notificationmodule/NotificationModuleSubscriber.java\n\n@@ -200,49 +200,49 @@ public class NotificationModuleSubscriber {\n     Calendar calendar2 = Calendar.getInstance();\n     calendar2.setTime(date2);\n     return calendar1.get(Calendar.YEAR) == calendar2.get(Calendar.YEAR)\n-            && calendar1.get(Calendar.MONTH) == calendar2.get(Calendar.MONTH)\n-            && calendar1.get(Calendar.DAY_OF_MONTH) == calendar2.get(Calendar.DAY_OF_MONTH);\n+        && calendar1.get(Calendar.MONTH) == calendar2.get(Calendar.MONTH)\n+        && calendar1.get(Calendar.DAY_OF_MONTH) == calendar2.get(Calendar.DAY_OF_MONTH);\n   }\n \n   public void setAlarm(\n-          Context context,\n-          String title,\n-          String description,\n-          String type,\n-          int notificationId,\n-          String studyId,\n-          String activityId,\n-          Calendar time) {\n+      Context context,\n+      String title,\n+      String description,\n+      String type,\n+      int notificationId,\n+      String studyId,\n+      String activityId,\n+      Calendar time) {\n     AlarmManager alarmManager = (AlarmManager) context.getSystemService(Context.ALARM_SERVICE);\n     int notificationNumber = 1;\n     Intent notificationIntent =\n-            new Intent(context, AlarmReceiver.class)\n-                    .setAction(\"android.media.action.DISPLAY_NOTIFICATION\")\n-                    .addCategory(\"android.intent.category.DEFAULT\")\n-                    .putExtra(\"title\", title)\n-                    .putExtra(\"description\", description)\n-                    .putExtra(\"type\", type)\n-                    .putExtra(\"notificationId\", notificationId)\n-                    .putExtra(\"studyId\", studyId)\n-                    .putExtra(\"activityId\", activityId)\n-                    .putExtra(\"date\", AppController.getDateFormat().format(time.getTime()))\n-                    .putExtra(\"notificationNumber\", notificationNumber);\n+        new Intent(context, AlarmReceiver.class)\n+            .setAction(\"android.media.action.DISPLAY_NOTIFICATION\")\n+            .addCategory(\"android.intent.category.DEFAULT\")\n+            .putExtra(\"title\", title)\n+            .putExtra(\"description\", description)\n+            .putExtra(\"type\", type)\n+            .putExtra(\"notificationId\", notificationId)\n+            .putExtra(\"studyId\", studyId)\n+            .putExtra(\"activityId\", activityId)\n+            .putExtra(\"date\", AppController.getDateFormat().format(time.getTime()))\n+            .putExtra(\"notificationNumber\", notificationNumber);\n \n     int pendingIntentId =\n-            Integer.parseInt(\n-                    AppController.getHelperSharedPreference()\n-                            .readPreference(\n-                                    context, context.getResources().getString(R.string.pendingCount), \"5\"))\n-                    + 1;\n+        Integer.parseInt(\n+                AppController.getHelperSharedPreference()\n+                    .readPreference(\n+                        context, context.getResources().getString(R.string.pendingCount), \"5\"))\n+            + 1;\n     AppController.getHelperSharedPreference()\n-            .writePreference(\n-                    context, context.getResources().getString(R.string.pendingCount), \"\" + pendingIntentId);\n+        .writePreference(\n+            context, context.getResources().getString(R.string.pendingCount), \"\" + pendingIntentId);\n \n     notificationIntent.putExtra(\"pendingIntentId\", pendingIntentId);\n \n     PendingIntent broadcast =\n-            PendingIntent.getBroadcast(\n-                    context, pendingIntentId, notificationIntent, PendingIntent.FLAG_UPDATE_CURRENT);\n+        PendingIntent.getBroadcast(\n+            context, pendingIntentId, notificationIntent, PendingIntent.FLAG_UPDATE_CURRENT);\n     PendingIntents pendingIntents = new PendingIntents();\n     pendingIntents.setActivityId(activityId);\n     pendingIntents.setStudyId(studyId);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjQ4NTYyMw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/420#discussion_r432485623", "bodyText": "if (!time.getTime().after(new Date())) {\n    return;\n}\n...\n\nprevents the whole function from being nested.", "author": "nikklassen", "createdAt": "2020-05-29T13:34:19Z", "path": "Android/app/src/main/java/com/harvard/notificationmodule/NotificationModuleSubscriber.java", "diffHunk": "@@ -655,25 +555,73 @@ public void cancleActivityLocalNotification(Context context) {\n \n     RealmResults<PendingIntents> pendingIntentses = dbServiceSubscriber.getPendingIntentId(mRealm);\n     if (pendingIntentses != null) {\n-      for (int i = 0; i < pendingIntentses.size(); i++) {\n+      for (PendingIntents pendingIntents : pendingIntentses) {\n         Intent notificationIntent = new Intent(context, AlarmReceiver.class);\n-        notificationIntent.setAction(\"android.media.action.DISPLAY_NOTIFICATION\");\n-        notificationIntent.addCategory(\"android.intent.category.DEFAULT\");\n-        notificationIntent.putExtra(\"title\", pendingIntentses.get(i).getTitle());\n-        notificationIntent.putExtra(\"description\", pendingIntentses.get(i).getDescription());\n-        notificationIntent.putExtra(\"type\", pendingIntentses.get(i).getType());\n-        notificationIntent.putExtra(\"studyId\", pendingIntentses.get(i).getStudyId());\n-        notificationIntent.putExtra(\"activityId\", pendingIntentses.get(i).getActivityId());\n-        notificationIntent.putExtra(\"notificationId\", pendingIntentses.get(i).getNotificationId());\n+        notificationIntent\n+                .setAction(\"android.media.action.DISPLAY_NOTIFICATION\")\n+                .addCategory(\"android.intent.category.DEFAULT\")\n+                .putExtra(\"title\", pendingIntents.getTitle())\n+                .putExtra(\"description\", pendingIntents.getDescription())\n+                .putExtra(\"type\", pendingIntents.getType())\n+                .putExtra(\"studyId\", pendingIntents.getStudyId())\n+                .putExtra(\"activityId\", pendingIntents.getActivityId())\n+                .putExtra(\"notificationId\", pendingIntents.getNotificationId());\n         PendingIntent broadcast =\n-            PendingIntent.getBroadcast(\n-                context,\n-                pendingIntentses.get(i).getPendingIntentId(),\n-                notificationIntent,\n-                PendingIntent.FLAG_UPDATE_CURRENT);\n+                PendingIntent.getBroadcast(\n+                        context,\n+                        pendingIntents.getPendingIntentId(),\n+                        notificationIntent,\n+                        PendingIntent.FLAG_UPDATE_CURRENT);\n         broadcast.cancel();\n         alarmManager.cancel(broadcast);\n       }\n     }\n   }\n+\n+  private void updateNotificationToDbAndSetAlarm(\n+          Context context,\n+          ActivityRun activityRun,\n+          Calendar time,\n+          String title,\n+          String description,\n+          int offset) {\n+    if (time.getTime().after(new Date())) {", "originalCommit": "91ddd774b776e07458c06ec87cb1131b29069579", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjU5NDA4Mg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/420#discussion_r432594082", "bodyText": "updated in the latest commit.", "author": "naveenr-btc", "createdAt": "2020-05-29T16:18:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjQ4NTYyMw=="}], "type": "inlineReview", "revised_code": {"commit": "acba04c0046ac8fc1de2b7383f9772e5126083a0", "chunk": "diff --git a/Android/app/src/main/java/com/harvard/notificationmodule/NotificationModuleSubscriber.java b/Android/app/src/main/java/com/harvard/notificationmodule/NotificationModuleSubscriber.java\nindex 402ff3f5a..2f80727af 100644\n--- a/Android/app/src/main/java/com/harvard/notificationmodule/NotificationModuleSubscriber.java\n+++ b/Android/app/src/main/java/com/harvard/notificationmodule/NotificationModuleSubscriber.java\n\n@@ -558,20 +551,20 @@ public class NotificationModuleSubscriber {\n       for (PendingIntents pendingIntents : pendingIntentses) {\n         Intent notificationIntent = new Intent(context, AlarmReceiver.class);\n         notificationIntent\n-                .setAction(\"android.media.action.DISPLAY_NOTIFICATION\")\n-                .addCategory(\"android.intent.category.DEFAULT\")\n-                .putExtra(\"title\", pendingIntents.getTitle())\n-                .putExtra(\"description\", pendingIntents.getDescription())\n-                .putExtra(\"type\", pendingIntents.getType())\n-                .putExtra(\"studyId\", pendingIntents.getStudyId())\n-                .putExtra(\"activityId\", pendingIntents.getActivityId())\n-                .putExtra(\"notificationId\", pendingIntents.getNotificationId());\n+            .setAction(\"android.media.action.DISPLAY_NOTIFICATION\")\n+            .addCategory(\"android.intent.category.DEFAULT\")\n+            .putExtra(\"title\", pendingIntents.getTitle())\n+            .putExtra(\"description\", pendingIntents.getDescription())\n+            .putExtra(\"type\", pendingIntents.getType())\n+            .putExtra(\"studyId\", pendingIntents.getStudyId())\n+            .putExtra(\"activityId\", pendingIntents.getActivityId())\n+            .putExtra(\"notificationId\", pendingIntents.getNotificationId());\n         PendingIntent broadcast =\n-                PendingIntent.getBroadcast(\n-                        context,\n-                        pendingIntents.getPendingIntentId(),\n-                        notificationIntent,\n-                        PendingIntent.FLAG_UPDATE_CURRENT);\n+            PendingIntent.getBroadcast(\n+                context,\n+                pendingIntents.getPendingIntentId(),\n+                notificationIntent,\n+                PendingIntent.FLAG_UPDATE_CURRENT);\n         broadcast.cancel();\n         alarmManager.cancel(broadcast);\n       }\n"}}, {"oid": "acba04c0046ac8fc1de2b7383f9772e5126083a0", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/acba04c0046ac8fc1de2b7383f9772e5126083a0", "message": "Code review updates", "committedDate": "2020-05-29T16:13:38Z", "type": "commit"}, {"oid": "e0ba2ed392f08ab2921ca54f1ce3cc06bcf37ad2", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/e0ba2ed392f08ab2921ca54f1ce3cc06bcf37ad2", "message": "Code review updates", "committedDate": "2020-06-01T15:08:29Z", "type": "commit"}, {"oid": "e124a4c1bd92726985c86739f60be9e9767b565b", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/e124a4c1bd92726985c86739f60be9e9767b565b", "message": "Merge branch 'early-access' into early-access-notification", "committedDate": "2020-06-02T07:10:06Z", "type": "commit"}]}