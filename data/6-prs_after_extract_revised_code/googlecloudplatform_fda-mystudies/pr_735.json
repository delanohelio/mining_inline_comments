{"pr_number": 735, "pr_title": "Participant Manager Service setup account endpoint implementation with integration test cases", "pr_createdAt": "2020-08-10T16:17:45Z", "pr_url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/735", "timeline": [{"oid": "b00d2cbb28bd98a7a830db9cf98a03e893cc1c5b", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/b00d2cbb28bd98a7a830db9cf98a03e893cc1c5b", "message": "POST setup account endpoint integration tests\n\nPOST setup account endpoint integration tests", "committedDate": "2020-08-10T16:15:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIzNjE3Nw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/735#discussion_r468236177", "bodyText": "These are not used and already stored in TestDataHelper/TestConstants so please remove", "author": "saminguyen", "createdAt": "2020-08-10T23:14:53Z", "path": "participant-manager-module/participant-manager-service/src/test/java/com/google/cloud/healthcare/fdamystudies/controller/UserProfileControllerTest.java", "diffHunk": "@@ -0,0 +1,174 @@\n+package com.google.cloud.healthcare.fdamystudies.controller;\n+\n+import com.github.tomakehurst.wiremock.client.WireMock;\n+import com.google.cloud.healthcare.fdamystudies.beans.SetUpAccountRequest;\n+import com.google.cloud.healthcare.fdamystudies.common.ApiEndpoint;\n+import com.google.cloud.healthcare.fdamystudies.common.BaseMockIT;\n+import com.google.cloud.healthcare.fdamystudies.common.ErrorCode;\n+import com.google.cloud.healthcare.fdamystudies.common.MessageCode;\n+import com.google.cloud.healthcare.fdamystudies.common.TestConstants;\n+import com.google.cloud.healthcare.fdamystudies.common.UserAccountStatus;\n+import com.google.cloud.healthcare.fdamystudies.helper.TestDataHelper;\n+import com.google.cloud.healthcare.fdamystudies.model.UserRegAdminEntity;\n+import com.google.cloud.healthcare.fdamystudies.repository.UserRegAdminRepository;\n+import com.google.cloud.healthcare.fdamystudies.service.UserProfileService;\n+import java.util.Optional;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.http.HttpHeaders;\n+\n+import static com.github.tomakehurst.wiremock.client.WireMock.postRequestedFor;\n+import static com.github.tomakehurst.wiremock.client.WireMock.urlEqualTo;\n+import static com.github.tomakehurst.wiremock.client.WireMock.verify;\n+import static com.google.cloud.healthcare.fdamystudies.common.JsonUtils.asJsonString;\n+import static org.hamcrest.CoreMatchers.is;\n+import static org.hamcrest.CoreMatchers.notNullValue;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.post;\n+import static org.springframework.test.web.servlet.result.MockMvcResultHandlers.print;\n+import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.jsonPath;\n+import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;\n+\n+public class UserProfileControllerTest extends BaseMockIT {\n+\n+  @Autowired private UserProfileController controller;\n+\n+  @Autowired private UserProfileService userProfileService;\n+\n+  @Autowired private TestDataHelper testDataHelper;\n+\n+  private UserRegAdminEntity userRegAdminEntity;\n+\n+  @Autowired UserRegAdminRepository userRegAdminRepository;\n+\n+  public static final String EMAIL_VALUE = \"mockit_email@grr.la\";\n+\n+  protected static final String VALID_BEARER_TOKEN = \"Bearer 7fd50c2c-d618-493c-89d6-f1887e3e4bb8\";", "originalCommit": "b00d2cbb28bd98a7a830db9cf98a03e893cc1c5b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODM0ODE2MQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/735#discussion_r468348161", "bodyText": "fixed review comment", "author": "Kantharajut-btc", "createdAt": "2020-08-11T06:11:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIzNjE3Nw=="}], "type": "inlineReview", "revised_code": {"commit": "a27950c4bbad3032a581e88bc114dfe3c719f564", "chunk": "diff --git a/participant-manager-module/participant-manager-service/src/test/java/com/google/cloud/healthcare/fdamystudies/controller/UserProfileControllerTest.java b/participant-manager-module/participant-manager-service/src/test/java/com/google/cloud/healthcare/fdamystudies/controller/UserProfileControllerTest.java\nindex b30dfd4b9..f7b145687 100644\n--- a/participant-manager-module/participant-manager-service/src/test/java/com/google/cloud/healthcare/fdamystudies/controller/UserProfileControllerTest.java\n+++ b/participant-manager-module/participant-manager-service/src/test/java/com/google/cloud/healthcare/fdamystudies/controller/UserProfileControllerTest.java\n\n@@ -44,10 +44,6 @@ public class UserProfileControllerTest extends BaseMockIT {\n \n   @Autowired UserRegAdminRepository userRegAdminRepository;\n \n-  public static final String EMAIL_VALUE = \"mockit_email@grr.la\";\n-\n-  protected static final String VALID_BEARER_TOKEN = \"Bearer 7fd50c2c-d618-493c-89d6-f1887e3e4bb8\";\n-\n   @Test\n   public void contextLoads() {\n     assertNotNull(controller);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIzNjk0OQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/735#discussion_r468236949", "bodyText": "To make it clear set the email for the request here to a random email address", "author": "saminguyen", "createdAt": "2020-08-10T23:17:20Z", "path": "participant-manager-module/participant-manager-service/src/test/java/com/google/cloud/healthcare/fdamystudies/controller/UserProfileControllerTest.java", "diffHunk": "@@ -0,0 +1,174 @@\n+package com.google.cloud.healthcare.fdamystudies.controller;\n+\n+import com.github.tomakehurst.wiremock.client.WireMock;\n+import com.google.cloud.healthcare.fdamystudies.beans.SetUpAccountRequest;\n+import com.google.cloud.healthcare.fdamystudies.common.ApiEndpoint;\n+import com.google.cloud.healthcare.fdamystudies.common.BaseMockIT;\n+import com.google.cloud.healthcare.fdamystudies.common.ErrorCode;\n+import com.google.cloud.healthcare.fdamystudies.common.MessageCode;\n+import com.google.cloud.healthcare.fdamystudies.common.TestConstants;\n+import com.google.cloud.healthcare.fdamystudies.common.UserAccountStatus;\n+import com.google.cloud.healthcare.fdamystudies.helper.TestDataHelper;\n+import com.google.cloud.healthcare.fdamystudies.model.UserRegAdminEntity;\n+import com.google.cloud.healthcare.fdamystudies.repository.UserRegAdminRepository;\n+import com.google.cloud.healthcare.fdamystudies.service.UserProfileService;\n+import java.util.Optional;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.http.HttpHeaders;\n+\n+import static com.github.tomakehurst.wiremock.client.WireMock.postRequestedFor;\n+import static com.github.tomakehurst.wiremock.client.WireMock.urlEqualTo;\n+import static com.github.tomakehurst.wiremock.client.WireMock.verify;\n+import static com.google.cloud.healthcare.fdamystudies.common.JsonUtils.asJsonString;\n+import static org.hamcrest.CoreMatchers.is;\n+import static org.hamcrest.CoreMatchers.notNullValue;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.post;\n+import static org.springframework.test.web.servlet.result.MockMvcResultHandlers.print;\n+import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.jsonPath;\n+import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;\n+\n+public class UserProfileControllerTest extends BaseMockIT {\n+\n+  @Autowired private UserProfileController controller;\n+\n+  @Autowired private UserProfileService userProfileService;\n+\n+  @Autowired private TestDataHelper testDataHelper;\n+\n+  private UserRegAdminEntity userRegAdminEntity;\n+\n+  @Autowired UserRegAdminRepository userRegAdminRepository;\n+\n+  public static final String EMAIL_VALUE = \"mockit_email@grr.la\";\n+\n+  protected static final String VALID_BEARER_TOKEN = \"Bearer 7fd50c2c-d618-493c-89d6-f1887e3e4bb8\";\n+\n+  @Test\n+  public void contextLoads() {\n+    assertNotNull(controller);\n+    assertNotNull(mockMvc);\n+    assertNotNull(userProfileService);\n+  }\n+\n+  @BeforeEach\n+  public void setUp() {\n+    userRegAdminEntity = testDataHelper.createUserRegAdmin();\n+    WireMock.resetAllRequests();\n+  }\n+\n+  @Test\n+  public void shouldSetUpNewAccount() throws Exception {\n+    // Step 1: Setting up the request for set up account\n+    SetUpAccountRequest request = setUpAccountRequest();\n+    userRegAdminEntity.setEmail(TestConstants.USER_EMAIL_VALUE);\n+    testDataHelper.getUserRegAdminRepository().saveAndFlush(userRegAdminEntity);\n+\n+    // Step 2: Call the API and expect SET_UP_ACCOUNT_SUCCESS message\n+    HttpHeaders headers = testDataHelper.newCommonHeaders();\n+\n+    mockMvc\n+        .perform(\n+            post(ApiEndpoint.SET_UP_ACCOUNT.getPath())\n+                .content(asJsonString(request))\n+                .headers(headers)\n+                .contextPath(getContextPath()))\n+        .andDo(print())\n+        .andExpect(status().isCreated())\n+        .andExpect(jsonPath(\"$.message\").value(MessageCode.SET_UP_ACCOUNT_SUCCESS.getMessage()))\n+        .andExpect(jsonPath(\"$.userId\", notNullValue()))\n+        .andReturn();\n+\n+    // Step 3: verify saved values\n+    Optional<UserRegAdminEntity> optUser = userRegAdminRepository.findByEmail(request.getEmail());\n+    UserRegAdminEntity user = optUser.get();\n+    assertEquals(request.getFirstName(), user.getFirstName());\n+    assertEquals(request.getLastName(), user.getLastName());\n+\n+    verify(1, postRequestedFor(urlEqualTo(\"/oauth-scim-service/users\")));\n+  }\n+\n+  @Test\n+  public void shouldReturnUserNotInvitedError() throws Exception {\n+    // Step 1: Setting up the request\n+    SetUpAccountRequest request = setUpAccountRequest();\n+", "originalCommit": "b00d2cbb28bd98a7a830db9cf98a03e893cc1c5b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODQxMjA0NA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/735#discussion_r468412044", "bodyText": "fixed review comment", "author": "Kantharajut-btc", "createdAt": "2020-08-11T08:26:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIzNjk0OQ=="}], "type": "inlineReview", "revised_code": {"commit": "a27950c4bbad3032a581e88bc114dfe3c719f564", "chunk": "diff --git a/participant-manager-module/participant-manager-service/src/test/java/com/google/cloud/healthcare/fdamystudies/controller/UserProfileControllerTest.java b/participant-manager-module/participant-manager-service/src/test/java/com/google/cloud/healthcare/fdamystudies/controller/UserProfileControllerTest.java\nindex b30dfd4b9..f7b145687 100644\n--- a/participant-manager-module/participant-manager-service/src/test/java/com/google/cloud/healthcare/fdamystudies/controller/UserProfileControllerTest.java\n+++ b/participant-manager-module/participant-manager-service/src/test/java/com/google/cloud/healthcare/fdamystudies/controller/UserProfileControllerTest.java\n\n@@ -44,10 +44,6 @@ public class UserProfileControllerTest extends BaseMockIT {\n \n   @Autowired UserRegAdminRepository userRegAdminRepository;\n \n-  public static final String EMAIL_VALUE = \"mockit_email@grr.la\";\n-\n-  protected static final String VALID_BEARER_TOKEN = \"Bearer 7fd50c2c-d618-493c-89d6-f1887e3e4bb8\";\n-\n   @Test\n   public void contextLoads() {\n     assertNotNull(controller);\n"}}, {"oid": "a27950c4bbad3032a581e88bc114dfe3c719f564", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/a27950c4bbad3032a581e88bc114dfe3c719f564", "message": "Fixed PR comments\n\nFixed PR comments", "committedDate": "2020-08-11T06:19:22Z", "type": "commit"}, {"oid": "32965bd8079da009758bf5c49162c538a78a2f86", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/32965bd8079da009758bf5c49162c538a78a2f86", "message": "Added fields in TestConstants\n\nAdded fields in TestConstants", "committedDate": "2020-08-11T07:36:56Z", "type": "commit"}, {"oid": "38cbf473fcba40354a85862b8d54c8b27d44b3e1", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/38cbf473fcba40354a85862b8d54c8b27d44b3e1", "message": "Merge branch 'participant-manager-setup-account' into participant-manager-setup-account-test-cases", "committedDate": "2020-08-12T04:03:34Z", "type": "commit"}, {"oid": "765ee3585c8433d28612565facd2d394c5fce7d3", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/765ee3585c8433d28612565facd2d394c5fce7d3", "message": "Merge branch 'develop' into participant-manager-setup-account-test-cases", "committedDate": "2020-08-13T04:31:44Z", "type": "commit"}]}