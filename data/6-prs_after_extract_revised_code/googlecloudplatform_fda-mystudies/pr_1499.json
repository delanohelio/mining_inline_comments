{"pr_number": 1499, "pr_title": "[Enrollment Service]:Issue #1357 and #1447 fixed", "pr_createdAt": "2020-10-19T15:49:45Z", "pr_url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1499", "timeline": [{"oid": "9af9bdc17be72894846dfdb4c1b7efd26063d18c", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/9af9bdc17be72894846dfdb4c1b7efd26063d18c", "message": "issue 1357 fixed", "committedDate": "2020-10-19T15:43:24Z", "type": "commit"}, {"oid": "cd8ef32336c55c7eb625953468b95553b6f19b5a", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/cd8ef32336c55c7eb625953468b95553b6f19b5a", "message": "Merge branch 'develop' into issue1357", "committedDate": "2020-10-19T15:52:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODAyODYxMg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1499#discussion_r508028612", "bodyText": "How will this fix the two issues mentioned", "author": "saminguyen", "createdAt": "2020-10-19T20:03:22Z", "path": "participant-datastore/enroll-mgmt-module/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/dao/EnrollmentTokenDaoImpl.java", "diffHunk": "@@ -103,13 +105,25 @@ public boolean hasParticipant(@NotNull String studyId, @NotNull String tokenValu\n     List<Object[]> participantList = null;\n     boolean hasParticipant = false;\n     Session session = this.sessionFactory.getCurrentSession();\n+    List<String> studyStateStatus = new ArrayList<>();\n+    studyStateStatus.add(ParticipantStudyStateStatus.ENROLLED.getValue());\n+    studyStateStatus.add(ParticipantStudyStateStatus.WITHDRAWN.getValue());\n+    studyStateStatus.add(ParticipantStudyStateStatus.INPROGRESS.getValue());\n+\n+    List<String> onboardingStatus = new ArrayList<>();\n+    onboardingStatus.add(OnboardingStatus.ENROLLED.getCode());\n+    onboardingStatus.add(OnboardingStatus.DISABLED.getCode());\n     participantList =\n         session\n             .createQuery(\n                 \"from ParticipantStudyEntity PS,StudyEntity SB, ParticipantRegistrySiteEntity PR\"\n                     + \" where SB.id =PS.study.id and PS.participantRegistrySite.id=PR.id\"\n-                    + \" and PS.status='Enrolled' and PR.enrollmentToken=:token and SB.customId=:studyId\")\n-            .setParameter(\"token\", tokenValue)\n+                    + \" and PS.status in (:studyStateStatus) \"\n+                    + \" and PR.onboardingStatus in (:onboardingStatus)\"\n+                    + \" and upper(trim(PR.enrollmentToken))=:token and SB.customId=:studyId\")\n+            .setParameter(\"studyStateStatus\", studyStateStatus)\n+            .setParameter(\"onboardingStatus\", onboardingStatus)\n+            .setParameter(\"token\", tokenValue.toUpperCase())", "originalCommit": "cd8ef32336c55c7eb625953468b95553b6f19b5a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODU0NDIwNw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1499#discussion_r508544207", "bodyText": "Issue #1447\nIn the existing logic we were validating the token based on the Enroll status only. If a participant Withdrawn from the study , in such scenario other participants were enroll into the study using the same token even if it not mapped to them.\nIssue #1357\nIf the user Withdrawn from the study , we are updating the status to \"Withdrwan\" in Participant_Study_Info table. When we were checking the hasParticipant status , it was returning true as the record is available in the table for the participant with Withdrawn status, hence same participant not able to enroll into the same study.", "author": "madhurya-btc", "createdAt": "2020-10-20T14:13:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODAyODYxMg=="}], "type": "inlineReview", "revised_code": null}, {"oid": "cc8e31698c0b668c64aa8eef27c1d47554cc4fd4", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/cc8e31698c0b668c64aa8eef27c1d47554cc4fd4", "message": "Merge branch 'develop' into issue1357", "committedDate": "2020-10-20T14:13:50Z", "type": "commit"}, {"oid": "f4595105a10a6d85b4f09c49a981b2daa7c0ac24", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/f4595105a10a6d85b4f09c49a981b2daa7c0ac24", "message": "Merge branch 'develop' into issue1357", "committedDate": "2020-10-20T18:19:19Z", "type": "commit"}]}