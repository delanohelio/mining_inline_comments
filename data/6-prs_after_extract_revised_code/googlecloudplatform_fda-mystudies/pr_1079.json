{"pr_number": 1079, "pr_title": "User Management Service: /deactivate api endpoint with integration test cases", "pr_createdAt": "2020-09-29T16:59:41Z", "pr_url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1079", "timeline": [{"oid": "72fe075dc69f31875b26a7c57b43b809a0634843", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/72fe075dc69f31875b26a7c57b43b809a0634843", "message": "deactivate url implementation", "committedDate": "2020-09-29T07:28:59Z", "type": "commit"}, {"oid": "eb7bf00fe8ce7af29e2e7f55bd3b4b4a9883104e", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/eb7bf00fe8ce7af29e2e7f55bd3b4b4a9883104e", "message": "integration test cases", "committedDate": "2020-09-29T11:49:01Z", "type": "commit"}, {"oid": "d5c73fcac274e0dc5796a73781b7706cd4538005", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/d5c73fcac274e0dc5796a73781b7706cd4538005", "message": "deactivate api endpoint", "committedDate": "2020-09-29T13:44:25Z", "type": "commit"}, {"oid": "e66ff63c1c8c30cdc5b2120549f1c97528dfb84c", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/e66ff63c1c8c30cdc5b2120549f1c97528dfb84c", "message": "/deactivate api endpoint", "committedDate": "2020-09-29T16:01:54Z", "type": "commit"}, {"oid": "526a4ae188770ce36561672cec38e82605bac368", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/526a4ae188770ce36561672cec38e82605bac368", "message": "deactivate api endpoint", "committedDate": "2020-09-29T16:53:07Z", "type": "commit"}, {"oid": "69ea36d82468c1e0f8cc85ad4c537540d4e7e15a", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/69ea36d82468c1e0f8cc85ad4c537540d4e7e15a", "message": "Merge branch 'develop' into user-management-deactive-api-endpoint", "committedDate": "2020-09-29T17:07:19Z", "type": "commit"}, {"oid": "862c3a38b90be98487a2d9f3441497c7fc565fd0", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/862c3a38b90be98487a2d9f3441497c7fc565fd0", "message": "build issue", "committedDate": "2020-09-29T17:45:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk0NTkwNA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1079#discussion_r496945904", "bodyText": "nit: deactivateAcct", "author": "zohrehj", "createdAt": "2020-09-29T18:19:55Z", "path": "user-registration-server-ws/user-mgmt-module/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/dao/UserProfileManagementDao.java", "diffHunk": "@@ -36,5 +36,7 @@ public ErrorBean updateUserProfile(\n \n   public UserDetailsEntity getParticipantDetails(String id);\n \n-  public boolean deActivateAcct(String userId, List<String> deleteData, String userDetailsId);\n+  public void deActivateAcct(String userId, List<String> deleteData, String userDetailsId);", "originalCommit": "862c3a38b90be98487a2d9f3441497c7fc565fd0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzY4ODYyMg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1079#discussion_r497688622", "bodyText": "Fixed review comment", "author": "madhurya-btc", "createdAt": "2020-09-30T17:39:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk0NTkwNA=="}], "type": "inlineReview", "revised_code": {"commit": "c715d4266d0de7b04e9bda52333fd9fd366f4447", "chunk": "diff --git a/user-registration-server-ws/user-mgmt-module/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/dao/UserProfileManagementDao.java b/user-registration-server-ws/user-mgmt-module/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/dao/UserProfileManagementDao.java\nindex 211553929..2644635dc 100644\n--- a/user-registration-server-ws/user-mgmt-module/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/dao/UserProfileManagementDao.java\n+++ b/user-registration-server-ws/user-mgmt-module/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/dao/UserProfileManagementDao.java\n\n@@ -36,7 +36,7 @@ public interface UserProfileManagementDao {\n \n   public UserDetailsEntity getParticipantDetails(String id);\n \n-  public void deActivateAcct(String userId, List<String> deleteData, String userDetailsId);\n+  public void deactivateAcct(String userId, List<String> deleteData, String userDetailsId);\n \n   public void deactivateUserAccount(String userId);\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk1MzIyNg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1079#discussion_r496953226", "bodyText": "why set the userId to null? userId which is the primary key should not be nullable anyway, so I am not sure what the reasoning is here.", "author": "zohrehj", "createdAt": "2020-09-29T18:32:18Z", "path": "user-registration-server-ws/user-mgmt-module/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/dao/UserProfileManagementDaoImpl.java", "diffHunk": "@@ -342,4 +329,13 @@ public AppEntity getAppPropertiesDetailsByAppId(String appId) {\n     }\n     return appPropertiesDetails;\n   }\n+\n+  @Override\n+  public void deactivateUserAccount(String userId) {\n+    Optional<UserDetailsEntity> optUserDetails = userDetailsRepository.findByUserId(userId);\n+    UserDetailsEntity userDetailsEntity = optUserDetails.get();\n+    userDetailsEntity.setStatus(UserStatus.DEACTIVATED.getValue());\n+    userDetailsEntity.setUserId(null);", "originalCommit": "862c3a38b90be98487a2d9f3441497c7fc565fd0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzI4MDAzNQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1079#discussion_r497280035", "bodyText": "userId is not PK in UserDetailsEntity class.\npublic class UserDetailsEntity implements Serializable {\n\n  private static final long serialVersionUID = -6971868842609206885L;\n\n  @ToString.Exclude\n  @Id\n  @GeneratedValue(generator = \"system-uuid\")\n  @GenericGenerator(name = \"system-uuid\", strategy = \"uuid\")\n  @Column(name = \"id\", updatable = false, nullable = false)\n  private String id;\n\n}", "author": "dhanyak-btc", "createdAt": "2020-09-30T06:53:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk1MzIyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzczNTAyMA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1079#discussion_r497735020", "bodyText": "true, though I still don't understand what we gain from saving a null value for this user?", "author": "zohrehj", "createdAt": "2020-09-30T19:02:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk1MzIyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzczOTEwOA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1079#discussion_r497739108", "bodyText": "This is generally not a good practice.\nby turning the user_id to null, we are losing valuable information, e.g. if we later on decide to find user associated with an audit log we will not be able to because the user_id captured in the log no longer exists.\nIt also introduces potential future bug, since another user can now have this user_id, and if we have any assets that are still pointing to this user_id, we could accidentally expose the first user's information to the second one.", "author": "zohrehj", "createdAt": "2020-09-30T19:09:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk1MzIyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODM1OTk2Ng==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1079#discussion_r498359966", "bodyText": "Fixed review comment", "author": "madhurya-btc", "createdAt": "2020-10-01T16:07:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk1MzIyNg=="}], "type": "inlineReview", "revised_code": {"commit": "4e4685111a9965fb47cd47c1f71d6e4f7853e235", "chunk": "diff --git a/user-registration-server-ws/user-mgmt-module/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/dao/UserProfileManagementDaoImpl.java b/user-registration-server-ws/user-mgmt-module/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/dao/UserProfileManagementDaoImpl.java\nindex b8cb40e62..f67035b70 100644\n--- a/user-registration-server-ws/user-mgmt-module/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/dao/UserProfileManagementDaoImpl.java\n+++ b/user-registration-server-ws/user-mgmt-module/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/dao/UserProfileManagementDaoImpl.java\n\n@@ -334,8 +336,11 @@ public class UserProfileManagementDaoImpl implements UserProfileManagementDao {\n   public void deactivateUserAccount(String userId) {\n     Optional<UserDetailsEntity> optUserDetails = userDetailsRepository.findByUserId(userId);\n     UserDetailsEntity userDetailsEntity = optUserDetails.get();\n+    String alteredEmail =\n+        userDetailsEntity.getEmail() + \"_DEACTIVATED_\" + Instant.now().toEpochMilli();\n+    alteredEmail = alteredEmail.substring(0, CommonConstants.EMAIL_LENGTH);\n     userDetailsEntity.setStatus(UserStatus.DEACTIVATED.getValue());\n-    userDetailsEntity.setUserId(null);\n+    userDetailsEntity.setEmail(alteredEmail);\n     userDetailsRepository.saveAndFlush(userDetailsEntity);\n   }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk1NTE5MQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1079#discussion_r496955191", "bodyText": "looks like you can move userProfileManagementDao.deactivateUserAccount(userDetails.getUserId());  outside the try catch.\nplease add comment as to why you are ignoring exception in the auth server call.", "author": "zohrehj", "createdAt": "2020-09-29T18:36:01Z", "path": "user-registration-server-ws/user-mgmt-module/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/service/UserManagementProfileServiceImpl.java", "diffHunk": "@@ -223,89 +224,114 @@ public UserDetailsEntity saveParticipant(UserDetailsEntity participant) {\n     return userDetails;\n   }\n \n+  @Override\n+  public void processDeactivatePendingRequests() {\n+    // findUsers With Status DEACTIVATE_PENDING\n+    List<UserDetailsEntity> listOfUserDetails =\n+        (List<UserDetailsEntity>)\n+            CollectionUtils.emptyIfNull(\n+                userDetailsRepository.findByStatus(UserStatus.DEACTIVATE_PENDING.getValue()));\n+\n+    // call deactivateUserAccount() for each userID's\n+    listOfUserDetails.forEach(\n+        userDetails -> {\n+          try {\n+            userManagementUtil.deleteUserInfoInAuthServer(userDetails.getUserId());\n+            userProfileManagementDao.deactivateUserAccount(userDetails.getUserId());\n+          } catch (ErrorCodeException e) {\n+            if (e.getErrorCode() == ErrorCode.USER_NOT_FOUND) {\n+              userProfileManagementDao.deactivateUserAccount(userDetails.getUserId());", "originalCommit": "862c3a38b90be98487a2d9f3441497c7fc565fd0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzI3ODI1MQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1079#discussion_r497278251", "bodyText": "Please refer Step 3 and Step 4 in PR description. If Step 3 is success but Step 4 failed, then the user status will remain with DEACTIVATE_PENDING. This record will be picked by the scheduler task and tries to delete the user from oauth-scim server, this service returns USER_NOT_FOUND, so we need to catch the ErrorCodeException and call the userProfileManagementDao.deactivateUserAccount(userDetails.getUserId()); if the ErrorCode is USER_NOT_FOUND. We ignore other exceptions such 5XX series as this record will be picked up again by the scheduler task.", "author": "dhanyak-btc", "createdAt": "2020-09-30T06:49:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk1NTE5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzI3ODkwMA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1079#discussion_r497278900", "bodyText": "@madhurya-btc  please add another catch block for Exception  class and log the exception.", "author": "dhanyak-btc", "createdAt": "2020-09-30T06:50:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk1NTE5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzY4ODU2OQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1079#discussion_r497688569", "bodyText": "Fixed review comment", "author": "madhurya-btc", "createdAt": "2020-09-30T17:39:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk1NTE5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzczNzEzNg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1079#discussion_r497737136", "bodyText": "other errors are still getting ignored here, and there is a chance that a user will get stuck in this step forever and we never get notified.\nPlease add a log statement (warning) that includes the the exception message, but also mentions that this will be retried.", "author": "zohrehj", "createdAt": "2020-09-30T19:06:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk1NTE5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODM1OTg4OA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1079#discussion_r498359888", "bodyText": "Fixed review comment", "author": "madhurya-btc", "createdAt": "2020-10-01T16:07:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk1NTE5MQ=="}], "type": "inlineReview", "revised_code": {"commit": "c715d4266d0de7b04e9bda52333fd9fd366f4447", "chunk": "diff --git a/user-registration-server-ws/user-mgmt-module/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/service/UserManagementProfileServiceImpl.java b/user-registration-server-ws/user-mgmt-module/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/service/UserManagementProfileServiceImpl.java\nindex 21f328b12..1e5235d40 100644\n--- a/user-registration-server-ws/user-mgmt-module/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/service/UserManagementProfileServiceImpl.java\n+++ b/user-registration-server-ws/user-mgmt-module/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/service/UserManagementProfileServiceImpl.java\n\n@@ -242,6 +242,8 @@ public class UserManagementProfileServiceImpl implements UserManagementProfileSe\n             if (e.getErrorCode() == ErrorCode.USER_NOT_FOUND) {\n               userProfileManagementDao.deactivateUserAccount(userDetails.getUserId());\n             }\n+          } catch (Exception e) {\n+            logger.error(\"processDeactivatePendingRequests() failed with an exception\", e);\n           }\n         });\n   }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk2MTY2Mg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1079#discussion_r496961662", "bodyText": "might be a good idea to move these values into application.properties", "author": "zohrehj", "createdAt": "2020-09-29T18:47:19Z", "path": "user-registration-server-ws/user-mgmt-module/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/task/DeactivateAccountScheduledTask.java", "diffHunk": "@@ -0,0 +1,31 @@\n+package com.google.cloud.healthcare.fdamystudies.task;\n+\n+import com.google.cloud.healthcare.fdamystudies.service.UserManagementProfileService;\n+import org.slf4j.ext.XLogger;\n+import org.slf4j.ext.XLoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.scheduling.annotation.Scheduled;\n+import org.springframework.stereotype.Component;\n+\n+@Component\n+public class DeactivateAccountScheduledTask {\n+\n+  private static final int INITIAL_DELAY_MILLI_SEC = 10000;", "originalCommit": "862c3a38b90be98487a2d9f3441497c7fc565fd0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzY4NjQ4OQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1079#discussion_r497686489", "bodyText": "When i tried to change this to application.properties, i am getting compilation error as below\nThe value for annotation attribute Scheduled.fixedDelay must be a constant expression\nThe value for annotation attribute Scheduled.initialDelay must be a constant expression", "author": "madhurya-btc", "createdAt": "2020-09-30T17:35:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk2MTY2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzc0NTYxNA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1079#discussion_r497745614", "bodyText": "see https://stackoverflow.com/questions/45192373/how-to-assign-a-value-from-application-properties-to-a-static-variable", "author": "zohrehj", "createdAt": "2020-09-30T19:22:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk2MTY2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODM1OTcxNg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1079#discussion_r498359716", "bodyText": "see https://stackoverflow.com/questions/45192373/how-to-assign-a-value-from-application-properties-to-a-static-variable\n\nI tried with the above approach, but still i am getting same compilation error.", "author": "madhurya-btc", "createdAt": "2020-10-01T16:06:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk2MTY2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODM2MzQ4OQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1079#discussion_r498363489", "bodyText": "ok. let's leave it for now. Please file a bug to address this in future.", "author": "zohrehj", "createdAt": "2020-10-01T16:13:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk2MTY2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODM4MjMwNg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1079#discussion_r498382306", "bodyText": "Created issue #1104 and added TODO in DeactivateAccountScheduledTask", "author": "madhurya-btc", "createdAt": "2020-10-01T16:45:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk2MTY2Mg=="}], "type": "inlineReview", "revised_code": {"commit": "cc63a35f7aa3595fff73e8498b1d56b3e0570b10", "chunk": "diff --git a/user-registration-server-ws/user-mgmt-module/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/task/DeactivateAccountScheduledTask.java b/user-registration-server-ws/user-mgmt-module/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/task/DeactivateAccountScheduledTask.java\nindex b833c88d6..894e5fb9e 100644\n--- a/user-registration-server-ws/user-mgmt-module/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/task/DeactivateAccountScheduledTask.java\n+++ b/user-registration-server-ws/user-mgmt-module/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/task/DeactivateAccountScheduledTask.java\n\n@@ -10,6 +10,7 @@ import org.springframework.stereotype.Component;\n @Component\n public class DeactivateAccountScheduledTask {\n \n+  // TODO (#1104) move initial delay and fixed delay to application*.property\n   private static final int INITIAL_DELAY_MILLI_SEC = 10000;\n \n   private static final int FIXED_DELAY_MILLI_SEC = 1800000;\n"}}, {"oid": "c715d4266d0de7b04e9bda52333fd9fd366f4447", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/c715d4266d0de7b04e9bda52333fd9fd366f4447", "message": "Fixed review comments", "committedDate": "2020-09-30T17:36:50Z", "type": "commit"}, {"oid": "6daa5b37efb6cf640873c7b0742193e5f3848b9f", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/6daa5b37efb6cf640873c7b0742193e5f3848b9f", "message": "Merge branch 'develop' into user-management-deactive-api-endpoint", "committedDate": "2020-09-30T17:37:39Z", "type": "commit"}, {"oid": "aad9a2d597d312eeb06e7e9c753e900bcd109892", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/aad9a2d597d312eeb06e7e9c753e900bcd109892", "message": "Merge branch 'user-management-deactive-api-endpoint' of https://github.com/GoogleCloudPlatform/fda-mystudies into user-management-deactive-api-endpoint", "committedDate": "2020-09-30T17:38:37Z", "type": "commit"}, {"oid": "4e4685111a9965fb47cd47c1f71d6e4f7853e235", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/4e4685111a9965fb47cd47c1f71d6e4f7853e235", "message": "Fixed review comment", "committedDate": "2020-10-01T15:33:25Z", "type": "commit"}, {"oid": "4a3272b90556b613759dfe7025e55a9fe39bf8e6", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/4a3272b90556b613759dfe7025e55a9fe39bf8e6", "message": "Review comment fix", "committedDate": "2020-10-01T16:06:43Z", "type": "commit"}, {"oid": "f22b19c1aefe8ebb7c19ffb49c1c98bf9e9fcb58", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/f22b19c1aefe8ebb7c19ffb49c1c98bf9e9fcb58", "message": "Merge branch 'develop' into user-management-deactive-api-endpoint", "committedDate": "2020-10-01T16:07:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODM2NDQ1MA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1079#discussion_r498364450", "bodyText": "please add test to cover this functionality", "author": "zohrehj", "createdAt": "2020-10-01T16:14:41Z", "path": "user-registration-server-ws/user-mgmt-module/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/dao/UserProfileManagementDaoImpl.java", "diffHunk": "@@ -342,4 +331,18 @@ public AppEntity getAppPropertiesDetailsByAppId(String appId) {\n     }\n     return appPropertiesDetails;\n   }\n+\n+  @Override\n+  public void deactivateUserAccount(String userId) {\n+    Optional<UserDetailsEntity> optUserDetails = userDetailsRepository.findByUserId(userId);\n+    UserDetailsEntity userDetailsEntity = optUserDetails.get();\n+    String alteredEmail =\n+        userDetailsEntity.getEmail() + \"_DEACTIVATED_\" + Instant.now().toEpochMilli();\n+    if (alteredEmail.length() > CommonConstants.EMAIL_LENGTH) {\n+      alteredEmail = alteredEmail.substring(0, CommonConstants.EMAIL_LENGTH);\n+    }", "originalCommit": "f22b19c1aefe8ebb7c19ffb49c1c98bf9e9fcb58", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODM4MjYxNg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1079#discussion_r498382616", "bodyText": "Fixed review comment.", "author": "madhurya-btc", "createdAt": "2020-10-01T16:45:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODM2NDQ1MA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "cc63a35f7aa3595fff73e8498b1d56b3e0570b10", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/cc63a35f7aa3595fff73e8498b1d56b3e0570b10", "message": "Fixed review comment", "committedDate": "2020-10-01T16:44:04Z", "type": "commit"}, {"oid": "e8c7848cac439bb96bc1380b350a0753ba0967dd", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/e8c7848cac439bb96bc1380b350a0753ba0967dd", "message": "Merge branch 'user-management-deactive-api-endpoint' of https://github.com/GoogleCloudPlatform/fda-mystudies into user-management-deactive-api-endpoint", "committedDate": "2020-10-01T16:44:15Z", "type": "commit"}, {"oid": "07d383ce1ef52e529420803401d11cfe6fba20a6", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/07d383ce1ef52e529420803401d11cfe6fba20a6", "message": "Merge branch 'develop' into user-management-deactive-api-endpoint", "committedDate": "2020-10-01T16:45:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODM4NjUyOA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1079#discussion_r498386528", "bodyText": "can you assert that email has been updated and contains \"DEACTIVATED\" after account is deactivated?", "author": "zohrehj", "createdAt": "2020-10-01T16:52:49Z", "path": "user-registration-server-ws/user-mgmt-module/user-mgmt/src/test/java/com/google/cloud/healthcare/fdamystudies/controller/UserProfileControllerTest.java", "diffHunk": "@@ -205,20 +215,21 @@ public void deactivateAccountSuccess() throws Exception {\n \n     verifyTokenIntrospectRequest(1);\n \n-    UserDetailsEntity daoResp = service.loadUserDetailsByUserId(Constants.VALID_USER_ID);\n-    assertEquals(3, daoResp.getStatus());\n+    UserDetailsEntity daoResp = service.loadUserDetailsByUserId(Constants.USER_ID);\n+    assertNotNull(daoResp);\n+    assertTrue(daoResp.getEmail().length() == CommonConstants.EMAIL_LENGTH);", "originalCommit": "07d383ce1ef52e529420803401d11cfe6fba20a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODM5MTE0NA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1079#discussion_r498391144", "bodyText": "Fixed review comment", "author": "madhurya-btc", "createdAt": "2020-10-01T17:01:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODM4NjUyOA=="}], "type": "inlineReview", "revised_code": {"commit": "618444710d39d108665e4a8fbbc1a9e25233a560", "chunk": "diff --git a/user-registration-server-ws/user-mgmt-module/user-mgmt/src/test/java/com/google/cloud/healthcare/fdamystudies/controller/UserProfileControllerTest.java b/user-registration-server-ws/user-mgmt-module/user-mgmt/src/test/java/com/google/cloud/healthcare/fdamystudies/controller/UserProfileControllerTest.java\nindex 17e46a7e1..b5d5b6637 100644\n--- a/user-registration-server-ws/user-mgmt-module/user-mgmt/src/test/java/com/google/cloud/healthcare/fdamystudies/controller/UserProfileControllerTest.java\n+++ b/user-registration-server-ws/user-mgmt-module/user-mgmt/src/test/java/com/google/cloud/healthcare/fdamystudies/controller/UserProfileControllerTest.java\n\n@@ -218,6 +218,7 @@ public class UserProfileControllerTest extends BaseMockIT {\n     UserDetailsEntity daoResp = service.loadUserDetailsByUserId(Constants.USER_ID);\n     assertNotNull(daoResp);\n     assertTrue(daoResp.getEmail().length() == CommonConstants.EMAIL_LENGTH);\n+    assertTrue(daoResp.getEmail().contains(\"_DEACTIVATED_\"));\n \n     verify(1, deleteRequestedFor(urlEqualTo(\"/oauth-scim-service/users/\" + Constants.USER_ID)));\n     verify(\n"}}, {"oid": "618444710d39d108665e4a8fbbc1a9e25233a560", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/618444710d39d108665e4a8fbbc1a9e25233a560", "message": "Fixed review comment", "committedDate": "2020-10-01T17:00:08Z", "type": "commit"}, {"oid": "e6ddde39cd3836c4bcf189a4fda0205a99646bc3", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/e6ddde39cd3836c4bcf189a4fda0205a99646bc3", "message": "Merge branch 'user-management-deactive-api-endpoint' of https://github.com/GoogleCloudPlatform/fda-mystudies into user-management-deactive-api-endpoint", "committedDate": "2020-10-01T17:00:44Z", "type": "commit"}]}