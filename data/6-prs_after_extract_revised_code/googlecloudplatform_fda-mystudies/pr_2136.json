{"pr_number": 2136, "pr_title": "[participant-manager-datastore] : Fixed issue #2106", "pr_createdAt": "2020-11-24T13:14:23Z", "pr_url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2136", "timeline": [{"oid": "9b4ecd0600f04fbe45620450a358ea905192f75e", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/9b4ecd0600f04fbe45620450a358ea905192f75e", "message": "Fixed issue #2106\n\nFixed issue #2106", "committedDate": "2020-11-24T13:01:51Z", "type": "commit"}, {"oid": "3cb8283308cf2a0a7353503f1328a9110e87393f", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/3cb8283308cf2a0a7353503f1328a9110e87393f", "message": "added test case\n\nadded test case", "committedDate": "2020-11-24T13:12:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc3MDk2MQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2136#discussion_r529770961", "bodyText": "Shouldn't we have a test here for when excludeEnrollmentStatus includes notEligible and yetToEnroll and check for empty array being returned instead", "author": "saminguyen", "createdAt": "2020-11-24T17:56:58Z", "path": "participant-manager-datastore/participant-manager-service/src/test/java/com/google/cloud/healthcare/fdamystudies/controller/SiteControllerTest.java", "diffHunk": "@@ -710,6 +710,33 @@ public void shouldReturnSiteParticipantsForDisabled() throws Exception {\n     verifyTokenIntrospectRequest();\n   }\n \n+  @Test\n+  public void shouldNotReturnSiteParticipantsForNotEligible() throws Exception {\n+    siteEntity = testDataHelper.createSiteEntity(studyEntity, userRegAdminEntity, appEntity);\n+    participantRegistrySiteEntity =\n+        testDataHelper.createParticipantRegistrySite(siteEntity, studyEntity);\n+\n+    participantStudyEntity.setStatus(\"notEligible\");\n+    testDataHelper.getParticipantStudyRepository().saveAndFlush(participantStudyEntity);\n+    HttpHeaders headers = testDataHelper.newCommonHeaders();\n+    headers.add(USER_ID_HEADER, userRegAdminEntity.getId());\n+\n+    mockMvc\n+        .perform(\n+            get(ApiEndpoint.GET_SITE_PARTICIPANTS.getPath(), siteEntity.getId())\n+                .headers(headers)\n+                .contextPath(getContextPath()))\n+        .andDo(print())\n+        .andExpect(status().isOk())\n+        .andExpect(jsonPath(\"$.participantRegistryDetail.registryParticipants\").isArray())\n+        .andExpect(\n+            jsonPath(\n+                \"$.participantRegistryDetail.registryParticipants[0].enrollmentStatus\",\n+                is(CommonConstants.YET_TO_ENROLL)));", "originalCommit": "3cb8283308cf2a0a7353503f1328a9110e87393f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDUxMzA1Mg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2136#discussion_r530513052", "bodyText": "fixed PR comment", "author": "Kantharajut-btc", "createdAt": "2020-11-25T16:46:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc3MDk2MQ=="}], "type": "inlineReview", "revised_code": {"commit": "a84a3ec319583032e70f3ec72adfa71ba4bf1580", "chunk": "diff --git a/participant-manager-datastore/participant-manager-service/src/test/java/com/google/cloud/healthcare/fdamystudies/controller/SiteControllerTest.java b/participant-manager-datastore/participant-manager-service/src/test/java/com/google/cloud/healthcare/fdamystudies/controller/SiteControllerTest.java\nindex 739bae372..1e648dc31 100644\n--- a/participant-manager-datastore/participant-manager-service/src/test/java/com/google/cloud/healthcare/fdamystudies/controller/SiteControllerTest.java\n+++ b/participant-manager-datastore/participant-manager-service/src/test/java/com/google/cloud/healthcare/fdamystudies/controller/SiteControllerTest.java\n\n@@ -716,7 +716,8 @@ public class SiteControllerTest extends BaseMockIT {\n     participantRegistrySiteEntity =\n         testDataHelper.createParticipantRegistrySite(siteEntity, studyEntity);\n \n-    participantStudyEntity.setStatus(\"notEligible\");\n+    participantStudyEntity.setStatus(\"yetToJoin\");\n+    participantStudyEntity.setParticipantRegistrySite(participantRegistrySiteEntity);\n     testDataHelper.getParticipantStudyRepository().saveAndFlush(participantStudyEntity);\n     HttpHeaders headers = testDataHelper.newCommonHeaders();\n     headers.add(USER_ID_HEADER, userRegAdminEntity.getId());\n"}}, {"oid": "a84a3ec319583032e70f3ec72adfa71ba4bf1580", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/a84a3ec319583032e70f3ec72adfa71ba4bf1580", "message": "Fixed PR comment\n\nFixed PR comment", "committedDate": "2020-11-25T16:44:35Z", "type": "commit"}, {"oid": "49abdcc7c427955c2ecabc58342c8f7b89b8ced8", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/49abdcc7c427955c2ecabc58342c8f7b89b8ced8", "message": "Merge branch 'develop' into participant-manager-issue-2106", "committedDate": "2020-11-25T16:45:06Z", "type": "commit"}, {"oid": "e7195e723c0169e8cb84eabc6925f7339b0f9165", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/e7195e723c0169e8cb84eabc6925f7339b0f9165", "message": "Merge branch 'develop' into participant-manager-issue-2106", "committedDate": "2020-12-01T05:35:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzYwNTQ5OA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2136#discussion_r533605498", "bodyText": "verify array size to show clearly that the enrollment status got excluded", "author": "saminguyen", "createdAt": "2020-12-01T17:48:32Z", "path": "participant-manager-datastore/participant-manager-service/src/test/java/com/google/cloud/healthcare/fdamystudies/controller/SiteControllerTest.java", "diffHunk": "@@ -725,14 +726,11 @@ public void shouldNotReturnSiteParticipantsForNotEligible() throws Exception {\n         .perform(\n             get(ApiEndpoint.GET_SITE_PARTICIPANTS.getPath(), siteEntity.getId())\n                 .headers(headers)\n+                .queryParam(\"excludeEnrollmentStatus\", \"notEligible\", \"yetToJoin \")\n                 .contextPath(getContextPath()))\n         .andDo(print())\n         .andExpect(status().isOk())\n-        .andExpect(jsonPath(\"$.participantRegistryDetail.registryParticipants\").isArray())\n-        .andExpect(\n-            jsonPath(\n-                \"$.participantRegistryDetail.registryParticipants[0].enrollmentStatus\",\n-                is(CommonConstants.YET_TO_ENROLL)));\n+        .andExpect(jsonPath(\"$.participantRegistryDetail.registryParticipants\").isArray());", "originalCommit": "e7195e723c0169e8cb84eabc6925f7339b0f9165", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzkyNTk2MQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2136#discussion_r533925961", "bodyText": "added array size to check 0 registryParticipants", "author": "Kantharajut-btc", "createdAt": "2020-12-02T06:29:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzYwNTQ5OA=="}], "type": "inlineReview", "revised_code": {"commit": "07a8dc299400f3ddadeec61d3b83de763b198eff", "chunk": "diff --git a/participant-manager-datastore/participant-manager-service/src/test/java/com/google/cloud/healthcare/fdamystudies/controller/SiteControllerTest.java b/participant-manager-datastore/participant-manager-service/src/test/java/com/google/cloud/healthcare/fdamystudies/controller/SiteControllerTest.java\nindex 1e648dc31..f6f05480e 100644\n--- a/participant-manager-datastore/participant-manager-service/src/test/java/com/google/cloud/healthcare/fdamystudies/controller/SiteControllerTest.java\n+++ b/participant-manager-datastore/participant-manager-service/src/test/java/com/google/cloud/healthcare/fdamystudies/controller/SiteControllerTest.java\n\n@@ -726,12 +722,12 @@ public class SiteControllerTest extends BaseMockIT {\n         .perform(\n             get(ApiEndpoint.GET_SITE_PARTICIPANTS.getPath(), siteEntity.getId())\n                 .headers(headers)\n-                .queryParam(\"excludeEnrollmentStatus\", \"notEligible\", \"yetToJoin \")\n+                .queryParam(\"excludeEnrollmentStatus\", \"notEligible\", \"yetToJoin\")\n                 .contextPath(getContextPath()))\n         .andDo(print())\n         .andExpect(status().isOk())\n-        .andExpect(jsonPath(\"$.participantRegistryDetail.registryParticipants\").isArray());\n-\n+        .andExpect(jsonPath(\"$.participantRegistryDetail.registryParticipants\").isArray())\n+        .andExpect(jsonPath(\"$.participantRegistryDetail.registryParticipants\", hasSize(0)));\n     verifyTokenIntrospectRequest();\n   }\n \n"}}, {"oid": "07a8dc299400f3ddadeec61d3b83de763b198eff", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/07a8dc299400f3ddadeec61d3b83de763b198eff", "message": "Fixed PR comments\n\nFixed PR comments", "committedDate": "2020-12-02T06:27:21Z", "type": "commit"}, {"oid": "100a0430f00930e442eafa0b9bbf8d198340e7f6", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/100a0430f00930e442eafa0b9bbf8d198340e7f6", "message": "Merge branch 'develop' into participant-manager-issue-2106", "committedDate": "2020-12-02T06:29:56Z", "type": "commit"}, {"oid": "6f5aa13a31bf72eeff08ed690306e4846c32a29d", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/6f5aa13a31bf72eeff08ed690306e4846c32a29d", "message": "Merge branch 'develop' into participant-manager-issue-2106", "committedDate": "2020-12-03T09:41:46Z", "type": "commit"}]}