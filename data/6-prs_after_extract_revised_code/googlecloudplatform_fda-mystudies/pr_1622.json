{"pr_number": 1622, "pr_title": "Fixed SQL injection for the first 2000 lines of StudyDAOImpl.java", "pr_createdAt": "2020-10-23T06:58:46Z", "pr_url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1622", "timeline": [{"oid": "778b5189a555b5b0b1c80030725a7a7cee9e31dd", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/778b5189a555b5b0b1c80030725a7a7cee9e31dd", "message": "Fixed sql injection for the first 2000 lines of StudyDAOImpl.java\n\nFixed sql injection for the first 2000 lines of StudyDAOImpl.java", "committedDate": "2020-10-23T06:57:14Z", "type": "commit"}, {"oid": "0dcd65e210774bdc67bedb7e7094464b1cfd84b8", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/0dcd65e210774bdc67bedb7e7094464b1cfd84b8", "message": "code is aligned properly", "committedDate": "2020-10-23T08:20:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDg4MTQzNw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1622#discussion_r510881437", "bodyText": "You've used setInteger above for studyId, since we know studyId is an integer please use setInteger in other places as well.", "author": "zohrehj", "createdAt": "2020-10-23T13:25:13Z", "path": "study-builder/fdahpStudyDesigner/src/main/java/com/fdahpstudydesigner/dao/StudyDAOImpl.java", "diffHunk": "@@ -166,9 +173,9 @@ public int comprehensionTestQuestionOrder(Integer studyId) {\n       session = hibernateTemplate.getSessionFactory().openSession();\n       query =\n           session.createQuery(\n-              \"From ComprehensionTestQuestionBo CTQBO where CTQBO.studyId=\"\n-                  + studyId\n+              \"From ComprehensionTestQuestionBo CTQBO where CTQBO.studyId=:studyId\"\n                   + \" and CTQBO.active=1 order by CTQBO.sequenceNo desc\");\n+      query.setParameter(\"studyId\", studyId);", "originalCommit": "0dcd65e210774bdc67bedb7e7094464b1cfd84b8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzUyNjM2Mw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1622#discussion_r513526363", "bodyText": "fixed as suggested way", "author": "vigneshjbtc", "createdAt": "2020-10-28T15:13:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDg4MTQzNw=="}], "type": "inlineReview", "revised_code": {"commit": "a46ed699d24bc6fb193228c9fd0c614ea36a2668", "chunk": "diff --git a/study-builder/fdahpStudyDesigner/src/main/java/com/fdahpstudydesigner/dao/StudyDAOImpl.java b/study-builder/fdahpStudyDesigner/src/main/java/com/fdahpstudydesigner/dao/StudyDAOImpl.java\nindex a042bfedc..4e642b265 100644\n--- a/study-builder/fdahpStudyDesigner/src/main/java/com/fdahpstudydesigner/dao/StudyDAOImpl.java\n+++ b/study-builder/fdahpStudyDesigner/src/main/java/com/fdahpstudydesigner/dao/StudyDAOImpl.java\n\n@@ -175,7 +175,7 @@ public class StudyDAOImpl implements StudyDAO {\n           session.createQuery(\n               \"From ComprehensionTestQuestionBo CTQBO where CTQBO.studyId=:studyId\"\n                   + \" and CTQBO.active=1 order by CTQBO.sequenceNo desc\");\n-      query.setParameter(\"studyId\", studyId);\n+      query.setInteger(\"studyId\", studyId);\n       query.setMaxResults(1);\n       comprehensionTestQuestionBo = (ComprehensionTestQuestionBo) query.uniqueResult();\n       if (comprehensionTestQuestionBo != null) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDg4NTA3Nw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1622#discussion_r510885077", "bodyText": "please remove all commented out code", "author": "zohrehj", "createdAt": "2020-10-23T13:31:05Z", "path": "study-builder/fdahpStudyDesigner/src/main/java/com/fdahpstudydesigner/dao/StudyDAOImpl.java", "diffHunk": "@@ -638,163 +656,358 @@ public String deleteStudyByIdOrCustomstudyId(\n     logger.info(\"StudyDAOImpl - deleteStudyByIdOrCustomstudyId() - Starts\");\n     String message = FdahpStudyDesignerConstants.FAILURE;\n     List<StudyBo> studyBOList = null;\n-    String subQuery = \"\";\n+    // String subQuery = \"\";\n     String studyCustomQuery = \"\";\n     List<Integer> idList = null;\n+    List<String> studyIdList = new ArrayList<>();\n     try {\n+      studyIdList = this.getStudyIdAsList(studyId);\n+\n       if (StringUtils.isNotEmpty(customStudyId)) {\n-        studyCustomQuery = \" FROM StudyBo SBO WHERE SBO.customStudyId ='\" + customStudyId + \"'\";\n-        subQuery = \"(SELECT id FROM studies WHERE custom_study_id='\" + customStudyId + \"')\";\n+        studyCustomQuery = \" FROM StudyBo SBO WHERE SBO.customStudyId =:customStudyId\";\n+        // subQuery = \"(SELECT id FROM studies WHERE custom_study_id=:customStudyId)\";", "originalCommit": "0dcd65e210774bdc67bedb7e7094464b1cfd84b8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzUyNjEwOA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1622#discussion_r513526108", "bodyText": "fixed as suggested", "author": "vigneshjbtc", "createdAt": "2020-10-28T15:12:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDg4NTA3Nw=="}], "type": "inlineReview", "revised_code": {"commit": "a46ed699d24bc6fb193228c9fd0c614ea36a2668", "chunk": "diff --git a/study-builder/fdahpStudyDesigner/src/main/java/com/fdahpstudydesigner/dao/StudyDAOImpl.java b/study-builder/fdahpStudyDesigner/src/main/java/com/fdahpstudydesigner/dao/StudyDAOImpl.java\nindex a042bfedc..4e642b265 100644\n--- a/study-builder/fdahpStudyDesigner/src/main/java/com/fdahpstudydesigner/dao/StudyDAOImpl.java\n+++ b/study-builder/fdahpStudyDesigner/src/main/java/com/fdahpstudydesigner/dao/StudyDAOImpl.java\n\n@@ -665,10 +663,8 @@ public class StudyDAOImpl implements StudyDAO {\n \n       if (StringUtils.isNotEmpty(customStudyId)) {\n         studyCustomQuery = \" FROM StudyBo SBO WHERE SBO.customStudyId =:customStudyId\";\n-        // subQuery = \"(SELECT id FROM studies WHERE custom_study_id=:customStudyId)\";\n       } else {\n         studyCustomQuery = \" FROM StudyBo SBO WHERE SBO.id in(:studyIdList)\";\n-        // subQuery = \"(:studyIdList)\";\n       }\n       query = session.createQuery(studyCustomQuery);\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDg5OTA5Mw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1622#discussion_r510899093", "bodyText": "what exceptions are you expecting here? arryList.add shouldn't throw any.\nI would recommend removing both try/catch blocks in this method.", "author": "zohrehj", "createdAt": "2020-10-23T13:52:36Z", "path": "study-builder/fdahpStudyDesigner/src/main/java/com/fdahpstudydesigner/dao/StudyDAOImpl.java", "diffHunk": "@@ -6855,4 +7400,29 @@ public String updateDraftToEditedStatus(\n     logger.info(\"AuditLogDAOImpl - updateDraftToEditedStatus - Ends\");\n     return message;\n   }\n+\n+  public List<String> getStudyIdAsList(String statusId) {\n+    List<String> outputList = new ArrayList<>();\n+    try {\n+      if (!StringUtils.isEmpty(statusId)) {\n+        if (statusId.contains(\",\")) {\n+          String[] statusIdArray = statusId.split(\",\");\n+          for (int i = 0; i < statusIdArray.length; i++) {\n+            try {\n+              outputList.add(statusIdArray[i]);\n+            } catch (Exception e) {\n+              e.printStackTrace();\n+              logger.error(\"AuditLogDAOImpl - getStatusIdAsList -Loop - ERROR\", e);\n+            }", "originalCommit": "0dcd65e210774bdc67bedb7e7094464b1cfd84b8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzUyNjYxNQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1622#discussion_r513526615", "bodyText": "removed the try / catch block", "author": "vigneshjbtc", "createdAt": "2020-10-28T15:13:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDg5OTA5Mw=="}], "type": "inlineReview", "revised_code": {"commit": "a46ed699d24bc6fb193228c9fd0c614ea36a2668", "chunk": "diff --git a/study-builder/fdahpStudyDesigner/src/main/java/com/fdahpstudydesigner/dao/StudyDAOImpl.java b/study-builder/fdahpStudyDesigner/src/main/java/com/fdahpstudydesigner/dao/StudyDAOImpl.java\nindex a042bfedc..4e642b265 100644\n--- a/study-builder/fdahpStudyDesigner/src/main/java/com/fdahpstudydesigner/dao/StudyDAOImpl.java\n+++ b/study-builder/fdahpStudyDesigner/src/main/java/com/fdahpstudydesigner/dao/StudyDAOImpl.java\n\n@@ -7403,25 +7169,15 @@ public class StudyDAOImpl implements StudyDAO {\n \n   public List<String> getStudyIdAsList(String statusId) {\n     List<String> outputList = new ArrayList<>();\n-    try {\n-      if (!StringUtils.isEmpty(statusId)) {\n-        if (statusId.contains(\",\")) {\n-          String[] statusIdArray = statusId.split(\",\");\n-          for (int i = 0; i < statusIdArray.length; i++) {\n-            try {\n-              outputList.add(statusIdArray[i]);\n-            } catch (Exception e) {\n-              e.printStackTrace();\n-              logger.error(\"AuditLogDAOImpl - getStatusIdAsList -Loop - ERROR\", e);\n-            }\n-          }\n-        } else {\n-          outputList.add(statusId);\n+    if (!StringUtils.isEmpty(statusId)) {\n+      if (statusId.contains(\",\")) {\n+        String[] statusIdArray = statusId.split(\",\");\n+        for (int i = 0; i < statusIdArray.length; i++) {\n+          outputList.add(statusIdArray[i]);\n         }\n+      } else {\n+        outputList.add(statusId);\n       }\n-    } catch (Exception e) {\n-      e.printStackTrace();\n-      logger.error(\"AuditLogDAOImpl - getStatusIdAsList - ERROR\", e);\n     }\n     return outputList;\n   }\n"}}, {"oid": "a46ed699d24bc6fb193228c9fd0c614ea36a2668", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/a46ed699d24bc6fb193228c9fd0c614ea36a2668", "message": "All setParmeter has been changed to setXXX methods\n\nModified the SetParameter to setXXXX methods  and removed the commented lines.\nthen removed the  try/catch block from \"getStudyIdAsList\" method", "committedDate": "2020-10-28T15:04:38Z", "type": "commit"}, {"oid": "95a03c2b90c37cfd4d4437ae55ebb2277bdc4e6d", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/95a03c2b90c37cfd4d4437ae55ebb2277bdc4e6d", "message": "Merge branch 'develop' into SQL_Injection-_Issue_fix_StudyDAO_till_2000line", "committedDate": "2020-10-29T06:21:53Z", "type": "commit"}]}