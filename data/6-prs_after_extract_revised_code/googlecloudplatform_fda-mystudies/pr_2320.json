{"pr_number": 2320, "pr_title": "[PM, UM] Enrollment status changes", "pr_createdAt": "2020-12-10T11:47:21Z", "pr_url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2320", "timeline": [{"oid": "a5880e5670bae8f0f9c3cdedabbf9a046d3f4c55", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/a5880e5670bae8f0f9c3cdedabbf9a046d3f4c55", "message": "enrollment status changes\n\nenrollment status changes", "committedDate": "2020-12-10T07:27:24Z", "type": "commit"}, {"oid": "275b4325fb64a495284f3c5dc4eee3a0f975e28a", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/275b4325fb64a495284f3c5dc4eee3a0f975e28a", "message": "Enrolment status change\n\nEnrolment status change", "committedDate": "2020-12-10T07:47:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDI0Mzg4Mw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2320#discussion_r540243883", "bodyText": "why was this removed?", "author": "zohrehj", "createdAt": "2020-12-10T15:07:29Z", "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/common/EnrollmentStatus.java", "diffHunk": "@@ -1,28 +1,20 @@\n-/*\n- * Copyright 2020 Google LLC\n- *\n- * Use of this source code is governed by an MIT-style\n- * license that can be found in the LICENSE file or at\n- * https://opensource.org/licenses/MIT.\n- */\n-", "originalCommit": "275b4325fb64a495284f3c5dc4eee3a0f975e28a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDY3NTI2OA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2320#discussion_r540675268", "bodyText": "My mistake, reverted back copyright text", "author": "Kantharajut-btc", "createdAt": "2020-12-11T04:06:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDI0Mzg4Mw=="}], "type": "inlineReview", "revised_code": {"commit": "dcfad74cfad43cc6ab583f27de2bb9cfcc49506c", "chunk": "diff --git a/common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/common/EnrollmentStatus.java b/common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/common/EnrollmentStatus.java\nindex 159677f22..1d535f57e 100644\n--- a/common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/common/EnrollmentStatus.java\n+++ b/common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/common/EnrollmentStatus.java\n\n@@ -1,3 +1,10 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n package com.google.cloud.healthcare.fdamystudies.common;\n \n import lombok.Getter;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDI0NDgzMw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2320#discussion_r540244833", "bodyText": "is \"YetToEnroll\" status not needed here? how do you display participants that have tokens generated for them but have not yet joined then?", "author": "zohrehj", "createdAt": "2020-12-10T15:08:44Z", "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/common/ParticipantStudyStateStatus.java", "diffHunk": "@@ -14,8 +14,6 @@\n public enum ParticipantStudyStateStatus {\n   ENROLLED(\"Enrolled\"),\n   WITHDRAWN(\"Withdrawn\"),\n-  INPROGRESS(\"inProgress\"),\n-  YETTOJOIN(\"yetToJoin\"),", "originalCommit": "275b4325fb64a495284f3c5dc4eee3a0f975e28a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDY4NDE5Mg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2320#discussion_r540684192", "bodyText": "ParticipantStudyStateStatus enum is unused, hence removed", "author": "Kantharajut-btc", "createdAt": "2020-12-11T04:34:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDI0NDgzMw=="}], "type": "inlineReview", "revised_code": {"commit": "dcfad74cfad43cc6ab583f27de2bb9cfcc49506c", "chunk": "diff --git a/common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/common/ParticipantStudyStateStatus.java b/common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/common/ParticipantStudyStateStatus.java\ndeleted file mode 100644\nindex ef46f0fb1..000000000\n--- a/common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/common/ParticipantStudyStateStatus.java\n+++ /dev/null\n\n@@ -1,28 +0,0 @@\n-/*\n- * Copyright 2020 Google LLC\n- *\n- * Use of this source code is governed by an MIT-style\n- * license that can be found in the LICENSE file or at\n- * https://opensource.org/licenses/MIT.\n- */\n-\n-package com.google.cloud.healthcare.fdamystudies.common;\n-\n-import lombok.Getter;\n-\n-@Getter\n-public enum ParticipantStudyStateStatus {\n-  ENROLLED(\"Enrolled\"),\n-  WITHDRAWN(\"Withdrawn\"),\n-  NOTELIGIBLE(\"notEligible\");\n-\n-  private final String value;\n-\n-  private ParticipantStudyStateStatus(String value) {\n-    this.value = value;\n-  }\n-\n-  public String getValue() {\n-    return value;\n-  }\n-}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDI1MzQzMg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2320#discussion_r540253432", "bodyText": "there is a change in logic here that is not explained:\n\n\nwhy is  enrollmentStatus set to EnrollmentStatus.YET_TO_ENROLL.getDisplayValue()? is it supposed to be a status or a display value? I am guessing those two are not the same thing.\nfor other cases you are directly setting this to studyParticipantDetail.getEnrolledStatus(), why is yet_to_enroll` case treated differentky?\n\n\nyou are not setting enrollmentDate to null when participant is in yet to enroll status anymore. why is this changed?", "author": "zohrehj", "createdAt": "2020-12-10T15:19:00Z", "path": "participant-manager-datastore/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/mapper/ParticipantMapper.java", "diffHunk": "@@ -60,21 +60,16 @@ public static ParticipantDetail fromParticipantStudy(\n     participantDetail.setInvitedDate(StringUtils.defaultIfEmpty(invitedDate, NOT_APPLICABLE));\n \n     if (studyParticipantDetail.getEnrolledStatus() != null) {\n-      if (studyParticipantDetail.getEnrolledStatus().equals(CommonConstants.YET_TO_ENROLL)) {\n-        participantDetail.setEnrollmentStatus(studyParticipantDetail.getEnrolledStatus());\n-        participantDetail.setEnrollmentDate(null);\n-      } else {\n-        String enrollmentStatus =\n-            EnrollmentStatus.IN_PROGRESS\n-                    .getStatus()\n-                    .equalsIgnoreCase(studyParticipantDetail.getEnrolledStatus())\n-                ? EnrollmentStatus.ENROLLED.getStatus()\n-                : studyParticipantDetail.getEnrolledStatus();\n-        participantDetail.setEnrollmentStatus(enrollmentStatus);\n-        String enrollmentDate = DateTimeUtils.format(studyParticipantDetail.getEnrolledDate());\n-        participantDetail.setEnrollmentDate(\n-            StringUtils.defaultIfEmpty(enrollmentDate, NOT_APPLICABLE));\n-      }\n+      String enrollmentStatus =", "originalCommit": "275b4325fb64a495284f3c5dc4eee3a0f975e28a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDY4MzA1MA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2320#discussion_r540683050", "bodyText": "Yet to enroll \u2013 currently this value is being directly displayed in PM web app Front End  based on Onboarding status. Now this value will be read from database directly, similar to other statuses. now while adding the participant to site will add the record in participant_study_info as well with enrollemnt status as  Yet to enroll  and enrollment date as null (please refer PR #2346)\nIf the participant is Yet to enroll then Enrolled date will be null in DB, hence showing NA for enrolled date for site participants and study participants to maintain consistency\nModified EnrollmentStatus enum to get the display value based on status", "author": "Kantharajut-btc", "createdAt": "2020-12-11T04:31:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDI1MzQzMg=="}], "type": "inlineReview", "revised_code": {"commit": "fccad75ef215d1955ed2d0758361ef3427074273", "chunk": "diff --git a/participant-manager-datastore/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/mapper/ParticipantMapper.java b/participant-manager-datastore/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/mapper/ParticipantMapper.java\nindex 42617bb46..0b73f81cf 100644\n--- a/participant-manager-datastore/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/mapper/ParticipantMapper.java\n+++ b/participant-manager-datastore/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/mapper/ParticipantMapper.java\n\n@@ -60,17 +60,11 @@ public final class ParticipantMapper {\n     participantDetail.setInvitedDate(StringUtils.defaultIfEmpty(invitedDate, NOT_APPLICABLE));\n \n     if (studyParticipantDetail.getEnrolledStatus() != null) {\n-      String enrollmentStatus =\n-          EnrollmentStatus.YET_TO_ENROLL\n-                  .getStatus()\n-                  .equalsIgnoreCase(studyParticipantDetail.getEnrolledStatus())\n-              ? EnrollmentStatus.YET_TO_ENROLL.getDisplayValue()\n-              : studyParticipantDetail.getEnrolledStatus();\n-      participantDetail.setEnrollmentStatus(enrollmentStatus);\n+      participantDetail.setEnrollmentStatus(\n+          EnrollmentStatus.getDisplayValue(studyParticipantDetail.getEnrolledStatus()));\n       String enrollmentDate = DateTimeUtils.format(studyParticipantDetail.getEnrolledDate());\n       participantDetail.setEnrollmentDate(\n           StringUtils.defaultIfEmpty(enrollmentDate, NOT_APPLICABLE));\n-\n     } else {\n       participantDetail.setEnrollmentStatus(YET_TO_ENROLL);\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDI1NjQ4NQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2320#discussion_r540256485", "bodyText": "same as above, change in logic is not explained. e.g. enrollmentDate is now being set to NOT_APPLICABLE instead of null for other cases. Setting a date to enum seems wrong and unintuitive; is there any tests to test these scenarios and make sure the app works as expected?", "author": "zohrehj", "createdAt": "2020-12-10T15:22:37Z", "path": "participant-manager-datastore/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/mapper/ParticipantMapper.java", "diffHunk": "@@ -149,18 +144,13 @@ public static ParticipantDetail toParticipantDetails(\n \n     ParticipantStudyEntity participantStudy = idMap.get(participantRegistrySite.getId());\n     if (participantStudy != null) {\n-      if (CommonConstants.YET_TO_ENROLL.equals(participantStudy.getStatus())) {\n-        participant.setEnrollmentStatus(participantStudy.getStatus());\n-        participant.setEnrollmentDate(null);\n-      } else {\n-        String enrollmentStatus =\n-            EnrollmentStatus.IN_PROGRESS.getStatus().equalsIgnoreCase(participantStudy.getStatus())\n-                ? EnrollmentStatus.ENROLLED.getStatus()\n-                : participantStudy.getStatus();\n-        participant.setEnrollmentStatus(enrollmentStatus);\n-        String enrollmentDate = DateTimeUtils.format(participantStudy.getEnrolledDate());\n-        participant.setEnrollmentDate(StringUtils.defaultIfEmpty(enrollmentDate, NOT_APPLICABLE));\n-      }\n+      String enrollmentStatus =\n+          EnrollmentStatus.YET_TO_ENROLL.getStatus().equalsIgnoreCase(participantStudy.getStatus())\n+              ? EnrollmentStatus.YET_TO_ENROLL.getDisplayValue()\n+              : participantStudy.getStatus();\n+      participant.setEnrollmentStatus(enrollmentStatus);\n+      String enrollmentDate = DateTimeUtils.format(participantStudy.getEnrolledDate());\n+      participant.setEnrollmentDate(StringUtils.defaultIfEmpty(enrollmentDate, NOT_APPLICABLE));", "originalCommit": "275b4325fb64a495284f3c5dc4eee3a0f975e28a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDkwMzI4Ng==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2320#discussion_r540903286", "bodyText": "If the participant is Yet to enroll then Enrolled date will be null in DB, hence showing NA for enrolled date for site participants and study participants to maintain consistency, modified existing tests for new status changes", "author": "Kantharajut-btc", "createdAt": "2020-12-11T12:10:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDI1NjQ4NQ=="}], "type": "inlineReview", "revised_code": {"commit": "fccad75ef215d1955ed2d0758361ef3427074273", "chunk": "diff --git a/participant-manager-datastore/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/mapper/ParticipantMapper.java b/participant-manager-datastore/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/mapper/ParticipantMapper.java\nindex 42617bb46..0b73f81cf 100644\n--- a/participant-manager-datastore/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/mapper/ParticipantMapper.java\n+++ b/participant-manager-datastore/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/mapper/ParticipantMapper.java\n\n@@ -144,11 +138,8 @@ public final class ParticipantMapper {\n \n     ParticipantStudyEntity participantStudy = idMap.get(participantRegistrySite.getId());\n     if (participantStudy != null) {\n-      String enrollmentStatus =\n-          EnrollmentStatus.YET_TO_ENROLL.getStatus().equalsIgnoreCase(participantStudy.getStatus())\n-              ? EnrollmentStatus.YET_TO_ENROLL.getDisplayValue()\n-              : participantStudy.getStatus();\n-      participant.setEnrollmentStatus(enrollmentStatus);\n+      participant.setEnrollmentStatus(\n+          EnrollmentStatus.getDisplayValue(participantStudy.getStatus()));\n       String enrollmentDate = DateTimeUtils.format(participantStudy.getEnrolledDate());\n       participant.setEnrollmentDate(StringUtils.defaultIfEmpty(enrollmentDate, NOT_APPLICABLE));\n     } else {\n"}}, {"oid": "dcfad74cfad43cc6ab583f27de2bb9cfcc49506c", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/dcfad74cfad43cc6ab583f27de2bb9cfcc49506c", "message": "Fixed PR comments\n\nFixed PR comments", "committedDate": "2020-12-10T15:43:57Z", "type": "commit"}, {"oid": "fccad75ef215d1955ed2d0758361ef3427074273", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/fccad75ef215d1955ed2d0758361ef3427074273", "message": "Fixed PR commments\n\nFixed PR commments", "committedDate": "2020-12-11T12:02:19Z", "type": "commit"}, {"oid": "e9e471a26d34ce43f672218426bf6ab1c914875d", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/e9e471a26d34ce43f672218426bf6ab1c914875d", "message": "enrollment status changes for withdrawn and enrolled\n\nenrollment status changes for withdrawn and enrolled", "committedDate": "2020-12-11T14:24:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDk4MzkwMQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2320#discussion_r540983901", "bodyText": "[user-mgmt Checks] reported by reviewdog \ud83d\udc36\nLine is longer than 100 characters (found 166).", "author": "github-actions", "createdAt": "2020-12-11T14:25:52Z", "path": "participant-datastore/user-mgmt-module/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/dao/CommonDaoImpl.java", "diffHunk": "@@ -223,7 +223,7 @@ public String getUserInfoDetails(String userId) {\n           session\n               .createSQLQuery(\n                   \"SELECT sp.study_info_id, GROUP_CONCAT(a.device_token) as device_token,GROUP_CONCAT(a.device_type) as device_type FROM participant_study_info sp, auth_info a\"\n-                      + \" where sp.user_details_id = a.user_details_id and sp.status not in('yetToJoin','withdrawn','notEligible') and a.remote_notification_flag=1\"\n+                      + \" where sp.user_details_id = a.user_details_id and sp.status not in('yetToEnroll','withdrawn','notEligible') and a.remote_notification_flag=1\"", "originalCommit": "e9e471a26d34ce43f672218426bf6ab1c914875d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "bb3a36c7016f9ed7a04dbd5f1eeff89b1e5bf152", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/bb3a36c7016f9ed7a04dbd5f1eeff89b1e5bf152", "message": "Merge branch 'develop' into participant-manager-enrollment-status-changes", "committedDate": "2020-12-14T07:04:18Z", "type": "commit"}, {"oid": "eafb81422cf0b8ba43ca70a052a7fd036c49bf52", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/eafb81422cf0b8ba43ca70a052a7fd036c49bf52", "message": "Merge branch 'develop' into participant-manager-enrollment-status-changes", "committedDate": "2020-12-14T07:18:09Z", "type": "commit"}, {"oid": "69934dd5fe9c158b6daace6aa930950034d57ff9", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/69934dd5fe9c158b6daace6aa930950034d57ff9", "message": "Merge branch 'develop' into participant-manager-enrollment-status-changes", "committedDate": "2020-12-14T07:59:08Z", "type": "commit"}, {"oid": "e59a80fbc86fddfb84a4d9a385ec5e33bf9a8bb7", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/e59a80fbc86fddfb84a4d9a385ec5e33bf9a8bb7", "message": "resolved merge conflict\n\nresolved merge conflict", "committedDate": "2020-12-14T08:04:54Z", "type": "commit"}, {"oid": "5e02c3147928ae3a42f7e53b68a265d640612a9f", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/5e02c3147928ae3a42f7e53b68a265d640612a9f", "message": "fixed build issue", "committedDate": "2020-12-14T08:11:33Z", "type": "commit"}, {"oid": "e75ac3d20f6f18097d75f9b03da5f0cd5093645f", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/e75ac3d20f6f18097d75f9b03da5f0cd5093645f", "message": "Merge branch 'develop' into participant-manager-enrollment-status-changes", "committedDate": "2020-12-14T14:47:35Z", "type": "commit"}]}