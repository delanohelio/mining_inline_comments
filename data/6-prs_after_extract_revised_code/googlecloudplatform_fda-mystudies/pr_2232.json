{"pr_number": 2232, "pr_title": "Participant Manager Datastore: GET /apps endpoint pagination", "pr_createdAt": "2020-12-03T06:17:29Z", "pr_url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2232", "timeline": [{"oid": "76253c61f0ac5e11347ba3764c65616c9586ca0c", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/76253c61f0ac5e11347ba3764c65616c9586ca0c", "message": "Apps Pagination\n\nApps Pagination", "committedDate": "2020-12-03T06:15:20Z", "type": "commit"}, {"oid": "e7b920e8fd3075d2eb2d28eedaa3265efc16389f", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/e7b920e8fd3075d2eb2d28eedaa3265efc16389f", "message": "Merge branch 'develop' into apps-pagination", "committedDate": "2020-12-03T06:19:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQwNjkxNw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2232#discussion_r535406917", "bodyText": "Have one test with offset being a non-zero value", "author": "saminguyen", "createdAt": "2020-12-03T16:52:58Z", "path": "participant-manager-datastore/participant-manager-service/src/test/java/com/google/cloud/healthcare/fdamystudies/controller/AppControllerTest.java", "diffHunk": "@@ -171,6 +173,88 @@ public void shouldReturnReturnAppsWithEnrolledCount() throws Exception {\n     verifyTokenIntrospectRequest();\n   }\n \n+  @Test\n+  public void shouldReturnAppsWithPagination() throws Exception {\n+    userRegAdminEntity.setSuperAdmin(false);\n+    testDataHelper.getUserRegAdminRepository().save(userRegAdminEntity);\n+\n+    for (int i = 1; i <= 20; i++) {\n+      appEntity = testDataHelper.newAppEntity();\n+      appEntity.setAppId(\"AppCustomId\" + String.valueOf(i));\n+      testDataHelper.getAppRepository().saveAndFlush(appEntity);\n+      studyEntity = testDataHelper.newStudyEntity();\n+      testDataHelper.getStudyRepository().saveAndFlush(studyEntity);\n+      SitePermissionEntity sitePermissionEntity = new SitePermissionEntity();\n+      sitePermissionEntity.setUrAdminUser(userRegAdminEntity);\n+      sitePermissionEntity.setCanEdit(Permission.EDIT);\n+      sitePermissionEntity.setApp(appEntity);\n+      sitePermissionEntity.setStudy(studyEntity);\n+      sitePermissionEntity.setSite(siteEntity);\n+      testDataHelper.getSitePermissionRepository().saveAndFlush(sitePermissionEntity);\n+      // Pagination records should be in descending order of created timestamp\n+      // Entities are not saved in sequential order so adding delay\n+      Thread.sleep(500);\n+    }\n+\n+    HttpHeaders headers = testDataHelper.newCommonHeaders();\n+    headers.add(USER_ID_HEADER, userRegAdminEntity.getId());\n+\n+    mockMvc\n+        .perform(\n+            get(ApiEndpoint.GET_APPS.getPath())\n+                .param(\"limit\", \"5\")\n+                .param(\"offset\", \"0\")\n+                .headers(headers)\n+                .contextPath(getContextPath()))\n+        .andDo(print())\n+        .andExpect(status().isOk())\n+        .andExpect(jsonPath(\"$.apps\").isArray())\n+        .andExpect(jsonPath(\"$.apps\", hasSize(5)))\n+        .andExpect(jsonPath(\"$.apps[0].customId\").value(\"AppCustomId20\"))\n+        .andExpect(jsonPath(\"$.apps[4].customId\").value(\"AppCustomId16\"));\n+\n+    verifyTokenIntrospectRequest();\n+  }\n+\n+  @Test\n+  public void shouldReturnAppsWithPaginationForSuperAdmin() throws Exception {\n+    userRegAdminEntity.setSuperAdmin(true);\n+    testDataHelper.getUserRegAdminRepository().save(userRegAdminEntity);\n+\n+    for (int i = 1; i <= 20; i++) {\n+      appEntity = testDataHelper.newAppEntity();\n+      appEntity.setAppId(\"AppCustomId\" + String.valueOf(i));\n+      testDataHelper.getAppRepository().saveAndFlush(appEntity);\n+      studyEntity = testDataHelper.newStudyEntity();\n+      testDataHelper.getStudyRepository().saveAndFlush(studyEntity);\n+      siteEntity = testDataHelper.newSiteEntity();\n+      siteEntity.setStudy(studyEntity);\n+      testDataHelper.getSiteRepository().saveAndFlush(siteEntity);\n+      // Pagination records should be in descending order of created timestamp\n+      // Entities are not saved in sequential order so adding delay\n+      Thread.sleep(500);\n+    }\n+\n+    HttpHeaders headers = testDataHelper.newCommonHeaders();\n+    headers.add(USER_ID_HEADER, userRegAdminEntity.getId());\n+\n+    mockMvc\n+        .perform(\n+            get(ApiEndpoint.GET_APPS.getPath())\n+                .param(\"limit\", \"20\")\n+                .param(\"offset\", \"0\")", "originalCommit": "e7b920e8fd3075d2eb2d28eedaa3265efc16389f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTkyMTcxOA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2232#discussion_r535921718", "bodyText": "Fixed review comment.", "author": "monica-BTC", "createdAt": "2020-12-04T08:31:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQwNjkxNw=="}], "type": "inlineReview", "revised_code": {"commit": "d7ce48c5373ab272af51c78b67aed3244566f169", "chunk": "diff --git a/participant-manager-datastore/participant-manager-service/src/test/java/com/google/cloud/healthcare/fdamystudies/controller/AppControllerTest.java b/participant-manager-datastore/participant-manager-service/src/test/java/com/google/cloud/healthcare/fdamystudies/controller/AppControllerTest.java\nindex 50256671c..dd5eee481 100644\n--- a/participant-manager-datastore/participant-manager-service/src/test/java/com/google/cloud/healthcare/fdamystudies/controller/AppControllerTest.java\n+++ b/participant-manager-datastore/participant-manager-service/src/test/java/com/google/cloud/healthcare/fdamystudies/controller/AppControllerTest.java\n\n@@ -252,7 +252,24 @@ public class AppControllerTest extends BaseMockIT {\n         .andExpect(jsonPath(\"$.apps[0].customId\").value(\"AppCustomId20\"))\n         .andExpect(jsonPath(\"$.apps[19].customId\").value(\"AppCustomId1\"));\n \n-    verifyTokenIntrospectRequest();\n+    verifyTokenIntrospectRequest(1);\n+\n+    // offset with non-zero value\n+    mockMvc\n+        .perform(\n+            get(ApiEndpoint.GET_APPS.getPath())\n+                .param(\"limit\", \"10\")\n+                .param(\"offset\", \"5\")\n+                .headers(headers)\n+                .contextPath(getContextPath()))\n+        .andDo(print())\n+        .andExpect(status().isOk())\n+        .andExpect(jsonPath(\"$.apps\").isArray())\n+        .andExpect(jsonPath(\"$.apps\", hasSize(10)))\n+        .andExpect(jsonPath(\"$.apps[0].customId\").value(\"AppCustomId15\"))\n+        .andExpect(jsonPath(\"$.apps[9].customId\").value(\"AppCustomId6\"));\n+\n+    verifyTokenIntrospectRequest(2);\n   }\n \n   @Test\n"}}, {"oid": "d7ce48c5373ab272af51c78b67aed3244566f169", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/d7ce48c5373ab272af51c78b67aed3244566f169", "message": "Fixed Review Comment\n\nFixed Review Comment", "committedDate": "2020-12-04T08:24:54Z", "type": "commit"}, {"oid": "8785726c1bc6207b7a8e79e772d8e5e40c860409", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/8785726c1bc6207b7a8e79e772d8e5e40c860409", "message": "Merge branch 'develop' into apps-pagination", "committedDate": "2020-12-07T13:17:46Z", "type": "commit"}, {"oid": "e5ef0d888f1a6a563dd06811ad021ede0a0be20b", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/e5ef0d888f1a6a563dd06811ad021ede0a0be20b", "message": "search term implementation\n\nsearch term implementation", "committedDate": "2020-12-07T14:52:04Z", "type": "commit"}, {"oid": "46a122eb91360804b8ec91b2ca38c345950a77a3", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/46a122eb91360804b8ec91b2ca38c345950a77a3", "message": "Merge branch 'develop' into apps-pagination", "committedDate": "2020-12-11T10:04:12Z", "type": "commit"}]}