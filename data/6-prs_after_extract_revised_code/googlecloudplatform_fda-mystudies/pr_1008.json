{"pr_number": 1008, "pr_title": "Issue number 1003 fixes for OAuth service Indexing", "pr_createdAt": "2020-09-22T13:43:08Z", "pr_url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1008", "timeline": [{"oid": "d0b68f749c78d01314a8f7fee84de2380287b985", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/d0b68f749c78d01314a8f7fee84de2380287b985", "message": "indexes are added for user entity class", "committedDate": "2020-09-22T10:15:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjc5NzY3MQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1008#discussion_r492797671", "bodyText": "Primary key and foreign keys should have indexes generated by default.\nAlso we use used a pattern for index names, I believe it was:\n<table name>_<index column names>_idx", "author": "zohrehj", "createdAt": "2020-09-22T14:49:35Z", "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/model/UserEntity.java", "diffHunk": "@@ -27,7 +28,14 @@\n @Setter\n @Getter\n @Entity\n-@Table(name = \"users\")\n+@Table(\n+    name = \"users\",\n+    indexes = {\n+      @Index(name = \"id_index\", columnList = \"id\", unique = true),\n+      @Index(name = \"user_id_index\", columnList = \"user_id\", unique = true),", "originalCommit": "d0b68f749c78d01314a8f7fee84de2380287b985", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzI2NjMyNw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1008#discussion_r493266327", "bodyText": "Requested changes fixed.", "author": "chiranjibi009", "createdAt": "2020-09-23T07:43:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjc5NzY3MQ=="}], "type": "inlineReview", "revised_code": {"commit": "09a36bf60063cd698f12cf26b392188b01bafa6b", "chunk": "diff --git a/oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/model/UserEntity.java b/oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/model/UserEntity.java\nindex 482fa6b4c..c9a64c044 100644\n--- a/oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/model/UserEntity.java\n+++ b/oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/model/UserEntity.java\n\n@@ -31,10 +31,9 @@ import org.hibernate.annotations.GenericGenerator;\n @Table(\n     name = \"users\",\n     indexes = {\n-      @Index(name = \"id_index\", columnList = \"id\", unique = true),\n-      @Index(name = \"user_id_index\", columnList = \"user_id\", unique = true),\n-      @Index(name = \"temp_reg_id_index\", columnList = \"temp_reg_id\", unique = true),\n-      @Index(name = \"app_id_email_index\", columnList = \"app_id,email\")\n+      @Index(name = \"users_user_id_idx\", columnList = \"user_id\", unique = true),\n+      @Index(name = \"users_temp_reg_id_idx\", columnList = \"temp_reg_id\", unique = true),\n+      @Index(name = \"users_app_id_email_idx\", columnList = \"app_id,email\")\n     })\n public class UserEntity {\n \n"}}, {"oid": "df644b5657ea26b24c29e1aeb900d63a2c16abc9", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/df644b5657ea26b24c29e1aeb900d63a2c16abc9", "message": "Merge branch 'develop' into issue-1003-fixes", "committedDate": "2020-09-23T05:57:45Z", "type": "commit"}, {"oid": "09a36bf60063cd698f12cf26b392188b01bafa6b", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/09a36bf60063cd698f12cf26b392188b01bafa6b", "message": "comment fixed", "committedDate": "2020-09-23T07:38:00Z", "type": "commit"}, {"oid": "77ce4200fdac66bdd5a691274275c2733f8952e0", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/77ce4200fdac66bdd5a691274275c2733f8952e0", "message": "Merge branch 'develop' into issue-1003-fixes", "committedDate": "2020-09-23T07:40:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg3MjY4NQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1008#discussion_r493872685", "bodyText": "I am seeing this value change all the time between PRs, without any code change.\nPlease explain why it is being changed yet again?", "author": "zohrehj", "createdAt": "2020-09-23T20:23:34Z", "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/model/UserEntity.java", "diffHunk": "@@ -49,7 +56,7 @@\n   private Timestamp created;\n \n   @ToString.Exclude\n-  @Column(name = \"tempRegId\", nullable = true, length = 64)\n+  @Column(name = \"temp_reg_id\", nullable = true, length = 64)", "originalCommit": "77ce4200fdac66bdd5a691274275c2733f8952e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDI4NTAyMg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1008#discussion_r494285022", "bodyText": "Initially, temp_reg_id was used in query params for auto sign-in after registration but later changed to camelCase format, angular developer also used tempRegId in their code.\nWe are not following camelCase format on Entity column names. I also noticed JPA DDL converts tempRegId into temp_reg_id hence asked the developer to change the name to temp_reg_id.", "author": "dhanyak-btc", "createdAt": "2020-09-24T12:42:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg3MjY4NQ=="}], "type": "inlineReview", "revised_code": {"commit": "c60ce4b180871be21e9f819c59e9a2f68b3d6f24", "chunk": "diff --git a/oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/model/UserEntity.java b/oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/model/UserEntity.java\nindex c9a64c044..4ffe9168a 100644\n--- a/oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/model/UserEntity.java\n+++ b/oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/model/UserEntity.java\n\n@@ -56,7 +52,7 @@ public class UserEntity {\n   private Timestamp created;\n \n   @ToString.Exclude\n-  @Column(name = \"temp_reg_id\", nullable = true, length = 64)\n+  @Column(name = \"temp_reg_id\", nullable = true, length = 64, unique = true)\n   private String tempRegId;\n \n   @ToString.Exclude\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg3NTk2Ng==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1008#discussion_r493875966", "bodyText": "I was under the impression that hibernate would create indexes for columns with@unique  automatically.\nI am not seeing a unique=true annotation on wither user_id or temp_reg_id however.\nPlease add those annotation first, dump the automatically generated schema, and only add indexes manually if hibernate does not create them automatically.\nAlso it might be a good idea to export db schema after each db change and include it in the PR so that we can verify indexes are correctly generated.", "author": "zohrehj", "createdAt": "2020-09-23T20:30:01Z", "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/model/UserEntity.java", "diffHunk": "@@ -27,7 +28,13 @@\n @Setter\n @Getter\n @Entity\n-@Table(name = \"users\")\n+@Table(\n+    name = \"users\",\n+    indexes = {\n+      @Index(name = \"users_user_id_idx\", columnList = \"user_id\", unique = true),\n+      @Index(name = \"users_temp_reg_id_idx\", columnList = \"temp_reg_id\", unique = true),", "originalCommit": "77ce4200fdac66bdd5a691274275c2733f8952e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDgxNzU0Ng==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1008#discussion_r494817546", "bodyText": "Fixed review comment. Added unique=true to user_id and temp_reg_id; removed @Index for temp_reg_id and user_id \nCREATE TABLE `users` (\n  `id` varchar(255) NOT NULL,\n  `app_id` varchar(100) NOT NULL,\n  `created` timestamp NULL DEFAULT CURRENT_TIMESTAMP,\n  `email` varchar(320) NOT NULL,\n  `status` int(11) NOT NULL,\n  `temp_reg_id` varchar(64) DEFAULT NULL,\n  `user_id` varchar(64) DEFAULT NULL,\n  `user_info` json NOT NULL,\n  PRIMARY KEY (`id`),\n  UNIQUE KEY `UK_onuvh020q8e92n6pgygqxjgro` (`temp_reg_id`),\n  UNIQUE KEY `UK_6efs5vmce86ymf5q7lmvn2uuf` (`user_id`),\n  KEY `users_app_id_email_idx` (`app_id`,`email`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;", "author": "dhanyak-btc", "createdAt": "2020-09-25T08:03:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg3NTk2Ng=="}], "type": "inlineReview", "revised_code": {"commit": "c60ce4b180871be21e9f819c59e9a2f68b3d6f24", "chunk": "diff --git a/oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/model/UserEntity.java b/oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/model/UserEntity.java\nindex c9a64c044..4ffe9168a 100644\n--- a/oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/model/UserEntity.java\n+++ b/oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/model/UserEntity.java\n\n@@ -30,11 +30,7 @@ import org.hibernate.annotations.GenericGenerator;\n @Entity\n @Table(\n     name = \"users\",\n-    indexes = {\n-      @Index(name = \"users_user_id_idx\", columnList = \"user_id\", unique = true),\n-      @Index(name = \"users_temp_reg_id_idx\", columnList = \"temp_reg_id\", unique = true),\n-      @Index(name = \"users_app_id_email_idx\", columnList = \"app_id,email\")\n-    })\n+    indexes = {@Index(name = \"users_app_id_email_idx\", columnList = \"app_id,email\")})\n public class UserEntity {\n \n   @ToString.Exclude\n"}}, {"oid": "c60ce4b180871be21e9f819c59e9a2f68b3d6f24", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/c60ce4b180871be21e9f819c59e9a2f68b3d6f24", "message": "Removed @Index for user_id and temp_reg_id and added unique=true in @Column for both fields\n\nRemoved @Index for user_id and temp_reg_id and added unique=true in @Column for both fields", "committedDate": "2020-09-25T08:02:32Z", "type": "commit"}, {"oid": "e06f952dbd0ad5b596da550334c4b7df00398791", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/e06f952dbd0ad5b596da550334c4b7df00398791", "message": "Merge branch 'develop' into issue-1003-fixes", "committedDate": "2020-09-25T08:04:37Z", "type": "commit"}, {"oid": "50a9a9597250a491ca1abf972c1b60e2b249af64", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/50a9a9597250a491ca1abf972c1b60e2b249af64", "message": "Merge branch 'develop' into issue-1003-fixes", "committedDate": "2020-09-25T15:46:22Z", "type": "commit"}]}