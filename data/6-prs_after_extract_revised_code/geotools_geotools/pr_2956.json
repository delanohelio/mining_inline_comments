{"pr_number": 2956, "pr_title": "[GEOT-6610] WMTS module uses wrong scale when requesting tiles [GEOT-6611] WMTS module makes occur unnecessary scaling while composing the map from requested tiles", "pr_createdAt": "2020-06-01T09:17:12Z", "pr_url": "https://github.com/geotools/geotools/pull/2956", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE0MzIwNQ==", "url": "https://github.com/geotools/geotools/pull/2956#discussion_r433143205", "bodyText": "I'd expect to see floor and ceil rather than round here - otherwise it can clip needed pixels", "author": "ianturton", "createdAt": "2020-06-01T09:53:38Z", "path": "modules/extension/wmts/src/main/java/org/geotools/ows/wmts/map/WMTSCoverageReader.java", "diffHunk": "@@ -366,10 +383,10 @@ protected void renderTile(Tile tile, Graphics2D g2d, double[] points) {\n         }\n         g2d.drawImage(\n                 img,\n-                (int) points[0],\n-                (int) points[1],\n-                (int) Math.ceil(points[2] - points[0]),\n-                (int) Math.ceil(points[3] - points[1]),\n+                (int) Math.round(points[0]),", "originalCommit": "f1fc773c9fb0e2b2ee46b898bab083d9e68feaa2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDM3NjY3Nw==", "url": "https://github.com/geotools/geotools/pull/2956#discussion_r434376677", "bodyText": "Maybe I'm not getting the point but using Math.round looks the better way to me since it provides the closest value to the double one. Also by doing some live test with both the solutions, this is the way I got the clearest output.", "author": "taba90", "createdAt": "2020-06-03T07:53:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE0MzIwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjU0MTA4OA==", "url": "https://github.com/geotools/geotools/pull/2956#discussion_r436541088", "bodyText": "Been trough it too, there are a number of positions very close to the unit, using floor and ceil causes 1-2 pixels to be added and quality suffers quite visibly due to a rescale being necessary after that. @taba90 I'd still make sure that the box hits at least one pixel in both directions though.", "author": "aaime", "createdAt": "2020-06-08T08:43:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE0MzIwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjY2MDY4NQ==", "url": "https://github.com/geotools/geotools/pull/2956#discussion_r436660685", "bodyText": "@aaime fixed", "author": "taba90", "createdAt": "2020-06-08T12:38:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE0MzIwNQ=="}], "type": "inlineReview", "revised_code": {"commit": "f5dde2e674c72114a2d3e67c47dbc5cad94d0457", "chunk": "diff --git a/modules/extension/wmts/src/main/java/org/geotools/ows/wmts/map/WMTSCoverageReader.java b/modules/extension/wmts/src/main/java/org/geotools/ows/wmts/map/WMTSCoverageReader.java\nindex 974df50e98..2c02e9b909 100644\n--- a/modules/extension/wmts/src/main/java/org/geotools/ows/wmts/map/WMTSCoverageReader.java\n+++ b/modules/extension/wmts/src/main/java/org/geotools/ows/wmts/map/WMTSCoverageReader.java\n\n@@ -383,10 +366,10 @@ public class WMTSCoverageReader extends AbstractGridCoverage2DReader {\n         }\n         g2d.drawImage(\n                 img,\n-                (int) Math.round(points[0]),\n-                (int) Math.round(points[1]),\n-                (int) Math.round(points[2] - points[0]),\n-                (int) Math.round(points[3] - points[1]),\n+                (int) points[0],\n+                (int) points[1],\n+                (int) Math.ceil(points[2] - points[0]),\n+                (int) Math.ceil(points[3] - points[1]),\n                 null);\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE0MzcwNw==", "url": "https://github.com/geotools/geotools/pull/2956#discussion_r433143707", "bodyText": "Why not leave scale as an int - rather than casting it when it's used?", "author": "ianturton", "createdAt": "2020-06-01T09:54:47Z", "path": "modules/extension/wmts/src/main/java/org/geotools/ows/wmts/request/AbstractGetTileRequest.java", "diffHunk": "@@ -265,22 +261,12 @@ public void setCRS(CoordinateReferenceSystem coordinateReferenceSystem) {\n                                         WMTSTileService.EXTRA_HEADERS, extra -> new HashMap<>())))\n                 .putAll(this.headers);\n \n-        // zoomLevel = factory.getZoomLevel(zoom, wmtsService);\n-        int scale = 0;\n-\n-        try {\n-            scale =\n-                    (int)\n-                            Math.round(\n-                                    RendererUtilities.calculateScale(\n-                                            requestedBBox, requestedWidth, requestedHeight, DPI));\n-        } catch (FactoryException | TransformException ex) {\n-            LOGGER.log(Level.WARNING, \"Failed to calculate scale\", ex);\n-            throw new ServiceException(\"Failed to calculate scale: \" + ex.getMessage());\n-        }\n+        double scale =", "originalCommit": "f1fc773c9fb0e2b2ee46b898bab083d9e68feaa2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE1NjI2Ng==", "url": "https://github.com/geotools/geotools/pull/2956#discussion_r433156266", "bodyText": "A scale has never been an int thought? Seems a step in the right direction to me.", "author": "aaime", "createdAt": "2020-06-01T10:25:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE0MzcwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE2NTc2NA==", "url": "https://github.com/geotools/geotools/pull/2956#discussion_r433165764", "bodyText": "but it is used as an int - using Math.round() and leaving it as a double and then casting to an int is misleading, If we want to use a double for scale then let's use a double all the way through.", "author": "ianturton", "createdAt": "2020-06-01T10:49:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE0MzcwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDM3NDMzNg==", "url": "https://github.com/geotools/geotools/pull/2956#discussion_r434374336", "bodyText": "fixed", "author": "taba90", "createdAt": "2020-06-03T07:49:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE0MzcwNw=="}], "type": "inlineReview", "revised_code": null}, {"oid": "f5dde2e674c72114a2d3e67c47dbc5cad94d0457", "url": "https://github.com/geotools/geotools/commit/f5dde2e674c72114a2d3e67c47dbc5cad94d0457", "message": "[GEOT-6610] WMTS module uses wrong scale when requesting tiles", "committedDate": "2020-06-08T10:22:39Z", "type": "commit"}, {"oid": "15c2ed03ee600535707e361d1e0b052b2067c438", "url": "https://github.com/geotools/geotools/commit/15c2ed03ee600535707e361d1e0b052b2067c438", "message": "[GEOT-6611] WMTS module makes occur unnecessary scaling while composing the map from requested tiles", "committedDate": "2020-06-08T10:22:39Z", "type": "commit"}, {"oid": "13a1a4220214c97d95437c267a47a9de897af1a9", "url": "https://github.com/geotools/geotools/commit/13a1a4220214c97d95437c267a47a9de897af1a9", "message": "fix tests failings + reviewer's suggestion applied", "committedDate": "2020-06-08T10:22:40Z", "type": "commit"}, {"oid": "13a1a4220214c97d95437c267a47a9de897af1a9", "url": "https://github.com/geotools/geotools/commit/13a1a4220214c97d95437c267a47a9de897af1a9", "message": "fix tests failings + reviewer's suggestion applied", "committedDate": "2020-06-08T10:22:40Z", "type": "forcePushed"}]}