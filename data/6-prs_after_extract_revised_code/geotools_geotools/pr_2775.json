{"pr_number": 2775, "pr_title": "[GEOT-6503] Extend SLD to support background fill specification at the UserStyle level", "pr_createdAt": "2020-01-27T18:59:12Z", "pr_url": "https://github.com/geotools/geotools/pull/2775", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQ1MDk3Mg==", "url": "https://github.com/geotools/geotools/pull/2775#discussion_r371450972", "bodyText": "exciting you went for Fill", "author": "jodygarnett", "createdAt": "2020-01-27T19:56:25Z", "path": "modules/library/main/src/main/java/org/geotools/styling/Style.java", "diffHunk": "@@ -95,4 +95,14 @@\n      * @param visitor\n      */\n     void accept(org.geotools.styling.StyleVisitor visitor);\n+\n+    /** The background Fill , if any, <code>null</code> otherwise */\n+    public default Fill getBackground() {\n+        return null;", "originalCommit": "c75fbaf0977db88179b9180e41a55a015bb7dc1a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQ1MTIxOA==", "url": "https://github.com/geotools/geotools/pull/2775#discussion_r371451218", "bodyText": "Do we need to make the image transparent, before applying your fill, in case the fill has some transparency effects?", "author": "jodygarnett", "createdAt": "2020-01-27T19:56:54Z", "path": "modules/library/render/src/main/java/org/geotools/renderer/lite/StreamingRenderer.java", "diffHunk": "@@ -834,6 +830,14 @@ public void paint(\n                         \"Cannot call paint, you did not set a MapContent in this renderer\");\n             }\n \n+            // handle the background color specification, if any\n+            Style firstStyle = mapContent.layers().get(0).getStyle();\n+            if (firstStyle.getBackground() != null) {\n+                Paint background = styleFactory.getPaint(firstStyle.getBackground(), null, null);\n+                graphics.setPaint(background);\n+                graphics.fill(paintArea);", "originalCommit": "c75fbaf0977db88179b9180e41a55a015bb7dc1a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjQ0ODczMQ==", "url": "https://github.com/geotools/geotools/pull/2775#discussion_r372448731", "bodyText": "No, StreamingRenderer is given a Graphic2D, it should not alter what was done before on it (could have been used for overlay on top of other stuff for example). It should be simple and predictable, just do what it was asked to do (apply the background).", "author": "aaime", "createdAt": "2020-01-29T15:23:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQ1MTIxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDI2MTU2MA==", "url": "https://github.com/geotools/geotools/pull/2775#discussion_r374261560", "bodyText": "thanks that makes sense", "author": "jodygarnett", "createdAt": "2020-02-03T18:21:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQ1MTIxOA=="}], "type": "inlineReview", "revised_code": {"commit": "e5cabb9eb4071f1a7f4852b4f2b643161d6df512", "chunk": "diff --git a/modules/library/render/src/main/java/org/geotools/renderer/lite/StreamingRenderer.java b/modules/library/render/src/main/java/org/geotools/renderer/lite/StreamingRenderer.java\nindex 37c7194465..e8a5772f23 100644\n--- a/modules/library/render/src/main/java/org/geotools/renderer/lite/StreamingRenderer.java\n+++ b/modules/library/render/src/main/java/org/geotools/renderer/lite/StreamingRenderer.java\n\n@@ -830,14 +830,6 @@ public class StreamingRenderer implements GTRenderer {\n                         \"Cannot call paint, you did not set a MapContent in this renderer\");\n             }\n \n-            // handle the background color specification, if any\n-            Style firstStyle = mapContent.layers().get(0).getStyle();\n-            if (firstStyle.getBackground() != null) {\n-                Paint background = styleFactory.getPaint(firstStyle.getBackground(), null, null);\n-                graphics.setPaint(background);\n-                graphics.fill(paintArea);\n-            }\n-\n             // re-organize the map content and generate the z group layers\n             MapContent zGroupedMapContent = ZGroupLayerFactory.filter(mapContent);\n \n"}}, {"oid": "e5cabb9eb4071f1a7f4852b4f2b643161d6df512", "url": "https://github.com/geotools/geotools/commit/e5cabb9eb4071f1a7f4852b4f2b643161d6df512", "message": "Work in progress on background for SLD and MBStyle", "committedDate": "2020-01-29T15:20:14Z", "type": "forcePushed"}, {"oid": "a4409d9173d7d62c5cf100e0f896ce5e556d46fc", "url": "https://github.com/geotools/geotools/commit/a4409d9173d7d62c5cf100e0f896ce5e556d46fc", "message": "[GEOT-6503] Extend SLD to support background fill specification at the UserStyle level", "committedDate": "2020-01-29T15:21:29Z", "type": "forcePushed"}, {"oid": "8daa5d3a22b9ee5823d63e1cff50ac6dd0e01563", "url": "https://github.com/geotools/geotools/commit/8daa5d3a22b9ee5823d63e1cff50ac6dd0e01563", "message": "[GEOT-6503] Extend SLD to support background fill specification at the UserStyle level", "committedDate": "2020-01-29T15:22:28Z", "type": "forcePushed"}, {"oid": "0dfebc20ab088ec3116f566b3a919bc56f71e51e", "url": "https://github.com/geotools/geotools/commit/0dfebc20ab088ec3116f566b3a919bc56f71e51e", "message": "[GEOT-6503] Extend SLD to support background fill specification at the UserStyle level", "committedDate": "2020-01-29T15:36:59Z", "type": "forcePushed"}, {"oid": "75b4ba86151551d43cd4c8a2fa9816adc86d8d9c", "url": "https://github.com/geotools/geotools/commit/75b4ba86151551d43cd4c8a2fa9816adc86d8d9c", "message": "[GEOT-6503] Extend SLD to support background fill specification at the UserStyle level", "committedDate": "2020-01-29T17:24:48Z", "type": "commit"}, {"oid": "75b4ba86151551d43cd4c8a2fa9816adc86d8d9c", "url": "https://github.com/geotools/geotools/commit/75b4ba86151551d43cd4c8a2fa9816adc86d8d9c", "message": "[GEOT-6503] Extend SLD to support background fill specification at the UserStyle level", "committedDate": "2020-01-29T17:24:48Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDE5NTk4OQ==", "url": "https://github.com/geotools/geotools/pull/2775#discussion_r374195989", "bodyText": "just a minor TYPO here... layer instead of later", "author": "dromagnoli", "createdAt": "2020-02-03T16:15:39Z", "path": "modules/unsupported/mbstyle/src/main/java/org/geotools/mbstyle/MBStyle.java", "diffHunk": "@@ -480,11 +440,75 @@ public StyledLayerDescriptor transform() {\n             }\n         }\n \n-        if (sld.layers().isEmpty()) {\n+        if (background != null) {\n+            // attach to the first layer if possible\n+            FilterFactory2 ff = parse.getFilterFactory();\n+            if (sld.getStyledLayers().length > 0) {\n+                NamedLayer layer = (NamedLayer) sld.getStyledLayers()[0];\n+                Style firstStyle = layer.getStyles()[0];\n+                firstStyle.setBackground(background.getFill(this));\n+            } else {\n+                // odd situation, the only spec is a background layer? build a fake SLD layer then\n+                addLoneBackgroundLayer(sf, sld, background, ff);\n+            }\n+        } else if (sld.layers().isEmpty()) {\n             throw new MBFormatException(\"No visibile layers\");\n         }\n \n         sld.setName(getName());\n         return sld;\n     }\n+\n+    private void addLoneBackgroundLayer(\n+            StyleFactory sf,\n+            StyledLayerDescriptor sld,\n+            BackgroundMBLayer background,\n+            FilterFactory2 ff) {\n+        // Background does not use a source; construct a user later with a world extent", "originalCommit": "75b4ba86151551d43cd4c8a2fa9816adc86d8d9c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}