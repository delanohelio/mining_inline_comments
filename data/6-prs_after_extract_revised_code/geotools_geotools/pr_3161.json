{"pr_number": 3161, "pr_title": "cql-json-module-start", "pr_createdAt": "2020-09-24T19:45:47Z", "pr_url": "https://github.com/geotools/geotools/pull/3161", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDU5MTUyMA==", "url": "https://github.com/geotools/geotools/pull/3161#discussion_r494591520", "bodyText": "2020 ?", "author": "jodygarnett", "createdAt": "2020-09-24T20:28:52Z", "path": "modules/unsupported/cql-json/src/main/java/org/geotools/filter/text/cqljson/CQLJson.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ *    GeoTools - The Open Source Java GIS Toolkit\n+ *    http://geotools.org\n+ *\n+ *    (C) 2016, Open Source Geospatial Foundation (OSGeo)", "originalCommit": "86639d8152e536d947bf934b6fa359b254f24ebb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njc5NzA0OQ==", "url": "https://github.com/geotools/geotools/pull/3161#discussion_r496797049", "bodyText": "Fixed.", "author": "turingtestfail", "createdAt": "2020-09-29T15:09:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDU5MTUyMA=="}], "type": "inlineReview", "revised_code": {"commit": "37c1704e798cc86d2f2d514409f037fb3b35121e", "chunk": "diff --git a/modules/unsupported/cql-json/src/main/java/org/geotools/filter/text/cqljson/CQLJson.java b/modules/unsupported/cql-json/src/main/java/org/geotools/filter/text/cqljson/CQLJson.java\nindex ccdebd2566..07053ee35e 100644\n--- a/modules/unsupported/cql-json/src/main/java/org/geotools/filter/text/cqljson/CQLJson.java\n+++ b/modules/unsupported/cql-json/src/main/java/org/geotools/filter/text/cqljson/CQLJson.java\n\n@@ -2,7 +2,7 @@\n  *    GeoTools - The Open Source Java GIS Toolkit\n  *    http://geotools.org\n  *\n- *    (C) 2016, Open Source Geospatial Foundation (OSGeo)\n+ *    (C) 2020, Open Source Geospatial Foundation (OSGeo)\n  *\n  *    This library is free software; you can redistribute it and/or\n  *    modify it under the terms of the GNU Lesser General Public\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDU5MTc5Nw==", "url": "https://github.com/geotools/geotools/pull/3161#discussion_r494591797", "bodyText": "We try for public javadocs, this is an unsupported module so you can wait until this is ready to be consider for the library.", "author": "jodygarnett", "createdAt": "2020-09-24T20:29:21Z", "path": "modules/unsupported/cql-json/src/main/java/org/geotools/filter/text/cqljson/CQLJson.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ *    GeoTools - The Open Source Java GIS Toolkit\n+ *    http://geotools.org\n+ *\n+ *    (C) 2016, Open Source Geospatial Foundation (OSGeo)\n+ *\n+ *    This library is free software; you can redistribute it and/or\n+ *    modify it under the terms of the GNU Lesser General Public\n+ *    License as published by the Free Software Foundation;\n+ *    version 2.1 of the License.\n+ *\n+ *    This library is distributed in the hope that it will be useful,\n+ *    but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ *    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n+ *    Lesser General Public License for more details.\n+ */\n+\n+package org.geotools.filter.text.cqljson;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import org.geotools.filter.text.commons.CompilerUtil;\n+import org.geotools.filter.text.cql2.CQLException;\n+import org.geotools.filter.text.cqljson.model.Predicates;\n+import org.opengis.filter.Filter;\n+import org.opengis.filter.FilterFactory;\n+", "originalCommit": "86639d8152e536d947bf934b6fa359b254f24ebb", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "37c1704e798cc86d2f2d514409f037fb3b35121e", "chunk": "diff --git a/modules/unsupported/cql-json/src/main/java/org/geotools/filter/text/cqljson/CQLJson.java b/modules/unsupported/cql-json/src/main/java/org/geotools/filter/text/cqljson/CQLJson.java\nindex ccdebd2566..07053ee35e 100644\n--- a/modules/unsupported/cql-json/src/main/java/org/geotools/filter/text/cqljson/CQLJson.java\n+++ b/modules/unsupported/cql-json/src/main/java/org/geotools/filter/text/cqljson/CQLJson.java\n\n@@ -2,7 +2,7 @@\n  *    GeoTools - The Open Source Java GIS Toolkit\n  *    http://geotools.org\n  *\n- *    (C) 2016, Open Source Geospatial Foundation (OSGeo)\n+ *    (C) 2020, Open Source Geospatial Foundation (OSGeo)\n  *\n  *    This library is free software; you can redistribute it and/or\n  *    modify it under the terms of the GNU Lesser General Public\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDU5MzAxNA==", "url": "https://github.com/geotools/geotools/pull/3161#discussion_r494593014", "bodyText": "This is a bit odd to have as a builder, are you sure you are not looking for a FilterVisitor? Traverse the data structure and covert ...", "author": "jodygarnett", "createdAt": "2020-09-24T20:31:42Z", "path": "modules/unsupported/cql-json/src/main/java/org/geotools/filter/text/cqljson/CQLJsonFilterBuilder.java", "diffHunk": "@@ -0,0 +1,610 @@\n+/*\n+ *    GeoTools - The Open Source Java GIS Toolkit\n+ *    http://geotools.org\n+ *\n+ *    (C) 2016, Open Source Geospatial Foundation (OSGeo)\n+ *\n+ *    This library is free software; you can redistribute it and/or\n+ *    modify it under the terms of the GNU Lesser General Public\n+ *    License as published by the Free Software Foundation;\n+ *    version 2.1 of the License.\n+ *\n+ *    This library is distributed in the hope that it will be useful,\n+ *    but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ *    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n+ *    Lesser General Public License for more details.\n+ */\n+\n+package org.geotools.filter.text.cqljson;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import org.geotools.filter.text.cqljson.model.After;\n+import org.geotools.filter.text.cqljson.model.Anyinteracts;\n+import org.geotools.filter.text.cqljson.model.Before;\n+import org.geotools.filter.text.cqljson.model.Begins;\n+import org.geotools.filter.text.cqljson.model.Begunby;\n+import org.geotools.filter.text.cqljson.model.Between;\n+import org.geotools.filter.text.cqljson.model.Contains;\n+import org.geotools.filter.text.cqljson.model.Crosses;\n+import org.geotools.filter.text.cqljson.model.Disjoint;\n+import org.geotools.filter.text.cqljson.model.During;\n+import org.geotools.filter.text.cqljson.model.Endedby;\n+import org.geotools.filter.text.cqljson.model.Ends;\n+import org.geotools.filter.text.cqljson.model.Eq;\n+import org.geotools.filter.text.cqljson.model.Equals;\n+import org.geotools.filter.text.cqljson.model.FunctionObjectArgument;\n+import org.geotools.filter.text.cqljson.model.Gt;\n+import org.geotools.filter.text.cqljson.model.Gte;\n+import org.geotools.filter.text.cqljson.model.In;\n+import org.geotools.filter.text.cqljson.model.Intersects;\n+import org.geotools.filter.text.cqljson.model.Like;\n+import org.geotools.filter.text.cqljson.model.Lt;\n+import org.geotools.filter.text.cqljson.model.Lte;\n+import org.geotools.filter.text.cqljson.model.Meets;\n+import org.geotools.filter.text.cqljson.model.Metby;\n+import org.geotools.filter.text.cqljson.model.Overlappedby;\n+import org.geotools.filter.text.cqljson.model.Overlaps;\n+import org.geotools.filter.text.cqljson.model.TContains;\n+import org.geotools.filter.text.cqljson.model.Tequals;\n+import org.geotools.filter.text.cqljson.model.Tintersects;\n+import org.geotools.filter.text.cqljson.model.Touches;\n+import org.geotools.filter.text.cqljson.model.Toverlaps;\n+import org.geotools.filter.text.cqljson.model.Within;\n+import org.geotools.filter.text.generated.parsers.ParseException;\n+import org.opengis.filter.Filter;\n+import org.opengis.filter.FilterFactory;\n+import org.opengis.filter.expression.Expression;\n+import org.opengis.filter.expression.Function;\n+import org.opengis.filter.expression.Literal;\n+import org.opengis.filter.expression.PropertyName;\n+import org.opengis.geometry.Geometry;\n+\n+final class CQLJsonFilterBuilder {", "originalCommit": "86639d8152e536d947bf934b6fa359b254f24ebb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njc5NjgwMg==", "url": "https://github.com/geotools/geotools/pull/3161#discussion_r496796802", "bodyText": "This is the pattern that the original CQL to filter developers followed.  My understanding is that the FilterVisitor is for going from Filter to something else (like SQL) vs. what I am doing here, which is going from JSON to Filter.", "author": "turingtestfail", "createdAt": "2020-09-29T15:08:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDU5MzAxNA=="}], "type": "inlineReview", "revised_code": {"commit": "37c1704e798cc86d2f2d514409f037fb3b35121e", "chunk": "diff --git a/modules/unsupported/cql-json/src/main/java/org/geotools/filter/text/cqljson/CQLJsonFilterBuilder.java b/modules/unsupported/cql-json/src/main/java/org/geotools/filter/text/cqljson/CQLJsonFilterBuilder.java\nindex 5285b10051..4f7810d39f 100644\n--- a/modules/unsupported/cql-json/src/main/java/org/geotools/filter/text/cqljson/CQLJsonFilterBuilder.java\n+++ b/modules/unsupported/cql-json/src/main/java/org/geotools/filter/text/cqljson/CQLJsonFilterBuilder.java\n\n@@ -2,7 +2,7 @@\n  *    GeoTools - The Open Source Java GIS Toolkit\n  *    http://geotools.org\n  *\n- *    (C) 2016, Open Source Geospatial Foundation (OSGeo)\n+ *    (C) 2020, Open Source Geospatial Foundation (OSGeo)\n  *\n  *    This library is free software; you can redistribute it and/or\n  *    modify it under the terms of the GNU Lesser General Public\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDU5Mzc3Mg==", "url": "https://github.com/geotools/geotools/pull/3161#discussion_r494593772", "bodyText": "I expect this class will be used a lot, may wish to go for a more explicit class name :)", "author": "jodygarnett", "createdAt": "2020-09-24T20:33:00Z", "path": "modules/unsupported/cql-json/src/main/java/org/geotools/filter/text/cqljson/GeomUtil.java", "diffHunk": "@@ -0,0 +1,206 @@\n+/*\n+ *    GeoTools - The Open Source Java GIS Toolkit\n+ *    http://geotools.org\n+ *\n+ *    (C) 2016, Open Source Geospatial Foundation (OSGeo)\n+ *\n+ *    This library is free software; you can redistribute it and/or\n+ *    modify it under the terms of the GNU Lesser General Public\n+ *    License as published by the Free Software Foundation;\n+ *    version 2.1 of the License.\n+ *\n+ *    This library is distributed in the hope that it will be useful,\n+ *    but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ *    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n+ *    Lesser General Public License for more details.\n+ */\n+\n+package org.geotools.filter.text.cqljson;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import org.geotools.filter.text.generated.parsers.ParseException;\n+import org.geotools.geometry.GeneralDirectPosition;\n+import org.geotools.geometry.GeometryBuilder;\n+import org.geotools.referencing.crs.DefaultGeographicCRS;\n+import org.opengis.geometry.aggregate.MultiCurve;\n+import org.opengis.geometry.aggregate.MultiPoint;\n+import org.opengis.geometry.aggregate.MultiSurface;\n+import org.opengis.geometry.coordinate.PointArray;\n+import org.opengis.geometry.primitive.Curve;\n+import org.opengis.geometry.primitive.Point;\n+import org.opengis.geometry.primitive.Surface;\n+import org.opengis.geometry.primitive.SurfaceBoundary;\n+\n+public class GeomUtil {", "originalCommit": "86639d8152e536d947bf934b6fa359b254f24ebb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njc5NDg0OA==", "url": "https://github.com/geotools/geotools/pull/3161#discussion_r496794848", "bodyText": "Yeah, that makes a lot of sense.  Changed to \"MapToOpenGISGeomUtil\"", "author": "turingtestfail", "createdAt": "2020-09-29T15:06:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDU5Mzc3Mg=="}], "type": "inlineReview", "revised_code": {"commit": "37c1704e798cc86d2f2d514409f037fb3b35121e", "chunk": "diff --git a/modules/unsupported/cql-json/src/main/java/org/geotools/filter/text/cqljson/GeomUtil.java b/modules/unsupported/cql-json/src/main/java/org/geotools/filter/text/cqljson/MapToOpenGISGeomUtil.java\nsimilarity index 98%\nrename from modules/unsupported/cql-json/src/main/java/org/geotools/filter/text/cqljson/GeomUtil.java\nrename to modules/unsupported/cql-json/src/main/java/org/geotools/filter/text/cqljson/MapToOpenGISGeomUtil.java\nindex 03aca14423..56af38a96e 100644\n--- a/modules/unsupported/cql-json/src/main/java/org/geotools/filter/text/cqljson/GeomUtil.java\n+++ b/modules/unsupported/cql-json/src/main/java/org/geotools/filter/text/cqljson/MapToOpenGISGeomUtil.java\n\n@@ -2,7 +2,7 @@\n  *    GeoTools - The Open Source Java GIS Toolkit\n  *    http://geotools.org\n  *\n- *    (C) 2016, Open Source Geospatial Foundation (OSGeo)\n+ *    (C) 2020, Open Source Geospatial Foundation (OSGeo)\n  *\n  *    This library is free software; you can redistribute it and/or\n  *    modify it under the terms of the GNU Lesser General Public\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDU5NDg2MA==", "url": "https://github.com/geotools/geotools/pull/3161#discussion_r494594860", "bodyText": "This used to be how enumerations were represented in Java (so they could be strongly typed).\nIs making SpatialExpressions an enum worthwhile?", "author": "jodygarnett", "createdAt": "2020-09-24T20:34:55Z", "path": "modules/unsupported/cql-json/src/main/java/org/geotools/filter/text/cqljson/model/Contains.java", "diffHunk": "@@ -0,0 +1,20 @@\n+/*\n+ *    GeoTools - The Open Source Java GIS Toolkit\n+ *    http://geotools.org\n+ *\n+ *    (C) 2016, Open Source Geospatial Foundation (OSGeo)\n+ *\n+ *    This library is free software; you can redistribute it and/or\n+ *    modify it under the terms of the GNU Lesser General Public\n+ *    License as published by the Free Software Foundation;\n+ *    version 2.1 of the License.\n+ *\n+ *    This library is distributed in the hope that it will be useful,\n+ *    but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ *    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n+ *    Lesser General Public License for more details.\n+ */\n+\n+package org.geotools.filter.text.cqljson.model;\n+\n+public class Contains extends SpatialExpressions {}", "originalCommit": "86639d8152e536d947bf934b6fa359b254f24ebb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njc5NDI5Ng==", "url": "https://github.com/geotools/geotools/pull/3161#discussion_r496794296", "bodyText": "I did this as a bit of future proofing and to match the CQLJson standard.  If you think this clutter things I can remove it.", "author": "turingtestfail", "createdAt": "2020-09-29T15:05:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDU5NDg2MA=="}], "type": "inlineReview", "revised_code": {"commit": "37c1704e798cc86d2f2d514409f037fb3b35121e", "chunk": "diff --git a/modules/unsupported/cql-json/src/main/java/org/geotools/filter/text/cqljson/model/Contains.java b/modules/unsupported/cql-json/src/main/java/org/geotools/filter/text/cqljson/model/Contains.java\nindex d190c1bb1a..9469a17da7 100644\n--- a/modules/unsupported/cql-json/src/main/java/org/geotools/filter/text/cqljson/model/Contains.java\n+++ b/modules/unsupported/cql-json/src/main/java/org/geotools/filter/text/cqljson/model/Contains.java\n\n@@ -2,7 +2,7 @@\n  *    GeoTools - The Open Source Java GIS Toolkit\n  *    http://geotools.org\n  *\n- *    (C) 2016, Open Source Geospatial Foundation (OSGeo)\n+ *    (C) 2020, Open Source Geospatial Foundation (OSGeo)\n  *\n  *    This library is free software; you can redistribute it and/or\n  *    modify it under the terms of the GNU Lesser General Public\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDYwNTQzNQ==", "url": "https://github.com/geotools/geotools/pull/3161#discussion_r494605435", "bodyText": "I strongly recommend using  ECQL.toCQL(filter) rather than filter.toString() to have a stable string representation to compare against. As a bonus it should also show the difference between 5 and '\"5\"`.", "author": "jodygarnett", "createdAt": "2020-09-24T20:55:59Z", "path": "modules/unsupported/cql-json/src/test/java/org/geotools/filter/text/cqljson/CQLJsonParsingTest.java", "diffHunk": "@@ -0,0 +1,598 @@\n+package org.geotools.filter.text.cqljson;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import org.geotools.filter.FilterFactoryImpl;\n+import org.geotools.filter.text.cql2.CQLException;\n+import org.junit.Assert;\n+import org.junit.Test;\n+import org.opengis.filter.Filter;\n+\n+public class CQLJsonParsingTest {\n+    @Test\n+    public void convertJsonToPredicates() throws JsonProcessingException, CQLException {\n+        String swimmingpool =\n+                \"{\"\n+                        + \"             \\\"and\\\": [\"\n+                        + \"                {\"\n+                        + \"                   \\\"eq\\\": {\"\n+                        + \"                      \\\"property\\\": \\\"swimming_pool\\\",\"\n+                        + \"                      \\\"value\\\": true\"\n+                        + \"                   }\"\n+                        + \"                },\"\n+                        + \"                {\"\n+                        + \"                   \\\"or\\\": [\"\n+                        + \"                      {\"\n+                        + \"                         \\\"gt\\\": {\"\n+                        + \"                            \\\"property\\\": \\\"floor\\\",\"\n+                        + \"                            \\\"value\\\": 5\"\n+                        + \"                         }\"\n+                        + \"                      },\"\n+                        + \"                      {\"\n+                        + \"                         \\\"like\\\": {\"\n+                        + \"                            \\\"property\\\": \\\"material\\\",\"\n+                        + \"                            \\\"value\\\": \\\"brick%\\\"\"\n+                        + \"                         }\"\n+                        + \"                      },\"\n+                        + \"                      {\"\n+                        + \"                         \\\"like\\\": {\"\n+                        + \"                            \\\"property\\\": \\\"material\\\",\"\n+                        + \"                            \\\"value\\\": \\\"%brick\\\"\"\n+                        + \"                         }\"\n+                        + \"                      } \"\n+                        + \"                   ]\"\n+                        + \"                }\"\n+                        + \"             ]\"\n+                        + \"          }\";\n+\n+        CQLJsonCompiler cqlJsonCompiler =\n+                new CQLJsonCompiler(swimmingpool, new FilterFactoryImpl());\n+        cqlJsonCompiler.compileFilter();\n+        Filter filter = cqlJsonCompiler.getFilter();\n+        Assert.assertEquals(\n+                \"[[ swimming_pool = true ] AND [[ floor > 5 ] OR [ material is like brick% ] OR [ material is like %brick ]]]\",\n+                filter.toString());", "originalCommit": "86639d8152e536d947bf934b6fa359b254f24ebb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njc5MzU5OQ==", "url": "https://github.com/geotools/geotools/pull/3161#discussion_r496793599", "bodyText": "Good point.  I changed the test to use ECQL.toCQL rather than toString for stability.", "author": "turingtestfail", "createdAt": "2020-09-29T15:04:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDYwNTQzNQ=="}], "type": "inlineReview", "revised_code": {"commit": "37c1704e798cc86d2f2d514409f037fb3b35121e", "chunk": "diff --git a/modules/unsupported/cql-json/src/test/java/org/geotools/filter/text/cqljson/CQLJsonParsingTest.java b/modules/unsupported/cql-json/src/test/java/org/geotools/filter/text/cqljson/CQLJsonParsingTest.java\nindex bbd14b3291..8e6a205685 100644\n--- a/modules/unsupported/cql-json/src/test/java/org/geotools/filter/text/cqljson/CQLJsonParsingTest.java\n+++ b/modules/unsupported/cql-json/src/test/java/org/geotools/filter/text/cqljson/CQLJsonParsingTest.java\n\n@@ -3,6 +3,7 @@ package org.geotools.filter.text.cqljson;\n import com.fasterxml.jackson.core.JsonProcessingException;\n import org.geotools.filter.FilterFactoryImpl;\n import org.geotools.filter.text.cql2.CQLException;\n+import org.geotools.filter.text.ecql.ECQL;\n import org.junit.Assert;\n import org.junit.Test;\n import org.opengis.filter.Filter;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDYxMzgxOQ==", "url": "https://github.com/geotools/geotools/pull/3161#discussion_r494613819", "bodyText": "These methods can be hard to maintain with having to quote content.\n\nPlease see MapBoxTestUtils test for one idea to make this easier, a utility method that changes \\`` to \"` and then parses.\n\n    public static JSONObject object(String json) throws ParseException {\n        JSONParser parser = new JSONParser();\n        String text = json.replace('\\'', '\\\"');\n        Object object = parser.parse(text);\n        return (JSONObject) object;\n    }\n\nUsed like:\n        String jsonStr = \"{'name1': 'fred', 'name2' : 1, 'name3' : null, 'name4': { 'age': 1 }}\";\n        JSONObject object = MapboxTestUtils.object(jsonStr);\n\n\nAnother good approach is to have a property file of reference ECQL expressions to round trip (convert ECQL -parse-> Filter -encode-> CQL-JSON -parse-> Filter and then double check the Filters are the same. Which is what a lot of the duplication in this class is about.\n\nconvertAndIntersects=(beamMode = \"ScanSAR Narrow\" ] AND [ swathDirection = \"ascending\") ...\n\nThis feedback assume the module will be long lived and plan for adding more and more tests over time as problems are reported. See example here.", "author": "jodygarnett", "createdAt": "2020-09-24T21:13:15Z", "path": "modules/unsupported/cql-json/src/test/java/org/geotools/filter/text/cqljson/CQLJsonParsingTest.java", "diffHunk": "@@ -0,0 +1,598 @@\n+package org.geotools.filter.text.cqljson;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import org.geotools.filter.FilterFactoryImpl;\n+import org.geotools.filter.text.cql2.CQLException;\n+import org.junit.Assert;\n+import org.junit.Test;\n+import org.opengis.filter.Filter;\n+\n+public class CQLJsonParsingTest {\n+    @Test\n+    public void convertJsonToPredicates() throws JsonProcessingException, CQLException {\n+        String swimmingpool =\n+                \"{\"\n+                        + \"             \\\"and\\\": [\"\n+                        + \"                {\"\n+                        + \"                   \\\"eq\\\": {\"\n+                        + \"                      \\\"property\\\": \\\"swimming_pool\\\",\"\n+                        + \"                      \\\"value\\\": true\"\n+                        + \"                   }\"\n+                        + \"                },\"\n+                        + \"                {\"\n+                        + \"                   \\\"or\\\": [\"\n+                        + \"                      {\"\n+                        + \"                         \\\"gt\\\": {\"\n+                        + \"                            \\\"property\\\": \\\"floor\\\",\"\n+                        + \"                            \\\"value\\\": 5\"\n+                        + \"                         }\"\n+                        + \"                      },\"\n+                        + \"                      {\"\n+                        + \"                         \\\"like\\\": {\"\n+                        + \"                            \\\"property\\\": \\\"material\\\",\"\n+                        + \"                            \\\"value\\\": \\\"brick%\\\"\"\n+                        + \"                         }\"\n+                        + \"                      },\"\n+                        + \"                      {\"\n+                        + \"                         \\\"like\\\": {\"\n+                        + \"                            \\\"property\\\": \\\"material\\\",\"\n+                        + \"                            \\\"value\\\": \\\"%brick\\\"\"\n+                        + \"                         }\"\n+                        + \"                      } \"\n+                        + \"                   ]\"\n+                        + \"                }\"\n+                        + \"             ]\"\n+                        + \"          }\";\n+\n+        CQLJsonCompiler cqlJsonCompiler =\n+                new CQLJsonCompiler(swimmingpool, new FilterFactoryImpl());\n+        cqlJsonCompiler.compileFilter();\n+        Filter filter = cqlJsonCompiler.getFilter();\n+        Assert.assertEquals(\n+                \"[[ swimming_pool = true ] AND [[ floor > 5 ] OR [ material is like brick% ] OR [ material is like %brick ]]]\",\n+                filter.toString());\n+    }\n+\n+    @Test\n+    public void convertAndIntersects() throws JsonProcessingException, CQLException {\n+        String beam =", "originalCommit": "86639d8152e536d947bf934b6fa359b254f24ebb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njc5MzE0NQ==", "url": "https://github.com/geotools/geotools/pull/3161#discussion_r496793145", "bodyText": "As suggested I moved the JSON into its own file.", "author": "turingtestfail", "createdAt": "2020-09-29T15:04:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDYxMzgxOQ=="}], "type": "inlineReview", "revised_code": {"commit": "37c1704e798cc86d2f2d514409f037fb3b35121e", "chunk": "diff --git a/modules/unsupported/cql-json/src/test/java/org/geotools/filter/text/cqljson/CQLJsonParsingTest.java b/modules/unsupported/cql-json/src/test/java/org/geotools/filter/text/cqljson/CQLJsonParsingTest.java\nindex bbd14b3291..8e6a205685 100644\n--- a/modules/unsupported/cql-json/src/test/java/org/geotools/filter/text/cqljson/CQLJsonParsingTest.java\n+++ b/modules/unsupported/cql-json/src/test/java/org/geotools/filter/text/cqljson/CQLJsonParsingTest.java\n\n@@ -3,6 +3,7 @@ package org.geotools.filter.text.cqljson;\n import com.fasterxml.jackson.core.JsonProcessingException;\n import org.geotools.filter.FilterFactoryImpl;\n import org.geotools.filter.text.cql2.CQLException;\n+import org.geotools.filter.text.ecql.ECQL;\n import org.junit.Assert;\n import org.junit.Test;\n import org.opengis.filter.Filter;\n"}}, {"oid": "e3670181c4bac64e47cb927cf104b5551ce38868", "url": "https://github.com/geotools/geotools/commit/e3670181c4bac64e47cb927cf104b5551ce38868", "message": "cql-json-module-start", "committedDate": "2020-10-05T19:35:00Z", "type": "commit"}, {"oid": "cc3b4b4e34b6bc25df163be2072fc2523442b506", "url": "https://github.com/geotools/geotools/commit/cc3b4b4e34b6bc25df163be2072fc2523442b506", "message": "updated parent pom to 25", "committedDate": "2020-10-05T19:35:00Z", "type": "commit"}, {"oid": "37c1704e798cc86d2f2d514409f037fb3b35121e", "url": "https://github.com/geotools/geotools/commit/37c1704e798cc86d2f2d514409f037fb3b35121e", "message": "Fixed license year and changed tests to use ECQL.toCQL instead of toString", "committedDate": "2020-10-05T19:35:00Z", "type": "commit"}, {"oid": "75b9fdee4a84474afa6dbec03d503f57fae19c13", "url": "https://github.com/geotools/geotools/commit/75b9fdee4a84474afa6dbec03d503f57fae19c13", "message": "started on moving json test objects into test file", "committedDate": "2020-10-05T19:35:00Z", "type": "commit"}, {"oid": "f66e41123cc1b5e43d02b70b30e301316c84112d", "url": "https://github.com/geotools/geotools/commit/f66e41123cc1b5e43d02b70b30e301316c84112d", "message": "half the tests are in the file", "committedDate": "2020-10-05T19:35:00Z", "type": "commit"}, {"oid": "cbb53dfc74d2c1711df0aaa93d67d3086df35c29", "url": "https://github.com/geotools/geotools/commit/cbb53dfc74d2c1711df0aaa93d67d3086df35c29", "message": "got all tests working with test json file and fixed issue with casting to double", "committedDate": "2020-10-05T19:35:00Z", "type": "commit"}, {"oid": "cbb53dfc74d2c1711df0aaa93d67d3086df35c29", "url": "https://github.com/geotools/geotools/commit/cbb53dfc74d2c1711df0aaa93d67d3086df35c29", "message": "got all tests working with test json file and fixed issue with casting to double", "committedDate": "2020-10-05T19:35:00Z", "type": "forcePushed"}, {"oid": "fbf52b2065b3e1e9fb972ab20ae854033369329a", "url": "https://github.com/geotools/geotools/commit/fbf52b2065b3e1e9fb972ab20ae854033369329a", "message": "qa cleanup", "committedDate": "2020-10-05T19:38:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDc1MzQyOQ==", "url": "https://github.com/geotools/geotools/pull/3161#discussion_r500753429", "bodyText": "This statement can be omitted", "author": "mprins", "createdAt": "2020-10-07T05:54:00Z", "path": "modules/unsupported/cql-json/src/main/java/org/geotools/filter/text/cqljson/MapToOpenGISGeomUtil.java", "diffHunk": "@@ -0,0 +1,217 @@\n+/*\n+ *    GeoTools - The Open Source Java GIS Toolkit\n+ *    http://geotools.org\n+ *\n+ *    (C) 2020, Open Source Geospatial Foundation (OSGeo)\n+ *\n+ *    This library is free software; you can redistribute it and/or\n+ *    modify it under the terms of the GNU Lesser General Public\n+ *    License as published by the Free Software Foundation;\n+ *    version 2.1 of the License.\n+ *\n+ *    This library is distributed in the hope that it will be useful,\n+ *    but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ *    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n+ *    Lesser General Public License for more details.\n+ */\n+\n+package org.geotools.filter.text.cqljson;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import org.geotools.filter.text.generated.parsers.ParseException;\n+import org.geotools.geometry.GeneralDirectPosition;\n+import org.geotools.geometry.GeometryBuilder;\n+import org.geotools.referencing.crs.DefaultGeographicCRS;\n+import org.opengis.geometry.aggregate.MultiCurve;\n+import org.opengis.geometry.aggregate.MultiPoint;\n+import org.opengis.geometry.aggregate.MultiSurface;\n+import org.opengis.geometry.coordinate.PointArray;\n+import org.opengis.geometry.primitive.Curve;\n+import org.opengis.geometry.primitive.Point;\n+import org.opengis.geometry.primitive.Surface;\n+import org.opengis.geometry.primitive.SurfaceBoundary;\n+\n+public class MapToOpenGISGeomUtil {\n+    public static GeometryBuilder FACTORY = null;\n+\n+    static {\n+        FACTORY = new GeometryBuilder(DefaultGeographicCRS.WGS84);\n+    }\n+\n+    /**\n+     * Jackson returns embedded geojson as a map so we use this method to create opengis.Geometry\n+     * for filter creation\n+     *\n+     * @param geoJsonAsMap GeoJSON Map\n+     * @return Geometry for filter creation\n+     * @throws ParseException\n+     */\n+    public static org.opengis.geometry.Geometry parseMapToGeometry(Map<String, Object> geoJsonAsMap)\n+            throws ParseException {\n+        String type = \"Bbox\";\n+        ArrayList coordinates = null;\n+        if (geoJsonAsMap.get(\"bbox\") != null) {\n+            type = \"Bbox\";", "originalCommit": "fbf52b2065b3e1e9fb972ab20ae854033369329a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDk4MjgyMw==", "url": "https://github.com/geotools/geotools/pull/3161#discussion_r500982823", "bodyText": "Fixed", "author": "turingtestfail", "createdAt": "2020-10-07T12:46:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDc1MzQyOQ=="}], "type": "inlineReview", "revised_code": {"commit": "2eec49ec9f447bdbce254b6ba281dfa73cfd0769", "chunk": "diff --git a/modules/unsupported/cql-json/src/main/java/org/geotools/filter/text/cqljson/MapToOpenGISGeomUtil.java b/modules/unsupported/cql-json/src/main/java/org/geotools/filter/text/cqljson/MapToOpenGISGeomUtil.java\nindex 37c52c67be..d408aece76 100644\n--- a/modules/unsupported/cql-json/src/main/java/org/geotools/filter/text/cqljson/MapToOpenGISGeomUtil.java\n+++ b/modules/unsupported/cql-json/src/main/java/org/geotools/filter/text/cqljson/MapToOpenGISGeomUtil.java\n\n@@ -55,7 +55,6 @@ public class MapToOpenGISGeomUtil {\n         String type = \"Bbox\";\n         ArrayList coordinates = null;\n         if (geoJsonAsMap.get(\"bbox\") != null) {\n-            type = \"Bbox\";\n             coordinates = (ArrayList<Double>) geoJsonAsMap.get(\"bbox\");\n         } else {\n             type = (String) geoJsonAsMap.get(\"type\");\n"}}, {"oid": "2eec49ec9f447bdbce254b6ba281dfa73cfd0769", "url": "https://github.com/geotools/geotools/commit/2eec49ec9f447bdbce254b6ba281dfa73cfd0769", "message": "fixed hardcoded versions and redundant bbox assignment", "committedDate": "2020-10-07T12:46:04Z", "type": "commit"}]}