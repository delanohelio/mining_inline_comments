{"pr_number": 3118, "pr_title": "[GEOT-6682] WFS 2.0 GetFeature reponse parsing fails on \"boundedBy\"", "pr_createdAt": "2020-08-20T09:51:47Z", "pr_url": "https://github.com/geotools/geotools/pull/3118", "timeline": [{"oid": "927c50eb2dd0e0d20d536f9decc13faf80f548bc", "url": "https://github.com/geotools/geotools/commit/927c50eb2dd0e0d20d536f9decc13faf80f548bc", "message": "[GEOT-6682] WFS 2.0 GetFeature reponse parsing fails on \"boundedBy\"", "committedDate": "2020-08-20T09:48:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzA1NDU3MQ==", "url": "https://github.com/geotools/geotools/pull/3118#discussion_r477054571", "bodyText": "Q: What is it getting back that is not an EnvelopePropertyType?", "author": "jodygarnett", "createdAt": "2020-08-26T06:06:00Z", "path": "modules/ogc/net.opengis.wfs/src/net/opengis/wfs20/impl/SimpleFeatureCollectionTypeImpl.java", "diffHunk": "@@ -178,7 +178,7 @@ public Object eGet(int featureID, boolean resolve, boolean coreType) {\n     public void eSet(int featureID, Object newValue) {\n     switch (featureID) {\n       case Wfs20Package.SIMPLE_FEATURE_COLLECTION_TYPE__BOUNDED_BY:\n-        setBoundedBy((EnvelopePropertyType)newValue);\n+        setBoundedBy(newValue instanceof EnvelopePropertyType ? (EnvelopePropertyType) newValue : null);", "originalCommit": "927c50eb2dd0e0d20d536f9decc13faf80f548bc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzA1NTc0Mg==", "url": "https://github.com/geotools/geotools/pull/3118#discussion_r477055742", "bodyText": "I see, it is explicitly allowed to be null:\n<complexType name=\"BoundingShapeType\">\n  <sequence>\n    <choice>\n      <element ref=\"gml:Envelope\"/>\n      <element ref=\"gml:Null\"/>\n    </choice>\n  </sequence>\n  <attribute name=\"nilReason\" type=\"gml:NilReasonType\"/>\n</complexType>", "author": "jodygarnett", "createdAt": "2020-08-26T06:09:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzA1NDU3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzA2MzUzNw==", "url": "https://github.com/geotools/geotools/pull/3118#discussion_r477063537", "bodyText": "Q: What is it getting back that is not an EnvelopePropertyType?\n\nHi Jody, it get an empty String, because the parsing failed.", "author": "awaterme", "createdAt": "2020-08-26T06:29:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzA1NDU3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzA2NDIzNA==", "url": "https://github.com/geotools/geotools/pull/3118#discussion_r477064234", "bodyText": "I see, it is explicitly allowed to be null:\n<complexType name=\"BoundingShapeType\">\n  <sequence>\n    <choice>\n      <element ref=\"gml:Envelope\"/>\n      <element ref=\"gml:Null\"/>\n    </choice>\n  </sequence>\n  <attribute name=\"nilReason\" type=\"gml:NilReasonType\"/>\n</complexType>\n\n\nWhen I look into the actual schema (http://schemas.opengis.net/wfs/2.0/wfs.xsd) I see the following:\n\nAre GeoTools using this schema?\nI think the problem is the \"any\" type...", "author": "awaterme", "createdAt": "2020-08-26T06:31:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzA1NDU3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDQxODAyMw==", "url": "https://github.com/geotools/geotools/pull/3118#discussion_r484418023", "bodyText": "GeoTools is using that schema. Being a schema driven parser, it might well be that its having problems when dealing with a \"any\" target, it probably does not know what bindings to use.\n@awaterme if you're interested, try adding a breakpoint in XSAnyTypeBinding and see if that's the one it is using to parse stuff.\n@nmco and @fernandor777 deal with this code more than I do, maybe they have a more educated guess as to what is happening.", "author": "aaime", "createdAt": "2020-09-07T12:59:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzA1NDU3MQ=="}], "type": "inlineReview", "revised_code": {"commit": "205ca90693af1e557a34de4fc16836f5f6ce9c65", "chunk": "diff --git a/modules/ogc/net.opengis.wfs/src/net/opengis/wfs20/impl/SimpleFeatureCollectionTypeImpl.java b/modules/ogc/net.opengis.wfs/src/net/opengis/wfs20/impl/SimpleFeatureCollectionTypeImpl.java\nindex 311c4ef44a..b318c39bba 100644\n--- a/modules/ogc/net.opengis.wfs/src/net/opengis/wfs20/impl/SimpleFeatureCollectionTypeImpl.java\n+++ b/modules/ogc/net.opengis.wfs/src/net/opengis/wfs20/impl/SimpleFeatureCollectionTypeImpl.java\n\n@@ -178,7 +178,7 @@ public class SimpleFeatureCollectionTypeImpl extends EObjectImpl implements Simp\n     public void eSet(int featureID, Object newValue) {\n     switch (featureID) {\n       case Wfs20Package.SIMPLE_FEATURE_COLLECTION_TYPE__BOUNDED_BY:\n-        setBoundedBy(newValue instanceof EnvelopePropertyType ? (EnvelopePropertyType) newValue : null);\n+        setBoundedBy((EnvelopePropertyType)newValue);\n         return;\n       case Wfs20Package.SIMPLE_FEATURE_COLLECTION_TYPE__MEMBER:\n         getMember().clear();\n"}}, {"oid": "205ca90693af1e557a34de4fc16836f5f6ce9c65", "url": "https://github.com/geotools/geotools/commit/205ca90693af1e557a34de4fc16836f5f6ce9c65", "message": "[GEOT-6682] WFS 2.0 GetFeature reponse parsing fails on \"boundedBy\"", "committedDate": "2020-09-14T07:05:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzgwNDg3NA==", "url": "https://github.com/geotools/geotools/pull/3118#discussion_r487804874", "bodyText": "All of these... they look like they should be constants, no?", "author": "aaime", "createdAt": "2020-09-14T10:18:43Z", "path": "modules/extension/xsd/xsd-wfs/src/main/java/org/geotools/wfs/v2_0/bindings/EnvelopePropertyTypeBinding.java", "diffHunk": "@@ -19,20 +19,41 @@\n import java.util.ArrayList;\n import java.util.List;\n import javax.xml.namespace.QName;\n+import net.opengis.wfs20.EnvelopePropertyType;\n+import net.opengis.wfs20.Wfs20Factory;\n+import net.opengis.wfs20.Wfs20Package;\n+import org.eclipse.emf.ecore.EAttribute;\n+import org.eclipse.emf.ecore.EClass;\n+import org.eclipse.emf.ecore.EcoreFactory;\n+import org.eclipse.emf.ecore.util.FeatureMap;\n+import org.eclipse.emf.ecore.util.FeatureMap.Entry;\n+import org.eclipse.emf.ecore.util.FeatureMapUtil;\n import org.eclipse.xsd.XSDElementDeclaration;\n import org.geotools.geometry.jts.ReferencedEnvelope;\n import org.geotools.gml3.v3_2.GML;\n import org.geotools.wfs.v2_0.WFS;\n import org.geotools.xsd.AbstractComplexBinding;\n+import org.geotools.xsd.ElementInstance;\n+import org.geotools.xsd.Node;\n \n public class EnvelopePropertyTypeBinding extends AbstractComplexBinding {\n \n+    private Class<ReferencedEnvelope> referencedEnvelopeClass = ReferencedEnvelope.class;", "originalCommit": "205ca90693af1e557a34de4fc16836f5f6ce9c65", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzgxMDM5OA==", "url": "https://github.com/geotools/geotools/pull/3118#discussion_r487810398", "bodyText": "Hi Andrea,\ncould be constants, but in that case on class loading of EnvelopePropertyTypeBinding the EMF Factories would also be bootstrapped. In my experience that sometimes causes trouble, maybe in testing scenarios, etc.\nOn the other hand I was not sure about the lifespan of the EnvelopePropertyTypeBinding. If it is created often, statics might make sense...\nAs you like. Let me know what you prefer please.\nBest regards,\nAndreas", "author": "awaterme", "createdAt": "2020-09-14T10:28:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzgwNDg3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzgxNjQxMg==", "url": "https://github.com/geotools/geotools/pull/3118#discussion_r487816412", "bodyText": "If memory serves me right, bindings are instantiated anew every time we parse or encode something. Each parse/encode gets its own dedicated Pico Container context, bindings are registered in there, every time. I'm not sure if they are just registered as classes, and then instantiated every time they are needed, or not. If it was the former, that would mean they get instantiated multiple times per parse/encode operation, too.", "author": "aaime", "createdAt": "2020-09-14T10:40:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzgwNDg3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzgxOTkwMw==", "url": "https://github.com/geotools/geotools/pull/3118#discussion_r487819903", "bodyText": "Do you prefer static fields then?", "author": "awaterme", "createdAt": "2020-09-14T10:47:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzgwNDg3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzgyMDIyOQ==", "url": "https://github.com/geotools/geotools/pull/3118#discussion_r487820229", "bodyText": "Personally I do, yes.", "author": "aaime", "createdAt": "2020-09-14T10:47:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzgwNDg3NA=="}], "type": "inlineReview", "revised_code": {"commit": "897b3332aaeec170140391e29ca3b4ab8d402240", "chunk": "diff --git a/modules/extension/xsd/xsd-wfs/src/main/java/org/geotools/wfs/v2_0/bindings/EnvelopePropertyTypeBinding.java b/modules/extension/xsd/xsd-wfs/src/main/java/org/geotools/wfs/v2_0/bindings/EnvelopePropertyTypeBinding.java\nindex 4e2e0e6883..e0791a5077 100644\n--- a/modules/extension/xsd/xsd-wfs/src/main/java/org/geotools/wfs/v2_0/bindings/EnvelopePropertyTypeBinding.java\n+++ b/modules/extension/xsd/xsd-wfs/src/main/java/org/geotools/wfs/v2_0/bindings/EnvelopePropertyTypeBinding.java\n\n@@ -38,16 +38,20 @@ import org.geotools.xsd.Node;\n \n public class EnvelopePropertyTypeBinding extends AbstractComplexBinding {\n \n-    private Class<ReferencedEnvelope> referencedEnvelopeClass = ReferencedEnvelope.class;\n-    private EClass newClass = EcoreFactory.eINSTANCE.createEClass();\n-    private EAttribute newAttribute = EcoreFactory.eINSTANCE.createEAttribute();\n-    private EAttribute anyAttribute = Wfs20Package.eINSTANCE.getEnvelopePropertyType_Any();\n+    private static Class<ReferencedEnvelope> referencedEnvelopeClass = ReferencedEnvelope.class;\n+    private static EClass newClass = EcoreFactory.eINSTANCE.createEClass();\n+    private static EAttribute newAttribute = EcoreFactory.eINSTANCE.createEAttribute();\n+    private static EAttribute anyAttribute = Wfs20Package.eINSTANCE.getEnvelopePropertyType_Any();\n \n-    public EnvelopePropertyTypeBinding() {\n+    static {\n         newClass.setInstanceClass(referencedEnvelopeClass);\n         newAttribute.setEType(newClass);\n     }\n \n+    public EnvelopePropertyTypeBinding() {\n+        super();\n+    }\n+\n     public QName getTarget() {\n         return WFS.EnvelopePropertyType;\n     }\n"}}, {"oid": "897b3332aaeec170140391e29ca3b4ab8d402240", "url": "https://github.com/geotools/geotools/commit/897b3332aaeec170140391e29ca3b4ab8d402240", "message": "[GEOT-6682] WFS 2.0 GetFeature reponse parsing fails on \"boundedBy\"", "committedDate": "2020-09-14T12:14:30Z", "type": "commit"}]}