{"pr_number": 2832, "pr_title": "GEOT-6529 Update Oracle JDBC driver", "pr_createdAt": "2020-03-09T13:40:39Z", "pr_url": "https://github.com/geotools/geotools/pull/2832", "timeline": [{"oid": "f9e479abbb5ee0d5089cabdd95a739c3456058ea", "url": "https://github.com/geotools/geotools/commit/f9e479abbb5ee0d5089cabdd95a739c3456058ea", "message": "WIP GEOT-6529 initial steps to update oracle driver", "committedDate": "2020-03-10T09:49:21Z", "type": "forcePushed"}, {"oid": "88726cd709eaa7b956f7cf5167059865dbe4db63", "url": "https://github.com/geotools/geotools/commit/88726cd709eaa7b956f7cf5167059865dbe4db63", "message": "Fix oracle STRUCT and ARRAY deprecation", "committedDate": "2020-03-12T13:51:15Z", "type": "forcePushed"}, {"oid": "525566de57500bb0f9945c95afa49a918db4069d", "url": "https://github.com/geotools/geotools/commit/525566de57500bb0f9945c95afa49a918db4069d", "message": "factor-out deprecated oracle.sql.StructDescriptor and fixup javadoc", "committedDate": "2020-03-12T14:54:42Z", "type": "forcePushed"}, {"oid": "3a5112aa60e8a3be6a798607142b22b90fe6cd6b", "url": "https://github.com/geotools/geotools/commit/3a5112aa60e8a3be6a798607142b22b90fe6cd6b", "message": "factor-out deprecated oracle.sql.StructDescriptor and fixup javadoc\n\nuse StringBuilder for improved performance\n\nIgnore  as even in plain SQL it seems to fail\n\nremove/cleanup deprecated ArrayDescriptor and StructDescriptor", "committedDate": "2020-03-16T14:16:23Z", "type": "forcePushed"}, {"oid": "b16fe7cccb1677432a4ec259c433926a6bb90add", "url": "https://github.com/geotools/geotools/commit/b16fe7cccb1677432a4ec259c433926a6bb90add", "message": "GEOT-6529 update oracle driver\n\nAlso factor out all Oracle deprecations, notably any use of:\n\n- oracle.sql.STRUCT\n- oracle.sql.ARRAY\n- oracle.sql.StructDescriptor\n- oracle.sql.ArrayDescriptor\n\nMake sure to use the proper driver classname, which is `oracle.jdbc.OracleDriver`,\nas well as some javadoc fixes and some replacement of StringBuffer by StringBuilder for improved performance.\n\nIgnore `Oracle3DOnlineTest#testBBOX3DOutsideLine()` as even in plain SQL it seems to fail", "committedDate": "2020-03-17T11:32:00Z", "type": "forcePushed"}, {"oid": "cc675f159978e2635eb3f2a6958a5de2f4c17f2f", "url": "https://github.com/geotools/geotools/commit/cc675f159978e2635eb3f2a6958a5de2f4c17f2f", "message": "[GEOT-6529] Update Oracle JDBC driver\n\nAlso factor out all Oracle deprecations, notably any use of:\n\n- oracle.sql.STRUCT\n- oracle.sql.ARRAY\n- oracle.sql.StructDescriptor\n- oracle.sql.ArrayDescriptor\n\nMake sure to use the proper driver classname, which is `oracle.jdbc.OracleDriver`,\nas well as some javadoc fixes and some replacement of StringBuffer by StringBuilder for improved performance.\n\nIgnore `Oracle3DOnlineTest#testBBOX3DOutsideLine()` as even in plain SQL it seems to fail", "committedDate": "2020-03-17T12:31:08Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk0MDUyMg==", "url": "https://github.com/geotools/geotools/pull/2832#discussion_r393940522", "bodyText": "Can we correct the test? JTS does now support the Z and M parameters so it should finally be possible to make this work.", "author": "jodygarnett", "createdAt": "2020-03-17T20:10:36Z", "path": "modules/plugin/jdbc/jdbc-oracle/src/test/java/org/geotools/data/oracle/Oracle3DOnlineTest.java", "diffHunk": "@@ -32,5 +33,28 @@ protected JDBC3DTestSetup createTestSetup() {\n      * GEOT-4133\n      */\n     @Override\n-    public void testCreateSchemaAndInsertPolyRectangle() throws Exception {}\n+    public void testCreateSchemaAndInsertPolyRectangle() {}\n+\n+    /**\n+     * This test does not work in Oracle, not even in SQL.", "originalCommit": "cc675f159978e2635eb3f2a6958a5de2f4c17f2f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDI1MDU0NQ==", "url": "https://github.com/geotools/geotools/pull/2832#discussion_r394250545", "bodyText": "I'll take another look at this, I think SDOSqlDumper only ever outputs 2D SDO geometries; but I'm not sure that is used or that GeometryConverter is used which should output 3D geometries (apart from Rectangle which seems a requirement for SDO filters - this may of course have changed), see:\n\n  \n    \n      geotools/modules/plugin/jdbc/jdbc-oracle/src/main/java/org/geotools/data/oracle/sdo/GeometryConverter.java\n    \n    \n        Lines 161 to 182\n      in\n      ff084ef\n    \n    \n    \n    \n\n        \n          \n           if (env.getWidth() > 0 \n        \n\n        \n          \n                   && env.getHeight() > 0 \n        \n\n        \n          \n                   && !(geom instanceof GeometryCollection) \n        \n\n        \n          \n                   && geom.isRectangle()) { \n        \n\n        \n          \n               // rectangle optimization. Actually, more than an optimization. A few operators \n        \n\n        \n          \n               // do not work properly if they don't get rectangular geoms encoded as rectangles \n        \n\n        \n          \n               // SDO_FILTER is an example of this silly situation \n        \n\n        \n          \n               SDO_POINT = null; \n        \n\n        \n          \n               int elemInfo[] = new int[] {1, 1003, 3}; \n        \n\n        \n          \n               double ordinates[]; \n        \n\n        \n          \n               if (SDO.D(geom) == 2) \n        \n\n        \n          \n                   ordinates = \n        \n\n        \n          \n                           new double[] { \n        \n\n        \n          \n                               env.getMinX(), env.getMinY(), env.getMaxX(), env.getMaxY() \n        \n\n        \n          \n                           }; \n        \n\n        \n          \n               else \n        \n\n        \n          \n                   ordinates = \n        \n\n        \n          \n                           new double[] { \n        \n\n        \n          \n                               env.getMinX(), env.getMinY(), 0, env.getMaxX(), env.getMaxY(), 0 \n        \n\n        \n          \n                           }; \n        \n\n        \n          \n            \n        \n\n        \n          \n               SDO_POINT = null;", "author": "mprins", "createdAt": "2020-03-18T10:38:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk0MDUyMg=="}], "type": "inlineReview", "revised_code": {"commit": "d1d73472a6430caa099ca9176ca88f33cc65c6b7", "chunk": "diff --git a/modules/plugin/jdbc/jdbc-oracle/src/test/java/org/geotools/data/oracle/Oracle3DOnlineTest.java b/modules/plugin/jdbc/jdbc-oracle/src/test/java/org/geotools/data/oracle/Oracle3DOnlineTest.java\nindex d716393229..5a183abc70 100644\n--- a/modules/plugin/jdbc/jdbc-oracle/src/test/java/org/geotools/data/oracle/Oracle3DOnlineTest.java\n+++ b/modules/plugin/jdbc/jdbc-oracle/src/test/java/org/geotools/data/oracle/Oracle3DOnlineTest.java\n\n@@ -28,33 +27,41 @@ public class Oracle3DOnlineTest extends JDBC3DOnlineTest {\n     }\n \n     /**\n-     * This test is overriden to disable it, since it is a known issue. The issue is that the Oracle\n-     * driver writes Rectangles as Oracle SDO Rectangle structures, which don't preserve 3D See\n-     * GEOT-4133\n+     * This test is overridden to disable it, since it is a known issue. The issue is that the\n+     * Oracle driver writes Rectangles as Oracle SDO Rectangle structures, which don't preserve 3D\n+     * See GEOT-4133\n      */\n     @Override\n     public void testCreateSchemaAndInsertPolyRectangle() {}\n \n     /**\n-     * This test does not work in Oracle, not even in SQL.\n+     * This test does not work in Oracle, not even using plain SQL. Override to disable. see\n+     * https://osgeo-org.atlassian.net/browse/GEOT-6534 GEOT-6534\n+     *\n+     * <p>It sends the following 2D query to the database:\n      *\n      * <pre>{@code\n-     * SELECT A.* FROM LINE3D A\n-     *   WHERE sdo_filter(\n-     *      A.GEOM,\n-     *      SDO_geometry( 3003, 4326, NULL, SDO_elem_info_array( 1, 1003, 3 ), SDO_ordinate_array( 2, 1, 100, 3, 2, 101 ) )\n-     *   ) = 'TRUE';\n+     * SELECT count(*) FROM GEOTOOLS.LINE3D\n+     * WHERE SDO_RELATE(\n+     * GEOM,\n+     * MDSYS.SDO_GEOMETRY(2003,4326,NULL,MDSYS.SDO_ELEM_INFO_ARRAY(1,1003,3),MDSYS.SDO_ORDINATE_ARRAY(2.0,1.0,3.0,2.0)),\n+     * 'mask=anyinteract querytype=WINDOW'\n+     * ) = 'TRUE'\n      * }</pre>\n      *\n      * returns 2 (==all) records and not 0 as the test expects.\n+     *\n+     * <p>But even eseding a 3D select window will still fail:\n+     *\n+     * <pre>{@code\n+     * SELECT count(*) FROM GEOTOOLS.LINE3D\n+     * WHERE SDO_RELATE(\n+     * GEOM,\n+     * MDSYS.SDO_GEOMETRY(3003,4326,NULL,MDSYS.SDO_ELEM_INFO_ARRAY(1,1003,3),MDSYS.SDO_ORDINATE_ARRAY(2.0,1.0,100.0,3.0,2.0,101.0)),\n+     * 'mask=anyinteract querytype=WINDOW'\n+     * ) = 'TRUE'\n+     * }</pre>\n      */\n     @Override\n-    public void testBBOX3DOutsideLine() throws IOException {\n-        // copied from superclass\n-        // a bbox 3d well outside the line footprint\n-        // BBOX3D bbox3d = FF.bbox(\"\", new ReferencedEnvelope3D(2, 3, 1, 2, 100, 101, crs));\n-        // SimpleFeatureCollection fc =\n-        // dataStore.getFeatureSource(tname(getLine3d())).getFeatures(bbox3d);\n-        // assertEquals(0, fc.size());\n-    }\n+    public void testBBOX3DOutsideLine() {}\n }\n"}}, {"oid": "28f9001e452261b2d637c26537ef70ecdd674a0c", "url": "https://github.com/geotools/geotools/commit/28f9001e452261b2d637c26537ef70ecdd674a0c", "message": "[GEOT-6529] Update Oracle JDBC driver\n\nAlso factor out all Oracle deprecations, notably any use of:\n\n- oracle.sql.STRUCT\n- oracle.sql.ARRAY\n- oracle.sql.StructDescriptor\n- oracle.sql.ArrayDescriptor\n\nMake sure to use the proper driver classname, which is `oracle.jdbc.OracleDriver`,\nas well as some javadoc fixes and some replacement of StringBuffer by StringBuilder for improved performance.\n\nIgnore `Oracle3DOnlineTest#testBBOX3DOutsideLine()` as even in plain SQL it seems to fail\n\nAdd a note to use the proper oracle driver class name in the upgrade notes", "committedDate": "2020-03-18T10:41:11Z", "type": "forcePushed"}, {"oid": "d1d73472a6430caa099ca9176ca88f33cc65c6b7", "url": "https://github.com/geotools/geotools/commit/d1d73472a6430caa099ca9176ca88f33cc65c6b7", "message": "[GEOT-6529] Update Oracle JDBC driver\n\nAlso factor out all Oracle deprecations, notably any use of:\n\n- oracle.sql.STRUCT\n- oracle.sql.ARRAY\n- oracle.sql.StructDescriptor\n- oracle.sql.ArrayDescriptor\n\nMake sure to use the proper driver classname, which is `oracle.jdbc.OracleDriver`,\nas well as some javadoc fixes and some replacement of StringBuffer by StringBuilder for improved performance.\n\nIgnore `Oracle3DOnlineTest#testBBOX3DOutsideLine()` as even in plain SQL it seems to fail\n\nAdd a note to use the proper oracle driver class name in the upgrade notes", "committedDate": "2020-03-19T09:38:00Z", "type": "forcePushed"}, {"oid": "68fd4ad0a2314deeb5e18bc86abeb85c4e8c3df5", "url": "https://github.com/geotools/geotools/commit/68fd4ad0a2314deeb5e18bc86abeb85c4e8c3df5", "message": "[GEOT-6529] Update Oracle JDBC driver\n\nAlso factor out all Oracle deprecations, notably any use of:\n\n- oracle.sql.STRUCT\n- oracle.sql.ARRAY\n- oracle.sql.StructDescriptor\n- oracle.sql.ArrayDescriptor\n\nMake sure to use the proper driver classname, which is `oracle.jdbc.OracleDriver`,\nas well as some javadoc fixes and some replacement of StringBuffer by StringBuilder for improved performance.\n\nIgnore `Oracle3DOnlineTest#testBBOX3DOutsideLine()` as even in plain SQL it seems to fail\n\nAdd a note to use the proper oracle driver class name in the upgrade notes\n\nRemove no longer useful user instructions for getting the oracle driver", "committedDate": "2020-04-15T07:03:51Z", "type": "forcePushed"}, {"oid": "8946eda1c14f94bf580f329c18ddc06e968b1874", "url": "https://github.com/geotools/geotools/commit/8946eda1c14f94bf580f329c18ddc06e968b1874", "message": "[GEOT-6529] Update Oracle JDBC driver\n\nAlso factor out all Oracle deprecations, notably any use of:\n\n- oracle.sql.STRUCT\n- oracle.sql.ARRAY\n- oracle.sql.StructDescriptor\n- oracle.sql.ArrayDescriptor\n\nMake sure to use the proper driver classname, which is `oracle.jdbc.OracleDriver`,\nas well as some javadoc fixes and some replacement of StringBuffer by StringBuilder for improved performance.\n\nIgnore `Oracle3DOnlineTest#testBBOX3DOutsideLine()` as even in plain SQL it seems to fail\n\nAdd a note to use the proper oracle driver class name in the upgrade notes\n\nRemove no longer useful user instructions for getting the oracle driver", "committedDate": "2020-04-21T13:40:45Z", "type": "forcePushed"}, {"oid": "75c042abff9a341416106c8751bf5ff6b835f0ff", "url": "https://github.com/geotools/geotools/commit/75c042abff9a341416106c8751bf5ff6b835f0ff", "message": "[GEOT-6529] Update Oracle JDBC driver\n\nAlso factor out all Oracle deprecations, notably any use of:\n\n- oracle.sql.STRUCT\n- oracle.sql.ARRAY\n- oracle.sql.StructDescriptor\n- oracle.sql.ArrayDescriptor\n\nMake sure to use the proper driver classname, which is `oracle.jdbc.OracleDriver`,\nas well as some javadoc fixes and some replacement of StringBuffer by StringBuilder for improved performance.\n\nIgnore `Oracle3DOnlineTest#testBBOX3DOutsideLine()` as even in plain SQL it seems to fail\n\nAdd a note to use the proper oracle driver class name in the upgrade notes\n\nRemove no longer useful user instructions for getting the oracle driver", "committedDate": "2020-04-23T10:42:43Z", "type": "commit"}, {"oid": "75c042abff9a341416106c8751bf5ff6b835f0ff", "url": "https://github.com/geotools/geotools/commit/75c042abff9a341416106c8751bf5ff6b835f0ff", "message": "[GEOT-6529] Update Oracle JDBC driver\n\nAlso factor out all Oracle deprecations, notably any use of:\n\n- oracle.sql.STRUCT\n- oracle.sql.ARRAY\n- oracle.sql.StructDescriptor\n- oracle.sql.ArrayDescriptor\n\nMake sure to use the proper driver classname, which is `oracle.jdbc.OracleDriver`,\nas well as some javadoc fixes and some replacement of StringBuffer by StringBuilder for improved performance.\n\nIgnore `Oracle3DOnlineTest#testBBOX3DOutsideLine()` as even in plain SQL it seems to fail\n\nAdd a note to use the proper oracle driver class name in the upgrade notes\n\nRemove no longer useful user instructions for getting the oracle driver", "committedDate": "2020-04-23T10:42:43Z", "type": "forcePushed"}]}