{"pr_number": 2914, "pr_title": "[GEOT-6579]: added array filter function, that can be used to create \u2026", "pr_createdAt": "2020-05-04T15:40:05Z", "pr_url": "https://github.com/geotools/geotools/pull/2914", "timeline": [{"oid": "7e490e2ac5f49181e4f8143157eb3dae6324009d", "url": "https://github.com/geotools/geotools/commit/7e490e2ac5f49181e4f8143157eb3dae6324009d", "message": "[GEOT-6579]: added array filter function, that can be used to create array literals in ECQL filters", "committedDate": "2020-05-04T15:53:30Z", "type": "commit"}, {"oid": "7e490e2ac5f49181e4f8143157eb3dae6324009d", "url": "https://github.com/geotools/geotools/commit/7e490e2ac5f49181e4f8143157eb3dae6324009d", "message": "[GEOT-6579]: added array filter function, that can be used to create array literals in ECQL filters", "committedDate": "2020-05-04T15:53:30Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTkwMjY5Mw==", "url": "https://github.com/geotools/geotools/pull/2914#discussion_r419902693", "bodyText": "public class javadoc", "author": "jodygarnett", "createdAt": "2020-05-05T07:04:05Z", "path": "modules/library/main/src/main/java/org/geotools/filter/function/ArrayFunction.java", "diffHunk": "@@ -0,0 +1,41 @@\n+/*\n+ *    GeoTools - The Open Source Java GIS Toolkit\n+ *    http://geotools.org\n+ *\n+ *    (C) 2020, Open Source Geospatial Foundation (OSGeo)\n+ *\n+ *    This library is free software; you can redistribute it and/or\n+ *    modify it under the terms of the GNU Lesser General Public\n+ *    License as published by the Free Software Foundation;\n+ *    version 2.1 of the License.\n+ *\n+ *    This library is distributed in the hope that it will be useful,\n+ *    but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ *    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n+ *    Lesser General Public License for more details.\n+ */\n+package org.geotools.filter.function;\n+\n+import static org.geotools.filter.capability.FunctionNameImpl.parameter;\n+\n+import org.geotools.filter.FunctionExpressionImpl;\n+import org.geotools.filter.capability.FunctionNameImpl;\n+import org.opengis.filter.capability.FunctionName;\n+\n+public class ArrayFunction extends FunctionExpressionImpl {", "originalCommit": "7e490e2ac5f49181e4f8143157eb3dae6324009d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "80e110285aad4c980784fa02c1ef1834c7861ab7", "chunk": "diff --git a/modules/library/main/src/main/java/org/geotools/filter/function/ArrayFunction.java b/modules/library/main/src/main/java/org/geotools/filter/function/ArrayFunction.java\nindex fcb2210e82..d9943ae085 100644\n--- a/modules/library/main/src/main/java/org/geotools/filter/function/ArrayFunction.java\n+++ b/modules/library/main/src/main/java/org/geotools/filter/function/ArrayFunction.java\n\n@@ -22,6 +22,11 @@ import org.geotools.filter.FunctionExpressionImpl;\n import org.geotools.filter.capability.FunctionNameImpl;\n import org.opengis.filter.capability.FunctionName;\n \n+/**\n+ * Array creator function. Evaluates all the arguments in order and creates an array from them.\n+ *\n+ * @author mauro.bartolomeoli at geo-solutions.it\n+ */\n public class ArrayFunction extends FunctionExpressionImpl {\n \n     public static FunctionName NAME =\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTkwMzQyNw==", "url": "https://github.com/geotools/geotools/pull/2914#discussion_r419903427", "bodyText": "This looks great, is it worth checking for null here (returned when converters cannot make the conversion) or do you want to just let it ride?", "author": "jodygarnett", "createdAt": "2020-05-05T07:05:49Z", "path": "modules/library/main/src/main/java/org/geotools/data/util/ArrayConverterFactory.java", "diffHunk": "@@ -55,4 +58,18 @@ public Converter createConverter(Class<?> source, Class<?> target, Hints hints)\n             return (T) result;\n         }\n     }\n+\n+    private static class ArrayToArrayConverter implements Converter {\n+        @Override\n+        public <T> T convert(Object source, Class<T> target) throws Exception {\n+            int arrLength = Array.getLength(source);\n+            Class<?> elementType = target.getComponentType();\n+            Object result = Array.newInstance(elementType, arrLength);\n+\n+            for (int count = 0; count < arrLength; count++) {\n+                Array.set(result, count, Converters.convert(Array.get(source, count), elementType));", "originalCommit": "7e490e2ac5f49181e4f8143157eb3dae6324009d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTkzMTYxNg==", "url": "https://github.com/geotools/geotools/pull/2914#discussion_r419931616", "bodyText": "@jodygarnett good catch. I think we could check the source element, if it's null then set the target array element to null, if the source is not null and the converted is (error in conversion) we can return null for the whole target array (to notify a conversion error). What do you think?", "author": "mbarto", "createdAt": "2020-05-05T08:05:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTkwMzQyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDMwMjk1Mw==", "url": "https://github.com/geotools/geotools/pull/2914#discussion_r420302953", "bodyText": "Yes that is the correct approach.\nNote: We did experiment with returning exceptions for this kind of failure, but the resulting exceptions would end up user visible (resulting in confused unhappy complaints). We ended up with this return null approach which IMHO ends up being too silent on details ... a tradeoff.", "author": "jodygarnett", "createdAt": "2020-05-05T18:01:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTkwMzQyNw=="}], "type": "inlineReview", "revised_code": {"commit": "80e110285aad4c980784fa02c1ef1834c7861ab7", "chunk": "diff --git a/modules/library/main/src/main/java/org/geotools/data/util/ArrayConverterFactory.java b/modules/library/main/src/main/java/org/geotools/data/util/ArrayConverterFactory.java\nindex fa3f9a3a8b..5930c5db69 100644\n--- a/modules/library/main/src/main/java/org/geotools/data/util/ArrayConverterFactory.java\n+++ b/modules/library/main/src/main/java/org/geotools/data/util/ArrayConverterFactory.java\n\n@@ -67,7 +67,13 @@ public class ArrayConverterFactory implements ConverterFactory {\n             Object result = Array.newInstance(elementType, arrLength);\n \n             for (int count = 0; count < arrLength; count++) {\n-                Array.set(result, count, Converters.convert(Array.get(source, count), elementType));\n+                Object sourceElement = Array.get(source, count);\n+                Object converted = Converters.convert(sourceElement, elementType);\n+                if (sourceElement != null && converted == null) {\n+                    // error in conversion\n+                    return null;\n+                }\n+                Array.set(result, count, converted);\n             }\n             return (T) result;\n         }\n"}}, {"oid": "80e110285aad4c980784fa02c1ef1834c7861ab7", "url": "https://github.com/geotools/geotools/commit/80e110285aad4c980784fa02c1ef1834c7861ab7", "message": "[GEOT-6579] improved array to array convertion where there are null elements", "committedDate": "2020-05-05T08:28:30Z", "type": "commit"}]}