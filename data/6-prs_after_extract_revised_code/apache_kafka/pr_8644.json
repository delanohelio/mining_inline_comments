{"pr_number": 8644, "pr_title": "KAFKA-9313: Set `use_all_dns_ips` as the new default for `client.dns.lookup` (KIP-602)", "pr_createdAt": "2020-05-10T22:50:51Z", "pr_url": "https://github.com/apache/kafka/pull/8644", "timeline": [{"oid": "66a55922b4eee455df5035fb7dd18ffd8f225782", "url": "https://github.com/apache/kafka/commit/66a55922b4eee455df5035fb7dd18ffd8f225782", "message": "Make use.all.dns.ips as the default behaviour fir client.dns.lookup configuration", "committedDate": "2020-05-10T22:29:41Z", "type": "commit"}, {"oid": "2c205b970f6deb5cb4f0edeb4a8b86fc5af01c07", "url": "https://github.com/apache/kafka/commit/2c205b970f6deb5cb4f0edeb4a8b86fc5af01c07", "message": "Added use_first_dns_ips option for client.dns.lookup configuration", "committedDate": "2020-05-10T22:46:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDcyMTg3NQ==", "url": "https://github.com/apache/kafka/pull/8644#discussion_r430721875", "bodyText": "In the KIP this field is called use_first_dns_ip, I think it was agreed in the discussion to remove the s", "author": "mimaison", "createdAt": "2020-05-26T21:36:52Z", "path": "clients/src/main/java/org/apache/kafka/clients/ClientDnsLookup.java", "diffHunk": "@@ -22,7 +22,8 @@\n \n     DEFAULT(\"default\"),\n     USE_ALL_DNS_IPS(\"use_all_dns_ips\"),\n-    RESOLVE_CANONICAL_BOOTSTRAP_SERVERS_ONLY(\"resolve_canonical_bootstrap_servers_only\");\n+    RESOLVE_CANONICAL_BOOTSTRAP_SERVERS_ONLY(\"resolve_canonical_bootstrap_servers_only\"),\n+    USE_FIRST_DNS_IPS(\"use_first_dns_ips\");", "originalCommit": "2c205b970f6deb5cb4f0edeb4a8b86fc5af01c07", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTU3MTc1Ng==", "url": "https://github.com/apache/kafka/pull/8644#discussion_r431571756", "bodyText": "I edited the PR to include this change.", "author": "ijuma", "createdAt": "2020-05-28T04:15:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDcyMTg3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc2ODAwMg==", "url": "https://github.com/apache/kafka/pull/8644#discussion_r432768002", "bodyText": "@mimaison Based on @ijuma 's suggestion, I am not adding use_first_dns_ip. I am going to deprecate default as the value and make use_all_dns_ips as the default value.", "author": "badaiaqrandista", "createdAt": "2020-05-29T22:32:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDcyMTg3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc3Mjc2MA==", "url": "https://github.com/apache/kafka/pull/8644#discussion_r432772760", "bodyText": "I agree it makes sense to not introduce this new value. It's unfortunate the old value is called default but hopefully we'll remove it in the next major release.", "author": "mimaison", "createdAt": "2020-05-29T22:50:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDcyMTg3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU0Mzk4NQ==", "url": "https://github.com/apache/kafka/pull/8644#discussion_r433543985", "bodyText": "ok. resolving this conversation.", "author": "badaiaqrandista", "createdAt": "2020-06-01T23:38:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDcyMTg3NQ=="}], "type": "inlineReview", "revised_code": {"commit": "1ef422b904f276d883ffc5dd331988e712391748", "chunk": "diff --git a/clients/src/main/java/org/apache/kafka/clients/ClientDnsLookup.java b/clients/src/main/java/org/apache/kafka/clients/ClientDnsLookup.java\nindex ac067b8f19..197cb2f538 100644\n--- a/clients/src/main/java/org/apache/kafka/clients/ClientDnsLookup.java\n+++ b/clients/src/main/java/org/apache/kafka/clients/ClientDnsLookup.java\n\n@@ -23,7 +23,7 @@ public enum ClientDnsLookup {\n     DEFAULT(\"default\"),\n     USE_ALL_DNS_IPS(\"use_all_dns_ips\"),\n     RESOLVE_CANONICAL_BOOTSTRAP_SERVERS_ONLY(\"resolve_canonical_bootstrap_servers_only\"),\n-    USE_FIRST_DNS_IPS(\"use_first_dns_ips\");\n+    USE_FIRST_DNS_IP(\"use_first_dns_ip\");\n \n     private String clientDnsLookup;\n \n"}}, {"oid": "1ef422b904f276d883ffc5dd331988e712391748", "url": "https://github.com/apache/kafka/commit/1ef422b904f276d883ffc5dd331988e712391748", "message": "use_first_dns_ips -> use_first_dns_ip", "committedDate": "2020-05-28T04:13:18Z", "type": "commit"}, {"oid": "af17aa6c4c510bf6792b98e461ea493448639f50", "url": "https://github.com/apache/kafka/commit/af17aa6c4c510bf6792b98e461ea493448639f50", "message": "use_first_dns_ips -> use_first_dns_ip", "committedDate": "2020-05-28T04:14:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTU3NDQ1NQ==", "url": "https://github.com/apache/kafka/pull/8644#discussion_r431574455", "bodyText": "@badaiaqrandista We should replace this if/else with a switch statement so that we are forced to handle every case. That makes it easier to avoid issues if we add new elements to the enum. Also, can we please add tests?", "author": "ijuma", "createdAt": "2020-05-28T04:27:20Z", "path": "clients/src/main/java/org/apache/kafka/clients/ClientUtils.java", "diffHunk": "@@ -108,10 +108,11 @@ public static ChannelBuilder createChannelBuilder(AbstractConfig config, Time ti\n \n     static List<InetAddress> resolve(String host, ClientDnsLookup clientDnsLookup) throws UnknownHostException {\n         InetAddress[] addresses = InetAddress.getAllByName(host);\n-        if (ClientDnsLookup.USE_ALL_DNS_IPS == clientDnsLookup) {\n-            return filterPreferredAddresses(addresses);\n-        } else {\n+        if (ClientDnsLookup.USE_FIRST_DNS_IP == clientDnsLookup) {\n             return Collections.singletonList(addresses[0]);\n+        } else {\n+            // ClientDnsLookup.USE_ALL_DNS_IPS == clientDnsLookup || ClientDnsLookup.DEFAULT == clientDnsLookup\n+            return filterPreferredAddresses(addresses);\n         }", "originalCommit": "af17aa6c4c510bf6792b98e461ea493448639f50", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTU3NjAxNw==", "url": "https://github.com/apache/kafka/pull/8644#discussion_r431576017", "bodyText": "Btw, it seems that we are changing the behavior of RESOLVE_CANONICAL_BOOTSTRAP_SERVERS_ONLY as well, right? Before, we would only use the first DNS IP for that option in the non bootstrap path. It would be good to make that clear in the KIP.", "author": "ijuma", "createdAt": "2020-05-28T04:34:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTU3NDQ1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTYyMjUwNQ==", "url": "https://github.com/apache/kafka/pull/8644#discussion_r431622505", "bodyText": "Yes, you are correct. If client.dns.lookup=RESOLVE_CANONICAL_BOOTSTRAP_SERVERS_ONLY , then it will resolves the hostname to IP address using the default behaviour.", "author": "badaiaqrandista", "createdAt": "2020-05-28T07:02:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTU3NDQ1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTk3NDIwOQ==", "url": "https://github.com/apache/kafka/pull/8644#discussion_r431974209", "bodyText": "I've changed this into switch/case and updated the KIP.", "author": "badaiaqrandista", "createdAt": "2020-05-28T16:38:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTU3NDQ1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjg2NDk4OQ==", "url": "https://github.com/apache/kafka/pull/8644#discussion_r432864989", "bodyText": "Can we remove the default since we handled all the cases?", "author": "ijuma", "createdAt": "2020-05-30T15:44:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTU3NDQ1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU0NzU2MQ==", "url": "https://github.com/apache/kafka/pull/8644#discussion_r433547561", "bodyText": "ok. will remove the default.", "author": "badaiaqrandista", "createdAt": "2020-06-01T23:51:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTU3NDQ1NQ=="}], "type": "inlineReview", "revised_code": {"commit": "bba054f9f07e9f7663695cfba356ab27d71655f0", "chunk": "diff --git a/clients/src/main/java/org/apache/kafka/clients/ClientUtils.java b/clients/src/main/java/org/apache/kafka/clients/ClientUtils.java\nindex 0de5d10183..2ebf869c42 100644\n--- a/clients/src/main/java/org/apache/kafka/clients/ClientUtils.java\n+++ b/clients/src/main/java/org/apache/kafka/clients/ClientUtils.java\n\n@@ -108,11 +108,15 @@ public final class ClientUtils {\n \n     static List<InetAddress> resolve(String host, ClientDnsLookup clientDnsLookup) throws UnknownHostException {\n         InetAddress[] addresses = InetAddress.getAllByName(host);\n-        if (ClientDnsLookup.USE_FIRST_DNS_IP == clientDnsLookup) {\n-            return Collections.singletonList(addresses[0]);\n-        } else {\n-            // ClientDnsLookup.USE_ALL_DNS_IPS == clientDnsLookup || ClientDnsLookup.DEFAULT == clientDnsLookup\n-            return filterPreferredAddresses(addresses);\n+        switch (clientDnsLookup) {\n+            case USE_FIRST_DNS_IP:\n+                return Collections.singletonList(addresses[0]);\n+            case DEFAULT:\n+            case USE_ALL_DNS_IPS:\n+            case RESOLVE_CANONICAL_BOOTSTRAP_SERVERS_ONLY:\n+                return filterPreferredAddresses(addresses);\n+            default:\n+                throw new ConfigException(\"Invalid client.dns.lookup value \" + clientDnsLookup.toString());\n         }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTU3NjE2NA==", "url": "https://github.com/apache/kafka/pull/8644#discussion_r431576164", "bodyText": "We said this would be deprecated for removal in 3.0. Let's mention that in the documentation and add a warning if this is selected.", "author": "ijuma", "createdAt": "2020-05-28T04:35:02Z", "path": "clients/src/main/java/org/apache/kafka/clients/ClientDnsLookup.java", "diffHunk": "@@ -22,7 +22,8 @@\n \n     DEFAULT(\"default\"),\n     USE_ALL_DNS_IPS(\"use_all_dns_ips\"),\n-    RESOLVE_CANONICAL_BOOTSTRAP_SERVERS_ONLY(\"resolve_canonical_bootstrap_servers_only\");\n+    RESOLVE_CANONICAL_BOOTSTRAP_SERVERS_ONLY(\"resolve_canonical_bootstrap_servers_only\"),\n+    USE_FIRST_DNS_IP(\"use_first_dns_ip\");", "originalCommit": "af17aa6c4c510bf6792b98e461ea493448639f50", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTU3NjMzNg==", "url": "https://github.com/apache/kafka/pull/8644#discussion_r431576336", "bodyText": "Thinking about it, maybe we should not add this at all. We could deprecate default and switch the config default to use_all_dns_ips. Thoughts @badaiaqrandista and @rajinisivaram?", "author": "ijuma", "createdAt": "2020-05-28T04:35:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTU3NjE2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTYyMTQ2OQ==", "url": "https://github.com/apache/kafka/pull/8644#discussion_r431621469", "bodyText": "I think that is a better idea, instead of introducing new value that would be removed soon.\nClientDnsLookup.DEFAULT is used in few places in core (server):\nhttps://github.com/apache/kafka/blob/trunk/core/src/main/scala/kafka/server/KafkaServer.scala#L520\nhttps://github.com/apache/kafka/blob/trunk/core/src/main/scala/kafka/server/ReplicaFetcherBlockingSend.scala#L92\nhttps://github.com/apache/kafka/blob/trunk/core/src/main/scala/kafka/controller/ControllerChannelManager.scala#L156\nhttps://github.com/apache/kafka/blob/trunk/core/src/main/scala/kafka/coordinator/transaction/TransactionMarkerChannelManager.scala#L82\nAnd a couple of tools:\nhttps://github.com/apache/kafka/blob/trunk/core/src/main/scala/kafka/tools/ReplicaVerificationTool.scala#L482\nhttps://github.com/apache/kafka/blob/trunk/core/src/main/scala/kafka/admin/BrokerApiVersionsCommand.scala#L299\nIt is also used literally in a lot of test cases under clients.\nI did not want to touch too many code in the first go. Should I change them all in this KIP or leave them until we remove ClientDnsLookup.DEFAULT in 3.0 ?", "author": "badaiaqrandista", "createdAt": "2020-05-28T07:00:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTU3NjE2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTk5MDk4MQ==", "url": "https://github.com/apache/kafka/pull/8644#discussion_r431990981", "bodyText": "@badaiaqrandista I think you should change it in the non test code in this PR. For the test code, we can do it in a separate PR.", "author": "ijuma", "createdAt": "2020-05-28T17:05:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTU3NjE2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc2NzQ2Ng==", "url": "https://github.com/apache/kafka/pull/8644#discussion_r432767466", "bodyText": "Ok. I have changed core code to use ClientDnsLookup.USE_ALL_DNS_IPS and leaving all clients tests except ClientUtilsTest.", "author": "badaiaqrandista", "createdAt": "2020-05-29T22:30:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTU3NjE2NA=="}], "type": "inlineReview", "revised_code": {"commit": "482c578728ca62e335c3b5213aa8ae0f367e36b9", "chunk": "diff --git a/clients/src/main/java/org/apache/kafka/clients/ClientDnsLookup.java b/clients/src/main/java/org/apache/kafka/clients/ClientDnsLookup.java\nindex 197cb2f538..96d47c344a 100644\n--- a/clients/src/main/java/org/apache/kafka/clients/ClientDnsLookup.java\n+++ b/clients/src/main/java/org/apache/kafka/clients/ClientDnsLookup.java\n\n@@ -22,8 +22,7 @@ public enum ClientDnsLookup {\n \n     DEFAULT(\"default\"),\n     USE_ALL_DNS_IPS(\"use_all_dns_ips\"),\n-    RESOLVE_CANONICAL_BOOTSTRAP_SERVERS_ONLY(\"resolve_canonical_bootstrap_servers_only\"),\n-    USE_FIRST_DNS_IP(\"use_first_dns_ip\");\n+    RESOLVE_CANONICAL_BOOTSTRAP_SERVERS_ONLY(\"resolve_canonical_bootstrap_servers_only\");\n \n     private String clientDnsLookup;\n \n"}}, {"oid": "bba054f9f07e9f7663695cfba356ab27d71655f0", "url": "https://github.com/apache/kafka/commit/bba054f9f07e9f7663695cfba356ab27d71655f0", "message": "Added test, modified configuration doc, apply suggestions in PR", "committedDate": "2020-05-28T16:32:53Z", "type": "commit"}, {"oid": "723aea0f7f5181cc46e75d36a398308f6c54adde", "url": "https://github.com/apache/kafka/commit/723aea0f7f5181cc46e75d36a398308f6c54adde", "message": "Fixed conflict", "committedDate": "2020-05-28T16:34:46Z", "type": "commit"}, {"oid": "482c578728ca62e335c3b5213aa8ae0f367e36b9", "url": "https://github.com/apache/kafka/commit/482c578728ca62e335c3b5213aa8ae0f367e36b9", "message": "Modified to remove 'use_first_dns_ip' and deprecate 'default' value", "committedDate": "2020-05-29T02:17:56Z", "type": "commit"}, {"oid": "e862f7a4c8e8d09abb7c55b30696296d7d5ad899", "url": "https://github.com/apache/kafka/commit/e862f7a4c8e8d09abb7c55b30696296d7d5ad899", "message": "Modified all references to ClientDnsLookup.DEFAULT to ClientDnsLookup.USE_ALL_DNS_IPS", "committedDate": "2020-05-29T02:18:32Z", "type": "commit"}, {"oid": "620a61d2ce0a75aabbb5eb024dc21f15ecfcf3dc", "url": "https://github.com/apache/kafka/commit/620a61d2ce0a75aabbb5eb024dc21f15ecfcf3dc", "message": "Modified all references of ClientDnsLookup.DEFAULT to ClientDnsLookup.USE_ALL_DNS_IPS in all clients tests", "committedDate": "2020-05-29T03:53:18Z", "type": "commit"}, {"oid": "6c3163493c135f57ff1795881a0546e511d57971", "url": "https://github.com/apache/kafka/commit/6c3163493c135f57ff1795881a0546e511d57971", "message": "Fixed missing semicolon", "committedDate": "2020-05-29T05:23:33Z", "type": "commit"}, {"oid": "9f07b9d65c0c2267265b808aa1856fd2a986f6fd", "url": "https://github.com/apache/kafka/commit/9f07b9d65c0c2267265b808aa1856fd2a986f6fd", "message": "Modified all references of ClientDnsLookup.DEFAULT to ClientDnsLookup.USE_ALL_DNS_IPS in all clients tests", "committedDate": "2020-05-29T22:21:02Z", "type": "commit"}, {"oid": "2b39bd3855b68f039e3771dc0bc7eef6df19c44a", "url": "https://github.com/apache/kafka/commit/2b39bd3855b68f039e3771dc0bc7eef6df19c44a", "message": "Fixed missing semicolon", "committedDate": "2020-05-29T22:21:02Z", "type": "commit"}, {"oid": "fc2d33b4f48fe106608f311c3858068c434587a2", "url": "https://github.com/apache/kafka/commit/fc2d33b4f48fe106608f311c3858068c434587a2", "message": "Revert \"Modified all references of ClientDnsLookup.DEFAULT to ClientDnsLookup.USE_ALL_DNS_IPS in all clients tests\"\n\nThis reverts commit 9f07b9d65c0c2267265b808aa1856fd2a986f6fd.", "committedDate": "2020-05-29T22:23:03Z", "type": "commit"}, {"oid": "6bc9c06393a0807d709bad81cfd137815fe16f19", "url": "https://github.com/apache/kafka/commit/6bc9c06393a0807d709bad81cfd137815fe16f19", "message": "Merge branch 'KIP-602_make-use_all_dns_ips-as-default' of https://github.com/badaiaqrandista/kafka into KIP-602_make-use_all_dns_ips-as-default", "committedDate": "2020-05-29T22:23:26Z", "type": "commit"}, {"oid": "d2a882d11496a414fbb2913ffb8876d5ec0be12e", "url": "https://github.com/apache/kafka/commit/d2a882d11496a414fbb2913ffb8876d5ec0be12e", "message": "Revert \"Modified all references of ClientDnsLookup.DEFAULT to ClientDnsLookup.USE_ALL_DNS_IPS in all clients tests\"\n\nThis reverts commit 9f07b9d65c0c2267265b808aa1856fd2a986f6fd.", "committedDate": "2020-05-29T22:28:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjg2NDk0NQ==", "url": "https://github.com/apache/kafka/pull/8644#discussion_r432864945", "bodyText": "This will warn on every resolve. We should probably add the warning when we get the config value from ConsumerConfig, ProducerConfig and AdminClientConfig.", "author": "ijuma", "createdAt": "2020-05-30T15:44:03Z", "path": "clients/src/main/java/org/apache/kafka/clients/ClientUtils.java", "diffHunk": "@@ -108,10 +108,15 @@ public static ChannelBuilder createChannelBuilder(AbstractConfig config, Time ti\n \n     static List<InetAddress> resolve(String host, ClientDnsLookup clientDnsLookup) throws UnknownHostException {\n         InetAddress[] addresses = InetAddress.getAllByName(host);\n-        if (ClientDnsLookup.USE_ALL_DNS_IPS == clientDnsLookup) {\n-            return filterPreferredAddresses(addresses);\n-        } else {\n-            return Collections.singletonList(addresses[0]);\n+        switch (clientDnsLookup) {\n+            case DEFAULT:\n+                log.warn(\"Configuration 'client.dns.lookup' value 'default' is deprecated and will be removed in the future version.\");", "originalCommit": "d2a882d11496a414fbb2913ffb8876d5ec0be12e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU0NDIyNg==", "url": "https://github.com/apache/kafka/pull/8644#discussion_r433544226", "bodyText": "ok. will move the warn there.", "author": "badaiaqrandista", "createdAt": "2020-06-01T23:39:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjg2NDk0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE2ODQ4MQ==", "url": "https://github.com/apache/kafka/pull/8644#discussion_r434168481", "bodyText": "I'm adding the check and the warning to the constructor of KafkaProducer, KafkaConsumer and KafkaAdminClient because the log context does not exist in the Config classes.", "author": "badaiaqrandista", "createdAt": "2020-06-02T20:52:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjg2NDk0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDIwNDY5Mw==", "url": "https://github.com/apache/kafka/pull/8644#discussion_r434204693", "bodyText": "Nevermind. I've added the warning to Config classes.", "author": "badaiaqrandista", "createdAt": "2020-06-02T22:14:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjg2NDk0NQ=="}], "type": "inlineReview", "revised_code": {"commit": "44552780b0951d8403d6c39847da35b2606803d0", "chunk": "diff --git a/clients/src/main/java/org/apache/kafka/clients/ClientUtils.java b/clients/src/main/java/org/apache/kafka/clients/ClientUtils.java\nindex d69b970d2f..64839b68e1 100644\n--- a/clients/src/main/java/org/apache/kafka/clients/ClientUtils.java\n+++ b/clients/src/main/java/org/apache/kafka/clients/ClientUtils.java\n\n@@ -108,16 +108,19 @@ public final class ClientUtils {\n \n     static List<InetAddress> resolve(String host, ClientDnsLookup clientDnsLookup) throws UnknownHostException {\n         InetAddress[] addresses = InetAddress.getAllByName(host);\n+        List<InetAddress> returnedAddresses = null;\n+\n         switch (clientDnsLookup) {\n             case DEFAULT:\n-                log.warn(\"Configuration 'client.dns.lookup' value 'default' is deprecated and will be removed in the future version.\");\n-                return Collections.singletonList(addresses[0]);\n+                returnedAddresses = Collections.singletonList(addresses[0]);\n+                break;\n             case USE_ALL_DNS_IPS:\n             case RESOLVE_CANONICAL_BOOTSTRAP_SERVERS_ONLY:\n-                return filterPreferredAddresses(addresses);\n-            default:\n-                throw new ConfigException(\"Invalid client.dns.lookup value \" + clientDnsLookup.toString());\n+                returnedAddresses = filterPreferredAddresses(addresses);\n+                break;\n         }\n+\n+        return returnedAddresses;\n     }\n \n     static List<InetAddress> filterPreferredAddresses(InetAddress[] allAddresses) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjg2NTIyOA==", "url": "https://github.com/apache/kafka/pull/8644#discussion_r432865228", "bodyText": "Can we clarify that resolve_canonical_bootstrap_servers_only applies to the boostrap urls only. For advertised servers, both use_all_dns_ips and resolve_canonical_bootstrap_servers behave the same.", "author": "ijuma", "createdAt": "2020-05-30T15:48:06Z", "path": "clients/src/main/java/org/apache/kafka/clients/CommonClientConfigs.java", "diffHunk": "@@ -42,9 +42,11 @@\n                                                        + \"servers (you may want more than one, though, in case a server is down).\";\n \n     public static final String CLIENT_DNS_LOOKUP_CONFIG = \"client.dns.lookup\";\n-    public static final String CLIENT_DNS_LOOKUP_DOC = \"Controls how the client uses DNS lookups. If set to <code>use_all_dns_ips</code> then, when the lookup returns multiple IP addresses for a hostname,\"\n-                                                       + \" they will all be attempted to connect to before failing the connection. Applies to both bootstrap and advertised servers.\"\n-                                                       + \" If the value is <code>resolve_canonical_bootstrap_servers_only</code> each entry will be resolved and expanded into a list of canonical names.\";\n+    public static final String CLIENT_DNS_LOOKUP_DOC = \"Controls how the client uses DNS lookups.\"\n+                                                       + \" If set to <code>use_all_dns_ips</code>, attempt to connect to all IP addresses returned by the lookup and use the first one that connects successfully.\"\n+                                                       + \" If set to <code>default</code>, connect to the first IP address returned by the lookup, even if the lookup returns multiple IP addresses.\"\n+                                                       + \" If set to <code>resolve_canonical_bootstrap_servers_only</code>, each entry will be resolved and expanded into a list of canonical names.\"\n+                                                       + \" Note that <code>default</code> is deprecated and will be removed in future release.\";", "originalCommit": "d2a882d11496a414fbb2913ffb8876d5ec0be12e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE3MTU4OQ==", "url": "https://github.com/apache/kafka/pull/8644#discussion_r434171589", "bodyText": "Sorry, I do not understand why you are referring to \"advertised servers\". Instead, I have changed the explanation to clarify that this only applies \"if bootstrap hostname is an alias to multiple canonical names\".", "author": "badaiaqrandista", "createdAt": "2020-06-02T20:58:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjg2NTIyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE5NjkwMA==", "url": "https://github.com/apache/kafka/pull/8644#discussion_r434196900", "bodyText": "Each of these configs have an impact on bootstrap and advertized servers. So, we should be clear on what they do for each case.", "author": "ijuma", "createdAt": "2020-06-02T21:54:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjg2NTIyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDIyNzQ4Ng==", "url": "https://github.com/apache/kafka/pull/8644#discussion_r434227486", "bodyText": "Config doc updated.", "author": "badaiaqrandista", "createdAt": "2020-06-02T23:23:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjg2NTIyOA=="}], "type": "inlineReview", "revised_code": {"commit": "49972961968a6c55cc4c238e9d7aba758c9bfff4", "chunk": "diff --git a/clients/src/main/java/org/apache/kafka/clients/CommonClientConfigs.java b/clients/src/main/java/org/apache/kafka/clients/CommonClientConfigs.java\nindex 0e93270c61..af500aed1d 100644\n--- a/clients/src/main/java/org/apache/kafka/clients/CommonClientConfigs.java\n+++ b/clients/src/main/java/org/apache/kafka/clients/CommonClientConfigs.java\n\n@@ -44,8 +44,9 @@ public class CommonClientConfigs {\n     public static final String CLIENT_DNS_LOOKUP_CONFIG = \"client.dns.lookup\";\n     public static final String CLIENT_DNS_LOOKUP_DOC = \"Controls how the client uses DNS lookups.\"\n                                                        + \" If set to <code>use_all_dns_ips</code>, attempt to connect to all IP addresses returned by the lookup and use the first one that connects successfully.\"\n-                                                       + \" If set to <code>default</code>, connect to the first IP address returned by the lookup, even if the lookup returns multiple IP addresses.\"\n-                                                       + \" If set to <code>resolve_canonical_bootstrap_servers_only</code>, each entry will be resolved and expanded into a list of canonical names.\"\n+                                                       + \" If set to <code>default</code>, attempt to connect to the first IP address returned by the lookup, even if the lookup returns multiple IP addresses.\"\n+                                                       + \" If set to <code>resolve_canonical_bootstrap_servers_only</code>, will try to expand bootstrap hostname into a list of canonical names, if bootstrap hostname is an alias for multiple canonical names.\"\n+                                                       + \" And each canonical name will be resolved in the same way as <code>use_all_dns_ips</code>.\"\n                                                        + \" Note that <code>default</code> is deprecated and will be removed in future release.\";\n \n     public static final String METADATA_MAX_AGE_CONFIG = \"metadata.max.age.ms\";\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjg2NTI1Mg==", "url": "https://github.com/apache/kafka/pull/8644#discussion_r432865252", "bodyText": "Why do we need this change?", "author": "ijuma", "createdAt": "2020-05-30T15:48:36Z", "path": "clients/src/test/java/org/apache/kafka/clients/ClientUtilsTest.java", "diffHunk": "@@ -102,7 +102,7 @@ public void testResolveUnknownHostException() throws UnknownHostException {\n \n     @Test\n     public void testResolveDnsLookup() throws UnknownHostException {\n-        assertEquals(1, ClientUtils.resolve(\"localhost\", ClientDnsLookup.DEFAULT).size());\n+        assertEquals(1, ClientUtils.resolve(\"kafka.apache.org\", ClientDnsLookup.DEFAULT).size());", "originalCommit": "d2a882d11496a414fbb2913ffb8876d5ec0be12e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU0ODE0Mg==", "url": "https://github.com/apache/kafka/pull/8644#discussion_r433548142", "bodyText": "because kafka.apache.org resolves to 2 IP addresses. and I want to be sure that DEFAULT only returns 1 of them.\nlocalhost resolves to 1 IP address.", "author": "badaiaqrandista", "createdAt": "2020-06-01T23:53:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjg2NTI1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg4OTcxMw==", "url": "https://github.com/apache/kafka/pull/8644#discussion_r433889713", "bodyText": "Can you add a comment about this?", "author": "ijuma", "createdAt": "2020-06-02T13:49:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjg2NTI1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDIwOTY4OA==", "url": "https://github.com/apache/kafka/pull/8644#discussion_r434209688", "bodyText": "Added.", "author": "badaiaqrandista", "createdAt": "2020-06-02T22:28:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjg2NTI1Mg=="}], "type": "inlineReview", "revised_code": {"commit": "49972961968a6c55cc4c238e9d7aba758c9bfff4", "chunk": "diff --git a/clients/src/test/java/org/apache/kafka/clients/ClientUtilsTest.java b/clients/src/test/java/org/apache/kafka/clients/ClientUtilsTest.java\nindex 3fd8c199b3..ae5c435635 100644\n--- a/clients/src/test/java/org/apache/kafka/clients/ClientUtilsTest.java\n+++ b/clients/src/test/java/org/apache/kafka/clients/ClientUtilsTest.java\n\n@@ -97,21 +97,29 @@ public class ClientUtilsTest {\n \n     @Test(expected = UnknownHostException.class)\n     public void testResolveUnknownHostException() throws UnknownHostException {\n-        ClientUtils.resolve(\"some.invalid.hostname.foo.bar.local\", ClientDnsLookup.DEFAULT);\n+        ClientUtils.resolve(\"some.invalid.hostname.foo.bar.local\", ClientDnsLookup.USE_ALL_DNS_IPS);\n     }\n \n     @Test\n     public void testResolveDnsLookup() throws UnknownHostException {\n+        // kafka.apache.org resolves to 2 IP addresses. DEFAULT should only return the first one.\n         assertEquals(1, ClientUtils.resolve(\"kafka.apache.org\", ClientDnsLookup.DEFAULT).size());\n     }\n \n     @Test\n     public void testResolveDnsLookupAllIps() throws UnknownHostException {\n+        // kafka.apache.org resolves to 2 IP addresses. USE_ALL_DNS_IPS should return both addresses.\n         assertEquals(2, ClientUtils.resolve(\"kafka.apache.org\", ClientDnsLookup.USE_ALL_DNS_IPS).size());\n     }\n \n+    @Test\n+    public void testResolveDnsLookupResolveCanonicalBootstrapServers() throws UnknownHostException {\n+        // kafka.apache.org resolves to 2 IP addresses. RESOLVE_CANONICAL_BOOTSTRAP_SERVERS_ONLY should return both addresses, like USE_ALL_DNS_IPS.\n+        assertEquals(2, ClientUtils.resolve(\"kafka.apache.org\", ClientDnsLookup.RESOLVE_CANONICAL_BOOTSTRAP_SERVERS_ONLY).size());\n+    }\n+\n     private List<InetSocketAddress> checkWithoutLookup(String... url) {\n-        return ClientUtils.parseAndValidateAddresses(Arrays.asList(url), ClientDnsLookup.DEFAULT);\n+        return ClientUtils.parseAndValidateAddresses(Arrays.asList(url), ClientDnsLookup.USE_ALL_DNS_IPS);\n     }\n \n     private List<InetSocketAddress> checkWithLookup(List<String> url) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjg2NTM4MQ==", "url": "https://github.com/apache/kafka/pull/8644#discussion_r432865381", "bodyText": "Can we add a test that passes RESOLVE_CANONICAL_BOOTSTRAP_SERVERS_ONLY showing that we now get multiple addresses instead of only the first one. That's one of the changes in this PR.", "author": "ijuma", "createdAt": "2020-05-30T15:50:26Z", "path": "clients/src/main/java/org/apache/kafka/clients/ClientUtils.java", "diffHunk": "@@ -108,10 +108,15 @@ public static ChannelBuilder createChannelBuilder(AbstractConfig config, Time ti\n \n     static List<InetAddress> resolve(String host, ClientDnsLookup clientDnsLookup) throws UnknownHostException {\n         InetAddress[] addresses = InetAddress.getAllByName(host);\n-        if (ClientDnsLookup.USE_ALL_DNS_IPS == clientDnsLookup) {\n-            return filterPreferredAddresses(addresses);\n-        } else {\n-            return Collections.singletonList(addresses[0]);\n+        switch (clientDnsLookup) {\n+            case DEFAULT:\n+                log.warn(\"Configuration 'client.dns.lookup' value 'default' is deprecated and will be removed in the future version.\");\n+                return Collections.singletonList(addresses[0]);\n+            case USE_ALL_DNS_IPS:\n+            case RESOLVE_CANONICAL_BOOTSTRAP_SERVERS_ONLY:\n+                return filterPreferredAddresses(addresses);", "originalCommit": "d2a882d11496a414fbb2913ffb8876d5ec0be12e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDIwNDc2Nw==", "url": "https://github.com/apache/kafka/pull/8644#discussion_r434204767", "bodyText": "Added.", "author": "badaiaqrandista", "createdAt": "2020-06-02T22:14:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjg2NTM4MQ=="}], "type": "inlineReview", "revised_code": {"commit": "44552780b0951d8403d6c39847da35b2606803d0", "chunk": "diff --git a/clients/src/main/java/org/apache/kafka/clients/ClientUtils.java b/clients/src/main/java/org/apache/kafka/clients/ClientUtils.java\nindex d69b970d2f..64839b68e1 100644\n--- a/clients/src/main/java/org/apache/kafka/clients/ClientUtils.java\n+++ b/clients/src/main/java/org/apache/kafka/clients/ClientUtils.java\n\n@@ -108,16 +108,19 @@ public final class ClientUtils {\n \n     static List<InetAddress> resolve(String host, ClientDnsLookup clientDnsLookup) throws UnknownHostException {\n         InetAddress[] addresses = InetAddress.getAllByName(host);\n+        List<InetAddress> returnedAddresses = null;\n+\n         switch (clientDnsLookup) {\n             case DEFAULT:\n-                log.warn(\"Configuration 'client.dns.lookup' value 'default' is deprecated and will be removed in the future version.\");\n-                return Collections.singletonList(addresses[0]);\n+                returnedAddresses = Collections.singletonList(addresses[0]);\n+                break;\n             case USE_ALL_DNS_IPS:\n             case RESOLVE_CANONICAL_BOOTSTRAP_SERVERS_ONLY:\n-                return filterPreferredAddresses(addresses);\n-            default:\n-                throw new ConfigException(\"Invalid client.dns.lookup value \" + clientDnsLookup.toString());\n+                returnedAddresses = filterPreferredAddresses(addresses);\n+                break;\n         }\n+\n+        return returnedAddresses;\n     }\n \n     static List<InetAddress> filterPreferredAddresses(InetAddress[] allAddresses) {\n"}}, {"oid": "49972961968a6c55cc4c238e9d7aba758c9bfff4", "url": "https://github.com/apache/kafka/commit/49972961968a6c55cc4c238e9d7aba758c9bfff4", "message": "Moved deprecation warning to Config classes. Added test as per PR comment.", "committedDate": "2020-06-02T22:11:17Z", "type": "commit"}, {"oid": "44552780b0951d8403d6c39847da35b2606803d0", "url": "https://github.com/apache/kafka/commit/44552780b0951d8403d6c39847da35b2606803d0", "message": "Remove default case in ClientUtils#resolve and updated client.dns.lookup documentation", "committedDate": "2020-06-02T22:26:03Z", "type": "commit"}, {"oid": "d6847af9a77f487c45f031c979191849592f758a", "url": "https://github.com/apache/kafka/commit/d6847af9a77f487c45f031c979191849592f758a", "message": "Fixed conflict in ConsumerConfig class after merging with trunk", "committedDate": "2020-06-02T23:50:20Z", "type": "commit"}, {"oid": "1deb3223daa3f8b79b166828a72b3ee8b552dea0", "url": "https://github.com/apache/kafka/commit/1deb3223daa3f8b79b166828a72b3ee8b552dea0", "message": "Modified upgrade.html about new behaviour of client.dns.lookup configuration", "committedDate": "2020-06-03T00:08:03Z", "type": "commit"}, {"oid": "11277b29e23a3a128d04ae009b658963e00cc6e3", "url": "https://github.com/apache/kafka/commit/11277b29e23a3a128d04ae009b658963e00cc6e3", "message": "Merge remote-tracking branch 'apache-github/trunk' into KIP-602_make-use_all_dns_ips-as-default\n\n* apache-github/trunk:\n  KAFKA-9788; Use distinct names for transaction and group load time sensors (#8784)\n  KAFKA-9514; The protocol generator generated useless condition when a field is made nullable and flexible version is used (#8793)\n  MINOR: Update to Gradle 6.5 and tweak build jvm config (#8751)\n  MINOR: Upgrade spotbugs and spotbugsPlugin (#8790)\n  KAFKA-10089 The stale ssl engine factory is not closed after reconfigure (#8792)\n  KAFKA-10080; Fix race condition on txn completion which can cause duplicate appends (#8782)\n  KAFKA-10084: Fix EosTestDriver end offset (#8785)\n  KAFKA-10083: fix failed testReassignmentWithRandomSubscriptionsAndChanges tests (#8786)", "committedDate": "2020-06-04T02:01:41Z", "type": "commit"}, {"oid": "12fba36967687077979e23c3918b15cb1647f0fc", "url": "https://github.com/apache/kafka/commit/12fba36967687077979e23c3918b15cb1647f0fc", "message": "Various improvements", "committedDate": "2020-06-04T03:35:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTEyODUxNw==", "url": "https://github.com/apache/kafka/pull/8644#discussion_r435128517", "bodyText": "We don't need to call toString()", "author": "mimaison", "createdAt": "2020-06-04T09:46:28Z", "path": "clients/src/main/java/org/apache/kafka/clients/CommonClientConfigs.java", "diffHunk": "@@ -167,4 +176,13 @@\n         }\n         return rval;\n     }\n+\n+    public static void warnIfDeprecatedDnsLookupValue(AbstractConfig config) {\n+        String clientDnsLookupValue = config.getString(CLIENT_DNS_LOOKUP_CONFIG);\n+        if (clientDnsLookupValue.equals(ClientDnsLookup.DEFAULT.toString()))\n+            log.warn(\"Configuration '{}' with value '{}' is deprecated and will be removed in \" +\n+                \"future version. Please use '{}' or another non-deprecated value.\",\n+                CLIENT_DNS_LOOKUP_CONFIG, ClientDnsLookup.DEFAULT.toString(),", "originalCommit": "12fba36967687077979e23c3918b15cb1647f0fc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTE3OTQ5NQ==", "url": "https://github.com/apache/kafka/pull/8644#discussion_r435179495", "bodyText": "Done.", "author": "badaiaqrandista", "createdAt": "2020-06-04T11:20:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTEyODUxNw=="}], "type": "inlineReview", "revised_code": {"commit": "df0302628a9211c8e628e70e57a2788e4a92fa45", "chunk": "diff --git a/clients/src/main/java/org/apache/kafka/clients/CommonClientConfigs.java b/clients/src/main/java/org/apache/kafka/clients/CommonClientConfigs.java\nindex acd29eceb7..22984db94a 100644\n--- a/clients/src/main/java/org/apache/kafka/clients/CommonClientConfigs.java\n+++ b/clients/src/main/java/org/apache/kafka/clients/CommonClientConfigs.java\n\n@@ -182,7 +182,7 @@ public class CommonClientConfigs {\n         if (clientDnsLookupValue.equals(ClientDnsLookup.DEFAULT.toString()))\n             log.warn(\"Configuration '{}' with value '{}' is deprecated and will be removed in \" +\n                 \"future version. Please use '{}' or another non-deprecated value.\",\n-                CLIENT_DNS_LOOKUP_CONFIG, ClientDnsLookup.DEFAULT.toString(),\n+                CLIENT_DNS_LOOKUP_CONFIG, ClientDnsLookup.DEFAULT,\n                 ClientDnsLookup.USE_ALL_DNS_IPS);\n     }\n }\n"}}, {"oid": "df0302628a9211c8e628e70e57a2788e4a92fa45", "url": "https://github.com/apache/kafka/commit/df0302628a9211c8e628e70e57a2788e4a92fa45", "message": "Remove toString()", "committedDate": "2020-06-04T11:20:02Z", "type": "commit"}]}