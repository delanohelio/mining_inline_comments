{"pr_number": 8111, "pr_title": "KAFKA-9206: throw a KafkaException when encountering CORRUPT_MESSAGE", "pr_createdAt": "2020-02-13T19:58:39Z", "pr_url": "https://github.com/apache/kafka/pull/8111", "timeline": [{"oid": "efa1736c7340b8f81ff7c60ef05fd8ad33c4fd20", "url": "https://github.com/apache/kafka/commit/efa1736c7340b8f81ff7c60ef05fd8ad33c4fd20", "message": "KAFKA-9206: throw a KafkaException when encountering `CORRUPT_MESSAGE` after a fetch", "committedDate": "2020-02-14T21:35:48Z", "type": "commit"}, {"oid": "969295daf0b277c7c33092ca31953fdd233863e6", "url": "https://github.com/apache/kafka/commit/969295daf0b277c7c33092ca31953fdd233863e6", "message": "nit: formatting", "committedDate": "2020-02-14T21:53:06Z", "type": "commit"}, {"oid": "a58e1be8f9c09937fab1182af62450ea38310d10", "url": "https://github.com/apache/kafka/commit/a58e1be8f9c09937fab1182af62450ea38310d10", "message": "added test", "committedDate": "2020-02-14T21:53:30Z", "type": "commit"}, {"oid": "a58e1be8f9c09937fab1182af62450ea38310d10", "url": "https://github.com/apache/kafka/commit/a58e1be8f9c09937fab1182af62450ea38310d10", "message": "added test", "committedDate": "2020-02-14T21:53:30Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY3MDA3NA==", "url": "https://github.com/apache/kafka/pull/8111#discussion_r379670074", "bodyText": "nit: just calling fetchedRecords() should work here, or is compiler not liking it and forcing the return value assignment?", "author": "soondenana", "createdAt": "2020-02-14T22:17:55Z", "path": "clients/src/test/java/org/apache/kafka/clients/consumer/internals/FetcherTest.java", "diffHunk": "@@ -3835,6 +3835,31 @@ public void testFetchCompletedBeforeHandlerAdded() {\n         assertEquals(1, fetcher.sendFetches());\n     }\n \n+    @Test\n+    public void testCorruptMessageError() {\n+        buildFetcher();\n+        assignFromUser(singleton(tp0));\n+        subscriptions.seek(tp0, 0);\n+\n+        assertEquals(1, fetcher.sendFetches());\n+        assertFalse(fetcher.hasCompletedFetches());\n+\n+        // Prepare a response with the CORRUPT_MESSAGE error.\n+        client.prepareResponse(fullFetchResponse(\n+                tp0,\n+                buildRecords(1L, 1, 1),\n+                Errors.CORRUPT_MESSAGE,\n+                100L, 0));\n+        consumerClient.poll(time.timer(0));\n+        assertTrue(fetcher.hasCompletedFetches());\n+\n+        // Trigger the exception.\n+        assertThrows(KafkaException.class, () -> {\n+            Map<TopicPartition, List<ConsumerRecord<byte[], byte[]>>> partitionRecords =\n+                    fetchedRecords();", "originalCommit": "a58e1be8f9c09937fab1182af62450ea38310d10", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY4NDc4MQ==", "url": "https://github.com/apache/kafka/pull/8111#discussion_r379684781", "bodyText": "Agree, made the change to discard the return value.", "author": "agam", "createdAt": "2020-02-14T23:12:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY3MDA3NA=="}], "type": "inlineReview", "revised_code": {"commit": "152323baa85ee0ab4396e2af7e1d7e25133cafec", "chunk": "diff --git a/clients/src/test/java/org/apache/kafka/clients/consumer/internals/FetcherTest.java b/clients/src/test/java/org/apache/kafka/clients/consumer/internals/FetcherTest.java\nindex 954ba9e33b..cd0e455b8a 100644\n--- a/clients/src/test/java/org/apache/kafka/clients/consumer/internals/FetcherTest.java\n+++ b/clients/src/test/java/org/apache/kafka/clients/consumer/internals/FetcherTest.java\n\n@@ -3855,8 +3855,7 @@ public class FetcherTest {\n \n         // Trigger the exception.\n         assertThrows(KafkaException.class, () -> {\n-            Map<TopicPartition, List<ConsumerRecord<byte[], byte[]>>> partitionRecords =\n-                    fetchedRecords();\n+            fetchedRecords();\n         });\n     }\n \n"}}, {"oid": "152323baa85ee0ab4396e2af7e1d7e25133cafec", "url": "https://github.com/apache/kafka/commit/152323baa85ee0ab4396e2af7e1d7e25133cafec", "message": "Review: throw away return value from fetchedRecords() in test", "committedDate": "2020-02-14T23:12:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTk0MzM0MA==", "url": "https://github.com/apache/kafka/pull/8111#discussion_r379943340", "bodyText": "While we're at it, could we add the fetch offset to the IllegalStateException message below and the UNKNOWN_SERVER_ERROR log message above?", "author": "hachikuji", "createdAt": "2020-02-16T23:28:22Z", "path": "clients/src/main/java/org/apache/kafka/clients/consumer/internals/Fetcher.java", "diffHunk": "@@ -1272,6 +1272,11 @@ private CompletedFetch initializeCompletedFetch(CompletedFetch nextCompletedFetc\n                 log.debug(\"Received unknown leader epoch error in fetch for partition {}\", tp);\n             } else if (error == Errors.UNKNOWN_SERVER_ERROR) {\n                 log.warn(\"Unknown error fetching data for topic-partition {}\", tp);\n+            } else if (error == Errors.CORRUPT_MESSAGE) {\n+                throw new KafkaException(\"Encountered corrupt message when fetching offset \"", "originalCommit": "152323baa85ee0ab4396e2af7e1d7e25133cafec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg3NjAyMQ==", "url": "https://github.com/apache/kafka/pull/8111#discussion_r380876021", "bodyText": "Done.", "author": "agam", "createdAt": "2020-02-18T19:08:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTk0MzM0MA=="}], "type": "inlineReview", "revised_code": {"commit": "d8afd7e73ead72d0f3c037f61b1164fe6ebefd3f", "chunk": "diff --git a/clients/src/main/java/org/apache/kafka/clients/consumer/internals/Fetcher.java b/clients/src/main/java/org/apache/kafka/clients/consumer/internals/Fetcher.java\nindex daff3a2f89..4e407b4439 100644\n--- a/clients/src/main/java/org/apache/kafka/clients/consumer/internals/Fetcher.java\n+++ b/clients/src/main/java/org/apache/kafka/clients/consumer/internals/Fetcher.java\n\n@@ -1271,14 +1271,20 @@ public class Fetcher<K, V> implements Closeable {\n             } else if (error == Errors.UNKNOWN_LEADER_EPOCH) {\n                 log.debug(\"Received unknown leader epoch error in fetch for partition {}\", tp);\n             } else if (error == Errors.UNKNOWN_SERVER_ERROR) {\n-                log.warn(\"Unknown error fetching data for topic-partition {}\", tp);\n+                log.warn(\"Unknown error fetching data while fetching offset \"\n+                        + fetchOffset\n+                        + \" for topic-partition \" + tp);\n             } else if (error == Errors.CORRUPT_MESSAGE) {\n                 throw new KafkaException(\"Encountered corrupt message when fetching offset \"\n                         + fetchOffset\n                         + \" for topic-partition \"\n                         + tp);\n             } else {\n-                throw new IllegalStateException(\"Unexpected error code \" + error.code() + \" while fetching from partition \" + tp);\n+                throw new IllegalStateException(\"Unexpected error code \"\n+                        + error.code()\n+                        + \" while fetching at offset \"\n+                        + fetchOffset\n+                        + \" from topic-partition \" + tp);\n             }\n         } finally {\n             if (completedFetch == null)\n"}}, {"oid": "d8afd7e73ead72d0f3c037f61b1164fe6ebefd3f", "url": "https://github.com/apache/kafka/commit/d8afd7e73ead72d0f3c037f61b1164fe6ebefd3f", "message": "Review: expanded log warnings to include fetch-offset", "committedDate": "2020-02-18T19:08:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQyNDg5NA==", "url": "https://github.com/apache/kafka/pull/8111#discussion_r381424894", "bodyText": "nit: for log messages, can we use the {} placeholders?", "author": "hachikuji", "createdAt": "2020-02-19T17:22:11Z", "path": "clients/src/main/java/org/apache/kafka/clients/consumer/internals/Fetcher.java", "diffHunk": "@@ -1271,9 +1271,20 @@ private CompletedFetch initializeCompletedFetch(CompletedFetch nextCompletedFetc\n             } else if (error == Errors.UNKNOWN_LEADER_EPOCH) {\n                 log.debug(\"Received unknown leader epoch error in fetch for partition {}\", tp);\n             } else if (error == Errors.UNKNOWN_SERVER_ERROR) {\n-                log.warn(\"Unknown error fetching data for topic-partition {}\", tp);\n+                log.warn(\"Unknown error fetching data while fetching offset \"", "originalCommit": "d8afd7e73ead72d0f3c037f61b1164fe6ebefd3f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQ0NDM2OA==", "url": "https://github.com/apache/kafka/pull/8111#discussion_r381444368", "bodyText": "Done", "author": "agam", "createdAt": "2020-02-19T17:56:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQyNDg5NA=="}], "type": "inlineReview", "revised_code": {"commit": "8cd5c55a133a36591e4cd911d3298481a09e1dfc", "chunk": "diff --git a/clients/src/main/java/org/apache/kafka/clients/consumer/internals/Fetcher.java b/clients/src/main/java/org/apache/kafka/clients/consumer/internals/Fetcher.java\nindex 4e407b4439..1231f18e14 100644\n--- a/clients/src/main/java/org/apache/kafka/clients/consumer/internals/Fetcher.java\n+++ b/clients/src/main/java/org/apache/kafka/clients/consumer/internals/Fetcher.java\n\n@@ -1271,9 +1271,8 @@ public class Fetcher<K, V> implements Closeable {\n             } else if (error == Errors.UNKNOWN_LEADER_EPOCH) {\n                 log.debug(\"Received unknown leader epoch error in fetch for partition {}\", tp);\n             } else if (error == Errors.UNKNOWN_SERVER_ERROR) {\n-                log.warn(\"Unknown error fetching data while fetching offset \"\n-                        + fetchOffset\n-                        + \" for topic-partition \" + tp);\n+                log.warn(\"Unknown server error while fetching offset {} for topic-partition {}\",\n+                        fetchOffset, tp);\n             } else if (error == Errors.CORRUPT_MESSAGE) {\n                 throw new KafkaException(\"Encountered corrupt message when fetching offset \"\n                         + fetchOffset\n"}}, {"oid": "8cd5c55a133a36591e4cd911d3298481a09e1dfc", "url": "https://github.com/apache/kafka/commit/8cd5c55a133a36591e4cd911d3298481a09e1dfc", "message": "Review: use \"{}\" in log warnings", "committedDate": "2020-02-19T17:45:22Z", "type": "commit"}, {"oid": "238eced39a01154d09718ec0b0536a3a468037ab", "url": "https://github.com/apache/kafka/commit/238eced39a01154d09718ec0b0536a3a468037ab", "message": "Review: add reference to the CORRUPT_MESSAGE error in docs for `FetchResponse`", "committedDate": "2020-02-20T19:57:29Z", "type": "commit"}]}