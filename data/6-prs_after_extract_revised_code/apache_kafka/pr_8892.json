{"pr_number": 8892, "pr_title": "KAFKA-10068: verify assignment performance with large cluster", "pr_createdAt": "2020-06-18T02:15:22Z", "pr_url": "https://github.com/apache/kafka/pull/8892", "timeline": [{"oid": "11c1dc09ab3f592d76ab1271a329598b316d0971", "url": "https://github.com/apache/kafka/commit/11c1dc09ab3f592d76ab1271a329598b316d0971", "message": "add scale test", "committedDate": "2020-09-18T23:08:31Z", "type": "commit"}, {"oid": "a123ebcdd69981ae7bab50377acd3dc44b1a73ba", "url": "https://github.com/apache/kafka/commit/a123ebcdd69981ae7bab50377acd3dc44b1a73ba", "message": "refactor, add several tests with different parameters", "committedDate": "2020-09-18T23:08:31Z", "type": "commit"}, {"oid": "8707e5392a38f3049c36fc3cd228b2a99b81ce89", "url": "https://github.com/apache/kafka/commit/8707e5392a38f3049c36fc3cd228b2a99b81ce89", "message": "stub consumer offset fetch", "committedDate": "2020-09-18T23:08:31Z", "type": "commit"}, {"oid": "f0d93598d50025b30abd5bfa8c92e99d317ecb09", "url": "https://github.com/apache/kafka/commit/f0d93598d50025b30abd5bfa8c92e99d317ecb09", "message": "review comments, un-parametrize the tests for individual limits", "committedDate": "2020-09-18T23:08:31Z", "type": "commit"}, {"oid": "4ae509cb9f216707f30f7766bbaeed19293090dc", "url": "https://github.com/apache/kafka/commit/4ae509cb9f216707f30f7766bbaeed19293090dc", "message": "fix checkstyle", "committedDate": "2020-09-18T23:08:31Z", "type": "commit"}, {"oid": "9ef7207d407aa8031f6ad85609764ae5794144c2", "url": "https://github.com/apache/kafka/commit/9ef7207d407aa8031f6ad85609764ae5794144c2", "message": "review comments", "committedDate": "2020-09-18T23:08:32Z", "type": "commit"}, {"oid": "9ef7207d407aa8031f6ad85609764ae5794144c2", "url": "https://github.com/apache/kafka/commit/9ef7207d407aa8031f6ad85609764ae5794144c2", "message": "review comments", "committedDate": "2020-09-18T23:08:32Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjMwMjUyMg==", "url": "https://github.com/apache/kafka/pull/8892#discussion_r492302522", "bodyText": "Huh, I thought we fixed this a while ago. Why it it showing up in the diff right now?", "author": "vvcephei", "createdAt": "2020-09-21T19:41:00Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/assignment/ClientState.java", "diffHunk": "@@ -288,17 +288,17 @@ public void computeTaskLags(final UUID uuid, final Map<TaskId, Long> allTaskEndO\n             final Long endOffsetSum = taskEntry.getValue();\n             final Long offsetSum = taskOffsetSums.getOrDefault(task, 0L);\n \n-            if (endOffsetSum < offsetSum) {\n+            if (offsetSum == Task.LATEST_OFFSET) {\n+                taskLagTotals.put(task, Task.LATEST_OFFSET);\n+            } else if (offsetSum == UNKNOWN_OFFSET_SUM) {\n+                taskLagTotals.put(task, UNKNOWN_OFFSET_SUM);\n+            } else if (endOffsetSum < offsetSum) {", "originalCommit": "9ef7207d407aa8031f6ad85609764ae5794144c2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjM4MzIyMw==", "url": "https://github.com/apache/kafka/pull/8892#discussion_r492383223", "bodyText": "I don't know about fixing this before, but I found this while debugging these tests and fixed it on the side in this PR. To be fair, it wasn't hurting anything since we happen to put the right thing in the taskLagTotals map, but the warning logged was definitely incorrect.", "author": "ableegoldman", "createdAt": "2020-09-21T22:33:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjMwMjUyMg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjMwMzk3OQ==", "url": "https://github.com/apache/kafka/pull/8892#discussion_r492303979", "bodyText": "Why remove this? Do we need to instantiate this class now? (I only see static members still).", "author": "vvcephei", "createdAt": "2020-09-21T19:43:58Z", "path": "streams/src/test/java/org/apache/kafka/streams/processor/internals/assignment/AssignmentTestUtils.java", "diffHunk": "@@ -77,13 +86,8 @@\n     public static final TaskId TASK_2_3 = new TaskId(2, 3);\n \n     public static final Set<TaskId> EMPTY_TASKS = emptySet();\n-    public static final List<TaskId> EMPTY_TASK_LIST = emptyList();\n-    public static final Map<TaskId, Long> EMPTY_TASK_OFFSET_SUMS = emptyMap();\n     public static final Map<TopicPartition, Long> EMPTY_CHANGELOG_END_OFFSETS = new HashMap<>();\n \n-    private AssignmentTestUtils() {}", "originalCommit": "9ef7207d407aa8031f6ad85609764ae5794144c2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjM4MjMzMg==", "url": "https://github.com/apache/kafka/pull/8892#discussion_r492382332", "bodyText": "Do we need to instantiate this class now\n\nNo...isn't that exactly the reason we don't need this?", "author": "ableegoldman", "createdAt": "2020-09-21T22:30:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjMwMzk3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQzNjY4MA==", "url": "https://github.com/apache/kafka/pull/8892#discussion_r492436680", "bodyText": "Ah, note the private. The purpose of this constructor is to make it uninstantiable. I.e., it's \"self-documenting\" that it should only be a container for static members.", "author": "vvcephei", "createdAt": "2020-09-22T01:52:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjMwMzk3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ0NzA0MQ==", "url": "https://github.com/apache/kafka/pull/8892#discussion_r492447041", "bodyText": "Ah yeah ok. I'll put it back", "author": "ableegoldman", "createdAt": "2020-09-22T02:44:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjMwMzk3OQ=="}], "type": "inlineReview", "revised_code": {"commit": "fc9dd1efa9585a3ce8d3bed551632776c50cd1be", "chunk": "diff --git a/streams/src/test/java/org/apache/kafka/streams/processor/internals/assignment/AssignmentTestUtils.java b/streams/src/test/java/org/apache/kafka/streams/processor/internals/assignment/AssignmentTestUtils.java\nindex b27fd67156..65166d4940 100644\n--- a/streams/src/test/java/org/apache/kafka/streams/processor/internals/assignment/AssignmentTestUtils.java\n+++ b/streams/src/test/java/org/apache/kafka/streams/processor/internals/assignment/AssignmentTestUtils.java\n\n@@ -88,6 +88,8 @@ public final class AssignmentTestUtils {\n     public static final Set<TaskId> EMPTY_TASKS = emptySet();\n     public static final Map<TopicPartition, Long> EMPTY_CHANGELOG_END_OFFSETS = new HashMap<>();\n \n+    private AssignmentTestUtils() {}\n+\n     static Map<UUID, ClientState> getClientStatesMap(final ClientState... states) {\n         final Map<UUID, ClientState> clientStates = new HashMap<>();\n         int nthState = 1;\n"}}, {"oid": "fc9dd1efa9585a3ce8d3bed551632776c50cd1be", "url": "https://github.com/apache/kafka/commit/fc9dd1efa9585a3ce8d3bed551632776c50cd1be", "message": "private constructor", "committedDate": "2020-09-22T02:42:43Z", "type": "commit"}]}