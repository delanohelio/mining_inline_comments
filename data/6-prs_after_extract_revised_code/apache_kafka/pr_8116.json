{"pr_number": 8116, "pr_title": "KAFKA-9562: part 1: ignore exceptions while flushing stores in close(dirty)", "pr_createdAt": "2020-02-13T23:18:37Z", "pr_url": "https://github.com/apache/kafka/pull/8116", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE3MzMzOQ==", "url": "https://github.com/apache/kafka/pull/8116#discussion_r379173339", "bodyText": "I added the exception to the log message, so we can see where the TaskMigratedException is actually caused.", "author": "vvcephei", "createdAt": "2020-02-13T23:19:09Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java", "diffHunk": "@@ -701,10 +701,13 @@ private void runLoop() {\n                     enforceRebalance();\n                 }\n             } catch (final TaskMigratedException ignoreAndRejoinGroup) {\n-                log.warn(\"Detected task {} that got migrated to another thread. \" +\n-                        \"This implies that this thread missed a rebalance and dropped out of the consumer group. \" +\n-                        \"Will try to rejoin the consumer group. Below is the detailed description of the task:\\n{}\",\n-                    ignoreAndRejoinGroup.migratedTask().id(), ignoreAndRejoinGroup.migratedTask().toString(\">\"));\n+                log.warn(\"Detected task \" + ignoreAndRejoinGroup.migratedTask().id() +\n+                             \" that got migrated to another thread. This implies that this thread missed\" +\n+                             \" a rebalance and dropped out of the consumer group. Will try to rejoin the\" +\n+                             \" consumer group. Below is the detailed description of the task:\\n\" +\n+                             ignoreAndRejoinGroup.migratedTask().toString(\">\"),\n+                         ignoreAndRejoinGroup\n+                         );", "originalCommit": "e506b287ec56d67d4e70c2b42b6fd432067c6ba3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE3Mzg0MQ==", "url": "https://github.com/apache/kafka/pull/8116#discussion_r379173841", "bodyText": "Judging from the stacktrace generated in the prior logging change, this is where we're throwing a TaskMigratedException, even though this block is an \"unclean close\". Just trying out ignoring the exception to see what happens.", "author": "vvcephei", "createdAt": "2020-02-13T23:20:32Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamTask.java", "diffHunk": "@@ -655,7 +655,11 @@ void suspend(final boolean clean,\n             }\n         } else {\n             // In the case of unclean close we still need to make sure all the stores are flushed before closing any\n-            super.flushState();\n+            try {\n+                stateMgr.flush();\n+            } catch (final ProcessorStateException e) {\n+                // ignore any exceptions while flushing (all stores would have had a chance to flush anyway)\n+            }", "originalCommit": "e506b287ec56d67d4e70c2b42b6fd432067c6ba3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTUyNTc0MQ==", "url": "https://github.com/apache/kafka/pull/8116#discussion_r379525741", "bodyText": "Just to clarify we should only swallow under dirty suspension (in trunk it is wrapped in close) right? For clean close / suspend if it throws we would capture it and wrap as TaskMigrated still and then handle them by closing the task as dirty (in that second try we would swallow).", "author": "guozhangwang", "createdAt": "2020-02-14T16:29:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE3Mzg0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYzODk3NA==", "url": "https://github.com/apache/kafka/pull/8116#discussion_r379638974", "bodyText": "That's right", "author": "vvcephei", "createdAt": "2020-02-14T20:51:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE3Mzg0MQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "5ba79bf6de34142dff929bae3d5c9e50b96800c1", "url": "https://github.com/apache/kafka/commit/5ba79bf6de34142dff929bae3d5c9e50b96800c1", "message": "KAFKA-9562: part 1: ignore exceptions while flushing stores in close(dirty)", "committedDate": "2020-02-20T20:36:23Z", "type": "commit"}]}