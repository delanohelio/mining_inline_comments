{"pr_number": 8483, "pr_title": "KAFKA-9865: Expose output topic names from TopologyTestDriver", "pr_createdAt": "2020-04-14T14:48:57Z", "pr_url": "https://github.com/apache/kafka/pull/8483", "timeline": [{"oid": "2ce51e1fdf05c75f3cc4cd73880c4b003d90d7e2", "url": "https://github.com/apache/kafka/commit/2ce51e1fdf05c75f3cc4cd73880c4b003d90d7e2", "message": "fixes: https://issues.apache.org/jira/browse/KAFKA-9864\n\nExpose the set of output topic names the topology produced records to during its test run.", "committedDate": "2020-04-14T14:46:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDczMjM1Ng==", "url": "https://github.com/apache/kafka/pull/8483#discussion_r414732356", "bodyText": "@big-andy-coates Can you update the method name according to the KIP discussion?", "author": "mjsax", "createdAt": "2020-04-24T17:11:50Z", "path": "streams/test-utils/src/main/java/org/apache/kafka/streams/TopologyTestDriver.java", "diffHunk": "@@ -855,6 +856,20 @@ public void advanceWallClockTime(final Duration advance) {\n         return new TestOutputTopic<>(this, topicName, keyDeserializer, valueDeserializer);\n     }\n \n+    /**\n+     * Get all the names of all the topics to which records have been output.\n+     * <p>\n+     * Call this method after piping the input into the test driver to retrieve the full set of topics the topology\n+     * produced records to.\n+     * <p>\n+     * The returned set of topic names includes changelog, repartition and sink topic names.\n+     *\n+     * @return the set of output topic names.\n+     */\n+    public final Set<String> getOutputTopicNames() {", "originalCommit": "2ce51e1fdf05c75f3cc4cd73880c4b003d90d7e2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "668be47015255ca9a6efd5064baeb583ed83fca5", "chunk": "diff --git a/streams/test-utils/src/main/java/org/apache/kafka/streams/TopologyTestDriver.java b/streams/test-utils/src/main/java/org/apache/kafka/streams/TopologyTestDriver.java\nindex aa4f6a7f11..8b2c81ec8e 100644\n--- a/streams/test-utils/src/main/java/org/apache/kafka/streams/TopologyTestDriver.java\n+++ b/streams/test-utils/src/main/java/org/apache/kafka/streams/TopologyTestDriver.java\n\n@@ -857,16 +857,16 @@ public class TopologyTestDriver implements Closeable {\n     }\n \n     /**\n-     * Get all the names of all the topics to which records have been output.\n+     * Get all the names of all the topics to which records have been produced during the test run.\n      * <p>\n-     * Call this method after piping the input into the test driver to retrieve the full set of topics the topology\n+     * Call this method after piping the input into the test driver to retrieve the full set of topic names the topology\n      * produced records to.\n      * <p>\n-     * The returned set of topic names includes changelog, repartition and sink topic names.\n+     * The returned set of topic names includes changelog, repartition and output topic names.\n      *\n-     * @return the set of output topic names.\n+     * @return the set of topic names the topology has produced to.\n      */\n-    public final Set<String> getOutputTopicNames() {\n+    public final Set<String> producedTopicNames() {\n         return Collections.unmodifiableSet(outputRecordsByTopic.keySet());\n     }\n \n"}}, {"oid": "668be47015255ca9a6efd5064baeb583ed83fca5", "url": "https://github.com/apache/kafka/commit/668be47015255ca9a6efd5064baeb583ed83fca5", "message": "update method name inline with kip", "committedDate": "2020-04-26T11:10:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODgwODg0MA==", "url": "https://github.com/apache/kafka/pull/8483#discussion_r418808840", "bodyText": "IMHO, this should be it's own test similar to the one from above. (Btw: what is \"globule\" -> should we fix those names?)", "author": "mjsax", "createdAt": "2020-05-02T01:12:52Z", "path": "streams/test-utils/src/test/java/org/apache/kafka/streams/TopologyTestDriverTest.java", "diffHunk": "@@ -1643,6 +1663,8 @@ public void process(final String key, final String value) {\n                     new KeyValue<>(\"A\", \"recurse-alpha\")\n                 ))\n             );\n+\n+            assertThat(topologyTestDriver.producedTopicNames(), hasItem(\"globule-topic\"));", "originalCommit": "668be47015255ca9a6efd5064baeb583ed83fca5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDY1MTI1NQ==", "url": "https://github.com/apache/kafka/pull/8483#discussion_r420651255", "bodyText": "You're right, I was being lazy ;)\nFixed the Globule thing.\nTried pulling the global topic out, but couldn't get the global table to produce to to a changelog topic.  I'm assuming / guess this is because there isn't one, i.e. the source topic is the global topics changelog.\nIf I'm missing something, maybe you can provide an example test that would capture the global table's change log, or maybe that can be picked up later by someone with more experience of this code", "author": "big-andy-coates", "createdAt": "2020-05-06T09:16:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODgwODg0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg2MzM5OA==", "url": "https://github.com/apache/kafka/pull/8483#discussion_r421863398", "bodyText": "There is no global table changelog topic -- this test really only write into the global input topic and your verification step was to verify that this write is picked up. Will add a corresponding test in a follow up PR.", "author": "mjsax", "createdAt": "2020-05-08T00:08:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODgwODg0MA=="}], "type": "inlineReview", "revised_code": {"commit": "ed4df815ac448b7244db0f1318340799b798b67e", "chunk": "diff --git a/streams/test-utils/src/test/java/org/apache/kafka/streams/TopologyTestDriverTest.java b/streams/test-utils/src/test/java/org/apache/kafka/streams/TopologyTestDriverTest.java\nindex d9876b1fec..9d920ac756 100644\n--- a/streams/test-utils/src/test/java/org/apache/kafka/streams/TopologyTestDriverTest.java\n+++ b/streams/test-utils/src/test/java/org/apache/kafka/streams/TopologyTestDriverTest.java\n\n@@ -1663,8 +1679,6 @@ public class TopologyTestDriverTest {\n                     new KeyValue<>(\"A\", \"recurse-alpha\")\n                 ))\n             );\n-\n-            assertThat(topologyTestDriver.producedTopicNames(), hasItem(\"globule-topic\"));\n         }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODgwOTAyNg==", "url": "https://github.com/apache/kafka/pull/8483#discussion_r418809026", "bodyText": "This does not setup a topology with an internal topic names. You would need to have a store or use the StreamsBuilder with some repartition topic. Or do you not care as you are just interested in the \"chaining\" itself? (than maybe change the test name?)\nOr even better, add tests for all cases, including repartition and changelog? Guess, it could even be one single test that covers all cases at once?", "author": "mjsax", "createdAt": "2020-05-02T01:13:19Z", "path": "streams/test-utils/src/test/java/org/apache/kafka/streams/TopologyTestDriverTest.java", "diffHunk": "@@ -450,6 +452,24 @@ public void shouldThrowForUnknownTopicDeprecated() {\n         }\n     }\n \n+    @Test\n+    public void shouldGetSinkTopicNames() {\n+        testDriver = new TopologyTestDriver(setupSourceSinkTopology(), config);\n+\n+        pipeRecord(SOURCE_TOPIC_1, testRecord1);\n+\n+        assertThat(testDriver.producedTopicNames(), hasItem(SINK_TOPIC_1));\n+    }\n+\n+    @Test\n+    public void shouldGetInternalTopicNames() {\n+        testDriver = new TopologyTestDriver(setupTopologyWithTwoSubtopologies(), config);", "originalCommit": "668be47015255ca9a6efd5064baeb583ed83fca5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDY1OTUwMw==", "url": "https://github.com/apache/kafka/pull/8483#discussion_r420659503", "bodyText": "done.", "author": "big-andy-coates", "createdAt": "2020-05-06T09:31:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODgwOTAyNg=="}], "type": "inlineReview", "revised_code": {"commit": "ed4df815ac448b7244db0f1318340799b798b67e", "chunk": "diff --git a/streams/test-utils/src/test/java/org/apache/kafka/streams/TopologyTestDriverTest.java b/streams/test-utils/src/test/java/org/apache/kafka/streams/TopologyTestDriverTest.java\nindex d9876b1fec..9d920ac756 100644\n--- a/streams/test-utils/src/test/java/org/apache/kafka/streams/TopologyTestDriverTest.java\n+++ b/streams/test-utils/src/test/java/org/apache/kafka/streams/TopologyTestDriverTest.java\n\n@@ -463,11 +477,13 @@ public class TopologyTestDriverTest {\n \n     @Test\n     public void shouldGetInternalTopicNames() {\n-        testDriver = new TopologyTestDriver(setupTopologyWithTwoSubtopologies(), config);\n+        testDriver = new TopologyTestDriver(setupTopologyWithInternalTopic(), config);\n \n         pipeRecord(SOURCE_TOPIC_1, testRecord1);\n \n-        assertThat(testDriver.producedTopicNames(), hasItems(SINK_TOPIC_1, SINK_TOPIC_2));\n+        assertThat(testDriver.producedTopicNames(), hasItems(\n+            endsWith(\"-changelog\"), endsWith(\"-repartition\")\n+        ));\n     }\n \n     @Test\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODgxMDgwNQ==", "url": "https://github.com/apache/kafka/pull/8483#discussion_r418810805", "bodyText": "nit: changelog, repartition and output topics names (as there are other internal topics, we might want to rephrase this more general:\nThe returned set of topic names may include user (e.g., output) and internal (e.g., changelog, repartition) topic names.", "author": "mjsax", "createdAt": "2020-05-02T01:17:35Z", "path": "streams/test-utils/src/main/java/org/apache/kafka/streams/TopologyTestDriver.java", "diffHunk": "@@ -855,6 +856,20 @@ public void advanceWallClockTime(final Duration advance) {\n         return new TestOutputTopic<>(this, topicName, keyDeserializer, valueDeserializer);\n     }\n \n+    /**\n+     * Get all the names of all the topics to which records have been produced during the test run.\n+     * <p>\n+     * Call this method after piping the input into the test driver to retrieve the full set of topic names the topology\n+     * produced records to.\n+     * <p>\n+     * The returned set of topic names includes changelog, repartition and output topic names.", "originalCommit": "668be47015255ca9a6efd5064baeb583ed83fca5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ed4df815ac448b7244db0f1318340799b798b67e", "chunk": "diff --git a/streams/test-utils/src/main/java/org/apache/kafka/streams/TopologyTestDriver.java b/streams/test-utils/src/main/java/org/apache/kafka/streams/TopologyTestDriver.java\nindex 8b2c81ec8e..94c988b8f5 100644\n--- a/streams/test-utils/src/main/java/org/apache/kafka/streams/TopologyTestDriver.java\n+++ b/streams/test-utils/src/main/java/org/apache/kafka/streams/TopologyTestDriver.java\n\n@@ -862,9 +862,10 @@ public class TopologyTestDriver implements Closeable {\n      * Call this method after piping the input into the test driver to retrieve the full set of topic names the topology\n      * produced records to.\n      * <p>\n-     * The returned set of topic names includes changelog, repartition and output topic names.\n+     * The returned set of topic names may include user (e.g., output) and internal (e.g., changelog, repartition) topic\n+     * names.\n      *\n-     * @return the set of topic names the topology has produced to.\n+     * @return The set of topic names the topology has produced to\n      */\n     public final Set<String> producedTopicNames() {\n         return Collections.unmodifiableSet(outputRecordsByTopic.keySet());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODgxMTQ2OQ==", "url": "https://github.com/apache/kafka/pull/8483#discussion_r418811469", "bodyText": "super nit: no . at the end or start sentence with [T]he :)", "author": "mjsax", "createdAt": "2020-05-02T01:19:13Z", "path": "streams/test-utils/src/main/java/org/apache/kafka/streams/TopologyTestDriver.java", "diffHunk": "@@ -855,6 +856,20 @@ public void advanceWallClockTime(final Duration advance) {\n         return new TestOutputTopic<>(this, topicName, keyDeserializer, valueDeserializer);\n     }\n \n+    /**\n+     * Get all the names of all the topics to which records have been produced during the test run.\n+     * <p>\n+     * Call this method after piping the input into the test driver to retrieve the full set of topic names the topology\n+     * produced records to.\n+     * <p>\n+     * The returned set of topic names includes changelog, repartition and output topic names.\n+     *\n+     * @return the set of topic names the topology has produced to.", "originalCommit": "668be47015255ca9a6efd5064baeb583ed83fca5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ed4df815ac448b7244db0f1318340799b798b67e", "chunk": "diff --git a/streams/test-utils/src/main/java/org/apache/kafka/streams/TopologyTestDriver.java b/streams/test-utils/src/main/java/org/apache/kafka/streams/TopologyTestDriver.java\nindex 8b2c81ec8e..94c988b8f5 100644\n--- a/streams/test-utils/src/main/java/org/apache/kafka/streams/TopologyTestDriver.java\n+++ b/streams/test-utils/src/main/java/org/apache/kafka/streams/TopologyTestDriver.java\n\n@@ -862,9 +862,10 @@ public class TopologyTestDriver implements Closeable {\n      * Call this method after piping the input into the test driver to retrieve the full set of topic names the topology\n      * produced records to.\n      * <p>\n-     * The returned set of topic names includes changelog, repartition and output topic names.\n+     * The returned set of topic names may include user (e.g., output) and internal (e.g., changelog, repartition) topic\n+     * names.\n      *\n-     * @return the set of topic names the topology has produced to.\n+     * @return The set of topic names the topology has produced to\n      */\n     public final Set<String> producedTopicNames() {\n         return Collections.unmodifiableSet(outputRecordsByTopic.keySet());\n"}}, {"oid": "ed4df815ac448b7244db0f1318340799b798b67e", "url": "https://github.com/apache/kafka/commit/ed4df815ac448b7244db0f1318340799b798b67e", "message": "Matthias's requested changes.", "committedDate": "2020-05-06T09:28:17Z", "type": "commit"}]}