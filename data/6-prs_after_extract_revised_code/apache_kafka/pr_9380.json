{"pr_number": 9380, "pr_title": "KAFKA-7334: Suggest changing config for state.dir in case of FileNotF\u2026", "pr_createdAt": "2020-10-06T11:21:52Z", "pr_url": "https://github.com/apache/kafka/pull/9380", "timeline": [{"oid": "08abab38c2700b70d7c381d9d12a655fc1df564c", "url": "https://github.com/apache/kafka/commit/08abab38c2700b70d7c381d9d12a655fc1df564c", "message": "KAFKA-7334: Suggest changing config for state.dir in case of FileNotFoundException", "committedDate": "2020-10-06T13:47:03Z", "type": "commit"}, {"oid": "08abab38c2700b70d7c381d9d12a655fc1df564c", "url": "https://github.com/apache/kafka/commit/08abab38c2700b70d7c381d9d12a655fc1df564c", "message": "KAFKA-7334: Suggest changing config for state.dir in case of FileNotFoundException", "committedDate": "2020-10-06T13:47:03Z", "type": "forcePushed"}, {"oid": "704b7063e7588c2e55c2d06e298d60a7a90765b9", "url": "https://github.com/apache/kafka/commit/704b7063e7588c2e55c2d06e298d60a7a90765b9", "message": "KAFKA-7334: Add additional warning and notes to errors.", "committedDate": "2020-10-07T08:06:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTM4NTAyNA==", "url": "https://github.com/apache/kafka/pull/9380#discussion_r501385024", "bodyText": "it located -> it is located\nin /tmp directory -> in the (default) /tmp/kafka-streams directory ?", "author": "mjsax", "createdAt": "2020-10-08T00:34:02Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStateManagerImpl.java", "diffHunk": "@@ -446,7 +446,9 @@ public void checkpoint() {\n         try {\n             checkpointFile.write(filteredOffsets);\n         } catch (final IOException e) {\n-            log.warn(\"Failed to write offset checkpoint file to {} for global stores: {}\", checkpointFile, e);\n+            log.warn(\"Failed to write offset checkpoint file to {} for global stores: {}.\" +\n+                \" This may occur if OS cleaned the state.dir in case when it located in /tmp directory.\" +", "originalCommit": "704b7063e7588c2e55c2d06e298d60a7a90765b9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3c95793b5a858fcdf18553830336325b16d08e8f", "chunk": "diff --git a/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStateManagerImpl.java b/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStateManagerImpl.java\nindex 0b86b02430..2c57a0a18a 100644\n--- a/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStateManagerImpl.java\n+++ b/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStateManagerImpl.java\n\n@@ -447,8 +447,8 @@ public class GlobalStateManagerImpl implements GlobalStateManager {\n             checkpointFile.write(filteredOffsets);\n         } catch (final IOException e) {\n             log.warn(\"Failed to write offset checkpoint file to {} for global stores: {}.\" +\n-                \" This may occur if OS cleaned the state.dir in case when it located in /tmp directory.\" +\n-                \" You can change location for state.dir to resolve problem\", checkpointFile, e);\n+                \" This may occur if OS cleaned the state.dir in case when it is located in the (default) /tmp/kafka-streams directory.\" +\n+                \" Changing the location of state.dir may resolve the problem\", checkpointFile, e);\n         }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTM4NTM3Mg==", "url": "https://github.com/apache/kafka/pull/9380#discussion_r501385372", "bodyText": "Do we know that it will resolve the problem? Maybe better:\nChanging the location of state.dir may resolve the problem", "author": "mjsax", "createdAt": "2020-10-08T00:35:17Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStateManagerImpl.java", "diffHunk": "@@ -446,7 +446,9 @@ public void checkpoint() {\n         try {\n             checkpointFile.write(filteredOffsets);\n         } catch (final IOException e) {\n-            log.warn(\"Failed to write offset checkpoint file to {} for global stores: {}\", checkpointFile, e);\n+            log.warn(\"Failed to write offset checkpoint file to {} for global stores: {}.\" +\n+                \" This may occur if OS cleaned the state.dir in case when it located in /tmp directory.\" +\n+                \" You can change location for state.dir to resolve problem\", checkpointFile, e);", "originalCommit": "704b7063e7588c2e55c2d06e298d60a7a90765b9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3c95793b5a858fcdf18553830336325b16d08e8f", "chunk": "diff --git a/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStateManagerImpl.java b/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStateManagerImpl.java\nindex 0b86b02430..2c57a0a18a 100644\n--- a/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStateManagerImpl.java\n+++ b/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStateManagerImpl.java\n\n@@ -447,8 +447,8 @@ public class GlobalStateManagerImpl implements GlobalStateManager {\n             checkpointFile.write(filteredOffsets);\n         } catch (final IOException e) {\n             log.warn(\"Failed to write offset checkpoint file to {} for global stores: {}.\" +\n-                \" This may occur if OS cleaned the state.dir in case when it located in /tmp directory.\" +\n-                \" You can change location for state.dir to resolve problem\", checkpointFile, e);\n+                \" This may occur if OS cleaned the state.dir in case when it is located in the (default) /tmp/kafka-streams directory.\" +\n+                \" Changing the location of state.dir may resolve the problem\", checkpointFile, e);\n         }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTM4NTg0MQ==", "url": "https://github.com/apache/kafka/pull/9380#discussion_r501385841", "bodyText": "Wondering if this should go into StreamsConfig ?", "author": "mjsax", "createdAt": "2020-10-08T00:37:07Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StateDirectory.java", "diffHunk": "@@ -98,6 +98,10 @@ public StateDirectory(final StreamsConfig config, final Time time, final boolean\n             throw new ProcessorStateException(\n                 String.format(\"state directory [%s] doesn't exist and couldn't be created\", stateDir.getPath()));\n         }\n+        if (stateDirName.startsWith(\"/tmp\")) {", "originalCommit": "704b7063e7588c2e55c2d06e298d60a7a90765b9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTM5NDMzNQ==", "url": "https://github.com/apache/kafka/pull/9380#discussion_r501394335", "bodyText": "Actually maybe we should wrap it in an if hasPersistentStores so that users won't get this warning if they don't have any persistent state", "author": "ableegoldman", "createdAt": "2020-10-08T01:10:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTM4NTg0MQ=="}], "type": "inlineReview", "revised_code": {"commit": "3c95793b5a858fcdf18553830336325b16d08e8f", "chunk": "diff --git a/streams/src/main/java/org/apache/kafka/streams/processor/internals/StateDirectory.java b/streams/src/main/java/org/apache/kafka/streams/processor/internals/StateDirectory.java\nindex 73ed3dafcb..8fb6936427 100644\n--- a/streams/src/main/java/org/apache/kafka/streams/processor/internals/StateDirectory.java\n+++ b/streams/src/main/java/org/apache/kafka/streams/processor/internals/StateDirectory.java\n\n@@ -98,7 +98,7 @@ public class StateDirectory {\n             throw new ProcessorStateException(\n                 String.format(\"state directory [%s] doesn't exist and couldn't be created\", stateDir.getPath()));\n         }\n-        if (stateDirName.startsWith(\"/tmp\")) {\n+        if (hasPersistentStores && stateDirName.startsWith(\"/tmp\")) {\n             log.warn(\"Using /tmp directory in the state.dir property can cause failures with writing the checkpoint file\" +\n                 \" due to the fact that this directory can be cleared by the OS\");\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTM4NjUyMg==", "url": "https://github.com/apache/kafka/pull/9380#discussion_r501386522", "bodyText": "Hmmm... Not sure if I can follow? Why?\nAlso, if you run multiple instances on the same machine, it seems to be the same as running multiple threads in the same KafkaStreams client?\nAlso, if you configure different state directories, local state cannot be shared what might be wasteful?\nCan you elaborate on this sentence?", "author": "mjsax", "createdAt": "2020-10-08T00:39:50Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/ProcessorStateManager.java", "diffHunk": "@@ -603,7 +603,11 @@ public void checkpoint() {\n         try {\n             checkpointFile.write(checkpointingOffsets);\n         } catch (final IOException e) {\n-            log.warn(\"Failed to write offset checkpoint file to [{}]\", checkpointFile, e);\n+            log.warn(\"Failed to write offset checkpoint file to [{}].\" +\n+                \" This may occur if OS cleaned the state.dir in case when it located in /tmp directory.\" +\n+                \" You can change location for state.dir to resolve problem.\" +\n+                \" This can also occur due to running multiple instances on the same machine using the same state dir.\",", "originalCommit": "704b7063e7588c2e55c2d06e298d60a7a90765b9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTM5MjI2Ng==", "url": "https://github.com/apache/kafka/pull/9380#discussion_r501392266", "bodyText": "@mjsax you can't run multiple instances on the same machine with the same state.dir. For one thing, the locking mechanism is per-process*. If you run two different instances then you can get an active task on one instance and the corresponding standby on another. They would each think they owned the lock for that task directory, and concurrently access it (leading to the FileNotFoundException if one of them deletes the checkpoint, for example)\n*on some systems. On others it isn't, but then you hit the opposite problem where a task is deadlocked because the other process grabbed the lock for its directory first", "author": "ableegoldman", "createdAt": "2020-10-08T01:02:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTM4NjUyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTM5MzcyNA==", "url": "https://github.com/apache/kafka/pull/9380#discussion_r501393724", "bodyText": "Currently, running multiple threads within an instance is not the same as running multiple instances on the same machine in the same state dir. I suppose technically if you could configure the two instances to have the same client UUID then the task assignor would make sure not to assign the same active/standby task to anyone on that machine, but I think there might be some unexpected side effects to running two separates instances with the same UUID.\nAnyways, if you're aware of the problem enough to configure the client Ids directly, you should be aware enough to just configure to use separate state.dirs. I don't think I buy the argument about it being wasteful just because there's really no reason to ever do this in a production app. But people seem to do it in testing all the time, and run into this issue, hence the warning here", "author": "ableegoldman", "createdAt": "2020-10-08T01:08:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTM4NjUyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTQwNjc2NQ==", "url": "https://github.com/apache/kafka/pull/9380#discussion_r501406765", "bodyText": "Thanks for clarification @ableegoldman!", "author": "mjsax", "createdAt": "2020-10-08T02:02:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTM4NjUyMg=="}], "type": "inlineReview", "revised_code": {"commit": "3c95793b5a858fcdf18553830336325b16d08e8f", "chunk": "diff --git a/streams/src/main/java/org/apache/kafka/streams/processor/internals/ProcessorStateManager.java b/streams/src/main/java/org/apache/kafka/streams/processor/internals/ProcessorStateManager.java\nindex 619f754673..44606ac97f 100644\n--- a/streams/src/main/java/org/apache/kafka/streams/processor/internals/ProcessorStateManager.java\n+++ b/streams/src/main/java/org/apache/kafka/streams/processor/internals/ProcessorStateManager.java\n\n@@ -605,8 +605,8 @@ public class ProcessorStateManager implements StateManager {\n         } catch (final IOException e) {\n             log.warn(\"Failed to write offset checkpoint file to [{}].\" +\n                 \" This may occur if OS cleaned the state.dir in case when it located in /tmp directory.\" +\n-                \" You can change location for state.dir to resolve problem.\" +\n-                \" This can also occur due to running multiple instances on the same machine using the same state dir.\",\n+                \" This may also occur due to running multiple instances on the same machine using the same state dir.\" +\n+                \" Changing the location of state.dir may resolve the problem.\",\n                 checkpointFile, e);\n         }\n     }\n"}}, {"oid": "3c95793b5a858fcdf18553830336325b16d08e8f", "url": "https://github.com/apache/kafka/commit/3c95793b5a858fcdf18553830336325b16d08e8f", "message": "KAFKA-7334: Fix warnings in log.", "committedDate": "2020-10-08T06:29:31Z", "type": "commit"}]}