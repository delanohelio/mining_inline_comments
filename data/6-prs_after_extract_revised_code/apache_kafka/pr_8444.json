{"pr_number": 8444, "pr_title": "KAFKA-8869: Remove task configs for deleted connectors from config snapshot", "pr_createdAt": "2020-04-08T04:48:16Z", "pr_url": "https://github.com/apache/kafka/pull/8444", "timeline": [{"oid": "990d63b2574de0dd3da5e75393f2af1d093f7a12", "url": "https://github.com/apache/kafka/commit/990d63b2574de0dd3da5e75393f2af1d093f7a12", "message": "KAFKA-8869: Remove task configs for deleted connectors from config snapshot", "committedDate": "2020-04-08T04:36:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTM0MjU3MQ==", "url": "https://github.com/apache/kafka/pull/8444#discussion_r405342571", "bodyText": "Do you think it is worth also updating connectorTaskCounts to keep these in sync?", "author": "ncliang", "createdAt": "2020-04-08T08:19:53Z", "path": "connect/runtime/src/main/java/org/apache/kafka/connect/storage/KafkaConfigBackingStore.java", "diffHunk": "@@ -548,6 +548,7 @@ public void onCompletion(Throwable error, ConsumerRecord<String, byte[]> record)\n                         // Connector deletion will be written as a null value\n                         log.info(\"Successfully processed removal of connector '{}'\", connectorName);\n                         connectorConfigs.remove(connectorName);\n+                        taskConfigs.keySet().removeIf(taskId -> taskId.connector().equals(connectorName));", "originalCommit": "990d63b2574de0dd3da5e75393f2af1d093f7a12", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgxMTM2Mw==", "url": "https://github.com/apache/kafka/pull/8444#discussion_r405811363", "bodyText": "No kidding! Good catch. I've added logic in this class to do that, and expanded the test to verify this logic.", "author": "C0urante", "createdAt": "2020-04-08T20:59:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTM0MjU3MQ=="}], "type": "inlineReview", "revised_code": {"commit": "8225b29541689adfd465c92649228786831d655d", "chunk": "diff --git a/connect/runtime/src/main/java/org/apache/kafka/connect/storage/KafkaConfigBackingStore.java b/connect/runtime/src/main/java/org/apache/kafka/connect/storage/KafkaConfigBackingStore.java\nindex bd926fc2fb..39a8f35be3 100644\n--- a/connect/runtime/src/main/java/org/apache/kafka/connect/storage/KafkaConfigBackingStore.java\n+++ b/connect/runtime/src/main/java/org/apache/kafka/connect/storage/KafkaConfigBackingStore.java\n\n@@ -548,6 +548,7 @@ public class KafkaConfigBackingStore implements ConfigBackingStore {\n                         // Connector deletion will be written as a null value\n                         log.info(\"Successfully processed removal of connector '{}'\", connectorName);\n                         connectorConfigs.remove(connectorName);\n+                        connectorTaskCounts.remove(connectorName);\n                         taskConfigs.keySet().removeIf(taskId -> taskId.connector().equals(connectorName));\n                         removed = true;\n                     } else {\n"}}, {"oid": "8225b29541689adfd465c92649228786831d655d", "url": "https://github.com/apache/kafka/commit/8225b29541689adfd465c92649228786831d655d", "message": "KAFKA-8869: Remove task count for deleted connectors from config snapshot", "committedDate": "2020-04-08T20:59:03Z", "type": "commit"}]}