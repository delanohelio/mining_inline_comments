{"pr_number": 8856, "pr_title": "KAFKA-10150: task state transitions/management and committing cleanup", "pr_createdAt": "2020-06-12T00:36:09Z", "pr_url": "https://github.com/apache/kafka/pull/8856", "timeline": [{"oid": "a5f47cda67e0876be6877c7aec3ec770cc46891b", "url": "https://github.com/apache/kafka/commit/a5f47cda67e0876be6877c7aec3ec770cc46891b", "message": "always close all tasks during shutdown", "committedDate": "2020-06-12T21:52:50Z", "type": "forcePushed"}, {"oid": "3789a7c1dc71b69ec4d6af621a3415210d731fa8", "url": "https://github.com/apache/kafka/commit/3789a7c1dc71b69ec4d6af621a3415210d731fa8", "message": "enforce SUSPENDED and check commitNeeded", "committedDate": "2020-06-16T20:00:35Z", "type": "commit"}, {"oid": "f621c3a02d673a57bcfb32a653a257bfc4d48241", "url": "https://github.com/apache/kafka/commit/f621c3a02d673a57bcfb32a653a257bfc4d48241", "message": "check if commit needed in TM", "committedDate": "2020-06-16T20:00:35Z", "type": "commit"}, {"oid": "0c3c080bf6c6007979404dcfaf45e75399711332", "url": "https://github.com/apache/kafka/commit/0c3c080bf6c6007979404dcfaf45e75399711332", "message": "just suspend in closeandRecycleState", "committedDate": "2020-06-16T20:00:35Z", "type": "commit"}, {"oid": "a6805838f5c3fbbade7eaa82330b14d88e52f783", "url": "https://github.com/apache/kafka/commit/a6805838f5c3fbbade7eaa82330b14d88e52f783", "message": "clean up handleRevocation and handleAssignment", "committedDate": "2020-06-16T20:00:36Z", "type": "commit"}, {"oid": "fb64b9787153ae1da96db9694008139f4d299a4d", "url": "https://github.com/apache/kafka/commit/fb64b9787153ae1da96db9694008139f4d299a4d", "message": "Task and TaskManager tests", "committedDate": "2020-06-16T20:00:36Z", "type": "commit"}, {"oid": "7b08e28d940ae822b05da54460064c261b56e0ed", "url": "https://github.com/apache/kafka/commit/7b08e28d940ae822b05da54460064c261b56e0ed", "message": "always close all tasks during shutdown", "committedDate": "2020-06-16T20:00:36Z", "type": "commit"}, {"oid": "dd03646b9c8c01602219d7afb25730df5663a7d0", "url": "https://github.com/apache/kafka/commit/dd03646b9c8c01602219d7afb25730df5663a7d0", "message": "only commit all for eos-beta", "committedDate": "2020-06-16T20:00:36Z", "type": "commit"}, {"oid": "1f989fc78ffa6b89cf50775767e563a64120460a", "url": "https://github.com/apache/kafka/commit/1f989fc78ffa6b89cf50775767e563a64120460a", "message": "addressing CR feedback", "committedDate": "2020-06-16T20:00:36Z", "type": "commit"}, {"oid": "cf21fb5d42e1a5b1521ae58b7f57839195a4791b", "url": "https://github.com/apache/kafka/commit/cf21fb5d42e1a5b1521ae58b7f57839195a4791b", "message": "get rid of checkpoint member", "committedDate": "2020-06-16T20:00:36Z", "type": "commit"}, {"oid": "d2ba0df1befe929672850755d1610427c6234e57", "url": "https://github.com/apache/kafka/commit/d2ba0df1befe929672850755d1610427c6234e57", "message": "fixing up last few TM tests", "committedDate": "2020-06-16T20:00:36Z", "type": "commit"}, {"oid": "bd032c97d515c9dfff9ed940ae795105b2c466c7", "url": "https://github.com/apache/kafka/commit/bd032c97d515c9dfff9ed940ae795105b2c466c7", "message": "log before transition", "committedDate": "2020-06-16T20:00:36Z", "type": "commit"}, {"oid": "0349663e2836129908a73e9e587ece9afb3bc04f", "url": "https://github.com/apache/kafka/commit/0349663e2836129908a73e9e587ece9afb3bc04f", "message": "attempt to postCommit all tasks", "committedDate": "2020-06-16T20:00:36Z", "type": "commit"}, {"oid": "3ff79ea351cd20c4021b053133061984c0bbd202", "url": "https://github.com/apache/kafka/commit/3ff79ea351cd20c4021b053133061984c0bbd202", "message": "always commit when commitNeeded", "committedDate": "2020-06-16T20:00:36Z", "type": "commit"}, {"oid": "3ff79ea351cd20c4021b053133061984c0bbd202", "url": "https://github.com/apache/kafka/commit/3ff79ea351cd20c4021b053133061984c0bbd202", "message": "always commit when commitNeeded", "committedDate": "2020-06-16T20:00:36Z", "type": "forcePushed"}, {"oid": "2529fb91b156a520ceb4178665ab313051f68cfd", "url": "https://github.com/apache/kafka/commit/2529fb91b156a520ceb4178665ab313051f68cfd", "message": "only commit active tasks", "committedDate": "2020-06-16T20:13:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTExNjE0MQ==", "url": "https://github.com/apache/kafka/pull/8856#discussion_r441116141", "bodyText": "As @mjsax pointed out, we should still commit even if there are no consumed offsets. However, we should not commit the offsets/transaction if there are no active tasks that need committing", "author": "ableegoldman", "createdAt": "2020-06-16T20:17:06Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/TaskManager.java", "diffHunk": "@@ -690,18 +686,21 @@ void shutdown(final boolean clean) {\n         final AtomicReference<RuntimeException> firstException = new AtomicReference<>(null);\n \n         final Set<Task> tasksToClose = new HashSet<>();\n+        final Set<Task> tasksToCommit = new HashSet<>();\n         final Map<TaskId, Map<TopicPartition, OffsetAndMetadata>> consumedOffsetsAndMetadataPerTask = new HashMap<>();\n \n         for (final Task task : tasks.values()) {\n             if (clean) {\n                 try {\n                     task.suspend();\n-                    final Map<TopicPartition, OffsetAndMetadata> committableOffsets = task.prepareCommit();\n-\n-                    tasksToClose.add(task);\n-                    if (!committableOffsets.isEmpty()) {\n-                        consumedOffsetsAndMetadataPerTask.put(task.id(), committableOffsets);\n+                    if (task.commitNeeded()) {\n+                        tasksToCommit.add(task);\n+                        final Map<TopicPartition, OffsetAndMetadata> committableOffsets = task.prepareCommit();\n+                        if (task.isActive()) {", "originalCommit": "2529fb91b156a520ceb4178665ab313051f68cfd", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}