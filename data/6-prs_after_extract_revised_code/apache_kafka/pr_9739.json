{"pr_number": 9739, "pr_title": "KAFKA-10636 Bypass log validation for writes to raft log", "pr_createdAt": "2020-12-13T07:15:12Z", "pr_url": "https://github.com/apache/kafka/pull/9739", "timeline": [{"oid": "ed2fc564ea5431a208cbb7e534996ee1843bb2a6", "url": "https://github.com/apache/kafka/commit/ed2fc564ea5431a208cbb7e534996ee1843bb2a6", "message": "initial commit", "committedDate": "2020-12-13T07:04:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTg2NTk3Nw==", "url": "https://github.com/apache/kafka/pull/9739#discussion_r541865977", "bodyText": "This is necessary for the sanity check in Log.scala append()\n         if (batch.magic >= RecordBatch.MAGIC_VALUE_V2) {\n              maybeAssignEpochStartOffset(batch.partitionLeaderEpoch, batch.baseOffset)", "author": "feyman2016", "createdAt": "2020-12-13T07:24:51Z", "path": "raft/src/main/java/org/apache/kafka/raft/KafkaRaftClient.java", "diffHunk": "@@ -1477,6 +1477,7 @@ private void appendBatch(\n     ) {\n         try {\n             int epoch = state.epoch();\n+            batch.data.batches().forEach(recordBatch -> recordBatch.setPartitionLeaderEpoch(epoch));", "originalCommit": "ed2fc564ea5431a208cbb7e534996ee1843bb2a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzY2NTQ4MQ==", "url": "https://github.com/apache/kafka/pull/9739#discussion_r553665481", "bodyText": "Hmm.. Do we need this? I thought we already set leader epoch here: https://github.com/apache/kafka/blob/trunk/raft/src/main/java/org/apache/kafka/raft/internals/BatchBuilder.java#L256.", "author": "hachikuji", "createdAt": "2021-01-08T00:09:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTg2NTk3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTA4MjU5OQ==", "url": "https://github.com/apache/kafka/pull/9739#discussion_r559082599", "bodyText": "@hachikuji I thought the same as you, re-check the code, the PARTITION_LEADER_EPOCH_OFFSET has been set in DefaultRecordBatch#writeHeader, but the problem is that the BatchBuilder is always constructed with the epoch=RecordBatch.NO_PARTITION_LEADER_EPOCH, so I updated it and reverted the L1480.", "author": "feyman2016", "createdAt": "2021-01-17T05:52:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTg2NTk3Nw=="}], "type": "inlineReview", "revised_code": {"commit": "56228d5ff88333645517248264011da860f559fb", "chunk": "diff --git a/raft/src/main/java/org/apache/kafka/raft/KafkaRaftClient.java b/raft/src/main/java/org/apache/kafka/raft/KafkaRaftClient.java\nindex d492883c69..742236893e 100644\n--- a/raft/src/main/java/org/apache/kafka/raft/KafkaRaftClient.java\n+++ b/raft/src/main/java/org/apache/kafka/raft/KafkaRaftClient.java\n\n@@ -1477,7 +1477,6 @@ public class KafkaRaftClient<T> implements RaftClient<T> {\n     ) {\n         try {\n             int epoch = state.epoch();\n-            batch.data.batches().forEach(recordBatch -> recordBatch.setPartitionLeaderEpoch(epoch));\n             LogAppendInfo info = appendAsLeader(batch.data);\n             OffsetAndEpoch offsetAndEpoch = new OffsetAndEpoch(info.lastOffset, epoch);\n             CompletableFuture<Long> future = appendPurgatory.await(\n"}}, {"oid": "621bbb2fdb63b3a72e80e0bdefb33e2b0bb3d033", "url": "https://github.com/apache/kafka/commit/621bbb2fdb63b3a72e80e0bdefb33e2b0bb3d033", "message": "fix tests", "committedDate": "2020-12-13T14:47:38Z", "type": "commit"}, {"oid": "56b1c6cc9c0df3b2eee222677b22fe66c3afb604", "url": "https://github.com/apache/kafka/commit/56b1c6cc9c0df3b2eee222677b22fe66c3afb604", "message": "update based on comments", "committedDate": "2021-01-16T15:23:24Z", "type": "commit"}, {"oid": "56228d5ff88333645517248264011da860f559fb", "url": "https://github.com/apache/kafka/commit/56228d5ff88333645517248264011da860f559fb", "message": "update", "committedDate": "2021-01-16T15:44:50Z", "type": "commit"}, {"oid": "30952cb2e7bd8eb913d011e6c9f6dde87d14a2e7", "url": "https://github.com/apache/kafka/commit/30952cb2e7bd8eb913d011e6c9f6dde87d14a2e7", "message": "merge trunk", "committedDate": "2021-01-17T08:26:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTA5Njg0Mw==", "url": "https://github.com/apache/kafka/pull/9739#discussion_r559096843", "bodyText": "Fx checkstyle error", "author": "feyman2016", "createdAt": "2021-01-17T08:28:02Z", "path": "raft/src/main/java/org/apache/kafka/raft/internals/BatchAccumulator.java", "diffHunk": "@@ -19,7 +19,6 @@\n import org.apache.kafka.common.memory.MemoryPool;\n import org.apache.kafka.common.record.CompressionType;\n import org.apache.kafka.common.record.MemoryRecords;\n-import org.apache.kafka.common.record.RecordBatch;", "originalCommit": "30952cb2e7bd8eb913d011e6c9f6dde87d14a2e7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "aa1049a848c06b99c2fbf73fbf04d8e52ff50f6a", "url": "https://github.com/apache/kafka/commit/aa1049a848c06b99c2fbf73fbf04d8e52ff50f6a", "message": "fix naming", "committedDate": "2021-01-17T08:29:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDYwMTMzNQ==", "url": "https://github.com/apache/kafka/pull/9739#discussion_r560601335", "bodyText": "Good catch. Do we have any test cases in BatchAccumulatorTest which can be modified to catch this case?", "author": "hachikuji", "createdAt": "2021-01-20T00:57:12Z", "path": "raft/src/main/java/org/apache/kafka/raft/internals/BatchAccumulator.java", "diffHunk": "@@ -180,7 +179,7 @@ private void startNewBatch() {\n                 nextOffset,\n                 time.milliseconds(),\n                 false,\n-                RecordBatch.NO_PARTITION_LEADER_EPOCH,\n+                epoch,", "originalCommit": "aa1049a848c06b99c2fbf73fbf04d8e52ff50f6a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTU4NzU1MA==", "url": "https://github.com/apache/kafka/pull/9739#discussion_r561587550", "bodyText": "Let me check", "author": "feyman2016", "createdAt": "2021-01-21T03:59:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDYwMTMzNQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "7ae4903a1ddf109892465d24dd1b935886c45b11", "url": "https://github.com/apache/kafka/commit/7ae4903a1ddf109892465d24dd1b935886c45b11", "message": "merge origin/trunk and fix based on comments", "committedDate": "2021-02-01T00:40:24Z", "type": "commit"}, {"oid": "89afaf3d8f72af4b5770bef9ae27989ad1a29860", "url": "https://github.com/apache/kafka/commit/89afaf3d8f72af4b5770bef9ae27989ad1a29860", "message": "Fix KafkaMetadataLogTest", "committedDate": "2021-02-01T15:17:00Z", "type": "commit"}]}