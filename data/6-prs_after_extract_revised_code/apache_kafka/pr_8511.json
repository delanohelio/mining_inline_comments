{"pr_number": 8511, "pr_title": "KAFKA-9888: Copy connector configs before passing to REST extensions", "pr_createdAt": "2020-04-18T05:31:20Z", "pr_url": "https://github.com/apache/kafka/pull/8511", "timeline": [{"oid": "1d8d28adf87ff877d83c43609bbe609b0ff81a19", "url": "https://github.com/apache/kafka/commit/1d8d28adf87ff877d83c43609bbe609b0ff81a19", "message": "KAFKA-9888: Copy connector configs before passing to REST extensions", "committedDate": "2020-04-18T05:26:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTYxMDgzOQ==", "url": "https://github.com/apache/kafka/pull/8511#discussion_r411610839", "bodyText": "Nice test.", "author": "ncliang", "createdAt": "2020-04-20T18:49:58Z", "path": "connect/runtime/src/test/java/org/apache/kafka/connect/runtime/health/ConnectClusterStateImplTest.java", "diffHunk": "@@ -87,7 +88,13 @@ public Void answer() {\n             }\n         });\n         EasyMock.replay(herder);\n-        assertEquals(expectedConfig, connectClusterState.connectorConfig(connName));\n+        Map<String, String> actualConfig = connectClusterState.connectorConfig(connName);\n+        assertEquals(expectedConfig, actualConfig);\n+        assertNotSame(", "originalCommit": "1d8d28adf87ff877d83c43609bbe609b0ff81a19", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzc2MDU1Mg==", "url": "https://github.com/apache/kafka/pull/8511#discussion_r427760552", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        Map<String, String> result = connectorConfigCallback.get(herderRequestTimeoutMs, TimeUnit.MILLISECONDS);\n          \n          \n            \n                        return new HashMap<>(result);\n          \n          \n            \n                        return new HashMap<>(connectorConfigCallback.get(herderRequestTimeoutMs, TimeUnit.MILLISECONDS););", "author": "kkonstantine", "createdAt": "2020-05-20T06:04:27Z", "path": "connect/runtime/src/main/java/org/apache/kafka/connect/runtime/health/ConnectClusterStateImpl.java", "diffHunk": "@@ -86,7 +86,8 @@ public ConnectorHealth connectorHealth(String connName) {\n         FutureCallback<Map<String, String>> connectorConfigCallback = new FutureCallback<>();\n         herder.connectorConfig(connName, connectorConfigCallback);\n         try {\n-            return connectorConfigCallback.get(herderRequestTimeoutMs, TimeUnit.MILLISECONDS);\n+            Map<String, String> result = connectorConfigCallback.get(herderRequestTimeoutMs, TimeUnit.MILLISECONDS);\n+            return new HashMap<>(result);", "originalCommit": "1d8d28adf87ff877d83c43609bbe609b0ff81a19", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "10c27d0841b0015f0f8b27c471cceb712654e536", "chunk": "diff --git a/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/health/ConnectClusterStateImpl.java b/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/health/ConnectClusterStateImpl.java\nindex b7a34e2941..8cae7f8117 100644\n--- a/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/health/ConnectClusterStateImpl.java\n+++ b/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/health/ConnectClusterStateImpl.java\n\n@@ -86,8 +86,7 @@ public class ConnectClusterStateImpl implements ConnectClusterState {\n         FutureCallback<Map<String, String>> connectorConfigCallback = new FutureCallback<>();\n         herder.connectorConfig(connName, connectorConfigCallback);\n         try {\n-            Map<String, String> result = connectorConfigCallback.get(herderRequestTimeoutMs, TimeUnit.MILLISECONDS);\n-            return new HashMap<>(result);\n+            return new HashMap<>(connectorConfigCallback.get(herderRequestTimeoutMs, TimeUnit.MILLISECONDS););\n         } catch (InterruptedException | ExecutionException | TimeoutException e) {\n             throw new ConnectException(\n                 String.format(\"Failed to retrieve configuration for connector '%s'\", connName),\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzc2MTgxMA==", "url": "https://github.com/apache/kafka/pull/8511#discussion_r427761810", "bodyText": "I like the improved text. But let's skip WARNING since it's not a tag we use in comments (such as TODO: for instance)", "author": "kkonstantine", "createdAt": "2020-05-20T06:08:17Z", "path": "connect/runtime/src/main/java/org/apache/kafka/connect/storage/KafkaConfigBackingStore.java", "diffHunk": "@@ -280,8 +280,8 @@ public void stop() {\n     @Override\n     public ClusterConfigState snapshot() {\n         synchronized (lock) {\n-            // Doing a shallow copy of the data is safe here because the complex nested data that is copied should all be\n-            // immutable configs\n+            // WARNING: Only a shallow copy is performed here; in order to avoid accidentally corrupting the worker's view", "originalCommit": "1d8d28adf87ff877d83c43609bbe609b0ff81a19", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e6e8f9ce49859173d5eb047a222483f4d730f08a", "chunk": "diff --git a/connect/runtime/src/main/java/org/apache/kafka/connect/storage/KafkaConfigBackingStore.java b/connect/runtime/src/main/java/org/apache/kafka/connect/storage/KafkaConfigBackingStore.java\nindex 8ec8f90b50..c4c6af9888 100644\n--- a/connect/runtime/src/main/java/org/apache/kafka/connect/storage/KafkaConfigBackingStore.java\n+++ b/connect/runtime/src/main/java/org/apache/kafka/connect/storage/KafkaConfigBackingStore.java\n\n@@ -280,7 +280,7 @@ public class KafkaConfigBackingStore implements ConfigBackingStore {\n     @Override\n     public ClusterConfigState snapshot() {\n         synchronized (lock) {\n-            // WARNING: Only a shallow copy is performed here; in order to avoid accidentally corrupting the worker's view\n+            // Only a shallow copy is performed here; in order to avoid accidentally corrupting the worker's view\n             // of the config topic, any nested structures should be copied before making modifications\n             return new ClusterConfigState(\n                     offset,\n"}}, {"oid": "10c27d0841b0015f0f8b27c471cceb712654e536", "url": "https://github.com/apache/kafka/commit/10c27d0841b0015f0f8b27c471cceb712654e536", "message": "Update connect/runtime/src/main/java/org/apache/kafka/connect/runtime/health/ConnectClusterStateImpl.java\n\nCo-authored-by: Konstantine Karantasis <konstantine@confluent.io>", "committedDate": "2020-05-20T17:56:24Z", "type": "commit"}, {"oid": "e6e8f9ce49859173d5eb047a222483f4d730f08a", "url": "https://github.com/apache/kafka/commit/e6e8f9ce49859173d5eb047a222483f4d730f08a", "message": "KAFKA-9888: Address review comments", "committedDate": "2020-05-20T17:57:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQzNjM0Mg==", "url": "https://github.com/apache/kafka/pull/8511#discussion_r428436342", "bodyText": "My bad. My suggestion inserted a typo. At least I saw it before I start the build.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        return new HashMap<>(connectorConfigCallback.get(herderRequestTimeoutMs, TimeUnit.MILLISECONDS););\n          \n          \n            \n                        return new HashMap<>(connectorConfigCallback.get(herderRequestTimeoutMs, TimeUnit.MILLISECONDS));", "author": "kkonstantine", "createdAt": "2020-05-21T04:18:34Z", "path": "connect/runtime/src/main/java/org/apache/kafka/connect/runtime/health/ConnectClusterStateImpl.java", "diffHunk": "@@ -86,7 +86,7 @@ public ConnectorHealth connectorHealth(String connName) {\n         FutureCallback<Map<String, String>> connectorConfigCallback = new FutureCallback<>();\n         herder.connectorConfig(connName, connectorConfigCallback);\n         try {\n-            return connectorConfigCallback.get(herderRequestTimeoutMs, TimeUnit.MILLISECONDS);\n+            return new HashMap<>(connectorConfigCallback.get(herderRequestTimeoutMs, TimeUnit.MILLISECONDS););", "originalCommit": "e6e8f9ce49859173d5eb047a222483f4d730f08a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "daa86fc1ee40440ee516f6377f536dd4c53f5ad3", "chunk": "diff --git a/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/health/ConnectClusterStateImpl.java b/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/health/ConnectClusterStateImpl.java\nindex 8cae7f8117..6b7285df50 100644\n--- a/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/health/ConnectClusterStateImpl.java\n+++ b/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/health/ConnectClusterStateImpl.java\n\n@@ -86,7 +86,7 @@ public class ConnectClusterStateImpl implements ConnectClusterState {\n         FutureCallback<Map<String, String>> connectorConfigCallback = new FutureCallback<>();\n         herder.connectorConfig(connName, connectorConfigCallback);\n         try {\n-            return new HashMap<>(connectorConfigCallback.get(herderRequestTimeoutMs, TimeUnit.MILLISECONDS););\n+            return new HashMap<>(connectorConfigCallback.get(herderRequestTimeoutMs, TimeUnit.MILLISECONDS));\n         } catch (InterruptedException | ExecutionException | TimeoutException e) {\n             throw new ConnectException(\n                 String.format(\"Failed to retrieve configuration for connector '%s'\", connName),\n"}}, {"oid": "daa86fc1ee40440ee516f6377f536dd4c53f5ad3", "url": "https://github.com/apache/kafka/commit/daa86fc1ee40440ee516f6377f536dd4c53f5ad3", "message": "Update connect/runtime/src/main/java/org/apache/kafka/connect/runtime/health/ConnectClusterStateImpl.java", "committedDate": "2020-05-21T04:18:45Z", "type": "commit"}]}