{"pr_number": 8455, "pr_title": "KAFKA-9845: Warn users about using config providers with plugin.path property", "pr_createdAt": "2020-04-09T15:38:07Z", "pr_url": "https://github.com/apache/kafka/pull/8455", "timeline": [{"oid": "96caaa9a4934bcef78d7b145d18aa1718cb10009", "url": "https://github.com/apache/kafka/commit/96caaa9a4934bcef78d7b145d18aa1718cb10009", "message": "KAFKA-9845: Fix plugin.path when config provider is used", "committedDate": "2020-04-09T15:32:37Z", "type": "commit"}, {"oid": "ab16154ff778e36eb509a43639438e8692cb048e", "url": "https://github.com/apache/kafka/commit/ab16154ff778e36eb509a43639438e8692cb048e", "message": "Revert \"KAFKA-9845: Fix plugin.path when config provider is used\"\n\nThis reverts commit 96caaa9a4934bcef78d7b145d18aa1718cb10009.", "committedDate": "2020-04-09T17:37:48Z", "type": "commit"}, {"oid": "f9387144bffd9257df08c49aa8a177ee7fc5c451", "url": "https://github.com/apache/kafka/commit/f9387144bffd9257df08c49aa8a177ee7fc5c451", "message": "KAFKA-9845: Emit ERROR-level log message when config provider is used for plugin.path property", "committedDate": "2020-04-09T21:46:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUzOTk1OQ==", "url": "https://github.com/apache/kafka/pull/8455#discussion_r406539959", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        log.error(\n          \n          \n            \n                        log.warn(", "author": "ncliang", "createdAt": "2020-04-10T00:04:40Z", "path": "connect/runtime/src/main/java/org/apache/kafka/connect/runtime/WorkerConfig.java", "diffHunk": "@@ -379,6 +380,20 @@ private void logDeprecatedProperty(String propName, String propValue, String def\n         }\n     }\n \n+    private void logPluginPathConfigProviderWarning(Map<String, String> rawOriginals) {\n+        String rawPluginPath = rawOriginals.get(PLUGIN_PATH_CONFIG);\n+        String transformedPluginPath = originalsStrings().get(PLUGIN_PATH_CONFIG);\n+        if (!Objects.equals(rawPluginPath, transformedPluginPath)) {\n+            log.error(", "originalCommit": "f9387144bffd9257df08c49aa8a177ee7fc5c451", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjU0Mzg3OQ==", "url": "https://github.com/apache/kafka/pull/8455#discussion_r406543879", "bodyText": "Yeah, I was torn here... on one hand, nothing's necessarily broken, no exceptions are thrown, and the worker won't fail to start up, so WARN does seem warranted. On the other hand, it's an unfortunate reality that the WARN level is heavily polluted by existing config warnings emitted when the framework creates Kafka clients and their unused configs get logged at that level, and it also seems highly unlikely that the worker would behave as expected in this case.\nI think if this were noticed from the first time it became an issue, it might even be reasonable to throw an exception and fail the worker on startup, but since we can't do that now without breaking backwards compatibility and opening that whole can of worms, ERROR level logging seemed like a decent substitute.\nThat's my thinking, if you're still convinced that WARN is better I'm happy to change it.", "author": "C0urante", "createdAt": "2020-04-10T00:18:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUzOTk1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjYwNzcwMQ==", "url": "https://github.com/apache/kafka/pull/8455#discussion_r406607701", "bodyText": "I think what you just described is precisely what I would consider something worthy of logging at WARN level. i.e. something went wrong and it is very likely that the application will behave in unexpected ways. ERROR level to me should be reserved for catastrophic failures that the application can not recover from. Something that would prevent the worker to start up, in this case. But, at the end of the day, everyone has their own interpretations and there is no right or wrong answer here.\nNow, WARN level being polluted by unused configs - that is something that should be considered a bug that we should fix separately, IMO.", "author": "ncliang", "createdAt": "2020-04-10T05:24:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUzOTk1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjYwODAxNg==", "url": "https://github.com/apache/kafka/pull/8455#discussion_r406608016", "bodyText": "Fair enough, will update accordingly :)", "author": "C0urante", "createdAt": "2020-04-10T05:26:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUzOTk1OQ=="}], "type": "inlineReview", "revised_code": {"commit": "1e9dae6efad90e6588aeddf030253c569c458731", "chunk": "diff --git a/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/WorkerConfig.java b/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/WorkerConfig.java\nindex 7b1d248164..62f9383095 100644\n--- a/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/WorkerConfig.java\n+++ b/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/WorkerConfig.java\n\n@@ -384,7 +384,7 @@ public class WorkerConfig extends AbstractConfig {\n         String rawPluginPath = rawOriginals.get(PLUGIN_PATH_CONFIG);\n         String transformedPluginPath = originalsStrings().get(PLUGIN_PATH_CONFIG);\n         if (!Objects.equals(rawPluginPath, transformedPluginPath)) {\n-            log.error(\n+            log.warn(\n                 \"Config providers do not work with the plugin.path property. The raw value '{}' \" \n                     + \"will be used for plugin scanning, as opposed to the transformed value '{}'. \" \n                     + \"See https://issues.apache.org/jira/browse/KAFKA-9845 for more information.\",\n"}}, {"oid": "1e9dae6efad90e6588aeddf030253c569c458731", "url": "https://github.com/apache/kafka/commit/1e9dae6efad90e6588aeddf030253c569c458731", "message": "KAFKA-9845: Demote log message level from ERROR to WARN\n\nCo-Authored-By: Nigel Liang <nigel@nigelliang.com>", "committedDate": "2020-04-10T05:26:17Z", "type": "commit"}, {"oid": "a2f339c438e1c91ef7b646941fc1ae584d0b2cda", "url": "https://github.com/apache/kafka/commit/a2f339c438e1c91ef7b646941fc1ae584d0b2cda", "message": "KAFKA-94845: Fix failing unit tests", "committedDate": "2020-04-10T17:54:35Z", "type": "commit"}, {"oid": "5d8af18e03e17361d430727a8b44e3f7a4077af4", "url": "https://github.com/apache/kafka/commit/5d8af18e03e17361d430727a8b44e3f7a4077af4", "message": "KAFKA-9845: Add warning message to docstring for plugin.path config", "committedDate": "2020-04-10T18:35:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODUxMjg1OQ==", "url": "https://github.com/apache/kafka/pull/8455#discussion_r438512859", "bodyText": "How about:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        + \"/opt/connectors\\n\" \n          \n          \n            \n                        + \"Warning: Config providers will not take effect if used for the value of this \" \n          \n          \n            \n                        + \"property, and instead the raw, non-transformed value will be used.\";\n          \n          \n            \n                        + \"/opt/connectors\\n\" \n          \n          \n            \n                        + \"Do not use config provider variables in this property, since the raw path is used \"\n          \n          \n            \n                        + \"by the worker's scanner before config providers are initialized and used to \"\n          \n          \n            \n                        + \"replace variables.\";", "author": "rhauch", "createdAt": "2020-06-11T02:48:05Z", "path": "connect/runtime/src/main/java/org/apache/kafka/connect/runtime/WorkerConfig.java", "diffHunk": "@@ -205,7 +206,9 @@\n             + \"plugins and their dependencies\\n\"\n             + \"Note: symlinks will be followed to discover dependencies or plugins.\\n\"\n             + \"Examples: plugin.path=/usr/local/share/java,/usr/local/share/kafka/plugins,\"\n-            + \"/opt/connectors\";\n+            + \"/opt/connectors\\n\" \n+            + \"Warning: Config providers will not take effect if used for the value of this \" \n+            + \"property, and instead the raw, non-transformed value will be used.\";", "originalCommit": "5d8af18e03e17361d430727a8b44e3f7a4077af4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ccec713d0bbbd5c6ab85f76dcbfd2592c57c2158", "chunk": "diff --git a/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/WorkerConfig.java b/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/WorkerConfig.java\nindex b7fe6941a9..c6e3bdc375 100644\n--- a/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/WorkerConfig.java\n+++ b/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/WorkerConfig.java\n\n@@ -207,8 +207,9 @@ public class WorkerConfig extends AbstractConfig {\n             + \"Note: symlinks will be followed to discover dependencies or plugins.\\n\"\n             + \"Examples: plugin.path=/usr/local/share/java,/usr/local/share/kafka/plugins,\"\n             + \"/opt/connectors\\n\" \n-            + \"Warning: Config providers will not take effect if used for the value of this \" \n-            + \"property, and instead the raw, non-transformed value will be used.\";\n+            + \"Do not use config provider variables in this property, since the raw path is used \"\n+            + \"by the worker's scanner before config providers are initialized and used to \"\n+            + \"replace variables.\";\n \n     public static final String CONFIG_PROVIDERS_CONFIG = \"config.providers\";\n     protected static final String CONFIG_PROVIDERS_DOC =\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODUxMzc0OA==", "url": "https://github.com/apache/kafka/pull/8455#discussion_r438513748", "bodyText": "How about:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            \"Config providers do not work with the plugin.path property. The raw value '{}' \" \n          \n          \n            \n                                + \"will be used for plugin scanning, as opposed to the transformed value '{}'. \" \n          \n          \n            \n                                + \"See https://issues.apache.org/jira/browse/KAFKA-9845 for more information.\",\n          \n          \n            \n                            \"Variables cannot be used in the 'plugin.path' property, since the property is \"\n          \n          \n            \n                            + \"used by plugin scanning before the config providers that replace the \" \n          \n          \n            \n                            + \"variables are initialized. The raw value '{}' was used for plugin scanning, as \" \n          \n          \n            \n                            + \"opposed to the transformed value '{}', and this may cause unexpected results.\",", "author": "rhauch", "createdAt": "2020-06-11T02:51:47Z", "path": "connect/runtime/src/main/java/org/apache/kafka/connect/runtime/WorkerConfig.java", "diffHunk": "@@ -379,6 +382,22 @@ private void logDeprecatedProperty(String propName, String propValue, String def\n         }\n     }\n \n+    private void logPluginPathConfigProviderWarning(Map<String, String> rawOriginals) {\n+        String rawPluginPath = rawOriginals.get(PLUGIN_PATH_CONFIG);\n+        // Can't use AbstractConfig::originalsStrings here since some values may be null, which\n+        // causes that method to fail\n+        String transformedPluginPath = Objects.toString(originals().get(PLUGIN_PATH_CONFIG));\n+        if (!Objects.equals(rawPluginPath, transformedPluginPath)) {\n+            log.warn(\n+                \"Config providers do not work with the plugin.path property. The raw value '{}' \" \n+                    + \"will be used for plugin scanning, as opposed to the transformed value '{}'. \" \n+                    + \"See https://issues.apache.org/jira/browse/KAFKA-9845 for more information.\",", "originalCommit": "5d8af18e03e17361d430727a8b44e3f7a4077af4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ccec713d0bbbd5c6ab85f76dcbfd2592c57c2158", "chunk": "diff --git a/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/WorkerConfig.java b/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/WorkerConfig.java\nindex b7fe6941a9..c6e3bdc375 100644\n--- a/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/WorkerConfig.java\n+++ b/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/WorkerConfig.java\n\n@@ -389,9 +390,10 @@ public class WorkerConfig extends AbstractConfig {\n         String transformedPluginPath = Objects.toString(originals().get(PLUGIN_PATH_CONFIG));\n         if (!Objects.equals(rawPluginPath, transformedPluginPath)) {\n             log.warn(\n-                \"Config providers do not work with the plugin.path property. The raw value '{}' \" \n-                    + \"will be used for plugin scanning, as opposed to the transformed value '{}'. \" \n-                    + \"See https://issues.apache.org/jira/browse/KAFKA-9845 for more information.\",\n+                \"Variables cannot be used in the 'plugin.path' property, since the property is \"\n+                + \"used by plugin scanning before the config providers that replace the \" \n+                + \"variables are initialized. The raw value '{}' was used for plugin scanning, as \" \n+                + \"opposed to the transformed value '{}', and this may cause unexpected results.\",\n                 rawPluginPath,\n                 transformedPluginPath\n             );\n"}}, {"oid": "ccec713d0bbbd5c6ab85f76dcbfd2592c57c2158", "url": "https://github.com/apache/kafka/commit/ccec713d0bbbd5c6ab85f76dcbfd2592c57c2158", "message": "KAFKA-9845: Apply suggestions from code review\n\nCo-authored-by: Randall Hauch <rhauch@gmail.com>", "committedDate": "2020-06-11T02:54:49Z", "type": "commit"}]}