{"pr_number": 8574, "pr_title": "KAFKA-9925: decorate pseudo-topics with app id", "pr_createdAt": "2020-04-28T16:26:46Z", "pr_url": "https://github.com/apache/kafka/pull/8574", "timeline": [{"oid": "8e8467de1e064eef4e06114757e7d3b1d2331940", "url": "https://github.com/apache/kafka/commit/8e8467de1e064eef4e06114757e7d3b1d2331940", "message": "KAFKA-9925: decorate pseudo-topics with app id", "committedDate": "2020-04-28T16:25:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjc1Mjk4Mg==", "url": "https://github.com/apache/kafka/pull/8574#discussion_r416752982", "bodyText": "Hopefully, this explains what's going on here.", "author": "vvcephei", "createdAt": "2020-04-28T16:27:07Z", "path": "streams/src/main/java/org/apache/kafka/streams/kstream/internals/KTableImpl.java", "diffHunk": "@@ -972,13 +974,26 @@ boolean sendingOldValueEnabled() {\n         //This occurs whenever the extracted foreignKey changes values.\n         enableSendingOldValues();\n \n+        final NamedInternal renamed = new NamedInternal(joinName);\n+\n+        final String subscriptionTopicName = renamed.suffixWithOrElseGet(\n+            \"-subscription-registration\",\n+            builder,\n+            SUBSCRIPTION_REGISTRATION\n+        ) + TOPIC_SUFFIX;\n \n+        // the decoration can't be performed until we have the configuration available when the app runs,\n+        // so we pass Suppliers into the components, which they can call at run time", "originalCommit": "8e8467de1e064eef4e06114757e7d3b1d2331940", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzU3ODU1Nw==", "url": "https://github.com/apache/kafka/pull/8574#discussion_r417578557", "bodyText": "I understood", "author": "abbccdda", "createdAt": "2020-04-29T20:05:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjc1Mjk4Mg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjc2NDE1OA==", "url": "https://github.com/apache/kafka/pull/8574#discussion_r416764158", "bodyText": "This (and below) is a bit awkward.\nOur requirement is not to call the supplier until after the app starts, but we can call it any time after the app starts.\nThe natural place would be in configure, but unfortunately, that method is basically useless for our internal serdes. The reason is that we previously decided that configure should be called externally to the DSL, but our internal serdes are constructed internal to the DSL. Plus, configure must be called at run time (when the config is available), but by run time, we can no longer tell whether our serde is \"internal\" or not. So, there's no good place where we can call configure for our internal serdes.\nI'm side-stepping the problem here by just invoking the supplier when we first need to use it, which is also at run time.", "author": "vvcephei", "createdAt": "2020-04-28T16:43:27Z", "path": "streams/src/main/java/org/apache/kafka/streams/kstream/internals/foreignkeyjoin/SubscriptionWrapperSerde.java", "diffHunk": "@@ -76,6 +78,10 @@ public void setIfUnset(final Serializer<K> defaultSerializer) {\n                 throw new UnsupportedVersionException(\"SubscriptionWrapper version is larger than maximum supported 0x7F\");\n             }\n \n+            if (primaryKeySerializationPseudoTopic == null) {\n+                primaryKeySerializationPseudoTopic = primaryKeySerializationPseudoTopicSupplier.get();\n+            }", "originalCommit": "8e8467de1e064eef4e06114757e7d3b1d2331940", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjc2NTY5Ng==", "url": "https://github.com/apache/kafka/pull/8574#discussion_r416765696", "bodyText": "I'm adding a new public method for our specific use case here, to document that we should only need to invoke this method publicly for \"pseudo\" topics.", "author": "vvcephei", "createdAt": "2020-04-28T16:45:41Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/InternalTopologyBuilder.java", "diffHunk": "@@ -1224,6 +1224,10 @@ private static Pattern buildPattern(final Collection<String> sourceTopics,\n         return decoratedTopics;\n     }\n \n+    public String decoratePseudoTopic(final String topic) {", "originalCommit": "8e8467de1e064eef4e06114757e7d3b1d2331940", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjc2NjMxNA==", "url": "https://github.com/apache/kafka/pull/8574#discussion_r416766314", "bodyText": "This verifies the fix: the pseudo topics should also be prefixed. I should have noticed before that they weren't.", "author": "vvcephei", "createdAt": "2020-04-28T16:46:29Z", "path": "streams/src/test/java/org/apache/kafka/streams/kstream/internals/KTableKTableForeignKeyJoinScenarioTest.java", "diffHunk": "@@ -218,19 +220,19 @@ public void shouldUseExpectedTopicsWithSerde() {\n         }\n         // verifying primarily that no extra pseudo-topics were used, but it's nice to also verify the rest of the\n         // topics our serdes serialize data for\n-        assertThat(serdeScope.registeredTopics(), CoreMatchers.is(mkSet(\n+        assertThat(serdeScope.registeredTopics(), is(mkSet(\n             // expected pseudo-topics\n-            \"KTABLE-FK-JOIN-SUBSCRIPTION-REGISTRATION-0000000006-topic-fk--key\",\n-            \"KTABLE-FK-JOIN-SUBSCRIPTION-REGISTRATION-0000000006-topic-pk--key\",\n-            \"KTABLE-FK-JOIN-SUBSCRIPTION-REGISTRATION-0000000006-topic-vh--value\",\n+            applicationId + \"-KTABLE-FK-JOIN-SUBSCRIPTION-REGISTRATION-0000000006-topic-fk--key\",\n+            applicationId + \"-KTABLE-FK-JOIN-SUBSCRIPTION-REGISTRATION-0000000006-topic-pk--key\",\n+            applicationId + \"-KTABLE-FK-JOIN-SUBSCRIPTION-REGISTRATION-0000000006-topic-vh--value\",", "originalCommit": "8e8467de1e064eef4e06114757e7d3b1d2331940", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "a863182d36994a2773be69953159c8a5320b07cc", "url": "https://github.com/apache/kafka/commit/a863182d36994a2773be69953159c8a5320b07cc", "message": "checkstyle", "committedDate": "2020-04-28T16:51:19Z", "type": "commit"}, {"oid": "ea21699024ea74196d96e416751ba49b77ca074d", "url": "https://github.com/apache/kafka/commit/ea21699024ea74196d96e416751ba49b77ca074d", "message": "checkstyle", "committedDate": "2020-04-28T16:53:22Z", "type": "commit"}]}