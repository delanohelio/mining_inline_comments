{"pr_number": 9792, "pr_title": "KAFKA-10870: handle REBALANCE_IN_PROGRESS error in JoinGroup", "pr_createdAt": "2020-12-28T09:24:57Z", "pr_url": "https://github.com/apache/kafka/pull/9792", "timeline": [{"oid": "50db08798b3e485e9cda89881e30c5c1c7d5684a", "url": "https://github.com/apache/kafka/commit/50db08798b3e485e9cda89881e30c5c1c7d5684a", "message": "KAFKA-10870: handle REBALANCE_IN_PROGRESS error in JoinGroup", "committedDate": "2020-12-28T09:23:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDI3MTA5OA==", "url": "https://github.com/apache/kafka/pull/9792#discussion_r550271098", "bodyText": "I think the call to requestRejoin is not needed. We only reset the rejoinNeeded flag after the subsequent SyncGroup request. Or is there a case that this misses?", "author": "hachikuji", "createdAt": "2020-12-30T17:32:47Z", "path": "clients/src/main/java/org/apache/kafka/clients/consumer/internals/AbstractCoordinator.java", "diffHunk": "@@ -658,6 +658,10 @@ public void handle(JoinGroupResponse joinResponse, RequestFuture<ByteBuffer> fut\n                     AbstractCoordinator.this.generation = new Generation(OffsetCommitRequest.DEFAULT_GENERATION_ID, memberId, null);\n                 }\n                 future.raise(error);\n+            } else if (error == Errors.REBALANCE_IN_PROGRESS) {\n+                log.info(\"JoinGroup failed due to the group began another rebalance. Need to re-join the group.\");\n+                requestRejoin();", "originalCommit": "50db08798b3e485e9cda89881e30c5c1c7d5684a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDQwODIwMw==", "url": "https://github.com/apache/kafka/pull/9792#discussion_r550408203", "bodyText": "You're correct. Removed. Thanks.", "author": "showuon", "createdAt": "2020-12-31T06:28:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDI3MTA5OA=="}], "type": "inlineReview", "revised_code": {"commit": "62c3c76ddb8b8d1163281b837c2b273824a9e1ec", "chunk": "diff --git a/clients/src/main/java/org/apache/kafka/clients/consumer/internals/AbstractCoordinator.java b/clients/src/main/java/org/apache/kafka/clients/consumer/internals/AbstractCoordinator.java\nindex ce20c1c2e4..dd4cf26361 100644\n--- a/clients/src/main/java/org/apache/kafka/clients/consumer/internals/AbstractCoordinator.java\n+++ b/clients/src/main/java/org/apache/kafka/clients/consumer/internals/AbstractCoordinator.java\n\n@@ -659,8 +659,8 @@ public abstract class AbstractCoordinator implements Closeable {\n                 }\n                 future.raise(error);\n             } else if (error == Errors.REBALANCE_IN_PROGRESS) {\n-                log.info(\"JoinGroup failed due to the group began another rebalance. Need to re-join the group.\");\n-                requestRejoin();\n+                log.info(\"JoinGroup failed with a REBALANCE_IN_PROGRESS error, which could indicate a replication timeout \" +\n+                    \"on the broker. Will retry.\");\n                 future.raise(error);\n             } else {\n                 // unexpected error, throw the exception\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDI3MzA3Ng==", "url": "https://github.com/apache/kafka/pull/9792#discussion_r550273076", "bodyText": "I guess it's kind of a confusing error to see. The case on the broker is when the write to the log failed because of a timeout. I wonder if it would be useful to suggest the cause in the message. For example:\n\nJoinGroup failed with a REBALANCE_IN_PROGRESS error, which could indicate a replication timeout on the broker. Will retry.", "author": "hachikuji", "createdAt": "2020-12-30T17:39:27Z", "path": "clients/src/main/java/org/apache/kafka/clients/consumer/internals/AbstractCoordinator.java", "diffHunk": "@@ -658,6 +658,10 @@ public void handle(JoinGroupResponse joinResponse, RequestFuture<ByteBuffer> fut\n                     AbstractCoordinator.this.generation = new Generation(OffsetCommitRequest.DEFAULT_GENERATION_ID, memberId, null);\n                 }\n                 future.raise(error);\n+            } else if (error == Errors.REBALANCE_IN_PROGRESS) {\n+                log.info(\"JoinGroup failed due to the group began another rebalance. Need to re-join the group.\");", "originalCommit": "50db08798b3e485e9cda89881e30c5c1c7d5684a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDQwODE2NQ==", "url": "https://github.com/apache/kafka/pull/9792#discussion_r550408165", "bodyText": "Agree. Thanks.", "author": "showuon", "createdAt": "2020-12-31T06:28:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDI3MzA3Ng=="}], "type": "inlineReview", "revised_code": {"commit": "62c3c76ddb8b8d1163281b837c2b273824a9e1ec", "chunk": "diff --git a/clients/src/main/java/org/apache/kafka/clients/consumer/internals/AbstractCoordinator.java b/clients/src/main/java/org/apache/kafka/clients/consumer/internals/AbstractCoordinator.java\nindex ce20c1c2e4..dd4cf26361 100644\n--- a/clients/src/main/java/org/apache/kafka/clients/consumer/internals/AbstractCoordinator.java\n+++ b/clients/src/main/java/org/apache/kafka/clients/consumer/internals/AbstractCoordinator.java\n\n@@ -659,8 +659,8 @@ public abstract class AbstractCoordinator implements Closeable {\n                 }\n                 future.raise(error);\n             } else if (error == Errors.REBALANCE_IN_PROGRESS) {\n-                log.info(\"JoinGroup failed due to the group began another rebalance. Need to re-join the group.\");\n-                requestRejoin();\n+                log.info(\"JoinGroup failed with a REBALANCE_IN_PROGRESS error, which could indicate a replication timeout \" +\n+                    \"on the broker. Will retry.\");\n                 future.raise(error);\n             } else {\n                 // unexpected error, throw the exception\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDI3MzMxNw==", "url": "https://github.com/apache/kafka/pull/9792#discussion_r550273317", "bodyText": "Can we verify that the JoinGroup gets retried on the next poll?", "author": "hachikuji", "createdAt": "2020-12-30T17:40:22Z", "path": "clients/src/test/java/org/apache/kafka/clients/consumer/internals/AbstractCoordinatorTest.java", "diffHunk": "@@ -823,6 +823,24 @@ public void testJoinGroupRequestWithGroupInstanceIdNotFound() {\n         assertTrue(coordinator.hasUnknownGeneration());\n     }\n \n+    @Test\n+    public void testJoinGroupRequestWithRebalanceInProgress() {\n+        setupCoordinator();\n+        mockClient.prepareResponse(groupCoordinatorResponse(node, Errors.NONE));\n+        coordinator.ensureCoordinatorReady(mockTime.timer(0));\n+\n+        mockClient.prepareResponse(\n+            joinGroupFollowerResponse(defaultGeneration, memberId, JoinGroupRequest.UNKNOWN_MEMBER_ID, Errors.REBALANCE_IN_PROGRESS));\n+\n+        RequestFuture<ByteBuffer> future = coordinator.sendJoinGroupRequest();\n+\n+        assertTrue(consumerClient.poll(future, mockTime.timer(REQUEST_TIMEOUT_MS)));\n+        assertTrue(future.exception().getClass().isInstance(Errors.REBALANCE_IN_PROGRESS.exception()));\n+        assertEquals(Errors.REBALANCE_IN_PROGRESS.message(), future.exception().getMessage());\n+        // should request rejoin\n+        assertTrue(coordinator.rejoinNeededOrPending());", "originalCommit": "50db08798b3e485e9cda89881e30c5c1c7d5684a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDQwODIzOQ==", "url": "https://github.com/apache/kafka/pull/9792#discussion_r550408239", "bodyText": "Added. Thanks.", "author": "showuon", "createdAt": "2020-12-31T06:28:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDI3MzMxNw=="}], "type": "inlineReview", "revised_code": {"commit": "62c3c76ddb8b8d1163281b837c2b273824a9e1ec", "chunk": "diff --git a/clients/src/test/java/org/apache/kafka/clients/consumer/internals/AbstractCoordinatorTest.java b/clients/src/test/java/org/apache/kafka/clients/consumer/internals/AbstractCoordinatorTest.java\nindex 2a579a9ba2..29bfcb81d5 100644\n--- a/clients/src/test/java/org/apache/kafka/clients/consumer/internals/AbstractCoordinatorTest.java\n+++ b/clients/src/test/java/org/apache/kafka/clients/consumer/internals/AbstractCoordinatorTest.java\n\n@@ -837,8 +837,19 @@ public class AbstractCoordinatorTest {\n         assertTrue(consumerClient.poll(future, mockTime.timer(REQUEST_TIMEOUT_MS)));\n         assertTrue(future.exception().getClass().isInstance(Errors.REBALANCE_IN_PROGRESS.exception()));\n         assertEquals(Errors.REBALANCE_IN_PROGRESS.message(), future.exception().getMessage());\n-        // should request rejoin\n         assertTrue(coordinator.rejoinNeededOrPending());\n+\n+        // make sure we'll retry on next poll\n+        assertEquals(0, coordinator.onJoinPrepareInvokes);\n+        assertEquals(0, coordinator.onJoinCompleteInvokes);\n+\n+        mockClient.prepareResponse(joinGroupFollowerResponse(defaultGeneration, memberId, JoinGroupRequest.UNKNOWN_MEMBER_ID, Errors.NONE));\n+        mockClient.prepareResponse(syncGroupResponse(Errors.NONE));\n+\n+        coordinator.ensureActiveGroup();\n+        // make sure both onJoinPrepare and onJoinComplete got called\n+        assertEquals(1, coordinator.onJoinPrepareInvokes);\n+        assertEquals(1, coordinator.onJoinCompleteInvokes);\n     }\n \n     @Test\n"}}, {"oid": "62c3c76ddb8b8d1163281b837c2b273824a9e1ec", "url": "https://github.com/apache/kafka/commit/62c3c76ddb8b8d1163281b837c2b273824a9e1ec", "message": "KAFKA-10870: address reviewer's comments to refactor fix", "committedDate": "2020-12-31T06:26:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTEyMzAxNw==", "url": "https://github.com/apache/kafka/pull/9792#discussion_r551123017", "bodyText": "Could we mention in the log that the error is non-fatal, similar to MEMBER_ID_REQUIRED?", "author": "abbccdda", "createdAt": "2021-01-04T05:22:58Z", "path": "clients/src/main/java/org/apache/kafka/clients/consumer/internals/AbstractCoordinator.java", "diffHunk": "@@ -658,6 +658,10 @@ public void handle(JoinGroupResponse joinResponse, RequestFuture<ByteBuffer> fut\n                     AbstractCoordinator.this.generation = new Generation(OffsetCommitRequest.DEFAULT_GENERATION_ID, memberId, null);\n                 }\n                 future.raise(error);\n+            } else if (error == Errors.REBALANCE_IN_PROGRESS) {\n+                log.info(\"JoinGroup failed with a REBALANCE_IN_PROGRESS error, which could indicate a replication timeout \" +", "originalCommit": "62c3c76ddb8b8d1163281b837c2b273824a9e1ec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTEyOTE2MA==", "url": "https://github.com/apache/kafka/pull/9792#discussion_r551129160", "bodyText": "@abbccdda , thanks for your comment. Just updated. Thanks.", "author": "showuon", "createdAt": "2021-01-04T05:54:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTEyMzAxNw=="}], "type": "inlineReview", "revised_code": {"commit": "558b1883efcf71cf006f4277b4d1f61d7ce8172e", "chunk": "diff --git a/clients/src/main/java/org/apache/kafka/clients/consumer/internals/AbstractCoordinator.java b/clients/src/main/java/org/apache/kafka/clients/consumer/internals/AbstractCoordinator.java\nindex dd4cf26361..b1db415d43 100644\n--- a/clients/src/main/java/org/apache/kafka/clients/consumer/internals/AbstractCoordinator.java\n+++ b/clients/src/main/java/org/apache/kafka/clients/consumer/internals/AbstractCoordinator.java\n\n@@ -659,8 +659,8 @@ public abstract class AbstractCoordinator implements Closeable {\n                 }\n                 future.raise(error);\n             } else if (error == Errors.REBALANCE_IN_PROGRESS) {\n-                log.info(\"JoinGroup failed with a REBALANCE_IN_PROGRESS error, which could indicate a replication timeout \" +\n-                    \"on the broker. Will retry.\");\n+                log.info(\"JoinGroup failed due to non-fatal error: REBALANCE_IN_PROGRESS, \" +\n+                    \"which could indicate a replication timeout on the broker. Will retry.\");\n                 future.raise(error);\n             } else {\n                 // unexpected error, throw the exception\n"}}, {"oid": "558b1883efcf71cf006f4277b4d1f61d7ce8172e", "url": "https://github.com/apache/kafka/commit/558b1883efcf71cf006f4277b4d1f61d7ce8172e", "message": "KAFKA-10870: address reviewer's comment to mention non-fatal error", "committedDate": "2021-01-04T05:53:39Z", "type": "commit"}]}