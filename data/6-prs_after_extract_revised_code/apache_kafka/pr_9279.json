{"pr_number": 9279, "pr_title": "MINOR: Fix common struct `JsonConverter` and `Schema` generation", "pr_createdAt": "2020-09-10T20:45:08Z", "pr_url": "https://github.com/apache/kafka/pull/9279", "timeline": [{"oid": "61a3ce7dbc91d6f1b2d0c992c6d6f681e50d3375", "url": "https://github.com/apache/kafka/commit/61a3ce7dbc91d6f1b2d0c992c6d6f681e50d3375", "message": "MINOR: Fix common struct `JsonConverter` and `Schema` generation", "committedDate": "2020-09-10T20:38:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODI3Njc4Mg==", "url": "https://github.com/apache/kafka/pull/9279#discussion_r488276782", "bodyText": "It's not clear whether we need to generate the common struct JSON converters first.  Can you try without (or explain why it needs to be with?)  Or is the iterator returned from structs not returning the correct data for common structs?", "author": "cmccabe", "createdAt": "2020-09-14T22:41:27Z", "path": "generator/src/main/java/org/apache/kafka/message/JsonConverterGenerator.java", "diffHunk": "@@ -53,17 +53,17 @@ public void generateAndWrite(MessageSpec message, BufferedWriter writer)\n         buffer.incrementIndent();\n         generateConverters(message.dataClassName(), message.struct(),\n             message.validVersions());\n+\n+        for (Iterator<StructSpec> iter = structRegistry.commonStructs(); iter.hasNext(); ) {\n+            generateStructClass(iter.next(), message.validVersions());\n+        }\n+\n         for (Iterator<StructRegistry.StructInfo> iter = structRegistry.structs();", "originalCommit": "61a3ce7dbc91d6f1b2d0c992c6d6f681e50d3375", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9d7aa5801ed321e94a4f9930dabbcfc597ac62b6", "chunk": "diff --git a/generator/src/main/java/org/apache/kafka/message/JsonConverterGenerator.java b/generator/src/main/java/org/apache/kafka/message/JsonConverterGenerator.java\nindex 0e10f9b871..437d069f8d 100644\n--- a/generator/src/main/java/org/apache/kafka/message/JsonConverterGenerator.java\n+++ b/generator/src/main/java/org/apache/kafka/message/JsonConverterGenerator.java\n\n@@ -54,14 +54,10 @@ public final class JsonConverterGenerator implements MessageClassGenerator {\n         generateConverters(message.dataClassName(), message.struct(),\n             message.validVersions());\n \n-        for (Iterator<StructSpec> iter = structRegistry.commonStructs(); iter.hasNext(); ) {\n-            generateStructClass(iter.next(), message.validVersions());\n-        }\n-\n         for (Iterator<StructRegistry.StructInfo> iter = structRegistry.structs();\n                 iter.hasNext(); ) {\n             StructRegistry.StructInfo info = iter.next();\n-            if (!structRegistry.commonStructNames().contains(info.spec().name())) {\n+            if (!info.isCommonStructReference) {\n                 generateStructClass(info.spec(), info.parentVersions());\n             }\n         }\n"}}, {"oid": "9d7aa5801ed321e94a4f9930dabbcfc597ac62b6", "url": "https://github.com/apache/kafka/commit/9d7aa5801ed321e94a4f9930dabbcfc597ac62b6", "message": "Track which structs refer to common structs", "committedDate": "2020-09-14T23:38:03Z", "type": "commit"}, {"oid": "3a3ac41b2e808e255cfc0141a8aeace67dc18219", "url": "https://github.com/apache/kafka/commit/3a3ac41b2e808e255cfc0141a8aeace67dc18219", "message": "Struct registry should key structs by type name", "committedDate": "2020-09-14T23:56:32Z", "type": "commit"}, {"oid": "3a3ac41b2e808e255cfc0141a8aeace67dc18219", "url": "https://github.com/apache/kafka/commit/3a3ac41b2e808e255cfc0141a8aeace67dc18219", "message": "Struct registry should key structs by type name", "committedDate": "2020-09-14T23:56:32Z", "type": "forcePushed"}]}