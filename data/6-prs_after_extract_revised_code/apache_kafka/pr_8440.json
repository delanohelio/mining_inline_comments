{"pr_number": 8440, "pr_title": "KAFKA-9832: extend Kafka Streams EOS system test", "pr_createdAt": "2020-04-07T20:53:37Z", "pr_url": "https://github.com/apache/kafka/pull/8440", "timeline": [{"oid": "37146f4cd2ae8c09330d2be45023ff2e5a6d0eb8", "url": "https://github.com/apache/kafka/commit/37146f4cd2ae8c09330d2be45023ff2e5a6d0eb8", "message": "MINOR: extend Kafka Streams EOS system test", "committedDate": "2020-04-10T19:16:10Z", "type": "commit"}, {"oid": "2f426e832506af219e0fba54228f243fa7b2d61c", "url": "https://github.com/apache/kafka/commit/2f426e832506af219e0fba54228f243fa7b2d61c", "message": "fix verification", "committedDate": "2020-04-10T19:16:10Z", "type": "commit"}, {"oid": "5053a5ede7aa142b88e5170bc818e681ec09a693", "url": "https://github.com/apache/kafka/commit/5053a5ede7aa142b88e5170bc818e681ec09a693", "message": "Extend StandbyTask unit test", "committedDate": "2020-04-10T19:16:10Z", "type": "commit"}, {"oid": "04bef596b7f032ebe540ed3e8a3ed1028eaafdec", "url": "https://github.com/apache/kafka/commit/04bef596b7f032ebe540ed3e8a3ed1028eaafdec", "message": "Extand StandbyTask integration test", "committedDate": "2020-04-10T19:16:10Z", "type": "commit"}, {"oid": "9203d9c5d2fc7188da05340b43d6d54c91c603ab", "url": "https://github.com/apache/kafka/commit/9203d9c5d2fc7188da05340b43d6d54c91c603ab", "message": "Extend TaskManger unit test", "committedDate": "2020-04-10T19:16:10Z", "type": "commit"}, {"oid": "fa0f27c62e035778185deb76da2d7d26ba04409e", "url": "https://github.com/apache/kafka/commit/fa0f27c62e035778185deb76da2d7d26ba04409e", "message": "fix checkstyle", "committedDate": "2020-04-10T19:16:10Z", "type": "commit"}, {"oid": "e48d9d8e2b8f9e2141770aa8fd0581bc0d56f3c6", "url": "https://github.com/apache/kafka/commit/e48d9d8e2b8f9e2141770aa8fd0581bc0d56f3c6", "message": "Github comments", "committedDate": "2020-04-10T19:16:10Z", "type": "commit"}, {"oid": "9960c51a6b8ef1d023316b87f35ab01b94fe4279", "url": "https://github.com/apache/kafka/commit/9960c51a6b8ef1d023316b87f35ab01b94fe4279", "message": "Fix consumer setup", "committedDate": "2020-04-10T19:16:10Z", "type": "commit"}, {"oid": "a7585a23c00af689701e9e67fb557864631dcfde", "url": "https://github.com/apache/kafka/commit/a7585a23c00af689701e9e67fb557864631dcfde", "message": "Fix unit tests", "committedDate": "2020-04-10T19:16:10Z", "type": "commit"}, {"oid": "b11c0ce54e85db2ab130ce6d7763fca3c036dcf3", "url": "https://github.com/apache/kafka/commit/b11c0ce54e85db2ab130ce6d7763fca3c036dcf3", "message": "Bug fix", "committedDate": "2020-04-10T19:16:10Z", "type": "commit"}, {"oid": "8ed96485e258a6683c60c614c15b955010ef0e17", "url": "https://github.com/apache/kafka/commit/8ed96485e258a6683c60c614c15b955010ef0e17", "message": "rebase fix", "committedDate": "2020-04-10T19:16:46Z", "type": "commit"}, {"oid": "8ed96485e258a6683c60c614c15b955010ef0e17", "url": "https://github.com/apache/kafka/commit/8ed96485e258a6683c60c614c15b955010ef0e17", "message": "rebase fix", "committedDate": "2020-04-10T19:16:46Z", "type": "forcePushed"}, {"oid": "5a56062d4c9efb20110c9cae7255aa1bb4dca097", "url": "https://github.com/apache/kafka/commit/5a56062d4c9efb20110c9cae7255aa1bb4dca097", "message": "Fix", "committedDate": "2020-04-13T21:06:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzcyMjAyMg==", "url": "https://github.com/apache/kafka/pull/8440#discussion_r407722022", "bodyText": "If we hit a TaskCorruptedException, we know that only a task in restore mode could be affected and those don't have anything to be committed (their commitNeeded flag should be set to false). Hence, we just commit all non-corrupted tasks. Afterwards we can safely call handleCorruption() (if we don't commit, we might abort a pending transaction for eos-beta incorrectly within handleCorruption())\n\\cc @abbccdda @guozhangwang", "author": "mjsax", "createdAt": "2020-04-13T21:07:47Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java", "diffHunk": "@@ -569,7 +570,13 @@ private void runLoop() {\n                 log.warn(\"Detected the states of tasks \" + e.corruptedTaskWithChangelogs() + \" are corrupted. \" +\n                              \"Will close the task as dirty and re-create and bootstrap from scratch.\", e);\n \n-                taskManager.commitAll();\n+                taskManager.commitInternal(\n+                    taskManager.tasks()\n+                        .values()\n+                        .stream()\n+                        .filter(t -> !e.corruptedTaskWithChangelogs().containsKey(t.id()))\n+                        .collect(Collectors.toSet())\n+                );", "originalCommit": "5a56062d4c9efb20110c9cae7255aa1bb4dca097", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "15e0b98ef384c15022ee76e6ca88b325567e31cb", "chunk": "diff --git a/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java b/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java\nindex da4dfacd17..1493cdd9bf 100644\n--- a/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java\n+++ b/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java\n\n@@ -570,7 +570,7 @@ public class StreamThread extends Thread {\n                 log.warn(\"Detected the states of tasks \" + e.corruptedTaskWithChangelogs() + \" are corrupted. \" +\n                              \"Will close the task as dirty and re-create and bootstrap from scratch.\", e);\n \n-                taskManager.commitInternal(\n+                taskManager.commit(\n                     taskManager.tasks()\n                         .values()\n                         .stream()\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzczMDQ3MQ==", "url": "https://github.com/apache/kafka/pull/8440#discussion_r407730471", "bodyText": "Should we consider adding a unit test here, since this call is externalized?", "author": "abbccdda", "createdAt": "2020-04-13T21:24:52Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/TaskManager.java", "diffHunk": "@@ -741,7 +741,7 @@ int commitAll() {\n         return commitInternal(tasks.values());\n     }\n \n-    private int commitInternal(final Collection<Task> tasks) {\n+    int commitInternal(final Collection<Task> tasks) {", "originalCommit": "5a56062d4c9efb20110c9cae7255aa1bb4dca097", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzc3MzAyNQ==", "url": "https://github.com/apache/kafka/pull/8440#discussion_r407773025", "bodyText": "Good call.\nI also need to add a unit test that we actually commit all other tasks if a TaskCorruptedException is thrown. Just wanted to get the suggested fix reviewed first (also tested via system test run) before I close the unit test gaps.", "author": "mjsax", "createdAt": "2020-04-13T23:16:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzczMDQ3MQ=="}], "type": "inlineReview", "revised_code": {"commit": "15e0b98ef384c15022ee76e6ca88b325567e31cb", "chunk": "diff --git a/streams/src/main/java/org/apache/kafka/streams/processor/internals/TaskManager.java b/streams/src/main/java/org/apache/kafka/streams/processor/internals/TaskManager.java\nindex 930a9fedbd..2f86538a52 100644\n--- a/streams/src/main/java/org/apache/kafka/streams/processor/internals/TaskManager.java\n+++ b/streams/src/main/java/org/apache/kafka/streams/processor/internals/TaskManager.java\n\n@@ -738,11 +738,10 @@ public class TaskManager {\n      * @return number of committed offsets, or -1 if we are in the middle of a rebalance and cannot commit\n      */\n     int commitAll() {\n-        return commitInternal(tasks.values());\n+        return commit(tasks.values());\n     }\n \n-    int commitInternal(final Collection<Task> tasks) {\n-\n+    int commit(final Collection<Task> tasks) {\n         if (rebalanceInProgress) {\n             return -1;\n         } else {\n"}}, {"oid": "d506697bf9605caebe9b421bb088bddcdbe78c52", "url": "https://github.com/apache/kafka/commit/d506697bf9605caebe9b421bb088bddcdbe78c52", "message": "FIX BROKEN SYSTEM TEST RUN", "committedDate": "2020-04-14T01:43:29Z", "type": "commit"}, {"oid": "5c76bdcdf357fc7773198b00f2e712e28ab34797", "url": "https://github.com/apache/kafka/commit/5c76bdcdf357fc7773198b00f2e712e28ab34797", "message": "Revert \"FIX BROKEN SYSTEM TEST RUN\"\n\nThis reverts commit d506697bf9605caebe9b421bb088bddcdbe78c52.", "committedDate": "2020-04-14T22:42:50Z", "type": "commit"}, {"oid": "15e0b98ef384c15022ee76e6ca88b325567e31cb", "url": "https://github.com/apache/kafka/commit/15e0b98ef384c15022ee76e6ca88b325567e31cb", "message": "Add unit tests", "committedDate": "2020-04-14T23:37:29Z", "type": "commit"}]}