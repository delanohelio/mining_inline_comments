{"pr_number": 9275, "pr_title": "KAFKA-10435; Fetch protocol changes for KIP-595", "pr_createdAt": "2020-09-09T21:27:56Z", "pr_url": "https://github.com/apache/kafka/pull/9275", "timeline": [{"oid": "0de6cc5f7b062de98fde080ca0802dc8a337b1c7", "url": "https://github.com/apache/kafka/commit/0de6cc5f7b062de98fde080ca0802dc8a337b1c7", "message": "KAFKA-10435; Fetch protocol changes for KIP-595", "committedDate": "2020-09-10T20:50:51Z", "type": "commit"}, {"oid": "0de6cc5f7b062de98fde080ca0802dc8a337b1c7", "url": "https://github.com/apache/kafka/commit/0de6cc5f7b062de98fde080ca0802dc8a337b1c7", "message": "KAFKA-10435; Fetch protocol changes for KIP-595", "committedDate": "2020-09-10T20:50:51Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzk3NDQwMQ==", "url": "https://github.com/apache/kafka/pull/9275#discussion_r487974401", "bodyText": "currentLeaderEpoch and lastFetchEpoch are both set to -1 by default, but they are set in different ways above, is that deliberate?", "author": "rajinisivaram", "createdAt": "2020-09-14T14:26:15Z", "path": "clients/src/main/java/org/apache/kafka/common/requests/FetchRequest.java", "diffHunk": "@@ -232,19 +263,25 @@ public FetchRequest build(short version) {\n             // We collect the partitions in a single FetchTopic only if they appear sequentially in the fetchData\n             FetchRequestData.FetchTopic fetchTopic = null;\n             for (Map.Entry<TopicPartition, PartitionData> entry : fetchData.entrySet()) {\n-                if (fetchTopic == null || !entry.getKey().topic().equals(fetchTopic.topic())) {\n+                TopicPartition topicPartition = entry.getKey();\n+                PartitionData partitionData = entry.getValue();\n+\n+                if (fetchTopic == null || !topicPartition.topic().equals(fetchTopic.topic())) {\n                     fetchTopic = new FetchRequestData.FetchTopic()\n-                       .setTopic(entry.getKey().topic())\n+                       .setTopic(topicPartition.topic())\n                        .setPartitions(new ArrayList<>());\n                     fetchRequestData.topics().add(fetchTopic);\n                 }\n \n-                fetchTopic.partitions().add(\n-                    new FetchRequestData.FetchPartition().setPartition(entry.getKey().partition())\n-                        .setCurrentLeaderEpoch(entry.getValue().currentLeaderEpoch.orElse(RecordBatch.NO_PARTITION_LEADER_EPOCH))\n-                        .setFetchOffset(entry.getValue().fetchOffset)\n-                        .setLogStartOffset(entry.getValue().logStartOffset)\n-                        .setPartitionMaxBytes(entry.getValue().maxBytes));\n+                FetchRequestData.FetchPartition fetchPartition = new FetchRequestData.FetchPartition()\n+                    .setPartition(topicPartition.partition())\n+                    .setCurrentLeaderEpoch(partitionData.currentLeaderEpoch.orElse(RecordBatch.NO_PARTITION_LEADER_EPOCH))\n+                    .setFetchOffset(partitionData.fetchOffset)\n+                    .setLogStartOffset(partitionData.logStartOffset)\n+                    .setPartitionMaxBytes(partitionData.maxBytes);\n+                partitionData.lastFetchedEpoch.ifPresent(fetchPartition::setLastFetchedEpoch);", "originalCommit": "0de6cc5f7b062de98fde080ca0802dc8a337b1c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODI2MjY5NQ==", "url": "https://github.com/apache/kafka/pull/9275#discussion_r488262695", "bodyText": "I guess I was trying to rely on the default from the schema, but I agree probably no reason to be inconsistent.", "author": "hachikuji", "createdAt": "2020-09-14T22:23:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzk3NDQwMQ=="}], "type": "inlineReview", "revised_code": {"commit": "eb821421f3c5dbaccc58cb6f28b80eb3963af41b", "chunk": "diff --git a/clients/src/main/java/org/apache/kafka/common/requests/FetchRequest.java b/clients/src/main/java/org/apache/kafka/common/requests/FetchRequest.java\nindex 33b7ca0ed8..6c88a37e30 100644\n--- a/clients/src/main/java/org/apache/kafka/common/requests/FetchRequest.java\n+++ b/clients/src/main/java/org/apache/kafka/common/requests/FetchRequest.java\n\n@@ -276,10 +276,10 @@ public class FetchRequest extends AbstractRequest {\n                 FetchRequestData.FetchPartition fetchPartition = new FetchRequestData.FetchPartition()\n                     .setPartition(topicPartition.partition())\n                     .setCurrentLeaderEpoch(partitionData.currentLeaderEpoch.orElse(RecordBatch.NO_PARTITION_LEADER_EPOCH))\n+                    .setLastFetchedEpoch(partitionData.lastFetchedEpoch.orElse(RecordBatch.NO_PARTITION_LEADER_EPOCH))\n                     .setFetchOffset(partitionData.fetchOffset)\n                     .setLogStartOffset(partitionData.logStartOffset)\n                     .setPartitionMaxBytes(partitionData.maxBytes);\n-                partitionData.lastFetchedEpoch.ifPresent(fetchPartition::setLastFetchedEpoch);\n \n                 fetchTopic.partitions().add(fetchPartition);\n             }\n"}}, {"oid": "eb821421f3c5dbaccc58cb6f28b80eb3963af41b", "url": "https://github.com/apache/kafka/commit/eb821421f3c5dbaccc58cb6f28b80eb3963af41b", "message": "Improve efficiency of epoch cache", "committedDate": "2020-09-15T03:11:35Z", "type": "commit"}, {"oid": "00867faf4ec2ac8b520191320832e88eb8fd1e83", "url": "https://github.com/apache/kafka/commit/00867faf4ec2ac8b520191320832e88eb8fd1e83", "message": "Check whether update is needed in write lock", "committedDate": "2020-09-15T17:45:46Z", "type": "commit"}]}