{"pr_number": 8776, "pr_title": "KAFKA-9441: Improve Kafka Streams task management", "pr_createdAt": "2020-06-02T06:55:31Z", "pr_url": "https://github.com/apache/kafka/pull/8776", "timeline": [{"oid": "9ab1bc1dd035cbe1e25ebb4170b10456a420933b", "url": "https://github.com/apache/kafka/commit/9ab1bc1dd035cbe1e25ebb4170b10456a420933b", "message": "KAFKA-9441: Improve Kafka Streams task management\n - make task manager agnostic to task state\n - make tasks state transitions idempotent", "committedDate": "2020-06-04T00:26:39Z", "type": "commit"}, {"oid": "9ab1bc1dd035cbe1e25ebb4170b10456a420933b", "url": "https://github.com/apache/kafka/commit/9ab1bc1dd035cbe1e25ebb4170b10456a420933b", "message": "KAFKA-9441: Improve Kafka Streams task management\n - make task manager agnostic to task state\n - make tasks state transitions idempotent", "committedDate": "2020-06-04T00:26:39Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTUyMzgyOQ==", "url": "https://github.com/apache/kafka/pull/8776#discussion_r435523829", "bodyText": "It might be nice to have a sanity check here that offset is non-negative, since that would indicate we've unexpectedly received a sentinel value. I thought we did that already, but it's obviously not here.", "author": "vvcephei", "createdAt": "2020-06-04T20:16:30Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/TaskManager.java", "diffHunk": "@@ -613,10 +604,14 @@ private long sumOfChangelogOffsets(final TaskId id, final Map<TopicPartition, Lo\n         for (final Map.Entry<TopicPartition, Long> changelogEntry : changelogOffsets.entrySet()) {\n             final long offset = changelogEntry.getValue();\n \n-            offsetSum += offset;\n-            if (offsetSum < 0) {\n-                log.warn(\"Sum of changelog offsets for task {} overflowed, pinning to Long.MAX_VALUE\", id);\n-                return Long.MAX_VALUE;\n+            if (offset == Task.LATEST_OFFSET) {\n+                return Task.LATEST_OFFSET;\n+            } else {\n+                offsetSum += offset;", "originalCommit": "9ab1bc1dd035cbe1e25ebb4170b10456a420933b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU1MjUwMg==", "url": "https://github.com/apache/kafka/pull/8776#discussion_r435552502", "bodyText": "We put the check for negative offsets in the RecordCollector, but I guess it doesn't hurt to check again here?", "author": "ableegoldman", "createdAt": "2020-06-04T21:12:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTUyMzgyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU1OTg2MA==", "url": "https://github.com/apache/kafka/pull/8776#discussion_r435559860", "bodyText": "Aha! Thanks. Yeah, I'd be in favor of coding defensively here as well.", "author": "vvcephei", "createdAt": "2020-06-04T21:22:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTUyMzgyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU4OTcwNw==", "url": "https://github.com/apache/kafka/pull/8776#discussion_r435589707", "bodyText": "Ack", "author": "mjsax", "createdAt": "2020-06-04T22:36:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTUyMzgyOQ=="}], "type": "inlineReview", "revised_code": {"commit": "f98207900282ef4d7a27980a4cc018216098236c", "chunk": "diff --git a/streams/src/main/java/org/apache/kafka/streams/processor/internals/TaskManager.java b/streams/src/main/java/org/apache/kafka/streams/processor/internals/TaskManager.java\nindex 16ab17113a..d1be8a3f30 100644\n--- a/streams/src/main/java/org/apache/kafka/streams/processor/internals/TaskManager.java\n+++ b/streams/src/main/java/org/apache/kafka/streams/processor/internals/TaskManager.java\n\n@@ -604,9 +604,15 @@ public class TaskManager {\n         for (final Map.Entry<TopicPartition, Long> changelogEntry : changelogOffsets.entrySet()) {\n             final long offset = changelogEntry.getValue();\n \n-            if (offset == Task.LATEST_OFFSET) {\n+\n+            if (offset == Task.LATEST_OFFSET) { // this condition can only be true for active tasks; never for standby\n+                // for this case, the offset of all partitions is set to `LATEST_OFFSET`\n+                // and we \"forward\" the sentinel value directly\n                 return Task.LATEST_OFFSET;\n             } else {\n+                if (offset < 0) {\n+                    throw new IllegalStateException(\"Offset should not be negative.\");\n+                }\n                 offsetSum += offset;\n                 if (offsetSum < 0) {\n                     log.warn(\"Sum of changelog offsets for task {} overflowed, pinning to Long.MAX_VALUE\", id);\n"}}, {"oid": "f98207900282ef4d7a27980a4cc018216098236c", "url": "https://github.com/apache/kafka/commit/f98207900282ef4d7a27980a4cc018216098236c", "message": "Github comments", "committedDate": "2020-06-04T22:38:26Z", "type": "commit"}]}