{"pr_number": 9170, "pr_title": "KAFKA-10391: Overwrite checkpoint in task corruption to remove corrupted partitions", "pr_createdAt": "2020-08-12T16:53:55Z", "pr_url": "https://github.com/apache/kafka/pull/9170", "timeline": [{"oid": "39a6a0e3e58836ba8b3e611a200574bd5c3ae3ec", "url": "https://github.com/apache/kafka/commit/39a6a0e3e58836ba8b3e611a200574bd5c3ae3ec", "message": "enforce post commit on task corruption", "committedDate": "2020-08-12T04:58:04Z", "type": "commit"}, {"oid": "4288099ff38892fc9b02b9ea2eaa87a50adb64c1", "url": "https://github.com/apache/kafka/commit/4288099ff38892fc9b02b9ea2eaa87a50adb64c1", "message": "update unit test", "committedDate": "2020-08-12T16:51:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTQ1MDM0NQ==", "url": "https://github.com/apache/kafka/pull/9170#discussion_r469450345", "bodyText": "Why did this test change?", "author": "ableegoldman", "createdAt": "2020-08-12T18:15:20Z", "path": "streams/src/test/java/org/apache/kafka/streams/processor/internals/StreamTaskTest.java", "diffHunk": "@@ -1609,12 +1609,11 @@ public void shouldReturnStateManagerChangelogOffsets() {\n     }\n \n     @Test\n-    public void shouldCheckpointWithCreatedStateOnClose() {\n+    public void shouldNotCheckpointOnCloseCreated() {", "originalCommit": "4288099ff38892fc9b02b9ea2eaa87a50adb64c1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTUxNzA5OQ==", "url": "https://github.com/apache/kafka/pull/9170#discussion_r469517099", "bodyText": "It was the same as the other one, that it was wrong to begin with.", "author": "guozhangwang", "createdAt": "2020-08-12T20:21:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTQ1MDM0NQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTQ1MDU5Ng==", "url": "https://github.com/apache/kafka/pull/9170#discussion_r469450596", "bodyText": "Same with this one, why did it change? Or was the test just wrong to begin with..?", "author": "ableegoldman", "createdAt": "2020-08-12T18:15:46Z", "path": "streams/src/test/java/org/apache/kafka/streams/processor/internals/StreamTaskTest.java", "diffHunk": "@@ -1629,16 +1628,18 @@ public void shouldCheckpointWithCreatedStateOnClose() {\n         assertFalse(source1.initialized);\n         assertFalse(source1.closed);\n \n+        EasyMock.verify(stateManager, recordCollector);\n+\n         final double expectedCloseTaskMetric = 1.0;\n         verifyCloseTaskMetric(expectedCloseTaskMetric, streamsMetrics, metricName);\n     }\n \n     @Test\n-    public void shouldNotCheckpointOnCloseRestoringIfNoProgress() {\n+    public void shouldCheckpointOnCloseRestoringIfNoProgress() {", "originalCommit": "4288099ff38892fc9b02b9ea2eaa87a50adb64c1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTUwOTY4MA==", "url": "https://github.com/apache/kafka/pull/9170#discussion_r469509680", "bodyText": "partition group", "author": "abbccdda", "createdAt": "2020-08-12T20:06:15Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/TaskManager.java", "diffHunk": "@@ -193,13 +193,17 @@ private void closeAndRevive(final Map<Task, Collection<TopicPartition>> taskWith\n \n             try {\n                 task.suspend();\n+                // we need to enforce a checkpoint that removes the corrupted partitions\n+                task.postCommit(true);\n             } catch (final RuntimeException swallow) {\n                 log.error(\"Error suspending corrupted task {} \", task.id(), swallow);\n             }\n             task.closeDirty();\n+\n+            // For active tasks pause their input partitions so we won't poll any more records\n+            // for this task until it has been re-initialized;\n+            // Note, closeDirty already clears the partitiongroup for the task.", "originalCommit": "4288099ff38892fc9b02b9ea2eaa87a50adb64c1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTUxMDQwMQ==", "url": "https://github.com/apache/kafka/pull/9170#discussion_r469510401", "bodyText": "I'm not sure this is 100% ensuring the snapshot gets done, as we have branching logic in postCommit. Do you think we should just get a helper to cleanup instead?", "author": "abbccdda", "createdAt": "2020-08-12T20:07:41Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/TaskManager.java", "diffHunk": "@@ -193,13 +193,17 @@ private void closeAndRevive(final Map<Task, Collection<TopicPartition>> taskWith\n \n             try {\n                 task.suspend();\n+                // we need to enforce a checkpoint that removes the corrupted partitions\n+                task.postCommit(true);", "originalCommit": "4288099ff38892fc9b02b9ea2eaa87a50adb64c1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTUxNzU5NQ==", "url": "https://github.com/apache/kafka/pull/9170#discussion_r469517595", "bodyText": "Here since the task is guaranteed to be in SUSPENDED postCommit() is ensured to trigger checkpointing.", "author": "guozhangwang", "createdAt": "2020-08-12T20:22:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTUxMDQwMQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTUxMjAwMA==", "url": "https://github.com/apache/kafka/pull/9170#discussion_r469512000", "bodyText": "Could we move this logic to the StandbyTask only? It is the only case I have seen which could have null snapshot passed in, which could make this helper assume both snapshots are not null.\nif (oldOffsetSnapshot == null) {\n            return false;\t          \n}", "author": "abbccdda", "createdAt": "2020-08-12T20:11:06Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StateManagerUtil.java", "diffHunk": "@@ -58,6 +58,9 @@ static boolean checkpointNeeded(final boolean enforceCheckpoint,\n             return false;\n         }\n \n+        if (enforceCheckpoint)", "originalCommit": "4288099ff38892fc9b02b9ea2eaa87a50adb64c1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTUxODQwOQ==", "url": "https://github.com/apache/kafka/pull/9170#discussion_r469518409", "bodyText": "The null snapshot is for both active / standby tasks before the initializeIfNeeded is triggered, in that case, we should not overwrite the checkpoint even if it was enforced.", "author": "guozhangwang", "createdAt": "2020-08-12T20:24:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTUxMjAwMA=="}], "type": "inlineReview", "revised_code": null}]}