{"pr_number": 9539, "pr_title": "KAFKA-10634: Adding LeaderId to Voters list in LeaderChangeMessage", "pr_createdAt": "2020-10-31T06:00:57Z", "pr_url": "https://github.com/apache/kafka/pull/9539", "timeline": [{"oid": "ce275e29beb48611425708fbe67d28d17329845a", "url": "https://github.com/apache/kafka/commit/ce275e29beb48611425708fbe67d28d17329845a", "message": "KAFKA-10634: Adding LeaderId to Voters list in LeaderChangeMessage", "committedDate": "2020-11-27T18:06:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzU5Mzg2OA==", "url": "https://github.com/apache/kafka/pull/9539#discussion_r533593868", "bodyText": "I think the terminology may be causing some confusion here. The \"granting\" voters are those who have voted for the leader and which the leader is using as the basis of its election. The \"endorsing\" voters are those who have acknowledged the leader. The set of endorsing voters changes over time as the voters convert to followers and begin fetching. We use nonEndorsingVoters to know which voters still need to be sent BeginQuorumEpoch. Note that it is possible for a voter to have granted a vote, but not yet endorsed the election (because it does not know the vote succeeded).\nWe should not conflate these sets, but maybe we can come up with better terms to avoid the confusion. I would stick with \"granting\" voters as the set of voters who granted the leader's candidacy. However, maybe we can change \"endorsing\" to \"acknowledged\"? These are the voters who have acknowledged the election result. What do you think?", "author": "hachikuji", "createdAt": "2020-12-01T17:31:08Z", "path": "raft/src/main/java/org/apache/kafka/raft/LeaderState.java", "diffHunk": "@@ -72,11 +73,20 @@ public int epoch() {\n         return voterReplicaStates.keySet().stream().filter(id -> id != localId).collect(Collectors.toSet());\n     }\n \n+    public Set<Integer> endorsingVoters() {", "originalCommit": "ce275e29beb48611425708fbe67d28d17329845a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDExODY4MQ==", "url": "https://github.com/apache/kafka/pull/9539#discussion_r534118681", "bodyText": "Yeah that makes sense. As you explained, endorsing are those voters who have acknowledged the BeginQuorumEpoch request from the leader, so eventually if the leader is accepted, this set will be all the voters who voted.\nRegarding endorsing v/s acknowledged, can we also add what has been acknowledged? Like, endoresedQuorumEpoch or endorsedLeaderCandidacy or something like this. Just adding context, might clear the confusion. WDYT @hachikuji , @jsancio", "author": "vamossagar12", "createdAt": "2020-12-02T12:10:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzU5Mzg2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ3NzUxNg==", "url": "https://github.com/apache/kafka/pull/9539#discussion_r534477516", "bodyText": "Good to know the subtle difference. \"acknowledged\" sounds good to me.", "author": "jsancio", "createdAt": "2020-12-02T20:59:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzU5Mzg2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDkxMTIwNg==", "url": "https://github.com/apache/kafka/pull/9539#discussion_r534911206", "bodyText": "Ok. I will change it to acknowledged then..", "author": "vamossagar12", "createdAt": "2020-12-03T08:28:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzU5Mzg2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjczNTcwOA==", "url": "https://github.com/apache/kafka/pull/9539#discussion_r536735708", "bodyText": "@jsancio , going by all the discussions here, I needed to revert some of the changes you had suggested in #9539 (comment) as a couple of test cases were failing. The issue is on this line:\n\n  \n    \n      kafka/raft/src/main/java/org/apache/kafka/raft/LeaderState.java\n    \n    \n         Line 52\n      in\n      ce275e2\n    \n    \n    \n    \n\n        \n          \n           boolean hasEndorsedLeader = grantingVoters.contains(voterId); \n        \n    \n  \n\n\nNote that, this is a deviation from the original code which was:\nboolean hasEndorsedLeader = voterId == localId;\nand the test case which was failing because of this was this line in particular:\nhttps://github.com/apache/kafka/pull/9539/files#diff-01c9950503611c357b85ef5b8850d2fbc6060075ce028bf4f86dfc6cbd63fd3cR255\nReason being, when transitionToLeader is invoked from QuorumState upon becoming the leader, it passes in the set of granting voters. Keeping in mind the explanation provided by @hachikuji above, these are all the voters who voted for the current leader.\nIf you check the above erroneous condition, we are checking if a voter has endorsed the voting by checking if it is present in the granting voters list:\nboolean hasEndorsedLeader = grantingVoters.contains(voterId);\nSo, the problem is, this condition will force all voters to be considered as having endorsed the Leader even before the BeginQuorumEpoch request response dance has begun.\nThe test cases in question fails because the pollLeader() method in KafkaRaftClient, checks the nonEndorsingVoters and sends the BeginQuorumEpoch request to nonEndorsed ones here:\nlong timeUntilSend = maybeSendRequests(\n            currentTimeMs,\n            state.nonEndorsingVoters(),\n            this::buildBeginQuorumEpochRequest\n        );\n\nbut it never gets to do that because every granting voter has been marked as an endorsed voter.\nLastly, we don't really need the acknowledgedVoters here because all we need are the granting voters in the LeaderChangeMessage i.e the voters who voted for the Leader in the current  epoch.\nSo, I am reverting the changes and now, the test cases have all passed as well. There were some timeout related errors as well which I believe which got resolved as well.", "author": "vamossagar12", "createdAt": "2020-12-05T12:47:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzU5Mzg2OA=="}], "type": "inlineReview", "revised_code": {"commit": "f57c6c50981c7b633a67c4cd9eeac08235706e36", "chunk": "diff --git a/raft/src/main/java/org/apache/kafka/raft/LeaderState.java b/raft/src/main/java/org/apache/kafka/raft/LeaderState.java\nindex ea6797310d..1d810a9c22 100644\n--- a/raft/src/main/java/org/apache/kafka/raft/LeaderState.java\n+++ b/raft/src/main/java/org/apache/kafka/raft/LeaderState.java\n\n@@ -73,13 +75,8 @@ public class LeaderState implements EpochState {\n         return voterReplicaStates.keySet().stream().filter(id -> id != localId).collect(Collectors.toSet());\n     }\n \n-    public Set<Integer> endorsingVoters() {\n-        return voterReplicaStates\n-            .values()\n-            .stream()\n-            .filter(voter -> voter.hasEndorsedLeader)\n-            .map(voter -> voter.nodeId)\n-            .collect(Collectors.toSet());\n+    public Set<Integer> grantingVoters() {\n+        return this.grantingVoters;\n     }\n \n     public int localId() {\n"}}, {"oid": "f57c6c50981c7b633a67c4cd9eeac08235706e36", "url": "https://github.com/apache/kafka/commit/f57c6c50981c7b633a67c4cd9eeac08235706e36", "message": "KAFKA-10634: Adding LeaderId to Voters list in LeaderChangeMessage", "committedDate": "2020-12-05T12:49:01Z", "type": "forcePushed"}, {"oid": "16432f8e9a89a11ffd862efe67f9ddc27a85642a", "url": "https://github.com/apache/kafka/commit/16432f8e9a89a11ffd862efe67f9ddc27a85642a", "message": "KAFKA-10634: Adding LeaderId to Voters list in LeaderChangeMessage", "committedDate": "2020-12-08T02:56:09Z", "type": "commit"}, {"oid": "16432f8e9a89a11ffd862efe67f9ddc27a85642a", "url": "https://github.com/apache/kafka/commit/16432f8e9a89a11ffd862efe67f9ddc27a85642a", "message": "KAFKA-10634: Adding LeaderId to Voters list in LeaderChangeMessage", "committedDate": "2020-12-08T02:56:09Z", "type": "forcePushed"}]}