{"pr_number": 9075, "pr_title": "KAFKA-10306: GlobalThread should fail on InvalidOffsetException", "pr_createdAt": "2020-07-24T21:37:01Z", "pr_url": "https://github.com/apache/kafka/pull/9075", "timeline": [{"oid": "edfc3f2dc015b9f3736b9d13a79c79abb86c4dff", "url": "https://github.com/apache/kafka/commit/edfc3f2dc015b9f3736b9d13a79c79abb86c4dff", "message": "KAFKA-10306: GlobalThread should fail on InvalidOffsetException", "committedDate": "2020-07-24T21:34:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDMwMDY2NA==", "url": "https://github.com/apache/kafka/pull/9075#discussion_r460300664", "bodyText": "This is the actual bug: we swallow the exception. However, because we don't do any \"seek\", we just hit the same exception in poll() over and over and never recover but loop forever.", "author": "mjsax", "createdAt": "2020-07-24T21:42:11Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStateManagerImpl.java", "diffHunk": "@@ -291,27 +290,17 @@ private void restoreState(final StateRestoreCallback stateRestoreCallback,\n             long restoreCount = 0L;\n \n             while (offset < highWatermark) {\n-                try {\n-                    final ConsumerRecords<byte[], byte[]> records = globalConsumer.poll(pollTime);\n-                    final List<ConsumerRecord<byte[], byte[]>> restoreRecords = new ArrayList<>();\n-                    for (final ConsumerRecord<byte[], byte[]> record : records.records(topicPartition)) {\n-                        if (record.key() != null) {\n-                            restoreRecords.add(recordConverter.convert(record));\n-                        }\n+                final ConsumerRecords<byte[], byte[]> records = globalConsumer.poll(pollTime);\n+                final List<ConsumerRecord<byte[], byte[]>> restoreRecords = new ArrayList<>();\n+                for (final ConsumerRecord<byte[], byte[]> record : records.records(topicPartition)) {\n+                    if (record.key() != null) {\n+                        restoreRecords.add(recordConverter.convert(record));\n                     }\n-                    offset = globalConsumer.position(topicPartition);\n-                    stateRestoreAdapter.restoreBatch(restoreRecords);\n-                    stateRestoreListener.onBatchRestored(topicPartition, storeName, offset, restoreRecords.size());\n-                    restoreCount += restoreRecords.size();\n-                } catch (final InvalidOffsetException recoverableException) {", "originalCommit": "edfc3f2dc015b9f3736b9d13a79c79abb86c4dff", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDMwMjIyOA==", "url": "https://github.com/apache/kafka/pull/9075#discussion_r460302228", "bodyText": "We could also not wipe out the store and let the user do it manually. A manual cleanup is actually required nowadays, thus, it's actually a small side \"improvement\".\nNote that we wipe out the whole global task dir here -- in contrast, users could do a manual per-store wipe out... But as we do the same coarse grained wipe out for all tasks and we have already a ticket for \"per store cleanup\" I though it would be ok for now.\nLet me know what you think.", "author": "mjsax", "createdAt": "2020-07-24T21:47:06Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStateMaintainer.java", "diffHunk": "@@ -31,7 +31,7 @@\n \n     void flushState();\n \n-    void close() throws IOException;\n+    void close(final boolean wipeStateStore) throws IOException;", "originalCommit": "edfc3f2dc015b9f3736b9d13a79c79abb86c4dff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDMwNjU4Ng==", "url": "https://github.com/apache/kafka/pull/9075#discussion_r460306586", "bodyText": "Thanks @mjsax , this sounds perfect to me.", "author": "vvcephei", "createdAt": "2020-07-24T22:01:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDMwMjIyOA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDMwMjU3Ng==", "url": "https://github.com/apache/kafka/pull/9075#discussion_r460302576", "bodyText": "We just let the original exception bubble up, to be able to wipe out the store. -- This is also just a side \"improvement\"; we could also just die and let users cleanup the state directory manually. However, it seems better to wipe it out directly.", "author": "mjsax", "createdAt": "2020-07-24T21:48:18Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStreamThread.java", "diffHunk": "@@ -234,24 +234,18 @@ void initialize() {\n         }\n \n         void pollAndUpdate() {\n-            try {\n-                final ConsumerRecords<byte[], byte[]> received = globalConsumer.poll(pollTime);\n-                for (final ConsumerRecord<byte[], byte[]> record : received) {\n-                    stateMaintainer.update(record);\n-                }\n-                final long now = time.milliseconds();\n-                if (now >= lastFlush + flushInterval) {\n-                    stateMaintainer.flushState();\n-                    lastFlush = now;\n-                }\n-            } catch (final InvalidOffsetException recoverableException) {", "originalCommit": "edfc3f2dc015b9f3736b9d13a79c79abb86c4dff", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDMwMzM0Mg==", "url": "https://github.com/apache/kafka/pull/9075#discussion_r460303342", "bodyText": "This test was broken: it throw the InvalidOffsetException only once and thus the second poll() succeeds -- however, this is not how a real consumer behalves.", "author": "mjsax", "createdAt": "2020-07-24T21:50:43Z", "path": "streams/src/test/java/org/apache/kafka/streams/processor/internals/GlobalStateManagerImplTest.java", "diffHunk": "@@ -323,21 +322,6 @@ public void shouldRestoreRecordsUpToHighwatermark() {\n         assertEquals(2, stateRestoreCallback.restored.size());\n     }\n \n-    @Test\n-    public void shouldRecoverFromInvalidOffsetExceptionAndRestoreRecords() {", "originalCommit": "edfc3f2dc015b9f3736b9d13a79c79abb86c4dff", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDMwMzQ5MQ==", "url": "https://github.com/apache/kafka/pull/9075#discussion_r460303491", "bodyText": "Just a little side cleanup :)", "author": "mjsax", "createdAt": "2020-07-24T21:51:11Z", "path": "streams/src/test/java/org/apache/kafka/streams/processor/internals/GlobalStreamThreadTest.java", "diffHunk": "@@ -128,10 +130,9 @@ public void shouldThrowStreamsExceptionOnStartupIfThereIsAStreamsException() {\n         assertFalse(globalStreamThread.stillRunning());\n     }\n \n-    @SuppressWarnings(\"unchecked\")", "originalCommit": "edfc3f2dc015b9f3736b9d13a79c79abb86c4dff", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDMwNzQ3OQ==", "url": "https://github.com/apache/kafka/pull/9075#discussion_r460307479", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            log.error(\"Failed to wiping state stores for global task.\", e);\n          \n          \n            \n                            log.error(\"Failed to delete global task directory after detecting corruption.\", e);", "author": "vvcephei", "createdAt": "2020-07-24T22:04:26Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStateUpdateTask.java", "diffHunk": "@@ -114,8 +118,16 @@ public void flushState() {\n         stateMgr.checkpoint(offsets);\n     }\n \n-    public void close() throws IOException {\n+    public void close(final boolean wipeStateStore) throws IOException {\n         stateMgr.close();\n+        if (wipeStateStore) {\n+            try {\n+                log.error(\"Wiping state stores for global task.\");\n+                Utils.delete(stateMgr.baseDir());\n+            } catch (final IOException e) {\n+                log.error(\"Failed to wiping state stores for global task.\", e);", "originalCommit": "edfc3f2dc015b9f3736b9d13a79c79abb86c4dff", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "267b08168823116450e74f350d14ed1c1c4ec941", "chunk": "diff --git a/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStateUpdateTask.java b/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStateUpdateTask.java\nindex 45297ced47..86aaa5e554 100644\n--- a/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStateUpdateTask.java\n+++ b/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStateUpdateTask.java\n\n@@ -122,7 +122,7 @@ public class GlobalStateUpdateTask implements GlobalStateMaintainer {\n         stateMgr.close();\n         if (wipeStateStore) {\n             try {\n-                log.error(\"Wiping state stores for global task.\");\n+                log.info(\"Deleting global task directory after detecting corruption.\");\n                 Utils.delete(stateMgr.baseDir());\n             } catch (final IOException e) {\n                 log.error(\"Failed to wiping state stores for global task.\", e);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDMwNzg5Nw==", "url": "https://github.com/apache/kafka/pull/9075#discussion_r460307897", "bodyText": "This doesn't seem to be an error. Maybe info would be better? Also, I think \"wipe state stores\" might be confusing for a user looking at the log messages with no context. \"Deleting the task directory\" seems to be a more context-free statement of what we're doing.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            log.error(\"Wiping state stores for global task.\");\n          \n          \n            \n                            log.info(\"Deleting global task directory after detecting corruption.\");", "author": "vvcephei", "createdAt": "2020-07-24T22:05:51Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStateUpdateTask.java", "diffHunk": "@@ -114,8 +118,16 @@ public void flushState() {\n         stateMgr.checkpoint(offsets);\n     }\n \n-    public void close() throws IOException {\n+    public void close(final boolean wipeStateStore) throws IOException {\n         stateMgr.close();\n+        if (wipeStateStore) {\n+            try {\n+                log.error(\"Wiping state stores for global task.\");", "originalCommit": "edfc3f2dc015b9f3736b9d13a79c79abb86c4dff", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "267b08168823116450e74f350d14ed1c1c4ec941", "chunk": "diff --git a/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStateUpdateTask.java b/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStateUpdateTask.java\nindex 45297ced47..86aaa5e554 100644\n--- a/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStateUpdateTask.java\n+++ b/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStateUpdateTask.java\n\n@@ -122,7 +122,7 @@ public class GlobalStateUpdateTask implements GlobalStateMaintainer {\n         stateMgr.close();\n         if (wipeStateStore) {\n             try {\n-                log.error(\"Wiping state stores for global task.\");\n+                log.info(\"Deleting global task directory after detecting corruption.\");\n                 Utils.delete(stateMgr.baseDir());\n             } catch (final IOException e) {\n                 log.error(\"Failed to wiping state stores for global task.\", e);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDMwODg2Mw==", "url": "https://github.com/apache/kafka/pull/9075#discussion_r460308863", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            \"Updating global state failed. You can restart KafkaStreams to recover from this error.\",\n          \n          \n            \n                            \"Updating global state failed due to inconsistent local state. Will attempt to clean up the local state. You can restart KafkaStreams to recover from this error.\",\n          \n      \n    \n    \n  \n\nJust a thought to indicate why just restarting would recover anything.", "author": "vvcephei", "createdAt": "2020-07-24T22:09:27Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStreamThread.java", "diffHunk": "@@ -284,10 +278,21 @@ public void run() {\n         }\n         setState(State.RUNNING);\n \n+        boolean wipeStateStore = false;\n         try {\n             while (stillRunning()) {\n                 stateConsumer.pollAndUpdate();\n             }\n+        } catch (final InvalidOffsetException recoverableException) {\n+            wipeStateStore = true;\n+            log.error(\n+                \"Updating global state failed. You can restart KafkaStreams to recover from this error.\",", "originalCommit": "edfc3f2dc015b9f3736b9d13a79c79abb86c4dff", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "671958997493fe96fa07515ed023fabba3f4ce9c", "chunk": "diff --git a/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStreamThread.java b/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStreamThread.java\nindex f4e0e6e306..36b3b11f9d 100644\n--- a/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStreamThread.java\n+++ b/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStreamThread.java\n\n@@ -286,7 +286,7 @@ public class GlobalStreamThread extends Thread {\n         } catch (final InvalidOffsetException recoverableException) {\n             wipeStateStore = true;\n             log.error(\n-                \"Updating global state failed. You can restart KafkaStreams to recover from this error.\",\n+                \"Updating global state failed due to inconsistent local state. Will attempt to clean up the local state. You can restart KafkaStreams to recover from this error.\",\n                 recoverableException\n             );\n             throw new StreamsException(\n"}}, {"oid": "267b08168823116450e74f350d14ed1c1c4ec941", "url": "https://github.com/apache/kafka/commit/267b08168823116450e74f350d14ed1c1c4ec941", "message": "Update streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStateUpdateTask.java\n\nCo-authored-by: John Roesler <vvcephei@users.noreply.github.com>", "committedDate": "2020-07-24T22:33:42Z", "type": "commit"}, {"oid": "7a3eda44881452b019dfa2b4331a4f97deac8e03", "url": "https://github.com/apache/kafka/commit/7a3eda44881452b019dfa2b4331a4f97deac8e03", "message": "Update streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStateUpdateTask.java\n\nCo-authored-by: John Roesler <vvcephei@users.noreply.github.com>", "committedDate": "2020-07-24T22:33:56Z", "type": "commit"}, {"oid": "671958997493fe96fa07515ed023fabba3f4ce9c", "url": "https://github.com/apache/kafka/commit/671958997493fe96fa07515ed023fabba3f4ce9c", "message": "Update streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStreamThread.java\n\nCo-authored-by: John Roesler <vvcephei@users.noreply.github.com>", "committedDate": "2020-07-24T22:34:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDMxNTkxNA==", "url": "https://github.com/apache/kafka/pull/9075#discussion_r460315914", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                \"Bootstrapping global state failed. You can restart KafkaStreams to recover from this error.\",\n          \n          \n            \n                                \"Bootstrapping global state failed due to inconsistent local state. Will attempt to clean up the local state. You can restart KafkaStreams to recover from this error.\",", "author": "mjsax", "createdAt": "2020-07-24T22:34:38Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStreamThread.java", "diffHunk": "@@ -331,17 +336,36 @@ private StateConsumer initialize() {\n                 logContext,\n                 globalConsumer,\n                 new GlobalStateUpdateTask(\n+                    logContext,\n                     topology,\n                     globalProcessorContext,\n                     stateMgr,\n-                    config.defaultDeserializationExceptionHandler(),\n-                    logContext\n+                    config.defaultDeserializationExceptionHandler()\n                 ),\n                 time,\n                 Duration.ofMillis(config.getLong(StreamsConfig.POLL_MS_CONFIG)),\n                 config.getLong(StreamsConfig.COMMIT_INTERVAL_MS_CONFIG)\n             );\n-            stateConsumer.initialize();\n+\n+            try {\n+                stateConsumer.initialize();\n+            } catch (final InvalidOffsetException recoverableException) {\n+                log.error(\n+                    \"Bootstrapping global state failed. You can restart KafkaStreams to recover from this error.\",", "originalCommit": "671958997493fe96fa07515ed023fabba3f4ce9c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3a2492620431421f5fdb702dea0046e23e575a30", "chunk": "diff --git a/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStreamThread.java b/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStreamThread.java\nindex 36b3b11f9d..14d1ef89f6 100644\n--- a/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStreamThread.java\n+++ b/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStreamThread.java\n\n@@ -351,7 +351,7 @@ public class GlobalStreamThread extends Thread {\n                 stateConsumer.initialize();\n             } catch (final InvalidOffsetException recoverableException) {\n                 log.error(\n-                    \"Bootstrapping global state failed. You can restart KafkaStreams to recover from this error.\",\n+                    \"Bootstrapping global state failed due to inconsistent local state. Will attempt to clean up the local state. You can restart KafkaStreams to recover from this error.\",\n                     recoverableException\n                 );\n \n"}}, {"oid": "3a2492620431421f5fdb702dea0046e23e575a30", "url": "https://github.com/apache/kafka/commit/3a2492620431421f5fdb702dea0046e23e575a30", "message": "Update streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStreamThread.java", "committedDate": "2020-07-24T22:34:52Z", "type": "commit"}]}