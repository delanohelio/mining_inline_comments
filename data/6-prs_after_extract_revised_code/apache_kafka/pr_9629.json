{"pr_number": 9629, "pr_title": "KAFKA-10754: fix flaky tests by waiting kafka streams be in running state before assert", "pr_createdAt": "2020-11-20T07:44:52Z", "pr_url": "https://github.com/apache/kafka/pull/9629", "timeline": [{"oid": "0e1c0c110c1f4f9eb42bea62f9129ae3a7083c81", "url": "https://github.com/apache/kafka/commit/0e1c0c110c1f4f9eb42bea62f9129ae3a7083c81", "message": "KAFKA-10754: fix flaky tests by waiting kafka streams be in running state before assert", "committedDate": "2020-11-20T14:45:22Z", "type": "commit"}, {"oid": "0e1c0c110c1f4f9eb42bea62f9129ae3a7083c81", "url": "https://github.com/apache/kafka/commit/0e1c0c110c1f4f9eb42bea62f9129ae3a7083c81", "message": "KAFKA-10754: fix flaky tests by waiting kafka streams be in running state before assert", "committedDate": "2020-11-20T14:45:22Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzc0MTk0OA==", "url": "https://github.com/apache/kafka/pull/9629#discussion_r527741948", "bodyText": "We should wait for the uncaughtExceptionHandler got called before waiting for the streams state change.", "author": "showuon", "createdAt": "2020-11-20T14:49:19Z", "path": "streams/src/test/java/org/apache/kafka/streams/integration/StreamsUncaughtExceptionHandlerIntegrationTest.java", "diffHunk": "@@ -110,83 +110,45 @@ public void teardown() throws IOException {\n     }\n \n     @Test\n-    public void shouldShutdownThreadUsingOldHandler() throws Exception {\n+    public void shouldShutdownThreadUsingOldHandler() throws InterruptedException {\n         try (final KafkaStreams kafkaStreams = new KafkaStreams(builder.build(), properties)) {\n-            final CountDownLatch latch = new CountDownLatch(1);\n             final AtomicBoolean flag = new AtomicBoolean(false);\n             kafkaStreams.setUncaughtExceptionHandler((t, e) -> flag.set(true));\n \n             StreamsTestUtils.startKafkaStreamsAndWaitForRunningState(kafkaStreams);\n-\n             produceMessages(0L, inputTopic, \"A\");\n-            waitForApplicationState(Collections.singletonList(kafkaStreams), KafkaStreams.State.ERROR, Duration.ofSeconds(15));\n \n             TestUtils.waitForCondition(flag::get, \"Handler was called\");\n+            waitForApplicationState(Collections.singletonList(kafkaStreams), KafkaStreams.State.ERROR, DEFAULT_DURATION);", "originalCommit": "0e1c0c110c1f4f9eb42bea62f9129ae3a7083c81", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODk5MzUyMw==", "url": "https://github.com/apache/kafka/pull/9629#discussion_r528993523", "bodyText": "The order is not really that important here, either way works", "author": "wcarlson5", "createdAt": "2020-11-23T21:02:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzc0MTk0OA=="}], "type": "inlineReview", "revised_code": {"commit": "e6d39f6dc15a198a5a58d34d239a1021eeaf43b7", "chunk": "diff --git a/streams/src/test/java/org/apache/kafka/streams/integration/StreamsUncaughtExceptionHandlerIntegrationTest.java b/streams/src/test/java/org/apache/kafka/streams/integration/StreamsUncaughtExceptionHandlerIntegrationTest.java\nindex 7cdaa16a37..d24ec1e7dd 100644\n--- a/streams/src/test/java/org/apache/kafka/streams/integration/StreamsUncaughtExceptionHandlerIntegrationTest.java\n+++ b/streams/src/test/java/org/apache/kafka/streams/integration/StreamsUncaughtExceptionHandlerIntegrationTest.java\n\n@@ -121,7 +121,7 @@ public class StreamsUncaughtExceptionHandlerIntegrationTest {\n             TestUtils.waitForCondition(flag::get, \"Handler was called\");\n             waitForApplicationState(Collections.singletonList(kafkaStreams), KafkaStreams.State.ERROR, DEFAULT_DURATION);\n \n-            assertThat(processorValueCollector.size(), equalTo(2));\n+            assertThat(processorValueCollector.size(), equalTo(1));\n         }\n     }\n \n"}}, {"oid": "e6d39f6dc15a198a5a58d34d239a1021eeaf43b7", "url": "https://github.com/apache/kafka/commit/e6d39f6dc15a198a5a58d34d239a1021eeaf43b7", "message": "KAFKA-10754: fix shouldShutdownThreadUsingOldHandler by using only 1 stream thread", "committedDate": "2020-11-21T07:14:24Z", "type": "commit"}, {"oid": "e6d39f6dc15a198a5a58d34d239a1021eeaf43b7", "url": "https://github.com/apache/kafka/commit/e6d39f6dc15a198a5a58d34d239a1021eeaf43b7", "message": "KAFKA-10754: fix shouldShutdownThreadUsingOldHandler by using only 1 stream thread", "committedDate": "2020-11-21T07:14:24Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODk0MDk1Mw==", "url": "https://github.com/apache/kafka/pull/9629#discussion_r528940953", "bodyText": "I think this was actually correct as it was (and ditto for the above). One alternative suggestion:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * Set the handler invoked when an {@link StreamsConfig#NUM_STREAM_THREADS_CONFIG} internal thread\n          \n          \n            \n                 * Set the handler invoked when an internal {@link StreamsConfig#NUM_STREAM_THREADS_CONFIG stream thread}", "author": "ableegoldman", "createdAt": "2020-11-23T19:21:42Z", "path": "streams/src/main/java/org/apache/kafka/streams/KafkaStreams.java", "diffHunk": "@@ -379,13 +379,12 @@ public void setUncaughtExceptionHandler(final Thread.UncaughtExceptionHandler un\n     }\n \n     /**\n-     * Set the handler invoked when an {@link StreamsConfig#NUM_STREAM_THREADS_CONFIG internal thread}\n+     * Set the handler invoked when an {@link StreamsConfig#NUM_STREAM_THREADS_CONFIG} internal thread", "originalCommit": "e6d39f6dc15a198a5a58d34d239a1021eeaf43b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTE4MjU4MA==", "url": "https://github.com/apache/kafka/pull/9629#discussion_r529182580", "bodyText": "Updated. Thanks.", "author": "showuon", "createdAt": "2020-11-24T03:43:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODk0MDk1Mw=="}], "type": "inlineReview", "revised_code": {"commit": "2b6d0a2d285b5b7fc0a9a8474712870f6f7a767e", "chunk": "diff --git a/streams/src/main/java/org/apache/kafka/streams/KafkaStreams.java b/streams/src/main/java/org/apache/kafka/streams/KafkaStreams.java\nindex 4991c93fef..e0f079612c 100644\n--- a/streams/src/main/java/org/apache/kafka/streams/KafkaStreams.java\n+++ b/streams/src/main/java/org/apache/kafka/streams/KafkaStreams.java\n\n@@ -379,7 +379,7 @@ public class KafkaStreams implements AutoCloseable {\n     }\n \n     /**\n-     * Set the handler invoked when an {@link StreamsConfig#NUM_STREAM_THREADS_CONFIG} internal thread\n+     * Set the handler invoked when an internal {@link StreamsConfig#NUM_STREAM_THREADS_CONFIG stream thread}\n      * throws an unexpected exception.\n      * These might be exceptions indicating rare bugs in Kafka Streams, or they\n      * might be exceptions thrown by your code, for example a NullPointerException thrown from your processor logic.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODk0MjQwMQ==", "url": "https://github.com/apache/kafka/pull/9629#discussion_r528942401", "bodyText": "Hey @wcarlson5 , can you take a look at this? If we change the default number of threads to 1 will we be reducing test coverage or not testing the correct thing anymore?\nFWIW I think for tests where the number of threads doesn't matter, we should default to 1. But I'm not sure which tests do/do not rely on using multiple stream threads", "author": "ableegoldman", "createdAt": "2020-11-23T19:24:27Z", "path": "streams/src/test/java/org/apache/kafka/streams/integration/StreamsUncaughtExceptionHandlerIntegrationTest.java", "diffHunk": "@@ -97,7 +97,7 @@ public void setup() {\n                 mkEntry(StreamsConfig.BOOTSTRAP_SERVERS_CONFIG, CLUSTER.bootstrapServers()),\n                 mkEntry(StreamsConfig.APPLICATION_ID_CONFIG, appId),\n                 mkEntry(StreamsConfig.STATE_DIR_CONFIG, TestUtils.tempDirectory().getPath()),\n-                mkEntry(StreamsConfig.NUM_STREAM_THREADS_CONFIG, 2),\n+                mkEntry(StreamsConfig.NUM_STREAM_THREADS_CONFIG, 1),", "originalCommit": "e6d39f6dc15a198a5a58d34d239a1021eeaf43b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODk5Mjg4OQ==", "url": "https://github.com/apache/kafka/pull/9629#discussion_r528992889", "bodyText": "Yes, Both the old handler test and the close client should have 2 threads. We need to ensure that after a rebalance the old handler has attempted the process the record twice and the client shutdown only once. We can not be sure of that with only one thread.", "author": "wcarlson5", "createdAt": "2020-11-23T21:00:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODk0MjQwMQ=="}], "type": "inlineReview", "revised_code": {"commit": "2b6d0a2d285b5b7fc0a9a8474712870f6f7a767e", "chunk": "diff --git a/streams/src/test/java/org/apache/kafka/streams/integration/StreamsUncaughtExceptionHandlerIntegrationTest.java b/streams/src/test/java/org/apache/kafka/streams/integration/StreamsUncaughtExceptionHandlerIntegrationTest.java\nindex d24ec1e7dd..c7d9308e48 100644\n--- a/streams/src/test/java/org/apache/kafka/streams/integration/StreamsUncaughtExceptionHandlerIntegrationTest.java\n+++ b/streams/src/test/java/org/apache/kafka/streams/integration/StreamsUncaughtExceptionHandlerIntegrationTest.java\n\n@@ -97,7 +97,7 @@ public class StreamsUncaughtExceptionHandlerIntegrationTest {\n                 mkEntry(StreamsConfig.BOOTSTRAP_SERVERS_CONFIG, CLUSTER.bootstrapServers()),\n                 mkEntry(StreamsConfig.APPLICATION_ID_CONFIG, appId),\n                 mkEntry(StreamsConfig.STATE_DIR_CONFIG, TestUtils.tempDirectory().getPath()),\n-                mkEntry(StreamsConfig.NUM_STREAM_THREADS_CONFIG, 1),\n+                mkEntry(StreamsConfig.NUM_STREAM_THREADS_CONFIG, 2),\n                 mkEntry(StreamsConfig.DEFAULT_KEY_SERDE_CLASS_CONFIG, Serdes.StringSerde.class),\n                 mkEntry(StreamsConfig.DEFAULT_VALUE_SERDE_CLASS_CONFIG, Serdes.StringSerde.class)\n             )\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODk0MzM4OQ==", "url": "https://github.com/apache/kafka/pull/9629#discussion_r528943389", "bodyText": "@wcarlson5 for example, this test probably should have multiple threads, right?", "author": "ableegoldman", "createdAt": "2020-11-23T19:26:00Z", "path": "streams/src/test/java/org/apache/kafka/streams/integration/StreamsUncaughtExceptionHandlerIntegrationTest.java", "diffHunk": "@@ -110,83 +110,45 @@ public void teardown() throws IOException {\n     }\n \n     @Test\n-    public void shouldShutdownThreadUsingOldHandler() throws Exception {\n+    public void shouldShutdownThreadUsingOldHandler() throws InterruptedException {\n         try (final KafkaStreams kafkaStreams = new KafkaStreams(builder.build(), properties)) {\n-            final CountDownLatch latch = new CountDownLatch(1);\n             final AtomicBoolean flag = new AtomicBoolean(false);\n             kafkaStreams.setUncaughtExceptionHandler((t, e) -> flag.set(true));\n \n             StreamsTestUtils.startKafkaStreamsAndWaitForRunningState(kafkaStreams);\n-\n             produceMessages(0L, inputTopic, \"A\");\n-            waitForApplicationState(Collections.singletonList(kafkaStreams), KafkaStreams.State.ERROR, Duration.ofSeconds(15));\n \n             TestUtils.waitForCondition(flag::get, \"Handler was called\");\n-            assertThat(processorValueCollector.size(), equalTo(2));", "originalCommit": "e6d39f6dc15a198a5a58d34d239a1021eeaf43b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODk5Mjk4Ng==", "url": "https://github.com/apache/kafka/pull/9629#discussion_r528992986", "bodyText": "as above", "author": "wcarlson5", "createdAt": "2020-11-23T21:01:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODk0MzM4OQ=="}], "type": "inlineReview", "revised_code": {"commit": "2b6d0a2d285b5b7fc0a9a8474712870f6f7a767e", "chunk": "diff --git a/streams/src/test/java/org/apache/kafka/streams/integration/StreamsUncaughtExceptionHandlerIntegrationTest.java b/streams/src/test/java/org/apache/kafka/streams/integration/StreamsUncaughtExceptionHandlerIntegrationTest.java\nindex d24ec1e7dd..c7d9308e48 100644\n--- a/streams/src/test/java/org/apache/kafka/streams/integration/StreamsUncaughtExceptionHandlerIntegrationTest.java\n+++ b/streams/src/test/java/org/apache/kafka/streams/integration/StreamsUncaughtExceptionHandlerIntegrationTest.java\n\n@@ -112,16 +112,20 @@ public class StreamsUncaughtExceptionHandlerIntegrationTest {\n     @Test\n     public void shouldShutdownThreadUsingOldHandler() throws InterruptedException {\n         try (final KafkaStreams kafkaStreams = new KafkaStreams(builder.build(), properties)) {\n-            final AtomicBoolean flag = new AtomicBoolean(false);\n-            kafkaStreams.setUncaughtExceptionHandler((t, e) -> flag.set(true));\n+            final AtomicInteger counter = new AtomicInteger(0);\n+            kafkaStreams.setUncaughtExceptionHandler((t, e) -> counter.incrementAndGet());\n \n             StreamsTestUtils.startKafkaStreamsAndWaitForRunningState(kafkaStreams);\n             produceMessages(0L, inputTopic, \"A\");\n \n-            TestUtils.waitForCondition(flag::get, \"Handler was called\");\n+            // should call the UncaughtExceptionHandler in current thread\n+            TestUtils.waitForCondition(() -> counter.get() == 1, \"Handler was called 1st time\");\n+            // should call the UncaughtExceptionHandler after rebalancing to another thread\n+            TestUtils.waitForCondition(() -> counter.get() == 2, DEFAULT_DURATION.toMillis(), \"Handler was called 2nd time\");\n+            // the stream should now turn into ERROR state after 2 threads are dead\n             waitForApplicationState(Collections.singletonList(kafkaStreams), KafkaStreams.State.ERROR, DEFAULT_DURATION);\n \n-            assertThat(processorValueCollector.size(), equalTo(1));\n+            assertThat(processorValueCollector.size(), equalTo(2));\n         }\n     }\n \n"}}, {"oid": "2b6d0a2d285b5b7fc0a9a8474712870f6f7a767e", "url": "https://github.com/apache/kafka/commit/2b6d0a2d285b5b7fc0a9a8474712870f6f7a767e", "message": "KAFKA-10754: revert to set the default thread number as 2, and make the test more reliable", "committedDate": "2020-11-24T04:26:39Z", "type": "commit"}]}