{"pr_number": 9489, "pr_title": "MINOR: demote \"Committing task offsets\" log to DEBUG", "pr_createdAt": "2020-10-24T00:02:47Z", "pr_url": "https://github.com/apache/kafka/pull/9489", "timeline": [{"oid": "8b0cbf0f03fa0362ad20b54dab117b3a7130ab9f", "url": "https://github.com/apache/kafka/commit/8b0cbf0f03fa0362ad20b54dab117b3a7130ab9f", "message": "demote to debug", "committedDate": "2020-11-09T19:59:35Z", "type": "commit"}, {"oid": "8310e6a4e4ebc65ca7616d5fae7479b200e5d6ff", "url": "https://github.com/apache/kafka/commit/8310e6a4e4ebc65ca7616d5fae7479b200e5d6ff", "message": "add new INFO-level log in its place", "committedDate": "2020-11-10T01:41:47Z", "type": "commit"}, {"oid": "8310e6a4e4ebc65ca7616d5fae7479b200e5d6ff", "url": "https://github.com/apache/kafka/commit/8310e6a4e4ebc65ca7616d5fae7479b200e5d6ff", "message": "add new INFO-level log in its place", "committedDate": "2020-11-10T01:41:47Z", "type": "forcePushed"}, {"oid": "65f9dd7840f5f1da6811597ce499337e100dab07", "url": "https://github.com/apache/kafka/commit/65f9dd7840f5f1da6811597ce499337e100dab07", "message": "move INFO log", "committedDate": "2020-11-10T01:55:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDk1OTE3NA==", "url": "https://github.com/apache/kafka/pull/9489#discussion_r520959174", "bodyText": "Could we log the owned task here as well?", "author": "abbccdda", "createdAt": "2020-11-11T00:24:48Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java", "diffHunk": "@@ -703,6 +703,14 @@ void runOnce() {\n             // we record the ratio out of the while loop so that the accumulated latency spans over\n             // multiple iterations with reasonably large max.num.records and hence is less vulnerable to outliers\n             taskManager.recordTaskProcessRatio(totalProcessLatency, now);\n+\n+            // Only log this when we actually processed some records to avoid flooding INFO-level logs when there are\n+            // no records on the input topics\n+            if (totalProcessed > 0) {", "originalCommit": "65f9dd7840f5f1da6811597ce499337e100dab07", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "385fd21d07e8ecf890faaba64ea21025da3c3181", "chunk": "diff --git a/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java b/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java\nindex e9109cc232..44b4638cb4 100644\n--- a/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java\n+++ b/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java\n\n@@ -704,12 +704,14 @@ public class StreamThread extends Thread {\n             // multiple iterations with reasonably large max.num.records and hence is less vulnerable to outliers\n             taskManager.recordTaskProcessRatio(totalProcessLatency, now);\n \n-            // Only log this when we actually processed some records to avoid flooding INFO-level logs when there are\n-            // no records on the input topics\n+            // Only log this at INFO when we actually processed some records to avoid flooding INFO-level logs when\n+            // there are no records on the input topics\n             if (totalProcessed > 0) {\n-                log.info(\"Finished processing {} records, going to poll again\", totalProcessed);\n+                log.info(\"Processed {} records for tasks {}, polling for more records now\",\n+                         totalProcessed, taskManager.activeTaskIds());\n             } else {\n-                log.debug(\"Processed zero records, going to poll again\");\n+                log.debug(\"Processed {} records for tasks {}, polling for more records now\",\n+                          totalProcessed, taskManager.activeTaskIds());\n             }\n         }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDk2MTM2OA==", "url": "https://github.com/apache/kafka/pull/9489#discussion_r520961368", "bodyText": "Is it important to make the distinction between \"Processed zero records, going to poll again\" and \"Finished processing 0 records, going to poll again\"?\nAlso if we are not saying its processed anything maybe we should log what it is pulling from", "author": "wcarlson5", "createdAt": "2020-11-11T00:31:19Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java", "diffHunk": "@@ -703,6 +703,14 @@ void runOnce() {\n             // we record the ratio out of the while loop so that the accumulated latency spans over\n             // multiple iterations with reasonably large max.num.records and hence is less vulnerable to outliers\n             taskManager.recordTaskProcessRatio(totalProcessLatency, now);\n+\n+            // Only log this when we actually processed some records to avoid flooding INFO-level logs when there are\n+            // no records on the input topics\n+            if (totalProcessed > 0) {\n+                log.info(\"Finished processing {} records, going to poll again\", totalProcessed);\n+            } else {\n+                log.debug(\"Processed zero records, going to poll again\");", "originalCommit": "65f9dd7840f5f1da6811597ce499337e100dab07", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDk3MDk3Mg==", "url": "https://github.com/apache/kafka/pull/9489#discussion_r520970972", "bodyText": "Reworked it a bit, lmk what you think", "author": "ableegoldman", "createdAt": "2020-11-11T00:54:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDk2MTM2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTA1NTYxNQ==", "url": "https://github.com/apache/kafka/pull/9489#discussion_r521055615", "bodyText": "Looks good", "author": "wcarlson5", "createdAt": "2020-11-11T02:55:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDk2MTM2OA=="}], "type": "inlineReview", "revised_code": {"commit": "385fd21d07e8ecf890faaba64ea21025da3c3181", "chunk": "diff --git a/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java b/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java\nindex e9109cc232..44b4638cb4 100644\n--- a/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java\n+++ b/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java\n\n@@ -704,12 +704,14 @@ public class StreamThread extends Thread {\n             // multiple iterations with reasonably large max.num.records and hence is less vulnerable to outliers\n             taskManager.recordTaskProcessRatio(totalProcessLatency, now);\n \n-            // Only log this when we actually processed some records to avoid flooding INFO-level logs when there are\n-            // no records on the input topics\n+            // Only log this at INFO when we actually processed some records to avoid flooding INFO-level logs when\n+            // there are no records on the input topics\n             if (totalProcessed > 0) {\n-                log.info(\"Finished processing {} records, going to poll again\", totalProcessed);\n+                log.info(\"Processed {} records for tasks {}, polling for more records now\",\n+                         totalProcessed, taskManager.activeTaskIds());\n             } else {\n-                log.debug(\"Processed zero records, going to poll again\");\n+                log.debug(\"Processed {} records for tasks {}, polling for more records now\",\n+                          totalProcessed, taskManager.activeTaskIds());\n             }\n         }\n \n"}}, {"oid": "385fd21d07e8ecf890faaba64ea21025da3c3181", "url": "https://github.com/apache/kafka/commit/385fd21d07e8ecf890faaba64ea21025da3c3181", "message": "review feedback", "committedDate": "2020-11-11T00:53:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjIwMzQ4Mg==", "url": "https://github.com/apache/kafka/pull/9489#discussion_r522203482", "bodyText": "This line looks about the same as L665. I'm wondering if we really need the \"else\" in this case.", "author": "vvcephei", "createdAt": "2020-11-12T15:41:32Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java", "diffHunk": "@@ -703,6 +703,16 @@ void runOnce() {\n             // we record the ratio out of the while loop so that the accumulated latency spans over\n             // multiple iterations with reasonably large max.num.records and hence is less vulnerable to outliers\n             taskManager.recordTaskProcessRatio(totalProcessLatency, now);\n+\n+            // Only log this at INFO when we actually processed some records to avoid flooding INFO-level logs when\n+            // there are no records on the input topics\n+            if (totalProcessed > 0) {\n+                log.info(\"Processed {} records for tasks {}, polling for more records now\",\n+                         totalProcessed, taskManager.activeTaskIds());\n+            } else {\n+                log.debug(\"Processed {} records for tasks {}, polling for more records now\",", "originalCommit": "385fd21d07e8ecf890faaba64ea21025da3c3181", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjU3OTY0MQ==", "url": "https://github.com/apache/kafka/pull/9489#discussion_r522579641", "bodyText": "Fair enough", "author": "ableegoldman", "createdAt": "2020-11-13T02:56:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjIwMzQ4Mg=="}], "type": "inlineReview", "revised_code": {"commit": "06ddcbb164b94839c07b798044eaaa9fcc1aabb6", "chunk": "diff --git a/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java b/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java\nindex 44b4638cb4..90cb4d8d33 100644\n--- a/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java\n+++ b/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java\n\n@@ -704,15 +708,9 @@ public class StreamThread extends Thread {\n             // multiple iterations with reasonably large max.num.records and hence is less vulnerable to outliers\n             taskManager.recordTaskProcessRatio(totalProcessLatency, now);\n \n-            // Only log this at INFO when we actually processed some records to avoid flooding INFO-level logs when\n-            // there are no records on the input topics\n-            if (totalProcessed > 0) {\n-                log.info(\"Processed {} records for tasks {}, polling for more records now\",\n-                         totalProcessed, taskManager.activeTaskIds());\n-            } else {\n-                log.debug(\"Processed {} records for tasks {}, polling for more records now\",\n-                          totalProcessed, taskManager.activeTaskIds());\n-            }\n+            log.info(\"Processed {} total records, ran {} punctuators, and committed {} total tasks \" +\n+                        \"for active tasks {} and standby tasks {}\",\n+                     totalProcessed, totalPunctuated, totalCommitted, taskManager.activeTaskIds(), taskManager.standbyTaskIds());\n         }\n \n         now = time.milliseconds();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjIwNTk1OQ==", "url": "https://github.com/apache/kafka/pull/9489#discussion_r522205959", "bodyText": "Since this is at the end of runOnce, I'm wondering if it also makes sense to log whether we committed or punctuated, and whether/how many records we polled at the beginning of the method.\nBasically, it seems like, if it's a good idea to log some information once per cycle, then it's probably a good idea to summarize everything you'd want to know.", "author": "vvcephei", "createdAt": "2020-11-12T15:44:40Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java", "diffHunk": "@@ -703,6 +703,16 @@ void runOnce() {\n             // we record the ratio out of the while loop so that the accumulated latency spans over\n             // multiple iterations with reasonably large max.num.records and hence is less vulnerable to outliers\n             taskManager.recordTaskProcessRatio(totalProcessLatency, now);\n+\n+            // Only log this at INFO when we actually processed some records to avoid flooding INFO-level logs when\n+            // there are no records on the input topics\n+            if (totalProcessed > 0) {\n+                log.info(\"Processed {} records for tasks {}, polling for more records now\",", "originalCommit": "385fd21d07e8ecf890faaba64ea21025da3c3181", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjU5MTAxMw==", "url": "https://github.com/apache/kafka/pull/9489#discussion_r522591013", "bodyText": "Yeah good call. I promoted one of the debug logs you added earlier to log the number of records polled at INFO. I think this should be reasonable but we can always demote it again if it's still showing up too frequently", "author": "ableegoldman", "createdAt": "2020-11-13T03:28:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjIwNTk1OQ=="}], "type": "inlineReview", "revised_code": {"commit": "06ddcbb164b94839c07b798044eaaa9fcc1aabb6", "chunk": "diff --git a/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java b/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java\nindex 44b4638cb4..90cb4d8d33 100644\n--- a/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java\n+++ b/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java\n\n@@ -704,15 +708,9 @@ public class StreamThread extends Thread {\n             // multiple iterations with reasonably large max.num.records and hence is less vulnerable to outliers\n             taskManager.recordTaskProcessRatio(totalProcessLatency, now);\n \n-            // Only log this at INFO when we actually processed some records to avoid flooding INFO-level logs when\n-            // there are no records on the input topics\n-            if (totalProcessed > 0) {\n-                log.info(\"Processed {} records for tasks {}, polling for more records now\",\n-                         totalProcessed, taskManager.activeTaskIds());\n-            } else {\n-                log.debug(\"Processed {} records for tasks {}, polling for more records now\",\n-                          totalProcessed, taskManager.activeTaskIds());\n-            }\n+            log.info(\"Processed {} total records, ran {} punctuators, and committed {} total tasks \" +\n+                        \"for active tasks {} and standby tasks {}\",\n+                     totalProcessed, totalPunctuated, totalCommitted, taskManager.activeTaskIds(), taskManager.standbyTaskIds());\n         }\n \n         now = time.milliseconds();\n"}}, {"oid": "06ddcbb164b94839c07b798044eaaa9fcc1aabb6", "url": "https://github.com/apache/kafka/commit/06ddcbb164b94839c07b798044eaaa9fcc1aabb6", "message": "review feedback", "committedDate": "2020-11-13T03:29:06Z", "type": "commit"}, {"oid": "06ddcbb164b94839c07b798044eaaa9fcc1aabb6", "url": "https://github.com/apache/kafka/commit/06ddcbb164b94839c07b798044eaaa9fcc1aabb6", "message": "review feedback", "committedDate": "2020-11-13T03:29:06Z", "type": "forcePushed"}]}