{"pr_number": 8154, "pr_title": "KAFKA-9530; Fix flaky test `testDescribeGroupWithShortInitializationTimeout`", "pr_createdAt": "2020-02-21T21:59:13Z", "pr_url": "https://github.com/apache/kafka/pull/8154", "timeline": [{"oid": "9d70807baae0ad6bb5f248d606900ac562ae8483", "url": "https://github.com/apache/kafka/commit/9d70807baae0ad6bb5f248d606900ac562ae8483", "message": "KAFKA-9530; Fix flaky test `testDescribeGroupWithShortInitializationTimeout`", "committedDate": "2020-02-21T22:42:46Z", "type": "commit"}, {"oid": "9d70807baae0ad6bb5f248d606900ac562ae8483", "url": "https://github.com/apache/kafka/commit/9d70807baae0ad6bb5f248d606900ac562ae8483", "message": "KAFKA-9530; Fix flaky test `testDescribeGroupWithShortInitializationTimeout`", "committedDate": "2020-02-21T22:42:46Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg1MDk1MQ==", "url": "https://github.com/apache/kafka/pull/8154#discussion_r382850951", "bodyText": "nit: retriable", "author": "abbccdda", "createdAt": "2020-02-21T23:21:02Z", "path": "clients/src/main/java/org/apache/kafka/clients/admin/KafkaAdminClient.java", "diffHunk": "@@ -729,13 +725,10 @@ final void fail(long now, Throwable throwable) {\n             tries++;\n             nextAllowedTryMs = now + retryBackoffMs;\n \n+\n             // If the call has timed out, fail.\n             if (calcTimeoutMsRemainingAsInt(now, deadlineMs) < 0) {\n-                if (log.isDebugEnabled()) {\n-                    log.debug(\"{} timed out at {} after {} attempt(s)\", this, now, tries,\n-                        new Exception(prettyPrintException(throwable)));\n-                }\n-                handleFailure(throwable);\n+                failWithTimeout(now, throwable);\n                 return;\n             }\n             // If the exception is not retryable, fail.", "originalCommit": "9d70807baae0ad6bb5f248d606900ac562ae8483", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a1db9a0ab0808dedd4dad0fb4651307437e989a9", "chunk": "diff --git a/clients/src/main/java/org/apache/kafka/clients/admin/KafkaAdminClient.java b/clients/src/main/java/org/apache/kafka/clients/admin/KafkaAdminClient.java\nindex fb318ed954..5ad8b79912 100644\n--- a/clients/src/main/java/org/apache/kafka/clients/admin/KafkaAdminClient.java\n+++ b/clients/src/main/java/org/apache/kafka/clients/admin/KafkaAdminClient.java\n\n@@ -725,13 +725,12 @@ public class KafkaAdminClient extends AdminClient {\n             tries++;\n             nextAllowedTryMs = now + retryBackoffMs;\n \n-\n             // If the call has timed out, fail.\n             if (calcTimeoutMsRemainingAsInt(now, deadlineMs) < 0) {\n                 failWithTimeout(now, throwable);\n                 return;\n             }\n-            // If the exception is not retryable, fail.\n+            // If the exception is not retriable, fail.\n             if (!(throwable instanceof RetriableException)) {\n                 if (log.isDebugEnabled()) {\n                     log.debug(\"{} failed with non-retriable exception after {} attempt(s)\", this, tries,\n"}}, {"oid": "a1db9a0ab0808dedd4dad0fb4651307437e989a9", "url": "https://github.com/apache/kafka/commit/a1db9a0ab0808dedd4dad0fb4651307437e989a9", "message": "retryable -> retriable", "committedDate": "2020-02-22T01:18:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg5MjQ3OQ==", "url": "https://github.com/apache/kafka/pull/8154#discussion_r382892479", "bodyText": "Below, we have a case where we throw the underlying exception if we run out of retries. Is that intentional?", "author": "ijuma", "createdAt": "2020-02-22T06:58:30Z", "path": "clients/src/main/java/org/apache/kafka/clients/admin/KafkaAdminClient.java", "diffHunk": "@@ -731,14 +727,10 @@ final void fail(long now, Throwable throwable) {\n \n             // If the call has timed out, fail.\n             if (calcTimeoutMsRemainingAsInt(now, deadlineMs) < 0) {\n-                if (log.isDebugEnabled()) {\n-                    log.debug(\"{} timed out at {} after {} attempt(s)\", this, now, tries,\n-                        new Exception(prettyPrintException(throwable)));\n-                }\n-                handleFailure(throwable);\n+                failWithTimeout(now, throwable);", "originalCommit": "a1db9a0ab0808dedd4dad0fb4651307437e989a9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjkzMDE2NA==", "url": "https://github.com/apache/kafka/pull/8154#discussion_r382930164", "bodyText": "Yeah, I was debating changing that one too. If retries are exhausted, do we consider that a timeout? I guess it's defensible.", "author": "hachikuji", "createdAt": "2020-02-22T18:01:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg5MjQ3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjkzMTYwOA==", "url": "https://github.com/apache/kafka/pull/8154#discussion_r382931608", "bodyText": "Right, if retries are exhausted and it's a retriable exception, then it seems like it should be a TimeoutException.", "author": "ijuma", "createdAt": "2020-02-22T18:26:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg5MjQ3OQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "631112b9a9396db915652297da6ae80157cd42a1", "url": "https://github.com/apache/kafka/commit/631112b9a9396db915652297da6ae80157cd42a1", "message": "Use TimeoutException when retries are exhausted", "committedDate": "2020-02-22T22:48:48Z", "type": "commit"}]}