{"pr_number": 8285, "pr_title": "KAFKA-9700:Fix negative estimatedCompressionRatio issue", "pr_createdAt": "2020-03-12T07:12:08Z", "pr_url": "https://github.com/apache/kafka/pull/8285", "timeline": [{"oid": "61ae1266c655b7e516aa18d54f4c0a9683332b6a", "url": "https://github.com/apache/kafka/commit/61ae1266c655b7e516aa18d54f4c0a9683332b6a", "message": "Fix negative estimatedCompressionRatio issue\n\nThere are cases that currentEstimation is smaller than\nCOMPRESSION_RATIO_IMPROVING_STEP and it will get negative\nestimatedCompressionRatio,which leads to misjudgment\nabout if there is no room and MESSAGE_TOO_LARGE might occur.\n\nChange-Id: I0932a2a6ca669f673ab5d862d3fe7b2bb6d96ff6\nSigned-off-by: Jiamei Xie <jiamei.xie@arm.com>", "committedDate": "2020-03-12T07:04:11Z", "type": "commit"}, {"oid": "36d7cb7d7200ccff56fa7387b214a434fcb2beff", "url": "https://github.com/apache/kafka/commit/36d7cb7d7200ccff56fa7387b214a434fcb2beff", "message": "Fix negative estimatedCompressionRatio issue\n\nThere are cases that currentEstimation is smaller than\nCOMPRESSION_RATIO_IMPROVING_STEP and it will get negative\nestimatedCompressionRatio,which leads to misjudgment\nabout if there is no room and MESSAGE_TOO_LARGE might occur.\n\nChange-Id: I0932a2a6ca669f673ab5d862d3fe7b2bb6d96ff6\nSigned-off-by: Jiamei Xie <jiamei.xie@arm.com>", "committedDate": "2020-03-13T09:42:49Z", "type": "commit"}, {"oid": "f998cdf26e0b1fbc464908207be5cdb72bbba921", "url": "https://github.com/apache/kafka/commit/f998cdf26e0b1fbc464908207be5cdb72bbba921", "message": "Merge branch 'trunk' of https://github.com/apache/kafka into negative", "committedDate": "2020-03-13T09:47:56Z", "type": "commit"}, {"oid": "0153dc7837dd95c456b4bf6048df19b0f86d7291", "url": "https://github.com/apache/kafka/commit/0153dc7837dd95c456b4bf6048df19b0f86d7291", "message": "Merge remote-tracking branch 'origin/negative' into negative", "committedDate": "2020-03-13T09:55:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzgxMjM0NQ==", "url": "https://github.com/apache/kafka/pull/8285#discussion_r393812345", "bodyText": "It seems like we are duplicating a lot of the logic of the code in this comment. This is likely to get stale over time. Can we make the comment more concise and refer to the non test code for more detail?", "author": "ijuma", "createdAt": "2020-03-17T16:33:30Z", "path": "clients/src/test/java/org/apache/kafka/common/record/CompressionRatioEstimatorTest.java", "diffHunk": "@@ -0,0 +1,63 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.kafka.common.record;\n+\n+import org.junit.Test;\n+import static org.junit.Assert.assertTrue;\n+\n+public class CompressionRatioEstimatorTest {\n+    @Test\n+    public void testUpdateEstimation() {\n+        String topic = \"tp\";\n+        class EstimationsObservedRatios {\n+            float currentEstimation;\n+            float observedRatio;\n+            float expected;\n+            EstimationsObservedRatios(float currentEstimation, float observedRatio, float expected) {\n+                this.currentEstimation = currentEstimation;\n+                this.observedRatio = observedRatio;\n+                this.expected = expected;\n+            }\n+        }\n+\n+        // Method updateEstimation is to update compressionRatioForTopic according to observedRatio and currentEstimation.\n+        // If currentEstimation is smaller than observedRatio, update compressionRatioForTopic to\n+        // Math.max(currentEstimation + COMPRESSION_RATIO_DETERIORATE_STEP, observedRatio)\n+        // If currentEstimation is larger than observedRatio, update compressionRatioForTopic to\n+        // Math.max(currentEstimation - COMPRESSION_RATIO_IMPROVING_STEP, observedRatio).\n+        // COMPRESSION_RATIO_DETERIORATE_STEP is 0.05f. COMPRESSION_RATIO_IMPROVING_STEP is 0.005f.\n+        // There are four cases:\n+        // 1. currentEstimation < observedRatio && (currentEstimation + COMPRESSION_RATIO_DETERIORATE_STEP) < observedRatio\n+        // 2. currentEstimation < observedRatio && (currentEstimation + COMPRESSION_RATIO_DETERIORATE_STEP) > observedRatio\n+        // 3. currentEstimation > observedRatio && (currentEstimation - COMPRESSION_RATIO_IMPROVING_STEP) > observedRatio\n+        // 4. currentEstimation > observedRatio && (currentEstimation - COMPRESSION_RATIO_IMPROVING_STEP) < observedRatio\n+        // In all cases, updatedCompressionRatio shouldn't smaller than observedRatio", "originalCommit": "0153dc7837dd95c456b4bf6048df19b0f86d7291", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "7a34d39d5b76dbc3543853e71192a885801a81d2", "chunk": "diff --git a/clients/src/test/java/org/apache/kafka/common/record/CompressionRatioEstimatorTest.java b/clients/src/test/java/org/apache/kafka/common/record/CompressionRatioEstimatorTest.java\nindex d30145744e..27dcc6efa3 100644\n--- a/clients/src/test/java/org/apache/kafka/common/record/CompressionRatioEstimatorTest.java\n+++ b/clients/src/test/java/org/apache/kafka/common/record/CompressionRatioEstimatorTest.java\n\n@@ -18,6 +18,7 @@ package org.apache.kafka.common.record;\n \n import org.junit.Test;\n import static org.junit.Assert.assertTrue;\n+import java.util.ArrayList;\n \n public class CompressionRatioEstimatorTest {\n     @Test\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzgxMjg4MQ==", "url": "https://github.com/apache/kafka/pull/8285#discussion_r393812881", "bodyText": "It seems that expected is always the same as observed? If so, why do we have 3 parameters instead of 2?", "author": "ijuma", "createdAt": "2020-03-17T16:34:16Z", "path": "clients/src/test/java/org/apache/kafka/common/record/CompressionRatioEstimatorTest.java", "diffHunk": "@@ -0,0 +1,63 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.kafka.common.record;\n+\n+import org.junit.Test;\n+import static org.junit.Assert.assertTrue;\n+\n+public class CompressionRatioEstimatorTest {\n+    @Test\n+    public void testUpdateEstimation() {\n+        String topic = \"tp\";\n+        class EstimationsObservedRatios {\n+            float currentEstimation;\n+            float observedRatio;\n+            float expected;\n+            EstimationsObservedRatios(float currentEstimation, float observedRatio, float expected) {\n+                this.currentEstimation = currentEstimation;\n+                this.observedRatio = observedRatio;\n+                this.expected = expected;\n+            }\n+        }\n+\n+        // Method updateEstimation is to update compressionRatioForTopic according to observedRatio and currentEstimation.\n+        // If currentEstimation is smaller than observedRatio, update compressionRatioForTopic to\n+        // Math.max(currentEstimation + COMPRESSION_RATIO_DETERIORATE_STEP, observedRatio)\n+        // If currentEstimation is larger than observedRatio, update compressionRatioForTopic to\n+        // Math.max(currentEstimation - COMPRESSION_RATIO_IMPROVING_STEP, observedRatio).\n+        // COMPRESSION_RATIO_DETERIORATE_STEP is 0.05f. COMPRESSION_RATIO_IMPROVING_STEP is 0.005f.\n+        // There are four cases:\n+        // 1. currentEstimation < observedRatio && (currentEstimation + COMPRESSION_RATIO_DETERIORATE_STEP) < observedRatio\n+        // 2. currentEstimation < observedRatio && (currentEstimation + COMPRESSION_RATIO_DETERIORATE_STEP) > observedRatio\n+        // 3. currentEstimation > observedRatio && (currentEstimation - COMPRESSION_RATIO_IMPROVING_STEP) > observedRatio\n+        // 4. currentEstimation > observedRatio && (currentEstimation - COMPRESSION_RATIO_IMPROVING_STEP) < observedRatio\n+        // In all cases, updatedCompressionRatio shouldn't smaller than observedRatio\n+        EstimationsObservedRatios[] currentEstimationsObservedRatios = new EstimationsObservedRatios[] {\n+            new EstimationsObservedRatios(0.8f, 0.84f, 0.84f),\n+            new EstimationsObservedRatios(0.6f, 0.7f, 0.7f),\n+            new EstimationsObservedRatios(0.6f, 0.4f, 0.4f),\n+            new EstimationsObservedRatios(0.004f, 0.001f, 0.001f)", "originalCommit": "0153dc7837dd95c456b4bf6048df19b0f86d7291", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "7a34d39d5b76dbc3543853e71192a885801a81d2", "chunk": "diff --git a/clients/src/test/java/org/apache/kafka/common/record/CompressionRatioEstimatorTest.java b/clients/src/test/java/org/apache/kafka/common/record/CompressionRatioEstimatorTest.java\nindex d30145744e..27dcc6efa3 100644\n--- a/clients/src/test/java/org/apache/kafka/common/record/CompressionRatioEstimatorTest.java\n+++ b/clients/src/test/java/org/apache/kafka/common/record/CompressionRatioEstimatorTest.java\n\n@@ -18,6 +18,7 @@ package org.apache.kafka.common.record;\n \n import org.junit.Test;\n import static org.junit.Assert.assertTrue;\n+import java.util.ArrayList;\n \n public class CompressionRatioEstimatorTest {\n     @Test\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzgxMzM2OQ==", "url": "https://github.com/apache/kafka/pull/8285#discussion_r393813369", "bodyText": "If we use a List, we should be able to simplify the logic below by using an enhanced for loop.", "author": "ijuma", "createdAt": "2020-03-17T16:35:01Z", "path": "clients/src/test/java/org/apache/kafka/common/record/CompressionRatioEstimatorTest.java", "diffHunk": "@@ -0,0 +1,63 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.kafka.common.record;\n+\n+import org.junit.Test;\n+import static org.junit.Assert.assertTrue;\n+\n+public class CompressionRatioEstimatorTest {\n+    @Test\n+    public void testUpdateEstimation() {\n+        String topic = \"tp\";\n+        class EstimationsObservedRatios {\n+            float currentEstimation;\n+            float observedRatio;\n+            float expected;\n+            EstimationsObservedRatios(float currentEstimation, float observedRatio, float expected) {\n+                this.currentEstimation = currentEstimation;\n+                this.observedRatio = observedRatio;\n+                this.expected = expected;\n+            }\n+        }\n+\n+        // Method updateEstimation is to update compressionRatioForTopic according to observedRatio and currentEstimation.\n+        // If currentEstimation is smaller than observedRatio, update compressionRatioForTopic to\n+        // Math.max(currentEstimation + COMPRESSION_RATIO_DETERIORATE_STEP, observedRatio)\n+        // If currentEstimation is larger than observedRatio, update compressionRatioForTopic to\n+        // Math.max(currentEstimation - COMPRESSION_RATIO_IMPROVING_STEP, observedRatio).\n+        // COMPRESSION_RATIO_DETERIORATE_STEP is 0.05f. COMPRESSION_RATIO_IMPROVING_STEP is 0.005f.\n+        // There are four cases:\n+        // 1. currentEstimation < observedRatio && (currentEstimation + COMPRESSION_RATIO_DETERIORATE_STEP) < observedRatio\n+        // 2. currentEstimation < observedRatio && (currentEstimation + COMPRESSION_RATIO_DETERIORATE_STEP) > observedRatio\n+        // 3. currentEstimation > observedRatio && (currentEstimation - COMPRESSION_RATIO_IMPROVING_STEP) > observedRatio\n+        // 4. currentEstimation > observedRatio && (currentEstimation - COMPRESSION_RATIO_IMPROVING_STEP) < observedRatio\n+        // In all cases, updatedCompressionRatio shouldn't smaller than observedRatio\n+        EstimationsObservedRatios[] currentEstimationsObservedRatios = new EstimationsObservedRatios[] {", "originalCommit": "0153dc7837dd95c456b4bf6048df19b0f86d7291", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "7a34d39d5b76dbc3543853e71192a885801a81d2", "chunk": "diff --git a/clients/src/test/java/org/apache/kafka/common/record/CompressionRatioEstimatorTest.java b/clients/src/test/java/org/apache/kafka/common/record/CompressionRatioEstimatorTest.java\nindex d30145744e..27dcc6efa3 100644\n--- a/clients/src/test/java/org/apache/kafka/common/record/CompressionRatioEstimatorTest.java\n+++ b/clients/src/test/java/org/apache/kafka/common/record/CompressionRatioEstimatorTest.java\n\n@@ -18,6 +18,7 @@ package org.apache.kafka.common.record;\n \n import org.junit.Test;\n import static org.junit.Assert.assertTrue;\n+import java.util.ArrayList;\n \n public class CompressionRatioEstimatorTest {\n     @Test\n"}}, {"oid": "7a34d39d5b76dbc3543853e71192a885801a81d2", "url": "https://github.com/apache/kafka/commit/7a34d39d5b76dbc3543853e71192a885801a81d2", "message": "Add test for CompressionRatioEstimator\n\nSigned-off-by: Jiamei Xie <jiamei.xie@arm.com>", "committedDate": "2020-03-18T04:28:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTEwOTk5NA==", "url": "https://github.com/apache/kafka/pull/8285#discussion_r395109994", "bodyText": "Nit: please add a line before @test.", "author": "ijuma", "createdAt": "2020-03-19T15:23:19Z", "path": "clients/src/test/java/org/apache/kafka/common/record/CompressionRatioEstimatorTest.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.kafka.common.record;\n+\n+import org.junit.Test;\n+import static org.junit.Assert.assertTrue;\n+import java.util.ArrayList;\n+\n+public class CompressionRatioEstimatorTest {\n+    @Test", "originalCommit": "7a34d39d5b76dbc3543853e71192a885801a81d2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e50dfdcc573035f90b73daeec19492827f356428", "chunk": "diff --git a/clients/src/test/java/org/apache/kafka/common/record/CompressionRatioEstimatorTest.java b/clients/src/test/java/org/apache/kafka/common/record/CompressionRatioEstimatorTest.java\nindex 27dcc6efa3..e4257ba63a 100644\n--- a/clients/src/test/java/org/apache/kafka/common/record/CompressionRatioEstimatorTest.java\n+++ b/clients/src/test/java/org/apache/kafka/common/record/CompressionRatioEstimatorTest.java\n\n@@ -18,9 +18,11 @@ package org.apache.kafka.common.record;\n \n import org.junit.Test;\n import static org.junit.Assert.assertTrue;\n-import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n \n public class CompressionRatioEstimatorTest {\n+\n     @Test\n     public void testUpdateEstimation() {\n         String topic = \"tp\";\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTExMDUzMg==", "url": "https://github.com/apache/kafka/pull/8285#discussion_r395110532", "bodyText": "Nit: this can be written more concisely by using Arrays.asList.", "author": "ijuma", "createdAt": "2020-03-19T15:23:57Z", "path": "clients/src/test/java/org/apache/kafka/common/record/CompressionRatioEstimatorTest.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.kafka.common.record;\n+\n+import org.junit.Test;\n+import static org.junit.Assert.assertTrue;\n+import java.util.ArrayList;\n+\n+public class CompressionRatioEstimatorTest {\n+    @Test\n+    public void testUpdateEstimation() {\n+        String topic = \"tp\";\n+        class EstimationsObservedRatios {\n+            float currentEstimation;\n+            float observedRatio;\n+            EstimationsObservedRatios(float currentEstimation, float observedRatio) {\n+                this.currentEstimation = currentEstimation;\n+                this.observedRatio = observedRatio;\n+            }\n+        }\n+\n+        // If currentEstimation is smaller than observedRatio, the updatedCompressionRatio is currentEstimation plus\n+        // COMPRESSION_RATIO_DETERIORATE_STEP 0.05, otherwise currentEstimation minus COMPRESSION_RATIO_IMPROVING_STEP\n+        // 0.005. There are four cases,and updatedCompressionRatio shouldn't smaller than observedRatio in all of cases.\n+        // Refer to non test code for more details.\n+        ArrayList<EstimationsObservedRatios> estimationsObservedRatios = new ArrayList<EstimationsObservedRatios>();\n+        estimationsObservedRatios.add(new EstimationsObservedRatios(0.8f, 0.84f));\n+        estimationsObservedRatios.add(new EstimationsObservedRatios(0.6f, 0.7f));\n+        estimationsObservedRatios.add(new EstimationsObservedRatios(0.6f, 0.4f));\n+        estimationsObservedRatios.add(new EstimationsObservedRatios(0.004f, 0.001f));", "originalCommit": "7a34d39d5b76dbc3543853e71192a885801a81d2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e50dfdcc573035f90b73daeec19492827f356428", "chunk": "diff --git a/clients/src/test/java/org/apache/kafka/common/record/CompressionRatioEstimatorTest.java b/clients/src/test/java/org/apache/kafka/common/record/CompressionRatioEstimatorTest.java\nindex 27dcc6efa3..e4257ba63a 100644\n--- a/clients/src/test/java/org/apache/kafka/common/record/CompressionRatioEstimatorTest.java\n+++ b/clients/src/test/java/org/apache/kafka/common/record/CompressionRatioEstimatorTest.java\n\n@@ -18,9 +18,11 @@ package org.apache.kafka.common.record;\n \n import org.junit.Test;\n import static org.junit.Assert.assertTrue;\n-import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n \n public class CompressionRatioEstimatorTest {\n+\n     @Test\n     public void testUpdateEstimation() {\n         String topic = \"tp\";\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTExMDY5NA==", "url": "https://github.com/apache/kafka/pull/8285#discussion_r395110694", "bodyText": "Nit: this brace should be on the previous line.", "author": "ijuma", "createdAt": "2020-03-19T15:24:10Z", "path": "clients/src/test/java/org/apache/kafka/common/record/CompressionRatioEstimatorTest.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.kafka.common.record;\n+\n+import org.junit.Test;\n+import static org.junit.Assert.assertTrue;\n+import java.util.ArrayList;\n+\n+public class CompressionRatioEstimatorTest {\n+    @Test\n+    public void testUpdateEstimation() {\n+        String topic = \"tp\";\n+        class EstimationsObservedRatios {\n+            float currentEstimation;\n+            float observedRatio;\n+            EstimationsObservedRatios(float currentEstimation, float observedRatio) {\n+                this.currentEstimation = currentEstimation;\n+                this.observedRatio = observedRatio;\n+            }\n+        }\n+\n+        // If currentEstimation is smaller than observedRatio, the updatedCompressionRatio is currentEstimation plus\n+        // COMPRESSION_RATIO_DETERIORATE_STEP 0.05, otherwise currentEstimation minus COMPRESSION_RATIO_IMPROVING_STEP\n+        // 0.005. There are four cases,and updatedCompressionRatio shouldn't smaller than observedRatio in all of cases.\n+        // Refer to non test code for more details.\n+        ArrayList<EstimationsObservedRatios> estimationsObservedRatios = new ArrayList<EstimationsObservedRatios>();\n+        estimationsObservedRatios.add(new EstimationsObservedRatios(0.8f, 0.84f));\n+        estimationsObservedRatios.add(new EstimationsObservedRatios(0.6f, 0.7f));\n+        estimationsObservedRatios.add(new EstimationsObservedRatios(0.6f, 0.4f));\n+        estimationsObservedRatios.add(new EstimationsObservedRatios(0.004f, 0.001f));\n+        float updatedCompressionRatio;\n+        for(EstimationsObservedRatios estimationsObservedRatio:estimationsObservedRatios)\n+        {", "originalCommit": "7a34d39d5b76dbc3543853e71192a885801a81d2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e50dfdcc573035f90b73daeec19492827f356428", "chunk": "diff --git a/clients/src/test/java/org/apache/kafka/common/record/CompressionRatioEstimatorTest.java b/clients/src/test/java/org/apache/kafka/common/record/CompressionRatioEstimatorTest.java\nindex 27dcc6efa3..e4257ba63a 100644\n--- a/clients/src/test/java/org/apache/kafka/common/record/CompressionRatioEstimatorTest.java\n+++ b/clients/src/test/java/org/apache/kafka/common/record/CompressionRatioEstimatorTest.java\n\n@@ -18,9 +18,11 @@ package org.apache.kafka.common.record;\n \n import org.junit.Test;\n import static org.junit.Assert.assertTrue;\n-import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n \n public class CompressionRatioEstimatorTest {\n+\n     @Test\n     public void testUpdateEstimation() {\n         String topic = \"tp\";\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTExMDkzNA==", "url": "https://github.com/apache/kafka/pull/8285#discussion_r395110934", "bodyText": "Nit: there should be a space before and after the colon.", "author": "ijuma", "createdAt": "2020-03-19T15:24:28Z", "path": "clients/src/test/java/org/apache/kafka/common/record/CompressionRatioEstimatorTest.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.kafka.common.record;\n+\n+import org.junit.Test;\n+import static org.junit.Assert.assertTrue;\n+import java.util.ArrayList;\n+\n+public class CompressionRatioEstimatorTest {\n+    @Test\n+    public void testUpdateEstimation() {\n+        String topic = \"tp\";\n+        class EstimationsObservedRatios {\n+            float currentEstimation;\n+            float observedRatio;\n+            EstimationsObservedRatios(float currentEstimation, float observedRatio) {\n+                this.currentEstimation = currentEstimation;\n+                this.observedRatio = observedRatio;\n+            }\n+        }\n+\n+        // If currentEstimation is smaller than observedRatio, the updatedCompressionRatio is currentEstimation plus\n+        // COMPRESSION_RATIO_DETERIORATE_STEP 0.05, otherwise currentEstimation minus COMPRESSION_RATIO_IMPROVING_STEP\n+        // 0.005. There are four cases,and updatedCompressionRatio shouldn't smaller than observedRatio in all of cases.\n+        // Refer to non test code for more details.\n+        ArrayList<EstimationsObservedRatios> estimationsObservedRatios = new ArrayList<EstimationsObservedRatios>();\n+        estimationsObservedRatios.add(new EstimationsObservedRatios(0.8f, 0.84f));\n+        estimationsObservedRatios.add(new EstimationsObservedRatios(0.6f, 0.7f));\n+        estimationsObservedRatios.add(new EstimationsObservedRatios(0.6f, 0.4f));\n+        estimationsObservedRatios.add(new EstimationsObservedRatios(0.004f, 0.001f));\n+        float updatedCompressionRatio;\n+        for(EstimationsObservedRatios estimationsObservedRatio:estimationsObservedRatios)", "originalCommit": "7a34d39d5b76dbc3543853e71192a885801a81d2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e50dfdcc573035f90b73daeec19492827f356428", "chunk": "diff --git a/clients/src/test/java/org/apache/kafka/common/record/CompressionRatioEstimatorTest.java b/clients/src/test/java/org/apache/kafka/common/record/CompressionRatioEstimatorTest.java\nindex 27dcc6efa3..e4257ba63a 100644\n--- a/clients/src/test/java/org/apache/kafka/common/record/CompressionRatioEstimatorTest.java\n+++ b/clients/src/test/java/org/apache/kafka/common/record/CompressionRatioEstimatorTest.java\n\n@@ -18,9 +18,11 @@ package org.apache.kafka.common.record;\n \n import org.junit.Test;\n import static org.junit.Assert.assertTrue;\n-import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n \n public class CompressionRatioEstimatorTest {\n+\n     @Test\n     public void testUpdateEstimation() {\n         String topic = \"tp\";\n"}}, {"oid": "e50dfdcc573035f90b73daeec19492827f356428", "url": "https://github.com/apache/kafka/commit/e50dfdcc573035f90b73daeec19492827f356428", "message": "Modify CompressionRatioEstimatorTest.java\n\nSigned-off-by: Jiamei Xie <jiamei.xie@arm.com>", "committedDate": "2020-03-24T01:54:33Z", "type": "commit"}, {"oid": "e50dfdcc573035f90b73daeec19492827f356428", "url": "https://github.com/apache/kafka/commit/e50dfdcc573035f90b73daeec19492827f356428", "message": "Modify CompressionRatioEstimatorTest.java\n\nSigned-off-by: Jiamei Xie <jiamei.xie@arm.com>", "committedDate": "2020-03-24T01:54:33Z", "type": "forcePushed"}, {"oid": "537c402a628b767295ba5a0de1fed85615e0ace5", "url": "https://github.com/apache/kafka/commit/537c402a628b767295ba5a0de1fed85615e0ace5", "message": "Formatting fixes", "committedDate": "2020-03-24T14:32:34Z", "type": "commit"}]}