{"pr_number": 8477, "pr_title": "KAFKA-9864: avoid expensive QuotaViolationException usage", "pr_createdAt": "2020-04-14T01:49:30Z", "pr_url": "https://github.com/apache/kafka/pull/8477", "timeline": [{"oid": "227ca86df24220727175b9465e9061268f279041", "url": "https://github.com/apache/kafka/commit/227ca86df24220727175b9465e9061268f279041", "message": "MINOR: QuotaViolationException should avoid String.format and stack trace", "committedDate": "2020-04-14T01:45:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzgyNjI3OA==", "url": "https://github.com/apache/kafka/pull/8477#discussion_r407826278", "bodyText": "I think we want to make the string computation lazy, but not lose info. We could do that by overriding toString.", "author": "ijuma", "createdAt": "2020-04-14T02:19:23Z", "path": "clients/src/main/java/org/apache/kafka/common/metrics/QuotaViolationException.java", "diffHunk": "@@ -30,11 +30,7 @@\n     private final double bound;\n \n     public QuotaViolationException(MetricName metricName, double value, double bound) {\n-        super(String.format(\n-                \"'%s' violated quota. Actual: %f, Threshold: %f\",\n-                metricName,\n-                value,\n-                bound));\n+        super(metricName + \" violated quota.\");", "originalCommit": "227ca86df24220727175b9465e9061268f279041", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzgyNzU5NQ==", "url": "https://github.com/apache/kafka/pull/8477#discussion_r407827595", "bodyText": "Great idea. I don't think it's currently used but it seems helpful. I'll change that.", "author": "lbradstreet", "createdAt": "2020-04-14T02:24:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzgyNjI3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzgzMTA2Mw==", "url": "https://github.com/apache/kafka/pull/8477#discussion_r407831063", "bodyText": "I've fixed this. toString for an example violation before and after both returned:\norg.apache.kafka.common.metrics.QuotaViolationException: 'MetricName [name=x, group=y, description=z, tags={}]' violated quota. Actual: 3.300000, Threshold: 3.300000", "author": "lbradstreet", "createdAt": "2020-04-14T02:37:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzgyNjI3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODE2MTIyNQ==", "url": "https://github.com/apache/kafka/pull/8477#discussion_r408161225", "bodyText": "Can we remove the allocation altogether in the constructor?", "author": "ijuma", "createdAt": "2020-04-14T14:03:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzgyNjI3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODE2ODc0Nw==", "url": "https://github.com/apache/kafka/pull/8477#discussion_r408168747", "bodyText": "Good point, now that toString is overridden I had actually just made that change and hadn't pushed it", "author": "lbradstreet", "createdAt": "2020-04-14T14:12:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzgyNjI3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODE4MzMxNw==", "url": "https://github.com/apache/kafka/pull/8477#discussion_r408183317", "bodyText": "Done", "author": "lbradstreet", "createdAt": "2020-04-14T14:31:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzgyNjI3OA=="}], "type": "inlineReview", "revised_code": {"commit": "0556d490ead260ec3c67790aa80855344e29ebd2", "chunk": "diff --git a/clients/src/main/java/org/apache/kafka/common/metrics/QuotaViolationException.java b/clients/src/main/java/org/apache/kafka/common/metrics/QuotaViolationException.java\nindex b22fc92c8e..7687d18018 100644\n--- a/clients/src/main/java/org/apache/kafka/common/metrics/QuotaViolationException.java\n+++ b/clients/src/main/java/org/apache/kafka/common/metrics/QuotaViolationException.java\n\n@@ -30,7 +30,7 @@ public class QuotaViolationException extends KafkaException {\n     private final double bound;\n \n     public QuotaViolationException(MetricName metricName, double value, double bound) {\n-        super(metricName + \" violated quota.\");\n+        super(\"Quota violated\");\n         this.metricName = metricName;\n         this.value = value;\n         this.bound = bound;\n"}}, {"oid": "3d5d7a38003a93d4ab3fe9c08593d046cc2fc058", "url": "https://github.com/apache/kafka/commit/3d5d7a38003a93d4ab3fe9c08593d046cc2fc058", "message": "Include additional information in toString", "committedDate": "2020-04-14T02:36:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODE2Mjk1MA==", "url": "https://github.com/apache/kafka/pull/8477#discussion_r408162950", "bodyText": "Do we need String.format here? Seems like String concat would be fine.", "author": "ijuma", "createdAt": "2020-04-14T14:05:06Z", "path": "clients/src/main/java/org/apache/kafka/common/metrics/QuotaViolationException.java", "diffHunk": "@@ -51,4 +47,20 @@ public double value() {\n     public double bound() {\n         return bound;\n     }\n+\n+    @Override\n+    public String toString() {\n+        return String.format(", "originalCommit": "3d5d7a38003a93d4ab3fe9c08593d046cc2fc058", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODE4MzEzMg==", "url": "https://github.com/apache/kafka/pull/8477#discussion_r408183132", "bodyText": "Sounds good. I figured it wasn't used so simply moved it but seems better to be safe.", "author": "lbradstreet", "createdAt": "2020-04-14T14:31:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODE2Mjk1MA=="}], "type": "inlineReview", "revised_code": {"commit": "a1ebc12bc98c16b8587b1ca965c2f3f50c30b761", "chunk": "diff --git a/clients/src/main/java/org/apache/kafka/common/metrics/QuotaViolationException.java b/clients/src/main/java/org/apache/kafka/common/metrics/QuotaViolationException.java\nindex bdd8159d38..3abf423510 100644\n--- a/clients/src/main/java/org/apache/kafka/common/metrics/QuotaViolationException.java\n+++ b/clients/src/main/java/org/apache/kafka/common/metrics/QuotaViolationException.java\n\n@@ -50,12 +49,13 @@ public class QuotaViolationException extends KafkaException {\n \n     @Override\n     public String toString() {\n-        return String.format(\n-                \"%s: '%s' violated quota. Actual: %f, Threshold: %f\",\n-                getClass().getName(),\n-                metricName,\n-                value,\n-                bound);\n+        return getClass().getName()\n+                + \": '\"\n+                + metricName\n+                + \"' violated quota. Actual: \"\n+                + value\n+                + \", Threshold: \"\n+                + bound;\n     }\n \n     /* avoid the expensive and stack trace for quota violation exceptions */\n"}}, {"oid": "0556d490ead260ec3c67790aa80855344e29ebd2", "url": "https://github.com/apache/kafka/commit/0556d490ead260ec3c67790aa80855344e29ebd2", "message": "Avoid string building, rely on toString now", "committedDate": "2020-04-14T14:08:45Z", "type": "commit"}, {"oid": "a1ebc12bc98c16b8587b1ca965c2f3f50c30b761", "url": "https://github.com/apache/kafka/commit/a1ebc12bc98c16b8587b1ca965c2f3f50c30b761", "message": "Avoid String.format use, avoid exceptional control flow in\nReplicationQuotaManager.", "committedDate": "2020-04-14T14:28:19Z", "type": "commit"}]}