{"pr_number": 8979, "pr_title": "KAFKA-10223; Use NOT_LEADER_OR_FOLLOWER instead of non-retriable REPLICA_NOT_AVAILABLE for consumers", "pr_createdAt": "2020-07-03T16:56:35Z", "pr_url": "https://github.com/apache/kafka/pull/8979", "timeline": [{"oid": "116b7b034a99c759d12ed1f2526fd79e8ebc1fa1", "url": "https://github.com/apache/kafka/commit/116b7b034a99c759d12ed1f2526fd79e8ebc1fa1", "message": "KAFKA-10223; Replace REPLICA_NOT_AVAILABLE with NOT_LEADER_OR_FOLLOWER", "committedDate": "2020-07-14T12:36:38Z", "type": "commit"}, {"oid": "8bcda5eb1adb331246de81fdb225540b990f557a", "url": "https://github.com/apache/kafka/commit/8bcda5eb1adb331246de81fdb225540b990f557a", "message": "Address review comments, remove some more usages of ReplicaNotAvailable", "committedDate": "2020-07-14T12:41:08Z", "type": "commit"}, {"oid": "8bcda5eb1adb331246de81fdb225540b990f557a", "url": "https://github.com/apache/kafka/commit/8bcda5eb1adb331246de81fdb225540b990f557a", "message": "Address review comments, remove some more usages of ReplicaNotAvailable", "committedDate": "2020-07-14T12:41:08Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQxMzUyNw==", "url": "https://github.com/apache/kafka/pull/8979#discussion_r455413527", "bodyText": "One nitpick on the naming. It seems a little strange that followers might return NOT_LEADER_OR_FOLLOWER for requests which are intended for the leader. I think my suggestion to frame the name around the broker not being the intended target of the request was a little more accurate, though I admit the name was clumsier. Perhaps this class would be a good place to document the semantics? Maybe worth mentioning the Produce/Fetch behavior explicitly.", "author": "hachikuji", "createdAt": "2020-07-15T23:02:32Z", "path": "clients/src/main/java/org/apache/kafka/common/errors/NotLeaderOrFollowerException.java", "diffHunk": "@@ -0,0 +1,44 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.kafka.common.errors;\n+\n+/**\n+ * This server is not the leader or follower for the given partition.\n+ * This could a transient exception during reassignments.\n+ */\n+@SuppressWarnings(\"deprecation\")\n+public class NotLeaderOrFollowerException extends NotLeaderForPartitionException {", "originalCommit": "8bcda5eb1adb331246de81fdb225540b990f557a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQ4NjYxMg==", "url": "https://github.com/apache/kafka/pull/8979#discussion_r455486612", "bodyText": "Good point.", "author": "ijuma", "createdAt": "2020-07-16T03:23:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQxMzUyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY0NTQwMg==", "url": "https://github.com/apache/kafka/pull/8979#discussion_r455645402", "bodyText": "Updated javadoc.", "author": "rajinisivaram", "createdAt": "2020-07-16T09:18:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQxMzUyNw=="}], "type": "inlineReview", "revised_code": {"commit": "eedd6e2731946f414fb20c667733153849efa854", "chunk": "diff --git a/clients/src/main/java/org/apache/kafka/common/errors/NotLeaderOrFollowerException.java b/clients/src/main/java/org/apache/kafka/common/errors/NotLeaderOrFollowerException.java\nindex 80cc9abd64..448c61f985 100644\n--- a/clients/src/main/java/org/apache/kafka/common/errors/NotLeaderOrFollowerException.java\n+++ b/clients/src/main/java/org/apache/kafka/common/errors/NotLeaderOrFollowerException.java\n\n@@ -17,8 +17,11 @@\n package org.apache.kafka.common.errors;\n \n /**\n- * This server is not the leader or follower for the given partition.\n- * This could a transient exception during reassignments.\n+ * Broker returns this error if a request could not be processed because the broker is not the leader\n+ * or follower for a topic partition. For `Produce` requests which are intended only for the leader,\n+ * this exception indicates that the broker is not the current leader. For consumer `Fetch` requests which\n+ * may be satisfied by a leader or follower, this exception indicates that the broker is not a replica\n+ * of the topic partition. This could be a transient exception during reassignments.\n  */\n @SuppressWarnings(\"deprecation\")\n public class NotLeaderOrFollowerException extends NotLeaderForPartitionException {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQxNDU2Mg==", "url": "https://github.com/apache/kafka/pull/8979#discussion_r455414562", "bodyText": "This would also be a good place to be clearer about the interpretation of this error. Maybe something like this?\n\nFor requests intended only for the leader, this error indicates that the broker is not the current leader. For requests intended for any replica, this error indicates that the broker is not a replica of the topic partition.", "author": "hachikuji", "createdAt": "2020-07-15T23:05:25Z", "path": "clients/src/main/java/org/apache/kafka/common/protocol/Errors.java", "diffHunk": "@@ -139,8 +139,8 @@\n             InvalidFetchSizeException::new),\n     LEADER_NOT_AVAILABLE(5, \"There is no leader for this topic-partition as we are in the middle of a leadership election.\",\n             LeaderNotAvailableException::new),\n-    NOT_LEADER_FOR_PARTITION(6, \"This server is not the leader for that topic-partition.\",\n-            NotLeaderForPartitionException::new),\n+    NOT_LEADER_OR_FOLLOWER(6, \"This server is not the leader or follower for that topic-partition.\",", "originalCommit": "8bcda5eb1adb331246de81fdb225540b990f557a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "eedd6e2731946f414fb20c667733153849efa854", "chunk": "diff --git a/clients/src/main/java/org/apache/kafka/common/protocol/Errors.java b/clients/src/main/java/org/apache/kafka/common/protocol/Errors.java\nindex d1ddb02764..9101224700 100644\n--- a/clients/src/main/java/org/apache/kafka/common/protocol/Errors.java\n+++ b/clients/src/main/java/org/apache/kafka/common/protocol/Errors.java\n\n@@ -139,13 +139,15 @@ public enum Errors {\n             InvalidFetchSizeException::new),\n     LEADER_NOT_AVAILABLE(5, \"There is no leader for this topic-partition as we are in the middle of a leadership election.\",\n             LeaderNotAvailableException::new),\n-    NOT_LEADER_OR_FOLLOWER(6, \"This server is not the leader or follower for that topic-partition.\",\n+    NOT_LEADER_OR_FOLLOWER(6, \"For requests intended only for the leader, this error indicates that the broker is not the current leader. \" +\n+            \"For requests intended for any replica, this error indicates that the broker is not a replica of the topic partition.\",\n             NotLeaderOrFollowerException::new),\n     REQUEST_TIMED_OUT(7, \"The request timed out.\",\n             TimeoutException::new),\n     BROKER_NOT_AVAILABLE(8, \"The broker is not available.\",\n             BrokerNotAvailableException::new),\n-    REPLICA_NOT_AVAILABLE(9, \"The replica is not available for the requested topic-partition.\",\n+    REPLICA_NOT_AVAILABLE(9, \"The replica is not available for the requested topic-partition. This is used for backward compatibility for \" +\n+            \"requests intended for any replica and may be replaced with NOT_LEADER_OR_FOLLOWER in new versions.\",\n             ReplicaNotAvailableException::new),\n     MESSAGE_TOO_LARGE(10, \"The request included a message larger than the max message size the server will accept.\",\n             RecordTooLargeException::new),\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQxNjUzNg==", "url": "https://github.com/apache/kafka/pull/8979#discussion_r455416536", "bodyText": "Is it worth adding a note about the use of REPLICA_NOT_AVAILABLE below? I think we are effectively deprecating its usage in this PR.", "author": "hachikuji", "createdAt": "2020-07-15T23:11:19Z", "path": "clients/src/main/java/org/apache/kafka/common/protocol/Errors.java", "diffHunk": "@@ -139,8 +139,8 @@\n             InvalidFetchSizeException::new),\n     LEADER_NOT_AVAILABLE(5, \"There is no leader for this topic-partition as we are in the middle of a leadership election.\",\n             LeaderNotAvailableException::new),\n-    NOT_LEADER_FOR_PARTITION(6, \"This server is not the leader for that topic-partition.\",\n-            NotLeaderForPartitionException::new),\n+    NOT_LEADER_OR_FOLLOWER(6, \"This server is not the leader or follower for that topic-partition.\",\n+            NotLeaderOrFollowerException::new),\n     REQUEST_TIMED_OUT(7, \"The request timed out.\",\n             TimeoutException::new),\n     BROKER_NOT_AVAILABLE(8, \"The broker is not available.\",", "originalCommit": "8bcda5eb1adb331246de81fdb225540b990f557a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "eedd6e2731946f414fb20c667733153849efa854", "chunk": "diff --git a/clients/src/main/java/org/apache/kafka/common/protocol/Errors.java b/clients/src/main/java/org/apache/kafka/common/protocol/Errors.java\nindex d1ddb02764..9101224700 100644\n--- a/clients/src/main/java/org/apache/kafka/common/protocol/Errors.java\n+++ b/clients/src/main/java/org/apache/kafka/common/protocol/Errors.java\n\n@@ -139,13 +139,15 @@ public enum Errors {\n             InvalidFetchSizeException::new),\n     LEADER_NOT_AVAILABLE(5, \"There is no leader for this topic-partition as we are in the middle of a leadership election.\",\n             LeaderNotAvailableException::new),\n-    NOT_LEADER_OR_FOLLOWER(6, \"This server is not the leader or follower for that topic-partition.\",\n+    NOT_LEADER_OR_FOLLOWER(6, \"For requests intended only for the leader, this error indicates that the broker is not the current leader. \" +\n+            \"For requests intended for any replica, this error indicates that the broker is not a replica of the topic partition.\",\n             NotLeaderOrFollowerException::new),\n     REQUEST_TIMED_OUT(7, \"The request timed out.\",\n             TimeoutException::new),\n     BROKER_NOT_AVAILABLE(8, \"The broker is not available.\",\n             BrokerNotAvailableException::new),\n-    REPLICA_NOT_AVAILABLE(9, \"The replica is not available for the requested topic-partition.\",\n+    REPLICA_NOT_AVAILABLE(9, \"The replica is not available for the requested topic-partition. This is used for backward compatibility for \" +\n+            \"requests intended for any replica and may be replaced with NOT_LEADER_OR_FOLLOWER in new versions.\",\n             ReplicaNotAvailableException::new),\n     MESSAGE_TOO_LARGE(10, \"The request included a message larger than the max message size the server will accept.\",\n             RecordTooLargeException::new),\n"}}, {"oid": "eedd6e2731946f414fb20c667733153849efa854", "url": "https://github.com/apache/kafka/commit/eedd6e2731946f414fb20c667733153849efa854", "message": "Address review comments", "committedDate": "2020-07-16T09:12:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjAwODM1NA==", "url": "https://github.com/apache/kafka/pull/8979#discussion_r456008354", "bodyText": "Is the note about the range from 2.4 to 2.6 correct? I think this error has always been possible in the case of a reassignment.", "author": "hachikuji", "createdAt": "2020-07-16T19:04:21Z", "path": "clients/src/main/java/org/apache/kafka/common/requests/FetchResponse.java", "diffHunk": "@@ -58,8 +58,8 @@\n  *\n  * - {@link Errors#OFFSET_OUT_OF_RANGE} If the fetch offset is out of range for a requested partition\n  * - {@link Errors#TOPIC_AUTHORIZATION_FAILED} If the user does not have READ access to a requested topic\n- * - {@link Errors#REPLICA_NOT_AVAILABLE} If the request is received by a broker which is not a replica\n- * - {@link Errors#NOT_LEADER_FOR_PARTITION} If the broker is not a leader and either the provided leader epoch\n+ * - {@link Errors#REPLICA_NOT_AVAILABLE} If the request is received by a broker with version 2.4 to 2.6 which is not a replica", "originalCommit": "eedd6e2731946f414fb20c667733153849efa854", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjM2MzcwMA==", "url": "https://github.com/apache/kafka/pull/8979#discussion_r456363700", "bodyText": "Updated to say < 2.6.", "author": "rajinisivaram", "createdAt": "2020-07-17T10:38:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjAwODM1NA=="}], "type": "inlineReview", "revised_code": {"commit": "991b61d764d3ea11feebe2977890fefed9bfa8b9", "chunk": "diff --git a/clients/src/main/java/org/apache/kafka/common/requests/FetchResponse.java b/clients/src/main/java/org/apache/kafka/common/requests/FetchResponse.java\nindex 8ab08dc140..984c50ca72 100644\n--- a/clients/src/main/java/org/apache/kafka/common/requests/FetchResponse.java\n+++ b/clients/src/main/java/org/apache/kafka/common/requests/FetchResponse.java\n\n@@ -58,7 +58,7 @@ import static org.apache.kafka.common.requests.FetchMetadata.INVALID_SESSION_ID;\n  *\n  * - {@link Errors#OFFSET_OUT_OF_RANGE} If the fetch offset is out of range for a requested partition\n  * - {@link Errors#TOPIC_AUTHORIZATION_FAILED} If the user does not have READ access to a requested topic\n- * - {@link Errors#REPLICA_NOT_AVAILABLE} If the request is received by a broker with version 2.4 to 2.6 which is not a replica\n+ * - {@link Errors#REPLICA_NOT_AVAILABLE} If the request is received by a broker with version < 2.6 which is not a replica\n  * - {@link Errors#NOT_LEADER_OR_FOLLOWER} If the broker is not a leader or follower and either the provided leader epoch\n  *     matches the known leader epoch on the broker or is empty\n  * - {@link Errors#FENCED_LEADER_EPOCH} If the epoch is lower than the broker's epoch\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjA3NDM1NQ==", "url": "https://github.com/apache/kafka/pull/8979#discussion_r456074355", "bodyText": "@hachikuji @rajinisivaram Since this is still used outside of produce/fetch, maybe the backwards compatibility message needs to be qualified?", "author": "ijuma", "createdAt": "2020-07-16T20:59:13Z", "path": "clients/src/main/java/org/apache/kafka/common/protocol/Errors.java", "diffHunk": "@@ -139,13 +139,15 @@\n             InvalidFetchSizeException::new),\n     LEADER_NOT_AVAILABLE(5, \"There is no leader for this topic-partition as we are in the middle of a leadership election.\",\n             LeaderNotAvailableException::new),\n-    NOT_LEADER_FOR_PARTITION(6, \"This server is not the leader for that topic-partition.\",\n-            NotLeaderForPartitionException::new),\n+    NOT_LEADER_OR_FOLLOWER(6, \"For requests intended only for the leader, this error indicates that the broker is not the current leader. \" +\n+            \"For requests intended for any replica, this error indicates that the broker is not a replica of the topic partition.\",\n+            NotLeaderOrFollowerException::new),\n     REQUEST_TIMED_OUT(7, \"The request timed out.\",\n             TimeoutException::new),\n     BROKER_NOT_AVAILABLE(8, \"The broker is not available.\",\n             BrokerNotAvailableException::new),\n-    REPLICA_NOT_AVAILABLE(9, \"The replica is not available for the requested topic-partition.\",\n+    REPLICA_NOT_AVAILABLE(9, \"The replica is not available for the requested topic-partition. This is used for backward compatibility for \" +", "originalCommit": "eedd6e2731946f414fb20c667733153849efa854", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjM2NDA0NQ==", "url": "https://github.com/apache/kafka/pull/8979#discussion_r456364045", "bodyText": "Updated the doc here and added javadoc for ReplicaNotAvailableException with more detail.", "author": "rajinisivaram", "createdAt": "2020-07-17T10:38:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjA3NDM1NQ=="}], "type": "inlineReview", "revised_code": {"commit": "991b61d764d3ea11feebe2977890fefed9bfa8b9", "chunk": "diff --git a/clients/src/main/java/org/apache/kafka/common/protocol/Errors.java b/clients/src/main/java/org/apache/kafka/common/protocol/Errors.java\nindex 9101224700..3837d7e8ab 100644\n--- a/clients/src/main/java/org/apache/kafka/common/protocol/Errors.java\n+++ b/clients/src/main/java/org/apache/kafka/common/protocol/Errors.java\n\n@@ -146,8 +146,8 @@ public enum Errors {\n             TimeoutException::new),\n     BROKER_NOT_AVAILABLE(8, \"The broker is not available.\",\n             BrokerNotAvailableException::new),\n-    REPLICA_NOT_AVAILABLE(9, \"The replica is not available for the requested topic-partition. This is used for backward compatibility for \" +\n-            \"requests intended for any replica and may be replaced with NOT_LEADER_OR_FOLLOWER in new versions.\",\n+    REPLICA_NOT_AVAILABLE(9, \"The replica is not available for the requested topic-partition. Fetch requests and other requests \" +\n+            \"intended only for the leader return NOT_LEADER_OR_FOLLOWER if the broker is not a replica of the topic-partition.\",\n             ReplicaNotAvailableException::new),\n     MESSAGE_TOO_LARGE(10, \"The request included a message larger than the max message size the server will accept.\",\n             RecordTooLargeException::new),\n"}}, {"oid": "991b61d764d3ea11feebe2977890fefed9bfa8b9", "url": "https://github.com/apache/kafka/commit/991b61d764d3ea11feebe2977890fefed9bfa8b9", "message": "Address review comments", "committedDate": "2020-07-17T10:20:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQ0MzQ5NQ==", "url": "https://github.com/apache/kafka/pull/8979#discussion_r456443495", "bodyText": "Should it be leader or follower her and in the ReplicaNotAvailable message?", "author": "ijuma", "createdAt": "2020-07-17T13:31:14Z", "path": "clients/src/main/java/org/apache/kafka/common/errors/ReplicaNotAvailableException.java", "diffHunk": "@@ -16,7 +16,13 @@\n  */\n package org.apache.kafka.common.errors;\n \n-public class ReplicaNotAvailableException extends ApiException {\n+/**\n+ * The replica is not available for the requested topic partition. This may be\n+ * a transient exception during reassignments. From version 2.6 onwards, Fetch requests\n+ * and other requests intended only for the leader of the topic partition return", "originalCommit": "991b61d764d3ea11feebe2977890fefed9bfa8b9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQ3MDUwOA==", "url": "https://github.com/apache/kafka/pull/8979#discussion_r456470508", "bodyText": "@ijuma Thanks for the review, updated.", "author": "rajinisivaram", "createdAt": "2020-07-17T14:16:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQ0MzQ5NQ=="}], "type": "inlineReview", "revised_code": {"commit": "65d4f62be75ad44bb14910b178e073d56b5ea586", "chunk": "diff --git a/clients/src/main/java/org/apache/kafka/common/errors/ReplicaNotAvailableException.java b/clients/src/main/java/org/apache/kafka/common/errors/ReplicaNotAvailableException.java\nindex 3a69f6dbe1..07971cd57e 100644\n--- a/clients/src/main/java/org/apache/kafka/common/errors/ReplicaNotAvailableException.java\n+++ b/clients/src/main/java/org/apache/kafka/common/errors/ReplicaNotAvailableException.java\n\n@@ -19,7 +19,7 @@ package org.apache.kafka.common.errors;\n /**\n  * The replica is not available for the requested topic partition. This may be\n  * a transient exception during reassignments. From version 2.6 onwards, Fetch requests\n- * and other requests intended only for the leader of the topic partition return\n+ * and other requests intended only for the leader or follower of the topic partition return\n  * {@link NotLeaderOrFollowerException} if the broker is a not a replica of the partition.\n  */\n public class ReplicaNotAvailableException extends InvalidMetadataException {\n"}}, {"oid": "65d4f62be75ad44bb14910b178e073d56b5ea586", "url": "https://github.com/apache/kafka/commit/65d4f62be75ad44bb14910b178e073d56b5ea586", "message": "Address review comment", "committedDate": "2020-07-17T14:14:01Z", "type": "commit"}]}