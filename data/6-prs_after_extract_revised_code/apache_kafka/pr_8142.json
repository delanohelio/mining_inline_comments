{"pr_number": 8142, "pr_title": "KAFKA-9577: SaslClientAuthenticator incorrectly negotiates SASL_HANDSHAKE version", "pr_createdAt": "2020-02-20T19:13:23Z", "pr_url": "https://github.com/apache/kafka/pull/8142", "timeline": [{"oid": "8b3a7200a857a09377078fc2fceadbb9afb21c78", "url": "https://github.com/apache/kafka/commit/8b3a7200a857a09377078fc2fceadbb9afb21c78", "message": "SaslClientAuthenticator incorrectly negotiates supported\nSaslHandshakeRequest versions and uses the max versions supported by the\nbroker whether or not the client supports it. This PR rolls back the\nSaslHandshake[Request,Response] bump, fixes the version negotiation, and\nadds a test to prevent anyone from accidentally bumping the version\nwithout a workaround (e.g. a new ApiKey).", "committedDate": "2020-02-20T19:04:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjIwNDg0MA==", "url": "https://github.com/apache/kafka/pull/8142#discussion_r382204840", "bodyText": "Set the versions for both auth and handshake the same way.", "author": "lbradstreet", "createdAt": "2020-02-20T19:17:47Z", "path": "clients/src/main/java/org/apache/kafka/common/security/authenticator/SaslClientAuthenticator.java", "diffHunk": "@@ -213,13 +215,13 @@ public void authenticate() throws IOException {\n                 if (apiVersionsResponse == null)\n                     break;\n                 else {\n-                    saslAuthenticateVersion(apiVersionsResponse);\n+                    saslApiVersions(apiVersionsResponse);", "originalCommit": "8b3a7200a857a09377078fc2fceadbb9afb21c78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjIxNTQwMg==", "url": "https://github.com/apache/kafka/pull/8142#discussion_r382215402", "bodyText": "nit: saslAuthenticateAndHandshakeVersions() is more intuitive to me (100% subjective, of course; I mention it only in case it didn't occur to you)", "author": "rondagostino", "createdAt": "2020-02-20T19:37:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjIwNDg0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjgxMDc4NQ==", "url": "https://github.com/apache/kafka/pull/8142#discussion_r382810785", "bodyText": "Done", "author": "lbradstreet", "createdAt": "2020-02-21T21:19:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjIwNDg0MA=="}], "type": "inlineReview", "revised_code": {"commit": "de7274f5673650db5aba20ce600ebb10e82cb04a", "chunk": "diff --git a/clients/src/main/java/org/apache/kafka/common/security/authenticator/SaslClientAuthenticator.java b/clients/src/main/java/org/apache/kafka/common/security/authenticator/SaslClientAuthenticator.java\nindex 1c4de70de0..e972da15f3 100644\n--- a/clients/src/main/java/org/apache/kafka/common/security/authenticator/SaslClientAuthenticator.java\n+++ b/clients/src/main/java/org/apache/kafka/common/security/authenticator/SaslClientAuthenticator.java\n\n@@ -215,7 +215,7 @@ public class SaslClientAuthenticator implements Authenticator {\n                 if (apiVersionsResponse == null)\n                     break;\n                 else {\n-                    saslApiVersions(apiVersionsResponse);\n+                    setSaslAuthenticateAndHandshakeVersions(apiVersionsResponse);\n                     reauthInfo.apiVersionsResponseReceivedFromBroker = apiVersionsResponse;\n                     setSaslState(SaslState.SEND_HANDSHAKE_REQUEST);\n                     // Fall through to send handshake request with the latest supported version\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjIwNTM4Ng==", "url": "https://github.com/apache/kafka/pull/8142#discussion_r382205386", "bodyText": "Rename as this only tested part of the version support.", "author": "lbradstreet", "createdAt": "2020-02-20T19:18:45Z", "path": "clients/src/test/java/org/apache/kafka/common/security/authenticator/SaslAuthenticatorTest.java", "diffHunk": "@@ -677,7 +677,7 @@ public void testUnauthenticatedApiVersionsRequestOverSslHandshakeVersion1() thro\n      * {@link SaslServerAuthenticator} of the server prior to client authentication.\n      */\n     @Test\n-    public void testApiVersionsRequestWithUnsupportedVersion() throws Exception {\n+    public void testApiVersionsRequestWithServerUnsupportedVersion() throws Exception {", "originalCommit": "8b3a7200a857a09377078fc2fceadbb9afb21c78", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjIwNTQ3OQ==", "url": "https://github.com/apache/kafka/pull/8142#discussion_r382205479", "bodyText": "Block anyone from bumping the schema without realizing.", "author": "lbradstreet", "createdAt": "2020-02-20T19:18:56Z", "path": "clients/src/test/java/org/apache/kafka/common/security/authenticator/SaslAuthenticatorTest.java", "diffHunk": "@@ -748,6 +767,16 @@ public void testInvalidApiVersionsRequest() throws Exception {\n         authenticateUsingSaslPlainAndCheckConnection(node, handshakeVersion > 0);\n     }\n \n+\n+    @Test\n+    public void testForBrokenSaslHandshakeVersionBump() {", "originalCommit": "8b3a7200a857a09377078fc2fceadbb9afb21c78", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "de7274f5673650db5aba20ce600ebb10e82cb04a", "chunk": "diff --git a/clients/src/test/java/org/apache/kafka/common/security/authenticator/SaslAuthenticatorTest.java b/clients/src/test/java/org/apache/kafka/common/security/authenticator/SaslAuthenticatorTest.java\nindex c761447142..6c7d7c8360 100644\n--- a/clients/src/test/java/org/apache/kafka/common/security/authenticator/SaslAuthenticatorTest.java\n+++ b/clients/src/test/java/org/apache/kafka/common/security/authenticator/SaslAuthenticatorTest.java\n\n@@ -770,9 +770,9 @@ public class SaslAuthenticatorTest {\n \n     @Test\n     public void testForBrokenSaslHandshakeVersionBump() {\n-        assertEquals(\"It is not possible to easily bump SASL_HANDSHAKE schema without \"\n-                        + \"due to improper version negotiation for clients < 2.5. \"\n-                        + \"Please see https://issues.apache.org/jira/browse/KAFKA-9577\",\n+        assertEquals(\"It is not possible to easily bump SASL_HANDSHAKE schema\"\n+                        + \" due to improper version negotiation in clients < 2.5.\"\n+                        + \" Please see https://issues.apache.org/jira/browse/KAFKA-9577\",\n                 ApiKeys.SASL_HANDSHAKE.latestVersion(),\n                 1);\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjIyNjI4Mg==", "url": "https://github.com/apache/kafka/pull/8142#discussion_r382226282", "bodyText": "It is not possible to easily bump SASL_HANDSHAKE schema without due to... (remove \"without\")", "author": "rondagostino", "createdAt": "2020-02-20T19:59:15Z", "path": "clients/src/test/java/org/apache/kafka/common/security/authenticator/SaslAuthenticatorTest.java", "diffHunk": "@@ -748,6 +767,16 @@ public void testInvalidApiVersionsRequest() throws Exception {\n         authenticateUsingSaslPlainAndCheckConnection(node, handshakeVersion > 0);\n     }\n \n+\n+    @Test\n+    public void testForBrokenSaslHandshakeVersionBump() {\n+        assertEquals(\"It is not possible to easily bump SASL_HANDSHAKE schema without \"", "originalCommit": "8b3a7200a857a09377078fc2fceadbb9afb21c78", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "de7274f5673650db5aba20ce600ebb10e82cb04a", "chunk": "diff --git a/clients/src/test/java/org/apache/kafka/common/security/authenticator/SaslAuthenticatorTest.java b/clients/src/test/java/org/apache/kafka/common/security/authenticator/SaslAuthenticatorTest.java\nindex c761447142..6c7d7c8360 100644\n--- a/clients/src/test/java/org/apache/kafka/common/security/authenticator/SaslAuthenticatorTest.java\n+++ b/clients/src/test/java/org/apache/kafka/common/security/authenticator/SaslAuthenticatorTest.java\n\n@@ -770,9 +770,9 @@ public class SaslAuthenticatorTest {\n \n     @Test\n     public void testForBrokenSaslHandshakeVersionBump() {\n-        assertEquals(\"It is not possible to easily bump SASL_HANDSHAKE schema without \"\n-                        + \"due to improper version negotiation for clients < 2.5. \"\n-                        + \"Please see https://issues.apache.org/jira/browse/KAFKA-9577\",\n+        assertEquals(\"It is not possible to easily bump SASL_HANDSHAKE schema\"\n+                        + \" due to improper version negotiation in clients < 2.5.\"\n+                        + \" Please see https://issues.apache.org/jira/browse/KAFKA-9577\",\n                 ApiKeys.SASL_HANDSHAKE.latestVersion(),\n                 1);\n     }\n"}}, {"oid": "de7274f5673650db5aba20ce600ebb10e82cb04a", "url": "https://github.com/apache/kafka/commit/de7274f5673650db5aba20ce600ebb10e82cb04a", "message": "saslApiVersions -> setSaslAuthenticateAndHandshakeVersions. Improve test\nfailure message.", "committedDate": "2020-02-20T20:56:30Z", "type": "commit"}, {"oid": "fb7ce3787a101b9243988c484c86238a8a61f97d", "url": "https://github.com/apache/kafka/commit/fb7ce3787a101b9243988c484c86238a8a61f97d", "message": "Better document bad negotiation", "committedDate": "2020-02-21T21:11:56Z", "type": "commit"}]}