{"pr_number": 9338, "pr_title": "KAFKA-10515: Properly initialize nullable Serdes with default values", "pr_createdAt": "2020-09-25T05:07:49Z", "pr_url": "https://github.com/apache/kafka/pull/9338", "timeline": [{"oid": "8630ff5e5cb2d5fca1b9d3be46efdaf193590382", "url": "https://github.com/apache/kafka/commit/8630ff5e5cb2d5fca1b9d3be46efdaf193590382", "message": "Fixed KAFKA-10515: Serdes used within metered state stores will now be initialized with the default serdes if not already set.\n\nAlso introduced the notion of WrappingNullableSerdes (aligned to the concept of WrappingNullableSerializer and WrappingNullableDeserializer)", "committedDate": "2020-10-10T17:39:39Z", "type": "commit"}, {"oid": "8630ff5e5cb2d5fca1b9d3be46efdaf193590382", "url": "https://github.com/apache/kafka/commit/8630ff5e5cb2d5fca1b9d3be46efdaf193590382", "message": "Fixed KAFKA-10515: Serdes used within metered state stores will now be initialized with the default serdes if not already set.\n\nAlso introduced the notion of WrappingNullableSerdes (aligned to the concept of WrappingNullableSerializer and WrappingNullableDeserializer)", "committedDate": "2020-10-10T17:39:39Z", "type": "forcePushed"}, {"oid": "3cbfebef292998640fe1ad55db982a1b4fa9cffd", "url": "https://github.com/apache/kafka/commit/3cbfebef292998640fe1ad55db982a1b4fa9cffd", "message": "suggestions", "committedDate": "2020-10-13T21:15:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDIyODY1OQ==", "url": "https://github.com/apache/kafka/pull/9338#discussion_r504228659", "bodyText": "This can be private", "author": "vvcephei", "createdAt": "2020-10-13T20:15:47Z", "path": "streams/src/main/java/org/apache/kafka/streams/state/internals/MeteredWindowStore.java", "diffHunk": "@@ -103,6 +104,13 @@ public void init(final StateStoreContext context,\n         // register and possibly restore the state from the logs\n         maybeMeasureLatency(() -> super.init(context, root), time, restoreSensor);\n     }\n+    protected Serde<K> prepareKeySerde(final Serde<K> keySerde, final Serde<?> contextKeySerde, final Serde<?> contextValueSerde) {", "originalCommit": "8630ff5e5cb2d5fca1b9d3be46efdaf193590382", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODM5MjczNQ==", "url": "https://github.com/apache/kafka/pull/9338#discussion_r508392735", "bodyText": "Removed the method completely and added a static import as you proposed in your PR.", "author": "thake", "createdAt": "2020-10-20T10:36:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDIyODY1OQ=="}], "type": "inlineReview", "revised_code": {"commit": "b9cfcbecc9901d24b2da22e569bdc328b3c25e0d", "chunk": "diff --git a/streams/src/main/java/org/apache/kafka/streams/state/internals/MeteredWindowStore.java b/streams/src/main/java/org/apache/kafka/streams/state/internals/MeteredWindowStore.java\nindex a2b1628145..1b419ec742 100644\n--- a/streams/src/main/java/org/apache/kafka/streams/state/internals/MeteredWindowStore.java\n+++ b/streams/src/main/java/org/apache/kafka/streams/state/internals/MeteredWindowStore.java\n\n@@ -104,10 +105,6 @@ public class MeteredWindowStore<K, V>\n         // register and possibly restore the state from the logs\n         maybeMeasureLatency(() -> super.init(context, root), time, restoreSensor);\n     }\n-    protected Serde<K> prepareKeySerde(final Serde<K> keySerde, final Serde<?> contextKeySerde, final Serde<?> contextValueSerde) {\n-        return WrappingNullableUtils.prepareKeySerde(keySerde, contextKeySerde, contextValueSerde);\n-    }\n-\n     protected Serde<V> prepareValueSerde(final Serde<V> valueSerde, final Serde<?> contextKeySerde, final Serde<?> contextValueSerde) {\n         return WrappingNullableUtils.prepareValueSerde(valueSerde, contextKeySerde, contextValueSerde);\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDIyODk3Ng==", "url": "https://github.com/apache/kafka/pull/9338#discussion_r504228976", "bodyText": "This (and the StateStoreContext one) can be private now. Thanks for factoring out the smallest chunk that needs to be overridden in the subclass. I wish I'd thought of it.", "author": "vvcephei", "createdAt": "2020-10-13T20:16:21Z", "path": "streams/src/main/java/org/apache/kafka/streams/state/internals/MeteredWindowStore.java", "diffHunk": "@@ -112,28 +120,26 @@ private void registerMetrics() {\n     }\n \n     @Deprecated\n-    @SuppressWarnings(\"unchecked\")\n     void initStoreSerde(final ProcessorContext context) {", "originalCommit": "8630ff5e5cb2d5fca1b9d3be46efdaf193590382", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODM5MjMxNw==", "url": "https://github.com/apache/kafka/pull/9338#discussion_r508392317", "bodyText": "Done", "author": "thake", "createdAt": "2020-10-20T10:35:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDIyODk3Ng=="}], "type": "inlineReview", "revised_code": {"commit": "b9cfcbecc9901d24b2da22e569bdc328b3c25e0d", "chunk": "diff --git a/streams/src/main/java/org/apache/kafka/streams/state/internals/MeteredWindowStore.java b/streams/src/main/java/org/apache/kafka/streams/state/internals/MeteredWindowStore.java\nindex a2b1628145..1b419ec742 100644\n--- a/streams/src/main/java/org/apache/kafka/streams/state/internals/MeteredWindowStore.java\n+++ b/streams/src/main/java/org/apache/kafka/streams/state/internals/MeteredWindowStore.java\n\n@@ -120,7 +117,7 @@ public class MeteredWindowStore<K, V>\n     }\n \n     @Deprecated\n-    void initStoreSerde(final ProcessorContext context) {\n+    private void initStoreSerde(final ProcessorContext context) {\n         final String storeName = name();\n         final String changelogTopic = ProcessorContextUtils.changelogFor(context, storeName);\n         serdes = new StateSerdes<>(\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI1MDcyNA==", "url": "https://github.com/apache/kafka/pull/9338#discussion_r504250724", "bodyText": "It would be good to also clean up the local disk and the topics after the test: org.apache.kafka.streams.integration.utils.IntegrationTestUtils#quietlyCleanStateAfterTest\nNot always necessary, but it keeps tests from becoming flaky after seemingly unrelated changes.", "author": "vvcephei", "createdAt": "2020-10-13T20:51:06Z", "path": "streams/src/test/java/org/apache/kafka/streams/integration/KTableKTableForeignKeyJoinDistributedTest.java", "diffHunk": "@@ -0,0 +1,232 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.kafka.streams.integration;\n+\n+import org.apache.kafka.clients.consumer.ConsumerConfig;\n+import org.apache.kafka.clients.producer.ProducerConfig;\n+import org.apache.kafka.common.serialization.Serdes;\n+import org.apache.kafka.common.serialization.StringDeserializer;\n+import org.apache.kafka.common.serialization.StringSerializer;\n+import org.apache.kafka.streams.KafkaStreams;\n+import org.apache.kafka.streams.KeyValue;\n+import org.apache.kafka.streams.StreamsBuilder;\n+import org.apache.kafka.streams.StreamsConfig;\n+import org.apache.kafka.streams.Topology;\n+import org.apache.kafka.streams.integration.utils.EmbeddedKafkaCluster;\n+import org.apache.kafka.streams.integration.utils.IntegrationTestUtils;\n+import org.apache.kafka.streams.kstream.KTable;\n+import org.apache.kafka.streams.kstream.ValueJoiner;\n+import org.apache.kafka.streams.processor.ThreadMetadata;\n+import org.apache.kafka.test.IntegrationTest;\n+import org.apache.kafka.test.TestUtils;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.BeforeClass;\n+import org.junit.ClassRule;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+import org.junit.rules.TestName;\n+\n+import java.util.Arrays;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Properties;\n+import java.util.Set;\n+import java.util.function.Function;\n+import java.util.function.Predicate;\n+\n+import static org.apache.kafka.streams.integration.utils.IntegrationTestUtils.safeUniqueTestName;\n+import static org.junit.Assert.assertEquals;\n+\n+@Category({IntegrationTest.class})\n+public class KTableKTableForeignKeyJoinDistributedTest {\n+    private static final int NUM_BROKERS = 1;\n+    private static final String LEFT_TABLE = \"left_table\";\n+    private static final String RIGHT_TABLE = \"right_table\";\n+    private static final String OUTPUT = \"output-topic\";\n+    @ClassRule\n+    public static final EmbeddedKafkaCluster CLUSTER = new EmbeddedKafkaCluster(NUM_BROKERS);\n+    private static final Properties CONSUMER_CONFIG = new Properties();\n+\n+    @Rule\n+    public TestName testName = new TestName();\n+\n+\n+    private static final String INPUT_TOPIC = \"input-topic\";\n+\n+    private KafkaStreams client1;\n+    private KafkaStreams client2;\n+\n+    private volatile boolean client1IsOk = false;\n+    private volatile boolean client2IsOk = false;\n+\n+    @BeforeClass\n+    public static void createTopics() throws InterruptedException {\n+        CLUSTER.createTopic(INPUT_TOPIC, 2, 1);\n+    }\n+\n+    @Before\n+    public void setupTopics() throws InterruptedException {\n+        CLUSTER.createTopic(LEFT_TABLE, 1, 1);\n+        CLUSTER.createTopic(RIGHT_TABLE, 1, 1);\n+        CLUSTER.createTopic(OUTPUT, 11, 1);\n+\n+        //Fill test tables\n+        final Properties producerConfig = new Properties();\n+        producerConfig.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, CLUSTER.bootstrapServers());\n+        producerConfig.put(ProducerConfig.ACKS_CONFIG, \"all\");\n+        producerConfig.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, StringSerializer.class);\n+        producerConfig.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, StringSerializer.class);\n+        final List<KeyValue<String, String>> leftTable = Arrays.asList(\n+                new KeyValue<>(\"lhsValue1\", \"lhsValue1|rhs1\"),\n+                new KeyValue<>(\"lhsValue2\", \"lhsValue2|rhs2\"),\n+                new KeyValue<>(\"lhsValue3\", \"lhsValue3|rhs3\"),\n+                new KeyValue<>(\"lhsValue4\", \"lhsValue4|rhs4\")\n+        );\n+        final List<KeyValue<String, String>> rightTable = Arrays.asList(\n+                new KeyValue<>(\"rhs1\", \"rhsValue1\"),\n+                new KeyValue<>(\"rhs2\", \"rhsValue2\"),\n+                new KeyValue<>(\"rhs3\", \"rhsValue3\")\n+        );\n+\n+        IntegrationTestUtils.produceKeyValuesSynchronously(LEFT_TABLE, leftTable, producerConfig, CLUSTER.time);\n+        IntegrationTestUtils.produceKeyValuesSynchronously(RIGHT_TABLE, rightTable, producerConfig, CLUSTER.time);\n+\n+        CONSUMER_CONFIG.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, CLUSTER.bootstrapServers());\n+        CONSUMER_CONFIG.put(ConsumerConfig.GROUP_ID_CONFIG, \"ktable-ktable-distributed-consumer\");\n+        CONSUMER_CONFIG.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class);\n+        CONSUMER_CONFIG.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class);\n+    }\n+\n+    @After\n+    public void after() {\n+        client1.close();\n+        client2.close();", "originalCommit": "8630ff5e5cb2d5fca1b9d3be46efdaf193590382", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODM5MjQyNQ==", "url": "https://github.com/apache/kafka/pull/9338#discussion_r508392425", "bodyText": "Done", "author": "thake", "createdAt": "2020-10-20T10:36:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI1MDcyNA=="}], "type": "inlineReview", "revised_code": {"commit": "b9cfcbecc9901d24b2da22e569bdc328b3c25e0d", "chunk": "diff --git a/streams/src/test/java/org/apache/kafka/streams/integration/KTableKTableForeignKeyJoinDistributedTest.java b/streams/src/test/java/org/apache/kafka/streams/integration/KTableKTableForeignKeyJoinDistributedTest.java\nindex 17acd42734..5b1304f93c 100644\n--- a/streams/src/test/java/org/apache/kafka/streams/integration/KTableKTableForeignKeyJoinDistributedTest.java\n+++ b/streams/src/test/java/org/apache/kafka/streams/integration/KTableKTableForeignKeyJoinDistributedTest.java\n\n@@ -51,6 +51,7 @@ import java.util.Set;\n import java.util.function.Function;\n import java.util.function.Predicate;\n \n+import static org.apache.kafka.streams.integration.utils.IntegrationTestUtils.quietlyCleanStateAfterTest;\n import static org.apache.kafka.streams.integration.utils.IntegrationTestUtils.safeUniqueTestName;\n import static org.junit.Assert.assertEquals;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI2MDQ4Mg==", "url": "https://github.com/apache/kafka/pull/9338#discussion_r504260482", "bodyText": "This is probably hypocritical, since I've surely written similar code, but this makes me a little uncomfortable, since there's no guarantee that serializer() would return the same reference every time it's called. I'd propose to make this an abstract class instead so we can make this guarantee ourselves.", "author": "vvcephei", "createdAt": "2020-10-13T21:10:29Z", "path": "streams/src/main/java/org/apache/kafka/streams/kstream/internals/WrappingNullableSerde.java", "diffHunk": "@@ -0,0 +1,36 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.kafka.streams.kstream.internals;\n+\n+import org.apache.kafka.common.serialization.Deserializer;\n+import org.apache.kafka.common.serialization.Serde;\n+import org.apache.kafka.common.serialization.Serializer;\n+\n+public interface WrappingNullableSerde<T, InnerK, InnerV> extends Serde<T> {\n+    @SuppressWarnings({\"unchecked\", \"rawtypes\"})\n+    default void setIfUnset(final Serde<InnerK> defaultKeySerde, final Serde<InnerV> defaultValueSerde) {\n+        final Serializer<T> serializer = this.serializer();", "originalCommit": "8630ff5e5cb2d5fca1b9d3be46efdaf193590382", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDkyNDkyMA==", "url": "https://github.com/apache/kafka/pull/9338#discussion_r504924920", "bodyText": "Ah, my bad. I didn't get the API right. I propably have worked too much on kotlin code with a lot of immutables :) The abstract class is a good idea to circumvent this problem. I'll check the PR and comment on it directly.", "author": "thake", "createdAt": "2020-10-14T19:36:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI2MDQ4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDkzNjUyNA==", "url": "https://github.com/apache/kafka/pull/9338#discussion_r504936524", "bodyText": "No worries, I think this is actually always ok in practice, since I think that all the Wrapping implementations keep their de/serializers in fields anyway. But then again, we've had so many bugs with serdes that I feel a bit twitchy about just ignoring the potential for a future bug that I happened to notice here.", "author": "vvcephei", "createdAt": "2020-10-14T19:57:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI2MDQ4Mg=="}], "type": "inlineReview", "revised_code": {"commit": "3cbfebef292998640fe1ad55db982a1b4fa9cffd", "chunk": "diff --git a/streams/src/main/java/org/apache/kafka/streams/kstream/internals/WrappingNullableSerde.java b/streams/src/main/java/org/apache/kafka/streams/kstream/internals/WrappingNullableSerde.java\nindex 558f3d0546..0679b03459 100644\n--- a/streams/src/main/java/org/apache/kafka/streams/kstream/internals/WrappingNullableSerde.java\n+++ b/streams/src/main/java/org/apache/kafka/streams/kstream/internals/WrappingNullableSerde.java\n\n@@ -21,16 +21,46 @@ import org.apache.kafka.common.serialization.Deserializer;\n import org.apache.kafka.common.serialization.Serde;\n import org.apache.kafka.common.serialization.Serializer;\n \n-public interface WrappingNullableSerde<T, InnerK, InnerV> extends Serde<T> {\n-    @SuppressWarnings({\"unchecked\", \"rawtypes\"})\n-    default void setIfUnset(final Serde<InnerK> defaultKeySerde, final Serde<InnerV> defaultValueSerde) {\n-        final Serializer<T> serializer = this.serializer();\n-        if (serializer instanceof WrappingNullableSerializer) {\n-            ((WrappingNullableSerializer) serializer).setIfUnset(defaultKeySerde != null ? defaultKeySerde.serializer() : null, defaultValueSerde != null ? defaultValueSerde.serializer() : null);\n-        }\n-        final Deserializer<T> deserializer = this.deserializer();\n-        if (deserializer instanceof WrappingNullableDeserializer) {\n-            ((WrappingNullableDeserializer) deserializer).setIfUnset(defaultKeySerde != null ? defaultKeySerde.deserializer() : null, defaultValueSerde != null ? defaultValueSerde.deserializer() : null);\n-        }\n+import java.util.Map;\n+import java.util.Objects;\n+\n+public abstract class WrappingNullableSerde<T, InnerK, InnerV> implements Serde<T> {\n+    private final WrappingNullableSerializer<T, InnerK, InnerV> serializer;\n+    private final WrappingNullableDeserializer<T, InnerK, InnerV> deserializer;\n+\n+    protected WrappingNullableSerde(final WrappingNullableSerializer<T, InnerK, InnerV> serializer,\n+                                    final WrappingNullableDeserializer<T, InnerK, InnerV> deserializer) {\n+        this.serializer = serializer;\n+        this.deserializer = deserializer;\n+    }\n+\n+    @Override\n+    public Serializer<T> serializer() {\n+        return serializer;\n+    }\n+\n+    @Override\n+    public Deserializer<T> deserializer() {\n+        return deserializer;\n+    }\n+\n+    @Override\n+    public void configure(final Map<String, ?> configs,\n+                          final boolean isKey) {\n+        serializer.configure(configs, isKey);\n+        deserializer.configure(configs, isKey);\n+    }\n+\n+    @Override\n+    public void close() {\n+        serializer.close();\n+        deserializer.close();\n+    }\n+\n+    public void setIfUnset(final Serde<InnerK> defaultKeySerde, final Serde<InnerV> defaultValueSerde) {\n+        Objects.requireNonNull(defaultKeySerde);\n+        Objects.requireNonNull(defaultValueSerde);\n+        serializer.setIfUnset(defaultKeySerde.serializer(), defaultValueSerde.serializer());\n+        deserializer.setIfUnset(defaultKeySerde.deserializer(), defaultValueSerde.deserializer());\n     }\n }\n"}}, {"oid": "6dc701a5ea0d37a91a2c22da8dae924f37803bec", "url": "https://github.com/apache/kafka/commit/6dc701a5ea0d37a91a2c22da8dae924f37803bec", "message": "Merge pull request #1 from vvcephei/9338-john\n\nSuggestions for PR 9338", "committedDate": "2020-10-20T10:22:35Z", "type": "commit"}, {"oid": "ab2a3131c3ac49a812f73ec555b9d5430c299075", "url": "https://github.com/apache/kafka/commit/ab2a3131c3ac49a812f73ec555b9d5430c299075", "message": "Making prepare(De)serializer private again", "committedDate": "2020-10-20T10:25:33Z", "type": "commit"}, {"oid": "b9cfcbecc9901d24b2da22e569bdc328b3c25e0d", "url": "https://github.com/apache/kafka/commit/b9cfcbecc9901d24b2da22e569bdc328b3c25e0d", "message": "Working in PR comments", "committedDate": "2020-10-20T10:34:45Z", "type": "commit"}, {"oid": "9d9e387ffebf5aca10dfa47e5a6b1924c2b4a63b", "url": "https://github.com/apache/kafka/commit/9d9e387ffebf5aca10dfa47e5a6b1924c2b4a63b", "message": "Merge branch 'trunk' of github.com:apache/kafka into 9338-john", "committedDate": "2020-10-20T10:37:55Z", "type": "commit"}]}