{"pr_number": 9619, "pr_title": "MINOR: Reduce sends created by `SendBuilder`", "pr_createdAt": "2020-11-18T22:33:47Z", "pr_url": "https://github.com/apache/kafka/pull/9619", "timeline": [{"oid": "ce2fc73c36df444387d2ef7d16819361ca3c11de", "url": "https://github.com/apache/kafka/commit/ce2fc73c36df444387d2ef7d16819361ca3c11de", "message": "MINOR: Reduce sends created by `SendBuilder`", "committedDate": "2020-11-18T21:54:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjU2NjcyMQ==", "url": "https://github.com/apache/kafka/pull/9619#discussion_r526566721", "bodyText": "why sends is ArrayDeque and buffers is ArrayList?", "author": "chia7712", "createdAt": "2020-11-19T03:14:54Z", "path": "clients/src/main/java/org/apache/kafka/common/protocol/SendBuilder.java", "diffHunk": "@@ -39,6 +42,7 @@\n  */\n public class SendBuilder implements Writable {\n     private final Queue<Send> sends = new ArrayDeque<>();\n+    private final List<ByteBuffer> buffers = new ArrayList<>();", "originalCommit": "ce2fc73c36df444387d2ef7d16819361ca3c11de", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjU4Mzc3OA==", "url": "https://github.com/apache/kafka/pull/9619#discussion_r526583778", "bodyText": "Oh, just because MultiRecordsSend needs a Queue.", "author": "hachikuji", "createdAt": "2020-11-19T04:16:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjU2NjcyMQ=="}], "type": "inlineReview", "revised_code": {"commit": "33fbae5f7a2f6a7e2803a2a82b2b45beacc732ba", "chunk": "diff --git a/clients/src/main/java/org/apache/kafka/common/protocol/SendBuilder.java b/clients/src/main/java/org/apache/kafka/common/protocol/SendBuilder.java\nindex 8526ee9101..add53850d4 100644\n--- a/clients/src/main/java/org/apache/kafka/common/protocol/SendBuilder.java\n+++ b/clients/src/main/java/org/apache/kafka/common/protocol/SendBuilder.java\n\n@@ -41,7 +41,7 @@ import java.util.Queue;\n  * for example usage.\n  */\n public class SendBuilder implements Writable {\n-    private final Queue<Send> sends = new ArrayDeque<>();\n+    private final Queue<Send> sends = new ArrayDeque<>(1);\n     private final List<ByteBuffer> buffers = new ArrayList<>();\n     private final ByteBuffer buffer;\n     private final String destinationId;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjU2NzQxNw==", "url": "https://github.com/apache/kafka/pull/9619#discussion_r526567417", "bodyText": "How about setting initial size of sends to 1 as auto-generated code use only MemoryRecords", "author": "chia7712", "createdAt": "2020-11-19T03:17:11Z", "path": "clients/src/main/java/org/apache/kafka/common/protocol/SendBuilder.java", "diffHunk": "@@ -130,13 +139,25 @@ public void writeVarlong(long i) {\n      */\n     @Override\n     public void writeRecords(BaseRecords records) {\n-        flushCurrentBuffer();\n-        sends.add(records.toSend(destinationId));\n+        flushPendingBuffer();\n+\n+        if (records instanceof MemoryRecords) {\n+            buffers.add(((MemoryRecords) records).buffer());\n+        } else {\n+            flushPendingSend();\n+            sends.add(records.toSend(destinationId));", "originalCommit": "ce2fc73c36df444387d2ef7d16819361ca3c11de", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjU4NDE1Ng==", "url": "https://github.com/apache/kafka/pull/9619#discussion_r526584156", "bodyText": "That's fair. FetchResponse is the only case where we would use a different Records type, so may as well optimize for the common case.", "author": "hachikuji", "createdAt": "2020-11-19T04:18:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjU2NzQxNw=="}], "type": "inlineReview", "revised_code": {"commit": "32332c2db2a24edeb2d0e50d28d638325939a33d", "chunk": "diff --git a/clients/src/main/java/org/apache/kafka/common/protocol/SendBuilder.java b/clients/src/main/java/org/apache/kafka/common/protocol/SendBuilder.java\nindex 8526ee9101..19d5600da8 100644\n--- a/clients/src/main/java/org/apache/kafka/common/protocol/SendBuilder.java\n+++ b/clients/src/main/java/org/apache/kafka/common/protocol/SendBuilder.java\n\n@@ -139,24 +136,45 @@ public class SendBuilder implements Writable {\n      */\n     @Override\n     public void writeRecords(BaseRecords records) {\n-        flushPendingBuffer();\n-\n         if (records instanceof MemoryRecords) {\n-            buffers.add(((MemoryRecords) records).buffer());\n+            flushPendingBuffer();\n+            addBuffer(((MemoryRecords) records).buffer());\n         } else {\n             flushPendingSend();\n-            sends.add(records.toSend(destinationId));\n+            addSend(records.toSend(destinationId));\n         }\n     }\n \n-    public Send build() {\n+    private void flushPendingSend() {\n         flushPendingBuffer();\n+        if (!buffers.isEmpty()) {\n+            ByteBuffer[] byteBufferArray = buffers.toArray(new ByteBuffer[0]);\n+            addSend(new ByteBufferSend(destinationId, byteBufferArray, sizeOfBuffers));\n+            clearBuffers();\n+        }\n+    }\n+\n+    private void flushPendingBuffer() {\n+        int latestPosition = buffer.position();\n+        buffer.reset();\n+\n+        if (latestPosition > buffer.position()) {\n+            buffer.limit(latestPosition);\n+            addBuffer(buffer.slice());\n+\n+            buffer.position(latestPosition);\n+            buffer.limit(buffer.capacity());\n+            buffer.mark();\n+        }\n+    }\n+\n+    public Send build() {\n         flushPendingSend();\n \n         if (sends.size() == 1) {\n             return sends.poll();\n         } else {\n-            return new MultiRecordsSend(destinationId, sends);\n+            return new MultiRecordsSend(destinationId, sends, sizeOfSends);\n         }\n     }\n \n"}}, {"oid": "33fbae5f7a2f6a7e2803a2a82b2b45beacc732ba", "url": "https://github.com/apache/kafka/commit/33fbae5f7a2f6a7e2803a2a82b2b45beacc732ba", "message": "Initialize size of `ArrayDeque` to 1", "committedDate": "2020-11-19T04:19:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjcxMDg5Mw==", "url": "https://github.com/apache/kafka/pull/9619#discussion_r526710893", "bodyText": "I just noticed that ByteBufferSend re-iterates over the byte buffers to compute the total size. We could compute the size while we accumulate them. I suppose that the number of buffers is usually small so it should not make a big difference.", "author": "dajac", "createdAt": "2020-11-19T09:25:49Z", "path": "clients/src/main/java/org/apache/kafka/common/protocol/SendBuilder.java", "diffHunk": "@@ -122,6 +123,14 @@ public void writeVarlong(long i) {\n         ByteUtils.writeVarlong(i, buffer);\n     }\n \n+    private void flushPendingSend() {\n+        if (!buffers.isEmpty()) {\n+            ByteBuffer[] byteBufferArray = buffers.toArray(new ByteBuffer[0]);\n+            sends.add(new ByteBufferSend(destinationId, byteBufferArray));", "originalCommit": "33fbae5f7a2f6a7e2803a2a82b2b45beacc732ba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzA3MzE0NA==", "url": "https://github.com/apache/kafka/pull/9619#discussion_r527073144", "bodyText": "I was somewhat inclined to leave this as is, but finally I decided to do it since it might help (even if only a little) with fetch overhead.", "author": "hachikuji", "createdAt": "2020-11-19T17:35:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjcxMDg5Mw=="}], "type": "inlineReview", "revised_code": {"commit": "32332c2db2a24edeb2d0e50d28d638325939a33d", "chunk": "diff --git a/clients/src/main/java/org/apache/kafka/common/protocol/SendBuilder.java b/clients/src/main/java/org/apache/kafka/common/protocol/SendBuilder.java\nindex add53850d4..19d5600da8 100644\n--- a/clients/src/main/java/org/apache/kafka/common/protocol/SendBuilder.java\n+++ b/clients/src/main/java/org/apache/kafka/common/protocol/SendBuilder.java\n\n@@ -123,12 +113,19 @@ public class SendBuilder implements Writable {\n         ByteUtils.writeVarlong(i, buffer);\n     }\n \n-    private void flushPendingSend() {\n-        if (!buffers.isEmpty()) {\n-            ByteBuffer[] byteBufferArray = buffers.toArray(new ByteBuffer[0]);\n-            sends.add(new ByteBufferSend(destinationId, byteBufferArray));\n-            buffers.clear();\n-        }\n+    private void addBuffer(ByteBuffer buffer) {\n+        buffers.add(buffer);\n+        sizeOfBuffers += buffer.remaining();\n+    }\n+\n+    private void addSend(Send send) {\n+        sends.add(send);\n+        sizeOfSends += send.size();\n+    }\n+\n+    private void clearBuffers() {\n+        buffers.clear();\n+        sizeOfBuffers = 0;\n     }\n \n     /**\n"}}, {"oid": "32332c2db2a24edeb2d0e50d28d638325939a33d", "url": "https://github.com/apache/kafka/commit/32332c2db2a24edeb2d0e50d28d638325939a33d", "message": "Compute size while building `Send`", "committedDate": "2020-11-19T17:34:58Z", "type": "commit"}, {"oid": "5b543acfd03bfad9d948e44f760273691e701c4f", "url": "https://github.com/apache/kafka/commit/5b543acfd03bfad9d948e44f760273691e701c4f", "message": "Fix compilation error in benchmark", "committedDate": "2020-11-19T17:50:05Z", "type": "commit"}]}