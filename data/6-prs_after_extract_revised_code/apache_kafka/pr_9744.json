{"pr_number": 9744, "pr_title": "KAFKA-10062: Add a method to retrieve the current timestamp as known by the Streams app", "pr_createdAt": "2020-12-13T22:33:06Z", "pr_url": "https://github.com/apache/kafka/pull/9744", "timeline": [{"oid": "d43dddfd414090ecafe3f0c83523a96136c1f6e7", "url": "https://github.com/apache/kafka/commit/d43dddfd414090ecafe3f0c83523a96136c1f6e7", "message": "initial set of changes for returning time constructs from processor contexts", "committedDate": "2020-12-11T06:44:23Z", "type": "commit"}, {"oid": "5c9f96659ee70486bc70615610231138951f4c7d", "url": "https://github.com/apache/kafka/commit/5c9f96659ee70486bc70615610231138951f4c7d", "message": "added tests in MockProcessorContextTest and TopologyTestDriverTest", "committedDate": "2020-12-12T08:20:15Z", "type": "commit"}, {"oid": "c066de331414a4739abf93ac8ca63280eefa9288", "url": "https://github.com/apache/kafka/commit/c066de331414a4739abf93ac8ca63280eefa9288", "message": "fixed merge conflicts with latest trunk", "committedDate": "2020-12-12T08:33:00Z", "type": "commit"}, {"oid": "f67bae1412fd8b40ad91cda2bc9f5403b0620667", "url": "https://github.com/apache/kafka/commit/f67bae1412fd8b40ad91cda2bc9f5403b0620667", "message": "refactoring for naming convention and removing redundant method from InternalProcessorContext", "committedDate": "2020-12-12T08:42:08Z", "type": "commit"}, {"oid": "f15ddd35669e70224800dadfeac5b0edd991d456", "url": "https://github.com/apache/kafka/commit/f15ddd35669e70224800dadfeac5b0edd991d456", "message": "fixed naming for currentSystemTimeMs method in StreamTask", "committedDate": "2020-12-13T21:27:39Z", "type": "commit"}, {"oid": "37f2e322f19d50dce9e4ac8fab9ad9165d804a8b", "url": "https://github.com/apache/kafka/commit/37f2e322f19d50dce9e4ac8fab9ad9165d804a8b", "message": "added unsupported methods to storeToProcessorContextAdapter", "committedDate": "2020-12-13T21:50:12Z", "type": "commit"}, {"oid": "520df6f1019ec3805436c4f8203b0cc4577295c5", "url": "https://github.com/apache/kafka/commit/520df6f1019ec3805436c4f8203b0cc4577295c5", "message": "added tests", "committedDate": "2020-12-13T21:53:32Z", "type": "commit"}, {"oid": "49e0075339e28f7da12a432135b96a1d73fe47e3", "url": "https://github.com/apache/kafka/commit/49e0075339e28f7da12a432135b96a1d73fe47e3", "message": "getting rid of current system time from bstractProcessorContext", "committedDate": "2020-12-23T04:01:59Z", "type": "commit"}, {"oid": "23da9d15f5305e3b715c56f7357cfa15c11d46d9", "url": "https://github.com/apache/kafka/commit/23da9d15f5305e3b715c56f7357cfa15c11d46d9", "message": "adding new test method to StreamTask to set wall clock time", "committedDate": "2020-12-23T06:08:33Z", "type": "commit"}, {"oid": "39f8586ba650cd9c8d8accdd1792ca6414c04b48", "url": "https://github.com/apache/kafka/commit/39f8586ba650cd9c8d8accdd1792ca6414c04b48", "message": "removing get/set currSystemMs method from Abstract processor context", "committedDate": "2020-12-23T06:23:58Z", "type": "commit"}, {"oid": "b9dfc196aaee91f4fa23fe6563261c6f2d01ac33", "url": "https://github.com/apache/kafka/commit/b9dfc196aaee91f4fa23fe6563261c6f2d01ac33", "message": "global context impl has to return system time", "committedDate": "2020-12-24T05:26:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTU0NjIzNA==", "url": "https://github.com/apache/kafka/pull/9744#discussion_r549546234", "bodyText": "nit: Return without s -- we use imperative to write JavaDocs.\nI would remove cached and add a dedicated second sentence about it. Also wall-clock time and system time are synonymous and thus wall-clock system time sounds a little odd.\nWhat about:\nReturn the current system timestamp (also called wall-clock time) in milliseconds.\n<p>\nNote: this method returns the internally cached system timestamp from the Kafka Stream runtime. Thus, it may return a different value compared to `System.currentTimeMillis()`.\n<p>\nFor a global processor, Kafka Streams does not cache system time and thus calling this method will return the same value as `System.currentTimeMillis()`.\n\n@return the current system timestamp in milliseconds", "author": "mjsax", "createdAt": "2020-12-29T02:32:07Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/ProcessorContext.java", "diffHunk": "@@ -289,4 +289,17 @@ Cancellable schedule(final Duration interval,\n      */\n     Map<String, Object> appConfigsWithPrefix(final String prefix);\n \n+    /**\n+     * Returns current cached wall-clock system timestamp in milliseconds.", "originalCommit": "b9dfc196aaee91f4fa23fe6563261c6f2d01ac33", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3c0d99d24295618d657005607cf5d5a0c88bed83", "chunk": "diff --git a/streams/src/main/java/org/apache/kafka/streams/processor/ProcessorContext.java b/streams/src/main/java/org/apache/kafka/streams/processor/ProcessorContext.java\nindex 6143f4a796..59cfdb52c2 100644\n--- a/streams/src/main/java/org/apache/kafka/streams/processor/ProcessorContext.java\n+++ b/streams/src/main/java/org/apache/kafka/streams/processor/ProcessorContext.java\n\n@@ -290,16 +292,35 @@ public interface ProcessorContext {\n     Map<String, Object> appConfigsWithPrefix(final String prefix);\n \n     /**\n-     * Returns current cached wall-clock system timestamp in milliseconds.\n+     * Return the current system timestamp (also called wall-clock time) in milliseconds.\n      *\n-     * @return the current cached wall-clock system timestamp in milliseconds\n+     * <p>\n+     * Note: this method returns the internally cached system timestamp from the Kafka Stream runtime.\n+     * Thus, it may return a different value compared to `System.currentTimeMillis()`.\n+     * <p>\n+     *\n+     * For a global processor, Kafka Streams does not cache system time and thus calling this method will return\n+     * the same value as `System.currentTimeMillis()`.\n+     *\n+     * @return the current system timestamp in milliseconds\n      */\n     long currentSystemTimeMs();\n \n     /**\n-     * Returns the maximum timestamp of any record yet processed by the task.\n+     * Return the current stream-time in milliseconds.\n+     *\n+     * <p>\n+     * Stream-time is the maximum observed {@link TimestampExtractor record timestamp} so far\n+     * (including the currently processed record), i.e., it can be considered a high-watermark.\n+     * Stream-time is tracked on a per-task basis and is preserved across restarts and during task migration.\n+     * <p>\n+     *\n+     * Note: this method is not supported for global processors (cf. {@link Topology#addGlobalStore} (...)\n+     * and {@link StreamsBuilder#addGlobalStore} (...),\n+     * because there is no concept of stream-time for this case.\n+     * Calling this method in a global processor with result in an {@link UnsupportedOperationException}.\n      *\n-     * @return the maximum timestamp of any record yet processed by the task\n+     * @return the current stream-time in milliseconds\n      */\n     long currentStreamTimeMs();\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTU0NjY4Nw==", "url": "https://github.com/apache/kafka/pull/9744#discussion_r549546687", "bodyText": "What about:\nReturn the current stream-time in milliseconds.\n<p>\nStream-time is the maximum observed {@link TimestampExtractor record timestamp} so far\n(including the currently processed record), i.e., it can be considered a high-watermark.\nStream-time is tracked on a per-task basis and is preserved across restarts and during task migration.\n<p>\nNote: this method is not supported for global processors (cf. {@link Topology#addGlobalStore(...)}\nand {@link StreamsBuilder#addGlobalStore(...)}, because there is no concept of stream-time for this case.\nCalling this method in a global processor with result in an {@link UnsupportedOperationException}.\n\n@return the current stream-time in milliseconds", "author": "mjsax", "createdAt": "2020-12-29T02:35:19Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/ProcessorContext.java", "diffHunk": "@@ -289,4 +289,17 @@ Cancellable schedule(final Duration interval,\n      */\n     Map<String, Object> appConfigsWithPrefix(final String prefix);\n \n+    /**\n+     * Returns current cached wall-clock system timestamp in milliseconds.\n+     *\n+     * @return the current cached wall-clock system timestamp in milliseconds\n+     */\n+    long currentSystemTimeMs();\n+\n+    /**\n+     * Returns the maximum timestamp of any record yet processed by the task.", "originalCommit": "b9dfc196aaee91f4fa23fe6563261c6f2d01ac33", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3c0d99d24295618d657005607cf5d5a0c88bed83", "chunk": "diff --git a/streams/src/main/java/org/apache/kafka/streams/processor/ProcessorContext.java b/streams/src/main/java/org/apache/kafka/streams/processor/ProcessorContext.java\nindex 6143f4a796..59cfdb52c2 100644\n--- a/streams/src/main/java/org/apache/kafka/streams/processor/ProcessorContext.java\n+++ b/streams/src/main/java/org/apache/kafka/streams/processor/ProcessorContext.java\n\n@@ -290,16 +292,35 @@ public interface ProcessorContext {\n     Map<String, Object> appConfigsWithPrefix(final String prefix);\n \n     /**\n-     * Returns current cached wall-clock system timestamp in milliseconds.\n+     * Return the current system timestamp (also called wall-clock time) in milliseconds.\n      *\n-     * @return the current cached wall-clock system timestamp in milliseconds\n+     * <p>\n+     * Note: this method returns the internally cached system timestamp from the Kafka Stream runtime.\n+     * Thus, it may return a different value compared to `System.currentTimeMillis()`.\n+     * <p>\n+     *\n+     * For a global processor, Kafka Streams does not cache system time and thus calling this method will return\n+     * the same value as `System.currentTimeMillis()`.\n+     *\n+     * @return the current system timestamp in milliseconds\n      */\n     long currentSystemTimeMs();\n \n     /**\n-     * Returns the maximum timestamp of any record yet processed by the task.\n+     * Return the current stream-time in milliseconds.\n+     *\n+     * <p>\n+     * Stream-time is the maximum observed {@link TimestampExtractor record timestamp} so far\n+     * (including the currently processed record), i.e., it can be considered a high-watermark.\n+     * Stream-time is tracked on a per-task basis and is preserved across restarts and during task migration.\n+     * <p>\n+     *\n+     * Note: this method is not supported for global processors (cf. {@link Topology#addGlobalStore} (...)\n+     * and {@link StreamsBuilder#addGlobalStore} (...),\n+     * because there is no concept of stream-time for this case.\n+     * Calling this method in a global processor with result in an {@link UnsupportedOperationException}.\n      *\n-     * @return the maximum timestamp of any record yet processed by the task\n+     * @return the current stream-time in milliseconds\n      */\n     long currentStreamTimeMs();\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTU0NzMzMQ==", "url": "https://github.com/apache/kafka/pull/9744#discussion_r549547331", "bodyText": "Why do we throw here? It seems to be safe to get the time from delegate object? We only disable forward but nothing else. (same below)", "author": "mjsax", "createdAt": "2020-12-29T02:39:01Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/ForwardingDisabledProcessorContext.java", "diffHunk": "@@ -166,4 +166,14 @@ public long timestamp() {\n     public Map<String, Object> appConfigsWithPrefix(final String prefix) {\n         return delegate.appConfigsWithPrefix(prefix);\n     }\n+\n+    @Override\n+    public long currentSystemTimeMs() {\n+        throw new UnsupportedOperationException(\"this method is not supported in ForwardingDisabledProcessor context\");", "originalCommit": "b9dfc196aaee91f4fa23fe6563261c6f2d01ac33", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3c0d99d24295618d657005607cf5d5a0c88bed83", "chunk": "diff --git a/streams/src/main/java/org/apache/kafka/streams/processor/internals/ForwardingDisabledProcessorContext.java b/streams/src/main/java/org/apache/kafka/streams/processor/internals/ForwardingDisabledProcessorContext.java\nindex 600abf9e54..1f5c91cf89 100644\n--- a/streams/src/main/java/org/apache/kafka/streams/processor/internals/ForwardingDisabledProcessorContext.java\n+++ b/streams/src/main/java/org/apache/kafka/streams/processor/internals/ForwardingDisabledProcessorContext.java\n\n@@ -169,11 +169,11 @@ public final class ForwardingDisabledProcessorContext implements ProcessorContex\n \n     @Override\n     public long currentSystemTimeMs() {\n-        throw new UnsupportedOperationException(\"this method is not supported in ForwardingDisabledProcessor context\");\n+        return delegate.currentSystemTimeMs();\n     }\n \n     @Override\n     public long currentStreamTimeMs() {\n-        throw new UnsupportedOperationException(\"this method is not supported in ForwardingDisabledProcessor context\");\n+        return delegate.currentStreamTimeMs();\n     }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTU0ODEzOA==", "url": "https://github.com/apache/kafka/pull/9744#discussion_r549548138", "bodyText": "This makes sense, but we might want to document this somewhere else, ie, in the corresponding docs. To be fair, not sure atm, if we have much content about it and/or where it add it?\nWe should for sure document it in the JavaDocs, ie, the ProcessorContext interface. (cf my comment above)\nAbout the error message:\nthrow new UnsupportedOperationException(\"There is no concept of stream-time for a global processor.\");", "author": "mjsax", "createdAt": "2020-12-29T02:44:38Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalProcessorContextImpl.java", "diffHunk": "@@ -115,6 +116,16 @@ public void commit() {\n         //no-op\n     }\n \n+    @Override\n+    public long currentSystemTimeMs() {\n+        return Time.SYSTEM.milliseconds();\n+    }\n+\n+    @Override\n+    public long currentStreamTimeMs() {\n+        throw new UnsupportedOperationException(\"this method is not supported in global processor context.\");", "originalCommit": "b9dfc196aaee91f4fa23fe6563261c6f2d01ac33", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3c0d99d24295618d657005607cf5d5a0c88bed83", "chunk": "diff --git a/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalProcessorContextImpl.java b/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalProcessorContextImpl.java\nindex 54e659e327..06cff0033f 100644\n--- a/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalProcessorContextImpl.java\n+++ b/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalProcessorContextImpl.java\n\n@@ -118,12 +121,12 @@ public class GlobalProcessorContextImpl extends AbstractProcessorContext {\n \n     @Override\n     public long currentSystemTimeMs() {\n-        return Time.SYSTEM.milliseconds();\n+        return time.milliseconds();\n     }\n \n     @Override\n     public long currentStreamTimeMs() {\n-        throw new UnsupportedOperationException(\"this method is not supported in global processor context.\");\n+        throw new UnsupportedOperationException(\"There is no concept of stream-time for a global processor.\");\n     }\n \n     /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTU0OTYwNg==", "url": "https://github.com/apache/kafka/pull/9744#discussion_r549549606", "bodyText": "We should pass in a Time reference to the GlobalProcessorContextImpl and call time.milliseconds() here -- otherwise, we cannot mock the time (cf. TopologyTestDriver) for testing", "author": "mjsax", "createdAt": "2020-12-29T02:54:15Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalProcessorContextImpl.java", "diffHunk": "@@ -115,6 +116,16 @@ public void commit() {\n         //no-op\n     }\n \n+    @Override\n+    public long currentSystemTimeMs() {\n+        return Time.SYSTEM.milliseconds();", "originalCommit": "b9dfc196aaee91f4fa23fe6563261c6f2d01ac33", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3c0d99d24295618d657005607cf5d5a0c88bed83", "chunk": "diff --git a/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalProcessorContextImpl.java b/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalProcessorContextImpl.java\nindex 54e659e327..06cff0033f 100644\n--- a/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalProcessorContextImpl.java\n+++ b/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalProcessorContextImpl.java\n\n@@ -118,12 +121,12 @@ public class GlobalProcessorContextImpl extends AbstractProcessorContext {\n \n     @Override\n     public long currentSystemTimeMs() {\n-        return Time.SYSTEM.milliseconds();\n+        return time.milliseconds();\n     }\n \n     @Override\n     public long currentStreamTimeMs() {\n-        throw new UnsupportedOperationException(\"this method is not supported in global processor context.\");\n+        throw new UnsupportedOperationException(\"There is no concept of stream-time for a global processor.\");\n     }\n \n     /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTU0OTk4OA==", "url": "https://github.com/apache/kafka/pull/9744#discussion_r549549988", "bodyText": "We should align the error message to the ones from above: \"StateStores can't access system time.\" (same below).", "author": "mjsax", "createdAt": "2020-12-29T02:56:21Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StoreToProcessorContextAdapter.java", "diffHunk": "@@ -160,4 +160,14 @@ public long timestamp() {\n     public Map<String, Object> appConfigsWithPrefix(final String prefix) {\n         return delegate.appConfigsWithPrefix(prefix);\n     }\n+\n+    @Override\n+    public long currentSystemTimeMs() {\n+        throw new UnsupportedOperationException(\"this method is not supported in StoreToProcessorContextAdapter\");", "originalCommit": "b9dfc196aaee91f4fa23fe6563261c6f2d01ac33", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3c0d99d24295618d657005607cf5d5a0c88bed83", "chunk": "diff --git a/streams/src/main/java/org/apache/kafka/streams/processor/internals/StoreToProcessorContextAdapter.java b/streams/src/main/java/org/apache/kafka/streams/processor/internals/StoreToProcessorContextAdapter.java\nindex 3c9cbc621f..4491d65c10 100644\n--- a/streams/src/main/java/org/apache/kafka/streams/processor/internals/StoreToProcessorContextAdapter.java\n+++ b/streams/src/main/java/org/apache/kafka/streams/processor/internals/StoreToProcessorContextAdapter.java\n\n@@ -163,11 +163,11 @@ public final class StoreToProcessorContextAdapter implements ProcessorContext {\n \n     @Override\n     public long currentSystemTimeMs() {\n-        throw new UnsupportedOperationException(\"this method is not supported in StoreToProcessorContextAdapter\");\n+        throw new UnsupportedOperationException(\"StateStores can't access system time.\");\n     }\n \n     @Override\n     public long currentStreamTimeMs() {\n-        throw new UnsupportedOperationException(\"this method is not supported in StoreToProcessorContextAdapter\");\n+        throw new UnsupportedOperationException(\"StateStores can't access stream time.\");\n     }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTU1MDQ0MQ==", "url": "https://github.com/apache/kafka/pull/9744#discussion_r549550441", "bodyText": "Why is this public now? It seems it's only newly called in ProcessorContextImpl that is in the same package and thus it can stay (default) package-private.", "author": "mjsax", "createdAt": "2020-12-29T02:58:47Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamTask.java", "diffHunk": "@@ -1111,13 +1111,21 @@ RecordCollector recordCollector() {\n         return recordCollector;\n     }\n \n+    public long streamTime() {", "originalCommit": "b9dfc196aaee91f4fa23fe6563261c6f2d01ac33", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3c0d99d24295618d657005607cf5d5a0c88bed83", "chunk": "diff --git a/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamTask.java b/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamTask.java\nindex fa827d1a40..64197c09b9 100644\n--- a/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamTask.java\n+++ b/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamTask.java\n\n@@ -1111,11 +1110,11 @@ public class StreamTask extends AbstractTask implements ProcessorNodePunctuator,\n         return recordCollector;\n     }\n \n-    public long streamTime() {\n+    long streamTime() {\n         return partitionGroup.streamTime();\n     }\n \n-    public long currentSystemTimeMs() {\n+    long currentSystemTimeMs() {\n         return time.milliseconds(); \n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTU1MDY0Mg==", "url": "https://github.com/apache/kafka/pull/9744#discussion_r549550642", "bodyText": "As above: seems this can be package-private?", "author": "mjsax", "createdAt": "2020-12-29T03:00:08Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamTask.java", "diffHunk": "@@ -1111,13 +1111,21 @@ RecordCollector recordCollector() {\n         return recordCollector;\n     }\n \n+    public long streamTime() {\n+        return partitionGroup.streamTime();\n+    }\n+\n+    public long currentSystemTimeMs() {", "originalCommit": "b9dfc196aaee91f4fa23fe6563261c6f2d01ac33", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3c0d99d24295618d657005607cf5d5a0c88bed83", "chunk": "diff --git a/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamTask.java b/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamTask.java\nindex fa827d1a40..64197c09b9 100644\n--- a/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamTask.java\n+++ b/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamTask.java\n\n@@ -1111,11 +1110,11 @@ public class StreamTask extends AbstractTask implements ProcessorNodePunctuator,\n         return recordCollector;\n     }\n \n-    public long streamTime() {\n+    long streamTime() {\n         return partitionGroup.streamTime();\n     }\n \n-    public long currentSystemTimeMs() {\n+    long currentSystemTimeMs() {\n         return time.milliseconds(); \n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTU1MDgwNg==", "url": "https://github.com/apache/kafka/pull/9744#discussion_r549550806", "bodyText": "Yes, Time is always wall-clock time -- comment seems unnecessary", "author": "mjsax", "createdAt": "2020-12-29T03:01:30Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamTask.java", "diffHunk": "@@ -70,7 +70,8 @@\n     // visible for testing\n     static final byte LATEST_MAGIC_BYTE = 1;\n \n-    private final Time time;\n+    // This time is wall clock time", "originalCommit": "b9dfc196aaee91f4fa23fe6563261c6f2d01ac33", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3c0d99d24295618d657005607cf5d5a0c88bed83", "chunk": "diff --git a/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamTask.java b/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamTask.java\nindex fa827d1a40..64197c09b9 100644\n--- a/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamTask.java\n+++ b/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamTask.java\n\n@@ -70,7 +70,6 @@ public class StreamTask extends AbstractTask implements ProcessorNodePunctuator,\n     // visible for testing\n     static final byte LATEST_MAGIC_BYTE = 1;\n \n-    // This time is wall clock time\n     private Time time;\n     private final Consumer<byte[], byte[]> mainConsumer;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTU1MDg1OA==", "url": "https://github.com/apache/kafka/pull/9744#discussion_r549550858", "bodyText": "I think we should keep this as final (compare my other comments).", "author": "mjsax", "createdAt": "2020-12-29T03:01:55Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamTask.java", "diffHunk": "@@ -70,7 +70,8 @@\n     // visible for testing\n     static final byte LATEST_MAGIC_BYTE = 1;\n \n-    private final Time time;\n+    // This time is wall clock time\n+    private Time time;", "originalCommit": "b9dfc196aaee91f4fa23fe6563261c6f2d01ac33", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3c0d99d24295618d657005607cf5d5a0c88bed83", "chunk": "diff --git a/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamTask.java b/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamTask.java\nindex fa827d1a40..64197c09b9 100644\n--- a/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamTask.java\n+++ b/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamTask.java\n\n@@ -70,7 +70,6 @@ public class StreamTask extends AbstractTask implements ProcessorNodePunctuator,\n     // visible for testing\n     static final byte LATEST_MAGIC_BYTE = 1;\n \n-    // This time is wall clock time\n     private Time time;\n     private final Consumer<byte[], byte[]> mainConsumer;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTU1MDk0OQ==", "url": "https://github.com/apache/kafka/pull/9744#discussion_r549550949", "bodyText": "I don't think we need this method (cf. my other comment in the test code where it is used).", "author": "mjsax", "createdAt": "2020-12-29T03:02:26Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamTask.java", "diffHunk": "@@ -1111,13 +1111,21 @@ RecordCollector recordCollector() {\n         return recordCollector;\n     }\n \n+    public long streamTime() {\n+        return partitionGroup.streamTime();\n+    }\n+\n+    public long currentSystemTimeMs() {\n+        return time.milliseconds(); \n+    }\n+\n     // below are visible for testing only\n     int numBuffered() {\n         return partitionGroup.numBuffered();\n     }\n \n-    long streamTime() {\n-        return partitionGroup.streamTime();\n+    void setTime(final Time time) {", "originalCommit": "b9dfc196aaee91f4fa23fe6563261c6f2d01ac33", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3c0d99d24295618d657005607cf5d5a0c88bed83", "chunk": "diff --git a/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamTask.java b/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamTask.java\nindex fa827d1a40..64197c09b9 100644\n--- a/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamTask.java\n+++ b/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamTask.java\n\n@@ -1111,11 +1110,11 @@ public class StreamTask extends AbstractTask implements ProcessorNodePunctuator,\n         return recordCollector;\n     }\n \n-    public long streamTime() {\n+    long streamTime() {\n         return partitionGroup.streamTime();\n     }\n \n-    public long currentSystemTimeMs() {\n+    long currentSystemTimeMs() {\n         return time.milliseconds(); \n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTU1MTIyOQ==", "url": "https://github.com/apache/kafka/pull/9744#discussion_r549551229", "bodyText": "This test seems not to be useful, as it tests the TestProcessorContext from below.", "author": "mjsax", "createdAt": "2020-12-29T03:04:19Z", "path": "streams/src/test/java/org/apache/kafka/streams/processor/internals/AbstractProcessorContextTest.java", "diffHunk": "@@ -179,6 +179,10 @@ public void appConfigsShouldReturnUnrecognizedValues() {\n             equalTo(\"user-supplied-value\"));\n     }\n \n+    @Test(expected = UnsupportedOperationException.class)\n+    public void shouldThrowOnCurrentStreamTime() {", "originalCommit": "b9dfc196aaee91f4fa23fe6563261c6f2d01ac33", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3c0d99d24295618d657005607cf5d5a0c88bed83", "chunk": "diff --git a/streams/src/test/java/org/apache/kafka/streams/processor/internals/AbstractProcessorContextTest.java b/streams/src/test/java/org/apache/kafka/streams/processor/internals/AbstractProcessorContextTest.java\nindex e9ba9c6682..68e02661bb 100644\n--- a/streams/src/test/java/org/apache/kafka/streams/processor/internals/AbstractProcessorContextTest.java\n+++ b/streams/src/test/java/org/apache/kafka/streams/processor/internals/AbstractProcessorContextTest.java\n\n@@ -179,11 +179,6 @@ public class AbstractProcessorContextTest {\n             equalTo(\"user-supplied-value\"));\n     }\n \n-    @Test(expected = UnsupportedOperationException.class)\n-    public void shouldThrowOnCurrentStreamTime() {\n-        context.currentStreamTimeMs();\n-    }\n-\n     private static class TestProcessorContext extends AbstractProcessorContext {\n         static Properties config;\n         static {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTU1MTYyMg==", "url": "https://github.com/apache/kafka/pull/9744#discussion_r549551622", "bodyText": "This should be two tests, one for each method.", "author": "mjsax", "createdAt": "2020-12-29T03:06:37Z", "path": "streams/src/test/java/org/apache/kafka/streams/processor/internals/ProcessorContextImplTest.java", "diffHunk": "@@ -555,6 +559,12 @@ public void shouldThrowUnsupportedOperationExceptionOnRecordContext() {\n         );\n     }\n \n+    @Test\n+    public void shouldMatchSystemAndStreamTime() {", "originalCommit": "b9dfc196aaee91f4fa23fe6563261c6f2d01ac33", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3c0d99d24295618d657005607cf5d5a0c88bed83", "chunk": "diff --git a/streams/src/test/java/org/apache/kafka/streams/processor/internals/ProcessorContextImplTest.java b/streams/src/test/java/org/apache/kafka/streams/processor/internals/ProcessorContextImplTest.java\nindex 90e459be63..fa78597b06 100644\n--- a/streams/src/test/java/org/apache/kafka/streams/processor/internals/ProcessorContextImplTest.java\n+++ b/streams/src/test/java/org/apache/kafka/streams/processor/internals/ProcessorContextImplTest.java\n\n@@ -560,8 +560,12 @@ public class ProcessorContextImplTest {\n     }\n \n     @Test\n-    public void shouldMatchSystemAndStreamTime() {\n+    public void shouldMatchSystemTime() {\n         assertEquals(TIMESTAMP, context.currentSystemTimeMs());\n+    }\n+\n+    @Test\n+    public void shouldMatchStreamTime() {\n         assertEquals(STREAM_TIME, context.currentStreamTimeMs());\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTU1MjMzNQ==", "url": "https://github.com/apache/kafka/pull/9744#discussion_r549552335", "bodyText": "Thanks for adding a test!!!\nWould you mind to add tests for all other methods of StoreToProcessorContextAdapter, too, to get full test coverage as a side improvement?", "author": "mjsax", "createdAt": "2020-12-29T03:11:05Z", "path": "streams/src/test/java/org/apache/kafka/streams/processor/internals/StoreToProcessorContextAdapterTest.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.kafka.streams.processor.internals;\n+\n+import org.apache.kafka.streams.processor.ProcessorContext;\n+import org.apache.kafka.streams.processor.StateStoreContext;\n+import org.easymock.EasyMockRunner;\n+import org.easymock.Mock;\n+import org.easymock.MockType;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+\n+@RunWith(EasyMockRunner.class)\n+public class StoreToProcessorContextAdapterTest {", "originalCommit": "b9dfc196aaee91f4fa23fe6563261c6f2d01ac33", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2103993cd2555d2575375cdee434e203980b903b", "chunk": "diff --git a/streams/src/test/java/org/apache/kafka/streams/processor/internals/StoreToProcessorContextAdapterTest.java b/streams/src/test/java/org/apache/kafka/streams/processor/internals/StoreToProcessorContextAdapterTest.java\nindex decbf6218d..aa85b1fe6f 100644\n--- a/streams/src/test/java/org/apache/kafka/streams/processor/internals/StoreToProcessorContextAdapterTest.java\n+++ b/streams/src/test/java/org/apache/kafka/streams/processor/internals/StoreToProcessorContextAdapterTest.java\n\n@@ -17,7 +17,10 @@\n package org.apache.kafka.streams.processor.internals;\n \n import org.apache.kafka.streams.processor.ProcessorContext;\n+import org.apache.kafka.streams.processor.PunctuationType;\n+import org.apache.kafka.streams.processor.Punctuator;\n import org.apache.kafka.streams.processor.StateStoreContext;\n+import org.apache.kafka.streams.processor.To;\n import org.easymock.EasyMockRunner;\n import org.easymock.Mock;\n import org.easymock.MockType;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTU1Mjc2OA==", "url": "https://github.com/apache/kafka/pull/9744#discussion_r549552768", "bodyText": "We have already a global MockTime object in this test that we should reused instead of creating a new one. This way, we can avoid to add setTime and keep the Time member variable final. -- Or is there a reason why we cannot reuse the global MockTime object?\nAlso, I don't really see any call to the newly added methods in this test, so why do we change this test method at all?", "author": "mjsax", "createdAt": "2020-12-29T03:14:01Z", "path": "streams/src/test/java/org/apache/kafka/streams/processor/internals/StreamTaskTest.java", "diffHunk": "@@ -494,7 +494,9 @@ public void process(final Record<Integer, Integer> record) {\n \n         // e2e latency = 10\n         task.addRecords(partition1, singletonList(getConsumerRecord(0, 0L)));\n-        task.process(10L);\n+        time = new MockTime(0L, 10L, 0L);", "originalCommit": "b9dfc196aaee91f4fa23fe6563261c6f2d01ac33", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTA1NTI5Mw==", "url": "https://github.com/apache/kafka/pull/9744#discussion_r551055293", "bodyText": "@mjsax The reason I had to change StreamTaskTest is because of following issue:\nStreamTask -> process(wallClockTime) method updates processor context's system time in this method: https://github.com/apache/kafka/blob/trunk/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamTask.java#L685\nAbstractProcessorContect has another systemTime field: https://github.com/apache/kafka/blob/trunk/streams/src/main/java/org/apache/kafka/streams/processor/internals/AbstractProcessorContext.java#L48 which is updated in streamTask's process method. I removed this field from AbstractProcessorContect as we want to fetch the time from StreamTask. But the latency is measured here which is streamTask's time filed now which is not updated.\nI couldn't find any other way to change time field in StreamTask unless I add setTime method in it. If i don't change time in StreamTask object, subsequent metric tests fail as stream-time is not updated.\nDo you have recommendation about how i can fix it without adding setTime method?", "author": "rohitrmd", "createdAt": "2021-01-03T21:15:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTU1Mjc2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjIwNjU1OQ==", "url": "https://github.com/apache/kafka/pull/9744#discussion_r556206559", "bodyText": "In L159, we define a global mock time object:\nprivate MockTime time = new MockTime();\n\nthat is passed into StreamTask. You can call time.sleep(...) to advance the mock time.", "author": "mjsax", "createdAt": "2021-01-13T01:36:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTU1Mjc2OA=="}], "type": "inlineReview", "revised_code": {"commit": "ca2e80091864359d102805c12c167ec2c43e512d", "chunk": "diff --git a/streams/src/test/java/org/apache/kafka/streams/processor/internals/StreamTaskTest.java b/streams/src/test/java/org/apache/kafka/streams/processor/internals/StreamTaskTest.java\nindex ac3e909530..bd2421eea4 100644\n--- a/streams/src/test/java/org/apache/kafka/streams/processor/internals/StreamTaskTest.java\n+++ b/streams/src/test/java/org/apache/kafka/streams/processor/internals/StreamTaskTest.java\n\n@@ -494,8 +494,7 @@ public class StreamTaskTest {\n \n         // e2e latency = 10\n         task.addRecords(partition1, singletonList(getConsumerRecord(0, 0L)));\n-        time = new MockTime(0L, 10L, 0L);\n-        task.setTime(time);\n+        time.sleep(10L);\n         task.process(time.milliseconds());\n \n         assertThat(sourceAvg.metricValue(), equalTo(10.0));\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTU1MjgwMQ==", "url": "https://github.com/apache/kafka/pull/9744#discussion_r549552801", "bodyText": "Why do we not keep task.process(10L); ? Similar below.", "author": "mjsax", "createdAt": "2020-12-29T03:14:16Z", "path": "streams/src/test/java/org/apache/kafka/streams/processor/internals/StreamTaskTest.java", "diffHunk": "@@ -494,7 +494,9 @@ public void process(final Record<Integer, Integer> record) {\n \n         // e2e latency = 10\n         task.addRecords(partition1, singletonList(getConsumerRecord(0, 0L)));\n-        task.process(10L);\n+        time = new MockTime(0L, 10L, 0L);\n+        task.setTime(time);\n+        task.process(time.milliseconds());", "originalCommit": "b9dfc196aaee91f4fa23fe6563261c6f2d01ac33", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ca2e80091864359d102805c12c167ec2c43e512d", "chunk": "diff --git a/streams/src/test/java/org/apache/kafka/streams/processor/internals/StreamTaskTest.java b/streams/src/test/java/org/apache/kafka/streams/processor/internals/StreamTaskTest.java\nindex ac3e909530..bd2421eea4 100644\n--- a/streams/src/test/java/org/apache/kafka/streams/processor/internals/StreamTaskTest.java\n+++ b/streams/src/test/java/org/apache/kafka/streams/processor/internals/StreamTaskTest.java\n\n@@ -494,8 +494,7 @@ public class StreamTaskTest {\n \n         // e2e latency = 10\n         task.addRecords(partition1, singletonList(getConsumerRecord(0, 0L)));\n-        time = new MockTime(0L, 10L, 0L);\n-        task.setTime(time);\n+        time.sleep(10L);\n         task.process(time.milliseconds());\n \n         assertThat(sourceAvg.metricValue(), equalTo(10.0));\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTU1MzI0Mw==", "url": "https://github.com/apache/kafka/pull/9744#discussion_r549553243", "bodyText": "nit: revert insert of additional space", "author": "mjsax", "createdAt": "2020-12-29T03:16:44Z", "path": "streams/src/test/java/org/apache/kafka/test/InternalMockProcessorContext.java", "diffHunk": "@@ -116,7 +117,7 @@ public InternalMockProcessorContext(final StreamsMetricsImpl streamsMetrics) {\n         );\n     }\n \n-    public InternalMockProcessorContext(final File stateDir,\n+    public  InternalMockProcessorContext(final File stateDir,", "originalCommit": "b9dfc196aaee91f4fa23fe6563261c6f2d01ac33", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3c0d99d24295618d657005607cf5d5a0c88bed83", "chunk": "diff --git a/streams/src/test/java/org/apache/kafka/test/InternalMockProcessorContext.java b/streams/src/test/java/org/apache/kafka/test/InternalMockProcessorContext.java\nindex d9ee3178cf..3a4fa379bc 100644\n--- a/streams/src/test/java/org/apache/kafka/test/InternalMockProcessorContext.java\n+++ b/streams/src/test/java/org/apache/kafka/test/InternalMockProcessorContext.java\n\n@@ -117,7 +117,7 @@ public class InternalMockProcessorContext\n         );\n     }\n \n-    public  InternalMockProcessorContext(final File stateDir,\n+    public InternalMockProcessorContext(final File stateDir,\n                                         final StreamsConfig config,\n                                         final RecordCollector collector) {\n         this(\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTU1MzUzOQ==", "url": "https://github.com/apache/kafka/pull/9744#discussion_r549553539", "bodyText": "We should pass in a Time parameter into the constructor of InternalMockProcessorContext and return time.milliseconds() here so we can mock the time.\nIf this method is unused, it's also ok to just throw an exception for now and we add mocking capabilities later when needed.\n(Same below.)", "author": "mjsax", "createdAt": "2020-12-29T03:18:36Z", "path": "streams/src/test/java/org/apache/kafka/test/InternalMockProcessorContext.java", "diffHunk": "@@ -369,6 +370,16 @@ public long timestamp() {\n         return recordContext.timestamp();\n     }\n \n+    @Override\n+    public long currentSystemTimeMs() {\n+        return Time.SYSTEM.milliseconds();", "originalCommit": "b9dfc196aaee91f4fa23fe6563261c6f2d01ac33", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d124ff5c647c483e6501f3cf301be9c9c5f3dc6c", "chunk": "diff --git a/streams/src/test/java/org/apache/kafka/test/InternalMockProcessorContext.java b/streams/src/test/java/org/apache/kafka/test/InternalMockProcessorContext.java\nindex d9ee3178cf..c392c95713 100644\n--- a/streams/src/test/java/org/apache/kafka/test/InternalMockProcessorContext.java\n+++ b/streams/src/test/java/org/apache/kafka/test/InternalMockProcessorContext.java\n\n@@ -372,7 +382,7 @@ public class InternalMockProcessorContext\n \n     @Override\n     public long currentSystemTimeMs() {\n-        return Time.SYSTEM.milliseconds();\n+        return time.milliseconds();\n     }\n \n     @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTU1Mzg0MA==", "url": "https://github.com/apache/kafka/pull/9744#discussion_r549553840", "bodyText": "The purpose of this class seems to be to allow mocking the time -- given that we add proper time support now, I am wondering if we can actually delete the whole class?", "author": "mjsax", "createdAt": "2020-12-29T03:20:53Z", "path": "streams/src/test/java/org/apache/kafka/test/MockInternalProcessorContext.java", "diffHunk": "@@ -55,14 +55,9 @@ public MockInternalProcessorContext(final Properties config, final TaskId taskId\n         super(config, taskId, stateDir);\n     }\n \n-    @Override\n-    public void setSystemTimeMs(long timeMs) {", "originalCommit": "b9dfc196aaee91f4fa23fe6563261c6f2d01ac33", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzI0NzUxMQ==", "url": "https://github.com/apache/kafka/pull/9744#discussion_r563247511", "bodyText": "@mjsax should i try to do this in another pr?", "author": "rohitrmd", "createdAt": "2021-01-24T06:54:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTU1Mzg0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDk5ODY1NA==", "url": "https://github.com/apache/kafka/pull/9744#discussion_r564998654", "bodyText": "I guess a follow up PR works, too.", "author": "mjsax", "createdAt": "2021-01-27T03:24:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTU1Mzg0MA=="}], "type": "inlineReview", "revised_code": {"commit": "b464a30cabd8533060349c3a9c7bf94cdde51572", "chunk": "diff --git a/streams/src/test/java/org/apache/kafka/test/MockInternalProcessorContext.java b/streams/src/test/java/org/apache/kafka/test/MockInternalProcessorContext.java\nindex 071fb27ff1..370dca75ce 100644\n--- a/streams/src/test/java/org/apache/kafka/test/MockInternalProcessorContext.java\n+++ b/streams/src/test/java/org/apache/kafka/test/MockInternalProcessorContext.java\n\n@@ -55,9 +55,14 @@ public class MockInternalProcessorContext extends MockProcessorContext implement\n         super(config, taskId, stateDir);\n     }\n \n+    @Override\n+    public void setSystemTimeMs(long timeMs) {\n+        currentSystemTimeMs = timeMs;\n+    }\n+\n     @Override\n     public long currentSystemTimeMs() {\n-        return Time.SYSTEM.milliseconds();\n+        return currentSystemTimeMs;\n     }\n \n     @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTU1NDA0NQ==", "url": "https://github.com/apache/kafka/pull/9744#discussion_r549554045", "bodyText": "Nit: I guess we could add support if needed. Maybe better say \"Not implemented yet.\" ? (Same below.)", "author": "mjsax", "createdAt": "2020-12-29T03:22:24Z", "path": "streams/src/test/java/org/apache/kafka/test/NoOpProcessorContext.java", "diffHunk": "@@ -120,6 +120,16 @@ public Cancellable schedule(final Duration interval,\n     @Override\n     public void commit() {}\n \n+    @Override\n+    public long currentSystemTimeMs() {\n+        throw new UnsupportedOperationException(\"this method is not supported in NoOpProcessorContext\");", "originalCommit": "b9dfc196aaee91f4fa23fe6563261c6f2d01ac33", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3c0d99d24295618d657005607cf5d5a0c88bed83", "chunk": "diff --git a/streams/src/test/java/org/apache/kafka/test/NoOpProcessorContext.java b/streams/src/test/java/org/apache/kafka/test/NoOpProcessorContext.java\nindex 794a63f31a..83580182fb 100644\n--- a/streams/src/test/java/org/apache/kafka/test/NoOpProcessorContext.java\n+++ b/streams/src/test/java/org/apache/kafka/test/NoOpProcessorContext.java\n\n@@ -122,12 +122,12 @@ public class NoOpProcessorContext extends AbstractProcessorContext {\n \n     @Override\n     public long currentSystemTimeMs() {\n-        throw new UnsupportedOperationException(\"this method is not supported in NoOpProcessorContext\");\n+        throw new UnsupportedOperationException(\"Not implemented yet.\");\n     }\n \n     @Override\n     public long currentStreamTimeMs() {\n-        throw new UnsupportedOperationException(\"this method is not supported in NoOpProcessorContext\");\n+        throw new UnsupportedOperationException(\"Not implemented yet.\");\n     }\n \n     @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTU1NDA4OQ==", "url": "https://github.com/apache/kafka/pull/9744#discussion_r549554089", "bodyText": "I don't think we need this change. The new test you added below, seem to re-test ProcessorContextImpl that is already tested in ProcessorContextImplTest and thus we don't need those.", "author": "mjsax", "createdAt": "2020-12-29T03:22:51Z", "path": "streams/test-utils/src/main/java/org/apache/kafka/streams/TopologyTestDriver.java", "diffHunk": "@@ -505,7 +506,7 @@ private void setupTask(final StreamsConfig streamsConfig,\n                 streamsMetrics\n             );\n \n-            final InternalProcessorContext context = new ProcessorContextImpl(", "originalCommit": "b9dfc196aaee91f4fa23fe6563261c6f2d01ac33", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3c0d99d24295618d657005607cf5d5a0c88bed83", "chunk": "diff --git a/streams/test-utils/src/main/java/org/apache/kafka/streams/TopologyTestDriver.java b/streams/test-utils/src/main/java/org/apache/kafka/streams/TopologyTestDriver.java\nindex 55b9ca80ea..925b341b7d 100644\n--- a/streams/test-utils/src/main/java/org/apache/kafka/streams/TopologyTestDriver.java\n+++ b/streams/test-utils/src/main/java/org/apache/kafka/streams/TopologyTestDriver.java\n\n@@ -506,7 +505,7 @@ public class TopologyTestDriver implements Closeable {\n                 streamsMetrics\n             );\n \n-            context = new ProcessorContextImpl(\n+            final InternalProcessorContext context = new ProcessorContextImpl(\n                 TASK_ID,\n                 streamsConfig,\n                 stateManager,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTU1NTAxOQ==", "url": "https://github.com/apache/kafka/pull/9744#discussion_r549555019", "bodyText": "timestamp is the current record timestamp and thus should not be returned here (same below).\nI seems, we need to actually extend this test-util class, what is a small change to the KIP. Note, that test-utils are public API and thus those changes also need a KIP. You don't need to worry about your KIP, we can just update it accordingly.\nSeems, we need to have two more internal fields, one for each time. The public API change would be to add corresponding setters. We might also rename setTimestamp to setRecordTimestamp for clarity, we we would have three setters for record, system, and stream time.", "author": "mjsax", "createdAt": "2020-12-29T03:28:34Z", "path": "streams/test-utils/src/main/java/org/apache/kafka/streams/processor/MockProcessorContext.java", "diffHunk": "@@ -261,6 +261,16 @@ public TaskId taskId() {\n         return config.originalsWithPrefix(prefix);\n     }\n \n+    @Override\n+    public long currentSystemTimeMs() {\n+        return timestamp;", "originalCommit": "b9dfc196aaee91f4fa23fe6563261c6f2d01ac33", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2df788fd336646572bd41b3e90c2de9b736fb371", "chunk": "diff --git a/streams/test-utils/src/main/java/org/apache/kafka/streams/processor/MockProcessorContext.java b/streams/test-utils/src/main/java/org/apache/kafka/streams/processor/MockProcessorContext.java\nindex 040ac7f80c..d5113b8e23 100644\n--- a/streams/test-utils/src/main/java/org/apache/kafka/streams/processor/MockProcessorContext.java\n+++ b/streams/test-utils/src/main/java/org/apache/kafka/streams/processor/MockProcessorContext.java\n\n@@ -263,12 +265,18 @@ public class MockProcessorContext implements ProcessorContext, RecordCollector.S\n \n     @Override\n     public long currentSystemTimeMs() {\n-        return timestamp;\n+        if (currentSystemTimeMs == null) {\n+            throw new IllegalStateException(\"System time must be set before use via setCurrentSystemTimeMs().\");\n+        }\n+        return currentSystemTimeMs;\n     }\n \n     @Override\n     public long currentStreamTimeMs() {\n-        return timestamp;\n+        if (currentStreamTimeMs == null) {\n+            throw new IllegalStateException(\"System time must be set before use via setCurrentStreamTimeMs().\");\n+        }\n+        return currentStreamTimeMs;\n     }\n \n     @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTU1NTYyMw==", "url": "https://github.com/apache/kafka/pull/9744#discussion_r549555623", "bodyText": "I think we can remove those two new tests.\nIf you really want to test it, you should rather add a Processor to the Topology that gets the current system and stream time and verify it this way, ie, we should rather add an integration test than a unit test.", "author": "mjsax", "createdAt": "2020-12-29T03:32:46Z", "path": "streams/test-utils/src/test/java/org/apache/kafka/streams/TopologyTestDriverTest.java", "diffHunk": "@@ -1878,4 +1877,33 @@ public void shouldRespectTaskIdling() {\n             );\n         }\n     }\n+\n+    @Test\n+    public void shouldMatchSystemTime() {", "originalCommit": "b9dfc196aaee91f4fa23fe6563261c6f2d01ac33", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3c0d99d24295618d657005607cf5d5a0c88bed83", "chunk": "diff --git a/streams/test-utils/src/test/java/org/apache/kafka/streams/TopologyTestDriverTest.java b/streams/test-utils/src/test/java/org/apache/kafka/streams/TopologyTestDriverTest.java\nindex 3006d8af2d..dc6978546c 100644\n--- a/streams/test-utils/src/test/java/org/apache/kafka/streams/TopologyTestDriverTest.java\n+++ b/streams/test-utils/src/test/java/org/apache/kafka/streams/TopologyTestDriverTest.java\n\n@@ -1877,33 +1877,4 @@ public class TopologyTestDriverTest {\n             );\n         }\n     }\n-\n-    @Test\n-    public void shouldMatchSystemTime() {\n-        testDriver = new TopologyTestDriver(setupSingleProcessorTopology(), config, Instant.ofEpochMilli(0L));\n-\n-        testDriver.advanceWallClockTime(Duration.ofMillis(5L));\n-        assertEquals(5L, testDriver.context.currentSystemTimeMs());\n-\n-        testDriver.advanceWallClockTime(Duration.ofMillis(9L));\n-        assertEquals(14L, testDriver.context.currentSystemTimeMs());\n-\n-        // stream time is unaffected - initially it's set to -1L\n-        assertEquals(-1L, testDriver.context.currentStreamTimeMs());\n-    }\n-\n-    @Test\n-    public void shouldMatchStreamsTime() {\n-        testDriver = new TopologyTestDriver(setupSingleProcessorTopology(), config, Instant.ofEpochMilli(0L));\n-\n-        pipeRecord(SOURCE_TOPIC_1, new TestRecord<>(key1, value1, null, 42L));\n-        assertEquals(42L, testDriver.context.currentStreamTimeMs());\n-\n-        pipeRecord(SOURCE_TOPIC_1, new TestRecord<>(key1, value1, null, 42L));\n-        assertEquals(42L, testDriver.context.currentStreamTimeMs());\n-\n-        // wall clock time is unaffected\n-        assertEquals(0L, testDriver.context.currentSystemTimeMs());\n-    }\n-\n }\n"}}, {"oid": "3c0d99d24295618d657005607cf5d5a0c88bed83", "url": "https://github.com/apache/kafka/commit/3c0d99d24295618d657005607cf5d5a0c88bed83", "message": "part 1: made changes as per review", "committedDate": "2021-01-04T06:57:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjIwNzE1MQ==", "url": "https://github.com/apache/kafka/pull/9744#discussion_r556207151", "bodyText": "nit (not introduced in this PR, but would be a nice side cleanup): rename to currentSystemTime(...)", "author": "mjsax", "createdAt": "2021-01-13T01:38:20Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/ProcessorContextUtils.java", "diffHunk": "@@ -39,9 +39,7 @@ private ProcessorContextUtils() {}\n      * removing the need for this method.\n      */\n     public static long getCurrentSystemTime(final ProcessorContext context) {", "originalCommit": "3c0d99d24295618d657005607cf5d5a0c88bed83", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e82e0d9307d44a935431e27f22a5db3635d4dcc0", "chunk": "diff --git a/streams/src/main/java/org/apache/kafka/streams/processor/internals/ProcessorContextUtils.java b/streams/src/main/java/org/apache/kafka/streams/processor/internals/ProcessorContextUtils.java\nindex 325e25baec..1c6551124d 100644\n--- a/streams/src/main/java/org/apache/kafka/streams/processor/internals/ProcessorContextUtils.java\n+++ b/streams/src/main/java/org/apache/kafka/streams/processor/internals/ProcessorContextUtils.java\n\n@@ -38,7 +38,7 @@ public final class ProcessorContextUtils {\n      * Note that KIP-622 would move currentSystemTimeMs to ProcessorContext,\n      * removing the need for this method.\n      */\n-    public static long getCurrentSystemTime(final ProcessorContext context) {\n+    public static long currentSystemTime(final ProcessorContext context) {\n         return context.currentSystemTimeMs();\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjIwNzgzMQ==", "url": "https://github.com/apache/kafka/pull/9744#discussion_r556207831", "bodyText": "@guozhangwang -- I am just wondering if removing this variable (what I think conceptually makes sense) might have an perf impact as it seems currentSystemTimeMs acts as some kind of cache -- and instead of using the cached time, we would call time.currentTimeMillis() in ProcessorContextImpl#forwardInternal() now.\nThoughts?", "author": "mjsax", "createdAt": "2021-01-13T01:40:34Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/AbstractProcessorContext.java", "diffHunk": "@@ -45,7 +45,6 @@\n     private boolean initialized;\n     protected ProcessorRecordContext recordContext;\n     protected ProcessorNode<?, ?, ?, ?> currentNode;\n-    private long currentSystemTimeMs;", "originalCommit": "3c0d99d24295618d657005607cf5d5a0c88bed83", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjcxODc3Mg==", "url": "https://github.com/apache/kafka/pull/9744#discussion_r556718772", "bodyText": "I think its rationale is actually to \"not advance\" the system time while in the middle of processing a record, i.e. the system time would just be the time when we start processing / punctuating, and it would not change throughout the process / punctuate.", "author": "guozhangwang", "createdAt": "2021-01-13T17:53:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjIwNzgzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDk5MzI1NQ==", "url": "https://github.com/apache/kafka/pull/9744#discussion_r564993255", "bodyText": "@rohitrmd did you see Guozhang comment? Seems we should not remove this variable (what is a little unfortunate, but I guess desirable behavior) -- maybe we can rename it to cachedSystemTimeMs?\nI guess we want the caching for the GlobalProcessorContext, too? (For this case, we would need to update the JavaDocs of the ProcessorContext interface accordingly.)\nWe should also add a test for the corresponding contest-test classes that they don't advance system time automatically, but only in the advance is triggered explicitly.", "author": "mjsax", "createdAt": "2021-01-27T03:06:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjIwNzgzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjU4Nzk1MQ==", "url": "https://github.com/apache/kafka/pull/9744#discussion_r566587951", "bodyText": "@mjsax do you recommend adding method to AbstractProcessorContext to set cachedSystemTimeMs (setCachedSystemTimeMs) or you want me to add setSystemTimeMs back to InternalProcessorContext and set the system time like it was done before?", "author": "rohitrmd", "createdAt": "2021-01-29T05:29:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjIwNzgzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NzM1Njk2OA==", "url": "https://github.com/apache/kafka/pull/9744#discussion_r567356968", "bodyText": "@mjsax also I am confused about what time do we want to return when currentSystemTimeMs() is called from the ProcessorContext hierarchy. If it's called from AbstractProcessorContext object reference, should we return cachedSystemTimeMs, and if it's called from ProcessorContextImpl object reference, should we return streamTask.currentSystemTimeMs()? Or we want completely new method to return the cached time when ProcessorContextImpl#forwardInternal() is called?", "author": "rohitrmd", "createdAt": "2021-01-31T03:13:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjIwNzgzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODM4OTg4NQ==", "url": "https://github.com/apache/kafka/pull/9744#discussion_r568389885", "bodyText": "If there is an advantage to add the method to the InternalProcessorContext  interface, sure why not. Don't think it's a big difference, and because it all internal code, we can change it anytime in the future.\nI think we should always return the cached time.", "author": "mjsax", "createdAt": "2021-02-02T07:57:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjIwNzgzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDYwNTcyOA==", "url": "https://github.com/apache/kafka/pull/9744#discussion_r570605728", "bodyText": "@mjsax can you please explain again what is expected now as for me this is contrary to initial KIP. What I have understood from KIP, we wanted to return system time from Stream Task. Considering changes in this pr,\n\nWe added one time field in InternalMockProcessorContext which we return when currentSystemTime() is called.\nWhen ProcessorContextImpl's currentSystemTime() method is called, we return time from streamTask's time field.\nWe also added time field in GlobalProcessorContextImpl which we return from currentSystemTime().\nIf we add new cachedSystemTimeMs field in AbstractProcessorContext, when do you want to return this field? Are earlier changes not valid to return time from StreamTask?", "author": "rohitrmd", "createdAt": "2021-02-04T23:06:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjIwNzgzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDcxNjUyMA==", "url": "https://github.com/apache/kafka/pull/9744#discussion_r570716520", "bodyText": "The main motivation to add ProcessorContext#currentSystemTime() was to be able to return the mocked wall-clock time in TopologyTestDriver. Even if we return the cached time from AbstractProcessorContext, we will be able to return the mocked time, as we update the cached time based on the mocked time in TopologyTestDriver.\n\nInternalMockProcessorContext is just for our own unit testing -- it's fine to add the new Time field, it's not a public facing change anyway\nOriginally we changed ProcessorContextImpl because we remove AbstractProcessorContext#currentSystemTime() -- as suggested by Guozhang, we should keep the cached time in AbstractProcessorContext(), and thus we don't need ProcessorContextImpl#currentSystemTime() any longer.\nGlobalProcessorContextImpl is a different code path, and thus the changes of this PR are fine\n\n\nIf we add new cachedSystemTimeMs field in AbstractProcessorContext, when do you want to return this field?\n\nYes, we want to return this field. (We get this behavior by adding back AbstractProcessorContext#currentSystemTime() (and the cached time in this class) and removing ProcessorContextImpl#currentSystemTime().\n\nAre earlier changes not valid to return time from StreamTask?\n\nYes, I think we can revert all changes from StreamTask.\nDoes this make sense?", "author": "mjsax", "createdAt": "2021-02-05T04:42:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjIwNzgzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MTUzMjkxMQ==", "url": "https://github.com/apache/kafka/pull/9744#discussion_r571532911", "bodyText": "@mjsax yes, thank you for the explanation. made changes as per review.", "author": "rohitrmd", "createdAt": "2021-02-07T04:14:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjIwNzgzMQ=="}], "type": "inlineReview", "revised_code": {"commit": "b464a30cabd8533060349c3a9c7bf94cdde51572", "chunk": "diff --git a/streams/src/main/java/org/apache/kafka/streams/processor/internals/AbstractProcessorContext.java b/streams/src/main/java/org/apache/kafka/streams/processor/internals/AbstractProcessorContext.java\nindex 55cf1b3be3..f59a6bcf8e 100644\n--- a/streams/src/main/java/org/apache/kafka/streams/processor/internals/AbstractProcessorContext.java\n+++ b/streams/src/main/java/org/apache/kafka/streams/processor/internals/AbstractProcessorContext.java\n\n@@ -45,7 +45,7 @@ public abstract class AbstractProcessorContext implements InternalProcessorConte\n     private boolean initialized;\n     protected ProcessorRecordContext recordContext;\n     protected ProcessorNode<?, ?, ?, ?> currentNode;\n-\n+    private long cachedSystemTimeMs;\n     protected ThreadCache cache;\n \n     public AbstractProcessorContext(final TaskId taskId,\n"}}, {"oid": "ca2e80091864359d102805c12c167ec2c43e512d", "url": "https://github.com/apache/kafka/commit/ca2e80091864359d102805c12c167ec2c43e512d", "message": "part 2: made changes as per review", "committedDate": "2021-01-17T19:41:41Z", "type": "commit"}, {"oid": "d124ff5c647c483e6501f3cf301be9c9c5f3dc6c", "url": "https://github.com/apache/kafka/commit/d124ff5c647c483e6501f3cf301be9c9c5f3dc6c", "message": "part 3: review: added time parameter to InternalMockProcessorContext constructor", "committedDate": "2021-01-18T20:55:12Z", "type": "commit"}, {"oid": "2df788fd336646572bd41b3e90c2de9b736fb371", "url": "https://github.com/apache/kafka/commit/2df788fd336646572bd41b3e90c2de9b736fb371", "message": "part 4: review: added separate stream and system time fields in MockProcessorContext", "committedDate": "2021-01-19T01:57:13Z", "type": "commit"}, {"oid": "e82e0d9307d44a935431e27f22a5db3635d4dcc0", "url": "https://github.com/apache/kafka/commit/e82e0d9307d44a935431e27f22a5db3635d4dcc0", "message": "part 5; minor refactoring", "committedDate": "2021-01-24T03:19:33Z", "type": "commit"}, {"oid": "2103993cd2555d2575375cdee434e203980b903b", "url": "https://github.com/apache/kafka/commit/2103993cd2555d2575375cdee434e203980b903b", "message": "part 6: added tests for StoreToProcessorContextAdapter", "committedDate": "2021-01-24T06:44:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDk5MjMyMQ==", "url": "https://github.com/apache/kafka/pull/9744#discussion_r564992321", "bodyText": "typo: with -> will", "author": "mjsax", "createdAt": "2021-01-27T03:03:19Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/ProcessorContext.java", "diffHunk": "@@ -289,4 +291,36 @@ Cancellable schedule(final Duration interval,\n      */\n     Map<String, Object> appConfigsWithPrefix(final String prefix);\n \n+    /**\n+     * Return the current system timestamp (also called wall-clock time) in milliseconds.\n+     *\n+     * <p>\n+     * Note: this method returns the internally cached system timestamp from the Kafka Stream runtime.\n+     * Thus, it may return a different value compared to `System.currentTimeMillis()`.\n+     * <p>\n+     *\n+     * For a global processor, Kafka Streams does not cache system time and thus calling this method will return\n+     * the same value as `System.currentTimeMillis()`.\n+     *\n+     * @return the current system timestamp in milliseconds\n+     */\n+    long currentSystemTimeMs();\n+\n+    /**\n+     * Return the current stream-time in milliseconds.\n+     *\n+     * <p>\n+     * Stream-time is the maximum observed {@link TimestampExtractor record timestamp} so far\n+     * (including the currently processed record), i.e., it can be considered a high-watermark.\n+     * Stream-time is tracked on a per-task basis and is preserved across restarts and during task migration.\n+     * <p>\n+     *\n+     * Note: this method is not supported for global processors (cf. {@link Topology#addGlobalStore} (...)\n+     * and {@link StreamsBuilder#addGlobalStore} (...),\n+     * because there is no concept of stream-time for this case.\n+     * Calling this method in a global processor with result in an {@link UnsupportedOperationException}.", "originalCommit": "2103993cd2555d2575375cdee434e203980b903b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e39671daa11c2393b789e9ac3921aa099db6f037", "chunk": "diff --git a/streams/src/main/java/org/apache/kafka/streams/processor/ProcessorContext.java b/streams/src/main/java/org/apache/kafka/streams/processor/ProcessorContext.java\nindex 59cfdb52c2..bedbba6f25 100644\n--- a/streams/src/main/java/org/apache/kafka/streams/processor/ProcessorContext.java\n+++ b/streams/src/main/java/org/apache/kafka/streams/processor/ProcessorContext.java\n\n@@ -296,11 +296,11 @@ public interface ProcessorContext {\n      *\n      * <p>\n      * Note: this method returns the internally cached system timestamp from the Kafka Stream runtime.\n-     * Thus, it may return a different value compared to `System.currentTimeMillis()`.\n+     * Thus, it may return a different value compared to {@code System.currentTimeMillis()} .\n      * <p>\n      *\n      * For a global processor, Kafka Streams does not cache system time and thus calling this method will return\n-     * the same value as `System.currentTimeMillis()`.\n+     * the same value as {@code System.currentTimeMillis()}.\n      *\n      * @return the current system timestamp in milliseconds\n      */\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDk5MjcyOQ==", "url": "https://github.com/apache/kafka/pull/9744#discussion_r564992729", "bodyText": "nit:\n`System.currentTimeMillis()` -> {@code System.currentTimeMillis()} \n\nor: {link System#currentTimeMillis()}", "author": "mjsax", "createdAt": "2021-01-27T03:04:45Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/ProcessorContext.java", "diffHunk": "@@ -289,4 +291,36 @@ Cancellable schedule(final Duration interval,\n      */\n     Map<String, Object> appConfigsWithPrefix(final String prefix);\n \n+    /**\n+     * Return the current system timestamp (also called wall-clock time) in milliseconds.\n+     *\n+     * <p>\n+     * Note: this method returns the internally cached system timestamp from the Kafka Stream runtime.\n+     * Thus, it may return a different value compared to `System.currentTimeMillis()`.", "originalCommit": "2103993cd2555d2575375cdee434e203980b903b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e39671daa11c2393b789e9ac3921aa099db6f037", "chunk": "diff --git a/streams/src/main/java/org/apache/kafka/streams/processor/ProcessorContext.java b/streams/src/main/java/org/apache/kafka/streams/processor/ProcessorContext.java\nindex 59cfdb52c2..bedbba6f25 100644\n--- a/streams/src/main/java/org/apache/kafka/streams/processor/ProcessorContext.java\n+++ b/streams/src/main/java/org/apache/kafka/streams/processor/ProcessorContext.java\n\n@@ -296,11 +296,11 @@ public interface ProcessorContext {\n      *\n      * <p>\n      * Note: this method returns the internally cached system timestamp from the Kafka Stream runtime.\n-     * Thus, it may return a different value compared to `System.currentTimeMillis()`.\n+     * Thus, it may return a different value compared to {@code System.currentTimeMillis()} .\n      * <p>\n      *\n      * For a global processor, Kafka Streams does not cache system time and thus calling this method will return\n-     * the same value as `System.currentTimeMillis()`.\n+     * the same value as {@code System.currentTimeMillis()}.\n      *\n      * @return the current system timestamp in milliseconds\n      */\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDk5Mjc1Ng==", "url": "https://github.com/apache/kafka/pull/9744#discussion_r564992756", "bodyText": "as above", "author": "mjsax", "createdAt": "2021-01-27T03:04:51Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/ProcessorContext.java", "diffHunk": "@@ -289,4 +291,36 @@ Cancellable schedule(final Duration interval,\n      */\n     Map<String, Object> appConfigsWithPrefix(final String prefix);\n \n+    /**\n+     * Return the current system timestamp (also called wall-clock time) in milliseconds.\n+     *\n+     * <p>\n+     * Note: this method returns the internally cached system timestamp from the Kafka Stream runtime.\n+     * Thus, it may return a different value compared to `System.currentTimeMillis()`.\n+     * <p>\n+     *\n+     * For a global processor, Kafka Streams does not cache system time and thus calling this method will return\n+     * the same value as `System.currentTimeMillis()`.", "originalCommit": "2103993cd2555d2575375cdee434e203980b903b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e39671daa11c2393b789e9ac3921aa099db6f037", "chunk": "diff --git a/streams/src/main/java/org/apache/kafka/streams/processor/ProcessorContext.java b/streams/src/main/java/org/apache/kafka/streams/processor/ProcessorContext.java\nindex 59cfdb52c2..bedbba6f25 100644\n--- a/streams/src/main/java/org/apache/kafka/streams/processor/ProcessorContext.java\n+++ b/streams/src/main/java/org/apache/kafka/streams/processor/ProcessorContext.java\n\n@@ -296,11 +296,11 @@ public interface ProcessorContext {\n      *\n      * <p>\n      * Note: this method returns the internally cached system timestamp from the Kafka Stream runtime.\n-     * Thus, it may return a different value compared to `System.currentTimeMillis()`.\n+     * Thus, it may return a different value compared to {@code System.currentTimeMillis()} .\n      * <p>\n      *\n      * For a global processor, Kafka Streams does not cache system time and thus calling this method will return\n-     * the same value as `System.currentTimeMillis()`.\n+     * the same value as {@code System.currentTimeMillis()}.\n      *\n      * @return the current system timestamp in milliseconds\n      */\n"}}, {"oid": "e39671daa11c2393b789e9ac3921aa099db6f037", "url": "https://github.com/apache/kafka/commit/e39671daa11c2393b789e9ac3921aa099db6f037", "message": "part 7: review: refactored comments", "committedDate": "2021-01-29T05:52:26Z", "type": "commit"}, {"oid": "b464a30cabd8533060349c3a9c7bf94cdde51572", "url": "https://github.com/apache/kafka/commit/b464a30cabd8533060349c3a9c7bf94cdde51572", "message": "part 9: review: added cached time to AbstractProcessorContext", "committedDate": "2021-02-07T03:25:53Z", "type": "commit"}, {"oid": "8c74fa5863da649d82008f3a4ab8f157c39b8199", "url": "https://github.com/apache/kafka/commit/8c74fa5863da649d82008f3a4ab8f157c39b8199", "message": "Merge branch 'trunk' into KAFKA-10062", "committedDate": "2021-02-07T03:32:44Z", "type": "commit"}, {"oid": "69c680579f575695bc3dd62587683a7ad55156a1", "url": "https://github.com/apache/kafka/commit/69c680579f575695bc3dd62587683a7ad55156a1", "message": "minor refactoring", "committedDate": "2021-02-07T04:07:23Z", "type": "commit"}, {"oid": "b95faccf8a2d6152a39a6f89544bb2bb26c644b2", "url": "https://github.com/apache/kafka/commit/b95faccf8a2d6152a39a6f89544bb2bb26c644b2", "message": "part 10: review fix comment", "committedDate": "2021-02-10T05:12:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NjcyNzAzMw==", "url": "https://github.com/apache/kafka/pull/9744#discussion_r586727033", "bodyText": "nit. can be removed", "author": "mjsax", "createdAt": "2021-03-03T19:43:30Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/ProcessorContext.java", "diffHunk": "@@ -289,4 +291,33 @@ Cancellable schedule(final Duration interval,\n      */\n     Map<String, Object> appConfigsWithPrefix(final String prefix);\n \n+    /**\n+     * Return the current system timestamp (also called wall-clock time) in milliseconds.\n+     *\n+     * <p>\n+     * Note: this method returns the internally cached system timestamp from the Kafka Stream runtime.\n+     * Thus, it may return a different value compared to {@code System.currentTimeMillis()} .\n+     * <p>", "originalCommit": "b95faccf8a2d6152a39a6f89544bb2bb26c644b2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "85405047d8d0e5782aebabf91a430a8888898d4d", "chunk": "diff --git a/streams/src/main/java/org/apache/kafka/streams/processor/ProcessorContext.java b/streams/src/main/java/org/apache/kafka/streams/processor/ProcessorContext.java\nindex 6b70a83802..fdaa0a466c 100644\n--- a/streams/src/main/java/org/apache/kafka/streams/processor/ProcessorContext.java\n+++ b/streams/src/main/java/org/apache/kafka/streams/processor/ProcessorContext.java\n\n@@ -296,7 +296,7 @@ public interface ProcessorContext {\n      *\n      * <p>\n      * Note: this method returns the internally cached system timestamp from the Kafka Stream runtime.\n-     * Thus, it may return a different value compared to {@code System.currentTimeMillis()} .\n+     * Thus, it may return a different value compared to {@code System.currentTimeMillis()}\n      * <p>\n      *\n      * @return the current system timestamp in milliseconds\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4Njk1ODE1OA==", "url": "https://github.com/apache/kafka/pull/9744#discussion_r586958158", "bodyText": "This class is public API, so we cannot remove setTimestamp but can only deprecate it.\nWe also need to update the KIP to mention the deprecation and the newly added methods.", "author": "mjsax", "createdAt": "2021-03-04T01:41:48Z", "path": "streams/test-utils/src/main/java/org/apache/kafka/streams/processor/MockProcessorContext.java", "diffHunk": "@@ -353,11 +371,19 @@ public void setHeaders(final Headers headers) {\n      * The context exposes this metadata for use in the processor. Normally, they are set by the Kafka Streams framework,\n      * but for the purpose of driving unit tests, you can set it directly. Setting this attribute doesn't affect the others.\n      *\n-     * @param timestamp A record timestamp\n+     * @param recordTimestamp A record timestamp\n      */\n     @SuppressWarnings({\"WeakerAccess\", \"unused\"})\n-    public void setTimestamp(final long timestamp) {\n-        this.timestamp = timestamp;\n+    public void setRecordTimestamp(final long recordTimestamp) {\n+        this.recordTimestamp = recordTimestamp;\n+    }\n+\n+    public void setCurrentSystemTimeMs(final long currentSystemTimeMs) {\n+        this.currentSystemTimeMs = currentSystemTimeMs;\n+    }\n+\n+    public void setCurrentStreamTimeMs(final long currentStreamTimeMs) {\n+        this.currentStreamTimeMs = currentStreamTimeMs;", "originalCommit": "b95faccf8a2d6152a39a6f89544bb2bb26c644b2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4Nzk5NjQ1OA==", "url": "https://github.com/apache/kafka/pull/9744#discussion_r587996458", "bodyText": "@mjsax added the method setTimestamp back which sets record timestamp and added Deprecated annotation. Also updated the kip.", "author": "rohitrmd", "createdAt": "2021-03-05T03:00:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4Njk1ODE1OA=="}], "type": "inlineReview", "revised_code": {"commit": "85405047d8d0e5782aebabf91a430a8888898d4d", "chunk": "diff --git a/streams/test-utils/src/main/java/org/apache/kafka/streams/processor/MockProcessorContext.java b/streams/test-utils/src/main/java/org/apache/kafka/streams/processor/MockProcessorContext.java\nindex dde05cee04..74aae1c80c 100644\n--- a/streams/test-utils/src/main/java/org/apache/kafka/streams/processor/MockProcessorContext.java\n+++ b/streams/test-utils/src/main/java/org/apache/kafka/streams/processor/MockProcessorContext.java\n\n@@ -372,8 +372,21 @@ public class MockProcessorContext implements ProcessorContext, RecordCollector.S\n      * but for the purpose of driving unit tests, you can set it directly. Setting this attribute doesn't affect the others.\n      *\n      * @param recordTimestamp A record timestamp\n+     * @deprecated Use {@link MockProcessorContext#setRecordTimestamp(long)} instead.\n      */\n+    @Deprecated\n     @SuppressWarnings({\"WeakerAccess\", \"unused\"})\n+    public void setTimestamp(final long recordTimestamp) {\n+        this.recordTimestamp = recordTimestamp;\n+    }\n+\n+    /**\n+     * The context exposes this metadata for use in the processor. Normally, they are set by the Kafka Streams framework,\n+     * but for the purpose of driving unit tests, you can set it directly. Setting this attribute doesn't affect the others.\n+     *\n+     * @param recordTimestamp A record timestamp\n+     */\n+    @SuppressWarnings({\"WeakerAccess\"})\n     public void setRecordTimestamp(final long recordTimestamp) {\n         this.recordTimestamp = recordTimestamp;\n     }\n"}}, {"oid": "85405047d8d0e5782aebabf91a430a8888898d4d", "url": "https://github.com/apache/kafka/commit/85405047d8d0e5782aebabf91a430a8888898d4d", "message": "part 11: review :made changes as per review", "committedDate": "2021-03-05T02:20:16Z", "type": "commit"}, {"oid": "d49ab3a184b1ad186fc2a19e29bab3bc3e424a1c", "url": "https://github.com/apache/kafka/commit/d49ab3a184b1ad186fc2a19e29bab3bc3e424a1c", "message": "fix incorrect comment", "committedDate": "2021-03-05T02:48:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5MDc2NjMyMQ==", "url": "https://github.com/apache/kafka/pull/9744#discussion_r590766321", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * Thus, it may return a different value compared to {@code System.currentTimeMillis()}\n          \n          \n            \n                 * Thus, it may return a different value compared to {@code System.currentTimeMillis()}.", "author": "mjsax", "createdAt": "2021-03-09T22:20:44Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/ProcessorContext.java", "diffHunk": "@@ -289,4 +291,33 @@ Cancellable schedule(final Duration interval,\n      */\n     Map<String, Object> appConfigsWithPrefix(final String prefix);\n \n+    /**\n+     * Return the current system timestamp (also called wall-clock time) in milliseconds.\n+     *\n+     * <p>\n+     * Note: this method returns the internally cached system timestamp from the Kafka Stream runtime.\n+     * Thus, it may return a different value compared to {@code System.currentTimeMillis()}", "originalCommit": "d49ab3a184b1ad186fc2a19e29bab3bc3e424a1c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a0e3446e4c0f19f16ec359af7cb5847a25297a2d", "chunk": "diff --git a/streams/src/main/java/org/apache/kafka/streams/processor/ProcessorContext.java b/streams/src/main/java/org/apache/kafka/streams/processor/ProcessorContext.java\nindex fdaa0a466c..09f982b96a 100644\n--- a/streams/src/main/java/org/apache/kafka/streams/processor/ProcessorContext.java\n+++ b/streams/src/main/java/org/apache/kafka/streams/processor/ProcessorContext.java\n\n@@ -296,7 +296,7 @@ public interface ProcessorContext {\n      *\n      * <p>\n      * Note: this method returns the internally cached system timestamp from the Kafka Stream runtime.\n-     * Thus, it may return a different value compared to {@code System.currentTimeMillis()}\n+     * Thus, it may return a different value compared to {@code System.currentTimeMillis()}.\n      * <p>\n      *\n      * @return the current system timestamp in milliseconds\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5MDc2NjQ2MQ==", "url": "https://github.com/apache/kafka/pull/9744#discussion_r590766461", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * <p>", "author": "mjsax", "createdAt": "2021-03-09T22:20:56Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/ProcessorContext.java", "diffHunk": "@@ -289,4 +291,33 @@ Cancellable schedule(final Duration interval,\n      */\n     Map<String, Object> appConfigsWithPrefix(final String prefix);\n \n+    /**\n+     * Return the current system timestamp (also called wall-clock time) in milliseconds.\n+     *\n+     * <p>\n+     * Note: this method returns the internally cached system timestamp from the Kafka Stream runtime.\n+     * Thus, it may return a different value compared to {@code System.currentTimeMillis()}\n+     * <p>", "originalCommit": "d49ab3a184b1ad186fc2a19e29bab3bc3e424a1c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a0e3446e4c0f19f16ec359af7cb5847a25297a2d", "chunk": "diff --git a/streams/src/main/java/org/apache/kafka/streams/processor/ProcessorContext.java b/streams/src/main/java/org/apache/kafka/streams/processor/ProcessorContext.java\nindex fdaa0a466c..09f982b96a 100644\n--- a/streams/src/main/java/org/apache/kafka/streams/processor/ProcessorContext.java\n+++ b/streams/src/main/java/org/apache/kafka/streams/processor/ProcessorContext.java\n\n@@ -296,7 +296,7 @@ public interface ProcessorContext {\n      *\n      * <p>\n      * Note: this method returns the internally cached system timestamp from the Kafka Stream runtime.\n-     * Thus, it may return a different value compared to {@code System.currentTimeMillis()}\n+     * Thus, it may return a different value compared to {@code System.currentTimeMillis()}.\n      * <p>\n      *\n      * @return the current system timestamp in milliseconds\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5MDc2Nzk0Ng==", "url": "https://github.com/apache/kafka/pull/9744#discussion_r590767946", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * @deprecated Use {@link MockProcessorContext#setRecordTimestamp(long)} instead.\n          \n          \n            \n                 * @deprecated Since 3.0.0; use {@link MockProcessorContext#setRecordTimestamp(long)} instead.", "author": "mjsax", "createdAt": "2021-03-09T22:22:23Z", "path": "streams/test-utils/src/main/java/org/apache/kafka/streams/processor/MockProcessorContext.java", "diffHunk": "@@ -354,10 +372,31 @@ public void setHeaders(final Headers headers) {\n      * but for the purpose of driving unit tests, you can set it directly. Setting this attribute doesn't affect the others.\n      *\n      * @param timestamp A record timestamp\n+     * @deprecated Use {@link MockProcessorContext#setRecordTimestamp(long)} instead.", "originalCommit": "d49ab3a184b1ad186fc2a19e29bab3bc3e424a1c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "dd16696cd6c4485aeb8649b48c4e81d402bc857d", "chunk": "diff --git a/streams/test-utils/src/main/java/org/apache/kafka/streams/processor/MockProcessorContext.java b/streams/test-utils/src/main/java/org/apache/kafka/streams/processor/MockProcessorContext.java\nindex 12fb90511e..f85977b5f1 100644\n--- a/streams/test-utils/src/main/java/org/apache/kafka/streams/processor/MockProcessorContext.java\n+++ b/streams/test-utils/src/main/java/org/apache/kafka/streams/processor/MockProcessorContext.java\n\n@@ -372,7 +372,7 @@ public class MockProcessorContext implements ProcessorContext, RecordCollector.S\n      * but for the purpose of driving unit tests, you can set it directly. Setting this attribute doesn't affect the others.\n      *\n      * @param timestamp A record timestamp\n-     * @deprecated Use {@link MockProcessorContext#setRecordTimestamp(long)} instead.\n+     * @deprecated Since 3.0.0; use {@link MockProcessorContext#setRecordTimestamp(long)} instead.\n      */\n     @Deprecated\n     @SuppressWarnings({\"WeakerAccess\", \"unused\"})\n"}}, {"oid": "a0e3446e4c0f19f16ec359af7cb5847a25297a2d", "url": "https://github.com/apache/kafka/commit/a0e3446e4c0f19f16ec359af7cb5847a25297a2d", "message": "Update streams/src/main/java/org/apache/kafka/streams/processor/ProcessorContext.java", "committedDate": "2021-03-09T22:22:53Z", "type": "commit"}, {"oid": "cfd394ababc343fc958250f5c800d8d206447776", "url": "https://github.com/apache/kafka/commit/cfd394ababc343fc958250f5c800d8d206447776", "message": "Update streams/src/main/java/org/apache/kafka/streams/processor/ProcessorContext.java", "committedDate": "2021-03-09T22:22:59Z", "type": "commit"}, {"oid": "dd16696cd6c4485aeb8649b48c4e81d402bc857d", "url": "https://github.com/apache/kafka/commit/dd16696cd6c4485aeb8649b48c4e81d402bc857d", "message": "Update streams/test-utils/src/main/java/org/apache/kafka/streams/processor/MockProcessorContext.java", "committedDate": "2021-03-09T22:23:11Z", "type": "commit"}]}