{"pr_number": 8862, "pr_title": "CB-8510: Fixing NPE when azure getCopyStatus returns with null value", "pr_createdAt": "2020-08-25T15:07:32Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/8862", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY0MDAzNA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8862#discussion_r476640034", "bodyText": "This can still throw NPE when the storage does not contain the image?", "author": "cegganesh84", "createdAt": "2020-08-25T18:04:13Z", "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/image/AzureImageSetupService.java", "diffHunk": "@@ -49,6 +49,9 @@ public ImageStatusResult checkImageStatus(AuthenticatedContext ac, CloudStack st\n         String imageStorageName = armStorage.getImageStorageName(acv, ac.getCloudContext(), stack);\n         try {\n             CopyState copyState = client.getCopyStatus(imageResourceGroupName, imageStorageName, IMAGES_CONTAINER, image.getImageName());\n+            if (copyState == null && storageContainsImage(client, imageResourceGroupName, imageStorageName, image.getImageName())) {\n+                return new ImageStatusResult(ImageStatus.CREATE_FINISHED, ImageStatusResult.COMPLETED);\n+            }\n             if (CopyStatus.SUCCESS.equals(copyState.getStatus())) {", "originalCommit": "a5b7686073ac8a4a2e0290fa875c7c199686cd67", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzUxNjQyOA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8862#discussion_r477516428", "bodyText": "You're right. It's fixed now.", "author": "tiborpopovics", "createdAt": "2020-08-26T18:53:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY0MDAzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODEwOTg5Mg==", "url": "https://github.com/hortonworks/cloudbreak/pull/8862#discussion_r478109892", "bodyText": "Thanks.", "author": "cegganesh84", "createdAt": "2020-08-27T04:44:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY0MDAzNA=="}], "type": "inlineReview", "revised_code": {"commit": "41f4cccb986c5f625cc1e6ee57bd2903cf28a3e6", "chunk": "diff --git a/cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/image/AzureImageSetupService.java b/cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/image/AzureImageSetupService.java\nindex 182569b51b..5bea993641 100644\n--- a/cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/image/AzureImageSetupService.java\n+++ b/cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/image/AzureImageSetupService.java\n\n@@ -42,15 +42,27 @@ public class AzureImageSetupService {\n     private AzureStorageAccountService azureStorageAccountService;\n \n     public ImageStatusResult checkImageStatus(AuthenticatedContext ac, CloudStack stack, Image image) {\n-        String imageResourceGroupName = azureResourceGroupMetadataProvider.getImageResourceGroupName(ac.getCloudContext(), stack);\n+        CloudContext cloudContext = ac.getCloudContext();\n+        String imageResourceGroupName = azureResourceGroupMetadataProvider.getImageResourceGroupName(cloudContext, stack);\n         AzureClient client = ac.getParameter(AzureClient.class);\n \n+        String customImageId = client.getCustomImageId(imageResourceGroupName, image.getImageName(), cloudContext.getLocation().getRegion().getRegionName(),\n+                false);\n+        if (!StringUtils.isEmpty(customImageId)) {\n+            LOGGER.info(\"Custom image with id {} already exists in the target resource group {}, bypassing VHD copy check!\",\n+                    customImageId, imageResourceGroupName);\n+            return new ImageStatusResult(ImageStatus.CREATE_FINISHED, ImageStatusResult.COMPLETED);\n+        }\n         AzureCredentialView acv = new AzureCredentialView(ac.getCloudCredential());\n-        String imageStorageName = armStorage.getImageStorageName(acv, ac.getCloudContext(), stack);\n+        String imageStorageName = armStorage.getImageStorageName(acv, cloudContext, stack);\n         try {\n             CopyState copyState = client.getCopyStatus(imageResourceGroupName, imageStorageName, IMAGES_CONTAINER, image.getImageName());\n             if (copyState == null && storageContainsImage(client, imageResourceGroupName, imageStorageName, image.getImageName())) {\n+                LOGGER.debug(\"The copy has been finished because the storage account already contains the image.\");\n                 return new ImageStatusResult(ImageStatus.CREATE_FINISHED, ImageStatusResult.COMPLETED);\n+            } else if (copyState == null && !storageContainsImage(client, imageResourceGroupName, imageStorageName, image.getImageName())) {\n+                throw new CloudConnectorException(\n+                        \"Image copy failed because the copy state is not available and the storage account does not contains the image.\");\n             }\n             if (CopyStatus.SUCCESS.equals(copyState.getStatus())) {\n                 if (StringUtils.isEmpty(armStorage.getCustomImageId(client, ac, stack))) {\n"}}, {"oid": "41f4cccb986c5f625cc1e6ee57bd2903cf28a3e6", "url": "https://github.com/hortonworks/cloudbreak/commit/41f4cccb986c5f625cc1e6ee57bd2903cf28a3e6", "message": "CB-8510 Fixing NPE when azure getCopyStatus returns with null value", "committedDate": "2020-08-26T15:02:07Z", "type": "forcePushed"}, {"oid": "0f3b6dea99d7fc5d8b9bb0019ca7e83e9d2f0f83", "url": "https://github.com/hortonworks/cloudbreak/commit/0f3b6dea99d7fc5d8b9bb0019ca7e83e9d2f0f83", "message": "Omit image check if managed image is already there", "committedDate": "2020-08-26T18:35:23Z", "type": "commit"}, {"oid": "09c81bd1e4038985e09ff5feaa72573ba2573b48", "url": "https://github.com/hortonworks/cloudbreak/commit/09c81bd1e4038985e09ff5feaa72573ba2573b48", "message": "CB-8510: Fixing NPE when azure getCopyStatus returns with null value", "committedDate": "2020-08-26T18:52:21Z", "type": "forcePushed"}, {"oid": "82125f8d8ffb7af3937a7171c9c2d1d47d0bb15d", "url": "https://github.com/hortonworks/cloudbreak/commit/82125f8d8ffb7af3937a7171c9c2d1d47d0bb15d", "message": "CB-8510: Fixing NPE when azure getCopyStatus returns with null value", "committedDate": "2020-08-26T19:33:03Z", "type": "forcePushed"}, {"oid": "12f20368a385d984df466ad69c8dd0d25b91c49f", "url": "https://github.com/hortonworks/cloudbreak/commit/12f20368a385d984df466ad69c8dd0d25b91c49f", "message": "CB-8510: Fixing NPE when azure getCopyStatus returns with null value", "committedDate": "2020-08-26T20:22:56Z", "type": "commit"}, {"oid": "12f20368a385d984df466ad69c8dd0d25b91c49f", "url": "https://github.com/hortonworks/cloudbreak/commit/12f20368a385d984df466ad69c8dd0d25b91c49f", "message": "CB-8510: Fixing NPE when azure getCopyStatus returns with null value", "committedDate": "2020-08-26T20:22:56Z", "type": "forcePushed"}]}