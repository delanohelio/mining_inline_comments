{"pr_number": 7230, "pr_title": "CB-5031 Ycloud support for hybrid cloud approach", "pr_createdAt": "2020-02-06T09:54:21Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/7230", "timeline": [{"oid": "2724bab1bc544ce642df533f76b6a1e9c97eb82d", "url": "https://github.com/hortonworks/cloudbreak/commit/2724bab1bc544ce642df533f76b6a1e9c97eb82d", "message": "CB-5162 fix FreeIPA and core orchestration for child environment related calls, reenable systemctl hack for YARN", "committedDate": "2020-02-07T13:11:33Z", "type": "forcePushed"}, {"oid": "d19d0066d771099d98678da8d0d062375a4722e9", "url": "https://github.com/hortonworks/cloudbreak/commit/d19d0066d771099d98678da8d0d062375a4722e9", "message": "CB-5494 There can not be active child environment in case of parent environment deletion", "committedDate": "2020-02-11T21:21:02Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc0MDkwMw==", "url": "https://github.com/hortonworks/cloudbreak/pull/7230#discussion_r378740903", "bodyText": "can we use name or crn here ?", "author": "doktoric", "createdAt": "2020-02-13T09:27:10Z", "path": "environment-api/src/main/java/com/sequenceiq/environment/api/v1/environment/model/request/EnvironmentRequest.java", "diffHunk": "@@ -79,6 +79,9 @@\n     @ApiModelProperty(EnvironmentModelDescription.AWS_PARAMETERS)\n     private AwsEnvironmentParameters aws;\n \n+    @ApiModelProperty(value = EnvironmentModelDescription.PARENT_ENVIRONMENT_CRN)\n+    private String parentEnvironmentCrn;", "originalCommit": "d19d0066d771099d98678da8d0d062375a4722e9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTQyNDg4Ng==", "url": "https://github.com/hortonworks/cloudbreak/pull/7230#discussion_r379424886", "bodyText": "Done in af20f70", "author": "pkedvessy", "createdAt": "2020-02-14T13:18:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc0MDkwMw=="}], "type": "inlineReview", "revised_code": {"commit": "cb1e6cdada50bb461fdcab9ffde35ef57f2fb8c6", "chunk": "diff --git a/environment-api/src/main/java/com/sequenceiq/environment/api/v1/environment/model/request/EnvironmentRequest.java b/environment-api/src/main/java/com/sequenceiq/environment/api/v1/environment/model/request/EnvironmentRequest.java\nindex 3b00c69ff5..229d413c21 100644\n--- a/environment-api/src/main/java/com/sequenceiq/environment/api/v1/environment/model/request/EnvironmentRequest.java\n+++ b/environment-api/src/main/java/com/sequenceiq/environment/api/v1/environment/model/request/EnvironmentRequest.java\n\n@@ -79,8 +79,8 @@ public class EnvironmentRequest extends EnvironmentBaseRequest implements Creden\n     @ApiModelProperty(EnvironmentModelDescription.AWS_PARAMETERS)\n     private AwsEnvironmentParameters aws;\n \n-    @ApiModelProperty(value = EnvironmentModelDescription.PARENT_ENVIRONMENT_CRN)\n-    private String parentEnvironmentCrn;\n+    @ApiModelProperty(value = EnvironmentModelDescription.PARENT_ENVIRONMENT_NAME)\n+    private String parentEnvironmentName;\n \n     public AttachedFreeIpaRequest getFreeIpa() {\n         return freeIpa;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc0MTEwOQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/7230#discussion_r378741109", "bodyText": "I think it should be great to show the name as well", "author": "doktoric", "createdAt": "2020-02-13T09:27:34Z", "path": "environment-api/src/main/java/com/sequenceiq/environment/api/v1/environment/model/response/DetailedEnvironmentResponse.java", "diffHunk": "@@ -70,6 +70,8 @@ public void setCredential(CredentialResponse credential) {\n \n         private AwsEnvironmentParameters aws;\n \n+        private String parentEnvironmentCrn;", "originalCommit": "d19d0066d771099d98678da8d0d062375a4722e9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTQyNDk4MA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7230#discussion_r379424980", "bodyText": "Done in af20f70", "author": "pkedvessy", "createdAt": "2020-02-14T13:18:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc0MTEwOQ=="}], "type": "inlineReview", "revised_code": {"commit": "cb1e6cdada50bb461fdcab9ffde35ef57f2fb8c6", "chunk": "diff --git a/environment-api/src/main/java/com/sequenceiq/environment/api/v1/environment/model/response/DetailedEnvironmentResponse.java b/environment-api/src/main/java/com/sequenceiq/environment/api/v1/environment/model/response/DetailedEnvironmentResponse.java\nindex e62e12d35d..e675d5f259 100644\n--- a/environment-api/src/main/java/com/sequenceiq/environment/api/v1/environment/model/response/DetailedEnvironmentResponse.java\n+++ b/environment-api/src/main/java/com/sequenceiq/environment/api/v1/environment/model/response/DetailedEnvironmentResponse.java\n\n@@ -72,6 +72,8 @@ public class DetailedEnvironmentResponse extends EnvironmentBaseResponse {\n \n         private String parentEnvironmentCrn;\n \n+        private String parentEnvironmentName;\n+\n         private Builder() {\n         }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc0MTg4OA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7230#discussion_r378741888", "bodyText": "I think it should be an application property", "author": "doktoric", "createdAt": "2020-02-13T09:28:57Z", "path": "environment/src/main/java/com/sequenceiq/environment/environment/flow/creation/handler/freeipa/FreeIpaCreationHandler.java", "diffHunk": "@@ -70,6 +74,8 @@\n \n     private static final List<String> DEFAULT_SECURITY_GROUP_PORTS = List.of(\"22\");\n \n+    private static final String YARN_NETWORK_CIDR = \"172.27.0.0/16\";", "originalCommit": "d19d0066d771099d98678da8d0d062375a4722e9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTQyNDE2NA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7230#discussion_r379424164", "bodyText": "Done in af20f70", "author": "pkedvessy", "createdAt": "2020-02-14T13:16:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc0MTg4OA=="}], "type": "inlineReview", "revised_code": {"commit": "cb1e6cdada50bb461fdcab9ffde35ef57f2fb8c6", "chunk": "diff --git a/environment/src/main/java/com/sequenceiq/environment/environment/flow/creation/handler/freeipa/FreeIpaCreationHandler.java b/environment/src/main/java/com/sequenceiq/environment/environment/flow/creation/handler/freeipa/FreeIpaCreationHandler.java\nindex 0f0679577f..61f84e6ff7 100644\n--- a/environment/src/main/java/com/sequenceiq/environment/environment/flow/creation/handler/freeipa/FreeIpaCreationHandler.java\n+++ b/environment/src/main/java/com/sequenceiq/environment/environment/flow/creation/handler/freeipa/FreeIpaCreationHandler.java\n\n@@ -74,8 +75,6 @@ public class FreeIpaCreationHandler extends EventSenderAwareHandler<EnvironmentD\n \n     private static final List<String> DEFAULT_SECURITY_GROUP_PORTS = List.of(\"22\");\n \n-    private static final String YARN_NETWORK_CIDR = \"172.27.0.0/16\";\n-\n     private final EnvironmentService environmentService;\n \n     private final FreeIpaService freeIpaService;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc0MjcyMQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/7230#discussion_r378742721", "bodyText": "should we use the mock as well ? If we dont have this option for mock I am afraid that we can easily break this feature.", "author": "doktoric", "createdAt": "2020-02-13T09:30:29Z", "path": "environment/src/main/java/com/sequenceiq/environment/environment/flow/creation/handler/freeipa/FreeIpaCreationHandler.java", "diffHunk": "@@ -143,13 +151,33 @@ private void createFreeIpa(Event<EnvironmentDto> environmentDtoEvent, Environmen\n                 dnsV1Endpoint.addDnsZoneForSubnetIds(addDnsZoneForSubnetIdsRequest);\n             }\n         } else {\n-            LOGGER.info(\"FreeIpa for environmentCrn '{}' already exists. Using this one.\", environment.getResourceCrn());\n+            LOGGER.info(\"FreeIpa for environmentCrn '{}' already exists. Using this one.\", environmentDto.getResourceCrn());\n             if (CREATE_IN_PROGRESS == freeIpa.get().getStatus()) {\n                 awaitFreeIpaCreation(environmentDtoEvent, environmentDto);\n             }\n         }\n     }\n \n+    private void attachParentFreeIpa(EnvironmentDto environmentDto) throws Exception {\n+        String parentEnvironmentCrn = environmentDto.getParentEnvironmentCrn();\n+        Optional<DescribeFreeIpaResponse> freeIpa = freeIpaService.describe(parentEnvironmentCrn);\n+        if (freeIpa.isPresent() && CloudPlatform.YARN.name().equalsIgnoreCase(environmentDto.getCloudPlatform())) {", "originalCommit": "d19d0066d771099d98678da8d0d062375a4722e9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTQyNDI5MA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7230#discussion_r379424290", "bodyText": "Done in af20f70", "author": "pkedvessy", "createdAt": "2020-02-14T13:17:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc0MjcyMQ=="}], "type": "inlineReview", "revised_code": {"commit": "cb1e6cdada50bb461fdcab9ffde35ef57f2fb8c6", "chunk": "diff --git a/environment/src/main/java/com/sequenceiq/environment/environment/flow/creation/handler/freeipa/FreeIpaCreationHandler.java b/environment/src/main/java/com/sequenceiq/environment/environment/flow/creation/handler/freeipa/FreeIpaCreationHandler.java\nindex 0f0679577f..61f84e6ff7 100644\n--- a/environment/src/main/java/com/sequenceiq/environment/environment/flow/creation/handler/freeipa/FreeIpaCreationHandler.java\n+++ b/environment/src/main/java/com/sequenceiq/environment/environment/flow/creation/handler/freeipa/FreeIpaCreationHandler.java\n\n@@ -159,22 +166,24 @@ public class FreeIpaCreationHandler extends EventSenderAwareHandler<EnvironmentD\n     }\n \n     private void attachParentFreeIpa(EnvironmentDto environmentDto) throws Exception {\n-        String parentEnvironmentCrn = environmentDto.getParentEnvironmentCrn();\n-        Optional<DescribeFreeIpaResponse> freeIpa = freeIpaService.describe(parentEnvironmentCrn);\n-        if (freeIpa.isPresent() && CloudPlatform.YARN.name().equalsIgnoreCase(environmentDto.getCloudPlatform())) {\n-            LOGGER.info(\"Using FreeIpa of parent environment '{}' .\", parentEnvironmentCrn);\n+        if (enabledChildPlatforms.stream().anyMatch(p -> p.equalsIgnoreCase(environmentDto.getCloudPlatform()))) {\n+            String parentEnvironmentCrn = environmentDto.getParentEnvironmentCrn();\n+            Optional<DescribeFreeIpaResponse> freeIpa = freeIpaService.describe(parentEnvironmentCrn);\n+            if (freeIpa.isPresent()) {\n+                LOGGER.info(\"Using FreeIpa of parent environment '{}' .\", parentEnvironmentCrn);\n \n-            RegisterChildEnvironmentRequest registerChildEnvironmentRequest = new RegisterChildEnvironmentRequest();\n-            registerChildEnvironmentRequest.setChildEnvironmentCrn(environmentDto.getResourceCrn());\n-            registerChildEnvironmentRequest.setParentEnvironmentCrn(parentEnvironmentCrn);\n+                AttachChildEnvironmentRequest attachChildEnvironmentRequest = new AttachChildEnvironmentRequest();\n+                attachChildEnvironmentRequest.setChildEnvironmentCrn(environmentDto.getResourceCrn());\n+                attachChildEnvironmentRequest.setParentEnvironmentCrn(parentEnvironmentCrn);\n \n-            freeIpaService.registerChildEnvironment(registerChildEnvironmentRequest);\n+                freeIpaService.attachChildEnvironment(attachChildEnvironmentRequest);\n \n-            AddDnsZoneForSubnetsRequest addDnsZoneForSubnetsRequest = new AddDnsZoneForSubnetsRequest();\n-            addDnsZoneForSubnetsRequest.setEnvironmentCrn(parentEnvironmentCrn);\n-            addDnsZoneForSubnetsRequest.setSubnets(Collections.singletonList(YARN_NETWORK_CIDR));\n+                AddDnsZoneForSubnetsRequest addDnsZoneForSubnetsRequest = new AddDnsZoneForSubnetsRequest();\n+                addDnsZoneForSubnetsRequest.setEnvironmentCrn(parentEnvironmentCrn);\n+                addDnsZoneForSubnetsRequest.setSubnets(Collections.singletonList(yarnNetowrkCidr));\n \n-            dnsV1Endpoint.addDnsZoneForSubnets(addDnsZoneForSubnetsRequest);\n+                dnsV1Endpoint.addDnsZoneForSubnets(addDnsZoneForSubnetsRequest);\n+            }\n         }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc0MzM3Mg==", "url": "https://github.com/hortonworks/cloudbreak/pull/7230#discussion_r378743372", "bodyText": "I think the name is more useful here", "author": "doktoric", "createdAt": "2020-02-13T09:31:36Z", "path": "environment/src/main/java/com/sequenceiq/environment/environment/validation/EnvironmentValidatorService.java", "diffHunk": "@@ -73,6 +75,25 @@ public ValidationResultBuilder validateNetworkCreation(Environment environment,\n         return networkCreationValidator.validateNetworkCreation(environment, network, subnetMetas);\n     }\n \n+    public ValidationResult validateParentChildRelation(Environment environment, String parentEnvironmentCrn) {\n+        ValidationResultBuilder resultBuilder = new ValidationResultBuilder();\n+\n+        resultBuilder.ifError(() -> Objects.nonNull(parentEnvironmentCrn) && Objects.isNull(environment.getParentEnvironment()),\n+                String.format(\"Active parent environment with crn '%s' is not available in account '%s'.\", parentEnvironmentCrn, environment.getAccountId()));", "originalCommit": "d19d0066d771099d98678da8d0d062375a4722e9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTQyNDM5Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/7230#discussion_r379424397", "bodyText": "Done in af20f70", "author": "pkedvessy", "createdAt": "2020-02-14T13:17:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc0MzM3Mg=="}], "type": "inlineReview", "revised_code": {"commit": "cb1e6cdada50bb461fdcab9ffde35ef57f2fb8c6", "chunk": "diff --git a/environment/src/main/java/com/sequenceiq/environment/environment/validation/EnvironmentValidatorService.java b/environment/src/main/java/com/sequenceiq/environment/environment/validation/EnvironmentValidatorService.java\nindex 042530e4de..aa3d27574c 100644\n--- a/environment/src/main/java/com/sequenceiq/environment/environment/validation/EnvironmentValidatorService.java\n+++ b/environment/src/main/java/com/sequenceiq/environment/environment/validation/EnvironmentValidatorService.java\n\n@@ -75,19 +84,19 @@ public class EnvironmentValidatorService {\n         return networkCreationValidator.validateNetworkCreation(environment, network, subnetMetas);\n     }\n \n-    public ValidationResult validateParentChildRelation(Environment environment, String parentEnvironmentCrn) {\n+    public ValidationResult validateParentChildRelation(Environment environment, String parentEnvironmentName) {\n         ValidationResultBuilder resultBuilder = new ValidationResultBuilder();\n \n-        resultBuilder.ifError(() -> Objects.nonNull(parentEnvironmentCrn) && Objects.isNull(environment.getParentEnvironment()),\n-                String.format(\"Active parent environment with crn '%s' is not available in account '%s'.\", parentEnvironmentCrn, environment.getAccountId()));\n+        resultBuilder.ifError(() -> Objects.nonNull(parentEnvironmentName) && Objects.isNull(environment.getParentEnvironment()),\n+                String.format(\"Active parent environment with name '%s' is not available in account '%s'.\", parentEnvironmentName, environment.getAccountId()));\n         if (Objects.nonNull(environment.getParentEnvironment())) {\n             resultBuilder.ifError(() -> environment.getParentEnvironment().getStatus() != EnvironmentStatus.AVAILABLE,\n                     \"Parent environment should be in 'AVAILABLE' status.\");\n             resultBuilder.ifError(() -> Objects.nonNull(environment.getParentEnvironment().getParentEnvironment()),\n                     \"Parent environment is already a child environment.\");\n-            resultBuilder.ifError(() -> !CloudPlatform.YARN.name().equalsIgnoreCase(environment.getCloudPlatform()),\n-                    String.format(\"Parent environment is not supported for '%s' platform.\", environment.getCloudPlatform()));\n-            resultBuilder.ifError(() -> !CloudPlatform.AWS.name().equalsIgnoreCase(environment.getParentEnvironment().getCloudPlatform()),\n+            resultBuilder.ifError(() -> !platformEnabled(enabledChildPlatforms, environment.getCloudPlatform()),\n+                    String.format(\"'%s' platform is not supported for child environment.\", environment.getCloudPlatform()));\n+            resultBuilder.ifError(() -> !platformEnabled(enabledParentPlatforms, environment.getParentEnvironment().getCloudPlatform()),\n                     String.format(\"'%s' platform is not supported for parent environment.\", environment.getParentEnvironment().getCloudPlatform()));\n         }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc0MzczNw==", "url": "https://github.com/hortonworks/cloudbreak/pull/7230#discussion_r378743737", "bodyText": "can we expose the supported platforms to an application property ?", "author": "doktoric", "createdAt": "2020-02-13T09:32:13Z", "path": "environment/src/main/java/com/sequenceiq/environment/environment/validation/EnvironmentValidatorService.java", "diffHunk": "@@ -73,6 +75,25 @@ public ValidationResultBuilder validateNetworkCreation(Environment environment,\n         return networkCreationValidator.validateNetworkCreation(environment, network, subnetMetas);\n     }\n \n+    public ValidationResult validateParentChildRelation(Environment environment, String parentEnvironmentCrn) {\n+        ValidationResultBuilder resultBuilder = new ValidationResultBuilder();\n+\n+        resultBuilder.ifError(() -> Objects.nonNull(parentEnvironmentCrn) && Objects.isNull(environment.getParentEnvironment()),\n+                String.format(\"Active parent environment with crn '%s' is not available in account '%s'.\", parentEnvironmentCrn, environment.getAccountId()));\n+        if (Objects.nonNull(environment.getParentEnvironment())) {\n+            resultBuilder.ifError(() -> environment.getParentEnvironment().getStatus() != EnvironmentStatus.AVAILABLE,\n+                    \"Parent environment should be in 'AVAILABLE' status.\");\n+            resultBuilder.ifError(() -> Objects.nonNull(environment.getParentEnvironment().getParentEnvironment()),\n+                    \"Parent environment is already a child environment.\");\n+            resultBuilder.ifError(() -> !CloudPlatform.YARN.name().equalsIgnoreCase(environment.getCloudPlatform()),", "originalCommit": "d19d0066d771099d98678da8d0d062375a4722e9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTQyNDUwNA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7230#discussion_r379424504", "bodyText": "Done in af20f70", "author": "pkedvessy", "createdAt": "2020-02-14T13:17:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc0MzczNw=="}], "type": "inlineReview", "revised_code": {"commit": "cb1e6cdada50bb461fdcab9ffde35ef57f2fb8c6", "chunk": "diff --git a/environment/src/main/java/com/sequenceiq/environment/environment/validation/EnvironmentValidatorService.java b/environment/src/main/java/com/sequenceiq/environment/environment/validation/EnvironmentValidatorService.java\nindex 042530e4de..aa3d27574c 100644\n--- a/environment/src/main/java/com/sequenceiq/environment/environment/validation/EnvironmentValidatorService.java\n+++ b/environment/src/main/java/com/sequenceiq/environment/environment/validation/EnvironmentValidatorService.java\n\n@@ -75,19 +84,19 @@ public class EnvironmentValidatorService {\n         return networkCreationValidator.validateNetworkCreation(environment, network, subnetMetas);\n     }\n \n-    public ValidationResult validateParentChildRelation(Environment environment, String parentEnvironmentCrn) {\n+    public ValidationResult validateParentChildRelation(Environment environment, String parentEnvironmentName) {\n         ValidationResultBuilder resultBuilder = new ValidationResultBuilder();\n \n-        resultBuilder.ifError(() -> Objects.nonNull(parentEnvironmentCrn) && Objects.isNull(environment.getParentEnvironment()),\n-                String.format(\"Active parent environment with crn '%s' is not available in account '%s'.\", parentEnvironmentCrn, environment.getAccountId()));\n+        resultBuilder.ifError(() -> Objects.nonNull(parentEnvironmentName) && Objects.isNull(environment.getParentEnvironment()),\n+                String.format(\"Active parent environment with name '%s' is not available in account '%s'.\", parentEnvironmentName, environment.getAccountId()));\n         if (Objects.nonNull(environment.getParentEnvironment())) {\n             resultBuilder.ifError(() -> environment.getParentEnvironment().getStatus() != EnvironmentStatus.AVAILABLE,\n                     \"Parent environment should be in 'AVAILABLE' status.\");\n             resultBuilder.ifError(() -> Objects.nonNull(environment.getParentEnvironment().getParentEnvironment()),\n                     \"Parent environment is already a child environment.\");\n-            resultBuilder.ifError(() -> !CloudPlatform.YARN.name().equalsIgnoreCase(environment.getCloudPlatform()),\n-                    String.format(\"Parent environment is not supported for '%s' platform.\", environment.getCloudPlatform()));\n-            resultBuilder.ifError(() -> !CloudPlatform.AWS.name().equalsIgnoreCase(environment.getParentEnvironment().getCloudPlatform()),\n+            resultBuilder.ifError(() -> !platformEnabled(enabledChildPlatforms, environment.getCloudPlatform()),\n+                    String.format(\"'%s' platform is not supported for child environment.\", environment.getCloudPlatform()));\n+            resultBuilder.ifError(() -> !platformEnabled(enabledParentPlatforms, environment.getParentEnvironment().getCloudPlatform()),\n                     String.format(\"'%s' platform is not supported for parent environment.\", environment.getParentEnvironment().getCloudPlatform()));\n         }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc0NDIxOA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7230#discussion_r378744218", "bodyText": "attach ?", "author": "doktoric", "createdAt": "2020-02-13T09:33:08Z", "path": "freeipa-api/src/main/java/com/sequenceiq/freeipa/api/v1/freeipa/stack/FreeIpaV1Endpoint.java", "diffHunk": "@@ -39,6 +41,20 @@\n             nickname = \"createFreeIpaV1\")\n     DescribeFreeIpaResponse create(@Valid CreateFreeIpaRequest request);\n \n+    @POST\n+    @Path(\"/register_child_environment\")", "originalCommit": "d19d0066d771099d98678da8d0d062375a4722e9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTM4Mzk0MQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/7230#discussion_r379383941", "bodyText": "Renamed", "author": "Bajzathd", "createdAt": "2020-02-14T11:31:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc0NDIxOA=="}], "type": "inlineReview", "revised_code": {"commit": "cb1e6cdada50bb461fdcab9ffde35ef57f2fb8c6", "chunk": "diff --git a/freeipa-api/src/main/java/com/sequenceiq/freeipa/api/v1/freeipa/stack/FreeIpaV1Endpoint.java b/freeipa-api/src/main/java/com/sequenceiq/freeipa/api/v1/freeipa/stack/FreeIpaV1Endpoint.java\nindex a672217f7c..1a4f0cc369 100644\n--- a/freeipa-api/src/main/java/com/sequenceiq/freeipa/api/v1/freeipa/stack/FreeIpaV1Endpoint.java\n+++ b/freeipa-api/src/main/java/com/sequenceiq/freeipa/api/v1/freeipa/stack/FreeIpaV1Endpoint.java\n\n@@ -42,18 +42,18 @@ public interface FreeIpaV1Endpoint {\n     DescribeFreeIpaResponse create(@Valid CreateFreeIpaRequest request);\n \n     @POST\n-    @Path(\"/register_child_environment\")\n+    @Path(\"/attach_child_environment\")\n     @Produces(MediaType.APPLICATION_JSON)\n     @ApiOperation(value = FreeIpaOperationDescriptions.REGISTER_CHILD_ENVIRONMENT, produces = MediaType.APPLICATION_JSON, notes = FreeIpaNotes.FREEIPA_NOTES,\n-            nickname = \"registerChildEnvironmentV1\")\n-    void registerChildEnvironment(@Valid RegisterChildEnvironmentRequest request);\n+            nickname = \"attachChildEnvironmentV1\")\n+    void attachChildEnvironment(@Valid AttachChildEnvironmentRequest request);\n \n     @POST\n-    @Path(\"/deregister_child_environment\")\n+    @Path(\"/detach_child_environment\")\n     @Produces(MediaType.APPLICATION_JSON)\n     @ApiOperation(value = FreeIpaOperationDescriptions.DEREGISTER_CHILD_ENVIRONMENT, produces = MediaType.APPLICATION_JSON, notes = FreeIpaNotes.FREEIPA_NOTES,\n-            nickname = \"deregisterChildEnvironmentV1\")\n-    void deregisterChildEnvironment(@Valid DeregisterChildEnvironmentRequest request);\n+            nickname = \"detachChildEnvironmentV1\")\n+    void detachChildEnvironment(@Valid DetachChildEnvironmentRequest request);\n \n     @GET\n     @Path(\"\")\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc0NDI2MA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7230#discussion_r378744260", "bodyText": "detach ?", "author": "doktoric", "createdAt": "2020-02-13T09:33:13Z", "path": "freeipa-api/src/main/java/com/sequenceiq/freeipa/api/v1/freeipa/stack/FreeIpaV1Endpoint.java", "diffHunk": "@@ -39,6 +41,20 @@\n             nickname = \"createFreeIpaV1\")\n     DescribeFreeIpaResponse create(@Valid CreateFreeIpaRequest request);\n \n+    @POST\n+    @Path(\"/register_child_environment\")\n+    @Produces(MediaType.APPLICATION_JSON)\n+    @ApiOperation(value = FreeIpaOperationDescriptions.REGISTER_CHILD_ENVIRONMENT, produces = MediaType.APPLICATION_JSON, notes = FreeIpaNotes.FREEIPA_NOTES,\n+            nickname = \"registerChildEnvironmentV1\")\n+    void registerChildEnvironment(@Valid RegisterChildEnvironmentRequest request);\n+\n+    @POST\n+    @Path(\"/deregister_child_environment\")", "originalCommit": "d19d0066d771099d98678da8d0d062375a4722e9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTM4Mzk3Mg==", "url": "https://github.com/hortonworks/cloudbreak/pull/7230#discussion_r379383972", "bodyText": "Renamed", "author": "Bajzathd", "createdAt": "2020-02-14T11:31:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc0NDI2MA=="}], "type": "inlineReview", "revised_code": {"commit": "cb1e6cdada50bb461fdcab9ffde35ef57f2fb8c6", "chunk": "diff --git a/freeipa-api/src/main/java/com/sequenceiq/freeipa/api/v1/freeipa/stack/FreeIpaV1Endpoint.java b/freeipa-api/src/main/java/com/sequenceiq/freeipa/api/v1/freeipa/stack/FreeIpaV1Endpoint.java\nindex a672217f7c..1a4f0cc369 100644\n--- a/freeipa-api/src/main/java/com/sequenceiq/freeipa/api/v1/freeipa/stack/FreeIpaV1Endpoint.java\n+++ b/freeipa-api/src/main/java/com/sequenceiq/freeipa/api/v1/freeipa/stack/FreeIpaV1Endpoint.java\n\n@@ -42,18 +42,18 @@ public interface FreeIpaV1Endpoint {\n     DescribeFreeIpaResponse create(@Valid CreateFreeIpaRequest request);\n \n     @POST\n-    @Path(\"/register_child_environment\")\n+    @Path(\"/attach_child_environment\")\n     @Produces(MediaType.APPLICATION_JSON)\n     @ApiOperation(value = FreeIpaOperationDescriptions.REGISTER_CHILD_ENVIRONMENT, produces = MediaType.APPLICATION_JSON, notes = FreeIpaNotes.FREEIPA_NOTES,\n-            nickname = \"registerChildEnvironmentV1\")\n-    void registerChildEnvironment(@Valid RegisterChildEnvironmentRequest request);\n+            nickname = \"attachChildEnvironmentV1\")\n+    void attachChildEnvironment(@Valid AttachChildEnvironmentRequest request);\n \n     @POST\n-    @Path(\"/deregister_child_environment\")\n+    @Path(\"/detach_child_environment\")\n     @Produces(MediaType.APPLICATION_JSON)\n     @ApiOperation(value = FreeIpaOperationDescriptions.DEREGISTER_CHILD_ENVIRONMENT, produces = MediaType.APPLICATION_JSON, notes = FreeIpaNotes.FREEIPA_NOTES,\n-            nickname = \"deregisterChildEnvironmentV1\")\n-    void deregisterChildEnvironment(@Valid DeregisterChildEnvironmentRequest request);\n+            nickname = \"detachChildEnvironmentV1\")\n+    void detachChildEnvironment(@Valid DetachChildEnvironmentRequest request);\n \n     @GET\n     @Path(\"\")\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc0NDQ2MA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7230#discussion_r378744460", "bodyText": "childEnvironmentNames ?", "author": "doktoric", "createdAt": "2020-02-13T09:33:35Z", "path": "freeipa-api/src/main/java/com/sequenceiq/freeipa/api/v1/freeipa/stack/model/describe/DescribeFreeIpaResponse.java", "diffHunk": "@@ -30,6 +30,9 @@\n     @ApiModelProperty(value = ModelDescriptions.ENVIRONMENT_CRN, required = true)\n     private String environmentCrn;\n \n+    @ApiModelProperty(ModelDescriptions.CHILD_ENVIRONMENT_CRN_LIST)\n+    private List<String> childEnvironmentCrns;", "originalCommit": "d19d0066d771099d98678da8d0d062375a4722e9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc3OTQ0Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/7230#discussion_r378779447", "bodyText": "everything is crn driven, I would stick with it", "author": "lacikaaa", "createdAt": "2020-02-13T10:39:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc0NDQ2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODg4MjU4MQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/7230#discussion_r378882581", "bodyText": "ok then", "author": "doktoric", "createdAt": "2020-02-13T14:10:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc0NDQ2MA=="}], "type": "inlineReview", "revised_code": {"commit": "448230ac70847b668aa93b3c6c105ae0461d7d96", "chunk": "diff --git a/freeipa-api/src/main/java/com/sequenceiq/freeipa/api/v1/freeipa/stack/model/describe/DescribeFreeIpaResponse.java b/freeipa-api/src/main/java/com/sequenceiq/freeipa/api/v1/freeipa/stack/model/describe/DescribeFreeIpaResponse.java\nindex 619e3360db..69c971989c 100644\n--- a/freeipa-api/src/main/java/com/sequenceiq/freeipa/api/v1/freeipa/stack/model/describe/DescribeFreeIpaResponse.java\n+++ b/freeipa-api/src/main/java/com/sequenceiq/freeipa/api/v1/freeipa/stack/model/describe/DescribeFreeIpaResponse.java\n\n@@ -30,9 +30,6 @@ public class DescribeFreeIpaResponse {\n     @ApiModelProperty(value = ModelDescriptions.ENVIRONMENT_CRN, required = true)\n     private String environmentCrn;\n \n-    @ApiModelProperty(ModelDescriptions.CHILD_ENVIRONMENT_CRN_LIST)\n-    private List<String> childEnvironmentCrns;\n-\n     @NotNull\n     @ApiModelProperty(value = FreeIpaModelDescriptions.FREEIPA_NAME, required = true)\n     private String name;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc0NTM2NA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7230#discussion_r378745364", "bodyText": "can we check for the status? I am afraid if somebody change the terminated = -1 we will be broken", "author": "doktoric", "createdAt": "2020-02-13T09:35:13Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/repository/StackRepository.java", "diffHunk": "@@ -67,6 +67,11 @@\n             + \"LEFT JOIN FETCH ig.instanceMetaData WHERE s.environmentCrn = :environmentCrn AND s.accountId = :accountId AND s.terminated = -1\")\n     Optional<Stack> findByEnvironmentCrnAndAccountIdWithList(@Param(\"environmentCrn\") String environmentCrn, @Param(\"accountId\") String accountId);\n \n+    @CheckPermission(action = ResourceAction.READ)\n+    @Query(\"SELECT s FROM Stack s LEFT JOIN FETCH s.childEnvironments c LEFT JOIN FETCH s.instanceGroups ig \"\n+            + \"LEFT JOIN FETCH ig.instanceMetaData WHERE c.environmentCrn = :environmentCrn AND s.accountId = :accountId AND s.terminated = -1\")", "originalCommit": "d19d0066d771099d98678da8d0d062375a4722e9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc3NDUxNA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7230#discussion_r378774514", "bodyText": "we work only with non-terminated stacks, which is indicated by this everywhere. I won't join another table for this reason, if not really necessary", "author": "lacikaaa", "createdAt": "2020-02-13T10:29:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc0NTM2NA=="}], "type": "inlineReview", "revised_code": {"commit": "baf9392cbd93e7e4913b47e44352ec97e058b905", "chunk": "diff --git a/freeipa/src/main/java/com/sequenceiq/freeipa/repository/StackRepository.java b/freeipa/src/main/java/com/sequenceiq/freeipa/repository/StackRepository.java\nindex 4b1062ee3b..71bb868ca0 100644\n--- a/freeipa/src/main/java/com/sequenceiq/freeipa/repository/StackRepository.java\n+++ b/freeipa/src/main/java/com/sequenceiq/freeipa/repository/StackRepository.java\n\n@@ -63,7 +63,7 @@ public interface StackRepository extends BaseJpaRepository<Stack, Long> {\n     List<Long> findAllIdByEnvironmentCrnAndAccountId(@Param(\"environmentCrn\") String environmentCrn, @Param(\"accountId\") String accountId);\n \n     @CheckPermission(action = ResourceAction.READ)\n-    @Query(\"SELECT s FROM Stack s LEFT JOIN FETCH s.instanceGroups ig \"\n+    @Query(\"SELECT s FROM Stack s LEFT JOIN FETCH s.childEnvironments c LEFT JOIN FETCH s.instanceGroups ig \"\n             + \"LEFT JOIN FETCH ig.instanceMetaData WHERE s.environmentCrn = :environmentCrn AND s.accountId = :accountId AND s.terminated = -1\")\n     Optional<Stack> findByEnvironmentCrnAndAccountIdWithList(@Param(\"environmentCrn\") String environmentCrn, @Param(\"accountId\") String accountId);\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc1ODAwMA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7230#discussion_r378758000", "bodyText": "do we really need it eagerly? this would mean an extra join every time we fetch the stack", "author": "lacikaaa", "createdAt": "2020-02-13T09:58:43Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/entity/Stack.java", "diffHunk": "@@ -48,6 +50,9 @@\n \n     private String environmentCrn;\n \n+    @OneToMany(mappedBy = \"stack\", fetch = FetchType.EAGER, cascade = CascadeType.ALL, orphanRemoval = true)\n+    private List<ChildEnvironment> childEnvironments = new ArrayList<>();", "originalCommit": "d19d0066d771099d98678da8d0d062375a4722e9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTQyMDYzNg==", "url": "https://github.com/hortonworks/cloudbreak/pull/7230#discussion_r379420636", "bodyText": "Seems like we do not really need it, I have a PR for this alone\n#7288", "author": "Bajzathd", "createdAt": "2020-02-14T13:07:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc1ODAwMA=="}], "type": "inlineReview", "revised_code": {"commit": "baf9392cbd93e7e4913b47e44352ec97e058b905", "chunk": "diff --git a/freeipa/src/main/java/com/sequenceiq/freeipa/entity/Stack.java b/freeipa/src/main/java/com/sequenceiq/freeipa/entity/Stack.java\nindex 56c667a0f1..d35242bf24 100644\n--- a/freeipa/src/main/java/com/sequenceiq/freeipa/entity/Stack.java\n+++ b/freeipa/src/main/java/com/sequenceiq/freeipa/entity/Stack.java\n\n@@ -50,7 +49,7 @@ public class Stack {\n \n     private String environmentCrn;\n \n-    @OneToMany(mappedBy = \"stack\", fetch = FetchType.EAGER, cascade = CascadeType.ALL, orphanRemoval = true)\n+    @OneToMany(mappedBy = \"stack\", cascade = CascadeType.ALL, orphanRemoval = true)\n     private List<ChildEnvironment> childEnvironments = new ArrayList<>();\n \n     private String accountId;\n"}}, {"oid": "16e14673b95d41497329f021f2e583c16910bacb", "url": "https://github.com/hortonworks/cloudbreak/commit/16e14673b95d41497329f021f2e583c16910bacb", "message": "CB-5494 There can not be active child environment in case of parent environment deletion", "committedDate": "2020-02-13T10:03:27Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc2ODM5MA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7230#discussion_r378768390", "bodyText": "could you refactor into smaller methods?", "author": "lacikaaa", "createdAt": "2020-02-13T10:18:10Z", "path": "environment/src/main/java/com/sequenceiq/environment/environment/flow/deletion/handler/freeipa/FreeIpaDeletionHandler.java", "diffHunk": "@@ -52,24 +54,29 @@ protected FreeIpaDeletionHandler(EventSender eventSender, EnvironmentService env\n     @Override\n     public void accept(Event<EnvironmentDto> environmentDtoEvent) {\n         EnvironmentDto environmentDto = environmentDtoEvent.getData();\n-        Optional<Environment> env = environmentService.findEnvironmentById(environmentDto.getId());\n+        Optional<Environment> envOptional = environmentService.findEnvironmentById(environmentDto.getId());\n         try {\n-            if (env.isPresent() && env.get().isCreateFreeIpa() && freeIpaExistsForEnvironment(env.get())) {\n-                freeIpaService.delete(env.get().getResourceCrn());\n-                Pair<PollingResult, Exception> result = freeIpaPollingService.pollWithTimeout(\n-                        new FreeIpaDeletionRetrievalTask(freeIpaService),\n-                        new FreeIpaPollerObject(env.get().getId(), env.get().getResourceCrn()),\n-                        FreeIpaDeletionRetrievalTask.FREEIPA_RETRYING_INTERVAL,\n-                        FreeIpaDeletionRetrievalTask.FREEIPA_RETRYING_COUNT,\n-                        SINGLE_FAILURE);\n-                if (isSuccess(result.getLeft())) {\n-                    eventSender().sendEvent(getNextStepObject(environmentDto), environmentDtoEvent.getHeaders());\n+            if (envOptional.isPresent() && envOptional.get().isCreateFreeIpa() && freeIpaExistsForEnvironment(envOptional.get())) {\n+                Environment environment = envOptional.get();\n+                if (isNull(environment.getParentEnvironment())) {\n+                    freeIpaService.delete(environment.getResourceCrn());\n+                    Pair<PollingResult, Exception> result = freeIpaPollingService.pollWithTimeout(\n+                            new FreeIpaDeletionRetrievalTask(freeIpaService),\n+                            new FreeIpaPollerObject(environment.getId(), environment.getResourceCrn()),\n+                            FreeIpaDeletionRetrievalTask.FREEIPA_RETRYING_INTERVAL,\n+                            FreeIpaDeletionRetrievalTask.FREEIPA_RETRYING_COUNT,\n+                            SINGLE_FAILURE);\n+                    if (!isSuccess(result.getLeft())) {\n+                        throw new FreeIpaOperationFailedException(\"Failed to delete FreeIpa! \" + getIfNotNull(result.getRight(), Throwable::getMessage));\n+                    }\n                 } else {\n-                    throw new FreeIpaOperationFailedException(\"Failed to delete FreeIpa! \" + getIfNotNull(result.getRight(), Throwable::getMessage));\n+                    DeregisterChildEnvironmentRequest deregisterChildEnvironmentRequest = new DeregisterChildEnvironmentRequest();\n+                    deregisterChildEnvironmentRequest.setParentEnvironmentCrn(environment.getParentEnvironment().getResourceCrn());\n+                    deregisterChildEnvironmentRequest.setChildEnvironmentCrn(environment.getResourceCrn());\n+                    freeIpaService.deregisterChildEnvironment(deregisterChildEnvironmentRequest);", "originalCommit": "16e14673b95d41497329f021f2e583c16910bacb", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "cb1e6cdada50bb461fdcab9ffde35ef57f2fb8c6", "chunk": "diff --git a/environment/src/main/java/com/sequenceiq/environment/environment/flow/deletion/handler/freeipa/FreeIpaDeletionHandler.java b/environment/src/main/java/com/sequenceiq/environment/environment/flow/deletion/handler/freeipa/FreeIpaDeletionHandler.java\nindex 89a4750db9..64ff9db11a 100644\n--- a/environment/src/main/java/com/sequenceiq/environment/environment/flow/deletion/handler/freeipa/FreeIpaDeletionHandler.java\n+++ b/environment/src/main/java/com/sequenceiq/environment/environment/flow/deletion/handler/freeipa/FreeIpaDeletionHandler.java\n\n@@ -70,10 +70,10 @@ public class FreeIpaDeletionHandler extends EventSenderAwareHandler<EnvironmentD\n                         throw new FreeIpaOperationFailedException(\"Failed to delete FreeIpa! \" + getIfNotNull(result.getRight(), Throwable::getMessage));\n                     }\n                 } else {\n-                    DeregisterChildEnvironmentRequest deregisterChildEnvironmentRequest = new DeregisterChildEnvironmentRequest();\n-                    deregisterChildEnvironmentRequest.setParentEnvironmentCrn(environment.getParentEnvironment().getResourceCrn());\n-                    deregisterChildEnvironmentRequest.setChildEnvironmentCrn(environment.getResourceCrn());\n-                    freeIpaService.deregisterChildEnvironment(deregisterChildEnvironmentRequest);\n+                    DetachChildEnvironmentRequest detachChildEnvironmentRequest = new DetachChildEnvironmentRequest();\n+                    detachChildEnvironmentRequest.setParentEnvironmentCrn(environment.getParentEnvironment().getResourceCrn());\n+                    detachChildEnvironmentRequest.setChildEnvironmentCrn(environment.getResourceCrn());\n+                    freeIpaService.detachChildEnvironment(detachChildEnvironmentRequest);\n                 }\n             }\n             eventSender().sendEvent(getNextStepObject(environmentDto), environmentDtoEvent.getHeaders());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc3ODU4Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/7230#discussion_r378778587", "bodyText": "not FreeIPA request, it's RegisterChildEnvironmentRequest", "author": "lacikaaa", "createdAt": "2020-02-13T10:37:41Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/controller/FreeIpaV1Controller.java", "diffHunk": "@@ -86,6 +96,23 @@ public DescribeFreeIpaResponse create(@Valid CreateFreeIpaRequest request) {\n         return freeIpaCreationService.launchFreeIpa(request, accountId);\n     }\n \n+    @Override\n+    public void registerChildEnvironment(@Valid RegisterChildEnvironmentRequest request) {\n+        ValidationResult validationResult = registerChildEnvironmentRequestValidator.validate(request);\n+        if (validationResult.hasError()) {\n+            LOGGER.debug(\"FreeIPA request has validation error(s): {}.\", validationResult.getFormattedErrors());", "originalCommit": "16e14673b95d41497329f021f2e583c16910bacb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTM4NDI2MA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7230#discussion_r379384260", "bodyText": "Fixed", "author": "Bajzathd", "createdAt": "2020-02-14T11:32:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc3ODU4Nw=="}], "type": "inlineReview", "revised_code": {"commit": "cb1e6cdada50bb461fdcab9ffde35ef57f2fb8c6", "chunk": "diff --git a/freeipa/src/main/java/com/sequenceiq/freeipa/controller/FreeIpaV1Controller.java b/freeipa/src/main/java/com/sequenceiq/freeipa/controller/FreeIpaV1Controller.java\nindex 4334d1eb43..4241459dd5 100644\n--- a/freeipa/src/main/java/com/sequenceiq/freeipa/controller/FreeIpaV1Controller.java\n+++ b/freeipa/src/main/java/com/sequenceiq/freeipa/controller/FreeIpaV1Controller.java\n\n@@ -97,20 +97,20 @@ public class FreeIpaV1Controller implements FreeIpaV1Endpoint {\n     }\n \n     @Override\n-    public void registerChildEnvironment(@Valid RegisterChildEnvironmentRequest request) {\n-        ValidationResult validationResult = registerChildEnvironmentRequestValidator.validate(request);\n+    public void attachChildEnvironment(@Valid AttachChildEnvironmentRequest request) {\n+        ValidationResult validationResult = attachChildEnvironmentRequestValidator.validate(request);\n         if (validationResult.hasError()) {\n-            LOGGER.debug(\"FreeIPA request has validation error(s): {}.\", validationResult.getFormattedErrors());\n+            LOGGER.debug(\"AttachChildEnvironmentRequest has validation error(s): {}.\", validationResult.getFormattedErrors());\n             throw new BadRequestException(validationResult.getFormattedErrors());\n         }\n         String accountId = crnService.getCurrentAccountId();\n-        childEnvironmentService.registerChildEnvironment(request, accountId);\n+        childEnvironmentService.attachChildEnvironment(request, accountId);\n     }\n \n     @Override\n-    public void deregisterChildEnvironment(@Valid DeregisterChildEnvironmentRequest request) {\n+    public void detachChildEnvironment(@Valid DetachChildEnvironmentRequest request) {\n         String accountId = crnService.getCurrentAccountId();\n-        childEnvironmentService.deregisterChildEnvironment(request, accountId);\n+        childEnvironmentService.detachChildEnvironment(request, accountId);\n     }\n \n     @Override\n"}}, {"oid": "cb1e6cdada50bb461fdcab9ffde35ef57f2fb8c6", "url": "https://github.com/hortonworks/cloudbreak/commit/cb1e6cdada50bb461fdcab9ffde35ef57f2fb8c6", "message": "CB-5031 update hostname on Ycloud based on CB-1367 to avoid DNS healt check failures in CM", "committedDate": "2020-02-17T10:33:20Z", "type": "forcePushed"}, {"oid": "c80bfcd71389644b55cd0a71e7ace3412b7ee8b9", "url": "https://github.com/hortonworks/cloudbreak/commit/c80bfcd71389644b55cd0a71e7ace3412b7ee8b9", "message": "CB-5031 update hostname on Ycloud based on CB-1367 to avoid DNS healt check failures in CM", "committedDate": "2020-02-17T15:08:03Z", "type": "forcePushed"}, {"oid": "bafc3b7c5c997922560ed9d20c1984f24095de4c", "url": "https://github.com/hortonworks/cloudbreak/commit/bafc3b7c5c997922560ed9d20c1984f24095de4c", "message": "CB-5122 Validate delete freeipa request", "committedDate": "2020-02-18T13:21:15Z", "type": "forcePushed"}, {"oid": "f875719b8db02bb3c87e0db5c07ac5150d4d6b56", "url": "https://github.com/hortonworks/cloudbreak/commit/f875719b8db02bb3c87e0db5c07ac5150d4d6b56", "message": "CB-5122 Draft of child environment relation in freeipa service", "committedDate": "2020-02-21T09:06:29Z", "type": "commit"}, {"oid": "0d22b71f0e56f07adcfd2e2065b401c4a0f57cf8", "url": "https://github.com/hortonworks/cloudbreak/commit/0d22b71f0e56f07adcfd2e2065b401c4a0f57cf8", "message": "CB-5121 Hybrid environment creation", "committedDate": "2020-02-21T09:06:29Z", "type": "commit"}, {"oid": "23240a55f91e7ef5733465175764a6da0b94d60b", "url": "https://github.com/hortonworks/cloudbreak/commit/23240a55f91e7ef5733465175764a6da0b94d60b", "message": "CB-5162 CB managed FreeIPA support for Ycloud with feature switch", "committedDate": "2020-02-21T09:06:29Z", "type": "commit"}, {"oid": "24c5bfe3658dbe7baee9441b027f604e8fb94ae1", "url": "https://github.com/hortonworks/cloudbreak/commit/24c5bfe3658dbe7baee9441b027f604e8fb94ae1", "message": "CB-5122 Add parentEnvironmentCrn to SimpleEnvironmentResponse", "committedDate": "2020-02-21T09:06:29Z", "type": "commit"}, {"oid": "fc90b5092b7311b61104d23bfde4619482d45a46", "url": "https://github.com/hortonworks/cloudbreak/commit/fc90b5092b7311b61104d23bfde4619482d45a46", "message": "CB-5395 Deregister child relation in case of deleting an environment with parent environment", "committedDate": "2020-02-21T09:06:30Z", "type": "commit"}, {"oid": "6b60d2f38ab9797086336448705a5251a352a902", "url": "https://github.com/hortonworks/cloudbreak/commit/6b60d2f38ab9797086336448705a5251a352a902", "message": "CB-5162 fix FreeIPA and core orchestration for child environment related calls, reenable systemctl hack for YARN", "committedDate": "2020-02-21T09:06:30Z", "type": "commit"}, {"oid": "080bbf528687956ac5ec917bfb55a10edd343c81", "url": "https://github.com/hortonworks/cloudbreak/commit/080bbf528687956ac5ec917bfb55a10edd343c81", "message": "CB-5122 FreeIPA's LdapConfig and KerbConfig entity cleanup in case of child environment (#7266)", "committedDate": "2020-02-21T09:06:30Z", "type": "commit"}, {"oid": "402eacfd0cf1b7c03cca938666552c23e2c8cd1e", "url": "https://github.com/hortonworks/cloudbreak/commit/402eacfd0cf1b7c03cca938666552c23e2c8cd1e", "message": "CB-5494 There can not be active child environment in case of parent environment deletion", "committedDate": "2020-02-21T09:06:30Z", "type": "commit"}, {"oid": "1986dbacca58bd8a82956ae3456a3b1de30824c6", "url": "https://github.com/hortonworks/cloudbreak/commit/1986dbacca58bd8a82956ae3456a3b1de30824c6", "message": "CB-5122 Rename freeipa child environment management", "committedDate": "2020-02-21T09:06:30Z", "type": "commit"}, {"oid": "b70415ae2b5782875aa58d8c1788151df580623a", "url": "https://github.com/hortonworks/cloudbreak/commit/b70415ae2b5782875aa58d8c1788151df580623a", "message": "CB-5121 Apply review comments", "committedDate": "2020-02-21T09:06:30Z", "type": "commit"}, {"oid": "54a4b768587145d7dd22998b670f68b61b87e8d3", "url": "https://github.com/hortonworks/cloudbreak/commit/54a4b768587145d7dd22998b670f68b61b87e8d3", "message": "CB-5031 update hostname on Ycloud based on CB-1367 to avoid DNS healt check failures in CM", "committedDate": "2020-02-21T09:06:30Z", "type": "commit"}, {"oid": "067b65f3c31808c6dcd872d590e62773984b2a85", "url": "https://github.com/hortonworks/cloudbreak/commit/067b65f3c31808c6dcd872d590e62773984b2a85", "message": "CB-5122 Validate delete freeipa request", "committedDate": "2020-02-21T09:06:30Z", "type": "commit"}, {"oid": "baf9392cbd93e7e4913b47e44352ec97e058b905", "url": "https://github.com/hortonworks/cloudbreak/commit/baf9392cbd93e7e4913b47e44352ec97e058b905", "message": "CB-5122 Remove eager fetching of child environments", "committedDate": "2020-02-21T09:06:30Z", "type": "commit"}, {"oid": "448230ac70847b668aa93b3c6c105ae0461d7d96", "url": "https://github.com/hortonworks/cloudbreak/commit/448230ac70847b668aa93b3c6c105ae0461d7d96", "message": "CB-5122 Only fetch ChildEnvironment when necessary", "committedDate": "2020-02-21T09:06:30Z", "type": "commit"}, {"oid": "6923618f9c6f1433819f8e14c146c1f2ff69ef91", "url": "https://github.com/hortonworks/cloudbreak/commit/6923618f9c6f1433819f8e14c146c1f2ff69ef91", "message": "CB-5122 Remove childEnvironment references from stack", "committedDate": "2020-02-21T09:06:30Z", "type": "commit"}, {"oid": "9144e66f182265370e85e9db228968a63c8f2949", "url": "https://github.com/hortonworks/cloudbreak/commit/9144e66f182265370e85e9db228968a63c8f2949", "message": "CB-5395 Fix FreeIpa delete/detach conditions", "committedDate": "2020-02-21T09:06:30Z", "type": "commit"}, {"oid": "9144e66f182265370e85e9db228968a63c8f2949", "url": "https://github.com/hortonworks/cloudbreak/commit/9144e66f182265370e85e9db228968a63c8f2949", "message": "CB-5395 Fix FreeIpa delete/detach conditions", "committedDate": "2020-02-21T09:06:30Z", "type": "forcePushed"}]}