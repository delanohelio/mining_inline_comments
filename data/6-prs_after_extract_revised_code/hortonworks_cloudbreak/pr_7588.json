{"pr_number": 7588, "pr_title": "CB-3864 subnet selection refactor", "pr_createdAt": "2020-03-15T14:53:21Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/7588", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY4Njg0MA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7588#discussion_r392686840", "bodyText": "SubnetSelectorStrategyType could be renamed to filterStrategy as it does not select anymore.", "author": "keyki", "createdAt": "2020-03-15T15:53:37Z", "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/AwsNetworkConnector.java", "diffHunk": "@@ -135,18 +142,25 @@ public String getNetworkCidr(Network network, CloudCredential credential) {\n     }\n \n     @Override\n-    public SubnetSelectionResult selectSubnets(List<CloudSubnet> subnetMetas, SubnetSelectionParameters subnetSelectionParameters) {\n-        boolean preferPrivate = subnetSelectionParameters.isForDatabase() || subnetSelectionParameters.getTunnel().useCcm();\n+    public SubnetSelectionResult filterSubnets(Collection<CloudSubnet> subnetMetas, SubnetSelectionParameters subnetSelectionParameters) {\n+        boolean preferPrivate = subnetSelectionParameters.isPreferPrivateIfExist() || subnetSelectionParameters.getTunnel().useCcm();\n \n-        SubnetSelectorStrategyType subnetSelectorStrategyType;\n-        if (subnetSelectionParameters.isHa()) {\n-            subnetSelectorStrategyType = preferPrivate ? SubnetSelectorStrategyType.MULTIPLE_PREFER_PRIVATE : SubnetSelectorStrategyType.MULTIPLE_PREFER_PUBLIC;\n-        } else {\n-            subnetSelectorStrategyType = preferPrivate ? SubnetSelectorStrategyType.SINGLE_PREFER_PRIVATE : SubnetSelectorStrategyType.SINGLE_PREFER_PUBLIC;\n-        }\n+        SubnetSelectorStrategyType subnetSelectorStrategyType = preferPrivate ?", "originalCommit": "45a05cd080d86f366e0b9131e08bb2ca2d4d2eb3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "914388c768a9666101e77bad687aaa8ed44b202e", "chunk": "diff --git a/cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/AwsNetworkConnector.java b/cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/AwsNetworkConnector.java\nindex abe75d791a..0f7bc982dc 100644\n--- a/cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/AwsNetworkConnector.java\n+++ b/cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/AwsNetworkConnector.java\n\n@@ -145,9 +145,9 @@ public class AwsNetworkConnector implements NetworkConnector {\n     public SubnetSelectionResult filterSubnets(Collection<CloudSubnet> subnetMetas, SubnetSelectionParameters subnetSelectionParameters) {\n         boolean preferPrivate = subnetSelectionParameters.isPreferPrivateIfExist() || subnetSelectionParameters.getTunnel().useCcm();\n \n-        SubnetSelectorStrategyType subnetSelectorStrategyType = preferPrivate ?\n-                SubnetSelectorStrategyType.MULTIPLE_PREFER_PRIVATE\n-                : SubnetSelectorStrategyType.MULTIPLE_PREFER_PUBLIC;\n+        SubnetFilterStrategyType subnetSelectorStrategyType = preferPrivate ?\n+                SubnetFilterStrategyType.MULTIPLE_PREFER_PRIVATE\n+                : SubnetFilterStrategyType.MULTIPLE_PREFER_PUBLIC;\n         return subnetSelectorStrategyMap.get(subnetSelectorStrategyType).select(subnetMetas);\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY4NzA2Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/7588#discussion_r392687067", "bodyText": "We should add a lot more logging to figure out what happens when it's not something that we expect.", "author": "keyki", "createdAt": "2020-03-15T15:55:57Z", "path": "cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/NetworkConnector.java", "diffHunk": "@@ -1,26 +1,84 @@\n package com.sequenceiq.cloudbreak.cloud;\n \n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.HashMap;\n import java.util.List;\n+import java.util.Map;\n+import java.util.Random;\n \n import com.sequenceiq.cloudbreak.cloud.model.CloudCredential;\n import com.sequenceiq.cloudbreak.cloud.model.CloudSubnet;\n import com.sequenceiq.cloudbreak.cloud.model.Network;\n import com.sequenceiq.cloudbreak.cloud.model.SubnetSelectionParameters;\n+import com.sequenceiq.cloudbreak.cloud.model.SubnetSelectionResult;\n import com.sequenceiq.cloudbreak.cloud.model.network.CreatedCloudNetwork;\n import com.sequenceiq.cloudbreak.cloud.model.network.NetworkCreationRequest;\n import com.sequenceiq.cloudbreak.cloud.model.network.NetworkDeletionRequest;\n-import com.sequenceiq.cloudbreak.cloud.model.SubnetSelectionResult;\n \n /**\n  * Network connectors.\n  */\n public interface NetworkConnector extends CloudPlatformAware {\n \n+    String NOT_ENOUGH_AZ = \"Acceptable subnets are in %d different AZs, but subnets in %d different AZs required.\";\n+\n     CreatedCloudNetwork createNetworkWithSubnets(NetworkCreationRequest networkCreationRequest);\n \n     void deleteNetworkWithSubnets(NetworkDeletionRequest networkDeletionRequest);\n \n     String getNetworkCidr(Network network, CloudCredential credential);\n \n-    SubnetSelectionResult selectSubnets(List<CloudSubnet> subnetMetas, SubnetSelectionParameters subnetSelectionParameters);\n+    SubnetSelectionResult filterSubnets(Collection<CloudSubnet> subnetMetas, SubnetSelectionParameters subnetSelectionParameters);\n+\n+    int subnetCountInDifferentAzMin();\n+\n+    int subnetCountInDifferentAzMax();\n+\n+    default SubnetSelectionResult selectSubnets(SubnetSelectionResult subnetSelectionResult, SubnetSelectionParameters subnetSelectionParameters) {\n+        if (subnetSelectionResult.hasResult()) {", "originalCommit": "45a05cd080d86f366e0b9131e08bb2ca2d4d2eb3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjcwOTE1Mg==", "url": "https://github.com/hortonworks/cloudbreak/pull/7588#discussion_r392709152", "bodyText": "yep already mentioned in the PR description", "author": "doktoric", "createdAt": "2020-03-15T20:24:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY4NzA2Nw=="}], "type": "inlineReview", "revised_code": {"commit": "96e4e6c23d8610324f01e2f7a599771d1233c916", "chunk": "diff --git a/cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/NetworkConnector.java b/cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/NetworkConnector.java\nindex ffda809c7a..a22e167268 100644\n--- a/cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/NetworkConnector.java\n+++ b/cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/NetworkConnector.java\n\n@@ -7,6 +7,9 @@ import java.util.List;\n import java.util.Map;\n import java.util.Random;\n \n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n import com.sequenceiq.cloudbreak.cloud.model.CloudCredential;\n import com.sequenceiq.cloudbreak.cloud.model.CloudSubnet;\n import com.sequenceiq.cloudbreak.cloud.model.Network;\n"}}, {"oid": "96e4e6c23d8610324f01e2f7a599771d1233c916", "url": "https://github.com/hortonworks/cloudbreak/commit/96e4e6c23d8610324f01e2f7a599771d1233c916", "message": "CB-3864 subnet selection refactor", "committedDate": "2020-03-15T20:22:08Z", "type": "forcePushed"}, {"oid": "914388c768a9666101e77bad687aaa8ed44b202e", "url": "https://github.com/hortonworks/cloudbreak/commit/914388c768a9666101e77bad687aaa8ed44b202e", "message": "CB-3864 subnet selection refactor", "committedDate": "2020-03-15T20:24:29Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzAzNzYyMA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7588#discussion_r393037620", "bodyText": "In my opinion a default implementation might not be the best solution. The algorithm here is the AWS implementation. I would suggest an abstract method with cloud-provider specific implementations.", "author": "gergopapi2", "createdAt": "2020-03-16T13:53:14Z", "path": "cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/NetworkConnector.java", "diffHunk": "@@ -1,26 +1,99 @@\n package com.sequenceiq.cloudbreak.cloud;\n \n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.HashMap;\n import java.util.List;\n+import java.util.Map;\n+import java.util.Random;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n \n import com.sequenceiq.cloudbreak.cloud.model.CloudCredential;\n import com.sequenceiq.cloudbreak.cloud.model.CloudSubnet;\n import com.sequenceiq.cloudbreak.cloud.model.Network;\n import com.sequenceiq.cloudbreak.cloud.model.SubnetSelectionParameters;\n+import com.sequenceiq.cloudbreak.cloud.model.SubnetSelectionResult;\n import com.sequenceiq.cloudbreak.cloud.model.network.CreatedCloudNetwork;\n import com.sequenceiq.cloudbreak.cloud.model.network.NetworkCreationRequest;\n import com.sequenceiq.cloudbreak.cloud.model.network.NetworkDeletionRequest;\n-import com.sequenceiq.cloudbreak.cloud.model.SubnetSelectionResult;\n \n /**\n  * Network connectors.\n  */\n public interface NetworkConnector extends CloudPlatformAware {\n+    Logger LOGGER = LoggerFactory.getLogger(NetworkConnector.class);\n+\n+    String NOT_ENOUGH_AZ = \"Acceptable subnets are in %d different AZs, but subnets in %d different AZs required.\";\n \n     CreatedCloudNetwork createNetworkWithSubnets(NetworkCreationRequest networkCreationRequest);\n \n     void deleteNetworkWithSubnets(NetworkDeletionRequest networkDeletionRequest);\n \n     String getNetworkCidr(Network network, CloudCredential credential);\n \n-    SubnetSelectionResult selectSubnets(List<CloudSubnet> subnetMetas, SubnetSelectionParameters subnetSelectionParameters);\n+    SubnetSelectionResult filterSubnets(Collection<CloudSubnet> subnetMetas, SubnetSelectionParameters subnetSelectionParameters);\n+\n+    int subnetCountInDifferentAzMin();\n+\n+    int subnetCountInDifferentAzMax();\n+\n+    default SubnetSelectionResult selectSubnets(SubnetSelectionResult subnetSelectionResult, SubnetSelectionParameters subnetSelectionParameters) {", "originalCommit": "914388c768a9666101e77bad687aaa8ed44b202e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzEzOTI0OA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7588#discussion_r393139248", "bodyText": "\ud83d\udc4d", "author": "doktoric", "createdAt": "2020-03-16T16:10:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzAzNzYyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzI4MjAwNA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7588#discussion_r393282004", "bodyText": "btw this is the same for mock", "author": "doktoric", "createdAt": "2020-03-16T20:07:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzAzNzYyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzI4MjUzMg==", "url": "https://github.com/hortonworks/cloudbreak/pull/7588#discussion_r393282532", "bodyText": "I think the default method is fine here becase probably other will use the same except Azure", "author": "doktoric", "createdAt": "2020-03-16T20:08:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzAzNzYyMA=="}], "type": "inlineReview", "revised_code": {"commit": "454f20c51bcd3c4525836b4b7e64b07dc6046b06", "chunk": "diff --git a/cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/NetworkConnector.java b/cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/NetworkConnector.java\nindex a22e167268..d7050be315 100644\n--- a/cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/NetworkConnector.java\n+++ b/cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/NetworkConnector.java\n\n@@ -2,10 +2,12 @@ package com.sequenceiq.cloudbreak.cloud;\n \n import java.util.ArrayList;\n import java.util.Collection;\n-import java.util.HashMap;\n+import java.util.Collections;\n+import java.util.LinkedHashMap;\n import java.util.List;\n import java.util.Map;\n import java.util.Random;\n+import java.util.stream.Collectors;\n \n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzAzOTQ2OA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7588#discussion_r393039468", "bodyText": "I prefer return early over indentations - this is, however, a matter of taste.", "author": "gergopapi2", "createdAt": "2020-03-16T13:56:02Z", "path": "cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/NetworkConnector.java", "diffHunk": "@@ -1,26 +1,99 @@\n package com.sequenceiq.cloudbreak.cloud;\n \n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.HashMap;\n import java.util.List;\n+import java.util.Map;\n+import java.util.Random;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n \n import com.sequenceiq.cloudbreak.cloud.model.CloudCredential;\n import com.sequenceiq.cloudbreak.cloud.model.CloudSubnet;\n import com.sequenceiq.cloudbreak.cloud.model.Network;\n import com.sequenceiq.cloudbreak.cloud.model.SubnetSelectionParameters;\n+import com.sequenceiq.cloudbreak.cloud.model.SubnetSelectionResult;\n import com.sequenceiq.cloudbreak.cloud.model.network.CreatedCloudNetwork;\n import com.sequenceiq.cloudbreak.cloud.model.network.NetworkCreationRequest;\n import com.sequenceiq.cloudbreak.cloud.model.network.NetworkDeletionRequest;\n-import com.sequenceiq.cloudbreak.cloud.model.SubnetSelectionResult;\n \n /**\n  * Network connectors.\n  */\n public interface NetworkConnector extends CloudPlatformAware {\n+    Logger LOGGER = LoggerFactory.getLogger(NetworkConnector.class);\n+\n+    String NOT_ENOUGH_AZ = \"Acceptable subnets are in %d different AZs, but subnets in %d different AZs required.\";\n \n     CreatedCloudNetwork createNetworkWithSubnets(NetworkCreationRequest networkCreationRequest);\n \n     void deleteNetworkWithSubnets(NetworkDeletionRequest networkDeletionRequest);\n \n     String getNetworkCidr(Network network, CloudCredential credential);\n \n-    SubnetSelectionResult selectSubnets(List<CloudSubnet> subnetMetas, SubnetSelectionParameters subnetSelectionParameters);\n+    SubnetSelectionResult filterSubnets(Collection<CloudSubnet> subnetMetas, SubnetSelectionParameters subnetSelectionParameters);\n+\n+    int subnetCountInDifferentAzMin();\n+\n+    int subnetCountInDifferentAzMax();\n+\n+    default SubnetSelectionResult selectSubnets(SubnetSelectionResult subnetSelectionResult, SubnetSelectionParameters subnetSelectionParameters) {\n+        if (subnetSelectionResult.hasResult()) {\n+            LOGGER.info(\"There are subnets in the subnet selection: {}.\", subnetSelectionResult);\n+            List<CloudSubnet> result = new ArrayList<>();\n+            if (subnetSelectionParameters.isHa()) {\n+                LOGGER.info(\"The request contains HA option: true: {}.\", subnetSelectionParameters);\n+                Map<String, List<CloudSubnet>> groupedSubnetsByAz = groupSubnetsByAz(subnetSelectionResult.getResult());\n+                LOGGER.info(\"The subnets groupped by AZs and the result is: {}.\", groupedSubnetsByAz);\n+                // We dont have enough AZ\n+                if (!isDifferentAzCountEnough(groupedSubnetsByAz)) {\n+                    LOGGER.info(\"There is not enough different AZ in the subnet setup.\");\n+                    return new SubnetSelectionResult(String.format(NOT_ENOUGH_AZ, groupedSubnetsByAz.keySet().size(), subnetCountInDifferentAzMin()));\n+                } else {\n+                    // We have enough AZ\n+                    for (Map.Entry<String, List<CloudSubnet>> entry : groupedSubnetsByAz.entrySet()) {\n+                        int random = new Random().nextInt(entry.getValue().size());\n+                        CloudSubnet cloudSubnet = entry.getValue().get(random);\n+                        LOGGER.info(\"The selected subnet is: {} by random id {}.\", cloudSubnet, random);\n+                        result.add(cloudSubnet);\n+                        if (result.size() == subnetCountInDifferentAzMax()) {\n+                            LOGGER.info(\"The selection logic already selected enough subnet which is {}.\", result.size());\n+                            break;\n+                        }\n+                    }\n+                }\n+            } else {\n+                int random = new Random().nextInt(subnetSelectionResult.getResult().size());\n+                CloudSubnet cloudSubnet = subnetSelectionResult.getResult().get(random);\n+                LOGGER.info(\"The selected subnet is: {} by random id {}.\", cloudSubnet, random);\n+                result.add(cloudSubnet);\n+            }\n+            LOGGER.info(\"The selected subnets are: {} for the resource provisioning.\", result);\n+            return new SubnetSelectionResult(result);\n+        } else {", "originalCommit": "914388c768a9666101e77bad687aaa8ed44b202e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzEzOTYzNw==", "url": "https://github.com/hortonworks/cloudbreak/pull/7588#discussion_r393139637", "bodyText": "If you dont mind I would like to do this way", "author": "doktoric", "createdAt": "2020-03-16T16:10:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzAzOTQ2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzE1Mjg5MQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/7588#discussion_r393152891", "bodyText": "Yes, I accept that.", "author": "gergopapi2", "createdAt": "2020-03-16T16:30:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzAzOTQ2OA=="}], "type": "inlineReview", "revised_code": {"commit": "454f20c51bcd3c4525836b4b7e64b07dc6046b06", "chunk": "diff --git a/cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/NetworkConnector.java b/cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/NetworkConnector.java\nindex a22e167268..d7050be315 100644\n--- a/cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/NetworkConnector.java\n+++ b/cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/NetworkConnector.java\n\n@@ -2,10 +2,12 @@ package com.sequenceiq.cloudbreak.cloud;\n \n import java.util.ArrayList;\n import java.util.Collection;\n-import java.util.HashMap;\n+import java.util.Collections;\n+import java.util.LinkedHashMap;\n import java.util.List;\n import java.util.Map;\n import java.util.Random;\n+import java.util.stream.Collectors;\n \n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA0MDAwMA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7588#discussion_r393040000", "bodyText": "This else is far from its corresponding if, I would extract methods for ha and non-ha, respectively.", "author": "gergopapi2", "createdAt": "2020-03-16T13:56:54Z", "path": "cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/NetworkConnector.java", "diffHunk": "@@ -1,26 +1,99 @@\n package com.sequenceiq.cloudbreak.cloud;\n \n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.HashMap;\n import java.util.List;\n+import java.util.Map;\n+import java.util.Random;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n \n import com.sequenceiq.cloudbreak.cloud.model.CloudCredential;\n import com.sequenceiq.cloudbreak.cloud.model.CloudSubnet;\n import com.sequenceiq.cloudbreak.cloud.model.Network;\n import com.sequenceiq.cloudbreak.cloud.model.SubnetSelectionParameters;\n+import com.sequenceiq.cloudbreak.cloud.model.SubnetSelectionResult;\n import com.sequenceiq.cloudbreak.cloud.model.network.CreatedCloudNetwork;\n import com.sequenceiq.cloudbreak.cloud.model.network.NetworkCreationRequest;\n import com.sequenceiq.cloudbreak.cloud.model.network.NetworkDeletionRequest;\n-import com.sequenceiq.cloudbreak.cloud.model.SubnetSelectionResult;\n \n /**\n  * Network connectors.\n  */\n public interface NetworkConnector extends CloudPlatformAware {\n+    Logger LOGGER = LoggerFactory.getLogger(NetworkConnector.class);\n+\n+    String NOT_ENOUGH_AZ = \"Acceptable subnets are in %d different AZs, but subnets in %d different AZs required.\";\n \n     CreatedCloudNetwork createNetworkWithSubnets(NetworkCreationRequest networkCreationRequest);\n \n     void deleteNetworkWithSubnets(NetworkDeletionRequest networkDeletionRequest);\n \n     String getNetworkCidr(Network network, CloudCredential credential);\n \n-    SubnetSelectionResult selectSubnets(List<CloudSubnet> subnetMetas, SubnetSelectionParameters subnetSelectionParameters);\n+    SubnetSelectionResult filterSubnets(Collection<CloudSubnet> subnetMetas, SubnetSelectionParameters subnetSelectionParameters);\n+\n+    int subnetCountInDifferentAzMin();\n+\n+    int subnetCountInDifferentAzMax();\n+\n+    default SubnetSelectionResult selectSubnets(SubnetSelectionResult subnetSelectionResult, SubnetSelectionParameters subnetSelectionParameters) {\n+        if (subnetSelectionResult.hasResult()) {\n+            LOGGER.info(\"There are subnets in the subnet selection: {}.\", subnetSelectionResult);\n+            List<CloudSubnet> result = new ArrayList<>();\n+            if (subnetSelectionParameters.isHa()) {\n+                LOGGER.info(\"The request contains HA option: true: {}.\", subnetSelectionParameters);\n+                Map<String, List<CloudSubnet>> groupedSubnetsByAz = groupSubnetsByAz(subnetSelectionResult.getResult());\n+                LOGGER.info(\"The subnets groupped by AZs and the result is: {}.\", groupedSubnetsByAz);\n+                // We dont have enough AZ\n+                if (!isDifferentAzCountEnough(groupedSubnetsByAz)) {\n+                    LOGGER.info(\"There is not enough different AZ in the subnet setup.\");\n+                    return new SubnetSelectionResult(String.format(NOT_ENOUGH_AZ, groupedSubnetsByAz.keySet().size(), subnetCountInDifferentAzMin()));\n+                } else {\n+                    // We have enough AZ\n+                    for (Map.Entry<String, List<CloudSubnet>> entry : groupedSubnetsByAz.entrySet()) {\n+                        int random = new Random().nextInt(entry.getValue().size());\n+                        CloudSubnet cloudSubnet = entry.getValue().get(random);\n+                        LOGGER.info(\"The selected subnet is: {} by random id {}.\", cloudSubnet, random);\n+                        result.add(cloudSubnet);\n+                        if (result.size() == subnetCountInDifferentAzMax()) {\n+                            LOGGER.info(\"The selection logic already selected enough subnet which is {}.\", result.size());\n+                            break;\n+                        }\n+                    }\n+                }\n+            } else {", "originalCommit": "914388c768a9666101e77bad687aaa8ed44b202e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "454f20c51bcd3c4525836b4b7e64b07dc6046b06", "chunk": "diff --git a/cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/NetworkConnector.java b/cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/NetworkConnector.java\nindex a22e167268..d7050be315 100644\n--- a/cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/NetworkConnector.java\n+++ b/cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/NetworkConnector.java\n\n@@ -2,10 +2,12 @@ package com.sequenceiq.cloudbreak.cloud;\n \n import java.util.ArrayList;\n import java.util.Collection;\n-import java.util.HashMap;\n+import java.util.Collections;\n+import java.util.LinkedHashMap;\n import java.util.List;\n import java.util.Map;\n import java.util.Random;\n+import java.util.stream.Collectors;\n \n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA0MTMyNA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7588#discussion_r393041324", "bodyText": "The corresponding if is an error handling with return. After that I would omit an else to reduce indentations. This is, however, almost a matter of taste, and so do not insist on it to be changed.", "author": "gergopapi2", "createdAt": "2020-03-16T13:58:52Z", "path": "cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/NetworkConnector.java", "diffHunk": "@@ -1,26 +1,99 @@\n package com.sequenceiq.cloudbreak.cloud;\n \n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.HashMap;\n import java.util.List;\n+import java.util.Map;\n+import java.util.Random;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n \n import com.sequenceiq.cloudbreak.cloud.model.CloudCredential;\n import com.sequenceiq.cloudbreak.cloud.model.CloudSubnet;\n import com.sequenceiq.cloudbreak.cloud.model.Network;\n import com.sequenceiq.cloudbreak.cloud.model.SubnetSelectionParameters;\n+import com.sequenceiq.cloudbreak.cloud.model.SubnetSelectionResult;\n import com.sequenceiq.cloudbreak.cloud.model.network.CreatedCloudNetwork;\n import com.sequenceiq.cloudbreak.cloud.model.network.NetworkCreationRequest;\n import com.sequenceiq.cloudbreak.cloud.model.network.NetworkDeletionRequest;\n-import com.sequenceiq.cloudbreak.cloud.model.SubnetSelectionResult;\n \n /**\n  * Network connectors.\n  */\n public interface NetworkConnector extends CloudPlatformAware {\n+    Logger LOGGER = LoggerFactory.getLogger(NetworkConnector.class);\n+\n+    String NOT_ENOUGH_AZ = \"Acceptable subnets are in %d different AZs, but subnets in %d different AZs required.\";\n \n     CreatedCloudNetwork createNetworkWithSubnets(NetworkCreationRequest networkCreationRequest);\n \n     void deleteNetworkWithSubnets(NetworkDeletionRequest networkDeletionRequest);\n \n     String getNetworkCidr(Network network, CloudCredential credential);\n \n-    SubnetSelectionResult selectSubnets(List<CloudSubnet> subnetMetas, SubnetSelectionParameters subnetSelectionParameters);\n+    SubnetSelectionResult filterSubnets(Collection<CloudSubnet> subnetMetas, SubnetSelectionParameters subnetSelectionParameters);\n+\n+    int subnetCountInDifferentAzMin();\n+\n+    int subnetCountInDifferentAzMax();\n+\n+    default SubnetSelectionResult selectSubnets(SubnetSelectionResult subnetSelectionResult, SubnetSelectionParameters subnetSelectionParameters) {\n+        if (subnetSelectionResult.hasResult()) {\n+            LOGGER.info(\"There are subnets in the subnet selection: {}.\", subnetSelectionResult);\n+            List<CloudSubnet> result = new ArrayList<>();\n+            if (subnetSelectionParameters.isHa()) {\n+                LOGGER.info(\"The request contains HA option: true: {}.\", subnetSelectionParameters);\n+                Map<String, List<CloudSubnet>> groupedSubnetsByAz = groupSubnetsByAz(subnetSelectionResult.getResult());\n+                LOGGER.info(\"The subnets groupped by AZs and the result is: {}.\", groupedSubnetsByAz);\n+                // We dont have enough AZ\n+                if (!isDifferentAzCountEnough(groupedSubnetsByAz)) {\n+                    LOGGER.info(\"There is not enough different AZ in the subnet setup.\");\n+                    return new SubnetSelectionResult(String.format(NOT_ENOUGH_AZ, groupedSubnetsByAz.keySet().size(), subnetCountInDifferentAzMin()));\n+                } else {", "originalCommit": "914388c768a9666101e77bad687aaa8ed44b202e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "454f20c51bcd3c4525836b4b7e64b07dc6046b06", "chunk": "diff --git a/cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/NetworkConnector.java b/cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/NetworkConnector.java\nindex a22e167268..d7050be315 100644\n--- a/cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/NetworkConnector.java\n+++ b/cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/NetworkConnector.java\n\n@@ -2,10 +2,12 @@ package com.sequenceiq.cloudbreak.cloud;\n \n import java.util.ArrayList;\n import java.util.Collection;\n-import java.util.HashMap;\n+import java.util.Collections;\n+import java.util.LinkedHashMap;\n import java.util.List;\n import java.util.Map;\n import java.util.Random;\n+import java.util.stream.Collectors;\n \n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA0ODQ0NQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/7588#discussion_r393048445", "bodyText": "This algorithm, if given a map with AZs ordered (that is, keys are: AZ-a, AZ-b, AZ-c .. AZ-n) leads to an uneven distribution of selected AZs and so subnets. It might make sense to select AZs randomly as well.", "author": "gergopapi2", "createdAt": "2020-03-16T14:09:20Z", "path": "cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/NetworkConnector.java", "diffHunk": "@@ -1,26 +1,99 @@\n package com.sequenceiq.cloudbreak.cloud;\n \n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.HashMap;\n import java.util.List;\n+import java.util.Map;\n+import java.util.Random;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n \n import com.sequenceiq.cloudbreak.cloud.model.CloudCredential;\n import com.sequenceiq.cloudbreak.cloud.model.CloudSubnet;\n import com.sequenceiq.cloudbreak.cloud.model.Network;\n import com.sequenceiq.cloudbreak.cloud.model.SubnetSelectionParameters;\n+import com.sequenceiq.cloudbreak.cloud.model.SubnetSelectionResult;\n import com.sequenceiq.cloudbreak.cloud.model.network.CreatedCloudNetwork;\n import com.sequenceiq.cloudbreak.cloud.model.network.NetworkCreationRequest;\n import com.sequenceiq.cloudbreak.cloud.model.network.NetworkDeletionRequest;\n-import com.sequenceiq.cloudbreak.cloud.model.SubnetSelectionResult;\n \n /**\n  * Network connectors.\n  */\n public interface NetworkConnector extends CloudPlatformAware {\n+    Logger LOGGER = LoggerFactory.getLogger(NetworkConnector.class);\n+\n+    String NOT_ENOUGH_AZ = \"Acceptable subnets are in %d different AZs, but subnets in %d different AZs required.\";\n \n     CreatedCloudNetwork createNetworkWithSubnets(NetworkCreationRequest networkCreationRequest);\n \n     void deleteNetworkWithSubnets(NetworkDeletionRequest networkDeletionRequest);\n \n     String getNetworkCidr(Network network, CloudCredential credential);\n \n-    SubnetSelectionResult selectSubnets(List<CloudSubnet> subnetMetas, SubnetSelectionParameters subnetSelectionParameters);\n+    SubnetSelectionResult filterSubnets(Collection<CloudSubnet> subnetMetas, SubnetSelectionParameters subnetSelectionParameters);\n+\n+    int subnetCountInDifferentAzMin();\n+\n+    int subnetCountInDifferentAzMax();\n+\n+    default SubnetSelectionResult selectSubnets(SubnetSelectionResult subnetSelectionResult, SubnetSelectionParameters subnetSelectionParameters) {\n+        if (subnetSelectionResult.hasResult()) {\n+            LOGGER.info(\"There are subnets in the subnet selection: {}.\", subnetSelectionResult);\n+            List<CloudSubnet> result = new ArrayList<>();\n+            if (subnetSelectionParameters.isHa()) {\n+                LOGGER.info(\"The request contains HA option: true: {}.\", subnetSelectionParameters);\n+                Map<String, List<CloudSubnet>> groupedSubnetsByAz = groupSubnetsByAz(subnetSelectionResult.getResult());\n+                LOGGER.info(\"The subnets groupped by AZs and the result is: {}.\", groupedSubnetsByAz);\n+                // We dont have enough AZ\n+                if (!isDifferentAzCountEnough(groupedSubnetsByAz)) {\n+                    LOGGER.info(\"There is not enough different AZ in the subnet setup.\");\n+                    return new SubnetSelectionResult(String.format(NOT_ENOUGH_AZ, groupedSubnetsByAz.keySet().size(), subnetCountInDifferentAzMin()));\n+                } else {\n+                    // We have enough AZ\n+                    for (Map.Entry<String, List<CloudSubnet>> entry : groupedSubnetsByAz.entrySet()) {", "originalCommit": "914388c768a9666101e77bad687aaa8ed44b202e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "454f20c51bcd3c4525836b4b7e64b07dc6046b06", "chunk": "diff --git a/cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/NetworkConnector.java b/cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/NetworkConnector.java\nindex a22e167268..d7050be315 100644\n--- a/cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/NetworkConnector.java\n+++ b/cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/NetworkConnector.java\n\n@@ -2,10 +2,12 @@ package com.sequenceiq.cloudbreak.cloud;\n \n import java.util.ArrayList;\n import java.util.Collection;\n-import java.util.HashMap;\n+import java.util.Collections;\n+import java.util.LinkedHashMap;\n import java.util.List;\n import java.util.Map;\n import java.util.Random;\n+import java.util.stream.Collectors;\n \n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA0ODg1NQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/7588#discussion_r393048855", "bodyText": "Selection is already done in the NetworkProvider, I would delete the randomization part.\nJust a note: if random subnet selection is introduced, then EnvironmentResponse will change from call to call as subnet selection is run every time a GET environment is invoked.", "author": "gergopapi2", "createdAt": "2020-03-16T14:10:00Z", "path": "environment/src/main/java/com/sequenceiq/environment/network/service/SubnetIdProvider.java", "diffHunk": "@@ -31,9 +31,21 @@ public String provide(NetworkDto network, Tunnel tunnel, CloudPlatform cloudPlat\n             LOGGER.debug(\"Check failed, returning null\");\n             return null;\n         }\n-        SubnetSelectionResult subnetSelectionResult = cloudPlatformConnectors.get(new CloudPlatformVariant(cloudPlatform.name(), cloudPlatform.name()))\n-                .networkConnector()\n-                .selectSubnets(new ArrayList<>(network.getSubnetMetas().values()), SubnetSelectionParameters.builder().withTunnel(tunnel).build());\n+\n+        NetworkConnector networkConnector = cloudPlatformConnectors\n+                .get(new CloudPlatformVariant(cloudPlatform.name(), cloudPlatform.name()))\n+                .networkConnector();\n+        SubnetSelectionParameters subnetSelectionParameters = SubnetSelectionParameters\n+                .builder()\n+                .withTunnel(tunnel)\n+                .build();\n+\n+        SubnetSelectionResult subnetSelectionResult = networkConnector\n+                .filterSubnets(network.getSubnetMetas().values(), subnetSelectionParameters);\n+        LOGGER.info(\"Filtered subnets are: {}\", subnetSelectionResult);\n+        subnetSelectionResult = networkConnector\n+                .selectSubnets(subnetSelectionResult, subnetSelectionParameters);\n+        LOGGER.info(\"Subnets after the selection are: {}\", subnetSelectionResult);\n         CloudSubnet selectedSubnet = subnetSelectionResult.hasResult()\n                 ? subnetSelectionResult.getResult().get(new Random().nextInt(subnetSelectionResult.getResult().size()))", "originalCommit": "914388c768a9666101e77bad687aaa8ed44b202e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "454f20c51bcd3c4525836b4b7e64b07dc6046b06", "chunk": "diff --git a/environment/src/main/java/com/sequenceiq/environment/network/service/SubnetIdProvider.java b/environment/src/main/java/com/sequenceiq/environment/network/service/SubnetIdProvider.java\nindex cf48747331..d294dbe9e8 100644\n--- a/environment/src/main/java/com/sequenceiq/environment/network/service/SubnetIdProvider.java\n+++ b/environment/src/main/java/com/sequenceiq/environment/network/service/SubnetIdProvider.java\n\n@@ -42,10 +42,8 @@ public class SubnetIdProvider {\n \n         SubnetSelectionResult subnetSelectionResult = networkConnector\n                 .filterSubnets(network.getSubnetMetas().values(), subnetSelectionParameters);\n-        LOGGER.info(\"Filtered subnets are: {}\", subnetSelectionResult);\n         subnetSelectionResult = networkConnector\n                 .selectSubnets(subnetSelectionResult, subnetSelectionParameters);\n-        LOGGER.info(\"Subnets after the selection are: {}\", subnetSelectionResult);\n         CloudSubnet selectedSubnet = subnetSelectionResult.hasResult()\n                 ? subnetSelectionResult.getResult().get(new Random().nextInt(subnetSelectionResult.getResult().size()))\n                 : fallback(network);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA3NzEwNw==", "url": "https://github.com/hortonworks/cloudbreak/pull/7588#discussion_r393077107", "bodyText": "This should be a private method, thus I would extract a class that would contain:\n\nselectSubnets\nisDifferentAzCountEnough\ngroupSubnetsByAz\n\nI would prefer to put this logic to AwsNetworkConnector.", "author": "gergopapi2", "createdAt": "2020-03-16T14:42:51Z", "path": "cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/NetworkConnector.java", "diffHunk": "@@ -1,26 +1,99 @@\n package com.sequenceiq.cloudbreak.cloud;\n \n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.HashMap;\n import java.util.List;\n+import java.util.Map;\n+import java.util.Random;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n \n import com.sequenceiq.cloudbreak.cloud.model.CloudCredential;\n import com.sequenceiq.cloudbreak.cloud.model.CloudSubnet;\n import com.sequenceiq.cloudbreak.cloud.model.Network;\n import com.sequenceiq.cloudbreak.cloud.model.SubnetSelectionParameters;\n+import com.sequenceiq.cloudbreak.cloud.model.SubnetSelectionResult;\n import com.sequenceiq.cloudbreak.cloud.model.network.CreatedCloudNetwork;\n import com.sequenceiq.cloudbreak.cloud.model.network.NetworkCreationRequest;\n import com.sequenceiq.cloudbreak.cloud.model.network.NetworkDeletionRequest;\n-import com.sequenceiq.cloudbreak.cloud.model.SubnetSelectionResult;\n \n /**\n  * Network connectors.\n  */\n public interface NetworkConnector extends CloudPlatformAware {\n+    Logger LOGGER = LoggerFactory.getLogger(NetworkConnector.class);\n+\n+    String NOT_ENOUGH_AZ = \"Acceptable subnets are in %d different AZs, but subnets in %d different AZs required.\";\n \n     CreatedCloudNetwork createNetworkWithSubnets(NetworkCreationRequest networkCreationRequest);\n \n     void deleteNetworkWithSubnets(NetworkDeletionRequest networkDeletionRequest);\n \n     String getNetworkCidr(Network network, CloudCredential credential);\n \n-    SubnetSelectionResult selectSubnets(List<CloudSubnet> subnetMetas, SubnetSelectionParameters subnetSelectionParameters);\n+    SubnetSelectionResult filterSubnets(Collection<CloudSubnet> subnetMetas, SubnetSelectionParameters subnetSelectionParameters);\n+\n+    int subnetCountInDifferentAzMin();\n+\n+    int subnetCountInDifferentAzMax();\n+\n+    default SubnetSelectionResult selectSubnets(SubnetSelectionResult subnetSelectionResult, SubnetSelectionParameters subnetSelectionParameters) {\n+        if (subnetSelectionResult.hasResult()) {\n+            LOGGER.info(\"There are subnets in the subnet selection: {}.\", subnetSelectionResult);\n+            List<CloudSubnet> result = new ArrayList<>();\n+            if (subnetSelectionParameters.isHa()) {\n+                LOGGER.info(\"The request contains HA option: true: {}.\", subnetSelectionParameters);\n+                Map<String, List<CloudSubnet>> groupedSubnetsByAz = groupSubnetsByAz(subnetSelectionResult.getResult());\n+                LOGGER.info(\"The subnets groupped by AZs and the result is: {}.\", groupedSubnetsByAz);\n+                // We dont have enough AZ\n+                if (!isDifferentAzCountEnough(groupedSubnetsByAz)) {\n+                    LOGGER.info(\"There is not enough different AZ in the subnet setup.\");\n+                    return new SubnetSelectionResult(String.format(NOT_ENOUGH_AZ, groupedSubnetsByAz.keySet().size(), subnetCountInDifferentAzMin()));\n+                } else {\n+                    // We have enough AZ\n+                    for (Map.Entry<String, List<CloudSubnet>> entry : groupedSubnetsByAz.entrySet()) {\n+                        int random = new Random().nextInt(entry.getValue().size());\n+                        CloudSubnet cloudSubnet = entry.getValue().get(random);\n+                        LOGGER.info(\"The selected subnet is: {} by random id {}.\", cloudSubnet, random);\n+                        result.add(cloudSubnet);\n+                        if (result.size() == subnetCountInDifferentAzMax()) {\n+                            LOGGER.info(\"The selection logic already selected enough subnet which is {}.\", result.size());\n+                            break;\n+                        }\n+                    }\n+                }\n+            } else {\n+                int random = new Random().nextInt(subnetSelectionResult.getResult().size());\n+                CloudSubnet cloudSubnet = subnetSelectionResult.getResult().get(random);\n+                LOGGER.info(\"The selected subnet is: {} by random id {}.\", cloudSubnet, random);\n+                result.add(cloudSubnet);\n+            }\n+            LOGGER.info(\"The selected subnets are: {} for the resource provisioning.\", result);\n+            return new SubnetSelectionResult(result);\n+        } else {\n+            LOGGER.info(\"There is no result in the subnet selection: {}.\", subnetSelectionResult);\n+            return subnetSelectionResult;\n+        }\n+    }\n+\n+    default boolean isDifferentAzCountEnough(Map<String, List<CloudSubnet>> groupedSubnetsByAz) {", "originalCommit": "914388c768a9666101e77bad687aaa8ed44b202e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "454f20c51bcd3c4525836b4b7e64b07dc6046b06", "chunk": "diff --git a/cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/NetworkConnector.java b/cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/NetworkConnector.java\nindex a22e167268..d7050be315 100644\n--- a/cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/NetworkConnector.java\n+++ b/cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/NetworkConnector.java\n\n@@ -2,10 +2,12 @@ package com.sequenceiq.cloudbreak.cloud;\n \n import java.util.ArrayList;\n import java.util.Collection;\n-import java.util.HashMap;\n+import java.util.Collections;\n+import java.util.LinkedHashMap;\n import java.util.List;\n import java.util.Map;\n import java.util.Random;\n+import java.util.stream.Collectors;\n \n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA4NDc4Mw==", "url": "https://github.com/hortonworks/cloudbreak/pull/7588#discussion_r393084783", "bodyText": "Private => public (method collects public subnets, log should say public as well).", "author": "gergopapi2", "createdAt": "2020-03-16T14:53:26Z", "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetSelectorService.java", "diffHunk": "@@ -18,61 +15,30 @@\n \n     private static final Logger LOGGER = LoggerFactory.getLogger(SubnetSelectorService.class);\n \n-    Map<String, CloudSubnet> collectOnePrivateSubnetPerAz(List<CloudSubnet> subnetMetas, int max) {\n-        Map<String, CloudSubnet> subnetsPerAz = new HashMap<>();\n-        Iterator<CloudSubnet> subnetIterator = subnetMetas.iterator();\n-        while (subnetsPerAz.size() < max && subnetIterator.hasNext()) {\n-            CloudSubnet nextSubnet = subnetIterator.next();\n-            if (nextSubnet.isPrivateSubnet()) {\n-                subnetsPerAz.putIfAbsent(nextSubnet.getAvailabilityZone(), nextSubnet);\n+    List<CloudSubnet> collectPublicSubnets(Collection<CloudSubnet> subnetMetas) {\n+        List<CloudSubnet> result = new ArrayList<>();\n+        for (CloudSubnet subnetMeta : subnetMetas) {\n+            if (isUsablePublicSubnet(subnetMeta)) {\n+                result.add(subnetMeta);\n             }\n         }\n-        LOGGER.debug(\"Private subnets per AZ: {}\", subnetsPerAz.values().stream().map(CloudSubnet::getId).collect(Collectors.joining(\",\")));\n-        return subnetsPerAz;\n+        LOGGER.debug(\"Private subnets for selections: {}\", result);", "originalCommit": "914388c768a9666101e77bad687aaa8ed44b202e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "59d679f8ecbfcb293f81abf30459b289b9e2c899", "chunk": "diff --git a/cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetSelectorService.java b/cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetSelectorService.java\nindex a92eb1730d..705d26f121 100644\n--- a/cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetSelectorService.java\n+++ b/cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetSelectorService.java\n\n@@ -22,7 +22,7 @@ class SubnetSelectorService {\n                 result.add(subnetMeta);\n             }\n         }\n-        LOGGER.debug(\"Private subnets for selections: {}\", result);\n+        LOGGER.debug(\"Public subnets for selections: {}\", result);\n         return result;\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA4NjU4MQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/7588#discussion_r393086581", "bodyText": "List of private subnets was listed in subnetSelectorService already, I think it is not necessary to log in once again.", "author": "gergopapi2", "createdAt": "2020-03-16T14:55:54Z", "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetSelectorStrategyMultiplePreferPrivate.java", "diffHunk": "@@ -20,37 +17,23 @@\n \n     private static final Logger LOGGER = LoggerFactory.getLogger(SubnetSelectorStrategyMultiplePreferPrivate.class);\n \n-    @VisibleForTesting\n-    @Value(\"${cb.aws.subnet.different.az.min:2}\")\n-    int minSubnetCountInDifferentAz;\n-\n-    @VisibleForTesting\n-    @Value(\"${cb.aws.subnet.different.az.max:3}\")\n-    int maxSubnetCountInDifferentAz;\n-\n     @Inject\n     private SubnetSelectorService subnetSelectorService;\n \n     @Override\n-    public SubnetSelectionResult selectInternal(List<CloudSubnet> subnetMetas) {\n-        Map<String, CloudSubnet> selectedSubnets = subnetSelectorService.collectOnePrivateSubnetPerAz(subnetMetas, maxSubnetCountInDifferentAz);\n-        if (selectedSubnets.size() < minSubnetCountInDifferentAz) {\n-            Map<String, CloudSubnet> publicSubnetsPerAz = subnetSelectorService.collectOnePublicSubnetPerAz(subnetMetas, minSubnetCountInDifferentAz);\n-            subnetSelectorService.collectSubnetsOfMissingAz(selectedSubnets, publicSubnetsPerAz, minSubnetCountInDifferentAz);\n-            if (selectedSubnets.size() < minSubnetCountInDifferentAz) {\n-                return new SubnetSelectionResult(String.format(NOT_ENOUGH_AZ, selectedSubnets.size(), minSubnetCountInDifferentAz));\n-            }\n+    public SubnetSelectionResult select(Collection<CloudSubnet> subnets) {\n+        List<CloudSubnet> result = subnetSelectorService.collectPrivateSubnets(subnets);\n+        LOGGER.info(\"Collected private subnets are: {}\", result);", "originalCommit": "914388c768a9666101e77bad687aaa8ed44b202e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "06c74468cfb4d0486b5b26fefe89e4c833f4fd4f", "chunk": "diff --git a/cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetSelectorStrategyMultiplePreferPrivate.java b/cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetFilterStrategyMultiplePreferPrivate.java\nsimilarity index 76%\nrename from cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetSelectorStrategyMultiplePreferPrivate.java\nrename to cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetFilterStrategyMultiplePreferPrivate.java\nindex d27fe5d8da..6e668c6037 100644\n--- a/cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetSelectorStrategyMultiplePreferPrivate.java\n+++ b/cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetFilterStrategyMultiplePreferPrivate.java\n\n@@ -13,19 +13,19 @@ import com.sequenceiq.cloudbreak.cloud.model.CloudSubnet;\n import com.sequenceiq.cloudbreak.cloud.model.SubnetSelectionResult;\n \n @Component\n-public class SubnetSelectorStrategyMultiplePreferPrivate extends SubnetSelectorStrategy {\n+public class SubnetFilterStrategyMultiplePreferPrivate extends SubnetFilterStrategy {\n \n-    private static final Logger LOGGER = LoggerFactory.getLogger(SubnetSelectorStrategyMultiplePreferPrivate.class);\n+    private static final Logger LOGGER = LoggerFactory.getLogger(SubnetFilterStrategyMultiplePreferPrivate.class);\n \n     @Inject\n     private SubnetSelectorService subnetSelectorService;\n \n     @Override\n-    public SubnetSelectionResult select(Collection<CloudSubnet> subnets) {\n+    public SubnetSelectionResult filter(Collection<CloudSubnet> subnets) {\n         List<CloudSubnet> result = subnetSelectorService.collectPrivateSubnets(subnets);\n         LOGGER.info(\"Collected private subnets are: {}\", result);\n         if (result.isEmpty()) {\n-            LOGGER.info(\"There are now private subnets in the environment, falling back to public subnets: {}\", subnets);\n+            LOGGER.info(\"There are no private subnets in the environment, falling back to public subnets: {}\", subnets);\n             result = subnetSelectorService.collectPublicSubnets(subnets);\n             LOGGER.info(\"Collected public subnets are: {}\", result);\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA4Njg4MA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7588#discussion_r393086880", "bodyText": "There are now => should read: There are no", "author": "gergopapi2", "createdAt": "2020-03-16T14:56:20Z", "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetSelectorStrategyMultiplePreferPrivate.java", "diffHunk": "@@ -20,37 +17,23 @@\n \n     private static final Logger LOGGER = LoggerFactory.getLogger(SubnetSelectorStrategyMultiplePreferPrivate.class);\n \n-    @VisibleForTesting\n-    @Value(\"${cb.aws.subnet.different.az.min:2}\")\n-    int minSubnetCountInDifferentAz;\n-\n-    @VisibleForTesting\n-    @Value(\"${cb.aws.subnet.different.az.max:3}\")\n-    int maxSubnetCountInDifferentAz;\n-\n     @Inject\n     private SubnetSelectorService subnetSelectorService;\n \n     @Override\n-    public SubnetSelectionResult selectInternal(List<CloudSubnet> subnetMetas) {\n-        Map<String, CloudSubnet> selectedSubnets = subnetSelectorService.collectOnePrivateSubnetPerAz(subnetMetas, maxSubnetCountInDifferentAz);\n-        if (selectedSubnets.size() < minSubnetCountInDifferentAz) {\n-            Map<String, CloudSubnet> publicSubnetsPerAz = subnetSelectorService.collectOnePublicSubnetPerAz(subnetMetas, minSubnetCountInDifferentAz);\n-            subnetSelectorService.collectSubnetsOfMissingAz(selectedSubnets, publicSubnetsPerAz, minSubnetCountInDifferentAz);\n-            if (selectedSubnets.size() < minSubnetCountInDifferentAz) {\n-                return new SubnetSelectionResult(String.format(NOT_ENOUGH_AZ, selectedSubnets.size(), minSubnetCountInDifferentAz));\n-            }\n+    public SubnetSelectionResult select(Collection<CloudSubnet> subnets) {\n+        List<CloudSubnet> result = subnetSelectorService.collectPrivateSubnets(subnets);\n+        LOGGER.info(\"Collected private subnets are: {}\", result);\n+        if (result.isEmpty()) {\n+            LOGGER.info(\"There are now private subnets in the environment, falling back to public subnets: {}\", subnets);", "originalCommit": "914388c768a9666101e77bad687aaa8ed44b202e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "06c74468cfb4d0486b5b26fefe89e4c833f4fd4f", "chunk": "diff --git a/cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetSelectorStrategyMultiplePreferPrivate.java b/cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetFilterStrategyMultiplePreferPrivate.java\nsimilarity index 76%\nrename from cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetSelectorStrategyMultiplePreferPrivate.java\nrename to cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetFilterStrategyMultiplePreferPrivate.java\nindex d27fe5d8da..6e668c6037 100644\n--- a/cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetSelectorStrategyMultiplePreferPrivate.java\n+++ b/cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetFilterStrategyMultiplePreferPrivate.java\n\n@@ -13,19 +13,19 @@ import com.sequenceiq.cloudbreak.cloud.model.CloudSubnet;\n import com.sequenceiq.cloudbreak.cloud.model.SubnetSelectionResult;\n \n @Component\n-public class SubnetSelectorStrategyMultiplePreferPrivate extends SubnetSelectorStrategy {\n+public class SubnetFilterStrategyMultiplePreferPrivate extends SubnetFilterStrategy {\n \n-    private static final Logger LOGGER = LoggerFactory.getLogger(SubnetSelectorStrategyMultiplePreferPrivate.class);\n+    private static final Logger LOGGER = LoggerFactory.getLogger(SubnetFilterStrategyMultiplePreferPrivate.class);\n \n     @Inject\n     private SubnetSelectorService subnetSelectorService;\n \n     @Override\n-    public SubnetSelectionResult select(Collection<CloudSubnet> subnets) {\n+    public SubnetSelectionResult filter(Collection<CloudSubnet> subnets) {\n         List<CloudSubnet> result = subnetSelectorService.collectPrivateSubnets(subnets);\n         LOGGER.info(\"Collected private subnets are: {}\", result);\n         if (result.isEmpty()) {\n-            LOGGER.info(\"There are now private subnets in the environment, falling back to public subnets: {}\", subnets);\n+            LOGGER.info(\"There are no private subnets in the environment, falling back to public subnets: {}\", subnets);\n             result = subnetSelectorService.collectPublicSubnets(subnets);\n             LOGGER.info(\"Collected public subnets are: {}\", result);\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA4Njk5NQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/7588#discussion_r393086995", "bodyText": "There are now => should read: There are no", "author": "gergopapi2", "createdAt": "2020-03-16T14:56:31Z", "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetSelectorStrategyMultiplePreferPublic.java", "diffHunk": "@@ -1,53 +1,39 @@\n package com.sequenceiq.cloudbreak.cloud.aws.service.subnetselector;\n \n-import java.util.ArrayList;\n+import java.util.Collection;\n import java.util.List;\n-import java.util.Map;\n \n import javax.inject.Inject;\n \n-import org.springframework.beans.factory.annotation.Value;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n import org.springframework.stereotype.Component;\n \n-import com.google.common.annotations.VisibleForTesting;\n import com.sequenceiq.cloudbreak.cloud.model.CloudSubnet;\n import com.sequenceiq.cloudbreak.cloud.model.SubnetSelectionResult;\n \n @Component\n public class SubnetSelectorStrategyMultiplePreferPublic extends SubnetSelectorStrategy {\n \n-    @VisibleForTesting\n-    @Value(\"${cb.aws.subnet.different.az.min:2}\")\n-    int minSubnetCountInDifferentAz;\n-\n-    @VisibleForTesting\n-    @Value(\"${cb.aws.subnet.different.az.max:3}\")\n-    int maxSubnetCountInDifferentAz;\n+    private static final Logger LOGGER = LoggerFactory.getLogger(SubnetSelectorStrategyMultiplePreferPublic.class);\n \n     @Inject\n     private SubnetSelectorService subnetSelectorService;\n \n     @Override\n-    protected SubnetSelectionResult selectInternal(List<CloudSubnet> subnetMetas) {\n-        Map<String, CloudSubnet> selectedSubnets = subnetSelectorService.collectOnePublicSubnetPerAz(subnetMetas, maxSubnetCountInDifferentAz);\n-        if (selectedSubnets.size() < minSubnetCountInDifferentAz) {\n-            Map<String, CloudSubnet> privateSubnetsPerAz = subnetSelectorService.collectOnePrivateSubnetPerAz(subnetMetas, maxSubnetCountInDifferentAz);\n-            subnetSelectorService.collectSubnetsOfMissingAz(selectedSubnets, privateSubnetsPerAz,\n-                    minSubnetCountInDifferentAz);\n-            if (selectedSubnets.size() < minSubnetCountInDifferentAz) {\n-                return new SubnetSelectionResult(String.format(NOT_ENOUGH_AZ, selectedSubnets.size(), minSubnetCountInDifferentAz));\n-            }\n+    public SubnetSelectionResult select(Collection<CloudSubnet> subnets) {\n+        List<CloudSubnet> result = subnetSelectorService.collectPublicSubnets(subnets);\n+        LOGGER.info(\"Collected pubic subnets are: {}\", result);\n+        if (result.isEmpty()) {\n+            LOGGER.info(\"There are now public subnets in the environment, falling back to private subnets: {}\", subnets);", "originalCommit": "914388c768a9666101e77bad687aaa8ed44b202e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "06c74468cfb4d0486b5b26fefe89e4c833f4fd4f", "chunk": "diff --git a/cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetSelectorStrategyMultiplePreferPublic.java b/cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetFilterStrategyMultiplePreferPublic.java\nsimilarity index 76%\nrename from cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetSelectorStrategyMultiplePreferPublic.java\nrename to cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetFilterStrategyMultiplePreferPublic.java\nindex 2995d3b4d0..854e956b09 100644\n--- a/cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetSelectorStrategyMultiplePreferPublic.java\n+++ b/cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetFilterStrategyMultiplePreferPublic.java\n\n@@ -13,19 +13,19 @@ import com.sequenceiq.cloudbreak.cloud.model.CloudSubnet;\n import com.sequenceiq.cloudbreak.cloud.model.SubnetSelectionResult;\n \n @Component\n-public class SubnetSelectorStrategyMultiplePreferPublic extends SubnetSelectorStrategy {\n+public class SubnetFilterStrategyMultiplePreferPublic extends SubnetFilterStrategy {\n \n-    private static final Logger LOGGER = LoggerFactory.getLogger(SubnetSelectorStrategyMultiplePreferPublic.class);\n+    private static final Logger LOGGER = LoggerFactory.getLogger(SubnetFilterStrategyMultiplePreferPublic.class);\n \n     @Inject\n     private SubnetSelectorService subnetSelectorService;\n \n     @Override\n-    public SubnetSelectionResult select(Collection<CloudSubnet> subnets) {\n+    public SubnetSelectionResult filter(Collection<CloudSubnet> subnets) {\n         List<CloudSubnet> result = subnetSelectorService.collectPublicSubnets(subnets);\n         LOGGER.info(\"Collected pubic subnets are: {}\", result);\n         if (result.isEmpty()) {\n-            LOGGER.info(\"There are now public subnets in the environment, falling back to private subnets: {}\", subnets);\n+            LOGGER.info(\"There are no public subnets in the environment, falling back to private subnets: {}\", subnets);\n             result = subnetSelectorService.collectPrivateSubnets(subnets);\n             LOGGER.info(\"Collected private subnets are: {}\", result);\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA5NTU1Ng==", "url": "https://github.com/hortonworks/cloudbreak/pull/7588#discussion_r393095556", "bodyText": "Consider the case we have 3 subnets:\nAZ-a: public (mapPublicIpOnLaunch=true)\nAZ-b: private\nAZ-c: private\nNow, the filter method would return AZ-a only. In this case the select step after the filter will throw an error because fallback private subnets are not present.\nA similar problem would be with the PreferPrivate variant.", "author": "gergopapi2", "createdAt": "2020-03-16T15:08:11Z", "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetSelectorStrategyMultiplePreferPublic.java", "diffHunk": "@@ -1,53 +1,39 @@\n package com.sequenceiq.cloudbreak.cloud.aws.service.subnetselector;\n \n-import java.util.ArrayList;\n+import java.util.Collection;\n import java.util.List;\n-import java.util.Map;\n \n import javax.inject.Inject;\n \n-import org.springframework.beans.factory.annotation.Value;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n import org.springframework.stereotype.Component;\n \n-import com.google.common.annotations.VisibleForTesting;\n import com.sequenceiq.cloudbreak.cloud.model.CloudSubnet;\n import com.sequenceiq.cloudbreak.cloud.model.SubnetSelectionResult;\n \n @Component\n public class SubnetSelectorStrategyMultiplePreferPublic extends SubnetSelectorStrategy {\n \n-    @VisibleForTesting\n-    @Value(\"${cb.aws.subnet.different.az.min:2}\")\n-    int minSubnetCountInDifferentAz;\n-\n-    @VisibleForTesting\n-    @Value(\"${cb.aws.subnet.different.az.max:3}\")\n-    int maxSubnetCountInDifferentAz;\n+    private static final Logger LOGGER = LoggerFactory.getLogger(SubnetSelectorStrategyMultiplePreferPublic.class);\n \n     @Inject\n     private SubnetSelectorService subnetSelectorService;\n \n     @Override\n-    protected SubnetSelectionResult selectInternal(List<CloudSubnet> subnetMetas) {\n-        Map<String, CloudSubnet> selectedSubnets = subnetSelectorService.collectOnePublicSubnetPerAz(subnetMetas, maxSubnetCountInDifferentAz);\n-        if (selectedSubnets.size() < minSubnetCountInDifferentAz) {\n-            Map<String, CloudSubnet> privateSubnetsPerAz = subnetSelectorService.collectOnePrivateSubnetPerAz(subnetMetas, maxSubnetCountInDifferentAz);\n-            subnetSelectorService.collectSubnetsOfMissingAz(selectedSubnets, privateSubnetsPerAz,\n-                    minSubnetCountInDifferentAz);\n-            if (selectedSubnets.size() < minSubnetCountInDifferentAz) {\n-                return new SubnetSelectionResult(String.format(NOT_ENOUGH_AZ, selectedSubnets.size(), minSubnetCountInDifferentAz));\n-            }\n+    public SubnetSelectionResult select(Collection<CloudSubnet> subnets) {\n+        List<CloudSubnet> result = subnetSelectorService.collectPublicSubnets(subnets);\n+        LOGGER.info(\"Collected pubic subnets are: {}\", result);\n+        if (result.isEmpty()) {", "originalCommit": "914388c768a9666101e77bad687aaa8ed44b202e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "06c74468cfb4d0486b5b26fefe89e4c833f4fd4f", "chunk": "diff --git a/cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetSelectorStrategyMultiplePreferPublic.java b/cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetFilterStrategyMultiplePreferPublic.java\nsimilarity index 76%\nrename from cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetSelectorStrategyMultiplePreferPublic.java\nrename to cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetFilterStrategyMultiplePreferPublic.java\nindex 2995d3b4d0..854e956b09 100644\n--- a/cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetSelectorStrategyMultiplePreferPublic.java\n+++ b/cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetFilterStrategyMultiplePreferPublic.java\n\n@@ -13,19 +13,19 @@ import com.sequenceiq.cloudbreak.cloud.model.CloudSubnet;\n import com.sequenceiq.cloudbreak.cloud.model.SubnetSelectionResult;\n \n @Component\n-public class SubnetSelectorStrategyMultiplePreferPublic extends SubnetSelectorStrategy {\n+public class SubnetFilterStrategyMultiplePreferPublic extends SubnetFilterStrategy {\n \n-    private static final Logger LOGGER = LoggerFactory.getLogger(SubnetSelectorStrategyMultiplePreferPublic.class);\n+    private static final Logger LOGGER = LoggerFactory.getLogger(SubnetFilterStrategyMultiplePreferPublic.class);\n \n     @Inject\n     private SubnetSelectorService subnetSelectorService;\n \n     @Override\n-    public SubnetSelectionResult select(Collection<CloudSubnet> subnets) {\n+    public SubnetSelectionResult filter(Collection<CloudSubnet> subnets) {\n         List<CloudSubnet> result = subnetSelectorService.collectPublicSubnets(subnets);\n         LOGGER.info(\"Collected pubic subnets are: {}\", result);\n         if (result.isEmpty()) {\n-            LOGGER.info(\"There are now public subnets in the environment, falling back to private subnets: {}\", subnets);\n+            LOGGER.info(\"There are no public subnets in the environment, falling back to private subnets: {}\", subnets);\n             result = subnetSelectorService.collectPrivateSubnets(subnets);\n             LOGGER.info(\"Collected private subnets are: {}\", result);\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA5NjIwMw==", "url": "https://github.com/hortonworks/cloudbreak/pull/7588#discussion_r393096203", "bodyText": "Since this is the filter step, I would rather rename it to SubnetFilterStrategy", "author": "gergopapi2", "createdAt": "2020-03-16T15:09:14Z", "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetSelectorStrategyMultiplePreferPublic.java", "diffHunk": "@@ -1,53 +1,39 @@\n package com.sequenceiq.cloudbreak.cloud.aws.service.subnetselector;\n \n-import java.util.ArrayList;\n+import java.util.Collection;\n import java.util.List;\n-import java.util.Map;\n \n import javax.inject.Inject;\n \n-import org.springframework.beans.factory.annotation.Value;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n import org.springframework.stereotype.Component;\n \n-import com.google.common.annotations.VisibleForTesting;\n import com.sequenceiq.cloudbreak.cloud.model.CloudSubnet;\n import com.sequenceiq.cloudbreak.cloud.model.SubnetSelectionResult;\n \n @Component\n public class SubnetSelectorStrategyMultiplePreferPublic extends SubnetSelectorStrategy {", "originalCommit": "914388c768a9666101e77bad687aaa8ed44b202e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "06c74468cfb4d0486b5b26fefe89e4c833f4fd4f", "chunk": "diff --git a/cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetSelectorStrategyMultiplePreferPublic.java b/cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetFilterStrategyMultiplePreferPublic.java\nsimilarity index 76%\nrename from cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetSelectorStrategyMultiplePreferPublic.java\nrename to cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetFilterStrategyMultiplePreferPublic.java\nindex 2995d3b4d0..854e956b09 100644\n--- a/cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetSelectorStrategyMultiplePreferPublic.java\n+++ b/cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetFilterStrategyMultiplePreferPublic.java\n\n@@ -13,19 +13,19 @@ import com.sequenceiq.cloudbreak.cloud.model.CloudSubnet;\n import com.sequenceiq.cloudbreak.cloud.model.SubnetSelectionResult;\n \n @Component\n-public class SubnetSelectorStrategyMultiplePreferPublic extends SubnetSelectorStrategy {\n+public class SubnetFilterStrategyMultiplePreferPublic extends SubnetFilterStrategy {\n \n-    private static final Logger LOGGER = LoggerFactory.getLogger(SubnetSelectorStrategyMultiplePreferPublic.class);\n+    private static final Logger LOGGER = LoggerFactory.getLogger(SubnetFilterStrategyMultiplePreferPublic.class);\n \n     @Inject\n     private SubnetSelectorService subnetSelectorService;\n \n     @Override\n-    public SubnetSelectionResult select(Collection<CloudSubnet> subnets) {\n+    public SubnetSelectionResult filter(Collection<CloudSubnet> subnets) {\n         List<CloudSubnet> result = subnetSelectorService.collectPublicSubnets(subnets);\n         LOGGER.info(\"Collected pubic subnets are: {}\", result);\n         if (result.isEmpty()) {\n-            LOGGER.info(\"There are now public subnets in the environment, falling back to private subnets: {}\", subnets);\n+            LOGGER.info(\"There are no public subnets in the environment, falling back to private subnets: {}\", subnets);\n             result = subnetSelectorService.collectPrivateSubnets(subnets);\n             LOGGER.info(\"Collected private subnets are: {}\", result);\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA5NjMzNg==", "url": "https://github.com/hortonworks/cloudbreak/pull/7588#discussion_r393096336", "bodyText": "I would rename it to filter.", "author": "gergopapi2", "createdAt": "2020-03-16T15:09:27Z", "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetSelectorStrategyMultiplePreferPublic.java", "diffHunk": "@@ -1,53 +1,39 @@\n package com.sequenceiq.cloudbreak.cloud.aws.service.subnetselector;\n \n-import java.util.ArrayList;\n+import java.util.Collection;\n import java.util.List;\n-import java.util.Map;\n \n import javax.inject.Inject;\n \n-import org.springframework.beans.factory.annotation.Value;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n import org.springframework.stereotype.Component;\n \n-import com.google.common.annotations.VisibleForTesting;\n import com.sequenceiq.cloudbreak.cloud.model.CloudSubnet;\n import com.sequenceiq.cloudbreak.cloud.model.SubnetSelectionResult;\n \n @Component\n public class SubnetSelectorStrategyMultiplePreferPublic extends SubnetSelectorStrategy {\n \n-    @VisibleForTesting\n-    @Value(\"${cb.aws.subnet.different.az.min:2}\")\n-    int minSubnetCountInDifferentAz;\n-\n-    @VisibleForTesting\n-    @Value(\"${cb.aws.subnet.different.az.max:3}\")\n-    int maxSubnetCountInDifferentAz;\n+    private static final Logger LOGGER = LoggerFactory.getLogger(SubnetSelectorStrategyMultiplePreferPublic.class);\n \n     @Inject\n     private SubnetSelectorService subnetSelectorService;\n \n     @Override\n-    protected SubnetSelectionResult selectInternal(List<CloudSubnet> subnetMetas) {\n-        Map<String, CloudSubnet> selectedSubnets = subnetSelectorService.collectOnePublicSubnetPerAz(subnetMetas, maxSubnetCountInDifferentAz);\n-        if (selectedSubnets.size() < minSubnetCountInDifferentAz) {\n-            Map<String, CloudSubnet> privateSubnetsPerAz = subnetSelectorService.collectOnePrivateSubnetPerAz(subnetMetas, maxSubnetCountInDifferentAz);\n-            subnetSelectorService.collectSubnetsOfMissingAz(selectedSubnets, privateSubnetsPerAz,\n-                    minSubnetCountInDifferentAz);\n-            if (selectedSubnets.size() < minSubnetCountInDifferentAz) {\n-                return new SubnetSelectionResult(String.format(NOT_ENOUGH_AZ, selectedSubnets.size(), minSubnetCountInDifferentAz));\n-            }\n+    public SubnetSelectionResult select(Collection<CloudSubnet> subnets) {", "originalCommit": "914388c768a9666101e77bad687aaa8ed44b202e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "06c74468cfb4d0486b5b26fefe89e4c833f4fd4f", "chunk": "diff --git a/cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetSelectorStrategyMultiplePreferPublic.java b/cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetFilterStrategyMultiplePreferPublic.java\nsimilarity index 76%\nrename from cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetSelectorStrategyMultiplePreferPublic.java\nrename to cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetFilterStrategyMultiplePreferPublic.java\nindex 2995d3b4d0..854e956b09 100644\n--- a/cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetSelectorStrategyMultiplePreferPublic.java\n+++ b/cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetFilterStrategyMultiplePreferPublic.java\n\n@@ -13,19 +13,19 @@ import com.sequenceiq.cloudbreak.cloud.model.CloudSubnet;\n import com.sequenceiq.cloudbreak.cloud.model.SubnetSelectionResult;\n \n @Component\n-public class SubnetSelectorStrategyMultiplePreferPublic extends SubnetSelectorStrategy {\n+public class SubnetFilterStrategyMultiplePreferPublic extends SubnetFilterStrategy {\n \n-    private static final Logger LOGGER = LoggerFactory.getLogger(SubnetSelectorStrategyMultiplePreferPublic.class);\n+    private static final Logger LOGGER = LoggerFactory.getLogger(SubnetFilterStrategyMultiplePreferPublic.class);\n \n     @Inject\n     private SubnetSelectorService subnetSelectorService;\n \n     @Override\n-    public SubnetSelectionResult select(Collection<CloudSubnet> subnets) {\n+    public SubnetSelectionResult filter(Collection<CloudSubnet> subnets) {\n         List<CloudSubnet> result = subnetSelectorService.collectPublicSubnets(subnets);\n         LOGGER.info(\"Collected pubic subnets are: {}\", result);\n         if (result.isEmpty()) {\n-            LOGGER.info(\"There are now public subnets in the environment, falling back to private subnets: {}\", subnets);\n+            LOGGER.info(\"There are no public subnets in the environment, falling back to private subnets: {}\", subnets);\n             result = subnetSelectorService.collectPrivateSubnets(subnets);\n             LOGGER.info(\"Collected private subnets are: {}\", result);\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzExMzAwMg==", "url": "https://github.com/hortonworks/cloudbreak/pull/7588#discussion_r393113002", "bodyText": "The result of filterSubnets is always used in conjunction with select (except for logging). I therefore would not put filterSubnets to the api but would make it a private implementation within AWS / Azure / Mock.", "author": "gergopapi2", "createdAt": "2020-03-16T15:33:04Z", "path": "cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/NetworkConnector.java", "diffHunk": "@@ -1,26 +1,99 @@\n package com.sequenceiq.cloudbreak.cloud;\n \n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.HashMap;\n import java.util.List;\n+import java.util.Map;\n+import java.util.Random;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n \n import com.sequenceiq.cloudbreak.cloud.model.CloudCredential;\n import com.sequenceiq.cloudbreak.cloud.model.CloudSubnet;\n import com.sequenceiq.cloudbreak.cloud.model.Network;\n import com.sequenceiq.cloudbreak.cloud.model.SubnetSelectionParameters;\n+import com.sequenceiq.cloudbreak.cloud.model.SubnetSelectionResult;\n import com.sequenceiq.cloudbreak.cloud.model.network.CreatedCloudNetwork;\n import com.sequenceiq.cloudbreak.cloud.model.network.NetworkCreationRequest;\n import com.sequenceiq.cloudbreak.cloud.model.network.NetworkDeletionRequest;\n-import com.sequenceiq.cloudbreak.cloud.model.SubnetSelectionResult;\n \n /**\n  * Network connectors.\n  */\n public interface NetworkConnector extends CloudPlatformAware {\n+    Logger LOGGER = LoggerFactory.getLogger(NetworkConnector.class);\n+\n+    String NOT_ENOUGH_AZ = \"Acceptable subnets are in %d different AZs, but subnets in %d different AZs required.\";\n \n     CreatedCloudNetwork createNetworkWithSubnets(NetworkCreationRequest networkCreationRequest);\n \n     void deleteNetworkWithSubnets(NetworkDeletionRequest networkDeletionRequest);\n \n     String getNetworkCidr(Network network, CloudCredential credential);\n \n-    SubnetSelectionResult selectSubnets(List<CloudSubnet> subnetMetas, SubnetSelectionParameters subnetSelectionParameters);\n+    SubnetSelectionResult filterSubnets(Collection<CloudSubnet> subnetMetas, SubnetSelectionParameters subnetSelectionParameters);", "originalCommit": "914388c768a9666101e77bad687aaa8ed44b202e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "454f20c51bcd3c4525836b4b7e64b07dc6046b06", "chunk": "diff --git a/cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/NetworkConnector.java b/cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/NetworkConnector.java\nindex a22e167268..d7050be315 100644\n--- a/cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/NetworkConnector.java\n+++ b/cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/NetworkConnector.java\n\n@@ -2,10 +2,12 @@ package com.sequenceiq.cloudbreak.cloud;\n \n import java.util.ArrayList;\n import java.util.Collection;\n-import java.util.HashMap;\n+import java.util.Collections;\n+import java.util.LinkedHashMap;\n import java.util.List;\n import java.util.Map;\n import java.util.Random;\n+import java.util.stream.Collectors;\n \n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzExMzk1NA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7588#discussion_r393113954", "bodyText": "I think there is enough logging within the selection logic, I would not list the result here again. If logging in the filter - selection is not enough, I would add it there.", "author": "gergopapi2", "createdAt": "2020-03-16T15:34:24Z", "path": "redbeams/src/main/java/com/sequenceiq/redbeams/service/network/SubnetChooserService.java", "diffHunk": "@@ -18,20 +21,25 @@\n @Service\n public class SubnetChooserService {\n \n+    private static final Logger LOGGER = LoggerFactory.getLogger(SubnetChooserService.class);\n+\n     @Inject\n     private CloudPlatformConnectors cloudPlatformConnectors;\n \n     public List<CloudSubnet> chooseSubnets(List<CloudSubnet> subnetMetas, CloudPlatform cloudPlatform, DBStack dbStack) {\n-        SubnetSelectionResult subnetSelectionResult =\n-                cloudPlatformConnectors.get(new CloudPlatformVariant(dbStack.getCloudPlatform(), dbStack.getPlatformVariant()))\n-                .networkConnector()\n-                .selectSubnets(\n-                        subnetMetas,\n-                        SubnetSelectionParameters.builder()\n-                                .withHa(dbStack.isHa())\n-                                .withForDatabase()\n-                                .build()\n-                );\n+        NetworkConnector networkConnector = cloudPlatformConnectors.get(new CloudPlatformVariant(dbStack.getCloudPlatform(), dbStack.getPlatformVariant()))\n+                .networkConnector();\n+        SubnetSelectionParameters build = SubnetSelectionParameters\n+                .builder()\n+                .withHa(dbStack.isHa())\n+                .withPreferPrivateIfExist()\n+                .build();\n+        SubnetSelectionResult subnetSelectionResult = networkConnector\n+                .filterSubnets(subnetMetas, build);\n+        LOGGER.info(\"Filtered subnets are: {}\", subnetSelectionResult);", "originalCommit": "914388c768a9666101e77bad687aaa8ed44b202e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "454f20c51bcd3c4525836b4b7e64b07dc6046b06", "chunk": "diff --git a/redbeams/src/main/java/com/sequenceiq/redbeams/service/network/SubnetChooserService.java b/redbeams/src/main/java/com/sequenceiq/redbeams/service/network/SubnetChooserService.java\nindex 1f7d137250..91011f2c2e 100644\n--- a/redbeams/src/main/java/com/sequenceiq/redbeams/service/network/SubnetChooserService.java\n+++ b/redbeams/src/main/java/com/sequenceiq/redbeams/service/network/SubnetChooserService.java\n\n@@ -36,10 +36,8 @@ public class SubnetChooserService {\n                 .build();\n         SubnetSelectionResult subnetSelectionResult = networkConnector\n                 .filterSubnets(subnetMetas, build);\n-        LOGGER.info(\"Filtered subnets are: {}\", subnetSelectionResult);\n         subnetSelectionResult = networkConnector\n                 .selectSubnets(subnetSelectionResult, build);\n-        LOGGER.info(\"Subnets after the selection are: {}\", subnetSelectionResult);\n         if (subnetSelectionResult.hasError()) {\n             throw new BadRequestException(subnetSelectionResult.getErrorMessage());\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzExNDA4OQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/7588#discussion_r393114089", "bodyText": "I would omit this logging, for the same reasons as above.", "author": "gergopapi2", "createdAt": "2020-03-16T15:34:38Z", "path": "redbeams/src/main/java/com/sequenceiq/redbeams/service/network/SubnetChooserService.java", "diffHunk": "@@ -18,20 +21,25 @@\n @Service\n public class SubnetChooserService {\n \n+    private static final Logger LOGGER = LoggerFactory.getLogger(SubnetChooserService.class);\n+\n     @Inject\n     private CloudPlatformConnectors cloudPlatformConnectors;\n \n     public List<CloudSubnet> chooseSubnets(List<CloudSubnet> subnetMetas, CloudPlatform cloudPlatform, DBStack dbStack) {\n-        SubnetSelectionResult subnetSelectionResult =\n-                cloudPlatformConnectors.get(new CloudPlatformVariant(dbStack.getCloudPlatform(), dbStack.getPlatformVariant()))\n-                .networkConnector()\n-                .selectSubnets(\n-                        subnetMetas,\n-                        SubnetSelectionParameters.builder()\n-                                .withHa(dbStack.isHa())\n-                                .withForDatabase()\n-                                .build()\n-                );\n+        NetworkConnector networkConnector = cloudPlatformConnectors.get(new CloudPlatformVariant(dbStack.getCloudPlatform(), dbStack.getPlatformVariant()))\n+                .networkConnector();\n+        SubnetSelectionParameters build = SubnetSelectionParameters\n+                .builder()\n+                .withHa(dbStack.isHa())\n+                .withPreferPrivateIfExist()\n+                .build();\n+        SubnetSelectionResult subnetSelectionResult = networkConnector\n+                .filterSubnets(subnetMetas, build);\n+        LOGGER.info(\"Filtered subnets are: {}\", subnetSelectionResult);\n+        subnetSelectionResult = networkConnector\n+                .selectSubnets(subnetSelectionResult, build);\n+        LOGGER.info(\"Subnets after the selection are: {}\", subnetSelectionResult);", "originalCommit": "914388c768a9666101e77bad687aaa8ed44b202e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "454f20c51bcd3c4525836b4b7e64b07dc6046b06", "chunk": "diff --git a/redbeams/src/main/java/com/sequenceiq/redbeams/service/network/SubnetChooserService.java b/redbeams/src/main/java/com/sequenceiq/redbeams/service/network/SubnetChooserService.java\nindex 1f7d137250..91011f2c2e 100644\n--- a/redbeams/src/main/java/com/sequenceiq/redbeams/service/network/SubnetChooserService.java\n+++ b/redbeams/src/main/java/com/sequenceiq/redbeams/service/network/SubnetChooserService.java\n\n@@ -36,10 +36,8 @@ public class SubnetChooserService {\n                 .build();\n         SubnetSelectionResult subnetSelectionResult = networkConnector\n                 .filterSubnets(subnetMetas, build);\n-        LOGGER.info(\"Filtered subnets are: {}\", subnetSelectionResult);\n         subnetSelectionResult = networkConnector\n                 .selectSubnets(subnetSelectionResult, build);\n-        LOGGER.info(\"Subnets after the selection are: {}\", subnetSelectionResult);\n         if (subnetSelectionResult.hasError()) {\n             throw new BadRequestException(subnetSelectionResult.getErrorMessage());\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzExNDc0OA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7588#discussion_r393114748", "bodyText": "I would omit logging here. It is present in the filter-select machinery.", "author": "gergopapi2", "createdAt": "2020-03-16T15:35:37Z", "path": "environment/src/main/java/com/sequenceiq/environment/network/service/SubnetIdProvider.java", "diffHunk": "@@ -31,9 +31,21 @@ public String provide(NetworkDto network, Tunnel tunnel, CloudPlatform cloudPlat\n             LOGGER.debug(\"Check failed, returning null\");\n             return null;\n         }\n-        SubnetSelectionResult subnetSelectionResult = cloudPlatformConnectors.get(new CloudPlatformVariant(cloudPlatform.name(), cloudPlatform.name()))\n-                .networkConnector()\n-                .selectSubnets(new ArrayList<>(network.getSubnetMetas().values()), SubnetSelectionParameters.builder().withTunnel(tunnel).build());\n+\n+        NetworkConnector networkConnector = cloudPlatformConnectors\n+                .get(new CloudPlatformVariant(cloudPlatform.name(), cloudPlatform.name()))\n+                .networkConnector();\n+        SubnetSelectionParameters subnetSelectionParameters = SubnetSelectionParameters\n+                .builder()\n+                .withTunnel(tunnel)\n+                .build();\n+\n+        SubnetSelectionResult subnetSelectionResult = networkConnector\n+                .filterSubnets(network.getSubnetMetas().values(), subnetSelectionParameters);\n+        LOGGER.info(\"Filtered subnets are: {}\", subnetSelectionResult);", "originalCommit": "914388c768a9666101e77bad687aaa8ed44b202e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "454f20c51bcd3c4525836b4b7e64b07dc6046b06", "chunk": "diff --git a/environment/src/main/java/com/sequenceiq/environment/network/service/SubnetIdProvider.java b/environment/src/main/java/com/sequenceiq/environment/network/service/SubnetIdProvider.java\nindex cf48747331..d294dbe9e8 100644\n--- a/environment/src/main/java/com/sequenceiq/environment/network/service/SubnetIdProvider.java\n+++ b/environment/src/main/java/com/sequenceiq/environment/network/service/SubnetIdProvider.java\n\n@@ -42,10 +42,8 @@ public class SubnetIdProvider {\n \n         SubnetSelectionResult subnetSelectionResult = networkConnector\n                 .filterSubnets(network.getSubnetMetas().values(), subnetSelectionParameters);\n-        LOGGER.info(\"Filtered subnets are: {}\", subnetSelectionResult);\n         subnetSelectionResult = networkConnector\n                 .selectSubnets(subnetSelectionResult, subnetSelectionParameters);\n-        LOGGER.info(\"Subnets after the selection are: {}\", subnetSelectionResult);\n         CloudSubnet selectedSubnet = subnetSelectionResult.hasResult()\n                 ? subnetSelectionResult.getResult().get(new Random().nextInt(subnetSelectionResult.getResult().size()))\n                 : fallback(network);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzExNTMyNQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/7588#discussion_r393115325", "bodyText": "I would log subnets here, should have been logged in the subnet filter-select machinery.", "author": "gergopapi2", "createdAt": "2020-03-16T15:36:20Z", "path": "environment/src/main/java/com/sequenceiq/environment/network/service/SubnetIdProvider.java", "diffHunk": "@@ -31,9 +31,21 @@ public String provide(NetworkDto network, Tunnel tunnel, CloudPlatform cloudPlat\n             LOGGER.debug(\"Check failed, returning null\");\n             return null;\n         }\n-        SubnetSelectionResult subnetSelectionResult = cloudPlatformConnectors.get(new CloudPlatformVariant(cloudPlatform.name(), cloudPlatform.name()))\n-                .networkConnector()\n-                .selectSubnets(new ArrayList<>(network.getSubnetMetas().values()), SubnetSelectionParameters.builder().withTunnel(tunnel).build());\n+\n+        NetworkConnector networkConnector = cloudPlatformConnectors\n+                .get(new CloudPlatformVariant(cloudPlatform.name(), cloudPlatform.name()))\n+                .networkConnector();\n+        SubnetSelectionParameters subnetSelectionParameters = SubnetSelectionParameters\n+                .builder()\n+                .withTunnel(tunnel)\n+                .build();\n+\n+        SubnetSelectionResult subnetSelectionResult = networkConnector\n+                .filterSubnets(network.getSubnetMetas().values(), subnetSelectionParameters);\n+        LOGGER.info(\"Filtered subnets are: {}\", subnetSelectionResult);\n+        subnetSelectionResult = networkConnector\n+                .selectSubnets(subnetSelectionResult, subnetSelectionParameters);\n+        LOGGER.info(\"Subnets after the selection are: {}\", subnetSelectionResult);", "originalCommit": "914388c768a9666101e77bad687aaa8ed44b202e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "454f20c51bcd3c4525836b4b7e64b07dc6046b06", "chunk": "diff --git a/environment/src/main/java/com/sequenceiq/environment/network/service/SubnetIdProvider.java b/environment/src/main/java/com/sequenceiq/environment/network/service/SubnetIdProvider.java\nindex cf48747331..d294dbe9e8 100644\n--- a/environment/src/main/java/com/sequenceiq/environment/network/service/SubnetIdProvider.java\n+++ b/environment/src/main/java/com/sequenceiq/environment/network/service/SubnetIdProvider.java\n\n@@ -42,10 +42,8 @@ public class SubnetIdProvider {\n \n         SubnetSelectionResult subnetSelectionResult = networkConnector\n                 .filterSubnets(network.getSubnetMetas().values(), subnetSelectionParameters);\n-        LOGGER.info(\"Filtered subnets are: {}\", subnetSelectionResult);\n         subnetSelectionResult = networkConnector\n                 .selectSubnets(subnetSelectionResult, subnetSelectionParameters);\n-        LOGGER.info(\"Subnets after the selection are: {}\", subnetSelectionResult);\n         CloudSubnet selectedSubnet = subnetSelectionResult.hasResult()\n                 ? subnetSelectionResult.getResult().get(new Random().nextInt(subnetSelectionResult.getResult().size()))\n                 : fallback(network);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzExNzg3Ng==", "url": "https://github.com/hortonworks/cloudbreak/pull/7588#discussion_r393117876", "bodyText": "I would not add these methods to the public api, as for now they are only relevant for AWS only. I would move them to AwsNetworkConnector.", "author": "gergopapi2", "createdAt": "2020-03-16T15:40:01Z", "path": "cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/NetworkConnector.java", "diffHunk": "@@ -1,26 +1,99 @@\n package com.sequenceiq.cloudbreak.cloud;\n \n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.HashMap;\n import java.util.List;\n+import java.util.Map;\n+import java.util.Random;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n \n import com.sequenceiq.cloudbreak.cloud.model.CloudCredential;\n import com.sequenceiq.cloudbreak.cloud.model.CloudSubnet;\n import com.sequenceiq.cloudbreak.cloud.model.Network;\n import com.sequenceiq.cloudbreak.cloud.model.SubnetSelectionParameters;\n+import com.sequenceiq.cloudbreak.cloud.model.SubnetSelectionResult;\n import com.sequenceiq.cloudbreak.cloud.model.network.CreatedCloudNetwork;\n import com.sequenceiq.cloudbreak.cloud.model.network.NetworkCreationRequest;\n import com.sequenceiq.cloudbreak.cloud.model.network.NetworkDeletionRequest;\n-import com.sequenceiq.cloudbreak.cloud.model.SubnetSelectionResult;\n \n /**\n  * Network connectors.\n  */\n public interface NetworkConnector extends CloudPlatformAware {\n+    Logger LOGGER = LoggerFactory.getLogger(NetworkConnector.class);\n+\n+    String NOT_ENOUGH_AZ = \"Acceptable subnets are in %d different AZs, but subnets in %d different AZs required.\";\n \n     CreatedCloudNetwork createNetworkWithSubnets(NetworkCreationRequest networkCreationRequest);\n \n     void deleteNetworkWithSubnets(NetworkDeletionRequest networkDeletionRequest);\n \n     String getNetworkCidr(Network network, CloudCredential credential);\n \n-    SubnetSelectionResult selectSubnets(List<CloudSubnet> subnetMetas, SubnetSelectionParameters subnetSelectionParameters);\n+    SubnetSelectionResult filterSubnets(Collection<CloudSubnet> subnetMetas, SubnetSelectionParameters subnetSelectionParameters);\n+\n+    int subnetCountInDifferentAzMin();", "originalCommit": "914388c768a9666101e77bad687aaa8ed44b202e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzI5MjM1NA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7588#discussion_r393292354", "bodyText": "it is also relevant for mock", "author": "doktoric", "createdAt": "2020-03-16T20:30:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzExNzg3Ng=="}], "type": "inlineReview", "revised_code": {"commit": "454f20c51bcd3c4525836b4b7e64b07dc6046b06", "chunk": "diff --git a/cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/NetworkConnector.java b/cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/NetworkConnector.java\nindex a22e167268..d7050be315 100644\n--- a/cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/NetworkConnector.java\n+++ b/cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/NetworkConnector.java\n\n@@ -2,10 +2,12 @@ package com.sequenceiq.cloudbreak.cloud;\n \n import java.util.ArrayList;\n import java.util.Collection;\n-import java.util.HashMap;\n+import java.util.Collections;\n+import java.util.LinkedHashMap;\n import java.util.List;\n import java.util.Map;\n import java.util.Random;\n+import java.util.stream.Collectors;\n \n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n"}}, {"oid": "73a738cf6f5aec53f51998efb4174ef38c22f5e3", "url": "https://github.com/hortonworks/cloudbreak/commit/73a738cf6f5aec53f51998efb4174ef38c22f5e3", "message": "CB-3864 subnet selection refactor", "committedDate": "2020-03-16T21:17:25Z", "type": "forcePushed"}, {"oid": "454f20c51bcd3c4525836b4b7e64b07dc6046b06", "url": "https://github.com/hortonworks/cloudbreak/commit/454f20c51bcd3c4525836b4b7e64b07dc6046b06", "message": "CB-3864 subnet selection refactor", "committedDate": "2020-03-16T21:18:06Z", "type": "forcePushed"}, {"oid": "06c74468cfb4d0486b5b26fefe89e4c833f4fd4f", "url": "https://github.com/hortonworks/cloudbreak/commit/06c74468cfb4d0486b5b26fefe89e4c833f4fd4f", "message": "CB-3864 subnet selection refactor", "committedDate": "2020-03-17T11:08:41Z", "type": "forcePushed"}, {"oid": "59d679f8ecbfcb293f81abf30459b289b9e2c899", "url": "https://github.com/hortonworks/cloudbreak/commit/59d679f8ecbfcb293f81abf30459b289b9e2c899", "message": "CB-3864 subnet selection refactor", "committedDate": "2020-03-17T16:28:44Z", "type": "forcePushed"}, {"oid": "3d8a304bd1b795e3fbf52a0ba3eb50426e447b5f", "url": "https://github.com/hortonworks/cloudbreak/commit/3d8a304bd1b795e3fbf52a0ba3eb50426e447b5f", "message": "CB-3864 subnet selection refactor", "committedDate": "2020-03-18T07:50:31Z", "type": "forcePushed"}, {"oid": "25910962a53430e80f9e5234d55d4206c76e8e9c", "url": "https://github.com/hortonworks/cloudbreak/commit/25910962a53430e80f9e5234d55d4206c76e8e9c", "message": "CB-3864 subnet selection refactor", "committedDate": "2020-03-18T08:51:27Z", "type": "forcePushed"}, {"oid": "75bfb0eade7e61c3c26ccee7abc847bac06f4344", "url": "https://github.com/hortonworks/cloudbreak/commit/75bfb0eade7e61c3c26ccee7abc847bac06f4344", "message": "CB-3864 subnet selection refactor", "committedDate": "2020-03-18T15:28:39Z", "type": "forcePushed"}, {"oid": "e0b86812d4c091c585dec331c5c79267362d4317", "url": "https://github.com/hortonworks/cloudbreak/commit/e0b86812d4c091c585dec331c5c79267362d4317", "message": "CB-3864 subnet selection refactor", "committedDate": "2020-03-19T09:34:24Z", "type": "forcePushed"}, {"oid": "89465ebd12bc3805a1981f4361965253df166da8", "url": "https://github.com/hortonworks/cloudbreak/commit/89465ebd12bc3805a1981f4361965253df166da8", "message": "CB-3864 subnet selection refactor", "committedDate": "2020-03-20T08:29:04Z", "type": "forcePushed"}, {"oid": "7857358ef2f9e7429e36646f8f2084b7cff2a7bb", "url": "https://github.com/hortonworks/cloudbreak/commit/7857358ef2f9e7429e36646f8f2084b7cff2a7bb", "message": "CB-3864 subnet selection refactor", "committedDate": "2020-03-20T09:57:54Z", "type": "forcePushed"}, {"oid": "cc597c24782995dab214e734776d4678de9aba17", "url": "https://github.com/hortonworks/cloudbreak/commit/cc597c24782995dab214e734776d4678de9aba17", "message": "CB-3864 subnet selection refactor", "committedDate": "2020-03-23T10:48:27Z", "type": "forcePushed"}, {"oid": "e9fdae747724991305ae6a0477170d8f25bfb1a1", "url": "https://github.com/hortonworks/cloudbreak/commit/e9fdae747724991305ae6a0477170d8f25bfb1a1", "message": "CB-3864 subnet selection refactor", "committedDate": "2020-03-23T16:47:05Z", "type": "forcePushed"}, {"oid": "a14c73661851bce28145e8d7c58beec525aaa3c2", "url": "https://github.com/hortonworks/cloudbreak/commit/a14c73661851bce28145e8d7c58beec525aaa3c2", "message": "CB-3864 subnet selection refactor", "committedDate": "2020-03-24T13:58:43Z", "type": "forcePushed"}, {"oid": "f00d0b87b413abf3cc8cadc09abe0ee5703989f1", "url": "https://github.com/hortonworks/cloudbreak/commit/f00d0b87b413abf3cc8cadc09abe0ee5703989f1", "message": "CB-3864 subnet selection refactor", "committedDate": "2020-03-24T15:56:59Z", "type": "forcePushed"}, {"oid": "1404121f8433c9713b39ce27f77dc9152db0f9ff", "url": "https://github.com/hortonworks/cloudbreak/commit/1404121f8433c9713b39ce27f77dc9152db0f9ff", "message": "CB-3864 subnet selection refactor", "committedDate": "2020-03-25T20:47:31Z", "type": "forcePushed"}, {"oid": "f0910fdc70217e85ba18db1abfb54a83d00f4bb7", "url": "https://github.com/hortonworks/cloudbreak/commit/f0910fdc70217e85ba18db1abfb54a83d00f4bb7", "message": "CB-3864 subnet selection refactor", "committedDate": "2020-03-26T07:43:57Z", "type": "commit"}, {"oid": "f0910fdc70217e85ba18db1abfb54a83d00f4bb7", "url": "https://github.com/hortonworks/cloudbreak/commit/f0910fdc70217e85ba18db1abfb54a83d00f4bb7", "message": "CB-3864 subnet selection refactor", "committedDate": "2020-03-26T07:43:57Z", "type": "forcePushed"}]}