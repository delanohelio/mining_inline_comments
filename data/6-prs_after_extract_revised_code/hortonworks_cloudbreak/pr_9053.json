{"pr_number": 9053, "pr_title": "CB-8901: Fix FreeIPA repair with a requested instance", "pr_createdAt": "2020-09-21T17:42:58Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/9053", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ4NzcyOA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9053#discussion_r492487728", "bodyText": "I don't think you need transaction here", "author": "lacikaaa", "createdAt": "2020-09-22T05:53:08Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/flow/stack/termination/action/TerminationService.java", "diffHunk": "@@ -91,6 +91,19 @@ public void finalizeTermination(Long stackId, List<String> instanceIds) {\n         }\n     }\n \n+    public void finalizeTerminationForInstancesWithoutInstanceIds(Long stackId) {\n+        try {\n+            transactionService.required(() -> {", "originalCommit": "b18c5b5695d0f8bf2f493dee3f3fcc2a3d30e65f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f51347f4ceef5c4e316e5a23118e0d50052995bb", "chunk": "diff --git a/freeipa/src/main/java/com/sequenceiq/freeipa/flow/stack/termination/action/TerminationService.java b/freeipa/src/main/java/com/sequenceiq/freeipa/flow/stack/termination/action/TerminationService.java\nindex 195f63084f..b84e0ed11e 100644\n--- a/freeipa/src/main/java/com/sequenceiq/freeipa/flow/stack/termination/action/TerminationService.java\n+++ b/freeipa/src/main/java/com/sequenceiq/freeipa/flow/stack/termination/action/TerminationService.java\n\n@@ -92,16 +92,8 @@ public class TerminationService {\n     }\n \n     public void finalizeTerminationForInstancesWithoutInstanceIds(Long stackId) {\n-        try {\n-            transactionService.required(() -> {\n-                Stack stack = stackService.getByIdWithListsInTransaction(stackId);\n-                terminateInstancesWithoutInstanceIds(stack);\n-                return null;\n-            });\n-        } catch (TransactionExecutionException ex) {\n-            LOGGER.info(\"Failed to terminate cluster infrastructure.\");\n-            throw new TerminationFailedException(ex);\n-        }\n+        Stack stack = stackService.getByIdWithListsInTransaction(stackId);\n+        terminateInstancesWithoutInstanceIds(stack);\n     }\n \n     private void terminateInstanceGroups(Stack stack) {\n"}}, {"oid": "f51347f4ceef5c4e316e5a23118e0d50052995bb", "url": "https://github.com/hortonworks/cloudbreak/commit/f51347f4ceef5c4e316e5a23118e0d50052995bb", "message": "CB-8901: Fix FreeIPA repair with a requested instance\n\nFix FreeIPA repair so that if there is an instance stuck in the\nrequsted state, the repair operation is able to succeed and it clean\nup as much as possible.\n\nThis was tested manully using a local instance of cloudbreak.", "committedDate": "2020-09-22T14:36:11Z", "type": "commit"}, {"oid": "f51347f4ceef5c4e316e5a23118e0d50052995bb", "url": "https://github.com/hortonworks/cloudbreak/commit/f51347f4ceef5c4e316e5a23118e0d50052995bb", "message": "CB-8901: Fix FreeIPA repair with a requested instance\n\nFix FreeIPA repair so that if there is an instance stuck in the\nrequsted state, the repair operation is able to succeed and it clean\nup as much as possible.\n\nThis was tested manully using a local instance of cloudbreak.", "committedDate": "2020-09-22T14:36:11Z", "type": "forcePushed"}]}