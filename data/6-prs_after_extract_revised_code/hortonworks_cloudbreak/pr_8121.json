{"pr_number": 8121, "pr_title": "CB-7104 Add resource based Auth for Freeipa api", "pr_createdAt": "2020-05-21T06:28:59Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/8121", "timeline": [{"oid": "824a00904ef6e5b45bfa4d373cdb4dfab2790d16", "url": "https://github.com/hortonworks/cloudbreak/commit/824a00904ef6e5b45bfa4d373cdb4dfab2790d16", "message": "CB-7104 Add resource based Auth for Freeipa api", "committedDate": "2020-05-21T06:36:09Z", "type": "forcePushed"}, {"oid": "a2ce477bcda66f384b903624f3b5f31e86bcedff", "url": "https://github.com/hortonworks/cloudbreak/commit/a2ce477bcda66f384b903624f3b5f31e86bcedff", "message": "CB-7104 Add resource based Auth for Freeipa api", "committedDate": "2020-05-21T07:38:18Z", "type": "forcePushed"}, {"oid": "8118e67f10d5758389294ce55bba3dbcc5df6612", "url": "https://github.com/hortonworks/cloudbreak/commit/8118e67f10d5758389294ce55bba3dbcc5df6612", "message": "CB-7104 Add resource based Auth for Freeipa api", "committedDate": "2020-05-21T14:41:53Z", "type": "forcePushed"}, {"oid": "a2a66bd8206e7dfb138c6d595b8b3fa5a1a0fa97", "url": "https://github.com/hortonworks/cloudbreak/commit/a2a66bd8206e7dfb138c6d595b8b3fa5a1a0fa97", "message": "CB-7104 Add resource based Auth for Freeipa api", "committedDate": "2020-05-21T16:15:44Z", "type": "forcePushed"}, {"oid": "ab017eec156381c78945ae8550f8378e4e79f7f5", "url": "https://github.com/hortonworks/cloudbreak/commit/ab017eec156381c78945ae8550f8378e4e79f7f5", "message": "CB-7104 Add resource based Auth for Freeipa api", "committedDate": "2020-05-22T09:25:42Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTMzMDA3OQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8121#discussion_r429330079", "bodyText": "User sync operations can apply to all environments in an account. This field is used to filter the environments and may be empty to indicate all environments. The SynchronizeAllUsersRequest does contain an accountID, but it is optional for backwards compatibility to callers that do not include it.\nIn short, there is no reliable way to get the account id from these user sync requests. I've made a suggestion in the UserV1Controller for a possible approach to work around this until we get a chance to redo all the user sync APIs to include either an resource crn", "author": "handavid", "createdAt": "2020-05-22T15:58:35Z", "path": "freeipa-api/src/main/java/com/sequenceiq/freeipa/api/v1/freeipa/user/model/SynchronizeOperationRequestBase.java", "diffHunk": "@@ -3,12 +3,16 @@\n import java.util.HashSet;\n import java.util.Set;\n \n+import com.sequenceiq.authorization.annotation.ResourceObjectField;\n+import com.sequenceiq.authorization.resource.AuthorizationResourceAction;\n+import com.sequenceiq.authorization.resource.AuthorizationVariableType;\n import com.sequenceiq.freeipa.api.v1.freeipa.user.doc.UserModelDescriptions;\n \n import io.swagger.annotations.ApiModelProperty;\n \n public class SynchronizeOperationRequestBase {\n     @ApiModelProperty(value = UserModelDescriptions.USERSYNC_ENVIRONMENT_CRNS)\n+    @ResourceObjectField(action = AuthorizationResourceAction.EDIT_ENVIRONMENT, variableType = AuthorizationVariableType.CRN_LIST)", "originalCommit": "ab017eec156381c78945ae8550f8378e4e79f7f5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM1MjExMA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8121#discussion_r429352110", "bodyText": "yes. this is one of many reasons why I would like to re-do the user sync APIs once I get a chance", "author": "handavid", "createdAt": "2020-05-22T16:47:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTMzMDA3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM1NzU4OQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8121#discussion_r429357589", "bodyText": "sorry i removed my comment because it was only partly true, but yes, it would be nice if at a time we/you would be able to redesign this to make it clearer", "author": "horadla23", "createdAt": "2020-05-22T16:59:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTMzMDA3OQ=="}], "type": "inlineReview", "revised_code": {"commit": "905a8de5c0ee6c394e58c09feed4830fe00a9049", "chunk": "diff --git a/freeipa-api/src/main/java/com/sequenceiq/freeipa/api/v1/freeipa/user/model/SynchronizeOperationRequestBase.java b/freeipa-api/src/main/java/com/sequenceiq/freeipa/api/v1/freeipa/user/model/SynchronizeOperationRequestBase.java\nindex e4f7610118..1ada75a910 100644\n--- a/freeipa-api/src/main/java/com/sequenceiq/freeipa/api/v1/freeipa/user/model/SynchronizeOperationRequestBase.java\n+++ b/freeipa-api/src/main/java/com/sequenceiq/freeipa/api/v1/freeipa/user/model/SynchronizeOperationRequestBase.java\n\n@@ -3,16 +3,12 @@ package com.sequenceiq.freeipa.api.v1.freeipa.user.model;\n import java.util.HashSet;\n import java.util.Set;\n \n-import com.sequenceiq.authorization.annotation.ResourceObjectField;\n-import com.sequenceiq.authorization.resource.AuthorizationResourceAction;\n-import com.sequenceiq.authorization.resource.AuthorizationVariableType;\n import com.sequenceiq.freeipa.api.v1.freeipa.user.doc.UserModelDescriptions;\n \n import io.swagger.annotations.ApiModelProperty;\n \n public class SynchronizeOperationRequestBase {\n     @ApiModelProperty(value = UserModelDescriptions.USERSYNC_ENVIRONMENT_CRNS)\n-    @ResourceObjectField(action = AuthorizationResourceAction.EDIT_ENVIRONMENT, variableType = AuthorizationVariableType.CRN_LIST)\n     private Set<String> environments = new HashSet<>();\n \n     public SynchronizeOperationRequestBase() {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM0MTkwNg==", "url": "https://github.com/hortonworks/cloudbreak/pull/8121#discussion_r429341906", "bodyText": "see my comment on the SyncOperationRequestBase for why we cannot reliable obtain the account id from the request objects.\nCan we treat the override methods as a facade, calculate the account id, then do the permission check? It's ugly and hopefully temporary until we fix this API.\nI didn't see an appropriate annotation for getting taking the account in as a parameter directly so there would have to be other changes to add account to the AuthorizationVariableType\n@Override\npublic SyncOperationStatus synchronizeUser(SynchronizeUserRequest request) {\n    String userCrn = checkUserCrn();\n    String accountId = ThreadBasedUserCrnProvider.getAccountId();\n    return internalSynchronizeUser(accountId, request);\n}\n\n@Override\n@CheckPermissionByResource(type = ACCOUNT_ID)\npublic SyncOperationStatus synchronizeUser(@ResourceObject String accountId, String actorCrn, SynchronizeUserRequest request) {\n    LOGGER.debug(\"synchronizeUser() requested for user {} in account {}\", userCrn, accountId);\n    ...\n}", "author": "handavid", "createdAt": "2020-05-22T16:28:16Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/controller/UserV1Controller.java", "diffHunk": "@@ -48,8 +50,8 @@\n     private OperationToSyncOperationStatus operationToSyncOperationStatus;\n \n     @Override\n-    @CheckPermissionByAccount(action = AuthorizationResourceAction.ENVIRONMENT_WRITE)\n-    public SyncOperationStatus synchronizeUser(SynchronizeUserRequest request) {\n+    @CheckPermissionByResourceObject", "originalCommit": "ab017eec156381c78945ae8550f8378e4e79f7f5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM0ODA3Mg==", "url": "https://github.com/hortonworks/cloudbreak/pull/8121#discussion_r429348072", "bodyText": "ah. I mistyped.\nThe second method signature should not be Override and can be private.", "author": "handavid", "createdAt": "2020-05-22T16:41:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM0MTkwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM0ODcyNQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8121#discussion_r429348725", "bodyText": "I did see the @CheckPermissionByAccount annotation, but doesn't that take the account from the ThreadBasedUserCrnProvider? If so, then that wouldn't work with internal actors.", "author": "handavid", "createdAt": "2020-05-22T16:43:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM0MTkwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM1NzkzMw==", "url": "https://github.com/hortonworks/cloudbreak/pull/8121#discussion_r429357933", "bodyText": "sorry i removed my comment here also, yes it gets accountid from ThreadBasedUserCrnProvider, in case of internal actors, it will be a problem, because TenantAwareParam can be applied for method parameter only.", "author": "horadla23", "createdAt": "2020-05-22T17:00:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM0MTkwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM1ODM1NQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8121#discussion_r429358355", "bodyText": "next week i'll think about these very special api methods (sync, setPassword) because it is hard to apply authz framework for these api methods", "author": "horadla23", "createdAt": "2020-05-22T17:01:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM0MTkwNg=="}], "type": "inlineReview", "revised_code": {"commit": "905a8de5c0ee6c394e58c09feed4830fe00a9049", "chunk": "diff --git a/freeipa/src/main/java/com/sequenceiq/freeipa/controller/UserV1Controller.java b/freeipa/src/main/java/com/sequenceiq/freeipa/controller/UserV1Controller.java\nindex 269d3cef2c..539fc2f39b 100644\n--- a/freeipa/src/main/java/com/sequenceiq/freeipa/controller/UserV1Controller.java\n+++ b/freeipa/src/main/java/com/sequenceiq/freeipa/controller/UserV1Controller.java\n\n@@ -50,8 +49,9 @@ public class UserV1Controller implements UserV1Endpoint {\n     private OperationToSyncOperationStatus operationToSyncOperationStatus;\n \n     @Override\n-    @CheckPermissionByResourceObject\n-    public SyncOperationStatus synchronizeUser(@ResourceObject SynchronizeUserRequest request) {\n+    // TODO we need to handle internal actors, and also the case when environments is empty and the sync will applied to all env in account\n+    @DisableCheckPermissions\n+    public SyncOperationStatus synchronizeUser(SynchronizeUserRequest request) {\n         String userCrn = checkUserCrn();\n         String accountId = ThreadBasedUserCrnProvider.getAccountId();\n         LOGGER.debug(\"synchronizeUser() requested for user {} in account {}\", userCrn, accountId);\n"}}, {"oid": "905a8de5c0ee6c394e58c09feed4830fe00a9049", "url": "https://github.com/hortonworks/cloudbreak/commit/905a8de5c0ee6c394e58c09feed4830fe00a9049", "message": "CB-7104 Add resource based Auth for Freeipa api", "committedDate": "2020-05-22T17:09:36Z", "type": "forcePushed"}, {"oid": "b5fe53d733aa43a564b2bac26cdad0fad9a0cd0f", "url": "https://github.com/hortonworks/cloudbreak/commit/b5fe53d733aa43a564b2bac26cdad0fad9a0cd0f", "message": "CB-7104 Add resource based Auth for Freeipa api", "committedDate": "2020-05-27T08:27:59Z", "type": "forcePushed"}, {"oid": "5e1abc2cd60a6aa43c2f496e078f5eec560e00dd", "url": "https://github.com/hortonworks/cloudbreak/commit/5e1abc2cd60a6aa43c2f496e078f5eec560e00dd", "message": "CB-7104 Add resource based Auth for Freeipa api", "committedDate": "2020-05-27T08:44:51Z", "type": "forcePushed"}, {"oid": "296fb03150ce4d626602eed9aa5bf23c5b52feef", "url": "https://github.com/hortonworks/cloudbreak/commit/296fb03150ce4d626602eed9aa5bf23c5b52feef", "message": "CB-7104 Add resource based Auth for Freeipa api", "committedDate": "2020-05-27T15:31:40Z", "type": "forcePushed"}, {"oid": "721a34f2335cc563c43d291fa2dd81e30d1c5c42", "url": "https://github.com/hortonworks/cloudbreak/commit/721a34f2335cc563c43d291fa2dd81e30d1c5c42", "message": "CB-7104 Add resource based Auth for Freeipa api", "committedDate": "2020-05-28T11:37:55Z", "type": "forcePushed"}, {"oid": "ca6964e4b808af664099d6d67e71387591a8833c", "url": "https://github.com/hortonworks/cloudbreak/commit/ca6964e4b808af664099d6d67e71387591a8833c", "message": "CB-7104 Add resource based Auth for Freeipa api", "committedDate": "2020-05-29T10:09:35Z", "type": "forcePushed"}, {"oid": "d787926bfeeff982cf9263806076a39d4cbbc632", "url": "https://github.com/hortonworks/cloudbreak/commit/d787926bfeeff982cf9263806076a39d4cbbc632", "message": "CB-7104 Add resource based Auth for Freeipa api", "committedDate": "2020-05-29T10:16:09Z", "type": "forcePushed"}, {"oid": "a574d093ed8c0f44d4da5ab4cadebaeddacd36c6", "url": "https://github.com/hortonworks/cloudbreak/commit/a574d093ed8c0f44d4da5ab4cadebaeddacd36c6", "message": "CB-7104 Add resource based Auth for Freeipa api", "committedDate": "2020-06-02T11:56:33Z", "type": "forcePushed"}, {"oid": "0122b5160275ecee5dec618b25f29b30067defbb", "url": "https://github.com/hortonworks/cloudbreak/commit/0122b5160275ecee5dec618b25f29b30067defbb", "message": "CB-7104 Add resource based Auth for Freeipa api", "committedDate": "2020-06-03T05:49:06Z", "type": "commit"}, {"oid": "0122b5160275ecee5dec618b25f29b30067defbb", "url": "https://github.com/hortonworks/cloudbreak/commit/0122b5160275ecee5dec618b25f29b30067defbb", "message": "CB-7104 Add resource based Auth for Freeipa api", "committedDate": "2020-06-03T05:49:06Z", "type": "forcePushed"}]}