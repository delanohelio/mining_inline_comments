{"pr_number": 9239, "pr_title": "CB-8227: Introduce a new entitlement to allow different Data Hub versions than Data Lake", "pr_createdAt": "2020-10-19T15:50:29Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/9239", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODIyNDY4NQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9239#discussion_r508224685", "bodyText": "I'm not sure about the blueprint version, because QE sometimes use the same blueprint for multiple runtime versions.", "author": "keyki", "createdAt": "2020-10-20T05:48:22Z", "path": "core/src/main/java/com/sequenceiq/cloudbreak/controller/StackCreatorService.java", "diffHunk": "@@ -178,6 +182,7 @@ public StackV4Response createStack(User user, Workspace workspace, StackV4Reques\n                 determineBlueprint(stackRequest, workspace),\n                 LOGGER,\n                 \"Stack request converted to stack took {} ms for stack {}\", stackName);\n+            validateBlueprintVersion(blueprint, stackRequest);", "originalCommit": "cd940537e9aba638bc24d60154a0af5b2233c64c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b97c7cfc7c9f96f1dfb4469e7449aafdbe2d6202", "chunk": "diff --git a/core/src/main/java/com/sequenceiq/cloudbreak/controller/StackCreatorService.java b/core/src/main/java/com/sequenceiq/cloudbreak/controller/StackCreatorService.java\nindex 3245b6893e..ca84cd73b5 100644\n--- a/core/src/main/java/com/sequenceiq/cloudbreak/controller/StackCreatorService.java\n+++ b/core/src/main/java/com/sequenceiq/cloudbreak/controller/StackCreatorService.java\n\n@@ -178,11 +178,11 @@ public class StackCreatorService {\n         MDCBuilder.buildMdcContext(stackStub);\n         Stack savedStack;\n         try {\n+            validateStackVersion(stackRequest);\n             Blueprint blueprint = measure(() ->\n                 determineBlueprint(stackRequest, workspace),\n                 LOGGER,\n                 \"Stack request converted to stack took {} ms for stack {}\", stackName);\n-            validateBlueprintVersion(blueprint, stackRequest);\n \n             Future<StatedImage> imgFromCatalogFuture = determineImageCatalog(stackName, platformString, stackRequest, blueprint, user, workspace);\n \n"}}, {"oid": "b97c7cfc7c9f96f1dfb4469e7449aafdbe2d6202", "url": "https://github.com/hortonworks/cloudbreak/commit/b97c7cfc7c9f96f1dfb4469e7449aafdbe2d6202", "message": "CB-8227: Introduce a new entitlement to allow different Data Hub versions than Data Lake", "committedDate": "2020-10-20T14:53:51Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODU4ODcxNw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9239#discussion_r508588717", "bodyText": "We shouldn't call the method param stackBlueprintVersion", "author": "keyki", "createdAt": "2020-10-20T15:05:08Z", "path": "core/src/main/java/com/sequenceiq/cloudbreak/controller/validation/stack/StackRuntimeVersionValidator.java", "diffHunk": "@@ -0,0 +1,69 @@\n+package com.sequenceiq.cloudbreak.controller.validation.stack;\n+\n+import static com.sequenceiq.cloudbreak.auth.ThreadBasedUserCrnProvider.INTERNAL_ACTOR_CRN;\n+\n+import java.util.List;\n+import java.util.Optional;\n+\n+import javax.inject.Inject;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+import com.sequenceiq.cloudbreak.api.endpoint.v4.stacks.request.StackV4Request;\n+import com.sequenceiq.cloudbreak.api.endpoint.v4.stacks.request.cluster.ClusterV4Request;\n+import com.sequenceiq.cloudbreak.api.endpoint.v4.stacks.request.cluster.cm.ClouderaManagerV4Request;\n+import com.sequenceiq.cloudbreak.api.endpoint.v4.stacks.request.cluster.repository.RepositoryV4Request;\n+import com.sequenceiq.cloudbreak.auth.ThreadBasedUserCrnProvider;\n+import com.sequenceiq.cloudbreak.auth.altus.EntitlementService;\n+import com.sequenceiq.cloudbreak.exception.BadRequestException;\n+import com.sequenceiq.cloudbreak.service.datalake.SdxClientService;\n+import com.sequenceiq.sdx.api.model.SdxClusterResponse;\n+\n+@Component\n+public class StackRuntimeVersionValidator {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(StackRuntimeVersionValidator.class);\n+\n+    @Inject\n+    private SdxClientService sdxClientService;\n+\n+    @Inject\n+    private EntitlementService entitlementService;\n+\n+    public void validate(StackV4Request stackRequest) {\n+        if (isDifferentDataHubAndDataLakeVersionAllowed()) {\n+            LOGGER.debug(\"The Data Hub version validation has been turned off with entitlement.\");\n+        } else {\n+            LOGGER.debug(\"Validating Data Hub version.\");\n+            findStackVersion(stackRequest).ifPresent(stackRuntimeVersion -> {\n+                List<SdxClusterResponse> sdxClusters = sdxClientService.getByEnvironmentCrn(stackRequest.getEnvironmentCrn());\n+                sdxClusters.forEach(sdx -> validateStackVersion(stackRuntimeVersion, sdx.getRuntime()));\n+            });\n+        }\n+\n+    }\n+\n+    private Optional<String> findStackVersion(StackV4Request stackRequest) {\n+        return Optional.of(stackRequest)\n+                .map(StackV4Request::getCluster)\n+                .map(ClusterV4Request::getCm)\n+                .map(ClouderaManagerV4Request::getRepository)\n+                .map(RepositoryV4Request::getVersion);\n+    }\n+\n+    private void validateStackVersion(String stackBlueprintVersion, String sdxRuntimeVersion) {", "originalCommit": "b97c7cfc7c9f96f1dfb4469e7449aafdbe2d6202", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f8b525f24dc89747c357adc802307256f4768300", "chunk": "diff --git a/core/src/main/java/com/sequenceiq/cloudbreak/controller/validation/stack/StackRuntimeVersionValidator.java b/core/src/main/java/com/sequenceiq/cloudbreak/controller/validation/stack/StackRuntimeVersionValidator.java\nindex 2fbec28f5d..a8bb46d2da 100644\n--- a/core/src/main/java/com/sequenceiq/cloudbreak/controller/validation/stack/StackRuntimeVersionValidator.java\n+++ b/core/src/main/java/com/sequenceiq/cloudbreak/controller/validation/stack/StackRuntimeVersionValidator.java\n\n@@ -17,6 +17,8 @@ import com.sequenceiq.cloudbreak.api.endpoint.v4.stacks.request.cluster.cm.Cloud\n import com.sequenceiq.cloudbreak.api.endpoint.v4.stacks.request.cluster.repository.RepositoryV4Request;\n import com.sequenceiq.cloudbreak.auth.ThreadBasedUserCrnProvider;\n import com.sequenceiq.cloudbreak.auth.altus.EntitlementService;\n+import com.sequenceiq.cloudbreak.cloud.model.catalog.Image;\n+import com.sequenceiq.cloudbreak.cloud.model.catalog.StackDetails;\n import com.sequenceiq.cloudbreak.exception.BadRequestException;\n import com.sequenceiq.cloudbreak.service.datalake.SdxClientService;\n import com.sequenceiq.sdx.api.model.SdxClusterResponse;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODU5MTI1Mw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9239#discussion_r508591253", "bodyText": "I think we might need to check the image as well. In the case of pre-warm image, the request won't contain the repository info, but the image id. In this case, we should check the version on the image if this is available at this point.", "author": "keyki", "createdAt": "2020-10-20T15:08:20Z", "path": "core/src/main/java/com/sequenceiq/cloudbreak/controller/validation/stack/StackRuntimeVersionValidator.java", "diffHunk": "@@ -0,0 +1,69 @@\n+package com.sequenceiq.cloudbreak.controller.validation.stack;\n+\n+import static com.sequenceiq.cloudbreak.auth.ThreadBasedUserCrnProvider.INTERNAL_ACTOR_CRN;\n+\n+import java.util.List;\n+import java.util.Optional;\n+\n+import javax.inject.Inject;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+import com.sequenceiq.cloudbreak.api.endpoint.v4.stacks.request.StackV4Request;\n+import com.sequenceiq.cloudbreak.api.endpoint.v4.stacks.request.cluster.ClusterV4Request;\n+import com.sequenceiq.cloudbreak.api.endpoint.v4.stacks.request.cluster.cm.ClouderaManagerV4Request;\n+import com.sequenceiq.cloudbreak.api.endpoint.v4.stacks.request.cluster.repository.RepositoryV4Request;\n+import com.sequenceiq.cloudbreak.auth.ThreadBasedUserCrnProvider;\n+import com.sequenceiq.cloudbreak.auth.altus.EntitlementService;\n+import com.sequenceiq.cloudbreak.exception.BadRequestException;\n+import com.sequenceiq.cloudbreak.service.datalake.SdxClientService;\n+import com.sequenceiq.sdx.api.model.SdxClusterResponse;\n+\n+@Component\n+public class StackRuntimeVersionValidator {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(StackRuntimeVersionValidator.class);\n+\n+    @Inject\n+    private SdxClientService sdxClientService;\n+\n+    @Inject\n+    private EntitlementService entitlementService;\n+\n+    public void validate(StackV4Request stackRequest) {\n+        if (isDifferentDataHubAndDataLakeVersionAllowed()) {\n+            LOGGER.debug(\"The Data Hub version validation has been turned off with entitlement.\");\n+        } else {\n+            LOGGER.debug(\"Validating Data Hub version.\");\n+            findStackVersion(stackRequest).ifPresent(stackRuntimeVersion -> {", "originalCommit": "b97c7cfc7c9f96f1dfb4469e7449aafdbe2d6202", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f8b525f24dc89747c357adc802307256f4768300", "chunk": "diff --git a/core/src/main/java/com/sequenceiq/cloudbreak/controller/validation/stack/StackRuntimeVersionValidator.java b/core/src/main/java/com/sequenceiq/cloudbreak/controller/validation/stack/StackRuntimeVersionValidator.java\nindex 2fbec28f5d..a8bb46d2da 100644\n--- a/core/src/main/java/com/sequenceiq/cloudbreak/controller/validation/stack/StackRuntimeVersionValidator.java\n+++ b/core/src/main/java/com/sequenceiq/cloudbreak/controller/validation/stack/StackRuntimeVersionValidator.java\n\n@@ -17,6 +17,8 @@ import com.sequenceiq.cloudbreak.api.endpoint.v4.stacks.request.cluster.cm.Cloud\n import com.sequenceiq.cloudbreak.api.endpoint.v4.stacks.request.cluster.repository.RepositoryV4Request;\n import com.sequenceiq.cloudbreak.auth.ThreadBasedUserCrnProvider;\n import com.sequenceiq.cloudbreak.auth.altus.EntitlementService;\n+import com.sequenceiq.cloudbreak.cloud.model.catalog.Image;\n+import com.sequenceiq.cloudbreak.cloud.model.catalog.StackDetails;\n import com.sequenceiq.cloudbreak.exception.BadRequestException;\n import com.sequenceiq.cloudbreak.service.datalake.SdxClientService;\n import com.sequenceiq.sdx.api.model.SdxClusterResponse;\n"}}, {"oid": "f8b525f24dc89747c357adc802307256f4768300", "url": "https://github.com/hortonworks/cloudbreak/commit/f8b525f24dc89747c357adc802307256f4768300", "message": "CB-8227: Introduce a new entitlement to allow different Data Hub versions than Data Lake", "committedDate": "2020-10-21T07:25:19Z", "type": "forcePushed"}, {"oid": "8ef4d390f6c29047f6b4efc7893534b4c069c7aa", "url": "https://github.com/hortonworks/cloudbreak/commit/8ef4d390f6c29047f6b4efc7893534b4c069c7aa", "message": "CB-8227: Introduce a new entitlement to allow different Data Hub versions than Data Lake", "committedDate": "2020-10-21T08:19:03Z", "type": "commit"}, {"oid": "8ef4d390f6c29047f6b4efc7893534b4c069c7aa", "url": "https://github.com/hortonworks/cloudbreak/commit/8ef4d390f6c29047f6b4efc7893534b4c069c7aa", "message": "CB-8227: Introduce a new entitlement to allow different Data Hub versions than Data Lake", "committedDate": "2020-10-21T08:19:03Z", "type": "forcePushed"}]}