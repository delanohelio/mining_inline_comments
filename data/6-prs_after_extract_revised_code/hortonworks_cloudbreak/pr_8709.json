{"pr_number": 8709, "pr_title": "CB-8213 [ASRG] dl and dh might leak resources in case of provisioning\u2026", "pr_createdAt": "2020-08-04T15:50:20Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/8709", "timeline": [{"oid": "f9e69d5ca2183a7c7a2faa35c7704aa577a24a1c", "url": "https://github.com/hortonworks/cloudbreak/commit/f9e69d5ca2183a7c7a2faa35c7704aa577a24a1c", "message": "CB-8213 [ASRG] dl and dh might leak resources in case of provisioning error\n\nIn case datalake of datahub is provisioned but some error comes up during stack provisioning then the created cloud resources might not be persisted into cloudbreak resources table. This leads to resource leakage in the azure single RG use case during deletion.", "committedDate": "2020-08-05T10:54:22Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTg0MzE4MQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8709#discussion_r465843181", "bodyText": "We should add log messages to this method about what's happening.", "author": "keyki", "createdAt": "2020-08-05T16:15:03Z", "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/AzureResourceConnector.java", "diffHunk": "@@ -141,6 +141,24 @@\n         return resources;\n     }\n \n+    private List<CloudResource> persistCloudResources(\n+            AuthenticatedContext ac, CloudStack stack, PersistenceNotifier notifier, CloudContext cloudContext, String stackName,\n+            String resourceGroupName, Deployment templateDeployment) {\n+        List<CloudResource> allResourcesToPersist = new ArrayList<>();\n+        List<CloudResource> instances;\n+        try {\n+            List<CloudResource> templateResources = azureCloudResourceService.getDeploymentCloudResources(templateDeployment);", "originalCommit": "f9e69d5ca2183a7c7a2faa35c7704aa577a24a1c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjE4MTM5Ng==", "url": "https://github.com/hortonworks/cloudbreak/pull/8709#discussion_r466181396", "bodyText": "Yes, I added some messages.", "author": "gergopapi2", "createdAt": "2020-08-06T06:48:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTg0MzE4MQ=="}], "type": "inlineReview", "revised_code": {"commit": "7d888dada682309f290f69d0f08625c8e8266f6c", "chunk": "diff --git a/cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/AzureResourceConnector.java b/cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/AzureResourceConnector.java\nindex e485dd9d06..c8830bb36a 100644\n--- a/cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/AzureResourceConnector.java\n+++ b/cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/AzureResourceConnector.java\n\n@@ -148,13 +148,16 @@ public class AzureResourceConnector extends AbstractResourceConnector {\n         List<CloudResource> instances;\n         try {\n             List<CloudResource> templateResources = azureCloudResourceService.getDeploymentCloudResources(templateDeployment);\n+            LOGGER.debug(\"Template resources retrieved: {}\", templateResources);\n             allResourcesToPersist.addAll(templateResources);\n             instances = azureCloudResourceService.getInstanceCloudResources(stackName, templateResources, stack.getGroups(), resourceGroupName);\n             List<CloudResource> osDiskResources = azureCloudResourceService.getAttachedOsDiskResources(ac, instances, resourceGroupName);\n+            LOGGER.debug(\"OS disk resources retrieved: {}\", osDiskResources);\n             allResourcesToPersist.addAll(osDiskResources);\n         } finally {\n             azureCloudResourceService.deleteCloudResources(notifier, cloudContext, allResourcesToPersist);\n             azureCloudResourceService.saveCloudResources(notifier, cloudContext, allResourcesToPersist);\n+            LOGGER.info(\"Resources persisted: {}\", allResourcesToPersist);\n         }\n         return instances;\n     }\n"}}, {"oid": "7d888dada682309f290f69d0f08625c8e8266f6c", "url": "https://github.com/hortonworks/cloudbreak/commit/7d888dada682309f290f69d0f08625c8e8266f6c", "message": "CB-8213 [ASRG] dl and dh might leak resources in case of provisioning error\n\nIn case datalake or datahub is provisioned but some error comes up during stack provisioning then the created cloud resources might not be persisted into cloudbreak resources table. This leads to resource leakage in the azure single RG use case during deletion.", "committedDate": "2020-08-06T06:45:43Z", "type": "commit"}, {"oid": "7d888dada682309f290f69d0f08625c8e8266f6c", "url": "https://github.com/hortonworks/cloudbreak/commit/7d888dada682309f290f69d0f08625c8e8266f6c", "message": "CB-8213 [ASRG] dl and dh might leak resources in case of provisioning error\n\nIn case datalake or datahub is provisioned but some error comes up during stack provisioning then the created cloud resources might not be persisted into cloudbreak resources table. This leads to resource leakage in the azure single RG use case during deletion.", "committedDate": "2020-08-06T06:45:43Z", "type": "forcePushed"}]}