{"pr_number": 8288, "pr_title": "CB-7225 Usersync and setpassword APIs should authorized in case of empty list too", "pr_createdAt": "2020-06-16T08:35:48Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/8288", "timeline": [{"oid": "d74180185d262a9c07a8ab9e0ae0d8f47aec9ea1", "url": "https://github.com/hortonworks/cloudbreak/commit/d74180185d262a9c07a8ab9e0ae0d8f47aec9ea1", "message": "CB-7225 Usersync and setpassword APIs should not handle empty env list", "committedDate": "2020-06-16T09:34:37Z", "type": "forcePushed"}, {"oid": "b42e21e65119f09457cf153fb70502ce6b68ca32", "url": "https://github.com/hortonworks/cloudbreak/commit/b42e21e65119f09457cf153fb70502ce6b68ca32", "message": "CB-7225 Usersync and setpassword APIs should not handle empty env list", "committedDate": "2020-06-17T09:38:43Z", "type": "forcePushed"}, {"oid": "ad7c42f948b25cc0b5376e56712e98e984bd7a70", "url": "https://github.com/hortonworks/cloudbreak/commit/ad7c42f948b25cc0b5376e56712e98e984bd7a70", "message": "CB-7225 Usersync and setpassword APIs should not handle empty env list", "committedDate": "2020-06-17T15:51:35Z", "type": "forcePushed"}, {"oid": "f90298057418e5b2251299ebc6cfef90df3e1408", "url": "https://github.com/hortonworks/cloudbreak/commit/f90298057418e5b2251299ebc6cfef90df3e1408", "message": "CB-7225 Usersync and setpassword APIs should not handle empty env list", "committedDate": "2020-06-18T15:34:16Z", "type": "forcePushed"}, {"oid": "cb4a1d65f677db07d86fa2a5185b0e0be2318db2", "url": "https://github.com/hortonworks/cloudbreak/commit/cb4a1d65f677db07d86fa2a5185b0e0be2318db2", "message": "CB-7225 Usersync and setpassword APIs should not handle empty env list", "committedDate": "2020-06-22T05:56:56Z", "type": "forcePushed"}, {"oid": "3883edfd204adb8477e81fa9fe8800b197d98ac9", "url": "https://github.com/hortonworks/cloudbreak/commit/3883edfd204adb8477e81fa9fe8800b197d98ac9", "message": "CB-7225 Usersync and setpassword APIs should not handle empty env list", "committedDate": "2020-06-22T09:16:16Z", "type": "forcePushed"}, {"oid": "0158cae02767cee9305af37bc5d4fc4322cdea9d", "url": "https://github.com/hortonworks/cloudbreak/commit/0158cae02767cee9305af37bc5d4fc4322cdea9d", "message": "CB-7225 Usersync and setpassword APIs should authorized in case of empty list too", "committedDate": "2020-06-22T09:43:55Z", "type": "forcePushed"}, {"oid": "ff61d10d7f6684b8896c138554897a84dcc19d4f", "url": "https://github.com/hortonworks/cloudbreak/commit/ff61d10d7f6684b8896c138554897a84dcc19d4f", "message": "CB-7225 Usersync and setpassword APIs should authorized in case of empty list too", "committedDate": "2020-06-22T10:52:03Z", "type": "forcePushed"}, {"oid": "b087aa31b34b85dfe14a61fbefb462d12afebe1b", "url": "https://github.com/hortonworks/cloudbreak/commit/b087aa31b34b85dfe14a61fbefb462d12afebe1b", "message": "CB-7225 Usersync and setpassword APIs should authorized in case of empty list too", "committedDate": "2020-06-22T11:19:44Z", "type": "forcePushed"}, {"oid": "a5e7315a7e2e5b7c89bcc349394a3491248dbad9", "url": "https://github.com/hortonworks/cloudbreak/commit/a5e7315a7e2e5b7c89bcc349394a3491248dbad9", "message": "CB-7225 Usersync and setpassword APIs should authorized in case of empty list too", "committedDate": "2020-06-22T11:28:01Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzYyMDI1MA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8288#discussion_r443620250", "bodyText": "I don't think we need the environmentCrnFilter here because we've already gotten the relevant stacks.", "author": "handavid", "createdAt": "2020-06-22T14:55:15Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/UserSyncService.java", "diffHunk": "@@ -102,15 +104,25 @@\n     @Inject\n     private WorkloadCredentialService workloadCredentialService;\n \n+    @Inject\n+    private CommonPermissionCheckingUtils commonPermissionCheckingUtils;\n+\n     public Operation synchronizeUsers(String accountId, String actorCrn, Set<String> environmentCrnFilter,\n             Set<String> userCrnFilter, Set<String> machineUserCrnFilter) {\n+        List<Stack> stacks = getStacksForSync(accountId, actorCrn, environmentCrnFilter, userCrnFilter, machineUserCrnFilter);\n+        return performSyncForStacks(accountId, actorCrn, environmentCrnFilter, userCrnFilter, machineUserCrnFilter, stacks);\n+    }\n \n-        validateParameters(accountId, actorCrn, environmentCrnFilter, userCrnFilter, machineUserCrnFilter);\n-        LOGGER.debug(\"Synchronizing users in account {} for environmentCrns {}, userCrns {}, and machineUserCrns {}\",\n-                accountId, environmentCrnFilter, userCrnFilter, machineUserCrnFilter);\n+    public Operation synchronizeUsersWithCustomPermissionCheck(String accountId, String actorCrn, Set<String> environmentCrnFilter,\n+            Set<String> userCrnFilter, Set<String> machineUserCrnFilter, AuthorizationResourceAction action) {\n+        List<Stack> stacks = getStacksForSync(accountId, actorCrn, environmentCrnFilter, userCrnFilter, machineUserCrnFilter);\n+        List<String> relatedEnvironmentCrns = stacks.stream().map(stack -> stack.getEnvironmentCrn()).collect(Collectors.toList());\n+        commonPermissionCheckingUtils.checkPermissionForUserOnResources(action, actorCrn, relatedEnvironmentCrns);\n+        return performSyncForStacks(accountId, actorCrn, environmentCrnFilter, userCrnFilter, machineUserCrnFilter, stacks);\n+    }\n \n-        List<Stack> stacks = stackService.getMultipleByEnvironmentCrnOrChildEnvironmantCrnAndAccountId(environmentCrnFilter, accountId);\n-        LOGGER.debug(\"Found {} stacks\", stacks.size());\n+    private Operation performSyncForStacks(String accountId, String actorCrn, Set<String> environmentCrnFilter,", "originalCommit": "a5e7315a7e2e5b7c89bcc349394a3491248dbad9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzYyNDAwMQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8288#discussion_r443624001", "bodyText": "ok!", "author": "horadla23", "createdAt": "2020-06-22T15:00:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzYyMDI1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzYyNjE2OA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8288#discussion_r443626168", "bodyText": "fixed", "author": "horadla23", "createdAt": "2020-06-22T15:03:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzYyMDI1MA=="}], "type": "inlineReview", "revised_code": {"commit": "0d372b8d880471beaa9c2eb50c6fc938bbf38a13", "chunk": "diff --git a/freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/UserSyncService.java b/freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/UserSyncService.java\nindex cad7e1304f..7f7021da0d 100644\n--- a/freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/UserSyncService.java\n+++ b/freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/UserSyncService.java\n\n@@ -110,7 +109,7 @@ public class UserSyncService {\n     public Operation synchronizeUsers(String accountId, String actorCrn, Set<String> environmentCrnFilter,\n             Set<String> userCrnFilter, Set<String> machineUserCrnFilter) {\n         List<Stack> stacks = getStacksForSync(accountId, actorCrn, environmentCrnFilter, userCrnFilter, machineUserCrnFilter);\n-        return performSyncForStacks(accountId, actorCrn, environmentCrnFilter, userCrnFilter, machineUserCrnFilter, stacks);\n+        return performSyncForStacks(accountId, actorCrn, userCrnFilter, machineUserCrnFilter, stacks);\n     }\n \n     public Operation synchronizeUsersWithCustomPermissionCheck(String accountId, String actorCrn, Set<String> environmentCrnFilter,\n"}}, {"oid": "0d372b8d880471beaa9c2eb50c6fc938bbf38a13", "url": "https://github.com/hortonworks/cloudbreak/commit/0d372b8d880471beaa9c2eb50c6fc938bbf38a13", "message": "CB-7225 Usersync and setpassword APIs should authorized in case of empty list too", "committedDate": "2020-06-22T15:02:29Z", "type": "commit"}, {"oid": "0d372b8d880471beaa9c2eb50c6fc938bbf38a13", "url": "https://github.com/hortonworks/cloudbreak/commit/0d372b8d880471beaa9c2eb50c6fc938bbf38a13", "message": "CB-7225 Usersync and setpassword APIs should authorized in case of empty list too", "committedDate": "2020-06-22T15:02:29Z", "type": "forcePushed"}]}