{"pr_number": 9019, "pr_title": "CB-8801 implement Redbeams and sdx force deletion. Tested with 1. env\u2026", "pr_createdAt": "2020-09-15T20:15:22Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/9019", "timeline": [{"oid": "eaeb61bca50b6ad28d907dd3b663950dc6be8c1f", "url": "https://github.com/hortonworks/cloudbreak/commit/eaeb61bca50b6ad28d907dd3b663950dc6be8c1f", "message": "CB-8801 implement Redbeams and sdx force deletion. Tested with 1. env deleted and sdx remained there with force delete 2. env is there with force delete 3. env is there and no force delete 4. env deleted and sdx remained there without force delete", "committedDate": "2020-09-16T07:30:12Z", "type": "forcePushed"}, {"oid": "8422d923dc55cb7293e63c83949a5de9e9490eda", "url": "https://github.com/hortonworks/cloudbreak/commit/8422d923dc55cb7293e63c83949a5de9e9490eda", "message": "CB-8801 implement Redbeams and sdx force deletion. Tested with 1. env deleted and sdx remained there with force delete 2. env is there with force delete 3. env is there and no force delete 4. env deleted and sdx remained there without force delete", "committedDate": "2020-09-16T09:57:47Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDEyNDMwOQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9019#discussion_r490124309", "bodyText": "I think it is not a good idea to check \"forced\" flag here. It would be a better approach if we handle it separately in stack deletion and rds deletion phase. With this implementation, it can hide many error which is not related to stack or rds delete. For example there is a nullpointer exception somewhere, then it will set sdx to delete status but it should not happen. We can move a logic like this into StackDeletionHandler and RdsDeletionHandler.", "author": "sodre90", "createdAt": "2020-09-17T10:02:42Z", "path": "datalake/src/main/java/com/sequenceiq/datalake/flow/delete/SdxDeleteActions.java", "diffHunk": "@@ -169,14 +169,24 @@ protected void doExecute(SdxContext context, SdxDeletionFailedEvent payload, Map\n                 if (exception.getMessage() != null) {\n                     statusReason = exception.getMessage();\n                 }\n-                try {\n-                    SdxCluster sdxCluster = sdxStatusService.setStatusForDatalakeAndNotify(DatalakeStatusEnum.DELETE_FAILED, statusReason,\n-                            payload.getResourceId());\n-                    metricService.incrementMetricCounter(MetricType.SDX_DELETION_FAILED, sdxCluster);\n-                } catch (NotFoundException notFoundException) {\n-                    LOGGER.info(\"Can not set status to SDX_DELETION_FAILED because data lake was not found\");\n+                if (payload.isForced()) {", "originalCommit": "8422d923dc55cb7293e63c83949a5de9e9490eda", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "334a1fedeb2d45a911af67ff709df8f0b35a5a2f", "chunk": "diff --git a/datalake/src/main/java/com/sequenceiq/datalake/flow/delete/SdxDeleteActions.java b/datalake/src/main/java/com/sequenceiq/datalake/flow/delete/SdxDeleteActions.java\nindex 4f16eacce7..024e236780 100644\n--- a/datalake/src/main/java/com/sequenceiq/datalake/flow/delete/SdxDeleteActions.java\n+++ b/datalake/src/main/java/com/sequenceiq/datalake/flow/delete/SdxDeleteActions.java\n\n@@ -169,24 +169,14 @@ public class SdxDeleteActions {\n                 if (exception.getMessage() != null) {\n                     statusReason = exception.getMessage();\n                 }\n-                if (payload.isForced()) {\n-                    Long datalakeId = payload.getResourceId();\n-                    LOGGER.info(\"Datalake delete finalized: {}\", datalakeId);\n-                    SdxCluster sdxCluster = sdxService.getById(datalakeId);\n-                    if (sdxCluster != null) {\n-                        metricService.incrementMetricCounter(MetricType.SDX_DELETION_FINISHED, sdxCluster);\n-                    }\n-                    sendEvent(context, SDX_DELETE_FINALIZED_EVENT.event(), payload);\n-                } else {\n-                    try {\n-                        SdxCluster sdxCluster = sdxStatusService.setStatusForDatalakeAndNotify(DatalakeStatusEnum.DELETE_FAILED, statusReason,\n-                                payload.getResourceId());\n-                        metricService.incrementMetricCounter(MetricType.SDX_DELETION_FAILED, sdxCluster);\n-                    } catch (NotFoundException notFoundException) {\n-                        LOGGER.info(\"Can not set status to SDX_DELETION_FAILED because data lake was not found\");\n-                    }\n-                    sendEvent(context, SDX_DELETE_FAILED_HANDLED_EVENT.event(), payload);\n+                try {\n+                    SdxCluster sdxCluster = sdxStatusService.setStatusForDatalakeAndNotify(DatalakeStatusEnum.DELETE_FAILED, statusReason,\n+                            payload.getResourceId());\n+                    metricService.incrementMetricCounter(MetricType.SDX_DELETION_FAILED, sdxCluster);\n+                } catch (NotFoundException notFoundException) {\n+                    LOGGER.info(\"Can not set status to SDX_DELETION_FAILED because data lake was not found\");\n                 }\n+                sendEvent(context, SDX_DELETE_FAILED_HANDLED_EVENT.event(), payload);\n             }\n \n             @Override\n"}}, {"oid": "334a1fedeb2d45a911af67ff709df8f0b35a5a2f", "url": "https://github.com/hortonworks/cloudbreak/commit/334a1fedeb2d45a911af67ff709df8f0b35a5a2f", "message": "CB-8801 implement Redbeams and sdx force deletion. Tested with 1. env deleted and sdx remained there with force delete 2. env is there with force delete 3. env is there and no force delete 4. env deleted and sdx remained there without force delete", "committedDate": "2020-09-18T10:30:58Z", "type": "commit"}, {"oid": "334a1fedeb2d45a911af67ff709df8f0b35a5a2f", "url": "https://github.com/hortonworks/cloudbreak/commit/334a1fedeb2d45a911af67ff709df8f0b35a5a2f", "message": "CB-8801 implement Redbeams and sdx force deletion. Tested with 1. env deleted and sdx remained there with force delete 2. env is there with force delete 3. env is there and no force delete 4. env deleted and sdx remained there without force delete", "committedDate": "2020-09-18T10:30:58Z", "type": "forcePushed"}]}