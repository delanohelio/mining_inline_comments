{"pr_number": 8988, "pr_title": "CDPCP-2998. Support deleted user as part of user sync", "pr_createdAt": "2020-09-10T18:34:35Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/8988", "timeline": [{"oid": "df6fe7b6723ac58edb359f5c948af3f6e861e666", "url": "https://github.com/hortonworks/cloudbreak/commit/df6fe7b6723ac58edb359f5c948af3f6e861e666", "message": "CDPCP-2998. Support deleted user as part of user sync\n\nThis updates the existing synchronizeAllUsers request to\nallow specifying a single workload user to be deleted\nfrom the freeipa. Currently this won't remove CM ranger\ncloud identities (azure object ids). That will come in\na following commit.", "committedDate": "2020-09-10T19:08:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjYwNzI0OQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8988#discussion_r486607249", "bodyText": "I think we want to be clear that this is a workload username, not a user crn, username, etc.\nWe should also indicate that this workload username corresponds to the single user or machine user crn in the filters.", "author": "handavid", "createdAt": "2020-09-10T20:14:55Z", "path": "freeipa-api/src/main/java/com/sequenceiq/freeipa/api/v1/freeipa/user/doc/UserModelDescriptions.java", "diffHunk": "@@ -6,6 +6,7 @@\n     public static final String USERSYNC_ENVIRONMENT_CRNS = \"Optional environment crns to sync\";\n     public static final String USERSYNC_USER_CRNS = \"Optional user crns to sync\";\n     public static final String USERSYNC_MACHINEUSER_CRNS = \"Optional machine user crns to sync\";\n+    public static final String DELETED_WORKLOAD_USER = \"An Optional workload user to be deleted\";", "originalCommit": "df6fe7b6723ac58edb359f5c948af3f6e861e666", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY5MjAzNQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8988#discussion_r486692035", "bodyText": "Okay, I've updated it. Since we're planning on moving to newer endpoints soon, I wasn't worrying too much about usability here.", "author": "aarman-cloudera", "createdAt": "2020-09-10T23:42:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjYwNzI0OQ=="}], "type": "inlineReview", "revised_code": {"commit": "6f61dd42fb0b819c9744528540c998fdc3b06565", "chunk": "diff --git a/freeipa-api/src/main/java/com/sequenceiq/freeipa/api/v1/freeipa/user/doc/UserModelDescriptions.java b/freeipa-api/src/main/java/com/sequenceiq/freeipa/api/v1/freeipa/user/doc/UserModelDescriptions.java\nindex f4c4097732..8238439d42 100644\n--- a/freeipa-api/src/main/java/com/sequenceiq/freeipa/api/v1/freeipa/user/doc/UserModelDescriptions.java\n+++ b/freeipa-api/src/main/java/com/sequenceiq/freeipa/api/v1/freeipa/user/doc/UserModelDescriptions.java\n\n@@ -6,7 +6,8 @@ public class UserModelDescriptions {\n     public static final String USERSYNC_ENVIRONMENT_CRNS = \"Optional environment crns to sync\";\n     public static final String USERSYNC_USER_CRNS = \"Optional user crns to sync\";\n     public static final String USERSYNC_MACHINEUSER_CRNS = \"Optional machine user crns to sync\";\n-    public static final String DELETED_WORKLOAD_USER = \"An Optional workload user to be deleted\";\n+    public static final String DELETED_WORKLOAD_USER = \"An Optional workload user name to be deleted. When this is included, there should also be\" +\n+            \" exactly 1 crn in the machineUsers or users set that coreesponds to the deleted workload user.\";\n     public static final String USERSYNC_ID = \"User synchronization operation id\";\n     public static final String USERSYNC_STATUS = \"User synchronization operation status\";\n     public static final String USERSYNC_STARTTIME = \"User synchronization operation start time\";\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjYxMzQ3MQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8988#discussion_r486613471", "bodyText": "validateParameters should be updated for your userSyncRequestFilter including the users+machineUsers size when a deletedWorkloadUsername is included", "author": "handavid", "createdAt": "2020-09-10T20:26:50Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/UserSyncService.java", "diffHunk": "@@ -184,11 +187,9 @@ private void logAffectedStacks(List<Stack> stacks) {\n         LOGGER.info(\"Affected stacks: {}\", stacksAffected);\n     }\n \n-    private List<Stack> getStacksForSync(String accountId, String actorCrn, Set<String> environmentCrnFilter,\n-            Set<String> userCrnFilter, Set<String> machineUserCrnFilter) {\n-        validateParameters(accountId, actorCrn, environmentCrnFilter, userCrnFilter, machineUserCrnFilter);\n-        LOGGER.debug(\"Synchronizing users in account {} for environmentCrns {}, userCrns {}, and machineUserCrns {}\",\n-                accountId, environmentCrnFilter, userCrnFilter, machineUserCrnFilter);\n+    private List<Stack> getStacksForSync(String accountId, String actorCrn, Set<String> environmentCrnFilter, UserSyncRequestFilter useSyncFilter) {\n+        validateParameters(accountId, actorCrn, environmentCrnFilter, useSyncFilter.getUserCrnFilter(), useSyncFilter.getMachineUserCrnFilter());", "originalCommit": "df6fe7b6723ac58edb359f5c948af3f6e861e666", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY5NjI4Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/8988#discussion_r486696287", "bodyText": "Ah, this check was in the constructor, but I can move it to here instead.", "author": "aarman-cloudera", "createdAt": "2020-09-10T23:56:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjYxMzQ3MQ=="}], "type": "inlineReview", "revised_code": {"commit": "6f61dd42fb0b819c9744528540c998fdc3b06565", "chunk": "diff --git a/freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/UserSyncService.java b/freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/UserSyncService.java\nindex 1da848c36d..fa6a2eedeb 100644\n--- a/freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/UserSyncService.java\n+++ b/freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/UserSyncService.java\n\n@@ -187,9 +187,10 @@ public class UserSyncService {\n         LOGGER.info(\"Affected stacks: {}\", stacksAffected);\n     }\n \n-    private List<Stack> getStacksForSync(String accountId, String actorCrn, Set<String> environmentCrnFilter, UserSyncRequestFilter useSyncFilter) {\n-        validateParameters(accountId, actorCrn, environmentCrnFilter, useSyncFilter.getUserCrnFilter(), useSyncFilter.getMachineUserCrnFilter());\n-        LOGGER.debug(\"Synchronizing users in account {} for environmentCrns {}, user sync filter {}\", accountId, environmentCrnFilter, useSyncFilter);\n+    private List<Stack> getStacksForSync(String accountId, String actorCrn, Set<String> environmentCrnFilter, UserSyncRequestFilter userSyncRequestFilter) {\n+        validateParameters(accountId, actorCrn, environmentCrnFilter, userSyncRequestFilter.getUserCrnFilter(),\n+                userSyncRequestFilter.getMachineUserCrnFilter(), userSyncRequestFilter.getDeletedWorkloadUser());\n+        LOGGER.debug(\"Synchronizing users in account {} for environmentCrns {}, user sync filter {}\", accountId, environmentCrnFilter, userSyncRequestFilter);\n \n         List<Stack> stacks = stackService.getMultipleByEnvironmentCrnOrChildEnvironmantCrnAndAccountId(environmentCrnFilter, accountId);\n         if (stacks.isEmpty()) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjYxMzY1MQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8988#discussion_r486613651", "bodyText": "useSyncFilter --> userSyncRequestFilter", "author": "handavid", "createdAt": "2020-09-10T20:27:10Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/UserSyncService.java", "diffHunk": "@@ -184,11 +187,9 @@ private void logAffectedStacks(List<Stack> stacks) {\n         LOGGER.info(\"Affected stacks: {}\", stacksAffected);\n     }\n \n-    private List<Stack> getStacksForSync(String accountId, String actorCrn, Set<String> environmentCrnFilter,\n-            Set<String> userCrnFilter, Set<String> machineUserCrnFilter) {\n-        validateParameters(accountId, actorCrn, environmentCrnFilter, userCrnFilter, machineUserCrnFilter);\n-        LOGGER.debug(\"Synchronizing users in account {} for environmentCrns {}, userCrns {}, and machineUserCrns {}\",\n-                accountId, environmentCrnFilter, userCrnFilter, machineUserCrnFilter);\n+    private List<Stack> getStacksForSync(String accountId, String actorCrn, Set<String> environmentCrnFilter, UserSyncRequestFilter useSyncFilter) {", "originalCommit": "df6fe7b6723ac58edb359f5c948af3f6e861e666", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6f61dd42fb0b819c9744528540c998fdc3b06565", "chunk": "diff --git a/freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/UserSyncService.java b/freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/UserSyncService.java\nindex 1da848c36d..fa6a2eedeb 100644\n--- a/freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/UserSyncService.java\n+++ b/freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/UserSyncService.java\n\n@@ -187,9 +187,10 @@ public class UserSyncService {\n         LOGGER.info(\"Affected stacks: {}\", stacksAffected);\n     }\n \n-    private List<Stack> getStacksForSync(String accountId, String actorCrn, Set<String> environmentCrnFilter, UserSyncRequestFilter useSyncFilter) {\n-        validateParameters(accountId, actorCrn, environmentCrnFilter, useSyncFilter.getUserCrnFilter(), useSyncFilter.getMachineUserCrnFilter());\n-        LOGGER.debug(\"Synchronizing users in account {} for environmentCrns {}, user sync filter {}\", accountId, environmentCrnFilter, useSyncFilter);\n+    private List<Stack> getStacksForSync(String accountId, String actorCrn, Set<String> environmentCrnFilter, UserSyncRequestFilter userSyncRequestFilter) {\n+        validateParameters(accountId, actorCrn, environmentCrnFilter, userSyncRequestFilter.getUserCrnFilter(),\n+                userSyncRequestFilter.getMachineUserCrnFilter(), userSyncRequestFilter.getDeletedWorkloadUser());\n+        LOGGER.debug(\"Synchronizing users in account {} for environmentCrns {}, user sync filter {}\", accountId, environmentCrnFilter, userSyncRequestFilter);\n \n         List<Stack> stacks = stackService.getMultipleByEnvironmentCrnOrChildEnvironmantCrnAndAccountId(environmentCrnFilter, accountId);\n         if (stacks.isEmpty()) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjYxNjA3NA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8988#discussion_r486616074", "bodyText": "I don't see a matching Finished log for USER_SYNC_DELETE. I think you need to move this logging into internalSynchronizeStackForDeleteUser", "author": "handavid", "createdAt": "2020-09-10T20:31:53Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/UserSyncService.java", "diffHunk": "@@ -243,20 +242,30 @@ private void internalSynchronizeUsers(String operationId, String accountId, Stri\n \n             LogEvent logUserSyncEvent = fullSync ? LogEvent.FULL_USER_SYNC : LogEvent.PARTIAL_USER_SYNC;\n             LOGGER.info(\"Starting {} for environments {} with operationId {} ...\", logUserSyncEvent, environmentCrns, operationId);\n-            LogEvent logRetrieveUmsEvent = fullSync ? LogEvent.RETRIEVE_FULL_UMS_STATE : LogEvent.RETRIEVE_PARTIAL_UMS_STATE;\n-            LOGGER.debug(\"Starting {} for environments {} ...\", logRetrieveUmsEvent, environmentCrns);\n-            Map<String, UmsUsersState> envToUmsStateMap = umsUsersStateProvider\n-                    .getEnvToUmsUsersStateMap(accountId, actorCrn, environmentCrns, userCrnFilter, machineUserCrnFilter, requestId);\n-            LOGGER.debug(\"Finished {}.\", logRetrieveUmsEvent);\n+\n+            Map<String, Future<SyncStatusDetail>> statusFutures;\n+\n+            if (userSyncFilter.getDeletedWorkloadUser().isEmpty()) {\n+                LogEvent logRetrieveUmsEvent = fullSync ? LogEvent.RETRIEVE_FULL_UMS_STATE : LogEvent.RETRIEVE_PARTIAL_UMS_STATE;\n+                LOGGER.debug(\"Starting {} for environments {} ...\", logRetrieveUmsEvent, environmentCrns);\n+                Map<String, UmsUsersState> envToUmsStateMap = umsUsersStateProvider\n+                        .getEnvToUmsUsersStateMap(accountId, actorCrn, environmentCrns, userSyncFilter.getUserCrnFilter(),\n+                                userSyncFilter.getMachineUserCrnFilter(), requestId);\n+                LOGGER.debug(\"Finished {}.\", logRetrieveUmsEvent);\n+                statusFutures = stacks.stream()\n+                        .collect(Collectors.toMap(Stack::getEnvironmentCrn,\n+                                stack -> asyncSynchronizeStack(stack, envToUmsStateMap.get(stack.getEnvironmentCrn()), umsEventGenerationIds, fullSync,\n+                                        operationId, accountId)));\n+            } else {\n+                String deletedWorkloadUser = userSyncFilter.getDeletedWorkloadUser().get();\n+                LOGGER.debug(\"Starting {} for environments {} and deleted user {} ...\", LogEvent.USER_SYNC_DELETE, environmentCrns, deletedWorkloadUser);", "originalCommit": "df6fe7b6723ac58edb359f5c948af3f6e861e666", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6f61dd42fb0b819c9744528540c998fdc3b06565", "chunk": "diff --git a/freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/UserSyncService.java b/freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/UserSyncService.java\nindex 1da848c36d..fa6a2eedeb 100644\n--- a/freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/UserSyncService.java\n+++ b/freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/UserSyncService.java\n\n@@ -258,7 +259,6 @@ public class UserSyncService {\n                                         operationId, accountId)));\n             } else {\n                 String deletedWorkloadUser = userSyncFilter.getDeletedWorkloadUser().get();\n-                LOGGER.debug(\"Starting {} for environments {} and deleted user {} ...\", LogEvent.USER_SYNC_DELETE, environmentCrns, deletedWorkloadUser);\n                 statusFutures = stacks.stream()\n                         .collect(Collectors.toMap(Stack::getEnvironmentCrn, stack -> asyncSynchronizeStackForDeleteUser(stack, deletedWorkloadUser)));\n             }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjYxOTAyMA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8988#discussion_r486619020", "bodyText": "I think we need a test that checks the parameter validation and ensures that we reject requests with a deleted workload username that contain 0 or >1 crns.", "author": "handavid", "createdAt": "2020-09-10T20:37:37Z", "path": "freeipa/src/test/java/com/sequenceiq/freeipa/controller/UserV1ControllerTest.java", "diffHunk": "@@ -115,14 +120,36 @@ void synchronizeAllUsers() {\n         request.setMachineUsers(machineUsers);\n \n         Operation operation = mock(Operation.class);\n-        when(userSyncService.synchronizeUsersWithCustomPermissionCheck(any(), any(), any(), any(), any(), any())).thenReturn(operation);\n+        when(userSyncService.synchronizeUsersWithCustomPermissionCheck(any(), any(), any(), any(), any())).thenReturn(operation);\n         SyncOperationStatus status = mock(SyncOperationStatus.class);\n         when(operationToSyncOperationStatus.convert(operation)).thenReturn(status);\n \n         assertEquals(status, ThreadBasedUserCrnProvider.doAs(USER_CRN, () -> underTest.synchronizeAllUsers(request)));\n \n+        UserSyncRequestFilter userSyncFilter = new UserSyncRequestFilter(users, machineUsers, Optional.empty());\n         verify(userSyncService, times(1)).synchronizeUsersWithCustomPermissionCheck(ACCOUNT_ID, USER_CRN, environments,\n-                users, machineUsers, AuthorizationResourceAction.DESCRIBE_ENVIRONMENT);\n+                userSyncFilter, AuthorizationResourceAction.DESCRIBE_ENVIRONMENT);\n+    }\n+\n+    @Test\n+    void synchronizeAllUsersDeleteWorkloadUser() {\n+        Set<String> users = Set.of(USER_CRN);", "originalCommit": "df6fe7b6723ac58edb359f5c948af3f6e861e666", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e601ef2f55e0bb5e54d42de8115cde6eaa6dadbb", "chunk": "diff --git a/freeipa/src/test/java/com/sequenceiq/freeipa/controller/UserV1ControllerTest.java b/freeipa/src/test/java/com/sequenceiq/freeipa/controller/UserV1ControllerTest.java\nindex 5835d5c680..8aeeef7019 100644\n--- a/freeipa/src/test/java/com/sequenceiq/freeipa/controller/UserV1ControllerTest.java\n+++ b/freeipa/src/test/java/com/sequenceiq/freeipa/controller/UserV1ControllerTest.java\n\n@@ -138,7 +139,7 @@ public class UserV1ControllerTest {\n         SynchronizeAllUsersRequest request = new SynchronizeAllUsersRequest();\n         request.setEnvironments(Set.of());\n         request.setUsers(users);\n-        request.setDeletedWorkloadUser(deletedWorkloadUser);\n+        request.setDeletedWorkloadUsers(Set.of(deletedWorkloadUser));\n \n         Operation operation = mock(Operation.class);\n         when(userSyncService.synchronizeUsersWithCustomPermissionCheck(any(), any(), any(), any(), any())).thenReturn(operation);\n"}}, {"oid": "6f61dd42fb0b819c9744528540c998fdc3b06565", "url": "https://github.com/hortonworks/cloudbreak/commit/6f61dd42fb0b819c9744528540c998fdc3b06565", "message": "CDPCP-2998. Support deleted user as part of user sync\n\nThis updates the existing synchronizeAllUsers request to\nallow specifying a single workload user to be deleted\nfrom the freeipa. Currently this won't remove CM ranger\ncloud identities (azure object ids). That will come in\na following commit.", "committedDate": "2020-09-11T04:32:27Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzEwMTM4Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/8988#discussion_r487101387", "bodyText": "typo: corresponds", "author": "handavid", "createdAt": "2020-09-11T14:55:20Z", "path": "freeipa-api/src/main/java/com/sequenceiq/freeipa/api/v1/freeipa/user/doc/UserModelDescriptions.java", "diffHunk": "@@ -6,6 +6,8 @@\n     public static final String USERSYNC_ENVIRONMENT_CRNS = \"Optional environment crns to sync\";\n     public static final String USERSYNC_USER_CRNS = \"Optional user crns to sync\";\n     public static final String USERSYNC_MACHINEUSER_CRNS = \"Optional machine user crns to sync\";\n+    public static final String DELETED_WORKLOAD_USER = \"An Optional workload user name to be deleted. When this is included, there should also be\" +\n+            \" exactly 1 crn in the machineUsers or users set that coreesponds to the deleted workload user.\";", "originalCommit": "6f61dd42fb0b819c9744528540c998fdc3b06565", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzExNTM5NA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8988#discussion_r487115394", "bodyText": "fixed", "author": "handavid", "createdAt": "2020-09-11T15:17:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzEwMTM4Nw=="}], "type": "inlineReview", "revised_code": {"commit": "d6c4ab5b6740560561d808affd21dc42fae99e94", "chunk": "diff --git a/freeipa-api/src/main/java/com/sequenceiq/freeipa/api/v1/freeipa/user/doc/UserModelDescriptions.java b/freeipa-api/src/main/java/com/sequenceiq/freeipa/api/v1/freeipa/user/doc/UserModelDescriptions.java\nindex 8238439d42..d354b3512a 100644\n--- a/freeipa-api/src/main/java/com/sequenceiq/freeipa/api/v1/freeipa/user/doc/UserModelDescriptions.java\n+++ b/freeipa-api/src/main/java/com/sequenceiq/freeipa/api/v1/freeipa/user/doc/UserModelDescriptions.java\n\n@@ -7,7 +7,7 @@ public class UserModelDescriptions {\n     public static final String USERSYNC_USER_CRNS = \"Optional user crns to sync\";\n     public static final String USERSYNC_MACHINEUSER_CRNS = \"Optional machine user crns to sync\";\n     public static final String DELETED_WORKLOAD_USER = \"An Optional workload user name to be deleted. When this is included, there should also be\" +\n-            \" exactly 1 crn in the machineUsers or users set that coreesponds to the deleted workload user.\";\n+            \" exactly 1 crn in the machineUsers or users set that corresponds to the deleted workload user.\";\n     public static final String USERSYNC_ID = \"User synchronization operation id\";\n     public static final String USERSYNC_STATUS = \"User synchronization operation status\";\n     public static final String USERSYNC_STARTTIME = \"User synchronization operation start time\";\n"}}, {"oid": "d6c4ab5b6740560561d808affd21dc42fae99e94", "url": "https://github.com/hortonworks/cloudbreak/commit/d6c4ab5b6740560561d808affd21dc42fae99e94", "message": "CDPCP-2998. Support deleted user as part of user sync\n\nThis updates the existing synchronizeAllUsers request to\nallow specifying a single workload user to be deleted\nfrom the freeipa. Currently this won't remove CM ranger\ncloud identities (azure object ids). That will come in\na following commit.", "committedDate": "2020-09-11T15:15:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzg0Mjk1OQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8988#discussion_r487842959", "bodyText": "is there any reason this can't be a set? it looks more flexible and I don't see why can't we delete 2 user at once", "author": "lacikaaa", "createdAt": "2020-09-14T11:32:54Z", "path": "freeipa-api/src/main/java/com/sequenceiq/freeipa/api/v1/freeipa/user/model/SynchronizeAllUsersRequest.java", "diffHunk": "@@ -18,6 +18,9 @@\n     @ApiModelProperty(value = UserModelDescriptions.USERSYNC_USER_CRNS)\n     private Set<String> users = new HashSet<>();\n \n+    @ApiModelProperty(value = UserModelDescriptions.DELETED_WORKLOAD_USER)\n+    private String deletedWorkloadUser;", "originalCommit": "d6c4ab5b6740560561d808affd21dc42fae99e94", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODQ2NDc4NA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8988#discussion_r488464784", "bodyText": "It has been resolved but not answered. I'm pushing this because a set would be more flexible and later you can't change this as the API has to be backward compatible.", "author": "lacikaaa", "createdAt": "2020-09-15T07:59:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzg0Mjk1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODU1MTMxNg==", "url": "https://github.com/hortonworks/cloudbreak/pull/8988#discussion_r488551316", "bodyText": "Sorry, my comment got lost. I did originally consider a set here, but ended up going with a single user (and had discussed with David prior to posting the PR) since it aligns with some follow on work coming up. We plan on updating user sync to only allow environment level sync or single actor sync and dropping support for something in between (like syncing N arbitrary users). This would involve adding new api endpoints and probably deprecating these existing ones. (I can point you to the design doc if you want). So I think it makes sense to keep this field single user only.", "author": "aarman-cloudera", "createdAt": "2020-09-15T10:15:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzg0Mjk1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc2MTM3Ng==", "url": "https://github.com/hortonworks/cloudbreak/pull/8988#discussion_r490761376", "bodyText": "Okay, after further discussion, I've updated to set and added a validation that will fail if size isn't 1.", "author": "aarman-cloudera", "createdAt": "2020-09-18T07:41:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzg0Mjk1OQ=="}], "type": "inlineReview", "revised_code": {"commit": "e601ef2f55e0bb5e54d42de8115cde6eaa6dadbb", "chunk": "diff --git a/freeipa-api/src/main/java/com/sequenceiq/freeipa/api/v1/freeipa/user/model/SynchronizeAllUsersRequest.java b/freeipa-api/src/main/java/com/sequenceiq/freeipa/api/v1/freeipa/user/model/SynchronizeAllUsersRequest.java\nindex b3134820e3..c62d1d65ef 100644\n--- a/freeipa-api/src/main/java/com/sequenceiq/freeipa/api/v1/freeipa/user/model/SynchronizeAllUsersRequest.java\n+++ b/freeipa-api/src/main/java/com/sequenceiq/freeipa/api/v1/freeipa/user/model/SynchronizeAllUsersRequest.java\n\n@@ -18,8 +18,8 @@ public class SynchronizeAllUsersRequest extends SynchronizeOperationRequestBase\n     @ApiModelProperty(value = UserModelDescriptions.USERSYNC_USER_CRNS)\n     private Set<String> users = new HashSet<>();\n \n-    @ApiModelProperty(value = UserModelDescriptions.DELETED_WORKLOAD_USER)\n-    private String deletedWorkloadUser;\n+    @ApiModelProperty(value = UserModelDescriptions.DELETED_WORKLOAD_USERS)\n+    private Set<String> deletedWorkloadUsers =  new HashSet<>();\n \n     @ApiModelProperty(value = UserModelDescriptions.USERSYNC_ACCOUNT_ID)\n     private String accountId;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzg2MjYwNg==", "url": "https://github.com/hortonworks/cloudbreak/pull/8988#discussion_r487862606", "bodyText": "I would prefer if you pass UserSyncRequestFilter instead of adding a new parameter.\nalso moving the whole validation to a separate class would be nice (@VisibleForTesting annotation already a sign this method should be in another class)", "author": "lacikaaa", "createdAt": "2020-09-14T12:11:18Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/UserSyncService.java", "diffHunk": "@@ -529,16 +583,24 @@ private void checkIfClientStillUsable(FreeIpaClientException e) throws FreeIpaCl\n \n     @VisibleForTesting\n     void validateParameters(String accountId, String actorCrn, Set<String> environmentCrnFilter,\n-            Set<String> userCrnFilter, Set<String> machineUserCrnFilter) {\n+            Set<String> userCrnFilter, Set<String> machineUserCrnFilter, Optional<String> deletedWorkoadUser) {", "originalCommit": "d6c4ab5b6740560561d808affd21dc42fae99e94", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bad2b4f67bc9998044ca3c88a8c293cf61b3714e", "chunk": "diff --git a/freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/UserSyncService.java b/freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/UserSyncService.java\nindex fa6a2eedeb..9affb3a9bb 100644\n--- a/freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/UserSyncService.java\n+++ b/freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/UserSyncService.java\n\n@@ -581,51 +577,6 @@ public class UserSyncService {\n         }\n     }\n \n-    @VisibleForTesting\n-    void validateParameters(String accountId, String actorCrn, Set<String> environmentCrnFilter,\n-            Set<String> userCrnFilter, Set<String> machineUserCrnFilter, Optional<String> deletedWorkoadUser) {\n-        requireNonNull(accountId, \"accountId must not be null\");\n-        requireNonNull(actorCrn, \"actorCrn must not be null\");\n-        requireNonNull(environmentCrnFilter, \"environmentCrnFilter must not be null\");\n-        requireNonNull(userCrnFilter, \"userCrnFilter must not be null\");\n-        requireNonNull(machineUserCrnFilter, \"machineUserCrnFilter must not be null\");\n-        requireNonNull(deletedWorkoadUser, \"deletedWorkoadUser must not be null\");\n-        validateCrnFilter(environmentCrnFilter, Crn.ResourceType.ENVIRONMENT);\n-        validateCrnFilter(userCrnFilter, Crn.ResourceType.USER);\n-        validateCrnFilter(machineUserCrnFilter, Crn.ResourceType.MACHINE_USER);\n-        validateSameAccount(accountId, Iterables.concat(environmentCrnFilter, userCrnFilter, machineUserCrnFilter));\n-        validateDeletedWorkloadUser(deletedWorkoadUser, userCrnFilter, machineUserCrnFilter);\n-    }\n-\n-    private void validateDeletedWorkloadUser(Optional<String> deletedWorkloadUser, Set<String> userCrnFilter, Set<String> machineUserCrnFilter) {\n-        if (deletedWorkloadUser.isPresent() && userCrnFilter.size() + machineUserCrnFilter.size() != 1) {\n-            throw new BadRequestException(\"Exactly 1 user or machine user needs to be specified when deletedWorkloadUser is present\");\n-        }\n-    }\n-\n-    private void validateSameAccount(String accountId, Iterable<String> crns) {\n-        crns.forEach(crnString -> {\n-            Crn crn = Crn.safeFromString(crnString);\n-            if (!accountId.equals(crn.getAccountId())) {\n-                throw new BadRequestException(String.format(\"Crn %s is not in the expected account %s\", crnString, accountId));\n-            }\n-        });\n-    }\n-\n-    @VisibleForTesting\n-    void validateCrnFilter(Set<String> crnFilter, Crn.ResourceType resourceType) {\n-        crnFilter.forEach(crnString -> {\n-            try {\n-                Crn crn = Crn.safeFromString(crnString);\n-                if (crn.getResourceType() != resourceType) {\n-                    throw new BadRequestException(String.format(\"Crn %s is not of expected type %s\", crnString, resourceType));\n-                }\n-            } catch (CrnParseException e) {\n-                throw new BadRequestException(e.getMessage(), e);\n-            }\n-        });\n-    }\n-\n     private Set<String> union(Collection<String> collection1, Collection<String> collection2) {\n         return Stream.concat(collection1.stream(), collection2.stream()).collect(Collectors.toSet());\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzg3MjM1NA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8988#discussion_r487872354", "bodyText": "could you move this to a separate class and refactor into multiple shorter methods", "author": "lacikaaa", "createdAt": "2020-09-14T12:28:28Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/UserSyncService.java", "diffHunk": "@@ -355,13 +368,54 @@ private SyncStatusDetail internalSynchronizeStack(Stack stack, UmsUsersState ums\n         }\n     }\n \n+    private SyncStatusDetail internalSynchronizeStackForDeleteUser(Stack stack, String deletedWorkloadUser) {", "originalCommit": "d6c4ab5b6740560561d808affd21dc42fae99e94", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODE5ODQ4Mw==", "url": "https://github.com/hortonworks/cloudbreak/pull/8988#discussion_r488198483", "bodyText": "I've made it slightly shorter. We can do additional refactoring when working on the new sync endpoints (as mention in a previous comment), so I prefer to keep it in this class for now.", "author": "aarman-cloudera", "createdAt": "2020-09-14T20:23:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzg3MjM1NA=="}], "type": "inlineReview", "revised_code": {"commit": "bad2b4f67bc9998044ca3c88a8c293cf61b3714e", "chunk": "diff --git a/freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/UserSyncService.java b/freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/UserSyncService.java\nindex fa6a2eedeb..9affb3a9bb 100644\n--- a/freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/UserSyncService.java\n+++ b/freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/UserSyncService.java\n\n@@ -357,11 +355,7 @@ public class UserSyncService {\n                 LOGGER.debug(\"Finished {}.\", LogEvent.SYNC_CLOUD_IDENTITIES);\n             }\n \n-            if (warnings.isEmpty()) {\n-                return SyncStatusDetail.succeed(environmentCrn);\n-            } else {\n-                return SyncStatusDetail.fail(environmentCrn, \"Synchronization completed with warnings.\", warnings);\n-            }\n+            return toSyncStatusDetail(environmentCrn, warnings);\n         } catch (Exception e) {\n             LOGGER.warn(\"Failed to synchronize environment {}\", environmentCrn, e);\n             return SyncStatusDetail.fail(environmentCrn, e.getLocalizedMessage(), warnings);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzg3MzExMQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8988#discussion_r487873111", "bodyText": "I think it should fit into one log line", "author": "lacikaaa", "createdAt": "2020-09-14T12:29:42Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/UserSyncService.java", "diffHunk": "@@ -355,13 +368,54 @@ private SyncStatusDetail internalSynchronizeStack(Stack stack, UmsUsersState ums\n         }\n     }\n \n+    private SyncStatusDetail internalSynchronizeStackForDeleteUser(Stack stack, String deletedWorkloadUser) {\n+        MDCBuilder.buildMdcContext(stack);\n+        String environmentCrn = stack.getEnvironmentCrn();\n+        Multimap<String, String> warnings = ArrayListMultimap.create();\n+        try {\n+            FreeIpaClient freeIpaClient = freeIpaClientFactory.getFreeIpaClientForStack(stack);\n+\n+            LOGGER.debug(\"Starting {} for environment {} and deleted user {} ...\", LogEvent.USER_SYNC_DELETE, environmentCrn, deletedWorkloadUser);\n+\n+            LogEvent logEvent = LogEvent.RETRIEVE_PARTIAL_IPA_STATE;\n+            LOGGER.debug(\"Starting {} ...\", LogEvent.RETRIEVE_PARTIAL_IPA_STATE);", "originalCommit": "d6c4ab5b6740560561d808affd21dc42fae99e94", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODE5ODcwOQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8988#discussion_r488198709", "bodyText": "I've removed the logEvent variable so it no longer fits.", "author": "aarman-cloudera", "createdAt": "2020-09-14T20:24:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzg3MzExMQ=="}], "type": "inlineReview", "revised_code": {"commit": "bad2b4f67bc9998044ca3c88a8c293cf61b3714e", "chunk": "diff --git a/freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/UserSyncService.java b/freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/UserSyncService.java\nindex fa6a2eedeb..9affb3a9bb 100644\n--- a/freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/UserSyncService.java\n+++ b/freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/UserSyncService.java\n\n@@ -357,11 +355,7 @@ public class UserSyncService {\n                 LOGGER.debug(\"Finished {}.\", LogEvent.SYNC_CLOUD_IDENTITIES);\n             }\n \n-            if (warnings.isEmpty()) {\n-                return SyncStatusDetail.succeed(environmentCrn);\n-            } else {\n-                return SyncStatusDetail.fail(environmentCrn, \"Synchronization completed with warnings.\", warnings);\n-            }\n+            return toSyncStatusDetail(environmentCrn, warnings);\n         } catch (Exception e) {\n             LOGGER.warn(\"Failed to synchronize environment {}\", environmentCrn, e);\n             return SyncStatusDetail.fail(environmentCrn, e.getLocalizedMessage(), warnings);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzg3NjQ1Mw==", "url": "https://github.com/hortonworks/cloudbreak/pull/8988#discussion_r487876453", "bodyText": "I think you should either delete logEvent variable or use it in the next line also", "author": "lacikaaa", "createdAt": "2020-09-14T12:35:08Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/UserSyncService.java", "diffHunk": "@@ -355,13 +368,54 @@ private SyncStatusDetail internalSynchronizeStack(Stack stack, UmsUsersState ums\n         }\n     }\n \n+    private SyncStatusDetail internalSynchronizeStackForDeleteUser(Stack stack, String deletedWorkloadUser) {\n+        MDCBuilder.buildMdcContext(stack);\n+        String environmentCrn = stack.getEnvironmentCrn();\n+        Multimap<String, String> warnings = ArrayListMultimap.create();\n+        try {\n+            FreeIpaClient freeIpaClient = freeIpaClientFactory.getFreeIpaClientForStack(stack);\n+\n+            LOGGER.debug(\"Starting {} for environment {} and deleted user {} ...\", LogEvent.USER_SYNC_DELETE, environmentCrn, deletedWorkloadUser);\n+\n+            LogEvent logEvent = LogEvent.RETRIEVE_PARTIAL_IPA_STATE;", "originalCommit": "d6c4ab5b6740560561d808affd21dc42fae99e94", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODE5ODc3Ng==", "url": "https://github.com/hortonworks/cloudbreak/pull/8988#discussion_r488198776", "bodyText": "Deleted", "author": "aarman-cloudera", "createdAt": "2020-09-14T20:24:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzg3NjQ1Mw=="}], "type": "inlineReview", "revised_code": {"commit": "bad2b4f67bc9998044ca3c88a8c293cf61b3714e", "chunk": "diff --git a/freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/UserSyncService.java b/freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/UserSyncService.java\nindex fa6a2eedeb..9affb3a9bb 100644\n--- a/freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/UserSyncService.java\n+++ b/freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/UserSyncService.java\n\n@@ -357,11 +355,7 @@ public class UserSyncService {\n                 LOGGER.debug(\"Finished {}.\", LogEvent.SYNC_CLOUD_IDENTITIES);\n             }\n \n-            if (warnings.isEmpty()) {\n-                return SyncStatusDetail.succeed(environmentCrn);\n-            } else {\n-                return SyncStatusDetail.fail(environmentCrn, \"Synchronization completed with warnings.\", warnings);\n-            }\n+            return toSyncStatusDetail(environmentCrn, warnings);\n         } catch (Exception e) {\n             LOGGER.warn(\"Failed to synchronize environment {}\", environmentCrn, e);\n             return SyncStatusDetail.fail(environmentCrn, e.getLocalizedMessage(), warnings);\n"}}, {"oid": "bad2b4f67bc9998044ca3c88a8c293cf61b3714e", "url": "https://github.com/hortonworks/cloudbreak/commit/bad2b4f67bc9998044ca3c88a8c293cf61b3714e", "message": "CDPCP-2998. Support deleted user as part of user sync\n\nThis updates the existing synchronizeAllUsers request to\nallow specifying a single workload user to be deleted\nfrom the freeipa. Currently this won't remove CM ranger\ncloud identities (azure object ids). That will come in\na following commit.", "committedDate": "2020-09-14T20:18:19Z", "type": "forcePushed"}, {"oid": "58507dbcb73caa1d6bda42383a66588acdd4fe10", "url": "https://github.com/hortonworks/cloudbreak/commit/58507dbcb73caa1d6bda42383a66588acdd4fe10", "message": "CDPCP-2998. Support deleted user as part of user sync\n\nThis updates the existing synchronizeAllUsers request to\nallow specifying a single workload user to be deleted\nfrom the freeipa. Currently this won't remove CM ranger\ncloud identities (azure object ids). That will come in\na following commit.", "committedDate": "2020-09-17T20:27:22Z", "type": "forcePushed"}, {"oid": "e601ef2f55e0bb5e54d42de8115cde6eaa6dadbb", "url": "https://github.com/hortonworks/cloudbreak/commit/e601ef2f55e0bb5e54d42de8115cde6eaa6dadbb", "message": "CDPCP-2998. Support deleted user as part of user sync\n\nThis updates the existing synchronizeAllUsers request to\nallow specifying a single workload user to be deleted\nfrom the freeipa. Currently this won't remove CM ranger\ncloud identities (azure object ids). That will come in\na following commit.", "committedDate": "2020-09-18T07:39:32Z", "type": "commit"}, {"oid": "e601ef2f55e0bb5e54d42de8115cde6eaa6dadbb", "url": "https://github.com/hortonworks/cloudbreak/commit/e601ef2f55e0bb5e54d42de8115cde6eaa6dadbb", "message": "CDPCP-2998. Support deleted user as part of user sync\n\nThis updates the existing synchronizeAllUsers request to\nallow specifying a single workload user to be deleted\nfrom the freeipa. Currently this won't remove CM ranger\ncloud identities (azure object ids). That will come in\na following commit.", "committedDate": "2020-09-18T07:39:32Z", "type": "forcePushed"}]}