{"pr_number": 7646, "pr_title": "CB-6217 Remove redundancy from API E2E test cases", "pr_createdAt": "2020-03-25T13:41:40Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/7646", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzg2NTA2Ng==", "url": "https://github.com/hortonworks/cloudbreak/pull/7646#discussion_r397865066", "bodyText": "I think this class should not extend ImageValidatorE2ETest, since InternalSdxDistroxTests also creates DistroX cluster", "author": "horadla23", "createdAt": "2020-03-25T13:46:27Z", "path": "integration-test/src/main/java/com/sequenceiq/it/cloudbreak/testcase/e2e/distrox/DistroXImageValidatorTest.java", "diffHunk": "@@ -0,0 +1,39 @@\n+package com.sequenceiq.it.cloudbreak.testcase.e2e.distrox;\n+\n+import javax.inject.Inject;\n+\n+import org.testng.annotations.Test;\n+\n+import com.sequenceiq.it.cloudbreak.client.DistroXTestClient;\n+import com.sequenceiq.it.cloudbreak.context.Description;\n+import com.sequenceiq.it.cloudbreak.context.TestContext;\n+import com.sequenceiq.it.cloudbreak.dto.distrox.DistroXTestDto;\n+import com.sequenceiq.it.cloudbreak.testcase.e2e.ImageValidatorE2ETest;\n+\n+public class DistroXImageValidatorTest extends ImageValidatorE2ETest {", "originalCommit": "eb6a33c137b10c3f5712106906b000bf50eb30f2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "70201a749d12757609004ece9915c0483023f1a6", "chunk": "diff --git a/integration-test/src/main/java/com/sequenceiq/it/cloudbreak/testcase/e2e/distrox/DistroXImageValidatorTest.java b/integration-test/src/main/java/com/sequenceiq/it/cloudbreak/testcase/e2e/distrox/DistroXImageValidatorTest.java\ndeleted file mode 100644\nindex eede4d84e3..0000000000\n--- a/integration-test/src/main/java/com/sequenceiq/it/cloudbreak/testcase/e2e/distrox/DistroXImageValidatorTest.java\n+++ /dev/null\n\n@@ -1,39 +0,0 @@\n-package com.sequenceiq.it.cloudbreak.testcase.e2e.distrox;\n-\n-import javax.inject.Inject;\n-\n-import org.testng.annotations.Test;\n-\n-import com.sequenceiq.it.cloudbreak.client.DistroXTestClient;\n-import com.sequenceiq.it.cloudbreak.context.Description;\n-import com.sequenceiq.it.cloudbreak.context.TestContext;\n-import com.sequenceiq.it.cloudbreak.dto.distrox.DistroXTestDto;\n-import com.sequenceiq.it.cloudbreak.testcase.e2e.ImageValidatorE2ETest;\n-\n-public class DistroXImageValidatorTest extends ImageValidatorE2ETest {\n-\n-    @Inject\n-    private DistroXTestClient distroXTestClient;\n-\n-    @Test(dataProvider = TEST_CONTEXT)\n-    @Description(\n-            given = \"there is a running cloudbreak\",\n-            when = \"a valid DistroX create request is sent\",\n-            then = \"DistroX cluster is created\")\n-    public void testCreateDistroX(TestContext testContext) {\n-        testContext.given(DistroXTestDto.class)\n-                .when(distroXTestClient.create())\n-                .await(STACK_AVAILABLE)\n-                .then((context, distrox, client) -> {\n-                    distrox.getResponse();\n-                    return distrox;\n-                })\n-                .when(distroXTestClient.get())\n-                .validate();\n-    }\n-\n-    @Override\n-    protected String getImageId(TestContext testContext) {\n-        return testContext.get(DistroXTestDto.class).getResponse().getImage().getId();\n-    }\n-}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzg2NTg1OA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7646#discussion_r397865858", "bodyText": "This class also should not extend ImageValidatorE2ETest, since it is not used in imagevalidation test suite", "author": "horadla23", "createdAt": "2020-03-25T13:47:27Z", "path": "integration-test/src/main/java/com/sequenceiq/it/cloudbreak/testcase/e2e/sdx/InternalSdxTests.java", "diffHunk": "@@ -19,15 +19,6 @@\n     @Inject\n     private SdxTestClient sdxTestClient;\n \n-    @Override\n-    protected void setupTest(TestContext testContext) {", "originalCommit": "eb6a33c137b10c3f5712106906b000bf50eb30f2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "70201a749d12757609004ece9915c0483023f1a6", "chunk": "diff --git a/integration-test/src/main/java/com/sequenceiq/it/cloudbreak/testcase/e2e/sdx/InternalSdxTests.java b/integration-test/src/main/java/com/sequenceiq/it/cloudbreak/testcase/e2e/sdx/InternalSdxTest.java\nsimilarity index 76%\nrename from integration-test/src/main/java/com/sequenceiq/it/cloudbreak/testcase/e2e/sdx/InternalSdxTests.java\nrename to integration-test/src/main/java/com/sequenceiq/it/cloudbreak/testcase/e2e/sdx/InternalSdxTest.java\nindex eee2c961eb..ee37ce7886 100644\n--- a/integration-test/src/main/java/com/sequenceiq/it/cloudbreak/testcase/e2e/sdx/InternalSdxTests.java\n+++ b/integration-test/src/main/java/com/sequenceiq/it/cloudbreak/testcase/e2e/sdx/InternalSdxTest.java\n\n@@ -10,15 +10,19 @@ import com.sequenceiq.it.cloudbreak.client.SdxTestClient;\n import com.sequenceiq.it.cloudbreak.context.Description;\n import com.sequenceiq.it.cloudbreak.context.TestContext;\n import com.sequenceiq.it.cloudbreak.dto.sdx.SdxInternalTestDto;\n-import com.sequenceiq.it.cloudbreak.testcase.e2e.ImageValidatorE2ETest;\n+import com.sequenceiq.it.cloudbreak.testcase.e2e.PreconditionSdxE2ETest;\n+import com.sequenceiq.it.cloudbreak.util.wait.WaitUtil;\n import com.sequenceiq.sdx.api.model.SdxClusterStatusResponse;\n import com.sequenceiq.sdx.api.model.SdxDatabaseRequest;\n \n-public class InternalSdxTests extends ImageValidatorE2ETest {\n+public class InternalSdxTest extends PreconditionSdxE2ETest {\n \n     @Inject\n     private SdxTestClient sdxTestClient;\n \n+    @Inject\n+    private WaitUtil waitUtil;\n+\n     @Test(dataProvider = TEST_CONTEXT)\n     @Description(\n             given = \"an SDX internal request\",\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzg3MzY0Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/7646#discussion_r397873647", "bodyText": "Since image validation does not use this test currently, I think you can move it back to the DistroxTests class, it does not need to be an imagevalidation test, the only class used for image validation is InternalSdxDistroxTests", "author": "horadla23", "createdAt": "2020-03-25T13:57:32Z", "path": "integration-test/src/main/java/com/sequenceiq/it/cloudbreak/testcase/e2e/distrox/DistroXImageValidatorTest.java", "diffHunk": "@@ -0,0 +1,39 @@\n+package com.sequenceiq.it.cloudbreak.testcase.e2e.distrox;\n+\n+import javax.inject.Inject;\n+\n+import org.testng.annotations.Test;\n+\n+import com.sequenceiq.it.cloudbreak.client.DistroXTestClient;\n+import com.sequenceiq.it.cloudbreak.context.Description;\n+import com.sequenceiq.it.cloudbreak.context.TestContext;\n+import com.sequenceiq.it.cloudbreak.dto.distrox.DistroXTestDto;\n+import com.sequenceiq.it.cloudbreak.testcase.e2e.ImageValidatorE2ETest;\n+\n+public class DistroXImageValidatorTest extends ImageValidatorE2ETest {\n+\n+    @Inject\n+    private DistroXTestClient distroXTestClient;\n+\n+    @Test(dataProvider = TEST_CONTEXT)\n+    @Description(\n+            given = \"there is a running cloudbreak\",\n+            when = \"a valid DistroX create request is sent\",\n+            then = \"DistroX cluster is created\")\n+    public void testCreateDistroX(TestContext testContext) {", "originalCommit": "eb6a33c137b10c3f5712106906b000bf50eb30f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzg3NTUzMw==", "url": "https://github.com/hortonworks/cloudbreak/pull/7646#discussion_r397875533", "bodyText": "Or you can simply remove this test", "author": "horadla23", "createdAt": "2020-03-25T13:59:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzg3MzY0Nw=="}], "type": "inlineReview", "revised_code": {"commit": "70201a749d12757609004ece9915c0483023f1a6", "chunk": "diff --git a/integration-test/src/main/java/com/sequenceiq/it/cloudbreak/testcase/e2e/distrox/DistroXImageValidatorTest.java b/integration-test/src/main/java/com/sequenceiq/it/cloudbreak/testcase/e2e/distrox/DistroXImageValidatorTest.java\ndeleted file mode 100644\nindex eede4d84e3..0000000000\n--- a/integration-test/src/main/java/com/sequenceiq/it/cloudbreak/testcase/e2e/distrox/DistroXImageValidatorTest.java\n+++ /dev/null\n\n@@ -1,39 +0,0 @@\n-package com.sequenceiq.it.cloudbreak.testcase.e2e.distrox;\n-\n-import javax.inject.Inject;\n-\n-import org.testng.annotations.Test;\n-\n-import com.sequenceiq.it.cloudbreak.client.DistroXTestClient;\n-import com.sequenceiq.it.cloudbreak.context.Description;\n-import com.sequenceiq.it.cloudbreak.context.TestContext;\n-import com.sequenceiq.it.cloudbreak.dto.distrox.DistroXTestDto;\n-import com.sequenceiq.it.cloudbreak.testcase.e2e.ImageValidatorE2ETest;\n-\n-public class DistroXImageValidatorTest extends ImageValidatorE2ETest {\n-\n-    @Inject\n-    private DistroXTestClient distroXTestClient;\n-\n-    @Test(dataProvider = TEST_CONTEXT)\n-    @Description(\n-            given = \"there is a running cloudbreak\",\n-            when = \"a valid DistroX create request is sent\",\n-            then = \"DistroX cluster is created\")\n-    public void testCreateDistroX(TestContext testContext) {\n-        testContext.given(DistroXTestDto.class)\n-                .when(distroXTestClient.create())\n-                .await(STACK_AVAILABLE)\n-                .then((context, distrox, client) -> {\n-                    distrox.getResponse();\n-                    return distrox;\n-                })\n-                .when(distroXTestClient.get())\n-                .validate();\n-    }\n-\n-    @Override\n-    protected String getImageId(TestContext testContext) {\n-        return testContext.get(DistroXTestDto.class).getResponse().getImage().getId();\n-    }\n-}\n"}}, {"oid": "70201a749d12757609004ece9915c0483023f1a6", "url": "https://github.com/hortonworks/cloudbreak/commit/70201a749d12757609004ece9915c0483023f1a6", "message": "CB-6217 Remove redundancy from API E2E test cases", "committedDate": "2020-03-25T16:46:46Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTExMTUyNg==", "url": "https://github.com/hortonworks/cloudbreak/pull/7646#discussion_r399111526", "bodyText": "please modify class name in the image validation suites as well", "author": "horadla23", "createdAt": "2020-03-27T08:46:09Z", "path": "integration-test/src/main/java/com/sequenceiq/it/cloudbreak/testcase/e2e/sdx/InternalSdxDistroxTest.java", "diffHunk": "@@ -17,23 +17,14 @@\n import com.sequenceiq.sdx.api.model.SdxClusterStatusResponse;\n import com.sequenceiq.sdx.api.model.SdxDatabaseRequest;\n \n-public class InternalSdxDistroxTests extends ImageValidatorE2ETest {\n+public class InternalSdxDistroxTest extends ImageValidatorE2ETest {", "originalCommit": "885415cc8487e160edf2ff9757a29e1dc7741cef", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bedeea3ae2ac2bacc2f423d94bc9ccb2644595ef", "chunk": "diff --git a/integration-test/src/main/java/com/sequenceiq/it/cloudbreak/testcase/e2e/sdx/InternalSdxDistroxTest.java b/integration-test/src/main/java/com/sequenceiq/it/cloudbreak/testcase/e2e/sdx/InternalSdxDistroxTest.java\nindex b76b3feb88..464e1627de 100644\n--- a/integration-test/src/main/java/com/sequenceiq/it/cloudbreak/testcase/e2e/sdx/InternalSdxDistroxTest.java\n+++ b/integration-test/src/main/java/com/sequenceiq/it/cloudbreak/testcase/e2e/sdx/InternalSdxDistroxTest.java\n\n@@ -13,7 +13,6 @@ import com.sequenceiq.it.cloudbreak.context.TestContext;\n import com.sequenceiq.it.cloudbreak.dto.distrox.DistroXTestDto;\n import com.sequenceiq.it.cloudbreak.dto.distrox.image.DistroXImageTestDto;\n import com.sequenceiq.it.cloudbreak.dto.sdx.SdxInternalTestDto;\n-import com.sequenceiq.it.cloudbreak.testcase.e2e.ImageValidatorE2ETest;\n import com.sequenceiq.sdx.api.model.SdxClusterStatusResponse;\n import com.sequenceiq.sdx.api.model.SdxDatabaseRequest;\n \n"}}, {"oid": "48be7fd34a9c05f8f5fbc3a131ebaa0f3e29da25", "url": "https://github.com/hortonworks/cloudbreak/commit/48be7fd34a9c05f8f5fbc3a131ebaa0f3e29da25", "message": "CB-6217 Remove redundancy from API E2E test cases", "committedDate": "2020-03-27T08:51:41Z", "type": "forcePushed"}, {"oid": "fcf55146834e9081a1ff06f5bce0910a9c208f7e", "url": "https://github.com/hortonworks/cloudbreak/commit/fcf55146834e9081a1ff06f5bce0910a9c208f7e", "message": "CB-6217 Remove redundancy from API E2E test cases", "committedDate": "2020-03-27T09:07:41Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQwNzIwNw==", "url": "https://github.com/hortonworks/cloudbreak/pull/7646#discussion_r399407207", "bodyText": "I would move into sdx package, as all of its descendants are there.", "author": "gergopapi2", "createdAt": "2020-03-27T16:55:39Z", "path": "integration-test/src/main/java/com/sequenceiq/it/cloudbreak/testcase/e2e/PreconditionSdxE2ETest.java", "diffHunk": "@@ -0,0 +1,112 @@\n+package com.sequenceiq.it.cloudbreak.testcase.e2e;", "originalCommit": "fcf55146834e9081a1ff06f5bce0910a9c208f7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bedeea3ae2ac2bacc2f423d94bc9ccb2644595ef", "chunk": "diff --git a/integration-test/src/main/java/com/sequenceiq/it/cloudbreak/testcase/e2e/PreconditionSdxE2ETest.java b/integration-test/src/main/java/com/sequenceiq/it/cloudbreak/testcase/e2e/sdx/PreconditionSdxE2ETest.java\nsimilarity index 97%\nrename from integration-test/src/main/java/com/sequenceiq/it/cloudbreak/testcase/e2e/PreconditionSdxE2ETest.java\nrename to integration-test/src/main/java/com/sequenceiq/it/cloudbreak/testcase/e2e/sdx/PreconditionSdxE2ETest.java\nindex d67aa6c93d..950e32cd06 100644\n--- a/integration-test/src/main/java/com/sequenceiq/it/cloudbreak/testcase/e2e/PreconditionSdxE2ETest.java\n+++ b/integration-test/src/main/java/com/sequenceiq/it/cloudbreak/testcase/e2e/sdx/PreconditionSdxE2ETest.java\n\n@@ -1,4 +1,4 @@\n-package com.sequenceiq.it.cloudbreak.testcase.e2e;\n+package com.sequenceiq.it.cloudbreak.testcase.e2e.sdx;\n \n import static com.sequenceiq.it.cloudbreak.cloud.HostGroupType.IDBROKER;\n import static com.sequenceiq.it.cloudbreak.cloud.HostGroupType.MASTER;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQwNzk0MQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/7646#discussion_r399407941", "bodyText": "I would move the class into sdx package as its sole descendant is also there.", "author": "gergopapi2", "createdAt": "2020-03-27T16:56:46Z", "path": "integration-test/src/main/java/com/sequenceiq/it/cloudbreak/testcase/e2e/ImageValidatorE2ETest.java", "diffHunk": "@@ -33,6 +33,15 @@\n     @Value(\"${integrationtest.imageValidation.sourceCatalogUrl}\")\n     private String sourceImageCatalogUrl;\n ", "originalCommit": "fcf55146834e9081a1ff06f5bce0910a9c208f7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQyNDA5OA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7646#discussion_r399424098", "bodyText": "This method and checkDistroxInstanceState are almost identical. I would try to refactor them to have one method. I think it is only the log and exception messages that differ within method body.", "author": "gergopapi2", "createdAt": "2020-03-27T17:23:09Z", "path": "integration-test/src/main/java/com/sequenceiq/it/cloudbreak/util/wait/WaitUtil.java", "diffHunk": "@@ -449,13 +451,37 @@ private boolean checkSdxInstanceState(SdxClient sdxClient, String sdxName, Strin\n         List<InstanceGroupV4Response> instanceGroups = sdxClient.getSdxClient().sdxEndpoint().getDetail(sdxName, Set.of())\n                 .getStackV4Response()\n                 .getInstanceGroups();\n-        return checkInstanceState(hostGroup, desiredState, instanceGroups);\n+        SdxClusterResponse sdxResponse = sdxClient.getSdxClient().sdxEndpoint().get(sdxName);", "originalCommit": "fcf55146834e9081a1ff06f5bce0910a9c208f7e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "bedeea3ae2ac2bacc2f423d94bc9ccb2644595ef", "url": "https://github.com/hortonworks/cloudbreak/commit/bedeea3ae2ac2bacc2f423d94bc9ccb2644595ef", "message": "CB-6217 Remove redundancy from API E2E test cases", "committedDate": "2020-03-30T08:45:58Z", "type": "commit"}, {"oid": "bedeea3ae2ac2bacc2f423d94bc9ccb2644595ef", "url": "https://github.com/hortonworks/cloudbreak/commit/bedeea3ae2ac2bacc2f423d94bc9ccb2644595ef", "message": "CB-6217 Remove redundancy from API E2E test cases", "committedDate": "2020-03-30T08:45:58Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA3OTM3OQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/7646#discussion_r400079379", "bodyText": "Is there some override for this variable?\nOr where do we get the 8 value?", "author": "lnardai", "createdAt": "2020-03-30T10:16:37Z", "path": "integration-test/src/main/java/com/sequenceiq/it/IntegrationTestApp.java", "diffHunk": "@@ -66,7 +66,7 @@\n     @Value(\"${integrationtest.threadCount:2}\")", "originalCommit": "bedeea3ae2ac2bacc2f423d94bc9ccb2644595ef", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}