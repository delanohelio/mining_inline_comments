{"pr_number": 9503, "pr_title": "CB-9957 in case of DH cluster we can provision external databases. Th\u2026", "pr_createdAt": "2020-11-24T10:06:05Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/9503", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTM5NDMzNw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9503#discussion_r529394337", "bodyText": "please set as private", "author": "bergerdenes", "createdAt": "2020-11-24T10:08:24Z", "path": "core/src/main/java/com/sequenceiq/cloudbreak/core/flow2/externaldatabase/ExternalDatabaseService.java", "diffHunk": "@@ -87,20 +92,32 @@ public void startDatabase(Cluster cluster, DatabaseAvailabilityType externalData\n                 externalDatabase.name(), environment.getName(), cluster.getName());\n         String databaseCrn = cluster.getDatabaseServerCrn();\n         try {\n-            redbeamsClient.startByCrn(databaseCrn);\n-            waitAndGetDatabase(cluster, databaseCrn, DatabaseOperation.START, false);\n+            if (externalDatabaseReferenceExist(databaseCrn)) {\n+                redbeamsClient.startByCrn(databaseCrn);\n+                waitAndGetDatabase(cluster, databaseCrn, DatabaseOperation.START, false);\n+            } else {\n+                LOGGER.warn(\"[INVESTIGATE] The external database type was {} but there was no crn\", externalDatabase);\n+            }\n         } catch (NotFoundException notFoundException) {\n             LOGGER.info(\"Database server not found on redbeams side {}\", databaseCrn);\n         }\n     }\n \n+    public boolean externalDatabaseReferenceExist(String databaseCrn) {", "originalCommit": "2e4f0ffaf2a9e3bef6196325599ccc92b11f57e8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "def8d4cde79f7e73b6f734e15afd739528d705f4", "chunk": "diff --git a/core/src/main/java/com/sequenceiq/cloudbreak/core/flow2/externaldatabase/ExternalDatabaseService.java b/core/src/main/java/com/sequenceiq/cloudbreak/core/flow2/externaldatabase/ExternalDatabaseService.java\nindex e9ce1edd39..ebcf3336aa 100644\n--- a/core/src/main/java/com/sequenceiq/cloudbreak/core/flow2/externaldatabase/ExternalDatabaseService.java\n+++ b/core/src/main/java/com/sequenceiq/cloudbreak/core/flow2/externaldatabase/ExternalDatabaseService.java\n\n@@ -103,10 +103,6 @@ public class ExternalDatabaseService {\n         }\n     }\n \n-    public boolean externalDatabaseReferenceExist(String databaseCrn) {\n-        return !Strings.isNullOrEmpty(databaseCrn);\n-    }\n-\n     public void stopDatabase(Cluster cluster, DatabaseAvailabilityType externalDatabase, DetailedEnvironmentResponse environment) {\n         LOGGER.info(\"Stopping external {} database server in environment {} for DataHub {}\",\n                 externalDatabase.name(), environment.getName(), cluster.getName());\n"}}, {"oid": "def8d4cde79f7e73b6f734e15afd739528d705f4", "url": "https://github.com/hortonworks/cloudbreak/commit/def8d4cde79f7e73b6f734e15afd739528d705f4", "message": "CB-9957 in case of DH cluster we can provision external databases. The problem was that somehow the external db reference was null. We should investigate further how it caused but this fix is basically checking the existence of the external rds crn before initiate the start/stop/delete.", "committedDate": "2020-11-24T10:17:35Z", "type": "commit"}, {"oid": "def8d4cde79f7e73b6f734e15afd739528d705f4", "url": "https://github.com/hortonworks/cloudbreak/commit/def8d4cde79f7e73b6f734e15afd739528d705f4", "message": "CB-9957 in case of DH cluster we can provision external databases. The problem was that somehow the external db reference was null. We should investigate further how it caused but this fix is basically checking the existence of the external rds crn before initiate the start/stop/delete.", "committedDate": "2020-11-24T10:17:35Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTQxMTY0OQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9503#discussion_r529411649", "bodyText": "Not sure if the MDCcontext is correct at these places, but if not then probably it would be better to include more information in the logs, like data hub name or crn.", "author": "keyki", "createdAt": "2020-11-24T10:22:27Z", "path": "core/src/main/java/com/sequenceiq/cloudbreak/core/flow2/externaldatabase/ExternalDatabaseService.java", "diffHunk": "@@ -99,13 +108,21 @@ public void stopDatabase(Cluster cluster, DatabaseAvailabilityType externalDatab\n                 externalDatabase.name(), environment.getName(), cluster.getName());\n         String databaseCrn = cluster.getDatabaseServerCrn();\n         try {\n-            redbeamsClient.stopByCrn(databaseCrn);\n-            waitAndGetDatabase(cluster, databaseCrn, DatabaseOperation.STOP, false);\n+            if (externalDatabaseReferenceExist(databaseCrn)) {\n+                redbeamsClient.stopByCrn(databaseCrn);\n+                waitAndGetDatabase(cluster, databaseCrn, DatabaseOperation.STOP, false);\n+            } else {\n+                LOGGER.warn(\"[INVESTIGATE] The external database type was {} but there was no crn\", externalDatabase);", "originalCommit": "def8d4cde79f7e73b6f734e15afd739528d705f4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTQxOTU2NA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9503#discussion_r529419564", "bodyText": "it must be correct. we checked the logs and the information is there. I just want to highlight how many times it happened.", "author": "doktoric", "createdAt": "2020-11-24T10:28:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTQxMTY0OQ=="}], "type": "inlineReview", "revised_code": null}]}