{"pr_number": 9620, "pr_title": "CB-10242 API changes to support semi-private networks", "pr_createdAt": "2020-12-09T20:33:55Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/9620", "timeline": [{"oid": "31ad5507ec7c34ecfa7dd89e3d359938962b03da", "url": "https://github.com/hortonworks/cloudbreak/commit/31ad5507ec7c34ecfa7dd89e3d359938962b03da", "message": "CB-10242 API changes to support semi-private networks\n\nAdds new optional fields 'usePublicEndpointAccessGateway' and\n'endpointGatewaySubnetIds' to the EnvironmentNetworkV1Request API object. These\nfields are persisted to the EnvironmentNetwork and NetworkDto BaseNetwork\nobjects. Adds new columns for these fields to the environment_network table\nand saves them to the database.\n\nTested with unit tests, and by manually setting the new fields in the IDE and\nverifying they were converted/persisted in the database correctly.", "committedDate": "2020-12-10T15:37:37Z", "type": "forcePushed"}, {"oid": "41e55e6bd5de0b37bf0ec078991bd80303e2f5d5", "url": "https://github.com/hortonworks/cloudbreak/commit/41e55e6bd5de0b37bf0ec078991bd80303e2f5d5", "message": "CB-10242 API changes to support semi-private networks\n\nAdds new optional fields 'usePublicEndpointAccessGateway' and\n'endpointGatewaySubnetIds' to the EnvironmentNetworkV1Request API object. These\nfields are persisted to the EnvironmentNetwork and NetworkDto BaseNetwork\nobjects. Adds new columns for these fields to the environment_network table\nand saves them to the database.\n\nTested with unit tests, and by manually setting the new fields in the IDE and\nverifying they were converted/persisted in the database correctly.", "committedDate": "2020-12-10T18:08:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjE2ODE5MQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9620#discussion_r542168191", "bodyText": "Usually, we prefer enums instead of booleans, it makes it easier to extend it the future.", "author": "akanto", "createdAt": "2020-12-14T07:37:18Z", "path": "environment-api/src/main/java/com/sequenceiq/environment/api/v1/environment/model/base/EnvironmentNetworkBase.java", "diffHunk": "@@ -42,6 +42,12 @@\n     @ApiModelProperty(EnvironmentModelDescription.SERVICE_ENDPOINT_CREATION)\n     private ServiceEndpointCreation serviceEndpointCreation = ServiceEndpointCreation.DISABLED;\n \n+    @ApiModelProperty(EnvironmentModelDescription.PUBLIC_ENDPOINT_ACCESS_GATEWAY)\n+    private Boolean usePublicEndpointAccessGateway = false;", "originalCommit": "41e55e6bd5de0b37bf0ec078991bd80303e2f5d5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9dca75f436b7eb17c699b40458fc5f826ecda1be", "chunk": "diff --git a/environment-api/src/main/java/com/sequenceiq/environment/api/v1/environment/model/base/EnvironmentNetworkBase.java b/environment-api/src/main/java/com/sequenceiq/environment/api/v1/environment/model/base/EnvironmentNetworkBase.java\nindex 67ac51adcb..f421e28483 100644\n--- a/environment-api/src/main/java/com/sequenceiq/environment/api/v1/environment/model/base/EnvironmentNetworkBase.java\n+++ b/environment-api/src/main/java/com/sequenceiq/environment/api/v1/environment/model/base/EnvironmentNetworkBase.java\n\n@@ -43,7 +44,7 @@ public abstract class EnvironmentNetworkBase {\n     private ServiceEndpointCreation serviceEndpointCreation = ServiceEndpointCreation.DISABLED;\n \n     @ApiModelProperty(EnvironmentModelDescription.PUBLIC_ENDPOINT_ACCESS_GATEWAY)\n-    private Boolean usePublicEndpointAccessGateway = false;\n+    private PublicEndpointAccessGateway publicEndpointAccessGateway = PublicEndpointAccessGateway.DISABLED;\n \n     @ApiModelProperty(value = EnvironmentModelDescription.ENDPOINT_ACCESS_GATEWAY_SUBNET_IDS)\n     private Set<String> endpointGatewaySubnetIds = Set.of();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjE2OTAyMg==", "url": "https://github.com/hortonworks/cloudbreak/pull/9620#discussion_r542169022", "bodyText": "Can you add more description here, please? What is the purpose of the subnetids?", "author": "akanto", "createdAt": "2020-12-14T07:39:02Z", "path": "environment-api/src/main/java/com/sequenceiq/environment/api/doc/environment/EnvironmentModelDescription.java", "diffHunk": "@@ -14,6 +14,9 @@\n     public static final String NETWORKCIDRS = \"The network cidrs for the configured vpc\";\n     public static final String PRIVATE_SUBNET_CREATION = \"A flag to enable or disable the private subnet creation.\";\n     public static final String SERVICE_ENDPOINT_CREATION = \"A flag to enable or disable the service endpoint creation.\";\n+    public static final String PUBLIC_ENDPOINT_ACCESS_GATEWAY = \"A flag to select a public or private endpoint access gateway.\";\n+    public static final String ENDPOINT_ACCESS_GATEWAY_SUBNET_IDS = \"Subnet ids for the endpoint access gateway. (Optional)\";", "originalCommit": "41e55e6bd5de0b37bf0ec078991bd80303e2f5d5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjg4OTUyOA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9620#discussion_r542889528", "bodyText": "Added more detail. Please check out the updated descriptions and let me know if they're sufficient.", "author": "hreeve-cloudera", "createdAt": "2020-12-14T22:44:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjE2OTAyMg=="}], "type": "inlineReview", "revised_code": {"commit": "9dca75f436b7eb17c699b40458fc5f826ecda1be", "chunk": "diff --git a/environment-api/src/main/java/com/sequenceiq/environment/api/doc/environment/EnvironmentModelDescription.java b/environment-api/src/main/java/com/sequenceiq/environment/api/doc/environment/EnvironmentModelDescription.java\nindex 8013dc99cf..813c596742 100644\n--- a/environment-api/src/main/java/com/sequenceiq/environment/api/doc/environment/EnvironmentModelDescription.java\n+++ b/environment-api/src/main/java/com/sequenceiq/environment/api/doc/environment/EnvironmentModelDescription.java\n\n@@ -14,9 +14,14 @@ public class EnvironmentModelDescription {\n     public static final String NETWORKCIDRS = \"The network cidrs for the configured vpc\";\n     public static final String PRIVATE_SUBNET_CREATION = \"A flag to enable or disable the private subnet creation.\";\n     public static final String SERVICE_ENDPOINT_CREATION = \"A flag to enable or disable the service endpoint creation.\";\n-    public static final String PUBLIC_ENDPOINT_ACCESS_GATEWAY = \"A flag to select a public or private endpoint access gateway.\";\n-    public static final String ENDPOINT_ACCESS_GATEWAY_SUBNET_IDS = \"Subnet ids for the endpoint access gateway. (Optional)\";\n-    public static final String ENDPOINT_ACCESS_GATEWAY_SUBNET_METAS = \"Subnet metadata for the endpoint access gateway. (Optional)\";\n+    public static final String PUBLIC_ENDPOINT_ACCESS_GATEWAY = \"A flag to enable the Public Endpoint Access Gateway, which provides public UI/API \" +\n+        \"access to private data lakes and data hubs.\";\n+    public static final String ENDPOINT_ACCESS_GATEWAY_SUBNET_IDS = \"Subnet ids for the Public Endpoint Access Gateway. If provided, these \" +\n+        \"are the subnets that will be used to create a public Knox endpoint for out-of-network UI/API access. If not provided, public subnets will be \" +\n+        \"selected from the subnet list provided for environment creation. (Optional)\";\n+    public static final String ENDPOINT_ACCESS_GATEWAY_SUBNET_METAS = \"Subnet metadata for the Public Endpoint Access Gateway. If provided, these \" +\n+        \"are the subnets that will be used to create a public Knox endpoint for out-of-network UI/API access. If not provided, public subnets will be \" +\n+        \"selected from the subnet list provided for environment creation. (Optional)\";\n     public static final String OUTBOUND_INTERNET_TRAFFIC = \"A flag to enable or disable the outbound internet traffic from the instances.\";\n     public static final String AWS_SPECIFIC_PARAMETERS = \"Subnet ids of the specified networks\";\n     public static final String AZURE_SPECIFIC_PARAMETERS = \"Subnet ids of the specified networks\";\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjIxMDg2Mw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9620#discussion_r542210863", "bodyText": "use enum please", "author": "doktoric", "createdAt": "2020-12-14T08:54:16Z", "path": "environment/src/main/java/com/sequenceiq/environment/environment/v1/converter/NetworkRequestToDtoConverter.java", "diffHunk": "@@ -110,4 +115,8 @@ private ServiceEndpointCreation getServiceEndpointCreation(EnvironmentNetworkReq\n     private OutboundInternetTraffic getOutboundInternetTraffic(EnvironmentNetworkRequest network) {\n         return Optional.ofNullable(network.getOutboundInternetTraffic()).orElse(OutboundInternetTraffic.ENABLED);\n     }\n+\n+    private Boolean getUsePublicEndpointAccessGateway(EnvironmentNetworkRequest network) {", "originalCommit": "41e55e6bd5de0b37bf0ec078991bd80303e2f5d5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjg5MDM1Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9620#discussion_r542890357", "bodyText": "I've created an enum PublicEndpointAccessGateway with values ENABLED and DISABLED, and used it in all the objects that have usePublicEndpointAccessGateway.", "author": "hreeve-cloudera", "createdAt": "2020-12-14T22:45:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjIxMDg2Mw=="}], "type": "inlineReview", "revised_code": {"commit": "9dca75f436b7eb17c699b40458fc5f826ecda1be", "chunk": "diff --git a/environment/src/main/java/com/sequenceiq/environment/environment/v1/converter/NetworkRequestToDtoConverter.java b/environment/src/main/java/com/sequenceiq/environment/environment/v1/converter/NetworkRequestToDtoConverter.java\nindex 91a3d3b747..f8d7b5387b 100644\n--- a/environment/src/main/java/com/sequenceiq/environment/environment/v1/converter/NetworkRequestToDtoConverter.java\n+++ b/environment/src/main/java/com/sequenceiq/environment/environment/v1/converter/NetworkRequestToDtoConverter.java\n\n@@ -116,7 +117,7 @@ public class NetworkRequestToDtoConverter {\n         return Optional.ofNullable(network.getOutboundInternetTraffic()).orElse(OutboundInternetTraffic.ENABLED);\n     }\n \n-    private Boolean getUsePublicEndpointAccessGateway(EnvironmentNetworkRequest network) {\n-        return Optional.ofNullable(network.getUsePublicEndpointAccessGateway()).orElse(false);\n+    private PublicEndpointAccessGateway getUsePublicEndpointAccessGateway(EnvironmentNetworkRequest network) {\n+        return Optional.ofNullable(network.getPublicEndpointAccessGateway()).orElse(PublicEndpointAccessGateway.DISABLED);\n     }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjIxMTM4MA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9620#discussion_r542211380", "bodyText": "we can not set nullable = false here", "author": "doktoric", "createdAt": "2020-12-14T08:55:01Z", "path": "environment/src/main/java/com/sequenceiq/environment/network/dao/domain/BaseNetwork.java", "diffHunk": "@@ -79,6 +79,12 @@\n     @Convert(converter = ServiceEndpointCreationConverter.class)\n     private ServiceEndpointCreation serviceEndpointCreation;\n \n+    private boolean usePublicEndpointAccessGateway;\n+\n+    @Convert(converter = JsonToString.class)\n+    @Column(columnDefinition = \"TEXT\", nullable = false)", "originalCommit": "41e55e6bd5de0b37bf0ec078991bd80303e2f5d5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9dca75f436b7eb17c699b40458fc5f826ecda1be", "chunk": "diff --git a/environment/src/main/java/com/sequenceiq/environment/network/dao/domain/BaseNetwork.java b/environment/src/main/java/com/sequenceiq/environment/network/dao/domain/BaseNetwork.java\nindex 95ccf1546a..332eda3ecc 100644\n--- a/environment/src/main/java/com/sequenceiq/environment/network/dao/domain/BaseNetwork.java\n+++ b/environment/src/main/java/com/sequenceiq/environment/network/dao/domain/BaseNetwork.java\n\n@@ -79,10 +81,11 @@ public abstract class BaseNetwork implements EnvironmentAwareResource {\n     @Convert(converter = ServiceEndpointCreationConverter.class)\n     private ServiceEndpointCreation serviceEndpointCreation;\n \n-    private boolean usePublicEndpointAccessGateway;\n+    @Convert(converter = PublicEndpointAccessGatewayConverter.class)\n+    private PublicEndpointAccessGateway publicEndpointAccessGateway;\n \n     @Convert(converter = JsonToString.class)\n-    @Column(columnDefinition = \"TEXT\", nullable = false)\n+    @Column(columnDefinition = \"TEXT\")\n     private Json endpointGatewaySubnetMetas = new Json(Map.of());\n \n     @Column(nullable = false)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjIxMTQ3OA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9620#discussion_r542211478", "bodyText": "enum please", "author": "doktoric", "createdAt": "2020-12-14T08:55:09Z", "path": "environment/src/main/java/com/sequenceiq/environment/network/dao/domain/BaseNetwork.java", "diffHunk": "@@ -169,6 +175,23 @@ public void setSubnetMetas(Map<String, CloudSubnet> subnetMetas) {\n         });\n     }\n \n+    public boolean isUsePublicEndpointAccessGateway() {\n+        return usePublicEndpointAccessGateway;\n+    }\n+\n+    public void setUsePublicEndpointAccessGateway(boolean usePublicEndpointAccessGateway) {", "originalCommit": "41e55e6bd5de0b37bf0ec078991bd80303e2f5d5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9dca75f436b7eb17c699b40458fc5f826ecda1be", "chunk": "diff --git a/environment/src/main/java/com/sequenceiq/environment/network/dao/domain/BaseNetwork.java b/environment/src/main/java/com/sequenceiq/environment/network/dao/domain/BaseNetwork.java\nindex 95ccf1546a..332eda3ecc 100644\n--- a/environment/src/main/java/com/sequenceiq/environment/network/dao/domain/BaseNetwork.java\n+++ b/environment/src/main/java/com/sequenceiq/environment/network/dao/domain/BaseNetwork.java\n\n@@ -175,12 +178,12 @@ public abstract class BaseNetwork implements EnvironmentAwareResource {\n         });\n     }\n \n-    public boolean isUsePublicEndpointAccessGateway() {\n-        return usePublicEndpointAccessGateway;\n+    public PublicEndpointAccessGateway getPublicEndpointAccessGateway() {\n+        return publicEndpointAccessGateway;\n     }\n \n-    public void setUsePublicEndpointAccessGateway(boolean usePublicEndpointAccessGateway) {\n-        this.usePublicEndpointAccessGateway = usePublicEndpointAccessGateway;\n+    public void setPublicEndpointAccessGateway(PublicEndpointAccessGateway publicEndpointAccessGateway) {\n+        this.publicEndpointAccessGateway = publicEndpointAccessGateway;\n     }\n \n     public void setEndpointGatewaySubnetMetas(Map<String, CloudSubnet> endpointGatewaySubnetMetas) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjIxMTUxNQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9620#discussion_r542211515", "bodyText": "enum please", "author": "doktoric", "createdAt": "2020-12-14T08:55:13Z", "path": "environment/src/main/java/com/sequenceiq/environment/network/dao/domain/BaseNetwork.java", "diffHunk": "@@ -169,6 +175,23 @@ public void setSubnetMetas(Map<String, CloudSubnet> subnetMetas) {\n         });\n     }\n \n+    public boolean isUsePublicEndpointAccessGateway() {\n+        return usePublicEndpointAccessGateway;\n+    }\n+\n+    public void setUsePublicEndpointAccessGateway(boolean usePublicEndpointAccessGateway) {\n+        this.usePublicEndpointAccessGateway = usePublicEndpointAccessGateway;\n+    }\n+\n+    public void setEndpointGatewaySubnetMetas(Map<String, CloudSubnet> endpointGatewaySubnetMetas) {", "originalCommit": "41e55e6bd5de0b37bf0ec078991bd80303e2f5d5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9dca75f436b7eb17c699b40458fc5f826ecda1be", "chunk": "diff --git a/environment/src/main/java/com/sequenceiq/environment/network/dao/domain/BaseNetwork.java b/environment/src/main/java/com/sequenceiq/environment/network/dao/domain/BaseNetwork.java\nindex 95ccf1546a..332eda3ecc 100644\n--- a/environment/src/main/java/com/sequenceiq/environment/network/dao/domain/BaseNetwork.java\n+++ b/environment/src/main/java/com/sequenceiq/environment/network/dao/domain/BaseNetwork.java\n\n@@ -175,12 +178,12 @@ public abstract class BaseNetwork implements EnvironmentAwareResource {\n         });\n     }\n \n-    public boolean isUsePublicEndpointAccessGateway() {\n-        return usePublicEndpointAccessGateway;\n+    public PublicEndpointAccessGateway getPublicEndpointAccessGateway() {\n+        return publicEndpointAccessGateway;\n     }\n \n-    public void setUsePublicEndpointAccessGateway(boolean usePublicEndpointAccessGateway) {\n-        this.usePublicEndpointAccessGateway = usePublicEndpointAccessGateway;\n+    public void setPublicEndpointAccessGateway(PublicEndpointAccessGateway publicEndpointAccessGateway) {\n+        this.publicEndpointAccessGateway = publicEndpointAccessGateway;\n     }\n \n     public void setEndpointGatewaySubnetMetas(Map<String, CloudSubnet> endpointGatewaySubnetMetas) {\n"}}, {"oid": "9dca75f436b7eb17c699b40458fc5f826ecda1be", "url": "https://github.com/hortonworks/cloudbreak/commit/9dca75f436b7eb17c699b40458fc5f826ecda1be", "message": "CB-10242 API changes to support semi-private networks\n\nAdds new optional fields 'publicEndpointAccessGateway' and\n'endpointGatewaySubnetIds' to the EnvironmentNetworkV1Request API object. These\nfields are persisted to the EnvironmentNetwork and NetworkDto BaseNetwork\nobjects. Adds new columns for these fields to the environment_network table\nand saves them to the database.\n\nTested with unit tests, and by manually setting the new fields in the IDE and\nverifying they were converted/persisted in the database correctly.", "committedDate": "2020-12-14T22:45:59Z", "type": "forcePushed"}, {"oid": "b33c6f0c5aede8e2980deb8721c30623f81c0ad8", "url": "https://github.com/hortonworks/cloudbreak/commit/b33c6f0c5aede8e2980deb8721c30623f81c0ad8", "message": "CB-10242 API changes to support semi-private networks\n\nAdds new optional fields 'publicEndpointAccessGateway' and\n'endpointGatewaySubnetIds' to the EnvironmentNetworkV1Request API object. These\nfields are persisted to the EnvironmentNetwork and NetworkDto BaseNetwork\nobjects. Adds new columns for these fields to the environment_network table\nand saves them to the database.\n\nTested with unit tests, and by manually setting the new fields in the IDE and\nverifying they were converted/persisted in the database correctly.", "committedDate": "2020-12-14T23:03:37Z", "type": "commit"}, {"oid": "b33c6f0c5aede8e2980deb8721c30623f81c0ad8", "url": "https://github.com/hortonworks/cloudbreak/commit/b33c6f0c5aede8e2980deb8721c30623f81c0ad8", "message": "CB-10242 API changes to support semi-private networks\n\nAdds new optional fields 'publicEndpointAccessGateway' and\n'endpointGatewaySubnetIds' to the EnvironmentNetworkV1Request API object. These\nfields are persisted to the EnvironmentNetwork and NetworkDto BaseNetwork\nobjects. Adds new columns for these fields to the environment_network table\nand saves them to the database.\n\nTested with unit tests, and by manually setting the new fields in the IDE and\nverifying they were converted/persisted in the database correctly.", "committedDate": "2020-12-14T23:03:37Z", "type": "forcePushed"}]}