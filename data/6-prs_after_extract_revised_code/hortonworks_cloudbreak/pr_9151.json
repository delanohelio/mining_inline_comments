{"pr_number": 9151, "pr_title": "CB-9149. Splitting large (> 16K) JSON logs on CB level in order to av\u2026", "pr_createdAt": "2020-10-06T10:06:46Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/9151", "timeline": [{"oid": "76bda607c5980805763a09b9cf1e80dca813077d", "url": "https://github.com/hortonworks/cloudbreak/commit/76bda607c5980805763a09b9cf1e80dca813077d", "message": "CB-9149. Splitting large (> 16K) JSON logs on CB level in order to avoid log rotation related issues by docker logging driver on K8s\ndetails:\n- in order to avoid large messages use a 12K max message length for JSON based logging (12K can be safe as we have many other fields, not only message)\n- split message into chunks based on the max chunk length\n- add partial metadata about the chunks, that can be handled by fluentd\n- using the same field names for partial metadata that is used by docker fluentd logging driver: partial_message, partial_id, partial_ordinal and partial_last\n- added some basic UTs for custom json layout", "committedDate": "2020-10-06T10:34:11Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDgxOTc4OA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9151#discussion_r500819788", "bodyText": "Is there any reason why we are not using the @value annotation of Spring like in all the other property holder components?", "author": "biharitomi", "createdAt": "2020-10-07T08:11:49Z", "path": "common/src/main/java/com/sequenceiq/cloudbreak/logger/PropertyHelper.java", "diffHunk": "@@ -0,0 +1,31 @@\n+package com.sequenceiq.cloudbreak.logger;\n+\n+import org.apache.commons.lang3.StringUtils;\n+\n+public class PropertyHelper {\n+\n+    private PropertyHelper() {\n+    }\n+\n+    public static Boolean isJsonFormatEnabled() {\n+        return Boolean.parseBoolean(getProperty(\"logger.format.json.enabled\", null));", "originalCommit": "76bda607c5980805763a09b9cf1e80dca813077d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTE1MDAzNg==", "url": "https://github.com/hortonworks/cloudbreak/pull/9151#discussion_r501150036", "bodyText": "that is for logging, it's needed right before Spring bootstrapping", "author": "oleewere", "createdAt": "2020-10-07T16:30:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDgxOTc4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY3Mzg1Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9151#discussion_r501673857", "bodyText": "This is a spring boot application so even the logging framework is initialised by Spring boot framework.\nI would give it a try to use @value annotation instead of this and let spring to build the dependencies in the right order(starting with logger dependencies)\nOn the other hand it would be a much cleaner code and you shouldn't have to deal with env variables and properties as @lacikaaa took this into the focus in his review.\nwhat do you think @lacikaaa ?", "author": "biharitomi", "createdAt": "2020-10-08T12:17:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDgxOTc4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY4MjYwOQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9151#discussion_r501682609", "bodyText": "Since logging is initialized\u00a0before\u00a0the\u00a0ApplicationContext\u00a0is created, it is not possible to control logging from\u00a0@PropertySources\u00a0in Spring\u00a0@Configuration\u00a0files. The only way to change the logging system or disable it entirely is via System properties.\n--\n\nSry, it is not supported, approving this PR", "author": "biharitomi", "createdAt": "2020-10-08T12:32:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDgxOTc4OA=="}], "type": "inlineReview", "revised_code": {"commit": "eee008047453663df542c2d10b9bb018561ee3aa", "chunk": "diff --git a/common/src/main/java/com/sequenceiq/cloudbreak/logger/PropertyHelper.java b/common/src/main/java/com/sequenceiq/cloudbreak/logger/LoggerConfiguration.java\nsimilarity index 85%\nrename from common/src/main/java/com/sequenceiq/cloudbreak/logger/PropertyHelper.java\nrename to common/src/main/java/com/sequenceiq/cloudbreak/logger/LoggerConfiguration.java\nindex 70197875c2..16901faf04 100644\n--- a/common/src/main/java/com/sequenceiq/cloudbreak/logger/PropertyHelper.java\n+++ b/common/src/main/java/com/sequenceiq/cloudbreak/logger/LoggerConfiguration.java\n\n@@ -2,9 +2,9 @@ package com.sequenceiq.cloudbreak.logger;\n \n import org.apache.commons.lang3.StringUtils;\n \n-public class PropertyHelper {\n+public class LoggerConfiguration {\n \n-    private PropertyHelper() {\n+    private LoggerConfiguration() {\n     }\n \n     public static Boolean isJsonFormatEnabled() {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDgyMTE0NA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9151#discussion_r500821144", "bodyText": "I would rename it to indicates that this class holds the logger related configurations that comes either from property or not. For example LoggerConfiguration.java", "author": "biharitomi", "createdAt": "2020-10-07T08:13:53Z", "path": "common/src/main/java/com/sequenceiq/cloudbreak/logger/PropertyHelper.java", "diffHunk": "@@ -0,0 +1,31 @@\n+package com.sequenceiq.cloudbreak.logger;\n+\n+import org.apache.commons.lang3.StringUtils;\n+\n+public class PropertyHelper {", "originalCommit": "76bda607c5980805763a09b9cf1e80dca813077d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "eee008047453663df542c2d10b9bb018561ee3aa", "chunk": "diff --git a/common/src/main/java/com/sequenceiq/cloudbreak/logger/PropertyHelper.java b/common/src/main/java/com/sequenceiq/cloudbreak/logger/LoggerConfiguration.java\nsimilarity index 85%\nrename from common/src/main/java/com/sequenceiq/cloudbreak/logger/PropertyHelper.java\nrename to common/src/main/java/com/sequenceiq/cloudbreak/logger/LoggerConfiguration.java\nindex 70197875c2..16901faf04 100644\n--- a/common/src/main/java/com/sequenceiq/cloudbreak/logger/PropertyHelper.java\n+++ b/common/src/main/java/com/sequenceiq/cloudbreak/logger/LoggerConfiguration.java\n\n@@ -2,9 +2,9 @@ package com.sequenceiq.cloudbreak.logger;\n \n import org.apache.commons.lang3.StringUtils;\n \n-public class PropertyHelper {\n+public class LoggerConfiguration {\n \n-    private PropertyHelper() {\n+    private LoggerConfiguration() {\n     }\n \n     public static Boolean isJsonFormatEnabled() {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDgzMzEzMw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9151#discussion_r500833133", "bodyText": "Would you mind to create tests based on the size message bigger than the 12KB limit or not?", "author": "biharitomi", "createdAt": "2020-10-07T08:32:36Z", "path": "common/src/test/java/com/sequenceiq/cloudbreak/logger/format/CustomJsonLayoutTest.java", "diffHunk": "@@ -0,0 +1,33 @@\n+package com.sequenceiq.cloudbreak.logger.format;\n+\n+import static org.junit.Assert.assertFalse;\n+import static org.junit.Assert.assertTrue;\n+\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+import ch.qos.logback.classic.spi.LoggingEvent;\n+\n+public class CustomJsonLayoutTest {\n+\n+    private CustomJsonLayout underTest;\n+\n+    @Before\n+    public void setUp() {", "originalCommit": "76bda607c5980805763a09b9cf1e80dca813077d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTE1MDUyOQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9151#discussion_r501150529", "bodyText": "that one is configurable, so im already testing that what happens if it reaches the limit", "author": "oleewere", "createdAt": "2020-10-07T16:30:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDgzMzEzMw=="}], "type": "inlineReview", "revised_code": {"commit": "ed19623361d57d4e5f03fdfedd82ca26a2fe9add", "chunk": "diff --git a/common/src/test/java/com/sequenceiq/cloudbreak/logger/format/CustomJsonLayoutTest.java b/common/src/test/java/com/sequenceiq/cloudbreak/logger/format/CustomJsonLayoutTest.java\nindex ed13798dd2..0384fe98d2 100644\n--- a/common/src/test/java/com/sequenceiq/cloudbreak/logger/format/CustomJsonLayoutTest.java\n+++ b/common/src/test/java/com/sequenceiq/cloudbreak/logger/format/CustomJsonLayoutTest.java\n\n@@ -20,14 +20,14 @@ public class CustomJsonLayoutTest {\n     @Test\n     public void testLogIsSplitted() {\n         LoggingEvent loggingEvent = new LoggingEvent();\n-        String result = underTest.doLayout(loggingEvent, \"LONG MESSAGE\", null);\n+        String result = underTest.doLayout(loggingEvent, \"LONG MESSAGE\");\n         assertTrue(result.contains(\"partial_message=true\"));\n     }\n \n     @Test\n     public void testLogIsNotSplitted() {\n         LoggingEvent loggingEvent = new LoggingEvent();\n-        String result = underTest.doLayout(loggingEvent, \"MESSAGE\", null);\n+        String result = underTest.doLayout(loggingEvent, \"MESSAGE\");\n         assertFalse(result.contains(\"partial_message=true\"));\n     }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDg2NDE5NA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9151#discussion_r500864194", "bodyText": "this Splitter.fixedLength(this.maxChunkLength) could be initiated in the constructor", "author": "lacikaaa", "createdAt": "2020-10-07T09:20:45Z", "path": "common/src/main/java/com/sequenceiq/cloudbreak/logger/format/CustomJsonLayout.java", "diffHunk": "@@ -1,29 +1,65 @@\n package com.sequenceiq.cloudbreak.logger.format;\n \n+import java.util.Iterator;\n import java.util.LinkedHashMap;\n import java.util.Map;\n \n+import org.apache.commons.lang3.StringUtils;\n+\n+import com.google.common.base.Splitter;\n+import com.sequenceiq.cloudbreak.logger.PartialMessageMetadata;\n+\n import ch.qos.logback.classic.spi.ILoggingEvent;\n import ch.qos.logback.contrib.json.classic.JsonLayout;\n import ch.qos.logback.core.CoreConstants;\n \n public class CustomJsonLayout extends JsonLayout {\n \n+    private static final String PARTIAL_MESSAGE_FIELD = \"partial_message\";\n+\n+    private static final String PARTIAL_CHUNK_ID_FIELD = \"partial_id\";\n+\n+    private static final String PARTIAL_CHUNK_INDEX_FIELD = \"partial_ordinal\";\n+\n+    private static final String PARTIAL_LAST_FIELD = \"partial_last\";\n+\n+    private static final String PARTIAL_MESSAGE_FLAG = \"true\";\n+\n     private final String contextName;\n \n-    CustomJsonLayout(String contextName) {\n+    private final Integer maxChunkLength;\n+\n+    CustomJsonLayout(String contextName, Integer maxChunkLength) {\n         this.contextName = contextName;\n+        this.maxChunkLength = maxChunkLength;\n     }\n \n     public String doLayout(ILoggingEvent event, String fullLogMessage, String loggerNameFilter) {\n-        Map map = toJsonMap(event, fullLogMessage, loggerNameFilter);\n-        if (map == null || map.isEmpty()) {\n+        if (StringUtils.length(fullLogMessage) > this.maxChunkLength) {\n+            StringBuilder stringBuilder = new StringBuilder();\n+            String chunkId = Integer.toHexString(event.hashCode());\n+            Iterable<String> messages = Splitter.fixedLength(this.maxChunkLength).split(fullLogMessage);", "originalCommit": "76bda607c5980805763a09b9cf1e80dca813077d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "eee008047453663df542c2d10b9bb018561ee3aa", "chunk": "diff --git a/common/src/main/java/com/sequenceiq/cloudbreak/logger/format/CustomJsonLayout.java b/common/src/main/java/com/sequenceiq/cloudbreak/logger/format/CustomJsonLayout.java\nindex b08168b304..df9924dff7 100644\n--- a/common/src/main/java/com/sequenceiq/cloudbreak/logger/format/CustomJsonLayout.java\n+++ b/common/src/main/java/com/sequenceiq/cloudbreak/logger/format/CustomJsonLayout.java\n\n@@ -29,37 +29,39 @@ public class CustomJsonLayout extends JsonLayout {\n \n     private final Integer maxChunkLength;\n \n+    private final Splitter splitter;\n+\n     CustomJsonLayout(String contextName, Integer maxChunkLength) {\n         this.contextName = contextName;\n         this.maxChunkLength = maxChunkLength;\n+        this.splitter = Splitter.fixedLength(this.maxChunkLength);\n     }\n \n-    public String doLayout(ILoggingEvent event, String fullLogMessage, String loggerNameFilter) {\n-        if (StringUtils.length(fullLogMessage) > this.maxChunkLength) {\n+    public String doLayout(ILoggingEvent event, String fullLogMessage) {\n+        if (StringUtils.length(fullLogMessage) > maxChunkLength) {\n             StringBuilder stringBuilder = new StringBuilder();\n             String chunkId = Integer.toHexString(event.hashCode());\n-            Iterable<String> messages = Splitter.fixedLength(this.maxChunkLength).split(fullLogMessage);\n-            int currentIndex = 0;\n+            Iterable<String> messages = splitter.split(fullLogMessage);\n             Iterator<String> messageIterator = messages.iterator();\n-            while (messageIterator.hasNext()) {\n+            for (int currentIndex = 0; messageIterator.hasNext(); currentIndex++) {\n                 String message = messageIterator.next();\n                 PartialMessageMetadata partialMessageMetadata = new PartialMessageMetadata(chunkId, currentIndex, !messageIterator.hasNext());\n-                stringBuilder.append(toJsonRecordString(toJsonMap(event, message, loggerNameFilter, partialMessageMetadata)));\n+                stringBuilder.append(toJsonRecordString(toJsonMap(event, message, partialMessageMetadata)));\n             }\n             return stringBuilder.toString();\n         } else {\n-            return toJsonRecordString(toJsonMap(event, fullLogMessage, loggerNameFilter, null));\n+            return toJsonRecordString(toJsonMap(event, fullLogMessage, null));\n         }\n     }\n \n-    private String toJsonRecordString(Map map) {\n+    private String toJsonRecordString(Map<String, Object> map) {\n         if (map.isEmpty()) {\n             return null;\n         }\n         return toJsonString(map) + CoreConstants.LINE_SEPARATOR;\n     }\n \n-    private Map toJsonMap(ILoggingEvent event, String fullLogMessage, String loggerNameFilter, PartialMessageMetadata partialMessageMetadata) {\n+    private Map<String, Object> toJsonMap(ILoggingEvent event, String fullLogMessage, PartialMessageMetadata partialMessageMetadata) {\n         Map<String, Object> map = new LinkedHashMap<>();\n         addTimestamp(TIMESTAMP_ATTR_NAME, this.includeTimestamp, event.getTimeStamp(), map);\n         add(LEVEL_ATTR_NAME, this.includeLevel, String.valueOf(event.getLevel()), map);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDg2NDUwNA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9151#discussion_r500864504", "bodyText": "this. is unnecessary", "author": "lacikaaa", "createdAt": "2020-10-07T09:21:18Z", "path": "common/src/main/java/com/sequenceiq/cloudbreak/logger/format/CustomJsonLayout.java", "diffHunk": "@@ -1,29 +1,65 @@\n package com.sequenceiq.cloudbreak.logger.format;\n \n+import java.util.Iterator;\n import java.util.LinkedHashMap;\n import java.util.Map;\n \n+import org.apache.commons.lang3.StringUtils;\n+\n+import com.google.common.base.Splitter;\n+import com.sequenceiq.cloudbreak.logger.PartialMessageMetadata;\n+\n import ch.qos.logback.classic.spi.ILoggingEvent;\n import ch.qos.logback.contrib.json.classic.JsonLayout;\n import ch.qos.logback.core.CoreConstants;\n \n public class CustomJsonLayout extends JsonLayout {\n \n+    private static final String PARTIAL_MESSAGE_FIELD = \"partial_message\";\n+\n+    private static final String PARTIAL_CHUNK_ID_FIELD = \"partial_id\";\n+\n+    private static final String PARTIAL_CHUNK_INDEX_FIELD = \"partial_ordinal\";\n+\n+    private static final String PARTIAL_LAST_FIELD = \"partial_last\";\n+\n+    private static final String PARTIAL_MESSAGE_FLAG = \"true\";\n+\n     private final String contextName;\n \n-    CustomJsonLayout(String contextName) {\n+    private final Integer maxChunkLength;\n+\n+    CustomJsonLayout(String contextName, Integer maxChunkLength) {\n         this.contextName = contextName;\n+        this.maxChunkLength = maxChunkLength;\n     }\n \n     public String doLayout(ILoggingEvent event, String fullLogMessage, String loggerNameFilter) {\n-        Map map = toJsonMap(event, fullLogMessage, loggerNameFilter);\n-        if (map == null || map.isEmpty()) {\n+        if (StringUtils.length(fullLogMessage) > this.maxChunkLength) {", "originalCommit": "76bda607c5980805763a09b9cf1e80dca813077d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "eee008047453663df542c2d10b9bb018561ee3aa", "chunk": "diff --git a/common/src/main/java/com/sequenceiq/cloudbreak/logger/format/CustomJsonLayout.java b/common/src/main/java/com/sequenceiq/cloudbreak/logger/format/CustomJsonLayout.java\nindex b08168b304..df9924dff7 100644\n--- a/common/src/main/java/com/sequenceiq/cloudbreak/logger/format/CustomJsonLayout.java\n+++ b/common/src/main/java/com/sequenceiq/cloudbreak/logger/format/CustomJsonLayout.java\n\n@@ -29,37 +29,39 @@ public class CustomJsonLayout extends JsonLayout {\n \n     private final Integer maxChunkLength;\n \n+    private final Splitter splitter;\n+\n     CustomJsonLayout(String contextName, Integer maxChunkLength) {\n         this.contextName = contextName;\n         this.maxChunkLength = maxChunkLength;\n+        this.splitter = Splitter.fixedLength(this.maxChunkLength);\n     }\n \n-    public String doLayout(ILoggingEvent event, String fullLogMessage, String loggerNameFilter) {\n-        if (StringUtils.length(fullLogMessage) > this.maxChunkLength) {\n+    public String doLayout(ILoggingEvent event, String fullLogMessage) {\n+        if (StringUtils.length(fullLogMessage) > maxChunkLength) {\n             StringBuilder stringBuilder = new StringBuilder();\n             String chunkId = Integer.toHexString(event.hashCode());\n-            Iterable<String> messages = Splitter.fixedLength(this.maxChunkLength).split(fullLogMessage);\n-            int currentIndex = 0;\n+            Iterable<String> messages = splitter.split(fullLogMessage);\n             Iterator<String> messageIterator = messages.iterator();\n-            while (messageIterator.hasNext()) {\n+            for (int currentIndex = 0; messageIterator.hasNext(); currentIndex++) {\n                 String message = messageIterator.next();\n                 PartialMessageMetadata partialMessageMetadata = new PartialMessageMetadata(chunkId, currentIndex, !messageIterator.hasNext());\n-                stringBuilder.append(toJsonRecordString(toJsonMap(event, message, loggerNameFilter, partialMessageMetadata)));\n+                stringBuilder.append(toJsonRecordString(toJsonMap(event, message, partialMessageMetadata)));\n             }\n             return stringBuilder.toString();\n         } else {\n-            return toJsonRecordString(toJsonMap(event, fullLogMessage, loggerNameFilter, null));\n+            return toJsonRecordString(toJsonMap(event, fullLogMessage, null));\n         }\n     }\n \n-    private String toJsonRecordString(Map map) {\n+    private String toJsonRecordString(Map<String, Object> map) {\n         if (map.isEmpty()) {\n             return null;\n         }\n         return toJsonString(map) + CoreConstants.LINE_SEPARATOR;\n     }\n \n-    private Map toJsonMap(ILoggingEvent event, String fullLogMessage, String loggerNameFilter, PartialMessageMetadata partialMessageMetadata) {\n+    private Map<String, Object> toJsonMap(ILoggingEvent event, String fullLogMessage, PartialMessageMetadata partialMessageMetadata) {\n         Map<String, Object> map = new LinkedHashMap<>();\n         addTimestamp(TIMESTAMP_ATTR_NAME, this.includeTimestamp, event.getTimeStamp(), map);\n         add(LEVEL_ATTR_NAME, this.includeLevel, String.valueOf(event.getLevel()), map);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDg2NzUyNw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9151#discussion_r500867527", "bodyText": "you can save one line here with:\nfor (int currentIndex = 0; messageIterator.hasNext(); currentIndex++) {", "author": "lacikaaa", "createdAt": "2020-10-07T09:25:58Z", "path": "common/src/main/java/com/sequenceiq/cloudbreak/logger/format/CustomJsonLayout.java", "diffHunk": "@@ -1,29 +1,65 @@\n package com.sequenceiq.cloudbreak.logger.format;\n \n+import java.util.Iterator;\n import java.util.LinkedHashMap;\n import java.util.Map;\n \n+import org.apache.commons.lang3.StringUtils;\n+\n+import com.google.common.base.Splitter;\n+import com.sequenceiq.cloudbreak.logger.PartialMessageMetadata;\n+\n import ch.qos.logback.classic.spi.ILoggingEvent;\n import ch.qos.logback.contrib.json.classic.JsonLayout;\n import ch.qos.logback.core.CoreConstants;\n \n public class CustomJsonLayout extends JsonLayout {\n \n+    private static final String PARTIAL_MESSAGE_FIELD = \"partial_message\";\n+\n+    private static final String PARTIAL_CHUNK_ID_FIELD = \"partial_id\";\n+\n+    private static final String PARTIAL_CHUNK_INDEX_FIELD = \"partial_ordinal\";\n+\n+    private static final String PARTIAL_LAST_FIELD = \"partial_last\";\n+\n+    private static final String PARTIAL_MESSAGE_FLAG = \"true\";\n+\n     private final String contextName;\n \n-    CustomJsonLayout(String contextName) {\n+    private final Integer maxChunkLength;\n+\n+    CustomJsonLayout(String contextName, Integer maxChunkLength) {\n         this.contextName = contextName;\n+        this.maxChunkLength = maxChunkLength;\n     }\n \n     public String doLayout(ILoggingEvent event, String fullLogMessage, String loggerNameFilter) {\n-        Map map = toJsonMap(event, fullLogMessage, loggerNameFilter);\n-        if (map == null || map.isEmpty()) {\n+        if (StringUtils.length(fullLogMessage) > this.maxChunkLength) {\n+            StringBuilder stringBuilder = new StringBuilder();\n+            String chunkId = Integer.toHexString(event.hashCode());\n+            Iterable<String> messages = Splitter.fixedLength(this.maxChunkLength).split(fullLogMessage);\n+            int currentIndex = 0;\n+            Iterator<String> messageIterator = messages.iterator();\n+            while (messageIterator.hasNext()) {", "originalCommit": "76bda607c5980805763a09b9cf1e80dca813077d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "eee008047453663df542c2d10b9bb018561ee3aa", "chunk": "diff --git a/common/src/main/java/com/sequenceiq/cloudbreak/logger/format/CustomJsonLayout.java b/common/src/main/java/com/sequenceiq/cloudbreak/logger/format/CustomJsonLayout.java\nindex b08168b304..df9924dff7 100644\n--- a/common/src/main/java/com/sequenceiq/cloudbreak/logger/format/CustomJsonLayout.java\n+++ b/common/src/main/java/com/sequenceiq/cloudbreak/logger/format/CustomJsonLayout.java\n\n@@ -29,37 +29,39 @@ public class CustomJsonLayout extends JsonLayout {\n \n     private final Integer maxChunkLength;\n \n+    private final Splitter splitter;\n+\n     CustomJsonLayout(String contextName, Integer maxChunkLength) {\n         this.contextName = contextName;\n         this.maxChunkLength = maxChunkLength;\n+        this.splitter = Splitter.fixedLength(this.maxChunkLength);\n     }\n \n-    public String doLayout(ILoggingEvent event, String fullLogMessage, String loggerNameFilter) {\n-        if (StringUtils.length(fullLogMessage) > this.maxChunkLength) {\n+    public String doLayout(ILoggingEvent event, String fullLogMessage) {\n+        if (StringUtils.length(fullLogMessage) > maxChunkLength) {\n             StringBuilder stringBuilder = new StringBuilder();\n             String chunkId = Integer.toHexString(event.hashCode());\n-            Iterable<String> messages = Splitter.fixedLength(this.maxChunkLength).split(fullLogMessage);\n-            int currentIndex = 0;\n+            Iterable<String> messages = splitter.split(fullLogMessage);\n             Iterator<String> messageIterator = messages.iterator();\n-            while (messageIterator.hasNext()) {\n+            for (int currentIndex = 0; messageIterator.hasNext(); currentIndex++) {\n                 String message = messageIterator.next();\n                 PartialMessageMetadata partialMessageMetadata = new PartialMessageMetadata(chunkId, currentIndex, !messageIterator.hasNext());\n-                stringBuilder.append(toJsonRecordString(toJsonMap(event, message, loggerNameFilter, partialMessageMetadata)));\n+                stringBuilder.append(toJsonRecordString(toJsonMap(event, message, partialMessageMetadata)));\n             }\n             return stringBuilder.toString();\n         } else {\n-            return toJsonRecordString(toJsonMap(event, fullLogMessage, loggerNameFilter, null));\n+            return toJsonRecordString(toJsonMap(event, fullLogMessage, null));\n         }\n     }\n \n-    private String toJsonRecordString(Map map) {\n+    private String toJsonRecordString(Map<String, Object> map) {\n         if (map.isEmpty()) {\n             return null;\n         }\n         return toJsonString(map) + CoreConstants.LINE_SEPARATOR;\n     }\n \n-    private Map toJsonMap(ILoggingEvent event, String fullLogMessage, String loggerNameFilter, PartialMessageMetadata partialMessageMetadata) {\n+    private Map<String, Object> toJsonMap(ILoggingEvent event, String fullLogMessage, PartialMessageMetadata partialMessageMetadata) {\n         Map<String, Object> map = new LinkedHashMap<>();\n         addTimestamp(TIMESTAMP_ATTR_NAME, this.includeTimestamp, event.getTimeStamp(), map);\n         add(LEVEL_ATTR_NAME, this.includeLevel, String.valueOf(event.getLevel()), map);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDg3MjQ3Mg==", "url": "https://github.com/hortonworks/cloudbreak/pull/9151#discussion_r500872472", "bodyText": "loggerNameFilter is not used\nmethod definition should look like: private Map<String, Object> toJsonMap\n\ntoJsonRecordString and toJsonString parameter is also missing the same", "author": "lacikaaa", "createdAt": "2020-10-07T09:33:52Z", "path": "common/src/main/java/com/sequenceiq/cloudbreak/logger/format/CustomJsonLayout.java", "diffHunk": "@@ -1,29 +1,65 @@\n package com.sequenceiq.cloudbreak.logger.format;\n \n+import java.util.Iterator;\n import java.util.LinkedHashMap;\n import java.util.Map;\n \n+import org.apache.commons.lang3.StringUtils;\n+\n+import com.google.common.base.Splitter;\n+import com.sequenceiq.cloudbreak.logger.PartialMessageMetadata;\n+\n import ch.qos.logback.classic.spi.ILoggingEvent;\n import ch.qos.logback.contrib.json.classic.JsonLayout;\n import ch.qos.logback.core.CoreConstants;\n \n public class CustomJsonLayout extends JsonLayout {\n \n+    private static final String PARTIAL_MESSAGE_FIELD = \"partial_message\";\n+\n+    private static final String PARTIAL_CHUNK_ID_FIELD = \"partial_id\";\n+\n+    private static final String PARTIAL_CHUNK_INDEX_FIELD = \"partial_ordinal\";\n+\n+    private static final String PARTIAL_LAST_FIELD = \"partial_last\";\n+\n+    private static final String PARTIAL_MESSAGE_FLAG = \"true\";\n+\n     private final String contextName;\n \n-    CustomJsonLayout(String contextName) {\n+    private final Integer maxChunkLength;\n+\n+    CustomJsonLayout(String contextName, Integer maxChunkLength) {\n         this.contextName = contextName;\n+        this.maxChunkLength = maxChunkLength;\n     }\n \n     public String doLayout(ILoggingEvent event, String fullLogMessage, String loggerNameFilter) {\n-        Map map = toJsonMap(event, fullLogMessage, loggerNameFilter);\n-        if (map == null || map.isEmpty()) {\n+        if (StringUtils.length(fullLogMessage) > this.maxChunkLength) {\n+            StringBuilder stringBuilder = new StringBuilder();\n+            String chunkId = Integer.toHexString(event.hashCode());\n+            Iterable<String> messages = Splitter.fixedLength(this.maxChunkLength).split(fullLogMessage);\n+            int currentIndex = 0;\n+            Iterator<String> messageIterator = messages.iterator();\n+            while (messageIterator.hasNext()) {\n+                String message = messageIterator.next();\n+                PartialMessageMetadata partialMessageMetadata = new PartialMessageMetadata(chunkId, currentIndex, !messageIterator.hasNext());\n+                stringBuilder.append(toJsonRecordString(toJsonMap(event, message, loggerNameFilter, partialMessageMetadata)));\n+            }\n+            return stringBuilder.toString();\n+        } else {\n+            return toJsonRecordString(toJsonMap(event, fullLogMessage, loggerNameFilter, null));\n+        }\n+    }\n+\n+    private String toJsonRecordString(Map map) {\n+        if (map.isEmpty()) {\n             return null;\n         }\n         return toJsonString(map) + CoreConstants.LINE_SEPARATOR;\n     }\n \n-    private Map toJsonMap(ILoggingEvent event, String fullLogMessage, String loggerNameFilter) {\n+    private Map toJsonMap(ILoggingEvent event, String fullLogMessage, String loggerNameFilter, PartialMessageMetadata partialMessageMetadata) {", "originalCommit": "76bda607c5980805763a09b9cf1e80dca813077d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTE3Mzg1NA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9151#discussion_r501173854", "bodyText": "sure i can remove loggerNameFilter, it seems anonymiziation was removed by @biharitomi  before, and the parameter was not cleaned up from MaskingPatternLayout (because of this, logback.xml configs needs to be updated) ... later we can remove the whole maskingPatternLayout, because at the moment, that is - technically - not doing anything at all (as that is for masking the logs, but it does not do that anymore)", "author": "oleewere", "createdAt": "2020-10-07T17:07:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDg3MjQ3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTE3NTMzNQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9151#discussion_r501175335", "bodyText": "with the Map, I have followed the JsonLayoutBase class, but that the same anyway ..so whatever, i can change that", "author": "oleewere", "createdAt": "2020-10-07T17:09:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDg3MjQ3Mg=="}], "type": "inlineReview", "revised_code": {"commit": "eee008047453663df542c2d10b9bb018561ee3aa", "chunk": "diff --git a/common/src/main/java/com/sequenceiq/cloudbreak/logger/format/CustomJsonLayout.java b/common/src/main/java/com/sequenceiq/cloudbreak/logger/format/CustomJsonLayout.java\nindex b08168b304..df9924dff7 100644\n--- a/common/src/main/java/com/sequenceiq/cloudbreak/logger/format/CustomJsonLayout.java\n+++ b/common/src/main/java/com/sequenceiq/cloudbreak/logger/format/CustomJsonLayout.java\n\n@@ -29,37 +29,39 @@ public class CustomJsonLayout extends JsonLayout {\n \n     private final Integer maxChunkLength;\n \n+    private final Splitter splitter;\n+\n     CustomJsonLayout(String contextName, Integer maxChunkLength) {\n         this.contextName = contextName;\n         this.maxChunkLength = maxChunkLength;\n+        this.splitter = Splitter.fixedLength(this.maxChunkLength);\n     }\n \n-    public String doLayout(ILoggingEvent event, String fullLogMessage, String loggerNameFilter) {\n-        if (StringUtils.length(fullLogMessage) > this.maxChunkLength) {\n+    public String doLayout(ILoggingEvent event, String fullLogMessage) {\n+        if (StringUtils.length(fullLogMessage) > maxChunkLength) {\n             StringBuilder stringBuilder = new StringBuilder();\n             String chunkId = Integer.toHexString(event.hashCode());\n-            Iterable<String> messages = Splitter.fixedLength(this.maxChunkLength).split(fullLogMessage);\n-            int currentIndex = 0;\n+            Iterable<String> messages = splitter.split(fullLogMessage);\n             Iterator<String> messageIterator = messages.iterator();\n-            while (messageIterator.hasNext()) {\n+            for (int currentIndex = 0; messageIterator.hasNext(); currentIndex++) {\n                 String message = messageIterator.next();\n                 PartialMessageMetadata partialMessageMetadata = new PartialMessageMetadata(chunkId, currentIndex, !messageIterator.hasNext());\n-                stringBuilder.append(toJsonRecordString(toJsonMap(event, message, loggerNameFilter, partialMessageMetadata)));\n+                stringBuilder.append(toJsonRecordString(toJsonMap(event, message, partialMessageMetadata)));\n             }\n             return stringBuilder.toString();\n         } else {\n-            return toJsonRecordString(toJsonMap(event, fullLogMessage, loggerNameFilter, null));\n+            return toJsonRecordString(toJsonMap(event, fullLogMessage, null));\n         }\n     }\n \n-    private String toJsonRecordString(Map map) {\n+    private String toJsonRecordString(Map<String, Object> map) {\n         if (map.isEmpty()) {\n             return null;\n         }\n         return toJsonString(map) + CoreConstants.LINE_SEPARATOR;\n     }\n \n-    private Map toJsonMap(ILoggingEvent event, String fullLogMessage, String loggerNameFilter, PartialMessageMetadata partialMessageMetadata) {\n+    private Map<String, Object> toJsonMap(ILoggingEvent event, String fullLogMessage, PartialMessageMetadata partialMessageMetadata) {\n         Map<String, Object> map = new LinkedHashMap<>();\n         addTimestamp(TIMESTAMP_ATTR_NAME, this.includeTimestamp, event.getTimeStamp(), map);\n         add(LEVEL_ATTR_NAME, this.includeLevel, String.valueOf(event.getLevel()), map);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDg3NDUxMA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9151#discussion_r500874510", "bodyText": "this. can be removed", "author": "lacikaaa", "createdAt": "2020-10-07T09:37:06Z", "path": "common/src/main/java/com/sequenceiq/cloudbreak/logger/format/JsonLayoutFormat.java", "diffHunk": "@@ -10,8 +10,8 @@\n \n     private final CustomJsonLayout jsonLayout;\n \n-    JsonLayoutFormat(String contextName) {\n-        this.jsonLayout = new CustomJsonLayout(contextName);\n+    JsonLayoutFormat(String contextName, Integer maxChunkLength) {\n+        this.jsonLayout = new CustomJsonLayout(contextName, maxChunkLength);", "originalCommit": "76bda607c5980805763a09b9cf1e80dca813077d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "eee008047453663df542c2d10b9bb018561ee3aa", "chunk": "diff --git a/common/src/main/java/com/sequenceiq/cloudbreak/logger/format/JsonLayoutFormat.java b/common/src/main/java/com/sequenceiq/cloudbreak/logger/format/JsonLayoutFormat.java\nindex 20acef2619..997d8ac958 100644\n--- a/common/src/main/java/com/sequenceiq/cloudbreak/logger/format/JsonLayoutFormat.java\n+++ b/common/src/main/java/com/sequenceiq/cloudbreak/logger/format/JsonLayoutFormat.java\n\n@@ -11,7 +11,7 @@ public class JsonLayoutFormat extends SimpleLayoutFormat {\n     private final CustomJsonLayout jsonLayout;\n \n     JsonLayoutFormat(String contextName, Integer maxChunkLength) {\n-        this.jsonLayout = new CustomJsonLayout(contextName, maxChunkLength);\n+        jsonLayout = new CustomJsonLayout(contextName, maxChunkLength);\n         jsonLayout.setIncludeMessage(true);\n         jsonLayout.setAppendLineSeparator(true);\n         jsonLayout.setJsonFormatter(m -> new ObjectMapper().writeValueAsString(m));\n"}}, {"oid": "eee008047453663df542c2d10b9bb018561ee3aa", "url": "https://github.com/hortonworks/cloudbreak/commit/eee008047453663df542c2d10b9bb018561ee3aa", "message": "CB-9149. Splitting large (> 16K) JSON logs on CB level in order to avoid log rotation related issues by docker logging driver on K8s\ndetails:\n- in order to avoid large messages use a 12K max message length for JSON based logging (12K can be safe as we have many other fields, not only message)\n- split message into chunks based on the max chunk length\n- add partial metadata about the chunks, that can be handled by fluentd\n- using the same field names for partial metadata that is used by docker fluentd logging driver: partial_message, partial_id, partial_ordinal and partial_last\n- added some basic UTs for custom json layout\n- cleaning up loggerNameFilter from masking pattern layout (not deleting that yet)", "committedDate": "2020-10-07T17:18:42Z", "type": "forcePushed"}, {"oid": "ed19623361d57d4e5f03fdfedd82ca26a2fe9add", "url": "https://github.com/hortonworks/cloudbreak/commit/ed19623361d57d4e5f03fdfedd82ca26a2fe9add", "message": "CB-9149. Splitting large (> 16K) JSON logs on CB level in order to avoid log rotation related issues by docker logging driver on K8s\ndetails:\n- in order to avoid large messages use a 12K max message length for JSON based logging (12K can be safe as we have many other fields, not only message)\n- split message into chunks based on the max chunk length\n- add partial metadata about the chunks, that can be handled by fluentd\n- using the same field names for partial metadata that is used by docker fluentd logging driver: partial_message, partial_id, partial_ordinal and partial_last\n- added some basic UTs for custom json layout\n- cleaning up loggerNameFilter from masking pattern layout (not deleting that yet)", "committedDate": "2020-10-07T17:24:58Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTQ4MzgxMw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9151#discussion_r501483813", "bodyText": "I don't really get this. so there are 3 properties above, you wrote them with lowercase and dot separated and right after you convert them. wouldn't be it easier just to have them written the way we expect them?", "author": "lacikaaa", "createdAt": "2020-10-08T06:46:55Z", "path": "common/src/main/java/com/sequenceiq/cloudbreak/logger/LoggerConfiguration.java", "diffHunk": "@@ -0,0 +1,31 @@\n+package com.sequenceiq.cloudbreak.logger;\n+\n+import org.apache.commons.lang3.StringUtils;\n+\n+public class LoggerConfiguration {\n+\n+    private LoggerConfiguration() {\n+    }\n+\n+    public static Boolean isJsonFormatEnabled() {\n+        return Boolean.parseBoolean(getProperty(\"logger.format.json.enabled\", null));\n+    }\n+\n+    public static String getJsonFormatMdcName() {\n+        return getProperty(\"logger.format.json.mdc.name\", \"context\");\n+    }\n+\n+    public static Integer getSplitterMaxChunLength() {\n+        return Integer.parseInt(getProperty(\"logger.appender.splitter.max.chunk.length\", \"12000\"));\n+    }\n+\n+    private static String getProperty(String property, String defaultValue) {\n+        String envProperty = property.toUpperCase().replace(\".\", \"_\");", "originalCommit": "ed19623361d57d4e5f03fdfedd82ca26a2fe9add", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTYzNDg1MA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9151#discussion_r501634850", "bodyText": "we use this both as a system property + environment variable (env+property needs to be the same key, if we are converting it, that's sure those are the ssme), first we are checking the environment property, lower we are simply checking the system property (system property used mostly locally, env vars are used for qa/mow deployments), we can do the opposite here, but I think it does not really matter.", "author": "oleewere", "createdAt": "2020-10-08T11:05:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTQ4MzgxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY3OTk0NA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9151#discussion_r501679944", "bodyText": "That's why we should use Spring instead of implementing a Spring feature this way....", "author": "biharitomi", "createdAt": "2020-10-08T12:27:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTQ4MzgxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY4MjE2Mw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9151#discussion_r501682163", "bodyText": "sry, it is not supported by spring", "author": "biharitomi", "createdAt": "2020-10-08T12:31:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTQ4MzgxMw=="}], "type": "inlineReview", "revised_code": null}, {"oid": "f00d3dd71a139bbbfd75185fe044be745d07eb31", "url": "https://github.com/hortonworks/cloudbreak/commit/f00d3dd71a139bbbfd75185fe044be745d07eb31", "message": "CB-9149. Splitting large (> 16K) JSON logs on CB level in order to avoid log rotation related issues by docker logging driver on K8s\ndetails:\n- in order to avoid large messages use a 12K max message length for JSON based logging (12K can be safe as we have many other fields, not only message)\n- split message into chunks based on the max chunk length\n- add partial metadata about the chunks, that can be handled by fluentd\n- using the same field names for partial metadata that is used by docker fluentd logging driver: partial_message, partial_id, partial_ordinal and partial_last\n- added some basic UTs for custom json layout\n- cleaning up loggerNameFilter from masking pattern layout (not deleting that yet)", "committedDate": "2020-10-11T08:29:12Z", "type": "commit"}, {"oid": "f00d3dd71a139bbbfd75185fe044be745d07eb31", "url": "https://github.com/hortonworks/cloudbreak/commit/f00d3dd71a139bbbfd75185fe044be745d07eb31", "message": "CB-9149. Splitting large (> 16K) JSON logs on CB level in order to avoid log rotation related issues by docker logging driver on K8s\ndetails:\n- in order to avoid large messages use a 12K max message length for JSON based logging (12K can be safe as we have many other fields, not only message)\n- split message into chunks based on the max chunk length\n- add partial metadata about the chunks, that can be handled by fluentd\n- using the same field names for partial metadata that is used by docker fluentd logging driver: partial_message, partial_id, partial_ordinal and partial_last\n- added some basic UTs for custom json layout\n- cleaning up loggerNameFilter from masking pattern layout (not deleting that yet)", "committedDate": "2020-10-11T08:29:12Z", "type": "forcePushed"}]}