{"pr_number": 8097, "pr_title": "CB-6236 enable Ranger Raz on Azure in the datalake.", "pr_createdAt": "2020-05-19T15:26:38Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/8097", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQxNjQ2Mg==", "url": "https://github.com/hortonworks/cloudbreak/pull/8097#discussion_r427416462", "bodyText": "razEntitlementEnabled", "author": "doktoric", "createdAt": "2020-05-19T15:59:46Z", "path": "datalake/src/main/java/com/sequenceiq/datalake/service/sdx/SdxService.java", "diffHunk": "@@ -413,6 +421,23 @@ private void validateCloudStorageRequest(SdxCloudStorageRequest cloudStorage, De\n         }\n     }\n \n+    private void validateRazEnablement(SdxClusterRequest sdxClusterRequest, DetailedEnvironmentResponse environment) {\n+        ValidationResultBuilder validationBuilder = new ValidationResultBuilder();\n+        boolean razEntitlement = entitlementService.razEnabled(environment.getCreator(), Crn.safeFromString(environment.getCreator()).getAccountId());", "originalCommit": "6d2e8b3ce70433c5aefe530c30ae6f6e63af92f1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c14ff1475f59015d58d3c23974213dd87602715d", "chunk": "diff --git a/datalake/src/main/java/com/sequenceiq/datalake/service/sdx/SdxService.java b/datalake/src/main/java/com/sequenceiq/datalake/service/sdx/SdxService.java\nindex 8a3c907bf6..82e72ea3fb 100644\n--- a/datalake/src/main/java/com/sequenceiq/datalake/service/sdx/SdxService.java\n+++ b/datalake/src/main/java/com/sequenceiq/datalake/service/sdx/SdxService.java\n\n@@ -423,14 +424,17 @@ public class SdxService implements ResourceIdProvider, ResourceBasedCrnProvider\n \n     private void validateRazEnablement(SdxClusterRequest sdxClusterRequest, DetailedEnvironmentResponse environment) {\n         ValidationResultBuilder validationBuilder = new ValidationResultBuilder();\n-        boolean razEntitlement = entitlementService.razEnabled(environment.getCreator(), Crn.safeFromString(environment.getCreator()).getAccountId());\n         if (sdxClusterRequest.isEnableRangerRaz())  {\n-            if (!razEntitlement) {\n+            boolean razEntitlementEnabled = entitlementService.razEnabled(environment.getCreator(), Crn.safeFromString(environment.getCreator()).getAccountId());\n+            if (!razEntitlementEnabled) {\n                 validationBuilder.error(\"Provisioning Ranger Raz is not enabled for this account.\");\n             }\n             if (!AZURE.name().equalsIgnoreCase(environment.getCloudPlatform())) {\n                 validationBuilder.error(\"Provisioning Ranger Raz is only valid for Microsft Azure.\");\n             }\n+            if (!CMRepositoryVersionUtil.isRazConfigurationSupported(sdxClusterRequest.getRuntime())) {\n+                validationBuilder.error(\"Provisioning Ranger Raz is only valid for CM version > 7.2.0 and not \" + sdxClusterRequest.getRuntime());\n+            }\n         }\n         ValidationResult validationResult = validationBuilder.build();\n         if (validationResult.hasError()) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQxODc1NA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8097#discussion_r427418754", "bodyText": "should we check this in case of sdx app as well ? I mean based on the runtime we should not enable the raz configuration if runtime < 7.2.0", "author": "doktoric", "createdAt": "2020-05-19T16:02:56Z", "path": "template-manager-cmtemplate/src/main/java/com/sequenceiq/cloudbreak/cmtemplate/CMRepositoryVersionUtil.java", "diffHunk": "@@ -64,6 +64,11 @@ public static boolean isTagsResourceSupportedViaBlueprint(ClouderaManagerRepo cl\n         return isVersionNewerOrEqualThanLimited(clouderaManagerRepoDetails::getVersion, CLOUDERAMANAGER_VERSION_7_1_0);\n     }\n \n+    public static boolean isRazConfigurationSupported(ClouderaManagerRepo clouderaManagerRepoDetails) {\n+        LOGGER.info(\"ClouderaManagerRepo is compared for Raz Ranger support\");", "originalCommit": "6d2e8b3ce70433c5aefe530c30ae6f6e63af92f1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c14ff1475f59015d58d3c23974213dd87602715d", "chunk": "diff --git a/template-manager-cmtemplate/src/main/java/com/sequenceiq/cloudbreak/cmtemplate/CMRepositoryVersionUtil.java b/template-manager-cmtemplate/src/main/java/com/sequenceiq/cloudbreak/cmtemplate/CMRepositoryVersionUtil.java\nindex e0c5bfa1af..0f84d5ac32 100644\n--- a/template-manager-cmtemplate/src/main/java/com/sequenceiq/cloudbreak/cmtemplate/CMRepositoryVersionUtil.java\n+++ b/template-manager-cmtemplate/src/main/java/com/sequenceiq/cloudbreak/cmtemplate/CMRepositoryVersionUtil.java\n\n@@ -65,8 +65,12 @@ public class CMRepositoryVersionUtil {\n     }\n \n     public static boolean isRazConfigurationSupported(ClouderaManagerRepo clouderaManagerRepoDetails) {\n+        return isRazConfigurationSupported(clouderaManagerRepoDetails.getVersion());\n+    }\n+\n+    public static boolean isRazConfigurationSupported(String version) {\n         LOGGER.info(\"ClouderaManagerRepo is compared for Raz Ranger support\");\n-        return isVersionNewerOrEqualThanLimited(clouderaManagerRepoDetails::getVersion, CLOUDERAMANAGER_VERSION_7_2_0);\n+        return isVersionNewerOrEqualThanLimited(version, CLOUDERAMANAGER_VERSION_7_2_0);\n     }\n \n     public static boolean isVersionNewerOrEqualThanLimited(Versioned currentVersion, Versioned limitedAPIVersion) {\n"}}, {"oid": "c14ff1475f59015d58d3c23974213dd87602715d", "url": "https://github.com/hortonworks/cloudbreak/commit/c14ff1475f59015d58d3c23974213dd87602715d", "message": "CB-6236 enable Ranger Raz on Azure in the datalake.", "committedDate": "2020-05-19T19:31:56Z", "type": "forcePushed"}, {"oid": "0e504d5adfba0750b3b7d3850212cb41d94f9732", "url": "https://github.com/hortonworks/cloudbreak/commit/0e504d5adfba0750b3b7d3850212cb41d94f9732", "message": "CB-6236 enable Ranger Raz on Azure in the datalake.", "committedDate": "2020-05-19T22:15:34Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODA4MzgwNw==", "url": "https://github.com/hortonworks/cloudbreak/pull/8097#discussion_r428083807", "bodyText": "if runtime not empty. In case of sdx-internal this field is missing", "author": "doktoric", "createdAt": "2020-05-20T15:00:30Z", "path": "datalake/src/main/java/com/sequenceiq/datalake/service/sdx/SdxService.java", "diffHunk": "@@ -413,6 +424,31 @@ private void validateCloudStorageRequest(SdxCloudStorageRequest cloudStorage, De\n         }\n     }\n \n+    private void validateRazEnablement(SdxClusterRequest sdxClusterRequest, DetailedEnvironmentResponse environment) {\n+        ValidationResultBuilder validationBuilder = new ValidationResultBuilder();\n+        if (sdxClusterRequest.isEnableRangerRaz())  {\n+            boolean razEntitlementEnabled = entitlementService.razEnabled(environment.getCreator(), Crn.safeFromString(environment.getCreator()).getAccountId());\n+            if (!razEntitlementEnabled) {\n+                validationBuilder.error(\"Provisioning Ranger Raz is not enabled for this account.\");\n+            }\n+            if (!AZURE.name().equalsIgnoreCase(environment.getCloudPlatform())) {\n+                validationBuilder.error(\"Provisioning Ranger Raz is only valid for Microsft Azure.\");\n+            }\n+            if (!isRazSupported(sdxClusterRequest.getRuntime())) {\n+                validationBuilder.error(\"Provisioning Ranger Raz is only valid for CM version > 7.2.0 and not \" + sdxClusterRequest.getRuntime());\n+            }\n+        }\n+        ValidationResult validationResult = validationBuilder.build();\n+        if (validationResult.hasError()) {\n+            throw new BadRequestException(validationResult.getFormattedErrors());\n+        }\n+    }\n+\n+    private boolean isRazSupported(String runtime) {\n+        Comparator<Versioned> versionComparator = new VersionComparator();", "originalCommit": "0e504d5adfba0750b3b7d3850212cb41d94f9732", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "df8502fdc7d901b23b64b9da3af0b2d660d174c6", "chunk": "diff --git a/datalake/src/main/java/com/sequenceiq/datalake/service/sdx/SdxService.java b/datalake/src/main/java/com/sequenceiq/datalake/service/sdx/SdxService.java\nindex d4146be0a7..a0b70dd971 100644\n--- a/datalake/src/main/java/com/sequenceiq/datalake/service/sdx/SdxService.java\n+++ b/datalake/src/main/java/com/sequenceiq/datalake/service/sdx/SdxService.java\n\n@@ -444,7 +444,13 @@ public class SdxService implements ResourceIdProvider, ResourceBasedCrnProvider\n         }\n     }\n \n+    /**\n+     * Ranger Raz is only on 7.2.0 and later.  If runtime is empty, then sdx-internal call was used.\n+     */\n     private boolean isRazSupported(String runtime) {\n+        if (StringUtils.isEmpty(runtime)) {\n+            return true;\n+        }\n         Comparator<Versioned> versionComparator = new VersionComparator();\n         return versionComparator.compare(() -> runtime, () -> \"7.2.0\") > -1;\n     }\n"}}, {"oid": "df8502fdc7d901b23b64b9da3af0b2d660d174c6", "url": "https://github.com/hortonworks/cloudbreak/commit/df8502fdc7d901b23b64b9da3af0b2d660d174c6", "message": "CB-6236 enable Ranger Raz on Azure in the datalake.", "committedDate": "2020-05-20T15:33:33Z", "type": "forcePushed"}, {"oid": "c9d7580b603b103252e97750f595466efd4f5bdd", "url": "https://github.com/hortonworks/cloudbreak/commit/c9d7580b603b103252e97750f595466efd4f5bdd", "message": "CB-6236 enable Ranger Raz on Azure in the datalake.", "committedDate": "2020-05-20T19:03:14Z", "type": "forcePushed"}, {"oid": "6a4e0763022ca548831dc3079ccdd0d7a37be382", "url": "https://github.com/hortonworks/cloudbreak/commit/6a4e0763022ca548831dc3079ccdd0d7a37be382", "message": "CB-6236 enable Ranger Raz on Azure in the datalake.", "committedDate": "2020-05-20T19:18:01Z", "type": "forcePushed"}, {"oid": "a04709441071729e4019c2c487f2f7f0c9ee5fd9", "url": "https://github.com/hortonworks/cloudbreak/commit/a04709441071729e4019c2c487f2f7f0c9ee5fd9", "message": "CB-6236 enable Ranger Raz on Azure in the datalake.", "committedDate": "2020-05-20T19:22:58Z", "type": "commit"}, {"oid": "a04709441071729e4019c2c487f2f7f0c9ee5fd9", "url": "https://github.com/hortonworks/cloudbreak/commit/a04709441071729e4019c2c487f2f7f0c9ee5fd9", "message": "CB-6236 enable Ranger Raz on Azure in the datalake.", "committedDate": "2020-05-20T19:22:58Z", "type": "forcePushed"}]}