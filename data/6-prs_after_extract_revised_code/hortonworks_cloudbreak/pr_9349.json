{"pr_number": 9349, "pr_title": "CB-9528: Datalake DR: Database backup restore operations are failing in CB2.32.", "pr_createdAt": "2020-10-30T23:07:48Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/9349", "timeline": [{"oid": "171eb9336d3ff0333f9c402de34a39a95833745f", "url": "https://github.com/hortonworks/cloudbreak/commit/171eb9336d3ff0333f9c402de34a39a95833745f", "message": "CB-9528: Datalake DR: Database backup restore operations are failing in CB2.32", "committedDate": "2020-11-02T00:59:33Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA5Mjg5Mg==", "url": "https://github.com/hortonworks/cloudbreak/pull/9349#discussion_r516092892", "bodyText": "Why are we passing both backupId and restoreId to the restore operation calls? I don't see where we're actually using backupId, although I may just be missing it.", "author": "hreeve-cloudera", "createdAt": "2020-11-02T16:26:27Z", "path": "datalake/src/main/java/com/sequenceiq/datalake/controller/sdx/SdxController.java", "diffHunk": "@@ -265,9 +265,10 @@ public SdxDatabaseBackupResponse backupDatabaseByName(@ResourceName String name,\n \n     @Override\n     @CheckPermissionByAccount(action = AuthorizationResourceAction.RESTORE_DATALAKE)\n-    public SdxDatabaseRestoreResponse restoreDatabaseByName(@ResourceName String name, String backupId, String backupLocation) {\n+    public SdxDatabaseRestoreResponse restoreDatabaseByName(@ResourceName String name, String backupId,", "originalCommit": "171eb9336d3ff0333f9c402de34a39a95833745f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjExNjU1OQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9349#discussion_r516116559", "bodyText": "we need backup-id to use the exact backup location for database backup. This was there from before.\nWe need restore-id to poll the status of datalake-dr operation for the restore to end the flow.", "author": "kkalvagadda1", "createdAt": "2020-11-02T16:58:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA5Mjg5Mg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE4MzgzNA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9349#discussion_r516183834", "bodyText": "If this method is databasebackupFailed, we can leave the log message the same as it was before, since it is about the failed database backup.", "author": "hreeve-cloudera", "createdAt": "2020-11-02T18:46:34Z", "path": "datalake/src/main/java/com/sequenceiq/datalake/flow/dr/backup/DatalakeDatabaseBackupActions.java", "diffHunk": "@@ -159,7 +189,7 @@ protected SdxContext createFlowContext(FlowParameters flowParameters, StateConte\n             @Override\n             protected void doExecute(SdxContext context, DatalakeDatabaseBackupFailedEvent payload, Map<Object, Object> variables) {\n                 Exception exception = payload.getException();\n-                LOGGER.error(\"Datalake database backup failed for datalake with id: {}\", payload.getResourceId(), exception);\n+                LOGGER.error(\"Datalake backup failed for datalake with id: {}\", payload.getResourceId(), exception);", "originalCommit": "171eb9336d3ff0333f9c402de34a39a95833745f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTgzODQ0OA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9349#discussion_r519838448", "bodyText": "addressed.", "author": "kkalvagadda1", "createdAt": "2020-11-09T14:06:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE4MzgzNA=="}], "type": "inlineReview", "revised_code": {"commit": "e375d38159fd3a48f0cc3e82a16785f016f791a2", "chunk": "diff --git a/datalake/src/main/java/com/sequenceiq/datalake/flow/dr/backup/DatalakeDatabaseBackupActions.java b/datalake/src/main/java/com/sequenceiq/datalake/flow/dr/backup/DatalakeDatabaseBackupActions.java\nindex a09e9870a9..1065cd5e1f 100644\n--- a/datalake/src/main/java/com/sequenceiq/datalake/flow/dr/backup/DatalakeDatabaseBackupActions.java\n+++ b/datalake/src/main/java/com/sequenceiq/datalake/flow/dr/backup/DatalakeDatabaseBackupActions.java\n\n@@ -189,7 +189,7 @@ public class DatalakeDatabaseBackupActions {\n             @Override\n             protected void doExecute(SdxContext context, DatalakeDatabaseBackupFailedEvent payload, Map<Object, Object> variables) {\n                 Exception exception = payload.getException();\n-                LOGGER.error(\"Datalake backup failed for datalake with id: {}\", payload.getResourceId(), exception);\n+                LOGGER.error(\"Datalake database backup failed for datalake with id: {}\", payload.getResourceId(), exception);\n                 String operationId = (String) variables.get(OPERATION_ID);\n                 sdxDatabaseDrService.updateDatabaseStatusEntry(operationId, SdxOperationStatus.FAILED, exception.getLocalizedMessage());\n                 sendEvent(context, DATALAKE_DATABASE_BACKUP_FAILURE_HANDLED_EVENT.event(), payload);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE4Mzk3Mg==", "url": "https://github.com/hortonworks/cloudbreak/pull/9349#discussion_r516183972", "bodyText": "nit: Fix camelcase. databaseBackupFailed", "author": "hreeve-cloudera", "createdAt": "2020-11-02T18:46:50Z", "path": "datalake/src/main/java/com/sequenceiq/datalake/flow/dr/backup/DatalakeDatabaseBackupActions.java", "diffHunk": "@@ -122,33 +128,57 @@ protected Object getFailurePayload(DatalakeDatabaseBackupCouldNotStartEvent payl\n         };\n     }\n \n-    @Bean(name = \"DATALAKE_DATABASE_BACKUP_FINISHED_STATE\")\n-    public Action<?, ?> finishedBackupAction() {\n-        return new AbstractSdxAction<>(DatalakeDatabaseBackupSuccessEvent.class) {\n+    @Bean(name = \"DATALAKE_FULL_BACKUP_IN_PROGRESS_STATE\")\n+    public Action<?, ?> datalakeFullBackupInProgress() {\n+        return new AbstractSdxAction<>(SdxEvent.class) {\n \n             @Override\n-            protected SdxContext createFlowContext(FlowParameters flowParameters, StateContext<FlowState, FlowEvent> stateContext,\n-                    DatalakeDatabaseBackupSuccessEvent payload) {\n+            protected SdxContext createFlowContext(FlowParameters flowParameters, StateContext<FlowState, FlowEvent> stateContext, SdxEvent payload) {\n                 return SdxContext.from(flowParameters, payload);\n             }\n \n             @Override\n-            protected void doExecute(SdxContext context, DatalakeDatabaseBackupSuccessEvent payload, Map<Object, Object> variables) {\n-                LOGGER.info(\"Sdx database backup is finalized with sdx id: {}\", payload.getResourceId());\n+            protected void doExecute(SdxContext context, SdxEvent payload, Map<Object, Object> variables) {\n+                LOGGER.info(\"Full datalake backup is in progress for {} \", payload.getResourceId());\n                 String operationId = (String) variables.get(OPERATION_ID);\n+                String backupId = (String) variables.get(BACKUP_ID);\n                 sdxDatabaseDrService.updateDatabaseStatusEntry(operationId, SdxOperationStatus.SUCCEEDED, null);\n+                sendEvent(context, DatalakeFullBackupWaitRequest.from(context, backupId));\n+            }\n+\n+            @Override\n+            protected Object getFailurePayload(SdxEvent payload, Optional<SdxContext> flowContext, Exception ex) {\n+                return DatalakeDatabaseBackupFailedEvent.from(payload, ex);\n+\n+            }\n+        };\n+    }\n+\n+    @Bean(name = \"DATALAKE_BACKUP_FINISHED_STATE\")\n+    public Action<?, ?> finishedBackupAction() {\n+        return new AbstractSdxAction<>(DatalakeBackupSuccessEvent.class) {\n+\n+            @Override\n+            protected SdxContext createFlowContext(FlowParameters flowParameters, StateContext<FlowState, FlowEvent> stateContext,\n+                    DatalakeBackupSuccessEvent payload) {\n+                return SdxContext.from(flowParameters, payload);\n+            }\n+\n+            @Override\n+            protected void doExecute(SdxContext context, DatalakeBackupSuccessEvent payload, Map<Object, Object> variables) {\n+                LOGGER.info(\"Sdx backup is finalized with sdx id: {}\", payload.getResourceId());\n                 sendEvent(context, DATALAKE_DATABASE_BACKUP_FINALIZED_EVENT.event(), payload);\n             }\n \n             @Override\n-            protected Object getFailurePayload(DatalakeDatabaseBackupSuccessEvent payload, Optional<SdxContext> flowContext, Exception ex) {\n+            protected Object getFailurePayload(DatalakeBackupSuccessEvent payload, Optional<SdxContext> flowContext, Exception ex) {\n                 return DatalakeDatabaseBackupFailedEvent.from(payload, ex);\n             }\n         };\n     }\n \n     @Bean(name = \"DATALAKE_DATABASE_BACKUP_FAILED_STATE\")\n-    public Action<?, ?> backupFailed() {\n+    public Action<?, ?> databasebackupFailed() {", "originalCommit": "171eb9336d3ff0333f9c402de34a39a95833745f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTgzODUxMw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9349#discussion_r519838513", "bodyText": "addressed.", "author": "kkalvagadda1", "createdAt": "2020-11-09T14:06:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE4Mzk3Mg=="}], "type": "inlineReview", "revised_code": {"commit": "e375d38159fd3a48f0cc3e82a16785f016f791a2", "chunk": "diff --git a/datalake/src/main/java/com/sequenceiq/datalake/flow/dr/backup/DatalakeDatabaseBackupActions.java b/datalake/src/main/java/com/sequenceiq/datalake/flow/dr/backup/DatalakeDatabaseBackupActions.java\nindex a09e9870a9..1065cd5e1f 100644\n--- a/datalake/src/main/java/com/sequenceiq/datalake/flow/dr/backup/DatalakeDatabaseBackupActions.java\n+++ b/datalake/src/main/java/com/sequenceiq/datalake/flow/dr/backup/DatalakeDatabaseBackupActions.java\n\n@@ -178,7 +178,7 @@ public class DatalakeDatabaseBackupActions {\n     }\n \n     @Bean(name = \"DATALAKE_DATABASE_BACKUP_FAILED_STATE\")\n-    public Action<?, ?> databasebackupFailed() {\n+    public Action<?, ?> databaseBackupFailed() {\n         return new AbstractSdxAction<>(DatalakeDatabaseBackupFailedEvent.class) {\n             @Override\n             protected SdxContext createFlowContext(FlowParameters flowParameters, StateContext<FlowState, FlowEvent> stateContext,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTgzNTg0MA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9349#discussion_r519835840", "bodyText": "restoreTd - restoreId", "author": "sodre90", "createdAt": "2020-11-09T14:02:26Z", "path": "datalake-api/src/main/java/com/sequenceiq/sdx/api/endpoint/SdxEndpoint.java", "diffHunk": "@@ -194,7 +194,8 @@ SdxDatabaseBackupResponse backupDatabaseByName(@PathParam(\"name\") String name,\n     @Produces(MediaType.APPLICATION_JSON)\n     @ApiOperation(value = \"restore the database backing datalake \", produces = MediaType.APPLICATION_JSON, nickname = \"restoreDatabase\")\n     SdxDatabaseRestoreResponse restoreDatabaseByName(@PathParam(\"name\") String name,\n-            @QueryParam(\"backupId\") String backupId, @QueryParam(\"backupLocation\") String backupLocation);\n+            @QueryParam(\"backupId\") String backupId, @QueryParam(\"restoreTd\") String restoreId,", "originalCommit": "171eb9336d3ff0333f9c402de34a39a95833745f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDAzOTIwOA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9349#discussion_r520039208", "bodyText": "will fix.", "author": "kkalvagadda1", "createdAt": "2020-11-09T18:50:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTgzNTg0MA=="}], "type": "inlineReview", "revised_code": {"commit": "e375d38159fd3a48f0cc3e82a16785f016f791a2", "chunk": "diff --git a/datalake-api/src/main/java/com/sequenceiq/sdx/api/endpoint/SdxEndpoint.java b/datalake-api/src/main/java/com/sequenceiq/sdx/api/endpoint/SdxEndpoint.java\nindex 66aa138c25..1283f99506 100644\n--- a/datalake-api/src/main/java/com/sequenceiq/sdx/api/endpoint/SdxEndpoint.java\n+++ b/datalake-api/src/main/java/com/sequenceiq/sdx/api/endpoint/SdxEndpoint.java\n\n@@ -194,7 +194,7 @@ public interface SdxEndpoint {\n     @Produces(MediaType.APPLICATION_JSON)\n     @ApiOperation(value = \"restore the database backing datalake \", produces = MediaType.APPLICATION_JSON, nickname = \"restoreDatabase\")\n     SdxDatabaseRestoreResponse restoreDatabaseByName(@PathParam(\"name\") String name,\n-            @QueryParam(\"backupId\") String backupId, @QueryParam(\"restoreTd\") String restoreId,\n+            @QueryParam(\"backupId\") String backupId, @QueryParam(\"restoreId\") String restoreId,\n             @QueryParam(\"backupLocation\") String backupLocation);\n \n     @GET\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTg1NTAxOQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9349#discussion_r519855019", "bodyText": "why is this line duplicated?", "author": "sodre90", "createdAt": "2020-11-09T14:29:48Z", "path": "datalake/src/main/java/com/sequenceiq/datalake/flow/dr/restore/DatalakeDatabaseRestoreActions.java", "diffHunk": "@@ -120,32 +128,60 @@ protected Object getFailurePayload(DatalakeDatabaseRestoreCouldNotStartEvent pay\n         };\n     }\n \n+    @Bean(name = \"DATALAKE_FULL_RESTORE_IN_PROGRESS_STATE\")\n+    public Action<?, ?> datalakeFullResoreInProgress() {\n+        return new AbstractSdxAction<>(SdxEvent.class) {\n+\n+            @Override\n+            protected SdxContext createFlowContext(FlowParameters flowParameters, StateContext<FlowState, FlowEvent> stateContext, SdxEvent payload) {\n+                return SdxContext.from(flowParameters, payload);\n+            }\n+\n+            @Override\n+            protected void doExecute(SdxContext context, SdxEvent payload, Map<Object, Object> variables) {\n+                LOGGER.info(\"Full datalake restore is in progress for {} \", payload.getResourceId());\n+                String operationId = (String) variables.get(OPERATION_ID);\n+                sdxDatabaseDrService.updateDatabaseStatusEntry(operationId, SdxOperationStatus.SUCCEEDED, null);\n+                sendEvent(context, DatalakeFullRestoreWaitRequest.from(context, operationId));\n+\n+                String restoreId = (String) variables.get(RESTORE_ID);\n+                sdxDatabaseDrService.updateDatabaseStatusEntry(operationId, SdxOperationStatus.SUCCEEDED, null);", "originalCommit": "bca8b3b4829ab2a7e36408b8d7b51e6743a9ca94", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDA0MDAwMg==", "url": "https://github.com/hortonworks/cloudbreak/pull/9349#discussion_r520040002", "bodyText": "My bad. I fixed it now.", "author": "kkalvagadda1", "createdAt": "2020-11-09T18:51:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTg1NTAxOQ=="}], "type": "inlineReview", "revised_code": {"commit": "e375d38159fd3a48f0cc3e82a16785f016f791a2", "chunk": "diff --git a/datalake/src/main/java/com/sequenceiq/datalake/flow/dr/restore/DatalakeDatabaseRestoreActions.java b/datalake/src/main/java/com/sequenceiq/datalake/flow/dr/restore/DatalakeDatabaseRestoreActions.java\nindex a7bd035e2b..1841f8ea8e 100644\n--- a/datalake/src/main/java/com/sequenceiq/datalake/flow/dr/restore/DatalakeDatabaseRestoreActions.java\n+++ b/datalake/src/main/java/com/sequenceiq/datalake/flow/dr/restore/DatalakeDatabaseRestoreActions.java\n\n@@ -141,9 +141,6 @@ public class DatalakeDatabaseRestoreActions {\n             protected void doExecute(SdxContext context, SdxEvent payload, Map<Object, Object> variables) {\n                 LOGGER.info(\"Full datalake restore is in progress for {} \", payload.getResourceId());\n                 String operationId = (String) variables.get(OPERATION_ID);\n-                sdxDatabaseDrService.updateDatabaseStatusEntry(operationId, SdxOperationStatus.SUCCEEDED, null);\n-                sendEvent(context, DatalakeFullRestoreWaitRequest.from(context, operationId));\n-\n                 String restoreId = (String) variables.get(RESTORE_ID);\n                 sdxDatabaseDrService.updateDatabaseStatusEntry(operationId, SdxOperationStatus.SUCCEEDED, null);\n                 sendEvent(context, DatalakeFullRestoreWaitRequest.from(context, restoreId));\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTg2MTAyMw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9349#discussion_r519861023", "bodyText": "we send 2 event from this action, is this intended?", "author": "sodre90", "createdAt": "2020-11-09T14:38:13Z", "path": "datalake/src/main/java/com/sequenceiq/datalake/flow/dr/restore/DatalakeDatabaseRestoreActions.java", "diffHunk": "@@ -120,32 +128,60 @@ protected Object getFailurePayload(DatalakeDatabaseRestoreCouldNotStartEvent pay\n         };\n     }\n \n+    @Bean(name = \"DATALAKE_FULL_RESTORE_IN_PROGRESS_STATE\")\n+    public Action<?, ?> datalakeFullResoreInProgress() {\n+        return new AbstractSdxAction<>(SdxEvent.class) {\n+\n+            @Override\n+            protected SdxContext createFlowContext(FlowParameters flowParameters, StateContext<FlowState, FlowEvent> stateContext, SdxEvent payload) {\n+                return SdxContext.from(flowParameters, payload);\n+            }\n+\n+            @Override\n+            protected void doExecute(SdxContext context, SdxEvent payload, Map<Object, Object> variables) {\n+                LOGGER.info(\"Full datalake restore is in progress for {} \", payload.getResourceId());\n+                String operationId = (String) variables.get(OPERATION_ID);\n+                sdxDatabaseDrService.updateDatabaseStatusEntry(operationId, SdxOperationStatus.SUCCEEDED, null);\n+                sendEvent(context, DatalakeFullRestoreWaitRequest.from(context, operationId));\n+\n+                String restoreId = (String) variables.get(RESTORE_ID);\n+                sdxDatabaseDrService.updateDatabaseStatusEntry(operationId, SdxOperationStatus.SUCCEEDED, null);\n+                sendEvent(context, DatalakeFullRestoreWaitRequest.from(context, restoreId));", "originalCommit": "bca8b3b4829ab2a7e36408b8d7b51e6743a9ca94", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDA0MDE5Mg==", "url": "https://github.com/hortonworks/cloudbreak/pull/9349#discussion_r520040192", "bodyText": "That is incorrect. I will fix it.", "author": "kkalvagadda1", "createdAt": "2020-11-09T18:51:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTg2MTAyMw=="}], "type": "inlineReview", "revised_code": {"commit": "e375d38159fd3a48f0cc3e82a16785f016f791a2", "chunk": "diff --git a/datalake/src/main/java/com/sequenceiq/datalake/flow/dr/restore/DatalakeDatabaseRestoreActions.java b/datalake/src/main/java/com/sequenceiq/datalake/flow/dr/restore/DatalakeDatabaseRestoreActions.java\nindex a7bd035e2b..1841f8ea8e 100644\n--- a/datalake/src/main/java/com/sequenceiq/datalake/flow/dr/restore/DatalakeDatabaseRestoreActions.java\n+++ b/datalake/src/main/java/com/sequenceiq/datalake/flow/dr/restore/DatalakeDatabaseRestoreActions.java\n\n@@ -141,9 +141,6 @@ public class DatalakeDatabaseRestoreActions {\n             protected void doExecute(SdxContext context, SdxEvent payload, Map<Object, Object> variables) {\n                 LOGGER.info(\"Full datalake restore is in progress for {} \", payload.getResourceId());\n                 String operationId = (String) variables.get(OPERATION_ID);\n-                sdxDatabaseDrService.updateDatabaseStatusEntry(operationId, SdxOperationStatus.SUCCEEDED, null);\n-                sendEvent(context, DatalakeFullRestoreWaitRequest.from(context, operationId));\n-\n                 String restoreId = (String) variables.get(RESTORE_ID);\n                 sdxDatabaseDrService.updateDatabaseStatusEntry(operationId, SdxOperationStatus.SUCCEEDED, null);\n                 sendEvent(context, DatalakeFullRestoreWaitRequest.from(context, restoreId));\n"}}, {"oid": "e375d38159fd3a48f0cc3e82a16785f016f791a2", "url": "https://github.com/hortonworks/cloudbreak/commit/e375d38159fd3a48f0cc3e82a16785f016f791a2", "message": "CB-9528: Datalake DR: Database backup restore operations are failing in CB2.32", "committedDate": "2020-11-11T20:33:53Z", "type": "commit"}, {"oid": "e375d38159fd3a48f0cc3e82a16785f016f791a2", "url": "https://github.com/hortonworks/cloudbreak/commit/e375d38159fd3a48f0cc3e82a16785f016f791a2", "message": "CB-9528: Datalake DR: Database backup restore operations are failing in CB2.32", "committedDate": "2020-11-11T20:33:53Z", "type": "forcePushed"}]}