{"pr_number": 7504, "pr_title": "CDPCP-1549", "pr_createdAt": "2020-03-06T16:44:59Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/7504", "timeline": [{"oid": "44096a4cd504b45e3b57c84db4d7c6fefd3739f1", "url": "https://github.com/hortonworks/cloudbreak/commit/44096a4cd504b45e3b57c84db4d7c6fefd3739f1", "message": "Revert \"Revert \"CDPCP-1549. Catch and fail user sync operation\"\"\n\nThere was a gap where exceptions could cause user sync to fail but\nnot be recorded in the Operation database. This would prevent another\nuser sync from being accepted even though the current user sync was\nnot actually running. Eventually, the operation would be TIMEDOUT,\nallowing another user sync to be accepted.\n\nThis commit closes the gap by catching all RuntimeExceptions and\nrecording the failure in the Operation database.\n\nThis reverts commit 430f4fd482373e50b6316c1a7c9ffcd6bbe16ee4.", "committedDate": "2020-03-06T16:39:40Z", "type": "commit"}, {"oid": "12fe1e852cc16140123a45b738f63bca21778949", "url": "https://github.com/hortonworks/cloudbreak/commit/12fe1e852cc16140123a45b738f63bca21778949", "message": "Revert \"Revert \"CDPCP-1549. Run user sync internals as internal user\"\"\n\nAn authorization mismatch between the Operation db and the UserSyncStatus\ndb resulted in a bug where a user sync operation can be accepted, but\nwill fail when saving the user sync status. This commit changes the\nauthorization behavior so that authoriation is only performed on acceptance\nof the sync operation. All the user sync internals are run as the internal\nuser.\n\nSince UserSyncService internals use an AsyncTaskExecutor, the UserSyncConfig\nhas been updated to add a decorator for propagating the user crn to the\nsubmitted jobs.\n\nThis reverts commit 7d32d63d725cdb51e3682a203a8ce2b476da502c.", "committedDate": "2020-03-06T16:40:38Z", "type": "commit"}, {"oid": "8023e9cae1b112849c0db12389e838a8a386d00f", "url": "https://github.com/hortonworks/cloudbreak/commit/8023e9cae1b112849c0db12389e838a8a386d00f", "message": "Revert \"Revert \"CDPCP-1549. Reconcile usersyncstatus permissions with operation permissions\"\"\n\nThis reverts commit fa42cbea9e8c8de44ef532e57167d56116d1e961.", "committedDate": "2020-03-06T16:41:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTAxNTc5OQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/7504#discussion_r389015799", "bodyText": "'stackService.getMultipleByEnvironmentCrnOrChildEnvironmantCrnAndAccountId' was renamed in rc-2.19. This test is new, so it merged fine.", "author": "handavid", "createdAt": "2020-03-06T16:46:36Z", "path": "freeipa/src/test/java/com/sequenceiq/freeipa/service/freeipa/user/UserSyncServiceTest.java", "diffHunk": "@@ -159,6 +188,34 @@ void testRemoveUsersFromGroupsPartitionsRequests() throws Exception {\n         });\n     }\n \n+    @Test\n+    void testAsyncSynchronizeUsersUsesInternalCrn() {\n+        Stack stack = mock(Stack.class);\n+        when(stack.getEnvironmentCrn()).thenReturn(ENV_CRN);\n+        when(stackService.getMultipleByEnvironmentCrnOrChildEnvironmantCrnAndAccountId(anySet(), anyString())).thenReturn(List.of(stack));", "originalCommit": "8023e9cae1b112849c0db12389e838a8a386d00f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}