{"pr_number": 9618, "pr_title": "CB-10255. Ability to use DataBus CNAME instead of the sigma DataBus e\u2026", "pr_createdAt": "2020-12-09T15:22:43Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/9618", "timeline": [{"oid": "5aa9c8593707b9dec57468534a428653020ac5c8", "url": "https://github.com/hortonworks/cloudbreak/commit/5aa9c8593707b9dec57468534a428653020ac5c8", "message": "CB-10255. Ability to use DataBus CNAME instead of the sigma DataBus endpoint.\ndetails:\nadd new entitlement to let customers to use databus cname endpoint instead of the original one\n\nthe value would be: CDP_USE_DATABUS_CNAME_ENDPOINT", "committedDate": "2020-12-09T15:20:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQyODk4Mw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9618#discussion_r539428983", "bodyText": "Are we sure this URL won't change? If not, then maybe it is worth to make a new config property for this in application.yml", "author": "horadla23", "createdAt": "2020-12-09T15:58:17Z", "path": "common/src/main/java/com/sequenceiq/cloudbreak/telemetry/DataBusEndpointProvider.java", "diffHunk": "@@ -0,0 +1,22 @@\n+package com.sequenceiq.cloudbreak.telemetry;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+@Component\n+public class DataBusEndpointProvider {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(DataBusEndpointProvider.class);\n+\n+    private static final String CNAME_ENDPOINT = \"https://dbusapi.us-west-1.altus.cloudera.com\";", "originalCommit": "5aa9c8593707b9dec57468534a428653020ac5c8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQzMjczNQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9618#discussion_r539432735", "bodyText": "does not seemed to be changed ever. I can do a follow-up change if that will be needed. although if it changes it should be changed everywhere so actually it sounds more like a constant still", "author": "oleewere", "createdAt": "2020-12-09T16:02:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQyODk4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQzMzI0OA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9618#discussion_r539433248", "bodyText": "ok, then it is fine for me", "author": "horadla23", "createdAt": "2020-12-09T16:03:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQyODk4Mw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQzMDU5OA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9618#discussion_r539430598", "bodyText": "This logic is very similar to the logic in TelemetryDecorator and in ClouderaManagerMgmtTelemetryService, might worth to make an own method for it somewhere, maybe in DataBusEndpointProvider, then you do not need to inject Entitlementservice  everywhere", "author": "horadla23", "createdAt": "2020-12-09T16:00:10Z", "path": "core/src/main/java/com/sequenceiq/cloudbreak/core/flow2/service/DiagnosticsTriggerService.java", "diffHunk": "@@ -71,9 +81,12 @@ public FlowIdentifier startDiagnosticsCollection(BaseDiagnosticsCollectionReques\n                 && StringUtils.isNotBlank(stack.getCluster().getBlueprint().getStackVersion())) {\n             clusterVersion = stack.getCluster().getBlueprint().getStackVersion();\n         }\n+        String accountId = Crn.fromString(stack.getResourceCrn()).getAccountId();\n+        boolean useDbusCnameEndpoint = entitlementService.useDataBusCNameEndpointEnabled(INTERNAL_ACTOR_CRN, accountId);\n+        String databusEndpoint = dataBusEndpointProvider.getDataBusEndpoint(telemetry.getDatabusEndpoint(), useDbusCnameEndpoint);", "originalCommit": "5aa9c8593707b9dec57468534a428653020ac5c8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQzMjA4Mw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9618#discussion_r539432083", "bodyText": "common has no auth-connector dependency, first i tried to put these kind of code together in auth-connector but @lnardai did not want that (I understand) - so i cannot include Entitlementservice in DataBusEndpointProvider", "author": "oleewere", "createdAt": "2020-12-09T16:01:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQzMDU5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQzMzQ0Mg==", "url": "https://github.com/hortonworks/cloudbreak/pull/9618#discussion_r539433442", "bodyText": "ohh i see, makes sense", "author": "horadla23", "createdAt": "2020-12-09T16:03:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQzMDU5OA=="}], "type": "inlineReview", "revised_code": null}]}