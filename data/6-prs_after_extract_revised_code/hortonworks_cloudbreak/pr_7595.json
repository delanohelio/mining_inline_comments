{"pr_number": 7595, "pr_title": "CB-5734 Introduce Load Based Alert Endpoint", "pr_createdAt": "2020-03-16T13:42:43Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/7595", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQxMjk0OQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/7595#discussion_r393412949", "bodyText": "Is this new check valid for the other alert types?", "author": "sidseth", "createdAt": "2020-03-17T02:37:25Z", "path": "autoscale-api/src/main/java/com/sequenceiq/periscope/api/model/ScalingPolicyBase.java", "diffHunk": "@@ -16,15 +20,19 @@\n     private String name;\n \n     @ApiModelProperty(ScalingPolicyJsonProperties.ADJUSTMENTTYPE)\n+    @NotNull", "originalCommit": "559afe9b8e7a9652db6f2b69a345384363939692", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzUxNTQ2MQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/7595#discussion_r393515461", "bodyText": "yes adjustmentType needs to be defined for any policy. added LOAD_BASED for LoadAlert", "author": "smaniraju", "createdAt": "2020-03-17T08:35:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQxMjk0OQ=="}], "type": "inlineReview", "revised_code": {"commit": "6754703bf01c5f4ced53e081020e13eac3994af9", "chunk": "diff --git a/autoscale-api/src/main/java/com/sequenceiq/periscope/api/model/ScalingPolicyBase.java b/autoscale-api/src/main/java/com/sequenceiq/periscope/api/model/ScalingPolicyBase.java\nindex 2a4e927d43..9fdcef7c54 100644\n--- a/autoscale-api/src/main/java/com/sequenceiq/periscope/api/model/ScalingPolicyBase.java\n+++ b/autoscale-api/src/main/java/com/sequenceiq/periscope/api/model/ScalingPolicyBase.java\n\n@@ -24,7 +23,6 @@ public class ScalingPolicyBase implements Json {\n     private AdjustmentType adjustmentType;\n \n     @ApiModelProperty(ScalingPolicyJsonProperties.SCALINGADJUSTMENT)\n-    @Positive\n     private int scalingAdjustment;\n \n     @ApiModelProperty(ScalingPolicyJsonProperties.ALERTID)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQxMzI2Mw==", "url": "https://github.com/hortonworks/cloudbreak/pull/7595#discussion_r393413263", "bodyText": "Not in case of Cron, AdjustmentType.PERCENTAGE or AdjustmentType.NODE_COUNT -> (-20%). Shrink by 20%.", "author": "sidseth", "createdAt": "2020-03-17T02:38:42Z", "path": "autoscale-api/src/main/java/com/sequenceiq/periscope/api/model/ScalingPolicyBase.java", "diffHunk": "@@ -16,15 +20,19 @@\n     private String name;\n \n     @ApiModelProperty(ScalingPolicyJsonProperties.ADJUSTMENTTYPE)\n+    @NotNull\n     private AdjustmentType adjustmentType;\n \n     @ApiModelProperty(ScalingPolicyJsonProperties.SCALINGADJUSTMENT)\n+    @Positive", "originalCommit": "559afe9b8e7a9652db6f2b69a345384363939692", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzUxNzYyNw==", "url": "https://github.com/hortonworks/cloudbreak/pull/7595#discussion_r393517627", "bodyText": "correct, removed the 'Positive' validation.", "author": "smaniraju", "createdAt": "2020-03-17T08:40:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQxMzI2Mw=="}], "type": "inlineReview", "revised_code": {"commit": "6754703bf01c5f4ced53e081020e13eac3994af9", "chunk": "diff --git a/autoscale-api/src/main/java/com/sequenceiq/periscope/api/model/ScalingPolicyBase.java b/autoscale-api/src/main/java/com/sequenceiq/periscope/api/model/ScalingPolicyBase.java\nindex 2a4e927d43..9fdcef7c54 100644\n--- a/autoscale-api/src/main/java/com/sequenceiq/periscope/api/model/ScalingPolicyBase.java\n+++ b/autoscale-api/src/main/java/com/sequenceiq/periscope/api/model/ScalingPolicyBase.java\n\n@@ -24,7 +23,6 @@ public class ScalingPolicyBase implements Json {\n     private AdjustmentType adjustmentType;\n \n     @ApiModelProperty(ScalingPolicyJsonProperties.SCALINGADJUSTMENT)\n-    @Positive\n     private int scalingAdjustment;\n \n     @ApiModelProperty(ScalingPolicyJsonProperties.ALERTID)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQxNzg0Ng==", "url": "https://github.com/hortonworks/cloudbreak/pull/7595#discussion_r393417846", "bodyText": "What does this 'id' represent? Will this be different from the 'id' inside the ScalingPolicyResponse object? Or is this the AlertId vs PolicyId?", "author": "sidseth", "createdAt": "2020-03-17T02:57:55Z", "path": "autoscale-api/src/main/java/com/sequenceiq/periscope/api/model/TimeAlertResponse.java", "diffHunk": "@@ -48,19 +45,11 @@ public void setId(Long id) {\n         this.id = id;", "originalCommit": "559afe9b8e7a9652db6f2b69a345384363939692", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzUxNzc4Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/7595#discussion_r393517787", "bodyText": "Yes this is AlertId vs PolicyId", "author": "smaniraju", "createdAt": "2020-03-17T08:40:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQxNzg0Ng=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQyMDM4Ng==", "url": "https://github.com/hortonworks/cloudbreak/pull/7595#discussion_r393420386", "bodyText": "Not exactly related to the review.\n\nWhat format TimeZone is supported?\nWhat format CRON expressions supported. It looks like the code allows expressions with a minimum of 3 entries.\nThese will eventually need to be documented.\nAlso will eventually need to add more error validation for the TimeZone, and other fields in general.", "author": "sidseth", "createdAt": "2020-03-17T03:06:08Z", "path": "autoscale-api/src/main/java/com/sequenceiq/periscope/api/model/TimeAlertRequest.java", "diffHunk": "@@ -12,9 +14,13 @@\n public class TimeAlertRequest extends AbstractAlertJson {\n \n     @ApiModelProperty(TimeAlertJsonProperties.TIMEZONE)\n+    @NotEmpty\n+    @Size(max = 50)\n     private String timeZone;", "originalCommit": "559afe9b8e7a9652db6f2b69a345384363939692", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzYwMzUxMA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7595#discussion_r393603510", "bodyText": "As of now there is validation for CRON expression when TimeAlert is set, I have added for TimeZone also.", "author": "smaniraju", "createdAt": "2020-03-17T11:13:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQyMDM4Ng=="}], "type": "inlineReview", "revised_code": {"commit": "6754703bf01c5f4ced53e081020e13eac3994af9", "chunk": "diff --git a/autoscale-api/src/main/java/com/sequenceiq/periscope/api/model/TimeAlertRequest.java b/autoscale-api/src/main/java/com/sequenceiq/periscope/api/model/TimeAlertRequest.java\nindex f33a97c835..40640e12ec 100644\n--- a/autoscale-api/src/main/java/com/sequenceiq/periscope/api/model/TimeAlertRequest.java\n+++ b/autoscale-api/src/main/java/com/sequenceiq/periscope/api/model/TimeAlertRequest.java\n\n@@ -14,7 +14,6 @@ import io.swagger.annotations.ApiModelProperty;\n public class TimeAlertRequest extends AbstractAlertJson {\n \n     @ApiModelProperty(TimeAlertJsonProperties.TIMEZONE)\n-    @NotEmpty\n     @Size(max = 50)\n     private String timeZone;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQyMjg1MA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7595#discussion_r393422850", "bodyText": "This error message is nice. However, when we start working with CRNs - this becomes problematic. This shouldn't show up to the end user. Are there other scenarios where this happens as well?", "author": "sidseth", "createdAt": "2020-03-17T03:15:51Z", "path": "autoscale/src/main/java/com/sequenceiq/periscope/controller/AlertController.java", "diffHunk": "@@ -175,4 +228,19 @@ private TimeAlertResponse createTimeAlertResponse(TimeAlert alarm) {\n     private PrometheusAlertResponse createPrometheusAlertResponse(PrometheusAlert alarm) {\n         return prometheusAlertResponseConverter.convert(alarm);\n     }\n+\n+    private void validateAlertForUpdate(Long clusterId, Long alertId, AlertType alertType) {\n+        BaseAlert alert;\n+        switch (alertType) {\n+            case LOAD:\n+                alert = alertService.findLoadAlertByCluster(clusterId, alertId);\n+                break;\n+            case TIME:\n+            default:\n+                alert = alertService.findTimeAlertByCluster(clusterId, alertId);\n+        }\n+        if (alert == null) {\n+            throw new NotFoundException(String.format(\"Could not find %s alert with id: '%s', for cluster: '%s'\", alertType, alertId, clusterId));", "originalCommit": "559afe9b8e7a9652db6f2b69a345384363939692", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzYwNjY0Mg==", "url": "https://github.com/hortonworks/cloudbreak/pull/7595#discussion_r393606642", "bodyText": "This can happen only when a deleted alert id is used to update.", "author": "smaniraju", "createdAt": "2020-03-17T11:19:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQyMjg1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDEwNTc2Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/7595#discussion_r394105767", "bodyText": "From your mail, I think CRN based error messages are better.\nAnother option may be more structured error responses which can be parsed by the CDP layer, and converted to actual errors. The CRN approach should be good for now.", "author": "sidseth", "createdAt": "2020-03-18T04:52:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQyMjg1MA=="}], "type": "inlineReview", "revised_code": {"commit": "6754703bf01c5f4ced53e081020e13eac3994af9", "chunk": "diff --git a/autoscale/src/main/java/com/sequenceiq/periscope/controller/AlertController.java b/autoscale/src/main/java/com/sequenceiq/periscope/controller/AlertController.java\nindex 43bb7b4d93..a0eef9ba17 100644\n--- a/autoscale/src/main/java/com/sequenceiq/periscope/controller/AlertController.java\n+++ b/autoscale/src/main/java/com/sequenceiq/periscope/controller/AlertController.java\n\n@@ -236,8 +238,17 @@ public class AlertController implements AlertEndpoint {\n                 alert = alertService.findLoadAlertByCluster(clusterId, alertId);\n                 break;\n             case TIME:\n-            default:\n                 alert = alertService.findTimeAlertByCluster(clusterId, alertId);\n+                break;\n+            case METRIC:\n+                alert = alertService.findMetricAlertByCluster(clusterId, alertId);\n+                break;\n+            case PROMETHEUS:\n+                alert = alertService.findPrometheusAlertByCluster(clusterId, alertId);\n+                break;\n+            default:\n+                alert = null;\n+\n         }\n         if (alert == null) {\n             throw new NotFoundException(String.format(\"Could not find %s alert with id: '%s', for cluster: '%s'\", alertType, alertId, clusterId));\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQyMzI1OQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/7595#discussion_r393423259", "bodyText": "May be worth adding a node here that this essentially breaks updates to metric / prometheus alerts (Yes - these will be disabled, but for future fixes - if someone decides to go update them)", "author": "sidseth", "createdAt": "2020-03-17T03:17:38Z", "path": "autoscale/src/main/java/com/sequenceiq/periscope/controller/AlertController.java", "diffHunk": "@@ -175,4 +228,19 @@ private TimeAlertResponse createTimeAlertResponse(TimeAlert alarm) {\n     private PrometheusAlertResponse createPrometheusAlertResponse(PrometheusAlert alarm) {\n         return prometheusAlertResponseConverter.convert(alarm);\n     }\n+\n+    private void validateAlertForUpdate(Long clusterId, Long alertId, AlertType alertType) {\n+        BaseAlert alert;", "originalCommit": "559afe9b8e7a9652db6f2b69a345384363939692", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzYxNjU1NQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/7595#discussion_r393616555", "bodyText": "ack", "author": "smaniraju", "createdAt": "2020-03-17T11:38:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQyMzI1OQ=="}], "type": "inlineReview", "revised_code": {"commit": "6754703bf01c5f4ced53e081020e13eac3994af9", "chunk": "diff --git a/autoscale/src/main/java/com/sequenceiq/periscope/controller/AlertController.java b/autoscale/src/main/java/com/sequenceiq/periscope/controller/AlertController.java\nindex 43bb7b4d93..a0eef9ba17 100644\n--- a/autoscale/src/main/java/com/sequenceiq/periscope/controller/AlertController.java\n+++ b/autoscale/src/main/java/com/sequenceiq/periscope/controller/AlertController.java\n\n@@ -236,8 +238,17 @@ public class AlertController implements AlertEndpoint {\n                 alert = alertService.findLoadAlertByCluster(clusterId, alertId);\n                 break;\n             case TIME:\n-            default:\n                 alert = alertService.findTimeAlertByCluster(clusterId, alertId);\n+                break;\n+            case METRIC:\n+                alert = alertService.findMetricAlertByCluster(clusterId, alertId);\n+                break;\n+            case PROMETHEUS:\n+                alert = alertService.findPrometheusAlertByCluster(clusterId, alertId);\n+                break;\n+            default:\n+                alert = null;\n+\n         }\n         if (alert == null) {\n             throw new NotFoundException(String.format(\"Could not find %s alert with id: '%s', for cluster: '%s'\", alertType, alertId, clusterId));\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQyMzc4NQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/7595#discussion_r393423785", "bodyText": "Does this mean 'One Load Alert per Cluster', or 'One Alert per cluster' or something else?", "author": "sidseth", "createdAt": "2020-03-17T03:20:04Z", "path": "autoscale/src/main/java/com/sequenceiq/periscope/domain/LoadAlert.java", "diffHunk": "@@ -0,0 +1,28 @@\n+package com.sequenceiq.periscope.domain;\n+\n+import javax.persistence.DiscriminatorValue;\n+import javax.persistence.Entity;\n+import javax.persistence.NamedQueries;\n+import javax.persistence.NamedQuery;\n+import javax.persistence.OneToOne;\n+\n+@Entity\n+@DiscriminatorValue(\"LOAD\")\n+@NamedQueries({\n+        @NamedQuery(name = \"LoadAlert.findByCluster\", query = \"SELECT c FROM LoadAlert c WHERE c.cluster.id= :clusterId AND c.id= :alertId\"),\n+        @NamedQuery(name = \"LoadAlert.findAllByCluster\", query = \"SELECT c FROM LoadAlert c WHERE c.cluster.id= :clusterId\")\n+})\n+public class LoadAlert extends BaseAlert {\n+\n+    @OneToOne", "originalCommit": "559afe9b8e7a9652db6f2b69a345384363939692", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzUxOTgyOA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7595#discussion_r393519828", "bodyText": "This has to be ManytoOne, changed it.", "author": "smaniraju", "createdAt": "2020-03-17T08:44:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQyMzc4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDEwNTkyMA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7595#discussion_r394105920", "bodyText": "What does it meant though. The JPA annotations are very confusing.", "author": "sidseth", "createdAt": "2020-03-18T04:53:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQyMzc4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDQ1ODExOQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/7595#discussion_r394458119", "bodyText": "There can be many LoadAlerts(One Per HostGroup if configured) for single cluster.", "author": "smaniraju", "createdAt": "2020-03-18T15:58:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQyMzc4NQ=="}], "type": "inlineReview", "revised_code": {"commit": "6754703bf01c5f4ced53e081020e13eac3994af9", "chunk": "diff --git a/autoscale/src/main/java/com/sequenceiq/periscope/domain/LoadAlert.java b/autoscale/src/main/java/com/sequenceiq/periscope/domain/LoadAlert.java\nindex d2be7496e4..38341eeb6d 100644\n--- a/autoscale/src/main/java/com/sequenceiq/periscope/domain/LoadAlert.java\n+++ b/autoscale/src/main/java/com/sequenceiq/periscope/domain/LoadAlert.java\n\n@@ -1,10 +1,14 @@\n package com.sequenceiq.periscope.domain;\n \n+import javax.persistence.Column;\n+import javax.persistence.Convert;\n import javax.persistence.DiscriminatorValue;\n import javax.persistence.Entity;\n+import javax.persistence.ManyToOne;\n import javax.persistence.NamedQueries;\n import javax.persistence.NamedQuery;\n-import javax.persistence.OneToOne;\n+\n+import com.sequenceiq.periscope.converter.db.LoadAlertConfigAttributeConverter;\n \n @Entity\n @DiscriminatorValue(\"LOAD\")\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQyMzkzNA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7595#discussion_r393423934", "bodyText": "Add a Json text field for Configuration? Can be populated with defaults, or left empty for now.", "author": "sidseth", "createdAt": "2020-03-17T03:20:38Z", "path": "autoscale/src/main/java/com/sequenceiq/periscope/domain/LoadAlert.java", "diffHunk": "@@ -0,0 +1,28 @@\n+package com.sequenceiq.periscope.domain;\n+\n+import javax.persistence.DiscriminatorValue;\n+import javax.persistence.Entity;\n+import javax.persistence.NamedQueries;\n+import javax.persistence.NamedQuery;\n+import javax.persistence.OneToOne;\n+\n+@Entity\n+@DiscriminatorValue(\"LOAD\")\n+@NamedQueries({\n+        @NamedQuery(name = \"LoadAlert.findByCluster\", query = \"SELECT c FROM LoadAlert c WHERE c.cluster.id= :clusterId AND c.id= :alertId\"),\n+        @NamedQuery(name = \"LoadAlert.findAllByCluster\", query = \"SELECT c FROM LoadAlert c WHERE c.cluster.id= :clusterId\")\n+})\n+public class LoadAlert extends BaseAlert {\n+\n+    @OneToOne\n+    private Cluster cluster;\n+", "originalCommit": "559afe9b8e7a9652db6f2b69a345384363939692", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzUyNzQ0OA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7595#discussion_r393527448", "bodyText": "The other fields related to LoadAlert are Min,Max,CoolDown. Since these applies to other type of alerts, I thought it is better to add hostGroup Level config for these three. For load alert specific config, i have added scaleUpMode (Normal, Aggressive) and scaleDownMode  (Normal, Aggressive) and storing it as a string itself in db.", "author": "smaniraju", "createdAt": "2020-03-17T08:58:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQyMzkzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDEwNjQzMw==", "url": "https://github.com/hortonworks/cloudbreak/pull/7595#discussion_r394106433", "bodyText": "Why I say json is that we don't necessarily know what these fields will be. For the current algo, it's probably aggressiveness as a value between 0 and 1 (fraction / percentage).\nIf the algorithm changes, the parameters can be very different.", "author": "sidseth", "createdAt": "2020-03-18T04:55:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQyMzkzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDQ1OTM1Ng==", "url": "https://github.com/hortonworks/cloudbreak/pull/7595#discussion_r394459356", "bodyText": "ack", "author": "smaniraju", "createdAt": "2020-03-18T15:59:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQyMzkzNA=="}], "type": "inlineReview", "revised_code": {"commit": "6754703bf01c5f4ced53e081020e13eac3994af9", "chunk": "diff --git a/autoscale/src/main/java/com/sequenceiq/periscope/domain/LoadAlert.java b/autoscale/src/main/java/com/sequenceiq/periscope/domain/LoadAlert.java\nindex d2be7496e4..38341eeb6d 100644\n--- a/autoscale/src/main/java/com/sequenceiq/periscope/domain/LoadAlert.java\n+++ b/autoscale/src/main/java/com/sequenceiq/periscope/domain/LoadAlert.java\n\n@@ -1,10 +1,14 @@\n package com.sequenceiq.periscope.domain;\n \n+import javax.persistence.Column;\n+import javax.persistence.Convert;\n import javax.persistence.DiscriminatorValue;\n import javax.persistence.Entity;\n+import javax.persistence.ManyToOne;\n import javax.persistence.NamedQueries;\n import javax.persistence.NamedQuery;\n-import javax.persistence.OneToOne;\n+\n+import com.sequenceiq.periscope.converter.db.LoadAlertConfigAttributeConverter;\n \n @Entity\n @DiscriminatorValue(\"LOAD\")\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQyNjk1Ng==", "url": "https://github.com/hortonworks/cloudbreak/pull/7595#discussion_r393426956", "bodyText": "List for future enhancements?, where load alerts may be set on different hostgroups on a single cluster?", "author": "sidseth", "createdAt": "2020-03-17T03:33:36Z", "path": "autoscale/src/main/java/com/sequenceiq/periscope/converter/ClusterConverter.java", "diffHunk": "@@ -59,6 +63,11 @@ public AutoscaleClusterResponse convert(Cluster source) {\n             json.setPrometheusAlerts(prometheusAlertRequests);\n         }\n \n+        if (!source.getLoadAlerts().isEmpty()) {", "originalCommit": "559afe9b8e7a9652db6f2b69a345384363939692", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzY2MDMwNg==", "url": "https://github.com/hortonworks/cloudbreak/pull/7595#discussion_r393660306", "bodyText": "All the loadalerts associated with various hostgroups is already retrieved.", "author": "smaniraju", "createdAt": "2020-03-17T13:00:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQyNjk1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDEwNjEwMA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7595#discussion_r394106100", "bodyText": "Was asking why a 'List' instead of a single LoadAlert.", "author": "sidseth", "createdAt": "2020-03-18T04:54:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQyNjk1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDQ2MDU1MQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/7595#discussion_r394460551", "bodyText": "It is a list since LoadAlerts can be configured one per HostGroup with different algorithms and maybe aggressiveness.", "author": "smaniraju", "createdAt": "2020-03-18T16:01:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQyNjk1Ng=="}], "type": "inlineReview", "revised_code": null}, {"oid": "6754703bf01c5f4ced53e081020e13eac3994af9", "url": "https://github.com/hortonworks/cloudbreak/commit/6754703bf01c5f4ced53e081020e13eac3994af9", "message": "Introduce Load Based Alert Endpoint", "committedDate": "2020-03-17T15:01:38Z", "type": "forcePushed"}, {"oid": "403d50e6a7f36ec2cbe46a328156d9a98c581930", "url": "https://github.com/hortonworks/cloudbreak/commit/403d50e6a7f36ec2cbe46a328156d9a98c581930", "message": "Introduce Load Based Alert Endpoint", "committedDate": "2020-03-19T13:46:58Z", "type": "forcePushed"}, {"oid": "b6b704b6e9bea51dfe895cbe9dda293467f1bc9e", "url": "https://github.com/hortonworks/cloudbreak/commit/b6b704b6e9bea51dfe895cbe9dda293467f1bc9e", "message": "Introduce Load Based Alert Endpoint", "committedDate": "2020-03-19T15:42:36Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ3NDIwNA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7595#discussion_r395474204", "bodyText": "What had we finalized on in terms of specifying minSize, maxSize and coolDown for Load Based only, or for Time Based as well?", "author": "sidseth", "createdAt": "2020-03-20T07:39:43Z", "path": "autoscale-api/src/main/java/com/sequenceiq/periscope/api/model/DistroXAutoscaleClusterRequest.java", "diffHunk": "@@ -0,0 +1,77 @@\n+package com.sequenceiq.periscope.api.model;\n+\n+import java.util.List;\n+\n+import javax.validation.Valid;\n+import javax.validation.constraints.NotNull;\n+\n+import com.sequenceiq.periscope.doc.ApiDescription.ClusterJsonsProperties;\n+import com.sequenceiq.periscope.doc.ApiDescription.DistroXClusterJsonsProperties;\n+\n+import io.swagger.annotations.ApiModel;\n+import io.swagger.annotations.ApiModelProperty;\n+\n+@ApiModel\n+public class DistroXAutoscaleClusterRequest implements Json {\n+    @ApiModelProperty(ClusterJsonsProperties.ENABLE_AUTOSCALING)\n+    private @NotNull Boolean enableAutoscaling;\n+\n+    @ApiModelProperty(DistroXClusterJsonsProperties.DISTROX_SCALING_MODE)\n+    private @Valid AutoscalingModeType autoScalingMode;\n+\n+    @ApiModelProperty(ClusterJsonsProperties.SCALING_CONFIGURATION)", "originalCommit": "b6b704b6e9bea51dfe895cbe9dda293467f1bc9e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTUxMzk1Mg==", "url": "https://github.com/hortonworks/cloudbreak/pull/7595#discussion_r395513952", "bodyText": "There was no finalization in this aspect, so i added to LoadBased based on the external api interface.", "author": "smaniraju", "createdAt": "2020-03-20T09:16:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ3NDIwNA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ3NjEzMA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7595#discussion_r395476130", "bodyText": "Extending AbstractAlertJson means the 'alertName' is present in LoadAlertConfigurationRequest as well as LoadAlertRequest. Also the description being repeated.", "author": "sidseth", "createdAt": "2020-03-20T07:45:53Z", "path": "autoscale-api/src/main/java/com/sequenceiq/periscope/api/model/LoadAlertConfigurationRequest.java", "diffHunk": "@@ -0,0 +1,34 @@\n+package com.sequenceiq.periscope.api.model;\n+\n+import javax.validation.Valid;\n+\n+import com.sequenceiq.periscope.doc.ApiDescription.LoadAlertJsonProperties;\n+\n+import io.swagger.annotations.ApiModel;\n+import io.swagger.annotations.ApiModelProperty;\n+\n+@ApiModel\n+public class LoadAlertConfigurationRequest extends AbstractAlertJson {", "originalCommit": "b6b704b6e9bea51dfe895cbe9dda293467f1bc9e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTUxNDA5Mg==", "url": "https://github.com/hortonworks/cloudbreak/pull/7595#discussion_r395514092", "bodyText": "ack", "author": "smaniraju", "createdAt": "2020-03-20T09:17:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ3NjEzMA=="}], "type": "inlineReview", "revised_code": {"commit": "71f7622ca61c26a56f262b166112a536e8d20e51", "chunk": "diff --git a/autoscale-api/src/main/java/com/sequenceiq/periscope/api/model/LoadAlertConfigurationRequest.java b/autoscale-api/src/main/java/com/sequenceiq/periscope/api/model/LoadAlertConfigurationRequest.java\nindex a02d74683a..994a208f7b 100644\n--- a/autoscale-api/src/main/java/com/sequenceiq/periscope/api/model/LoadAlertConfigurationRequest.java\n+++ b/autoscale-api/src/main/java/com/sequenceiq/periscope/api/model/LoadAlertConfigurationRequest.java\n\n@@ -8,7 +8,7 @@ import io.swagger.annotations.ApiModel;\n import io.swagger.annotations.ApiModelProperty;\n \n @ApiModel\n-public class LoadAlertConfigurationRequest extends AbstractAlertJson {\n+public class LoadAlertConfigurationRequest implements Json {\n \n     @ApiModelProperty(LoadAlertJsonProperties.LOAD_ALERT_CONFIGURATION_MIN_RESOUCE_VALUE)\n     private @Valid Integer minResourceValue;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ3NjMyMA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7595#discussion_r395476320", "bodyText": "How would these relate to the ScalingConfigurationRequest that exists in the DistroXAutoscaleClusterRequest?", "author": "sidseth", "createdAt": "2020-03-20T07:46:31Z", "path": "autoscale-api/src/main/java/com/sequenceiq/periscope/api/model/LoadAlertConfigurationRequest.java", "diffHunk": "@@ -0,0 +1,34 @@\n+package com.sequenceiq.periscope.api.model;\n+\n+import javax.validation.Valid;\n+\n+import com.sequenceiq.periscope.doc.ApiDescription.LoadAlertJsonProperties;\n+\n+import io.swagger.annotations.ApiModel;\n+import io.swagger.annotations.ApiModelProperty;\n+\n+@ApiModel\n+public class LoadAlertConfigurationRequest extends AbstractAlertJson {\n+\n+    @ApiModelProperty(LoadAlertJsonProperties.LOAD_ALERT_CONFIGURATION_MIN_RESOUCE_VALUE)", "originalCommit": "b6b704b6e9bea51dfe895cbe9dda293467f1bc9e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTUxNDY3MQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/7595#discussion_r395514671", "bodyText": "ScalingConfigurationRequest is at cluster level, and this can be overriding value for the alert. If not this can be removed and the cluster level value be used.", "author": "smaniraju", "createdAt": "2020-03-20T09:18:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ3NjMyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkyNDI3Mg==", "url": "https://github.com/hortonworks/cloudbreak/pull/7595#discussion_r395924272", "bodyText": "I would say remove ScalingConfigurationRequest rather than this.\nActually, ScalingConfigurationRequest could be changed to allow users to configure aspects like\n\nIf scaling up, max number of nodes to add in one 'scale-up' event. (This is hardcoded to 100 in CB at the moment.\n\nAnyway, I'd remove it for now.", "author": "sidseth", "createdAt": "2020-03-20T22:57:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ3NjMyMA=="}], "type": "inlineReview", "revised_code": {"commit": "71f7622ca61c26a56f262b166112a536e8d20e51", "chunk": "diff --git a/autoscale-api/src/main/java/com/sequenceiq/periscope/api/model/LoadAlertConfigurationRequest.java b/autoscale-api/src/main/java/com/sequenceiq/periscope/api/model/LoadAlertConfigurationRequest.java\nindex a02d74683a..994a208f7b 100644\n--- a/autoscale-api/src/main/java/com/sequenceiq/periscope/api/model/LoadAlertConfigurationRequest.java\n+++ b/autoscale-api/src/main/java/com/sequenceiq/periscope/api/model/LoadAlertConfigurationRequest.java\n\n@@ -8,7 +8,7 @@ import io.swagger.annotations.ApiModel;\n import io.swagger.annotations.ApiModelProperty;\n \n @ApiModel\n-public class LoadAlertConfigurationRequest extends AbstractAlertJson {\n+public class LoadAlertConfigurationRequest implements Json {\n \n     @ApiModelProperty(LoadAlertJsonProperties.LOAD_ALERT_CONFIGURATION_MIN_RESOUCE_VALUE)\n     private @Valid Integer minResourceValue;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ4MDExOA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7595#discussion_r395480118", "bodyText": "AutoScalingMode being at the top level means a single cluster can only have a single AutoScalingMode for each host group.\nAt the moment, this doesn't matter since there is only one hostGroup to scale out. However, the interface allows for multiple Time or Load based policies - so it is partly catering to future requirements, while disallowing some functionality that may be required in the future. Can this be flipped to pull the hostGroup up - similar to 'https://github.infra.cloudera.com/sseth/thunderhead/blob/master/services/libs/protocols-yaml/src/main/yaml/datahub.yaml#L1754'. That does not disallow different host groups from having different types of scaling configs. It doesn't necessarily enable potential future functionality like Spot instance ratios, but does not block it out either. (For Spot - the thought was to specify hostGroups, and then a ratio within that single policy block).", "author": "sidseth", "createdAt": "2020-03-20T07:57:53Z", "path": "autoscale-api/src/main/java/com/sequenceiq/periscope/api/model/DistroXAutoscaleClusterRequest.java", "diffHunk": "@@ -0,0 +1,77 @@\n+package com.sequenceiq.periscope.api.model;\n+\n+import java.util.List;\n+\n+import javax.validation.Valid;\n+import javax.validation.constraints.NotNull;\n+\n+import com.sequenceiq.periscope.doc.ApiDescription.ClusterJsonsProperties;\n+import com.sequenceiq.periscope.doc.ApiDescription.DistroXClusterJsonsProperties;\n+\n+import io.swagger.annotations.ApiModel;\n+import io.swagger.annotations.ApiModelProperty;\n+\n+@ApiModel\n+public class DistroXAutoscaleClusterRequest implements Json {\n+    @ApiModelProperty(ClusterJsonsProperties.ENABLE_AUTOSCALING)\n+    private @NotNull Boolean enableAutoscaling;\n+\n+    @ApiModelProperty(DistroXClusterJsonsProperties.DISTROX_SCALING_MODE)\n+    private @Valid AutoscalingModeType autoScalingMode;", "originalCommit": "b6b704b6e9bea51dfe895cbe9dda293467f1bc9e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTUxNTk1OA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7595#discussion_r395515958", "bodyText": "Based on all our discussions and even the UI spec I assumed only one type of AutoScaling will be supported for a single cluster with different policies for different hostGroups. This also ensures efficient loading of clusters and avoids full table scans.", "author": "smaniraju", "createdAt": "2020-03-20T09:20:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ4MDExOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkyMzgxMg==", "url": "https://github.com/hortonworks/cloudbreak/pull/7595#discussion_r395923812", "bodyText": "Replied in the separate email thread; adding that here as well.\nThe current release supports a single type. The API should not disallow it though, for future enhancements. The UI will typically offer a simpler set of options compared to what is possible via the CLI or API - which tends to always be richer.", "author": "sidseth", "createdAt": "2020-03-20T22:55:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ4MDExOA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ4MDc0Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/7595#discussion_r395480747", "bodyText": "State and Stack_Type - Is it possible to make these Enums? Not sure what they mean, and what the valid values are.", "author": "sidseth", "createdAt": "2020-03-20T07:59:46Z", "path": "autoscale-api/src/main/java/com/sequenceiq/periscope/api/model/DistroXAutoscaleClusterResponse.java", "diffHunk": "@@ -0,0 +1,134 @@\n+package com.sequenceiq.periscope.api.model;\n+\n+import java.util.List;\n+\n+import com.sequenceiq.periscope.doc.ApiDescription;\n+import com.sequenceiq.periscope.doc.ApiDescription.ClusterJsonsProperties;\n+\n+import io.swagger.annotations.ApiModel;\n+import io.swagger.annotations.ApiModelProperty;\n+\n+@ApiModel\n+public class DistroXAutoscaleClusterResponse implements Json {\n+    @ApiModelProperty(ClusterJsonsProperties.ID)\n+    private long id;\n+\n+    @ApiModelProperty(ClusterJsonsProperties.STACK_NAME)\n+    private String stackName;\n+\n+    @ApiModelProperty(ClusterJsonsProperties.STACK_CRN)\n+    private String stackCrn;\n+\n+    @ApiModelProperty(ClusterJsonsProperties.STATE)", "originalCommit": "b6b704b6e9bea51dfe895cbe9dda293467f1bc9e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "71f7622ca61c26a56f262b166112a536e8d20e51", "chunk": "diff --git a/autoscale-api/src/main/java/com/sequenceiq/periscope/api/model/DistroXAutoscaleClusterResponse.java b/autoscale-api/src/main/java/com/sequenceiq/periscope/api/model/DistroXAutoscaleClusterResponse.java\nindex 8df46bd5e4..f894400e1a 100644\n--- a/autoscale-api/src/main/java/com/sequenceiq/periscope/api/model/DistroXAutoscaleClusterResponse.java\n+++ b/autoscale-api/src/main/java/com/sequenceiq/periscope/api/model/DistroXAutoscaleClusterResponse.java\n\n@@ -2,6 +2,7 @@ package com.sequenceiq.periscope.api.model;\n \n import java.util.List;\n \n+import com.sequenceiq.cloudbreak.api.endpoint.v4.common.StackType;\n import com.sequenceiq.periscope.doc.ApiDescription;\n import com.sequenceiq.periscope.doc.ApiDescription.ClusterJsonsProperties;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ4MDk2Mg==", "url": "https://github.com/hortonworks/cloudbreak/pull/7595#discussion_r395480962", "bodyText": "ScalingConfigurarationResponse? (Likely identical to ScalingConfigurationRequest - but should still be a separate class), or maybe just name the object ScalingConfiguration.", "author": "sidseth", "createdAt": "2020-03-20T08:00:23Z", "path": "autoscale-api/src/main/java/com/sequenceiq/periscope/api/model/DistroXAutoscaleClusterResponse.java", "diffHunk": "@@ -0,0 +1,134 @@\n+package com.sequenceiq.periscope.api.model;\n+\n+import java.util.List;\n+\n+import com.sequenceiq.periscope.doc.ApiDescription;\n+import com.sequenceiq.periscope.doc.ApiDescription.ClusterJsonsProperties;\n+\n+import io.swagger.annotations.ApiModel;\n+import io.swagger.annotations.ApiModelProperty;\n+\n+@ApiModel\n+public class DistroXAutoscaleClusterResponse implements Json {\n+    @ApiModelProperty(ClusterJsonsProperties.ID)\n+    private long id;\n+\n+    @ApiModelProperty(ClusterJsonsProperties.STACK_NAME)\n+    private String stackName;\n+\n+    @ApiModelProperty(ClusterJsonsProperties.STACK_CRN)\n+    private String stackCrn;\n+\n+    @ApiModelProperty(ClusterJsonsProperties.STATE)\n+    private String state;\n+\n+    @ApiModelProperty(ClusterJsonsProperties.STACK_TYPE)\n+    private String stackType;\n+\n+    @ApiModelProperty(ClusterJsonsProperties.AUTOSCALING_ENABLED)\n+    private Boolean autoscalingEnabled;\n+\n+    @ApiModelProperty(ApiDescription.DistroXClusterJsonsProperties.DISTROX_SCALING_MODE)\n+    private AutoscalingModeType autoScalingMode;\n+\n+    @ApiModelProperty(ClusterJsonsProperties.TIME_ALERTS)\n+    private List<TimeAlertResponse> timeAlerts;\n+\n+    @ApiModelProperty(ClusterJsonsProperties.LOAD_ALERTS)\n+    private List<LoadAlertResponse> loadAlerts;\n+\n+    @ApiModelProperty(ClusterJsonsProperties.SCALING_CONFIGURATION)\n+    private ScalingConfigurationRequest scalingConfiguration;", "originalCommit": "b6b704b6e9bea51dfe895cbe9dda293467f1bc9e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTUxNzA3Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/7595#discussion_r395517077", "bodyText": "All Request and Response are identical except they have DB ID in response, the naming convention and converter conventions is based on existing class hierarchy.", "author": "smaniraju", "createdAt": "2020-03-20T09:23:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ4MDk2Mg=="}], "type": "inlineReview", "revised_code": {"commit": "71f7622ca61c26a56f262b166112a536e8d20e51", "chunk": "diff --git a/autoscale-api/src/main/java/com/sequenceiq/periscope/api/model/DistroXAutoscaleClusterResponse.java b/autoscale-api/src/main/java/com/sequenceiq/periscope/api/model/DistroXAutoscaleClusterResponse.java\nindex 8df46bd5e4..f894400e1a 100644\n--- a/autoscale-api/src/main/java/com/sequenceiq/periscope/api/model/DistroXAutoscaleClusterResponse.java\n+++ b/autoscale-api/src/main/java/com/sequenceiq/periscope/api/model/DistroXAutoscaleClusterResponse.java\n\n@@ -2,6 +2,7 @@ package com.sequenceiq.periscope.api.model;\n \n import java.util.List;\n \n+import com.sequenceiq.cloudbreak.api.endpoint.v4.common.StackType;\n import com.sequenceiq.periscope.doc.ApiDescription;\n import com.sequenceiq.periscope.doc.ApiDescription.ClusterJsonsProperties;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ4MTk3MA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7595#discussion_r395481970", "bodyText": "LoadAlertConfigurationRequest and LoadAlertConfigurationResponse are identical. Should be a single base class from which they inherit. Alternately, can be replaced by a 'LoadAlertConfiguration'", "author": "sidseth", "createdAt": "2020-03-20T08:03:15Z", "path": "autoscale-api/src/main/java/com/sequenceiq/periscope/api/model/LoadAlertConfigurationResponse.java", "diffHunk": "@@ -0,0 +1,31 @@\n+package com.sequenceiq.periscope.api.model;", "originalCommit": "b6b704b6e9bea51dfe895cbe9dda293467f1bc9e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTUxNzUyMw==", "url": "https://github.com/hortonworks/cloudbreak/pull/7595#discussion_r395517523", "bodyText": "same as above. have kept in sync with existing hierarchy we can refactor all request\\responses\\converters in a later PR if required.", "author": "smaniraju", "createdAt": "2020-03-20T09:23:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ4MTk3MA=="}], "type": "inlineReview", "revised_code": {"commit": "71f7622ca61c26a56f262b166112a536e8d20e51", "chunk": "diff --git a/autoscale-api/src/main/java/com/sequenceiq/periscope/api/model/LoadAlertConfigurationResponse.java b/autoscale-api/src/main/java/com/sequenceiq/periscope/api/model/LoadAlertConfigurationResponse.java\nindex 6b8821bebf..f2909ab4f8 100644\n--- a/autoscale-api/src/main/java/com/sequenceiq/periscope/api/model/LoadAlertConfigurationResponse.java\n+++ b/autoscale-api/src/main/java/com/sequenceiq/periscope/api/model/LoadAlertConfigurationResponse.java\n\n@@ -6,7 +6,8 @@ import io.swagger.annotations.ApiModel;\n import io.swagger.annotations.ApiModelProperty;\n \n @ApiModel\n-public class LoadAlertConfigurationResponse extends AbstractAlertJson {\n+public class LoadAlertConfigurationResponse implements Json {\n+\n     @ApiModelProperty(LoadAlertJsonProperties.LOAD_ALERT_CONFIGURATION_MIN_RESOUCE_VALUE)\n     private Integer minResourceValue;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ4Mjk3Ng==", "url": "https://github.com/hortonworks/cloudbreak/pull/7595#discussion_r395482976", "bodyText": "Similarly here. The only difference between the Request and Response is the 'id' in the response. Base class + inherit?", "author": "sidseth", "createdAt": "2020-03-20T08:06:03Z", "path": "autoscale-api/src/main/java/com/sequenceiq/periscope/api/model/LoadAlertRequest.java", "diffHunk": "@@ -0,0 +1,35 @@\n+package com.sequenceiq.periscope.api.model;", "originalCommit": "b6b704b6e9bea51dfe895cbe9dda293467f1bc9e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ5MDY1NA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7595#discussion_r395490654", "bodyText": "General question: This and AutoScaleClusterV1Controller - Is there some specific reason to move the conversion (domain (or DB) to model (API) from the Service over to the Controller?", "author": "sidseth", "createdAt": "2020-03-20T08:24:47Z", "path": "autoscale/src/main/java/com/sequenceiq/periscope/controller/AutoScaleClusterV2Controller.java", "diffHunk": "@@ -10,6 +10,7 @@\n import com.sequenceiq.periscope.api.model.AutoscaleClusterResponse;\n import com.sequenceiq.periscope.api.model.AutoscaleClusterState;\n import com.sequenceiq.periscope.api.model.StateJson;\n+import com.sequenceiq.periscope.converter.ClusterConverter;", "originalCommit": "b6b704b6e9bea51dfe895cbe9dda293467f1bc9e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTUxODMwMw==", "url": "https://github.com/hortonworks/cloudbreak/pull/7595#discussion_r395518303", "bodyText": "Yes expect this class all other service api retrieve domain model only. The same domain model can be converted to different types of response objects in the controller, hence it was refactored.", "author": "smaniraju", "createdAt": "2020-03-20T09:25:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ5MDY1NA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ5Mjg4NQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/7595#discussion_r395492885", "bodyText": "What is the significance of this?, and potential alternate values?", "author": "sidseth", "createdAt": "2020-03-20T08:29:33Z", "path": "autoscale-api/src/main/java/com/sequenceiq/periscope/api/model/AutoscaleStackType.java", "diffHunk": "@@ -0,0 +1,5 @@\n+package com.sequenceiq.periscope.api.model;\n+\n+public enum AutoscaleStackType {\n+    WORKLOAD", "originalCommit": "b6b704b6e9bea51dfe895cbe9dda293467f1bc9e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTUxODU4NA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7595#discussion_r395518584", "bodyText": "There are DATALAKE, TEMPLATE type clusters also.", "author": "smaniraju", "createdAt": "2020-03-20T09:25:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ5Mjg4NQ=="}], "type": "inlineReview", "revised_code": {"commit": "71f7622ca61c26a56f262b166112a536e8d20e51", "chunk": "diff --git a/autoscale-api/src/main/java/com/sequenceiq/periscope/api/model/AutoscaleStackType.java b/autoscale-api/src/main/java/com/sequenceiq/periscope/api/model/AutoscaleStackType.java\ndeleted file mode 100644\nindex 578b5ee659..0000000000\n--- a/autoscale-api/src/main/java/com/sequenceiq/periscope/api/model/AutoscaleStackType.java\n+++ /dev/null\n\n@@ -1,5 +0,0 @@\n-package com.sequenceiq.periscope.api.model;\n-\n-public enum AutoscaleStackType {\n-    WORKLOAD\n-}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ5NDgyMA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7595#discussion_r395494820", "bodyText": "Would a name need to be associated with each of the cron expressions? (Can be auto-generated if required)", "author": "sidseth", "createdAt": "2020-03-20T08:34:08Z", "path": "autoscale-api/src/main/java/com/sequenceiq/periscope/api/model/DistroXAutoscaleClusterRequest.java", "diffHunk": "@@ -0,0 +1,77 @@\n+package com.sequenceiq.periscope.api.model;\n+\n+import java.util.List;\n+\n+import javax.validation.Valid;\n+import javax.validation.constraints.NotNull;\n+\n+import com.sequenceiq.periscope.doc.ApiDescription.ClusterJsonsProperties;\n+import com.sequenceiq.periscope.doc.ApiDescription.DistroXClusterJsonsProperties;\n+\n+import io.swagger.annotations.ApiModel;\n+import io.swagger.annotations.ApiModelProperty;\n+\n+@ApiModel\n+public class DistroXAutoscaleClusterRequest implements Json {\n+    @ApiModelProperty(ClusterJsonsProperties.ENABLE_AUTOSCALING)\n+    private @NotNull Boolean enableAutoscaling;\n+\n+    @ApiModelProperty(DistroXClusterJsonsProperties.DISTROX_SCALING_MODE)\n+    private @Valid AutoscalingModeType autoScalingMode;\n+\n+    @ApiModelProperty(ClusterJsonsProperties.SCALING_CONFIGURATION)\n+    private @Valid ScalingConfigurationRequest scalingConfiguration;\n+\n+    @ApiModelProperty(ClusterJsonsProperties.TIME_ALERTS)\n+    private @Valid List<TimeAlertRequest> timeAlertRequests;\n+\n+    @ApiModelProperty(ClusterJsonsProperties.LOAD_ALERTS)\n+    private @Valid List<LoadAlertRequest> loadAlertRequests;\n+\n+    public DistroXAutoscaleClusterRequest() {\n+    }\n+\n+    public DistroXAutoscaleClusterRequest(boolean enableAutoscaling) {\n+        this.enableAutoscaling = enableAutoscaling;\n+    }\n+\n+    public void setEnableAutoscaling(Boolean enableAutoscaling) {\n+        this.enableAutoscaling = enableAutoscaling;\n+    }\n+\n+    public List<TimeAlertRequest> getTimeAlertRequests() {\n+        return timeAlertRequests;\n+    }\n+\n+    public void setTimeAlertRequests(List<TimeAlertRequest> timeAlertRequests) {", "originalCommit": "b6b704b6e9bea51dfe895cbe9dda293467f1bc9e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTUxODcwMw==", "url": "https://github.com/hortonworks/cloudbreak/pull/7595#discussion_r395518703", "bodyText": "name is nullable.", "author": "smaniraju", "createdAt": "2020-03-20T09:26:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ5NDgyMA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ5Njc0Mg==", "url": "https://github.com/hortonworks/cloudbreak/pull/7595#discussion_r395496742", "bodyText": "Skip this? Set the fields in the constructor itself, so that they can be 'final'", "author": "sidseth", "createdAt": "2020-03-20T08:38:37Z", "path": "autoscale/src/main/java/com/sequenceiq/periscope/model/MonitoredStack.java", "diffHunk": "@@ -8,20 +8,31 @@\n \n     private final ClusterManager clusterManager;\n \n-    private final String stackCrn;\n+    private String stackCrn;\n+\n+    private String stackName;\n+\n+    private String stackType;\n \n     private final Long stackId;\n \n     private final SecurityConfig securityConfig;\n \n     private final Tunnel tunnel;\n \n-    public MonitoredStack(ClusterManager clusterManager, String stackCrn, Long stackId, SecurityConfig securityConfig, Tunnel tunnel) {\n+    public MonitoredStack(ClusterManager clusterManager, String stackName, String stackCrn,\n+            String stackType, Long stackId, SecurityConfig securityConfig, Tunnel tunnel) {\n         this.clusterManager = clusterManager;\n-        this.stackCrn = stackCrn;\n-        this.stackId = stackId;\n         this.securityConfig = securityConfig;\n         this.tunnel = tunnel;\n+        this.stackId = stackId;\n+        initStackContext(stackName, stackCrn, stackType);\n+    }\n+\n+    private void initStackContext(String stackName, String stackCrn, String stackType) {", "originalCommit": "b6b704b6e9bea51dfe895cbe9dda293467f1bc9e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTUxOTExNg==", "url": "https://github.com/hortonworks/cloudbreak/pull/7595#discussion_r395519116", "bodyText": "There is checkstyle limit on constructor to 5 executable statements hence had to refactor", "author": "smaniraju", "createdAt": "2020-03-20T09:27:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ5Njc0Mg=="}], "type": "inlineReview", "revised_code": {"commit": "71f7622ca61c26a56f262b166112a536e8d20e51", "chunk": "diff --git a/autoscale/src/main/java/com/sequenceiq/periscope/model/MonitoredStack.java b/autoscale/src/main/java/com/sequenceiq/periscope/model/MonitoredStack.java\nindex 51e48dc094..8a30bd8477 100644\n--- a/autoscale/src/main/java/com/sequenceiq/periscope/model/MonitoredStack.java\n+++ b/autoscale/src/main/java/com/sequenceiq/periscope/model/MonitoredStack.java\n\n@@ -8,11 +9,11 @@ public final class MonitoredStack {\n \n     private final ClusterManager clusterManager;\n \n-    private String stackCrn;\n+    private final String stackCrn;\n \n-    private String stackName;\n+    private final String stackName;\n \n-    private String stackType;\n+    private final StackType stackType;\n \n     private final Long stackId;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ5NzQwMg==", "url": "https://github.com/hortonworks/cloudbreak/pull/7595#discussion_r395497402", "bodyText": "Same as previous - significance of the 'stackType' field? Why was it not required earlier when the id was being used?", "author": "sidseth", "createdAt": "2020-03-20T08:40:18Z", "path": "autoscale/src/main/java/com/sequenceiq/periscope/repository/ClusterRepository.java", "diffHunk": "@@ -25,6 +29,9 @@\n     @Query(\"SELECT c FROM Cluster c LEFT JOIN FETCH c.clusterPertain WHERE c.clusterPertain.userId = :userId\")\n     List<Cluster> findByUserId(@Param(\"userId\") String userId);\n \n+    @Query(\"SELECT c FROM Cluster c LEFT JOIN FETCH c.clusterPertain WHERE c.clusterPertain.userId = :userId and c.stackType = :stackType\")", "originalCommit": "b6b704b6e9bea51dfe895cbe9dda293467f1bc9e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTUxOTcxMw==", "url": "https://github.com/hortonworks/cloudbreak/pull/7595#discussion_r395519713", "bodyText": "It was not required in earlier CB, but since now we differentiate DataHub clusters and Datalake clusters this is required whether id based or crn based.", "author": "smaniraju", "createdAt": "2020-03-20T09:28:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ5NzQwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkxOTYyNw==", "url": "https://github.com/hortonworks/cloudbreak/pull/7595#discussion_r395919627", "bodyText": "Sounds good.", "author": "sidseth", "createdAt": "2020-03-20T22:39:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ5NzQwMg=="}], "type": "inlineReview", "revised_code": {"commit": "71f7622ca61c26a56f262b166112a536e8d20e51", "chunk": "diff --git a/autoscale/src/main/java/com/sequenceiq/periscope/repository/ClusterRepository.java b/autoscale/src/main/java/com/sequenceiq/periscope/repository/ClusterRepository.java\nindex 8abdc8460a..55e05ab3de 100644\n--- a/autoscale/src/main/java/com/sequenceiq/periscope/repository/ClusterRepository.java\n+++ b/autoscale/src/main/java/com/sequenceiq/periscope/repository/ClusterRepository.java\n\n@@ -30,7 +31,7 @@ public interface ClusterRepository extends CrudRepository<Cluster, Long> {\n     List<Cluster> findByUserId(@Param(\"userId\") String userId);\n \n     @Query(\"SELECT c FROM Cluster c LEFT JOIN FETCH c.clusterPertain WHERE c.clusterPertain.userId = :userId and c.stackType = :stackType\")\n-    List<Cluster> findByUserIdAndStackType(@Param(\"userId\") String userId, @Param(\"stackType\") String stackType);\n+    List<Cluster> findByUserIdAndStackType(@Param(\"userId\") String userId, @Param(\"stackType\") StackType stackType);\n \n     List<Cluster> findByStateAndPeriscopeNodeId(ClusterState state, String nodeId);\n \n"}}, {"oid": "71f7622ca61c26a56f262b166112a536e8d20e51", "url": "https://github.com/hortonworks/cloudbreak/commit/71f7622ca61c26a56f262b166112a536e8d20e51", "message": "Introduce Load Based Alert Endpoint", "committedDate": "2020-03-20T13:39:53Z", "type": "commit"}, {"oid": "71f7622ca61c26a56f262b166112a536e8d20e51", "url": "https://github.com/hortonworks/cloudbreak/commit/71f7622ca61c26a56f262b166112a536e8d20e51", "message": "Introduce Load Based Alert Endpoint", "committedDate": "2020-03-20T13:39:53Z", "type": "forcePushed"}]}