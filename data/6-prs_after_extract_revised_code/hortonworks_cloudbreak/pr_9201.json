{"pr_number": 9201, "pr_title": "CB-9156 refactor permission check logic on request object within auth\u2026", "pr_createdAt": "2020-10-12T12:57:40Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/9201", "timeline": [{"oid": "ab982d25290b1a9fc5104ce9b9563e5c32dde11a", "url": "https://github.com/hortonworks/cloudbreak/commit/ab982d25290b1a9fc5104ce9b9563e5c32dde11a", "message": "CB-9156 refactor permission check logic on request object within authz framework", "committedDate": "2020-10-12T13:21:08Z", "type": "forcePushed"}, {"oid": "2c8e00fa1d348ec8d43f26cac35f6f19fd93c72d", "url": "https://github.com/hortonworks/cloudbreak/commit/2c8e00fa1d348ec8d43f26cac35f6f19fd93c72d", "message": "CB-9156 refactor permission check logic on request object within authz framework", "committedDate": "2020-10-13T10:24:33Z", "type": "forcePushed"}, {"oid": "abcf7e32958ddc930cbea1e71d071598567467d5", "url": "https://github.com/hortonworks/cloudbreak/commit/abcf7e32958ddc930cbea1e71d071598567467d5", "message": "CB-9156 refactor permission check logic on request object within authz framework", "committedDate": "2020-10-13T10:29:34Z", "type": "forcePushed"}, {"oid": "09a29655c3bf9451160e666ee6f866f6e6b50579", "url": "https://github.com/hortonworks/cloudbreak/commit/09a29655c3bf9451160e666ee6f866f6e6b50579", "message": "CB-9156 refactor permission check logic on request object within authz framework", "committedDate": "2020-10-13T10:45:57Z", "type": "forcePushed"}, {"oid": "bf8c47efd0cd20684367aed49c0b0db3b3adfe61", "url": "https://github.com/hortonworks/cloudbreak/commit/bf8c47efd0cd20684367aed49c0b0db3b3adfe61", "message": "CB-9156 refactor permission check logic on request object within authz framework", "committedDate": "2020-10-13T11:06:57Z", "type": "forcePushed"}, {"oid": "74cab385c98cd7a0590d7041507683cd9cea05d5", "url": "https://github.com/hortonworks/cloudbreak/commit/74cab385c98cd7a0590d7041507683cd9cea05d5", "message": "CB-9156 refactor permission check logic on request object within authz framework", "committedDate": "2020-10-13T12:28:19Z", "type": "forcePushed"}, {"oid": "0e501fd7f61a9a285f4eb4cbe41e0c5607c7d53e", "url": "https://github.com/hortonworks/cloudbreak/commit/0e501fd7f61a9a285f4eb4cbe41e0c5607c7d53e", "message": "CB-9156 refactor permission check logic on request object within authz framework", "committedDate": "2020-10-13T18:18:44Z", "type": "forcePushed"}, {"oid": "c2abecf710ae1a50f85e48191b88434c60730e4f", "url": "https://github.com/hortonworks/cloudbreak/commit/c2abecf710ae1a50f85e48191b88434c60730e4f", "message": "CB-9156 refactor permission check logic on request object within authz framework", "committedDate": "2020-10-14T05:20:33Z", "type": "forcePushed"}, {"oid": "ac0b20ea2f6ca8412a5092304a591fbe98cb41f1", "url": "https://github.com/hortonworks/cloudbreak/commit/ac0b20ea2f6ca8412a5092304a591fbe98cb41f1", "message": "CB-9156 refactor permission check logic on request object within authz framework", "committedDate": "2020-10-14T05:26:26Z", "type": "forcePushed"}, {"oid": "9c7532b43e9f914d4c85ba2af99e3df91886cfd4", "url": "https://github.com/hortonworks/cloudbreak/commit/9c7532b43e9f914d4c85ba2af99e3df91886cfd4", "message": "CB-9156 refactor permission check logic on request object within authz framework", "committedDate": "2020-10-14T09:51:51Z", "type": "forcePushed"}, {"oid": "fb21b7df3ba72a645abfb4c2f20fe511e2e2ff1c", "url": "https://github.com/hortonworks/cloudbreak/commit/fb21b7df3ba72a645abfb4c2f20fe511e2e2ff1c", "message": "CB-9156 refactor permission check logic on request object within authz framework", "committedDate": "2020-10-14T10:03:29Z", "type": "forcePushed"}, {"oid": "b5eba7c6528098758ae53e593f682fb86af7be0c", "url": "https://github.com/hortonworks/cloudbreak/commit/b5eba7c6528098758ae53e593f682fb86af7be0c", "message": "CB-9156 refactor permission check logic on request object within authz framework", "committedDate": "2020-10-14T11:39:45Z", "type": "forcePushed"}, {"oid": "56be864efeffff6227225dbb7290bce2de45b4f9", "url": "https://github.com/hortonworks/cloudbreak/commit/56be864efeffff6227225dbb7290bce2de45b4f9", "message": "CB-9156 refactor permission check logic on request object within authz framework", "committedDate": "2020-10-14T11:55:21Z", "type": "forcePushed"}, {"oid": "19157b5745d85af19c227d0f764528c825e7051b", "url": "https://github.com/hortonworks/cloudbreak/commit/19157b5745d85af19c227d0f764528c825e7051b", "message": "CB-9156 refactor permission check logic on request object within authz framework", "committedDate": "2020-10-19T08:45:26Z", "type": "forcePushed"}, {"oid": "72053d66a7df2a479fb90458ceea5fd809a2853f", "url": "https://github.com/hortonworks/cloudbreak/commit/72053d66a7df2a479fb90458ceea5fd809a2853f", "message": "CB-9156 refactor permission check logic on request object within authz framework", "committedDate": "2020-10-19T10:06:07Z", "type": "forcePushed"}, {"oid": "0854d321e2022ee0b2e0d8ae82836a9043c549e5", "url": "https://github.com/hortonworks/cloudbreak/commit/0854d321e2022ee0b2e0d8ae82836a9043c549e5", "message": "CB-9156 refactor permission check logic on request object within authz framework", "committedDate": "2020-10-21T09:18:43Z", "type": "forcePushed"}, {"oid": "9691e57e3d5cd245a0628aa89e235b764da13dc3", "url": "https://github.com/hortonworks/cloudbreak/commit/9691e57e3d5cd245a0628aa89e235b764da13dc3", "message": "CB-9156 refactor permission check logic on request object within authz framework", "committedDate": "2020-10-21T09:38:28Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTkyNTU5MQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9201#discussion_r509925591", "bodyText": "Not a blocker but would be better to make only one request to UMS instead of doing it in a for loop.", "author": "foldik", "createdAt": "2020-10-22T07:05:04Z", "path": "authorization-common/src/main/java/com/sequenceiq/authorization/service/CompositeRequestPropertyPermissionChecker.java", "diffHunk": "@@ -0,0 +1,37 @@\n+package com.sequenceiq.authorization.service;\n+\n+import java.lang.annotation.Annotation;\n+import java.util.Arrays;\n+\n+import javax.inject.Inject;\n+\n+import org.aspectj.lang.ProceedingJoinPoint;\n+import org.aspectj.lang.reflect.MethodSignature;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+import com.sequenceiq.authorization.annotation.CheckPermissionByCompositeRequestProperty;\n+\n+@Component\n+public class CompositeRequestPropertyPermissionChecker extends ResourcePermissionChecker<CheckPermissionByCompositeRequestProperty> {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(CompositeRequestPropertyPermissionChecker.class);\n+\n+    @Inject\n+    private RequestPropertyPermissionChecker requestPropertyPermissionChecker;\n+\n+    @Override\n+    public <T extends Annotation> void checkPermissions(T rawMethodAnnotation, String userCrn, ProceedingJoinPoint proceedingJoinPoint,\n+            MethodSignature methodSignature, long startTime) {\n+        // check fields of requestObject\n+        CheckPermissionByCompositeRequestProperty methodAnnotation = (CheckPermissionByCompositeRequestProperty) rawMethodAnnotation;\n+        Arrays.stream(methodAnnotation.value()).forEach(checkPermissionByRequestField -> requestPropertyPermissionChecker.", "originalCommit": "9691e57e3d5cd245a0628aa89e235b764da13dc3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTkzMjk3MQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9201#discussion_r509932971", "bodyText": "to be honest, i would not use hasRights once again, it is hard to use and hard to extract result from response, especially if we would use it here after collecting crns for every field of request object, conditional dual check (based on entitlement) makes it even more complex", "author": "horadla23", "createdAt": "2020-10-22T07:19:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTkyNTU5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTk0MTg5NQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9201#discussion_r509941895", "bodyText": "Yes I see, the UMS API doesn't give us very usable answer, therefore our logic would become quite complex. In an ideal world for every controller method we could just collect the information what to authorize then send the whole thing to UMS in one request, and based on the annotations we could generate the authorization logic in compile time not using any kind of reflection at all. I know it's a dream so I'm not pushing this further.", "author": "foldik", "createdAt": "2020-10-22T07:35:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTkyNTU5MQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "313a94f396159e88e81d9aa8af16ffa913488eb1", "url": "https://github.com/hortonworks/cloudbreak/commit/313a94f396159e88e81d9aa8af16ffa913488eb1", "message": "CB-9156 refactor permission check logic on request object within authz framework", "committedDate": "2020-10-22T09:09:56Z", "type": "commit"}, {"oid": "313a94f396159e88e81d9aa8af16ffa913488eb1", "url": "https://github.com/hortonworks/cloudbreak/commit/313a94f396159e88e81d9aa8af16ffa913488eb1", "message": "CB-9156 refactor permission check logic on request object within authz framework", "committedDate": "2020-10-22T09:09:56Z", "type": "forcePushed"}]}