{"pr_number": 7484, "pr_title": "CB-5099: FreeIPA changes to support AWS instance recovery", "pr_createdAt": "2020-03-06T06:05:38Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/7484", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODgwMzkzNQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/7484#discussion_r388803935", "bodyText": "could you drop this field in favor of adding only an entry to the parameter map? As it is very spi specific I think we should not include this as a field in CloudStack", "author": "lacikaaa", "createdAt": "2020-03-06T09:44:41Z", "path": "cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/model/CloudStack.java", "diffHunk": "@@ -33,8 +33,11 @@\n \n     private final Optional<SpiFileSystem> fileSystem;\n \n+    private final boolean createCloudWatchAlarm;", "originalCommit": "f363f4a5268821f31856be790a200a215ed875ed", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIyOTU5Mw==", "url": "https://github.com/hortonworks/cloudbreak/pull/7484#discussion_r389229593", "bodyText": "fixed", "author": "holleyism", "createdAt": "2020-03-07T05:21:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODgwMzkzNQ=="}], "type": "inlineReview", "revised_code": {"commit": "d48507630c9052a13eee22e0abe51b6db442736e", "chunk": "diff --git a/cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/model/CloudStack.java b/cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/model/CloudStack.java\nindex 36a471a138..727b2649e1 100644\n--- a/cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/model/CloudStack.java\n+++ b/cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/model/CloudStack.java\n\n@@ -33,11 +35,8 @@ public class CloudStack {\n \n     private final Optional<SpiFileSystem> fileSystem;\n \n-    private final boolean createCloudWatchAlarm;\n-\n     public CloudStack(Collection<Group> groups, Network network, Image image, Map<String, String> parameters, Map<String, String> tags, String template,\n-            InstanceAuthentication instanceAuthentication, String loginUserName, String publicKey, SpiFileSystem fileSystem,\n-            boolean createCloudWatchAlarm) {\n+            InstanceAuthentication instanceAuthentication, String loginUserName, String publicKey, SpiFileSystem fileSystem) {\n         this.groups = ImmutableList.copyOf(groups);\n         this.network = network;\n         this.image = image;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODgwNjk3MA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7484#discussion_r388806970", "bodyText": "could you move cloudwatch related code/methods to a separate component?\nthat way it would be easier to write some simple unit test for it also. maybe the condition could be moved there, so you can cover all the pieces of the logic related to it", "author": "lacikaaa", "createdAt": "2020-03-06T09:50:21Z", "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/connector/resource/AwsLaunchService.java", "diffHunk": "@@ -163,9 +176,35 @@\n \n         awsTaggingService.tagRootVolumes(ac, amazonEC2Client, instances, stack.getTags());\n \n+        if (stack.isCreateCloudWatchAlarm()) {\n+            addCloudWatchAlarmsForSystemFailures(instances, regionName, credentialView);\n+        }\n         return awsResourceConnector.check(ac, instances);\n     }\n \n+    private void addCloudWatchAlarmsForSystemFailures(List<CloudResource> instances, String regionName, AwsCredentialView credentialView) {", "originalCommit": "f363f4a5268821f31856be790a200a215ed875ed", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIyOTYwMw==", "url": "https://github.com/hortonworks/cloudbreak/pull/7484#discussion_r389229603", "bodyText": "moved", "author": "holleyism", "createdAt": "2020-03-07T05:21:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODgwNjk3MA=="}], "type": "inlineReview", "revised_code": {"commit": "d48507630c9052a13eee22e0abe51b6db442736e", "chunk": "diff --git a/cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/connector/resource/AwsLaunchService.java b/cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/connector/resource/AwsLaunchService.java\nindex b5569499be..49a55d248c 100644\n--- a/cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/connector/resource/AwsLaunchService.java\n+++ b/cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/connector/resource/AwsLaunchService.java\n\n@@ -176,33 +166,9 @@ public class AwsLaunchService {\n \n         awsTaggingService.tagRootVolumes(ac, amazonEC2Client, instances, stack.getTags());\n \n-        if (stack.isCreateCloudWatchAlarm()) {\n-            addCloudWatchAlarmsForSystemFailures(instances, regionName, credentialView);\n-        }\n-        return awsResourceConnector.check(ac, instances);\n-    }\n+        awsCloudWatchService.addCloudWatchAlarmsForSystemFailures(instances, stack, regionName, credentialView);\n \n-    private void addCloudWatchAlarmsForSystemFailures(List<CloudResource> instances, String regionName, AwsCredentialView credentialView) {\n-        instances.stream().forEach(instance -> {\n-            try {\n-                PutMetricAlarmRequest metricAlarmRequest = new PutMetricAlarmRequest();\n-                metricAlarmRequest.setAlarmActions(Arrays.asList(\"arn:aws:automate:\" + regionName + \":ec2:recover\"));\n-                metricAlarmRequest.setAlarmName(instance.getInstanceId() + ALARM_SUFFIX);\n-                metricAlarmRequest.setMetricName(\"StatusCheckFailed_System\");\n-                metricAlarmRequest.setStatistic(\"Maximum\");\n-                metricAlarmRequest.setNamespace(\"AWS/EC2\");\n-                metricAlarmRequest.setDimensions(Arrays.asList(new Dimension().withName(\"InstanceId\").withValue(instance.getInstanceId())));\n-                metricAlarmRequest.setPeriod(CLOUDWATCH_PERIOD);\n-                metricAlarmRequest.setEvaluationPeriods(CLOUDWATCH_EVALUATION_PERIODS);\n-                metricAlarmRequest.setThreshold(CLOUDWATCH_THRESHOLD);\n-                metricAlarmRequest.setComparisonOperator(\"GreaterThanOrEqualToThreshold\");\n-                AmazonCloudWatchClient amazonCloudWatchClient = awsClient.createCloudWatchClient(credentialView, regionName);\n-                amazonCloudWatchClient.putMetricAlarm(metricAlarmRequest);\n-                LOGGER.debug(\"Created cloudwatch alarm for instanceId {}.\", instance.getInstanceId());\n-            } catch (AmazonCloudWatchException acwe) {\n-                LOGGER.error(\"Unable to create cloudwatch alarm for instanceId {}: {}\", instance.getInstanceId(), acwe.getLocalizedMessage());\n-            }\n-        });\n+        return awsResourceConnector.check(ac, instances);\n     }\n \n     private void associatePublicIpsToGatewayInstances(CloudStack stack, String cFStackName, AmazonCloudFormationRetryClient cfRetryClient,\n"}}, {"oid": "d48507630c9052a13eee22e0abe51b6db442736e", "url": "https://github.com/hortonworks/cloudbreak/commit/d48507630c9052a13eee22e0abe51b6db442736e", "message": "CB-5099: FreeIPA changes to support AWS instance recovery\n\nThis change adds an automatic cloudwatch alarm during\nthe instance creation for AWS and removes it during\ntermination. This is only necessary for AWS as Azure\nenables this by default. This enables an instance to\nautomatically recover when the underlying hardware,\nowned by AWS, is faulty.", "committedDate": "2020-03-07T05:19:14Z", "type": "forcePushed"}, {"oid": "cbb849b6c655ea008a44239ddc4515ced5a1627c", "url": "https://github.com/hortonworks/cloudbreak/commit/cbb849b6c655ea008a44239ddc4515ced5a1627c", "message": "CB-5099: FreeIPA changes to support AWS instance recovery\n\nThis change adds an automatic cloudwatch alarm during\nthe instance creation for AWS and removes it during\ntermination. This is only necessary for AWS as Azure\nenables this by default. This enables an instance to\nautomatically recover when the underlying hardware,\nowned by AWS, is faulty.", "committedDate": "2020-03-09T14:34:25Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDM5MDg3Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/7484#discussion_r390390877", "bodyText": "I think this would be better in PlatformParametersConsts", "author": "lacikaaa", "createdAt": "2020-03-10T15:14:59Z", "path": "cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/model/CloudStack.java", "diffHunk": "@@ -13,6 +13,8 @@\n  */\n public class CloudStack {\n \n+    public static final String CLOUDWATCH_CREATE_PARAMETER = \"createCloudWatchAlarm\";", "originalCommit": "cbb849b6c655ea008a44239ddc4515ced5a1627c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDUwMDEyNA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7484#discussion_r390500124", "bodyText": "moved", "author": "holleyism", "createdAt": "2020-03-10T17:49:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDM5MDg3Nw=="}], "type": "inlineReview", "revised_code": {"commit": "7fdccb6e8f1e3087ec53dbfc15a6494938afef0a", "chunk": "diff --git a/cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/model/CloudStack.java b/cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/model/CloudStack.java\nindex 727b2649e1..693b9fd2c2 100644\n--- a/cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/model/CloudStack.java\n+++ b/cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/model/CloudStack.java\n\n@@ -13,8 +13,6 @@ import com.google.common.collect.ImmutableMap;\n  */\n public class CloudStack {\n \n-    public static final String CLOUDWATCH_CREATE_PARAMETER = \"createCloudWatchAlarm\";\n-\n     private final List<Group> groups;\n \n     private final Network network;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDM5MTYyMg==", "url": "https://github.com/hortonworks/cloudbreak/pull/7484#discussion_r390391622", "bodyText": "Could you move these to @Values so we can easily override them?", "author": "lacikaaa", "createdAt": "2020-03-10T15:15:56Z", "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/connector/resource/AwsCloudWatchService.java", "diffHunk": "@@ -0,0 +1,85 @@\n+package com.sequenceiq.cloudbreak.cloud.aws.connector.resource;\n+\n+import static com.sequenceiq.cloudbreak.cloud.model.CloudStack.CLOUDWATCH_CREATE_PARAMETER;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+import javax.inject.Inject;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Service;\n+\n+import com.amazonaws.services.cloudwatch.AmazonCloudWatchClient;\n+import com.amazonaws.services.cloudwatch.model.AmazonCloudWatchException;\n+import com.amazonaws.services.cloudwatch.model.DeleteAlarmsRequest;\n+import com.amazonaws.services.cloudwatch.model.Dimension;\n+import com.amazonaws.services.cloudwatch.model.PutMetricAlarmRequest;\n+import com.sequenceiq.cloudbreak.cloud.aws.AwsClient;\n+import com.sequenceiq.cloudbreak.cloud.aws.view.AwsCredentialView;\n+import com.sequenceiq.cloudbreak.cloud.model.CloudInstance;\n+import com.sequenceiq.cloudbreak.cloud.model.CloudResource;\n+import com.sequenceiq.cloudbreak.cloud.model.CloudStack;\n+\n+@Service\n+public class AwsCloudWatchService {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(AwsCloudWatchService.class);\n+\n+    private  static final String ALARM_SUFFIX = \"-Status-Check-Failed-System\";\n+\n+    private static final int CLOUDWATCH_PERIOD = 60;\n+\n+    private static final int CLOUDWATCH_EVALUATION_PERIODS = 2;\n+\n+    private static final double CLOUDWATCH_THRESHOLD = 1.0;", "originalCommit": "cbb849b6c655ea008a44239ddc4515ced5a1627c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDU1MzIxMw==", "url": "https://github.com/hortonworks/cloudbreak/pull/7484#discussion_r390553213", "bodyText": "done", "author": "holleyism", "createdAt": "2020-03-10T19:17:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDM5MTYyMg=="}], "type": "inlineReview", "revised_code": {"commit": "7fdccb6e8f1e3087ec53dbfc15a6494938afef0a", "chunk": "diff --git a/cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/connector/resource/AwsCloudWatchService.java b/cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/connector/resource/AwsCloudWatchService.java\nindex 5e798058e5..3a4342df78 100644\n--- a/cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/connector/resource/AwsCloudWatchService.java\n+++ b/cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/connector/resource/AwsCloudWatchService.java\n\n@@ -1,6 +1,6 @@\n package com.sequenceiq.cloudbreak.cloud.aws.connector.resource;\n \n-import static com.sequenceiq.cloudbreak.cloud.model.CloudStack.CLOUDWATCH_CREATE_PARAMETER;\n+import static com.sequenceiq.cloudbreak.cloud.PlatformParametersConsts.CLOUDWATCH_CREATE_PARAMETER;\n \n import java.util.Arrays;\n import java.util.List;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDM5MjkwNA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7484#discussion_r390392904", "bodyText": "this should be also come from a @Value so we can turn it off/on as we wish", "author": "lacikaaa", "createdAt": "2020-03-10T15:17:37Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/converter/cloud/StackToCloudStackConverter.java", "diffHunk": "@@ -96,8 +97,9 @@ public CloudStack convert(Stack stack, Collection<String> deleteRequestedInstanc\n         Network network = buildNetwork(stack);\n         InstanceAuthentication instanceAuthentication = buildInstanceAuthentication(stack.getStackAuthentication());\n \n-        return new CloudStack(instanceGroups, network, image, Collections.emptyMap(), getUserDefinedTags(stack), stack.getTemplate(),\n-                instanceAuthentication, instanceAuthentication.getLoginUserName(), instanceAuthentication.getPublicKey(), null);\n+        return new CloudStack(instanceGroups, network, image, Map.of(CLOUDWATCH_CREATE_PARAMETER, Boolean.TRUE.toString()),", "originalCommit": "cbb849b6c655ea008a44239ddc4515ced5a1627c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDU1MzI4MQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/7484#discussion_r390553281", "bodyText": "done", "author": "holleyism", "createdAt": "2020-03-10T19:17:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDM5MjkwNA=="}], "type": "inlineReview", "revised_code": {"commit": "7fdccb6e8f1e3087ec53dbfc15a6494938afef0a", "chunk": "diff --git a/freeipa/src/main/java/com/sequenceiq/freeipa/converter/cloud/StackToCloudStackConverter.java b/freeipa/src/main/java/com/sequenceiq/freeipa/converter/cloud/StackToCloudStackConverter.java\nindex 25800b392a..ce05d6a32a 100644\n--- a/freeipa/src/main/java/com/sequenceiq/freeipa/converter/cloud/StackToCloudStackConverter.java\n+++ b/freeipa/src/main/java/com/sequenceiq/freeipa/converter/cloud/StackToCloudStackConverter.java\n\n@@ -97,7 +101,7 @@ public class StackToCloudStackConverter implements Converter<Stack, CloudStack>\n         Network network = buildNetwork(stack);\n         InstanceAuthentication instanceAuthentication = buildInstanceAuthentication(stack.getStackAuthentication());\n \n-        return new CloudStack(instanceGroups, network, image, Map.of(CLOUDWATCH_CREATE_PARAMETER, Boolean.TRUE.toString()),\n+        return new CloudStack(instanceGroups, network, image, Map.of(CLOUDWATCH_CREATE_PARAMETER, Boolean.toString(enableCloudwatch)),\n                 getUserDefinedTags(stack), stack.getTemplate(), instanceAuthentication, instanceAuthentication.getLoginUserName(),\n                 instanceAuthentication.getPublicKey(), null);\n     }\n"}}, {"oid": "7fdccb6e8f1e3087ec53dbfc15a6494938afef0a", "url": "https://github.com/hortonworks/cloudbreak/commit/7fdccb6e8f1e3087ec53dbfc15a6494938afef0a", "message": "CB-5099: FreeIPA changes to support AWS instance recovery\n\nThis change adds an automatic cloudwatch alarm during\nthe instance creation for AWS and removes it during\ntermination. This is only necessary for AWS as Azure\nenables this by default. This enables an instance to\nautomatically recover when the underlying hardware,\nowned by AWS, is faulty.", "committedDate": "2020-03-10T19:34:51Z", "type": "commit"}, {"oid": "7fdccb6e8f1e3087ec53dbfc15a6494938afef0a", "url": "https://github.com/hortonworks/cloudbreak/commit/7fdccb6e8f1e3087ec53dbfc15a6494938afef0a", "message": "CB-5099: FreeIPA changes to support AWS instance recovery\n\nThis change adds an automatic cloudwatch alarm during\nthe instance creation for AWS and removes it during\ntermination. This is only necessary for AWS as Azure\nenables this by default. This enables an instance to\nautomatically recover when the underlying hardware,\nowned by AWS, is faulty.", "committedDate": "2020-03-10T19:34:51Z", "type": "forcePushed"}]}