{"pr_number": 7324, "pr_title": "CB-5395 Fix FreeIpa delete/detach conditions", "pr_createdAt": "2020-02-19T12:33:51Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/7324", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTI3MDcxNQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/7324#discussion_r381270715", "bodyText": "I think we should use the deleted condition in these cases because envOptional.get().isCreateFreeIpa() is dedicated to reduce the number of calls on FreeIPA service as FreeIPA creation hasn't been requested then we have no business on FreeIPA service side", "author": "biharitomi", "createdAt": "2020-02-19T12:52:47Z", "path": "environment/src/main/java/com/sequenceiq/environment/environment/flow/deletion/handler/freeipa/FreeIpaDeletionHandler.java", "diffHunk": "@@ -56,24 +55,12 @@ public void accept(Event<EnvironmentDto> environmentDtoEvent) {\n         EnvironmentDto environmentDto = environmentDtoEvent.getData();\n         Optional<Environment> envOptional = environmentService.findEnvironmentById(environmentDto.getId());\n         try {\n-            if (envOptional.isPresent() && envOptional.get().isCreateFreeIpa() && freeIpaExistsForEnvironment(envOptional.get())) {\n+            if (envOptional.isPresent() && freeIpaExistsForEnvironment(envOptional.get())) {", "originalCommit": "dc7c628395cd100e5aa68c7130f4e5c0968df085", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a67ad60b7ea26c155f3577e131de1e07741b10e3", "chunk": "diff --git a/environment/src/main/java/com/sequenceiq/environment/environment/flow/deletion/handler/freeipa/FreeIpaDeletionHandler.java b/environment/src/main/java/com/sequenceiq/environment/environment/flow/deletion/handler/freeipa/FreeIpaDeletionHandler.java\nindex 1da51e143e..ad07385e2d 100644\n--- a/environment/src/main/java/com/sequenceiq/environment/environment/flow/deletion/handler/freeipa/FreeIpaDeletionHandler.java\n+++ b/environment/src/main/java/com/sequenceiq/environment/environment/flow/deletion/handler/freeipa/FreeIpaDeletionHandler.java\n\n@@ -53,13 +54,12 @@ public class FreeIpaDeletionHandler extends EventSenderAwareHandler<EnvironmentD\n     @Override\n     public void accept(Event<EnvironmentDto> environmentDtoEvent) {\n         EnvironmentDto environmentDto = environmentDtoEvent.getData();\n-        Optional<Environment> envOptional = environmentService.findEnvironmentById(environmentDto.getId());\n+        Environment environment = environmentService.findEnvironmentById(environmentDto.getId()).orElse(null);\n         try {\n-            if (envOptional.isPresent() && freeIpaExistsForEnvironment(envOptional.get())) {\n-                Environment environment = envOptional.get();\n-                if (environment.getParentEnvironment() != null) {\n+            if (shouldRemoveFreeIpa(environment)) {\n+                if (Objects.nonNull(environment.getParentEnvironment())) {\n                     detachChildEnvironmentFromFreeIpa(environment);\n-                } else if (environment.isCreateFreeIpa()) {\n+                } else {\n                     deleteFreeIpa(environment);\n                 }\n             }\n"}}, {"oid": "a67ad60b7ea26c155f3577e131de1e07741b10e3", "url": "https://github.com/hortonworks/cloudbreak/commit/a67ad60b7ea26c155f3577e131de1e07741b10e3", "message": "CB-5395 Fix FreeIpa delete/detach conditions", "committedDate": "2020-02-19T13:50:55Z", "type": "commit"}, {"oid": "a67ad60b7ea26c155f3577e131de1e07741b10e3", "url": "https://github.com/hortonworks/cloudbreak/commit/a67ad60b7ea26c155f3577e131de1e07741b10e3", "message": "CB-5395 Fix FreeIpa delete/detach conditions", "committedDate": "2020-02-19T13:50:55Z", "type": "forcePushed"}]}