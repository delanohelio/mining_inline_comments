{"pr_number": 9569, "pr_title": "CB-9901 Update load balancer when instances change", "pr_createdAt": "2020-12-03T21:01:57Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/9569", "timeline": [{"oid": "dab8b02a3385430b471c3cfe92b54fdbb1e395c4", "url": "https://github.com/hortonworks/cloudbreak/commit/dab8b02a3385430b471c3cfe92b54fdbb1e395c4", "message": "CB-9901 Update load balancer when instances change\n\nAdds new logic to AwsDownscaleService and AwsUpscaleService. The new logic will\nupdate the load balancer's routing rules to either remove any instances that\nare being deleted from the instance groups the load balancer routes traffic to,\nor add any new instances in those groups to the load balancer's targets.\n\nTested with unit tests, and by terminating the Knox gateway node and initating\na repair to verify the load balancer was correctly updated.", "committedDate": "2020-12-04T16:50:24Z", "type": "forcePushed"}, {"oid": "8c99d89ca3675142f6fee7e43de040a4c5dcb833", "url": "https://github.com/hortonworks/cloudbreak/commit/8c99d89ca3675142f6fee7e43de040a4c5dcb833", "message": "CB-9901 Update load balancer when instances change\n\nAdds new logic to AwsDownscaleService and AwsUpscaleService. The new logic will\nupdate the load balancer's routing rules to either remove any instances that\nare being deleted from the instance groups the load balancer routes traffic to,\nor add any new instances in those groups to the load balancer's targets.\n\nTested with unit tests, and by terminating the Knox gateway node and initating\na repair to verify the load balancer was correctly updated.", "committedDate": "2020-12-07T21:13:08Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc4MTYzMw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9569#discussion_r538781633", "bodyText": "suggestion: It looks like the String region value here is already present in the AuthenticatedContext ac parameter through String regionName = ac.getCloudContext().getLocation().getRegion().value(); can you get by with just the ac parameter being passed?\nI think something similar is going on with the Set<Group>> portToGroupMapping and AwsLoadBalancerScheme type parameters - they're both available in the loadBalancer object in the upscale() method.\nI think that would make the method signature cleaner:\ncfStackUtil.addLoadBalancerTargets(ac, loadBalancer, instances);\nAnd I think that reflects the \"purpose\" of each argument:\n\nac and region are really just here so we can construct clients to integrate with AWS, combine them into 1 to make the signature smaller.\nThe load balancer we're adding targets to is loadBalancer.\nThe new targets are held in `instances.\n\nI think in an ideal world the AuthenticatedContext would be provided via DI or some other means since it looks like it's being passed around a lot but actually used in very few places. \ud83e\udd37", "author": "brycederriso", "createdAt": "2020-12-08T20:25:24Z", "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/CloudFormationStackUtil.java", "diffHunk": "@@ -156,20 +169,96 @@ public DescribeInstancesRequest createDescribeInstancesRequest(Collection<String\n     }\n \n     public LoadBalancer getLoadBalancerByLogicalId(AuthenticatedContext ac, String logicalId, String region) {\n-        String cFStackName = getCfStackName(ac);\n-        AmazonCloudFormationRetryClient amazonCfClient =\n-            awsClient.createCloudFormationRetryClient(new AwsCredentialView(ac.getCloudCredential()), region);\n         AmazonElasticLoadBalancingClient amazonElbClient =\n             awsClient.createElasticLoadBalancingClient(new AwsCredentialView(ac.getCloudCredential()), region);\n \n-        DescribeStackResourceResult stackResourceResult = amazonCfClient.describeStackResource(new DescribeStackResourceRequest()\n-            .withStackName(cFStackName)\n-            .withLogicalResourceId(logicalId));\n-        String loadBalancerArn = stackResourceResult.getStackResourceDetail().getPhysicalResourceId();\n+        String loadBalancerArn = getResourceArnByLogicalId(ac, logicalId, region);\n \n         DescribeLoadBalancersResult loadBalancersResult = amazonElbClient.describeLoadBalancers(new DescribeLoadBalancersRequest()\n             .withLoadBalancerArns(Collections.singletonList(loadBalancerArn)));\n \n         return loadBalancersResult.getLoadBalancers().get(0);\n     }\n+\n+    public void addLoadBalancerTargets(AuthenticatedContext ac, String region, Map<Integer, Set<Group>> portToGroupMapping,", "originalCommit": "8c99d89ca3675142f6fee7e43de040a4c5dcb833", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQxNDA0NA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9569#discussion_r539414044", "bodyText": "You make well-thought out, compelling arguments. I've updated everything as you suggested.", "author": "hreeve-cloudera", "createdAt": "2020-12-09T15:41:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc4MTYzMw=="}], "type": "inlineReview", "revised_code": {"commit": "cef969833677452c9b10dfab55531f63da4daeda", "chunk": "diff --git a/cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/CloudFormationStackUtil.java b/cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/CloudFormationStackUtil.java\nindex 7d3caac29c..290acbecd7 100644\n--- a/cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/CloudFormationStackUtil.java\n+++ b/cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/CloudFormationStackUtil.java\n\n@@ -168,7 +168,8 @@ public class CloudFormationStackUtil {\n         return new DescribeInstancesRequest().withInstanceIds(instanceIds);\n     }\n \n-    public LoadBalancer getLoadBalancerByLogicalId(AuthenticatedContext ac, String logicalId, String region) {\n+    public LoadBalancer getLoadBalancerByLogicalId(AuthenticatedContext ac, String logicalId) {\n+        String region = ac.getCloudContext().getLocation().getRegion().value();\n         AmazonElasticLoadBalancingClient amazonElbClient =\n             awsClient.createElasticLoadBalancingClient(new AwsCredentialView(ac.getCloudCredential()), region);\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc4NDU4OA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9569#discussion_r538784588", "bodyText": "question: It looks like we're subtracting currentInstanceIds from this set of newInstanceIds, is that true? If so, are these actually instanceIdsFromNewTargetGroups?\nIt's a bit confusing to me to call them new, then remove the ones that aren't actually new.", "author": "brycederriso", "createdAt": "2020-12-08T20:30:26Z", "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/CloudFormationStackUtil.java", "diffHunk": "@@ -156,20 +169,96 @@ public DescribeInstancesRequest createDescribeInstancesRequest(Collection<String\n     }\n \n     public LoadBalancer getLoadBalancerByLogicalId(AuthenticatedContext ac, String logicalId, String region) {\n-        String cFStackName = getCfStackName(ac);\n-        AmazonCloudFormationRetryClient amazonCfClient =\n-            awsClient.createCloudFormationRetryClient(new AwsCredentialView(ac.getCloudCredential()), region);\n         AmazonElasticLoadBalancingClient amazonElbClient =\n             awsClient.createElasticLoadBalancingClient(new AwsCredentialView(ac.getCloudCredential()), region);\n \n-        DescribeStackResourceResult stackResourceResult = amazonCfClient.describeStackResource(new DescribeStackResourceRequest()\n-            .withStackName(cFStackName)\n-            .withLogicalResourceId(logicalId));\n-        String loadBalancerArn = stackResourceResult.getStackResourceDetail().getPhysicalResourceId();\n+        String loadBalancerArn = getResourceArnByLogicalId(ac, logicalId, region);\n \n         DescribeLoadBalancersResult loadBalancersResult = amazonElbClient.describeLoadBalancers(new DescribeLoadBalancersRequest()\n             .withLoadBalancerArns(Collections.singletonList(loadBalancerArn)));\n \n         return loadBalancersResult.getLoadBalancers().get(0);\n     }\n+\n+    public void addLoadBalancerTargets(AuthenticatedContext ac, String region, Map<Integer, Set<Group>> portToGroupMapping,\n+            AwsLoadBalancerScheme type, List<CloudResource> resourcesToAdd) {\n+        AmazonElasticLoadBalancingClient amazonElbClient =\n+            awsClient.createElasticLoadBalancingClient(new AwsCredentialView(ac.getCloudCredential()), region);\n+\n+        for (Map.Entry<Integer, Set<Group>> entry : portToGroupMapping.entrySet()) {\n+            // Get a list of the new instances in the target groups\n+            Set<String> newInstanceIds = getInstanceIdsForGroups(resourcesToAdd, entry.getValue());", "originalCommit": "8c99d89ca3675142f6fee7e43de040a4c5dcb833", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQxNDcxMQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9569#discussion_r539414711", "bodyText": "I've changed the names to alreadyRegisteredInstanceIds and updatedInstanceIds, respectively.", "author": "hreeve-cloudera", "createdAt": "2020-12-09T15:42:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc4NDU4OA=="}], "type": "inlineReview", "revised_code": {"commit": "cef969833677452c9b10dfab55531f63da4daeda", "chunk": "diff --git a/cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/CloudFormationStackUtil.java b/cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/CloudFormationStackUtil.java\nindex 7d3caac29c..290acbecd7 100644\n--- a/cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/CloudFormationStackUtil.java\n+++ b/cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/CloudFormationStackUtil.java\n\n@@ -168,7 +168,8 @@ public class CloudFormationStackUtil {\n         return new DescribeInstancesRequest().withInstanceIds(instanceIds);\n     }\n \n-    public LoadBalancer getLoadBalancerByLogicalId(AuthenticatedContext ac, String logicalId, String region) {\n+    public LoadBalancer getLoadBalancerByLogicalId(AuthenticatedContext ac, String logicalId) {\n+        String region = ac.getCloudContext().getLocation().getRegion().value();\n         AmazonElasticLoadBalancingClient amazonElbClient =\n             awsClient.createElasticLoadBalancingClient(new AwsCredentialView(ac.getCloudCredential()), region);\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc4NzE3Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9569#discussion_r538787177", "bodyText": "suggestion: Consider:\nnewInstanceIds.removeAll(currentInstanceIds);\nThis would be mutating the collection (boo) but keeps type-safety and I think is easier to read (yay).", "author": "brycederriso", "createdAt": "2020-12-08T20:34:57Z", "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/CloudFormationStackUtil.java", "diffHunk": "@@ -156,20 +169,96 @@ public DescribeInstancesRequest createDescribeInstancesRequest(Collection<String\n     }\n \n     public LoadBalancer getLoadBalancerByLogicalId(AuthenticatedContext ac, String logicalId, String region) {\n-        String cFStackName = getCfStackName(ac);\n-        AmazonCloudFormationRetryClient amazonCfClient =\n-            awsClient.createCloudFormationRetryClient(new AwsCredentialView(ac.getCloudCredential()), region);\n         AmazonElasticLoadBalancingClient amazonElbClient =\n             awsClient.createElasticLoadBalancingClient(new AwsCredentialView(ac.getCloudCredential()), region);\n \n-        DescribeStackResourceResult stackResourceResult = amazonCfClient.describeStackResource(new DescribeStackResourceRequest()\n-            .withStackName(cFStackName)\n-            .withLogicalResourceId(logicalId));\n-        String loadBalancerArn = stackResourceResult.getStackResourceDetail().getPhysicalResourceId();\n+        String loadBalancerArn = getResourceArnByLogicalId(ac, logicalId, region);\n \n         DescribeLoadBalancersResult loadBalancersResult = amazonElbClient.describeLoadBalancers(new DescribeLoadBalancersRequest()\n             .withLoadBalancerArns(Collections.singletonList(loadBalancerArn)));\n \n         return loadBalancersResult.getLoadBalancers().get(0);\n     }\n+\n+    public void addLoadBalancerTargets(AuthenticatedContext ac, String region, Map<Integer, Set<Group>> portToGroupMapping,\n+            AwsLoadBalancerScheme type, List<CloudResource> resourcesToAdd) {\n+        AmazonElasticLoadBalancingClient amazonElbClient =\n+            awsClient.createElasticLoadBalancingClient(new AwsCredentialView(ac.getCloudCredential()), region);\n+\n+        for (Map.Entry<Integer, Set<Group>> entry : portToGroupMapping.entrySet()) {\n+            // Get a list of the new instances in the target groups\n+            Set<String> newInstanceIds = getInstanceIdsForGroups(resourcesToAdd, entry.getValue());\n+\n+            // Find target group ARN\n+            String targetGroupArn = getResourceArnByLogicalId(ac, AwsTargetGroup.getTargetGroupName(entry.getKey(), type), region);\n+\n+            // Use ARN to fetch a list of current targets\n+            DescribeTargetHealthResult targetHealthResult = amazonElbClient.describeTargetHealth(new DescribeTargetHealthRequest()\n+                .withTargetGroupArn(targetGroupArn));\n+            List<TargetDescription> targetDescriptions = targetHealthResult.getTargetHealthDescriptions().stream()\n+                .map(TargetHealthDescription::getTarget)\n+                .collect(Collectors.toList());\n+            Set<String> currentInstanceIds = targetDescriptions.stream()\n+                .map(TargetDescription::getId)\n+                .collect(Collectors.toSet());\n+\n+            // Get any instances that need to be added to the target group\n+            Collection<String> instancesToAdd = CollectionUtils.subtract(newInstanceIds, currentInstanceIds);", "originalCommit": "8c99d89ca3675142f6fee7e43de040a4c5dcb833", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "cef969833677452c9b10dfab55531f63da4daeda", "chunk": "diff --git a/cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/CloudFormationStackUtil.java b/cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/CloudFormationStackUtil.java\nindex 7d3caac29c..290acbecd7 100644\n--- a/cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/CloudFormationStackUtil.java\n+++ b/cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/CloudFormationStackUtil.java\n\n@@ -168,7 +168,8 @@ public class CloudFormationStackUtil {\n         return new DescribeInstancesRequest().withInstanceIds(instanceIds);\n     }\n \n-    public LoadBalancer getLoadBalancerByLogicalId(AuthenticatedContext ac, String logicalId, String region) {\n+    public LoadBalancer getLoadBalancerByLogicalId(AuthenticatedContext ac, String logicalId) {\n+        String region = ac.getCloudContext().getLocation().getRegion().value();\n         AmazonElasticLoadBalancingClient amazonElbClient =\n             awsClient.createElasticLoadBalancingClient(new AwsCredentialView(ac.getCloudCredential()), region);\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc4Nzc0MQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9569#discussion_r538787741", "bodyText": "suggestion: Comments about method signature from above apply here too I think.", "author": "brycederriso", "createdAt": "2020-12-08T20:36:04Z", "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/CloudFormationStackUtil.java", "diffHunk": "@@ -156,20 +169,96 @@ public DescribeInstancesRequest createDescribeInstancesRequest(Collection<String\n     }\n \n     public LoadBalancer getLoadBalancerByLogicalId(AuthenticatedContext ac, String logicalId, String region) {\n-        String cFStackName = getCfStackName(ac);\n-        AmazonCloudFormationRetryClient amazonCfClient =\n-            awsClient.createCloudFormationRetryClient(new AwsCredentialView(ac.getCloudCredential()), region);\n         AmazonElasticLoadBalancingClient amazonElbClient =\n             awsClient.createElasticLoadBalancingClient(new AwsCredentialView(ac.getCloudCredential()), region);\n \n-        DescribeStackResourceResult stackResourceResult = amazonCfClient.describeStackResource(new DescribeStackResourceRequest()\n-            .withStackName(cFStackName)\n-            .withLogicalResourceId(logicalId));\n-        String loadBalancerArn = stackResourceResult.getStackResourceDetail().getPhysicalResourceId();\n+        String loadBalancerArn = getResourceArnByLogicalId(ac, logicalId, region);\n \n         DescribeLoadBalancersResult loadBalancersResult = amazonElbClient.describeLoadBalancers(new DescribeLoadBalancersRequest()\n             .withLoadBalancerArns(Collections.singletonList(loadBalancerArn)));\n \n         return loadBalancersResult.getLoadBalancers().get(0);\n     }\n+\n+    public void addLoadBalancerTargets(AuthenticatedContext ac, String region, Map<Integer, Set<Group>> portToGroupMapping,\n+            AwsLoadBalancerScheme type, List<CloudResource> resourcesToAdd) {\n+        AmazonElasticLoadBalancingClient amazonElbClient =\n+            awsClient.createElasticLoadBalancingClient(new AwsCredentialView(ac.getCloudCredential()), region);\n+\n+        for (Map.Entry<Integer, Set<Group>> entry : portToGroupMapping.entrySet()) {\n+            // Get a list of the new instances in the target groups\n+            Set<String> newInstanceIds = getInstanceIdsForGroups(resourcesToAdd, entry.getValue());\n+\n+            // Find target group ARN\n+            String targetGroupArn = getResourceArnByLogicalId(ac, AwsTargetGroup.getTargetGroupName(entry.getKey(), type), region);\n+\n+            // Use ARN to fetch a list of current targets\n+            DescribeTargetHealthResult targetHealthResult = amazonElbClient.describeTargetHealth(new DescribeTargetHealthRequest()\n+                .withTargetGroupArn(targetGroupArn));\n+            List<TargetDescription> targetDescriptions = targetHealthResult.getTargetHealthDescriptions().stream()\n+                .map(TargetHealthDescription::getTarget)\n+                .collect(Collectors.toList());\n+            Set<String> currentInstanceIds = targetDescriptions.stream()\n+                .map(TargetDescription::getId)\n+                .collect(Collectors.toSet());\n+\n+            // Get any instances that need to be added to the target group\n+            Collection<String> instancesToAdd = CollectionUtils.subtract(newInstanceIds, currentInstanceIds);\n+\n+            // Register any new instances\n+            if (!instancesToAdd.isEmpty()) {\n+                List<TargetDescription> targetsToAdd = instancesToAdd.stream()\n+                    .map(instanceId -> new TargetDescription().withId(instanceId))\n+                    .collect(Collectors.toList());\n+                RegisterTargetsResult registerTargetsResult = amazonElbClient.registerTargets(new RegisterTargetsRequest()\n+                    .withTargetGroupArn(targetGroupArn)\n+                    .withTargets(targetsToAdd));\n+            }\n+        }\n+    }\n+\n+    public void removeLoadBalancerTargets(AuthenticatedContext ac, String region, Map<Integer, Set<Group>> portToGroupMapping,", "originalCommit": "8c99d89ca3675142f6fee7e43de040a4c5dcb833", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "cef969833677452c9b10dfab55531f63da4daeda", "chunk": "diff --git a/cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/CloudFormationStackUtil.java b/cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/CloudFormationStackUtil.java\nindex 7d3caac29c..290acbecd7 100644\n--- a/cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/CloudFormationStackUtil.java\n+++ b/cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/CloudFormationStackUtil.java\n\n@@ -168,7 +168,8 @@ public class CloudFormationStackUtil {\n         return new DescribeInstancesRequest().withInstanceIds(instanceIds);\n     }\n \n-    public LoadBalancer getLoadBalancerByLogicalId(AuthenticatedContext ac, String logicalId, String region) {\n+    public LoadBalancer getLoadBalancerByLogicalId(AuthenticatedContext ac, String logicalId) {\n+        String region = ac.getCloudContext().getLocation().getRegion().value();\n         AmazonElasticLoadBalancingClient amazonElbClient =\n             awsClient.createElasticLoadBalancingClient(new AwsCredentialView(ac.getCloudCredential()), region);\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc4ODEzNg==", "url": "https://github.com/hortonworks/cloudbreak/pull/9569#discussion_r538788136", "bodyText": "praise: Thank you for comments!", "author": "brycederriso", "createdAt": "2020-12-08T20:36:48Z", "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/CloudFormationStackUtil.java", "diffHunk": "@@ -156,20 +169,96 @@ public DescribeInstancesRequest createDescribeInstancesRequest(Collection<String\n     }\n \n     public LoadBalancer getLoadBalancerByLogicalId(AuthenticatedContext ac, String logicalId, String region) {\n-        String cFStackName = getCfStackName(ac);\n-        AmazonCloudFormationRetryClient amazonCfClient =\n-            awsClient.createCloudFormationRetryClient(new AwsCredentialView(ac.getCloudCredential()), region);\n         AmazonElasticLoadBalancingClient amazonElbClient =\n             awsClient.createElasticLoadBalancingClient(new AwsCredentialView(ac.getCloudCredential()), region);\n \n-        DescribeStackResourceResult stackResourceResult = amazonCfClient.describeStackResource(new DescribeStackResourceRequest()\n-            .withStackName(cFStackName)\n-            .withLogicalResourceId(logicalId));\n-        String loadBalancerArn = stackResourceResult.getStackResourceDetail().getPhysicalResourceId();\n+        String loadBalancerArn = getResourceArnByLogicalId(ac, logicalId, region);\n \n         DescribeLoadBalancersResult loadBalancersResult = amazonElbClient.describeLoadBalancers(new DescribeLoadBalancersRequest()\n             .withLoadBalancerArns(Collections.singletonList(loadBalancerArn)));\n \n         return loadBalancersResult.getLoadBalancers().get(0);\n     }\n+\n+    public void addLoadBalancerTargets(AuthenticatedContext ac, String region, Map<Integer, Set<Group>> portToGroupMapping,\n+            AwsLoadBalancerScheme type, List<CloudResource> resourcesToAdd) {\n+        AmazonElasticLoadBalancingClient amazonElbClient =\n+            awsClient.createElasticLoadBalancingClient(new AwsCredentialView(ac.getCloudCredential()), region);\n+\n+        for (Map.Entry<Integer, Set<Group>> entry : portToGroupMapping.entrySet()) {\n+            // Get a list of the new instances in the target groups\n+            Set<String> newInstanceIds = getInstanceIdsForGroups(resourcesToAdd, entry.getValue());\n+\n+            // Find target group ARN\n+            String targetGroupArn = getResourceArnByLogicalId(ac, AwsTargetGroup.getTargetGroupName(entry.getKey(), type), region);\n+\n+            // Use ARN to fetch a list of current targets\n+            DescribeTargetHealthResult targetHealthResult = amazonElbClient.describeTargetHealth(new DescribeTargetHealthRequest()\n+                .withTargetGroupArn(targetGroupArn));\n+            List<TargetDescription> targetDescriptions = targetHealthResult.getTargetHealthDescriptions().stream()\n+                .map(TargetHealthDescription::getTarget)\n+                .collect(Collectors.toList());\n+            Set<String> currentInstanceIds = targetDescriptions.stream()\n+                .map(TargetDescription::getId)\n+                .collect(Collectors.toSet());\n+\n+            // Get any instances that need to be added to the target group\n+            Collection<String> instancesToAdd = CollectionUtils.subtract(newInstanceIds, currentInstanceIds);\n+\n+            // Register any new instances\n+            if (!instancesToAdd.isEmpty()) {\n+                List<TargetDescription> targetsToAdd = instancesToAdd.stream()\n+                    .map(instanceId -> new TargetDescription().withId(instanceId))\n+                    .collect(Collectors.toList());\n+                RegisterTargetsResult registerTargetsResult = amazonElbClient.registerTargets(new RegisterTargetsRequest()\n+                    .withTargetGroupArn(targetGroupArn)\n+                    .withTargets(targetsToAdd));\n+            }\n+        }\n+    }\n+\n+    public void removeLoadBalancerTargets(AuthenticatedContext ac, String region, Map<Integer, Set<Group>> portToGroupMapping,\n+            AwsLoadBalancerScheme type, List<CloudResource> resourcesToRemove) {\n+        AmazonElasticLoadBalancingClient amazonElbClient =\n+            awsClient.createElasticLoadBalancingClient(new AwsCredentialView(ac.getCloudCredential()), region);\n+\n+        for (Map.Entry<Integer, Set<Group>> entry : portToGroupMapping.entrySet()) {\n+            // Get a list of the instance ids to remove\n+            Set<String> instancesToRemove = getInstanceIdsForGroups(resourcesToRemove, entry.getValue());\n+\n+            // Find target group ARN\n+            String targetGroupArn = getResourceArnByLogicalId(ac, AwsTargetGroup.getTargetGroupName(entry.getKey(), type), region);\n+\n+            // Deregister any instances that no longer exist\n+            if (!instancesToRemove.isEmpty()) {\n+                try {\n+                    List<TargetDescription> targetsToRemove = instancesToRemove.stream()\n+                        .map(instanceId -> new TargetDescription().withId(instanceId))\n+                        .collect(Collectors.toList());\n+                    DeregisterTargetsResult deregisterTargetsResult = amazonElbClient.deregisterTargets(new DeregisterTargetsRequest()\n+                        .withTargetGroupArn(targetGroupArn)\n+                        .withTargets(targetsToRemove));\n+                } catch (InvalidTargetException ignored) {\n+                    // no-op - we tried to remove a target that wasn't in the target group, which is fine", "originalCommit": "8c99d89ca3675142f6fee7e43de040a4c5dcb833", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "cef969833677452c9b10dfab55531f63da4daeda", "chunk": "diff --git a/cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/CloudFormationStackUtil.java b/cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/CloudFormationStackUtil.java\nindex 7d3caac29c..290acbecd7 100644\n--- a/cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/CloudFormationStackUtil.java\n+++ b/cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/CloudFormationStackUtil.java\n\n@@ -168,7 +168,8 @@ public class CloudFormationStackUtil {\n         return new DescribeInstancesRequest().withInstanceIds(instanceIds);\n     }\n \n-    public LoadBalancer getLoadBalancerByLogicalId(AuthenticatedContext ac, String logicalId, String region) {\n+    public LoadBalancer getLoadBalancerByLogicalId(AuthenticatedContext ac, String logicalId) {\n+        String region = ac.getCloudContext().getLocation().getRegion().value();\n         AmazonElasticLoadBalancingClient amazonElbClient =\n             awsClient.createElasticLoadBalancingClient(new AwsCredentialView(ac.getCloudCredential()), region);\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc5NjU4OQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9569#discussion_r538796589", "bodyText": "question: No longer using this Object resourcesToRemove is very suspicious to me, though I understand if it's necessary to keep the Interface contract intact.\nIs that the case?", "author": "brycederriso", "createdAt": "2020-12-08T20:51:15Z", "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/connector/resource/AwsResourceConnector.java", "diffHunk": "@@ -162,7 +162,7 @@ public Object collectResourcesToRemove(AuthenticatedContext authenticatedContext\n     @Override\n     public List<CloudResourceStatus> downscale(AuthenticatedContext auth, CloudStack stack, List<CloudResource> resources, List<CloudInstance> vms,\n             Object resourcesToRemove) {\n-        return awsDownscaleService.downscale(auth, stack, resources, vms, resourcesToRemove);", "originalCommit": "8c99d89ca3675142f6fee7e43de040a4c5dcb833", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQxNzM0Mw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9569#discussion_r539417343", "bodyText": "The resourcesToRemove parameter comes from the interface, and does seem to be used by by other cloud providers, just not AWS. However, I found it very confusing when I was working on this to see that awsDownscaleService.downscale had a parameter called resourcesToRemove, but if you look at the actual code those aren't the resources being removed because that object isn't used at all. So this technically doesn't have anything to do with my change, but I thought it cleaned up the code and made it less confusing.", "author": "hreeve-cloudera", "createdAt": "2020-12-09T15:45:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc5NjU4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDIzNzIzNg==", "url": "https://github.com/hortonworks/cloudbreak/pull/9569#discussion_r540237236", "bodyText": "Ah, ok. You're right, this is better I think.\nThe real issue is with the interface, but I'm not familiar enough with it to suggest a refactoring that would work.\nThanks!", "author": "brycederriso", "createdAt": "2020-12-10T14:59:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc5NjU4OQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg3MzkzNQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9569#discussion_r538873935", "bodyText": "Can this be package-private?", "author": "kmanamcheri", "createdAt": "2020-12-08T23:02:28Z", "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/loadbalancer/AwsTargetGroup.java", "diffHunk": "@@ -49,7 +49,7 @@ public int getOrder() {\n         return instanceIds;\n     }\n \n-    private static String getTargetGroupName(int port, AwsLoadBalancerScheme scheme) {\n+    public static String getTargetGroupName(int port, AwsLoadBalancerScheme scheme) {", "originalCommit": "8c99d89ca3675142f6fee7e43de040a4c5dcb833", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQxMzI1MA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9569#discussion_r539413250", "bodyText": "No, it's referenced outside the package.", "author": "hreeve-cloudera", "createdAt": "2020-12-09T15:40:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg3MzkzNQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "cef969833677452c9b10dfab55531f63da4daeda", "url": "https://github.com/hortonworks/cloudbreak/commit/cef969833677452c9b10dfab55531f63da4daeda", "message": "CB-9901 Update load balancer when instances change\n\nAdds new logic to AwsDownscaleService and AwsUpscaleService. The new logic will\nupdate the load balancer's routing rules to either remove any instances that\nare being deleted from the instance groups the load balancer routes traffic to,\nor add any new instances in those groups to the load balancer's targets.\n\nTested with unit tests, and by terminating the Knox gateway node and initating\na repair to verify the load balancer was correctly updated.", "committedDate": "2020-12-09T15:47:23Z", "type": "forcePushed"}, {"oid": "54763d1159c55348c8ff4a68ece5d69126d150de", "url": "https://github.com/hortonworks/cloudbreak/commit/54763d1159c55348c8ff4a68ece5d69126d150de", "message": "CB-9901 Update load balancer when instances change\n\nAdds new logic to AwsDownscaleService and AwsUpscaleService. The new logic will\nupdate the load balancer's routing rules to either remove any instances that\nare being deleted from the instance groups the load balancer routes traffic to,\nor add any new instances in those groups to the load balancer's targets.\n\nTested with unit tests, and by terminating the Knox gateway node and initating\na repair to verify the load balancer was correctly updated.", "committedDate": "2020-12-14T17:55:06Z", "type": "commit"}, {"oid": "54763d1159c55348c8ff4a68ece5d69126d150de", "url": "https://github.com/hortonworks/cloudbreak/commit/54763d1159c55348c8ff4a68ece5d69126d150de", "message": "CB-9901 Update load balancer when instances change\n\nAdds new logic to AwsDownscaleService and AwsUpscaleService. The new logic will\nupdate the load balancer's routing rules to either remove any instances that\nare being deleted from the instance groups the load balancer routes traffic to,\nor add any new instances in those groups to the load balancer's targets.\n\nTested with unit tests, and by terminating the Knox gateway node and initating\na repair to verify the load balancer was correctly updated.", "committedDate": "2020-12-14T17:55:06Z", "type": "forcePushed"}]}