{"pr_number": 8555, "pr_title": "CDPCP-1941. Only trigger user sync role refresh when needed", "pr_createdAt": "2020-07-15T08:28:29Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/8555", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDg4NDc0NQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8555#discussion_r454884745", "bodyText": "setAzureCloudIdentityMapping is already a big method, could you refactor this part into a separate one, like refreshRoleIfStale", "author": "lacikaaa", "createdAt": "2020-07-15T08:33:59Z", "path": "datalake/src/main/java/com/sequenceiq/datalake/cm/ClouderaManagerRangerUtil.java", "diffHunk": "@@ -117,7 +124,12 @@ public void setAzureCloudIdentityMapping(String stackCrn, Map<String, String> az\n             rolesResourceApi.updateRoleConfig(clusterName, rangerUserSyncRoleName, RANGER_SERVICE_NAME,\n                     \"Updating Azure Cloud Identity Mapping through Cloudbreak\",\n                     configList);\n-            triggerRoleRefresh(client, clusterName, RANGER_SERVICE_NAME, rangerUserSyncRoleName);\n+            if (isRoleRefreshNeeded(rolesResourceApi, clusterName, rangerUserSyncRoleName)) {\n+                LOGGER.info(\"Role refresh required, trigerring role refresh\");\n+                triggerRoleRefresh(client, clusterName, RANGER_SERVICE_NAME, rangerUserSyncRoleName);\n+            } else {\n+                LOGGER.info(\"No role refresh required\");\n+            }", "originalCommit": "f1dd1b47c9c45a5be8a594a34856123535dca09f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8650aec6965b3a02794b3db5c1cfd90b50de83b7", "chunk": "diff --git a/datalake/src/main/java/com/sequenceiq/datalake/cm/ClouderaManagerRangerUtil.java b/datalake/src/main/java/com/sequenceiq/datalake/cm/ClouderaManagerRangerUtil.java\nindex 2abbd39966..6fd24e9ca0 100644\n--- a/datalake/src/main/java/com/sequenceiq/datalake/cm/ClouderaManagerRangerUtil.java\n+++ b/datalake/src/main/java/com/sequenceiq/datalake/cm/ClouderaManagerRangerUtil.java\n\n@@ -124,12 +134,7 @@ public class ClouderaManagerRangerUtil {\n             rolesResourceApi.updateRoleConfig(clusterName, rangerUserSyncRoleName, RANGER_SERVICE_NAME,\n                     \"Updating Azure Cloud Identity Mapping through Cloudbreak\",\n                     configList);\n-            if (isRoleRefreshNeeded(rolesResourceApi, clusterName, rangerUserSyncRoleName)) {\n-                LOGGER.info(\"Role refresh required, trigerring role refresh\");\n-                triggerRoleRefresh(client, clusterName, RANGER_SERVICE_NAME, rangerUserSyncRoleName);\n-            } else {\n-                LOGGER.info(\"No role refresh required\");\n-            }\n+            refreshRoleIfStale(client, rolesResourceApi, clusterName, rangerUserSyncRoleName);\n         }\n     }\n \n"}}, {"oid": "8650aec6965b3a02794b3db5c1cfd90b50de83b7", "url": "https://github.com/hortonworks/cloudbreak/commit/8650aec6965b3a02794b3db5c1cfd90b50de83b7", "message": "CDPCP-1941. Only trigger user sync role refresh when needed\n\nAfter setting role configs related to identity mapping, we no\nlonger trigger refresh when the values haven't changed (by\nchecking whether CM reports whether a refresh is required).", "committedDate": "2020-07-15T18:47:44Z", "type": "commit"}, {"oid": "8650aec6965b3a02794b3db5c1cfd90b50de83b7", "url": "https://github.com/hortonworks/cloudbreak/commit/8650aec6965b3a02794b3db5c1cfd90b50de83b7", "message": "CDPCP-1941. Only trigger user sync role refresh when needed\n\nAfter setting role configs related to identity mapping, we no\nlonger trigger refresh when the values haven't changed (by\nchecking whether CM reports whether a refresh is required).", "committedDate": "2020-07-15T18:47:44Z", "type": "forcePushed"}]}