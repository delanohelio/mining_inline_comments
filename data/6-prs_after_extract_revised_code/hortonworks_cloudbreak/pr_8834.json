{"pr_number": 8834, "pr_title": "CB-8480 internal calls broke tags and audit", "pr_createdAt": "2020-08-18T14:28:43Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/8834", "timeline": [{"oid": "7183bd5bbcd5f027c29de4f3ab4c4ba0b984e336", "url": "https://github.com/hortonworks/cloudbreak/commit/7183bd5bbcd5f027c29de4f3ab4c4ba0b984e336", "message": "CB-8480 internal calls broke tags and audit", "committedDate": "2020-08-18T14:45:43Z", "type": "forcePushed"}, {"oid": "cda185e574a20ed47fbcff77eea1609d1366d833", "url": "https://github.com/hortonworks/cloudbreak/commit/cda185e574a20ed47fbcff77eea1609d1366d833", "message": "CB-8480 internal calls broke tags and audit", "committedDate": "2020-08-18T16:49:10Z", "type": "forcePushed"}, {"oid": "62dbc85e4b7cc0861c5dd6c85665a91b70a9451c", "url": "https://github.com/hortonworks/cloudbreak/commit/62dbc85e4b7cc0861c5dd6c85665a91b70a9451c", "message": "CB-8480 internal calls broke tags and audit", "committedDate": "2020-08-19T05:18:43Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjg4NDQwNw==", "url": "https://github.com/hortonworks/cloudbreak/pull/8834#discussion_r472884407", "bodyText": "Can't we skip the whole workspace ID from these new API's?", "author": "lnardai", "createdAt": "2020-08-19T09:15:34Z", "path": "core-api/src/main/java/com/sequenceiq/cloudbreak/api/endpoint/v4/stacks/StackV4Endpoint.java", "diffHunk": "@@ -285,6 +351,13 @@ UpgradeV4Response checkForClusterUpgradeByName(@PathParam(\"workspaceId\") Long wo\n     FlowIdentifier upgradeClusterByName(@PathParam(\"workspaceId\") Long workspaceId, @PathParam(\"name\") String name, String imageId,\n             @AccountId @QueryParam(\"accountId\") String accountId);\n \n+    @POST\n+    @Path(\"internal/{name}/cluster_upgrade\")\n+    @Produces(MediaType.APPLICATION_JSON)\n+    @ApiOperation(value = STACK_UPGRADE_INTERNAL, nickname = \"upgradeClusterByNameInternal\")\n+    FlowIdentifier upgradeClusterByNameInternal(@PathParam(\"workspaceId\") Long workspaceId, @PathParam(\"name\") String name, String imageId,", "originalCommit": "62dbc85e4b7cc0861c5dd6c85665a91b70a9451c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjg4NTcwMw==", "url": "https://github.com/hortonworks/cloudbreak/pull/8834#discussion_r472885703", "bodyText": "Or use accountId instead?", "author": "lnardai", "createdAt": "2020-08-19T09:17:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjg4NDQwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjg5MDkxOA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8834#discussion_r472890918", "bodyText": "I'd like to, but we have some precheck code for this and fails if there is no workspaceId. We can create a followup task for this but I didn't want to deal with this in this PR.", "author": "sodre90", "createdAt": "2020-08-19T09:25:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjg4NDQwNw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjg4NjQxOQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8834#discussion_r472886419", "bodyText": "Can we check if the endpoint has the @InternalOnly annotation?", "author": "lnardai", "createdAt": "2020-08-19T09:18:40Z", "path": "authorization-common/src/main/java/com/sequenceiq/authorization/service/PermissionCheckService.java", "diffHunk": "@@ -54,6 +68,12 @@ public Object hasPermission(ProceedingJoinPoint proceedingJoinPoint) {\n         MethodSignature methodSignature = (MethodSignature) proceedingJoinPoint.getSignature();\n         LOGGER.debug(\"Permission check started at {} (method: {})\", startTime,\n                 methodSignature.getMethod().getDeclaringClass().getSimpleName() + \"#\" + methodSignature.getMethod().getName());\n+        Optional<Object> initiatorUserCrn = reflectionUtil.getParameter(proceedingJoinPoint, methodSignature, InitiatorUserCrn.class);", "originalCommit": "62dbc85e4b7cc0861c5dd6c85665a91b70a9451c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "31bcd253d192521c5bba97364857a801497ae19c", "chunk": "diff --git a/authorization-common/src/main/java/com/sequenceiq/authorization/service/PermissionCheckService.java b/authorization-common/src/main/java/com/sequenceiq/authorization/service/PermissionCheckService.java\nindex 4bd84643a6..dcb9ffdf6d 100644\n--- a/authorization-common/src/main/java/com/sequenceiq/authorization/service/PermissionCheckService.java\n+++ b/authorization-common/src/main/java/com/sequenceiq/authorization/service/PermissionCheckService.java\n\n@@ -69,7 +69,9 @@ public class PermissionCheckService {\n         LOGGER.debug(\"Permission check started at {} (method: {})\", startTime,\n                 methodSignature.getMethod().getDeclaringClass().getSimpleName() + \"#\" + methodSignature.getMethod().getName());\n         Optional<Object> initiatorUserCrn = reflectionUtil.getParameter(proceedingJoinPoint, methodSignature, InitiatorUserCrn.class);\n-        if (initiatorUserCrn.isPresent() && initiatorUserCrn.get() instanceof String && Crn.isCrn((String) initiatorUserCrn.get())) {\n+        if (InternalCrnBuilder.isInternalCrn(ThreadBasedUserCrnProvider.getUserCrn())\n+                && initiatorUserCrn.isPresent()\n+                && initiatorUserCrn.get() instanceof String && Crn.isCrn((String) initiatorUserCrn.get())) {\n             String newUserCrn = (String) initiatorUserCrn.get();\n             internalUserModifier.persistModifiedInternalUser(crnUserDetailsService.loadUserByUsername(newUserCrn));\n             return ThreadBasedUserCrnProvider.doAs(newUserCrn, () -> commonPermissionCheckingUtils.proceed(proceedingJoinPoint, methodSignature, startTime));\n"}}, {"oid": "31bcd253d192521c5bba97364857a801497ae19c", "url": "https://github.com/hortonworks/cloudbreak/commit/31bcd253d192521c5bba97364857a801497ae19c", "message": "CB-8480 internal calls broke tags and audit", "committedDate": "2020-08-19T09:26:51Z", "type": "forcePushed"}, {"oid": "7e0bb1afe2b46bf2154f22c51cc4dd74ad4214dc", "url": "https://github.com/hortonworks/cloudbreak/commit/7e0bb1afe2b46bf2154f22c51cc4dd74ad4214dc", "message": "CB-8480 internal calls broke tags and audit", "committedDate": "2020-08-19T09:42:04Z", "type": "commit"}, {"oid": "7e0bb1afe2b46bf2154f22c51cc4dd74ad4214dc", "url": "https://github.com/hortonworks/cloudbreak/commit/7e0bb1afe2b46bf2154f22c51cc4dd74ad4214dc", "message": "CB-8480 internal calls broke tags and audit", "committedDate": "2020-08-19T09:42:04Z", "type": "forcePushed"}]}