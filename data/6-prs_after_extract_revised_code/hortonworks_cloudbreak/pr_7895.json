{"pr_number": 7895, "pr_title": "CDPCP-1561. Allow internal actor to call user sync endpoint", "pr_createdAt": "2020-04-24T21:06:42Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/7895", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDg3NzcyNA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7895#discussion_r414877724", "bodyText": "you should also allow setting the account id to your own account", "author": "handavid", "createdAt": "2020-04-24T21:37:18Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/controller/UserV1Controller.java", "diffHunk": "@@ -107,6 +109,16 @@ public SyncOperationStatus getSyncOperationStatus(@NotNull String operationId) {\n                 operationService.getOperationForAccountIdAndOperationId(accountId, operationId));\n     }\n \n+    private String determineAccountId(String callingActor, String requestedAccountId) {\n+        if (requestedAccountId == null) {\n+            return ThreadBasedUserCrnProvider.getAccountId();\n+        }\n+        if (!InternalCrnBuilder.isInternalCrn(callingActor)) {", "originalCommit": "407e1094f8a84f499a3849c34ee8f48fd1d2bfff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTU2MTI3NA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7895#discussion_r415561274", "bodyText": "Fixed.", "author": "aarman-cloudera", "createdAt": "2020-04-27T07:03:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDg3NzcyNA=="}], "type": "inlineReview", "revised_code": {"commit": "18458c58ca756886234e29dcee497c257752a9b7", "chunk": "diff --git a/freeipa/src/main/java/com/sequenceiq/freeipa/controller/UserV1Controller.java b/freeipa/src/main/java/com/sequenceiq/freeipa/controller/UserV1Controller.java\nindex d547342694..babf5dc9c7 100644\n--- a/freeipa/src/main/java/com/sequenceiq/freeipa/controller/UserV1Controller.java\n+++ b/freeipa/src/main/java/com/sequenceiq/freeipa/controller/UserV1Controller.java\n\n@@ -113,8 +113,9 @@ public class UserV1Controller implements UserV1Endpoint {\n         if (requestedAccountId == null) {\n             return ThreadBasedUserCrnProvider.getAccountId();\n         }\n-        if (!InternalCrnBuilder.isInternalCrn(callingActor)) {\n-            throw new BadRequestException(\"Only the internal actor can set the accountId\");\n+        String callingActorAccountId = Crn.safeFromString(callingActor).getAccountId();\n+        if (!callingActorAccountId.equals(requestedAccountId) && !InternalCrnBuilder.isInternalCrn(callingActor)) {\n+            throw new BadRequestException(\"Only the internal actor can set a different accountId\");\n         }\n         return requestedAccountId;\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDg3OTEzMg==", "url": "https://github.com/hortonworks/cloudbreak/pull/7895#discussion_r414879132", "bodyText": "actor crn not needed here", "author": "handavid", "createdAt": "2020-04-24T21:40:37Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/UserSyncService.java", "diffHunk": "@@ -402,6 +402,16 @@ void validateParameters(String accountId, String actorCrn, Set<String> environme\n         validateCrnFilter(environmentCrnFilter, Crn.ResourceType.ENVIRONMENT);\n         validateCrnFilter(userCrnFilter, Crn.ResourceType.USER);\n         validateCrnFilter(machineUserCrnFilter, Crn.ResourceType.MACHINE_USER);\n+        validateSameAccount(actorCrn, accountId, Iterables.concat(environmentCrnFilter, userCrnFilter, machineUserCrnFilter));\n+    }\n+\n+    private void validateSameAccount(String actorCrn, String accountId, Iterable<String> crns) {", "originalCommit": "407e1094f8a84f499a3849c34ee8f48fd1d2bfff", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "18458c58ca756886234e29dcee497c257752a9b7", "chunk": "diff --git a/freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/UserSyncService.java b/freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/UserSyncService.java\nindex 051f817366..54b14b349d 100644\n--- a/freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/UserSyncService.java\n+++ b/freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/UserSyncService.java\n\n@@ -402,10 +402,10 @@ public class UserSyncService {\n         validateCrnFilter(environmentCrnFilter, Crn.ResourceType.ENVIRONMENT);\n         validateCrnFilter(userCrnFilter, Crn.ResourceType.USER);\n         validateCrnFilter(machineUserCrnFilter, Crn.ResourceType.MACHINE_USER);\n-        validateSameAccount(actorCrn, accountId, Iterables.concat(environmentCrnFilter, userCrnFilter, machineUserCrnFilter));\n+        validateSameAccount(accountId, Iterables.concat(environmentCrnFilter, userCrnFilter, machineUserCrnFilter));\n     }\n \n-    private void validateSameAccount(String actorCrn, String accountId, Iterable<String> crns) {\n+    private void validateSameAccount(String accountId, Iterable<String> crns) {\n         crns.forEach(crnString -> {\n             Crn crn = Crn.safeFromString(crnString);\n             if (!accountId.equals(crn.getAccountId())) {\n"}}, {"oid": "18458c58ca756886234e29dcee497c257752a9b7", "url": "https://github.com/hortonworks/cloudbreak/commit/18458c58ca756886234e29dcee497c257752a9b7", "message": "CDPCP-1561. Allow internal actor to call user sync endpoint\n\nPreviously the accountId to sync was inferred from the calling\nuser, which doesn't work when the calling user is the internal\nactor. This is fixed by including accountId as an optional\nparameter to the user sync request.", "committedDate": "2020-04-27T07:00:35Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTczNTkxNw==", "url": "https://github.com/hortonworks/cloudbreak/pull/7895#discussion_r415735917", "bodyText": "do we really want to propagate that information to customers if somehow they can invoke it with different accountid?", "author": "lacikaaa", "createdAt": "2020-04-27T11:34:12Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/controller/UserV1Controller.java", "diffHunk": "@@ -107,6 +109,17 @@ public SyncOperationStatus getSyncOperationStatus(@NotNull String operationId) {\n                 operationService.getOperationForAccountIdAndOperationId(accountId, operationId));\n     }\n \n+    private String determineAccountId(String callingActor, String requestedAccountId) {\n+        if (requestedAccountId == null) {\n+            return ThreadBasedUserCrnProvider.getAccountId();\n+        }\n+        String callingActorAccountId = Crn.safeFromString(callingActor).getAccountId();\n+        if (!callingActorAccountId.equals(requestedAccountId) && !InternalCrnBuilder.isInternalCrn(callingActor)) {\n+            throw new BadRequestException(\"Only the internal actor can set a different accountId\");", "originalCommit": "18458c58ca756886234e29dcee497c257752a9b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTk3ODQyNA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7895#discussion_r415978424", "bodyText": "I think that permission denied be more appropriate than bad request then.\nThe message should just say that the user isn't allowed to make this call. I agree that we don't want to reveal that internal actors exist.", "author": "handavid", "createdAt": "2020-04-27T16:48:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTczNTkxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjA1NjE5NQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/7895#discussion_r416056195", "bodyText": "We're not exposing this to customers (they won't have an option to set an accountId through public api). They might somehow figure out how to call this endpoint without going through the public api but we don't need to give friendly message in this case. The message as it is right now is more useful to internal developers.", "author": "aarman-cloudera", "createdAt": "2020-04-27T18:37:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTczNTkxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjA4NTI3MA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7895#discussion_r416085270", "bodyText": "I agree that it should be Permission Denied.  I would prefer to have the same exception message as thrown by the Scrutinizer (see validateActorCrnInAccountOrInternal). You can put any other information you think is useful in a log message.", "author": "giladwolff", "createdAt": "2020-04-27T19:22:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTczNTkxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjM2NTgwMw==", "url": "https://github.com/hortonworks/cloudbreak/pull/7895#discussion_r416365803", "bodyText": "Thanks, I've made the changes.", "author": "aarman-cloudera", "createdAt": "2020-04-28T06:40:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTczNTkxNw=="}], "type": "inlineReview", "revised_code": {"commit": "6514f6fc345a2d2ac1362d6d526589832497e633", "chunk": "diff --git a/freeipa/src/main/java/com/sequenceiq/freeipa/controller/UserV1Controller.java b/freeipa/src/main/java/com/sequenceiq/freeipa/controller/UserV1Controller.java\nindex babf5dc9c7..065e5e2d3e 100644\n--- a/freeipa/src/main/java/com/sequenceiq/freeipa/controller/UserV1Controller.java\n+++ b/freeipa/src/main/java/com/sequenceiq/freeipa/controller/UserV1Controller.java\n\n@@ -115,7 +116,7 @@ public class UserV1Controller implements UserV1Endpoint {\n         }\n         String callingActorAccountId = Crn.safeFromString(callingActor).getAccountId();\n         if (!callingActorAccountId.equals(requestedAccountId) && !InternalCrnBuilder.isInternalCrn(callingActor)) {\n-            throw new BadRequestException(\"Only the internal actor can set a different accountId\");\n+            throw new AccessDeniedException(String.format(\"Actor %s does not belong to the request account %s\", callingActor, requestedAccountId));\n         }\n         return requestedAccountId;\n     }\n"}}, {"oid": "6514f6fc345a2d2ac1362d6d526589832497e633", "url": "https://github.com/hortonworks/cloudbreak/commit/6514f6fc345a2d2ac1362d6d526589832497e633", "message": "CDPCP-1561. Allow internal actor to call user sync endpoint\n\nPreviously the accountId to sync was inferred from the calling\nuser, which doesn't work when the calling user is the internal\nactor. This is fixed by including accountId as an optional\nparameter to the user sync request.", "committedDate": "2020-04-28T06:38:13Z", "type": "commit"}, {"oid": "6514f6fc345a2d2ac1362d6d526589832497e633", "url": "https://github.com/hortonworks/cloudbreak/commit/6514f6fc345a2d2ac1362d6d526589832497e633", "message": "CDPCP-1561. Allow internal actor to call user sync endpoint\n\nPreviously the accountId to sync was inferred from the calling\nuser, which doesn't work when the calling user is the internal\nactor. This is fixed by including accountId as an optional\nparameter to the user sync request.", "committedDate": "2020-04-28T06:38:13Z", "type": "forcePushed"}]}