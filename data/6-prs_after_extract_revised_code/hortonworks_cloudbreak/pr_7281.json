{"pr_number": 7281, "pr_title": "CB-4502 Consolidate DistroX/SDX/FreeIPA/RDS tagging", "pr_createdAt": "2020-02-13T13:53:20Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/7281", "timeline": [{"oid": "3ae7bede954bc94a50c6dfbdb180f493e574534c", "url": "https://github.com/hortonworks/cloudbreak/commit/3ae7bede954bc94a50c6dfbdb180f493e574534c", "message": "CB-4502 Consolidate DistroX/SDX/FreeIPA/RDS tagging", "committedDate": "2020-02-13T13:54:25Z", "type": "forcePushed"}, {"oid": "0e99f5f3de06f51c7f1a71a9fa4091660f848304", "url": "https://github.com/hortonworks/cloudbreak/commit/0e99f5f3de06f51c7f1a71a9fa4091660f848304", "message": "CB-4502 Consolidate DistroX/SDX/FreeIPA/RDS tagging", "committedDate": "2020-02-13T13:55:59Z", "type": "forcePushed"}, {"oid": "751901f99ea6e091133dbdffea952b65189c9974", "url": "https://github.com/hortonworks/cloudbreak/commit/751901f99ea6e091133dbdffea952b65189c9974", "message": "CB-4502 Consolidate DistroX/SDX/FreeIPA/RDS tagging", "committedDate": "2020-02-14T09:07:01Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTQwMDAxNQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/7281#discussion_r379400015", "bodyText": "Is it only used in case of Azure?", "author": "biharitomi", "createdAt": "2020-02-14T12:14:00Z", "path": "environment/src/main/java/com/sequenceiq/environment/environment/dto/EnvironmentDtoConverter.java", "diffHunk": "@@ -99,11 +121,39 @@ public LocationDto environmentToLocationDto(Environment environment) {\n                 .build();\n     }\n \n+    private String getUserFromCrn(String crn) {\n+        return Optional.ofNullable(Crn.fromString(crn)).map(Crn::getUserId).orElse(null);\n+    }\n+\n     private SecurityAccessDto environmentToSecurityAccessDto(Environment environment) {\n         return SecurityAccessDto.builder()\n                 .withCidr(environment.getCidr())\n                 .withSecurityGroupIdForKnox(environment.getSecurityGroupIdForKnox())\n                 .withDefaultSecurityGroupId(environment.getDefaultSecurityGroupId())\n                 .build();\n     }\n+\n+    private Json getTags(EnvironmentCreationDto creationDto) {\n+        boolean internalTenant = entitlementService.internalTenant(creationDto.getCreator(), creationDto.getAccountId());\n+        CDPTagGenerationRequest request = CDPTagGenerationRequest.Builder.builder()\n+                .withCreatorCrn(creationDto.getCreator())\n+                .withEnvironmentCrn(creationDto.getCrn())\n+                .withAccountId(creationDto.getAccountId())\n+                .withPlatform(CloudConstants.AZURE)", "originalCommit": "751901f99ea6e091133dbdffea952b65189c9974", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "abd61da2297c58bfdb4cad459245759310dc17ba", "chunk": "diff --git a/environment/src/main/java/com/sequenceiq/environment/environment/dto/EnvironmentDtoConverter.java b/environment/src/main/java/com/sequenceiq/environment/environment/dto/EnvironmentDtoConverter.java\nindex db9a061542..e89a977088 100644\n--- a/environment/src/main/java/com/sequenceiq/environment/environment/dto/EnvironmentDtoConverter.java\n+++ b/environment/src/main/java/com/sequenceiq/environment/environment/dto/EnvironmentDtoConverter.java\n\n@@ -139,7 +138,7 @@ public class EnvironmentDtoConverter {\n                 .withCreatorCrn(creationDto.getCreator())\n                 .withEnvironmentCrn(creationDto.getCrn())\n                 .withAccountId(creationDto.getAccountId())\n-                .withPlatform(CloudConstants.AZURE)\n+                .withPlatform(creationDto.getCloudPlatform())\n                 .withResourceCrn(creationDto.getCrn())\n                 .withIsInternalTenant(internalTenant)\n                 .withUserName(getUserFromCrn(creationDto.getCreator()))\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTQwMDQ1Ng==", "url": "https://github.com/hortonworks/cloudbreak/pull/7281#discussion_r379400456", "bodyText": "The getUserCrn method should be used here for getting user's crn.", "author": "biharitomi", "createdAt": "2020-02-14T12:15:09Z", "path": "environment/src/main/java/com/sequenceiq/environment/environment/v1/EnvironmentApiConverter.java", "diffHunk": "@@ -112,6 +117,8 @@ public EnvironmentCreationDto initCreationDto(EnvironmentRequest request) {\n                 .withRegions(request.getRegions())\n                 .withAuthentication(authenticationRequestToDto(request.getAuthentication()))\n                 .withAdminGroupName(request.getAdminGroupName())\n+                .withTags(request.getTags())\n+                .withCrn(createCrn(ThreadBasedUserCrnProvider.getAccountId()))", "originalCommit": "751901f99ea6e091133dbdffea952b65189c9974", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTQwMTc5Mg==", "url": "https://github.com/hortonworks/cloudbreak/pull/7281#discussion_r379401792", "bodyText": "I sow a similar method, maybe we should create a dedicated factory or constructor for creating this object from EnvironmentDto.", "author": "biharitomi", "createdAt": "2020-02-14T12:18:55Z", "path": "environment/src/main/java/com/sequenceiq/environment/network/service/NetworkCreationRequestFactory.java", "diffHunk": "@@ -70,4 +77,13 @@ private boolean getPrivateSubnetEnabled(EnvironmentDto environmentDto) {\n     private String getUserFromCrn(String crn) {\n         return Optional.ofNullable(Crn.fromString(crn)).map(Crn::getUserId).orElse(null);\n     }\n+\n+    private CDPTagMergeRequest cdpTagMergeRequest(EnvironmentDto environmentDto) {", "originalCommit": "751901f99ea6e091133dbdffea952b65189c9974", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "abd61da2297c58bfdb4cad459245759310dc17ba", "chunk": "diff --git a/environment/src/main/java/com/sequenceiq/environment/network/service/NetworkCreationRequestFactory.java b/environment/src/main/java/com/sequenceiq/environment/network/service/NetworkCreationRequestFactory.java\nindex 3565049138..882304263b 100644\n--- a/environment/src/main/java/com/sequenceiq/environment/network/service/NetworkCreationRequestFactory.java\n+++ b/environment/src/main/java/com/sequenceiq/environment/network/service/NetworkCreationRequestFactory.java\n\n@@ -77,13 +85,4 @@ public class NetworkCreationRequestFactory {\n     private String getUserFromCrn(String crn) {\n         return Optional.ofNullable(Crn.fromString(crn)).map(Crn::getUserId).orElse(null);\n     }\n-\n-    private CDPTagMergeRequest cdpTagMergeRequest(EnvironmentDto environmentDto) {\n-        return CDPTagMergeRequest.Builder\n-                .builder()\n-                .withEnvironmentTags(environmentDto.getTags().getUserDefinedTags())\n-                .withPlatform(environmentDto.getCloudPlatform())\n-                .withRequestTags(environmentDto.getTags().getDefaultTags())\n-                .build();\n-    }\n }\n"}}, {"oid": "abd61da2297c58bfdb4cad459245759310dc17ba", "url": "https://github.com/hortonworks/cloudbreak/commit/abd61da2297c58bfdb4cad459245759310dc17ba", "message": "CB-4502 Consolidate DistroX/SDX/FreeIPA/RDS tagging", "committedDate": "2020-02-14T13:06:22Z", "type": "forcePushed"}, {"oid": "d32bb1058a8ad97def19b318c679d1925e4351d6", "url": "https://github.com/hortonworks/cloudbreak/commit/d32bb1058a8ad97def19b318c679d1925e4351d6", "message": "CB-4502 Consolidate DistroX/SDX/FreeIPA/RDS tagging", "committedDate": "2020-02-17T08:06:54Z", "type": "commit"}, {"oid": "d32bb1058a8ad97def19b318c679d1925e4351d6", "url": "https://github.com/hortonworks/cloudbreak/commit/d32bb1058a8ad97def19b318c679d1925e4351d6", "message": "CB-4502 Consolidate DistroX/SDX/FreeIPA/RDS tagging", "committedDate": "2020-02-17T08:06:54Z", "type": "forcePushed"}]}