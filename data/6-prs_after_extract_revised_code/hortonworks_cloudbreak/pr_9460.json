{"pr_number": 9460, "pr_title": "CB-9849 GCP : For FreeIPA use the GCP shared project id to query the \u2026", "pr_createdAt": "2020-11-17T22:56:11Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/9460", "timeline": [{"oid": "e0b5375bff63b8081fc3c223efbc17d6c9058bd5", "url": "https://github.com/hortonworks/cloudbreak/commit/e0b5375bff63b8081fc3c223efbc17d6c9058bd5", "message": "CB-9849 GCP : For FreeIPA use the GCP shared project id to query the networks", "committedDate": "2020-11-18T11:43:30Z", "type": "forcePushed"}, {"oid": "74791e4d75ceafec88b71936302b5ff0a6f8be4a", "url": "https://github.com/hortonworks/cloudbreak/commit/74791e4d75ceafec88b71936302b5ff0a6f8be4a", "message": "CB-9849 GCP : For FreeIPA use the GCP shared project id to query the networks", "committedDate": "2020-11-18T12:27:43Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjAzNTE0MQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9460#discussion_r526035141", "bodyText": "null collection is not ideal, please init an empty one", "author": "lacikaaa", "createdAt": "2020-11-18T12:04:48Z", "path": "cloud-gcp/src/main/java/com/sequenceiq/cloudbreak/cloud/gcp/GcpPlatformResources.java", "diffHunk": "@@ -129,18 +129,26 @@ public CloudNetworks networks(CloudCredential cloudCredential, Region region, Ma\n         Map<String, Set<CloudNetwork>> result = new HashMap<>();\n \n         String networkId = null;\n-        String subnetId = null;\n+        List<String> subnetIds = null;", "originalCommit": "e0b5375bff63b8081fc3c223efbc17d6c9058bd5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c64cefe0ec1a5907940a343221ab5502bde4e61b", "chunk": "diff --git a/cloud-gcp/src/main/java/com/sequenceiq/cloudbreak/cloud/gcp/GcpPlatformResources.java b/cloud-gcp/src/main/java/com/sequenceiq/cloudbreak/cloud/gcp/GcpPlatformResources.java\nindex e60fdcda5e..b75396d107 100644\n--- a/cloud-gcp/src/main/java/com/sequenceiq/cloudbreak/cloud/gcp/GcpPlatformResources.java\n+++ b/cloud-gcp/src/main/java/com/sequenceiq/cloudbreak/cloud/gcp/GcpPlatformResources.java\n\n@@ -129,19 +129,11 @@ public class GcpPlatformResources implements PlatformResources {\n         Map<String, Set<CloudNetwork>> result = new HashMap<>();\n \n         String networkId = null;\n-        List<String> subnetIds = null;\n+        List<String> subnetIds = new ArrayList<>();\n         String sharedProjectId = null;\n         if (filters != null) {\n             networkId = filters.getOrDefault(\"networkId\", null);\n-            String subnetId = filters.getOrDefault(\"subnetId\", null);\n-            if (!Strings.isNullOrEmpty(subnetId)) {\n-                subnetIds = List.of(subnetId);\n-            } else {\n-                String subnetIdsString = filters.getOrDefault(\"subnetIds\", null);\n-                if (!Strings.isNullOrEmpty(subnetIdsString)) {\n-                    subnetIds = List.of(subnetIdsString.split(\",\"));\n-                }\n-            }\n+            subnetIds = getSubnetIds(filters);\n             sharedProjectId = filters.getOrDefault(\"sharedProjectId\", null);\n         }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjAzNTQ2OA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9460#discussion_r526035468", "bodyText": "this should be moved to a separate method", "author": "lacikaaa", "createdAt": "2020-11-18T12:05:19Z", "path": "cloud-gcp/src/main/java/com/sequenceiq/cloudbreak/cloud/gcp/GcpPlatformResources.java", "diffHunk": "@@ -129,18 +129,26 @@ public CloudNetworks networks(CloudCredential cloudCredential, Region region, Ma\n         Map<String, Set<CloudNetwork>> result = new HashMap<>();\n \n         String networkId = null;\n-        String subnetId = null;\n+        List<String> subnetIds = null;\n         String sharedProjectId = null;\n         if (filters != null) {\n             networkId = filters.getOrDefault(\"networkId\", null);\n-            subnetId = filters.getOrDefault(\"subnetId\", null);\n+            String subnetId = filters.getOrDefault(\"subnetId\", null);\n+            if (!Strings.isNullOrEmpty(subnetId)) {\n+                subnetIds = List.of(subnetId);\n+            } else {\n+                String subnetIdsString = filters.getOrDefault(\"subnetIds\", null);\n+                if (!Strings.isNullOrEmpty(subnetIdsString)) {\n+                    subnetIds = List.of(subnetIdsString.split(\",\"));\n+                }\n+            }", "originalCommit": "e0b5375bff63b8081fc3c223efbc17d6c9058bd5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c64cefe0ec1a5907940a343221ab5502bde4e61b", "chunk": "diff --git a/cloud-gcp/src/main/java/com/sequenceiq/cloudbreak/cloud/gcp/GcpPlatformResources.java b/cloud-gcp/src/main/java/com/sequenceiq/cloudbreak/cloud/gcp/GcpPlatformResources.java\nindex e60fdcda5e..b75396d107 100644\n--- a/cloud-gcp/src/main/java/com/sequenceiq/cloudbreak/cloud/gcp/GcpPlatformResources.java\n+++ b/cloud-gcp/src/main/java/com/sequenceiq/cloudbreak/cloud/gcp/GcpPlatformResources.java\n\n@@ -129,19 +129,11 @@ public class GcpPlatformResources implements PlatformResources {\n         Map<String, Set<CloudNetwork>> result = new HashMap<>();\n \n         String networkId = null;\n-        List<String> subnetIds = null;\n+        List<String> subnetIds = new ArrayList<>();\n         String sharedProjectId = null;\n         if (filters != null) {\n             networkId = filters.getOrDefault(\"networkId\", null);\n-            String subnetId = filters.getOrDefault(\"subnetId\", null);\n-            if (!Strings.isNullOrEmpty(subnetId)) {\n-                subnetIds = List.of(subnetId);\n-            } else {\n-                String subnetIdsString = filters.getOrDefault(\"subnetIds\", null);\n-                if (!Strings.isNullOrEmpty(subnetIdsString)) {\n-                    subnetIds = List.of(subnetIdsString.split(\",\"));\n-                }\n-            }\n+            subnetIds = getSubnetIds(filters);\n             sharedProjectId = filters.getOrDefault(\"sharedProjectId\", null);\n         }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjAzNjczMg==", "url": "https://github.com/hortonworks/cloudbreak/pull/9460#discussion_r526036732", "bodyText": "this could be a private method and we could skip null check on subnetIds if the my previous comment is addressed", "author": "lacikaaa", "createdAt": "2020-11-18T12:07:38Z", "path": "cloud-gcp/src/main/java/com/sequenceiq/cloudbreak/cloud/gcp/GcpPlatformResources.java", "diffHunk": "@@ -184,18 +192,25 @@ public CloudNetworks networks(CloudCredential cloudCredential, Region region, Ma\n         return new CloudNetworks(result);\n     }\n \n-    public SubnetworkList getSubnetworkList(Region region, Compute compute, String projectId, String subnetId, String sharedProjectId) throws IOException {\n+    public SubnetworkList getSubnetworkList(Region region, Compute compute, String projectId, List<String> subnetIds,", "originalCommit": "e0b5375bff63b8081fc3c223efbc17d6c9058bd5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c64cefe0ec1a5907940a343221ab5502bde4e61b", "chunk": "diff --git a/cloud-gcp/src/main/java/com/sequenceiq/cloudbreak/cloud/gcp/GcpPlatformResources.java b/cloud-gcp/src/main/java/com/sequenceiq/cloudbreak/cloud/gcp/GcpPlatformResources.java\nindex e60fdcda5e..b75396d107 100644\n--- a/cloud-gcp/src/main/java/com/sequenceiq/cloudbreak/cloud/gcp/GcpPlatformResources.java\n+++ b/cloud-gcp/src/main/java/com/sequenceiq/cloudbreak/cloud/gcp/GcpPlatformResources.java\n\n@@ -192,10 +184,24 @@ public class GcpPlatformResources implements PlatformResources {\n         return new CloudNetworks(result);\n     }\n \n-    public SubnetworkList getSubnetworkList(Region region, Compute compute, String projectId, List<String> subnetIds,\n+    public List<String> getSubnetIds(Map<String, String> filters) {\n+        List<String> subnetIds = new ArrayList<>();\n+        String subnetId = filters.getOrDefault(\"subnetId\", null);\n+        if (!Strings.isNullOrEmpty(subnetId)) {\n+            subnetIds.add(subnetId);\n+        } else {\n+            String subnetIdsString = filters.getOrDefault(\"subnetIds\", null);\n+            if (!Strings.isNullOrEmpty(subnetIdsString)) {\n+                subnetIds = List.of(subnetIdsString.split(\",\"));\n+            }\n+        }\n+        return subnetIds;\n+    }\n+\n+    private SubnetworkList getSubnetworkList(Region region, Compute compute, String projectId, List<String> subnetIds,\n         String sharedProjectId) throws IOException {\n         SubnetworkList subnetworkList;\n-        if (subnetIds != null && subnetIds.isEmpty()) {\n+        if (subnetIds.isEmpty()) {\n             subnetworkList = compute.subnetworks()\n                     .list(projectId, region.value()).execute();\n         } else {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjA0NTQ5OQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9460#discussion_r526045499", "bodyText": "this seems a bit complicated and could be simplified. Like instead of query every subnet one by one we could still use the list then filter the result.\n    private SubnetworkList getSubnetworkList(Region region, Compute compute, String projectId, List<String> subnetIds,\n        String sharedProjectId) throws IOException {\n        String projectIdToQuery = StringUtils.isNotBlank(sharedProjectId) ? sharedProjectId : projectId;\n        SubnetworkList subnetworkList = compute.subnetworks().list(projectIdToQuery, region.value()).execute();\n        if (subnetIds.isEmpty()) {\n            return subnetworkList;\n        } else {\n            List<Subnetwork> filteredSubnets = subnetworkList.getItems().stream()\n                    .filter(subnetwork -> subnetIds.contains(subnetwork.getName()))\n                    .collect(Collectors.toList());\n            return new SubnetworkList().setItems(filteredSubnets);\n        }\n    }", "author": "lacikaaa", "createdAt": "2020-11-18T12:23:26Z", "path": "cloud-gcp/src/main/java/com/sequenceiq/cloudbreak/cloud/gcp/GcpPlatformResources.java", "diffHunk": "@@ -184,18 +192,25 @@ public CloudNetworks networks(CloudCredential cloudCredential, Region region, Ma\n         return new CloudNetworks(result);\n     }\n \n-    public SubnetworkList getSubnetworkList(Region region, Compute compute, String projectId, String subnetId, String sharedProjectId) throws IOException {\n+    public SubnetworkList getSubnetworkList(Region region, Compute compute, String projectId, List<String> subnetIds,\n+        String sharedProjectId) throws IOException {\n         SubnetworkList subnetworkList;\n-        if (StringUtils.isEmpty(subnetId)) {\n+        if (subnetIds != null && subnetIds.isEmpty()) {\n             subnetworkList = compute.subnetworks()\n                     .list(projectId, region.value()).execute();\n         } else {\n             if (!Strings.isNullOrEmpty(sharedProjectId)) {\n-                subnetworkList = new SubnetworkList()\n-                        .setItems(Collections.singletonList(compute.subnetworks().get(sharedProjectId, region.value(), subnetId).execute()));\n+                subnetworkList = new SubnetworkList().setItems(new ArrayList<>());\n+                for (String subnetId : subnetIds) {\n+                    Subnetwork subnetwork = compute.subnetworks().get(sharedProjectId, region.value(), subnetId).execute();\n+                    subnetworkList.getItems().add(subnetwork);\n+                }\n             } else {\n-                subnetworkList = new SubnetworkList()\n-                        .setItems(Collections.singletonList(compute.subnetworks().get(projectId, region.value(), subnetId).execute()));\n+                subnetworkList = new SubnetworkList().setItems(new ArrayList<>());\n+                for (String subnetId : subnetIds) {\n+                    Subnetwork subnetwork = compute.subnetworks().get(projectId, region.value(), subnetId).execute();\n+                    subnetworkList.getItems().add(subnetwork);\n+                }\n             }\n         }\n         return subnetworkList;", "originalCommit": "e0b5375bff63b8081fc3c223efbc17d6c9058bd5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjA5NzY2MA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9460#discussion_r526097660", "bodyText": "unfortunately it is not the same here? They are using the same object but in case of list most of the field is null", "author": "doktoric", "createdAt": "2020-11-18T13:45:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjA0NTQ5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjEwNDAxNw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9460#discussion_r526104017", "bodyText": "yeah, right, instead of creating a new, the old one's items should be overridden, that should do the trick. but the old implementation did the same, creating a new SubnetworkList object and adding subnetoworks to it's items.", "author": "lacikaaa", "createdAt": "2020-11-18T13:54:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjA0NTQ5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjE2OTUyNg==", "url": "https://github.com/hortonworks/cloudbreak/pull/9460#discussion_r526169526", "bodyText": "We just discussed on zoom", "author": "doktoric", "createdAt": "2020-11-18T15:19:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjA0NTQ5OQ=="}], "type": "inlineReview", "revised_code": {"commit": "c64cefe0ec1a5907940a343221ab5502bde4e61b", "chunk": "diff --git a/cloud-gcp/src/main/java/com/sequenceiq/cloudbreak/cloud/gcp/GcpPlatformResources.java b/cloud-gcp/src/main/java/com/sequenceiq/cloudbreak/cloud/gcp/GcpPlatformResources.java\nindex e60fdcda5e..b75396d107 100644\n--- a/cloud-gcp/src/main/java/com/sequenceiq/cloudbreak/cloud/gcp/GcpPlatformResources.java\n+++ b/cloud-gcp/src/main/java/com/sequenceiq/cloudbreak/cloud/gcp/GcpPlatformResources.java\n\n@@ -192,10 +184,24 @@ public class GcpPlatformResources implements PlatformResources {\n         return new CloudNetworks(result);\n     }\n \n-    public SubnetworkList getSubnetworkList(Region region, Compute compute, String projectId, List<String> subnetIds,\n+    public List<String> getSubnetIds(Map<String, String> filters) {\n+        List<String> subnetIds = new ArrayList<>();\n+        String subnetId = filters.getOrDefault(\"subnetId\", null);\n+        if (!Strings.isNullOrEmpty(subnetId)) {\n+            subnetIds.add(subnetId);\n+        } else {\n+            String subnetIdsString = filters.getOrDefault(\"subnetIds\", null);\n+            if (!Strings.isNullOrEmpty(subnetIdsString)) {\n+                subnetIds = List.of(subnetIdsString.split(\",\"));\n+            }\n+        }\n+        return subnetIds;\n+    }\n+\n+    private SubnetworkList getSubnetworkList(Region region, Compute compute, String projectId, List<String> subnetIds,\n         String sharedProjectId) throws IOException {\n         SubnetworkList subnetworkList;\n-        if (subnetIds != null && subnetIds.isEmpty()) {\n+        if (subnetIds.isEmpty()) {\n             subnetworkList = compute.subnetworks()\n                     .list(projectId, region.value()).execute();\n         } else {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjA0NzAzMQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9460#discussion_r526047031", "bodyText": "this constant at least should be refactored into a field to avoid duplication here", "author": "lacikaaa", "createdAt": "2020-11-18T12:26:02Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/filter/GcpNetworkFilterProvider.java", "diffHunk": "@@ -0,0 +1,42 @@\n+package com.sequenceiq.freeipa.service.filter;\n+\n+import java.util.Collection;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import org.springframework.stereotype.Service;\n+\n+import com.sequenceiq.cloudbreak.common.mappable.CloudPlatform;\n+import com.sequenceiq.freeipa.entity.Network;\n+\n+@Service\n+public class GcpNetworkFilterProvider implements NetworkFilterProvider {\n+\n+    @Override\n+    public Map<String, String> provide(Network network, String networkId, Collection<String> subnetIds) {\n+        Map<String, String> filter = new HashMap<>();\n+        if (network.getAttributes() != null && network.getAttributes().getMap() != null) {\n+            Map<String, Object> attributes = network.getAttributes().getMap();\n+            String sharedProjectId = (String) attributes.get(\"sharedProjectId\");\n+            filter.put(\"sharedProjectId\", sharedProjectId);", "originalCommit": "e0b5375bff63b8081fc3c223efbc17d6c9058bd5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "74791e4d75ceafec88b71936302b5ff0a6f8be4a", "chunk": "diff --git a/freeipa/src/main/java/com/sequenceiq/freeipa/service/filter/GcpNetworkFilterProvider.java b/freeipa/src/main/java/com/sequenceiq/freeipa/service/filter/GcpNetworkFilterProvider.java\nindex 78c31b42cf..4f4899a2e5 100644\n--- a/freeipa/src/main/java/com/sequenceiq/freeipa/service/filter/GcpNetworkFilterProvider.java\n+++ b/freeipa/src/main/java/com/sequenceiq/freeipa/service/filter/GcpNetworkFilterProvider.java\n\n@@ -6,6 +6,7 @@ import java.util.Map;\n \n import org.springframework.stereotype.Service;\n \n+import com.google.common.base.Strings;\n import com.sequenceiq.cloudbreak.common.mappable.CloudPlatform;\n import com.sequenceiq.freeipa.entity.Network;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjA0NzM4NQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9460#discussion_r526047385", "bodyText": "I don't think we need this if, just use subnetIds", "author": "lacikaaa", "createdAt": "2020-11-18T12:26:37Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/filter/GcpNetworkFilterProvider.java", "diffHunk": "@@ -0,0 +1,42 @@\n+package com.sequenceiq.freeipa.service.filter;\n+\n+import java.util.Collection;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import org.springframework.stereotype.Service;\n+\n+import com.sequenceiq.cloudbreak.common.mappable.CloudPlatform;\n+import com.sequenceiq.freeipa.entity.Network;\n+\n+@Service\n+public class GcpNetworkFilterProvider implements NetworkFilterProvider {\n+\n+    @Override\n+    public Map<String, String> provide(Network network, String networkId, Collection<String> subnetIds) {\n+        Map<String, String> filter = new HashMap<>();\n+        if (network.getAttributes() != null && network.getAttributes().getMap() != null) {\n+            Map<String, Object> attributes = network.getAttributes().getMap();\n+            String sharedProjectId = (String) attributes.get(\"sharedProjectId\");\n+            filter.put(\"sharedProjectId\", sharedProjectId);\n+            filter.put(\"networkId\", networkId);\n+            buildSubnetIdFilter(subnetIds, filter);\n+        }\n+        return filter;\n+    }\n+\n+    @Override\n+    public CloudPlatform cloudPlatform() {\n+        return CloudPlatform.GCP;\n+    }\n+\n+    private void buildSubnetIdFilter(Collection<String> subnetIds, Map<String, String> filter) {\n+        if (subnetIds != null && !subnetIds.isEmpty()) {\n+            if (subnetIds.size() > 1) {\n+                filter.put(\"subnetIds\", String.join(\",\", subnetIds));\n+            } else {\n+                filter.put(\"subnetId\", subnetIds.stream().findFirst().get());\n+            }", "originalCommit": "e0b5375bff63b8081fc3c223efbc17d6c9058bd5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "74791e4d75ceafec88b71936302b5ff0a6f8be4a", "chunk": "diff --git a/freeipa/src/main/java/com/sequenceiq/freeipa/service/filter/GcpNetworkFilterProvider.java b/freeipa/src/main/java/com/sequenceiq/freeipa/service/filter/GcpNetworkFilterProvider.java\nindex 78c31b42cf..4f4899a2e5 100644\n--- a/freeipa/src/main/java/com/sequenceiq/freeipa/service/filter/GcpNetworkFilterProvider.java\n+++ b/freeipa/src/main/java/com/sequenceiq/freeipa/service/filter/GcpNetworkFilterProvider.java\n\n@@ -6,6 +6,7 @@ import java.util.Map;\n \n import org.springframework.stereotype.Service;\n \n+import com.google.common.base.Strings;\n import com.sequenceiq.cloudbreak.common.mappable.CloudPlatform;\n import com.sequenceiq.freeipa.entity.Network;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjA0OTQzNA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9460#discussion_r526049434", "bodyText": "it would be much nicer if it would return with like a map and we could use filter.putAll where it is called instead of modifying the map passed via a parameter. It could return with empty map if not applicable", "author": "lacikaaa", "createdAt": "2020-11-18T12:30:07Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/filter/GcpNetworkFilterProvider.java", "diffHunk": "@@ -0,0 +1,45 @@\n+package com.sequenceiq.freeipa.service.filter;\n+\n+import java.util.Collection;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import org.springframework.stereotype.Service;\n+\n+import com.google.common.base.Strings;\n+import com.sequenceiq.cloudbreak.common.mappable.CloudPlatform;\n+import com.sequenceiq.freeipa.entity.Network;\n+\n+@Service\n+public class GcpNetworkFilterProvider implements NetworkFilterProvider {\n+\n+    @Override\n+    public Map<String, String> provide(Network network, String networkId, Collection<String> subnetIds) {\n+        Map<String, String> filter = new HashMap<>();\n+        if (network.getAttributes() != null && network.getAttributes().getMap() != null) {\n+            Map<String, Object> attributes = network.getAttributes().getMap();\n+            String sharedProjectId = (String) attributes.get(\"sharedProjectId\");\n+            if (!Strings.isNullOrEmpty(sharedProjectId)) {\n+                filter.put(\"sharedProjectId\", sharedProjectId);\n+            }\n+        }\n+        filter.put(\"networkId\", networkId);\n+        buildSubnetIdFilter(subnetIds, filter);\n+        return filter;\n+    }\n+\n+    @Override\n+    public CloudPlatform cloudPlatform() {\n+        return CloudPlatform.GCP;\n+    }\n+\n+    private void buildSubnetIdFilter(Collection<String> subnetIds, Map<String, String> filter) {", "originalCommit": "74791e4d75ceafec88b71936302b5ff0a6f8be4a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c64cefe0ec1a5907940a343221ab5502bde4e61b", "chunk": "diff --git a/freeipa/src/main/java/com/sequenceiq/freeipa/service/filter/GcpNetworkFilterProvider.java b/freeipa/src/main/java/com/sequenceiq/freeipa/service/filter/GcpNetworkFilterProvider.java\nindex 4f4899a2e5..72466c28aa 100644\n--- a/freeipa/src/main/java/com/sequenceiq/freeipa/service/filter/GcpNetworkFilterProvider.java\n+++ b/freeipa/src/main/java/com/sequenceiq/freeipa/service/filter/GcpNetworkFilterProvider.java\n\n@@ -13,18 +13,20 @@ import com.sequenceiq.freeipa.entity.Network;\n @Service\n public class GcpNetworkFilterProvider implements NetworkFilterProvider {\n \n+    private static final String SHARED_PROJECT_ID = \"sharedProjectId\";\n+\n     @Override\n     public Map<String, String> provide(Network network, String networkId, Collection<String> subnetIds) {\n         Map<String, String> filter = new HashMap<>();\n         if (network.getAttributes() != null && network.getAttributes().getMap() != null) {\n             Map<String, Object> attributes = network.getAttributes().getMap();\n-            String sharedProjectId = (String) attributes.get(\"sharedProjectId\");\n+            String sharedProjectId = (String) attributes.get(SHARED_PROJECT_ID);\n             if (!Strings.isNullOrEmpty(sharedProjectId)) {\n-                filter.put(\"sharedProjectId\", sharedProjectId);\n+                filter.put(SHARED_PROJECT_ID, sharedProjectId);\n             }\n         }\n         filter.put(\"networkId\", networkId);\n-        buildSubnetIdFilter(subnetIds, filter);\n+        filter.putAll(buildSubnetIdFilter(subnetIds));\n         return filter;\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjA1MDY4NA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9460#discussion_r526050684", "bodyText": "could be moved to a separate method, like createFilter", "author": "lacikaaa", "createdAt": "2020-11-18T12:32:17Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/stack/NetworkService.java", "diffHunk": "@@ -49,8 +55,13 @@\n     public Map<String, String> getFilteredSubnetWithCidr(String environmentCrn, Stack stack, String networkId, Collection<String> subnetIds) {\n         Credential credential = credentialService.getCredentialByEnvCrn(environmentCrn);\n         ExtendedCloudCredential cloudCredential = extendedCloudCredentialConverter.convert(credential);\n+        Map<String, String> filter = new HashMap<>();\n+        NetworkFilterProvider networkFilterProvider = networkFilterProviderMap.get(CloudPlatform.valueOf(stack.getCloudPlatform()));\n+        if (networkFilterProvider != null) {\n+            filter = networkFilterProvider.provide(stack.getNetwork(), networkId, subnetIds);\n+        }", "originalCommit": "74791e4d75ceafec88b71936302b5ff0a6f8be4a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c64cefe0ec1a5907940a343221ab5502bde4e61b", "chunk": "diff --git a/freeipa/src/main/java/com/sequenceiq/freeipa/service/stack/NetworkService.java b/freeipa/src/main/java/com/sequenceiq/freeipa/service/stack/NetworkService.java\nindex 89af53b463..004278c860 100644\n--- a/freeipa/src/main/java/com/sequenceiq/freeipa/service/stack/NetworkService.java\n+++ b/freeipa/src/main/java/com/sequenceiq/freeipa/service/stack/NetworkService.java\n\n@@ -55,11 +55,7 @@ public class NetworkService {\n     public Map<String, String> getFilteredSubnetWithCidr(String environmentCrn, Stack stack, String networkId, Collection<String> subnetIds) {\n         Credential credential = credentialService.getCredentialByEnvCrn(environmentCrn);\n         ExtendedCloudCredential cloudCredential = extendedCloudCredentialConverter.convert(credential);\n-        Map<String, String> filter = new HashMap<>();\n-        NetworkFilterProvider networkFilterProvider = networkFilterProviderMap.get(CloudPlatform.valueOf(stack.getCloudPlatform()));\n-        if (networkFilterProvider != null) {\n-            filter = networkFilterProvider.provide(stack.getNetwork(), networkId, subnetIds);\n-        }\n+        Map<String, String> filter = getFilter(stack, networkId, subnetIds);\n         CloudNetworks cloudNetworks =\n                 cloudParameterService.getCloudNetworks(cloudCredential, stack.getRegion(), stack.getPlatformvariant(), filter);\n         LOGGER.debug(\"Received Cloud networks for region [{}]: {}\", stack.getRegion(), cloudNetworks.getCloudNetworkResponses().get(stack.getRegion()));\n"}}, {"oid": "fc60b11cbdc463d5792ceced438dcfa23c2c991e", "url": "https://github.com/hortonworks/cloudbreak/commit/fc60b11cbdc463d5792ceced438dcfa23c2c991e", "message": "CB-9849 GCP : For FreeIPA use the GCP shared project id to query the networks", "committedDate": "2020-11-18T13:52:10Z", "type": "forcePushed"}, {"oid": "c64cefe0ec1a5907940a343221ab5502bde4e61b", "url": "https://github.com/hortonworks/cloudbreak/commit/c64cefe0ec1a5907940a343221ab5502bde4e61b", "message": "CB-9849 GCP : For FreeIPA use the GCP shared project id to query the networks", "committedDate": "2020-11-18T13:57:06Z", "type": "forcePushed"}, {"oid": "43acc08598344b9ffa419d958fa63f876e43f942", "url": "https://github.com/hortonworks/cloudbreak/commit/43acc08598344b9ffa419d958fa63f876e43f942", "message": "CB-9849 GCP : For FreeIPA use the GCP shared project id to query the networks", "committedDate": "2020-11-18T14:24:26Z", "type": "forcePushed"}, {"oid": "f7f784a64f781167ca041c9eeefccfe567566d03", "url": "https://github.com/hortonworks/cloudbreak/commit/f7f784a64f781167ca041c9eeefccfe567566d03", "message": "CB-9849 GCP : For FreeIPA use the GCP shared project id to query the networks\n\n1. If a user gives a shared project id and a vpc in it, then the reverse DNS zone calculations in FreeIPA is not done correctly.\n2. To fix this we need to look at the network and subnet in the shared project.\n3. This is fixed everywhere except at one place here.\n4. The ultimate issue will be that DH can not talk to IDBroker, it will receive 401 due to lack of reverse DNS.\n5. CB-9180 will take care of bailing out if we can not calculate reverse DNS zones.\n\n./gradlew build", "committedDate": "2020-11-18T20:03:26Z", "type": "commit"}, {"oid": "f7f784a64f781167ca041c9eeefccfe567566d03", "url": "https://github.com/hortonworks/cloudbreak/commit/f7f784a64f781167ca041c9eeefccfe567566d03", "message": "CB-9849 GCP : For FreeIPA use the GCP shared project id to query the networks\n\n1. If a user gives a shared project id and a vpc in it, then the reverse DNS zone calculations in FreeIPA is not done correctly.\n2. To fix this we need to look at the network and subnet in the shared project.\n3. This is fixed everywhere except at one place here.\n4. The ultimate issue will be that DH can not talk to IDBroker, it will receive 401 due to lack of reverse DNS.\n5. CB-9180 will take care of bailing out if we can not calculate reverse DNS zones.\n\n./gradlew build", "committedDate": "2020-11-18T20:03:26Z", "type": "forcePushed"}]}