{"pr_number": 9006, "pr_title": "CB-8778 validate paywall access before starting the upgrade process", "pr_createdAt": "2020-09-14T14:47:02Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/9006", "timeline": [{"oid": "dfc9a73220c728c2ec232e5fd7f0e251d4f77414", "url": "https://github.com/hortonworks/cloudbreak/commit/dfc9a73220c728c2ec232e5fd7f0e251d4f77414", "message": "CB-8778 validate paywall access before starting the upgrade process\nFor runtime upgrade, we have to download the CM and CDP builds from paywall\n(archive.cloudera.com/p/). The CM license that is configured uniquely for each\nCDP account can be used to authenticate. However, it can happen that customers\ndo not have an updated license that can be used. In this case, it would be a\nmistake to even start the upgrade process. Instead, whenever an upgrade is\nrequested we'll validate if we can use the configured license to access the paywall.\nIf it's not valid we will reject the request. Once they update the license in UMS\nwe will also update the license as part of the upgrade process to make sure\nwe can download everything. We're also NOT checking the validity of the license\nwhen we're searching for upgrade candidates. This is because this operation happens\nvery frequently (each time you open up the Datalake details page on the UI). Due to\nthis we will show a message on the UI that upgrades are available, but when they\ntry to trigger it we will reject the request.", "committedDate": "2020-09-14T15:37:59Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODEyMjMyMg==", "url": "https://github.com/hortonworks/cloudbreak/pull/9006#discussion_r488122322", "bodyText": "typo here", "author": "pdarvasi", "createdAt": "2020-09-14T18:01:46Z", "path": "datalake/src/main/java/com/sequenceiq/datalake/service/upgrade/SdxRuntimeUpgradeService.java", "diffHunk": "@@ -146,6 +174,46 @@ private void verifyRuntimeUpgradeEntitlement(String userCrn, SdxUpgradeRequest u\n         }\n     }\n \n+    private void verifyPaywallAccess(String userCrn, SdxUpgradeRequest upgradeRequest) {\n+        if (upgradeRequest != null && !Boolean.TRUE.equals(upgradeRequest.getLockComponents())) {\n+            if (!isInternalRepoAllowedForUpgrade(userCrn)) {\n+                verifyCMLicenseValidity(userCrn);\n+            } else {\n+                LOGGER.info(\"Internal repo is allowed for upgrade, skip CM license validation\");\n+            }\n+        }\n+    }\n+\n+    private void verifyCMLicenseValidity(String userCrn) {\n+        LOGGER.info(\"Verify if the CM license is valid to authentichate to {}\", paywallUrl);", "originalCommit": "dfc9a73220c728c2ec232e5fd7f0e251d4f77414", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d68c0f44e188d071b24440781ba227a917cd6538", "chunk": "diff --git a/datalake/src/main/java/com/sequenceiq/datalake/service/upgrade/SdxRuntimeUpgradeService.java b/datalake/src/main/java/com/sequenceiq/datalake/service/upgrade/SdxRuntimeUpgradeService.java\nindex 7c783b4819..f7f6ced697 100644\n--- a/datalake/src/main/java/com/sequenceiq/datalake/service/upgrade/SdxRuntimeUpgradeService.java\n+++ b/datalake/src/main/java/com/sequenceiq/datalake/service/upgrade/SdxRuntimeUpgradeService.java\n\n@@ -185,7 +185,7 @@ public class SdxRuntimeUpgradeService {\n     }\n \n     private void verifyCMLicenseValidity(String userCrn) {\n-        LOGGER.info(\"Verify if the CM license is valid to authentichate to {}\", paywallUrl);\n+        LOGGER.info(\"Verify if the CM license is valid to authenticate to {}\", paywallUrl);\n         String accountId = sdxService.getAccountIdFromCrn(userCrn);\n         Account account = umsClient.getAccountDetails(INTERNAL_ACTOR_CRN, accountId, MDCUtils.getRequestId());\n         JsonCMLicense license = CMLicenseUtil.parseLicense(account.getClouderaManagerLicenseKey())\n"}}, {"oid": "d68c0f44e188d071b24440781ba227a917cd6538", "url": "https://github.com/hortonworks/cloudbreak/commit/d68c0f44e188d071b24440781ba227a917cd6538", "message": "CB-8778 validate paywall access before starting the upgrade process\nFor runtime upgrade, we have to download the CM and CDP builds from paywall\n(archive.cloudera.com/p/). The CM license that is configured uniquely for each\nCDP account can be used to authenticate. However, it can happen that customers\ndo not have an updated license that can be used. In this case, it would be a\nmistake to even start the upgrade process. Instead, whenever an upgrade is\nrequested we'll validate if we can use the configured license to access the paywall.\nIf it's not valid we will reject the request. Once they update the license in UMS\nwe will also update the license as part of the upgrade process to make sure\nwe can download everything. We're also NOT checking the validity of the license\nwhen we're searching for upgrade candidates. This is because this operation happens\nvery frequently (each time you open up the Datalake details page on the UI). Due to\nthis we will show a message on the UI that upgrades are available, but when they\ntry to trigger it we will reject the request.", "committedDate": "2020-09-14T18:58:13Z", "type": "commit"}, {"oid": "d68c0f44e188d071b24440781ba227a917cd6538", "url": "https://github.com/hortonworks/cloudbreak/commit/d68c0f44e188d071b24440781ba227a917cd6538", "message": "CB-8778 validate paywall access before starting the upgrade process\nFor runtime upgrade, we have to download the CM and CDP builds from paywall\n(archive.cloudera.com/p/). The CM license that is configured uniquely for each\nCDP account can be used to authenticate. However, it can happen that customers\ndo not have an updated license that can be used. In this case, it would be a\nmistake to even start the upgrade process. Instead, whenever an upgrade is\nrequested we'll validate if we can use the configured license to access the paywall.\nIf it's not valid we will reject the request. Once they update the license in UMS\nwe will also update the license as part of the upgrade process to make sure\nwe can download everything. We're also NOT checking the validity of the license\nwhen we're searching for upgrade candidates. This is because this operation happens\nvery frequently (each time you open up the Datalake details page on the UI). Due to\nthis we will show a message on the UI that upgrades are available, but when they\ntry to trigger it we will reject the request.", "committedDate": "2020-09-14T18:58:13Z", "type": "forcePushed"}]}