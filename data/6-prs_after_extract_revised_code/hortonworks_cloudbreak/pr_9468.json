{"pr_number": 9468, "pr_title": "CB-9858 - Azure environment with same network and RG cannot be created", "pr_createdAt": "2020-11-18T15:00:59Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/9468", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc3MTEzMA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9468#discussion_r526771130", "bodyText": "This could be one line", "author": "gergopapi2", "createdAt": "2020-11-19T10:57:34Z", "path": "environment/src/main/java/com/sequenceiq/environment/environment/validation/network/azure/AzureEnvironmentNetworkValidator.java", "diffHunk": "@@ -147,11 +147,20 @@ private void checkPrivateEndpointNetworkPoliciesWhenExistingNetwork(\n     }\n \n     private void checkPrivateEndpointForExistingNetworkLink(ValidationResultBuilder resultBuilder, EnvironmentDto environmentDto, NetworkDto networkDto) {\n-        if (networkDto.getServiceEndpointCreation() ==  ServiceEndpointCreation.ENABLED_PRIVATE_ENDPOINT) {\n+        if (networkDto.getServiceEndpointCreation() ==  ServiceEndpointCreation.ENABLED_PRIVATE_ENDPOINT &&\n+                ResourceGroupUsagePattern.USE_MULTIPLE != getResourceGroupUsagePattern(environmentDto)) {\n             CloudCredential cloudCredential = credentialToCloudCredentialConverter.convert(environmentDto.getCredential());\n             AzureClient azureClient = azureClientService.getClient(cloudCredential);\n-            ValidationResult validationResult = azureNetworkLinkService.validateExistingNetworkLink(azureClient, networkDto.getAzure().getNetworkId());\n-            NullUtil.doIfNotNull(validationResult, resultBuilder::merge);\n+            Optional<String> resourceGroupName = getAzureResourceGroupDto(environmentDto)", "originalCommit": "e7e362f2e5c186acc6e45ea121533f3481e3804e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "dff9d6cd8b8bea9f0832ddf03e12690e6da80bac", "chunk": "diff --git a/environment/src/main/java/com/sequenceiq/environment/environment/validation/network/azure/AzureEnvironmentNetworkValidator.java b/environment/src/main/java/com/sequenceiq/environment/environment/validation/network/azure/AzureEnvironmentNetworkValidator.java\nindex 0b780ba8e7..b6077c6fff 100644\n--- a/environment/src/main/java/com/sequenceiq/environment/environment/validation/network/azure/AzureEnvironmentNetworkValidator.java\n+++ b/environment/src/main/java/com/sequenceiq/environment/environment/validation/network/azure/AzureEnvironmentNetworkValidator.java\n\n@@ -153,14 +152,8 @@ public class AzureEnvironmentNetworkValidator implements EnvironmentNetworkValid\n             AzureClient azureClient = azureClientService.getClient(cloudCredential);\n             Optional<String> resourceGroupName = getAzureResourceGroupDto(environmentDto)\n                     .map(AzureResourceGroupDto::getName);\n-            ValidationResult validationResult;\n-            if (resourceGroupName.isPresent()) {\n-                validationResult = azureNetworkLinkService.validateExistingNetworkLink(azureClient, networkDto.getAzure().getNetworkId(),\n-                        resourceGroupName.get());\n-                NullUtil.doIfNotNull(validationResult, resultBuilder::merge);\n-            } else {\n-                resultBuilder.error(\"Resource group name is not specified in the environment request!\");\n-            }\n+            resourceGroupName.ifPresent(rgName -> NullUtil.doIfNotNull(\n+                    azureNetworkLinkService.validateExistingNetworkLink(azureClient, networkDto.getAzure().getNetworkId(), rgName), resultBuilder::merge));\n         }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc3MjU3MQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9468#discussion_r526772571", "bodyText": "A question: in what condition is it possible in single RG use-case not to have a RG name saved?", "author": "gergopapi2", "createdAt": "2020-11-19T10:59:47Z", "path": "environment/src/main/java/com/sequenceiq/environment/environment/validation/network/azure/AzureEnvironmentNetworkValidator.java", "diffHunk": "@@ -147,11 +147,20 @@ private void checkPrivateEndpointNetworkPoliciesWhenExistingNetwork(\n     }\n \n     private void checkPrivateEndpointForExistingNetworkLink(ValidationResultBuilder resultBuilder, EnvironmentDto environmentDto, NetworkDto networkDto) {\n-        if (networkDto.getServiceEndpointCreation() ==  ServiceEndpointCreation.ENABLED_PRIVATE_ENDPOINT) {\n+        if (networkDto.getServiceEndpointCreation() ==  ServiceEndpointCreation.ENABLED_PRIVATE_ENDPOINT &&\n+                ResourceGroupUsagePattern.USE_MULTIPLE != getResourceGroupUsagePattern(environmentDto)) {\n             CloudCredential cloudCredential = credentialToCloudCredentialConverter.convert(environmentDto.getCredential());\n             AzureClient azureClient = azureClientService.getClient(cloudCredential);\n-            ValidationResult validationResult = azureNetworkLinkService.validateExistingNetworkLink(azureClient, networkDto.getAzure().getNetworkId());\n-            NullUtil.doIfNotNull(validationResult, resultBuilder::merge);\n+            Optional<String> resourceGroupName = getAzureResourceGroupDto(environmentDto)\n+                    .map(AzureResourceGroupDto::getName);\n+            ValidationResult validationResult;\n+            if (resourceGroupName.isPresent()) {\n+                validationResult = azureNetworkLinkService.validateExistingNetworkLink(azureClient, networkDto.getAzure().getNetworkId(),\n+                        resourceGroupName.get());\n+                NullUtil.doIfNotNull(validationResult, resultBuilder::merge);\n+            } else {\n+                resultBuilder.error(\"Resource group name is not specified in the environment request!\");", "originalCommit": "e7e362f2e5c186acc6e45ea121533f3481e3804e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjg4OTcyMw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9468#discussion_r526889723", "bodyText": "Hopefully, never, this was instead of the orElseThrow, but you are right we might skip the validation silently in such impossible cases.", "author": "pdarvasi", "createdAt": "2020-11-19T13:36:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc3MjU3MQ=="}], "type": "inlineReview", "revised_code": {"commit": "dff9d6cd8b8bea9f0832ddf03e12690e6da80bac", "chunk": "diff --git a/environment/src/main/java/com/sequenceiq/environment/environment/validation/network/azure/AzureEnvironmentNetworkValidator.java b/environment/src/main/java/com/sequenceiq/environment/environment/validation/network/azure/AzureEnvironmentNetworkValidator.java\nindex 0b780ba8e7..b6077c6fff 100644\n--- a/environment/src/main/java/com/sequenceiq/environment/environment/validation/network/azure/AzureEnvironmentNetworkValidator.java\n+++ b/environment/src/main/java/com/sequenceiq/environment/environment/validation/network/azure/AzureEnvironmentNetworkValidator.java\n\n@@ -153,14 +152,8 @@ public class AzureEnvironmentNetworkValidator implements EnvironmentNetworkValid\n             AzureClient azureClient = azureClientService.getClient(cloudCredential);\n             Optional<String> resourceGroupName = getAzureResourceGroupDto(environmentDto)\n                     .map(AzureResourceGroupDto::getName);\n-            ValidationResult validationResult;\n-            if (resourceGroupName.isPresent()) {\n-                validationResult = azureNetworkLinkService.validateExistingNetworkLink(azureClient, networkDto.getAzure().getNetworkId(),\n-                        resourceGroupName.get());\n-                NullUtil.doIfNotNull(validationResult, resultBuilder::merge);\n-            } else {\n-                resultBuilder.error(\"Resource group name is not specified in the environment request!\");\n-            }\n+            resourceGroupName.ifPresent(rgName -> NullUtil.doIfNotNull(\n+                    azureNetworkLinkService.validateExistingNetworkLink(azureClient, networkDto.getAzure().getNetworkId(), rgName), resultBuilder::merge));\n         }\n     }\n \n"}}, {"oid": "dff9d6cd8b8bea9f0832ddf03e12690e6da80bac", "url": "https://github.com/hortonworks/cloudbreak/commit/dff9d6cd8b8bea9f0832ddf03e12690e6da80bac", "message": "CB-9858 - Azure environment with same network and RG cannot be created", "committedDate": "2020-11-19T14:35:42Z", "type": "commit"}, {"oid": "dff9d6cd8b8bea9f0832ddf03e12690e6da80bac", "url": "https://github.com/hortonworks/cloudbreak/commit/dff9d6cd8b8bea9f0832ddf03e12690e6da80bac", "message": "CB-9858 - Azure environment with same network and RG cannot be created", "committedDate": "2020-11-19T14:35:42Z", "type": "forcePushed"}]}