{"pr_number": 8346, "pr_title": "CB-7574: Fix FreeIPA repair to remove dead ipa servers registration", "pr_createdAt": "2020-06-19T16:29:38Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/8346", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjkzOTQ3NQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8346#discussion_r442939475", "bodyText": "nit: plural naming on list?", "author": "wonderslug", "createdAt": "2020-06-19T16:33:24Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/flow/chain/RepairFlowEventChainFactory.java", "diffHunk": "@@ -22,10 +26,13 @@ public String initEvent() {\n \n     @Override\n     public Queue<Selectable> createFlowTriggerEventQueue(RepairEvent event) {\n+        Set<String> terminatedOrRemovedInstanceIdsSet = new HashSet<>(event.getInstanceIds());\n+        terminatedOrRemovedInstanceIdsSet.addAll(event.getAdditionalTermiantedInstanceIds());\n+        List<String> terminatedOrRemovedInstanceId = terminatedOrRemovedInstanceIdsSet.stream().collect(Collectors.toList());", "originalCommit": "0bd4ec7d8b281ce1aadfbe2683dd11b17099963a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e73669ecc541a75b9115e8bdb365604b0e717445", "chunk": "diff --git a/freeipa/src/main/java/com/sequenceiq/freeipa/flow/chain/RepairFlowEventChainFactory.java b/freeipa/src/main/java/com/sequenceiq/freeipa/flow/chain/RepairFlowEventChainFactory.java\nindex 8d260db6c9..02e431dda1 100644\n--- a/freeipa/src/main/java/com/sequenceiq/freeipa/flow/chain/RepairFlowEventChainFactory.java\n+++ b/freeipa/src/main/java/com/sequenceiq/freeipa/flow/chain/RepairFlowEventChainFactory.java\n\n@@ -28,11 +28,11 @@ public class RepairFlowEventChainFactory implements FlowEventChainFactory<Repair\n     public Queue<Selectable> createFlowTriggerEventQueue(RepairEvent event) {\n         Set<String> terminatedOrRemovedInstanceIdsSet = new HashSet<>(event.getInstanceIds());\n         terminatedOrRemovedInstanceIdsSet.addAll(event.getAdditionalTermiantedInstanceIds());\n-        List<String> terminatedOrRemovedInstanceId = terminatedOrRemovedInstanceIdsSet.stream().collect(Collectors.toList());\n+        List<String> terminatedOrRemovedInstanceIds = terminatedOrRemovedInstanceIdsSet.stream().collect(Collectors.toList());\n \n         Queue<Selectable> flowEventChain = new ConcurrentLinkedQueue<>();\n         flowEventChain.add(new DownscaleEvent(DownscaleFlowEvent.DOWNSCALE_EVENT.event(),\n-                event.getResourceId(), terminatedOrRemovedInstanceId, event.getInstanceCountByGroup(), Boolean.TRUE, event.getOperationId(), event.accepted()));\n+                event.getResourceId(), terminatedOrRemovedInstanceIds, event.getInstanceCountByGroup(), Boolean.TRUE, event.getOperationId(), event.accepted()));\n         flowEventChain.add(new UpscaleEvent(UpscaleFlowEvent.UPSCALE_EVENT.event(),\n                 event.getResourceId(), event.getInstanceCountByGroup(), Boolean.TRUE, event.getOperationId()));\n         return flowEventChain;\n"}}, {"oid": "e73669ecc541a75b9115e8bdb365604b0e717445", "url": "https://github.com/hortonworks/cloudbreak/commit/e73669ecc541a75b9115e8bdb365604b0e717445", "message": "CB-7574: Fix FreeIPA repair to remove dead ipa servers registration\n\nThis fixes a case where a previously deleted freeipa server was not\nfully deleted and it remained registered as a server but the host\nentry was cleaned up. The freeipa server deletion was fixed to check\nthe ipa server list (ipa server_find) rather than the host list\n(ip host_find) so that a delete is issued if the server is still\nstill registered.\n\nThis also changes the repair downscale to remove all previously\ncleaned up servers. This was important because if the downscale leaves\nsome old information around, a future repair can ensure it is cleaned\nup. Once the first downscale finishes, the UI no longer displays the\ninstance ID, so it makes it very difficult to determine the old\ninstance ID to specify in the repair request. For most of the\ndownscale operations, the deletion of previously deleted items just\nskips over them.\n\nThis was tested manually on a local deployment of cloudbreak on a\ncluster that was experiencing this issue.", "committedDate": "2020-06-19T16:53:37Z", "type": "commit"}, {"oid": "e73669ecc541a75b9115e8bdb365604b0e717445", "url": "https://github.com/hortonworks/cloudbreak/commit/e73669ecc541a75b9115e8bdb365604b0e717445", "message": "CB-7574: Fix FreeIPA repair to remove dead ipa servers registration\n\nThis fixes a case where a previously deleted freeipa server was not\nfully deleted and it remained registered as a server but the host\nentry was cleaned up. The freeipa server deletion was fixed to check\nthe ipa server list (ipa server_find) rather than the host list\n(ip host_find) so that a delete is issued if the server is still\nstill registered.\n\nThis also changes the repair downscale to remove all previously\ncleaned up servers. This was important because if the downscale leaves\nsome old information around, a future repair can ensure it is cleaned\nup. Once the first downscale finishes, the UI no longer displays the\ninstance ID, so it makes it very difficult to determine the old\ninstance ID to specify in the repair request. For most of the\ndownscale operations, the deletion of previously deleted items just\nskips over them.\n\nThis was tested manually on a local deployment of cloudbreak on a\ncluster that was experiencing this issue.", "committedDate": "2020-06-19T16:53:37Z", "type": "forcePushed"}]}