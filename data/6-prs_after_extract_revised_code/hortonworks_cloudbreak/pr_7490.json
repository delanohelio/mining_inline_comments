{"pr_number": 7490, "pr_title": "CB-5917 use parent environment virtual groups for workloads in child environments", "pr_createdAt": "2020-03-06T11:09:33Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/7490", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODg3NTYxMA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7490#discussion_r388875610", "bodyText": "some log would be nice here", "author": "doktoric", "createdAt": "2020-03-06T12:28:31Z", "path": "core/src/main/java/com/sequenceiq/cloudbreak/service/environment/EnvironmentConfigProvider.java", "diffHunk": "@@ -22,4 +22,18 @@ public boolean isChildEnvironment(String environmentCrn) {\n             throw new CloudbreakServiceException(\"Failed to get environment details from Environment service due to:\", ex);\n         }\n     }\n+\n+    public String getParentEnvironmentCrn(String environmentCrn) {\n+        try {\n+            String result = environmentCrn;\n+            DetailedEnvironmentResponse environmentResponse = environmentClientService.getByCrn(environmentCrn);\n+            String parentEnvironmentCrn = environmentResponse.getParentEnvironmentCrn();", "originalCommit": "7f3baf9b3f9e5e9ce889aa6c36cbb61311f4346f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f83b9feb82fbe94367d765c8cffebe011594c78f", "chunk": "diff --git a/core/src/main/java/com/sequenceiq/cloudbreak/service/environment/EnvironmentConfigProvider.java b/core/src/main/java/com/sequenceiq/cloudbreak/service/environment/EnvironmentConfigProvider.java\nindex 68fa6bca39..b303fbadee 100644\n--- a/core/src/main/java/com/sequenceiq/cloudbreak/service/environment/EnvironmentConfigProvider.java\n+++ b/core/src/main/java/com/sequenceiq/cloudbreak/service/environment/EnvironmentConfigProvider.java\n\n@@ -10,29 +12,33 @@ import com.sequenceiq.environment.api.v1.environment.model.response.DetailedEnvi\n \n @Service\n public class EnvironmentConfigProvider {\n+    private static final Logger LOGGER = LoggerFactory.getLogger(EnvironmentConfigProvider.class);\n \n     @Inject\n     private EnvironmentClientService environmentClientService;\n \n     public boolean isChildEnvironment(String environmentCrn) {\n-        try {\n-            DetailedEnvironmentResponse environmentResponse = environmentClientService.getByCrn(environmentCrn);\n-            return StringUtils.isNoneEmpty(environmentResponse.getParentEnvironmentCrn());\n-        } catch (Exception ex) {\n-            throw new CloudbreakServiceException(\"Failed to get environment details from Environment service due to:\", ex);\n-        }\n+        DetailedEnvironmentResponse environment = getEnvironmentByCrn(environmentCrn);\n+        return StringUtils.isNoneEmpty(environment.getParentEnvironmentCrn());\n     }\n \n     public String getParentEnvironmentCrn(String environmentCrn) {\n-        try {\n             String result = environmentCrn;\n-            DetailedEnvironmentResponse environmentResponse = environmentClientService.getByCrn(environmentCrn);\n+            DetailedEnvironmentResponse environmentResponse = getEnvironmentByCrn(environmentCrn);\n             String parentEnvironmentCrn = environmentResponse.getParentEnvironmentCrn();\n             if (StringUtils.isNotBlank(parentEnvironmentCrn)) {\n+                LOGGER.debug(\"The environment('{}') is a child, returning with the crn('{}') of the parent environment\", environmentCrn, parentEnvironmentCrn);\n                 result = parentEnvironmentCrn;\n             }\n             return result;\n+    }\n+\n+    private DetailedEnvironmentResponse getEnvironmentByCrn(String environmentCrn) {\n+        try {\n+            LOGGER.info(\"Fetch environment details by crn:'{}' from Environment service\", environmentCrn);\n+            return environmentClientService.getByCrn(environmentCrn);\n         } catch (Exception ex) {\n+            LOGGER.warn(String.format(\"Failed to get environment by crn:'%s' from Environment service\", environmentCrn), ex);\n             throw new CloudbreakServiceException(\"Failed to get environment details from Environment service due to:\", ex);\n         }\n     }\n"}}, {"oid": "f83b9feb82fbe94367d765c8cffebe011594c78f", "url": "https://github.com/hortonworks/cloudbreak/commit/f83b9feb82fbe94367d765c8cffebe011594c78f", "message": "CB-5917 use parent environment virtual groups for workloads in child environments", "committedDate": "2020-03-06T13:37:39Z", "type": "commit"}, {"oid": "f83b9feb82fbe94367d765c8cffebe011594c78f", "url": "https://github.com/hortonworks/cloudbreak/commit/f83b9feb82fbe94367d765c8cffebe011594c78f", "message": "CB-5917 use parent environment virtual groups for workloads in child environments", "committedDate": "2020-03-06T13:37:39Z", "type": "forcePushed"}]}