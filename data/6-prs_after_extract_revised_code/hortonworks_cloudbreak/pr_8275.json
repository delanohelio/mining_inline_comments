{"pr_number": 8275, "pr_title": "DISTX-480 Integrate with autoscale hostgroup recommendations", "pr_createdAt": "2020-06-15T06:38:51Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/8275", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDU4ODQ5Mg==", "url": "https://github.com/hortonworks/cloudbreak/pull/8275#discussion_r440588492", "bodyText": "This will not NPE if there's no supported groups, correct?", "author": "sidseth", "createdAt": "2020-06-16T05:07:00Z", "path": "autoscale/src/main/java/com/sequenceiq/periscope/controller/AlertController.java", "diffHunk": "@@ -176,15 +185,36 @@ private void validateAccountEntitlement(Cluster cluster) {\n                 ThreadBasedUserCrnProvider.getUserCrn(),\n                 ThreadBasedUserCrnProvider.getAccountId(),\n                 cluster.getCloudPlatform())) {\n-            throw new BadRequestException(String.format(\"Autoscaling is not enabled for CloudPlatform '%s', Cluster '%s' in this Account\",\n-                    cluster.getCloudPlatform(), cluster.getStackCrn()));\n+            throw new BadRequestException(messagesService.getMessage(MessageCode.AUTOSCALING_ENTITLEMENT_NOT_ENABLED,\n+                    List.of(cluster.getCloudPlatform(),  cluster.getStackName())));\n+        }\n+    }\n+\n+    private void validateSupportedHostGroup(Cluster cluster, String requestHostGroup, AlertType alertType) {\n+        Set<String> supportedHostGroups = Optional.ofNullable(\n+                recommendationService.getAutoscaleRecommendations(cluster.getStackCrn())).map(\n+                recommendation -> {\n+                    if (AlertType.LOAD.equals(alertType)) {\n+                        return recommendation.getLoadBasedHostGroups();\n+                    }\n+                    if (AlertType.TIME.equals(alertType)) {\n+                        return recommendation.getTimeBasedHostGroups();\n+                    }\n+                    return Set.of(\"\");\n+                }).orElse(Set.of(\"\"));\n+        if (!supportedHostGroups.contains(requestHostGroup)) {", "originalCommit": "91bc048a04e83857e9e04ed4c24289a6bb6d295e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDc0NDkzNQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8275#discussion_r440744935", "bodyText": "The service returns empty set when no supported group, added additional null validation.", "author": "smaniraju", "createdAt": "2020-06-16T10:20:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDU4ODQ5Mg=="}], "type": "inlineReview", "revised_code": {"commit": "4f2401f1fdb5bec1826a8ba33140ec1a7f9e21c5", "chunk": "diff --git a/autoscale/src/main/java/com/sequenceiq/periscope/controller/AlertController.java b/autoscale/src/main/java/com/sequenceiq/periscope/controller/AlertController.java\nindex 810d1a9eae..4f43bebc91 100644\n--- a/autoscale/src/main/java/com/sequenceiq/periscope/controller/AlertController.java\n+++ b/autoscale/src/main/java/com/sequenceiq/periscope/controller/AlertController.java\n\n@@ -195,10 +195,10 @@ public class AlertController implements AlertEndpoint {\n                 recommendationService.getAutoscaleRecommendations(cluster.getStackCrn())).map(\n                 recommendation -> {\n                     if (AlertType.LOAD.equals(alertType)) {\n-                        return recommendation.getLoadBasedHostGroups();\n+                        return Optional.ofNullable(recommendation.getLoadBasedHostGroups()).orElse(Set.of());\n                     }\n                     if (AlertType.TIME.equals(alertType)) {\n-                        return recommendation.getTimeBasedHostGroups();\n+                        return Optional.ofNullable(recommendation.getTimeBasedHostGroups()).orElse(Set.of());\n                     }\n                     return Set.of(\"\");\n                 }).orElse(Set.of(\"\"));\n"}}, {"oid": "4f2401f1fdb5bec1826a8ba33140ec1a7f9e21c5", "url": "https://github.com/hortonworks/cloudbreak/commit/4f2401f1fdb5bec1826a8ba33140ec1a7f9e21c5", "message": "DISTX-480 Integrate with autoscale recommendations\n\nIntegrate with autoscale recommendations.\nIntegrate with MessageSource messages.\nOptimize Yarn Response Unmarshalling", "committedDate": "2020-06-16T10:24:06Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM0NzQ5MA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8275#discussion_r441347490", "bodyText": "what is your opinion about that you convert only the different value and you are using the .name() any other case?", "author": "topolyai5", "createdAt": "2020-06-17T07:45:50Z", "path": "autoscale-api/src/main/java/com/sequenceiq/periscope/api/model/AlertType.java", "diffHunk": "@@ -1,5 +1,16 @@\n package com.sequenceiq.periscope.api.model;\n \n public enum AlertType {\n-    METRIC, TIME, PROMETHEUS, LOAD\n+    METRIC, TIME, PROMETHEUS, LOAD;\n+\n+    @Override\n+    public String toString() {\n+        switch (this) {", "originalCommit": "4f2401f1fdb5bec1826a8ba33140ec1a7f9e21c5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM3MTgwMw==", "url": "https://github.com/hortonworks/cloudbreak/pull/8275#discussion_r441371803", "bodyText": "ok, updated to use .name()", "author": "smaniraju", "createdAt": "2020-06-17T08:26:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM0NzQ5MA=="}], "type": "inlineReview", "revised_code": {"commit": "64dae250f3d6a4f4b422b6b17f394548025a5e91", "chunk": "diff --git a/autoscale-api/src/main/java/com/sequenceiq/periscope/api/model/AlertType.java b/autoscale-api/src/main/java/com/sequenceiq/periscope/api/model/AlertType.java\nindex 24aa9d5fe0..02f424223c 100644\n--- a/autoscale-api/src/main/java/com/sequenceiq/periscope/api/model/AlertType.java\n+++ b/autoscale-api/src/main/java/com/sequenceiq/periscope/api/model/AlertType.java\n\n@@ -7,10 +7,7 @@ public enum AlertType {\n     public String toString() {\n         switch (this) {\n             case TIME: return \"SCHEDULE\";\n-            case LOAD: return \"LOAD\";\n-            case METRIC: return \"METRIC\";\n-            case PROMETHEUS: return \"PROMETHEUS\";\n-            default: throw new IllegalArgumentException();\n+            default: return name();\n         }\n     }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM0ODM1MA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8275#discussion_r441348350", "bodyText": "this should work without this because the class is annotated with @RunWith(MockitoJUnitRunner.class) or am I missing something?", "author": "topolyai5", "createdAt": "2020-06-17T07:47:18Z", "path": "autoscale-api/src/test/java/com/sequenceiq/periscope/api/endpoint/validator/DistroXAutoscaleRequestValidatorTest.java", "diffHunk": "@@ -38,8 +43,12 @@\n \n     private ConstraintValidatorContext validatorContext;\n \n+    @Mock\n+    private CloudbreakMessagesService messagesService;\n+\n     @Before\n     public void setupMocks() {\n+        MockitoAnnotations.initMocks(this);", "originalCommit": "4f2401f1fdb5bec1826a8ba33140ec1a7f9e21c5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM3MTI4NA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8275#discussion_r441371284", "bodyText": "yes this is not required, fixed it.", "author": "smaniraju", "createdAt": "2020-06-17T08:25:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM0ODM1MA=="}], "type": "inlineReview", "revised_code": {"commit": "64dae250f3d6a4f4b422b6b17f394548025a5e91", "chunk": "diff --git a/autoscale-api/src/test/java/com/sequenceiq/periscope/api/endpoint/validator/DistroXAutoscaleRequestValidatorTest.java b/autoscale-api/src/test/java/com/sequenceiq/periscope/api/endpoint/validator/DistroXAutoscaleRequestValidatorTest.java\nindex a08aef3cc4..9a47cde377 100644\n--- a/autoscale-api/src/test/java/com/sequenceiq/periscope/api/endpoint/validator/DistroXAutoscaleRequestValidatorTest.java\n+++ b/autoscale-api/src/test/java/com/sequenceiq/periscope/api/endpoint/validator/DistroXAutoscaleRequestValidatorTest.java\n\n@@ -48,7 +47,6 @@ public class DistroXAutoscaleRequestValidatorTest {\n \n     @Before\n     public void setupMocks() {\n-        MockitoAnnotations.initMocks(this);\n         constraintViolationBuilder = mock(ConstraintValidatorContext.ConstraintViolationBuilder.class);\n         nodeBuilderCustomizableContext =\n                 mock(ConstraintValidatorContext.ConstraintViolationBuilder.NodeBuilderCustomizableContext.class);\n"}}, {"oid": "64dae250f3d6a4f4b422b6b17f394548025a5e91", "url": "https://github.com/hortonworks/cloudbreak/commit/64dae250f3d6a4f4b422b6b17f394548025a5e91", "message": "DISTX-480 Integrate with autoscale recommendations\n\nIntegrate with autoscale recommendations.\nIntegrate with MessageSource messages.\nOptimize Yarn Response Unmarshalling", "committedDate": "2020-06-17T08:22:44Z", "type": "commit"}, {"oid": "64dae250f3d6a4f4b422b6b17f394548025a5e91", "url": "https://github.com/hortonworks/cloudbreak/commit/64dae250f3d6a4f4b422b6b17f394548025a5e91", "message": "DISTX-480 Integrate with autoscale recommendations\n\nIntegrate with autoscale recommendations.\nIntegrate with MessageSource messages.\nOptimize Yarn Response Unmarshalling", "committedDate": "2020-06-17T08:22:44Z", "type": "forcePushed"}]}