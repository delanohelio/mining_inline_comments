{"pr_number": 7764, "pr_title": "CB-6458 Deny distrox/sdx stop on spot instances", "pr_createdAt": "2020-04-08T17:55:46Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/7764", "timeline": [{"oid": "d29fe945b812d3fc32788a0faa3ced32a86be9e0", "url": "https://github.com/hortonworks/cloudbreak/commit/d29fe945b812d3fc32788a0faa3ced32a86be9e0", "message": "CB-6458 Deny distrox/sdx stop on spot instances", "committedDate": "2020-04-09T13:29:27Z", "type": "commit"}, {"oid": "d29fe945b812d3fc32788a0faa3ced32a86be9e0", "url": "https://github.com/hortonworks/cloudbreak/commit/d29fe945b812d3fc32788a0faa3ced32a86be9e0", "message": "CB-6458 Deny distrox/sdx stop on spot instances", "committedDate": "2020-04-09T13:29:27Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI2NjM4Ng==", "url": "https://github.com/hortonworks/cloudbreak/pull/7764#discussion_r406266386", "bodyText": "pls add  verify(stackUpdater, never()).updateStackStatus(any(), any()) here", "author": "bergerdenes", "createdAt": "2020-04-09T14:56:44Z", "path": "core/src/test/java/com/sequenceiq/cloudbreak/service/stack/flow/StackOperationServiceTest.java", "diffHunk": "@@ -106,4 +124,40 @@ public void testStartWhenClusterStopFailed() {\n         verify(flowManager, times(1)).triggerStackStart(stack.getId());\n         verify(stackUpdater, times(1)).updateStackStatus(stack.getId(),  DetailedStackStatus.START_REQUESTED);\n     }\n+\n+    @Test\n+    public void shouldNotTriggerStopWhenStackRunsOnSpotInstances() {\n+        Stack stack = new Stack();\n+        stack.setId(9876L);\n+        stack.setStackStatus(new StackStatus(stack, AVAILABLE));\n+        stack.setInstanceGroups(Set.of(createInstanceGroup(100)));\n+\n+        when(stackService.getByIdWithLists(stack.getId())).thenReturn(stack);\n+\n+        Assertions.assertThatThrownBy(() -> underTest.updateStatus(stack.getId(), StatusRequest.STOPPED, true, new User()))\n+                .isInstanceOf(BadRequestException.class)\n+                .hasMessage(String.format(\"Cannot update the status of stack '%s' to STOPPED, because it runs on spot instances\", stack.getName()));\n+    }", "originalCommit": "37e06f89f2f32e9f5edeeafa378a6add4e10fa45", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI3MDU1NQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/7764#discussion_r406270555", "bodyText": "Great idea, added", "author": "Bajzathd", "createdAt": "2020-04-09T15:02:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI2NjM4Ng=="}], "type": "inlineReview", "revised_code": {"commit": "be84a51096f18633c5887156f5c4e2096b174c8f", "chunk": "diff --git a/core/src/test/java/com/sequenceiq/cloudbreak/service/stack/flow/StackOperationServiceTest.java b/core/src/test/java/com/sequenceiq/cloudbreak/service/stack/flow/StackOperationServiceTest.java\nindex a4ef176d7f..f67fa59ba6 100644\n--- a/core/src/test/java/com/sequenceiq/cloudbreak/service/stack/flow/StackOperationServiceTest.java\n+++ b/core/src/test/java/com/sequenceiq/cloudbreak/service/stack/flow/StackOperationServiceTest.java\n\n@@ -137,6 +138,7 @@ public class StackOperationServiceTest {\n         Assertions.assertThatThrownBy(() -> underTest.updateStatus(stack.getId(), StatusRequest.STOPPED, true, new User()))\n                 .isInstanceOf(BadRequestException.class)\n                 .hasMessage(String.format(\"Cannot update the status of stack '%s' to STOPPED, because it runs on spot instances\", stack.getName()));\n+        verify(stackUpdater, never()).updateStackStatus(stack.getId(), STOP_REQUESTED);\n     }\n \n     @Test\n"}}, {"oid": "be84a51096f18633c5887156f5c4e2096b174c8f", "url": "https://github.com/hortonworks/cloudbreak/commit/be84a51096f18633c5887156f5c4e2096b174c8f", "message": "CB-6458 Add tests to deny distrox/sdx stop on spot instances", "committedDate": "2020-04-09T15:02:10Z", "type": "forcePushed"}, {"oid": "94d5e81754d5a0b9b7fb9c054c195ff31c9aa77f", "url": "https://github.com/hortonworks/cloudbreak/commit/94d5e81754d5a0b9b7fb9c054c195ff31c9aa77f", "message": "CB-6458 Add tests to deny distrox/sdx stop on spot instances", "committedDate": "2020-04-14T09:23:00Z", "type": "commit"}, {"oid": "94d5e81754d5a0b9b7fb9c054c195ff31c9aa77f", "url": "https://github.com/hortonworks/cloudbreak/commit/94d5e81754d5a0b9b7fb9c054c195ff31c9aa77f", "message": "CB-6458 Add tests to deny distrox/sdx stop on spot instances", "committedDate": "2020-04-14T09:23:00Z", "type": "forcePushed"}]}