{"pr_number": 7194, "pr_title": "CB-5240 Refactor byName and byCrn methods in StackService, StackCommo\u2026", "pr_createdAt": "2020-02-03T10:06:02Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/7194", "timeline": [{"oid": "8c0453a33d44769f6c653fa7b79562a96fa80863", "url": "https://github.com/hortonworks/cloudbreak/commit/8c0453a33d44769f6c653fa7b79562a96fa80863", "message": "CB-5240 Refactor byName and byCrn methods in StackService, StackCommonService, StackOperations", "committedDate": "2020-02-03T17:02:50Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjkxMzY2Mw==", "url": "https://github.com/hortonworks/cloudbreak/pull/7194#discussion_r376913663", "bodyText": "Please rename the param name to crn.", "author": "foldik", "createdAt": "2020-02-10T08:14:05Z", "path": "core/src/main/java/com/sequenceiq/cloudbreak/repository/StackRepository.java", "diffHunk": "@@ -207,6 +207,10 @@\n     @Query(\"SELECT s.id FROM Stack s WHERE s.name= :name AND s.workspace.id= :workspaceId AND s.terminated = null\")\n     Optional<Long> findIdByNameAndWorkspaceId(@Param(\"name\") String name, @Param(\"workspaceId\") Long workspaceId);\n \n+    @DisableCheckPermissions\n+    @Query(\"SELECT s.id FROM Stack s WHERE s.resourceCrn= :crn AND s.workspace.id= :workspaceId AND s.terminated = null\")\n+    Optional<Long> findIdByCrnAndWorkspaceId(@Param(\"crn\") String name, @Param(\"workspaceId\") Long workspaceId);", "originalCommit": "8c0453a33d44769f6c653fa7b79562a96fa80863", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk5NDE0Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/7194#discussion_r376994147", "bodyText": "Thanks, a nice catch! Done.", "author": "gergopapi2", "createdAt": "2020-02-10T10:59:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjkxMzY2Mw=="}], "type": "inlineReview", "revised_code": {"commit": "486d73376755c1a72d77f84271da1301a6aa6d66", "chunk": "diff --git a/core/src/main/java/com/sequenceiq/cloudbreak/repository/StackRepository.java b/core/src/main/java/com/sequenceiq/cloudbreak/repository/StackRepository.java\nindex 2b6a6cf5cb..e627eaaef0 100644\n--- a/core/src/main/java/com/sequenceiq/cloudbreak/repository/StackRepository.java\n+++ b/core/src/main/java/com/sequenceiq/cloudbreak/repository/StackRepository.java\n\n@@ -209,7 +209,7 @@ public interface StackRepository extends WorkspaceResourceRepository<Stack, Long\n \n     @DisableCheckPermissions\n     @Query(\"SELECT s.id FROM Stack s WHERE s.resourceCrn= :crn AND s.workspace.id= :workspaceId AND s.terminated = null\")\n-    Optional<Long> findIdByCrnAndWorkspaceId(@Param(\"crn\") String name, @Param(\"workspaceId\") Long workspaceId);\n+    Optional<Long> findIdByCrnAndWorkspaceId(@Param(\"crn\") String crn, @Param(\"workspaceId\") Long workspaceId);\n \n     @CheckPermissionsByWorkspaceId\n     @Query(\"SELECT s.id as id, \"\n"}}, {"oid": "486d73376755c1a72d77f84271da1301a6aa6d66", "url": "https://github.com/hortonworks/cloudbreak/commit/486d73376755c1a72d77f84271da1301a6aa6d66", "message": "CB-5240 Refactor byName and byCrn methods in StackService, StackCommonService, StackOperations", "committedDate": "2020-02-10T10:58:11Z", "type": "forcePushed"}, {"oid": "e1643bf58f6be5d7ce11dc9e04b886f4be7d5a4f", "url": "https://github.com/hortonworks/cloudbreak/commit/e1643bf58f6be5d7ce11dc9e04b886f4be7d5a4f", "message": "CB-5240 Refactor byName and byCrn methods in StackService, StackCommonService, StackOperations", "committedDate": "2020-02-10T15:39:45Z", "type": "forcePushed"}, {"oid": "d7c7c6cee2609db06bf2f3fe6afb484761f65774", "url": "https://github.com/hortonworks/cloudbreak/commit/d7c7c6cee2609db06bf2f3fe6afb484761f65774", "message": "CB-5240 Refactor byName and byCrn methods in StackService, StackCommonService, StackOperations", "committedDate": "2020-02-12T12:23:24Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODI1NDQ4Mg==", "url": "https://github.com/hortonworks/cloudbreak/pull/7194#discussion_r378254482", "bodyText": "small thing: why are you using toString here instead of name?", "author": "horadla23", "createdAt": "2020-02-12T13:38:33Z", "path": "core/src/main/java/com/sequenceiq/cloudbreak/service/upgrade/UpgradeService.java", "diffHunk": "@@ -74,18 +75,18 @@\n     @Inject\n     private TransactionService transactionService;\n \n-    public UpgradeOptionV4Response getUpgradeOptionByStackName(Long workspaceId, String stackName, User user) {\n+    public UpgradeOptionV4Response getUpgradeOptionByStackNameOrCrn(Long workspaceId, NameOrCrn nameOrCrn, User user) {\n         try {\n             return transactionService.required(() -> {\n-                Optional<Stack> stack = stackService.findStackByNameAndWorkspaceId(stackName, workspaceId);\n+                Optional<Stack> stack = stackService.findStackByNameOrCrnAndWorkspaceId(nameOrCrn, workspaceId);\n                 if (stack.isPresent()) {\n                     try {\n                         return getUpgradeOption(stack.get(), workspaceId, user);\n                     } catch (CloudbreakImageNotFoundException | CloudbreakImageCatalogException e) {\n                         throw new BadRequestException(e.getMessage());\n                     }\n                 } else {\n-                    throw notFoundException(\"Stack\", stackName);\n+                    throw notFoundException(\"Stack\", nameOrCrn.toString());", "originalCommit": "d7c7c6cee2609db06bf2f3fe6afb484761f65774", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTM2Mjg5NQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/7194#discussion_r379362895", "bodyText": "On this very place I need to use toString as nameOrCrn can hold either name or crn, it is not known statically. NameOrCrn object is passed to the method findStackByNameOrCrnAndWorkspaceId accepting both name and crn.", "author": "gergopapi2", "createdAt": "2020-02-14T10:41:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODI1NDQ4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTUyODAxNA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7194#discussion_r379528014", "bodyText": "@horadla23 Tests: I ran e2e aws tests locally:\ntestCreateScaleStopStartCluster\ntestSDXRepairIDBRokerWithStoppedEC2Instance", "author": "gergopapi2", "createdAt": "2020-02-14T16:34:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODI1NDQ4Mg=="}], "type": "inlineReview", "revised_code": {"commit": "77a0d341a7ee1c25a9477d8858ebe2ed2113c423", "chunk": "diff --git a/core/src/main/java/com/sequenceiq/cloudbreak/service/upgrade/UpgradeService.java b/core/src/main/java/com/sequenceiq/cloudbreak/service/upgrade/UpgradeService.java\nindex a95062625e..3243b52de8 100644\n--- a/core/src/main/java/com/sequenceiq/cloudbreak/service/upgrade/UpgradeService.java\n+++ b/core/src/main/java/com/sequenceiq/cloudbreak/service/upgrade/UpgradeService.java\n\n@@ -94,13 +95,12 @@ public class UpgradeService {\n         }\n     }\n \n-    public void upgradeByStackName(Long workspaceId, String stackName) {\n+    public FlowIdentifier upgradeByStackName(Long workspaceId, String stackName) {\n         try {\n-            transactionService.required(() -> {\n+            return transactionService.required(() -> {\n                 Optional<Stack> stack = stackService.findStackByNameAndWorkspaceId(stackName, workspaceId);\n                 if (stack.isPresent()) {\n-                    clusterRepairService.repairAll(stack.get().getId());\n-                    return null;\n+                    return clusterRepairService.repairAll(stack.get().getId());\n                 } else {\n                     throw notFoundException(\"Stack\", stackName);\n                 }\n"}}, {"oid": "cdb494ea7cfbbd23d1c49d136e33b3b365bc95a9", "url": "https://github.com/hortonworks/cloudbreak/commit/cdb494ea7cfbbd23d1c49d136e33b3b365bc95a9", "message": "CB-5240 Refactor byName and byCrn methods in StackService, StackCommonService, StackOperations", "committedDate": "2020-02-14T10:57:14Z", "type": "forcePushed"}, {"oid": "77a0d341a7ee1c25a9477d8858ebe2ed2113c423", "url": "https://github.com/hortonworks/cloudbreak/commit/77a0d341a7ee1c25a9477d8858ebe2ed2113c423", "message": "CB-5240 Refactor byName and byCrn methods in StackService, StackCommonService, StackOperations", "committedDate": "2020-02-19T09:18:38Z", "type": "commit"}, {"oid": "77a0d341a7ee1c25a9477d8858ebe2ed2113c423", "url": "https://github.com/hortonworks/cloudbreak/commit/77a0d341a7ee1c25a9477d8858ebe2ed2113c423", "message": "CB-5240 Refactor byName and byCrn methods in StackService, StackCommonService, StackOperations", "committedDate": "2020-02-19T09:18:38Z", "type": "forcePushed"}]}