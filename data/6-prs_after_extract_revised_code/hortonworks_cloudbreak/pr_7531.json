{"pr_number": 7531, "pr_title": "CDPCP-1635. User sync syncs all workload administration groups", "pr_createdAt": "2020-03-10T23:09:53Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/7531", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDc3OTIxMA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7531#discussion_r390779210", "bodyText": "This request can only be made with an internal actor CRN.", "author": "keyki", "createdAt": "2020-03-11T07:11:15Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/UmsUsersStateProvider.java", "diffHunk": "@@ -60,11 +60,16 @@\n             Map<String, FmsGroup> crnToFmsGroup = grpcUmsClient.listGroups(actorCrn, accountId, List.of(), requestIdOptional).stream()\n                     .collect(Collectors.toMap(Group::getCrn, this::umsGroupToGroup));\n \n+            Set<FmsGroup> wags = grpcUmsClient.listWorkloadAdministrationGroups(actorCrn, accountId, requestIdOptional).stream()", "originalCommit": "d2d3a3161acf2cc885c8b93ade43d88f8dcc6b22", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c521733ee2f0eb24df537559c4038f95ed82c15c", "chunk": "diff --git a/freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/UmsUsersStateProvider.java b/freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/UmsUsersStateProvider.java\nindex 6531a8800a..8d80808937 100644\n--- a/freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/UmsUsersStateProvider.java\n+++ b/freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/UmsUsersStateProvider.java\n\n@@ -60,7 +60,7 @@ public class UmsUsersStateProvider {\n             Map<String, FmsGroup> crnToFmsGroup = grpcUmsClient.listGroups(actorCrn, accountId, List.of(), requestIdOptional).stream()\n                     .collect(Collectors.toMap(Group::getCrn, this::umsGroupToGroup));\n \n-            Set<FmsGroup> wags = grpcUmsClient.listWorkloadAdministrationGroups(actorCrn, accountId, requestIdOptional).stream()\n+            Set<FmsGroup> wags = grpcUmsClient.listWorkloadAdministrationGroups(IAM_INTERNAL_ACTOR_CRN, accountId, requestIdOptional).stream()\n                     .map(wag -> nameToGroup(wag.getWorkloadAdministrationGroupName()))\n                     .collect(Collectors.toSet());\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDgzODgzMg==", "url": "https://github.com/hortonworks/cloudbreak/pull/7531#discussion_r390838832", "bodyText": "We can add mockCrnService.ensureInternalActor(); here", "author": "keyki", "createdAt": "2020-03-11T09:25:12Z", "path": "mock-caas/src/main/java/com/sequenceiq/caas/grpc/service/MockUserManagementService.java", "diffHunk": "@@ -629,6 +631,21 @@ public void deleteWorkloadAdministrationGroupName(UserManagementProto.DeleteWork\n         mockGroupManagementService.deleteWorkloadAdministrationGroupName(request, responseObserver);\n     }\n \n+    @Override\n+    public void listWorkloadAdministrationGroups(UserManagementProto.ListWorkloadAdministrationGroupsRequest request,\n+            StreamObserver<UserManagementProto.ListWorkloadAdministrationGroupsResponse> responseObserver) {\n+        responseObserver.onNext(UserManagementProto.ListWorkloadAdministrationGroupsResponse.newBuilder()", "originalCommit": "d2d3a3161acf2cc885c8b93ade43d88f8dcc6b22", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c521733ee2f0eb24df537559c4038f95ed82c15c", "chunk": "diff --git a/mock-caas/src/main/java/com/sequenceiq/caas/grpc/service/MockUserManagementService.java b/mock-caas/src/main/java/com/sequenceiq/caas/grpc/service/MockUserManagementService.java\nindex aa9ea56a0f..721fe55bc8 100644\n--- a/mock-caas/src/main/java/com/sequenceiq/caas/grpc/service/MockUserManagementService.java\n+++ b/mock-caas/src/main/java/com/sequenceiq/caas/grpc/service/MockUserManagementService.java\n\n@@ -634,6 +634,7 @@ public class MockUserManagementService extends UserManagementGrpc.UserManagement\n     @Override\n     public void listWorkloadAdministrationGroups(UserManagementProto.ListWorkloadAdministrationGroupsRequest request,\n             StreamObserver<UserManagementProto.ListWorkloadAdministrationGroupsResponse> responseObserver) {\n+        mockCrnService.ensureInternalActor();\n         responseObserver.onNext(UserManagementProto.ListWorkloadAdministrationGroupsResponse.newBuilder()\n                 .addWorkloadAdministrationGroup(\n                         UserManagementProto.WorkloadAdministrationGroup.newBuilder()\n"}}, {"oid": "c521733ee2f0eb24df537559c4038f95ed82c15c", "url": "https://github.com/hortonworks/cloudbreak/commit/c521733ee2f0eb24df537559c4038f95ed82c15c", "message": "CDPCP-1635. User sync syncs all workload administration groups", "committedDate": "2020-03-13T14:21:08Z", "type": "commit"}, {"oid": "c521733ee2f0eb24df537559c4038f95ed82c15c", "url": "https://github.com/hortonworks/cloudbreak/commit/c521733ee2f0eb24df537559c4038f95ed82c15c", "message": "CDPCP-1635. User sync syncs all workload administration groups", "committedDate": "2020-03-13T14:21:08Z", "type": "forcePushed"}]}