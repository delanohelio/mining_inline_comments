{"pr_number": 9167, "pr_title": "CB-9180 Freeipa install in GCP does not populate reverse DNS entries", "pr_createdAt": "2020-10-07T22:44:50Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/9167", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTQ4ODk0NA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9167#discussion_r501488944", "bodyText": "please remove these 2 comments, your commit message should be enough to identify why it's there", "author": "lacikaaa", "createdAt": "2020-10-08T06:58:27Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/stack/NetworkService.java", "diffHunk": "@@ -57,11 +57,13 @@\n                     // support for azure\n                     String[] splittedNetworkId = cloudNetwork.getId().split(\"/\");\n                     String cloudNetworkId = splittedNetworkId[splittedNetworkId.length - 1];\n-                    return networkId.equals(cloudNetworkId);\n+                    // CB-9180 For GCP user can pass network name as id", "originalCommit": "f5aa03fefa9f80d84f7d1697ffa28475af7ad917", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTkwOTQ3Mw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9167#discussion_r501909473", "bodyText": "Actually, I have a different opinion here. It is interesting that both are valid points from each perspective.\nA person who is reading that line of code, and click blame to read through my commit message. But a casual reader will miss that.\nTrue story, // support for azure is actually what made me stop and think about what might be going wrong in that function for GCP!", "author": "cegganesh84", "createdAt": "2020-10-08T17:58:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTQ4ODk0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjU1NjIzNQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9167#discussion_r502556235", "bodyText": "I have to say I would do it differently today, move that part to a method and give a meaningful name. If we add these comments to every part of the code then it will be outdated in a while etc. I still prefer avoiding comments as much as possible. Solving that issue and indicating with a comment was a mistake from my part.", "author": "lacikaaa", "createdAt": "2020-10-09T16:52:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTQ4ODk0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjU3NDIxMQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9167#discussion_r502574211", "bodyText": "Ok, I have removed those comments to move forward.", "author": "cegganesh84", "createdAt": "2020-10-09T17:27:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTQ4ODk0NA=="}], "type": "inlineReview", "revised_code": {"commit": "433ca87ad196c0081ad6253b9c3c0e34678d9569", "chunk": "diff --git a/freeipa/src/main/java/com/sequenceiq/freeipa/service/stack/NetworkService.java b/freeipa/src/main/java/com/sequenceiq/freeipa/service/stack/NetworkService.java\nindex c6baa19e16..5bf0f60196 100644\n--- a/freeipa/src/main/java/com/sequenceiq/freeipa/service/stack/NetworkService.java\n+++ b/freeipa/src/main/java/com/sequenceiq/freeipa/service/stack/NetworkService.java\n\n@@ -57,12 +57,10 @@ public class NetworkService {\n                     // support for azure\n                     String[] splittedNetworkId = cloudNetwork.getId().split(\"/\");\n                     String cloudNetworkId = splittedNetworkId[splittedNetworkId.length - 1];\n-                    // CB-9180 For GCP user can pass network name as id\n                     return networkId.equals(cloudNetworkId) || networkId.equals(cloudNetwork.getName());\n                 })\n                 .flatMap(cloudNetwork -> cloudNetwork.getSubnetsMeta().stream())\n                 .filter(cloudSubnet -> StringUtils.isNoneBlank(cloudSubnet.getId(), cloudSubnet.getCidr()))\n-                // CB-9180 For GCP user can pass subnet name as id\n                 .filter(cloudSubnet -> subnetIds.contains(cloudSubnet.getId()) || subnetIds.contains(cloudSubnet.getName()))\n                 .collect(Collectors.toMap(CloudSubnet::getId, CloudSubnet::getCidr));\n     }\n"}}, {"oid": "433ca87ad196c0081ad6253b9c3c0e34678d9569", "url": "https://github.com/hortonworks/cloudbreak/commit/433ca87ad196c0081ad6253b9c3c0e34678d9569", "message": "CB-9180 Freeipa install in GCP does not populate reverse DNS entries\n\n1. We accept the subnet name from the user for GCP.\n2. When we fetch the subnet information back from GCP, it gives internal subnet id.\n3. So make the subnet filtering logic in NetworkService similar to CloudNetworkService https://github.com/hortonworks/cloudbreak/blob/master/environment/src/main/java/com/sequenceiq/environment/network/CloudNetworkService.java#L130\n4. We saw that the jinja2 template picked the next argument as the reverse zone value if the zones is an empty list, fixed that part also.\n\nTested in private stack\n\n```\n$ ipa dnszone-find\n  Zone name: 114.10.in-addr.arpa.\n  Active zone: TRUE\n  Authoritative nameserver: ipaserver0.demo5.r6zv-kv2u.dev.cldr.work.\n  Administrator e-mail address: hostmaster.demo5.r6zv-kv2u.dev.cldr.work.\n  SOA serial: 1602118320\n  SOA refresh: 3600\n  SOA retry: 900\n  SOA expire: 1209600\n  SOA minimum: 3600\n  Allow query: any;\n  Allow transfer: none;\n\n  Zone name: demo5.r6zv-kv2u.dev.cldr.work.\n  Active zone: TRUE\n  Authoritative nameserver: ipaserver0.demo5.r6zv-kv2u.dev.cldr.work.\n  Administrator e-mail address: hostmaster.demo5.r6zv-kv2u.dev.cldr.work.\n  SOA serial: 1602118320\n  SOA refresh: 3600\n  SOA retry: 900\n  SOA expire: 1209600\n  SOA minimum: 3600\n  Allow query: any;\n  Allow transfer: none;\n----------------------------\nNumber of entries returned 2\n----------------------------\n```", "committedDate": "2020-10-09T17:26:48Z", "type": "forcePushed"}, {"oid": "b4623418856b3d6fdd24f6e3925213275f00be86", "url": "https://github.com/hortonworks/cloudbreak/commit/b4623418856b3d6fdd24f6e3925213275f00be86", "message": "CB-9180 Freeipa install in GCP does not populate reverse DNS entries\n\n1. We accept the subnet name from the user for GCP.\n2. When we fetch the subnet information back from GCP, it gives internal subnet id.\n3. So make the subnet filtering logic in NetworkService similar to CloudNetworkService https://github.com/hortonworks/cloudbreak/blob/master/environment/src/main/java/com/sequenceiq/environment/network/CloudNetworkService.java#L130\n4. We saw that the jinja2 template picked the next argument as the reverse zone value if the zones is an empty list, fixed that part also.\n\nTested in private stack\n\n```\n$ ipa dnszone-find\n  Zone name: 114.10.in-addr.arpa.\n  Active zone: TRUE\n  Authoritative nameserver: ipaserver0.demo5.r6zv-kv2u.dev.cldr.work.\n  Administrator e-mail address: hostmaster.demo5.r6zv-kv2u.dev.cldr.work.\n  SOA serial: 1602118320\n  SOA refresh: 3600\n  SOA retry: 900\n  SOA expire: 1209600\n  SOA minimum: 3600\n  Allow query: any;\n  Allow transfer: none;\n\n  Zone name: demo5.r6zv-kv2u.dev.cldr.work.\n  Active zone: TRUE\n  Authoritative nameserver: ipaserver0.demo5.r6zv-kv2u.dev.cldr.work.\n  Administrator e-mail address: hostmaster.demo5.r6zv-kv2u.dev.cldr.work.\n  SOA serial: 1602118320\n  SOA refresh: 3600\n  SOA retry: 900\n  SOA expire: 1209600\n  SOA minimum: 3600\n  Allow query: any;\n  Allow transfer: none;\n----------------------------\nNumber of entries returned 2\n----------------------------\n```", "committedDate": "2020-10-09T17:33:45Z", "type": "commit"}, {"oid": "b4623418856b3d6fdd24f6e3925213275f00be86", "url": "https://github.com/hortonworks/cloudbreak/commit/b4623418856b3d6fdd24f6e3925213275f00be86", "message": "CB-9180 Freeipa install in GCP does not populate reverse DNS entries\n\n1. We accept the subnet name from the user for GCP.\n2. When we fetch the subnet information back from GCP, it gives internal subnet id.\n3. So make the subnet filtering logic in NetworkService similar to CloudNetworkService https://github.com/hortonworks/cloudbreak/blob/master/environment/src/main/java/com/sequenceiq/environment/network/CloudNetworkService.java#L130\n4. We saw that the jinja2 template picked the next argument as the reverse zone value if the zones is an empty list, fixed that part also.\n\nTested in private stack\n\n```\n$ ipa dnszone-find\n  Zone name: 114.10.in-addr.arpa.\n  Active zone: TRUE\n  Authoritative nameserver: ipaserver0.demo5.r6zv-kv2u.dev.cldr.work.\n  Administrator e-mail address: hostmaster.demo5.r6zv-kv2u.dev.cldr.work.\n  SOA serial: 1602118320\n  SOA refresh: 3600\n  SOA retry: 900\n  SOA expire: 1209600\n  SOA minimum: 3600\n  Allow query: any;\n  Allow transfer: none;\n\n  Zone name: demo5.r6zv-kv2u.dev.cldr.work.\n  Active zone: TRUE\n  Authoritative nameserver: ipaserver0.demo5.r6zv-kv2u.dev.cldr.work.\n  Administrator e-mail address: hostmaster.demo5.r6zv-kv2u.dev.cldr.work.\n  SOA serial: 1602118320\n  SOA refresh: 3600\n  SOA retry: 900\n  SOA expire: 1209600\n  SOA minimum: 3600\n  Allow query: any;\n  Allow transfer: none;\n----------------------------\nNumber of entries returned 2\n----------------------------\n```", "committedDate": "2020-10-09T17:33:45Z", "type": "forcePushed"}]}