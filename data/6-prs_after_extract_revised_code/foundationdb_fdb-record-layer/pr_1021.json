{"pr_number": 1021, "pr_title": " Resolves #1020: Dangling sampled key read operation can log a lot", "pr_createdAt": "2020-08-20T14:24:12Z", "pr_url": "https://github.com/FoundationDB/fdb-record-layer/pull/1021", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE5Mzc4Mw==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/1021#discussion_r474193783", "bodyText": "Should this be an enum?", "author": "alecgrieser", "createdAt": "2020-08-20T18:39:35Z", "path": "fdb-extensions/src/main/java/com/apple/foundationdb/ErrorCodes.java", "diffHunk": "@@ -0,0 +1,181 @@\n+/*\n+ * ErrorCodes.java\n+ *\n+ * This source file is part of the FoundationDB open source project\n+ *\n+ * Copyright 2015-2020 Apple Inc. and the FoundationDB project authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.apple.foundationdb;\n+\n+import com.apple.foundationdb.annotation.API;\n+import com.google.common.collect.ImmutableMap;\n+\n+import javax.annotation.Nonnull;\n+import java.util.Map;\n+\n+/**\n+ * FDB error codes (from https://apple.github.io/foundationdb/api-error-codes.html) and handy methods to\n+ * interpret them.\n+ */\n+@API(API.Status.MAINTAINED)\n+public class ErrorCodes {", "originalCommit": "d2007f761e740201e95a27d94f22c84c97228043", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc2MTg4Mg==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/1021#discussion_r499761882", "bodyText": "@alecgrieser Sorry this has been stagnating so long.  I updated this to an enum.  It does have the benefit that we can later add other attributes to the error, but it does make other things a little more awkward - for example, there is no good way to represent an error code that we have never seen before.  But, I'm not unhappy with the change.", "author": "scgray", "createdAt": "2020-10-05T17:34:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE5Mzc4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQzOTI4OQ==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/1021#discussion_r500439289", "bodyText": "I think I like the enum better, though it kind of seems like this should really be an enum that lives in the Java bindings, but alas. The foundationdb project already has some automation that can generate C++ files based on these error definitions, so it seems like they should be able to generate this enum as well.\nThere's an alternative version of this change that resolves #1020 but doesn't try and fix the problem of error codes (partially to avoid having two changes in one PR and partially to avoid trying to argue on how the API should look). I'm happy enough with how this is, though.", "author": "alecgrieser", "createdAt": "2020-10-06T16:34:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE5Mzc4Mw=="}], "type": "inlineReview", "revised_code": {"commit": "e2063632058aee9a63b4d2097bf01baed3728ecb", "chunk": "diff --git a/fdb-extensions/src/main/java/com/apple/foundationdb/ErrorCodes.java b/fdb-extensions/src/main/java/com/apple/foundationdb/ErrorCodes.java\ndeleted file mode 100644\nindex 97f4b2ea..00000000\n--- a/fdb-extensions/src/main/java/com/apple/foundationdb/ErrorCodes.java\n+++ /dev/null\n\n@@ -1,181 +0,0 @@\n-/*\n- * ErrorCodes.java\n- *\n- * This source file is part of the FoundationDB open source project\n- *\n- * Copyright 2015-2020 Apple Inc. and the FoundationDB project authors\n- *\n- * Licensed under the Apache License, Version 2.0 (the \"License\");\n- * you may not use this file except in compliance with the License.\n- * You may obtain a copy of the License at\n- *\n- *     http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing, software\n- * distributed under the License is distributed on an \"AS IS\" BASIS,\n- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n- * See the License for the specific language governing permissions and\n- * limitations under the License.\n- */\n-\n-package com.apple.foundationdb;\n-\n-import com.apple.foundationdb.annotation.API;\n-import com.google.common.collect.ImmutableMap;\n-\n-import javax.annotation.Nonnull;\n-import java.util.Map;\n-\n-/**\n- * FDB error codes (from https://apple.github.io/foundationdb/api-error-codes.html) and handy methods to\n- * interpret them.\n- */\n-@API(API.Status.MAINTAINED)\n-public class ErrorCodes {\n-    public static final int SUCCESS = 0;\n-    public static final int OPERATION_FAILED = 1000;\n-    public static final int TIMED_OUT = 1004;\n-    public static final int TRANSACTION_TOO_OLD = 1007;\n-    public static final int FUTURE_VERSION = 1009;\n-    public static final int NOT_COMMITTED = 1020;\n-    public static final int COMMIT_UNKNOWN_RESULT = 1021;\n-    public static final int TRANSACTION_CANCELLED = 1025;\n-    public static final int TRANSACTION_TIMED_OUT = 1031;\n-    public static final int TOO_MANY_WATCHES = 1032;\n-    public static final int WATCHES_DISABLED = 1034;\n-    public static final int ACCESSED_UNREADABLE = 1036;\n-    public static final int PROCESS_BEHIND = 1037;\n-    public static final int DATABASE_LOCKED = 1038;\n-    public static final int CLUSTER_VERSION_CHANGED = 1039;\n-    public static final int EXTERNAL_CLIENT_ALREADY_LOADED = 1040;\n-    public static final int PROXY_MEMORY_LIMIT_EXCEEDED = 1042;\n-    public static final int OPERATION_CANCELLED = 1101;\n-    public static final int FUTURE_RELEASED = 1102;\n-    public static final int PLATFORM_ERROR = 1500;\n-    public static final int LARGE_ALLOC_FAILED = 1501;\n-    public static final int PERFORMANCE_COUNTER_ERROR = 1502;\n-    public static final int IO_ERROR = 1510;\n-    public static final int FILE_NOT_FOUND = 1511;\n-    public static final int BIND_FAILED = 1512;\n-    public static final int FILE_NOT_READABLE = 1513;\n-    public static final int FILE_NOT_WRITABLE = 1514;\n-    public static final int NO_CLUSTER_FILE_FOUND = 1515;\n-    public static final int FILE_TOO_LARGE = 1516;\n-    public static final int CLIENT_INVALID_OPERATION = 2000;\n-    public static final int COMMIT_READ_INCOMPLETE = 2002;\n-    public static final int TEST_SPECIFICATION_INVALID = 2003;\n-    public static final int KEY_OUTSIDE_LEGAL_RANGE = 2004;\n-    public static final int INVERTED_RANGE = 2005;\n-    public static final int INVALID_OPTION_VALUE = 2006;\n-    public static final int INVALID_OPTION = 2007;\n-    public static final int NETWORK_NOT_SETUP = 2008;\n-    public static final int NETWORK_ALREADY_SETUP = 2009;\n-    public static final int READ_VERSION_ALREADY_SET = 2010;\n-    public static final int VERSION_INVALID = 2011;\n-    public static final int RANGE_LIMITS_INVALID = 2012;\n-    public static final int INVALID_DATABASE_NAME = 2013;\n-    public static final int ATTRIBUTE_NOT_FOUND = 2014;\n-    public static final int FUTURE_NOT_SET = 2015;\n-    public static final int FUTURE_NOT_ERROR = 2016;\n-    public static final int USED_DURING_COMMIT = 2017;\n-    public static final int INVALID_MUTATION_TYPE = 2018;\n-    public static final int TRANSACTION_INVALID_VERSION = 2020;\n-    public static final int NO_COMMIT_VERSION = 2021;\n-    public static final int ENVIRONMENT_VARIABLE_NETWORK_OPTION_FAILED = 2022;\n-    public static final int TRANSACTION_READ_ONLY = 2023;\n-    public static final int INCOMPATIBLE_PROTOCOL_VERSION = 2100;\n-    public static final int TRANSACTION_TOO_LARGE = 2101;\n-    public static final int KEY_TOO_LARGE = 2102;\n-    public static final int VALUE_TOO_LARGE = 2103;\n-    public static final int CONNECTION_STRING_INVALID = 2104;\n-    public static final int ADDRESS_IN_USE = 2105;\n-    public static final int INVALID_LOCAL_ADDRESS = 2106;\n-    public static final int TLS_ERROR = 2107;\n-    public static final int UNSUPPORTED_OPERATION = 2108;\n-    public static final int API_VERSION_UNSET = 2200;\n-    public static final int API_VERSION_ALREADY_SET = 2201;\n-    public static final int API_VERSION_INVALID = 2202;\n-    public static final int API_VERSION_NOT_SUPPORTED = 2203;\n-    public static final int EXACT_MODE_WITHOUT_LIMITS = 2210;\n-    public static final int UNKNOWN_ERROR = 4000;\n-    public static final int INTERNAL_ERROR = 4100;\n-\n-    private static final Map<Integer, String> ERROR_TEXTMAP = new ImmutableMap.Builder<Integer, String>()\n-            .put(0, \"SUCCESS\")\n-            .put(1000, \"OPERATION_FAILED\")\n-            .put(1004, \"TIMED_OUT\")\n-            .put(1007, \"TRANSACTION_TOO_OLD\")\n-            .put(1009, \"FUTURE_VERSION\")\n-            .put(1020, \"NOT_COMMITTED\")\n-            .put(1021, \"COMMIT_UNKNOWN_RESULT\")\n-            .put(1025, \"TRANSACTION_CANCELLED\")\n-            .put(1031, \"TRANSACTION_TIMED_OUT\")\n-            .put(1032, \"TOO_MANY_WATCHES\")\n-            .put(1034, \"WATCHES_DISABLED\")\n-            .put(1036, \"ACCESSED_UNREADABLE\")\n-            .put(1037, \"PROCESS_BEHIND\")\n-            .put(1038, \"DATABASE_LOCKED\")\n-            .put(1039, \"CLUSTER_VERSION_CHANGED\")\n-            .put(1040, \"EXTERNAL_CLIENT_ALREADY_LOADED\")\n-            .put(1042, \"PROXY_MEMORY_LIMIT_EXCEEDED\")\n-            .put(1101, \"OPERATION_CANCELLED\")\n-            .put(1102, \"FUTURE_RELEASED\")\n-            .put(1500, \"PLATFORM_ERROR\")\n-            .put(1501, \"LARGE_ALLOC_FAILED\")\n-            .put(1502, \"PERFORMANCE_COUNTER_ERROR\")\n-            .put(1510, \"IO_ERROR\")\n-            .put(1511, \"FILE_NOT_FOUND\")\n-            .put(1512, \"BIND_FAILED\")\n-            .put(1513, \"FILE_NOT_READABLE\")\n-            .put(1514, \"FILE_NOT_WRITABLE\")\n-            .put(1515, \"NO_CLUSTER_FILE_FOUND\")\n-            .put(1516, \"FILE_TOO_LARGE\")\n-            .put(2000, \"CLIENT_INVALID_OPERATION\")\n-            .put(2002, \"COMMIT_READ_INCOMPLETE\")\n-            .put(2003, \"TEST_SPECIFICATION_INVALID\")\n-            .put(2004, \"KEY_OUTSIDE_LEGAL_RANGE\")\n-            .put(2005, \"INVERTED_RANGE\")\n-            .put(2006, \"INVALID_OPTION_VALUE\")\n-            .put(2007, \"INVALID_OPTION\")\n-            .put(2008, \"NETWORK_NOT_SETUP\")\n-            .put(2009, \"NETWORK_ALREADY_SETUP\")\n-            .put(2010, \"READ_VERSION_ALREADY_SET\")\n-            .put(2011, \"VERSION_INVALID\")\n-            .put(2012, \"RANGE_LIMITS_INVALID\")\n-            .put(2013, \"INVALID_DATABASE_NAME\")\n-            .put(2014, \"ATTRIBUTE_NOT_FOUND\")\n-            .put(2015, \"FUTURE_NOT_SET\")\n-            .put(2016, \"FUTURE_NOT_ERROR\")\n-            .put(2017, \"USED_DURING_COMMIT\")\n-            .put(2018, \"INVALID_MUTATION_TYPE\")\n-            .put(2020, \"TRANSACTION_INVALID_VERSION\")\n-            .put(2021, \"NO_COMMIT_VERSION\")\n-            .put(2022, \"ENVIRONMENT_VARIABLE_NETWORK_OPTION_FAILED\")\n-            .put(2023, \"TRANSACTION_READ_ONLY\")\n-            .put(2100, \"INCOMPATIBLE_PROTOCOL_VERSION\")\n-            .put(2101, \"TRANSACTION_TOO_LARGE\")\n-            .put(2102, \"KEY_TOO_LARGE\")\n-            .put(2103, \"VALUE_TOO_LARGE\")\n-            .put(2104, \"CONNECTION_STRING_INVALID\")\n-            .put(2105, \"ADDRESS_IN_USE\")\n-            .put(2106, \"INVALID_LOCAL_ADDRESS\")\n-            .put(2107, \"TLS_ERROR\")\n-            .put(2108, \"UNSUPPORTED_OPERATION\")\n-            .put(2200, \"API_VERSION_UNSET\")\n-            .put(2201, \"API_VERSION_ALREADY_SET\")\n-            .put(2202, \"API_VERSION_INVALID\")\n-            .put(2203, \"API_VERSION_NOT_SUPPORTED\")\n-            .put(2210, \"EXACT_MODE_WITHOUT_LIMITS\")\n-            .put(4000, \"UNKNOWN_ERROR\")\n-            .put(4100, \"INTERNAL_ERROR\")\n-            .build();\n-\n-    @Nonnull\n-    public static String toString(int errorCode) {\n-        final String text = ERROR_TEXTMAP.get(errorCode);\n-        if (text == null) {\n-            return \"UNKNOWN(\" + errorCode + \")\";\n-        }\n-        return text;\n-    }\n-}\n"}}, {"oid": "1a4f5e64230492ba1b78b0dc5ab832ea02e89461", "url": "https://github.com/FoundationDB/fdb-record-layer/commit/1a4f5e64230492ba1b78b0dc5ab832ea02e89461", "message": "Resolves #1020: Dangling sampled key read operation can log a lot", "committedDate": "2020-10-05T16:11:24Z", "type": "commit"}, {"oid": "c6f1b3fe9a4701954214d5f7f1837d0581786254", "url": "https://github.com/FoundationDB/fdb-record-layer/commit/c6f1b3fe9a4701954214d5f7f1837d0581786254", "message": "Use symbolic error codes when possible", "committedDate": "2020-10-05T16:11:24Z", "type": "commit"}, {"oid": "e2063632058aee9a63b4d2097bf01baed3728ecb", "url": "https://github.com/FoundationDB/fdb-record-layer/commit/e2063632058aee9a63b4d2097bf01baed3728ecb", "message": "Change to enum", "committedDate": "2020-10-05T17:32:32Z", "type": "forcePushed"}, {"oid": "79d9770d15177efdf145b0224b0c709f42eb17d8", "url": "https://github.com/FoundationDB/fdb-record-layer/commit/79d9770d15177efdf145b0224b0c709f42eb17d8", "message": "Change to ErrorCodes class to FDBError enum", "committedDate": "2020-10-07T14:39:28Z", "type": "forcePushed"}, {"oid": "3e43051ee29529c8f859453fcce1d4a9635d11df", "url": "https://github.com/FoundationDB/fdb-record-layer/commit/3e43051ee29529c8f859453fcce1d4a9635d11df", "message": "Change to ErrorCodes class to FDBError enum", "committedDate": "2020-10-07T21:17:26Z", "type": "commit"}, {"oid": "3e43051ee29529c8f859453fcce1d4a9635d11df", "url": "https://github.com/FoundationDB/fdb-record-layer/commit/3e43051ee29529c8f859453fcce1d4a9635d11df", "message": "Change to ErrorCodes class to FDBError enum", "committedDate": "2020-10-07T21:17:26Z", "type": "forcePushed"}]}