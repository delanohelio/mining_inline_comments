{"pr_number": 1069, "pr_title": "Resolves #1068: Could allow degenerate composed bitmaps from single index", "pr_createdAt": "2020-11-11T22:40:45Z", "pr_url": "https://github.com/FoundationDB/fdb-record-layer/pull/1069", "timeline": [{"oid": "31edd502b56e18c8eda189ff111dd2a26cb91e5b", "url": "https://github.com/FoundationDB/fdb-record-layer/commit/31edd502b56e18c8eda189ff111dd2a26cb91e5b", "message": "Resolves #1068: Could allow degenerate composed bitmaps from single index", "committedDate": "2020-11-11T22:39:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY4MTc2MA==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/1069#discussion_r521681760", "bodyText": "I believe that an earlier review of this class suggested that this was a more appropriate signature. It didn't matter then, but it does now.", "author": "MMcM", "createdAt": "2020-11-11T22:41:24Z", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/query/plan/bitmap/ComposedBitmapIndexAggregate.java", "diffHunk": "@@ -82,9 +83,9 @@\n      * @return an {@code Optional} query plan or {@code Optional.empty} if planning is not possible\n      */\n     @Nonnull\n-    public static Optional<ComposedBitmapIndexQueryPlan> tryPlan(@Nonnull RecordQueryPlanner planner,\n-                                                                 @Nonnull RecordQuery query,\n-                                                                 @Nonnull IndexAggregateFunction indexAggregateFunction) {\n+    public static Optional<RecordQueryPlan> tryPlan(@Nonnull RecordQueryPlanner planner,", "originalCommit": "31edd502b56e18c8eda189ff111dd2a26cb91e5b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTcwMTE2MA==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/1069#discussion_r521701160", "bodyText": "I guess this class doesn't have an API stability annotation. It kind of feels like it should have been marked experimental, but alas. Not sure how much of a stickler we want to be here. My inclination here is to just let the signature be changed.", "author": "alecgrieser", "createdAt": "2020-11-11T23:29:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY4MTc2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTc4NjEwNg==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/1069#discussion_r521786106", "bodyText": "Somehow half the classes in this package are annotated and the other half is not. I made them all experimental, which I believe was the intention.", "author": "MMcM", "createdAt": "2020-11-12T02:56:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY4MTc2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ2NjQ0OQ==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/1069#discussion_r522466449", "bodyText": "Yeah, that sounds right", "author": "alecgrieser", "createdAt": "2020-11-12T22:19:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY4MTc2MA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTcwMDY3MQ==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/1069#discussion_r521700671", "bodyText": "Is this correct if there's a NOT in the composer tree against a single index scan?\nAlso, separately, without this change, would it have returned a ComposedBitmapIndexQueryPlan with a single IndexNode in the tree (which I think is correct, but perhaps inefficient), or would it have returned something less good?", "author": "alecgrieser", "createdAt": "2020-11-11T23:28:23Z", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/query/plan/bitmap/ComposedBitmapIndexAggregate.java", "diffHunk": "@@ -99,12 +100,18 @@\n      * @return an {@code Optional} query plan or {@code Optional.empty} if planning is not possible\n      */\n     @Nonnull\n-    public Optional<ComposedBitmapIndexQueryPlan> tryPlan(@Nonnull RecordQueryPlanner planner,\n-                                                          @Nonnull RecordQuery.Builder queryBuilder) {\n+    public Optional<RecordQueryPlan> tryPlan(@Nonnull RecordQueryPlanner planner,\n+                                             @Nonnull RecordQuery.Builder queryBuilder) {\n         final List<RecordQueryCoveringIndexPlan> indexScans = new ArrayList<>();\n         final Map<IndexNode, ComposedBitmapIndexQueryPlan.IndexComposer> indexComposers = new IdentityHashMap<>();\n-        return Optional.ofNullable(plan(root, queryBuilder, planner, indexScans, indexComposers))\n-                .map(composer -> new ComposedBitmapIndexQueryPlan(indexScans, composer));\n+        final ComposedBitmapIndexQueryPlan.ComposerBase composer = plan(root, queryBuilder, planner, indexScans, indexComposers);\n+        if (composer == null || indexScans.isEmpty()) {\n+            return Optional.empty();\n+        }\n+        if (indexScans.size() == 1) {\n+            return Optional.ofNullable(indexScans.get(0));", "originalCommit": "31edd502b56e18c8eda189ff111dd2a26cb91e5b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTc4MDM4NA==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/1069#discussion_r521780384", "bodyText": "It would have given an error, insisting that there be more than one child.", "author": "MMcM", "createdAt": "2020-11-12T02:36:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTcwMDY3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTc4NjQwOA==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/1069#discussion_r521786408", "bodyText": "I added a check to make sure the composer is trivial (pass through the index). It might be possible to get NOT to work in this case, but it doesn't look like it would today, even if the composer were given a chance.", "author": "MMcM", "createdAt": "2020-11-12T02:58:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTcwMDY3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ2Nzk1Mw==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/1069#discussion_r522467953", "bodyText": "Okay, sounds good. I suppose it would be nice if NOT planned correctly, but having it fail to plan is fine (but having it return the wrong plan would have seemed dangerous).", "author": "alecgrieser", "createdAt": "2020-11-12T22:21:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTcwMDY3MQ=="}], "type": "inlineReview", "revised_code": {"commit": "f1bf17f08cd6ba9a2d3310a674d099435ba8fa26", "chunk": "diff --git a/fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/query/plan/bitmap/ComposedBitmapIndexAggregate.java b/fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/query/plan/bitmap/ComposedBitmapIndexAggregate.java\nindex 1e3cca8d..6f2930c9 100644\n--- a/fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/query/plan/bitmap/ComposedBitmapIndexAggregate.java\n+++ b/fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/query/plan/bitmap/ComposedBitmapIndexAggregate.java\n\n@@ -109,7 +111,11 @@ public class ComposedBitmapIndexAggregate {\n             return Optional.empty();\n         }\n         if (indexScans.size() == 1) {\n-            return Optional.ofNullable(indexScans.get(0));\n+            if (composer instanceof ComposedBitmapIndexQueryPlan.IndexComposer) {\n+                return Optional.ofNullable(indexScans.get(0));\n+            } else {\n+                return Optional.empty();\n+            }\n         }\n         return Optional.of(new ComposedBitmapIndexQueryPlan(indexScans, composer));\n     }\n"}}, {"oid": "f1bf17f08cd6ba9a2d3310a674d099435ba8fa26", "url": "https://github.com/FoundationDB/fdb-record-layer/commit/f1bf17f08cd6ba9a2d3310a674d099435ba8fa26", "message": "Add missing annotations", "committedDate": "2020-11-12T02:56:00Z", "type": "commit"}]}