{"pr_number": 5419, "pr_title": "Better support for implied ports on ForwardedRequestCustomizer", "pr_createdAt": "2020-10-09T14:55:51Z", "pr_url": "https://github.com/eclipse/jetty.project/pull/5419", "timeline": [{"oid": "149f389fd8a2e5f82511ceb492220edbf96839d8", "url": "https://github.com/eclipse/jetty.project/commit/149f389fd8a2e5f82511ceb492220edbf96839d8", "message": "Issue #5417 - Honoring implied ports on ForwardedRequestCustomizer better\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>", "committedDate": "2020-10-09T14:54:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzE2ODQ0MA==", "url": "https://github.com/eclipse/jetty.project/pull/5419#discussion_r503168440", "bodyText": "remove this comment", "author": "gregw", "createdAt": "2020-10-12T09:38:06Z", "path": "jetty-server/src/test/java/org/eclipse/jetty/server/ForwardedRequestCustomizerTest.java", "diffHunk": "@@ -783,6 +794,71 @@ public void testConfiguredBehavior(Request request, Expectations expectations) t\n         expectations.accept(actual);\n     }\n \n+    public static Stream<Arguments> nonStandardPortCases()\n+    {\n+        return Stream.of(\n+            // RFC7239 Tests with https.\n+            Arguments.of(new Request(\"RFC7239 with https and h2\")\n+                    .headers(\n+                        \"GET /test/forwarded.jsp HTTP/1.1\",\n+                        \"Host: web.euro.de\",\n+                        \"Forwarded: for=192.168.2.6;host=web.euro.de;proto=https;proto-version=h2\"\n+                        // Client: https://web.euro.de/test/forwarded.jsp", "originalCommit": "149f389fd8a2e5f82511ceb492220edbf96839d8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c2266fdd63dea082dc83fc2ab031867d1d83ecc9", "chunk": "diff --git a/jetty-server/src/test/java/org/eclipse/jetty/server/ForwardedRequestCustomizerTest.java b/jetty-server/src/test/java/org/eclipse/jetty/server/ForwardedRequestCustomizerTest.java\nindex 3b34209ff1..d425e894c1 100644\n--- a/jetty-server/src/test/java/org/eclipse/jetty/server/ForwardedRequestCustomizerTest.java\n+++ b/jetty-server/src/test/java/org/eclipse/jetty/server/ForwardedRequestCustomizerTest.java\n\n@@ -801,40 +792,38 @@ public class ForwardedRequestCustomizerTest\n             Arguments.of(new Request(\"RFC7239 with https and h2\")\n                     .headers(\n                         \"GET /test/forwarded.jsp HTTP/1.1\",\n-                        \"Host: web.euro.de\",\n-                        \"Forwarded: for=192.168.2.6;host=web.euro.de;proto=https;proto-version=h2\"\n-                        // Client: https://web.euro.de/test/forwarded.jsp\n+                        \"Host: web.example.net\",\n+                        \"Forwarded: for=192.168.2.6;host=web.example.net;proto=https;proto-version=h2\"\n                     ),\n                 new Expectations()\n-                    .scheme(\"https\").serverName(\"web.euro.de\").serverPort(443)\n-                    .requestURL(\"https://web.euro.de/test/forwarded.jsp\")\n+                    .scheme(\"https\").serverName(\"web.example.net\").serverPort(443)\n+                    .requestURL(\"https://web.example.net/test/forwarded.jsp\")\n                     .remoteAddr(\"192.168.2.6\").remotePort(0)\n             ),\n             // RFC7239 Tests with https and proxy provided port\n             Arguments.of(new Request(\"RFC7239 with proxy provided port on https and h2\")\n                     .headers(\n                         \"GET /test/forwarded.jsp HTTP/1.1\",\n-                        \"Host: web.euro.de:9443\",\n-                        \"Forwarded: for=192.168.2.6;host=web.euro.de:9443;proto=https;proto-version=h2\"\n-                        // Client: https://web.euro.de:9443/test/forwarded.jsp\n+                        \"Host: web.example.net:9443\",\n+                        \"Forwarded: for=192.168.2.6;host=web.example.net:9443;proto=https;proto-version=h2\"\n                     ),\n                 new Expectations()\n-                    .scheme(\"https\").serverName(\"web.euro.de\").serverPort(9443)\n-                    .requestURL(\"https://web.euro.de:9443/test/forwarded.jsp\")\n+                    .scheme(\"https\").serverName(\"web.example.net\").serverPort(9443)\n+                    .requestURL(\"https://web.example.net:9443/test/forwarded.jsp\")\n                     .remoteAddr(\"192.168.2.6\").remotePort(0)\n             ),\n             // RFC7239 Tests with https, no port in Host, but proxy provided port\n             Arguments.of(new Request(\"RFC7239 with client provided host and different proxy provided port on https and h2\")\n                     .headers(\n                         \"GET /test/forwarded.jsp HTTP/1.1\",\n-                        \"Host: web.euro.de\",\n-                        \"Forwarded: for=192.168.2.6;host=new.euro.de:7443;proto=https;proto-version=h2\"\n-                        // Client: https://web.euro.de/test/forwarded.jsp\n-                        // Proxy Requests: https://new.euro.de/test/forwarded.jsp\n+                        \"Host: web.example.net\",\n+                        \"Forwarded: for=192.168.2.6;host=new.example.net:7443;proto=https;proto-version=h2\"\n+                        // Client: https://web.example.net/test/forwarded.jsp\n+                        // Proxy Requests: https://new.example.net/test/forwarded.jsp\n                     ),\n                 new Expectations()\n-                    .scheme(\"https\").serverName(\"new.euro.de\").serverPort(7443)\n-                    .requestURL(\"https://new.euro.de:7443/test/forwarded.jsp\")\n+                    .scheme(\"https\").serverName(\"new.example.net\").serverPort(7443)\n+                    .requestURL(\"https://new.example.net:7443/test/forwarded.jsp\")\n                     .remoteAddr(\"192.168.2.6\").remotePort(0)\n             )\n         );\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzE2ODU1OQ==", "url": "https://github.com/eclipse/jetty.project/pull/5419#discussion_r503168559", "bodyText": "remove this comment", "author": "gregw", "createdAt": "2020-10-12T09:38:18Z", "path": "jetty-server/src/test/java/org/eclipse/jetty/server/ForwardedRequestCustomizerTest.java", "diffHunk": "@@ -783,6 +794,71 @@ public void testConfiguredBehavior(Request request, Expectations expectations) t\n         expectations.accept(actual);\n     }\n \n+    public static Stream<Arguments> nonStandardPortCases()\n+    {\n+        return Stream.of(\n+            // RFC7239 Tests with https.\n+            Arguments.of(new Request(\"RFC7239 with https and h2\")\n+                    .headers(\n+                        \"GET /test/forwarded.jsp HTTP/1.1\",\n+                        \"Host: web.euro.de\",\n+                        \"Forwarded: for=192.168.2.6;host=web.euro.de;proto=https;proto-version=h2\"\n+                        // Client: https://web.euro.de/test/forwarded.jsp\n+                    ),\n+                new Expectations()\n+                    .scheme(\"https\").serverName(\"web.euro.de\").serverPort(443)\n+                    .requestURL(\"https://web.euro.de/test/forwarded.jsp\")\n+                    .remoteAddr(\"192.168.2.6\").remotePort(0)\n+            ),\n+            // RFC7239 Tests with https and proxy provided port\n+            Arguments.of(new Request(\"RFC7239 with proxy provided port on https and h2\")\n+                    .headers(\n+                        \"GET /test/forwarded.jsp HTTP/1.1\",\n+                        \"Host: web.euro.de:9443\",\n+                        \"Forwarded: for=192.168.2.6;host=web.euro.de:9443;proto=https;proto-version=h2\"\n+                        // Client: https://web.euro.de:9443/test/forwarded.jsp", "originalCommit": "149f389fd8a2e5f82511ceb492220edbf96839d8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c2266fdd63dea082dc83fc2ab031867d1d83ecc9", "chunk": "diff --git a/jetty-server/src/test/java/org/eclipse/jetty/server/ForwardedRequestCustomizerTest.java b/jetty-server/src/test/java/org/eclipse/jetty/server/ForwardedRequestCustomizerTest.java\nindex 3b34209ff1..d425e894c1 100644\n--- a/jetty-server/src/test/java/org/eclipse/jetty/server/ForwardedRequestCustomizerTest.java\n+++ b/jetty-server/src/test/java/org/eclipse/jetty/server/ForwardedRequestCustomizerTest.java\n\n@@ -801,40 +792,38 @@ public class ForwardedRequestCustomizerTest\n             Arguments.of(new Request(\"RFC7239 with https and h2\")\n                     .headers(\n                         \"GET /test/forwarded.jsp HTTP/1.1\",\n-                        \"Host: web.euro.de\",\n-                        \"Forwarded: for=192.168.2.6;host=web.euro.de;proto=https;proto-version=h2\"\n-                        // Client: https://web.euro.de/test/forwarded.jsp\n+                        \"Host: web.example.net\",\n+                        \"Forwarded: for=192.168.2.6;host=web.example.net;proto=https;proto-version=h2\"\n                     ),\n                 new Expectations()\n-                    .scheme(\"https\").serverName(\"web.euro.de\").serverPort(443)\n-                    .requestURL(\"https://web.euro.de/test/forwarded.jsp\")\n+                    .scheme(\"https\").serverName(\"web.example.net\").serverPort(443)\n+                    .requestURL(\"https://web.example.net/test/forwarded.jsp\")\n                     .remoteAddr(\"192.168.2.6\").remotePort(0)\n             ),\n             // RFC7239 Tests with https and proxy provided port\n             Arguments.of(new Request(\"RFC7239 with proxy provided port on https and h2\")\n                     .headers(\n                         \"GET /test/forwarded.jsp HTTP/1.1\",\n-                        \"Host: web.euro.de:9443\",\n-                        \"Forwarded: for=192.168.2.6;host=web.euro.de:9443;proto=https;proto-version=h2\"\n-                        // Client: https://web.euro.de:9443/test/forwarded.jsp\n+                        \"Host: web.example.net:9443\",\n+                        \"Forwarded: for=192.168.2.6;host=web.example.net:9443;proto=https;proto-version=h2\"\n                     ),\n                 new Expectations()\n-                    .scheme(\"https\").serverName(\"web.euro.de\").serverPort(9443)\n-                    .requestURL(\"https://web.euro.de:9443/test/forwarded.jsp\")\n+                    .scheme(\"https\").serverName(\"web.example.net\").serverPort(9443)\n+                    .requestURL(\"https://web.example.net:9443/test/forwarded.jsp\")\n                     .remoteAddr(\"192.168.2.6\").remotePort(0)\n             ),\n             // RFC7239 Tests with https, no port in Host, but proxy provided port\n             Arguments.of(new Request(\"RFC7239 with client provided host and different proxy provided port on https and h2\")\n                     .headers(\n                         \"GET /test/forwarded.jsp HTTP/1.1\",\n-                        \"Host: web.euro.de\",\n-                        \"Forwarded: for=192.168.2.6;host=new.euro.de:7443;proto=https;proto-version=h2\"\n-                        // Client: https://web.euro.de/test/forwarded.jsp\n-                        // Proxy Requests: https://new.euro.de/test/forwarded.jsp\n+                        \"Host: web.example.net\",\n+                        \"Forwarded: for=192.168.2.6;host=new.example.net:7443;proto=https;proto-version=h2\"\n+                        // Client: https://web.example.net/test/forwarded.jsp\n+                        // Proxy Requests: https://new.example.net/test/forwarded.jsp\n                     ),\n                 new Expectations()\n-                    .scheme(\"https\").serverName(\"new.euro.de\").serverPort(7443)\n-                    .requestURL(\"https://new.euro.de:7443/test/forwarded.jsp\")\n+                    .scheme(\"https\").serverName(\"new.example.net\").serverPort(7443)\n+                    .requestURL(\"https://new.example.net:7443/test/forwarded.jsp\")\n                     .remoteAddr(\"192.168.2.6\").remotePort(0)\n             )\n         );\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzE2OTAwNg==", "url": "https://github.com/eclipse/jetty.project/pull/5419#discussion_r503169006", "bodyText": "Use another domain name like web.example.org", "author": "gregw", "createdAt": "2020-10-12T09:38:55Z", "path": "jetty-server/src/test/java/org/eclipse/jetty/server/ForwardedRequestCustomizerTest.java", "diffHunk": "@@ -783,6 +794,71 @@ public void testConfiguredBehavior(Request request, Expectations expectations) t\n         expectations.accept(actual);\n     }\n \n+    public static Stream<Arguments> nonStandardPortCases()\n+    {\n+        return Stream.of(\n+            // RFC7239 Tests with https.\n+            Arguments.of(new Request(\"RFC7239 with https and h2\")\n+                    .headers(\n+                        \"GET /test/forwarded.jsp HTTP/1.1\",\n+                        \"Host: web.euro.de\",", "originalCommit": "149f389fd8a2e5f82511ceb492220edbf96839d8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c2266fdd63dea082dc83fc2ab031867d1d83ecc9", "chunk": "diff --git a/jetty-server/src/test/java/org/eclipse/jetty/server/ForwardedRequestCustomizerTest.java b/jetty-server/src/test/java/org/eclipse/jetty/server/ForwardedRequestCustomizerTest.java\nindex 3b34209ff1..d425e894c1 100644\n--- a/jetty-server/src/test/java/org/eclipse/jetty/server/ForwardedRequestCustomizerTest.java\n+++ b/jetty-server/src/test/java/org/eclipse/jetty/server/ForwardedRequestCustomizerTest.java\n\n@@ -801,40 +792,38 @@ public class ForwardedRequestCustomizerTest\n             Arguments.of(new Request(\"RFC7239 with https and h2\")\n                     .headers(\n                         \"GET /test/forwarded.jsp HTTP/1.1\",\n-                        \"Host: web.euro.de\",\n-                        \"Forwarded: for=192.168.2.6;host=web.euro.de;proto=https;proto-version=h2\"\n-                        // Client: https://web.euro.de/test/forwarded.jsp\n+                        \"Host: web.example.net\",\n+                        \"Forwarded: for=192.168.2.6;host=web.example.net;proto=https;proto-version=h2\"\n                     ),\n                 new Expectations()\n-                    .scheme(\"https\").serverName(\"web.euro.de\").serverPort(443)\n-                    .requestURL(\"https://web.euro.de/test/forwarded.jsp\")\n+                    .scheme(\"https\").serverName(\"web.example.net\").serverPort(443)\n+                    .requestURL(\"https://web.example.net/test/forwarded.jsp\")\n                     .remoteAddr(\"192.168.2.6\").remotePort(0)\n             ),\n             // RFC7239 Tests with https and proxy provided port\n             Arguments.of(new Request(\"RFC7239 with proxy provided port on https and h2\")\n                     .headers(\n                         \"GET /test/forwarded.jsp HTTP/1.1\",\n-                        \"Host: web.euro.de:9443\",\n-                        \"Forwarded: for=192.168.2.6;host=web.euro.de:9443;proto=https;proto-version=h2\"\n-                        // Client: https://web.euro.de:9443/test/forwarded.jsp\n+                        \"Host: web.example.net:9443\",\n+                        \"Forwarded: for=192.168.2.6;host=web.example.net:9443;proto=https;proto-version=h2\"\n                     ),\n                 new Expectations()\n-                    .scheme(\"https\").serverName(\"web.euro.de\").serverPort(9443)\n-                    .requestURL(\"https://web.euro.de:9443/test/forwarded.jsp\")\n+                    .scheme(\"https\").serverName(\"web.example.net\").serverPort(9443)\n+                    .requestURL(\"https://web.example.net:9443/test/forwarded.jsp\")\n                     .remoteAddr(\"192.168.2.6\").remotePort(0)\n             ),\n             // RFC7239 Tests with https, no port in Host, but proxy provided port\n             Arguments.of(new Request(\"RFC7239 with client provided host and different proxy provided port on https and h2\")\n                     .headers(\n                         \"GET /test/forwarded.jsp HTTP/1.1\",\n-                        \"Host: web.euro.de\",\n-                        \"Forwarded: for=192.168.2.6;host=new.euro.de:7443;proto=https;proto-version=h2\"\n-                        // Client: https://web.euro.de/test/forwarded.jsp\n-                        // Proxy Requests: https://new.euro.de/test/forwarded.jsp\n+                        \"Host: web.example.net\",\n+                        \"Forwarded: for=192.168.2.6;host=new.example.net:7443;proto=https;proto-version=h2\"\n+                        // Client: https://web.example.net/test/forwarded.jsp\n+                        // Proxy Requests: https://new.example.net/test/forwarded.jsp\n                     ),\n                 new Expectations()\n-                    .scheme(\"https\").serverName(\"new.euro.de\").serverPort(7443)\n-                    .requestURL(\"https://new.euro.de:7443/test/forwarded.jsp\")\n+                    .scheme(\"https\").serverName(\"new.example.net\").serverPort(7443)\n+                    .requestURL(\"https://new.example.net:7443/test/forwarded.jsp\")\n                     .remoteAddr(\"192.168.2.6\").remotePort(0)\n             )\n         );\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzE2OTIwOA==", "url": "https://github.com/eclipse/jetty.project/pull/5419#discussion_r503169208", "bodyText": "I wonder why we are setting the input buffer  size in this test?", "author": "gregw", "createdAt": "2020-10-12T09:39:16Z", "path": "jetty-server/src/test/java/org/eclipse/jetty/server/ForwardedRequestCustomizerTest.java", "diffHunk": "@@ -82,6 +84,15 @@ public void init() throws Exception\n         connector = new LocalConnector(server, http);\n         server.addConnector(connector);\n \n+        // Alternate behavior Connector\n+        HttpConnectionFactory httpAlt = new HttpConnectionFactory();\n+        httpAlt.setInputBufferSize(1024);", "originalCommit": "149f389fd8a2e5f82511ceb492220edbf96839d8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzE3MTM2OQ==", "url": "https://github.com/eclipse/jetty.project/pull/5419#discussion_r503171369", "bodyText": "no clue, i'll remove it and see what happens", "author": "joakime", "createdAt": "2020-10-12T09:42:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzE2OTIwOA=="}], "type": "inlineReview", "revised_code": {"commit": "c2266fdd63dea082dc83fc2ab031867d1d83ecc9", "chunk": "diff --git a/jetty-server/src/test/java/org/eclipse/jetty/server/ForwardedRequestCustomizerTest.java b/jetty-server/src/test/java/org/eclipse/jetty/server/ForwardedRequestCustomizerTest.java\nindex 3b34209ff1..d425e894c1 100644\n--- a/jetty-server/src/test/java/org/eclipse/jetty/server/ForwardedRequestCustomizerTest.java\n+++ b/jetty-server/src/test/java/org/eclipse/jetty/server/ForwardedRequestCustomizerTest.java\n\n@@ -74,10 +74,6 @@ public class ForwardedRequestCustomizerTest\n \n         // Default behavior Connector\n         HttpConnectionFactory http = new HttpConnectionFactory();\n-        http.setInputBufferSize(1024);\n-        http.getHttpConfiguration().setRequestHeaderSize(512);\n-        http.getHttpConfiguration().setResponseHeaderSize(512);\n-        http.getHttpConfiguration().setOutputBufferSize(2048);\n         http.getHttpConfiguration().setSecurePort(443);\n         customizer = new ForwardedRequestCustomizer();\n         http.getHttpConfiguration().addCustomizer(customizer);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzE3MDU2Nw==", "url": "https://github.com/eclipse/jetty.project/pull/5419#discussion_r503170567", "bodyText": "can you make this comment not look like commented out code.  It is good info to have, but I found the format confusing", "author": "gregw", "createdAt": "2020-10-12T09:41:25Z", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/ForwardedRequestCustomizer.java", "diffHunk": "@@ -512,12 +512,7 @@ public void customize(Connector connector, HttpConfiguration config, Request req\n         {\n             port = requestURI.getPort();\n         }\n-        if (port == MutableHostPort.IMPLIED) // is implied\n-        {\n-            // get Implied port (from protocol / scheme) and HttpConfiguration\n-            int defaultPort = 80;\n-            port = proto.equalsIgnoreCase(config.getSecureScheme()) ? getSecurePort(config) : defaultPort;\n-        }\n+        // if (port == MutableHostPort.IMPLIED) // is implied, no port change needed", "originalCommit": "149f389fd8a2e5f82511ceb492220edbf96839d8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzE3MTUwNA==", "url": "https://github.com/eclipse/jetty.project/pull/5419#discussion_r503171504", "bodyText": "True. will fix.", "author": "joakime", "createdAt": "2020-10-12T09:42:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzE3MDU2Nw=="}], "type": "inlineReview", "revised_code": {"commit": "c2266fdd63dea082dc83fc2ab031867d1d83ecc9", "chunk": "diff --git a/jetty-server/src/main/java/org/eclipse/jetty/server/ForwardedRequestCustomizer.java b/jetty-server/src/main/java/org/eclipse/jetty/server/ForwardedRequestCustomizer.java\nindex a3dc7a96b0..3e20cece18 100644\n--- a/jetty-server/src/main/java/org/eclipse/jetty/server/ForwardedRequestCustomizer.java\n+++ b/jetty-server/src/main/java/org/eclipse/jetty/server/ForwardedRequestCustomizer.java\n\n@@ -512,7 +512,7 @@ public class ForwardedRequestCustomizer implements Customizer\n         {\n             port = requestURI.getPort();\n         }\n-        // if (port == MutableHostPort.IMPLIED) // is implied, no port change needed\n+        // Don't change port if port == IMPLIED.\n \n         // Update authority if different from metadata\n         if (!host.equalsIgnoreCase(requestURI.getHost()) ||\n"}}, {"oid": "c2266fdd63dea082dc83fc2ab031867d1d83ecc9", "url": "https://github.com/eclipse/jetty.project/commit/c2266fdd63dea082dc83fc2ab031867d1d83ecc9", "message": "Issue #5417 - Cleanup of PR from Review\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>", "committedDate": "2020-10-12T09:50:51Z", "type": "commit"}]}