{"pr_number": 5148, "pr_title": "Issue #5095 - XmlConfiguration Parser Pool", "pr_createdAt": "2020-08-13T11:27:09Z", "pr_url": "https://github.com/eclipse/jetty.project/pull/5148", "timeline": [{"oid": "ebb301794dd0f2e60155c2ee82349ec7e8704c3a", "url": "https://github.com/eclipse/jetty.project/commit/ebb301794dd0f2e60155c2ee82349ec7e8704c3a", "message": "Issue #5095 XmlConfiguration Parser Pool\n\nUse a pool of parsers rather than a shared static\n\nSigned-off-by: Greg Wilkins <gregw@webtide.com>", "committedDate": "2020-08-04T11:38:19Z", "type": "commit"}, {"oid": "1436b0c3e2da420cec9d3865072d7ed26a62f186", "url": "https://github.com/eclipse/jetty.project/commit/1436b0c3e2da420cec9d3865072d7ed26a62f186", "message": "Some updates to the new Pool class:\n\n + fixed a race with pending reservations\n + use a pending counter\n + Reservation API to simplify Entry API\n + removed public methods on Entry API", "committedDate": "2020-08-04T16:23:33Z", "type": "commit"}, {"oid": "f5a35a2eac4ce20b64ba71edcc1800a926cadde4", "url": "https://github.com/eclipse/jetty.project/commit/f5a35a2eac4ce20b64ba71edcc1800a926cadde4", "message": "Some updates to the new Pool class:\n\n + fixed a race with pending reservations\n + use a pending counter\n + Reservation API to simplify Entry API\n + removed public methods on Entry API", "committedDate": "2020-08-05T09:22:49Z", "type": "commit"}, {"oid": "37a9f88fb7f8104364db7856f285460b02781db8", "url": "https://github.com/eclipse/jetty.project/commit/37a9f88fb7f8104364db7856f285460b02781db8", "message": "Updates from review", "committedDate": "2020-08-05T15:17:09Z", "type": "commit"}, {"oid": "be7bb00a2633de913b7014b7b511fee0094c9a15", "url": "https://github.com/eclipse/jetty.project/commit/be7bb00a2633de913b7014b7b511fee0094c9a15", "message": "Updates from review\nTests for cache size and acquire with creator", "committedDate": "2020-08-05T16:44:54Z", "type": "commit"}, {"oid": "2eb669757f63098c41bdcfa34438c9afc9af22cc", "url": "https://github.com/eclipse/jetty.project/commit/2eb669757f63098c41bdcfa34438c9afc9af22cc", "message": "Merge remote-tracking branch 'origin/jetty-9.4.x' into jetty-9.4.x-PoolCleaning", "committedDate": "2020-08-10T07:56:01Z", "type": "commit"}, {"oid": "1ac922b3f4b0a1fe1df0e8606ec70b22805bb5a3", "url": "https://github.com/eclipse/jetty.project/commit/1ac922b3f4b0a1fe1df0e8606ec70b22805bb5a3", "message": "Method no longer required with Reservation", "committedDate": "2020-08-10T08:05:27Z", "type": "commit"}, {"oid": "d8b28e435ac41438cb18c307f6f5257934e99c00", "url": "https://github.com/eclipse/jetty.project/commit/d8b28e435ac41438cb18c307f6f5257934e99c00", "message": "update from the feedback on the feedback of the feedback from the review.\n\nMoved enable to Entry, removed Reservation class and clarified usage in javadoc", "committedDate": "2020-08-10T13:31:31Z", "type": "commit"}, {"oid": "746323320fc45a3033dffc8b515380ff3515fa2b", "url": "https://github.com/eclipse/jetty.project/commit/746323320fc45a3033dffc8b515380ff3515fa2b", "message": "Issue #5095 XmlConfiguration locking  Use pool instead of static shared instance", "committedDate": "2020-08-10T13:33:40Z", "type": "commit"}, {"oid": "92fde37248dbc4fb5fb829917ee34d8296212a34", "url": "https://github.com/eclipse/jetty.project/commit/92fde37248dbc4fb5fb829917ee34d8296212a34", "message": "Merge branch 'jetty-9.4.x-5095-XmlConfigurationParserPool' of https://github.com/eclipse/jetty.project into jetty-9.4.x-5095-XmlConfigurationParserPool\n\nSigned-off-by: Greg Wilkins <gregw@webtide.com>", "committedDate": "2020-08-13T09:54:16Z", "type": "commit"}, {"oid": "bf07df4da775e4e8fb4a2728393571d128ee07a9", "url": "https://github.com/eclipse/jetty.project/commit/bf07df4da775e4e8fb4a2728393571d128ee07a9", "message": "Merge remote-tracking branch 'origin/jetty-9.4.x' into jetty-9.4.x-5095-XmlConfigurationParserPool\n\nSigned-off-by: Greg Wilkins <gregw@webtide.com>", "committedDate": "2020-08-13T11:25:31Z", "type": "commit"}, {"oid": "6058ffb147f2bfb644345930ad22ce4777192525", "url": "https://github.com/eclipse/jetty.project/commit/6058ffb147f2bfb644345930ad22ce4777192525", "message": "removed fake test\n\nSigned-off-by: Greg Wilkins <gregw@webtide.com>", "committedDate": "2020-08-13T11:26:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTMxNjAwNA==", "url": "https://github.com/eclipse/jetty.project/pull/5148#discussion_r471316004", "bodyText": "I would cap that Runtime.getRuntime().availableProcessors() up to a reasonable number (8? 16? 32?) as I don't think we could use 128+ parsers (which is becoming a more and more common HW thread count) in parallel in practice. Or could we?", "author": "lorban", "createdAt": "2020-08-17T08:16:47Z", "path": "jetty-xml/src/main/java/org/eclipse/jetty/xml/XmlConfiguration.java", "diffHunk": "@@ -99,7 +100,7 @@\n             ArrayList.class, HashSet.class, Queue.class, List.class, Set.class, Collection.class\n         };\n     private static final Iterable<ConfigurationProcessorFactory> __factoryLoader = ServiceLoader.load(ConfigurationProcessorFactory.class);\n-    private static final XmlParser __parser = initParser();\n+    private static final Pool<ConfigurationParser> __parsers = new Pool<>(Runtime.getRuntime().availableProcessors(),1);", "originalCommit": "6058ffb147f2bfb644345930ad22ce4777192525", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTMyMzc4MA==", "url": "https://github.com/eclipse/jetty.project/pull/5148#discussion_r471323780", "bodyText": "Good idea.  Considering we were previously contending on 1 instance, I think a limit of 8 would be fine.", "author": "gregw", "createdAt": "2020-08-17T08:31:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTMxNjAwNA=="}], "type": "inlineReview", "revised_code": {"commit": "64066b7a4afd4ac7edcd22f05de02b3ac0d3d59b", "chunk": "diff --git a/jetty-xml/src/main/java/org/eclipse/jetty/xml/XmlConfiguration.java b/jetty-xml/src/main/java/org/eclipse/jetty/xml/XmlConfiguration.java\nindex f6ee611383..c79664d7b9 100644\n--- a/jetty-xml/src/main/java/org/eclipse/jetty/xml/XmlConfiguration.java\n+++ b/jetty-xml/src/main/java/org/eclipse/jetty/xml/XmlConfiguration.java\n\n@@ -100,7 +100,8 @@ public class XmlConfiguration\n             ArrayList.class, HashSet.class, Queue.class, List.class, Set.class, Collection.class\n         };\n     private static final Iterable<ConfigurationProcessorFactory> __factoryLoader = ServiceLoader.load(ConfigurationProcessorFactory.class);\n-    private static final Pool<ConfigurationParser> __parsers = new Pool<>(Runtime.getRuntime().availableProcessors(),1);\n+    private static final Pool<ConfigurationParser> __parsers =\n+        new Pool<>(Math.min(8, Runtime.getRuntime().availableProcessors()),1);\n     public static final Comparator<Executable> EXECUTABLE_COMPARATOR = (e1, e2) ->\n     {\n         // Favour methods with less parameters\n"}}, {"oid": "ca9bc68ccf7d6447329ce03d55201d49334662a4", "url": "https://github.com/eclipse/jetty.project/commit/ca9bc68ccf7d6447329ce03d55201d49334662a4", "message": "Merge branch 'jetty-9.4.x' into jetty-9.4.x-5095-XmlConfigurationParserPool", "committedDate": "2020-08-17T08:26:57Z", "type": "commit"}, {"oid": "64066b7a4afd4ac7edcd22f05de02b3ac0d3d59b", "url": "https://github.com/eclipse/jetty.project/commit/64066b7a4afd4ac7edcd22f05de02b3ac0d3d59b", "message": "Issue #5095 XmlConfiguration locking  Use pool instead of static shared instance\n\nupdates from review", "committedDate": "2020-08-17T08:31:44Z", "type": "commit"}]}