{"pr_number": 4768, "pr_title": "Fixes #4764 - HTTP2 Jetty Server does not send back content-length.", "pr_createdAt": "2020-04-13T15:58:23Z", "pr_url": "https://github.com/eclipse/jetty.project/pull/4768", "timeline": [{"oid": "dc89f7f264c1503d7a4a70fbdcf23024fe2bd504", "url": "https://github.com/eclipse/jetty.project/commit/dc89f7f264c1503d7a4a70fbdcf23024fe2bd504", "message": "Fixes #4764 - HTTP2 Jetty Server does not send back content-length.\n\nSending Content-Length header if known at the time of sending the\nresponse headers.\n\nSigned-off-by: Simone Bordet <simone.bordet@gmail.com>", "committedDate": "2020-04-13T15:57:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzkyNTI5MQ==", "url": "https://github.com/eclipse/jetty.project/pull/4768#discussion_r407925291", "bodyText": "Does it have to be put into the HttpFields instance?  The HTTP/1 does this in the generator, so that as it is committing the headers it looks for an existing content-length header and if one is not found, but the length is known, then the content length header is generated directly into the output buffer without creating a HttpField instance or modifying the info.\nThe h2 approach here still results in different behaviour because the HttpFields class will be different after commit.", "author": "gregw", "createdAt": "2020-04-14T07:33:58Z", "path": "jetty-http2/http2-server/src/main/java/org/eclipse/jetty/http2/server/HttpTransportOverHTTP2.java", "diffHunk": "@@ -110,6 +111,13 @@ public void send(MetaData.Response info, boolean isHeadRequest, ByteBuffer conte\n             {\n                 if (commit.compareAndSet(false, true))\n                 {\n+                    if (lastContent)\n+                    {\n+                        HttpFields responseHeaders = info.getFields();\n+                        if (!responseHeaders.contains(HttpHeader.CONTENT_LENGTH))\n+                            responseHeaders.put(HttpHeader.CONTENT_LENGTH, String.valueOf(BufferUtil.length(content)));", "originalCommit": "dc89f7f264c1503d7a4a70fbdcf23024fe2bd504", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzk0MTk0OA==", "url": "https://github.com/eclipse/jetty.project/pull/4768#discussion_r407941948", "bodyText": "@gregw HTTP/2 works with frames, so if I can't put the Content-Length inside the HttpFields I would need an additional field HeadersFrame.contentLength which is doable but feels weird.\nAlso, it's not clear what should be done in case of conflicts with the application.\nFor example, if the application specified a different Content-Length value?", "author": "sbordet", "createdAt": "2020-04-14T08:02:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzkyNTI5MQ=="}], "type": "inlineReview", "revised_code": {"commit": "2e85b3e169e30d604b1af11a7518086e5545b0ce", "chunk": "diff --git a/jetty-http2/http2-server/src/main/java/org/eclipse/jetty/http2/server/HttpTransportOverHTTP2.java b/jetty-http2/http2-server/src/main/java/org/eclipse/jetty/http2/server/HttpTransportOverHTTP2.java\nindex a19a8fa071..03a9812c58 100644\n--- a/jetty-http2/http2-server/src/main/java/org/eclipse/jetty/http2/server/HttpTransportOverHTTP2.java\n+++ b/jetty-http2/http2-server/src/main/java/org/eclipse/jetty/http2/server/HttpTransportOverHTTP2.java\n\n@@ -113,9 +113,17 @@ public class HttpTransportOverHTTP2 implements HttpTransport\n                 {\n                     if (lastContent)\n                     {\n-                        HttpFields responseHeaders = info.getFields();\n-                        if (!responseHeaders.contains(HttpHeader.CONTENT_LENGTH))\n-                            responseHeaders.put(HttpHeader.CONTENT_LENGTH, String.valueOf(BufferUtil.length(content)));\n+                        long realContentLength = BufferUtil.length(content);\n+                        long contentLength = info.getContentLength();\n+                        if (contentLength < 0)\n+                        {\n+                            info.setContentLength(realContentLength);\n+                        }\n+                        else if (contentLength != realContentLength)\n+                        {\n+                            callback.failed(new BadMessageException(HttpStatus.INTERNAL_SERVER_ERROR_500, String.format(\"Incorrect Content-Length %d!=%d\", contentLength, realContentLength)));\n+                            return;\n+                        }\n                     }\n \n                     if (hasContent)\n"}}, {"oid": "2e85b3e169e30d604b1af11a7518086e5545b0ce", "url": "https://github.com/eclipse/jetty.project/commit/2e85b3e169e30d604b1af11a7518086e5545b0ce", "message": "Fixes #4764 - HTTP2 Jetty Server does not send back content-length.\n\nUpdates after review.\nNow the Content-Length header is generated by HpackEncoder based on\nMetaData.contentLength, so that the MetaData.HttpFields are not modified.\n\nSigned-off-by: Simone Bordet <simone.bordet@gmail.com>", "committedDate": "2020-04-14T09:44:58Z", "type": "commit"}, {"oid": "3e96bf862152f0b301d27be12cae051d9bec6d14", "url": "https://github.com/eclipse/jetty.project/commit/3e96bf862152f0b301d27be12cae051d9bec6d14", "message": "Merged branch 'jetty-9.4.x' into 'jetty-9.4.x-4764-http2_content_length'.", "committedDate": "2020-04-14T09:45:48Z", "type": "commit"}, {"oid": "0e30d6b7515df97c02f99c589b43b513043ac920", "url": "https://github.com/eclipse/jetty.project/commit/0e30d6b7515df97c02f99c589b43b513043ac920", "message": "Fixes #4764 - HTTP2 Jetty Server does not send back content-length.\n\nFixed InterleavingTest that was using the wrong MetaData.Response constructor.\nFixed handling of HEAD methods in HttpTransportOverHTTP2.\n\nSigned-off-by: Simone Bordet <simone.bordet@gmail.com>", "committedDate": "2020-04-14T11:05:24Z", "type": "commit"}]}