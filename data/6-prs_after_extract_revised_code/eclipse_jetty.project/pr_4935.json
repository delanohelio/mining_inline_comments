{"pr_number": 4935, "pr_title": "#4877 fix PathSpec long-standing bugs and shortcomings", "pr_createdAt": "2020-06-03T12:23:31Z", "pr_url": "https://github.com/eclipse/jetty.project/pull/4935", "timeline": [{"oid": "a0179dfd57f204c27639958e60b07e1ba788e727", "url": "https://github.com/eclipse/jetty.project/commit/a0179dfd57f204c27639958e60b07e1ba788e727", "message": "#4877 fix PathSpec long-standing bugs and shortcomings\n\nSigned-off-by: Ludovic Orban <lorban@bitronix.be>", "committedDate": "2020-06-03T12:26:35Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDUzMzA4MQ==", "url": "https://github.com/eclipse/jetty.project/pull/4935#discussion_r434533081", "bodyText": "This code is duplicated 3 times, why don't we have a simple base class like AbstractPathSpec, which could implement this and also maybe compareTo and toString, and then we could reduce the code duplication.\nI made some similar changes like this in my branch at jetty-9.4.x-4877-PathSpecEquals if you want to take a look\n\n  \n    \n      jetty.project/jetty-http/src/main/java/org/eclipse/jetty/http/pathmap/AbstractPathSpec.java\n    \n    \n        Lines 23 to 60\n      in\n      c6a4078\n    \n    \n    \n    \n\n        \n          \n           public abstract class AbstractPathSpec implements PathSpec \n        \n\n        \n          \n           { \n        \n\n        \n          \n               @Override \n        \n\n        \n          \n               public int compareTo(PathSpec other) \n        \n\n        \n          \n               { \n        \n\n        \n          \n                   // Grouping (increasing) \n        \n\n        \n          \n                   int diff = getGroup().ordinal() - other.getGroup().ordinal(); \n        \n\n        \n          \n                   if (diff != 0) \n        \n\n        \n          \n                       return diff; \n        \n\n        \n          \n            \n        \n\n        \n          \n                   // Spec Length (decreasing) \n        \n\n        \n          \n                   diff = other.getSpecLength() - getSpecLength(); \n        \n\n        \n          \n                   if (diff != 0) \n        \n\n        \n          \n                       return diff; \n        \n\n        \n          \n            \n        \n\n        \n          \n                   // Path Spec Name (alphabetical) \n        \n\n        \n          \n                   return getDeclaration().compareTo(other.getDeclaration()); \n        \n\n        \n          \n               } \n        \n\n        \n          \n            \n        \n\n        \n          \n               @Override \n        \n\n        \n          \n               public boolean equals(Object obj) \n        \n\n        \n          \n               { \n        \n\n        \n          \n                   if (this == obj) \n        \n\n        \n          \n                       return true; \n        \n\n        \n          \n                   if (obj == null) \n        \n\n        \n          \n                       return false; \n        \n\n        \n          \n                   if (getClass() != obj.getClass()) \n        \n\n        \n          \n                       return false; \n        \n\n        \n          \n            \n        \n\n        \n          \n                   return Objects.equals(getDeclaration(), ((PathSpec)obj).getDeclaration()); \n        \n\n        \n          \n               } \n        \n\n        \n          \n            \n        \n\n        \n          \n               @Override \n        \n\n        \n          \n               public String toString() \n        \n\n        \n          \n               { \n        \n\n        \n          \n                   return String.format(\"%s@%s{%s}\", getClass().getSimpleName(), Integer.toHexString(hashCode()), getDeclaration()); \n        \n\n        \n          \n               } \n        \n\n        \n          \n           }", "author": "lachlan-roberts", "createdAt": "2020-06-03T12:36:13Z", "path": "jetty-http/src/main/java/org/eclipse/jetty/http/pathmap/RegexPathSpec.java", "diffHunk": "@@ -193,4 +194,21 @@ public boolean matches(final String path)\n             return getMatcher(path).matches();\n         }\n     }\n+\n+    @Override\n+    public boolean equals(Object o)", "originalCommit": "a0179dfd57f204c27639958e60b07e1ba788e727", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDUzNDQyNg==", "url": "https://github.com/eclipse/jetty.project/pull/4935#discussion_r434534426", "bodyText": "@lachlan-roberts because I asked him to make all the fields final. Hard to do the abstract and the final fields without more complication.", "author": "gregw", "createdAt": "2020-06-03T12:38:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDUzMzA4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDUzNTY1Ng==", "url": "https://github.com/eclipse/jetty.project/pull/4935#discussion_r434535656", "bodyText": "@gregw Take a look at the file I linked, it doesn't prevent having any final fields in the implementations of the abstract class.", "author": "lachlan-roberts", "createdAt": "2020-06-03T12:40:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDUzMzA4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDUzODc1MA==", "url": "https://github.com/eclipse/jetty.project/pull/4935#discussion_r434538750", "bodyText": "I like the idea of this abstract class that provides implementations for toString, equals, hashcode and compareTo, especially if I can get rid of the  PathSpec.compareTo default implementation. But I'd make equals and hashcode final then to make sure compareTo and equals always agree. See my comment for context.", "author": "lorban", "createdAt": "2020-06-03T12:45:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDUzMzA4MQ=="}], "type": "inlineReview", "revised_code": {"commit": "43cd401ba2b35f9bfd83461188b6dfc2b3a4d994", "chunk": "diff --git a/jetty-http/src/main/java/org/eclipse/jetty/http/pathmap/RegexPathSpec.java b/jetty-http/src/main/java/org/eclipse/jetty/http/pathmap/RegexPathSpec.java\nindex 9df701ca3e..41f313b138 100644\n--- a/jetty-http/src/main/java/org/eclipse/jetty/http/pathmap/RegexPathSpec.java\n+++ b/jetty-http/src/main/java/org/eclipse/jetty/http/pathmap/RegexPathSpec.java\n\n@@ -194,21 +193,4 @@ public class RegexPathSpec implements PathSpec\n             return getMatcher(path).matches();\n         }\n     }\n-\n-    @Override\n-    public boolean equals(Object o)\n-    {\n-        if (this == o)\n-            return true;\n-        if (o == null || getClass() != o.getClass())\n-            return false;\n-        RegexPathSpec that = (RegexPathSpec)o;\n-        return compareTo(that) == 0;\n-    }\n-\n-    @Override\n-    public int hashCode()\n-    {\n-        return Objects.hash(_declaration);\n-    }\n }\n"}}, {"oid": "43cd401ba2b35f9bfd83461188b6dfc2b3a4d994", "url": "https://github.com/eclipse/jetty.project/commit/43cd401ba2b35f9bfd83461188b6dfc2b3a4d994", "message": "Signed-off-by: Ludovic Orban <lorban@bitronix.be>", "committedDate": "2020-06-03T13:46:11Z", "type": "forcePushed"}, {"oid": "6c62157865f124c83c5b8e7278af8acf140883f2", "url": "https://github.com/eclipse/jetty.project/commit/6c62157865f124c83c5b8e7278af8acf140883f2", "message": "Signed-off-by: Ludovic Orban <lorban@bitronix.be>", "committedDate": "2020-06-03T14:30:26Z", "type": "commit"}, {"oid": "7d7f56ab7991c788c08bedf6e487ac6485436b3e", "url": "https://github.com/eclipse/jetty.project/commit/7d7f56ab7991c788c08bedf6e487ac6485436b3e", "message": "Signed-off-by: Ludovic Orban <lorban@bitronix.be>", "committedDate": "2020-06-03T14:30:26Z", "type": "forcePushed"}, {"oid": "e43c98f08d8f711a0f24b8c022133fb0a205c4d4", "url": "https://github.com/eclipse/jetty.project/commit/e43c98f08d8f711a0f24b8c022133fb0a205c4d4", "message": "Signed-off-by: Ludovic Orban <lorban@bitronix.be>", "committedDate": "2020-06-03T15:58:01Z", "type": "commit"}, {"oid": "e43c98f08d8f711a0f24b8c022133fb0a205c4d4", "url": "https://github.com/eclipse/jetty.project/commit/e43c98f08d8f711a0f24b8c022133fb0a205c4d4", "message": "Signed-off-by: Ludovic Orban <lorban@bitronix.be>", "committedDate": "2020-06-03T15:58:01Z", "type": "forcePushed"}]}