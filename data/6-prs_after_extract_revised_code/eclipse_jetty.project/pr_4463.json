{"pr_number": 4463, "pr_title": "Issue #4433 - Implement ServletContext.addJspFile", "pr_createdAt": "2020-01-08T00:39:50Z", "pr_url": "https://github.com/eclipse/jetty.project/pull/4463", "timeline": [{"oid": "60833a91aa42962aad8299e6e724e8bf66b8f481", "url": "https://github.com/eclipse/jetty.project/commit/60833a91aa42962aad8299e6e724e8bf66b8f481", "message": "Issue #4433 Implement ServletContext.addJspFile\n\nSigned-off-by: Jan Bartel <janb@webtide.com>", "committedDate": "2020-01-08T00:08:00Z", "type": "commit"}, {"oid": "8fc82bf4f4b22529efefb922e5129129488bddcd", "url": "https://github.com/eclipse/jetty.project/commit/8fc82bf4f4b22529efefb922e5129129488bddcd", "message": "Issue #4433 remove todo\n\nSigned-off-by: Jan Bartel <janb@webtide.com>", "committedDate": "2020-01-08T00:35:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDY3NjMxMg==", "url": "https://github.com/eclipse/jetty.project/pull/4463#discussion_r364676312", "bodyText": "All other tests in this class have code that actually make a HTTP request to test the functionality.\nThis new test only adds the dynamic JSP but does not test that making a HTTP request to it works.\nIs that intended?", "author": "sbordet", "createdAt": "2020-01-09T10:55:43Z", "path": "jetty-servlet/src/test/java/org/eclipse/jetty/servlet/ServletContextHandlerTest.java", "diffHunk": "@@ -884,6 +884,38 @@ public void onStartup(Set<Class<?>> c, ServletContext ctx) throws ServletExcepti\n         assertThat(\"Response\", response, containsString(\"Hello World\"));\n     }\n \n+    @Test\n+    public void testAddJspFile() throws Exception\n+    {\n+        ContextHandlerCollection contexts = new ContextHandlerCollection();\n+        _server.setHandler(contexts);\n+\n+        ServletContextHandler root = new ServletContextHandler(contexts, \"/\");\n+        ServletHolder jspServlet = new ServletHolder();\n+        jspServlet.setName(\"jsp\");\n+        jspServlet.setHeldClass(FakeJspServlet.class);\n+        root.addServlet(jspServlet, \"*.jsp\");\n+        class JSPAddingSCI implements ServletContainerInitializer\n+        {\n+            @Override\n+            public void onStartup(Set<Class<?>> c, ServletContext ctx) throws ServletException\n+            {\n+                try\n+                {\n+                    ServletRegistration rego = ctx.addJspFile(\"some.jsp\", \"/path/to/some.jsp\");\n+                    rego.addMapping(\"/somejsp/*\");\n+                }\n+                catch (Exception e)\n+                {\n+                    fail(e);\n+                }\n+            }\n+        }\n+        \n+        root.addBean(new MySCIStarter(root.getServletContext(), new JSPAddingSCI()), true);\n+        _server.start();\n+    }", "originalCommit": "8fc82bf4f4b22529efefb922e5129129488bddcd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDY3NjgxMg==", "url": "https://github.com/eclipse/jetty.project/pull/4463#discussion_r364676812", "bodyText": "Also, should we not have 3 tests for this functionality? No mapping, partial mapping, existing mapping?", "author": "sbordet", "createdAt": "2020-01-09T10:56:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDY3NjMxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQzOTI5Nw==", "url": "https://github.com/eclipse/jetty.project/pull/4463#discussion_r367439297", "bodyText": "I can't add a test for a jsp file because jetty-servlet cannot depend on apache-jsp module. I've added an assertion that tests that the mapped jsp servlet is the one matched by the ServletHandler for the given path, that's as much as we can do.\nI also added tests for an existing full mapping and an existing preliminary mapping.", "author": "janbartel", "createdAt": "2020-01-16T14:14:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDY3NjMxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzc5MDM5NQ==", "url": "https://github.com/eclipse/jetty.project/pull/4463#discussion_r367790395", "bodyText": "Can we add a jspFile via this API in the test-spec webapp as an integration test?", "author": "gregw", "createdAt": "2020-01-17T06:49:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDY3NjMxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzc5OTM5NQ==", "url": "https://github.com/eclipse/jetty.project/pull/4463#discussion_r367799395", "bodyText": "That was already part of the initial commit: the test-spec-webapp calls addJsp via a ServletContainerInitiaizer.  See https://github.com/eclipse/jetty.project/blob/jetty-10.0.x-4433-addJspFile/tests/test-webapps/test-servlet-spec/test-container-initializer/src/main/java/com/acme/initializer/FooInitializer.java#L108 and https://github.com/eclipse/jetty.project/blob/jetty-10.0.x-4433-addJspFile/tests/test-webapps/test-servlet-spec/test-spec-webapp/src/main/java/com/acme/test/AnnotationTest.java#L255", "author": "janbartel", "createdAt": "2020-01-17T07:27:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDY3NjMxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzgwMTI2MA==", "url": "https://github.com/eclipse/jetty.project/pull/4463#discussion_r367801260", "bodyText": "great!  can we then check that the test-distribution will see any fail for this?", "author": "gregw", "createdAt": "2020-01-17T07:35:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDY3NjMxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzgxMTQzMQ==", "url": "https://github.com/eclipse/jetty.project/pull/4463#discussion_r367811431", "bodyText": "Done.", "author": "janbartel", "createdAt": "2020-01-17T08:10:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDY3NjMxMg=="}], "type": "inlineReview", "revised_code": {"commit": "dbeb4861bb492447176c97585f87509fb4df4e76", "chunk": "diff --git a/jetty-servlet/src/test/java/org/eclipse/jetty/servlet/ServletContextHandlerTest.java b/jetty-servlet/src/test/java/org/eclipse/jetty/servlet/ServletContextHandlerTest.java\nindex bbaa6db307..c31a751f91 100644\n--- a/jetty-servlet/src/test/java/org/eclipse/jetty/servlet/ServletContextHandlerTest.java\n+++ b/jetty-servlet/src/test/java/org/eclipse/jetty/servlet/ServletContextHandlerTest.java\n\n@@ -911,9 +912,88 @@ public class ServletContextHandlerTest\n                 }\n             }\n         }\n-        \n+\n+        root.addBean(new MySCIStarter(root.getServletContext(), new JSPAddingSCI()), true);\n+        _server.start();\n+        MappedResource<ServletHolder> mappedServlet = root.getServletHandler().getMappedServlet(\"/somejsp/xxx\");\n+        assertNotNull(mappedServlet.getResource());\n+        assertEquals(\"some.jsp\", mappedServlet.getResource().getName());\n+    }\n+\n+    @Test\n+    public void testAddJspFileWithExistingRegistration() throws Exception\n+    {\n+        ContextHandlerCollection contexts = new ContextHandlerCollection();\n+        _server.setHandler(contexts);\n+\n+        ServletContextHandler root = new ServletContextHandler(contexts, \"/\");\n+        ServletHolder jspServlet = new ServletHolder();\n+        jspServlet.setName(\"jsp\");\n+        jspServlet.setHeldClass(FakeJspServlet.class);\n+        root.addServlet(jspServlet, \"*.jsp\");\n+        //add a full registration so that the addJspFile will fail\n+        ServletHolder barServlet = new ServletHolder();\n+        barServlet.setName(\"some.jsp\");\n+        barServlet.setHeldClass(HelloServlet.class);\n+        root.addServlet(barServlet, \"/bar/*\");\n+        class JSPAddingSCI implements ServletContainerInitializer\n+        {\n+            @Override\n+            public void onStartup(Set<Class<?>> c, ServletContext ctx) throws ServletException\n+            {\n+                try\n+                {\n+                    ServletRegistration rego = ctx.addJspFile(\"some.jsp\", \"/path/to/some.jsp\");\n+                    assertNull(rego);\n+                }\n+                catch (Exception e)\n+                {\n+                    fail(e);\n+                }\n+            }\n+        }\n+\n+        root.addBean(new MySCIStarter(root.getServletContext(), new JSPAddingSCI()), true);\n+        _server.start();\n+    }\n+\n+    @Test\n+    public void testAddJspFileWithPartialRegistration() throws Exception\n+    {\n+        ContextHandlerCollection contexts = new ContextHandlerCollection();\n+        _server.setHandler(contexts);\n+\n+        ServletContextHandler root = new ServletContextHandler(contexts, \"/\");\n+        ServletHolder jspServlet = new ServletHolder();\n+        jspServlet.setName(\"jsp\");\n+        jspServlet.setHeldClass(FakeJspServlet.class);\n+        root.addServlet(jspServlet, \"*.jsp\");\n+        //add a preliminary registration so that the addJspFile will complete it\n+        ServletHolder barServlet = new ServletHolder();\n+        barServlet.setName(\"some.jsp\");\n+        root.addServlet(barServlet, \"/bar/*\");\n+        class JSPAddingSCI implements ServletContainerInitializer\n+        {\n+            @Override\n+            public void onStartup(Set<Class<?>> c, ServletContext ctx) throws ServletException\n+            {\n+                try\n+                {\n+                    ServletRegistration rego = ctx.addJspFile(\"some.jsp\", \"/path/to/some.jsp\");\n+                    assertNotNull(rego);\n+                }\n+                catch (Exception e)\n+                {\n+                    fail(e);\n+                }\n+            }\n+        }\n+\n         root.addBean(new MySCIStarter(root.getServletContext(), new JSPAddingSCI()), true);\n         _server.start();\n+        MappedResource<ServletHolder> mappedServlet = root.getServletHandler().getMappedServlet(\"/bar/xxx\");\n+        assertNotNull(mappedServlet.getResource());\n+        assertEquals(\"some.jsp\", mappedServlet.getResource().getName());\n     }\n     \n     @Test\n"}}, {"oid": "dbeb4861bb492447176c97585f87509fb4df4e76", "url": "https://github.com/eclipse/jetty.project/commit/dbeb4861bb492447176c97585f87509fb4df4e76", "message": "Issue #4433 Add extra tests\n\nSigned-off-by: Jan Bartel <janb@webtide.com>", "committedDate": "2020-01-16T14:12:59Z", "type": "commit"}, {"oid": "0040f55b9250c649aa26c8e2d2f77f70a60c0a1b", "url": "https://github.com/eclipse/jetty.project/commit/0040f55b9250c649aa26c8e2d2f77f70a60c0a1b", "message": "Issue #4433 Add demo base test for addJsp\n\nSigned-off-by: Jan Bartel <janb@webtide.com>", "committedDate": "2020-01-17T08:10:04Z", "type": "commit"}]}