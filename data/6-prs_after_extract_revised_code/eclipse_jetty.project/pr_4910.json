{"pr_number": 4910, "pr_title": "Jetty 9.4.x jdbc session test docker", "pr_createdAt": "2020-05-26T10:39:11Z", "pr_url": "https://github.com/eclipse/jetty.project/pull/4910", "timeline": [{"oid": "c0a8cdf837ba320ff0a18ce8008ef14bd6362dee", "url": "https://github.com/eclipse/jetty.project/commit/c0a8cdf837ba320ff0a18ce8008ef14bd6362dee", "message": "use testcontainers/docker to run jdbc sessions tests with Mariadb remote\n\nSigned-off-by: olivier lamy <oliver.lamy@gmail.com>", "committedDate": "2020-05-26T08:33:05Z", "type": "commit"}, {"oid": "5e652bc79d0cb78f246afecffeb3aa1e401f7165", "url": "https://github.com/eclipse/jetty.project/commit/5e652bc79d0cb78f246afecffeb3aa1e401f7165", "message": "remove changes to DatabaseAdaptor with new fields username/password, use our own username/password in maria_db tests\n\nSigned-off-by: olivier lamy <oliver.lamy@gmail.com>", "committedDate": "2020-05-26T08:33:05Z", "type": "commit"}, {"oid": "95bc9cbcbfa8420cc57f2ed24b2619e37fcc27f6", "url": "https://github.com/eclipse/jetty.project/commit/95bc9cbcbfa8420cc57f2ed24b2619e37fcc27f6", "message": "bye bye Derby tests, only use mariadb via container\n\nSigned-off-by: olivier lamy <oliver.lamy@gmail.com>", "committedDate": "2020-05-26T08:33:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDM4NDExMg==", "url": "https://github.com/eclipse/jetty.project/pull/4910#discussion_r430384112", "bodyText": "Still need to delete this line setting the derby property.", "author": "janbartel", "createdAt": "2020-05-26T12:46:11Z", "path": "tests/test-sessions/test-jdbc-sessions/src/test/java/org/eclipse/jetty/server/session/JdbcTestHelper.java", "diffHunk": "@@ -60,6 +68,39 @@\n     public static final String COOKIE_COL = \"cooktime\";\n     public static final String CREATE_COL = \"ctime\";\n \n+    static MariaDBContainer MARIAD_DB;\n+\n+    static final String MARIA_DB_USER = \"beer\";\n+    static final String MARIA_DB_PASSWORD = \"pacific_ale\";\n+\n+    static\n+    {\n+        try\n+        {\n+            long start = System.currentTimeMillis();\n+            MARIAD_DB =\n+                new MariaDBContainer(\"mariadb:\" + System.getProperty(\"mariadb.docker.version\", \"10.3.6\"))\n+                    .withUsername(MARIA_DB_USER)\n+                    .withPassword(MARIA_DB_PASSWORD)\n+                    .withDatabaseName(\"sessions\");\n+            MARIAD_DB.withLogConsumer(new Slf4jLogConsumer(MARIADB_LOG)).start();\n+            String containerIpAddress =  MARIAD_DB.getContainerIpAddress();\n+            int mariadbPort = MARIAD_DB.getMappedPort(3306);\n+            DEFAULT_CONNECTION_URL = MARIAD_DB.getJdbcUrl();\n+            DRIVER_CLASS = MARIAD_DB.getDriverClassName();\n+            LOG.info(\"Mariadb container started for {}:{} - {}ms\", containerIpAddress, mariadbPort,\n+                     System.currentTimeMillis() - start);\n+            DEFAULT_CONNECTION_URL = DEFAULT_CONNECTION_URL + \"?user=\" + MARIA_DB_USER +\n+                \"&password=\" + MARIA_DB_PASSWORD;\n+            LOG.info(\"DEFAULT_CONNECTION_URL: {}\", DEFAULT_CONNECTION_URL);\n+        }\n+        catch (Exception e)\n+        {\n+            LOG.error(e.getMessage(), e);\n+            throw new RuntimeException(e.getMessage(), e);\n+        }\n+    }\n+\n     static\n     {\n         System.setProperty(\"derby.system.home\", MavenTestingUtils.getTargetFile(\"test-derby\").getAbsolutePath());", "originalCommit": "95bc9cbcbfa8420cc57f2ed24b2619e37fcc27f6", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9038338644cf27b21b8f575829599b49804bd5c8", "chunk": "diff --git a/tests/test-sessions/test-jdbc-sessions/src/test/java/org/eclipse/jetty/server/session/JdbcTestHelper.java b/tests/test-sessions/test-jdbc-sessions/src/test/java/org/eclipse/jetty/server/session/JdbcTestHelper.java\nindex 541f43c69c..ae951339e3 100644\n--- a/tests/test-sessions/test-jdbc-sessions/src/test/java/org/eclipse/jetty/server/session/JdbcTestHelper.java\n+++ b/tests/test-sessions/test-jdbc-sessions/src/test/java/org/eclipse/jetty/server/session/JdbcTestHelper.java\n\n@@ -101,11 +101,6 @@ public class JdbcTestHelper\n         }\n     }\n \n-    static\n-    {\n-        System.setProperty(\"derby.system.home\", MavenTestingUtils.getTargetFile(\"test-derby\").getAbsolutePath());\n-    }\n-\n     public static void shutdown(String connectionUrl)\n         throws Exception\n     {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDM4NDgzMA==", "url": "https://github.com/eclipse/jetty.project/pull/4910#discussion_r430384830", "bodyText": "Just out of interest, if the tables are dropped after every test, you don't need to make the id unique. Fine either way.", "author": "janbartel", "createdAt": "2020-05-26T12:47:25Z", "path": "tests/test-sessions/test-jdbc-sessions/src/test/java/org/eclipse/jetty/server/session/SessionTableSchemaTest.java", "diffHunk": "@@ -119,8 +117,10 @@ public void testLoad()\n         _da.initialize();\n         _tableSchema.prepareTables();\n \n+        String id = Long.toString(System.nanoTime());", "originalCommit": "95bc9cbcbfa8420cc57f2ed24b2619e37fcc27f6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDcxODIzNA==", "url": "https://github.com/eclipse/jetty.project/pull/4910#discussion_r430718234", "bodyText": "ah yes I added that before truncate table after every tests.", "author": "olamy", "createdAt": "2020-05-26T21:28:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDM4NDgzMA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "9038338644cf27b21b8f575829599b49804bd5c8", "url": "https://github.com/eclipse/jetty.project/commit/9038338644cf27b21b8f575829599b49804bd5c8", "message": "remove derby system property\n\nSigned-off-by: olivier lamy <oliver.lamy@gmail.com>", "committedDate": "2020-05-26T21:29:15Z", "type": "commit"}, {"oid": "7389f16285b08e5c45a540d97486fd03f2846c1b", "url": "https://github.com/eclipse/jetty.project/commit/7389f16285b08e5c45a540d97486fd03f2846c1b", "message": "always run the test except if Docker not available\n\nSigned-off-by: olivier lamy <oliver.lamy@gmail.com>", "committedDate": "2020-05-26T21:35:32Z", "type": "commit"}]}