{"pr_number": 5008, "pr_title": "Fixes #4971 - Simplify Connection.upgradeFrom()/upgradeTo().", "pr_createdAt": "2020-06-30T14:01:32Z", "pr_url": "https://github.com/eclipse/jetty.project/pull/5008", "timeline": [{"oid": "cef86c936c241c7a57ccf20615ef67b1733ca99a", "url": "https://github.com/eclipse/jetty.project/commit/cef86c936c241c7a57ccf20615ef67b1733ca99a", "message": "Fixes #4971 - Simplify Connection.upgradeFrom()/upgradeTo().\n\nNow the upgrade-from connection produces a \"floating\" buffer (not belonging to a pool), so that it can release the original buffer.\n\nThe upgrade-to connection is free to copy or store this \"floating\" buffer.\n\nUpdated javadocs and all implementations.\n\nSigned-off-by: Simone Bordet <simone.bordet@gmail.com>", "committedDate": "2020-06-30T14:00:35Z", "type": "commit"}, {"oid": "fc10eb2f95bbaac246917d31c50a8a1031075ba1", "url": "https://github.com/eclipse/jetty.project/commit/fc10eb2f95bbaac246917d31c50a8a1031075ba1", "message": "Fixes #4971 - Simplify Connection.upgradeFrom()/upgradeTo().\n\nFlip those buffers!\n\nSigned-off-by: Simone Bordet <simone.bordet@gmail.com>", "committedDate": "2020-06-30T18:04:13Z", "type": "commit"}, {"oid": "359252144d7cfc51b4e08420472ca4831847ec70", "url": "https://github.com/eclipse/jetty.project/commit/359252144d7cfc51b4e08420472ca4831847ec70", "message": "Fixes #4971 - Simplify Connection.upgradeFrom()/upgradeTo().\n\nFixed ConnectHandler by calling fillInterested() if the upgrade buffer is null.\n\nSigned-off-by: Simone Bordet <simone.bordet@gmail.com>", "committedDate": "2020-06-30T21:21:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMwMzYyMA==", "url": "https://github.com/eclipse/jetty.project/pull/5008#discussion_r448303620", "bodyText": "The contract changes you're proposing forces a ByteBuffer allocation.\nCouldn't that be avoided by specifying that the buffer returned by onUpgradeFrom and passed to onUpgradeTo must be fully consumed and no reference to it should be kept?\nI would phrase that as:\nFor onUpgradeTo: Implementations MUST consume all bytes of the buffer and MUST NOT keep a reference to the buffer.\nFor onUpgradeFrom: The buffer WILL only be used for the duration of the Endpoint.upgrade call and MAY be disposed of afterwards.", "author": "lorban", "createdAt": "2020-07-01T11:38:30Z", "path": "jetty-io/src/main/java/org/eclipse/jetty/io/Connection.java", "diffHunk": "@@ -96,31 +96,49 @@\n \n     long getCreatedTimeStamp();\n \n+    /**\n+     * <p>{@link Connection} implementations implement this interface when they\n+     * can upgrade from the protocol they speak (for example HTTP/1.1)\n+     * to a different protocol (e.g. HTTP/2).</p>\n+     *\n+     * @see EndPoint#upgrade(Connection)\n+     * @see UpgradeTo\n+     */\n     interface UpgradeFrom\n     {\n         /**\n-         * <p>Takes the input buffer from the connection on upgrade.</p>\n-         * <p>This method is used to take any unconsumed input from\n-         * a connection during an upgrade.</p>\n+         * <p>Invoked during an {@link EndPoint#upgrade(Connection) upgrade}\n+         * to produce a buffer containing bytes that have not been consumed by\n+         * this connection, and that must be consumed by the upgrade-to\n+         * connection.</p>\n          *\n-         * @return A buffer of unconsumed input. The caller must return the buffer\n-         * to the bufferpool when consumed and this connection must not.\n+         * @return a buffer of unconsumed bytes to pass to the upgrade-to connection.\n+         * The buffer does not belong to any pool and should be discarded after\n+         * having consumed its bytes.\n+         * The returned buffer may be null if there are no unconsumed bytes.\n          */\n         ByteBuffer onUpgradeFrom();\n     }\n \n+    /**\n+     * <p>{@link Connection} implementations implement this interface when they\n+     * can be upgraded to the protocol they speak (e.g. HTTP/2)\n+     * from a different protocol (e.g. HTTP/1.1).</p>\n+     */\n     interface UpgradeTo\n     {\n         /**\n-         * <p>Callback method invoked when this connection is upgraded.</p>\n-         * <p>This must be called before {@link #onOpen()}.</p>\n+         * <p>Invoked during an {@link EndPoint#upgrade(Connection) upgrade}\n+         * to receive a buffer containing bytes that have not been consumed by\n+         * the upgrade-from connection, and that must be consumed by this\n+         * connection.</p>\n          *\n-         * @param prefilled An optional buffer that can contain prefilled data. Typically this\n-         * results from an upgrade of one protocol to the other where the old connection has buffered\n-         * data destined for the new connection.  The new connection must take ownership of the buffer\n-         * and is responsible for returning it to the buffer pool\n+         * @param buffer a non-null buffer of unconsumed bytes received from\n+         * the upgrade-from connection.\n+         * The buffer does not belong to any pool and should be discarded after\n+         * having consumed its bytes.\n          */\n-        void onUpgradeTo(ByteBuffer prefilled);\n+        void onUpgradeTo(ByteBuffer buffer);\n     }", "originalCommit": "359252144d7cfc51b4e08420472ca4831847ec70", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTY2ODQ4Mg==", "url": "https://github.com/eclipse/jetty.project/pull/5008#discussion_r449668482", "bodyText": "@lorban and I discussed this and the problem with the approach he proposes is that onUpgradeFrom() returns a buffer, but it won't know when it's free to release it back to the pool.", "author": "sbordet", "createdAt": "2020-07-03T17:38:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMwMzYyMA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMwNTU0MA==", "url": "https://github.com/eclipse/jetty.project/pull/5008#discussion_r448305540", "bodyText": "Shouldn't we also specify what happens when the current connection is not an instance of UpgradeFrom and/or the new connection is not an instance of UpgradeTo?\nAlso, we could specify what happens when onUpgradeTo does not consume all the bytes of the buffer, like throwing an exception, or discarding the bytes with a warning.", "author": "lorban", "createdAt": "2020-07-01T11:42:34Z", "path": "jetty-io/src/main/java/org/eclipse/jetty/io/EndPoint.java", "diffHunk": "@@ -266,13 +266,15 @@\n     boolean isOptimizedForDirectBuffers();\n \n     /**\n-     * Upgrade connections.\n-     * Close the old connection, update the endpoint and open the new connection.\n-     * If the oldConnection is an instance of {@link Connection.UpgradeFrom} then\n-     * a prefilled buffer is requested and passed to the newConnection if it is an instance\n-     * of {@link Connection.UpgradeTo}\n+     * <p>Upgrades this EndPoint from the current connection to the given new connection.</p>\n+     * <p>Closes the current connection, links this EndPoint to the new connection and\n+     * then opens the new connection.</p>\n+     * <p>If the current connection is an instance of {@link Connection.UpgradeFrom} then\n+     * a buffer of unconsumed bytes is requested; if there are unconsumed bytes, and if\n+     * the new connection is an instance of {@link Connection.UpgradeTo}, the unconsumed\n+     * buffer is passed to the new connection.</p>", "originalCommit": "359252144d7cfc51b4e08420472ca4831847ec70", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "75958cf17328d64179243094248eef0bbdcbf778", "chunk": "diff --git a/jetty-io/src/main/java/org/eclipse/jetty/io/EndPoint.java b/jetty-io/src/main/java/org/eclipse/jetty/io/EndPoint.java\nindex a5c0dce354..95c75ef3b0 100644\n--- a/jetty-io/src/main/java/org/eclipse/jetty/io/EndPoint.java\n+++ b/jetty-io/src/main/java/org/eclipse/jetty/io/EndPoint.java\n\n@@ -270,9 +273,12 @@ public interface EndPoint extends Closeable\n      * <p>Closes the current connection, links this EndPoint to the new connection and\n      * then opens the new connection.</p>\n      * <p>If the current connection is an instance of {@link Connection.UpgradeFrom} then\n-     * a buffer of unconsumed bytes is requested; if there are unconsumed bytes, and if\n-     * the new connection is an instance of {@link Connection.UpgradeTo}, the unconsumed\n-     * buffer is passed to the new connection.</p>\n+     * a buffer of unconsumed bytes is requested.\n+     * If the buffer of unconsumed bytes is non-null and non-empty, then the new\n+     * connection is tested: if it is an instance of {@link Connection.UpgradeTo}, then\n+     * the unconsumed buffer is passed to the new connection; otherwise, an exception\n+     * is thrown since there are unconsumed bytes that cannot be consumed by the new\n+     * connection.</p>\n      *\n      * @param newConnection the connection to upgrade to\n      */\n"}}, {"oid": "12b53713d199b6cc150a95bfae4db732e66a3fde", "url": "https://github.com/eclipse/jetty.project/commit/12b53713d199b6cc150a95bfae4db732e66a3fde", "message": "Fixes #4971 - Simplify Connection.upgradeFrom()/upgradeTo().\n\nStrengthened ByteBufferPool behavior when releasing non-pooled\nByteBuffers: the buffer is now discarded.\n\nSigned-off-by: Simone Bordet <simone.bordet@gmail.com>", "committedDate": "2020-07-06T14:05:06Z", "type": "commit"}, {"oid": "75958cf17328d64179243094248eef0bbdcbf778", "url": "https://github.com/eclipse/jetty.project/commit/75958cf17328d64179243094248eef0bbdcbf778", "message": "Fixes #4971 - Simplify Connection.upgradeFrom()/upgradeTo().\n\nJavadocs.\n\nSigned-off-by: Simone Bordet <simone.bordet@gmail.com>", "committedDate": "2020-07-06T18:28:20Z", "type": "commit"}, {"oid": "44fee6c4045c545f3af71995e8df73308204a208", "url": "https://github.com/eclipse/jetty.project/commit/44fee6c4045c545f3af71995e8df73308204a208", "message": "Fixes #4971 - Simplify Connection.upgradeFrom()/upgradeTo().\n\nFixed javadocs.\n\nSigned-off-by: Simone Bordet <simone.bordet@gmail.com>", "committedDate": "2020-07-06T19:56:24Z", "type": "commit"}]}