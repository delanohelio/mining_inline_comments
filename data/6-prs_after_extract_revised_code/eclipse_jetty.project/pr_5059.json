{"pr_number": 5059, "pr_title": "Issue #4824 - add configuration on RemoteEndpoint for maxOutgoingFrames", "pr_createdAt": "2020-07-17T03:53:48Z", "pr_url": "https://github.com/eclipse/jetty.project/pull/5059", "timeline": [{"oid": "71df3b57eef08040203337f6d83ff28adc86d7c7", "url": "https://github.com/eclipse/jetty.project/commit/71df3b57eef08040203337f6d83ff28adc86d7c7", "message": "Issue #4824 - add configuration on RemoteEndpoint for maxOutgoingFrames\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-04-29T23:39:58Z", "type": "commit"}, {"oid": "576b1e23230aed8660b8e6f1bf296b001dd1eebb", "url": "https://github.com/eclipse/jetty.project/commit/576b1e23230aed8660b8e6f1bf296b001dd1eebb", "message": "Merge remote-tracking branch 'origin/jetty-9.4.x' into jetty-9.4.x-4824-WSmaxOutgoingFrames", "committedDate": "2020-09-02T00:07:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkyNjk1Mg==", "url": "https://github.com/eclipse/jetty.project/pull/5059#discussion_r481926952", "bodyText": "Please change the exception from IOException to WritePendingException.", "author": "sbordet", "createdAt": "2020-09-02T09:19:35Z", "path": "jetty-websocket/websocket-common/src/main/java/org/eclipse/jetty/websocket/common/WebSocketRemoteEndpoint.java", "diffHunk": "@@ -303,6 +305,19 @@ public void uncheckedSendFrame(WebSocketFrame frame, WriteCallback callback)\n         BatchMode batchMode = BatchMode.OFF;\n         if (frame.isDataFrame())\n             batchMode = getBatchMode();\n+\n+        if (maxNumOutgoingFrames > 0 && frame.isDataFrame())\n+        {\n+            // Increase the number of outgoing frames, will be decremented when callback is completed.\n+            int outgoingFrames = numOutgoingFrames.incrementAndGet();\n+            callback = from(callback, numOutgoingFrames::decrementAndGet);\n+            if (outgoingFrames > maxNumOutgoingFrames)\n+            {\n+                callback.writeFailed(new IOException(\"Exceeded max outgoing frames: \" + outgoingFrames + \">\" + maxNumOutgoingFrames));", "originalCommit": "576b1e23230aed8660b8e6f1bf296b001dd1eebb", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f788260abd097308fb5f560baca2345a59d4175f", "chunk": "diff --git a/jetty-websocket/websocket-common/src/main/java/org/eclipse/jetty/websocket/common/WebSocketRemoteEndpoint.java b/jetty-websocket/websocket-common/src/main/java/org/eclipse/jetty/websocket/common/WebSocketRemoteEndpoint.java\nindex aa827f3754..c047cb9481 100644\n--- a/jetty-websocket/websocket-common/src/main/java/org/eclipse/jetty/websocket/common/WebSocketRemoteEndpoint.java\n+++ b/jetty-websocket/websocket-common/src/main/java/org/eclipse/jetty/websocket/common/WebSocketRemoteEndpoint.java\n\n@@ -313,7 +314,7 @@ public class WebSocketRemoteEndpoint implements RemoteEndpoint\n             callback = from(callback, numOutgoingFrames::decrementAndGet);\n             if (outgoingFrames > maxNumOutgoingFrames)\n             {\n-                callback.writeFailed(new IOException(\"Exceeded max outgoing frames: \" + outgoingFrames + \">\" + maxNumOutgoingFrames));\n+                callback.writeFailed(new WritePendingException());\n                 return;\n             }\n         }\n"}}, {"oid": "f788260abd097308fb5f560baca2345a59d4175f", "url": "https://github.com/eclipse/jetty.project/commit/f788260abd097308fb5f560baca2345a59d4175f", "message": "Issue #4824 - use WritePendingException instead of IOException\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-09-03T04:58:09Z", "type": "commit"}, {"oid": "52c9f8730b3881585f814ecbd32733b801e52f4d", "url": "https://github.com/eclipse/jetty.project/commit/52c9f8730b3881585f814ecbd32733b801e52f4d", "message": "Issue #4824 - create test for WebSocket maxOutgoingFrames\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-09-04T00:45:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQzNzAwNg==", "url": "https://github.com/eclipse/jetty.project/pull/5059#discussion_r483437006", "bodyText": "Please add some text that explains what happens if the limit is exceeded.\nWhat operation will get what exception, etc.", "author": "sbordet", "createdAt": "2020-09-04T07:25:11Z", "path": "jetty-websocket/websocket-api/src/main/java/org/eclipse/jetty/websocket/api/RemoteEndpoint.java", "diffHunk": "@@ -141,6 +141,24 @@\n      */\n     void setBatchMode(BatchMode mode);\n \n+    /**\n+     * Set the maximum number of frames which allowed to be waiting to be sent at any one time.\n+     * The default value is -1, this indicates there is no limit on how many frames can be\n+     * queued to be sent by the implementation.", "originalCommit": "52c9f8730b3881585f814ecbd32733b801e52f4d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b5810b930d756f5e1f0878cb6b202abc78ecb164", "chunk": "diff --git a/jetty-websocket/websocket-api/src/main/java/org/eclipse/jetty/websocket/api/RemoteEndpoint.java b/jetty-websocket/websocket-api/src/main/java/org/eclipse/jetty/websocket/api/RemoteEndpoint.java\nindex 37dcec9294..0b13c57fa3 100644\n--- a/jetty-websocket/websocket-api/src/main/java/org/eclipse/jetty/websocket/api/RemoteEndpoint.java\n+++ b/jetty-websocket/websocket-api/src/main/java/org/eclipse/jetty/websocket/api/RemoteEndpoint.java\n\n@@ -144,7 +144,9 @@ public interface RemoteEndpoint\n     /**\n      * Set the maximum number of frames which allowed to be waiting to be sent at any one time.\n      * The default value is -1, this indicates there is no limit on how many frames can be\n-     * queued to be sent by the implementation.\n+     * queued to be sent by the implementation. If the limit is exceeded, subsequent frames\n+     * sent are failed with a {@link java.nio.channels.WritePendingException} but\n+     * the connection is not failed and will remain open.\n      *\n      * @param maxOutgoingFrames the max number of frames.\n      */\n"}}, {"oid": "b5810b930d756f5e1f0878cb6b202abc78ecb164", "url": "https://github.com/eclipse/jetty.project/commit/b5810b930d756f5e1f0878cb6b202abc78ecb164", "message": "Issue #5824 - improve javadocs for RemoteEndpoint maxOutgoingFrames\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-09-04T07:43:36Z", "type": "commit"}, {"oid": "4fd7920143d1d968f014f4cfc8799f0b64234d3c", "url": "https://github.com/eclipse/jetty.project/commit/4fd7920143d1d968f014f4cfc8799f0b64234d3c", "message": "Merge remote-tracking branch 'origin/jetty-9.4.x' into jetty-9.4.x-4824-WSmaxOutgoingFrames", "committedDate": "2020-09-09T23:46:12Z", "type": "commit"}, {"oid": "b44b62038c72524433da5c482c0651257689c027", "url": "https://github.com/eclipse/jetty.project/commit/b44b62038c72524433da5c482c0651257689c027", "message": "reorder methods for maxOutgoingFrames, fix javadoc\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-09-09T23:50:52Z", "type": "commit"}]}