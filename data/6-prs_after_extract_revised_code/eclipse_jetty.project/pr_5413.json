{"pr_number": 5413, "pr_title": "simplify the usage of WebSocketUpgradeFilter in jetty 10", "pr_createdAt": "2020-10-09T06:56:45Z", "pr_url": "https://github.com/eclipse/jetty.project/pull/5413", "timeline": [{"oid": "94bafba6acda7bd31e35f8188c98d644dd01e1cf", "url": "https://github.com/eclipse/jetty.project/commit/94bafba6acda7bd31e35f8188c98d644dd01e1cf", "message": "simplify the usage of WebSocketUpgradeFilter\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-10-09T06:31:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjIyNzY0OA==", "url": "https://github.com/eclipse/jetty.project/pull/5413#discussion_r502227648", "bodyText": "This is the name of the init parameter used to define which ServletContext attribute to use to share the WebSocketMapping.\nI am not really sure what use anyone would have for this as if they set it to anything else they would need to manually add their mappings to the WebSocketMapping which is an internal class.\nI also don't really like the name org.eclipse.jetty.websocket.util.server.internal.WebSocketMapping.key, I think this could simplify this to just WebSocketMapping.\n@gregw what do you think?", "author": "lachlan-roberts", "createdAt": "2020-10-09T07:03:42Z", "path": "jetty-websocket/websocket-util-server/src/main/java/org/eclipse/jetty/websocket/util/server/WebSocketUpgradeFilter.java", "diffHunk": "@@ -78,34 +77,40 @@\n     private static final Logger LOG = LoggerFactory.getLogger(WebSocketUpgradeFilter.class);\n     private static final AutoLock LOCK = new AutoLock();\n \n+    /**\n+     * The init parameter name used to define {@link ServletContext} attribute used to share the {@link WebSocketMapping}.\n+     */\n+    public static final String MAPPING_ATTRIBUTE_INIT_PARAM = \"org.eclipse.jetty.websocket.util.server.internal.WebSocketMapping.key\";", "originalCommit": "94bafba6acda7bd31e35f8188c98d644dd01e1cf", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5d9c81a511d635b03beb3aa870945d6ff0e3fa30", "chunk": "diff --git a/jetty-websocket/websocket-util-server/src/main/java/org/eclipse/jetty/websocket/util/server/WebSocketUpgradeFilter.java b/jetty-websocket/websocket-util-server/src/main/java/org/eclipse/jetty/websocket/util/server/WebSocketUpgradeFilter.java\nindex a89d7e67a0..176544be38 100644\n--- a/jetty-websocket/websocket-util-server/src/main/java/org/eclipse/jetty/websocket/util/server/WebSocketUpgradeFilter.java\n+++ b/jetty-websocket/websocket-util-server/src/main/java/org/eclipse/jetty/websocket/util/server/WebSocketUpgradeFilter.java\n\n@@ -80,7 +80,7 @@ public class WebSocketUpgradeFilter implements Filter, Dumpable\n     /**\n      * The init parameter name used to define {@link ServletContext} attribute used to share the {@link WebSocketMapping}.\n      */\n-    public static final String MAPPING_ATTRIBUTE_INIT_PARAM = \"org.eclipse.jetty.websocket.util.server.internal.WebSocketMapping.key\";\n+    public static final String MAPPING_ATTRIBUTE_INIT_PARAM = \"jetty.websocket.WebSocketMapping\";\n \n     /**\n      * Return any {@link WebSocketUpgradeFilter} already present on the {@link ServletContext}.\n"}}, {"oid": "c40d14a1e95d9a1d3a88537f7ade41c5fe267d4a", "url": "https://github.com/eclipse/jetty.project/commit/c40d14a1e95d9a1d3a88537f7ade41c5fe267d4a", "message": "Merge remote-tracking branch 'origin/jetty-10.0.x' into jetty-10.0.x-WebSocketUpgradeFilter", "committedDate": "2020-10-12T05:38:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzE5NDg2Ng==", "url": "https://github.com/eclipse/jetty.project/pull/5413#discussion_r503194866", "bodyText": "I'm very cautious about this method!\nfirstly, this should probably be a mechanism on BaseHolder even if only used for filters.\nThen if an instance has been set, then the heldClass will be set in the baseHolder, so you really can just look at getHeldClass() and only do something special if it is null.\nBut my biggest concern is that the conversion of className to class is entirely dependent on the thread context classloader when called. This is well defined for when start is called, but not no define at all for when this method is called....\nNeed to think more about this... but please tidy up the above comments while I do!", "author": "gregw", "createdAt": "2020-10-12T10:22:24Z", "path": "jetty-servlet/src/main/java/org/eclipse/jetty/servlet/FilterHolder.java", "diffHunk": "@@ -221,6 +222,39 @@ public void doFilter(ServletRequest request, ServletResponse response, FilterCha\n         }\n     }\n \n+    /**\n+     * Work out the class of the held {@link Filter} even before the {@link FilterHolder} has been started.\n+     * @return the class of the held {@link Filter}, or null if not available.\n+     */\n+    @SuppressWarnings(\"unchecked\")\n+    public Class<? extends Filter> getFilterClass()\n+    {\n+        if (_filter != null)\n+            return _filter.getClass();\n+\n+        Filter filter = getInstance();\n+        if (filter != null)\n+            return filter.getClass();\n+\n+        Class<? extends Filter> heldClass = getHeldClass();\n+        if (heldClass != null)\n+            return heldClass;\n+\n+        String className = getClassName();\n+        if (className != null)\n+        {\n+            try\n+            {\n+                return Loader.loadClass(className);\n+            }\n+            catch (ClassNotFoundException e)\n+            {\n+                LOG.warn(\"Could not load filter class\", e);\n+            }\n+        }\n+        return null;\n+    }\n+", "originalCommit": "c40d14a1e95d9a1d3a88537f7ade41c5fe267d4a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzM5MzA1Nw==", "url": "https://github.com/eclipse/jetty.project/pull/5413#discussion_r503393057", "bodyText": "The other alternative is to use a very specific filter name.  Perhaps the fully qualified class name as the filter name?", "author": "gregw", "createdAt": "2020-10-12T16:03:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzE5NDg2Ng=="}], "type": "inlineReview", "revised_code": {"commit": "5d9c81a511d635b03beb3aa870945d6ff0e3fa30", "chunk": "diff --git a/jetty-servlet/src/main/java/org/eclipse/jetty/servlet/FilterHolder.java b/jetty-servlet/src/main/java/org/eclipse/jetty/servlet/FilterHolder.java\nindex 14dc3c94b7..579ae8dddb 100644\n--- a/jetty-servlet/src/main/java/org/eclipse/jetty/servlet/FilterHolder.java\n+++ b/jetty-servlet/src/main/java/org/eclipse/jetty/servlet/FilterHolder.java\n\n@@ -222,39 +221,6 @@ public class FilterHolder extends Holder<Filter>\n         }\n     }\n \n-    /**\n-     * Work out the class of the held {@link Filter} even before the {@link FilterHolder} has been started.\n-     * @return the class of the held {@link Filter}, or null if not available.\n-     */\n-    @SuppressWarnings(\"unchecked\")\n-    public Class<? extends Filter> getFilterClass()\n-    {\n-        if (_filter != null)\n-            return _filter.getClass();\n-\n-        Filter filter = getInstance();\n-        if (filter != null)\n-            return filter.getClass();\n-\n-        Class<? extends Filter> heldClass = getHeldClass();\n-        if (heldClass != null)\n-            return heldClass;\n-\n-        String className = getClassName();\n-        if (className != null)\n-        {\n-            try\n-            {\n-                return Loader.loadClass(className);\n-            }\n-            catch (ClassNotFoundException e)\n-            {\n-                LOG.warn(\"Could not load filter class\", e);\n-            }\n-        }\n-        return null;\n-    }\n-\n     @Override\n     public void dump(Appendable out, String indent) throws IOException\n     {\n"}}, {"oid": "5d9c81a511d635b03beb3aa870945d6ff0e3fa30", "url": "https://github.com/eclipse/jetty.project/commit/5d9c81a511d635b03beb3aa870945d6ff0e3fa30", "message": "revert to using init parameter to identify the WebSocketUpgradeFilter\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-11-02T04:44:14Z", "type": "commit"}, {"oid": "b327992f75a949b2e245ddd188af0ac61cb313a4", "url": "https://github.com/eclipse/jetty.project/commit/b327992f75a949b2e245ddd188af0ac61cb313a4", "message": "Don't enforce the default WebSocketMapping.\n\nIf a user wants to use the WebSocketUpgradeFilter with a different WebSocketMapping,\nthey can add the ServerContainer manually and put their own WebSocketMapping in.\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-11-02T05:14:27Z", "type": "commit"}, {"oid": "9c78e203149e49cd9ec7b6d178b79d793918d858", "url": "https://github.com/eclipse/jetty.project/commit/9c78e203149e49cd9ec7b6d178b79d793918d858", "message": "Merge remote-tracking branch 'origin/jetty-10.0.x' into jetty-10.0.x-WebSocketUpgradeFilter\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-11-03T23:53:45Z", "type": "commit"}, {"oid": "f857ac97560e8765dadb4df501a5a75dbac56fc7", "url": "https://github.com/eclipse/jetty.project/commit/f857ac97560e8765dadb4df501a5a75dbac56fc7", "message": "fix failures from incorrectly configured WebSocketUpgradeFilters\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-11-04T04:13:59Z", "type": "commit"}]}