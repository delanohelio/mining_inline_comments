{"pr_number": 5789, "pr_title": "Fix the calculation of rates in ConnectionStatistics", "pr_createdAt": "2020-12-10T11:29:08Z", "pr_url": "https://github.com/eclipse/jetty.project/pull/5789", "timeline": [{"oid": "ffe3aa4459c25b3db142b0465699f027e143dd6a", "url": "https://github.com/eclipse/jetty.project/commit/ffe3aa4459c25b3db142b0465699f027e143dd6a", "message": "Issue #5783 - fix getRate() methods on ConnectionStatistics\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-12-10T11:15:59Z", "type": "commit"}, {"oid": "8a940fc18111daf11e4965a12c3e330b1f694267", "url": "https://github.com/eclipse/jetty.project/commit/8a940fc18111daf11e4965a12c3e330b1f694267", "message": "Issue #5783 - start _rateCheckTimeStamp at current time\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-12-10T11:22:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjIwNDk4MQ==", "url": "https://github.com/eclipse/jetty.project/pull/5789#discussion_r546204981", "bodyText": "Is the total really necessary in this class?\nIt is entirely independent so no benefit being in here.  If you just want a rate you don't need it, if you also want the total then just have a LongAdder in addition to a RateCounter.", "author": "gregw", "createdAt": "2020-12-19T07:21:25Z", "path": "jetty-util/src/main/java/org/eclipse/jetty/util/statistic/RateCounter.java", "diffHunk": "@@ -0,0 +1,61 @@\n+//\n+//  ========================================================================\n+//  Copyright (c) 1995-2020 Mort Bay Consulting Pty Ltd and others.\n+//  ------------------------------------------------------------------------\n+//  All rights reserved. This program and the accompanying materials\n+//  are made available under the terms of the Eclipse Public License v1.0\n+//  and Apache License v2.0 which accompanies this distribution.\n+//\n+//      The Eclipse Public License is available at\n+//      http://www.eclipse.org/legal/epl-v10.html\n+//\n+//      The Apache License v2.0 is available at\n+//      http://www.opensource.org/licenses/apache2.0.php\n+//\n+//  You may elect to redistribute this code under either of these licenses.\n+//  ========================================================================\n+//\n+\n+package org.eclipse.jetty.util.statistic;\n+\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicLong;\n+import java.util.concurrent.atomic.LongAdder;\n+\n+/**\n+ * Gives the same basic functionality of {@link LongAdder} but allows you to check\n+ * the rate of increase of the sum since the last call to {@link #getRate()};\n+ */\n+public class RateCounter\n+{\n+    private final LongAdder _total = new LongAdder();", "originalCommit": "8a940fc18111daf11e4965a12c3e330b1f694267", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjUwOTk0MA==", "url": "https://github.com/eclipse/jetty.project/pull/5789#discussion_r546509940", "bodyText": "I removed the total from the RateCounter.\nYou now have to explicitly call  RateCounter.reset() to reset it, it doesn't do this automatically on the RateCounter.getRate() call anymore, the reset is called from the ConnectionStatistics.getRate() methods.", "author": "lachlan-roberts", "createdAt": "2020-12-21T05:01:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjIwNDk4MQ=="}], "type": "inlineReview", "revised_code": {"commit": "4e9e9b8d19fe58be4be041d0d516cf3384ddd0b2", "chunk": "diff --git a/jetty-util/src/main/java/org/eclipse/jetty/util/statistic/RateCounter.java b/jetty-util/src/main/java/org/eclipse/jetty/util/statistic/RateCounter.java\nindex 660597577b..2de5f10797 100644\n--- a/jetty-util/src/main/java/org/eclipse/jetty/util/statistic/RateCounter.java\n+++ b/jetty-util/src/main/java/org/eclipse/jetty/util/statistic/RateCounter.java\n\n@@ -23,39 +23,27 @@ import java.util.concurrent.atomic.AtomicLong;\n import java.util.concurrent.atomic.LongAdder;\n \n /**\n- * Gives the same basic functionality of {@link LongAdder} but allows you to check\n- * the rate of increase of the sum since the last call to {@link #getRate()};\n+ * Counts the rate that {@link Long}s are added to this from the time of creation or the last call to {@link #reset()}.\n  */\n public class RateCounter\n {\n     private final LongAdder _total = new LongAdder();\n-    private final LongAdder _totalSinceRateCheck = new LongAdder();\n-    private final AtomicLong _rateCheckTimeStamp = new AtomicLong(System.nanoTime());\n-\n-    public long sum()\n-    {\n-        return _total.sum();\n-    }\n+    private final AtomicLong _timeStamp = new AtomicLong(System.nanoTime());\n \n     public void add(long l)\n     {\n         _total.add(l);\n-        _totalSinceRateCheck.add(l);\n     }\n \n-    public void reset()\n+    public long getRate()\n     {\n-        _rateCheckTimeStamp.getAndSet(System.nanoTime());\n-        _totalSinceRateCheck.reset();\n-        _total.reset();\n+        long elapsed = TimeUnit.NANOSECONDS.toMillis(System.nanoTime() - _timeStamp.get());\n+        return elapsed == 0 ? 0 : _total.sum() * 1000 / elapsed;\n     }\n \n-    public long getRate()\n+    public void reset()\n     {\n-        long totalSinceLastCheck = _totalSinceRateCheck.sumThenReset();\n-        long now = System.nanoTime();\n-        long then = _rateCheckTimeStamp.getAndSet(now);\n-        long elapsed = TimeUnit.NANOSECONDS.toMillis(now - then);\n-        return elapsed == 0 ? 0 : totalSinceLastCheck * 1000 / elapsed;\n+        _timeStamp.getAndSet(System.nanoTime());\n+        _total.reset();\n     }\n }\n"}}, {"oid": "4e9e9b8d19fe58be4be041d0d516cf3384ddd0b2", "url": "https://github.com/eclipse/jetty.project/commit/4e9e9b8d19fe58be4be041d0d516cf3384ddd0b2", "message": "Remove the total count from the RateCounter.\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-12-21T04:55:54Z", "type": "commit"}]}