{"pr_number": 4499, "pr_title": "Issue #4495 ReservedThreadExecutor optimise", "pr_createdAt": "2020-01-20T12:08:36Z", "pr_url": "https://github.com/eclipse/jetty.project/pull/4499", "timeline": [{"oid": "1ee64cb5ceb0eda01320a90af84c721b5194de9d", "url": "https://github.com/eclipse/jetty.project/commit/1ee64cb5ceb0eda01320a90af84c721b5194de9d", "message": "Issue #4495 ReservedThreadExecutor optimise\n\nUse synchronousQueue for task handoff\n\nSigned-off-by: Greg Wilkins <gregw@webtide.com>", "committedDate": "2020-01-20T12:06:55Z", "type": "commit"}, {"oid": "02cd928bfcb7de3bc4dd91897bbcb8aad249d1da", "url": "https://github.com/eclipse/jetty.project/commit/02cd928bfcb7de3bc4dd91897bbcb8aad249d1da", "message": "Issue #4495 ReservedThreadExecutor optimise\n\nupdates from review\n\nSigned-off-by: Greg Wilkins <gregw@webtide.com>", "committedDate": "2020-01-20T15:10:04Z", "type": "commit"}, {"oid": "0dd187980004dff9283d7d5b44a57ccb098423b3", "url": "https://github.com/eclipse/jetty.project/commit/0dd187980004dff9283d7d5b44a57ccb098423b3", "message": "Issue #4495 ReservedThreadExecutor optimise\n\nUse a linked queue rather than a deque(as a stack).  This should be simpler, better optimised and less contended.  Idling has been simplified so that a reserve thread is always dropped every idle period.\n\nSigned-off-by: Greg Wilkins <gregw@webtide.com>", "committedDate": "2020-01-20T15:49:26Z", "type": "commit"}, {"oid": "88b46703118d5ddb69e644af6b83252b73ddd9ef", "url": "https://github.com/eclipse/jetty.project/commit/88b46703118d5ddb69e644af6b83252b73ddd9ef", "message": "Issue #4495 ReservedThreadExecutor optimise\n\nreverted RTE and added a JMH benchmark\n\nSigned-off-by: Greg Wilkins <gregw@webtide.com>", "committedDate": "2020-01-20T16:54:13Z", "type": "commit"}, {"oid": "d4c620bd3431e27e5616a370fc70fb984e00acba", "url": "https://github.com/eclipse/jetty.project/commit/d4c620bd3431e27e5616a370fc70fb984e00acba", "message": "More variants and longer tests\n\nSigned-off-by: Greg Wilkins <gregw@webtide.com>", "committedDate": "2020-01-21T08:27:41Z", "type": "commit"}, {"oid": "bbda80763e7b9c07dfa5726216c023f1bcd5d4b3", "url": "https://github.com/eclipse/jetty.project/commit/bbda80763e7b9c07dfa5726216c023f1bcd5d4b3", "message": "Added LQ\n\nSigned-off-by: Greg Wilkins <gregw@webtide.com>", "committedDate": "2020-01-21T09:33:06Z", "type": "commit"}, {"oid": "d486fb0dd5a5109dbdcc75c75a81b221a795d70d", "url": "https://github.com/eclipse/jetty.project/commit/d486fb0dd5a5109dbdcc75c75a81b221a795d70d", "message": "removed SQ2\n\nSigned-off-by: Greg Wilkins <gregw@webtide.com>", "committedDate": "2020-01-21T10:29:34Z", "type": "commit"}, {"oid": "403cc41f6fd5e1a0874b2d41bc332aaeac43e186", "url": "https://github.com/eclipse/jetty.project/commit/403cc41f6fd5e1a0874b2d41bc332aaeac43e186", "message": "Issue #4495 ReservedThreadExecutor optimise\n\nReplaced real implementation with SQ\n\nSigned-off-by: Greg Wilkins <gregw@webtide.com>", "committedDate": "2020-01-21T12:41:42Z", "type": "commit"}, {"oid": "51807f715136e270bff7af066fcee7d5ebdf2589", "url": "https://github.com/eclipse/jetty.project/commit/51807f715136e270bff7af066fcee7d5ebdf2589", "message": "Merge remote-tracking branch 'origin/jetty-9.4.x' into jetty-9.4.x-4495-ReservedThreadExecutor-Optimise", "committedDate": "2020-01-31T10:56:22Z", "type": "commit"}, {"oid": "458cb8c7edf91e01cd7de436374b737b2485d51f", "url": "https://github.com/eclipse/jetty.project/commit/458cb8c7edf91e01cd7de436374b737b2485d51f", "message": "Issue #4495 RTE optimise\n\nRemoved alternate implementations\n\nSigned-off-by: Greg Wilkins <gregw@webtide.com>", "committedDate": "2020-01-31T11:03:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQ1NzUxMA==", "url": "https://github.com/eclipse/jetty.project/pull/4499#discussion_r373457510", "bodyText": "Better catch Throwable here.", "author": "sbordet", "createdAt": "2020-01-31T12:32:41Z", "path": "jetty-util/src/main/java/org/eclipse/jetty/util/thread/ReservedThreadExecutor.java", "diffHunk": "@@ -264,20 +265,25 @@ public String toString()\n \n     private class ReservedThread implements Runnable\n     {\n-        private final Locker _locker = new Locker();\n-        private final Condition _wakeup = _locker.newCondition();\n+        private final SynchronousQueue<Runnable> _task = new SynchronousQueue<>();\n         private boolean _starting = true;\n-        private Runnable _task = null;\n \n-        public void offer(Runnable task)\n+        public boolean offer(Runnable task)\n         {\n             if (LOG.isDebugEnabled())\n                 LOG.debug(\"{} offer {}\", this, task);\n \n-            try (Locker.Lock lock = _locker.lock())\n+            try\n+            {\n+                _task.put(task);\n+                return true;\n+            }\n+            catch (InterruptedException e)", "originalCommit": "458cb8c7edf91e01cd7de436374b737b2485d51f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "4708509e3636df5d42b3157afab552ff7c29ffce", "chunk": "diff --git a/jetty-util/src/main/java/org/eclipse/jetty/util/thread/ReservedThreadExecutor.java b/jetty-util/src/main/java/org/eclipse/jetty/util/thread/ReservedThreadExecutor.java\nindex b88c95b5c6..0bc982c266 100644\n--- a/jetty-util/src/main/java/org/eclipse/jetty/util/thread/ReservedThreadExecutor.java\n+++ b/jetty-util/src/main/java/org/eclipse/jetty/util/thread/ReservedThreadExecutor.java\n\n@@ -278,7 +278,7 @@ public class ReservedThreadExecutor extends AbstractLifeCycle implements TryExec\n                 _task.put(task);\n                 return true;\n             }\n-            catch (InterruptedException e)\n+            catch (Throwable e)\n             {\n                 LOG.ignore(e);\n                 _size.getAndIncrement();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQ1NzY0NA==", "url": "https://github.com/eclipse/jetty.project/pull/4499#discussion_r373457644", "bodyText": "Should be _idleTime <= 0.", "author": "sbordet", "createdAt": "2020-01-31T12:33:03Z", "path": "jetty-util/src/main/java/org/eclipse/jetty/util/thread/ReservedThreadExecutor.java", "diffHunk": "@@ -296,37 +302,12 @@ private Runnable reservedWait()\n                 if (!isRunning())\n                     return STOP;\n \n-                boolean idle = false;\n-                try (Locker.Lock lock = _locker.lock())\n+                try\n                 {\n-                    if (_task == null)\n-                    {\n-                        try\n-                        {\n-                            if (_idleTime == 0)\n-                                _wakeup.await();\n-                            else\n-                                idle = !_wakeup.await(_idleTime, _idleTimeUnit);\n-                        }\n-                        catch (InterruptedException e)\n-                        {\n-                            LOG.ignore(e);\n-                        }\n-                    }\n-                    else\n-                    {\n-                        Runnable task = _task;\n-                        _task = null;\n-\n-                        if (LOG.isDebugEnabled())\n-                            LOG.debug(\"{} task={}\", this, task);\n-\n+                    Runnable task = _idleTime == 0 ? _task.take() : _task.poll(_idleTime, _idleTimeUnit);", "originalCommit": "458cb8c7edf91e01cd7de436374b737b2485d51f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "4708509e3636df5d42b3157afab552ff7c29ffce", "chunk": "diff --git a/jetty-util/src/main/java/org/eclipse/jetty/util/thread/ReservedThreadExecutor.java b/jetty-util/src/main/java/org/eclipse/jetty/util/thread/ReservedThreadExecutor.java\nindex b88c95b5c6..0bc982c266 100644\n--- a/jetty-util/src/main/java/org/eclipse/jetty/util/thread/ReservedThreadExecutor.java\n+++ b/jetty-util/src/main/java/org/eclipse/jetty/util/thread/ReservedThreadExecutor.java\n\n@@ -304,7 +304,9 @@ public class ReservedThreadExecutor extends AbstractLifeCycle implements TryExec\n \n                 try\n                 {\n-                    Runnable task = _idleTime == 0 ? _task.take() : _task.poll(_idleTime, _idleTimeUnit);\n+                    Runnable task = _idleTime <= 0 ? _task.take() : _task.poll(_idleTime, _idleTimeUnit);\n+                    if (LOG.isDebugEnabled())\n+                        LOG.debug(\"{} task={}\", this, task);\n                     if (task != null)\n                         return task;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQ1ODA5NQ==", "url": "https://github.com/eclipse/jetty.project/pull/4499#discussion_r373458095", "bodyText": "There was a LOG.debug() statement when we had a non-null task that I would like to keep.", "author": "sbordet", "createdAt": "2020-01-31T12:34:19Z", "path": "jetty-util/src/main/java/org/eclipse/jetty/util/thread/ReservedThreadExecutor.java", "diffHunk": "@@ -296,37 +302,12 @@ private Runnable reservedWait()\n                 if (!isRunning())\n                     return STOP;\n \n-                boolean idle = false;\n-                try (Locker.Lock lock = _locker.lock())\n+                try\n                 {\n-                    if (_task == null)\n-                    {\n-                        try\n-                        {\n-                            if (_idleTime == 0)\n-                                _wakeup.await();\n-                            else\n-                                idle = !_wakeup.await(_idleTime, _idleTimeUnit);\n-                        }\n-                        catch (InterruptedException e)\n-                        {\n-                            LOG.ignore(e);\n-                        }\n-                    }\n-                    else\n-                    {\n-                        Runnable task = _task;\n-                        _task = null;\n-\n-                        if (LOG.isDebugEnabled())\n-                            LOG.debug(\"{} task={}\", this, task);\n-\n+                    Runnable task = _idleTime == 0 ? _task.take() : _task.poll(_idleTime, _idleTimeUnit);\n+                    if (task != null)", "originalCommit": "458cb8c7edf91e01cd7de436374b737b2485d51f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "4708509e3636df5d42b3157afab552ff7c29ffce", "chunk": "diff --git a/jetty-util/src/main/java/org/eclipse/jetty/util/thread/ReservedThreadExecutor.java b/jetty-util/src/main/java/org/eclipse/jetty/util/thread/ReservedThreadExecutor.java\nindex b88c95b5c6..0bc982c266 100644\n--- a/jetty-util/src/main/java/org/eclipse/jetty/util/thread/ReservedThreadExecutor.java\n+++ b/jetty-util/src/main/java/org/eclipse/jetty/util/thread/ReservedThreadExecutor.java\n\n@@ -304,7 +304,9 @@ public class ReservedThreadExecutor extends AbstractLifeCycle implements TryExec\n \n                 try\n                 {\n-                    Runnable task = _idleTime == 0 ? _task.take() : _task.poll(_idleTime, _idleTimeUnit);\n+                    Runnable task = _idleTime <= 0 ? _task.take() : _task.poll(_idleTime, _idleTimeUnit);\n+                    if (LOG.isDebugEnabled())\n+                        LOG.debug(\"{} task={}\", this, task);\n                     if (task != null)\n                         return task;\n \n"}}, {"oid": "4708509e3636df5d42b3157afab552ff7c29ffce", "url": "https://github.com/eclipse/jetty.project/commit/4708509e3636df5d42b3157afab552ff7c29ffce", "message": "Issue #4495 RTE optimise\n\nupdates from review\n\nSigned-off-by: Greg Wilkins <gregw@webtide.com>", "committedDate": "2020-01-31T12:55:59Z", "type": "commit"}]}