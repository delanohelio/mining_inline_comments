{"pr_number": 5405, "pr_title": "Issue #5378 - add test to reproduce issue with WebSocketUpgradeFilter not started", "pr_createdAt": "2020-10-07T21:53:33Z", "pr_url": "https://github.com/eclipse/jetty.project/pull/5405", "timeline": [{"oid": "2a4d672fc1ccf82a57ee6a98fe0a718dcdf3b104", "url": "https://github.com/eclipse/jetty.project/commit/2a4d672fc1ccf82a57ee6a98fe0a718dcdf3b104", "message": "Issue #5378 - improve testing for WebSocketUpgradeFilter\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-10-07T21:46:51Z", "type": "commit"}, {"oid": "7003b3c42e06425b6dc07599039b1661811c3e19", "url": "https://github.com/eclipse/jetty.project/commit/7003b3c42e06425b6dc07599039b1661811c3e19", "message": "Issue #5378 - guard against concurrent requests lazily initializing the filter\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-10-07T21:46:51Z", "type": "commit"}, {"oid": "d2beb2861d795a479ab89de6f9bd6446b7548648", "url": "https://github.com/eclipse/jetty.project/commit/d2beb2861d795a479ab89de6f9bd6446b7548648", "message": "Merge remote-tracking branch 'origin/jetty-10.0.x' into jetty-10.0.x-5378-LazyWSUpgradeFilter", "committedDate": "2020-10-07T22:27:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTUxNTkzMg==", "url": "https://github.com/eclipse/jetty.project/pull/5405#discussion_r501515932", "bodyText": "Are there other ensureFoo methods in the websocket setup that also need such locks?", "author": "gregw", "createdAt": "2020-10-08T07:50:43Z", "path": "jetty-websocket/websocket-util-server/src/main/java/org/eclipse/jetty/websocket/util/server/WebSocketUpgradeFilter.java", "diffHunk": "@@ -105,22 +109,27 @@ private static FilterHolder getFilter(ServletContext servletContext)\n      */\n     public static FilterHolder ensureFilter(ServletContext servletContext)\n     {\n-        FilterHolder existingFilter = WebSocketUpgradeFilter.getFilter(servletContext);\n-        if (existingFilter != null)\n-            return existingFilter;\n-\n-        final String name = \"WebSocketUpgradeFilter\";\n-        final String pathSpec = \"/*\";\n-        FilterHolder holder = new FilterHolder(new WebSocketUpgradeFilter());\n-        holder.setName(name);\n-        holder.setInitParameter(MAPPING_ATTRIBUTE_INIT_PARAM, WebSocketMapping.DEFAULT_KEY);\n-\n-        holder.setAsyncSupported(true);\n-        ServletHandler servletHandler = ContextHandler.getContextHandler(servletContext).getChildHandlerByClass(ServletHandler.class);\n-        servletHandler.addFilterWithMapping(holder, pathSpec, EnumSet.of(DispatcherType.REQUEST));\n-        if (LOG.isDebugEnabled())\n-            LOG.debug(\"Adding {} mapped to {} in {}\", holder, pathSpec, servletContext);\n-        return holder;\n+        // Lock in case two concurrent requests are initializing the filter lazily.\n+        try (AutoLock l = LOCK.lock())", "originalCommit": "d2beb2861d795a479ab89de6f9bd6446b7548648", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTUxODM4OQ==", "url": "https://github.com/eclipse/jetty.project/pull/5405#discussion_r501518389", "bodyText": "I'll approve this PR, but feel free to add other such locks before merging.", "author": "gregw", "createdAt": "2020-10-08T07:54:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTUxNTkzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTU2NjAwMg==", "url": "https://github.com/eclipse/jetty.project/pull/5405#discussion_r501566002", "bodyText": "The other ensureFoo methods are all called directly from within the SCI, so we don't get the same sort of race occurring.\nDo you think we should just add the locks there as well anyway?", "author": "lachlan-roberts", "createdAt": "2020-10-08T09:10:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTUxNTkzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTU4Mjg2NA==", "url": "https://github.com/eclipse/jetty.project/pull/5405#discussion_r501582864", "bodyText": "Ok. No need then.", "author": "gregw", "createdAt": "2020-10-08T09:37:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTUxNTkzMg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTUxNjgwNQ==", "url": "https://github.com/eclipse/jetty.project/pull/5405#discussion_r501516805", "bodyText": "Can we put a check within configure on the start of the contextHandler passed?  If it is started then it should ISE.   No sure about if it is starting?", "author": "gregw", "createdAt": "2020-10-08T07:52:14Z", "path": "jetty-websocket/websocket-jetty-tests/src/test/java/org/eclipse/jetty/websocket/tests/JettyWebSocketFilterTest.java", "diffHunk": "@@ -45,18 +50,29 @@\n     private WebSocketClient client;\n     private ServletContextHandler contextHandler;\n \n-    @BeforeEach\n-    public void start() throws Exception\n+    public void start(JettyWebSocketServletContainerInitializer.Configurator configurator) throws Exception\n+    {\n+        start(configurator, null);\n+    }\n+\n+    public void start(ServletHolder servletHolder) throws Exception\n+    {\n+        start(null, servletHolder);\n+    }\n+\n+    public void start(JettyWebSocketServletContainerInitializer.Configurator configurator, ServletHolder servletHolder) throws Exception\n     {\n         server = new Server();\n         connector = new ServerConnector(server);\n         server.addConnector(connector);\n \n         contextHandler = new ServletContextHandler(ServletContextHandler.SESSIONS);\n         contextHandler.setContextPath(\"/\");\n+        if (servletHolder != null)\n+            contextHandler.addServlet(servletHolder, \"/\");\n         server.setHandler(contextHandler);\n \n-        JettyWebSocketServletContainerInitializer.configure(contextHandler, null);\n+        JettyWebSocketServletContainerInitializer.configure(contextHandler, configurator);", "originalCommit": "d2beb2861d795a479ab89de6f9bd6446b7548648", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTUxODAzMA==", "url": "https://github.com/eclipse/jetty.project/pull/5405#discussion_r501518030", "bodyText": "Ah I just saw #5406, so ignore this one.", "author": "gregw", "createdAt": "2020-10-08T07:54:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTUxNjgwNQ=="}], "type": "inlineReview", "revised_code": null}]}