{"pr_number": 5481, "pr_title": "NPE protection on WebInfConfiguration.deconfigure()", "pr_createdAt": "2020-10-20T21:32:57Z", "pr_url": "https://github.com/eclipse/jetty.project/pull/5481", "timeline": [{"oid": "0e98c370fd00492dc6973e017b9b7cc3315280be", "url": "https://github.com/eclipse/jetty.project/commit/0e98c370fd00492dc6973e017b9b7cc3315280be", "message": "Issue #5480 - NPE protection on IO.delete(File)\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>", "committedDate": "2020-10-20T21:28:36Z", "type": "commit"}, {"oid": "227dd47157c6839d137b49a14e6085f42787f444", "url": "https://github.com/eclipse/jetty.project/commit/227dd47157c6839d137b49a14e6085f42787f444", "message": "Issue #5480 - Fail in jetty-maven-plugin if unable to create temp directory.\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>", "committedDate": "2020-10-20T21:29:22Z", "type": "commit"}, {"oid": "6be6fae291eff4ff8d7449d7f222812e02c76645", "url": "https://github.com/eclipse/jetty.project/commit/6be6fae291eff4ff8d7449d7f222812e02c76645", "message": "Issue #5480 - NPE Check in WebInfConfiguration.deconfigure()\n\n+ Removing Temp dir deletion in configureTempDirectory()\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>", "committedDate": "2020-10-20T21:30:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODg1NjE4Ng==", "url": "https://github.com/eclipse/jetty.project/pull/5481#discussion_r508856186", "bodyText": "I'm not sure about this .... we need to check that if the dir should not be persisted then anything that is already in it should be removed before we try and unpack the webapp into it.", "author": "janbartel", "createdAt": "2020-10-20T21:38:57Z", "path": "jetty-webapp/src/main/java/org/eclipse/jetty/webapp/WebInfConfiguration.java", "diffHunk": "@@ -522,21 +522,16 @@ public void configureTempDirectory(File dir, WebAppContext context)\n         if (dir == null)\n             throw new IllegalArgumentException(\"Null temp dir\");\n \n-        //if dir exists and we don't want it persisted, delete it\n-        if (dir.exists() && !context.isPersistTempDirectory())\n+        // if it doesn't exist make it", "originalCommit": "6be6fae291eff4ff8d7449d7f222812e02c76645", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODg1Nzk1Mg==", "url": "https://github.com/eclipse/jetty.project/pull/5481#discussion_r508857952", "bodyText": "But we cannot remove it arbitrarily here, only under small circumstance will removing the directory itself be safe.\nThis step isn't really necessary as both the WebInfConfiguration.deconfigure() and the Temp directory specific File.deleteOnExit() both cover the deletion angle.\nAs an alternative, we could simply clear out the directory contents.", "author": "joakime", "createdAt": "2020-10-20T21:42:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODg1NjE4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODg1ODUwNQ==", "url": "https://github.com/eclipse/jetty.project/pull/5481#discussion_r508858505", "bodyText": "yep I think we need to clear it out", "author": "gregw", "createdAt": "2020-10-20T21:43:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODg1NjE4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODg1OTI3MA==", "url": "https://github.com/eclipse/jetty.project/pull/5481#discussion_r508859270", "bodyText": "Yes, I'd prefer to clear out the directory contents, and leave the dir in place.\nThis is safeguarding if the previous deconfigure() failed, and deleteOnExit might not come into play because you're just restarting the context/server without restarting the jvm.", "author": "janbartel", "createdAt": "2020-10-20T21:45:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODg1NjE4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODg2NTQ0Mw==", "url": "https://github.com/eclipse/jetty.project/pull/5481#discussion_r508865443", "bodyText": "The temp directory deletion block has been restored.", "author": "joakime", "createdAt": "2020-10-20T21:58:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODg1NjE4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODg2NzAzMQ==", "url": "https://github.com/eclipse/jetty.project/pull/5481#discussion_r508867031", "bodyText": "About the concern about prior directory (example given is context/server restart) ...\nThe Files.createTempDirectory path (or the older File.createTempFile path), this delete would never have deleted the prior directory, as each time you enter this block you have a new directory path.", "author": "joakime", "createdAt": "2020-10-20T22:01:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODg1NjE4Ng=="}], "type": "inlineReview", "revised_code": {"commit": "c7ae5b50ab8bfffe46aca5cc8cf1ceef305fa316", "chunk": "diff --git a/jetty-webapp/src/main/java/org/eclipse/jetty/webapp/WebInfConfiguration.java b/jetty-webapp/src/main/java/org/eclipse/jetty/webapp/WebInfConfiguration.java\nindex 53ec88c942..6fbe03080d 100644\n--- a/jetty-webapp/src/main/java/org/eclipse/jetty/webapp/WebInfConfiguration.java\n+++ b/jetty-webapp/src/main/java/org/eclipse/jetty/webapp/WebInfConfiguration.java\n\n@@ -522,6 +526,12 @@ public class WebInfConfiguration extends AbstractConfiguration\n         if (dir == null)\n             throw new IllegalArgumentException(\"Null temp dir\");\n \n+        // if dir exists and we don't want it persisted, delete it\n+        if (!context.isPersistTempDirectory() && dir.exists() && !IO.delete(dir))\n+        {\n+            throw new IllegalStateException(\"Failed to delete temp dir \" + dir);\n+        }\n+\n         // if it doesn't exist make it\n         if (!dir.exists())\n         {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODg1NjU3Mw==", "url": "https://github.com/eclipse/jetty.project/pull/5481#discussion_r508856573", "bodyText": "You need to keep the if (!context.isPersistTempDirectory) dir.deleteOnExit.", "author": "janbartel", "createdAt": "2020-10-20T21:39:45Z", "path": "jetty-webapp/src/main/java/org/eclipse/jetty/webapp/WebInfConfiguration.java", "diffHunk": "@@ -522,21 +522,16 @@ public void configureTempDirectory(File dir, WebAppContext context)\n         if (dir == null)\n             throw new IllegalArgumentException(\"Null temp dir\");\n \n-        //if dir exists and we don't want it persisted, delete it\n-        if (dir.exists() && !context.isPersistTempDirectory())\n+        // if it doesn't exist make it\n+        if (!dir.exists())\n         {\n-            if (!IO.delete(dir))\n-                throw new IllegalStateException(\"Failed to delete temp dir \" + dir);\n+            if (!dir.mkdirs())\n+            {\n+                throw new IllegalStateException(\"Unable to create temp dir \" + dir);\n+            }\n         }\n \n-        //if it doesn't exist make it\n-        if (!dir.exists())\n-            dir.mkdirs();\n-\n-        if (!context.isPersistTempDirectory())\n-            dir.deleteOnExit();\n-\n-        //is it useable\n+        // is it useable", "originalCommit": "6be6fae291eff4ff8d7449d7f222812e02c76645", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODg1ODA3MQ==", "url": "https://github.com/eclipse/jetty.project/pull/5481#discussion_r508858071", "bodyText": "That's covered in makeTempDirectory() already.", "author": "joakime", "createdAt": "2020-10-20T21:42:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODg1NjU3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODg1ODcwMA==", "url": "https://github.com/eclipse/jetty.project/pull/5481#discussion_r508858700", "bodyText": "Scratch that, i'm wrong about this specific one.", "author": "joakime", "createdAt": "2020-10-20T21:44:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODg1NjU3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODg2MDg2MA==", "url": "https://github.com/eclipse/jetty.project/pull/5481#discussion_r508860860", "bodyText": "No, it's also called directly by resolveTempDirectory in the case where someone has explicitly supplied the temp directory to use or the javax.servlet.context.tempDir has been set - whether these are persisted or not is optional and configured by configureTempDirectory.", "author": "janbartel", "createdAt": "2020-10-20T21:48:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODg1NjU3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODg2NTY1Mw==", "url": "https://github.com/eclipse/jetty.project/pull/5481#discussion_r508865653", "bodyText": "deleteOnExit has been restored.", "author": "joakime", "createdAt": "2020-10-20T21:58:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODg1NjU3Mw=="}], "type": "inlineReview", "revised_code": {"commit": "c7ae5b50ab8bfffe46aca5cc8cf1ceef305fa316", "chunk": "diff --git a/jetty-webapp/src/main/java/org/eclipse/jetty/webapp/WebInfConfiguration.java b/jetty-webapp/src/main/java/org/eclipse/jetty/webapp/WebInfConfiguration.java\nindex 53ec88c942..6fbe03080d 100644\n--- a/jetty-webapp/src/main/java/org/eclipse/jetty/webapp/WebInfConfiguration.java\n+++ b/jetty-webapp/src/main/java/org/eclipse/jetty/webapp/WebInfConfiguration.java\n\n@@ -522,6 +526,12 @@ public class WebInfConfiguration extends AbstractConfiguration\n         if (dir == null)\n             throw new IllegalArgumentException(\"Null temp dir\");\n \n+        // if dir exists and we don't want it persisted, delete it\n+        if (!context.isPersistTempDirectory() && dir.exists() && !IO.delete(dir))\n+        {\n+            throw new IllegalStateException(\"Failed to delete temp dir \" + dir);\n+        }\n+\n         // if it doesn't exist make it\n         if (!dir.exists())\n         {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODg1Njg0Ng==", "url": "https://github.com/eclipse/jetty.project/pull/5481#discussion_r508856846", "bodyText": "You've changed the logic here.   This was always deleting and recreating a non persistent temp dir.\nWe  don't want to do that any more because of hijacking!   But I think we have to ensure the tempdir is empty if it is not persistent.", "author": "gregw", "createdAt": "2020-10-20T21:40:17Z", "path": "jetty-webapp/src/main/java/org/eclipse/jetty/webapp/WebInfConfiguration.java", "diffHunk": "@@ -522,21 +522,16 @@ public void configureTempDirectory(File dir, WebAppContext context)\n         if (dir == null)\n             throw new IllegalArgumentException(\"Null temp dir\");\n \n-        //if dir exists and we don't want it persisted, delete it\n-        if (dir.exists() && !context.isPersistTempDirectory())\n+        // if it doesn't exist make it\n+        if (!dir.exists())", "originalCommit": "6be6fae291eff4ff8d7449d7f222812e02c76645", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c7ae5b50ab8bfffe46aca5cc8cf1ceef305fa316", "chunk": "diff --git a/jetty-webapp/src/main/java/org/eclipse/jetty/webapp/WebInfConfiguration.java b/jetty-webapp/src/main/java/org/eclipse/jetty/webapp/WebInfConfiguration.java\nindex 53ec88c942..6fbe03080d 100644\n--- a/jetty-webapp/src/main/java/org/eclipse/jetty/webapp/WebInfConfiguration.java\n+++ b/jetty-webapp/src/main/java/org/eclipse/jetty/webapp/WebInfConfiguration.java\n\n@@ -522,6 +526,12 @@ public class WebInfConfiguration extends AbstractConfiguration\n         if (dir == null)\n             throw new IllegalArgumentException(\"Null temp dir\");\n \n+        // if dir exists and we don't want it persisted, delete it\n+        if (!context.isPersistTempDirectory() && dir.exists() && !IO.delete(dir))\n+        {\n+            throw new IllegalStateException(\"Failed to delete temp dir \" + dir);\n+        }\n+\n         // if it doesn't exist make it\n         if (!dir.exists())\n         {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODg1NzEwMA==", "url": "https://github.com/eclipse/jetty.project/pull/5481#discussion_r508857100", "bodyText": "assign getTempDirectory() to a variable", "author": "gregw", "createdAt": "2020-10-20T21:40:48Z", "path": "jetty-webapp/src/main/java/org/eclipse/jetty/webapp/WebInfConfiguration.java", "diffHunk": "@@ -355,7 +355,7 @@ public void configure(WebAppContext context) throws Exception\n     public void deconfigure(WebAppContext context) throws Exception\n     {\n         //if we're not persisting the temp dir contents delete it\n-        if (!context.isPersistTempDirectory())\n+        if (!context.isPersistTempDirectory() && context.getTempDirectory() != null && context.getTempDirectory().exists())", "originalCommit": "6be6fae291eff4ff8d7449d7f222812e02c76645", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODg2NzY0NQ==", "url": "https://github.com/eclipse/jetty.project/pull/5481#discussion_r508867645", "bodyText": "Done.", "author": "joakime", "createdAt": "2020-10-20T22:03:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODg1NzEwMA=="}], "type": "inlineReview", "revised_code": {"commit": "c7ae5b50ab8bfffe46aca5cc8cf1ceef305fa316", "chunk": "diff --git a/jetty-webapp/src/main/java/org/eclipse/jetty/webapp/WebInfConfiguration.java b/jetty-webapp/src/main/java/org/eclipse/jetty/webapp/WebInfConfiguration.java\nindex 53ec88c942..6fbe03080d 100644\n--- a/jetty-webapp/src/main/java/org/eclipse/jetty/webapp/WebInfConfiguration.java\n+++ b/jetty-webapp/src/main/java/org/eclipse/jetty/webapp/WebInfConfiguration.java\n\n@@ -354,8 +354,10 @@ public class WebInfConfiguration extends AbstractConfiguration\n     @Override\n     public void deconfigure(WebAppContext context) throws Exception\n     {\n-        //if we're not persisting the temp dir contents delete it\n-        if (!context.isPersistTempDirectory() && context.getTempDirectory() != null && context.getTempDirectory().exists())\n+        File tempDirectory = context.getTempDirectory();\n+\n+        // if we're not persisting the temp dir contents delete it\n+        if (!context.isPersistTempDirectory() && tempDirectory != null && tempDirectory.exists())\n         {\n             IO.delete(context.getTempDirectory());\n         }\n"}}, {"oid": "c7ae5b50ab8bfffe46aca5cc8cf1ceef305fa316", "url": "https://github.com/eclipse/jetty.project/commit/c7ae5b50ab8bfffe46aca5cc8cf1ceef305fa316", "message": "Issue #5480 - Safer temp directory management\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>", "committedDate": "2020-10-20T21:53:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODg2NjEwNw==", "url": "https://github.com/eclipse/jetty.project/pull/5481#discussion_r508866107", "bodyText": "This execution path does not use configureTempDirectory.\nIt's always a new, and unique, directory.\nAlso, it is always !isPersisTempDirectory()", "author": "joakime", "createdAt": "2020-10-20T21:59:48Z", "path": "jetty-webapp/src/main/java/org/eclipse/jetty/webapp/WebInfConfiguration.java", "diffHunk": "@@ -504,13 +506,15 @@ public void makeTempDirectory(File parent, WebAppContext context)\n             //if it is to be persisted, make sure it will be the same name\n             //by not using File.createTempFile, which appends random digits\n             tmpDir = new File(parent, temp);\n+            configureTempDirectory(tmpDir, context);\n         }\n         else\n         {\n-            //ensure file will always be unique by appending random digits\n+            // ensure dir will always be unique by having classlib generate random path name\n             tmpDir = Files.createTempDirectory(parent.toPath(), temp).toFile();\n+            tmpDir.deleteOnExit();\n+            ensureTempDirUsable(tmpDir);", "originalCommit": "c7ae5b50ab8bfffe46aca5cc8cf1ceef305fa316", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODg2NjkyOQ==", "url": "https://github.com/eclipse/jetty.project/pull/5481#discussion_r508866929", "bodyText": "probably should now be called ensureTempDirectory ?", "author": "gregw", "createdAt": "2020-10-20T22:01:38Z", "path": "jetty-webapp/src/main/java/org/eclipse/jetty/webapp/WebInfConfiguration.java", "diffHunk": "@@ -504,13 +506,15 @@ public void makeTempDirectory(File parent, WebAppContext context)\n             //if it is to be persisted, make sure it will be the same name\n             //by not using File.createTempFile, which appends random digits\n             tmpDir = new File(parent, temp);\n+            configureTempDirectory(tmpDir, context);", "originalCommit": "c7ae5b50ab8bfffe46aca5cc8cf1ceef305fa316", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODg2ODA3OA==", "url": "https://github.com/eclipse/jetty.project/pull/5481#discussion_r508868078", "bodyText": "This is a public API / method, don't want to change it for 9.4.x.\nBe happy to change it for 10.0.x though.", "author": "joakime", "createdAt": "2020-10-20T22:04:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODg2NjkyOQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODg2NzQ0NQ==", "url": "https://github.com/eclipse/jetty.project/pull/5481#discussion_r508867445", "bodyText": "how hard is it to check if it is empty or not.   if it is empty, it would be good to avoid deleting it.", "author": "gregw", "createdAt": "2020-10-20T22:02:51Z", "path": "jetty-webapp/src/main/java/org/eclipse/jetty/webapp/WebInfConfiguration.java", "diffHunk": "@@ -522,21 +526,30 @@ public void configureTempDirectory(File dir, WebAppContext context)\n         if (dir == null)\n             throw new IllegalArgumentException(\"Null temp dir\");\n \n-        //if dir exists and we don't want it persisted, delete it\n-        if (dir.exists() && !context.isPersistTempDirectory())\n+        // if dir exists and we don't want it persisted, delete it\n+        if (!context.isPersistTempDirectory() && dir.exists() && !IO.delete(dir))", "originalCommit": "c7ae5b50ab8bfffe46aca5cc8cf1ceef305fa316", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODg2ODI4MA==", "url": "https://github.com/eclipse/jetty.project/pull/5481#discussion_r508868280", "bodyText": "Not to terrible to check if empty.\nLet me try.", "author": "joakime", "createdAt": "2020-10-20T22:04:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODg2NzQ0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODg3NDk4MQ==", "url": "https://github.com/eclipse/jetty.project/pull/5481#discussion_r508874981", "bodyText": "This has been implemented and is available in this PR.", "author": "joakime", "createdAt": "2020-10-20T22:21:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODg2NzQ0NQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "fa6c8f7decf89ce00774f8aa34c2fd1efb23a156", "url": "https://github.com/eclipse/jetty.project/commit/fa6c8f7decf89ce00774f8aa34c2fd1efb23a156", "message": "Issue #5480 - Only delete non-persist temp dir if not-empty\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>", "committedDate": "2020-10-20T22:19:54Z", "type": "commit"}]}