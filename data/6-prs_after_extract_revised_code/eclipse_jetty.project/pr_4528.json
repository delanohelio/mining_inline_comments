{"pr_number": 4528, "pr_title": "Issue #4520 Reinstate throw of UnreadableSessionDataException", "pr_createdAt": "2020-01-30T10:10:06Z", "pr_url": "https://github.com/eclipse/jetty.project/pull/4528", "timeline": [{"oid": "c19898de71286bc0ca6070018128f8371146d052", "url": "https://github.com/eclipse/jetty.project/commit/c19898de71286bc0ca6070018128f8371146d052", "message": "Issue #4520 Reinstate throw of UnreadableSessionDataException\n\nSigned-off-by: Jan Bartel <janb@webtide.com>", "committedDate": "2020-01-30T09:54:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzM3NjkwNg==", "url": "https://github.com/eclipse/jetty.project/pull/4528#discussion_r373376906", "bodyText": "Since now you are rethrowing the exception, you don't want to log it at warn level at 370 - otherwise it will be printed out twice.", "author": "sbordet", "createdAt": "2020-01-31T09:07:18Z", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/session/AbstractSessionCache.java", "diffHunk": "@@ -366,10 +368,15 @@ protected Session getAndEnter(String id, boolean enter) throws Exception\n             catch (Exception e)\n             {\n                 LOG.warn(\"Error loading session {}\", id, e);\n+                exception.set(e);\n                 return null;\n             }\n         });\n \n+        Exception ex = exception.get();\n+        if (ex != null)\n+            throw ex;", "originalCommit": "c19898de71286bc0ca6070018128f8371146d052", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f6a09077bd4f06f7eca15ff25edd78a565562117", "chunk": "diff --git a/jetty-server/src/main/java/org/eclipse/jetty/server/session/AbstractSessionCache.java b/jetty-server/src/main/java/org/eclipse/jetty/server/session/AbstractSessionCache.java\nindex 4c852e7fff..3b4aa5388f 100644\n--- a/jetty-server/src/main/java/org/eclipse/jetty/server/session/AbstractSessionCache.java\n+++ b/jetty-server/src/main/java/org/eclipse/jetty/server/session/AbstractSessionCache.java\n\n@@ -367,7 +367,6 @@ public abstract class AbstractSessionCache extends ContainerLifeCycle implements\n             }\n             catch (Exception e)\n             {\n-                LOG.warn(\"Error loading session {}\", id, e);\n                 exception.set(e);\n                 return null;\n             }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzM3ODE4MA==", "url": "https://github.com/eclipse/jetty.project/pull/4528#discussion_r373378180", "bodyText": "Remove System.err.", "author": "sbordet", "createdAt": "2020-01-31T09:10:30Z", "path": "tests/test-sessions/test-sessions-common/src/test/java/org/eclipse/jetty/server/session/AbstractSessionCacheTest.java", "diffHunk": "@@ -43,6 +48,62 @@\n  */\n public abstract class AbstractSessionCacheTest\n {\n+    public static class UnreadableSessionDataStore extends AbstractSessionDataStore\n+    {\n+        public Set<String> _deletedIds = ConcurrentHashMap.newKeySet();\n+        int _count;\n+        int _calls;\n+        SessionData _data;\n+\n+        public UnreadableSessionDataStore(int count, SessionData data)\n+        {\n+            _count = count;\n+            _data = data;\n+        }\n+\n+        @Override\n+        public boolean isPassivating()\n+        {\n+            return false;\n+        }\n+\n+        @Override\n+        public boolean exists(String id) throws Exception\n+        {\n+            if (!_deletedIds.contains(id))\n+                return true;\n+            return false;\n+        }\n+\n+        @Override\n+        public boolean delete(String id) throws Exception\n+        {\n+            _deletedIds.add(id);\n+            return true;\n+        }\n+\n+        @Override\n+        public void doStore(String id, SessionData data, long lastSaveTime) throws Exception\n+        {\n+            System.err.println(\"DOSTORE: \" + id + \" lastsave=\" + lastSaveTime);", "originalCommit": "c19898de71286bc0ca6070018128f8371146d052", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f6a09077bd4f06f7eca15ff25edd78a565562117", "chunk": "diff --git a/tests/test-sessions/test-sessions-common/src/test/java/org/eclipse/jetty/server/session/AbstractSessionCacheTest.java b/tests/test-sessions/test-sessions-common/src/test/java/org/eclipse/jetty/server/session/AbstractSessionCacheTest.java\nindex 52be0e966a..3ecbb505d9 100644\n--- a/tests/test-sessions/test-sessions-common/src/test/java/org/eclipse/jetty/server/session/AbstractSessionCacheTest.java\n+++ b/tests/test-sessions/test-sessions-common/src/test/java/org/eclipse/jetty/server/session/AbstractSessionCacheTest.java\n\n@@ -50,7 +51,6 @@ public abstract class AbstractSessionCacheTest\n {\n     public static class UnreadableSessionDataStore extends AbstractSessionDataStore\n     {\n-        public Set<String> _deletedIds = ConcurrentHashMap.newKeySet();\n         int _count;\n         int _calls;\n         SessionData _data;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzM3OTY5Mg==", "url": "https://github.com/eclipse/jetty.project/pull/4528#discussion_r373379692", "bodyText": "Replace with assertNotEquals().", "author": "sbordet", "createdAt": "2020-01-31T09:14:12Z", "path": "tests/test-sessions/test-sessions-common/src/test/java/org/eclipse/jetty/server/session/AbstractSessionCacheTest.java", "diffHunk": "@@ -65,7 +126,56 @@ public void sessionDidActivate(HttpSessionEvent se)\n     public abstract AbstractSessionCacheFactory newSessionCacheFactory(int evictionPolicy, boolean saveOnCreate, \n                                                                        boolean saveOnInactiveEvict, boolean removeUnloadableSessions,\n                                                                        boolean flushOnResponseCommit);\n-    \n+\n+    /**\n+     * Test that a session that exists in the datastore, but that cannot be\n+     * read will be invalidated and deleted, and thus a request to re-use that\n+     * same id will not succeed.\n+     * \n+     * @throws Exception\n+     */\n+    @Test\n+    public void testUnreadableSession() throws Exception\n+    {\n+        Server server = new Server();\n+        server.setSessionIdManager(new DefaultSessionIdManager(server));\n+\n+        ServletContextHandler context = new ServletContextHandler(ServletContextHandler.SESSIONS);\n+        context.setContextPath(\"/test\");\n+        context.setServer(server);\n+        server.setHandler(context);\n+\n+        AbstractSessionCacheFactory cacheFactory = newSessionCacheFactory(SessionCache.NEVER_EVICT, false, false, false, false);\n+        SessionCache cache = cacheFactory.getSessionCache(context.getSessionHandler());\n+\n+        //prefill the datastore with a session that will be treated as unreadable\n+        UnreadableSessionDataStore store = new UnreadableSessionDataStore(1, new SessionData(\"1234\", \"/test\", \"0.0.0.0\", System.currentTimeMillis(), 0,0, -1));\n+        cache.setSessionDataStore(store);\n+        context.getSessionHandler().setSessionCache(cache);\n+        server.start();\n+\n+        try (StacklessLogging stackless = new StacklessLogging(Log.getLogger(\"org.eclipse.jetty.server.session\")))\n+        {\n+            //check that session 1234 cannot be read, ie returns null AND\n+            //that it is deleted in the datastore\n+            Session session = context.getSessionHandler().getSession(\"1234\");\n+            assertNull(session);\n+            assertTrue(store._deletedIds.contains(\"1234\"));\n+\n+            //now try to make a session with the same id as if from a request with\n+            //a SESSION_ID cookie set\n+            Request request = new Request(null, null);\n+            request.setRequestedSessionId(\"1234\");\n+            HttpSession newSession = context.getSessionHandler().newHttpSession(request);\n+            assertFalse(\"1234\".equals(newSession.getId()));", "originalCommit": "c19898de71286bc0ca6070018128f8371146d052", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQwNjk1OA==", "url": "https://github.com/eclipse/jetty.project/pull/4528#discussion_r373406958", "bodyText": "Please add a comment here about the fact that since the session has been deleted, its id cannot be reused, and delete the javadoc of the method (which basically says the same, but in the wrong spot - and who reads test javadocs anyway?!? \ud83d\ude04)", "author": "sbordet", "createdAt": "2020-01-31T10:18:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzM3OTY5Mg=="}], "type": "inlineReview", "revised_code": {"commit": "f6a09077bd4f06f7eca15ff25edd78a565562117", "chunk": "diff --git a/tests/test-sessions/test-sessions-common/src/test/java/org/eclipse/jetty/server/session/AbstractSessionCacheTest.java b/tests/test-sessions/test-sessions-common/src/test/java/org/eclipse/jetty/server/session/AbstractSessionCacheTest.java\nindex 52be0e966a..3ecbb505d9 100644\n--- a/tests/test-sessions/test-sessions-common/src/test/java/org/eclipse/jetty/server/session/AbstractSessionCacheTest.java\n+++ b/tests/test-sessions/test-sessions-common/src/test/java/org/eclipse/jetty/server/session/AbstractSessionCacheTest.java\n\n@@ -160,14 +157,17 @@ public abstract class AbstractSessionCacheTest\n             //that it is deleted in the datastore\n             Session session = context.getSessionHandler().getSession(\"1234\");\n             assertNull(session);\n-            assertTrue(store._deletedIds.contains(\"1234\"));\n+            assertFalse(store.exists(\"1234\"));\n \n             //now try to make a session with the same id as if from a request with\n-            //a SESSION_ID cookie set\n+            //a SESSION_ID cookie set - the id from the cookie should not be able to\n+            //be re-used because we just deleted the session with that id. Ids cannot\n+            //be re-used (unless another context is already using that same id (ie cross\n+            //context dispatch), which is not the case in this test).\n             Request request = new Request(null, null);\n             request.setRequestedSessionId(\"1234\");\n             HttpSession newSession = context.getSessionHandler().newHttpSession(request);\n-            assertFalse(\"1234\".equals(newSession.getId()));\n+            assertNotEquals(\"1234\", newSession.getId());\n         }\n         finally\n         {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzM4MDMzNA==", "url": "https://github.com/eclipse/jetty.project/pull/4528#discussion_r373380334", "bodyText": "Simplify into return !....", "author": "sbordet", "createdAt": "2020-01-31T09:15:44Z", "path": "tests/test-sessions/test-sessions-common/src/test/java/org/eclipse/jetty/server/session/AbstractSessionCacheTest.java", "diffHunk": "@@ -43,6 +48,62 @@\n  */\n public abstract class AbstractSessionCacheTest\n {\n+    public static class UnreadableSessionDataStore extends AbstractSessionDataStore\n+    {\n+        public Set<String> _deletedIds = ConcurrentHashMap.newKeySet();\n+        int _count;\n+        int _calls;\n+        SessionData _data;\n+\n+        public UnreadableSessionDataStore(int count, SessionData data)\n+        {\n+            _count = count;\n+            _data = data;\n+        }\n+\n+        @Override\n+        public boolean isPassivating()\n+        {\n+            return false;\n+        }\n+\n+        @Override\n+        public boolean exists(String id) throws Exception\n+        {\n+            if (!_deletedIds.contains(id))\n+                return true;\n+            return false;", "originalCommit": "c19898de71286bc0ca6070018128f8371146d052", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f6a09077bd4f06f7eca15ff25edd78a565562117", "chunk": "diff --git a/tests/test-sessions/test-sessions-common/src/test/java/org/eclipse/jetty/server/session/AbstractSessionCacheTest.java b/tests/test-sessions/test-sessions-common/src/test/java/org/eclipse/jetty/server/session/AbstractSessionCacheTest.java\nindex 52be0e966a..3ecbb505d9 100644\n--- a/tests/test-sessions/test-sessions-common/src/test/java/org/eclipse/jetty/server/session/AbstractSessionCacheTest.java\n+++ b/tests/test-sessions/test-sessions-common/src/test/java/org/eclipse/jetty/server/session/AbstractSessionCacheTest.java\n\n@@ -50,7 +51,6 @@ public abstract class AbstractSessionCacheTest\n {\n     public static class UnreadableSessionDataStore extends AbstractSessionDataStore\n     {\n-        public Set<String> _deletedIds = ConcurrentHashMap.newKeySet();\n         int _count;\n         int _calls;\n         SessionData _data;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzM4NDU0OA==", "url": "https://github.com/eclipse/jetty.project/pull/4528#discussion_r373384548", "bodyText": "Unnecessary empty line.", "author": "sbordet", "createdAt": "2020-01-31T09:25:51Z", "path": "tests/test-sessions/test-sessions-common/src/test/java/org/eclipse/jetty/server/session/AbstractSessionCacheTest.java", "diffHunk": "@@ -65,7 +126,56 @@ public void sessionDidActivate(HttpSessionEvent se)\n     public abstract AbstractSessionCacheFactory newSessionCacheFactory(int evictionPolicy, boolean saveOnCreate, \n                                                                        boolean saveOnInactiveEvict, boolean removeUnloadableSessions,\n                                                                        boolean flushOnResponseCommit);\n-    \n+\n+    /**\n+     * Test that a session that exists in the datastore, but that cannot be\n+     * read will be invalidated and deleted, and thus a request to re-use that\n+     * same id will not succeed.\n+     * \n+     * @throws Exception\n+     */\n+    @Test\n+    public void testUnreadableSession() throws Exception\n+    {\n+        Server server = new Server();\n+        server.setSessionIdManager(new DefaultSessionIdManager(server));\n+\n+        ServletContextHandler context = new ServletContextHandler(ServletContextHandler.SESSIONS);\n+        context.setContextPath(\"/test\");\n+        context.setServer(server);\n+        server.setHandler(context);\n+\n+        AbstractSessionCacheFactory cacheFactory = newSessionCacheFactory(SessionCache.NEVER_EVICT, false, false, false, false);\n+        SessionCache cache = cacheFactory.getSessionCache(context.getSessionHandler());\n+\n+        //prefill the datastore with a session that will be treated as unreadable\n+        UnreadableSessionDataStore store = new UnreadableSessionDataStore(1, new SessionData(\"1234\", \"/test\", \"0.0.0.0\", System.currentTimeMillis(), 0,0, -1));\n+        cache.setSessionDataStore(store);\n+        context.getSessionHandler().setSessionCache(cache);\n+        server.start();\n+\n+        try (StacklessLogging stackless = new StacklessLogging(Log.getLogger(\"org.eclipse.jetty.server.session\")))\n+        {\n+            //check that session 1234 cannot be read, ie returns null AND\n+            //that it is deleted in the datastore\n+            Session session = context.getSessionHandler().getSession(\"1234\");\n+            assertNull(session);\n+            assertTrue(store._deletedIds.contains(\"1234\"));\n+\n+            //now try to make a session with the same id as if from a request with\n+            //a SESSION_ID cookie set\n+            Request request = new Request(null, null);\n+            request.setRequestedSessionId(\"1234\");\n+            HttpSession newSession = context.getSessionHandler().newHttpSession(request);\n+            assertFalse(\"1234\".equals(newSession.getId()));\n+        }\n+        finally\n+        {\n+            server.stop();\n+        }\n+    }\n+\n+", "originalCommit": "c19898de71286bc0ca6070018128f8371146d052", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f6a09077bd4f06f7eca15ff25edd78a565562117", "chunk": "diff --git a/tests/test-sessions/test-sessions-common/src/test/java/org/eclipse/jetty/server/session/AbstractSessionCacheTest.java b/tests/test-sessions/test-sessions-common/src/test/java/org/eclipse/jetty/server/session/AbstractSessionCacheTest.java\nindex 52be0e966a..3ecbb505d9 100644\n--- a/tests/test-sessions/test-sessions-common/src/test/java/org/eclipse/jetty/server/session/AbstractSessionCacheTest.java\n+++ b/tests/test-sessions/test-sessions-common/src/test/java/org/eclipse/jetty/server/session/AbstractSessionCacheTest.java\n\n@@ -160,14 +157,17 @@ public abstract class AbstractSessionCacheTest\n             //that it is deleted in the datastore\n             Session session = context.getSessionHandler().getSession(\"1234\");\n             assertNull(session);\n-            assertTrue(store._deletedIds.contains(\"1234\"));\n+            assertFalse(store.exists(\"1234\"));\n \n             //now try to make a session with the same id as if from a request with\n-            //a SESSION_ID cookie set\n+            //a SESSION_ID cookie set - the id from the cookie should not be able to\n+            //be re-used because we just deleted the session with that id. Ids cannot\n+            //be re-used (unless another context is already using that same id (ie cross\n+            //context dispatch), which is not the case in this test).\n             Request request = new Request(null, null);\n             request.setRequestedSessionId(\"1234\");\n             HttpSession newSession = context.getSessionHandler().newHttpSession(request);\n-            assertFalse(\"1234\".equals(newSession.getId()));\n+            assertNotEquals(\"1234\", newSession.getId());\n         }\n         finally\n         {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzM4NDg2MA==", "url": "https://github.com/eclipse/jetty.project/pull/4528#discussion_r373384860", "bodyText": "No need for final here.", "author": "sbordet", "createdAt": "2020-01-31T09:26:30Z", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/session/AbstractSessionCache.java", "diffHunk": "@@ -334,12 +335,13 @@ public Session get(String id) throws Exception\n      * \n      * @param id The session to retrieve\n      * @param enter if true, the usage count of the session will be incremented\n-     * @return\n-     * @throws Exception\n+     * @return the session if it exists, null otherwise\n+     * @throws Exception if the session cannot be loaded\n      */\n     protected Session getAndEnter(String id, boolean enter) throws Exception\n     {\n         Session session = null;\n+        final AtomicReference<Exception> exception = new AtomicReference<Exception>();", "originalCommit": "c19898de71286bc0ca6070018128f8371146d052", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f6a09077bd4f06f7eca15ff25edd78a565562117", "chunk": "diff --git a/jetty-server/src/main/java/org/eclipse/jetty/server/session/AbstractSessionCache.java b/jetty-server/src/main/java/org/eclipse/jetty/server/session/AbstractSessionCache.java\nindex 4c852e7fff..3b4aa5388f 100644\n--- a/jetty-server/src/main/java/org/eclipse/jetty/server/session/AbstractSessionCache.java\n+++ b/jetty-server/src/main/java/org/eclipse/jetty/server/session/AbstractSessionCache.java\n\n@@ -341,7 +341,7 @@ public abstract class AbstractSessionCache extends ContainerLifeCycle implements\n     protected Session getAndEnter(String id, boolean enter) throws Exception\n     {\n         Session session = null;\n-        final AtomicReference<Exception> exception = new AtomicReference<Exception>();\n+        AtomicReference<Exception> exception = new AtomicReference<Exception>();\n \n         session = doComputeIfAbsent(id, k ->\n         {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQwNTY4Ng==", "url": "https://github.com/eclipse/jetty.project/pull/4528#discussion_r373405686", "bodyText": "Perhaps you can just use _data in the implementation, so you won't need to remember deleted ids.", "author": "sbordet", "createdAt": "2020-01-31T10:15:09Z", "path": "tests/test-sessions/test-sessions-common/src/test/java/org/eclipse/jetty/server/session/AbstractSessionCacheTest.java", "diffHunk": "@@ -43,6 +48,62 @@\n  */\n public abstract class AbstractSessionCacheTest\n {\n+    public static class UnreadableSessionDataStore extends AbstractSessionDataStore\n+    {\n+        public Set<String> _deletedIds = ConcurrentHashMap.newKeySet();", "originalCommit": "c19898de71286bc0ca6070018128f8371146d052", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f6a09077bd4f06f7eca15ff25edd78a565562117", "chunk": "diff --git a/tests/test-sessions/test-sessions-common/src/test/java/org/eclipse/jetty/server/session/AbstractSessionCacheTest.java b/tests/test-sessions/test-sessions-common/src/test/java/org/eclipse/jetty/server/session/AbstractSessionCacheTest.java\nindex 52be0e966a..3ecbb505d9 100644\n--- a/tests/test-sessions/test-sessions-common/src/test/java/org/eclipse/jetty/server/session/AbstractSessionCacheTest.java\n+++ b/tests/test-sessions/test-sessions-common/src/test/java/org/eclipse/jetty/server/session/AbstractSessionCacheTest.java\n\n@@ -50,7 +51,6 @@ public abstract class AbstractSessionCacheTest\n {\n     public static class UnreadableSessionDataStore extends AbstractSessionDataStore\n     {\n-        public Set<String> _deletedIds = ConcurrentHashMap.newKeySet();\n         int _count;\n         int _calls;\n         SessionData _data;\n"}}, {"oid": "f6a09077bd4f06f7eca15ff25edd78a565562117", "url": "https://github.com/eclipse/jetty.project/commit/f6a09077bd4f06f7eca15ff25edd78a565562117", "message": "Issue #4520 Updates after review\n\nSigned-off-by: Jan Bartel <janb@webtide.com>", "committedDate": "2020-01-31T11:52:27Z", "type": "commit"}, {"oid": "0732a69eeaf3a16c8823119cc5365d639d5df6da", "url": "https://github.com/eclipse/jetty.project/commit/0732a69eeaf3a16c8823119cc5365d639d5df6da", "message": "Issue #4520 Ensure LOG.warns contain exception\n\nSigned-off-by: Jan Bartel <janb@webtide.com>", "committedDate": "2020-01-31T17:46:08Z", "type": "commit"}]}