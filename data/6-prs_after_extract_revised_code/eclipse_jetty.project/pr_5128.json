{"pr_number": 5128, "pr_title": "Fixes #5079 - :authority header for IPv6 address not having square br\u2026", "pr_createdAt": "2020-08-07T13:54:17Z", "pr_url": "https://github.com/eclipse/jetty.project/pull/5128", "timeline": [{"oid": "d53d9d8a1db1de93bf823ee59805940ac1a2e4f9", "url": "https://github.com/eclipse/jetty.project/commit/d53d9d8a1db1de93bf823ee59805940ac1a2e4f9", "message": "Fixes #5079 - :authority header for IPv6 address not having square brackets.\n\nOn the client:\n* Origin.Address.host is passed through HostPort.normalizeHost(),\nso that if it is IPv6 is bracketed.\nNow the ipv6 address passed to an `HttClient` request is bracketed.\n* HttpRequest was de-bracketing the host, but now it does not anymore.\n\nOn the server:\n* Request.getLocalAddr(), getLocalName(), getRemoteAddr(),\ngetRemoteHost(), getServerName(), when dealing with an IPv6 address,\nreturn it bracketed.\nThe reason to return bracketed IPv6 also from *Addr() methods is that\nif it is used with InetAddress/InetSocketAddress it still works, but\noften it is interpreted as a URI host so brackets are necessary.\n* DoSFilter was blindly bracketing - now it does not.\n\nAdded a number of test cases, and fixed those that expected\nnon-bracketed IPv6.\n\nSigned-off-by: Simone Bordet <simone.bordet@gmail.com>", "committedDate": "2020-08-07T13:53:19Z", "type": "commit"}, {"oid": "dd4c1dbac0cf67748ff1454724cd39e15ee8cfbb", "url": "https://github.com/eclipse/jetty.project/commit/dd4c1dbac0cf67748ff1454724cd39e15ee8cfbb", "message": "Merged branch 'jetty-9.4.x' into 'jetty-9.4.x-5079-ipv6_brackets'.", "committedDate": "2020-08-08T21:21:14Z", "type": "commit"}, {"oid": "867621af89650b380350ddb625f711ee62ea3a13", "url": "https://github.com/eclipse/jetty.project/commit/867621af89650b380350ddb625f711ee62ea3a13", "message": "Fixes #5079 - :authority header for IPv6 address not having square brackets.\n\nFixed Jenkins failures by disabling tests that require IPv6 if it is not available.\n\nSigned-off-by: Simone Bordet <simone.bordet@gmail.com>", "committedDate": "2020-08-10T12:52:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODQ0OTY2MA==", "url": "https://github.com/eclipse/jetty.project/pull/5128#discussion_r468449660", "bodyText": "should the impl at least call HostPort.normalize so that it works if somebody does call it?", "author": "gregw", "createdAt": "2020-08-11T09:30:35Z", "path": "jetty-client/src/main/java/org/eclipse/jetty/client/HttpClient.java", "diffHunk": "@@ -1155,10 +1155,14 @@ protected HttpField getAcceptEncodingField()\n         return encodingField;\n     }\n \n+    /**\n+     * @param host the host to normalize\n+     * @return the host itself\n+     * @deprecated no replacement, do not use it\n+     */\n+    @Deprecated", "originalCommit": "867621af89650b380350ddb625f711ee62ea3a13", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODc2MjY2Nw==", "url": "https://github.com/eclipse/jetty.project/pull/5128#discussion_r468762667", "bodyText": "Also, perhaps add some apidoc text telling developers what the options are now that it's deprecated ...\n/**\n * @deprecated use {@link HostPort#normalize(String)} instead.\n */\n@Deprecated", "author": "joakime", "createdAt": "2020-08-11T17:57:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODQ0OTY2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODc2NjAwNw==", "url": "https://github.com/eclipse/jetty.project/pull/5128#discussion_r468766007", "bodyText": "Nope, the method should not be used. It's protected so only subclasses could use it, but they should not - there is no need to normalize the host anymore.\nI initially followed @gregw suggestion to call HostPort.normalizeHost(), but actually this method was doing exactly the opposite. So either restore the old behavior, or keep this new one that does nothing.", "author": "sbordet", "createdAt": "2020-08-11T18:02:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODQ0OTY2MA=="}], "type": "inlineReview", "revised_code": {"commit": "897e766f24becb5c1a3ddc0b0d3970e45c08d134", "chunk": "diff --git a/jetty-client/src/main/java/org/eclipse/jetty/client/HttpClient.java b/jetty-client/src/main/java/org/eclipse/jetty/client/HttpClient.java\nindex 7a5903a46e..88cba2ebd1 100644\n--- a/jetty-client/src/main/java/org/eclipse/jetty/client/HttpClient.java\n+++ b/jetty-client/src/main/java/org/eclipse/jetty/client/HttpClient.java\n\n@@ -1163,7 +1164,7 @@ public class HttpClient extends ContainerLifeCycle\n     @Deprecated\n     protected String normalizeHost(String host)\n     {\n-        return host;\n+        return HostPort.normalizeHost(host);\n     }\n \n     public static int normalizePort(String scheme, int port)\n"}}, {"oid": "897e766f24becb5c1a3ddc0b0d3970e45c08d134", "url": "https://github.com/eclipse/jetty.project/commit/897e766f24becb5c1a3ddc0b0d3970e45c08d134", "message": "Fixes #5079 - :authority header for IPv6 address not having square brackets.\n\nUpdates after review.\n\nSigned-off-by: Simone Bordet <simone.bordet@gmail.com>", "committedDate": "2020-08-11T17:18:11Z", "type": "commit"}, {"oid": "2e73f80d34d7946c13451baf7f5280bb83aca50c", "url": "https://github.com/eclipse/jetty.project/commit/2e73f80d34d7946c13451baf7f5280bb83aca50c", "message": "Fixes #5079 - :authority header for IPv6 address not having square brackets.\n\nReverted code changes to HttpClient.normalizeHost().\n\nSigned-off-by: Simone Bordet <simone.bordet@gmail.com>", "committedDate": "2020-08-11T18:03:42Z", "type": "commit"}]}