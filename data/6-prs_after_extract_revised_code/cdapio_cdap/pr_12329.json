{"pr_number": 12329, "pr_title": "[CDAP-16835] Change Batch Upgrade REST API to take in list of ApplicationRecords", "pr_createdAt": "2020-06-15T20:50:42Z", "pr_url": "https://github.com/cdapio/cdap/pull/12329", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQ0MDM4OQ==", "url": "https://github.com/cdapio/cdap/pull/12329#discussion_r440440389", "bodyText": "Why not just the List to deserialize?", "author": "chtyim", "createdAt": "2020-06-15T20:53:15Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/gateway/handlers/AppLifecycleHttpHandler.java", "diffHunk": "@@ -542,6 +542,41 @@ public void getApplicationDetails(FullHttpRequest request, HttpResponder respond\n     }\n   }\n \n+    /**\n+   * Decodes request coming from the {@link #upgradeApplications(FullHttpRequest, HttpResponder, String, Set, boolean)} call.\n+   */\n+  private List<ApplicationId> decodeAndValidateBatchApplicationRecord(NamespaceId namespaceId,\n+                                                                      FullHttpRequest request)\n+    throws BadRequestException {\n+    try {\n+      List<ApplicationId> result = new ArrayList<>();\n+      JsonArray array = DECODE_GSON.fromJson(request.content().toString(StandardCharsets.UTF_8), JsonArray.class);", "originalCommit": "94620832a799a1b16e4a62b3a265eb0e457a4f24", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQ0NTE1MQ==", "url": "https://github.com/cdapio/cdap/pull/12329#discussion_r440445151", "bodyText": "i mean List<ApplicationRecord>", "author": "chtyim", "createdAt": "2020-06-15T21:02:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQ0MDM4OQ=="}], "type": "inlineReview", "revised_code": {"commit": "6b88e3c9fc798d0076076567a055f7eef4a249bc", "chunk": "diff --git a/cdap-app-fabric/src/main/java/io/cdap/cdap/gateway/handlers/AppLifecycleHttpHandler.java b/cdap-app-fabric/src/main/java/io/cdap/cdap/gateway/handlers/AppLifecycleHttpHandler.java\nindex 54b565c6cf6..41bbabdb03a 100644\n--- a/cdap-app-fabric/src/main/java/io/cdap/cdap/gateway/handlers/AppLifecycleHttpHandler.java\n+++ b/cdap-app-fabric/src/main/java/io/cdap/cdap/gateway/handlers/AppLifecycleHttpHandler.java\n\n@@ -542,36 +542,32 @@ public class AppLifecycleHttpHandler extends AbstractAppFabricHttpHandler {\n     }\n   }\n \n-    /**\n-   * Decodes request coming from the {@link #upgradeApplications(FullHttpRequest, HttpResponder, String, Set, boolean)} call.\n+  /**\n+   * Decodes request coming from the {@link #upgradeApplications(FullHttpRequest, HttpResponder, String, Set, boolean)}\n+   * call.\n    */\n   private List<ApplicationId> decodeAndValidateBatchApplicationRecord(NamespaceId namespaceId,\n                                                                       FullHttpRequest request)\n     throws BadRequestException {\n     try {\n-      List<ApplicationId> result = new ArrayList<>();\n-      JsonArray array = DECODE_GSON.fromJson(request.content().toString(StandardCharsets.UTF_8), JsonArray.class);\n-      if (array == null) {\n+      List<ApplicationId> appIds = new ArrayList<>();\n+      List<ApplicationRecord> records =\n+        DECODE_GSON.fromJson(request.content().toString(StandardCharsets.UTF_8),\n+                             new TypeToken<List<ApplicationRecord>>() { }.getType());\n+      if (records == null) {\n         throw new BadRequestException(\"Request body is invalid json, please check that it is a json array.\");\n       }\n-      for (JsonElement element : array) {\n-        if (!element.isJsonObject()) {\n-          throw new BadRequestException(\"Request element is expected to be a json object.\");\n-        }\n-        JsonObject obj = element.getAsJsonObject();\n-        if (!obj.has(\"name\")) {\n+      for (ApplicationRecord element : records) {\n+        if (element.getName() != null && element.getName().isEmpty()) {\n           throw new BadRequestException(\"Missing 'name' in the request element for app-id.\");\n         }\n-        String appId = obj.get(\"name\").getAsString();\n-\n-        JsonElement version = obj.get(\"version\");\n-        if (version == null) {\n-          result.add(validateApplicationId(namespaceId, appId));\n+        if (element.getAppVersion() == null) {\n+          appIds.add(validateApplicationId(namespaceId, element.getName()));\n         } else {\n-          result.add(validateApplicationVersionId(namespaceId, appId, version.getAsString()));\n+          appIds.add(validateApplicationVersionId(namespaceId, element.getName(), element.getAppVersion()));\n         }\n       }\n-      return result;\n+      return appIds;\n     } catch (JsonSyntaxException e) {\n       throw new BadRequestException(\"Request body is invalid json: \" + e.getMessage());\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDU4Njk1OA==", "url": "https://github.com/cdapio/cdap/pull/12329#discussion_r440586958", "bodyText": "Why not just pass e to ApplicationUpdateDetail directly?", "author": "chtyim", "createdAt": "2020-06-16T05:00:35Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/gateway/handlers/AppLifecycleHttpHandler.java", "diffHunk": "@@ -448,20 +449,21 @@ public void upgradeApplications(FullHttpRequest request, HttpResponder responder\n     // TODO: (CDAP-16910) Improve batch API performance as each application upgrade is an event independent of each\n     //  other.\n \n-    List<ApplicationId> appIds = decodeAndValidateBatchApplication(validateNamespace(namespaceId), request);\n+    List<ApplicationId> appIds = decodeAndValidateBatchApplicationRecord(validateNamespace(namespaceId), request);\n     Set<ArtifactScope> allowedArtifactScopes = getArtifactScopes(artifactScopes);\n     List<ApplicationUpdateDetail> details = new ArrayList<>();\n     for (ApplicationId appId : appIds) {\n       ApplicationUpdateDetail updateDetail;\n       try {\n-        applicationLifecycleService.upgradeApplication(appId, createProgramTerminator(), allowedArtifactScopes,\n-                                                       allowSnapshot);\n-        updateDetail = new ApplicationUpdateDetail(appId, \"upgrade successful.\");\n+        applicationLifecycleService.upgradeApplication(appId, allowedArtifactScopes, allowSnapshot);\n+        updateDetail = new ApplicationUpdateDetail(appId);\n       } catch (UnsupportedOperationException e) {\n         String errorMessage = String.format(\"Application %s does not support upgrade.\", appId);\n-        updateDetail = new ApplicationUpdateDetail(appId, errorMessage);\n-      } catch (InvalidArtifactException | NotFoundException e) {\n-        updateDetail = new ApplicationUpdateDetail(appId, e.getMessage());\n+        updateDetail = new ApplicationUpdateDetail(appId, new NotImplementedException(errorMessage));\n+      } catch (NotFoundException e) {\n+        updateDetail = new ApplicationUpdateDetail(appId, new NotFoundException(appId));\n+      } catch (InvalidArtifactException e) {\n+        updateDetail = new ApplicationUpdateDetail(appId, new InvalidArtifactException(e.getMessage()));", "originalCommit": "70e31c1628dbb5204526bd8719b6f1cd1940fd31", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDU5MDYxNQ==", "url": "https://github.com/cdapio/cdap/pull/12329#discussion_r440590615", "bodyText": "aah.. I was trying something else then didnt change this back. Thanks for noticing.", "author": "pandyajay10", "createdAt": "2020-06-16T05:14:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDU4Njk1OA=="}], "type": "inlineReview", "revised_code": {"commit": "6b88e3c9fc798d0076076567a055f7eef4a249bc", "chunk": "diff --git a/cdap-app-fabric/src/main/java/io/cdap/cdap/gateway/handlers/AppLifecycleHttpHandler.java b/cdap-app-fabric/src/main/java/io/cdap/cdap/gateway/handlers/AppLifecycleHttpHandler.java\nindex 93b9da9f0db..41bbabdb03a 100644\n--- a/cdap-app-fabric/src/main/java/io/cdap/cdap/gateway/handlers/AppLifecycleHttpHandler.java\n+++ b/cdap-app-fabric/src/main/java/io/cdap/cdap/gateway/handlers/AppLifecycleHttpHandler.java\n\n@@ -460,10 +460,8 @@ public class AppLifecycleHttpHandler extends AbstractAppFabricHttpHandler {\n       } catch (UnsupportedOperationException e) {\n         String errorMessage = String.format(\"Application %s does not support upgrade.\", appId);\n         updateDetail = new ApplicationUpdateDetail(appId, new NotImplementedException(errorMessage));\n-      } catch (NotFoundException e) {\n-        updateDetail = new ApplicationUpdateDetail(appId, new NotFoundException(appId));\n-      } catch (InvalidArtifactException e) {\n-        updateDetail = new ApplicationUpdateDetail(appId, new InvalidArtifactException(e.getMessage()));\n+      } catch (InvalidArtifactException | NotFoundException e) {\n+        updateDetail = new ApplicationUpdateDetail(appId, e);\n       } catch (Exception e) {\n         updateDetail =\n           new ApplicationUpdateDetail(appId, new ServiceException(\"Upgrade failed due to internal error.\", null,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDU4NzAyNQ==", "url": "https://github.com/cdapio/cdap/pull/12329#discussion_r440587025", "bodyText": "Can you just pass in e?", "author": "chtyim", "createdAt": "2020-06-16T05:00:51Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/gateway/handlers/AppLifecycleHttpHandler.java", "diffHunk": "@@ -448,20 +449,21 @@ public void upgradeApplications(FullHttpRequest request, HttpResponder responder\n     // TODO: (CDAP-16910) Improve batch API performance as each application upgrade is an event independent of each\n     //  other.\n \n-    List<ApplicationId> appIds = decodeAndValidateBatchApplication(validateNamespace(namespaceId), request);\n+    List<ApplicationId> appIds = decodeAndValidateBatchApplicationRecord(validateNamespace(namespaceId), request);\n     Set<ArtifactScope> allowedArtifactScopes = getArtifactScopes(artifactScopes);\n     List<ApplicationUpdateDetail> details = new ArrayList<>();\n     for (ApplicationId appId : appIds) {\n       ApplicationUpdateDetail updateDetail;\n       try {\n-        applicationLifecycleService.upgradeApplication(appId, createProgramTerminator(), allowedArtifactScopes,\n-                                                       allowSnapshot);\n-        updateDetail = new ApplicationUpdateDetail(appId, \"upgrade successful.\");\n+        applicationLifecycleService.upgradeApplication(appId, allowedArtifactScopes, allowSnapshot);\n+        updateDetail = new ApplicationUpdateDetail(appId);\n       } catch (UnsupportedOperationException e) {\n         String errorMessage = String.format(\"Application %s does not support upgrade.\", appId);\n-        updateDetail = new ApplicationUpdateDetail(appId, errorMessage);\n-      } catch (InvalidArtifactException | NotFoundException e) {\n-        updateDetail = new ApplicationUpdateDetail(appId, e.getMessage());\n+        updateDetail = new ApplicationUpdateDetail(appId, new NotImplementedException(errorMessage));\n+      } catch (NotFoundException e) {\n+        updateDetail = new ApplicationUpdateDetail(appId, new NotFoundException(appId));", "originalCommit": "70e31c1628dbb5204526bd8719b6f1cd1940fd31", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDU5MDY3MQ==", "url": "https://github.com/cdapio/cdap/pull/12329#discussion_r440590671", "bodyText": "aah.. I was trying something else forgot to change this back. Thanks for noticing.", "author": "pandyajay10", "createdAt": "2020-06-16T05:14:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDU4NzAyNQ=="}], "type": "inlineReview", "revised_code": {"commit": "6b88e3c9fc798d0076076567a055f7eef4a249bc", "chunk": "diff --git a/cdap-app-fabric/src/main/java/io/cdap/cdap/gateway/handlers/AppLifecycleHttpHandler.java b/cdap-app-fabric/src/main/java/io/cdap/cdap/gateway/handlers/AppLifecycleHttpHandler.java\nindex 93b9da9f0db..41bbabdb03a 100644\n--- a/cdap-app-fabric/src/main/java/io/cdap/cdap/gateway/handlers/AppLifecycleHttpHandler.java\n+++ b/cdap-app-fabric/src/main/java/io/cdap/cdap/gateway/handlers/AppLifecycleHttpHandler.java\n\n@@ -460,10 +460,8 @@ public class AppLifecycleHttpHandler extends AbstractAppFabricHttpHandler {\n       } catch (UnsupportedOperationException e) {\n         String errorMessage = String.format(\"Application %s does not support upgrade.\", appId);\n         updateDetail = new ApplicationUpdateDetail(appId, new NotImplementedException(errorMessage));\n-      } catch (NotFoundException e) {\n-        updateDetail = new ApplicationUpdateDetail(appId, new NotFoundException(appId));\n-      } catch (InvalidArtifactException e) {\n-        updateDetail = new ApplicationUpdateDetail(appId, new InvalidArtifactException(e.getMessage()));\n+      } catch (InvalidArtifactException | NotFoundException e) {\n+        updateDetail = new ApplicationUpdateDetail(appId, e);\n       } catch (Exception e) {\n         updateDetail =\n           new ApplicationUpdateDetail(appId, new ServiceException(\"Upgrade failed due to internal error.\", null,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDU4NzM1OQ==", "url": "https://github.com/cdapio/cdap/pull/12329#discussion_r440587359", "bodyText": "Shall we just remove the terminator in the updateApplicationInternal method? Is it still needed?", "author": "chtyim", "createdAt": "2020-06-16T05:02:14Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/services/ApplicationLifecycleService.java", "diffHunk": "@@ -509,7 +506,7 @@ public void upgradeApplication(ApplicationId appId, ProgramTerminator programTer\n     Id.Artifact newArtifact = Id.Artifact.fromEntityId(Artifacts.toProtoArtifactId(appId.getParent(), newArtifactId));\n     ArtifactDetail newArtifactDetail = artifactRepository.getArtifact(newArtifact);\n \n-    updateApplicationInternal(appId, currentSpec.getConfiguration(), programTerminator, newArtifactDetail,\n+    updateApplicationInternal(appId, currentSpec.getConfiguration(), programId -> { }, newArtifactDetail,", "originalCommit": "70e31c1628dbb5204526bd8719b6f1cd1940fd31", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDU5MTAwMQ==", "url": "https://github.com/cdapio/cdap/pull/12329#discussion_r440591001", "bodyText": "I kept it so that any \"update\" usage in future can use it for their purpose. For upgrade, we dont want to terminate jobs but may be for other kind \"updates\" we might want to so I kept it for now (also it is similar to current \"Update\" API which updates config in place).", "author": "pandyajay10", "createdAt": "2020-06-16T05:16:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDU4NzM1OQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "6b88e3c9fc798d0076076567a055f7eef4a249bc", "url": "https://github.com/cdapio/cdap/commit/6b88e3c9fc798d0076076567a055f7eef4a249bc", "message": "Change Batch Upgrade REST API to take in list of ApplicationRecords.\nChange ApplicationUpdateDetail API. Change error code for upgrade response. Introduce \"label\" in ETLStage for compatibility.", "committedDate": "2020-06-16T05:54:20Z", "type": "commit"}, {"oid": "6b88e3c9fc798d0076076567a055f7eef4a249bc", "url": "https://github.com/cdapio/cdap/commit/6b88e3c9fc798d0076076567a055f7eef4a249bc", "message": "Change Batch Upgrade REST API to take in list of ApplicationRecords.\nChange ApplicationUpdateDetail API. Change error code for upgrade response. Introduce \"label\" in ETLStage for compatibility.", "committedDate": "2020-06-16T05:54:20Z", "type": "forcePushed"}]}