{"pr_number": 11861, "pr_title": "(CDAP-16243) Support for config based bootstrapping for system application on CDAP", "pr_createdAt": "2020-02-11T05:26:51Z", "pr_url": "https://github.com/cdapio/cdap/pull/11861", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQ1Mjk4MQ==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r377452981", "bodyText": "Debug", "author": "nitinmotgi", "createdAt": "2020-02-11T05:40:32Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.sysapp;\n+\n+import com.google.common.util.concurrent.AbstractIdleService;\n+import com.google.gson.Gson;\n+import com.google.gson.JsonParseException;\n+import com.google.inject.Inject;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.internal.app.services.ApplicationLifecycleService;\n+import io.cdap.cdap.internal.app.services.ProgramLifecycleService;\n+import org.apache.twill.common.Threads;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.File;\n+import java.io.FileNotFoundException;\n+import java.io.FileReader;\n+import java.io.IOException;\n+import java.io.Reader;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+\n+/**\n+ * Enables system apps using system app config files located in SYSTEM_APP_CONFIG_DIR. Each config\n+ * describes steps to perform to start one (or more) system app. Currently\n+ * SystemAppManagementService runs during bootstrap phase.\n+ */\n+public class SystemAppManagementService extends AbstractIdleService {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(SystemAppManagementService.class);\n+  private static final Gson GSON = new Gson();\n+\n+  private final File systemAppConfigDirPath;\n+  private final SystemAppEnableExecutor systemAppEnableExecutor;\n+  private ExecutorService executorService;\n+\n+  @Inject\n+  SystemAppManagementService(CConfiguration cConf, ApplicationLifecycleService appLifecycleService,\n+      ProgramLifecycleService programLifecycleService) {\n+    this.systemAppConfigDirPath = new File(cConf.get(Constants.SYSTEM_APP_CONFIG_DIR));\n+    this.systemAppEnableExecutor = new SystemAppEnableExecutor(appLifecycleService,\n+        programLifecycleService);\n+  }\n+\n+  @Override\n+  protected void startUp() {\n+    LOG.info(\"Starting {}\", getClass().getSimpleName());", "originalCommit": "1cce764fcaa94645fa6f4804b85d69123860be62", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "99d5cde6912612787c31820e6ef9612bf88d8c05", "chunk": "diff --git a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java\nindex 2a238781de0..212598a4f75 100644\n--- a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java\n+++ b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java\n\n@@ -60,7 +60,7 @@ public class SystemAppManagementService extends AbstractIdleService {\n \n   @Override\n   protected void startUp() {\n-    LOG.info(\"Starting {}\", getClass().getSimpleName());\n+    LOG.debug(\"Starting {}\", getClass().getSimpleName());\n     executorService = Executors\n         .newSingleThreadExecutor(Threads.createDaemonThreadFactory(\"sys-app-management-service\"));\n     executorService.execute(() -> {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQ1MzE2OQ==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r377453169", "bodyText": "Debug or trace", "author": "nitinmotgi", "createdAt": "2020-02-11T05:41:40Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.sysapp;\n+\n+import com.google.common.util.concurrent.AbstractIdleService;\n+import com.google.gson.Gson;\n+import com.google.gson.JsonParseException;\n+import com.google.inject.Inject;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.internal.app.services.ApplicationLifecycleService;\n+import io.cdap.cdap.internal.app.services.ProgramLifecycleService;\n+import org.apache.twill.common.Threads;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.File;\n+import java.io.FileNotFoundException;\n+import java.io.FileReader;\n+import java.io.IOException;\n+import java.io.Reader;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+\n+/**\n+ * Enables system apps using system app config files located in SYSTEM_APP_CONFIG_DIR. Each config\n+ * describes steps to perform to start one (or more) system app. Currently\n+ * SystemAppManagementService runs during bootstrap phase.\n+ */\n+public class SystemAppManagementService extends AbstractIdleService {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(SystemAppManagementService.class);\n+  private static final Gson GSON = new Gson();\n+\n+  private final File systemAppConfigDirPath;\n+  private final SystemAppEnableExecutor systemAppEnableExecutor;\n+  private ExecutorService executorService;\n+\n+  @Inject\n+  SystemAppManagementService(CConfiguration cConf, ApplicationLifecycleService appLifecycleService,\n+      ProgramLifecycleService programLifecycleService) {\n+    this.systemAppConfigDirPath = new File(cConf.get(Constants.SYSTEM_APP_CONFIG_DIR));\n+    this.systemAppEnableExecutor = new SystemAppEnableExecutor(appLifecycleService,\n+        programLifecycleService);\n+  }\n+\n+  @Override\n+  protected void startUp() {\n+    LOG.info(\"Starting {}\", getClass().getSimpleName());\n+    executorService = Executors\n+        .newSingleThreadExecutor(Threads.createDaemonThreadFactory(\"sys-app-management-service\"));\n+    executorService.execute(() -> {\n+      try {\n+        // Execute all steps for each config file in system config directory.\n+        bootStrapSystemAppConfigDir();\n+      } catch (Exception ex) {\n+        LOG.error(\"Got exception in watch service for system app config dir\", ex);\n+      }\n+    });\n+  }\n+\n+  private void bootStrapSystemAppConfigDir() throws Exception {\n+    LOG.info(\"Number of config files {} in system app config directory.\",", "originalCommit": "1cce764fcaa94645fa6f4804b85d69123860be62", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "99d5cde6912612787c31820e6ef9612bf88d8c05", "chunk": "diff --git a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java\nindex 2a238781de0..212598a4f75 100644\n--- a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java\n+++ b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java\n\n@@ -60,7 +60,7 @@ public class SystemAppManagementService extends AbstractIdleService {\n \n   @Override\n   protected void startUp() {\n-    LOG.info(\"Starting {}\", getClass().getSimpleName());\n+    LOG.debug(\"Starting {}\", getClass().getSimpleName());\n     executorService = Executors\n         .newSingleThreadExecutor(Threads.createDaemonThreadFactory(\"sys-app-management-service\"));\n     executorService.execute(() -> {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQ1MzIwMA==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r377453200", "bodyText": "Debug or trace", "author": "nitinmotgi", "createdAt": "2020-02-11T05:41:55Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.sysapp;\n+\n+import com.google.common.util.concurrent.AbstractIdleService;\n+import com.google.gson.Gson;\n+import com.google.gson.JsonParseException;\n+import com.google.inject.Inject;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.internal.app.services.ApplicationLifecycleService;\n+import io.cdap.cdap.internal.app.services.ProgramLifecycleService;\n+import org.apache.twill.common.Threads;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.File;\n+import java.io.FileNotFoundException;\n+import java.io.FileReader;\n+import java.io.IOException;\n+import java.io.Reader;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+\n+/**\n+ * Enables system apps using system app config files located in SYSTEM_APP_CONFIG_DIR. Each config\n+ * describes steps to perform to start one (or more) system app. Currently\n+ * SystemAppManagementService runs during bootstrap phase.\n+ */\n+public class SystemAppManagementService extends AbstractIdleService {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(SystemAppManagementService.class);\n+  private static final Gson GSON = new Gson();\n+\n+  private final File systemAppConfigDirPath;\n+  private final SystemAppEnableExecutor systemAppEnableExecutor;\n+  private ExecutorService executorService;\n+\n+  @Inject\n+  SystemAppManagementService(CConfiguration cConf, ApplicationLifecycleService appLifecycleService,\n+      ProgramLifecycleService programLifecycleService) {\n+    this.systemAppConfigDirPath = new File(cConf.get(Constants.SYSTEM_APP_CONFIG_DIR));\n+    this.systemAppEnableExecutor = new SystemAppEnableExecutor(appLifecycleService,\n+        programLifecycleService);\n+  }\n+\n+  @Override\n+  protected void startUp() {\n+    LOG.info(\"Starting {}\", getClass().getSimpleName());\n+    executorService = Executors\n+        .newSingleThreadExecutor(Threads.createDaemonThreadFactory(\"sys-app-management-service\"));\n+    executorService.execute(() -> {\n+      try {\n+        // Execute all steps for each config file in system config directory.\n+        bootStrapSystemAppConfigDir();\n+      } catch (Exception ex) {\n+        LOG.error(\"Got exception in watch service for system app config dir\", ex);\n+      }\n+    });\n+  }\n+\n+  private void bootStrapSystemAppConfigDir() throws Exception {\n+    LOG.info(\"Number of config files {} in system app config directory.\",\n+        systemAppConfigDirPath.listFiles().length);\n+\n+    for (File sysAppConfigFile : systemAppConfigDirPath.listFiles()) {", "originalCommit": "1cce764fcaa94645fa6f4804b85d69123860be62", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "99d5cde6912612787c31820e6ef9612bf88d8c05", "chunk": "diff --git a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java\nindex 2a238781de0..212598a4f75 100644\n--- a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java\n+++ b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java\n\n@@ -60,7 +60,7 @@ public class SystemAppManagementService extends AbstractIdleService {\n \n   @Override\n   protected void startUp() {\n-    LOG.info(\"Starting {}\", getClass().getSimpleName());\n+    LOG.debug(\"Starting {}\", getClass().getSimpleName());\n     executorService = Executors\n         .newSingleThreadExecutor(Threads.createDaemonThreadFactory(\"sys-app-management-service\"));\n     executorService.execute(() -> {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQ1MzI2OQ==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r377453269", "bodyText": "Debug or trace", "author": "nitinmotgi", "createdAt": "2020-02-11T05:42:19Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.sysapp;\n+\n+import com.google.common.util.concurrent.AbstractIdleService;\n+import com.google.gson.Gson;\n+import com.google.gson.JsonParseException;\n+import com.google.inject.Inject;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.internal.app.services.ApplicationLifecycleService;\n+import io.cdap.cdap.internal.app.services.ProgramLifecycleService;\n+import org.apache.twill.common.Threads;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.File;\n+import java.io.FileNotFoundException;\n+import java.io.FileReader;\n+import java.io.IOException;\n+import java.io.Reader;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+\n+/**\n+ * Enables system apps using system app config files located in SYSTEM_APP_CONFIG_DIR. Each config\n+ * describes steps to perform to start one (or more) system app. Currently\n+ * SystemAppManagementService runs during bootstrap phase.\n+ */\n+public class SystemAppManagementService extends AbstractIdleService {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(SystemAppManagementService.class);\n+  private static final Gson GSON = new Gson();\n+\n+  private final File systemAppConfigDirPath;\n+  private final SystemAppEnableExecutor systemAppEnableExecutor;\n+  private ExecutorService executorService;\n+\n+  @Inject\n+  SystemAppManagementService(CConfiguration cConf, ApplicationLifecycleService appLifecycleService,\n+      ProgramLifecycleService programLifecycleService) {\n+    this.systemAppConfigDirPath = new File(cConf.get(Constants.SYSTEM_APP_CONFIG_DIR));\n+    this.systemAppEnableExecutor = new SystemAppEnableExecutor(appLifecycleService,\n+        programLifecycleService);\n+  }\n+\n+  @Override\n+  protected void startUp() {\n+    LOG.info(\"Starting {}\", getClass().getSimpleName());\n+    executorService = Executors\n+        .newSingleThreadExecutor(Threads.createDaemonThreadFactory(\"sys-app-management-service\"));\n+    executorService.execute(() -> {\n+      try {\n+        // Execute all steps for each config file in system config directory.\n+        bootStrapSystemAppConfigDir();\n+      } catch (Exception ex) {\n+        LOG.error(\"Got exception in watch service for system app config dir\", ex);\n+      }\n+    });\n+  }\n+\n+  private void bootStrapSystemAppConfigDir() throws Exception {\n+    LOG.info(\"Number of config files {} in system app config directory.\",\n+        systemAppConfigDirPath.listFiles().length);\n+\n+    for (File sysAppConfigFile : systemAppConfigDirPath.listFiles()) {\n+      LOG.info(\"Running steps in config file {}\", sysAppConfigFile.getAbsoluteFile());\n+      sysConfigExecutor(sysAppConfigFile.getAbsoluteFile());\n+    }\n+  }\n+\n+  private void sysConfigExecutor(File fileName) throws Exception {\n+    SystemAppConfig config = parseConfig(fileName);\n+    for (SystemAppStep step : config.getSteps()) {\n+      try {\n+        step.validate();\n+      } catch (IllegalArgumentException e) {\n+        LOG.warn(\"Config step {} failed because it is malformed: {}\", step.getLabel(),\n+            e.getMessage());\n+        return;\n+      }\n+      if (step.getType() == SystemAppStep.Type.ENABLE_SYSTEM_APP) {\n+        systemAppEnableExecutor.deployAppAndStartPrograms(step.getArguments());\n+        LOG.info(\"Deployed and enabled system app with id {} and label {}. Config file: {}.\",", "originalCommit": "1cce764fcaa94645fa6f4804b85d69123860be62", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "99d5cde6912612787c31820e6ef9612bf88d8c05", "chunk": "diff --git a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java\nindex 2a238781de0..212598a4f75 100644\n--- a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java\n+++ b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java\n\n@@ -60,7 +60,7 @@ public class SystemAppManagementService extends AbstractIdleService {\n \n   @Override\n   protected void startUp() {\n-    LOG.info(\"Starting {}\", getClass().getSimpleName());\n+    LOG.debug(\"Starting {}\", getClass().getSimpleName());\n     executorService = Executors\n         .newSingleThreadExecutor(Threads.createDaemonThreadFactory(\"sys-app-management-service\"));\n     executorService.execute(() -> {\n"}}, {"oid": "99d5cde6912612787c31820e6ef9612bf88d8c05", "url": "https://github.com/cdapio/cdap/commit/99d5cde6912612787c31820e6ef9612bf88d8c05", "message": "Addressing log line comments", "committedDate": "2020-02-11T20:18:37Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkxMDA0OA==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r377910048", "bodyText": "style: indentation should match the rest of the project, where this variable is aligned with the variable from the previous line:\nXyz(String s1,\n    String s2", "author": "albertshau", "createdAt": "2020-02-11T21:29:12Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java", "diffHunk": "@@ -0,0 +1,141 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.sysapp;\n+\n+import com.google.common.base.Preconditions;\n+import com.google.gson.Gson;\n+import com.google.inject.Inject;\n+import io.cdap.cdap.api.artifact.ArtifactSummary;\n+import io.cdap.cdap.api.dataset.DatasetManagementException;\n+import io.cdap.cdap.api.retry.RetryableException;\n+import io.cdap.cdap.app.program.ProgramDescriptor;\n+import io.cdap.cdap.common.ApplicationNotFoundException;\n+import io.cdap.cdap.common.ConflictException;\n+import io.cdap.cdap.common.InvalidArtifactException;\n+import io.cdap.cdap.common.NotFoundException;\n+import io.cdap.cdap.common.service.Retries;\n+import io.cdap.cdap.common.service.RetryStrategies;\n+import io.cdap.cdap.internal.app.deploy.pipeline.ApplicationWithPrograms;\n+import io.cdap.cdap.internal.app.services.ApplicationLifecycleService;\n+import io.cdap.cdap.internal.app.services.ProgramLifecycleService;\n+import io.cdap.cdap.internal.sysapp.SystemAppStep.Arguments;\n+import io.cdap.cdap.proto.ProgramStatus;\n+import io.cdap.cdap.proto.id.ApplicationId;\n+import io.cdap.cdap.proto.id.KerberosPrincipalId;\n+import io.cdap.cdap.proto.id.ProgramId;\n+import io.cdap.cdap.security.spi.authorization.UnauthorizedException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.Collections;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * Deploys an application with given arguments. Also runs all programs corresponding to the\n+ * application.\n+ */\n+public class SystemAppEnableExecutor {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(SystemAppEnableExecutor.class);\n+  private static final Gson GSON = new Gson();\n+  private final ApplicationLifecycleService appLifecycleService;\n+  private final ProgramLifecycleService programLifecycleService;\n+\n+  @Inject\n+  SystemAppEnableExecutor(ApplicationLifecycleService appLifecycleService,\n+      ProgramLifecycleService programLifecycleService) {", "originalCommit": "99d5cde6912612787c31820e6ef9612bf88d8c05", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d2fbb2550578c5ecadbfda7de4f312360f752d6e", "chunk": "diff --git a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\nindex cf95c868d05..ac061f162a8 100644\n--- a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\n+++ b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\n\n@@ -27,6 +27,8 @@ import io.cdap.cdap.common.ApplicationNotFoundException;\n import io.cdap.cdap.common.ConflictException;\n import io.cdap.cdap.common.InvalidArtifactException;\n import io.cdap.cdap.common.NotFoundException;\n+import io.cdap.cdap.common.logging.LogSamplers;\n+import io.cdap.cdap.common.logging.Loggers;\n import io.cdap.cdap.common.service.Retries;\n import io.cdap.cdap.common.service.RetryStrategies;\n import io.cdap.cdap.internal.app.deploy.pipeline.ApplicationWithPrograms;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkxMDM5MQ==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r377910391", "bodyText": "style: max line width is 120 characters. this looks like it could fit on the previous line.", "author": "albertshau", "createdAt": "2020-02-11T21:29:54Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java", "diffHunk": "@@ -0,0 +1,141 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.sysapp;\n+\n+import com.google.common.base.Preconditions;\n+import com.google.gson.Gson;\n+import com.google.inject.Inject;\n+import io.cdap.cdap.api.artifact.ArtifactSummary;\n+import io.cdap.cdap.api.dataset.DatasetManagementException;\n+import io.cdap.cdap.api.retry.RetryableException;\n+import io.cdap.cdap.app.program.ProgramDescriptor;\n+import io.cdap.cdap.common.ApplicationNotFoundException;\n+import io.cdap.cdap.common.ConflictException;\n+import io.cdap.cdap.common.InvalidArtifactException;\n+import io.cdap.cdap.common.NotFoundException;\n+import io.cdap.cdap.common.service.Retries;\n+import io.cdap.cdap.common.service.RetryStrategies;\n+import io.cdap.cdap.internal.app.deploy.pipeline.ApplicationWithPrograms;\n+import io.cdap.cdap.internal.app.services.ApplicationLifecycleService;\n+import io.cdap.cdap.internal.app.services.ProgramLifecycleService;\n+import io.cdap.cdap.internal.sysapp.SystemAppStep.Arguments;\n+import io.cdap.cdap.proto.ProgramStatus;\n+import io.cdap.cdap.proto.id.ApplicationId;\n+import io.cdap.cdap.proto.id.KerberosPrincipalId;\n+import io.cdap.cdap.proto.id.ProgramId;\n+import io.cdap.cdap.security.spi.authorization.UnauthorizedException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.Collections;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * Deploys an application with given arguments. Also runs all programs corresponding to the\n+ * application.\n+ */\n+public class SystemAppEnableExecutor {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(SystemAppEnableExecutor.class);\n+  private static final Gson GSON = new Gson();\n+  private final ApplicationLifecycleService appLifecycleService;\n+  private final ProgramLifecycleService programLifecycleService;\n+\n+  @Inject\n+  SystemAppEnableExecutor(ApplicationLifecycleService appLifecycleService,\n+      ProgramLifecycleService programLifecycleService) {\n+    this.appLifecycleService = appLifecycleService;\n+    this.programLifecycleService = programLifecycleService;\n+  }\n+\n+  public void deployAppAndStartPrograms(Arguments arguments) {\n+    try {\n+      // TODO(CDAP-16243): Make deploy app and start programs idempotent to not have transactional issues.\n+      ApplicationWithPrograms appDetail = retryableDeploySystemApp(arguments);\n+      for (ProgramDescriptor program : appDetail.getPrograms()) {\n+        startProgram(program.getProgramId());\n+      }\n+    } catch (Exception ex) {\n+      LOG.error(\"Failed to deploy app {} and start its program with exception {}.\",\n+          arguments.getId(), ex);\n+\n+    }\n+  }\n+\n+  private ApplicationWithPrograms retryableDeploySystemApp(Arguments arguments) throws Exception {\n+    return Retries.callWithRetries(() -> deploySystemApp(arguments),\n+        RetryStrategies.fixDelay(6, TimeUnit.SECONDS));", "originalCommit": "99d5cde6912612787c31820e6ef9612bf88d8c05", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk2MjY2MQ==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r377962661", "bodyText": "Seems like google plugin indentation for intellij is set at 80 char. But fixed applied according to your suggestion.", "author": "pandyajay10", "createdAt": "2020-02-11T23:33:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkxMDM5MQ=="}], "type": "inlineReview", "revised_code": {"commit": "d2fbb2550578c5ecadbfda7de4f312360f752d6e", "chunk": "diff --git a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\nindex cf95c868d05..ac061f162a8 100644\n--- a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\n+++ b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\n\n@@ -27,6 +27,8 @@ import io.cdap.cdap.common.ApplicationNotFoundException;\n import io.cdap.cdap.common.ConflictException;\n import io.cdap.cdap.common.InvalidArtifactException;\n import io.cdap.cdap.common.NotFoundException;\n+import io.cdap.cdap.common.logging.LogSamplers;\n+import io.cdap.cdap.common.logging.Loggers;\n import io.cdap.cdap.common.service.Retries;\n import io.cdap.cdap.common.service.RetryStrategies;\n import io.cdap.cdap.internal.app.deploy.pipeline.ApplicationWithPrograms;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkxNDExOQ==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r377914119", "bodyText": "style: when a line wraps (and it's not in the middle of a method call), the next line should be indented with 2 spaces instead of 4\nint x = 500 + \n  100;", "author": "albertshau", "createdAt": "2020-02-11T21:37:19Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java", "diffHunk": "@@ -0,0 +1,141 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.sysapp;\n+\n+import com.google.common.base.Preconditions;\n+import com.google.gson.Gson;\n+import com.google.inject.Inject;\n+import io.cdap.cdap.api.artifact.ArtifactSummary;\n+import io.cdap.cdap.api.dataset.DatasetManagementException;\n+import io.cdap.cdap.api.retry.RetryableException;\n+import io.cdap.cdap.app.program.ProgramDescriptor;\n+import io.cdap.cdap.common.ApplicationNotFoundException;\n+import io.cdap.cdap.common.ConflictException;\n+import io.cdap.cdap.common.InvalidArtifactException;\n+import io.cdap.cdap.common.NotFoundException;\n+import io.cdap.cdap.common.service.Retries;\n+import io.cdap.cdap.common.service.RetryStrategies;\n+import io.cdap.cdap.internal.app.deploy.pipeline.ApplicationWithPrograms;\n+import io.cdap.cdap.internal.app.services.ApplicationLifecycleService;\n+import io.cdap.cdap.internal.app.services.ProgramLifecycleService;\n+import io.cdap.cdap.internal.sysapp.SystemAppStep.Arguments;\n+import io.cdap.cdap.proto.ProgramStatus;\n+import io.cdap.cdap.proto.id.ApplicationId;\n+import io.cdap.cdap.proto.id.KerberosPrincipalId;\n+import io.cdap.cdap.proto.id.ProgramId;\n+import io.cdap.cdap.security.spi.authorization.UnauthorizedException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.Collections;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * Deploys an application with given arguments. Also runs all programs corresponding to the\n+ * application.\n+ */\n+public class SystemAppEnableExecutor {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(SystemAppEnableExecutor.class);\n+  private static final Gson GSON = new Gson();\n+  private final ApplicationLifecycleService appLifecycleService;\n+  private final ProgramLifecycleService programLifecycleService;\n+\n+  @Inject\n+  SystemAppEnableExecutor(ApplicationLifecycleService appLifecycleService,\n+      ProgramLifecycleService programLifecycleService) {\n+    this.appLifecycleService = appLifecycleService;\n+    this.programLifecycleService = programLifecycleService;\n+  }\n+\n+  public void deployAppAndStartPrograms(Arguments arguments) {\n+    try {\n+      // TODO(CDAP-16243): Make deploy app and start programs idempotent to not have transactional issues.\n+      ApplicationWithPrograms appDetail = retryableDeploySystemApp(arguments);\n+      for (ProgramDescriptor program : appDetail.getPrograms()) {\n+        startProgram(program.getProgramId());\n+      }\n+    } catch (Exception ex) {\n+      LOG.error(\"Failed to deploy app {} and start its program with exception {}.\",\n+          arguments.getId(), ex);\n+\n+    }\n+  }\n+\n+  private ApplicationWithPrograms retryableDeploySystemApp(Arguments arguments) throws Exception {\n+    return Retries.callWithRetries(() -> deploySystemApp(arguments),\n+        RetryStrategies.fixDelay(6, TimeUnit.SECONDS));\n+  }\n+\n+  private ApplicationWithPrograms deploySystemApp(Arguments arguments) throws Exception {\n+    ApplicationId appId = arguments.getId();\n+    ArtifactSummary artifactSummary = arguments.getArtifact();\n+\n+    KerberosPrincipalId ownerPrincipalId =\n+        arguments.getOwnerPrincipal() == null ? null", "originalCommit": "99d5cde6912612787c31820e6ef9612bf88d8c05", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk2NDM1Mw==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r377964353", "bodyText": "Default Google setting for intellij indentation. Will change it.", "author": "pandyajay10", "createdAt": "2020-02-11T23:39:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkxNDExOQ=="}], "type": "inlineReview", "revised_code": {"commit": "d2fbb2550578c5ecadbfda7de4f312360f752d6e", "chunk": "diff --git a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\nindex cf95c868d05..ac061f162a8 100644\n--- a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\n+++ b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\n\n@@ -27,6 +27,8 @@ import io.cdap.cdap.common.ApplicationNotFoundException;\n import io.cdap.cdap.common.ConflictException;\n import io.cdap.cdap.common.InvalidArtifactException;\n import io.cdap.cdap.common.NotFoundException;\n+import io.cdap.cdap.common.logging.LogSamplers;\n+import io.cdap.cdap.common.logging.Loggers;\n import io.cdap.cdap.common.service.Retries;\n import io.cdap.cdap.common.service.RetryStrategies;\n import io.cdap.cdap.internal.app.deploy.pipeline.ApplicationWithPrograms;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkxNTYzOA==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r377915638", "bodyText": "style: it's more readable to remove the new line here, can have x -> { } on previous line", "author": "albertshau", "createdAt": "2020-02-11T21:40:13Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java", "diffHunk": "@@ -0,0 +1,141 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.sysapp;\n+\n+import com.google.common.base.Preconditions;\n+import com.google.gson.Gson;\n+import com.google.inject.Inject;\n+import io.cdap.cdap.api.artifact.ArtifactSummary;\n+import io.cdap.cdap.api.dataset.DatasetManagementException;\n+import io.cdap.cdap.api.retry.RetryableException;\n+import io.cdap.cdap.app.program.ProgramDescriptor;\n+import io.cdap.cdap.common.ApplicationNotFoundException;\n+import io.cdap.cdap.common.ConflictException;\n+import io.cdap.cdap.common.InvalidArtifactException;\n+import io.cdap.cdap.common.NotFoundException;\n+import io.cdap.cdap.common.service.Retries;\n+import io.cdap.cdap.common.service.RetryStrategies;\n+import io.cdap.cdap.internal.app.deploy.pipeline.ApplicationWithPrograms;\n+import io.cdap.cdap.internal.app.services.ApplicationLifecycleService;\n+import io.cdap.cdap.internal.app.services.ProgramLifecycleService;\n+import io.cdap.cdap.internal.sysapp.SystemAppStep.Arguments;\n+import io.cdap.cdap.proto.ProgramStatus;\n+import io.cdap.cdap.proto.id.ApplicationId;\n+import io.cdap.cdap.proto.id.KerberosPrincipalId;\n+import io.cdap.cdap.proto.id.ProgramId;\n+import io.cdap.cdap.security.spi.authorization.UnauthorizedException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.Collections;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * Deploys an application with given arguments. Also runs all programs corresponding to the\n+ * application.\n+ */\n+public class SystemAppEnableExecutor {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(SystemAppEnableExecutor.class);\n+  private static final Gson GSON = new Gson();\n+  private final ApplicationLifecycleService appLifecycleService;\n+  private final ProgramLifecycleService programLifecycleService;\n+\n+  @Inject\n+  SystemAppEnableExecutor(ApplicationLifecycleService appLifecycleService,\n+      ProgramLifecycleService programLifecycleService) {\n+    this.appLifecycleService = appLifecycleService;\n+    this.programLifecycleService = programLifecycleService;\n+  }\n+\n+  public void deployAppAndStartPrograms(Arguments arguments) {\n+    try {\n+      // TODO(CDAP-16243): Make deploy app and start programs idempotent to not have transactional issues.\n+      ApplicationWithPrograms appDetail = retryableDeploySystemApp(arguments);\n+      for (ProgramDescriptor program : appDetail.getPrograms()) {\n+        startProgram(program.getProgramId());\n+      }\n+    } catch (Exception ex) {\n+      LOG.error(\"Failed to deploy app {} and start its program with exception {}.\",\n+          arguments.getId(), ex);\n+\n+    }\n+  }\n+\n+  private ApplicationWithPrograms retryableDeploySystemApp(Arguments arguments) throws Exception {\n+    return Retries.callWithRetries(() -> deploySystemApp(arguments),\n+        RetryStrategies.fixDelay(6, TimeUnit.SECONDS));\n+  }\n+\n+  private ApplicationWithPrograms deploySystemApp(Arguments arguments) throws Exception {\n+    ApplicationId appId = arguments.getId();\n+    ArtifactSummary artifactSummary = arguments.getArtifact();\n+\n+    KerberosPrincipalId ownerPrincipalId =\n+        arguments.getOwnerPrincipal() == null ? null\n+            : new KerberosPrincipalId(arguments.getOwnerPrincipal());\n+\n+    // if we don't null check, it gets serialized to \"null\"\n+    String configString =\n+        arguments.getConfig() == null ? null : GSON.toJson(arguments.getConfig());\n+\n+    try {\n+      return appLifecycleService\n+          .deployApp(appId.getParent(), appId.getApplication(), appId.getVersion(),\n+              artifactSummary, configString, x -> {\n+              },", "originalCommit": "99d5cde6912612787c31820e6ef9612bf88d8c05", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d2fbb2550578c5ecadbfda7de4f312360f752d6e", "chunk": "diff --git a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\nindex cf95c868d05..ac061f162a8 100644\n--- a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\n+++ b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\n\n@@ -27,6 +27,8 @@ import io.cdap.cdap.common.ApplicationNotFoundException;\n import io.cdap.cdap.common.ConflictException;\n import io.cdap.cdap.common.InvalidArtifactException;\n import io.cdap.cdap.common.NotFoundException;\n+import io.cdap.cdap.common.logging.LogSamplers;\n+import io.cdap.cdap.common.logging.Loggers;\n import io.cdap.cdap.common.service.Retries;\n import io.cdap.cdap.common.service.RetryStrategies;\n import io.cdap.cdap.internal.app.deploy.pipeline.ApplicationWithPrograms;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkxNzI5Nw==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r377917297", "bodyText": "change the log message, as this isn't bootstrap.\nThis is also a normal situation, I don't think we need to log anything here.", "author": "albertshau", "createdAt": "2020-02-11T21:43:23Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java", "diffHunk": "@@ -0,0 +1,141 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.sysapp;\n+\n+import com.google.common.base.Preconditions;\n+import com.google.gson.Gson;\n+import com.google.inject.Inject;\n+import io.cdap.cdap.api.artifact.ArtifactSummary;\n+import io.cdap.cdap.api.dataset.DatasetManagementException;\n+import io.cdap.cdap.api.retry.RetryableException;\n+import io.cdap.cdap.app.program.ProgramDescriptor;\n+import io.cdap.cdap.common.ApplicationNotFoundException;\n+import io.cdap.cdap.common.ConflictException;\n+import io.cdap.cdap.common.InvalidArtifactException;\n+import io.cdap.cdap.common.NotFoundException;\n+import io.cdap.cdap.common.service.Retries;\n+import io.cdap.cdap.common.service.RetryStrategies;\n+import io.cdap.cdap.internal.app.deploy.pipeline.ApplicationWithPrograms;\n+import io.cdap.cdap.internal.app.services.ApplicationLifecycleService;\n+import io.cdap.cdap.internal.app.services.ProgramLifecycleService;\n+import io.cdap.cdap.internal.sysapp.SystemAppStep.Arguments;\n+import io.cdap.cdap.proto.ProgramStatus;\n+import io.cdap.cdap.proto.id.ApplicationId;\n+import io.cdap.cdap.proto.id.KerberosPrincipalId;\n+import io.cdap.cdap.proto.id.ProgramId;\n+import io.cdap.cdap.security.spi.authorization.UnauthorizedException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.Collections;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * Deploys an application with given arguments. Also runs all programs corresponding to the\n+ * application.\n+ */\n+public class SystemAppEnableExecutor {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(SystemAppEnableExecutor.class);\n+  private static final Gson GSON = new Gson();\n+  private final ApplicationLifecycleService appLifecycleService;\n+  private final ProgramLifecycleService programLifecycleService;\n+\n+  @Inject\n+  SystemAppEnableExecutor(ApplicationLifecycleService appLifecycleService,\n+      ProgramLifecycleService programLifecycleService) {\n+    this.appLifecycleService = appLifecycleService;\n+    this.programLifecycleService = programLifecycleService;\n+  }\n+\n+  public void deployAppAndStartPrograms(Arguments arguments) {\n+    try {\n+      // TODO(CDAP-16243): Make deploy app and start programs idempotent to not have transactional issues.\n+      ApplicationWithPrograms appDetail = retryableDeploySystemApp(arguments);\n+      for (ProgramDescriptor program : appDetail.getPrograms()) {\n+        startProgram(program.getProgramId());\n+      }\n+    } catch (Exception ex) {\n+      LOG.error(\"Failed to deploy app {} and start its program with exception {}.\",\n+          arguments.getId(), ex);\n+\n+    }\n+  }\n+\n+  private ApplicationWithPrograms retryableDeploySystemApp(Arguments arguments) throws Exception {\n+    return Retries.callWithRetries(() -> deploySystemApp(arguments),\n+        RetryStrategies.fixDelay(6, TimeUnit.SECONDS));\n+  }\n+\n+  private ApplicationWithPrograms deploySystemApp(Arguments arguments) throws Exception {\n+    ApplicationId appId = arguments.getId();\n+    ArtifactSummary artifactSummary = arguments.getArtifact();\n+\n+    KerberosPrincipalId ownerPrincipalId =\n+        arguments.getOwnerPrincipal() == null ? null\n+            : new KerberosPrincipalId(arguments.getOwnerPrincipal());\n+\n+    // if we don't null check, it gets serialized to \"null\"\n+    String configString =\n+        arguments.getConfig() == null ? null : GSON.toJson(arguments.getConfig());\n+\n+    try {\n+      return appLifecycleService\n+          .deployApp(appId.getParent(), appId.getApplication(), appId.getVersion(),\n+              artifactSummary, configString, x -> {\n+              },\n+              ownerPrincipalId, arguments.canUpdateSchedules());\n+    } catch (NotFoundException | UnauthorizedException | InvalidArtifactException e) {\n+      // these exceptions are for sure not retry-able. It's hard to tell if the others are, so we just try retrying\n+      // up to the default time limit\n+      throw e;\n+    } catch (DatasetManagementException e) {\n+      if (e.getCause() instanceof UnauthorizedException) {\n+        throw (UnauthorizedException) e.getCause();\n+      } else {\n+        throw new RetryableException(e);\n+      }\n+    } catch (Exception e) {\n+      throw new RetryableException(e);\n+    }\n+  }\n+\n+  private void startProgram(ProgramId programId) throws Exception {\n+    Preconditions.checkArgument(programLifecycleService.getProgramSpecification(programId) != null,\n+        \"Cannot start %s because it does not exist.\", programId);\n+\n+    try {\n+      // do nothing if the program is already running\n+      ProgramStatus currentStatus = programLifecycleService.getProgramStatus(programId);\n+      if (currentStatus != ProgramStatus.STOPPED) {\n+        LOG.info(\"Program {} is in the {} state, skipping start program system bootstrap step.\",", "originalCommit": "99d5cde6912612787c31820e6ef9612bf88d8c05", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk2NDE3Mw==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r377964173", "bodyText": "Oh I changed it as system bootstrap  but makes sense to not have log.", "author": "pandyajay10", "createdAt": "2020-02-11T23:38:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkxNzI5Nw=="}], "type": "inlineReview", "revised_code": {"commit": "d2fbb2550578c5ecadbfda7de4f312360f752d6e", "chunk": "diff --git a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\nindex cf95c868d05..ac061f162a8 100644\n--- a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\n+++ b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\n\n@@ -27,6 +27,8 @@ import io.cdap.cdap.common.ApplicationNotFoundException;\n import io.cdap.cdap.common.ConflictException;\n import io.cdap.cdap.common.InvalidArtifactException;\n import io.cdap.cdap.common.NotFoundException;\n+import io.cdap.cdap.common.logging.LogSamplers;\n+import io.cdap.cdap.common.logging.Loggers;\n import io.cdap.cdap.common.service.Retries;\n import io.cdap.cdap.common.service.RetryStrategies;\n import io.cdap.cdap.internal.app.deploy.pipeline.ApplicationWithPrograms;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkxNzgxNw==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r377917817", "bodyText": "this is only temporary for a few days until you add the file watcher right?", "author": "albertshau", "createdAt": "2020-02-11T21:44:22Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.sysapp;\n+\n+import com.google.common.util.concurrent.AbstractIdleService;\n+import com.google.gson.Gson;\n+import com.google.gson.JsonParseException;\n+import com.google.inject.Inject;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.internal.app.services.ApplicationLifecycleService;\n+import io.cdap.cdap.internal.app.services.ProgramLifecycleService;\n+import org.apache.twill.common.Threads;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.File;\n+import java.io.FileNotFoundException;\n+import java.io.FileReader;\n+import java.io.IOException;\n+import java.io.Reader;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+\n+/**\n+ * Enables system apps using system app config files located in SYSTEM_APP_CONFIG_DIR. Each config\n+ * describes steps to perform to start one (or more) system app. Currently\n+ * SystemAppManagementService runs during bootstrap phase.", "originalCommit": "99d5cde6912612787c31820e6ef9612bf88d8c05", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk2NDkzMg==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r377964932", "bodyText": "We will have both steps as filewatcher does not act on files which already exists.\n\n\"Init bootstrap\": Which will act on all config files that are already there.\nFile watcher: Which will act on new changes after watchservice starts.", "author": "pandyajay10", "createdAt": "2020-02-11T23:41:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkxNzgxNw=="}], "type": "inlineReview", "revised_code": {"commit": "d2fbb2550578c5ecadbfda7de4f312360f752d6e", "chunk": "diff --git a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java\nindex 212598a4f75..96e49d500a4 100644\n--- a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java\n+++ b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java\n\n@@ -22,6 +22,7 @@ import com.google.gson.JsonParseException;\n import com.google.inject.Inject;\n import io.cdap.cdap.common.conf.CConfiguration;\n import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.utils.DirUtils;\n import io.cdap.cdap.internal.app.services.ApplicationLifecycleService;\n import io.cdap.cdap.internal.app.services.ProgramLifecycleService;\n import org.apache.twill.common.Threads;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkxOTk2MQ==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r377919961", "bodyText": "style: for the most part, method names should be verbs and not nouns, as they are performing some action.", "author": "albertshau", "createdAt": "2020-02-11T21:48:45Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.sysapp;\n+\n+import com.google.common.util.concurrent.AbstractIdleService;\n+import com.google.gson.Gson;\n+import com.google.gson.JsonParseException;\n+import com.google.inject.Inject;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.internal.app.services.ApplicationLifecycleService;\n+import io.cdap.cdap.internal.app.services.ProgramLifecycleService;\n+import org.apache.twill.common.Threads;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.File;\n+import java.io.FileNotFoundException;\n+import java.io.FileReader;\n+import java.io.IOException;\n+import java.io.Reader;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+\n+/**\n+ * Enables system apps using system app config files located in SYSTEM_APP_CONFIG_DIR. Each config\n+ * describes steps to perform to start one (or more) system app. Currently\n+ * SystemAppManagementService runs during bootstrap phase.\n+ */\n+public class SystemAppManagementService extends AbstractIdleService {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(SystemAppManagementService.class);\n+  private static final Gson GSON = new Gson();\n+\n+  private final File systemAppConfigDirPath;\n+  private final SystemAppEnableExecutor systemAppEnableExecutor;\n+  private ExecutorService executorService;\n+\n+  @Inject\n+  SystemAppManagementService(CConfiguration cConf, ApplicationLifecycleService appLifecycleService,\n+      ProgramLifecycleService programLifecycleService) {\n+    this.systemAppConfigDirPath = new File(cConf.get(Constants.SYSTEM_APP_CONFIG_DIR));\n+    this.systemAppEnableExecutor = new SystemAppEnableExecutor(appLifecycleService,\n+        programLifecycleService);\n+  }\n+\n+  @Override\n+  protected void startUp() {\n+    LOG.debug(\"Starting {}\", getClass().getSimpleName());\n+    executorService = Executors\n+        .newSingleThreadExecutor(Threads.createDaemonThreadFactory(\"sys-app-management-service\"));\n+    executorService.execute(() -> {\n+      try {\n+        // Execute all steps for each config file in system config directory.\n+        bootStrapSystemAppConfigDir();\n+      } catch (Exception ex) {\n+        LOG.error(\"Got exception in watch service for system app config dir\", ex);\n+      }\n+    });\n+  }\n+\n+  private void bootStrapSystemAppConfigDir() throws Exception {\n+    LOG.debug(\"Number of config files {} in system app config directory.\",\n+        systemAppConfigDirPath.listFiles().length);\n+\n+    for (File sysAppConfigFile : systemAppConfigDirPath.listFiles()) {\n+      LOG.debug(\"Running steps in config file {}\", sysAppConfigFile.getAbsoluteFile());\n+      sysConfigExecutor(sysAppConfigFile.getAbsoluteFile());\n+    }\n+  }\n+\n+  private void sysConfigExecutor(File fileName) throws Exception {", "originalCommit": "99d5cde6912612787c31820e6ef9612bf88d8c05", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk2NTQ2OQ==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r377965469", "bodyText": "Agreed. Changed accordingly.", "author": "pandyajay10", "createdAt": "2020-02-11T23:42:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkxOTk2MQ=="}], "type": "inlineReview", "revised_code": {"commit": "d2fbb2550578c5ecadbfda7de4f312360f752d6e", "chunk": "diff --git a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java\nindex 212598a4f75..96e49d500a4 100644\n--- a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java\n+++ b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java\n\n@@ -22,6 +22,7 @@ import com.google.gson.JsonParseException;\n import com.google.inject.Inject;\n import io.cdap.cdap.common.conf.CConfiguration;\n import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.utils.DirUtils;\n import io.cdap.cdap.internal.app.services.ApplicationLifecycleService;\n import io.cdap.cdap.internal.app.services.ProgramLifecycleService;\n import org.apache.twill.common.Threads;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkyMzc1NQ==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r377923755", "bodyText": "undo these style changes", "author": "albertshau", "createdAt": "2020-02-11T21:56:37Z", "path": "cdap-app-fabric/src/test/java/io/cdap/cdap/internal/app/services/http/AppFabricTestBase.java", "diffHunk": "@@ -151,39 +151,48 @@\n import javax.ws.rs.core.MediaType;\n \n /**\n- * AppFabric HttpHandler Test classes can extend this class, this will allow the HttpService be setup before\n- * running the handler tests, this also gives the ability to run individual test cases.\n+ * AppFabric HttpHandler Test classes can extend this class, this will allow the HttpService be\n+ * setup before running the handler tests, this also gives the ability to run individual test\n+ * cases.\n  */\n public abstract class AppFabricTestBase {\n+\n   protected static final Gson GSON = new GsonBuilder()\n-    .registerTypeAdapterFactory(new CaseInsensitiveEnumTypeAdapterFactory())\n-    .registerTypeAdapter(Trigger.class, new TriggerCodec())\n-    .registerTypeAdapter(SatisfiableTrigger.class, new TriggerCodec())\n-    .registerTypeAdapter(Constraint.class, new ProtoConstraintCodec())\n-    .create();\n+      .registerTypeAdapterFactory(new CaseInsensitiveEnumTypeAdapterFactory())\n+      .registerTypeAdapter(Trigger.class, new TriggerCodec())\n+      .registerTypeAdapter(SatisfiableTrigger.class, new TriggerCodec())\n+      .registerTypeAdapter(Constraint.class, new ProtoConstraintCodec())\n+      .create();\n   private static final String API_KEY = \"SampleTestApiKey\";\n \n-  private static final Type BATCH_PROGRAM_RUNS_TYPE = new TypeToken<List<BatchProgramHistory>>() { }.getType();\n-  private static final Type LIST_JSON_OBJECT_TYPE = new TypeToken<List<JsonObject>>() { }.getType();\n-  private static final Type LIST_RUNRECORD_TYPE = new TypeToken<List<RunRecord>>() { }.getType();\n-  private static final Type SET_TRING_TYPE = new TypeToken<Set<String>>() { }.getType();\n-  private static final Type LIST_PROFILE = new TypeToken<List<Profile>>() { }.getType();\n-\n-  protected static final Type LIST_MAP_STRING_STRING_TYPE = new TypeToken<List<Map<String, String>>>() { }.getType();\n-  protected static final Type MAP_STRING_STRING_TYPE = new TypeToken<Map<String, String>>() { }.getType();\n+  private static final Type BATCH_PROGRAM_RUNS_TYPE = new TypeToken<List<BatchProgramHistory>>() {\n+  }.getType();", "originalCommit": "99d5cde6912612787c31820e6ef9612bf88d8c05", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d2fbb2550578c5ecadbfda7de4f312360f752d6e", "chunk": "diff --git a/cdap-app-fabric/src/test/java/io/cdap/cdap/internal/app/services/http/AppFabricTestBase.java b/cdap-app-fabric/src/test/java/io/cdap/cdap/internal/app/services/http/AppFabricTestBase.java\nindex f44edab2f83..6a1c200f9a7 100644\n--- a/cdap-app-fabric/src/test/java/io/cdap/cdap/internal/app/services/http/AppFabricTestBase.java\n+++ b/cdap-app-fabric/src/test/java/io/cdap/cdap/internal/app/services/http/AppFabricTestBase.java\n\n@@ -151,48 +151,39 @@ import javax.annotation.Nullable;\n import javax.ws.rs.core.MediaType;\n \n /**\n- * AppFabric HttpHandler Test classes can extend this class, this will allow the HttpService be\n- * setup before running the handler tests, this also gives the ability to run individual test\n- * cases.\n+ * AppFabric HttpHandler Test classes can extend this class, this will allow the HttpService be setup before\n+ * running the handler tests, this also gives the ability to run individual test cases.\n  */\n public abstract class AppFabricTestBase {\n-\n   protected static final Gson GSON = new GsonBuilder()\n-      .registerTypeAdapterFactory(new CaseInsensitiveEnumTypeAdapterFactory())\n-      .registerTypeAdapter(Trigger.class, new TriggerCodec())\n-      .registerTypeAdapter(SatisfiableTrigger.class, new TriggerCodec())\n-      .registerTypeAdapter(Constraint.class, new ProtoConstraintCodec())\n-      .create();\n+    .registerTypeAdapterFactory(new CaseInsensitiveEnumTypeAdapterFactory())\n+    .registerTypeAdapter(Trigger.class, new TriggerCodec())\n+    .registerTypeAdapter(SatisfiableTrigger.class, new TriggerCodec())\n+    .registerTypeAdapter(Constraint.class, new ProtoConstraintCodec())\n+    .create();\n   private static final String API_KEY = \"SampleTestApiKey\";\n \n-  private static final Type BATCH_PROGRAM_RUNS_TYPE = new TypeToken<List<BatchProgramHistory>>() {\n-  }.getType();\n-  private static final Type LIST_JSON_OBJECT_TYPE = new TypeToken<List<JsonObject>>() {\n-  }.getType();\n-  private static final Type LIST_RUNRECORD_TYPE = new TypeToken<List<RunRecord>>() {\n-  }.getType();\n-  private static final Type SET_TRING_TYPE = new TypeToken<Set<String>>() {\n-  }.getType();\n-  private static final Type LIST_PROFILE = new TypeToken<List<Profile>>() {\n-  }.getType();\n-\n-  protected static final Type LIST_MAP_STRING_STRING_TYPE = new TypeToken<List<Map<String, String>>>() {\n-  }.getType();\n-  protected static final Type MAP_STRING_STRING_TYPE = new TypeToken<Map<String, String>>() {\n-  }.getType();\n+  private static final Type BATCH_PROGRAM_RUNS_TYPE = new TypeToken<List<BatchProgramHistory>>() { }.getType();\n+  private static final Type LIST_JSON_OBJECT_TYPE = new TypeToken<List<JsonObject>>() { }.getType();\n+  private static final Type LIST_RUNRECORD_TYPE = new TypeToken<List<RunRecord>>() { }.getType();\n+  private static final Type SET_TRING_TYPE = new TypeToken<Set<String>>() { }.getType();\n+  private static final Type LIST_PROFILE = new TypeToken<List<Profile>>() { }.getType();\n+\n+  protected static final Type LIST_MAP_STRING_STRING_TYPE = new TypeToken<List<Map<String, String>>>() { }.getType();\n+  protected static final Type MAP_STRING_STRING_TYPE = new TypeToken<Map<String, String>>() { }.getType();\n \n   protected static final String NONEXISTENT_NAMESPACE = \"12jr0j90jf3foieoi33\";\n \n   protected static final String TEST_NAMESPACE1 = \"testnamespace1\";\n   protected static final NamespaceMeta TEST_NAMESPACE_META1 = new NamespaceMeta.Builder()\n-      .setName(TEST_NAMESPACE1)\n-      .setDescription(TEST_NAMESPACE1)\n-      .build();\n+    .setName(TEST_NAMESPACE1)\n+    .setDescription(TEST_NAMESPACE1)\n+    .build();\n   protected static final String TEST_NAMESPACE2 = \"testnamespace2\";\n   protected static final NamespaceMeta TEST_NAMESPACE_META2 = new NamespaceMeta.Builder()\n-      .setName(TEST_NAMESPACE2)\n-      .setDescription(TEST_NAMESPACE2)\n-      .build();\n+    .setName(TEST_NAMESPACE2)\n+    .setDescription(TEST_NAMESPACE2)\n+    .build();\n \n   protected static final String VERSION1 = \"1.0.0\";\n   protected static final String VERSION2 = \"2.0.0\";\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkyNDMyNQ==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r377924325", "bodyText": "there's a utility Tasks.waitFor() method that should be used instead of adding retrying versions of these methods.", "author": "albertshau", "createdAt": "2020-02-11T21:57:44Z", "path": "cdap-app-fabric/src/test/java/io/cdap/cdap/internal/app/services/http/AppFabricTestBase.java", "diffHunk": "@@ -364,7 +380,23 @@ protected static HttpResponse doGet(String resource) throws Exception {\n     return doGet(resource, null);\n   }\n \n-  protected static HttpResponse doGet(String resource, @Nullable Map<String, String> headers) throws Exception {\n+  protected static HttpResponse doRetryableGet(String resource, int count) throws Exception {", "originalCommit": "99d5cde6912612787c31820e6ef9612bf88d8c05", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk4MTI5Nw==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r377981297", "bodyText": "Changed existing waitState functions to avoid JSON parse error for 404 (bbecause of which I added this new utility but now it is not needed).", "author": "pandyajay10", "createdAt": "2020-02-12T00:34:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkyNDMyNQ=="}], "type": "inlineReview", "revised_code": {"commit": "d2fbb2550578c5ecadbfda7de4f312360f752d6e", "chunk": "diff --git a/cdap-app-fabric/src/test/java/io/cdap/cdap/internal/app/services/http/AppFabricTestBase.java b/cdap-app-fabric/src/test/java/io/cdap/cdap/internal/app/services/http/AppFabricTestBase.java\nindex f44edab2f83..6a1c200f9a7 100644\n--- a/cdap-app-fabric/src/test/java/io/cdap/cdap/internal/app/services/http/AppFabricTestBase.java\n+++ b/cdap-app-fabric/src/test/java/io/cdap/cdap/internal/app/services/http/AppFabricTestBase.java\n\n@@ -380,23 +364,7 @@ public abstract class AppFabricTestBase {\n     return doGet(resource, null);\n   }\n \n-  protected static HttpResponse doRetryableGet(String resource, int count) throws Exception {\n-    while (true) {\n-      HttpResponse response = doGet(resource, null);\n-      if (response.getResponseCode() == 404) {\n-        // Resource not found. Might not have been created yet. Sleep for 1 second before retry.\n-        Thread.sleep(1000);\n-        count--;\n-        if (count > 0) {\n-          continue;\n-        }\n-      }\n-      return response;\n-    }\n-  }\n-\n-  protected static HttpResponse doGet(String resource, @Nullable Map<String, String> headers)\n-      throws Exception {\n+  protected static HttpResponse doGet(String resource, @Nullable Map<String, String> headers) throws Exception {\n     HttpRequest.Builder builder = HttpRequest.get(getEndPoint(resource).toURL());\n \n     if (headers != null) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk0MTgxMw==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r377941813", "bodyText": "this doesn't make it clear what actually failed, since we get here if either the app could not be deployed or one of the programs couldn't be started. I think it's better to break apart the app deploy and program starting.", "author": "albertshau", "createdAt": "2020-02-11T22:37:50Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java", "diffHunk": "@@ -0,0 +1,141 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.sysapp;\n+\n+import com.google.common.base.Preconditions;\n+import com.google.gson.Gson;\n+import com.google.inject.Inject;\n+import io.cdap.cdap.api.artifact.ArtifactSummary;\n+import io.cdap.cdap.api.dataset.DatasetManagementException;\n+import io.cdap.cdap.api.retry.RetryableException;\n+import io.cdap.cdap.app.program.ProgramDescriptor;\n+import io.cdap.cdap.common.ApplicationNotFoundException;\n+import io.cdap.cdap.common.ConflictException;\n+import io.cdap.cdap.common.InvalidArtifactException;\n+import io.cdap.cdap.common.NotFoundException;\n+import io.cdap.cdap.common.service.Retries;\n+import io.cdap.cdap.common.service.RetryStrategies;\n+import io.cdap.cdap.internal.app.deploy.pipeline.ApplicationWithPrograms;\n+import io.cdap.cdap.internal.app.services.ApplicationLifecycleService;\n+import io.cdap.cdap.internal.app.services.ProgramLifecycleService;\n+import io.cdap.cdap.internal.sysapp.SystemAppStep.Arguments;\n+import io.cdap.cdap.proto.ProgramStatus;\n+import io.cdap.cdap.proto.id.ApplicationId;\n+import io.cdap.cdap.proto.id.KerberosPrincipalId;\n+import io.cdap.cdap.proto.id.ProgramId;\n+import io.cdap.cdap.security.spi.authorization.UnauthorizedException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.Collections;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * Deploys an application with given arguments. Also runs all programs corresponding to the\n+ * application.\n+ */\n+public class SystemAppEnableExecutor {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(SystemAppEnableExecutor.class);\n+  private static final Gson GSON = new Gson();\n+  private final ApplicationLifecycleService appLifecycleService;\n+  private final ProgramLifecycleService programLifecycleService;\n+\n+  @Inject\n+  SystemAppEnableExecutor(ApplicationLifecycleService appLifecycleService,\n+      ProgramLifecycleService programLifecycleService) {\n+    this.appLifecycleService = appLifecycleService;\n+    this.programLifecycleService = programLifecycleService;\n+  }\n+\n+  public void deployAppAndStartPrograms(Arguments arguments) {\n+    try {\n+      // TODO(CDAP-16243): Make deploy app and start programs idempotent to not have transactional issues.\n+      ApplicationWithPrograms appDetail = retryableDeploySystemApp(arguments);\n+      for (ProgramDescriptor program : appDetail.getPrograms()) {\n+        startProgram(program.getProgramId());\n+      }\n+    } catch (Exception ex) {\n+      LOG.error(\"Failed to deploy app {} and start its program with exception {}.\",", "originalCommit": "99d5cde6912612787c31820e6ef9612bf88d8c05", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk5MTMxMA==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r377991310", "bodyText": "Done. Changed logic accordingly.", "author": "pandyajay10", "createdAt": "2020-02-12T01:11:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk0MTgxMw=="}], "type": "inlineReview", "revised_code": {"commit": "d2fbb2550578c5ecadbfda7de4f312360f752d6e", "chunk": "diff --git a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\nindex cf95c868d05..ac061f162a8 100644\n--- a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\n+++ b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\n\n@@ -27,6 +27,8 @@ import io.cdap.cdap.common.ApplicationNotFoundException;\n import io.cdap.cdap.common.ConflictException;\n import io.cdap.cdap.common.InvalidArtifactException;\n import io.cdap.cdap.common.NotFoundException;\n+import io.cdap.cdap.common.logging.LogSamplers;\n+import io.cdap.cdap.common.logging.Loggers;\n import io.cdap.cdap.common.service.Retries;\n import io.cdap.cdap.common.service.RetryStrategies;\n import io.cdap.cdap.internal.app.deploy.pipeline.ApplicationWithPrograms;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk0MjMzMA==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r377942330", "bodyText": "doesn't look like there are any retries if this fails", "author": "albertshau", "createdAt": "2020-02-11T22:38:57Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java", "diffHunk": "@@ -0,0 +1,141 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.sysapp;\n+\n+import com.google.common.base.Preconditions;\n+import com.google.gson.Gson;\n+import com.google.inject.Inject;\n+import io.cdap.cdap.api.artifact.ArtifactSummary;\n+import io.cdap.cdap.api.dataset.DatasetManagementException;\n+import io.cdap.cdap.api.retry.RetryableException;\n+import io.cdap.cdap.app.program.ProgramDescriptor;\n+import io.cdap.cdap.common.ApplicationNotFoundException;\n+import io.cdap.cdap.common.ConflictException;\n+import io.cdap.cdap.common.InvalidArtifactException;\n+import io.cdap.cdap.common.NotFoundException;\n+import io.cdap.cdap.common.service.Retries;\n+import io.cdap.cdap.common.service.RetryStrategies;\n+import io.cdap.cdap.internal.app.deploy.pipeline.ApplicationWithPrograms;\n+import io.cdap.cdap.internal.app.services.ApplicationLifecycleService;\n+import io.cdap.cdap.internal.app.services.ProgramLifecycleService;\n+import io.cdap.cdap.internal.sysapp.SystemAppStep.Arguments;\n+import io.cdap.cdap.proto.ProgramStatus;\n+import io.cdap.cdap.proto.id.ApplicationId;\n+import io.cdap.cdap.proto.id.KerberosPrincipalId;\n+import io.cdap.cdap.proto.id.ProgramId;\n+import io.cdap.cdap.security.spi.authorization.UnauthorizedException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.Collections;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * Deploys an application with given arguments. Also runs all programs corresponding to the\n+ * application.\n+ */\n+public class SystemAppEnableExecutor {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(SystemAppEnableExecutor.class);\n+  private static final Gson GSON = new Gson();\n+  private final ApplicationLifecycleService appLifecycleService;\n+  private final ProgramLifecycleService programLifecycleService;\n+\n+  @Inject\n+  SystemAppEnableExecutor(ApplicationLifecycleService appLifecycleService,\n+      ProgramLifecycleService programLifecycleService) {\n+    this.appLifecycleService = appLifecycleService;\n+    this.programLifecycleService = programLifecycleService;\n+  }\n+\n+  public void deployAppAndStartPrograms(Arguments arguments) {\n+    try {\n+      // TODO(CDAP-16243): Make deploy app and start programs idempotent to not have transactional issues.\n+      ApplicationWithPrograms appDetail = retryableDeploySystemApp(arguments);\n+      for (ProgramDescriptor program : appDetail.getPrograms()) {\n+        startProgram(program.getProgramId());", "originalCommit": "99d5cde6912612787c31820e6ef9612bf88d8c05", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk0Mzk4NQ==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r377943985", "bodyText": "If the program is already running, this will be a no-op. However, this actually isn't the desired behavior if the app changed.\nFor example, if the artifact version is different, after we deploy the app, we need to restart the programs in order for them to pick up the new code. We need to restart the programs if the artifact or config for the app changed.\nOr is this what you were referring to with that idempotent TODO comment?", "author": "albertshau", "createdAt": "2020-02-11T22:42:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk0MjMzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk4ODgwMg==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r377988802", "bodyText": "doesn't look like there are any retries if this fails\n\nNot retrying here as ProgramStarter does not throw retryable exception. I am only retrying for DeployingSystemApp because it throws retryable exception (and we need to wait till metadata sergice is up and running). Following what we did for ProgramStarter Bootstrap step.", "author": "pandyajay10", "createdAt": "2020-02-12T01:01:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk0MjMzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk4OTIxMw==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r377989213", "bodyText": "If the program is already running, this will be a no-op. However, this actually isn't the desired behavior if the app changed.\nFor example, if the artifact version is different, after we deploy the app, we need to restart the programs in order for them to pick up the new code. We need to restart the programs if the artifact or config for the app changed.\nOr is this what you were referring to with that idempotent TODO comment?\n\nYeah. I am planning to work on understanding how to handle those cases from you after this change is in and will start working on it after operator changes are also in.", "author": "pandyajay10", "createdAt": "2020-02-12T01:02:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk0MjMzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQxMjk2Ng==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r378412966", "bodyText": "The caller decides what it wants to retry, not the ProgramLifecycleService. You can define whatever retry logic you want.\nYou should not compare this service to the BootstrapService. They have completely different contracts. The contract here is that CDAP will make system apps match the state declared in the configs. If program start fails for some transient reason, it should be retried in order to fulfill that contract. If it failed in a way that we know it will always fail, then it doesn't need to be retried.", "author": "albertshau", "createdAt": "2020-02-12T17:49:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk0MjMzMA=="}], "type": "inlineReview", "revised_code": {"commit": "d2fbb2550578c5ecadbfda7de4f312360f752d6e", "chunk": "diff --git a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\nindex cf95c868d05..ac061f162a8 100644\n--- a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\n+++ b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\n\n@@ -27,6 +27,8 @@ import io.cdap.cdap.common.ApplicationNotFoundException;\n import io.cdap.cdap.common.ConflictException;\n import io.cdap.cdap.common.InvalidArtifactException;\n import io.cdap.cdap.common.NotFoundException;\n+import io.cdap.cdap.common.logging.LogSamplers;\n+import io.cdap.cdap.common.logging.Loggers;\n import io.cdap.cdap.common.service.Retries;\n import io.cdap.cdap.common.service.RetryStrategies;\n import io.cdap.cdap.internal.app.deploy.pipeline.ApplicationWithPrograms;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk0MjU3MQ==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r377942571", "bodyText": "style: remove newline between javadoc and class", "author": "albertshau", "createdAt": "2020-02-11T22:39:31Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppStep.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.sysapp;\n+\n+import com.google.gson.JsonObject;\n+import com.google.gson.annotations.SerializedName;\n+import io.cdap.cdap.proto.artifact.AppRequest;\n+import io.cdap.cdap.proto.id.ApplicationId;\n+import io.cdap.cdap.proto.id.NamespaceId;\n+\n+/**\n+ * Definition for a single step in a system app config. Defines what operation to perform for a\n+ * system app and any arguments required to perform the operation.\n+ */\n+", "originalCommit": "99d5cde6912612787c31820e6ef9612bf88d8c05", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d2fbb2550578c5ecadbfda7de4f312360f752d6e", "chunk": "diff --git a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppStep.java b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppStep.java\nindex d0454055862..85049ade0d9 100644\n--- a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppStep.java\n+++ b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppStep.java\n\n@@ -17,7 +17,6 @@\n package io.cdap.cdap.internal.sysapp;\n \n import com.google.gson.JsonObject;\n-import com.google.gson.annotations.SerializedName;\n import io.cdap.cdap.proto.artifact.AppRequest;\n import io.cdap.cdap.proto.id.ApplicationId;\n import io.cdap.cdap.proto.id.NamespaceId;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk0NDc5Mg==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r377944792", "bodyText": "It looks like nothing is logged if there are failures deploying the app. We need to log errors if they happen, though we also don't want to flood the logs with error messages if it is failing constantly.\nYou can use the Loggers utility class to create a logger that limits how often it actually logs.", "author": "albertshau", "createdAt": "2020-02-11T22:44:53Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java", "diffHunk": "@@ -0,0 +1,141 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.sysapp;\n+\n+import com.google.common.base.Preconditions;\n+import com.google.gson.Gson;\n+import com.google.inject.Inject;\n+import io.cdap.cdap.api.artifact.ArtifactSummary;\n+import io.cdap.cdap.api.dataset.DatasetManagementException;\n+import io.cdap.cdap.api.retry.RetryableException;\n+import io.cdap.cdap.app.program.ProgramDescriptor;\n+import io.cdap.cdap.common.ApplicationNotFoundException;\n+import io.cdap.cdap.common.ConflictException;\n+import io.cdap.cdap.common.InvalidArtifactException;\n+import io.cdap.cdap.common.NotFoundException;\n+import io.cdap.cdap.common.service.Retries;\n+import io.cdap.cdap.common.service.RetryStrategies;\n+import io.cdap.cdap.internal.app.deploy.pipeline.ApplicationWithPrograms;\n+import io.cdap.cdap.internal.app.services.ApplicationLifecycleService;\n+import io.cdap.cdap.internal.app.services.ProgramLifecycleService;\n+import io.cdap.cdap.internal.sysapp.SystemAppStep.Arguments;\n+import io.cdap.cdap.proto.ProgramStatus;\n+import io.cdap.cdap.proto.id.ApplicationId;\n+import io.cdap.cdap.proto.id.KerberosPrincipalId;\n+import io.cdap.cdap.proto.id.ProgramId;\n+import io.cdap.cdap.security.spi.authorization.UnauthorizedException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.Collections;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * Deploys an application with given arguments. Also runs all programs corresponding to the\n+ * application.\n+ */\n+public class SystemAppEnableExecutor {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(SystemAppEnableExecutor.class);\n+  private static final Gson GSON = new Gson();\n+  private final ApplicationLifecycleService appLifecycleService;\n+  private final ProgramLifecycleService programLifecycleService;\n+\n+  @Inject\n+  SystemAppEnableExecutor(ApplicationLifecycleService appLifecycleService,\n+      ProgramLifecycleService programLifecycleService) {\n+    this.appLifecycleService = appLifecycleService;\n+    this.programLifecycleService = programLifecycleService;\n+  }\n+\n+  public void deployAppAndStartPrograms(Arguments arguments) {\n+    try {\n+      // TODO(CDAP-16243): Make deploy app and start programs idempotent to not have transactional issues.\n+      ApplicationWithPrograms appDetail = retryableDeploySystemApp(arguments);\n+      for (ProgramDescriptor program : appDetail.getPrograms()) {\n+        startProgram(program.getProgramId());\n+      }\n+    } catch (Exception ex) {\n+      LOG.error(\"Failed to deploy app {} and start its program with exception {}.\",\n+          arguments.getId(), ex);\n+\n+    }\n+  }\n+\n+  private ApplicationWithPrograms retryableDeploySystemApp(Arguments arguments) throws Exception {\n+    return Retries.callWithRetries(() -> deploySystemApp(arguments),", "originalCommit": "99d5cde6912612787c31820e6ef9612bf88d8c05", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk5MzE2Nw==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r377993167", "bodyText": "Added logging such that it logs in debug mode if error is retryable exception else it will anyways log in catch below.", "author": "pandyajay10", "createdAt": "2020-02-12T01:18:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk0NDc5Mg=="}], "type": "inlineReview", "revised_code": {"commit": "d2fbb2550578c5ecadbfda7de4f312360f752d6e", "chunk": "diff --git a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\nindex cf95c868d05..ac061f162a8 100644\n--- a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\n+++ b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\n\n@@ -27,6 +27,8 @@ import io.cdap.cdap.common.ApplicationNotFoundException;\n import io.cdap.cdap.common.ConflictException;\n import io.cdap.cdap.common.InvalidArtifactException;\n import io.cdap.cdap.common.NotFoundException;\n+import io.cdap.cdap.common.logging.LogSamplers;\n+import io.cdap.cdap.common.logging.Loggers;\n import io.cdap.cdap.common.service.Retries;\n import io.cdap.cdap.common.service.RetryStrategies;\n import io.cdap.cdap.internal.app.deploy.pipeline.ApplicationWithPrograms;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM2MjQ1OQ==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r378362459", "bodyText": "insert space after 'if'", "author": "albertshau", "createdAt": "2020-02-12T16:24:40Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java", "diffHunk": "@@ -57,48 +57,62 @@\n \n   @Inject\n   SystemAppEnableExecutor(ApplicationLifecycleService appLifecycleService,\n-      ProgramLifecycleService programLifecycleService) {\n+                          ProgramLifecycleService programLifecycleService) {\n     this.appLifecycleService = appLifecycleService;\n     this.programLifecycleService = programLifecycleService;\n   }\n \n   public void deployAppAndStartPrograms(Arguments arguments) {\n-    try {\n-      // TODO(CDAP-16243): Make deploy app and start programs idempotent to not have transactional issues.\n-      ApplicationWithPrograms appDetail = retryableDeploySystemApp(arguments);\n-      for (ProgramDescriptor program : appDetail.getPrograms()) {\n+\n+\n+    // TODO(CDAP-16243): Make deploy app and start programs idempotent to not have transactional issues.\n+    ApplicationWithPrograms appDetail = retryableDeploySystemApp(arguments);\n+    if(appDetail == null) return;", "originalCommit": "25979d7ef8470eef91a97f829682219eba1262d3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQ0NjgxMw==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r378446813", "bodyText": "Don't do one line if. Always do:\nif (appDetail == null) {\n  return;\n}", "author": "chtyim", "createdAt": "2020-02-12T18:54:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM2MjQ1OQ=="}], "type": "inlineReview", "revised_code": {"commit": "d2fbb2550578c5ecadbfda7de4f312360f752d6e", "chunk": "diff --git a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\nindex 55195d8d92f..ac061f162a8 100644\n--- a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\n+++ b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\n\n@@ -51,6 +54,9 @@ import java.util.concurrent.TimeUnit;\n public class SystemAppEnableExecutor {\n \n   private static final Logger LOG = LoggerFactory.getLogger(SystemAppEnableExecutor.class);\n+  private static final Logger LIMITED_LOGGER = Loggers\n+    .sampling(LOG, LogSamplers.limitRate(TimeUnit.SECONDS.toMillis(100)));\n+\n   private static final Gson GSON = new Gson();\n   private final ApplicationLifecycleService appLifecycleService;\n   private final ProgramLifecycleService programLifecycleService;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM2Mjc3MQ==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r378362771", "bodyText": "indentation", "author": "albertshau", "createdAt": "2020-02-12T16:25:11Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java", "diffHunk": "@@ -57,48 +57,62 @@\n \n   @Inject\n   SystemAppEnableExecutor(ApplicationLifecycleService appLifecycleService,\n-      ProgramLifecycleService programLifecycleService) {\n+                          ProgramLifecycleService programLifecycleService) {\n     this.appLifecycleService = appLifecycleService;\n     this.programLifecycleService = programLifecycleService;\n   }\n \n   public void deployAppAndStartPrograms(Arguments arguments) {\n-    try {\n-      // TODO(CDAP-16243): Make deploy app and start programs idempotent to not have transactional issues.\n-      ApplicationWithPrograms appDetail = retryableDeploySystemApp(arguments);\n-      for (ProgramDescriptor program : appDetail.getPrograms()) {\n+\n+\n+    // TODO(CDAP-16243): Make deploy app and start programs idempotent to not have transactional issues.\n+    ApplicationWithPrograms appDetail = retryableDeploySystemApp(arguments);\n+    if(appDetail == null) return;\n+\n+    // TODO(CDAP-16243): Fix logic to restart programs for app with difference version/config.\n+    for (ProgramDescriptor program : appDetail.getPrograms()) {\n+      try {\n         startProgram(program.getProgramId());\n+      } catch (Exception ex) {\n+        LOG.error(\"Failed to start program {} for app {} with exception {}\",\n+          program.getProgramId(), arguments.getId(), ex);\n       }\n-    } catch (Exception ex) {\n-      LOG.error(\"Failed to deploy app {} and start its program with exception {}.\",\n-          arguments.getId(), ex);\n-\n     }\n   }\n \n-  private ApplicationWithPrograms retryableDeploySystemApp(Arguments arguments) throws Exception {\n-    return Retries.callWithRetries(() -> deploySystemApp(arguments),\n-        RetryStrategies.fixDelay(6, TimeUnit.SECONDS));\n+  private ApplicationWithPrograms retryableDeploySystemApp(Arguments arguments) {\n+    try {\n+      return Retries.callWithRetries(() -> {\n+            try {", "originalCommit": "25979d7ef8470eef91a97f829682219eba1262d3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d2fbb2550578c5ecadbfda7de4f312360f752d6e", "chunk": "diff --git a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\nindex 55195d8d92f..ac061f162a8 100644\n--- a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\n+++ b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\n\n@@ -51,6 +54,9 @@ import java.util.concurrent.TimeUnit;\n public class SystemAppEnableExecutor {\n \n   private static final Logger LOG = LoggerFactory.getLogger(SystemAppEnableExecutor.class);\n+  private static final Logger LIMITED_LOGGER = Loggers\n+    .sampling(LOG, LogSamplers.limitRate(TimeUnit.SECONDS.toMillis(100)));\n+\n   private static final Gson GSON = new Gson();\n   private final ApplicationLifecycleService appLifecycleService;\n   private final ProgramLifecycleService programLifecycleService;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM4ODc1Ng==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r378388756", "bodyText": "should not print stack trace like this, it's printed in the log above.", "author": "albertshau", "createdAt": "2020-02-12T17:06:03Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java", "diffHunk": "@@ -57,48 +57,62 @@\n \n   @Inject\n   SystemAppEnableExecutor(ApplicationLifecycleService appLifecycleService,\n-      ProgramLifecycleService programLifecycleService) {\n+                          ProgramLifecycleService programLifecycleService) {\n     this.appLifecycleService = appLifecycleService;\n     this.programLifecycleService = programLifecycleService;\n   }\n \n   public void deployAppAndStartPrograms(Arguments arguments) {\n-    try {\n-      // TODO(CDAP-16243): Make deploy app and start programs idempotent to not have transactional issues.\n-      ApplicationWithPrograms appDetail = retryableDeploySystemApp(arguments);\n-      for (ProgramDescriptor program : appDetail.getPrograms()) {\n+\n+\n+    // TODO(CDAP-16243): Make deploy app and start programs idempotent to not have transactional issues.\n+    ApplicationWithPrograms appDetail = retryableDeploySystemApp(arguments);\n+    if(appDetail == null) return;\n+\n+    // TODO(CDAP-16243): Fix logic to restart programs for app with difference version/config.\n+    for (ProgramDescriptor program : appDetail.getPrograms()) {\n+      try {\n         startProgram(program.getProgramId());\n+      } catch (Exception ex) {\n+        LOG.error(\"Failed to start program {} for app {} with exception {}\",\n+          program.getProgramId(), arguments.getId(), ex);\n       }\n-    } catch (Exception ex) {\n-      LOG.error(\"Failed to deploy app {} and start its program with exception {}.\",\n-          arguments.getId(), ex);\n-\n     }\n   }\n \n-  private ApplicationWithPrograms retryableDeploySystemApp(Arguments arguments) throws Exception {\n-    return Retries.callWithRetries(() -> deploySystemApp(arguments),\n-        RetryStrategies.fixDelay(6, TimeUnit.SECONDS));\n+  private ApplicationWithPrograms retryableDeploySystemApp(Arguments arguments) {\n+    try {\n+      return Retries.callWithRetries(() -> {\n+            try {\n+              return deploySystemApp(arguments);\n+            } catch (RetryableException ex) {\n+              LOG.debug(\"Failed to deploy app {} with exception {}. Will retry\", arguments.getId(), ex);\n+              ex.printStackTrace();", "originalCommit": "25979d7ef8470eef91a97f829682219eba1262d3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d2fbb2550578c5ecadbfda7de4f312360f752d6e", "chunk": "diff --git a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\nindex 55195d8d92f..ac061f162a8 100644\n--- a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\n+++ b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\n\n@@ -51,6 +54,9 @@ import java.util.concurrent.TimeUnit;\n public class SystemAppEnableExecutor {\n \n   private static final Logger LOG = LoggerFactory.getLogger(SystemAppEnableExecutor.class);\n+  private static final Logger LIMITED_LOGGER = Loggers\n+    .sampling(LOG, LogSamplers.limitRate(TimeUnit.SECONDS.toMillis(100)));\n+\n   private static final Gson GSON = new Gson();\n   private final ApplicationLifecycleService appLifecycleService;\n   private final ProgramLifecycleService programLifecycleService;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM4OTQzOA==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r378389438", "bodyText": "this behavior means it don't actually get retried. It will catch the exception then return. You should use the version that takes a Predicate, and log there.", "author": "albertshau", "createdAt": "2020-02-12T17:07:02Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java", "diffHunk": "@@ -57,48 +57,62 @@\n \n   @Inject\n   SystemAppEnableExecutor(ApplicationLifecycleService appLifecycleService,\n-      ProgramLifecycleService programLifecycleService) {\n+                          ProgramLifecycleService programLifecycleService) {\n     this.appLifecycleService = appLifecycleService;\n     this.programLifecycleService = programLifecycleService;\n   }\n \n   public void deployAppAndStartPrograms(Arguments arguments) {\n-    try {\n-      // TODO(CDAP-16243): Make deploy app and start programs idempotent to not have transactional issues.\n-      ApplicationWithPrograms appDetail = retryableDeploySystemApp(arguments);\n-      for (ProgramDescriptor program : appDetail.getPrograms()) {\n+\n+\n+    // TODO(CDAP-16243): Make deploy app and start programs idempotent to not have transactional issues.\n+    ApplicationWithPrograms appDetail = retryableDeploySystemApp(arguments);\n+    if(appDetail == null) return;\n+\n+    // TODO(CDAP-16243): Fix logic to restart programs for app with difference version/config.\n+    for (ProgramDescriptor program : appDetail.getPrograms()) {\n+      try {\n         startProgram(program.getProgramId());\n+      } catch (Exception ex) {\n+        LOG.error(\"Failed to start program {} for app {} with exception {}\",\n+          program.getProgramId(), arguments.getId(), ex);\n       }\n-    } catch (Exception ex) {\n-      LOG.error(\"Failed to deploy app {} and start its program with exception {}.\",\n-          arguments.getId(), ex);\n-\n     }\n   }\n \n-  private ApplicationWithPrograms retryableDeploySystemApp(Arguments arguments) throws Exception {\n-    return Retries.callWithRetries(() -> deploySystemApp(arguments),\n-        RetryStrategies.fixDelay(6, TimeUnit.SECONDS));\n+  private ApplicationWithPrograms retryableDeploySystemApp(Arguments arguments) {\n+    try {\n+      return Retries.callWithRetries(() -> {\n+            try {\n+              return deploySystemApp(arguments);\n+            } catch (RetryableException ex) {\n+              LOG.debug(\"Failed to deploy app {} with exception {}. Will retry\", arguments.getId(), ex);\n+              ex.printStackTrace();\n+            }\n+            return null;", "originalCommit": "25979d7ef8470eef91a97f829682219eba1262d3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d2fbb2550578c5ecadbfda7de4f312360f752d6e", "chunk": "diff --git a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\nindex 55195d8d92f..ac061f162a8 100644\n--- a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\n+++ b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\n\n@@ -51,6 +54,9 @@ import java.util.concurrent.TimeUnit;\n public class SystemAppEnableExecutor {\n \n   private static final Logger LOG = LoggerFactory.getLogger(SystemAppEnableExecutor.class);\n+  private static final Logger LIMITED_LOGGER = Loggers\n+    .sampling(LOG, LogSamplers.limitRate(TimeUnit.SECONDS.toMillis(100)));\n+\n   private static final Gson GSON = new Gson();\n   private final ApplicationLifecycleService appLifecycleService;\n   private final ProgramLifecycleService programLifecycleService;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM5MDM2MA==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r378390360", "bodyText": "it's better to let this exception propagate up and have the caller handler it, rather than log here and return null.", "author": "albertshau", "createdAt": "2020-02-12T17:08:38Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java", "diffHunk": "@@ -57,48 +57,62 @@\n \n   @Inject\n   SystemAppEnableExecutor(ApplicationLifecycleService appLifecycleService,\n-      ProgramLifecycleService programLifecycleService) {\n+                          ProgramLifecycleService programLifecycleService) {\n     this.appLifecycleService = appLifecycleService;\n     this.programLifecycleService = programLifecycleService;\n   }\n \n   public void deployAppAndStartPrograms(Arguments arguments) {\n-    try {\n-      // TODO(CDAP-16243): Make deploy app and start programs idempotent to not have transactional issues.\n-      ApplicationWithPrograms appDetail = retryableDeploySystemApp(arguments);\n-      for (ProgramDescriptor program : appDetail.getPrograms()) {\n+\n+\n+    // TODO(CDAP-16243): Make deploy app and start programs idempotent to not have transactional issues.\n+    ApplicationWithPrograms appDetail = retryableDeploySystemApp(arguments);\n+    if(appDetail == null) return;\n+\n+    // TODO(CDAP-16243): Fix logic to restart programs for app with difference version/config.\n+    for (ProgramDescriptor program : appDetail.getPrograms()) {\n+      try {\n         startProgram(program.getProgramId());\n+      } catch (Exception ex) {\n+        LOG.error(\"Failed to start program {} for app {} with exception {}\",\n+          program.getProgramId(), arguments.getId(), ex);\n       }\n-    } catch (Exception ex) {\n-      LOG.error(\"Failed to deploy app {} and start its program with exception {}.\",\n-          arguments.getId(), ex);\n-\n     }\n   }\n \n-  private ApplicationWithPrograms retryableDeploySystemApp(Arguments arguments) throws Exception {\n-    return Retries.callWithRetries(() -> deploySystemApp(arguments),\n-        RetryStrategies.fixDelay(6, TimeUnit.SECONDS));\n+  private ApplicationWithPrograms retryableDeploySystemApp(Arguments arguments) {\n+    try {\n+      return Retries.callWithRetries(() -> {\n+            try {\n+              return deploySystemApp(arguments);\n+            } catch (RetryableException ex) {\n+              LOG.debug(\"Failed to deploy app {} with exception {}. Will retry\", arguments.getId(), ex);\n+              ex.printStackTrace();\n+            }\n+            return null;\n+          },\n+          RetryStrategies.fixDelay(6, TimeUnit.SECONDS));\n+    } catch (Exception ex) {", "originalCommit": "25979d7ef8470eef91a97f829682219eba1262d3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQ0NzUyNw==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r378447527", "bodyText": "Changed it to throwing the retryable exception.", "author": "pandyajay10", "createdAt": "2020-02-12T18:55:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM5MDM2MA=="}], "type": "inlineReview", "revised_code": {"commit": "d2fbb2550578c5ecadbfda7de4f312360f752d6e", "chunk": "diff --git a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\nindex 55195d8d92f..ac061f162a8 100644\n--- a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\n+++ b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\n\n@@ -51,6 +54,9 @@ import java.util.concurrent.TimeUnit;\n public class SystemAppEnableExecutor {\n \n   private static final Logger LOG = LoggerFactory.getLogger(SystemAppEnableExecutor.class);\n+  private static final Logger LIMITED_LOGGER = Loggers\n+    .sampling(LOG, LogSamplers.limitRate(TimeUnit.SECONDS.toMillis(100)));\n+\n   private static final Gson GSON = new Gson();\n   private final ApplicationLifecycleService appLifecycleService;\n   private final ProgramLifecycleService programLifecycleService;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM5MTM0OA==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r378391348", "bodyText": "indentation", "author": "albertshau", "createdAt": "2020-02-12T17:10:25Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.sysapp;\n+\n+import com.google.common.base.Preconditions;\n+import com.google.gson.Gson;\n+import com.google.inject.Inject;\n+import io.cdap.cdap.api.artifact.ArtifactSummary;\n+import io.cdap.cdap.api.dataset.DatasetManagementException;\n+import io.cdap.cdap.api.retry.RetryableException;\n+import io.cdap.cdap.app.program.ProgramDescriptor;\n+import io.cdap.cdap.common.ApplicationNotFoundException;\n+import io.cdap.cdap.common.ConflictException;\n+import io.cdap.cdap.common.InvalidArtifactException;\n+import io.cdap.cdap.common.NotFoundException;\n+import io.cdap.cdap.common.service.Retries;\n+import io.cdap.cdap.common.service.RetryStrategies;\n+import io.cdap.cdap.internal.app.deploy.pipeline.ApplicationWithPrograms;\n+import io.cdap.cdap.internal.app.services.ApplicationLifecycleService;\n+import io.cdap.cdap.internal.app.services.ProgramLifecycleService;\n+import io.cdap.cdap.internal.sysapp.SystemAppStep.Arguments;\n+import io.cdap.cdap.proto.ProgramStatus;\n+import io.cdap.cdap.proto.id.ApplicationId;\n+import io.cdap.cdap.proto.id.KerberosPrincipalId;\n+import io.cdap.cdap.proto.id.ProgramId;\n+import io.cdap.cdap.security.spi.authorization.UnauthorizedException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.Collections;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * Deploys an application with given arguments. Also runs all programs corresponding to the\n+ * application.\n+ */\n+public class SystemAppEnableExecutor {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(SystemAppEnableExecutor.class);\n+  private static final Gson GSON = new Gson();\n+  private final ApplicationLifecycleService appLifecycleService;\n+  private final ProgramLifecycleService programLifecycleService;\n+\n+  @Inject\n+  SystemAppEnableExecutor(ApplicationLifecycleService appLifecycleService,\n+                          ProgramLifecycleService programLifecycleService) {\n+    this.appLifecycleService = appLifecycleService;\n+    this.programLifecycleService = programLifecycleService;\n+  }\n+\n+  public void deployAppAndStartPrograms(Arguments arguments) {\n+\n+\n+    // TODO(CDAP-16243): Make deploy app and start programs idempotent to not have transactional issues.\n+    ApplicationWithPrograms appDetail = retryableDeploySystemApp(arguments);\n+    if(appDetail == null) return;\n+\n+    // TODO(CDAP-16243): Fix logic to restart programs for app with difference version/config.\n+    for (ProgramDescriptor program : appDetail.getPrograms()) {\n+      try {\n+        startProgram(program.getProgramId());\n+      } catch (Exception ex) {\n+        LOG.error(\"Failed to start program {} for app {} with exception {}\",\n+          program.getProgramId(), arguments.getId(), ex);\n+      }\n+    }\n+  }\n+\n+  private ApplicationWithPrograms retryableDeploySystemApp(Arguments arguments) {\n+    try {\n+      return Retries.callWithRetries(() -> {\n+            try {\n+              return deploySystemApp(arguments);\n+            } catch (RetryableException ex) {\n+              LOG.debug(\"Failed to deploy app {} with exception {}. Will retry\", arguments.getId(), ex);\n+              ex.printStackTrace();\n+            }\n+            return null;\n+          },\n+          RetryStrategies.fixDelay(6, TimeUnit.SECONDS));\n+    } catch (Exception ex) {\n+      LOG.error(\"Failed to deploy app {} with exception {}\",\n+          arguments.getId(), ex);", "originalCommit": "25979d7ef8470eef91a97f829682219eba1262d3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d2fbb2550578c5ecadbfda7de4f312360f752d6e", "chunk": "diff --git a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\nindex 55195d8d92f..ac061f162a8 100644\n--- a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\n+++ b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\n\n@@ -27,6 +27,8 @@ import io.cdap.cdap.common.ApplicationNotFoundException;\n import io.cdap.cdap.common.ConflictException;\n import io.cdap.cdap.common.InvalidArtifactException;\n import io.cdap.cdap.common.NotFoundException;\n+import io.cdap.cdap.common.logging.LogSamplers;\n+import io.cdap.cdap.common.logging.Loggers;\n import io.cdap.cdap.common.service.Retries;\n import io.cdap.cdap.common.service.RetryStrategies;\n import io.cdap.cdap.internal.app.deploy.pipeline.ApplicationWithPrograms;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM5Mjk5Mg==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r378392992", "bodyText": "this is misleading, the caller doesn't set a time limit", "author": "albertshau", "createdAt": "2020-02-12T17:13:17Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.sysapp;\n+\n+import com.google.common.base.Preconditions;\n+import com.google.gson.Gson;\n+import com.google.inject.Inject;\n+import io.cdap.cdap.api.artifact.ArtifactSummary;\n+import io.cdap.cdap.api.dataset.DatasetManagementException;\n+import io.cdap.cdap.api.retry.RetryableException;\n+import io.cdap.cdap.app.program.ProgramDescriptor;\n+import io.cdap.cdap.common.ApplicationNotFoundException;\n+import io.cdap.cdap.common.ConflictException;\n+import io.cdap.cdap.common.InvalidArtifactException;\n+import io.cdap.cdap.common.NotFoundException;\n+import io.cdap.cdap.common.service.Retries;\n+import io.cdap.cdap.common.service.RetryStrategies;\n+import io.cdap.cdap.internal.app.deploy.pipeline.ApplicationWithPrograms;\n+import io.cdap.cdap.internal.app.services.ApplicationLifecycleService;\n+import io.cdap.cdap.internal.app.services.ProgramLifecycleService;\n+import io.cdap.cdap.internal.sysapp.SystemAppStep.Arguments;\n+import io.cdap.cdap.proto.ProgramStatus;\n+import io.cdap.cdap.proto.id.ApplicationId;\n+import io.cdap.cdap.proto.id.KerberosPrincipalId;\n+import io.cdap.cdap.proto.id.ProgramId;\n+import io.cdap.cdap.security.spi.authorization.UnauthorizedException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.Collections;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * Deploys an application with given arguments. Also runs all programs corresponding to the\n+ * application.\n+ */\n+public class SystemAppEnableExecutor {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(SystemAppEnableExecutor.class);\n+  private static final Gson GSON = new Gson();\n+  private final ApplicationLifecycleService appLifecycleService;\n+  private final ProgramLifecycleService programLifecycleService;\n+\n+  @Inject\n+  SystemAppEnableExecutor(ApplicationLifecycleService appLifecycleService,\n+                          ProgramLifecycleService programLifecycleService) {\n+    this.appLifecycleService = appLifecycleService;\n+    this.programLifecycleService = programLifecycleService;\n+  }\n+\n+  public void deployAppAndStartPrograms(Arguments arguments) {\n+\n+\n+    // TODO(CDAP-16243): Make deploy app and start programs idempotent to not have transactional issues.\n+    ApplicationWithPrograms appDetail = retryableDeploySystemApp(arguments);\n+    if(appDetail == null) return;\n+\n+    // TODO(CDAP-16243): Fix logic to restart programs for app with difference version/config.\n+    for (ProgramDescriptor program : appDetail.getPrograms()) {\n+      try {\n+        startProgram(program.getProgramId());\n+      } catch (Exception ex) {\n+        LOG.error(\"Failed to start program {} for app {} with exception {}\",\n+          program.getProgramId(), arguments.getId(), ex);\n+      }\n+    }\n+  }\n+\n+  private ApplicationWithPrograms retryableDeploySystemApp(Arguments arguments) {\n+    try {\n+      return Retries.callWithRetries(() -> {\n+            try {\n+              return deploySystemApp(arguments);\n+            } catch (RetryableException ex) {\n+              LOG.debug(\"Failed to deploy app {} with exception {}. Will retry\", arguments.getId(), ex);\n+              ex.printStackTrace();\n+            }\n+            return null;\n+          },\n+          RetryStrategies.fixDelay(6, TimeUnit.SECONDS));\n+    } catch (Exception ex) {\n+      LOG.error(\"Failed to deploy app {} with exception {}\",\n+          arguments.getId(), ex);\n+      return null;\n+    }\n+  }\n+\n+  private ApplicationWithPrograms deploySystemApp(Arguments arguments) throws Exception {\n+    ApplicationId appId = arguments.getId();\n+    ArtifactSummary artifactSummary = arguments.getArtifact();\n+\n+    KerberosPrincipalId ownerPrincipalId =\n+        arguments.getOwnerPrincipal() == null ? null : new KerberosPrincipalId(arguments.getOwnerPrincipal());\n+\n+    // if we don't null check, it gets serialized to \"null\"\n+    String configString = arguments.getConfig() == null ? null : GSON.toJson(arguments.getConfig());\n+\n+    try {\n+      return appLifecycleService\n+        .deployApp(appId.getParent(), appId.getApplication(), appId.getVersion(),\n+          artifactSummary, configString, x -> { }, ownerPrincipalId, arguments.canUpdateSchedules());\n+    } catch (NotFoundException | UnauthorizedException | InvalidArtifactException e) {\n+      // these exceptions are for sure not retry-able. It's hard to tell if the others are, so we just try retrying", "originalCommit": "25979d7ef8470eef91a97f829682219eba1262d3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQ0ODcyMQ==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r378448721", "bodyText": "Oh ok.. took it from AppStarter Step. Removed the line as it seems pretty self explanatory.", "author": "pandyajay10", "createdAt": "2020-02-12T18:57:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM5Mjk5Mg=="}], "type": "inlineReview", "revised_code": {"commit": "d2fbb2550578c5ecadbfda7de4f312360f752d6e", "chunk": "diff --git a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\nindex 55195d8d92f..ac061f162a8 100644\n--- a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\n+++ b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\n\n@@ -27,6 +27,8 @@ import io.cdap.cdap.common.ApplicationNotFoundException;\n import io.cdap.cdap.common.ConflictException;\n import io.cdap.cdap.common.InvalidArtifactException;\n import io.cdap.cdap.common.NotFoundException;\n+import io.cdap.cdap.common.logging.LogSamplers;\n+import io.cdap.cdap.common.logging.Loggers;\n import io.cdap.cdap.common.service.Retries;\n import io.cdap.cdap.common.service.RetryStrategies;\n import io.cdap.cdap.internal.app.deploy.pipeline.ApplicationWithPrograms;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM5MzgzNQ==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r378393835", "bodyText": "don't need 'with exception {}'. Passing the last argument as an exception will tell the logger to log the stack trace, you don't need to include a placeholder for it in the message.", "author": "albertshau", "createdAt": "2020-02-12T17:14:45Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.sysapp;\n+\n+import com.google.common.base.Preconditions;\n+import com.google.gson.Gson;\n+import com.google.inject.Inject;\n+import io.cdap.cdap.api.artifact.ArtifactSummary;\n+import io.cdap.cdap.api.dataset.DatasetManagementException;\n+import io.cdap.cdap.api.retry.RetryableException;\n+import io.cdap.cdap.app.program.ProgramDescriptor;\n+import io.cdap.cdap.common.ApplicationNotFoundException;\n+import io.cdap.cdap.common.ConflictException;\n+import io.cdap.cdap.common.InvalidArtifactException;\n+import io.cdap.cdap.common.NotFoundException;\n+import io.cdap.cdap.common.service.Retries;\n+import io.cdap.cdap.common.service.RetryStrategies;\n+import io.cdap.cdap.internal.app.deploy.pipeline.ApplicationWithPrograms;\n+import io.cdap.cdap.internal.app.services.ApplicationLifecycleService;\n+import io.cdap.cdap.internal.app.services.ProgramLifecycleService;\n+import io.cdap.cdap.internal.sysapp.SystemAppStep.Arguments;\n+import io.cdap.cdap.proto.ProgramStatus;\n+import io.cdap.cdap.proto.id.ApplicationId;\n+import io.cdap.cdap.proto.id.KerberosPrincipalId;\n+import io.cdap.cdap.proto.id.ProgramId;\n+import io.cdap.cdap.security.spi.authorization.UnauthorizedException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.Collections;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * Deploys an application with given arguments. Also runs all programs corresponding to the\n+ * application.\n+ */\n+public class SystemAppEnableExecutor {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(SystemAppEnableExecutor.class);\n+  private static final Gson GSON = new Gson();\n+  private final ApplicationLifecycleService appLifecycleService;\n+  private final ProgramLifecycleService programLifecycleService;\n+\n+  @Inject\n+  SystemAppEnableExecutor(ApplicationLifecycleService appLifecycleService,\n+                          ProgramLifecycleService programLifecycleService) {\n+    this.appLifecycleService = appLifecycleService;\n+    this.programLifecycleService = programLifecycleService;\n+  }\n+\n+  public void deployAppAndStartPrograms(Arguments arguments) {\n+\n+\n+    // TODO(CDAP-16243): Make deploy app and start programs idempotent to not have transactional issues.\n+    ApplicationWithPrograms appDetail = retryableDeploySystemApp(arguments);\n+    if(appDetail == null) return;\n+\n+    // TODO(CDAP-16243): Fix logic to restart programs for app with difference version/config.\n+    for (ProgramDescriptor program : appDetail.getPrograms()) {\n+      try {\n+        startProgram(program.getProgramId());\n+      } catch (Exception ex) {\n+        LOG.error(\"Failed to start program {} for app {} with exception {}\",\n+          program.getProgramId(), arguments.getId(), ex);\n+      }\n+    }\n+  }\n+\n+  private ApplicationWithPrograms retryableDeploySystemApp(Arguments arguments) {\n+    try {\n+      return Retries.callWithRetries(() -> {\n+            try {\n+              return deploySystemApp(arguments);\n+            } catch (RetryableException ex) {\n+              LOG.debug(\"Failed to deploy app {} with exception {}. Will retry\", arguments.getId(), ex);\n+              ex.printStackTrace();\n+            }\n+            return null;\n+          },\n+          RetryStrategies.fixDelay(6, TimeUnit.SECONDS));\n+    } catch (Exception ex) {\n+      LOG.error(\"Failed to deploy app {} with exception {}\",", "originalCommit": "25979d7ef8470eef91a97f829682219eba1262d3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d2fbb2550578c5ecadbfda7de4f312360f752d6e", "chunk": "diff --git a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\nindex 55195d8d92f..ac061f162a8 100644\n--- a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\n+++ b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\n\n@@ -27,6 +27,8 @@ import io.cdap.cdap.common.ApplicationNotFoundException;\n import io.cdap.cdap.common.ConflictException;\n import io.cdap.cdap.common.InvalidArtifactException;\n import io.cdap.cdap.common.NotFoundException;\n+import io.cdap.cdap.common.logging.LogSamplers;\n+import io.cdap.cdap.common.logging.Loggers;\n import io.cdap.cdap.common.service.Retries;\n import io.cdap.cdap.common.service.RetryStrategies;\n import io.cdap.cdap.internal.app.deploy.pipeline.ApplicationWithPrograms;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM5NTE5Mg==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r378395192", "bodyText": "this shouldn't be a debug log, it's pretty important to know that there is some problem with the system apps. I think it's better as a warning, with some limit to how often it is logged (see Loggers.sampling).", "author": "albertshau", "createdAt": "2020-02-12T17:16:59Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.sysapp;\n+\n+import com.google.common.base.Preconditions;\n+import com.google.gson.Gson;\n+import com.google.inject.Inject;\n+import io.cdap.cdap.api.artifact.ArtifactSummary;\n+import io.cdap.cdap.api.dataset.DatasetManagementException;\n+import io.cdap.cdap.api.retry.RetryableException;\n+import io.cdap.cdap.app.program.ProgramDescriptor;\n+import io.cdap.cdap.common.ApplicationNotFoundException;\n+import io.cdap.cdap.common.ConflictException;\n+import io.cdap.cdap.common.InvalidArtifactException;\n+import io.cdap.cdap.common.NotFoundException;\n+import io.cdap.cdap.common.service.Retries;\n+import io.cdap.cdap.common.service.RetryStrategies;\n+import io.cdap.cdap.internal.app.deploy.pipeline.ApplicationWithPrograms;\n+import io.cdap.cdap.internal.app.services.ApplicationLifecycleService;\n+import io.cdap.cdap.internal.app.services.ProgramLifecycleService;\n+import io.cdap.cdap.internal.sysapp.SystemAppStep.Arguments;\n+import io.cdap.cdap.proto.ProgramStatus;\n+import io.cdap.cdap.proto.id.ApplicationId;\n+import io.cdap.cdap.proto.id.KerberosPrincipalId;\n+import io.cdap.cdap.proto.id.ProgramId;\n+import io.cdap.cdap.security.spi.authorization.UnauthorizedException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.Collections;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * Deploys an application with given arguments. Also runs all programs corresponding to the\n+ * application.\n+ */\n+public class SystemAppEnableExecutor {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(SystemAppEnableExecutor.class);\n+  private static final Gson GSON = new Gson();\n+  private final ApplicationLifecycleService appLifecycleService;\n+  private final ProgramLifecycleService programLifecycleService;\n+\n+  @Inject\n+  SystemAppEnableExecutor(ApplicationLifecycleService appLifecycleService,\n+                          ProgramLifecycleService programLifecycleService) {\n+    this.appLifecycleService = appLifecycleService;\n+    this.programLifecycleService = programLifecycleService;\n+  }\n+\n+  public void deployAppAndStartPrograms(Arguments arguments) {\n+\n+\n+    // TODO(CDAP-16243): Make deploy app and start programs idempotent to not have transactional issues.\n+    ApplicationWithPrograms appDetail = retryableDeploySystemApp(arguments);\n+    if(appDetail == null) return;\n+\n+    // TODO(CDAP-16243): Fix logic to restart programs for app with difference version/config.\n+    for (ProgramDescriptor program : appDetail.getPrograms()) {\n+      try {\n+        startProgram(program.getProgramId());\n+      } catch (Exception ex) {\n+        LOG.error(\"Failed to start program {} for app {} with exception {}\",\n+          program.getProgramId(), arguments.getId(), ex);\n+      }\n+    }\n+  }\n+\n+  private ApplicationWithPrograms retryableDeploySystemApp(Arguments arguments) {\n+    try {\n+      return Retries.callWithRetries(() -> {\n+            try {\n+              return deploySystemApp(arguments);\n+            } catch (RetryableException ex) {\n+              LOG.debug(\"Failed to deploy app {} with exception {}. Will retry\", arguments.getId(), ex);", "originalCommit": "25979d7ef8470eef91a97f829682219eba1262d3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d2fbb2550578c5ecadbfda7de4f312360f752d6e", "chunk": "diff --git a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\nindex 55195d8d92f..ac061f162a8 100644\n--- a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\n+++ b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\n\n@@ -27,6 +27,8 @@ import io.cdap.cdap.common.ApplicationNotFoundException;\n import io.cdap.cdap.common.ConflictException;\n import io.cdap.cdap.common.InvalidArtifactException;\n import io.cdap.cdap.common.NotFoundException;\n+import io.cdap.cdap.common.logging.LogSamplers;\n+import io.cdap.cdap.common.logging.Loggers;\n import io.cdap.cdap.common.service.Retries;\n import io.cdap.cdap.common.service.RetryStrategies;\n import io.cdap.cdap.internal.app.deploy.pipeline.ApplicationWithPrograms;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM5NjAzMg==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r378396032", "bodyText": "this is an extra I/O and is not needed. It will always exist unless the user happens to delete it in the middle of this call. And even then, it would be handled below, through the NotFoundException.", "author": "albertshau", "createdAt": "2020-02-12T17:18:28Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.sysapp;\n+\n+import com.google.common.base.Preconditions;\n+import com.google.gson.Gson;\n+import com.google.inject.Inject;\n+import io.cdap.cdap.api.artifact.ArtifactSummary;\n+import io.cdap.cdap.api.dataset.DatasetManagementException;\n+import io.cdap.cdap.api.retry.RetryableException;\n+import io.cdap.cdap.app.program.ProgramDescriptor;\n+import io.cdap.cdap.common.ApplicationNotFoundException;\n+import io.cdap.cdap.common.ConflictException;\n+import io.cdap.cdap.common.InvalidArtifactException;\n+import io.cdap.cdap.common.NotFoundException;\n+import io.cdap.cdap.common.service.Retries;\n+import io.cdap.cdap.common.service.RetryStrategies;\n+import io.cdap.cdap.internal.app.deploy.pipeline.ApplicationWithPrograms;\n+import io.cdap.cdap.internal.app.services.ApplicationLifecycleService;\n+import io.cdap.cdap.internal.app.services.ProgramLifecycleService;\n+import io.cdap.cdap.internal.sysapp.SystemAppStep.Arguments;\n+import io.cdap.cdap.proto.ProgramStatus;\n+import io.cdap.cdap.proto.id.ApplicationId;\n+import io.cdap.cdap.proto.id.KerberosPrincipalId;\n+import io.cdap.cdap.proto.id.ProgramId;\n+import io.cdap.cdap.security.spi.authorization.UnauthorizedException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.Collections;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * Deploys an application with given arguments. Also runs all programs corresponding to the\n+ * application.\n+ */\n+public class SystemAppEnableExecutor {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(SystemAppEnableExecutor.class);\n+  private static final Gson GSON = new Gson();\n+  private final ApplicationLifecycleService appLifecycleService;\n+  private final ProgramLifecycleService programLifecycleService;\n+\n+  @Inject\n+  SystemAppEnableExecutor(ApplicationLifecycleService appLifecycleService,\n+                          ProgramLifecycleService programLifecycleService) {\n+    this.appLifecycleService = appLifecycleService;\n+    this.programLifecycleService = programLifecycleService;\n+  }\n+\n+  public void deployAppAndStartPrograms(Arguments arguments) {\n+\n+\n+    // TODO(CDAP-16243): Make deploy app and start programs idempotent to not have transactional issues.\n+    ApplicationWithPrograms appDetail = retryableDeploySystemApp(arguments);\n+    if(appDetail == null) return;\n+\n+    // TODO(CDAP-16243): Fix logic to restart programs for app with difference version/config.\n+    for (ProgramDescriptor program : appDetail.getPrograms()) {\n+      try {\n+        startProgram(program.getProgramId());\n+      } catch (Exception ex) {\n+        LOG.error(\"Failed to start program {} for app {} with exception {}\",\n+          program.getProgramId(), arguments.getId(), ex);\n+      }\n+    }\n+  }\n+\n+  private ApplicationWithPrograms retryableDeploySystemApp(Arguments arguments) {\n+    try {\n+      return Retries.callWithRetries(() -> {\n+            try {\n+              return deploySystemApp(arguments);\n+            } catch (RetryableException ex) {\n+              LOG.debug(\"Failed to deploy app {} with exception {}. Will retry\", arguments.getId(), ex);\n+              ex.printStackTrace();\n+            }\n+            return null;\n+          },\n+          RetryStrategies.fixDelay(6, TimeUnit.SECONDS));\n+    } catch (Exception ex) {\n+      LOG.error(\"Failed to deploy app {} with exception {}\",\n+          arguments.getId(), ex);\n+      return null;\n+    }\n+  }\n+\n+  private ApplicationWithPrograms deploySystemApp(Arguments arguments) throws Exception {\n+    ApplicationId appId = arguments.getId();\n+    ArtifactSummary artifactSummary = arguments.getArtifact();\n+\n+    KerberosPrincipalId ownerPrincipalId =\n+        arguments.getOwnerPrincipal() == null ? null : new KerberosPrincipalId(arguments.getOwnerPrincipal());\n+\n+    // if we don't null check, it gets serialized to \"null\"\n+    String configString = arguments.getConfig() == null ? null : GSON.toJson(arguments.getConfig());\n+\n+    try {\n+      return appLifecycleService\n+        .deployApp(appId.getParent(), appId.getApplication(), appId.getVersion(),\n+          artifactSummary, configString, x -> { }, ownerPrincipalId, arguments.canUpdateSchedules());\n+    } catch (NotFoundException | UnauthorizedException | InvalidArtifactException e) {\n+      // these exceptions are for sure not retry-able. It's hard to tell if the others are, so we just try retrying\n+      // up to the default time limit\n+      throw e;\n+    } catch (DatasetManagementException e) {\n+      if (e.getCause() instanceof UnauthorizedException) {\n+        throw (UnauthorizedException) e.getCause();\n+      } else {\n+        throw new RetryableException(e);\n+      }\n+    } catch (Exception e) {\n+      throw new RetryableException(e);\n+    }\n+  }\n+\n+  private void startProgram(ProgramId programId) throws Exception {\n+    Preconditions.checkArgument(programLifecycleService.getProgramSpecification(programId) != null,", "originalCommit": "25979d7ef8470eef91a97f829682219eba1262d3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d2fbb2550578c5ecadbfda7de4f312360f752d6e", "chunk": "diff --git a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\nindex 55195d8d92f..ac061f162a8 100644\n--- a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\n+++ b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\n\n@@ -27,6 +27,8 @@ import io.cdap.cdap.common.ApplicationNotFoundException;\n import io.cdap.cdap.common.ConflictException;\n import io.cdap.cdap.common.InvalidArtifactException;\n import io.cdap.cdap.common.NotFoundException;\n+import io.cdap.cdap.common.logging.LogSamplers;\n+import io.cdap.cdap.common.logging.Loggers;\n import io.cdap.cdap.common.service.Retries;\n import io.cdap.cdap.common.service.RetryStrategies;\n import io.cdap.cdap.internal.app.deploy.pipeline.ApplicationWithPrograms;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM5Njc1OA==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r378396758", "bodyText": "please insert a TODO to make this restart the program if the application was changed.", "author": "albertshau", "createdAt": "2020-02-12T17:19:51Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.sysapp;\n+\n+import com.google.common.base.Preconditions;\n+import com.google.gson.Gson;\n+import com.google.inject.Inject;\n+import io.cdap.cdap.api.artifact.ArtifactSummary;\n+import io.cdap.cdap.api.dataset.DatasetManagementException;\n+import io.cdap.cdap.api.retry.RetryableException;\n+import io.cdap.cdap.app.program.ProgramDescriptor;\n+import io.cdap.cdap.common.ApplicationNotFoundException;\n+import io.cdap.cdap.common.ConflictException;\n+import io.cdap.cdap.common.InvalidArtifactException;\n+import io.cdap.cdap.common.NotFoundException;\n+import io.cdap.cdap.common.service.Retries;\n+import io.cdap.cdap.common.service.RetryStrategies;\n+import io.cdap.cdap.internal.app.deploy.pipeline.ApplicationWithPrograms;\n+import io.cdap.cdap.internal.app.services.ApplicationLifecycleService;\n+import io.cdap.cdap.internal.app.services.ProgramLifecycleService;\n+import io.cdap.cdap.internal.sysapp.SystemAppStep.Arguments;\n+import io.cdap.cdap.proto.ProgramStatus;\n+import io.cdap.cdap.proto.id.ApplicationId;\n+import io.cdap.cdap.proto.id.KerberosPrincipalId;\n+import io.cdap.cdap.proto.id.ProgramId;\n+import io.cdap.cdap.security.spi.authorization.UnauthorizedException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.Collections;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * Deploys an application with given arguments. Also runs all programs corresponding to the\n+ * application.\n+ */\n+public class SystemAppEnableExecutor {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(SystemAppEnableExecutor.class);\n+  private static final Gson GSON = new Gson();\n+  private final ApplicationLifecycleService appLifecycleService;\n+  private final ProgramLifecycleService programLifecycleService;\n+\n+  @Inject\n+  SystemAppEnableExecutor(ApplicationLifecycleService appLifecycleService,\n+                          ProgramLifecycleService programLifecycleService) {\n+    this.appLifecycleService = appLifecycleService;\n+    this.programLifecycleService = programLifecycleService;\n+  }\n+\n+  public void deployAppAndStartPrograms(Arguments arguments) {\n+\n+\n+    // TODO(CDAP-16243): Make deploy app and start programs idempotent to not have transactional issues.\n+    ApplicationWithPrograms appDetail = retryableDeploySystemApp(arguments);\n+    if(appDetail == null) return;\n+\n+    // TODO(CDAP-16243): Fix logic to restart programs for app with difference version/config.\n+    for (ProgramDescriptor program : appDetail.getPrograms()) {\n+      try {\n+        startProgram(program.getProgramId());\n+      } catch (Exception ex) {\n+        LOG.error(\"Failed to start program {} for app {} with exception {}\",\n+          program.getProgramId(), arguments.getId(), ex);\n+      }\n+    }\n+  }\n+\n+  private ApplicationWithPrograms retryableDeploySystemApp(Arguments arguments) {\n+    try {\n+      return Retries.callWithRetries(() -> {\n+            try {\n+              return deploySystemApp(arguments);\n+            } catch (RetryableException ex) {\n+              LOG.debug(\"Failed to deploy app {} with exception {}. Will retry\", arguments.getId(), ex);\n+              ex.printStackTrace();\n+            }\n+            return null;\n+          },\n+          RetryStrategies.fixDelay(6, TimeUnit.SECONDS));\n+    } catch (Exception ex) {\n+      LOG.error(\"Failed to deploy app {} with exception {}\",\n+          arguments.getId(), ex);\n+      return null;\n+    }\n+  }\n+\n+  private ApplicationWithPrograms deploySystemApp(Arguments arguments) throws Exception {\n+    ApplicationId appId = arguments.getId();\n+    ArtifactSummary artifactSummary = arguments.getArtifact();\n+\n+    KerberosPrincipalId ownerPrincipalId =\n+        arguments.getOwnerPrincipal() == null ? null : new KerberosPrincipalId(arguments.getOwnerPrincipal());\n+\n+    // if we don't null check, it gets serialized to \"null\"\n+    String configString = arguments.getConfig() == null ? null : GSON.toJson(arguments.getConfig());\n+\n+    try {\n+      return appLifecycleService\n+        .deployApp(appId.getParent(), appId.getApplication(), appId.getVersion(),\n+          artifactSummary, configString, x -> { }, ownerPrincipalId, arguments.canUpdateSchedules());\n+    } catch (NotFoundException | UnauthorizedException | InvalidArtifactException e) {\n+      // these exceptions are for sure not retry-able. It's hard to tell if the others are, so we just try retrying\n+      // up to the default time limit\n+      throw e;\n+    } catch (DatasetManagementException e) {\n+      if (e.getCause() instanceof UnauthorizedException) {\n+        throw (UnauthorizedException) e.getCause();\n+      } else {\n+        throw new RetryableException(e);\n+      }\n+    } catch (Exception e) {\n+      throw new RetryableException(e);\n+    }\n+  }\n+\n+  private void startProgram(ProgramId programId) throws Exception {\n+    Preconditions.checkArgument(programLifecycleService.getProgramSpecification(programId) != null,\n+        \"Cannot start %s because it does not exist.\", programId);\n+\n+    try {\n+      // do nothing if the program is already running", "originalCommit": "25979d7ef8470eef91a97f829682219eba1262d3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQ1MTE2Nw==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r378451167", "bodyText": "Had added similar TODO above but also added here to keep track of it.", "author": "pandyajay10", "createdAt": "2020-02-12T19:02:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM5Njc1OA=="}], "type": "inlineReview", "revised_code": {"commit": "d2fbb2550578c5ecadbfda7de4f312360f752d6e", "chunk": "diff --git a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\nindex 55195d8d92f..ac061f162a8 100644\n--- a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\n+++ b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\n\n@@ -27,6 +27,8 @@ import io.cdap.cdap.common.ApplicationNotFoundException;\n import io.cdap.cdap.common.ConflictException;\n import io.cdap.cdap.common.InvalidArtifactException;\n import io.cdap.cdap.common.NotFoundException;\n+import io.cdap.cdap.common.logging.LogSamplers;\n+import io.cdap.cdap.common.logging.Loggers;\n import io.cdap.cdap.common.service.Retries;\n import io.cdap.cdap.common.service.RetryStrategies;\n import io.cdap.cdap.internal.app.deploy.pipeline.ApplicationWithPrograms;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM5Njk1MQ==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r378396951", "bodyText": "indentation", "author": "albertshau", "createdAt": "2020-02-12T17:20:09Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.sysapp;\n+\n+import com.google.common.util.concurrent.AbstractIdleService;\n+import com.google.gson.Gson;\n+import com.google.gson.JsonParseException;\n+import com.google.inject.Inject;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.internal.app.services.ApplicationLifecycleService;\n+import io.cdap.cdap.internal.app.services.ProgramLifecycleService;\n+import org.apache.twill.common.Threads;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.File;\n+import java.io.FileNotFoundException;\n+import java.io.FileReader;\n+import java.io.IOException;\n+import java.io.Reader;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+\n+/**\n+ * Enables system apps using system app config files located in SYSTEM_APP_CONFIG_DIR. Each config\n+ * describes steps to perform to start one (or more) system app. Currently\n+ * SystemAppManagementService runs during bootstrap phase.\n+ */\n+public class SystemAppManagementService extends AbstractIdleService {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(SystemAppManagementService.class);\n+  private static final Gson GSON = new Gson();\n+\n+  private final File systemAppConfigDirPath;\n+  private final SystemAppEnableExecutor systemAppEnableExecutor;\n+  private ExecutorService executorService;\n+\n+  @Inject\n+  SystemAppManagementService(CConfiguration cConf, ApplicationLifecycleService appLifecycleService,\n+                             ProgramLifecycleService programLifecycleService) {\n+    this.systemAppConfigDirPath = new File(cConf.get(Constants.SYSTEM_APP_CONFIG_DIR));\n+    this.systemAppEnableExecutor = new SystemAppEnableExecutor(appLifecycleService,\n+        programLifecycleService);\n+  }\n+\n+  @Override\n+  protected void startUp() {\n+    LOG.debug(\"Starting {}\", getClass().getSimpleName());\n+    executorService = Executors\n+        .newSingleThreadExecutor(Threads.createDaemonThreadFactory(\"sys-app-management-service\"));", "originalCommit": "25979d7ef8470eef91a97f829682219eba1262d3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d2fbb2550578c5ecadbfda7de4f312360f752d6e", "chunk": "diff --git a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java\nindex fd12be1bbd1..96e49d500a4 100644\n--- a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java\n+++ b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java\n\n@@ -22,6 +22,7 @@ import com.google.gson.JsonParseException;\n import com.google.inject.Inject;\n import io.cdap.cdap.common.conf.CConfiguration;\n import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.utils.DirUtils;\n import io.cdap.cdap.internal.app.services.ApplicationLifecycleService;\n import io.cdap.cdap.internal.app.services.ProgramLifecycleService;\n import org.apache.twill.common.Threads;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM5Njk3Mg==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r378396972", "bodyText": "indentation", "author": "albertshau", "createdAt": "2020-02-12T17:20:11Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.sysapp;\n+\n+import com.google.common.util.concurrent.AbstractIdleService;\n+import com.google.gson.Gson;\n+import com.google.gson.JsonParseException;\n+import com.google.inject.Inject;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.internal.app.services.ApplicationLifecycleService;\n+import io.cdap.cdap.internal.app.services.ProgramLifecycleService;\n+import org.apache.twill.common.Threads;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.File;\n+import java.io.FileNotFoundException;\n+import java.io.FileReader;\n+import java.io.IOException;\n+import java.io.Reader;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+\n+/**\n+ * Enables system apps using system app config files located in SYSTEM_APP_CONFIG_DIR. Each config\n+ * describes steps to perform to start one (or more) system app. Currently\n+ * SystemAppManagementService runs during bootstrap phase.\n+ */\n+public class SystemAppManagementService extends AbstractIdleService {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(SystemAppManagementService.class);\n+  private static final Gson GSON = new Gson();\n+\n+  private final File systemAppConfigDirPath;\n+  private final SystemAppEnableExecutor systemAppEnableExecutor;\n+  private ExecutorService executorService;\n+\n+  @Inject\n+  SystemAppManagementService(CConfiguration cConf, ApplicationLifecycleService appLifecycleService,\n+                             ProgramLifecycleService programLifecycleService) {\n+    this.systemAppConfigDirPath = new File(cConf.get(Constants.SYSTEM_APP_CONFIG_DIR));\n+    this.systemAppEnableExecutor = new SystemAppEnableExecutor(appLifecycleService,\n+        programLifecycleService);", "originalCommit": "25979d7ef8470eef91a97f829682219eba1262d3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d2fbb2550578c5ecadbfda7de4f312360f752d6e", "chunk": "diff --git a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java\nindex fd12be1bbd1..96e49d500a4 100644\n--- a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java\n+++ b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java\n\n@@ -22,6 +22,7 @@ import com.google.gson.JsonParseException;\n import com.google.inject.Inject;\n import io.cdap.cdap.common.conf.CConfiguration;\n import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.utils.DirUtils;\n import io.cdap.cdap.internal.app.services.ApplicationLifecycleService;\n import io.cdap.cdap.internal.app.services.ProgramLifecycleService;\n import org.apache.twill.common.Threads;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM5NzQ2Nw==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r378397467", "bodyText": "indentation", "author": "albertshau", "createdAt": "2020-02-12T17:20:59Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.sysapp;\n+\n+import com.google.common.util.concurrent.AbstractIdleService;\n+import com.google.gson.Gson;\n+import com.google.gson.JsonParseException;\n+import com.google.inject.Inject;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.internal.app.services.ApplicationLifecycleService;\n+import io.cdap.cdap.internal.app.services.ProgramLifecycleService;\n+import org.apache.twill.common.Threads;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.File;\n+import java.io.FileNotFoundException;\n+import java.io.FileReader;\n+import java.io.IOException;\n+import java.io.Reader;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+\n+/**\n+ * Enables system apps using system app config files located in SYSTEM_APP_CONFIG_DIR. Each config\n+ * describes steps to perform to start one (or more) system app. Currently\n+ * SystemAppManagementService runs during bootstrap phase.\n+ */\n+public class SystemAppManagementService extends AbstractIdleService {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(SystemAppManagementService.class);\n+  private static final Gson GSON = new Gson();\n+\n+  private final File systemAppConfigDirPath;\n+  private final SystemAppEnableExecutor systemAppEnableExecutor;\n+  private ExecutorService executorService;\n+\n+  @Inject\n+  SystemAppManagementService(CConfiguration cConf, ApplicationLifecycleService appLifecycleService,\n+                             ProgramLifecycleService programLifecycleService) {\n+    this.systemAppConfigDirPath = new File(cConf.get(Constants.SYSTEM_APP_CONFIG_DIR));\n+    this.systemAppEnableExecutor = new SystemAppEnableExecutor(appLifecycleService,\n+        programLifecycleService);\n+  }\n+\n+  @Override\n+  protected void startUp() {\n+    LOG.debug(\"Starting {}\", getClass().getSimpleName());\n+    executorService = Executors\n+        .newSingleThreadExecutor(Threads.createDaemonThreadFactory(\"sys-app-management-service\"));\n+    executorService.execute(() -> {\n+      try {\n+        // Execute all steps for each config file in system config directory.\n+        bootStrapSystemAppConfigDir();\n+      } catch (Exception ex) {\n+        LOG.error(\"Got exception in watch service for system app config dir\", ex);\n+      }\n+    });\n+  }\n+\n+  private void bootStrapSystemAppConfigDir() throws Exception {\n+    LOG.debug(\"Number of config files {} in system app config directory.\",\n+        systemAppConfigDirPath.listFiles().length);\n+\n+    for (File sysAppConfigFile : systemAppConfigDirPath.listFiles()) {\n+      LOG.debug(\"Running steps in config file {}\", sysAppConfigFile.getAbsoluteFile());\n+      executeSysConfig(sysAppConfigFile.getAbsoluteFile());\n+    }\n+  }\n+\n+  private void executeSysConfig(File fileName) throws Exception {\n+    SystemAppConfig config = parseConfig(fileName);\n+    for (SystemAppStep step : config.getSteps()) {\n+      try {\n+        step.validate();\n+      } catch (IllegalArgumentException e) {\n+        LOG.warn(\"Config step {} failed because it is malformed: {}\", step.getLabel(),\n+            e.getMessage());", "originalCommit": "25979d7ef8470eef91a97f829682219eba1262d3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d2fbb2550578c5ecadbfda7de4f312360f752d6e", "chunk": "diff --git a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java\nindex fd12be1bbd1..96e49d500a4 100644\n--- a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java\n+++ b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java\n\n@@ -22,6 +22,7 @@ import com.google.gson.JsonParseException;\n import com.google.inject.Inject;\n import io.cdap.cdap.common.conf.CConfiguration;\n import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.utils.DirUtils;\n import io.cdap.cdap.internal.app.services.ApplicationLifecycleService;\n import io.cdap.cdap.internal.app.services.ProgramLifecycleService;\n import org.apache.twill.common.Threads;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM5ODEzMA==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r378398130", "bodyText": "indentation", "author": "albertshau", "createdAt": "2020-02-12T17:22:07Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.sysapp;\n+\n+import com.google.common.util.concurrent.AbstractIdleService;\n+import com.google.gson.Gson;\n+import com.google.gson.JsonParseException;\n+import com.google.inject.Inject;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.internal.app.services.ApplicationLifecycleService;\n+import io.cdap.cdap.internal.app.services.ProgramLifecycleService;\n+import org.apache.twill.common.Threads;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.File;\n+import java.io.FileNotFoundException;\n+import java.io.FileReader;\n+import java.io.IOException;\n+import java.io.Reader;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+\n+/**\n+ * Enables system apps using system app config files located in SYSTEM_APP_CONFIG_DIR. Each config\n+ * describes steps to perform to start one (or more) system app. Currently\n+ * SystemAppManagementService runs during bootstrap phase.\n+ */\n+public class SystemAppManagementService extends AbstractIdleService {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(SystemAppManagementService.class);\n+  private static final Gson GSON = new Gson();\n+\n+  private final File systemAppConfigDirPath;\n+  private final SystemAppEnableExecutor systemAppEnableExecutor;\n+  private ExecutorService executorService;\n+\n+  @Inject\n+  SystemAppManagementService(CConfiguration cConf, ApplicationLifecycleService appLifecycleService,\n+                             ProgramLifecycleService programLifecycleService) {\n+    this.systemAppConfigDirPath = new File(cConf.get(Constants.SYSTEM_APP_CONFIG_DIR));\n+    this.systemAppEnableExecutor = new SystemAppEnableExecutor(appLifecycleService,\n+        programLifecycleService);\n+  }\n+\n+  @Override\n+  protected void startUp() {\n+    LOG.debug(\"Starting {}\", getClass().getSimpleName());\n+    executorService = Executors\n+        .newSingleThreadExecutor(Threads.createDaemonThreadFactory(\"sys-app-management-service\"));\n+    executorService.execute(() -> {\n+      try {\n+        // Execute all steps for each config file in system config directory.\n+        bootStrapSystemAppConfigDir();\n+      } catch (Exception ex) {\n+        LOG.error(\"Got exception in watch service for system app config dir\", ex);\n+      }\n+    });\n+  }\n+\n+  private void bootStrapSystemAppConfigDir() throws Exception {\n+    LOG.debug(\"Number of config files {} in system app config directory.\",\n+        systemAppConfigDirPath.listFiles().length);\n+\n+    for (File sysAppConfigFile : systemAppConfigDirPath.listFiles()) {\n+      LOG.debug(\"Running steps in config file {}\", sysAppConfigFile.getAbsoluteFile());\n+      executeSysConfig(sysAppConfigFile.getAbsoluteFile());\n+    }\n+  }\n+\n+  private void executeSysConfig(File fileName) throws Exception {\n+    SystemAppConfig config = parseConfig(fileName);\n+    for (SystemAppStep step : config.getSteps()) {\n+      try {\n+        step.validate();\n+      } catch (IllegalArgumentException e) {\n+        LOG.warn(\"Config step {} failed because it is malformed: {}\", step.getLabel(),\n+            e.getMessage());\n+        return;\n+      }\n+      if (step.getType() == SystemAppStep.Type.ENABLE_SYSTEM_APP) {\n+        systemAppEnableExecutor.deployAppAndStartPrograms(step.getArguments());\n+        LOG.debug(\"Deployed and enabled system app with id {} and label {}. Config file: {}.\",\n+            step.getArguments().getId(), step.getLabel(), fileName);", "originalCommit": "25979d7ef8470eef91a97f829682219eba1262d3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d2fbb2550578c5ecadbfda7de4f312360f752d6e", "chunk": "diff --git a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java\nindex fd12be1bbd1..96e49d500a4 100644\n--- a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java\n+++ b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java\n\n@@ -22,6 +22,7 @@ import com.google.gson.JsonParseException;\n import com.google.inject.Inject;\n import io.cdap.cdap.common.conf.CConfiguration;\n import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.utils.DirUtils;\n import io.cdap.cdap.internal.app.services.ApplicationLifecycleService;\n import io.cdap.cdap.internal.app.services.ProgramLifecycleService;\n import org.apache.twill.common.Threads;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM5ODE1Nw==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r378398157", "bodyText": "indentation", "author": "albertshau", "createdAt": "2020-02-12T17:22:10Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.sysapp;\n+\n+import com.google.common.util.concurrent.AbstractIdleService;\n+import com.google.gson.Gson;\n+import com.google.gson.JsonParseException;\n+import com.google.inject.Inject;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.internal.app.services.ApplicationLifecycleService;\n+import io.cdap.cdap.internal.app.services.ProgramLifecycleService;\n+import org.apache.twill.common.Threads;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.File;\n+import java.io.FileNotFoundException;\n+import java.io.FileReader;\n+import java.io.IOException;\n+import java.io.Reader;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+\n+/**\n+ * Enables system apps using system app config files located in SYSTEM_APP_CONFIG_DIR. Each config\n+ * describes steps to perform to start one (or more) system app. Currently\n+ * SystemAppManagementService runs during bootstrap phase.\n+ */\n+public class SystemAppManagementService extends AbstractIdleService {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(SystemAppManagementService.class);\n+  private static final Gson GSON = new Gson();\n+\n+  private final File systemAppConfigDirPath;\n+  private final SystemAppEnableExecutor systemAppEnableExecutor;\n+  private ExecutorService executorService;\n+\n+  @Inject\n+  SystemAppManagementService(CConfiguration cConf, ApplicationLifecycleService appLifecycleService,\n+                             ProgramLifecycleService programLifecycleService) {\n+    this.systemAppConfigDirPath = new File(cConf.get(Constants.SYSTEM_APP_CONFIG_DIR));\n+    this.systemAppEnableExecutor = new SystemAppEnableExecutor(appLifecycleService,\n+        programLifecycleService);\n+  }\n+\n+  @Override\n+  protected void startUp() {\n+    LOG.debug(\"Starting {}\", getClass().getSimpleName());\n+    executorService = Executors\n+        .newSingleThreadExecutor(Threads.createDaemonThreadFactory(\"sys-app-management-service\"));\n+    executorService.execute(() -> {\n+      try {\n+        // Execute all steps for each config file in system config directory.\n+        bootStrapSystemAppConfigDir();\n+      } catch (Exception ex) {\n+        LOG.error(\"Got exception in watch service for system app config dir\", ex);\n+      }\n+    });\n+  }\n+\n+  private void bootStrapSystemAppConfigDir() throws Exception {\n+    LOG.debug(\"Number of config files {} in system app config directory.\",\n+        systemAppConfigDirPath.listFiles().length);\n+\n+    for (File sysAppConfigFile : systemAppConfigDirPath.listFiles()) {\n+      LOG.debug(\"Running steps in config file {}\", sysAppConfigFile.getAbsoluteFile());\n+      executeSysConfig(sysAppConfigFile.getAbsoluteFile());\n+    }\n+  }\n+\n+  private void executeSysConfig(File fileName) throws Exception {\n+    SystemAppConfig config = parseConfig(fileName);\n+    for (SystemAppStep step : config.getSteps()) {\n+      try {\n+        step.validate();\n+      } catch (IllegalArgumentException e) {\n+        LOG.warn(\"Config step {} failed because it is malformed: {}\", step.getLabel(),\n+            e.getMessage());\n+        return;\n+      }\n+      if (step.getType() == SystemAppStep.Type.ENABLE_SYSTEM_APP) {\n+        systemAppEnableExecutor.deployAppAndStartPrograms(step.getArguments());\n+        LOG.debug(\"Deployed and enabled system app with id {} and label {}. Config file: {}.\",\n+            step.getArguments().getId(), step.getLabel(), fileName);\n+      } else {\n+        LOG.warn(\"Unknown system app step type {} for step label {}. Config file: {}. Ignoring it.\",\n+            step.getLabel(), step.getType(), fileName);", "originalCommit": "25979d7ef8470eef91a97f829682219eba1262d3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d2fbb2550578c5ecadbfda7de4f312360f752d6e", "chunk": "diff --git a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java\nindex fd12be1bbd1..96e49d500a4 100644\n--- a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java\n+++ b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java\n\n@@ -22,6 +22,7 @@ import com.google.gson.JsonParseException;\n import com.google.inject.Inject;\n import io.cdap.cdap.common.conf.CConfiguration;\n import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.utils.DirUtils;\n import io.cdap.cdap.internal.app.services.ApplicationLifecycleService;\n import io.cdap.cdap.internal.app.services.ProgramLifecycleService;\n import org.apache.twill.common.Threads;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM5ODE4Nw==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r378398187", "bodyText": "indentation", "author": "albertshau", "createdAt": "2020-02-12T17:22:14Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.sysapp;\n+\n+import com.google.common.util.concurrent.AbstractIdleService;\n+import com.google.gson.Gson;\n+import com.google.gson.JsonParseException;\n+import com.google.inject.Inject;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.internal.app.services.ApplicationLifecycleService;\n+import io.cdap.cdap.internal.app.services.ProgramLifecycleService;\n+import org.apache.twill.common.Threads;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.File;\n+import java.io.FileNotFoundException;\n+import java.io.FileReader;\n+import java.io.IOException;\n+import java.io.Reader;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+\n+/**\n+ * Enables system apps using system app config files located in SYSTEM_APP_CONFIG_DIR. Each config\n+ * describes steps to perform to start one (or more) system app. Currently\n+ * SystemAppManagementService runs during bootstrap phase.\n+ */\n+public class SystemAppManagementService extends AbstractIdleService {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(SystemAppManagementService.class);\n+  private static final Gson GSON = new Gson();\n+\n+  private final File systemAppConfigDirPath;\n+  private final SystemAppEnableExecutor systemAppEnableExecutor;\n+  private ExecutorService executorService;\n+\n+  @Inject\n+  SystemAppManagementService(CConfiguration cConf, ApplicationLifecycleService appLifecycleService,\n+                             ProgramLifecycleService programLifecycleService) {\n+    this.systemAppConfigDirPath = new File(cConf.get(Constants.SYSTEM_APP_CONFIG_DIR));\n+    this.systemAppEnableExecutor = new SystemAppEnableExecutor(appLifecycleService,\n+        programLifecycleService);\n+  }\n+\n+  @Override\n+  protected void startUp() {\n+    LOG.debug(\"Starting {}\", getClass().getSimpleName());\n+    executorService = Executors\n+        .newSingleThreadExecutor(Threads.createDaemonThreadFactory(\"sys-app-management-service\"));\n+    executorService.execute(() -> {\n+      try {\n+        // Execute all steps for each config file in system config directory.\n+        bootStrapSystemAppConfigDir();\n+      } catch (Exception ex) {\n+        LOG.error(\"Got exception in watch service for system app config dir\", ex);\n+      }\n+    });\n+  }\n+\n+  private void bootStrapSystemAppConfigDir() throws Exception {\n+    LOG.debug(\"Number of config files {} in system app config directory.\",\n+        systemAppConfigDirPath.listFiles().length);\n+\n+    for (File sysAppConfigFile : systemAppConfigDirPath.listFiles()) {\n+      LOG.debug(\"Running steps in config file {}\", sysAppConfigFile.getAbsoluteFile());\n+      executeSysConfig(sysAppConfigFile.getAbsoluteFile());\n+    }\n+  }\n+\n+  private void executeSysConfig(File fileName) throws Exception {\n+    SystemAppConfig config = parseConfig(fileName);\n+    for (SystemAppStep step : config.getSteps()) {\n+      try {\n+        step.validate();\n+      } catch (IllegalArgumentException e) {\n+        LOG.warn(\"Config step {} failed because it is malformed: {}\", step.getLabel(),\n+            e.getMessage());\n+        return;\n+      }\n+      if (step.getType() == SystemAppStep.Type.ENABLE_SYSTEM_APP) {\n+        systemAppEnableExecutor.deployAppAndStartPrograms(step.getArguments());\n+        LOG.debug(\"Deployed and enabled system app with id {} and label {}. Config file: {}.\",\n+            step.getArguments().getId(), step.getLabel(), fileName);\n+      } else {\n+        LOG.warn(\"Unknown system app step type {} for step label {}. Config file: {}. Ignoring it.\",\n+            step.getLabel(), step.getType(), fileName);\n+      }\n+    }\n+  }\n+\n+  private SystemAppConfig parseConfig(File fileName) {\n+    try {\n+      try (Reader reader = new FileReader(fileName)) {\n+        return GSON.fromJson(reader, SystemAppConfig.class);\n+      }\n+    } catch (FileNotFoundException e) {\n+      LOG.info(\"System app config file {} does not exist.\",\n+          fileName);", "originalCommit": "25979d7ef8470eef91a97f829682219eba1262d3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d2fbb2550578c5ecadbfda7de4f312360f752d6e", "chunk": "diff --git a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java\nindex fd12be1bbd1..96e49d500a4 100644\n--- a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java\n+++ b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java\n\n@@ -22,6 +22,7 @@ import com.google.gson.JsonParseException;\n import com.google.inject.Inject;\n import io.cdap.cdap.common.conf.CConfiguration;\n import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.utils.DirUtils;\n import io.cdap.cdap.internal.app.services.ApplicationLifecycleService;\n import io.cdap.cdap.internal.app.services.ProgramLifecycleService;\n import org.apache.twill.common.Threads;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM5ODIyNQ==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r378398225", "bodyText": "indentation", "author": "albertshau", "createdAt": "2020-02-12T17:22:17Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.sysapp;\n+\n+import com.google.common.util.concurrent.AbstractIdleService;\n+import com.google.gson.Gson;\n+import com.google.gson.JsonParseException;\n+import com.google.inject.Inject;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.internal.app.services.ApplicationLifecycleService;\n+import io.cdap.cdap.internal.app.services.ProgramLifecycleService;\n+import org.apache.twill.common.Threads;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.File;\n+import java.io.FileNotFoundException;\n+import java.io.FileReader;\n+import java.io.IOException;\n+import java.io.Reader;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+\n+/**\n+ * Enables system apps using system app config files located in SYSTEM_APP_CONFIG_DIR. Each config\n+ * describes steps to perform to start one (or more) system app. Currently\n+ * SystemAppManagementService runs during bootstrap phase.\n+ */\n+public class SystemAppManagementService extends AbstractIdleService {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(SystemAppManagementService.class);\n+  private static final Gson GSON = new Gson();\n+\n+  private final File systemAppConfigDirPath;\n+  private final SystemAppEnableExecutor systemAppEnableExecutor;\n+  private ExecutorService executorService;\n+\n+  @Inject\n+  SystemAppManagementService(CConfiguration cConf, ApplicationLifecycleService appLifecycleService,\n+                             ProgramLifecycleService programLifecycleService) {\n+    this.systemAppConfigDirPath = new File(cConf.get(Constants.SYSTEM_APP_CONFIG_DIR));\n+    this.systemAppEnableExecutor = new SystemAppEnableExecutor(appLifecycleService,\n+        programLifecycleService);\n+  }\n+\n+  @Override\n+  protected void startUp() {\n+    LOG.debug(\"Starting {}\", getClass().getSimpleName());\n+    executorService = Executors\n+        .newSingleThreadExecutor(Threads.createDaemonThreadFactory(\"sys-app-management-service\"));\n+    executorService.execute(() -> {\n+      try {\n+        // Execute all steps for each config file in system config directory.\n+        bootStrapSystemAppConfigDir();\n+      } catch (Exception ex) {\n+        LOG.error(\"Got exception in watch service for system app config dir\", ex);\n+      }\n+    });\n+  }\n+\n+  private void bootStrapSystemAppConfigDir() throws Exception {\n+    LOG.debug(\"Number of config files {} in system app config directory.\",\n+        systemAppConfigDirPath.listFiles().length);\n+\n+    for (File sysAppConfigFile : systemAppConfigDirPath.listFiles()) {\n+      LOG.debug(\"Running steps in config file {}\", sysAppConfigFile.getAbsoluteFile());\n+      executeSysConfig(sysAppConfigFile.getAbsoluteFile());\n+    }\n+  }\n+\n+  private void executeSysConfig(File fileName) throws Exception {\n+    SystemAppConfig config = parseConfig(fileName);\n+    for (SystemAppStep step : config.getSteps()) {\n+      try {\n+        step.validate();\n+      } catch (IllegalArgumentException e) {\n+        LOG.warn(\"Config step {} failed because it is malformed: {}\", step.getLabel(),\n+            e.getMessage());\n+        return;\n+      }\n+      if (step.getType() == SystemAppStep.Type.ENABLE_SYSTEM_APP) {\n+        systemAppEnableExecutor.deployAppAndStartPrograms(step.getArguments());\n+        LOG.debug(\"Deployed and enabled system app with id {} and label {}. Config file: {}.\",\n+            step.getArguments().getId(), step.getLabel(), fileName);\n+      } else {\n+        LOG.warn(\"Unknown system app step type {} for step label {}. Config file: {}. Ignoring it.\",\n+            step.getLabel(), step.getType(), fileName);\n+      }\n+    }\n+  }\n+\n+  private SystemAppConfig parseConfig(File fileName) {\n+    try {\n+      try (Reader reader = new FileReader(fileName)) {\n+        return GSON.fromJson(reader, SystemAppConfig.class);\n+      }\n+    } catch (FileNotFoundException e) {\n+      LOG.info(\"System app config file {} does not exist.\",\n+          fileName);\n+      return SystemAppConfig.EMPTY;\n+    } catch (JsonParseException e) {\n+      LOG.warn(\"Could not parse system app config file {}.\",\n+          fileName, e);", "originalCommit": "25979d7ef8470eef91a97f829682219eba1262d3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d2fbb2550578c5ecadbfda7de4f312360f752d6e", "chunk": "diff --git a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java\nindex fd12be1bbd1..96e49d500a4 100644\n--- a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java\n+++ b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java\n\n@@ -22,6 +22,7 @@ import com.google.gson.JsonParseException;\n import com.google.inject.Inject;\n import io.cdap.cdap.common.conf.CConfiguration;\n import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.utils.DirUtils;\n import io.cdap.cdap.internal.app.services.ApplicationLifecycleService;\n import io.cdap.cdap.internal.app.services.ProgramLifecycleService;\n import org.apache.twill.common.Threads;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM5ODI3Nw==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r378398277", "bodyText": "indentation", "author": "albertshau", "createdAt": "2020-02-12T17:22:22Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.sysapp;\n+\n+import com.google.common.util.concurrent.AbstractIdleService;\n+import com.google.gson.Gson;\n+import com.google.gson.JsonParseException;\n+import com.google.inject.Inject;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.internal.app.services.ApplicationLifecycleService;\n+import io.cdap.cdap.internal.app.services.ProgramLifecycleService;\n+import org.apache.twill.common.Threads;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.File;\n+import java.io.FileNotFoundException;\n+import java.io.FileReader;\n+import java.io.IOException;\n+import java.io.Reader;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+\n+/**\n+ * Enables system apps using system app config files located in SYSTEM_APP_CONFIG_DIR. Each config\n+ * describes steps to perform to start one (or more) system app. Currently\n+ * SystemAppManagementService runs during bootstrap phase.\n+ */\n+public class SystemAppManagementService extends AbstractIdleService {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(SystemAppManagementService.class);\n+  private static final Gson GSON = new Gson();\n+\n+  private final File systemAppConfigDirPath;\n+  private final SystemAppEnableExecutor systemAppEnableExecutor;\n+  private ExecutorService executorService;\n+\n+  @Inject\n+  SystemAppManagementService(CConfiguration cConf, ApplicationLifecycleService appLifecycleService,\n+                             ProgramLifecycleService programLifecycleService) {\n+    this.systemAppConfigDirPath = new File(cConf.get(Constants.SYSTEM_APP_CONFIG_DIR));\n+    this.systemAppEnableExecutor = new SystemAppEnableExecutor(appLifecycleService,\n+        programLifecycleService);\n+  }\n+\n+  @Override\n+  protected void startUp() {\n+    LOG.debug(\"Starting {}\", getClass().getSimpleName());\n+    executorService = Executors\n+        .newSingleThreadExecutor(Threads.createDaemonThreadFactory(\"sys-app-management-service\"));\n+    executorService.execute(() -> {\n+      try {\n+        // Execute all steps for each config file in system config directory.\n+        bootStrapSystemAppConfigDir();\n+      } catch (Exception ex) {\n+        LOG.error(\"Got exception in watch service for system app config dir\", ex);\n+      }\n+    });\n+  }\n+\n+  private void bootStrapSystemAppConfigDir() throws Exception {\n+    LOG.debug(\"Number of config files {} in system app config directory.\",\n+        systemAppConfigDirPath.listFiles().length);\n+\n+    for (File sysAppConfigFile : systemAppConfigDirPath.listFiles()) {\n+      LOG.debug(\"Running steps in config file {}\", sysAppConfigFile.getAbsoluteFile());\n+      executeSysConfig(sysAppConfigFile.getAbsoluteFile());\n+    }\n+  }\n+\n+  private void executeSysConfig(File fileName) throws Exception {\n+    SystemAppConfig config = parseConfig(fileName);\n+    for (SystemAppStep step : config.getSteps()) {\n+      try {\n+        step.validate();\n+      } catch (IllegalArgumentException e) {\n+        LOG.warn(\"Config step {} failed because it is malformed: {}\", step.getLabel(),\n+            e.getMessage());\n+        return;\n+      }\n+      if (step.getType() == SystemAppStep.Type.ENABLE_SYSTEM_APP) {\n+        systemAppEnableExecutor.deployAppAndStartPrograms(step.getArguments());\n+        LOG.debug(\"Deployed and enabled system app with id {} and label {}. Config file: {}.\",\n+            step.getArguments().getId(), step.getLabel(), fileName);\n+      } else {\n+        LOG.warn(\"Unknown system app step type {} for step label {}. Config file: {}. Ignoring it.\",\n+            step.getLabel(), step.getType(), fileName);\n+      }\n+    }\n+  }\n+\n+  private SystemAppConfig parseConfig(File fileName) {\n+    try {\n+      try (Reader reader = new FileReader(fileName)) {\n+        return GSON.fromJson(reader, SystemAppConfig.class);\n+      }\n+    } catch (FileNotFoundException e) {\n+      LOG.info(\"System app config file {} does not exist.\",\n+          fileName);\n+      return SystemAppConfig.EMPTY;\n+    } catch (JsonParseException e) {\n+      LOG.warn(\"Could not parse system app config file {}.\",\n+          fileName, e);\n+      return SystemAppConfig.EMPTY;\n+    } catch (IOException e) {\n+      LOG.warn(\"Could not system app config file {}.\",\n+          fileName, e);", "originalCommit": "25979d7ef8470eef91a97f829682219eba1262d3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d2fbb2550578c5ecadbfda7de4f312360f752d6e", "chunk": "diff --git a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java\nindex fd12be1bbd1..96e49d500a4 100644\n--- a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java\n+++ b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java\n\n@@ -22,6 +22,7 @@ import com.google.gson.JsonParseException;\n import com.google.inject.Inject;\n import io.cdap.cdap.common.conf.CConfiguration;\n import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.utils.DirUtils;\n import io.cdap.cdap.internal.app.services.ApplicationLifecycleService;\n import io.cdap.cdap.internal.app.services.ProgramLifecycleService;\n import org.apache.twill.common.Threads;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM5ODQxMg==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r378398412", "bodyText": "Could not read system app config file", "author": "albertshau", "createdAt": "2020-02-12T17:22:37Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.sysapp;\n+\n+import com.google.common.util.concurrent.AbstractIdleService;\n+import com.google.gson.Gson;\n+import com.google.gson.JsonParseException;\n+import com.google.inject.Inject;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.internal.app.services.ApplicationLifecycleService;\n+import io.cdap.cdap.internal.app.services.ProgramLifecycleService;\n+import org.apache.twill.common.Threads;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.File;\n+import java.io.FileNotFoundException;\n+import java.io.FileReader;\n+import java.io.IOException;\n+import java.io.Reader;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+\n+/**\n+ * Enables system apps using system app config files located in SYSTEM_APP_CONFIG_DIR. Each config\n+ * describes steps to perform to start one (or more) system app. Currently\n+ * SystemAppManagementService runs during bootstrap phase.\n+ */\n+public class SystemAppManagementService extends AbstractIdleService {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(SystemAppManagementService.class);\n+  private static final Gson GSON = new Gson();\n+\n+  private final File systemAppConfigDirPath;\n+  private final SystemAppEnableExecutor systemAppEnableExecutor;\n+  private ExecutorService executorService;\n+\n+  @Inject\n+  SystemAppManagementService(CConfiguration cConf, ApplicationLifecycleService appLifecycleService,\n+                             ProgramLifecycleService programLifecycleService) {\n+    this.systemAppConfigDirPath = new File(cConf.get(Constants.SYSTEM_APP_CONFIG_DIR));\n+    this.systemAppEnableExecutor = new SystemAppEnableExecutor(appLifecycleService,\n+        programLifecycleService);\n+  }\n+\n+  @Override\n+  protected void startUp() {\n+    LOG.debug(\"Starting {}\", getClass().getSimpleName());\n+    executorService = Executors\n+        .newSingleThreadExecutor(Threads.createDaemonThreadFactory(\"sys-app-management-service\"));\n+    executorService.execute(() -> {\n+      try {\n+        // Execute all steps for each config file in system config directory.\n+        bootStrapSystemAppConfigDir();\n+      } catch (Exception ex) {\n+        LOG.error(\"Got exception in watch service for system app config dir\", ex);\n+      }\n+    });\n+  }\n+\n+  private void bootStrapSystemAppConfigDir() throws Exception {\n+    LOG.debug(\"Number of config files {} in system app config directory.\",\n+        systemAppConfigDirPath.listFiles().length);\n+\n+    for (File sysAppConfigFile : systemAppConfigDirPath.listFiles()) {\n+      LOG.debug(\"Running steps in config file {}\", sysAppConfigFile.getAbsoluteFile());\n+      executeSysConfig(sysAppConfigFile.getAbsoluteFile());\n+    }\n+  }\n+\n+  private void executeSysConfig(File fileName) throws Exception {\n+    SystemAppConfig config = parseConfig(fileName);\n+    for (SystemAppStep step : config.getSteps()) {\n+      try {\n+        step.validate();\n+      } catch (IllegalArgumentException e) {\n+        LOG.warn(\"Config step {} failed because it is malformed: {}\", step.getLabel(),\n+            e.getMessage());\n+        return;\n+      }\n+      if (step.getType() == SystemAppStep.Type.ENABLE_SYSTEM_APP) {\n+        systemAppEnableExecutor.deployAppAndStartPrograms(step.getArguments());\n+        LOG.debug(\"Deployed and enabled system app with id {} and label {}. Config file: {}.\",\n+            step.getArguments().getId(), step.getLabel(), fileName);\n+      } else {\n+        LOG.warn(\"Unknown system app step type {} for step label {}. Config file: {}. Ignoring it.\",\n+            step.getLabel(), step.getType(), fileName);\n+      }\n+    }\n+  }\n+\n+  private SystemAppConfig parseConfig(File fileName) {\n+    try {\n+      try (Reader reader = new FileReader(fileName)) {\n+        return GSON.fromJson(reader, SystemAppConfig.class);\n+      }\n+    } catch (FileNotFoundException e) {\n+      LOG.info(\"System app config file {} does not exist.\",\n+          fileName);\n+      return SystemAppConfig.EMPTY;\n+    } catch (JsonParseException e) {\n+      LOG.warn(\"Could not parse system app config file {}.\",\n+          fileName, e);\n+      return SystemAppConfig.EMPTY;\n+    } catch (IOException e) {\n+      LOG.warn(\"Could not system app config file {}.\",", "originalCommit": "25979d7ef8470eef91a97f829682219eba1262d3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQ1MjE5OQ==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r378452199", "bodyText": "You can combine the FileNotFoundException as the IOException. Just log with the exception would give enough information to debug.", "author": "chtyim", "createdAt": "2020-02-12T19:04:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM5ODQxMg=="}], "type": "inlineReview", "revised_code": {"commit": "d2fbb2550578c5ecadbfda7de4f312360f752d6e", "chunk": "diff --git a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java\nindex fd12be1bbd1..96e49d500a4 100644\n--- a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java\n+++ b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java\n\n@@ -22,6 +22,7 @@ import com.google.gson.JsonParseException;\n import com.google.inject.Inject;\n import io.cdap.cdap.common.conf.CConfiguration;\n import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.utils.DirUtils;\n import io.cdap.cdap.internal.app.services.ApplicationLifecycleService;\n import io.cdap.cdap.internal.app.services.ProgramLifecycleService;\n import org.apache.twill.common.Threads;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM5OTU2OQ==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r378399569", "bodyText": "this is not required, since it's a TemporaryFolder it will be cleaned up by junit.", "author": "albertshau", "createdAt": "2020-02-12T17:24:48Z", "path": "cdap-app-fabric/src/test/java/io/cdap/cdap/internal/sysapp/SystemAppManagementServiceTest.java", "diffHunk": "@@ -0,0 +1,132 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.sysapp;\n+\n+import com.google.gson.Gson;\n+import com.google.gson.JsonObject;\n+import com.google.inject.Injector;\n+import io.cdap.cdap.AllProgramsApp;\n+import io.cdap.cdap.api.artifact.ArtifactSummary;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.id.Id;\n+import io.cdap.cdap.internal.app.services.ApplicationLifecycleService;\n+import io.cdap.cdap.internal.app.services.ProgramLifecycleService;\n+import io.cdap.cdap.internal.app.services.http.AppFabricTestBase;\n+import io.cdap.cdap.proto.ProgramType;\n+import io.cdap.cdap.proto.artifact.AppRequest;\n+import io.cdap.cdap.proto.id.ApplicationId;\n+import io.cdap.cdap.proto.id.NamespaceId;\n+import io.cdap.cdap.proto.id.ProgramId;\n+import org.iq80.leveldb.util.FileUtils;\n+import org.junit.After;\n+import org.junit.AfterClass;\n+import org.junit.Assert;\n+import org.junit.BeforeClass;\n+import org.junit.ClassRule;\n+import org.junit.Test;\n+import org.junit.rules.TemporaryFolder;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.BufferedWriter;\n+import java.io.File;\n+import java.io.FileWriter;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+/**\n+ * Tests for the {@link SystemAppManagementService}.\n+ */\n+public class SystemAppManagementServiceTest extends AppFabricTestBase {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(SystemAppManagementServiceTest.class);\n+  private static final Gson GSON = new Gson();\n+\n+  private static ProgramLifecycleService programLifecycleService;\n+  private static ApplicationLifecycleService applicationLifecycleService;\n+  private static CConfiguration cConf;\n+  private static SystemAppManagementService systemAppManagementService;\n+  private static File systemConfigDir;\n+\n+  private static final String RUNNING = \"RUNNING\";\n+\n+  @ClassRule\n+  public static final TemporaryFolder TEMPORARY_FOLDER = new TemporaryFolder();\n+\n+\n+  @BeforeClass\n+  public static void setup() throws IOException {\n+    Injector injector = getInjector();\n+    programLifecycleService = injector.getInstance(ProgramLifecycleService.class);\n+    applicationLifecycleService = injector.getInstance(ApplicationLifecycleService.class);\n+    cConf = injector.getInstance(CConfiguration.class);\n+    systemConfigDir = TEMPORARY_FOLDER.newFolder(\"demo-sys-app-config-dir\");\n+    cConf.set(Constants.SYSTEM_APP_CONFIG_DIR, systemConfigDir.getAbsolutePath());\n+    systemAppManagementService = new SystemAppManagementService(cConf, applicationLifecycleService,\n+                                                                programLifecycleService);\n+  }\n+\n+  @AfterClass\n+  public static void tearDown() throws Exception {\n+    systemAppManagementService.shutDown();\n+  }\n+\n+  @After\n+  public void cleanupTest() {\n+    FileUtils.deleteDirectoryContents(systemConfigDir);", "originalCommit": "25979d7ef8470eef91a97f829682219eba1262d3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d2fbb2550578c5ecadbfda7de4f312360f752d6e", "chunk": "diff --git a/cdap-app-fabric/src/test/java/io/cdap/cdap/internal/sysapp/SystemAppManagementServiceTest.java b/cdap-app-fabric/src/test/java/io/cdap/cdap/internal/sysapp/SystemAppManagementServiceTest.java\nindex 0eb48b9e187..0064f1156cd 100644\n--- a/cdap-app-fabric/src/test/java/io/cdap/cdap/internal/sysapp/SystemAppManagementServiceTest.java\n+++ b/cdap-app-fabric/src/test/java/io/cdap/cdap/internal/sysapp/SystemAppManagementServiceTest.java\n\n@@ -76,10 +76,6 @@ public class SystemAppManagementServiceTest extends AppFabricTestBase {\n     programLifecycleService = injector.getInstance(ProgramLifecycleService.class);\n     applicationLifecycleService = injector.getInstance(ApplicationLifecycleService.class);\n     cConf = injector.getInstance(CConfiguration.class);\n-    systemConfigDir = TEMPORARY_FOLDER.newFolder(\"demo-sys-app-config-dir\");\n-    cConf.set(Constants.SYSTEM_APP_CONFIG_DIR, systemConfigDir.getAbsolutePath());\n-    systemAppManagementService = new SystemAppManagementService(cConf, applicationLifecycleService,\n-                                                                programLifecycleService);\n   }\n \n   @AfterClass\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQwMDM0NA==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r378400344", "bodyText": "indentation (same for rest of the file)", "author": "albertshau", "createdAt": "2020-02-12T17:26:07Z", "path": "cdap-app-fabric/src/test/java/io/cdap/cdap/internal/sysapp/SystemAppManagementServiceTest.java", "diffHunk": "@@ -0,0 +1,132 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.sysapp;\n+\n+import com.google.gson.Gson;\n+import com.google.gson.JsonObject;\n+import com.google.inject.Injector;\n+import io.cdap.cdap.AllProgramsApp;\n+import io.cdap.cdap.api.artifact.ArtifactSummary;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.id.Id;\n+import io.cdap.cdap.internal.app.services.ApplicationLifecycleService;\n+import io.cdap.cdap.internal.app.services.ProgramLifecycleService;\n+import io.cdap.cdap.internal.app.services.http.AppFabricTestBase;\n+import io.cdap.cdap.proto.ProgramType;\n+import io.cdap.cdap.proto.artifact.AppRequest;\n+import io.cdap.cdap.proto.id.ApplicationId;\n+import io.cdap.cdap.proto.id.NamespaceId;\n+import io.cdap.cdap.proto.id.ProgramId;\n+import org.iq80.leveldb.util.FileUtils;\n+import org.junit.After;\n+import org.junit.AfterClass;\n+import org.junit.Assert;\n+import org.junit.BeforeClass;\n+import org.junit.ClassRule;\n+import org.junit.Test;\n+import org.junit.rules.TemporaryFolder;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.BufferedWriter;\n+import java.io.File;\n+import java.io.FileWriter;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+/**\n+ * Tests for the {@link SystemAppManagementService}.\n+ */\n+public class SystemAppManagementServiceTest extends AppFabricTestBase {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(SystemAppManagementServiceTest.class);\n+  private static final Gson GSON = new Gson();\n+\n+  private static ProgramLifecycleService programLifecycleService;\n+  private static ApplicationLifecycleService applicationLifecycleService;\n+  private static CConfiguration cConf;\n+  private static SystemAppManagementService systemAppManagementService;\n+  private static File systemConfigDir;\n+\n+  private static final String RUNNING = \"RUNNING\";\n+\n+  @ClassRule\n+  public static final TemporaryFolder TEMPORARY_FOLDER = new TemporaryFolder();\n+\n+\n+  @BeforeClass\n+  public static void setup() throws IOException {\n+    Injector injector = getInjector();\n+    programLifecycleService = injector.getInstance(ProgramLifecycleService.class);\n+    applicationLifecycleService = injector.getInstance(ApplicationLifecycleService.class);\n+    cConf = injector.getInstance(CConfiguration.class);\n+    systemConfigDir = TEMPORARY_FOLDER.newFolder(\"demo-sys-app-config-dir\");\n+    cConf.set(Constants.SYSTEM_APP_CONFIG_DIR, systemConfigDir.getAbsolutePath());\n+    systemAppManagementService = new SystemAppManagementService(cConf, applicationLifecycleService,\n+                                                                programLifecycleService);\n+  }\n+\n+  @AfterClass\n+  public static void tearDown() throws Exception {\n+    systemAppManagementService.shutDown();\n+  }\n+\n+  @After\n+  public void cleanupTest() {\n+    FileUtils.deleteDirectoryContents(systemConfigDir);\n+  }\n+\n+  private void createEnableSysAppConfigFile(Id.Artifact artifactId, String filename) throws IOException {\n+    AppRequest<JsonObject> appRequest = new AppRequest<>(\n+        new ArtifactSummary(artifactId.getName(), artifactId.getVersion().getVersion()));", "originalCommit": "25979d7ef8470eef91a97f829682219eba1262d3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d2fbb2550578c5ecadbfda7de4f312360f752d6e", "chunk": "diff --git a/cdap-app-fabric/src/test/java/io/cdap/cdap/internal/sysapp/SystemAppManagementServiceTest.java b/cdap-app-fabric/src/test/java/io/cdap/cdap/internal/sysapp/SystemAppManagementServiceTest.java\nindex 0eb48b9e187..0064f1156cd 100644\n--- a/cdap-app-fabric/src/test/java/io/cdap/cdap/internal/sysapp/SystemAppManagementServiceTest.java\n+++ b/cdap-app-fabric/src/test/java/io/cdap/cdap/internal/sysapp/SystemAppManagementServiceTest.java\n\n@@ -76,10 +76,6 @@ public class SystemAppManagementServiceTest extends AppFabricTestBase {\n     programLifecycleService = injector.getInstance(ProgramLifecycleService.class);\n     applicationLifecycleService = injector.getInstance(ApplicationLifecycleService.class);\n     cConf = injector.getInstance(CConfiguration.class);\n-    systemConfigDir = TEMPORARY_FOLDER.newFolder(\"demo-sys-app-config-dir\");\n-    cConf.set(Constants.SYSTEM_APP_CONFIG_DIR, systemConfigDir.getAbsolutePath());\n-    systemAppManagementService = new SystemAppManagementService(cConf, applicationLifecycleService,\n-                                                                programLifecycleService);\n   }\n \n   @AfterClass\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQwMDc0OQ==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r378400749", "bodyText": "should be in a try - finally to ensure it gets closed", "author": "albertshau", "createdAt": "2020-02-12T17:26:47Z", "path": "cdap-app-fabric/src/test/java/io/cdap/cdap/internal/sysapp/SystemAppManagementServiceTest.java", "diffHunk": "@@ -0,0 +1,132 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.sysapp;\n+\n+import com.google.gson.Gson;\n+import com.google.gson.JsonObject;\n+import com.google.inject.Injector;\n+import io.cdap.cdap.AllProgramsApp;\n+import io.cdap.cdap.api.artifact.ArtifactSummary;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.id.Id;\n+import io.cdap.cdap.internal.app.services.ApplicationLifecycleService;\n+import io.cdap.cdap.internal.app.services.ProgramLifecycleService;\n+import io.cdap.cdap.internal.app.services.http.AppFabricTestBase;\n+import io.cdap.cdap.proto.ProgramType;\n+import io.cdap.cdap.proto.artifact.AppRequest;\n+import io.cdap.cdap.proto.id.ApplicationId;\n+import io.cdap.cdap.proto.id.NamespaceId;\n+import io.cdap.cdap.proto.id.ProgramId;\n+import org.iq80.leveldb.util.FileUtils;\n+import org.junit.After;\n+import org.junit.AfterClass;\n+import org.junit.Assert;\n+import org.junit.BeforeClass;\n+import org.junit.ClassRule;\n+import org.junit.Test;\n+import org.junit.rules.TemporaryFolder;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.BufferedWriter;\n+import java.io.File;\n+import java.io.FileWriter;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+/**\n+ * Tests for the {@link SystemAppManagementService}.\n+ */\n+public class SystemAppManagementServiceTest extends AppFabricTestBase {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(SystemAppManagementServiceTest.class);\n+  private static final Gson GSON = new Gson();\n+\n+  private static ProgramLifecycleService programLifecycleService;\n+  private static ApplicationLifecycleService applicationLifecycleService;\n+  private static CConfiguration cConf;\n+  private static SystemAppManagementService systemAppManagementService;\n+  private static File systemConfigDir;\n+\n+  private static final String RUNNING = \"RUNNING\";\n+\n+  @ClassRule\n+  public static final TemporaryFolder TEMPORARY_FOLDER = new TemporaryFolder();\n+\n+\n+  @BeforeClass\n+  public static void setup() throws IOException {\n+    Injector injector = getInjector();\n+    programLifecycleService = injector.getInstance(ProgramLifecycleService.class);\n+    applicationLifecycleService = injector.getInstance(ApplicationLifecycleService.class);\n+    cConf = injector.getInstance(CConfiguration.class);\n+    systemConfigDir = TEMPORARY_FOLDER.newFolder(\"demo-sys-app-config-dir\");\n+    cConf.set(Constants.SYSTEM_APP_CONFIG_DIR, systemConfigDir.getAbsolutePath());\n+    systemAppManagementService = new SystemAppManagementService(cConf, applicationLifecycleService,\n+                                                                programLifecycleService);\n+  }\n+\n+  @AfterClass\n+  public static void tearDown() throws Exception {\n+    systemAppManagementService.shutDown();\n+  }\n+\n+  @After\n+  public void cleanupTest() {\n+    FileUtils.deleteDirectoryContents(systemConfigDir);\n+  }\n+\n+  private void createEnableSysAppConfigFile(Id.Artifact artifactId, String filename) throws IOException {\n+    AppRequest<JsonObject> appRequest = new AppRequest<>(\n+        new ArtifactSummary(artifactId.getName(), artifactId.getVersion().getVersion()));\n+    SystemAppStep.Arguments step1Argument = new SystemAppStep.Arguments(\n+        appRequest, artifactId.getNamespace().getId(), artifactId.getName(), false);\n+    List<SystemAppStep> steps = new ArrayList<>();\n+    steps.add(\n+        new SystemAppStep(\"step for \" + artifactId.getName(), SystemAppStep.Type.ENABLE_SYSTEM_APP,\n+            step1Argument));\n+    SystemAppConfig config = new SystemAppConfig(steps);\n+    File tmpFile = new File(systemConfigDir, filename);\n+    BufferedWriter bw = new BufferedWriter(new FileWriter(tmpFile));", "originalCommit": "25979d7ef8470eef91a97f829682219eba1262d3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d2fbb2550578c5ecadbfda7de4f312360f752d6e", "chunk": "diff --git a/cdap-app-fabric/src/test/java/io/cdap/cdap/internal/sysapp/SystemAppManagementServiceTest.java b/cdap-app-fabric/src/test/java/io/cdap/cdap/internal/sysapp/SystemAppManagementServiceTest.java\nindex 0eb48b9e187..0064f1156cd 100644\n--- a/cdap-app-fabric/src/test/java/io/cdap/cdap/internal/sysapp/SystemAppManagementServiceTest.java\n+++ b/cdap-app-fabric/src/test/java/io/cdap/cdap/internal/sysapp/SystemAppManagementServiceTest.java\n\n@@ -76,10 +76,6 @@ public class SystemAppManagementServiceTest extends AppFabricTestBase {\n     programLifecycleService = injector.getInstance(ProgramLifecycleService.class);\n     applicationLifecycleService = injector.getInstance(ApplicationLifecycleService.class);\n     cConf = injector.getInstance(CConfiguration.class);\n-    systemConfigDir = TEMPORARY_FOLDER.newFolder(\"demo-sys-app-config-dir\");\n-    cConf.set(Constants.SYSTEM_APP_CONFIG_DIR, systemConfigDir.getAbsolutePath());\n-    systemAppManagementService = new SystemAppManagementService(cConf, applicationLifecycleService,\n-                                                                programLifecycleService);\n   }\n \n   @AfterClass\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQwOTMyNg==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r378409326", "bodyText": "Since the service can't really be re-used across test cases because it reads things on start up, it's better to create it within the test case rather than here.", "author": "albertshau", "createdAt": "2020-02-12T17:42:21Z", "path": "cdap-app-fabric/src/test/java/io/cdap/cdap/internal/sysapp/SystemAppManagementServiceTest.java", "diffHunk": "@@ -0,0 +1,132 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.sysapp;\n+\n+import com.google.gson.Gson;\n+import com.google.gson.JsonObject;\n+import com.google.inject.Injector;\n+import io.cdap.cdap.AllProgramsApp;\n+import io.cdap.cdap.api.artifact.ArtifactSummary;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.id.Id;\n+import io.cdap.cdap.internal.app.services.ApplicationLifecycleService;\n+import io.cdap.cdap.internal.app.services.ProgramLifecycleService;\n+import io.cdap.cdap.internal.app.services.http.AppFabricTestBase;\n+import io.cdap.cdap.proto.ProgramType;\n+import io.cdap.cdap.proto.artifact.AppRequest;\n+import io.cdap.cdap.proto.id.ApplicationId;\n+import io.cdap.cdap.proto.id.NamespaceId;\n+import io.cdap.cdap.proto.id.ProgramId;\n+import org.iq80.leveldb.util.FileUtils;\n+import org.junit.After;\n+import org.junit.AfterClass;\n+import org.junit.Assert;\n+import org.junit.BeforeClass;\n+import org.junit.ClassRule;\n+import org.junit.Test;\n+import org.junit.rules.TemporaryFolder;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.BufferedWriter;\n+import java.io.File;\n+import java.io.FileWriter;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+/**\n+ * Tests for the {@link SystemAppManagementService}.\n+ */\n+public class SystemAppManagementServiceTest extends AppFabricTestBase {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(SystemAppManagementServiceTest.class);\n+  private static final Gson GSON = new Gson();\n+\n+  private static ProgramLifecycleService programLifecycleService;\n+  private static ApplicationLifecycleService applicationLifecycleService;\n+  private static CConfiguration cConf;\n+  private static SystemAppManagementService systemAppManagementService;\n+  private static File systemConfigDir;\n+\n+  private static final String RUNNING = \"RUNNING\";\n+\n+  @ClassRule\n+  public static final TemporaryFolder TEMPORARY_FOLDER = new TemporaryFolder();\n+\n+\n+  @BeforeClass\n+  public static void setup() throws IOException {\n+    Injector injector = getInjector();\n+    programLifecycleService = injector.getInstance(ProgramLifecycleService.class);\n+    applicationLifecycleService = injector.getInstance(ApplicationLifecycleService.class);\n+    cConf = injector.getInstance(CConfiguration.class);\n+    systemConfigDir = TEMPORARY_FOLDER.newFolder(\"demo-sys-app-config-dir\");\n+    cConf.set(Constants.SYSTEM_APP_CONFIG_DIR, systemConfigDir.getAbsolutePath());\n+    systemAppManagementService = new SystemAppManagementService(cConf, applicationLifecycleService,", "originalCommit": "25979d7ef8470eef91a97f829682219eba1262d3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQ1Njc2NQ==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r378456765", "bodyText": "Makes sense. I was planning to use @BeforeTest and @AfterTest but this looks better for now. Changed it accordingly.", "author": "pandyajay10", "createdAt": "2020-02-12T19:13:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQwOTMyNg=="}], "type": "inlineReview", "revised_code": {"commit": "d2fbb2550578c5ecadbfda7de4f312360f752d6e", "chunk": "diff --git a/cdap-app-fabric/src/test/java/io/cdap/cdap/internal/sysapp/SystemAppManagementServiceTest.java b/cdap-app-fabric/src/test/java/io/cdap/cdap/internal/sysapp/SystemAppManagementServiceTest.java\nindex 0eb48b9e187..0064f1156cd 100644\n--- a/cdap-app-fabric/src/test/java/io/cdap/cdap/internal/sysapp/SystemAppManagementServiceTest.java\n+++ b/cdap-app-fabric/src/test/java/io/cdap/cdap/internal/sysapp/SystemAppManagementServiceTest.java\n\n@@ -76,10 +76,6 @@ public class SystemAppManagementServiceTest extends AppFabricTestBase {\n     programLifecycleService = injector.getInstance(ProgramLifecycleService.class);\n     applicationLifecycleService = injector.getInstance(ApplicationLifecycleService.class);\n     cConf = injector.getInstance(CConfiguration.class);\n-    systemConfigDir = TEMPORARY_FOLDER.newFolder(\"demo-sys-app-config-dir\");\n-    cConf.set(Constants.SYSTEM_APP_CONFIG_DIR, systemConfigDir.getAbsolutePath());\n-    systemAppManagementService = new SystemAppManagementService(cConf, applicationLifecycleService,\n-                                                                programLifecycleService);\n   }\n \n   @AfterClass\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQ0NTA3Ng==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r378445076", "bodyText": "Use annotation @VisibileForTesting", "author": "chtyim", "createdAt": "2020-02-12T18:51:13Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppConfig.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.sysapp;\n+\n+import java.util.Collections;\n+import java.util.List;\n+\n+/**\n+ * Specified operations to perform for system app in a CDAP instance.\n+ */\n+public class SystemAppConfig {\n+  public static final SystemAppConfig EMPTY = new SystemAppConfig(Collections.emptyList());\n+  private final List<SystemAppStep> steps;\n+\n+  public SystemAppConfig(List<SystemAppStep> steps) {\n+    this.steps = steps;\n+  }\n+\n+  public List<SystemAppStep> getSteps() {\n+    // can be null when deserialized through gson\n+    return steps == null ? Collections.emptyList() : Collections.unmodifiableList(steps);\n+  }\n+\n+  // Only used for testing.", "originalCommit": "25979d7ef8470eef91a97f829682219eba1262d3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQ2MjEzMw==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r378462133", "bodyText": "The method is not needed anymore. removed it.", "author": "pandyajay10", "createdAt": "2020-02-12T19:23:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQ0NTA3Ng=="}], "type": "inlineReview", "revised_code": {"commit": "d2fbb2550578c5ecadbfda7de4f312360f752d6e", "chunk": "diff --git a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppConfig.java b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppConfig.java\nindex a0d54012562..fc90fa07d4b 100644\n--- a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppConfig.java\n+++ b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppConfig.java\n\n@@ -35,19 +35,12 @@ public class SystemAppConfig {\n     return steps == null ? Collections.emptyList() : Collections.unmodifiableList(steps);\n   }\n \n-  // Only used for testing.\n-  protected void addSteps(SystemAppStep step) {\n-    steps.add(step);\n-  }\n-\n   /**\n    * Check that this is a valid config, throwing an exception if not.\n    *\n    * @throws IllegalArgumentException if the config is invalid\n    */\n   public void validate() {\n-    for (SystemAppStep step : steps) {\n-      step.validate();\n-    }\n+    steps.forEach(SystemAppStep::validate);\n   }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQ0NTg0NA==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r378445844", "bodyText": "Can simply be steps.forEach(SystemAppStep::validate);", "author": "chtyim", "createdAt": "2020-02-12T18:52:38Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppConfig.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.sysapp;\n+\n+import java.util.Collections;\n+import java.util.List;\n+\n+/**\n+ * Specified operations to perform for system app in a CDAP instance.\n+ */\n+public class SystemAppConfig {\n+  public static final SystemAppConfig EMPTY = new SystemAppConfig(Collections.emptyList());\n+  private final List<SystemAppStep> steps;\n+\n+  public SystemAppConfig(List<SystemAppStep> steps) {\n+    this.steps = steps;\n+  }\n+\n+  public List<SystemAppStep> getSteps() {\n+    // can be null when deserialized through gson\n+    return steps == null ? Collections.emptyList() : Collections.unmodifiableList(steps);\n+  }\n+\n+  // Only used for testing.\n+  protected void addSteps(SystemAppStep step) {\n+    steps.add(step);\n+  }\n+\n+  /**\n+   * Check that this is a valid config, throwing an exception if not.\n+   *\n+   * @throws IllegalArgumentException if the config is invalid\n+   */\n+  public void validate() {\n+    for (SystemAppStep step : steps) {", "originalCommit": "25979d7ef8470eef91a97f829682219eba1262d3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d2fbb2550578c5ecadbfda7de4f312360f752d6e", "chunk": "diff --git a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppConfig.java b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppConfig.java\nindex a0d54012562..fc90fa07d4b 100644\n--- a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppConfig.java\n+++ b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppConfig.java\n\n@@ -35,19 +35,12 @@ public class SystemAppConfig {\n     return steps == null ? Collections.emptyList() : Collections.unmodifiableList(steps);\n   }\n \n-  // Only used for testing.\n-  protected void addSteps(SystemAppStep step) {\n-    steps.add(step);\n-  }\n-\n   /**\n    * Check that this is a valid config, throwing an exception if not.\n    *\n    * @throws IllegalArgumentException if the config is invalid\n    */\n   public void validate() {\n-    for (SystemAppStep step : steps) {\n-      step.validate();\n-    }\n+    steps.forEach(SystemAppStep::validate);\n   }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQ0NjU4OA==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r378446588", "bodyText": "Remove extra empty lines.", "author": "chtyim", "createdAt": "2020-02-12T18:53:58Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.sysapp;\n+\n+import com.google.common.base.Preconditions;\n+import com.google.gson.Gson;\n+import com.google.inject.Inject;\n+import io.cdap.cdap.api.artifact.ArtifactSummary;\n+import io.cdap.cdap.api.dataset.DatasetManagementException;\n+import io.cdap.cdap.api.retry.RetryableException;\n+import io.cdap.cdap.app.program.ProgramDescriptor;\n+import io.cdap.cdap.common.ApplicationNotFoundException;\n+import io.cdap.cdap.common.ConflictException;\n+import io.cdap.cdap.common.InvalidArtifactException;\n+import io.cdap.cdap.common.NotFoundException;\n+import io.cdap.cdap.common.service.Retries;\n+import io.cdap.cdap.common.service.RetryStrategies;\n+import io.cdap.cdap.internal.app.deploy.pipeline.ApplicationWithPrograms;\n+import io.cdap.cdap.internal.app.services.ApplicationLifecycleService;\n+import io.cdap.cdap.internal.app.services.ProgramLifecycleService;\n+import io.cdap.cdap.internal.sysapp.SystemAppStep.Arguments;\n+import io.cdap.cdap.proto.ProgramStatus;\n+import io.cdap.cdap.proto.id.ApplicationId;\n+import io.cdap.cdap.proto.id.KerberosPrincipalId;\n+import io.cdap.cdap.proto.id.ProgramId;\n+import io.cdap.cdap.security.spi.authorization.UnauthorizedException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.Collections;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * Deploys an application with given arguments. Also runs all programs corresponding to the\n+ * application.\n+ */\n+public class SystemAppEnableExecutor {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(SystemAppEnableExecutor.class);\n+  private static final Gson GSON = new Gson();\n+  private final ApplicationLifecycleService appLifecycleService;\n+  private final ProgramLifecycleService programLifecycleService;\n+\n+  @Inject\n+  SystemAppEnableExecutor(ApplicationLifecycleService appLifecycleService,\n+                          ProgramLifecycleService programLifecycleService) {\n+    this.appLifecycleService = appLifecycleService;\n+    this.programLifecycleService = programLifecycleService;\n+  }\n+\n+  public void deployAppAndStartPrograms(Arguments arguments) {\n+", "originalCommit": "25979d7ef8470eef91a97f829682219eba1262d3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d2fbb2550578c5ecadbfda7de4f312360f752d6e", "chunk": "diff --git a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\nindex 55195d8d92f..ac061f162a8 100644\n--- a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\n+++ b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\n\n@@ -27,6 +27,8 @@ import io.cdap.cdap.common.ApplicationNotFoundException;\n import io.cdap.cdap.common.ConflictException;\n import io.cdap.cdap.common.InvalidArtifactException;\n import io.cdap.cdap.common.NotFoundException;\n+import io.cdap.cdap.common.logging.LogSamplers;\n+import io.cdap.cdap.common.logging.Loggers;\n import io.cdap.cdap.common.service.Retries;\n import io.cdap.cdap.common.service.RetryStrategies;\n import io.cdap.cdap.internal.app.deploy.pipeline.ApplicationWithPrograms;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQ0NzI2OA==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r378447268", "bodyText": "Javadoc is needed for non-trivial public method.", "author": "chtyim", "createdAt": "2020-02-12T18:55:10Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.sysapp;\n+\n+import com.google.common.base.Preconditions;\n+import com.google.gson.Gson;\n+import com.google.inject.Inject;\n+import io.cdap.cdap.api.artifact.ArtifactSummary;\n+import io.cdap.cdap.api.dataset.DatasetManagementException;\n+import io.cdap.cdap.api.retry.RetryableException;\n+import io.cdap.cdap.app.program.ProgramDescriptor;\n+import io.cdap.cdap.common.ApplicationNotFoundException;\n+import io.cdap.cdap.common.ConflictException;\n+import io.cdap.cdap.common.InvalidArtifactException;\n+import io.cdap.cdap.common.NotFoundException;\n+import io.cdap.cdap.common.service.Retries;\n+import io.cdap.cdap.common.service.RetryStrategies;\n+import io.cdap.cdap.internal.app.deploy.pipeline.ApplicationWithPrograms;\n+import io.cdap.cdap.internal.app.services.ApplicationLifecycleService;\n+import io.cdap.cdap.internal.app.services.ProgramLifecycleService;\n+import io.cdap.cdap.internal.sysapp.SystemAppStep.Arguments;\n+import io.cdap.cdap.proto.ProgramStatus;\n+import io.cdap.cdap.proto.id.ApplicationId;\n+import io.cdap.cdap.proto.id.KerberosPrincipalId;\n+import io.cdap.cdap.proto.id.ProgramId;\n+import io.cdap.cdap.security.spi.authorization.UnauthorizedException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.Collections;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * Deploys an application with given arguments. Also runs all programs corresponding to the\n+ * application.\n+ */\n+public class SystemAppEnableExecutor {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(SystemAppEnableExecutor.class);\n+  private static final Gson GSON = new Gson();\n+  private final ApplicationLifecycleService appLifecycleService;\n+  private final ProgramLifecycleService programLifecycleService;\n+\n+  @Inject\n+  SystemAppEnableExecutor(ApplicationLifecycleService appLifecycleService,\n+                          ProgramLifecycleService programLifecycleService) {\n+    this.appLifecycleService = appLifecycleService;\n+    this.programLifecycleService = programLifecycleService;\n+  }\n+\n+  public void deployAppAndStartPrograms(Arguments arguments) {", "originalCommit": "25979d7ef8470eef91a97f829682219eba1262d3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d2fbb2550578c5ecadbfda7de4f312360f752d6e", "chunk": "diff --git a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\nindex 55195d8d92f..ac061f162a8 100644\n--- a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\n+++ b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\n\n@@ -27,6 +27,8 @@ import io.cdap.cdap.common.ApplicationNotFoundException;\n import io.cdap.cdap.common.ConflictException;\n import io.cdap.cdap.common.InvalidArtifactException;\n import io.cdap.cdap.common.NotFoundException;\n+import io.cdap.cdap.common.logging.LogSamplers;\n+import io.cdap.cdap.common.logging.Loggers;\n import io.cdap.cdap.common.service.Retries;\n import io.cdap.cdap.common.service.RetryStrategies;\n import io.cdap.cdap.internal.app.deploy.pipeline.ApplicationWithPrograms;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQ0NzkzNw==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r378447937", "bodyText": "Why starting of the program doesn't take arguments? This means there is no way to alter the runtime arguments via the config?", "author": "chtyim", "createdAt": "2020-02-12T18:56:17Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.sysapp;\n+\n+import com.google.common.base.Preconditions;\n+import com.google.gson.Gson;\n+import com.google.inject.Inject;\n+import io.cdap.cdap.api.artifact.ArtifactSummary;\n+import io.cdap.cdap.api.dataset.DatasetManagementException;\n+import io.cdap.cdap.api.retry.RetryableException;\n+import io.cdap.cdap.app.program.ProgramDescriptor;\n+import io.cdap.cdap.common.ApplicationNotFoundException;\n+import io.cdap.cdap.common.ConflictException;\n+import io.cdap.cdap.common.InvalidArtifactException;\n+import io.cdap.cdap.common.NotFoundException;\n+import io.cdap.cdap.common.service.Retries;\n+import io.cdap.cdap.common.service.RetryStrategies;\n+import io.cdap.cdap.internal.app.deploy.pipeline.ApplicationWithPrograms;\n+import io.cdap.cdap.internal.app.services.ApplicationLifecycleService;\n+import io.cdap.cdap.internal.app.services.ProgramLifecycleService;\n+import io.cdap.cdap.internal.sysapp.SystemAppStep.Arguments;\n+import io.cdap.cdap.proto.ProgramStatus;\n+import io.cdap.cdap.proto.id.ApplicationId;\n+import io.cdap.cdap.proto.id.KerberosPrincipalId;\n+import io.cdap.cdap.proto.id.ProgramId;\n+import io.cdap.cdap.security.spi.authorization.UnauthorizedException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.Collections;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * Deploys an application with given arguments. Also runs all programs corresponding to the\n+ * application.\n+ */\n+public class SystemAppEnableExecutor {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(SystemAppEnableExecutor.class);\n+  private static final Gson GSON = new Gson();\n+  private final ApplicationLifecycleService appLifecycleService;\n+  private final ProgramLifecycleService programLifecycleService;\n+\n+  @Inject\n+  SystemAppEnableExecutor(ApplicationLifecycleService appLifecycleService,\n+                          ProgramLifecycleService programLifecycleService) {\n+    this.appLifecycleService = appLifecycleService;\n+    this.programLifecycleService = programLifecycleService;\n+  }\n+\n+  public void deployAppAndStartPrograms(Arguments arguments) {\n+\n+\n+    // TODO(CDAP-16243): Make deploy app and start programs idempotent to not have transactional issues.\n+    ApplicationWithPrograms appDetail = retryableDeploySystemApp(arguments);\n+    if(appDetail == null) return;\n+\n+    // TODO(CDAP-16243): Fix logic to restart programs for app with difference version/config.\n+    for (ProgramDescriptor program : appDetail.getPrograms()) {\n+      try {\n+        startProgram(program.getProgramId());", "originalCommit": "25979d7ef8470eef91a97f829682219eba1262d3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQ2NTAwOA==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r378465008", "bodyText": "Currently we plan to only use one step for enable an app (which includes deploying app and starting its programs). The ProgramStarter step also only uses programId to start programs (https://github.com/cdapio/cdap/blob/1d62163faaecb5b888f4bccd0fcf4a8d27bbd549/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/bootstrap/executor/ProgramStarter.java). I can  follow up on this offline with you and Albert.", "author": "pandyajay10", "createdAt": "2020-02-12T19:28:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQ0NzkzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQ3MTc0OA==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r378471748", "bodyText": "Discussed with Terrence offline. We can think of adding more steps in system app config for starting specific programs with their arguments. For next step of changes.", "author": "pandyajay10", "createdAt": "2020-02-12T19:41:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQ0NzkzNw=="}], "type": "inlineReview", "revised_code": {"commit": "d2fbb2550578c5ecadbfda7de4f312360f752d6e", "chunk": "diff --git a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\nindex 55195d8d92f..ac061f162a8 100644\n--- a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\n+++ b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\n\n@@ -27,6 +27,8 @@ import io.cdap.cdap.common.ApplicationNotFoundException;\n import io.cdap.cdap.common.ConflictException;\n import io.cdap.cdap.common.InvalidArtifactException;\n import io.cdap.cdap.common.NotFoundException;\n+import io.cdap.cdap.common.logging.LogSamplers;\n+import io.cdap.cdap.common.logging.Loggers;\n import io.cdap.cdap.common.service.Retries;\n import io.cdap.cdap.common.service.RetryStrategies;\n import io.cdap.cdap.internal.app.deploy.pipeline.ApplicationWithPrograms;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQ0ODcxNw==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r378448717", "bodyText": "Is this method contract allows null to be returned? If that's the case, annotate it with @Nullable.", "author": "chtyim", "createdAt": "2020-02-12T18:57:46Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.sysapp;\n+\n+import com.google.common.base.Preconditions;\n+import com.google.gson.Gson;\n+import com.google.inject.Inject;\n+import io.cdap.cdap.api.artifact.ArtifactSummary;\n+import io.cdap.cdap.api.dataset.DatasetManagementException;\n+import io.cdap.cdap.api.retry.RetryableException;\n+import io.cdap.cdap.app.program.ProgramDescriptor;\n+import io.cdap.cdap.common.ApplicationNotFoundException;\n+import io.cdap.cdap.common.ConflictException;\n+import io.cdap.cdap.common.InvalidArtifactException;\n+import io.cdap.cdap.common.NotFoundException;\n+import io.cdap.cdap.common.service.Retries;\n+import io.cdap.cdap.common.service.RetryStrategies;\n+import io.cdap.cdap.internal.app.deploy.pipeline.ApplicationWithPrograms;\n+import io.cdap.cdap.internal.app.services.ApplicationLifecycleService;\n+import io.cdap.cdap.internal.app.services.ProgramLifecycleService;\n+import io.cdap.cdap.internal.sysapp.SystemAppStep.Arguments;\n+import io.cdap.cdap.proto.ProgramStatus;\n+import io.cdap.cdap.proto.id.ApplicationId;\n+import io.cdap.cdap.proto.id.KerberosPrincipalId;\n+import io.cdap.cdap.proto.id.ProgramId;\n+import io.cdap.cdap.security.spi.authorization.UnauthorizedException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.Collections;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * Deploys an application with given arguments. Also runs all programs corresponding to the\n+ * application.\n+ */\n+public class SystemAppEnableExecutor {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(SystemAppEnableExecutor.class);\n+  private static final Gson GSON = new Gson();\n+  private final ApplicationLifecycleService appLifecycleService;\n+  private final ProgramLifecycleService programLifecycleService;\n+\n+  @Inject\n+  SystemAppEnableExecutor(ApplicationLifecycleService appLifecycleService,\n+                          ProgramLifecycleService programLifecycleService) {\n+    this.appLifecycleService = appLifecycleService;\n+    this.programLifecycleService = programLifecycleService;\n+  }\n+\n+  public void deployAppAndStartPrograms(Arguments arguments) {\n+\n+\n+    // TODO(CDAP-16243): Make deploy app and start programs idempotent to not have transactional issues.\n+    ApplicationWithPrograms appDetail = retryableDeploySystemApp(arguments);\n+    if(appDetail == null) return;\n+\n+    // TODO(CDAP-16243): Fix logic to restart programs for app with difference version/config.\n+    for (ProgramDescriptor program : appDetail.getPrograms()) {\n+      try {\n+        startProgram(program.getProgramId());\n+      } catch (Exception ex) {\n+        LOG.error(\"Failed to start program {} for app {} with exception {}\",\n+          program.getProgramId(), arguments.getId(), ex);\n+      }\n+    }\n+  }\n+\n+  private ApplicationWithPrograms retryableDeploySystemApp(Arguments arguments) {", "originalCommit": "25979d7ef8470eef91a97f829682219eba1262d3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d2fbb2550578c5ecadbfda7de4f312360f752d6e", "chunk": "diff --git a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\nindex 55195d8d92f..ac061f162a8 100644\n--- a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\n+++ b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\n\n@@ -27,6 +27,8 @@ import io.cdap.cdap.common.ApplicationNotFoundException;\n import io.cdap.cdap.common.ConflictException;\n import io.cdap.cdap.common.InvalidArtifactException;\n import io.cdap.cdap.common.NotFoundException;\n+import io.cdap.cdap.common.logging.LogSamplers;\n+import io.cdap.cdap.common.logging.Loggers;\n import io.cdap.cdap.common.service.Retries;\n import io.cdap.cdap.common.service.RetryStrategies;\n import io.cdap.cdap.internal.app.deploy.pipeline.ApplicationWithPrograms;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQ1MDM1Mw==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r378450353", "bodyText": "listFiles can return null. Use DirUtils.listFiles instead.", "author": "chtyim", "createdAt": "2020-02-12T19:00:50Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.sysapp;\n+\n+import com.google.common.util.concurrent.AbstractIdleService;\n+import com.google.gson.Gson;\n+import com.google.gson.JsonParseException;\n+import com.google.inject.Inject;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.internal.app.services.ApplicationLifecycleService;\n+import io.cdap.cdap.internal.app.services.ProgramLifecycleService;\n+import org.apache.twill.common.Threads;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.File;\n+import java.io.FileNotFoundException;\n+import java.io.FileReader;\n+import java.io.IOException;\n+import java.io.Reader;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+\n+/**\n+ * Enables system apps using system app config files located in SYSTEM_APP_CONFIG_DIR. Each config\n+ * describes steps to perform to start one (or more) system app. Currently\n+ * SystemAppManagementService runs during bootstrap phase.\n+ */\n+public class SystemAppManagementService extends AbstractIdleService {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(SystemAppManagementService.class);\n+  private static final Gson GSON = new Gson();\n+\n+  private final File systemAppConfigDirPath;\n+  private final SystemAppEnableExecutor systemAppEnableExecutor;\n+  private ExecutorService executorService;\n+\n+  @Inject\n+  SystemAppManagementService(CConfiguration cConf, ApplicationLifecycleService appLifecycleService,\n+                             ProgramLifecycleService programLifecycleService) {\n+    this.systemAppConfigDirPath = new File(cConf.get(Constants.SYSTEM_APP_CONFIG_DIR));\n+    this.systemAppEnableExecutor = new SystemAppEnableExecutor(appLifecycleService,\n+        programLifecycleService);\n+  }\n+\n+  @Override\n+  protected void startUp() {\n+    LOG.debug(\"Starting {}\", getClass().getSimpleName());\n+    executorService = Executors\n+        .newSingleThreadExecutor(Threads.createDaemonThreadFactory(\"sys-app-management-service\"));\n+    executorService.execute(() -> {\n+      try {\n+        // Execute all steps for each config file in system config directory.\n+        bootStrapSystemAppConfigDir();\n+      } catch (Exception ex) {\n+        LOG.error(\"Got exception in watch service for system app config dir\", ex);\n+      }\n+    });\n+  }\n+\n+  private void bootStrapSystemAppConfigDir() throws Exception {\n+    LOG.debug(\"Number of config files {} in system app config directory.\",\n+        systemAppConfigDirPath.listFiles().length);\n+\n+    for (File sysAppConfigFile : systemAppConfigDirPath.listFiles()) {", "originalCommit": "25979d7ef8470eef91a97f829682219eba1262d3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d2fbb2550578c5ecadbfda7de4f312360f752d6e", "chunk": "diff --git a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java\nindex fd12be1bbd1..96e49d500a4 100644\n--- a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java\n+++ b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java\n\n@@ -22,6 +22,7 @@ import com.google.gson.JsonParseException;\n import com.google.inject.Inject;\n import io.cdap.cdap.common.conf.CConfiguration;\n import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.utils.DirUtils;\n import io.cdap.cdap.internal.app.services.ApplicationLifecycleService;\n import io.cdap.cdap.internal.app.services.ProgramLifecycleService;\n import org.apache.twill.common.Threads;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQ1MTEwNA==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r378451104", "bodyText": "Log with the exception, not just the e.getMessage. Otherwise the stacktrace will be lost and hard to find the root cause.", "author": "chtyim", "createdAt": "2020-02-12T19:02:19Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.sysapp;\n+\n+import com.google.common.util.concurrent.AbstractIdleService;\n+import com.google.gson.Gson;\n+import com.google.gson.JsonParseException;\n+import com.google.inject.Inject;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.internal.app.services.ApplicationLifecycleService;\n+import io.cdap.cdap.internal.app.services.ProgramLifecycleService;\n+import org.apache.twill.common.Threads;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.File;\n+import java.io.FileNotFoundException;\n+import java.io.FileReader;\n+import java.io.IOException;\n+import java.io.Reader;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+\n+/**\n+ * Enables system apps using system app config files located in SYSTEM_APP_CONFIG_DIR. Each config\n+ * describes steps to perform to start one (or more) system app. Currently\n+ * SystemAppManagementService runs during bootstrap phase.\n+ */\n+public class SystemAppManagementService extends AbstractIdleService {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(SystemAppManagementService.class);\n+  private static final Gson GSON = new Gson();\n+\n+  private final File systemAppConfigDirPath;\n+  private final SystemAppEnableExecutor systemAppEnableExecutor;\n+  private ExecutorService executorService;\n+\n+  @Inject\n+  SystemAppManagementService(CConfiguration cConf, ApplicationLifecycleService appLifecycleService,\n+                             ProgramLifecycleService programLifecycleService) {\n+    this.systemAppConfigDirPath = new File(cConf.get(Constants.SYSTEM_APP_CONFIG_DIR));\n+    this.systemAppEnableExecutor = new SystemAppEnableExecutor(appLifecycleService,\n+        programLifecycleService);\n+  }\n+\n+  @Override\n+  protected void startUp() {\n+    LOG.debug(\"Starting {}\", getClass().getSimpleName());\n+    executorService = Executors\n+        .newSingleThreadExecutor(Threads.createDaemonThreadFactory(\"sys-app-management-service\"));\n+    executorService.execute(() -> {\n+      try {\n+        // Execute all steps for each config file in system config directory.\n+        bootStrapSystemAppConfigDir();\n+      } catch (Exception ex) {\n+        LOG.error(\"Got exception in watch service for system app config dir\", ex);\n+      }\n+    });\n+  }\n+\n+  private void bootStrapSystemAppConfigDir() throws Exception {\n+    LOG.debug(\"Number of config files {} in system app config directory.\",\n+        systemAppConfigDirPath.listFiles().length);\n+\n+    for (File sysAppConfigFile : systemAppConfigDirPath.listFiles()) {\n+      LOG.debug(\"Running steps in config file {}\", sysAppConfigFile.getAbsoluteFile());\n+      executeSysConfig(sysAppConfigFile.getAbsoluteFile());\n+    }\n+  }\n+\n+  private void executeSysConfig(File fileName) throws Exception {\n+    SystemAppConfig config = parseConfig(fileName);\n+    for (SystemAppStep step : config.getSteps()) {\n+      try {\n+        step.validate();\n+      } catch (IllegalArgumentException e) {\n+        LOG.warn(\"Config step {} failed because it is malformed: {}\", step.getLabel(),", "originalCommit": "25979d7ef8470eef91a97f829682219eba1262d3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d2fbb2550578c5ecadbfda7de4f312360f752d6e", "chunk": "diff --git a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java\nindex fd12be1bbd1..96e49d500a4 100644\n--- a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java\n+++ b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java\n\n@@ -22,6 +22,7 @@ import com.google.gson.JsonParseException;\n import com.google.inject.Inject;\n import io.cdap.cdap.common.conf.CConfiguration;\n import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.utils.DirUtils;\n import io.cdap.cdap.internal.app.services.ApplicationLifecycleService;\n import io.cdap.cdap.internal.app.services.ProgramLifecycleService;\n import org.apache.twill.common.Threads;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQ1MTYxNg==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r378451616", "bodyText": "I don't think you need a double try. Just normal try-catch would do it.", "author": "chtyim", "createdAt": "2020-02-12T19:03:16Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.sysapp;\n+\n+import com.google.common.util.concurrent.AbstractIdleService;\n+import com.google.gson.Gson;\n+import com.google.gson.JsonParseException;\n+import com.google.inject.Inject;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.internal.app.services.ApplicationLifecycleService;\n+import io.cdap.cdap.internal.app.services.ProgramLifecycleService;\n+import org.apache.twill.common.Threads;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.File;\n+import java.io.FileNotFoundException;\n+import java.io.FileReader;\n+import java.io.IOException;\n+import java.io.Reader;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+\n+/**\n+ * Enables system apps using system app config files located in SYSTEM_APP_CONFIG_DIR. Each config\n+ * describes steps to perform to start one (or more) system app. Currently\n+ * SystemAppManagementService runs during bootstrap phase.\n+ */\n+public class SystemAppManagementService extends AbstractIdleService {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(SystemAppManagementService.class);\n+  private static final Gson GSON = new Gson();\n+\n+  private final File systemAppConfigDirPath;\n+  private final SystemAppEnableExecutor systemAppEnableExecutor;\n+  private ExecutorService executorService;\n+\n+  @Inject\n+  SystemAppManagementService(CConfiguration cConf, ApplicationLifecycleService appLifecycleService,\n+                             ProgramLifecycleService programLifecycleService) {\n+    this.systemAppConfigDirPath = new File(cConf.get(Constants.SYSTEM_APP_CONFIG_DIR));\n+    this.systemAppEnableExecutor = new SystemAppEnableExecutor(appLifecycleService,\n+        programLifecycleService);\n+  }\n+\n+  @Override\n+  protected void startUp() {\n+    LOG.debug(\"Starting {}\", getClass().getSimpleName());\n+    executorService = Executors\n+        .newSingleThreadExecutor(Threads.createDaemonThreadFactory(\"sys-app-management-service\"));\n+    executorService.execute(() -> {\n+      try {\n+        // Execute all steps for each config file in system config directory.\n+        bootStrapSystemAppConfigDir();\n+      } catch (Exception ex) {\n+        LOG.error(\"Got exception in watch service for system app config dir\", ex);\n+      }\n+    });\n+  }\n+\n+  private void bootStrapSystemAppConfigDir() throws Exception {\n+    LOG.debug(\"Number of config files {} in system app config directory.\",\n+        systemAppConfigDirPath.listFiles().length);\n+\n+    for (File sysAppConfigFile : systemAppConfigDirPath.listFiles()) {\n+      LOG.debug(\"Running steps in config file {}\", sysAppConfigFile.getAbsoluteFile());\n+      executeSysConfig(sysAppConfigFile.getAbsoluteFile());\n+    }\n+  }\n+\n+  private void executeSysConfig(File fileName) throws Exception {\n+    SystemAppConfig config = parseConfig(fileName);\n+    for (SystemAppStep step : config.getSteps()) {\n+      try {\n+        step.validate();\n+      } catch (IllegalArgumentException e) {\n+        LOG.warn(\"Config step {} failed because it is malformed: {}\", step.getLabel(),\n+            e.getMessage());\n+        return;\n+      }\n+      if (step.getType() == SystemAppStep.Type.ENABLE_SYSTEM_APP) {\n+        systemAppEnableExecutor.deployAppAndStartPrograms(step.getArguments());\n+        LOG.debug(\"Deployed and enabled system app with id {} and label {}. Config file: {}.\",\n+            step.getArguments().getId(), step.getLabel(), fileName);\n+      } else {\n+        LOG.warn(\"Unknown system app step type {} for step label {}. Config file: {}. Ignoring it.\",\n+            step.getLabel(), step.getType(), fileName);\n+      }\n+    }\n+  }\n+\n+  private SystemAppConfig parseConfig(File fileName) {\n+    try {", "originalCommit": "25979d7ef8470eef91a97f829682219eba1262d3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d2fbb2550578c5ecadbfda7de4f312360f752d6e", "chunk": "diff --git a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java\nindex fd12be1bbd1..96e49d500a4 100644\n--- a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java\n+++ b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java\n\n@@ -22,6 +22,7 @@ import com.google.gson.JsonParseException;\n import com.google.inject.Inject;\n import io.cdap.cdap.common.conf.CConfiguration;\n import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.utils.DirUtils;\n import io.cdap.cdap.internal.app.services.ApplicationLifecycleService;\n import io.cdap.cdap.internal.app.services.ProgramLifecycleService;\n import org.apache.twill.common.Threads;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQ1MjY4Mg==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r378452682", "bodyText": "These logs during shutdown seems a bit too much.", "author": "chtyim", "createdAt": "2020-02-12T19:05:24Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.sysapp;\n+\n+import com.google.common.util.concurrent.AbstractIdleService;\n+import com.google.gson.Gson;\n+import com.google.gson.JsonParseException;\n+import com.google.inject.Inject;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.internal.app.services.ApplicationLifecycleService;\n+import io.cdap.cdap.internal.app.services.ProgramLifecycleService;\n+import org.apache.twill.common.Threads;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.File;\n+import java.io.FileNotFoundException;\n+import java.io.FileReader;\n+import java.io.IOException;\n+import java.io.Reader;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+\n+/**\n+ * Enables system apps using system app config files located in SYSTEM_APP_CONFIG_DIR. Each config\n+ * describes steps to perform to start one (or more) system app. Currently\n+ * SystemAppManagementService runs during bootstrap phase.\n+ */\n+public class SystemAppManagementService extends AbstractIdleService {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(SystemAppManagementService.class);\n+  private static final Gson GSON = new Gson();\n+\n+  private final File systemAppConfigDirPath;\n+  private final SystemAppEnableExecutor systemAppEnableExecutor;\n+  private ExecutorService executorService;\n+\n+  @Inject\n+  SystemAppManagementService(CConfiguration cConf, ApplicationLifecycleService appLifecycleService,\n+                             ProgramLifecycleService programLifecycleService) {\n+    this.systemAppConfigDirPath = new File(cConf.get(Constants.SYSTEM_APP_CONFIG_DIR));\n+    this.systemAppEnableExecutor = new SystemAppEnableExecutor(appLifecycleService,\n+        programLifecycleService);\n+  }\n+\n+  @Override\n+  protected void startUp() {\n+    LOG.debug(\"Starting {}\", getClass().getSimpleName());\n+    executorService = Executors\n+        .newSingleThreadExecutor(Threads.createDaemonThreadFactory(\"sys-app-management-service\"));\n+    executorService.execute(() -> {\n+      try {\n+        // Execute all steps for each config file in system config directory.\n+        bootStrapSystemAppConfigDir();\n+      } catch (Exception ex) {\n+        LOG.error(\"Got exception in watch service for system app config dir\", ex);\n+      }\n+    });\n+  }\n+\n+  private void bootStrapSystemAppConfigDir() throws Exception {\n+    LOG.debug(\"Number of config files {} in system app config directory.\",\n+        systemAppConfigDirPath.listFiles().length);\n+\n+    for (File sysAppConfigFile : systemAppConfigDirPath.listFiles()) {\n+      LOG.debug(\"Running steps in config file {}\", sysAppConfigFile.getAbsoluteFile());\n+      executeSysConfig(sysAppConfigFile.getAbsoluteFile());\n+    }\n+  }\n+\n+  private void executeSysConfig(File fileName) throws Exception {\n+    SystemAppConfig config = parseConfig(fileName);\n+    for (SystemAppStep step : config.getSteps()) {\n+      try {\n+        step.validate();\n+      } catch (IllegalArgumentException e) {\n+        LOG.warn(\"Config step {} failed because it is malformed: {}\", step.getLabel(),\n+            e.getMessage());\n+        return;\n+      }\n+      if (step.getType() == SystemAppStep.Type.ENABLE_SYSTEM_APP) {\n+        systemAppEnableExecutor.deployAppAndStartPrograms(step.getArguments());\n+        LOG.debug(\"Deployed and enabled system app with id {} and label {}. Config file: {}.\",\n+            step.getArguments().getId(), step.getLabel(), fileName);\n+      } else {\n+        LOG.warn(\"Unknown system app step type {} for step label {}. Config file: {}. Ignoring it.\",\n+            step.getLabel(), step.getType(), fileName);\n+      }\n+    }\n+  }\n+\n+  private SystemAppConfig parseConfig(File fileName) {\n+    try {\n+      try (Reader reader = new FileReader(fileName)) {\n+        return GSON.fromJson(reader, SystemAppConfig.class);\n+      }\n+    } catch (FileNotFoundException e) {\n+      LOG.info(\"System app config file {} does not exist.\",\n+          fileName);\n+      return SystemAppConfig.EMPTY;\n+    } catch (JsonParseException e) {\n+      LOG.warn(\"Could not parse system app config file {}.\",\n+          fileName, e);\n+      return SystemAppConfig.EMPTY;\n+    } catch (IOException e) {\n+      LOG.warn(\"Could not system app config file {}.\",\n+          fileName, e);\n+      return SystemAppConfig.EMPTY;\n+    }\n+  }\n+\n+  @Override\n+  protected void shutDown() throws Exception {\n+    LOG.debug(\"Stopping {}\", getClass().getSimpleName());", "originalCommit": "25979d7ef8470eef91a97f829682219eba1262d3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d2fbb2550578c5ecadbfda7de4f312360f752d6e", "chunk": "diff --git a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java\nindex fd12be1bbd1..96e49d500a4 100644\n--- a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java\n+++ b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java\n\n@@ -22,6 +22,7 @@ import com.google.gson.JsonParseException;\n import com.google.inject.Inject;\n import io.cdap.cdap.common.conf.CConfiguration;\n import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.utils.DirUtils;\n import io.cdap.cdap.internal.app.services.ApplicationLifecycleService;\n import io.cdap.cdap.internal.app.services.ProgramLifecycleService;\n import org.apache.twill.common.Threads;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQ1MjkyMg==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r378452922", "bodyText": "Why the full name?", "author": "chtyim", "createdAt": "2020-02-12T19:05:50Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppStep.java", "diffHunk": "@@ -0,0 +1,114 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.sysapp;\n+\n+import com.google.gson.JsonObject;\n+import com.google.gson.annotations.SerializedName;\n+import io.cdap.cdap.proto.artifact.AppRequest;\n+import io.cdap.cdap.proto.id.ApplicationId;\n+import io.cdap.cdap.proto.id.NamespaceId;\n+\n+/**\n+ * Definition for a single step in a system app config. Defines what operation to perform for a\n+ * system app and any arguments required to perform the operation.\n+ */\n+public class SystemAppStep {\n+\n+  private final String label;\n+  private final Type type;\n+  private final Arguments arguments;\n+\n+  public SystemAppStep(String label, Type type, Arguments arguments) {\n+    this.label = label;\n+    this.type = type;\n+    this.arguments = arguments;\n+  }\n+\n+  public String getLabel() {\n+    return label;\n+  }\n+\n+  public io.cdap.cdap.internal.sysapp.SystemAppStep.Type getType() {", "originalCommit": "25979d7ef8470eef91a97f829682219eba1262d3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d2fbb2550578c5ecadbfda7de4f312360f752d6e", "chunk": "diff --git a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppStep.java b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppStep.java\nindex 6a07a8d9b00..85049ade0d9 100644\n--- a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppStep.java\n+++ b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppStep.java\n\n@@ -17,7 +17,6 @@\n package io.cdap.cdap.internal.sysapp;\n \n import com.google.gson.JsonObject;\n-import com.google.gson.annotations.SerializedName;\n import io.cdap.cdap.proto.artifact.AppRequest;\n import io.cdap.cdap.proto.id.ApplicationId;\n import io.cdap.cdap.proto.id.NamespaceId;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQ2ODk3OA==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r378468978", "bodyText": "indentation", "author": "albertshau", "createdAt": "2020-02-12T19:36:12Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java", "diffHunk": "@@ -51,50 +54,55 @@\n public class SystemAppEnableExecutor {\n \n   private static final Logger LOG = LoggerFactory.getLogger(SystemAppEnableExecutor.class);\n+  private static final Logger LIMITED_LOGGER = Loggers\n+      .sampling(LOG, LogSamplers.limitRate(TimeUnit.SECONDS.toMillis(100)));", "originalCommit": "af755f0251c1dad6b841a29f5ca24d2f07761d31", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d2fbb2550578c5ecadbfda7de4f312360f752d6e", "chunk": "diff --git a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\nindex c0717a5b091..ac061f162a8 100644\n--- a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\n+++ b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\n\n@@ -55,7 +55,7 @@ public class SystemAppEnableExecutor {\n \n   private static final Logger LOG = LoggerFactory.getLogger(SystemAppEnableExecutor.class);\n   private static final Logger LIMITED_LOGGER = Loggers\n-      .sampling(LOG, LogSamplers.limitRate(TimeUnit.SECONDS.toMillis(100)));\n+    .sampling(LOG, LogSamplers.limitRate(TimeUnit.SECONDS.toMillis(100)));\n \n   private static final Gson GSON = new Gson();\n   private final ApplicationLifecycleService appLifecycleService;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQ2OTAxMg==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r378469012", "bodyText": "indentation", "author": "albertshau", "createdAt": "2020-02-12T19:36:16Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java", "diffHunk": "@@ -51,50 +54,55 @@\n public class SystemAppEnableExecutor {\n \n   private static final Logger LOG = LoggerFactory.getLogger(SystemAppEnableExecutor.class);\n+  private static final Logger LIMITED_LOGGER = Loggers\n+      .sampling(LOG, LogSamplers.limitRate(TimeUnit.SECONDS.toMillis(100)));\n+\n   private static final Gson GSON = new Gson();\n   private final ApplicationLifecycleService appLifecycleService;\n   private final ProgramLifecycleService programLifecycleService;\n \n   @Inject\n   SystemAppEnableExecutor(ApplicationLifecycleService appLifecycleService,\n-                          ProgramLifecycleService programLifecycleService) {\n+      ProgramLifecycleService programLifecycleService) {", "originalCommit": "af755f0251c1dad6b841a29f5ca24d2f07761d31", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQ2OTg4MA==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r378469880", "bodyText": "same comment for the rest of the changes, earlier fixes look like they were undone.", "author": "albertshau", "createdAt": "2020-02-12T19:37:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQ2OTAxMg=="}], "type": "inlineReview", "revised_code": {"commit": "d2fbb2550578c5ecadbfda7de4f312360f752d6e", "chunk": "diff --git a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\nindex c0717a5b091..ac061f162a8 100644\n--- a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\n+++ b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\n\n@@ -55,7 +55,7 @@ public class SystemAppEnableExecutor {\n \n   private static final Logger LOG = LoggerFactory.getLogger(SystemAppEnableExecutor.class);\n   private static final Logger LIMITED_LOGGER = Loggers\n-      .sampling(LOG, LogSamplers.limitRate(TimeUnit.SECONDS.toMillis(100)));\n+    .sampling(LOG, LogSamplers.limitRate(TimeUnit.SECONDS.toMillis(100)));\n \n   private static final Gson GSON = new Gson();\n   private final ApplicationLifecycleService appLifecycleService;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQ2OTIzNg==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r378469236", "bodyText": "indentation", "author": "albertshau", "createdAt": "2020-02-12T19:36:40Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java", "diffHunk": "@@ -51,50 +54,55 @@\n public class SystemAppEnableExecutor {\n \n   private static final Logger LOG = LoggerFactory.getLogger(SystemAppEnableExecutor.class);\n+  private static final Logger LIMITED_LOGGER = Loggers\n+      .sampling(LOG, LogSamplers.limitRate(TimeUnit.SECONDS.toMillis(100)));\n+\n   private static final Gson GSON = new Gson();\n   private final ApplicationLifecycleService appLifecycleService;\n   private final ProgramLifecycleService programLifecycleService;\n \n   @Inject\n   SystemAppEnableExecutor(ApplicationLifecycleService appLifecycleService,\n-                          ProgramLifecycleService programLifecycleService) {\n+      ProgramLifecycleService programLifecycleService) {\n     this.appLifecycleService = appLifecycleService;\n     this.programLifecycleService = programLifecycleService;\n   }\n \n+  /**\n+   * Deploys an application with given arguments and starts all its programs.\n+   */\n   public void deployAppAndStartPrograms(Arguments arguments) {\n-\n-\n     // TODO(CDAP-16243): Make deploy app and start programs idempotent to not have transactional issues.\n     ApplicationWithPrograms appDetail = retryableDeploySystemApp(arguments);\n-    if(appDetail == null) return;\n+    if (appDetail == null) {\n+      return;\n+    }\n \n     // TODO(CDAP-16243): Fix logic to restart programs for app with difference version/config.\n     for (ProgramDescriptor program : appDetail.getPrograms()) {\n       try {\n         startProgram(program.getProgramId());\n       } catch (Exception ex) {\n         LOG.error(\"Failed to start program {} for app {} with exception {}\",\n-          program.getProgramId(), arguments.getId(), ex);\n+            program.getProgramId(), arguments.getId(), ex);", "originalCommit": "af755f0251c1dad6b841a29f5ca24d2f07761d31", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d2fbb2550578c5ecadbfda7de4f312360f752d6e", "chunk": "diff --git a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\nindex c0717a5b091..ac061f162a8 100644\n--- a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\n+++ b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\n\n@@ -55,7 +55,7 @@ public class SystemAppEnableExecutor {\n \n   private static final Logger LOG = LoggerFactory.getLogger(SystemAppEnableExecutor.class);\n   private static final Logger LIMITED_LOGGER = Loggers\n-      .sampling(LOG, LogSamplers.limitRate(TimeUnit.SECONDS.toMillis(100)));\n+    .sampling(LOG, LogSamplers.limitRate(TimeUnit.SECONDS.toMillis(100)));\n \n   private static final Gson GSON = new Gson();\n   private final ApplicationLifecycleService appLifecycleService;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQ3MDczMg==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r378470732", "bodyText": "you can leave out the finally if you do:\ntry (BufferedWriter bw = new BufferedWriter(...)) {\n  ...\n}", "author": "albertshau", "createdAt": "2020-02-12T19:39:35Z", "path": "cdap-app-fabric/src/test/java/io/cdap/cdap/internal/sysapp/SystemAppManagementServiceTest.java", "diffHunk": "@@ -76,36 +76,30 @@ public static void setup() throws IOException {\n     programLifecycleService = injector.getInstance(ProgramLifecycleService.class);\n     applicationLifecycleService = injector.getInstance(ApplicationLifecycleService.class);\n     cConf = injector.getInstance(CConfiguration.class);\n-    systemConfigDir = TEMPORARY_FOLDER.newFolder(\"demo-sys-app-config-dir\");\n-    cConf.set(Constants.SYSTEM_APP_CONFIG_DIR, systemConfigDir.getAbsolutePath());\n-    systemAppManagementService = new SystemAppManagementService(cConf, applicationLifecycleService,\n-                                                                programLifecycleService);\n   }\n \n   @AfterClass\n   public static void tearDown() throws Exception {\n     systemAppManagementService.shutDown();\n   }\n \n-  @After\n-  public void cleanupTest() {\n-    FileUtils.deleteDirectoryContents(systemConfigDir);\n-  }\n-\n   private void createEnableSysAppConfigFile(Id.Artifact artifactId, String filename) throws IOException {\n-    AppRequest<JsonObject> appRequest = new AppRequest<>(\n-        new ArtifactSummary(artifactId.getName(), artifactId.getVersion().getVersion()));\n+    AppRequest<JsonObject> appRequest = new AppRequest<>(new ArtifactSummary(artifactId.getName(),\n+      artifactId.getVersion().getVersion()));\n     SystemAppStep.Arguments step1Argument = new SystemAppStep.Arguments(\n-        appRequest, artifactId.getNamespace().getId(), artifactId.getName(), false);\n+      appRequest, artifactId.getNamespace().getId(), artifactId.getName(), false);\n     List<SystemAppStep> steps = new ArrayList<>();\n     steps.add(\n-        new SystemAppStep(\"step for \" + artifactId.getName(), SystemAppStep.Type.ENABLE_SYSTEM_APP,\n-            step1Argument));\n+      new SystemAppStep(\"step for \" + artifactId.getName(), SystemAppStep.Type.ENABLE_SYSTEM_APP, step1Argument));\n     SystemAppConfig config = new SystemAppConfig(steps);\n     File tmpFile = new File(systemConfigDir, filename);\n     BufferedWriter bw = new BufferedWriter(new FileWriter(tmpFile));\n-    bw.write(GSON.toJson(config));\n-    bw.flush();\n+    try {", "originalCommit": "af755f0251c1dad6b841a29f5ca24d2f07761d31", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQ3MTE3OQ==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r378471179", "bodyText": "I believe the flush is also done automatically on close, so it may not be needed", "author": "albertshau", "createdAt": "2020-02-12T19:40:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQ3MDczMg=="}], "type": "inlineReview", "revised_code": {"commit": "d2fbb2550578c5ecadbfda7de4f312360f752d6e", "chunk": "diff --git a/cdap-app-fabric/src/test/java/io/cdap/cdap/internal/sysapp/SystemAppManagementServiceTest.java b/cdap-app-fabric/src/test/java/io/cdap/cdap/internal/sysapp/SystemAppManagementServiceTest.java\nindex 82316f20a2e..0064f1156cd 100644\n--- a/cdap-app-fabric/src/test/java/io/cdap/cdap/internal/sysapp/SystemAppManagementServiceTest.java\n+++ b/cdap-app-fabric/src/test/java/io/cdap/cdap/internal/sysapp/SystemAppManagementServiceTest.java\n\n@@ -85,20 +85,16 @@ public class SystemAppManagementServiceTest extends AppFabricTestBase {\n \n   private void createEnableSysAppConfigFile(Id.Artifact artifactId, String filename) throws IOException {\n     AppRequest<JsonObject> appRequest = new AppRequest<>(new ArtifactSummary(artifactId.getName(),\n-      artifactId.getVersion().getVersion()));\n-    SystemAppStep.Arguments step1Argument = new SystemAppStep.Arguments(\n-      appRequest, artifactId.getNamespace().getId(), artifactId.getName(), false);\n+                                                         artifactId.getVersion().getVersion()));\n+    SystemAppStep.Arguments step1Argument =\n+      new SystemAppStep.Arguments(appRequest, artifactId.getNamespace().getId(), artifactId.getName(), false);\n     List<SystemAppStep> steps = new ArrayList<>();\n     steps.add(\n       new SystemAppStep(\"step for \" + artifactId.getName(), SystemAppStep.Type.ENABLE_SYSTEM_APP, step1Argument));\n     SystemAppConfig config = new SystemAppConfig(steps);\n     File tmpFile = new File(systemConfigDir, filename);\n-    BufferedWriter bw = new BufferedWriter(new FileWriter(tmpFile));\n-    try {\n+    try (BufferedWriter bw = new BufferedWriter(new FileWriter(tmpFile))) {\n       bw.write(GSON.toJson(config));\n-      bw.flush();\n-    } finally {\n-      bw.close();\n     }\n   }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQ4OTUzNA==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r378489534", "bodyText": "style: when there is a newline in the middle of a method call, arguments should line up with the previous line.", "author": "albertshau", "createdAt": "2020-02-12T20:17:07Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java", "diffHunk": "@@ -84,7 +84,7 @@ public void deployAppAndStartPrograms(Arguments arguments) {\n         startProgram(program.getProgramId());\n       } catch (Exception ex) {\n         LOG.error(\"Failed to start program {} for app {} with exception {}\",\n-            program.getProgramId(), arguments.getId(), ex);", "originalCommit": "c09541e4912432876f03256f00a10978d58ca07e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d2fbb2550578c5ecadbfda7de4f312360f752d6e", "chunk": "diff --git a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\nindex 432562aee1e..ac061f162a8 100644\n--- a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\n+++ b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\n\n@@ -83,8 +83,7 @@ public class SystemAppEnableExecutor {\n       try {\n         startProgram(program.getProgramId());\n       } catch (Exception ex) {\n-        LOG.error(\"Failed to start program {} for app {} with exception {}\",\n-          program.getProgramId(), arguments.getId(), ex);\n+        LOG.error(\"Failed to start program {} for app {}.\", program.getProgramId(), arguments.getId(), ex);\n       }\n     }\n   }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQ4OTcyNw==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r378489727", "bodyText": "here it's correct to do 2 space indent since it's not in the middle of a method call", "author": "albertshau", "createdAt": "2020-02-12T20:17:33Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java", "diffHunk": "@@ -112,17 +112,14 @@ private ApplicationWithPrograms deploySystemApp(Arguments arguments) throws Exce\n     ArtifactSummary artifactSummary = arguments.getArtifact();\n \n     KerberosPrincipalId ownerPrincipalId =\n-        arguments.getOwnerPrincipal() == null ? null\n-            : new KerberosPrincipalId(arguments.getOwnerPrincipal());\n+      arguments.getOwnerPrincipal() == null ? null : new KerberosPrincipalId(arguments.getOwnerPrincipal());", "originalCommit": "c09541e4912432876f03256f00a10978d58ca07e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU1OTc4MQ==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r378559781", "bodyText": "Oh ok. In this case the whole line came into 1 single line <120 chars so just made a one line.", "author": "pandyajay10", "createdAt": "2020-02-12T22:52:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQ4OTcyNw=="}], "type": "inlineReview", "revised_code": {"commit": "d2fbb2550578c5ecadbfda7de4f312360f752d6e", "chunk": "diff --git a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\nindex 432562aee1e..ac061f162a8 100644\n--- a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\n+++ b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\n\n@@ -119,7 +118,9 @@ public class SystemAppEnableExecutor {\n \n     try {\n       return appLifecycleService.deployApp(appId.getParent(), appId.getApplication(), appId.getVersion(),\n-        artifactSummary, configString, x -> { }, ownerPrincipalId, arguments.canUpdateSchedules());\n+                                           artifactSummary, configString, x -> { },\n+                                           ownerPrincipalId, arguments.canUpdateSchedules());\n+\n     } catch (NotFoundException | UnauthorizedException | InvalidArtifactException e) {\n       throw e;\n     } catch (DatasetManagementException e) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU2NzAyOA==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r378567028", "bodyText": "extra space after return", "author": "albertshau", "createdAt": "2020-02-12T23:12:40Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java", "diffHunk": "@@ -0,0 +1,155 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.sysapp;\n+\n+import com.google.common.base.Preconditions;\n+import com.google.gson.Gson;\n+import com.google.inject.Inject;\n+import io.cdap.cdap.api.artifact.ArtifactSummary;\n+import io.cdap.cdap.api.dataset.DatasetManagementException;\n+import io.cdap.cdap.api.retry.RetryableException;\n+import io.cdap.cdap.app.program.ProgramDescriptor;\n+import io.cdap.cdap.common.ApplicationNotFoundException;\n+import io.cdap.cdap.common.ConflictException;\n+import io.cdap.cdap.common.InvalidArtifactException;\n+import io.cdap.cdap.common.NotFoundException;\n+import io.cdap.cdap.common.logging.LogSamplers;\n+import io.cdap.cdap.common.logging.Loggers;\n+import io.cdap.cdap.common.service.Retries;\n+import io.cdap.cdap.common.service.RetryStrategies;\n+import io.cdap.cdap.internal.app.deploy.pipeline.ApplicationWithPrograms;\n+import io.cdap.cdap.internal.app.services.ApplicationLifecycleService;\n+import io.cdap.cdap.internal.app.services.ProgramLifecycleService;\n+import io.cdap.cdap.internal.sysapp.SystemAppStep.Arguments;\n+import io.cdap.cdap.proto.ProgramStatus;\n+import io.cdap.cdap.proto.id.ApplicationId;\n+import io.cdap.cdap.proto.id.KerberosPrincipalId;\n+import io.cdap.cdap.proto.id.ProgramId;\n+import io.cdap.cdap.security.spi.authorization.UnauthorizedException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.Collections;\n+import java.util.concurrent.TimeUnit;\n+import javax.annotation.Nullable;\n+\n+/**\n+ * Deploys an application with given arguments. Also runs all programs corresponding to the\n+ * application.\n+ */\n+public class SystemAppEnableExecutor {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(SystemAppEnableExecutor.class);\n+  private static final Logger LIMITED_LOGGER = Loggers\n+    .sampling(LOG, LogSamplers.limitRate(TimeUnit.SECONDS.toMillis(100)));\n+\n+  private static final Gson GSON = new Gson();\n+  private final ApplicationLifecycleService appLifecycleService;\n+  private final ProgramLifecycleService programLifecycleService;\n+\n+  @Inject\n+  SystemAppEnableExecutor(ApplicationLifecycleService appLifecycleService,\n+                          ProgramLifecycleService programLifecycleService) {\n+    this.appLifecycleService = appLifecycleService;\n+    this.programLifecycleService = programLifecycleService;\n+  }\n+\n+  /**\n+   * Deploys an application with given arguments and starts all its programs.\n+   */\n+  public void deployAppAndStartPrograms(Arguments arguments) {\n+    // TODO(CDAP-16243): Make deploy app and start programs idempotent to not have transactional issues.\n+    ApplicationWithPrograms appDetail = retryableDeploySystemApp(arguments);\n+    if (appDetail == null) {\n+      return;\n+    }\n+\n+    // TODO(CDAP-16243): Fix logic to restart programs for app with difference version/config.\n+    for (ProgramDescriptor program : appDetail.getPrograms()) {\n+      try {\n+        startProgram(program.getProgramId());\n+      } catch (Exception ex) {\n+        LOG.error(\"Failed to start program {} for app {}.\", program.getProgramId(), arguments.getId(), ex);\n+      }\n+    }\n+  }\n+\n+  @Nullable\n+  private ApplicationWithPrograms retryableDeploySystemApp(Arguments arguments) {\n+    try {\n+      return Retries.callWithRetries(() -> {\n+        try {\n+          return deploySystemApp(arguments);\n+        } catch (RetryableException ex) {\n+          LIMITED_LOGGER.debug(\"Failed to deploy app {}. Will retry\", arguments.getId(), ex);\n+          throw ex;\n+        }\n+      },\n+      RetryStrategies.fixDelay(6, TimeUnit.SECONDS));\n+    } catch (Exception ex) {\n+      LOG.error(\"Failed to deploy app {} with exception\", arguments.getId(), ex);\n+      return null;\n+    }\n+  }\n+\n+  private ApplicationWithPrograms deploySystemApp(Arguments arguments) throws Exception {\n+    ApplicationId appId = arguments.getId();\n+    ArtifactSummary artifactSummary = arguments.getArtifact();\n+\n+    KerberosPrincipalId ownerPrincipalId =\n+      arguments.getOwnerPrincipal() == null ? null : new KerberosPrincipalId(arguments.getOwnerPrincipal());\n+\n+    // if we don't null check, it gets serialized to \"null\"\n+    String configString = arguments.getConfig() == null ? null : GSON.toJson(arguments.getConfig());\n+\n+    try {\n+      return  appLifecycleService.deployApp(appId.getParent(), appId.getApplication(), appId.getVersion(),", "originalCommit": "7d95192455b995c19f3779d2eea5ce5868ebe058", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d2fbb2550578c5ecadbfda7de4f312360f752d6e", "chunk": "diff --git a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\nindex 9d32a31a0c5..ac061f162a8 100644\n--- a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\n+++ b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java\n\n@@ -117,9 +117,9 @@ public class SystemAppEnableExecutor {\n     String configString = arguments.getConfig() == null ? null : GSON.toJson(arguments.getConfig());\n \n     try {\n-      return  appLifecycleService.deployApp(appId.getParent(), appId.getApplication(), appId.getVersion(),\n-                                            artifactSummary, configString, x -> { },\n-                                            ownerPrincipalId, arguments.canUpdateSchedules());\n+      return appLifecycleService.deployApp(appId.getParent(), appId.getApplication(), appId.getVersion(),\n+                                           artifactSummary, configString, x -> { },\n+                                           ownerPrincipalId, arguments.canUpdateSchedules());\n \n     } catch (NotFoundException | UnauthorizedException | InvalidArtifactException e) {\n       throw e;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU2NzM0OA==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r378567348", "bodyText": "indentation should be 2 spaces", "author": "albertshau", "createdAt": "2020-02-12T23:13:28Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java", "diffHunk": "@@ -0,0 +1,126 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.sysapp;\n+\n+import com.google.common.util.concurrent.AbstractIdleService;\n+import com.google.gson.Gson;\n+import com.google.gson.JsonParseException;\n+import com.google.inject.Inject;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.utils.DirUtils;\n+import io.cdap.cdap.internal.app.services.ApplicationLifecycleService;\n+import io.cdap.cdap.internal.app.services.ProgramLifecycleService;\n+import org.apache.twill.common.Threads;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.File;\n+import java.io.FileNotFoundException;\n+import java.io.FileReader;\n+import java.io.IOException;\n+import java.io.Reader;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+\n+/**\n+ * Enables system apps using system app config files located in SYSTEM_APP_CONFIG_DIR. Each config\n+ * describes steps to perform to start one (or more) system app. Currently\n+ * SystemAppManagementService runs during bootstrap phase.\n+ */\n+public class SystemAppManagementService extends AbstractIdleService {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(SystemAppManagementService.class);\n+  private static final Gson GSON = new Gson();\n+\n+  private final File systemAppConfigDirPath;\n+  private final SystemAppEnableExecutor systemAppEnableExecutor;\n+  private ExecutorService executorService;\n+\n+  @Inject\n+  SystemAppManagementService(CConfiguration cConf, ApplicationLifecycleService appLifecycleService,\n+                             ProgramLifecycleService programLifecycleService) {\n+    this.systemAppConfigDirPath = new File(cConf.get(Constants.SYSTEM_APP_CONFIG_DIR));\n+    this.systemAppEnableExecutor = new SystemAppEnableExecutor(appLifecycleService, programLifecycleService);\n+  }\n+\n+  @Override\n+  protected void startUp() {\n+    LOG.debug(\"Starting {}\", getClass().getSimpleName());\n+    executorService =\n+        Executors.newSingleThreadExecutor(Threads.createDaemonThreadFactory(\"sys-app-management-service\"));", "originalCommit": "7d95192455b995c19f3779d2eea5ce5868ebe058", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d2fbb2550578c5ecadbfda7de4f312360f752d6e", "chunk": "diff --git a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java\nindex 74ac90f5e9a..96e49d500a4 100644\n--- a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java\n+++ b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppManagementService.java\n\n@@ -62,7 +62,7 @@ public class SystemAppManagementService extends AbstractIdleService {\n   protected void startUp() {\n     LOG.debug(\"Starting {}\", getClass().getSimpleName());\n     executorService =\n-        Executors.newSingleThreadExecutor(Threads.createDaemonThreadFactory(\"sys-app-management-service\"));\n+      Executors.newSingleThreadExecutor(Threads.createDaemonThreadFactory(\"sys-app-management-service\"));\n     executorService.execute(() -> {\n       try {\n         // Execute all steps for each config file in system config directory.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU2NzQ2Nw==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r378567467", "bodyText": "indentation alignment", "author": "albertshau", "createdAt": "2020-02-12T23:13:48Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppStep.java", "diffHunk": "@@ -0,0 +1,113 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.sysapp;\n+\n+import com.google.gson.JsonObject;\n+import io.cdap.cdap.proto.artifact.AppRequest;\n+import io.cdap.cdap.proto.id.ApplicationId;\n+import io.cdap.cdap.proto.id.NamespaceId;\n+\n+/**\n+ * Definition for a single step in a system app config. Defines what operation to perform for a\n+ * system app and any arguments required to perform the operation.\n+ */\n+public class SystemAppStep {\n+\n+  private final String label;\n+  private final Type type;\n+  private final Arguments arguments;\n+\n+  public SystemAppStep(String label, Type type, Arguments arguments) {\n+    this.label = label;\n+    this.type = type;\n+    this.arguments = arguments;\n+  }\n+\n+  public String getLabel() {\n+    return label;\n+  }\n+\n+  public Type getType() {\n+    return type;\n+  }\n+\n+  public Arguments getArguments() {\n+    return arguments;\n+  }\n+\n+  /**\n+   * Validate that all required fields exist.\n+   *\n+   * @throws IllegalArgumentException if the step is invalid\n+   */\n+  public void validate() {\n+    if (label == null || label.isEmpty()) {\n+      throw new IllegalArgumentException(\"An accelerator step must contain a label.\");\n+    }\n+\n+    if (type == null) {\n+      throw new IllegalArgumentException(\"An accelerator step must contain a type.\");\n+    }\n+\n+    arguments.validate();\n+  }\n+\n+  /**\n+   * System app step type\n+   */\n+  public enum Type {\n+    ENABLE_SYSTEM_APP\n+  }\n+\n+  /**\n+   * Arguments required to create an application\n+   */\n+  static class Arguments extends AppRequest<JsonObject> {\n+\n+    private String namespace;\n+    private String name;\n+    private boolean overwrite;\n+\n+    Arguments(AppRequest<JsonObject> appRequest, String namespace, String name, boolean overwrite) {\n+      super(appRequest.getArtifact(), appRequest.getConfig(), appRequest.getPreview(),\n+          appRequest.getOwnerPrincipal(),", "originalCommit": "7d95192455b995c19f3779d2eea5ce5868ebe058", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d2fbb2550578c5ecadbfda7de4f312360f752d6e", "chunk": "diff --git a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppStep.java b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppStep.java\nindex 88dd3bb9d99..85049ade0d9 100644\n--- a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppStep.java\n+++ b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppStep.java\n\n@@ -84,8 +84,8 @@ public class SystemAppStep {\n \n     Arguments(AppRequest<JsonObject> appRequest, String namespace, String name, boolean overwrite) {\n       super(appRequest.getArtifact(), appRequest.getConfig(), appRequest.getPreview(),\n-          appRequest.getOwnerPrincipal(),\n-          appRequest.canUpdateSchedules());\n+            appRequest.getOwnerPrincipal(),\n+            appRequest.canUpdateSchedules());\n       this.namespace = namespace;\n       this.name = name;\n       this.overwrite = overwrite;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU2NzUzNQ==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r378567535", "bodyText": "indentation should be 2 spaces", "author": "albertshau", "createdAt": "2020-02-12T23:14:03Z", "path": "cdap-app-fabric/src/test/java/io/cdap/cdap/internal/sysapp/SystemAppManagementServiceTest.java", "diffHunk": "@@ -0,0 +1,126 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.sysapp;\n+\n+import com.google.gson.Gson;\n+import com.google.gson.JsonObject;\n+import com.google.inject.Injector;\n+import io.cdap.cdap.AllProgramsApp;\n+import io.cdap.cdap.api.artifact.ArtifactSummary;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.id.Id;\n+import io.cdap.cdap.internal.app.services.ApplicationLifecycleService;\n+import io.cdap.cdap.internal.app.services.ProgramLifecycleService;\n+import io.cdap.cdap.internal.app.services.http.AppFabricTestBase;\n+import io.cdap.cdap.proto.ProgramType;\n+import io.cdap.cdap.proto.artifact.AppRequest;\n+import io.cdap.cdap.proto.id.ApplicationId;\n+import io.cdap.cdap.proto.id.NamespaceId;\n+import io.cdap.cdap.proto.id.ProgramId;\n+import org.iq80.leveldb.util.FileUtils;\n+import org.junit.After;\n+import org.junit.AfterClass;\n+import org.junit.Assert;\n+import org.junit.BeforeClass;\n+import org.junit.ClassRule;\n+import org.junit.Test;\n+import org.junit.rules.TemporaryFolder;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.BufferedWriter;\n+import java.io.File;\n+import java.io.FileWriter;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+/**\n+ * Tests for the {@link SystemAppManagementService}.\n+ */\n+public class SystemAppManagementServiceTest extends AppFabricTestBase {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(SystemAppManagementServiceTest.class);\n+  private static final Gson GSON = new Gson();\n+\n+  private static ProgramLifecycleService programLifecycleService;\n+  private static ApplicationLifecycleService applicationLifecycleService;\n+  private static CConfiguration cConf;\n+  private static SystemAppManagementService systemAppManagementService;\n+  private static File systemConfigDir;\n+\n+  private static final String RUNNING = \"RUNNING\";\n+\n+  @ClassRule\n+  public static final TemporaryFolder TEMPORARY_FOLDER = new TemporaryFolder();\n+\n+\n+  @BeforeClass\n+  public static void setup() throws IOException {\n+    Injector injector = getInjector();\n+    programLifecycleService = injector.getInstance(ProgramLifecycleService.class);\n+    applicationLifecycleService = injector.getInstance(ApplicationLifecycleService.class);\n+    cConf = injector.getInstance(CConfiguration.class);\n+  }\n+\n+  @AfterClass\n+  public static void tearDown() throws Exception {\n+    systemAppManagementService.shutDown();\n+  }\n+\n+  private void createEnableSysAppConfigFile(Id.Artifact artifactId, String filename) throws IOException {\n+    AppRequest<JsonObject> appRequest = new AppRequest<>(new ArtifactSummary(artifactId.getName(),\n+                                                         artifactId.getVersion().getVersion()));\n+    SystemAppStep.Arguments step1Argument =\n+        new SystemAppStep.Arguments(appRequest, artifactId.getNamespace().getId(), artifactId.getName(), false);", "originalCommit": "7d95192455b995c19f3779d2eea5ce5868ebe058", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d2fbb2550578c5ecadbfda7de4f312360f752d6e", "chunk": "diff --git a/cdap-app-fabric/src/test/java/io/cdap/cdap/internal/sysapp/SystemAppManagementServiceTest.java b/cdap-app-fabric/src/test/java/io/cdap/cdap/internal/sysapp/SystemAppManagementServiceTest.java\nindex 074b07dcfca..0064f1156cd 100644\n--- a/cdap-app-fabric/src/test/java/io/cdap/cdap/internal/sysapp/SystemAppManagementServiceTest.java\n+++ b/cdap-app-fabric/src/test/java/io/cdap/cdap/internal/sysapp/SystemAppManagementServiceTest.java\n\n@@ -87,7 +87,7 @@ public class SystemAppManagementServiceTest extends AppFabricTestBase {\n     AppRequest<JsonObject> appRequest = new AppRequest<>(new ArtifactSummary(artifactId.getName(),\n                                                          artifactId.getVersion().getVersion()));\n     SystemAppStep.Arguments step1Argument =\n-        new SystemAppStep.Arguments(appRequest, artifactId.getNamespace().getId(), artifactId.getName(), false);\n+      new SystemAppStep.Arguments(appRequest, artifactId.getNamespace().getId(), artifactId.getName(), false);\n     List<SystemAppStep> steps = new ArrayList<>();\n     steps.add(\n       new SystemAppStep(\"step for \" + artifactId.getName(), SystemAppStep.Type.ENABLE_SYSTEM_APP, step1Argument));\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU2NzYxOQ==", "url": "https://github.com/cdapio/cdap/pull/11861#discussion_r378567619", "bodyText": "indentation alignment", "author": "albertshau", "createdAt": "2020-02-12T23:14:19Z", "path": "cdap-app-fabric/src/test/java/io/cdap/cdap/internal/sysapp/SystemAppManagementServiceTest.java", "diffHunk": "@@ -0,0 +1,126 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.sysapp;\n+\n+import com.google.gson.Gson;\n+import com.google.gson.JsonObject;\n+import com.google.inject.Injector;\n+import io.cdap.cdap.AllProgramsApp;\n+import io.cdap.cdap.api.artifact.ArtifactSummary;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.id.Id;\n+import io.cdap.cdap.internal.app.services.ApplicationLifecycleService;\n+import io.cdap.cdap.internal.app.services.ProgramLifecycleService;\n+import io.cdap.cdap.internal.app.services.http.AppFabricTestBase;\n+import io.cdap.cdap.proto.ProgramType;\n+import io.cdap.cdap.proto.artifact.AppRequest;\n+import io.cdap.cdap.proto.id.ApplicationId;\n+import io.cdap.cdap.proto.id.NamespaceId;\n+import io.cdap.cdap.proto.id.ProgramId;\n+import org.iq80.leveldb.util.FileUtils;\n+import org.junit.After;\n+import org.junit.AfterClass;\n+import org.junit.Assert;\n+import org.junit.BeforeClass;\n+import org.junit.ClassRule;\n+import org.junit.Test;\n+import org.junit.rules.TemporaryFolder;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.BufferedWriter;\n+import java.io.File;\n+import java.io.FileWriter;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+/**\n+ * Tests for the {@link SystemAppManagementService}.\n+ */\n+public class SystemAppManagementServiceTest extends AppFabricTestBase {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(SystemAppManagementServiceTest.class);\n+  private static final Gson GSON = new Gson();\n+\n+  private static ProgramLifecycleService programLifecycleService;\n+  private static ApplicationLifecycleService applicationLifecycleService;\n+  private static CConfiguration cConf;\n+  private static SystemAppManagementService systemAppManagementService;\n+  private static File systemConfigDir;\n+\n+  private static final String RUNNING = \"RUNNING\";\n+\n+  @ClassRule\n+  public static final TemporaryFolder TEMPORARY_FOLDER = new TemporaryFolder();\n+\n+\n+  @BeforeClass\n+  public static void setup() throws IOException {\n+    Injector injector = getInjector();\n+    programLifecycleService = injector.getInstance(ProgramLifecycleService.class);\n+    applicationLifecycleService = injector.getInstance(ApplicationLifecycleService.class);\n+    cConf = injector.getInstance(CConfiguration.class);\n+  }\n+\n+  @AfterClass\n+  public static void tearDown() throws Exception {\n+    systemAppManagementService.shutDown();\n+  }\n+\n+  private void createEnableSysAppConfigFile(Id.Artifact artifactId, String filename) throws IOException {\n+    AppRequest<JsonObject> appRequest = new AppRequest<>(new ArtifactSummary(artifactId.getName(),\n+                                                         artifactId.getVersion().getVersion()));\n+    SystemAppStep.Arguments step1Argument =\n+        new SystemAppStep.Arguments(appRequest, artifactId.getNamespace().getId(), artifactId.getName(), false);\n+    List<SystemAppStep> steps = new ArrayList<>();\n+    steps.add(\n+      new SystemAppStep(\"step for \" + artifactId.getName(), SystemAppStep.Type.ENABLE_SYSTEM_APP, step1Argument));\n+    SystemAppConfig config = new SystemAppConfig(steps);\n+    File tmpFile = new File(systemConfigDir, filename);\n+    try (BufferedWriter bw = new BufferedWriter(new FileWriter(tmpFile))) {\n+      bw.write(GSON.toJson(config));\n+    }\n+  }\n+\n+  /**\n+   * Tests SystemAppManagementService end to end by running below scenario:\n+   * 1. Creates a system app config for an application into corresponding directory.\n+   * 2. Successfully read and load the config.\n+   * 3. Runs all steps to enable a system app , tests SystemAppEnableExecutor.\n+   * 4. Deploys the app.\n+   * 5. Runs all programs corresponding to the app.\n+   * 6. Checks status of a continuously running program, i.e a service program.\n+   * @throws Exception\n+   */\n+  @Test\n+  public void testSystemAppManagementServiceE2E() throws Exception {\n+    systemConfigDir = TEMPORARY_FOLDER.newFolder(\"demo-sys-app-config-dir\");\n+    cConf.set(Constants.SYSTEM_APP_CONFIG_DIR, systemConfigDir.getAbsolutePath());\n+    systemAppManagementService = new SystemAppManagementService(cConf, applicationLifecycleService,\n+      programLifecycleService);", "originalCommit": "7d95192455b995c19f3779d2eea5ce5868ebe058", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d2fbb2550578c5ecadbfda7de4f312360f752d6e", "chunk": "diff --git a/cdap-app-fabric/src/test/java/io/cdap/cdap/internal/sysapp/SystemAppManagementServiceTest.java b/cdap-app-fabric/src/test/java/io/cdap/cdap/internal/sysapp/SystemAppManagementServiceTest.java\nindex 074b07dcfca..0064f1156cd 100644\n--- a/cdap-app-fabric/src/test/java/io/cdap/cdap/internal/sysapp/SystemAppManagementServiceTest.java\n+++ b/cdap-app-fabric/src/test/java/io/cdap/cdap/internal/sysapp/SystemAppManagementServiceTest.java\n\n@@ -87,7 +87,7 @@ public class SystemAppManagementServiceTest extends AppFabricTestBase {\n     AppRequest<JsonObject> appRequest = new AppRequest<>(new ArtifactSummary(artifactId.getName(),\n                                                          artifactId.getVersion().getVersion()));\n     SystemAppStep.Arguments step1Argument =\n-        new SystemAppStep.Arguments(appRequest, artifactId.getNamespace().getId(), artifactId.getName(), false);\n+      new SystemAppStep.Arguments(appRequest, artifactId.getNamespace().getId(), artifactId.getName(), false);\n     List<SystemAppStep> steps = new ArrayList<>();\n     steps.add(\n       new SystemAppStep(\"step for \" + artifactId.getName(), SystemAppStep.Type.ENABLE_SYSTEM_APP, step1Argument));\n"}}, {"oid": "d2fbb2550578c5ecadbfda7de4f312360f752d6e", "url": "https://github.com/cdapio/cdap/commit/d2fbb2550578c5ecadbfda7de4f312360f752d6e", "message": "(CDAP-16243) Support for config based bootstrapping for system application on CDAP\n\nAdding support for bootstrapping system apps using separate config files\n\nAdding support for bootstrapping system apps using separate config files. Looks for config files during app fabric start in a given directory. Ideally one separate file for one application. Runs steps (currently only ENABLE_SYSTEM_APP step) for the application. Deploys and starts program for each application.\n\nThis will be basis for dynamic start/stop of system apps.", "committedDate": "2020-02-13T01:06:05Z", "type": "commit"}, {"oid": "d2fbb2550578c5ecadbfda7de4f312360f752d6e", "url": "https://github.com/cdapio/cdap/commit/d2fbb2550578c5ecadbfda7de4f312360f752d6e", "message": "(CDAP-16243) Support for config based bootstrapping for system application on CDAP\n\nAdding support for bootstrapping system apps using separate config files\n\nAdding support for bootstrapping system apps using separate config files. Looks for config files during app fabric start in a given directory. Ideally one separate file for one application. Runs steps (currently only ENABLE_SYSTEM_APP step) for the application. Deploys and starts program for each application.\n\nThis will be basis for dynamic start/stop of system apps.", "committedDate": "2020-02-13T01:06:05Z", "type": "forcePushed"}]}