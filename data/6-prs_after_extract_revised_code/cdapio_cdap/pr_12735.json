{"pr_number": 12735, "pr_title": "(CDAP-17218) Launch Preview Runner pods using TwillRunner", "pr_createdAt": "2020-08-28T20:31:29Z", "pr_url": "https://github.com/cdapio/cdap/pull/12735", "timeline": [{"oid": "cd7756f6f7e2d91b8ecd4cdb2381d2af7e5c93ce", "url": "https://github.com/cdapio/cdap/commit/cd7756f6f7e2d91b8ecd4cdb2381d2af7e5c93ce", "message": "Distributed Preview runner via k8s twill", "committedDate": "2020-08-29T07:25:23Z", "type": "forcePushed"}, {"oid": "bacdac5a7b749481bfc4023dd5248861bb590114", "url": "https://github.com/cdapio/cdap/commit/bacdac5a7b749481bfc4023dd5248861bb590114", "message": "Added setting of priority class for preview runner", "committedDate": "2020-08-31T06:39:27Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU5MTM4OA==", "url": "https://github.com/cdapio/cdap/pull/12735#discussion_r479591388", "bodyText": "2016-2020?", "author": "sagarkapare", "createdAt": "2020-08-29T01:36:19Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/PreviewRunnerModule.java", "diffHunk": "@@ -1,5 +1,5 @@\n /*\n- * Copyright \u00a9 2020 Cask Data, Inc.\n+ * Copyright \u00a9 2016-2019 Cask Data, Inc.", "originalCommit": "6e6b9d84ae765cc25489aae14312103867fe37ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQwODYxMw==", "url": "https://github.com/cdapio/cdap/pull/12735#discussion_r481408613", "bodyText": "fixed", "author": "chtyim", "createdAt": "2020-09-01T20:22:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU5MTM4OA=="}], "type": "inlineReview", "revised_code": {"commit": "ffd0c11271294c26fbf2e14580f4d58bde8e350e", "chunk": "diff --git a/cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/PreviewRunnerModule.java b/cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/PreviewRunnerModule.java\nindex a626cb22300..5bc55b633dc 100644\n--- a/cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/PreviewRunnerModule.java\n+++ b/cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/PreviewRunnerModule.java\n\n@@ -1,5 +1,5 @@\n /*\n- * Copyright \u00a9 2016-2019 Cask Data, Inc.\n+ * Copyright \u00a9 2016-2020 Cask Data, Inc.\n  *\n  * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n  * use this file except in compliance with the License. You may obtain a copy of\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTI3Nzg1MQ==", "url": "https://github.com/cdapio/cdap/pull/12735#discussion_r481277851", "bodyText": "Should the application name be \"PreviewRunner\"?", "author": "sagarkapare", "createdAt": "2020-09-01T16:28:36Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/preview/PreviewRunnerTwillApplication.java", "diffHunk": "@@ -0,0 +1,54 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.app.preview;\n+\n+import io.cdap.cdap.common.conf.Constants;\n+import org.apache.twill.api.ResourceSpecification;\n+import org.apache.twill.api.TwillApplication;\n+import org.apache.twill.api.TwillSpecification;\n+\n+import java.net.URI;\n+\n+/**\n+ * The {@link TwillApplication} for launch preview runner.\n+ */\n+public class PreviewRunnerTwillApplication implements TwillApplication {\n+\n+  private final URI cConfFileURI;\n+  private final URI hConfFileURI;\n+  private final ResourceSpecification resourceSpec;\n+\n+  public PreviewRunnerTwillApplication(URI cConfFileURI, URI hConfFileURI, ResourceSpecification resourceSpec) {\n+    this.cConfFileURI = cConfFileURI;\n+    this.hConfFileURI = hConfFileURI;\n+    this.resourceSpec = resourceSpec;\n+  }\n+\n+  @Override\n+  public TwillSpecification configure() {\n+    return TwillSpecification.Builder.with()\n+      .setName(Constants.Service.PREVIEW_HTTP)", "originalCommit": "bacdac5a7b749481bfc4023dd5248861bb590114", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQwODE5Mw==", "url": "https://github.com/cdapio/cdap/pull/12735#discussion_r481408193", "bodyText": "changed to preview.runner", "author": "chtyim", "createdAt": "2020-09-01T20:21:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTI3Nzg1MQ=="}], "type": "inlineReview", "revised_code": {"commit": "ffd0c11271294c26fbf2e14580f4d58bde8e350e", "chunk": "diff --git a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/preview/PreviewRunnerTwillApplication.java b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/preview/PreviewRunnerTwillApplication.java\nindex 7c349f0cf6d..08942dd1271 100644\n--- a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/preview/PreviewRunnerTwillApplication.java\n+++ b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/preview/PreviewRunnerTwillApplication.java\n\n@@ -28,6 +28,8 @@ import java.net.URI;\n  */\n public class PreviewRunnerTwillApplication implements TwillApplication {\n \n+  static final String NAME = \"preview.runner\";\n+\n   private final URI cConfFileURI;\n   private final URI hConfFileURI;\n   private final ResourceSpecification resourceSpec;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTI4MTE1MA==", "url": "https://github.com/cdapio/cdap/pull/12735#discussion_r481281150", "bodyText": "Can UID be null?", "author": "sagarkapare", "createdAt": "2020-09-01T16:34:23Z", "path": "cdap-kubernetes/src/main/java/io/cdap/cdap/k8s/runtime/KubeTwillContext.java", "diffHunk": "@@ -190,6 +197,12 @@ public void close() {\n     }\n   }\n \n+  @Nullable", "originalCommit": "bacdac5a7b749481bfc4023dd5248861bb590114", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTMwMzI5MA==", "url": "https://github.com/cdapio/cdap/pull/12735#discussion_r481303290", "bodyText": "It's inherited from the interface, as from the interface definition perspective, it can be.", "author": "chtyim", "createdAt": "2020-09-01T17:11:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTI4MTE1MA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTI4MTY3Nw==", "url": "https://github.com/cdapio/cdap/pull/12735#discussion_r481281677", "bodyText": "This comment is no longer valid now right?", "author": "sagarkapare", "createdAt": "2020-09-01T16:35:15Z", "path": "cdap-kubernetes/src/main/java/io/cdap/cdap/k8s/runtime/KubeTwillController.java", "diffHunk": "@@ -145,6 +146,31 @@ public ResourceReport getResourceReport() {\n     return doRestartInstances(runnable, instanceIds);\n   }\n \n+  @Override\n+  public Future<String> restartInstance(String runnable, int instanceId, String uid) {\n+    CompletableFuture<String> resultFuture = new CompletableFuture<>();\n+    CoreV1Api api = new CoreV1Api(apiClient);\n+\n+    // Only support for stateful set for now\n+    if (!V1StatefulSet.class.equals(resourceType)) {\n+      resultFuture.completeExceptionally(\n+        new UnsupportedOperationException(\"Instance restart by instance id is only supported for statefulsets\"));\n+      return resultFuture;\n+    }\n+\n+    // pod uid is passed as \"runnable\" parameter to the method.", "originalCommit": "bacdac5a7b749481bfc4023dd5248861bb590114", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQwODA5Ng==", "url": "https://github.com/cdapio/cdap/pull/12735#discussion_r481408096", "bodyText": "removed", "author": "chtyim", "createdAt": "2020-09-01T20:21:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTI4MTY3Nw=="}], "type": "inlineReview", "revised_code": {"commit": "ffd0c11271294c26fbf2e14580f4d58bde8e350e", "chunk": "diff --git a/cdap-kubernetes/src/main/java/io/cdap/cdap/k8s/runtime/KubeTwillController.java b/cdap-kubernetes/src/main/java/io/cdap/cdap/k8s/runtime/KubeTwillController.java\nindex 742cf12dbbc..b2ffe5ee5c9 100644\n--- a/cdap-kubernetes/src/main/java/io/cdap/cdap/k8s/runtime/KubeTwillController.java\n+++ b/cdap-kubernetes/src/main/java/io/cdap/cdap/k8s/runtime/KubeTwillController.java\n\n@@ -158,7 +158,6 @@ class KubeTwillController implements ExtendedTwillController {\n       return resultFuture;\n     }\n \n-    // pod uid is passed as \"runnable\" parameter to the method.\n     V1DeleteOptions deleteOptions = new V1DeleteOptions().preconditions(new V1Preconditions().uid(uid));\n     String podName = String.format(\"%s-%d\", meta.getName(), instanceId);\n \n"}}, {"oid": "ffd0c11271294c26fbf2e14580f4d58bde8e350e", "url": "https://github.com/cdapio/cdap/commit/ffd0c11271294c26fbf2e14580f4d58bde8e350e", "message": "(CDAP-17218) Launch Preview Runner Using TwillRunner\n\n- Introduced PreviewRunnerTwillApplication and PreviewRunnerTwillRunnable\n  for starting multiple instances of preview runners in the cluster\n- Fixed preview level db binding to correctly use the preview local data directory\n  instead of using the regular data directory\n- Refactoring of preview related Guice bindings", "committedDate": "2020-09-01T17:31:42Z", "type": "commit"}, {"oid": "ffd0c11271294c26fbf2e14580f4d58bde8e350e", "url": "https://github.com/cdapio/cdap/commit/ffd0c11271294c26fbf2e14580f4d58bde8e350e", "message": "(CDAP-17218) Launch Preview Runner Using TwillRunner\n\n- Introduced PreviewRunnerTwillApplication and PreviewRunnerTwillRunnable\n  for starting multiple instances of preview runners in the cluster\n- Fixed preview level db binding to correctly use the preview local data directory\n  instead of using the regular data directory\n- Refactoring of preview related Guice bindings", "committedDate": "2020-09-01T17:31:42Z", "type": "forcePushed"}]}