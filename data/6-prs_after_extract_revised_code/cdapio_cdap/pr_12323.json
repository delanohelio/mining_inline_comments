{"pr_number": 12323, "pr_title": "Support Dataproc custom Image", "pr_createdAt": "2020-06-12T21:22:17Z", "pr_url": "https://github.com/cdapio/cdap/pull/12323", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY3MTAyMg==", "url": "https://github.com/cdapio/cdap/pull/12323#discussion_r439671022", "bodyText": "Check for not empty string as well.", "author": "chtyim", "createdAt": "2020-06-12T22:48:31Z", "path": "cdap-runtime-ext-dataproc/src/main/java/io/cdap/cdap/runtime/spi/provisioner/dataproc/DataprocClient.java", "diffHunk": "@@ -368,6 +368,24 @@ ClusterOperationMetadata createCluster(String name, String imageVersion, Map<Str\n       clusterProperties.put(\"dataproc:dataproc.monitoring.stackdriver.enable\",\n                             Boolean.toString(conf.isStackdriverMonitoringEnabled()));\n \n+      InstanceGroupConfig.Builder instanceGroupBuilder = InstanceGroupConfig.newBuilder()\n+          .setNumInstances(conf.getWorkerNumNodes())\n+          .setMachineTypeUri(conf.getWorkerMachineType())\n+          .setDiskConfig(DiskConfig.newBuilder()\n+              .setBootDiskSizeGb(conf.getWorkerDiskGB())\n+              .setNumLocalSsds(0)\n+              .build());\n+      //If custom Image URI is specified, use that for cluster creation\n+      if (conf.getCustomImageUri() != null) {", "originalCommit": "006a8ecbf5b1278ae3b06566612a0332cd4d0f19", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c5b124b28f1a09aaa51636b7583434f0eda22853", "chunk": "diff --git a/cdap-runtime-ext-dataproc/src/main/java/io/cdap/cdap/runtime/spi/provisioner/dataproc/DataprocClient.java b/cdap-runtime-ext-dataproc/src/main/java/io/cdap/cdap/runtime/spi/provisioner/dataproc/DataprocClient.java\nindex ecac256a3cc..59227f29053 100644\n--- a/cdap-runtime-ext-dataproc/src/main/java/io/cdap/cdap/runtime/spi/provisioner/dataproc/DataprocClient.java\n+++ b/cdap-runtime-ext-dataproc/src/main/java/io/cdap/cdap/runtime/spi/provisioner/dataproc/DataprocClient.java\n\n@@ -375,16 +375,15 @@ final class DataprocClient implements AutoCloseable {\n               .setBootDiskSizeGb(conf.getWorkerDiskGB())\n               .setNumLocalSsds(0)\n               .build());\n-      //If custom Image URI is specified, use that for cluster creation\n-      if (conf.getCustomImageUri() != null) {\n-        instanceGroupBuilder.setImageUri(conf.getCustomImageUri());\n-      }\n \n       SoftwareConfig.Builder softwareConfigBuilder = SoftwareConfig.newBuilder()\n           .putAllProperties(clusterProperties);\n       //Use image version only if custom Image URI is not specified, otherwise may cause image version conflicts\n-      if (conf.getCustomImageUri() == null) {\n+      if (conf.getCustomImageUri() == null || conf.getCustomImageUri().isEmpty()) {\n         softwareConfigBuilder.setImageVersion(imageVersion);\n+      } else {\n+        //If custom Image URI is specified, use that for cluster creation\n+        instanceGroupBuilder.setImageUri(conf.getCustomImageUri());\n       }\n       ClusterConfig.Builder builder = ClusterConfig.newBuilder()\n         .setEndpointConfig(EndpointConfig.newBuilder()\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY3MTMwNA==", "url": "https://github.com/cdapio/cdap/pull/12323#discussion_r439671304", "bodyText": "Better group this with an else to the if above.", "author": "chtyim", "createdAt": "2020-06-12T22:49:42Z", "path": "cdap-runtime-ext-dataproc/src/main/java/io/cdap/cdap/runtime/spi/provisioner/dataproc/DataprocClient.java", "diffHunk": "@@ -368,6 +368,24 @@ ClusterOperationMetadata createCluster(String name, String imageVersion, Map<Str\n       clusterProperties.put(\"dataproc:dataproc.monitoring.stackdriver.enable\",\n                             Boolean.toString(conf.isStackdriverMonitoringEnabled()));\n \n+      InstanceGroupConfig.Builder instanceGroupBuilder = InstanceGroupConfig.newBuilder()\n+          .setNumInstances(conf.getWorkerNumNodes())\n+          .setMachineTypeUri(conf.getWorkerMachineType())\n+          .setDiskConfig(DiskConfig.newBuilder()\n+              .setBootDiskSizeGb(conf.getWorkerDiskGB())\n+              .setNumLocalSsds(0)\n+              .build());\n+      //If custom Image URI is specified, use that for cluster creation\n+      if (conf.getCustomImageUri() != null) {\n+        instanceGroupBuilder.setImageUri(conf.getCustomImageUri());\n+      }\n+\n+      SoftwareConfig.Builder softwareConfigBuilder = SoftwareConfig.newBuilder()\n+          .putAllProperties(clusterProperties);\n+      //Use image version only if custom Image URI is not specified, otherwise may cause image version conflicts\n+      if (conf.getCustomImageUri() == null) {", "originalCommit": "006a8ecbf5b1278ae3b06566612a0332cd4d0f19", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c5b124b28f1a09aaa51636b7583434f0eda22853", "chunk": "diff --git a/cdap-runtime-ext-dataproc/src/main/java/io/cdap/cdap/runtime/spi/provisioner/dataproc/DataprocClient.java b/cdap-runtime-ext-dataproc/src/main/java/io/cdap/cdap/runtime/spi/provisioner/dataproc/DataprocClient.java\nindex ecac256a3cc..59227f29053 100644\n--- a/cdap-runtime-ext-dataproc/src/main/java/io/cdap/cdap/runtime/spi/provisioner/dataproc/DataprocClient.java\n+++ b/cdap-runtime-ext-dataproc/src/main/java/io/cdap/cdap/runtime/spi/provisioner/dataproc/DataprocClient.java\n\n@@ -375,16 +375,15 @@ final class DataprocClient implements AutoCloseable {\n               .setBootDiskSizeGb(conf.getWorkerDiskGB())\n               .setNumLocalSsds(0)\n               .build());\n-      //If custom Image URI is specified, use that for cluster creation\n-      if (conf.getCustomImageUri() != null) {\n-        instanceGroupBuilder.setImageUri(conf.getCustomImageUri());\n-      }\n \n       SoftwareConfig.Builder softwareConfigBuilder = SoftwareConfig.newBuilder()\n           .putAllProperties(clusterProperties);\n       //Use image version only if custom Image URI is not specified, otherwise may cause image version conflicts\n-      if (conf.getCustomImageUri() == null) {\n+      if (conf.getCustomImageUri() == null || conf.getCustomImageUri().isEmpty()) {\n         softwareConfigBuilder.setImageVersion(imageVersion);\n+      } else {\n+        //If custom Image URI is specified, use that for cluster creation\n+        instanceGroupBuilder.setImageUri(conf.getCustomImageUri());\n       }\n       ClusterConfig.Builder builder = ClusterConfig.newBuilder()\n         .setEndpointConfig(EndpointConfig.newBuilder()\n"}}, {"oid": "c5b124b28f1a09aaa51636b7583434f0eda22853", "url": "https://github.com/cdapio/cdap/commit/c5b124b28f1a09aaa51636b7583434f0eda22853", "message": "Support Dataproc custom Image", "committedDate": "2020-06-13T03:33:35Z", "type": "forcePushed"}, {"oid": "6434484ee3ad04ccb42c1bcdf3591628093ee5cf", "url": "https://github.com/cdapio/cdap/commit/6434484ee3ad04ccb42c1bcdf3591628093ee5cf", "message": "Support Dataproc custom Image", "committedDate": "2020-06-16T18:01:53Z", "type": "commit"}, {"oid": "6434484ee3ad04ccb42c1bcdf3591628093ee5cf", "url": "https://github.com/cdapio/cdap/commit/6434484ee3ad04ccb42c1bcdf3591628093ee5cf", "message": "Support Dataproc custom Image", "committedDate": "2020-06-16T18:01:53Z", "type": "forcePushed"}]}