{"pr_number": 11930, "pr_title": "CDAP-16392 fix joiner fll", "pr_createdAt": "2020-03-06T22:48:23Z", "pr_url": "https://github.com/cdapio/cdap/pull/11930", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIwOTU5MA==", "url": "https://github.com/cdapio/cdap/pull/11930#discussion_r389209590", "bodyText": "is this just for clarity? The behavior seems the same as before?", "author": "albertshau", "createdAt": "2020-03-07T00:59:54Z", "path": "cdap-app-templates/cdap-etl/cdap-etl-core/src/main/java/io/cdap/cdap/etl/lineage/LineageOperationsProcessor.java", "diffHunk": "@@ -197,6 +197,10 @@ private void addMergeOperation(Set<String> stageInputs, Map<String, Operation> p\n \n     List<String> fieldsForJoin = new ArrayList<>();\n     for (String field : fields) {\n+      // for joiner, the field name is prefixed with stage name, needs to calculate this name to query for the origin\n+      // from other stages, but in the inputFields map we should use the original name since the actual name can be\n+      // same from different previous stages\n+      String actualField = field;", "originalCommit": "2ed3115e11f2c19653d5ec7529bfb39285be56d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIxNjkyNQ==", "url": "https://github.com/cdapio/cdap/pull/11930#discussion_r389216925", "bodyText": "No, it is different, actualField is always the short name without the stage prefix, for non-joiner stages, this will be the same as field. For joiner stage, the field is in format ., this actual field will get reassigned to  in later stages. And it will be used to query for processedOperations since the field name there never contains the stage prefix. Will update the comment about this", "author": "yaojiefeng", "createdAt": "2020-03-07T01:59:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIwOTU5MA=="}], "type": "inlineReview", "revised_code": {"commit": "e4c452edbe4c527d43ef071d1ad41bac1689db60", "chunk": "diff --git a/cdap-app-templates/cdap-etl/cdap-etl-core/src/main/java/io/cdap/cdap/etl/lineage/LineageOperationsProcessor.java b/cdap-app-templates/cdap-etl/cdap-etl-core/src/main/java/io/cdap/cdap/etl/lineage/LineageOperationsProcessor.java\nindex 9556d85fd47..695cfaa2e66 100644\n--- a/cdap-app-templates/cdap-etl/cdap-etl-core/src/main/java/io/cdap/cdap/etl/lineage/LineageOperationsProcessor.java\n+++ b/cdap-app-templates/cdap-etl/cdap-etl-core/src/main/java/io/cdap/cdap/etl/lineage/LineageOperationsProcessor.java\n\n@@ -200,6 +200,10 @@ public class LineageOperationsProcessor {\n       // for joiner, the field name is prefixed with stage name, needs to calculate this name to query for the origin\n       // from other stages, but in the inputFields map we should use the original name since the actual name can be\n       // same from different previous stages\n+      // actualField is always the short name without the stage prefix, for non-joiner stages, this will be the\n+      // same as field. For joiner stage, the field is in format <stage-name>.<field-name>, this actual field will\n+      // get reassigned to the <field-name>in later stages. And it will be used to query for processedOperations\n+      // since the field name there never contains the stage prefix.\n       String actualField = field;\n       if (noMergeRequiredStages.contains(currentStage)) {\n         // Current stage is of type JOIN.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIxODc2NQ==", "url": "https://github.com/cdapio/cdap/pull/11930#discussion_r389218765", "bodyText": "this happens in both if and else statements, should we move it out and remove the else?", "author": "albertshau", "createdAt": "2020-03-07T02:19:38Z", "path": "cdap-app-templates/cdap-etl/cdap-etl-core/src/main/java/io/cdap/cdap/etl/lineage/LineageOperationsProcessor.java", "diffHunk": "@@ -211,10 +219,12 @@ private void addMergeOperation(Set<String> stageInputs, Map<String, Operation> p\n         Iterator<String> stageFieldPairIter = Splitter.on(\".\").omitEmptyStrings().trimResults().split(field).iterator();\n         String stageName = stageFieldPairIter.next();\n         if (stageFieldPairIter.hasNext() && stageOperations.keySet().contains(stageName)) {\n-          field = stageFieldPairIter.next();\n+          actualField = stageFieldPairIter.next();\n           fieldsForJoin.add(field);", "originalCommit": "c3323e9cf48c28b4b45a261795ccdb5fcdf9dd59", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e4c452edbe4c527d43ef071d1ad41bac1689db60", "chunk": "diff --git a/cdap-app-templates/cdap-etl/cdap-etl-core/src/main/java/io/cdap/cdap/etl/lineage/LineageOperationsProcessor.java b/cdap-app-templates/cdap-etl/cdap-etl-core/src/main/java/io/cdap/cdap/etl/lineage/LineageOperationsProcessor.java\nindex 64fb7ec0403..695cfaa2e66 100644\n--- a/cdap-app-templates/cdap-etl/cdap-etl-core/src/main/java/io/cdap/cdap/etl/lineage/LineageOperationsProcessor.java\n+++ b/cdap-app-templates/cdap-etl/cdap-etl-core/src/main/java/io/cdap/cdap/etl/lineage/LineageOperationsProcessor.java\n\n@@ -220,15 +220,12 @@ public class LineageOperationsProcessor {\n         String stageName = stageFieldPairIter.next();\n         if (stageFieldPairIter.hasNext() && stageOperations.keySet().contains(stageName)) {\n           actualField = stageFieldPairIter.next();\n-          fieldsForJoin.add(field);\n           List<String> parentStages = findParentStages(stageName);\n           // if this operation field clearly defines a stage name, should just find the origins from that stage,\n           // since we traverse backwards, append the finded parent stages\n           parents.addAll(parentStages);\n-        } else {\n-          // field belongs to one of the operations output from join stage\n-          fieldsForJoin.add(field);\n         }\n+        fieldsForJoin.add(field);\n       }\n       ListIterator<String> parentsIterator = parents.listIterator(parents.size());\n       while (parentsIterator.hasPrevious()) {\n"}}, {"oid": "e4c452edbe4c527d43ef071d1ad41bac1689db60", "url": "https://github.com/cdapio/cdap/commit/e4c452edbe4c527d43ef071d1ad41bac1689db60", "message": "CDAP-16392 fix joiner fll", "committedDate": "2020-03-07T02:32:11Z", "type": "commit"}, {"oid": "e4c452edbe4c527d43ef071d1ad41bac1689db60", "url": "https://github.com/cdapio/cdap/commit/e4c452edbe4c527d43ef071d1ad41bac1689db60", "message": "CDAP-16392 fix joiner fll", "committedDate": "2020-03-07T02:32:11Z", "type": "forcePushed"}]}