{"pr_number": 12898, "pr_title": "CDAP-16527 include field name in casting errors for records", "pr_createdAt": "2020-12-11T21:58:44Z", "pr_url": "https://github.com/cdapio/cdap/pull/12898", "timeline": [{"oid": "d76bac6da422133e5ecf461832cc0461f6ae2ee9", "url": "https://github.com/cdapio/cdap/commit/d76bac6da422133e5ecf461832cc0461f6ae2ee9", "message": "CDAP-16527 include field name is casting errors for records\n\nFor logical type utility methods, including the field name when\nthe type is not as expected.\n\nThis is only required because the builder does not verify that\na valid type is being set for a field. If/when that verification\nis added, this logic can be removed.", "committedDate": "2020-12-11T21:58:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjkxNzgwMQ==", "url": "https://github.com/cdapio/cdap/pull/12898#discussion_r542917801", "bodyText": "Why do we retrow ClassCastException in all other cases, but UnexpectedFormatException here?", "author": "tivv", "createdAt": "2020-12-14T23:19:59Z", "path": "cdap-api-common/src/main/java/io/cdap/cdap/api/data/format/StructuredRecord.java", "diffHunk": "@@ -192,7 +220,12 @@ public BigDecimal getDecimal(String fieldName) {\n       return new BigDecimal(new BigInteger(Bytes.toBytes((ByteBuffer) value)), scale);\n     }\n \n-    return new BigDecimal(new BigInteger((byte[]) value), scale);\n+    try {\n+      return new BigDecimal(new BigInteger((byte[]) value), scale);\n+    } catch (ClassCastException e) {\n+      throw new UnexpectedFormatException(String.format(\"Field '%s' is expected to be a %s, but is a %s.\", fieldName,", "originalCommit": "d76bac6da422133e5ecf461832cc0461f6ae2ee9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjk3MTI0NA==", "url": "https://github.com/cdapio/cdap/pull/12898#discussion_r542971244", "bodyText": "good catch, not intended will change it", "author": "albertshau", "createdAt": "2020-12-15T01:18:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjkxNzgwMQ=="}], "type": "inlineReview", "revised_code": {"commit": "cd725904d737cd8fa42d0faf0ff0fcdab626aa60", "chunk": "diff --git a/cdap-api-common/src/main/java/io/cdap/cdap/api/data/format/StructuredRecord.java b/cdap-api-common/src/main/java/io/cdap/cdap/api/data/format/StructuredRecord.java\nindex 47e42fd1c56..bc4a51c2102 100644\n--- a/cdap-api-common/src/main/java/io/cdap/cdap/api/data/format/StructuredRecord.java\n+++ b/cdap-api-common/src/main/java/io/cdap/cdap/api/data/format/StructuredRecord.java\n\n@@ -223,8 +223,8 @@ public class StructuredRecord implements Serializable {\n     try {\n       return new BigDecimal(new BigInteger((byte[]) value), scale);\n     } catch (ClassCastException e) {\n-      throw new UnexpectedFormatException(String.format(\"Field '%s' is expected to be a %s, but is a %s.\", fieldName,\n-                                                        \"decimal\", value.getClass().getSimpleName()), e);\n+      throw new ClassCastException(String.format(\"Field '%s' is expected to be a decimal, but is a %s.\", fieldName,\n+                                                 value.getClass().getSimpleName()));\n     }\n   }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjkxOTI3MQ==", "url": "https://github.com/cdapio/cdap/pull/12898#discussion_r542919271", "bodyText": "It would be great to test the fix: not only exception type, but message as well. You should be able to use https://junit.org/junit4/javadoc/latest/org/junit/rules/ExpectedException.html to do it.", "author": "tivv", "createdAt": "2020-12-14T23:23:22Z", "path": "cdap-formats/src/test/java/io/cdap/cdap/format/StructuredRecordBuilderTest.java", "diffHunk": "@@ -285,4 +285,25 @@ public void testInvalidPrecision() {\n     Schema schema = Schema.recordOf(\"test\", Schema.Field.of(\"d\", Schema.decimalOf(5, 2)));\n     StructuredRecord.builder(schema).setDecimal(\"d\", new BigDecimal(new BigInteger(\"12341324\"), 2)).build();\n   }\n+\n+  @Test(expected = ClassCastException.class)", "originalCommit": "d76bac6da422133e5ecf461832cc0461f6ae2ee9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjk3MzIyMQ==", "url": "https://github.com/cdapio/cdap/pull/12898#discussion_r542973221", "bodyText": "nice, did not know about this, will update", "author": "albertshau", "createdAt": "2020-12-15T01:23:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjkxOTI3MQ=="}], "type": "inlineReview", "revised_code": {"commit": "cd725904d737cd8fa42d0faf0ff0fcdab626aa60", "chunk": "diff --git a/cdap-formats/src/test/java/io/cdap/cdap/format/StructuredRecordBuilderTest.java b/cdap-formats/src/test/java/io/cdap/cdap/format/StructuredRecordBuilderTest.java\nindex b60a93b85a5..90c15bb02c6 100644\n--- a/cdap-formats/src/test/java/io/cdap/cdap/format/StructuredRecordBuilderTest.java\n+++ b/cdap-formats/src/test/java/io/cdap/cdap/format/StructuredRecordBuilderTest.java\n\n@@ -241,69 +246,90 @@ public class StructuredRecordBuilderTest {\n       Schema.nullableOf(Schema.of(Schema.LogicalType.TIME_MILLIS)))));\n \n     LocalDate date = LocalDate.of(2018, 11, 11);\n-    Assert.assertEquals(date, StructuredRecord.builder(schema).setDate(\"x\", date).build().getDate(\"x\"));\n+    thrown.expect(UnexpectedFormatException.class);\n+    StructuredRecord.builder(schema).setDate(\"x\", date).build().getDate(\"x\");\n   }\n \n-  @Test(expected = UnexpectedFormatException.class)\n+  @Test\n   public void testInvalidDateLogicalType() {\n     Schema schema = Schema.recordOf(\"test\", Schema.Field.of(\"id\", Schema.of(Schema.Type.INT)),\n                                     Schema.Field.of(\"name\", Schema.of(Schema.Type.STRING)),\n                                     Schema.Field.of(\"date\", Schema.of(Schema.LogicalType.DATE)));\n \n     LocalTime expected = LocalTime.now();\n+    thrown.expect(UnexpectedFormatException.class);\n     StructuredRecord.builder(schema).set(\"id\", 1).set(\"name\", \"test\").setTime(\"date\", expected).build();\n   }\n \n-  @Test(expected = UnexpectedFormatException.class)\n+  @Test\n   public void testInvalidTimeLogicalType() {\n     Schema schema = Schema.recordOf(\"test\", Schema.Field.of(\"id\", Schema.of(Schema.Type.INT)),\n                                     Schema.Field.of(\"name\", Schema.of(Schema.Type.STRING)),\n                                     Schema.Field.of(\"time\", Schema.of(Schema.LogicalType.TIME_MILLIS)));\n \n     LocalDate expected = LocalDate.now();\n+    thrown.expect(UnexpectedFormatException.class);\n     StructuredRecord.builder(schema).set(\"id\", 1).set(\"name\", \"test\").setDate(\"time\", expected).build();\n   }\n \n-  @Test(expected = UnexpectedFormatException.class)\n+  @Test\n   public void testInvalidTimestampLogicalType() {\n     Schema schema = Schema.recordOf(\"test\", Schema.Field.of(\"id\", Schema.of(Schema.Type.INT)),\n                                     Schema.Field.of(\"name\", Schema.of(Schema.Type.STRING)),\n                                     Schema.Field.of(\"timestamp\", Schema.of(Schema.LogicalType.TIMESTAMP_MILLIS)));\n \n     LocalDate expected = LocalDate.now();\n+    thrown.expect(UnexpectedFormatException.class);\n     StructuredRecord.builder(schema).set(\"id\", 1).set(\"name\", \"test\").setDate(\"timestamp\", expected).build();\n   }\n \n-  @Test(expected = UnexpectedFormatException.class)\n+  @Test\n   public void testInvalidDecimalScale() {\n     Schema schema = Schema.recordOf(\"test\", Schema.Field.of(\"d\", Schema.decimalOf(5, 2)));\n+    thrown.expect(UnexpectedFormatException.class);\n     StructuredRecord.builder(schema).setDecimal(\"d\", new BigDecimal(new BigInteger(\"1234\"), 1)).build();\n   }\n \n-  @Test(expected = UnexpectedFormatException.class)\n+  @Test\n   public void testInvalidPrecision() {\n     Schema schema = Schema.recordOf(\"test\", Schema.Field.of(\"d\", Schema.decimalOf(5, 2)));\n+    thrown.expect(UnexpectedFormatException.class);\n     StructuredRecord.builder(schema).setDecimal(\"d\", new BigDecimal(new BigInteger(\"12341324\"), 2)).build();\n   }\n \n-  @Test(expected = ClassCastException.class)\n+  @Test\n   public void testUnexpectedDateType() {\n     Schema schema = Schema.recordOf(\"test\", Schema.Field.of(\"x\", Schema.of(Schema.LogicalType.DATE)));\n     StructuredRecord record = StructuredRecord.builder(schema).set(\"x\", 5L).build();\n+    thrown.expect(ClassCastException.class);\n+    thrown.expectMessage(\"Field 'x' is expected to be a date\");\n     record.getDate(\"x\");\n   }\n \n-  @Test(expected = ClassCastException.class)\n+  @Test\n   public void testUnexpectedTimestampType() {\n     Schema schema = Schema.recordOf(\"test\", Schema.Field.of(\"x\", Schema.of(Schema.LogicalType.TIMESTAMP_MILLIS)));\n     StructuredRecord record = StructuredRecord.builder(schema).set(\"x\", \"2020-01-01 12:00:00\").build();\n+    thrown.expect(ClassCastException.class);\n+    thrown.expectMessage(\"Field 'x' is expected to be a timestamp\");\n     record.getTimestamp(\"x\");\n   }\n \n-  @Test(expected = ClassCastException.class)\n+  @Test\n   public void testUnexpectedTimeType() {\n     Schema schema = Schema.recordOf(\"test\", Schema.Field.of(\"x\", Schema.of(Schema.LogicalType.TIME_MICROS)));\n     StructuredRecord record = StructuredRecord.builder(schema).set(\"x\", \"12:00:00\").build();\n+    thrown.expect(ClassCastException.class);\n+    thrown.expectMessage(\"Field 'x' is expected to be a time\");\n     record.getTime(\"x\");\n   }\n+\n+  @Test\n+  public void testUnexpectedDecimalType() {\n+    Schema schema = Schema.recordOf(\"test\", Schema.Field.of(\"x\", Schema.decimalOf(5, 3)));\n+    StructuredRecord record = StructuredRecord.builder(schema).set(\"x\", \"5.3\").build();\n+    thrown.expect(ClassCastException.class);\n+    thrown.expectMessage(\"Field 'x' is expected to be a decimal\");\n+    record.getDecimal(\"x\");\n+  }\n }\n"}}, {"oid": "cd725904d737cd8fa42d0faf0ff0fcdab626aa60", "url": "https://github.com/cdapio/cdap/commit/cd725904d737cd8fa42d0faf0ff0fcdab626aa60", "message": "CDAP-16527 fix decimal getter and check messages in tests", "committedDate": "2020-12-15T01:30:49Z", "type": "commit"}]}