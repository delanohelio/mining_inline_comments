{"pr_number": 11957, "pr_title": "CDAP-16431 write empty fll instead of NPE", "pr_createdAt": "2020-03-13T19:40:20Z", "pr_url": "https://github.com/cdapio/cdap/pull/11957", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQzNTkxMA==", "url": "https://github.com/cdapio/cdap/pull/11957#discussion_r392435910", "bodyText": "It looks like we also assume all map values are non-null. That is not correct and should also be guarded against.", "author": "albertshau", "createdAt": "2020-03-13T19:48:55Z", "path": "cdap-app-templates/cdap-etl/cdap-etl-core/src/main/java/io/cdap/cdap/etl/lineage/FieldLineageProcessor.java", "diffHunk": "@@ -70,6 +70,12 @@ public FieldLineageProcessor(PipelineSpec pipelineSpec) {\n     for (StageSpec stageSpec : pipelineSpec.getStages()) {\n \n       Map<String, Schema> inputSchemas = stageSpec.getInputSchemas();\n+      // workaround to avoid NPE if the schema is not set\n+      // TODO: CDAP-16428 populate the schema if macro is enabled to avoid this\n+      if (inputSchemas == null || inputSchemas.isEmpty()) {", "originalCommit": "9b55b74051f26d84873371e66b5c2d4f58327af9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9778be46b61022a74545a8ffa9a23c9f25561c4c", "chunk": "diff --git a/cdap-app-templates/cdap-etl/cdap-etl-core/src/main/java/io/cdap/cdap/etl/lineage/FieldLineageProcessor.java b/cdap-app-templates/cdap-etl/cdap-etl-core/src/main/java/io/cdap/cdap/etl/lineage/FieldLineageProcessor.java\nindex ec69e1f8074..1e8d971be2b 100644\n--- a/cdap-app-templates/cdap-etl/cdap-etl-core/src/main/java/io/cdap/cdap/etl/lineage/FieldLineageProcessor.java\n+++ b/cdap-app-templates/cdap-etl/cdap-etl-core/src/main/java/io/cdap/cdap/etl/lineage/FieldLineageProcessor.java\n\n@@ -81,16 +81,18 @@ public class FieldLineageProcessor {\n       List<String> stageOutputs = new ArrayList<>();\n       if (BatchJoiner.PLUGIN_TYPE.equals(stageSpec.getPlugin().getType())) {\n         for (Map.Entry<String, Schema> entry : inputSchemas.entrySet()) {\n-          if (entry.getValue().getFields() != null) {\n-            stageInputs.addAll(entry.getValue().getFields()\n+          Schema schema = entry.getValue();\n+          if (schema != null && schema.getFields() != null) {\n+            stageInputs.addAll(schema.getFields()\n                                  .stream().map(field -> entry.getKey() + \".\" + field.getName())\n                                  .collect(Collectors.toList()));\n           }\n         }\n       } else {\n         for (Map.Entry<String, Schema> entry : inputSchemas.entrySet()) {\n-          if (entry.getValue().getFields() != null) {\n-            stageInputs.addAll(entry.getValue().getFields().stream().map(Schema.Field::getName)\n+          Schema schema = entry.getValue();\n+          if (schema != null && schema.getFields() != null) {\n+            stageInputs.addAll(schema.getFields().stream().map(Schema.Field::getName)\n                                  .collect(Collectors.toList()));\n           }\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQ1Mjg1NQ==", "url": "https://github.com/cdapio/cdap/pull/11957#discussion_r392452855", "bodyText": "nit: more readable to do entry.getValue() once and re-use it everywhere else.", "author": "albertshau", "createdAt": "2020-03-13T20:27:03Z", "path": "cdap-app-templates/cdap-etl/cdap-etl-core/src/main/java/io/cdap/cdap/etl/lineage/FieldLineageProcessor.java", "diffHunk": "@@ -81,15 +81,15 @@ public FieldLineageProcessor(PipelineSpec pipelineSpec) {\n       List<String> stageOutputs = new ArrayList<>();\n       if (BatchJoiner.PLUGIN_TYPE.equals(stageSpec.getPlugin().getType())) {\n         for (Map.Entry<String, Schema> entry : inputSchemas.entrySet()) {\n-          if (entry.getValue().getFields() != null) {\n+          if (entry.getValue() != null && entry.getValue().getFields() != null) {", "originalCommit": "39926d287c0ddcf46d887c24fe70eea7cada3733", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9778be46b61022a74545a8ffa9a23c9f25561c4c", "chunk": "diff --git a/cdap-app-templates/cdap-etl/cdap-etl-core/src/main/java/io/cdap/cdap/etl/lineage/FieldLineageProcessor.java b/cdap-app-templates/cdap-etl/cdap-etl-core/src/main/java/io/cdap/cdap/etl/lineage/FieldLineageProcessor.java\nindex c01b36b3c01..1e8d971be2b 100644\n--- a/cdap-app-templates/cdap-etl/cdap-etl-core/src/main/java/io/cdap/cdap/etl/lineage/FieldLineageProcessor.java\n+++ b/cdap-app-templates/cdap-etl/cdap-etl-core/src/main/java/io/cdap/cdap/etl/lineage/FieldLineageProcessor.java\n\n@@ -81,16 +81,18 @@ public class FieldLineageProcessor {\n       List<String> stageOutputs = new ArrayList<>();\n       if (BatchJoiner.PLUGIN_TYPE.equals(stageSpec.getPlugin().getType())) {\n         for (Map.Entry<String, Schema> entry : inputSchemas.entrySet()) {\n-          if (entry.getValue() != null && entry.getValue().getFields() != null) {\n-            stageInputs.addAll(entry.getValue().getFields()\n+          Schema schema = entry.getValue();\n+          if (schema != null && schema.getFields() != null) {\n+            stageInputs.addAll(schema.getFields()\n                                  .stream().map(field -> entry.getKey() + \".\" + field.getName())\n                                  .collect(Collectors.toList()));\n           }\n         }\n       } else {\n         for (Map.Entry<String, Schema> entry : inputSchemas.entrySet()) {\n-          if (entry.getValue() != null && entry.getValue().getFields() != null) {\n-            stageInputs.addAll(entry.getValue().getFields().stream().map(Schema.Field::getName)\n+          Schema schema = entry.getValue();\n+          if (schema != null && schema.getFields() != null) {\n+            stageInputs.addAll(schema.getFields().stream().map(Schema.Field::getName)\n                                  .collect(Collectors.toList()));\n           }\n         }\n"}}, {"oid": "9778be46b61022a74545a8ffa9a23c9f25561c4c", "url": "https://github.com/cdapio/cdap/commit/9778be46b61022a74545a8ffa9a23c9f25561c4c", "message": "CDAP-16431 write empty fll instead of NPE", "committedDate": "2020-03-13T20:29:50Z", "type": "forcePushed"}, {"oid": "f77a01083ecb25d98c761da73cbd330a86214973", "url": "https://github.com/cdapio/cdap/commit/f77a01083ecb25d98c761da73cbd330a86214973", "message": "CDAP-16431 write empty fll instead of NPE", "committedDate": "2020-03-14T06:42:13Z", "type": "commit"}, {"oid": "f77a01083ecb25d98c761da73cbd330a86214973", "url": "https://github.com/cdapio/cdap/commit/f77a01083ecb25d98c761da73cbd330a86214973", "message": "CDAP-16431 write empty fll instead of NPE", "committedDate": "2020-03-14T06:42:13Z", "type": "forcePushed"}]}