{"pr_number": 12699, "pr_title": "CDAP-17196 fix mapreduce on distributed mode", "pr_createdAt": "2020-08-19T18:41:23Z", "pr_url": "https://github.com/cdapio/cdap/pull/12699", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzc0MTcwMw==", "url": "https://github.com/cdapio/cdap/pull/12699#discussion_r473741703", "bodyText": "It's better to have dependency on MapReduceContainerLauncher.class instead since the job needs to have that class to run correctly and it is that class which uses the MainClassLoader", "author": "chtyim", "createdAt": "2020-08-20T08:08:21Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/runtime/batch/MapReduceRuntimeService.java", "diffHunk": "@@ -790,6 +791,7 @@ public boolean accept(String className, URL classUrl, URL classPathUrl) {\n     classes.add(MapperWrapper.class);\n     classes.add(ReducerWrapper.class);\n     classes.add(SLF4JBridgeHandler.class);\n+    classes.add(MainClassLoader.class);", "originalCommit": "fc17770713e14ee687e7987e3e21a2c63295fc5c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "0405bd66215f89457738270baa9ea28860c53407", "chunk": "diff --git a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/runtime/batch/MapReduceRuntimeService.java b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/runtime/batch/MapReduceRuntimeService.java\nindex 68f10264e51..732d6c68fa7 100644\n--- a/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/runtime/batch/MapReduceRuntimeService.java\n+++ b/cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/runtime/batch/MapReduceRuntimeService.java\n\n@@ -791,7 +790,7 @@ final class MapReduceRuntimeService extends AbstractExecutionThreadService {\n     classes.add(MapperWrapper.class);\n     classes.add(ReducerWrapper.class);\n     classes.add(SLF4JBridgeHandler.class);\n-    classes.add(MainClassLoader.class);\n+    classes.add(MapReduceContainerLauncher.class);\n \n     // We only need to trace the Input/OutputFormat class due to MAPREDUCE-5957 so that those classes are included\n     // in the job.jar and be available in the MR system classpath before our job classloader (ApplicationClassLoader)\n"}}, {"oid": "0405bd66215f89457738270baa9ea28860c53407", "url": "https://github.com/cdapio/cdap/commit/0405bd66215f89457738270baa9ea28860c53407", "message": "CDAP-17196 fix mapreduce on distributed mode\n\nmapreduce was failing due to a missing asm-tree dependency.\nSomehow this dependency was not getting traced since the upgrade\nto asm 7, even though it is a twill dependency.\n\nAdded MapReduceContainerLauncher as a class to trace for\ndependencies when building the job jar since it is used to\nlaunch the actual mapreduce job.\n\nAlso modified the launcher to print unexpected errors to stderr\ninstead of using the logger, to ensure that errors are not lost.", "committedDate": "2020-08-20T18:38:08Z", "type": "commit"}, {"oid": "0405bd66215f89457738270baa9ea28860c53407", "url": "https://github.com/cdapio/cdap/commit/0405bd66215f89457738270baa9ea28860c53407", "message": "CDAP-17196 fix mapreduce on distributed mode\n\nmapreduce was failing due to a missing asm-tree dependency.\nSomehow this dependency was not getting traced since the upgrade\nto asm 7, even though it is a twill dependency.\n\nAdded MapReduceContainerLauncher as a class to trace for\ndependencies when building the job jar since it is used to\nlaunch the actual mapreduce job.\n\nAlso modified the launcher to print unexpected errors to stderr\ninstead of using the logger, to ensure that errors are not lost.", "committedDate": "2020-08-20T18:38:08Z", "type": "forcePushed"}]}