{"pr_number": 12504, "pr_title": "(CDAP-17124) Fix the PreviewRunnerService stop logic", "pr_createdAt": "2020-07-26T09:24:27Z", "pr_url": "https://github.com/cdapio/cdap/pull/12504", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA1MDI4Nw==", "url": "https://github.com/cdapio/cdap/pull/12504#discussion_r461050287", "bodyText": "Correct. I noticed this in the testing as well. I think we should change the start order as well. Start the runner before starting pollers.", "author": "sagarkapare", "createdAt": "2020-07-27T17:25:31Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/DefaultPreviewRunnerManager.java", "diffHunk": "@@ -134,14 +134,15 @@ protected void startUp() throws Exception {\n \n   @Override\n   protected void shutDown() throws Exception {\n+    // Should stop the polling service, hence individual preview runs, before stopping the top level preview runner.", "originalCommit": "3a3ffe8e0afd7b74da96510305d219fb87bb340e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA2NDg2OA==", "url": "https://github.com/cdapio/cdap/pull/12504#discussion_r461064868", "bodyText": "Moved", "author": "chtyim", "createdAt": "2020-07-27T17:50:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA1MDI4Nw=="}], "type": "inlineReview", "revised_code": {"commit": "9efe031877bae2de47b398263a9f3026001b1d58", "chunk": "diff --git a/cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/DefaultPreviewRunnerManager.java b/cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/DefaultPreviewRunnerManager.java\nindex a5fe56be551..fdb48fc7350 100644\n--- a/cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/DefaultPreviewRunnerManager.java\n+++ b/cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/DefaultPreviewRunnerManager.java\n\n@@ -126,10 +133,6 @@ public class DefaultPreviewRunnerManager extends AbstractIdleService implements\n       pollerService.startAndWait();\n       previewPollers.put(pollerInfo, pollerService);\n     }\n-    PreviewRunner runner = previewInjector.getInstance(PreviewRunner.class);\n-    if (runner instanceof Service) {\n-      ((Service) runner).startAndWait();\n-    }\n   }\n \n   @Override\n"}}, {"oid": "9efe031877bae2de47b398263a9f3026001b1d58", "url": "https://github.com/cdapio/cdap/commit/9efe031877bae2de47b398263a9f3026001b1d58", "message": "(CDAP-17124) Fix the PreviewRunnerService stop logic\n\n- Shouldn\u2019t try to stop a preview run that was already completed\n- Stop individual preview runs before stopping the PreviewRunner, which the PreviewRunner runs shared services", "committedDate": "2020-07-27T17:50:31Z", "type": "commit"}, {"oid": "9efe031877bae2de47b398263a9f3026001b1d58", "url": "https://github.com/cdapio/cdap/commit/9efe031877bae2de47b398263a9f3026001b1d58", "message": "(CDAP-17124) Fix the PreviewRunnerService stop logic\n\n- Shouldn\u2019t try to stop a preview run that was already completed\n- Stop individual preview runs before stopping the PreviewRunner, which the PreviewRunner runs shared services", "committedDate": "2020-07-27T17:50:31Z", "type": "forcePushed"}]}