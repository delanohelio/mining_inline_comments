{"pr_number": 12250, "pr_title": "[CDAP-16873] Add metrics writer module ", "pr_createdAt": "2020-06-03T18:17:52Z", "pr_url": "https://github.com/cdapio/cdap/pull/12250", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA1ODc1Mw==", "url": "https://github.com/cdapio/cdap/pull/12250#discussion_r437058753", "bodyText": "When the MetricsWriter.initialize will be called? I would suggest called them in the startUp method of this service (including the default one, the call should move there).", "author": "chtyim", "createdAt": "2020-06-08T23:40:03Z", "path": "cdap-watchdog/src/main/java/io/cdap/cdap/metrics/process/MessagingMetricsProcessorManagerService.java", "diffHunk": "@@ -74,6 +79,10 @@\n     metricsWriter.initialize(metricsContext);\n     this.metricsWriters.add(metricsWriter);\n \n+    for (Map.Entry<String, MetricsWriter> metricsWriterEntry : metricsWriterProvider.loadMetricsWriters().entrySet()) {\n+      this.metricsWriters.add(metricsWriterEntry.getValue());", "originalCommit": "720d59598f1b84d5aba1b55ef91f25e97ac0828f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzExMjc5Mw==", "url": "https://github.com/cdapio/cdap/pull/12250#discussion_r437112793", "bodyText": "done", "author": "rmstar", "createdAt": "2020-06-09T03:08:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA1ODc1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQ0MDIwMQ==", "url": "https://github.com/cdapio/cdap/pull/12250#discussion_r438440201", "bodyText": "So I only see the MetricsWriter being added, but the initialize is not getting called?", "author": "chtyim", "createdAt": "2020-06-10T22:22:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA1ODc1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQ2MzkzMg==", "url": "https://github.com/cdapio/cdap/pull/12250#discussion_r438463932", "bodyText": "fixed.", "author": "rmstar", "createdAt": "2020-06-10T23:37:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA1ODc1Mw=="}], "type": "inlineReview", "revised_code": {"commit": "ec8fd551593c86cc4d14ec08ad3992fd3c396539", "chunk": "diff --git a/cdap-watchdog/src/main/java/io/cdap/cdap/metrics/process/MessagingMetricsProcessorManagerService.java b/cdap-watchdog/src/main/java/io/cdap/cdap/metrics/process/MessagingMetricsProcessorManagerService.java\nindex 2e66b58f100..a1f83c42499 100644\n--- a/cdap-watchdog/src/main/java/io/cdap/cdap/metrics/process/MessagingMetricsProcessorManagerService.java\n+++ b/cdap-watchdog/src/main/java/io/cdap/cdap/metrics/process/MessagingMetricsProcessorManagerService.java\n\n@@ -75,31 +85,46 @@ public class MessagingMetricsProcessorManagerService extends AbstractIdleService\n                                           int instanceId) {\n     this.metricsWriters = new ArrayList<>();\n     this.metricsProcessorServices = new ArrayList<>();\n+    this.cConf = cConf;\n+    this.metricDatasetFactory = metricDatasetFactory;\n+    this.messagingService = messagingService;\n+    this.schemaGenerator = schemaGenerator;\n+    this.readerFactory = readerFactory;\n+    this.metricStore = metricStore;\n+    this.metricsWriterProvider = metricsWriterProvider;\n+    this.topicNumbers = topicNumbers;\n+    this.metricsContext = metricsContext;\n+    this.metricsProcessIntervalMillis = metricsProcessIntervalMillis;\n+    this.instanceId = instanceId;\n+  }\n+\n+  @Override\n+  protected void startUp() throws Exception {\n     MetricStoreMetricsWriter metricsWriter = new MetricStoreMetricsWriter(metricStore);\n     metricsWriter.initialize(metricsContext);\n     this.metricsWriters.add(metricsWriter);\n \n     for (Map.Entry<String, MetricsWriter> metricsWriterEntry : metricsWriterProvider.loadMetricsWriters().entrySet()) {\n-      this.metricsWriters.add(metricsWriterEntry.getValue());\n+      MetricsWriter writer = metricsWriterEntry.getValue();\n+      this.metricsWriters.add(writer);\n+      writer.initialize(metricsContext);\n     }\n \n     for (MetricsWriter metricsExtension : this.metricsWriters) {\n-      metricsProcessorServices.add(new MessagingMetricsProcessorService(cConf,\n-                                                                        metricDatasetFactory,\n-                                                                        messagingService,\n-                                                                        schemaGenerator,\n-                                                                        readerFactory,\n-                                                                        metricsExtension,\n-                                                                        topicNumbers,\n-                                                                        metricsContext,\n-                                                                        metricsProcessIntervalMillis,\n-                                                                        instanceId));\n+      metricsProcessorServices.add(new MessagingMetricsProcessorService(\n+        cConf,\n+        metricDatasetFactory,\n+        messagingService,\n+        schemaGenerator,\n+        readerFactory,\n+        metricsExtension,\n+        topicNumbers,\n+        metricsContext,\n+        metricsProcessIntervalMillis,\n+        instanceId));\n \n     }\n-  }\n \n-  @Override\n-  protected void startUp() throws Exception {\n     for (MessagingMetricsProcessorService processorService : metricsProcessorServices) {\n       processorService.startAndWait();\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQzOTU4MA==", "url": "https://github.com/cdapio/cdap/pull/12250#discussion_r438439580", "bodyText": "We only need this in the MetricsServiceMain instead of all service main, right?", "author": "chtyim", "createdAt": "2020-06-10T22:20:54Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/master/environment/k8s/AbstractServiceMain.java", "diffHunk": "@@ -163,6 +164,7 @@ public final void init(String[] args) throws Exception {\n     modules.add(new ConfigModule(cConf, hConf, sConf));\n     modules.add(new IOModule());\n     modules.add(new MetricsClientRuntimeModule().getDistributedModules());\n+    modules.add(new MetricsWriterModule());", "originalCommit": "17753a74c97ff5d502670b96b5d4182eb59badbf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQ2NDE1Mg==", "url": "https://github.com/cdapio/cdap/pull/12250#discussion_r438464152", "bodyText": "removed from here and added it in MetricsServiceMain", "author": "rmstar", "createdAt": "2020-06-10T23:38:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQzOTU4MA=="}], "type": "inlineReview", "revised_code": {"commit": "ec8fd551593c86cc4d14ec08ad3992fd3c396539", "chunk": "diff --git a/cdap-app-fabric/src/main/java/io/cdap/cdap/master/environment/k8s/AbstractServiceMain.java b/cdap-app-fabric/src/main/java/io/cdap/cdap/master/environment/k8s/AbstractServiceMain.java\nindex 42e011daeac..eabfc248e78 100644\n--- a/cdap-app-fabric/src/main/java/io/cdap/cdap/master/environment/k8s/AbstractServiceMain.java\n+++ b/cdap-app-fabric/src/main/java/io/cdap/cdap/master/environment/k8s/AbstractServiceMain.java\n\n@@ -164,7 +163,6 @@ public abstract class AbstractServiceMain<T extends EnvironmentOptions> extends\n     modules.add(new ConfigModule(cConf, hConf, sConf));\n     modules.add(new IOModule());\n     modules.add(new MetricsClientRuntimeModule().getDistributedModules());\n-    modules.add(new MetricsWriterModule());\n     modules.add(new AbstractModule() {\n       @Override\n       protected void configure() {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODUxMjM4NA==", "url": "https://github.com/cdapio/cdap/pull/12250#discussion_r438512384", "bodyText": "The MetricsWriter also implements Closeable. So you have to close them on the shutDown method.", "author": "chtyim", "createdAt": "2020-06-11T02:46:14Z", "path": "cdap-watchdog/src/main/java/io/cdap/cdap/metrics/process/MessagingMetricsProcessorManagerService.java", "diffHunk": "@@ -64,33 +78,53 @@\n                                           SchemaGenerator schemaGenerator,\n                                           DatumReaderFactory readerFactory,\n                                           MetricStore metricStore,\n+                                          MetricsWriterProvider metricsWriterProvider,\n                                           Set<Integer> topicNumbers,\n                                           MetricsContext metricsContext,\n                                           long metricsProcessIntervalMillis,\n                                           int instanceId) {\n     this.metricsWriters = new ArrayList<>();\n     this.metricsProcessorServices = new ArrayList<>();\n+    this.cConf = cConf;\n+    this.metricDatasetFactory = metricDatasetFactory;\n+    this.messagingService = messagingService;\n+    this.schemaGenerator = schemaGenerator;\n+    this.readerFactory = readerFactory;\n+    this.metricStore = metricStore;\n+    this.metricsWriterProvider = metricsWriterProvider;\n+    this.topicNumbers = topicNumbers;\n+    this.metricsContext = metricsContext;\n+    this.metricsProcessIntervalMillis = metricsProcessIntervalMillis;\n+    this.instanceId = instanceId;\n+  }\n+\n+  @Override\n+  protected void startUp() throws Exception {\n     MetricStoreMetricsWriter metricsWriter = new MetricStoreMetricsWriter(metricStore);\n     metricsWriter.initialize(metricsContext);\n     this.metricsWriters.add(metricsWriter);\n \n+    for (Map.Entry<String, MetricsWriter> metricsWriterEntry : metricsWriterProvider.loadMetricsWriters().entrySet()) {\n+      MetricsWriter writer = metricsWriterEntry.getValue();\n+      this.metricsWriters.add(writer);\n+      writer.initialize(metricsContext);", "originalCommit": "147729438b54b8a5c3b3243fe5c7ed3f8596a579", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU1MDE1Ng==", "url": "https://github.com/cdapio/cdap/pull/12250#discussion_r438550156", "bodyText": "done", "author": "rmstar", "createdAt": "2020-06-11T05:27:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODUxMjM4NA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "ec8fd551593c86cc4d14ec08ad3992fd3c396539", "url": "https://github.com/cdapio/cdap/commit/ec8fd551593c86cc4d14ec08ad3992fd3c396539", "message": "[CDAP-16873] Add metrics writer module.", "committedDate": "2020-06-11T05:28:05Z", "type": "forcePushed"}, {"oid": "9deb283f612a9b0453d1f84dd5e288160826a946", "url": "https://github.com/cdapio/cdap/commit/9deb283f612a9b0453d1f84dd5e288160826a946", "message": "[CDAP-16873] Add metrics writer module.", "committedDate": "2020-06-12T01:14:57Z", "type": "commit"}, {"oid": "9deb283f612a9b0453d1f84dd5e288160826a946", "url": "https://github.com/cdapio/cdap/commit/9deb283f612a9b0453d1f84dd5e288160826a946", "message": "[CDAP-16873] Add metrics writer module.", "committedDate": "2020-06-12T01:14:57Z", "type": "forcePushed"}]}