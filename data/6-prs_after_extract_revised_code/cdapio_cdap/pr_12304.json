{"pr_number": 12304, "pr_title": "[CDAP-16784] Add Kryo serializers for unmodifiable class types", "pr_createdAt": "2020-06-11T17:48:14Z", "pr_url": "https://github.com/cdapio/cdap/pull/12304", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk3MTQ5NA==", "url": "https://github.com/cdapio/cdap/pull/12304#discussion_r438971494", "bodyText": "Seems unnecessary?", "author": "chtyim", "createdAt": "2020-06-11T17:56:55Z", "path": "cdap-app-templates/cdap-etl/cdap-data-streams/src/main/java/io/cdap/cdap/datastreams/DataStreamsSparkLauncher.java", "diffHunk": "@@ -98,6 +98,7 @@ public void initialize() throws Exception {\n \n     SparkConf sparkConf = new SparkConf();\n     sparkConf.set(\"spark.streaming.backpressure.enabled\", \"true\");\n+", "originalCommit": "4436d764009ec37a459e3f75e774798f789fd237", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk4MDA3Mw==", "url": "https://github.com/cdapio/cdap/pull/12304#discussion_r438980073", "bodyText": "removed", "author": "MEseifan", "createdAt": "2020-06-11T18:12:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk3MTQ5NA=="}], "type": "inlineReview", "revised_code": {"commit": "08743441634c5f00a070494ffef0bae2a4aeb8c6", "chunk": "diff --git a/cdap-app-templates/cdap-etl/cdap-data-streams/src/main/java/io/cdap/cdap/datastreams/DataStreamsSparkLauncher.java b/cdap-app-templates/cdap-etl/cdap-data-streams/src/main/java/io/cdap/cdap/datastreams/DataStreamsSparkLauncher.java\nindex 72acfe7a228..ee2f71b01d2 100644\n--- a/cdap-app-templates/cdap-etl/cdap-data-streams/src/main/java/io/cdap/cdap/datastreams/DataStreamsSparkLauncher.java\n+++ b/cdap-app-templates/cdap-etl/cdap-data-streams/src/main/java/io/cdap/cdap/datastreams/DataStreamsSparkLauncher.java\n\n@@ -98,7 +98,6 @@ public class DataStreamsSparkLauncher extends AbstractSpark {\n \n     SparkConf sparkConf = new SparkConf();\n     sparkConf.set(\"spark.streaming.backpressure.enabled\", \"true\");\n-\n     sparkConf.set(\"spark.spark.streaming.blockInterval\", String.valueOf(spec.getBatchIntervalMillis() / 5));\n     for (Map.Entry<String, String> property : spec.getProperties().entrySet()) {\n       sparkConf.set(property.getKey(), property.getValue());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk3MTYzNg==", "url": "https://github.com/cdapio/cdap/pull/12304#discussion_r438971636", "bodyText": "Unused import?", "author": "chtyim", "createdAt": "2020-06-11T17:57:04Z", "path": "cdap-app-templates/cdap-etl/hydrator-spark-core-base/src/main/java/io/cdap/cdap/etl/spark/batch/ETLSpark.java", "diffHunk": "@@ -39,6 +39,7 @@\n import io.cdap.cdap.etl.common.submit.Finisher;\n import io.cdap.cdap.internal.io.SchemaTypeAdapter;\n import org.apache.spark.SparkConf;\n+import org.apache.spark.storage.StorageLevel;", "originalCommit": "4436d764009ec37a459e3f75e774798f789fd237", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk4MDE0Ng==", "url": "https://github.com/cdapio/cdap/pull/12304#discussion_r438980146", "bodyText": "removed", "author": "MEseifan", "createdAt": "2020-06-11T18:12:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk3MTYzNg=="}], "type": "inlineReview", "revised_code": {"commit": "08743441634c5f00a070494ffef0bae2a4aeb8c6", "chunk": "diff --git a/cdap-app-templates/cdap-etl/hydrator-spark-core-base/src/main/java/io/cdap/cdap/etl/spark/batch/ETLSpark.java b/cdap-app-templates/cdap-etl/hydrator-spark-core-base/src/main/java/io/cdap/cdap/etl/spark/batch/ETLSpark.java\nindex 50b97935348..b051c28c69c 100644\n--- a/cdap-app-templates/cdap-etl/hydrator-spark-core-base/src/main/java/io/cdap/cdap/etl/spark/batch/ETLSpark.java\n+++ b/cdap-app-templates/cdap-etl/hydrator-spark-core-base/src/main/java/io/cdap/cdap/etl/spark/batch/ETLSpark.java\n\n@@ -39,7 +39,6 @@ import io.cdap.cdap.etl.common.submit.CompositeFinisher;\n import io.cdap.cdap.etl.common.submit.Finisher;\n import io.cdap.cdap.internal.io.SchemaTypeAdapter;\n import org.apache.spark.SparkConf;\n-import org.apache.spark.storage.StorageLevel;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk3MjA0OA==", "url": "https://github.com/cdapio/cdap/pull/12304#discussion_r438972048", "bodyText": "Add this after all the Type constant. Make it easier for eyes", "author": "chtyim", "createdAt": "2020-06-11T17:57:44Z", "path": "cdap-spark-core-base/src/main/java/io/cdap/cdap/app/runtime/spark/classloader/SparkClassRewriter.java", "diffHunk": "@@ -104,6 +112,8 @@\n     Type.getObjectType(\"io/cdap/cdap/app/runtime/spark/serializer/SchemaSerializer\");\n   private static final Type STRUCTURED_RECORD_SERIALIZER_TYPE =\n     Type.getObjectType(\"io/cdap/cdap/app/runtime/spark/serializer/StructuredRecordSerializer\");\n+  private static final String UNMODIFIABLE_SERIALIZERS_TYPE_FORMAT =", "originalCommit": "4436d764009ec37a459e3f75e774798f789fd237", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk4MDU1NQ==", "url": "https://github.com/cdapio/cdap/pull/12304#discussion_r438980555", "bodyText": "done", "author": "MEseifan", "createdAt": "2020-06-11T18:13:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk3MjA0OA=="}], "type": "inlineReview", "revised_code": {"commit": "08743441634c5f00a070494ffef0bae2a4aeb8c6", "chunk": "diff --git a/cdap-spark-core-base/src/main/java/io/cdap/cdap/app/runtime/spark/classloader/SparkClassRewriter.java b/cdap-spark-core-base/src/main/java/io/cdap/cdap/app/runtime/spark/classloader/SparkClassRewriter.java\nindex 6caf5d0ffcb..bfbecd660e5 100644\n--- a/cdap-spark-core-base/src/main/java/io/cdap/cdap/app/runtime/spark/classloader/SparkClassRewriter.java\n+++ b/cdap-spark-core-base/src/main/java/io/cdap/cdap/app/runtime/spark/classloader/SparkClassRewriter.java\n\n@@ -112,8 +113,6 @@ public class SparkClassRewriter implements ClassRewriter {\n     Type.getObjectType(\"io/cdap/cdap/app/runtime/spark/serializer/SchemaSerializer\");\n   private static final Type STRUCTURED_RECORD_SERIALIZER_TYPE =\n     Type.getObjectType(\"io/cdap/cdap/app/runtime/spark/serializer/StructuredRecordSerializer\");\n-  private static final String UNMODIFIABLE_SERIALIZERS_TYPE_FORMAT =\n-    \"io/cdap/cdap/app/runtime/spark/serializer/Unmodifiable%sSerializer\";\n   private static final Type SPARK_DISK_STORE = Type.getObjectType(\"org/apache/spark/storage/DiskStore\");\n \n   // Don't refer akka Remoting with the \".class\" because in future Spark version, akka dependency is removed and\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk3MjI4Mw==", "url": "https://github.com/cdapio/cdap/pull/12304#discussion_r438972283", "bodyText": "Unnecessary new line", "author": "chtyim", "createdAt": "2020-06-11T17:58:07Z", "path": "cdap-spark-core-base/src/main/java/io/cdap/cdap/app/runtime/spark/classloader/SparkClassRewriter.java", "diffHunk": "@@ -351,11 +361,12 @@ void onMethodExit(String name, String desc, GeneratorAdapter generatorAdapter) {\n     // Map from getResource* methods to the method signature\n     // (can be null, since only method that has generic has signature)\n     final Map<Method, String> resourceMethods = new HashMap<>();\n-    Method method = new Method(\"getResource\", Type.getType(URL.class), new Type[]{Type.getType(String.class)});\n+    Method method = new Method(\"getResource\", Type.getType(URL.class), new Type[] { Type.getType(String.class) });\n     resourceMethods.put(method, null);\n \n     method = new Method(\"getResources\", Type.getType(Enumeration.class), new Type[] { Type.getType(String.class) });\n-    resourceMethods.put(method, Signatures.getMethodSignature(method, new TypeToken<Enumeration<URL>>() { },\n+    resourceMethods.put(method, Signatures.getMethodSignature(method, new TypeToken<Enumeration<URL>>() {\n+                                                              },", "originalCommit": "4436d764009ec37a459e3f75e774798f789fd237", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk4MDY5Mg==", "url": "https://github.com/cdapio/cdap/pull/12304#discussion_r438980692", "bodyText": "done", "author": "MEseifan", "createdAt": "2020-06-11T18:13:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk3MjI4Mw=="}], "type": "inlineReview", "revised_code": {"commit": "08743441634c5f00a070494ffef0bae2a4aeb8c6", "chunk": "diff --git a/cdap-spark-core-base/src/main/java/io/cdap/cdap/app/runtime/spark/classloader/SparkClassRewriter.java b/cdap-spark-core-base/src/main/java/io/cdap/cdap/app/runtime/spark/classloader/SparkClassRewriter.java\nindex 6caf5d0ffcb..bfbecd660e5 100644\n--- a/cdap-spark-core-base/src/main/java/io/cdap/cdap/app/runtime/spark/classloader/SparkClassRewriter.java\n+++ b/cdap-spark-core-base/src/main/java/io/cdap/cdap/app/runtime/spark/classloader/SparkClassRewriter.java\n\n@@ -365,8 +366,7 @@ public class SparkClassRewriter implements ClassRewriter {\n     resourceMethods.put(method, null);\n \n     method = new Method(\"getResources\", Type.getType(Enumeration.class), new Type[] { Type.getType(String.class) });\n-    resourceMethods.put(method, Signatures.getMethodSignature(method, new TypeToken<Enumeration<URL>>() {\n-                                                              },\n+    resourceMethods.put(method, Signatures.getMethodSignature(method, new TypeToken<Enumeration<URL>>() { },\n                                                               TypeToken.of(String.class)));\n \n     method = new Method(\"getResourceAsStream\", Type.getType(InputStream.class),\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk3MjUzMw==", "url": "https://github.com/cdapio/cdap/pull/12304#discussion_r438972533", "bodyText": "Pull this out as a private static class.", "author": "chtyim", "createdAt": "2020-06-11T17:58:36Z", "path": "cdap-spark-core-base/src/main/java/io/cdap/cdap/app/runtime/spark/classloader/SparkClassRewriter.java", "diffHunk": "@@ -450,6 +461,24 @@ public void visitEnd() {\n    */\n   private byte[] rewriteKryo(InputStream byteCodeStream) throws IOException {\n     return rewriteConstructor(KRYO_TYPE, byteCodeStream, new ConstructorRewriter() {\n+      class UnmodifiableData {", "originalCommit": "4436d764009ec37a459e3f75e774798f789fd237", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk4MTYzMg==", "url": "https://github.com/cdapio/cdap/pull/12304#discussion_r438981632", "bodyText": "done", "author": "MEseifan", "createdAt": "2020-06-11T18:15:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk3MjUzMw=="}], "type": "inlineReview", "revised_code": {"commit": "08743441634c5f00a070494ffef0bae2a4aeb8c6", "chunk": "diff --git a/cdap-spark-core-base/src/main/java/io/cdap/cdap/app/runtime/spark/classloader/SparkClassRewriter.java b/cdap-spark-core-base/src/main/java/io/cdap/cdap/app/runtime/spark/classloader/SparkClassRewriter.java\nindex 6caf5d0ffcb..bfbecd660e5 100644\n--- a/cdap-spark-core-base/src/main/java/io/cdap/cdap/app/runtime/spark/classloader/SparkClassRewriter.java\n+++ b/cdap-spark-core-base/src/main/java/io/cdap/cdap/app/runtime/spark/classloader/SparkClassRewriter.java\n\n@@ -461,24 +479,6 @@ public class SparkClassRewriter implements ClassRewriter {\n    */\n   private byte[] rewriteKryo(InputStream byteCodeStream) throws IOException {\n     return rewriteConstructor(KRYO_TYPE, byteCodeStream, new ConstructorRewriter() {\n-      class UnmodifiableData {\n-        Class<?> unmodifiableClass;\n-        Type implementationType;\n-        Type serializerType;\n-        String name;\n-\n-        UnmodifiableData(String name, Class<?> ununmodifiableClass, Class<?> implementationClass) {\n-          this.unmodifiableClass = ununmodifiableClass;\n-          this.implementationType = Type.getType(implementationClass);\n-          this.serializerType = Type.getObjectType(String.format(UNMODIFIABLE_SERIALIZERS_TYPE_FORMAT, name));\n-          this.name = name;\n-        }\n-\n-        String getCollectionsConstructorName() {\n-          return \"unmodifiable\" + name;\n-        }\n-      }\n-\n       @Override\n       public void onMethodExit(String name, String desc, GeneratorAdapter generatorAdapter) {\n         // Register serializer for Schema\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk3MzIyMg==", "url": "https://github.com/cdapio/cdap/pull/12304#discussion_r438973222", "bodyText": "Suggest to use LinkedHashMap to maintain order", "author": "chtyim", "createdAt": "2020-06-11T17:59:54Z", "path": "cdap-spark-core-base/src/main/java/io/cdap/cdap/app/runtime/spark/classloader/SparkClassRewriter.java", "diffHunk": "@@ -468,17 +497,46 @@ public void onMethodExit(String name, String desc, GeneratorAdapter generatorAda\n         generatorAdapter.push(STRUCTURED_RECORD_SERIALIZER_TYPE);\n         generatorAdapter.invokeVirtual(KRYO_TYPE,\n                                        new Method(\"addDefaultSerializer\", Type.VOID_TYPE,\n-                                                  new Type[] { Type.getType(Class.class), Type.getType(Class.class)}));\n+                                                  new Type[] { Type.getType(Class.class), Type.getType(Class.class) }));\n+\n+        // Register serializer for all Unmodifiable classes within Collections. Ex:\n+        // addDefaultSerializer(Collections.unmodifiableMap(new HashMap<>()).getClass(),\n+        //                      UnmodifiableMapSerializer.class);\n+        List<UnmodifiableData> unmodifableTypesData = new ArrayList<>();\n+        unmodifableTypesData.add(new UnmodifiableData(\"Collection\", Collection.class, LinkedList.class));\n+        unmodifableTypesData.add(new UnmodifiableData(\"List\", List.class, LinkedList.class));\n+        unmodifableTypesData.add(new UnmodifiableData(\"Set\", Set.class, LinkedHashSet.class));\n+        unmodifableTypesData.add(new UnmodifiableData(\"SortedSet\", SortedSet.class, TreeSet.class));\n+        unmodifableTypesData.add(new UnmodifiableData(\"Map\", Map.class, HashMap.class));", "originalCommit": "4436d764009ec37a459e3f75e774798f789fd237", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk4MjM4Nw==", "url": "https://github.com/cdapio/cdap/pull/12304#discussion_r438982387", "bodyText": "Done", "author": "MEseifan", "createdAt": "2020-06-11T18:16:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk3MzIyMg=="}], "type": "inlineReview", "revised_code": {"commit": "08743441634c5f00a070494ffef0bae2a4aeb8c6", "chunk": "diff --git a/cdap-spark-core-base/src/main/java/io/cdap/cdap/app/runtime/spark/classloader/SparkClassRewriter.java b/cdap-spark-core-base/src/main/java/io/cdap/cdap/app/runtime/spark/classloader/SparkClassRewriter.java\nindex 6caf5d0ffcb..bfbecd660e5 100644\n--- a/cdap-spark-core-base/src/main/java/io/cdap/cdap/app/runtime/spark/classloader/SparkClassRewriter.java\n+++ b/cdap-spark-core-base/src/main/java/io/cdap/cdap/app/runtime/spark/classloader/SparkClassRewriter.java\n\n@@ -507,7 +507,7 @@ public class SparkClassRewriter implements ClassRewriter {\n         unmodifableTypesData.add(new UnmodifiableData(\"List\", List.class, LinkedList.class));\n         unmodifableTypesData.add(new UnmodifiableData(\"Set\", Set.class, LinkedHashSet.class));\n         unmodifableTypesData.add(new UnmodifiableData(\"SortedSet\", SortedSet.class, TreeSet.class));\n-        unmodifableTypesData.add(new UnmodifiableData(\"Map\", Map.class, HashMap.class));\n+        unmodifableTypesData.add(new UnmodifiableData(\"Map\", Map.class, LinkedHashMap.class));\n         unmodifableTypesData.add(new UnmodifiableData(\"SortedMap\", SortedMap.class, TreeMap.class));\n \n         for (UnmodifiableData unmodifableTypesDatum : unmodifableTypesData) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk3MzU5Nw==", "url": "https://github.com/cdapio/cdap/pull/12304#discussion_r438973597", "bodyText": "Unnecessary indentation.", "author": "chtyim", "createdAt": "2020-06-11T18:00:33Z", "path": "cdap-spark-core-base/src/main/java/io/cdap/cdap/app/runtime/spark/classloader/SparkClassRewriter.java", "diffHunk": "@@ -507,9 +565,9 @@ public MethodVisitor visitMethod(int access, final String name,\n           public void visitMethodInsn(int opcode, String owner, String name, String desc, boolean itf) {\n             // See if in this constructor it is calling other constructor (this(..)).\n             calledThis = calledThis || (opcode == Opcodes.INVOKESPECIAL\n-              && Type.getObjectType(owner).equals(classType)\n-              && name.equals(\"<init>\")\n-              && Type.getReturnType(desc).equals(Type.VOID_TYPE));\n+                                        && Type.getObjectType(owner).equals(classType)", "originalCommit": "4436d764009ec37a459e3f75e774798f789fd237", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk4MzU1OQ==", "url": "https://github.com/cdapio/cdap/pull/12304#discussion_r438983559", "bodyText": "done", "author": "MEseifan", "createdAt": "2020-06-11T18:18:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk3MzU5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk4MzYzNg==", "url": "https://github.com/cdapio/cdap/pull/12304#discussion_r438983636", "bodyText": "done", "author": "MEseifan", "createdAt": "2020-06-11T18:19:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk3MzU5Nw=="}], "type": "inlineReview", "revised_code": {"commit": "08743441634c5f00a070494ffef0bae2a4aeb8c6", "chunk": "diff --git a/cdap-spark-core-base/src/main/java/io/cdap/cdap/app/runtime/spark/classloader/SparkClassRewriter.java b/cdap-spark-core-base/src/main/java/io/cdap/cdap/app/runtime/spark/classloader/SparkClassRewriter.java\nindex 6caf5d0ffcb..bfbecd660e5 100644\n--- a/cdap-spark-core-base/src/main/java/io/cdap/cdap/app/runtime/spark/classloader/SparkClassRewriter.java\n+++ b/cdap-spark-core-base/src/main/java/io/cdap/cdap/app/runtime/spark/classloader/SparkClassRewriter.java\n\n@@ -565,9 +565,9 @@ public class SparkClassRewriter implements ClassRewriter {\n           public void visitMethodInsn(int opcode, String owner, String name, String desc, boolean itf) {\n             // See if in this constructor it is calling other constructor (this(..)).\n             calledThis = calledThis || (opcode == Opcodes.INVOKESPECIAL\n-                                        && Type.getObjectType(owner).equals(classType)\n-                                        && name.equals(\"<init>\")\n-                                        && Type.getReturnType(desc).equals(Type.VOID_TYPE));\n+              && Type.getObjectType(owner).equals(classType)\n+              && name.equals(\"<init>\")\n+              && Type.getReturnType(desc).equals(Type.VOID_TYPE));\n             super.visitMethodInsn(opcode, owner, name, desc, itf);\n           }\n \n"}}, {"oid": "08743441634c5f00a070494ffef0bae2a4aeb8c6", "url": "https://github.com/cdapio/cdap/commit/08743441634c5f00a070494ffef0bae2a4aeb8c6", "message": "Addressed comments", "committedDate": "2020-06-11T18:27:30Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTE2MjExOQ==", "url": "https://github.com/cdapio/cdap/pull/12304#discussion_r439162119", "bodyText": "Move private class to the end of the file. Not to interrupt the code flow. Also, add a javadoc for the class.", "author": "chtyim", "createdAt": "2020-06-12T01:38:29Z", "path": "cdap-spark-core-base/src/main/java/io/cdap/cdap/app/runtime/spark/classloader/SparkClassRewriter.java", "diffHunk": "@@ -442,6 +453,24 @@ public void visitEnd() {\n     return cw.toByteArray();\n   }\n \n+  private static class UnmodifiableData {", "originalCommit": "08743441634c5f00a070494ffef0bae2a4aeb8c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTUzNTQ0MA==", "url": "https://github.com/cdapio/cdap/pull/12304#discussion_r439535440", "bodyText": "done", "author": "MEseifan", "createdAt": "2020-06-12T16:55:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTE2MjExOQ=="}], "type": "inlineReview", "revised_code": {"commit": "e38a04de10534fc3d0bfbb427191b1527e6c69a5", "chunk": "diff --git a/cdap-spark-core-base/src/main/java/io/cdap/cdap/app/runtime/spark/classloader/SparkClassRewriter.java b/cdap-spark-core-base/src/main/java/io/cdap/cdap/app/runtime/spark/classloader/SparkClassRewriter.java\nindex bfbecd660e5..728e1ee34bd 100644\n--- a/cdap-spark-core-base/src/main/java/io/cdap/cdap/app/runtime/spark/classloader/SparkClassRewriter.java\n+++ b/cdap-spark-core-base/src/main/java/io/cdap/cdap/app/runtime/spark/classloader/SparkClassRewriter.java\n\n@@ -453,24 +453,6 @@ public class SparkClassRewriter implements ClassRewriter {\n     return cw.toByteArray();\n   }\n \n-  private static class UnmodifiableData {\n-    Class<?> unmodifiableClass;\n-    Type implementationType;\n-    Type serializerType;\n-    String name;\n-\n-    UnmodifiableData(String name, Class<?> ununmodifiableClass, Class<?> implementationClass) {\n-      this.unmodifiableClass = ununmodifiableClass;\n-      this.implementationType = Type.getType(implementationClass);\n-      this.serializerType = Type.getObjectType(String.format(UNMODIFIABLE_SERIALIZERS_TYPE_FORMAT, name));\n-      this.name = name;\n-    }\n-\n-    String getCollectionsConstructorName() {\n-      return \"unmodifiable\" + name;\n-    }\n-  }\n-\n   /**\n    * Rewrites the constructor of the Kryo class to add serializer for CDAP classes.\n    *\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTE2MjE3Mg==", "url": "https://github.com/cdapio/cdap/pull/12304#discussion_r439162172", "bodyText": "final all fields", "author": "chtyim", "createdAt": "2020-06-12T01:38:41Z", "path": "cdap-spark-core-base/src/main/java/io/cdap/cdap/app/runtime/spark/classloader/SparkClassRewriter.java", "diffHunk": "@@ -442,6 +453,24 @@ public void visitEnd() {\n     return cw.toByteArray();\n   }\n \n+  private static class UnmodifiableData {\n+    Class<?> unmodifiableClass;", "originalCommit": "08743441634c5f00a070494ffef0bae2a4aeb8c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTUzNTcwMw==", "url": "https://github.com/cdapio/cdap/pull/12304#discussion_r439535703", "bodyText": "done", "author": "MEseifan", "createdAt": "2020-06-12T16:55:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTE2MjE3Mg=="}], "type": "inlineReview", "revised_code": {"commit": "e38a04de10534fc3d0bfbb427191b1527e6c69a5", "chunk": "diff --git a/cdap-spark-core-base/src/main/java/io/cdap/cdap/app/runtime/spark/classloader/SparkClassRewriter.java b/cdap-spark-core-base/src/main/java/io/cdap/cdap/app/runtime/spark/classloader/SparkClassRewriter.java\nindex bfbecd660e5..728e1ee34bd 100644\n--- a/cdap-spark-core-base/src/main/java/io/cdap/cdap/app/runtime/spark/classloader/SparkClassRewriter.java\n+++ b/cdap-spark-core-base/src/main/java/io/cdap/cdap/app/runtime/spark/classloader/SparkClassRewriter.java\n\n@@ -453,24 +453,6 @@ public class SparkClassRewriter implements ClassRewriter {\n     return cw.toByteArray();\n   }\n \n-  private static class UnmodifiableData {\n-    Class<?> unmodifiableClass;\n-    Type implementationType;\n-    Type serializerType;\n-    String name;\n-\n-    UnmodifiableData(String name, Class<?> ununmodifiableClass, Class<?> implementationClass) {\n-      this.unmodifiableClass = ununmodifiableClass;\n-      this.implementationType = Type.getType(implementationClass);\n-      this.serializerType = Type.getObjectType(String.format(UNMODIFIABLE_SERIALIZERS_TYPE_FORMAT, name));\n-      this.name = name;\n-    }\n-\n-    String getCollectionsConstructorName() {\n-      return \"unmodifiable\" + name;\n-    }\n-  }\n-\n   /**\n    * Rewrites the constructor of the Kryo class to add serializer for CDAP classes.\n    *\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTE2MjkyMw==", "url": "https://github.com/cdapio/cdap/pull/12304#discussion_r439162923", "bodyText": "Use Arrays.asList to make the code simpler\nList<UnmodifiableData> unmodiableTypes = Arrays.asList(\n  new UnmodifiableData(\"Collection\", Collection.class, LinkedList.class),\n  new UnmodifiableData(\"List\", List.class, LinkedList.class),\n  ...\n);", "author": "chtyim", "createdAt": "2020-06-12T01:41:58Z", "path": "cdap-spark-core-base/src/main/java/io/cdap/cdap/app/runtime/spark/classloader/SparkClassRewriter.java", "diffHunk": "@@ -468,17 +497,46 @@ public void onMethodExit(String name, String desc, GeneratorAdapter generatorAda\n         generatorAdapter.push(STRUCTURED_RECORD_SERIALIZER_TYPE);\n         generatorAdapter.invokeVirtual(KRYO_TYPE,\n                                        new Method(\"addDefaultSerializer\", Type.VOID_TYPE,\n-                                                  new Type[] { Type.getType(Class.class), Type.getType(Class.class)}));\n+                                                  new Type[] { Type.getType(Class.class), Type.getType(Class.class) }));\n+\n+        // Register serializer for all Unmodifiable classes within Collections. Ex:\n+        // addDefaultSerializer(Collections.unmodifiableMap(new HashMap<>()).getClass(),\n+        //                      UnmodifiableMapSerializer.class);\n+        List<UnmodifiableData> unmodifableTypesData = new ArrayList<>();", "originalCommit": "08743441634c5f00a070494ffef0bae2a4aeb8c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTUzNjc0Mg==", "url": "https://github.com/cdapio/cdap/pull/12304#discussion_r439536742", "bodyText": "done", "author": "MEseifan", "createdAt": "2020-06-12T16:57:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTE2MjkyMw=="}], "type": "inlineReview", "revised_code": {"commit": "e38a04de10534fc3d0bfbb427191b1527e6c69a5", "chunk": "diff --git a/cdap-spark-core-base/src/main/java/io/cdap/cdap/app/runtime/spark/classloader/SparkClassRewriter.java b/cdap-spark-core-base/src/main/java/io/cdap/cdap/app/runtime/spark/classloader/SparkClassRewriter.java\nindex bfbecd660e5..728e1ee34bd 100644\n--- a/cdap-spark-core-base/src/main/java/io/cdap/cdap/app/runtime/spark/classloader/SparkClassRewriter.java\n+++ b/cdap-spark-core-base/src/main/java/io/cdap/cdap/app/runtime/spark/classloader/SparkClassRewriter.java\n\n@@ -502,13 +484,14 @@ public class SparkClassRewriter implements ClassRewriter {\n         // Register serializer for all Unmodifiable classes within Collections. Ex:\n         // addDefaultSerializer(Collections.unmodifiableMap(new HashMap<>()).getClass(),\n         //                      UnmodifiableMapSerializer.class);\n-        List<UnmodifiableData> unmodifableTypesData = new ArrayList<>();\n-        unmodifableTypesData.add(new UnmodifiableData(\"Collection\", Collection.class, LinkedList.class));\n-        unmodifableTypesData.add(new UnmodifiableData(\"List\", List.class, LinkedList.class));\n-        unmodifableTypesData.add(new UnmodifiableData(\"Set\", Set.class, LinkedHashSet.class));\n-        unmodifableTypesData.add(new UnmodifiableData(\"SortedSet\", SortedSet.class, TreeSet.class));\n-        unmodifableTypesData.add(new UnmodifiableData(\"Map\", Map.class, LinkedHashMap.class));\n-        unmodifableTypesData.add(new UnmodifiableData(\"SortedMap\", SortedMap.class, TreeMap.class));\n+        List<UnmodifiableData> unmodifableTypesData = Arrays.asList(\n+          new UnmodifiableData(\"Collection\", Collection.class, LinkedList.class),\n+          new UnmodifiableData(\"List\", List.class, LinkedList.class),\n+          new UnmodifiableData(\"Set\", Set.class, LinkedHashSet.class),\n+          new UnmodifiableData(\"SortedSet\", SortedSet.class, TreeSet.class),\n+          new UnmodifiableData(\"Map\", Map.class, LinkedHashMap.class),\n+          new UnmodifiableData(\"SortedMap\", SortedMap.class, TreeMap.class)\n+        );\n \n         for (UnmodifiableData unmodifableTypesDatum : unmodifableTypesData) {\n           generatorAdapter.loadThis();\n"}}, {"oid": "e38a04de10534fc3d0bfbb427191b1527e6c69a5", "url": "https://github.com/cdapio/cdap/commit/e38a04de10534fc3d0bfbb427191b1527e6c69a5", "message": "Added kryo serializers for unmodifiable types", "committedDate": "2020-06-12T16:58:30Z", "type": "commit"}, {"oid": "e38a04de10534fc3d0bfbb427191b1527e6c69a5", "url": "https://github.com/cdapio/cdap/commit/e38a04de10534fc3d0bfbb427191b1527e6c69a5", "message": "Added kryo serializers for unmodifiable types", "committedDate": "2020-06-12T16:58:30Z", "type": "forcePushed"}]}