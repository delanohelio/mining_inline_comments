{"pr_number": 3481, "pr_title": "Fixes #3479: Implement Progress Bar for Zoom Activity ", "pr_createdAt": "2020-03-10T12:04:13Z", "pr_url": "https://github.com/commons-app/apps-android-commons/pull/3481", "timeline": [{"oid": "ba41f3f8b20bb74a7c76a718a8aacea2bf3bda94", "url": "https://github.com/commons-app/apps-android-commons/commit/ba41f3f8b20bb74a7c76a718a8aacea2bf3bda94", "message": "ZoomableActivity: add hierarchy to view for displaying progress bar", "committedDate": "2020-03-10T11:49:23Z", "type": "commit"}, {"oid": "8bf1d6452298d9de16234070fc053564ae66563d", "url": "https://github.com/commons-app/apps-android-commons/commit/8bf1d6452298d9de16234070fc053564ae66563d", "message": "CircularProgressBar: circular progress bar for ZoomableDraweeView", "committedDate": "2020-03-10T11:50:22Z", "type": "commit"}, {"oid": "125f8c5066f5cf9f23e760f4e46ff06a9105a148", "url": "https://github.com/commons-app/apps-android-commons/commit/125f8c5066f5cf9f23e760f4e46ff06a9105a148", "message": "ZoomableActivity: add indeterministic loading spinner", "committedDate": "2020-03-10T18:08:44Z", "type": "commit"}, {"oid": "a972bb5bd03ac2b240a6b56d72a09194585f962d", "url": "https://github.com/commons-app/apps-android-commons/commit/a972bb5bd03ac2b240a6b56d72a09194585f962d", "message": "activity_zoomable: add inderterministic Progressbar", "committedDate": "2020-03-10T18:09:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQ4NTg5Mw==", "url": "https://github.com/commons-app/apps-android-commons/pull/3481#discussion_r391485893", "bodyText": "Sometimes intermediate image is also slowly appears. I think we should also use the progressbar for that phase. What do you think @kbhardwaj123 ?", "author": "neslihanturan", "createdAt": "2020-03-12T09:13:30Z", "path": "app/src/main/java/fr/free/nrw/commons/media/ZoomableActivity.java", "diffHunk": "@@ -48,13 +59,33 @@ protected void onCreate(Bundle savedInstanceState) {\n         init();\n     }\n \n+    private final ControllerListener loadingListener = new BaseControllerListener<ImageInfo>() {\n+        @Override\n+        public void onSubmit(String id, Object callerContext) {\n+        }\n+\n+        @Override\n+        public void onIntermediateImageSet(String id, @Nullable ImageInfo imageInfo) {", "originalCommit": "a972bb5bd03ac2b240a6b56d72a09194585f962d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTU1NjY1Ng==", "url": "https://github.com/commons-app/apps-android-commons/pull/3481#discussion_r391556656", "bodyText": "@neslihanturan actually i inspected this thing and found that if i place a log statement for onIntermediateImageSet it won't appear in the logs, i think it would be better if i make the Indeterminate spinner INVISIBLE as soon as Intermediate image is set", "author": "kbhardwaj123", "createdAt": "2020-03-12T11:24:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQ4NTg5Mw=="}], "type": "inlineReview", "revised_code": {"commit": "85e00affa9c2e4d251f659674d4e67e864af177d", "chunk": "diff --git a/app/src/main/java/fr/free/nrw/commons/media/ZoomableActivity.java b/app/src/main/java/fr/free/nrw/commons/media/ZoomableActivity.java\nindex 2e411f380..089d16a0a 100644\n--- a/app/src/main/java/fr/free/nrw/commons/media/ZoomableActivity.java\n+++ b/app/src/main/java/fr/free/nrw/commons/media/ZoomableActivity.java\n\n@@ -59,13 +59,22 @@ public class ZoomableActivity extends AppCompatActivity {\n         init();\n     }\n \n+    /**\n+     * Two types of loading indicators have been added to the zoom activity:\n+     *  1.  An Indeterminate spinner for showing the time lapsed between dispatch of the image request\n+     *      and starting to receiving the image.\n+     *  2.  ProgressBarDrawable that reflects how much image has been downloaded\n+     */\n     private final ControllerListener loadingListener = new BaseControllerListener<ImageInfo>() {\n         @Override\n         public void onSubmit(String id, Object callerContext) {\n+            // Sometimes the spinner doesn't appear when rapidly switching between images, this fixes that\n+            spinner.setVisibility(View.VISIBLE);\n         }\n \n         @Override\n         public void onIntermediateImageSet(String id, @Nullable ImageInfo imageInfo) {\n+            spinner.setVisibility(View.GONE);\n         }\n         @Override\n         public void onFinalImageSet(String id, @Nullable ImageInfo imageInfo, @Nullable Animatable animatable) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQ4NjM3OA==", "url": "https://github.com/commons-app/apps-android-commons/pull/3481#discussion_r391486378", "bodyText": "Why we are using a custom ProgressBar drawable, is this necessary?", "author": "neslihanturan", "createdAt": "2020-03-12T09:14:22Z", "path": "app/src/main/java/fr/free/nrw/commons/media/zoomControllers/loading/CircleProgressBarDrawable.java", "diffHunk": "@@ -0,0 +1,44 @@\n+package fr.free.nrw.commons.media.zoomControllers.loading;\n+\n+import android.graphics.Canvas;\n+import android.graphics.Paint;\n+import android.graphics.Rect;\n+import android.graphics.RectF;\n+\n+import com.facebook.drawee.drawable.ProgressBarDrawable;\n+\n+public class CircleProgressBarDrawable extends ProgressBarDrawable {", "originalCommit": "a972bb5bd03ac2b240a6b56d72a09194585f962d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQ5MzUyMw==", "url": "https://github.com/commons-app/apps-android-commons/pull/3481#discussion_r391493523", "bodyText": "The Fresco API demands it and the drawable they use in their sample is maybe the one used here, seeing as it has the same error, link\nI'd prefer to not use it and just have the indeterminate", "author": "macgills", "createdAt": "2020-03-12T09:28:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQ4NjM3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTU1NDkwMA==", "url": "https://github.com/commons-app/apps-android-commons/pull/3481#discussion_r391554900", "bodyText": "@neslihanturan i just realised that SimpleDraweeView in the Contributions home page while uploading shows linear progress bar so i think it would be more appropriate to keep linear one for UI consistency, i will change it\n@macgills i have added the progressbar because if the image size is heavy then it might take some time to load as @neslihanturan elucidated in the issue thread, i will replace circular progressbar with linear one while keeping the indeterminate spinner", "author": "kbhardwaj123", "createdAt": "2020-03-12T11:21:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQ4NjM3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTU1NjQzMg==", "url": "https://github.com/commons-app/apps-android-commons/pull/3481#discussion_r391556432", "bodyText": "It seems really confusing as a user that my image is loading twice. I don't mind if the bar is linear or circular but there should only be one loading indication", "author": "macgills", "createdAt": "2020-03-12T11:24:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQ4NjM3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTU2ODAzMA==", "url": "https://github.com/commons-app/apps-android-commons/pull/3481#discussion_r391568030", "bodyText": "@macgills i completely agree with you but the problem is that the\n\nIn-deterministic spinner would not account for the downloading of a big image file\nKeeping only progressBar will show a show black screen for 95% of the time as you correctly pointed out previously\n\nI think the best middle ground is to keep a linear progress bar which is much less intrusive and would fulfill the purpose of showing download progress,\nWhat do you think about this :)", "author": "kbhardwaj123", "createdAt": "2020-03-12T11:49:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQ4NjM3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTU3MDk4MA==", "url": "https://github.com/commons-app/apps-android-commons/pull/3481#discussion_r391570980", "bodyText": "By default show the indeterminate spinner, surely there is some callback imageLoadComplete where you can just hide it, the place that currently hides the progressdrawable.\nI don't know fresco well, I'd use picasso or maybe coil nowadays", "author": "macgills", "createdAt": "2020-03-12T11:55:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQ4NjM3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTU3MTY2Ng==", "url": "https://github.com/commons-app/apps-android-commons/pull/3481#discussion_r391571666", "bodyText": "Yeah just stop setting it Gone in onIntermediateImageSet", "author": "macgills", "createdAt": "2020-03-12T11:57:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQ4NjM3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTU3NTg2Mw==", "url": "https://github.com/commons-app/apps-android-commons/pull/3481#discussion_r391575863", "bodyText": "This is how it looks with the changes:\nThe blue bar at the bottom is the progress bar", "author": "kbhardwaj123", "createdAt": "2020-03-12T12:06:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQ4NjM3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTU4OTA0OQ==", "url": "https://github.com/commons-app/apps-android-commons/pull/3481#discussion_r391589049", "bodyText": "That works, just frustrating this scenario doesn't have better support in fresco.\nMaybe if we had a good placeholderImage it would feel less weird to me?", "author": "macgills", "createdAt": "2020-03-12T12:33:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQ4NjM3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk0OTU2OA==", "url": "https://github.com/commons-app/apps-android-commons/pull/3481#discussion_r396949568", "bodyText": "@macgills should i change anything else ?", "author": "kbhardwaj123", "createdAt": "2020-03-24T07:36:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQ4NjM3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk5NTM5OQ==", "url": "https://github.com/commons-app/apps-android-commons/pull/3481#discussion_r396995399", "bodyText": "I'll leave final say with @neslihanturan\nI still think only using the ProgressBar makes for a better visual experience", "author": "macgills", "createdAt": "2020-03-24T09:04:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQ4NjM3OA=="}], "type": "inlineReview", "revised_code": {"commit": "85e00affa9c2e4d251f659674d4e67e864af177d", "chunk": "diff --git a/app/src/main/java/fr/free/nrw/commons/media/zoomControllers/loading/CircleProgressBarDrawable.java b/app/src/main/java/fr/free/nrw/commons/media/zoomControllers/loading/CircleProgressBarDrawable.java\ndeleted file mode 100644\nindex c015acf6a..000000000\n--- a/app/src/main/java/fr/free/nrw/commons/media/zoomControllers/loading/CircleProgressBarDrawable.java\n+++ /dev/null\n\n@@ -1,44 +0,0 @@\n-package fr.free.nrw.commons.media.zoomControllers.loading;\n-\n-import android.graphics.Canvas;\n-import android.graphics.Paint;\n-import android.graphics.Rect;\n-import android.graphics.RectF;\n-\n-import com.facebook.drawee.drawable.ProgressBarDrawable;\n-\n-public class CircleProgressBarDrawable extends ProgressBarDrawable {\n-    private final Paint mPaint = new Paint(Paint.ANTI_ALIAS_FLAG);\n-    private int mLevel = 0;\n-    private int maxLevel = 10000;\n-\n-    @Override\n-    protected boolean onLevelChange(int level) {\n-        mLevel = level;\n-        invalidateSelf();\n-        return true;\n-    }\n-\n-    @Override\n-    public void draw(Canvas canvas) {\n-        if (getHideWhenZero() && mLevel == 0) {\n-            return;\n-        }\n-        drawBar(canvas, maxLevel, getBackgroundColor());\n-        drawBar(canvas, mLevel, getColor());\n-    }\n-\n-    private void drawBar(Canvas canvas, int level, int color) {\n-        Rect bounds = getBounds();\n-        RectF rectF =\n-                new RectF(\n-                        (float) (bounds.right * .4),\n-                        (float) (bounds.bottom * .45),\n-                        (float) (bounds.right * .6),\n-                        (float) (bounds.bottom * .55));\n-        mPaint.setColor(color);\n-        mPaint.setStyle(Paint.Style.STROKE);\n-        mPaint.setStrokeWidth(6);\n-        if (level != 0) canvas.drawArc(rectF, 0, (float) (level * 360 / maxLevel), false, mPaint);\n-    }\n-}\n"}}, {"oid": "85e00affa9c2e4d251f659674d4e67e864af177d", "url": "https://github.com/commons-app/apps-android-commons/commit/85e00affa9c2e4d251f659674d4e67e864af177d", "message": " remove circular progressbar and make changes to controller listener", "committedDate": "2020-03-12T11:41:30Z", "type": "commit"}]}