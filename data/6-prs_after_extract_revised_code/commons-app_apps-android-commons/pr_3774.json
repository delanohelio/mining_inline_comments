{"pr_number": 3774, "pr_title": "Add destroyed column to BookmarkLocation table (##3729)", "pr_createdAt": "2020-05-26T06:05:53Z", "pr_url": "https://github.com/commons-app/apps-android-commons/pull/3774", "timeline": [{"oid": "4dd1608a0ffde04b26126a7fb719f65592ac4022", "url": "https://github.com/commons-app/apps-android-commons/commit/4dd1608a0ffde04b26126a7fb719f65592ac4022", "message": "Add destroyed column to BookmarkLocation table (##3729)", "committedDate": "2020-05-26T05:57:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDIxOTQ2MQ==", "url": "https://github.com/commons-app/apps-android-commons/pull/3774#discussion_r430219461", "bodyText": "this from == x && to == y is not how it should be done, typically this is done in a switch on from and you just let it fallthrough.\nThe problem is that we can never guarantee a user upgrades monotonically, a user could theoretically go from v1 to v100 with none of the intervening updates and migrations should happily walk them along that path", "author": "macgills", "createdAt": "2020-05-26T07:48:46Z", "path": "app/src/main/java/fr/free/nrw/commons/bookmarks/locations/BookmarkLocationsDao.java", "diffHunk": "@@ -276,6 +280,15 @@ public static void onUpdate(SQLiteDatabase db, int from, int to) {\n                 }\n                 return;\n             }\n+            if (from == 12 && to == 13) {", "originalCommit": "4dd1608a0ffde04b26126a7fb719f65592ac4022", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDIyOTk1OA==", "url": "https://github.com/commons-app/apps-android-commons/pull/3774#discussion_r430229958", "bodyText": "So should I go ahead and change it to switch with fall through?", "author": "gvaibhav1734", "createdAt": "2020-05-26T08:06:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDIxOTQ2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDIzMjU4OQ==", "url": "https://github.com/commons-app/apps-android-commons/pull/3774#discussion_r430232589", "bodyText": "Yes please", "author": "macgills", "createdAt": "2020-05-26T08:11:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDIxOTQ2MQ=="}], "type": "inlineReview", "revised_code": {"commit": "f5e005438268d8d5b51bf10158dd6f196ab6448d", "chunk": "diff --git a/app/src/main/java/fr/free/nrw/commons/bookmarks/locations/BookmarkLocationsDao.java b/app/src/main/java/fr/free/nrw/commons/bookmarks/locations/BookmarkLocationsDao.java\nindex db5e87a9e..4b9fe4b55 100644\n--- a/app/src/main/java/fr/free/nrw/commons/bookmarks/locations/BookmarkLocationsDao.java\n+++ b/app/src/main/java/fr/free/nrw/commons/bookmarks/locations/BookmarkLocationsDao.java\n\n@@ -248,46 +248,24 @@ public class BookmarkLocationsDao {\n \n         public static void onUpdate(SQLiteDatabase db, int from, int to) {\n             Timber.d(\"bookmarksLocations db is updated from:\"+from+\", to:\"+to);\n-            if (from == to) {\n-                return;\n-            }\n-            if (from < 7) {\n-                // doesn't exist yet\n-                from++;\n-                onUpdate(db, from, to);\n-                return;\n-            }\n-            if (from == 7) {\n-                // table added in version 8\n-                onCreate(db);\n-                from++;\n-                onUpdate(db, from, to);\n-                return;\n-            }\n-            if (from == 8) {\n-                from++;\n-                onUpdate(db, from, to);\n-                return;\n-            }\n-            if (from == 10 && to == 11) {\n-                from++;\n-                //This is safe, and can be called clean, as we/I do not remember the appropriate version for this\n-                //We are anyways switching to room, these things won't be nescessary then\n-                try {\n-                    db.execSQL(\"ALTER TABLE bookmarksLocations ADD COLUMN location_pic STRING;\");\n-                }catch (SQLiteException exception){\n-                    Timber.e(exception);//\n-                }\n-                return;\n-            }\n-            if (from == 12 && to == 13) {\n-                from++;\n-                try {\n-                    db.execSQL(\"ALTER TABLE bookmarksLocations ADD COLUMN location_destroyed STRING;\");\n-                }catch (SQLiteException exception){\n-                    Timber.e(exception);//\n-                }\n-                return;\n+            switch (from) {\n+                case 7: onCreate(db);\n+                case 8: // No change\n+                case 9: // No change\n+                case 10:\n+                    try {\n+                        db.execSQL(\"ALTER TABLE bookmarksLocations ADD COLUMN location_pic STRING;\");\n+                    } catch (SQLiteException exception){\n+                        Timber.e(exception);\n+                    }\n+                case 11: // No change\n+                case 12:\n+                    try {\n+                        db.execSQL(\"ALTER TABLE bookmarksLocations ADD COLUMN location_destroyed STRING;\");\n+                    }catch (SQLiteException exception){\n+                        Timber.e(exception);\n+                    }\n+                    break;\n             }\n         }\n     }\n"}}, {"oid": "f5e005438268d8d5b51bf10158dd6f196ab6448d", "url": "https://github.com/commons-app/apps-android-commons/commit/f5e005438268d8d5b51bf10158dd6f196ab6448d", "message": "switch with fall through for migrations", "committedDate": "2020-05-26T08:24:39Z", "type": "commit"}]}