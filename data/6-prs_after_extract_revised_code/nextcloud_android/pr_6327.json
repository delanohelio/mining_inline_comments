{"pr_number": 6327, "pr_title": "Combined ShareActivity with FileDetailSharingFragment as much as possible", "pr_createdAt": "2020-06-22T08:13:45Z", "pr_url": "https://github.com/nextcloud/android/pull/6327", "timeline": [{"oid": "8c71f3aa868947b0399b509f7b1e261795700591", "url": "https://github.com/nextcloud/android/commit/8c71f3aa868947b0399b509f7b1e261795700591", "message": "Combined ShareActivity with FileDetailSharingFragment as much as possible\n\nSigned-off-by: tobiasKaminsky <tobias@kaminsky.me>", "committedDate": "2020-06-22T08:31:27Z", "type": "forcePushed"}, {"oid": "cd0a51f442b9ab9bfd06ec9b2bea912e9eb41191", "url": "https://github.com/nextcloud/android/commit/cd0a51f442b9ab9bfd06ec9b2bea912e9eb41191", "message": "Combined ShareActivity with FileDetailSharingFragment as much as possible\n\nSigned-off-by: tobiasKaminsky <tobias@kaminsky.me>", "committedDate": "2020-06-22T10:29:32Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQ5MjE0OQ==", "url": "https://github.com/nextcloud/android/pull/6327#discussion_r443492149", "bodyText": "this identation seems wrong", "author": "AndyScherzinger", "createdAt": "2020-06-22T11:26:57Z", "path": "src/main/java/com/owncloud/android/ui/activity/FileActivity.java", "diffHunk": "@@ -377,10 +391,24 @@ public void onRemoteOperationFinish(RemoteOperation operation, RemoteOperationRe\n \n             } else {\n                 DisplayUtils.showSnackMessage(\n-                        this, ErrorMessageAdapter.getErrorCauseMessage(result, operation, getResources())\n-                );\n+                    this, ErrorMessageAdapter.getErrorCauseMessage(result, operation, getResources())\n+                                             );", "originalCommit": "cd0a51f442b9ab9bfd06ec9b2bea912e9eb41191", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "97c95d4eee05dde3d59da411479b0faa1bee87ab", "chunk": "diff --git a/src/main/java/com/owncloud/android/ui/activity/FileActivity.java b/src/main/java/com/owncloud/android/ui/activity/FileActivity.java\nindex 3ba432206..4ddb48184 100644\n--- a/src/main/java/com/owncloud/android/ui/activity/FileActivity.java\n+++ b/src/main/java/com/owncloud/android/ui/activity/FileActivity.java\n\n@@ -390,9 +390,10 @@ public abstract class FileActivity extends DrawerActivity\n                 updateFileFromDB();\n \n             } else {\n-                DisplayUtils.showSnackMessage(\n-                    this, ErrorMessageAdapter.getErrorCauseMessage(result, operation, getResources())\n-                                             );\n+                DisplayUtils.showSnackMessage(this,\n+                                              ErrorMessageAdapter.getErrorCauseMessage(result,\n+                                                                                       operation,\n+                                                                                       getResources()));\n             }\n         }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQ5NDExMg==", "url": "https://github.com/nextcloud/android/pull/6327#discussion_r443494112", "bodyText": "also see below, this is a naming pattern and should thus be extracted to a separate method", "author": "AndyScherzinger", "createdAt": "2020-06-22T11:31:16Z", "path": "src/main/java/com/owncloud/android/ui/activity/FileActivity.java", "diffHunk": "@@ -720,4 +749,170 @@ public static void showShareLinkDialog(FileActivity activity, OCFile file, Strin\n         DialogFragment chooserDialog = ShareLinkToDialog.newInstance(intentToShareLink, packagesToExclude);\n         chooserDialog.show(activity.getSupportFragmentManager(), FileDisplayActivity.FTAG_CHOOSER_DIALOG);\n     }\n+\n+    private void onUpdateNoteForShareOperationFinish(RemoteOperationResult result) {\n+        FileDetailSharingFragment sharingFragment = getShareFileFragment();\n+\n+        if (result.isSuccess()) {\n+            if (sharingFragment != null) {\n+                sharingFragment.refreshPublicShareFromDB();\n+                sharingFragment.onUpdateShareInformation(result, getFile());\n+            }\n+        } else {\n+            DisplayUtils.showSnackMessage(this, R.string.note_could_not_sent);\n+        }\n+    }\n+\n+    private void onUpdateShareInformation(RemoteOperationResult result, @StringRes int defaultError) {\n+        Snackbar snackbar;\n+        FileDetailSharingFragment sharingFragment = getShareFileFragment();\n+\n+        if (result.isSuccess()) {\n+            updateFileFromDB();\n+            if (sharingFragment != null) {\n+                sharingFragment.onUpdateShareInformation(result, getFile());\n+            }\n+        } else if (sharingFragment != null && sharingFragment.getView() != null) {\n+            String errorResponse;\n+\n+            if (result.getData() != null && result.getData().size() > 0) {\n+                errorResponse = result.getData().get(0).toString();\n+            } else {\n+                errorResponse = \"\";\n+            }\n+\n+            if (!TextUtils.isEmpty(errorResponse)) {\n+                snackbar = Snackbar.make(sharingFragment.getView(), errorResponse, Snackbar.LENGTH_LONG);\n+            } else {\n+                snackbar = Snackbar.make(sharingFragment.getView(), defaultError, Snackbar.LENGTH_LONG);\n+            }\n+\n+            ThemeUtils.colorSnackbar(this, snackbar);\n+            snackbar.show();\n+        }\n+    }\n+\n+    private void onCreateShareViaLinkOperationFinish(CreateShareViaLinkOperation operation,\n+                                                     RemoteOperationResult result) {\n+        FileDetailSharingFragment sharingFragment = getShareFileFragment();\n+\n+        if (sharingFragment == null) {\n+            Log_OC.e(this, \"Access to non-existing file FileDetailSharingFragment\");\n+            return;\n+        }\n+\n+        if (result.isSuccess()) {\n+            updateFileFromDB();\n+\n+            // if share to user and share via link multiple ocshares are returned,\n+            // therefore filtering for public_link\n+            String link = \"\";\n+            OCFile file = null;\n+            for (Object object : result.getData()) {\n+                OCShare shareLink = (OCShare) object;\n+                if (TAG_PUBLIC_LINK.equalsIgnoreCase(shareLink.getShareType().name())) {\n+                    link = shareLink.getShareLink();\n+                    file = getStorageManager().getFileByPath(shareLink.getPath());\n+                    break;\n+                }\n+            }\n+\n+            copyAndShareFileLink(this, file, link);\n+\n+            sharingFragment.refreshPublicShareFromDB();\n+            sharingFragment.onUpdateShareInformation(result, getFile());\n+        } else {\n+            // Detect Failure (403) --> maybe needs password\n+            String password = operation.getPassword();\n+            if (result.getCode() == RemoteOperationResult.ResultCode.SHARE_FORBIDDEN &&\n+                TextUtils.isEmpty(password) &&\n+                getCapabilities().getFilesSharingPublicEnabled().isUnknown()) {\n+                // Was tried without password, but not sure that it's optional.\n+\n+                // Try with password before giving up; see also ShareFileFragment#OnShareViaLinkListener\n+                if (sharingFragment.isAdded()) { // only if added to the view hierarchy\n+\n+                    sharingFragment.requestPasswordForShareViaLink(true,\n+                                                                   getCapabilities().getFilesSharingPublicAskForOptionalPassword()\n+                                                                       .isTrue());\n+                }\n+\n+            } else {\n+                sharingFragment.refreshPublicShareFromDB();\n+                Snackbar snackbar = Snackbar.make(findViewById(android.R.id.content),\n+                                                  ErrorMessageAdapter.getErrorCauseMessage(result,\n+                                                                                           operation,\n+                                                                                           getResources()),\n+                                                  Snackbar.LENGTH_LONG);\n+                ThemeUtils.colorSnackbar(this, snackbar);\n+                snackbar.show();\n+            }\n+        }\n+    }\n+\n+    /**\n+     * Shortcut to get access to the {@link FileDetailSharingFragment} instance, if any\n+     *\n+     * @return A {@link FileDetailSharingFragment} instance, or null\n+     */\n+    private @Nullable\n+    FileDetailSharingFragment getShareFileFragment() {\n+        Fragment fragment = getSupportFragmentManager().findFragmentByTag(ShareActivity.TAG_SHARE_FRAGMENT);\n+\n+        if (fragment == null) {\n+            fragment = getSupportFragmentManager().findFragmentByTag(TAG_SECOND_FRAGMENT);\n+        }\n+\n+        if (fragment instanceof FileDetailSharingFragment) {\n+            return (FileDetailSharingFragment) fragment;\n+        } else if (fragment instanceof FileDetailFragment) {\n+            FileDetailFragment fileDetailFragment = (FileDetailFragment) fragment;\n+            return fileDetailFragment.getFileDetailSharingFragment();\n+        } else {\n+            return null;\n+        }\n+    }\n+\n+    @Override\n+    protected void onNewIntent(Intent intent) {\n+        super.onNewIntent(intent);\n+\n+        if (UsersAndGroupsSearchProvider.ACTION_SHARE_WITH.equals(intent.getAction())) {\n+            Uri data = intent.getData();\n+            String dataString = intent.getDataString();\n+            String shareWith = dataString.substring(dataString.lastIndexOf('/') + 1);\n+\n+            ArrayList<String> existingSharees = new ArrayList<>();\n+            for (OCShare share : getStorageManager().getSharesWithForAFile(getFile().getRemotePath(),\n+                                                                           getAccount().name)) {\n+                existingSharees.add(share.getShareType() + \"_\" + share.getShareWith());", "originalCommit": "cd0a51f442b9ab9bfd06ec9b2bea912e9eb41191", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ad768c8a48d89b1ad6b2786e822a2d9ff6f197d9", "chunk": "diff --git a/src/main/java/com/owncloud/android/ui/activity/FileActivity.java b/src/main/java/com/owncloud/android/ui/activity/FileActivity.java\nindex 3ba432206..29faee39f 100644\n--- a/src/main/java/com/owncloud/android/ui/activity/FileActivity.java\n+++ b/src/main/java/com/owncloud/android/ui/activity/FileActivity.java\n\n@@ -796,11 +797,6 @@ public abstract class FileActivity extends DrawerActivity\n                                                      RemoteOperationResult result) {\n         FileDetailSharingFragment sharingFragment = getShareFileFragment();\n \n-        if (sharingFragment == null) {\n-            Log_OC.e(this, \"Access to non-existing file FileDetailSharingFragment\");\n-            return;\n-        }\n-\n         if (result.isSuccess()) {\n             updateFileFromDB();\n \n"}}, {"oid": "79355d5e1c3cf877231835bb59337951380e7d06", "url": "https://github.com/nextcloud/android/commit/79355d5e1c3cf877231835bb59337951380e7d06", "message": "Combined ShareActivity with FileDetailSharingFragment as much as possible\n\nSigned-off-by: tobiasKaminsky <tobias@kaminsky.me>", "committedDate": "2020-06-23T08:08:28Z", "type": "forcePushed"}, {"oid": "97c95d4eee05dde3d59da411479b0faa1bee87ab", "url": "https://github.com/nextcloud/android/commit/97c95d4eee05dde3d59da411479b0faa1bee87ab", "message": "Combined ShareActivity with FileDetailSharingFragment as much as possible\n\nSigned-off-by: tobiasKaminsky <tobias@kaminsky.me>", "committedDate": "2020-06-23T08:12:35Z", "type": "forcePushed"}, {"oid": "ad768c8a48d89b1ad6b2786e822a2d9ff6f197d9", "url": "https://github.com/nextcloud/android/commit/ad768c8a48d89b1ad6b2786e822a2d9ff6f197d9", "message": "Combined ShareActivity with FileDetailSharingFragment as much as possible\n\nSigned-off-by: tobiasKaminsky <tobias@kaminsky.me>", "committedDate": "2020-06-23T08:30:04Z", "type": "forcePushed"}, {"oid": "7732ff065b143167db2b4aa40aa4d0523ec2d74d", "url": "https://github.com/nextcloud/android/commit/7732ff065b143167db2b4aa40aa4d0523ec2d74d", "message": "Combined ShareActivity with FileDetailSharingFragment as much as possible\n\nSigned-off-by: tobiasKaminsky <tobias@kaminsky.me>", "committedDate": "2020-06-23T08:47:43Z", "type": "commit"}, {"oid": "7732ff065b143167db2b4aa40aa4d0523ec2d74d", "url": "https://github.com/nextcloud/android/commit/7732ff065b143167db2b4aa40aa4d0523ec2d74d", "message": "Combined ShareActivity with FileDetailSharingFragment as much as possible\n\nSigned-off-by: tobiasKaminsky <tobias@kaminsky.me>", "committedDate": "2020-06-23T08:47:43Z", "type": "forcePushed"}]}