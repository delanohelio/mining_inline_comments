{"pr_number": 5447, "pr_title": "Migrate jobs to new user model", "pr_createdAt": "2020-02-10T22:00:44Z", "pr_url": "https://github.com/nextcloud/android/pull/5447", "timeline": [{"oid": "0e0be9207baae0a24d3e168eec46055149d0351a", "url": "https://github.com/nextcloud/android/commit/0e0be9207baae0a24d3e168eec46055149d0351a", "message": "Migrated jobs to new user model\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-02-10T22:05:02Z", "type": "forcePushed"}, {"oid": "0afc2645c437dfd63b706945127971536c0e9e5d", "url": "https://github.com/nextcloud/android/commit/0afc2645c437dfd63b706945127971536c0e9e5d", "message": "Migrated jobs to new user model\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-02-14T06:22:20Z", "type": "commit"}, {"oid": "0afc2645c437dfd63b706945127971536c0e9e5d", "url": "https://github.com/nextcloud/android/commit/0afc2645c437dfd63b706945127971536c0e9e5d", "message": "Migrated jobs to new user model\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-02-14T06:22:20Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTM0MTMwMQ==", "url": "https://github.com/nextcloud/android/pull/5447#discussion_r379341301", "bodyText": "I know that this was used before, so I am totally fine to re-use this.\nBut as our approach as to get rid of 3rd party libs, we should think about removing EventBus and evernote Job scheduling, but rely on WorkManager and\n[https://developer.android.com/topic/libraries/architecture/workmanager/how-to/states-and-observation#observing](observing your work)\nBut let us do this in a following PR, please :-)", "author": "tobiasKaminsky", "createdAt": "2020-02-14T09:56:54Z", "path": "src/main/java/com/owncloud/android/jobs/AccountRemovalJob.java", "diffHunk": "@@ -75,100 +76,121 @@\n /**\n  * Removes account and all local files\n  */\n-public class AccountRemovalJob extends Job implements AccountManagerCallback<Boolean> {\n+public class AccountRemovalJob extends Job {\n     public static final String TAG = \"AccountRemovalJob\";\n     public static final String ACCOUNT = \"account\";\n     public static final String REMOTE_WIPE = \"remote_wipe\";\n \n     private final UploadsStorageManager uploadsStorageManager;\n     private final UserAccountManager userAccountManager;\n     private final Clock clock;\n+    private final EventBus eventBus;", "originalCommit": "0afc2645c437dfd63b706945127971536c0e9e5d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTM0MjA3NQ==", "url": "https://github.com/nextcloud/android/pull/5447#discussion_r379342075", "bodyText": "I understand the evernote thing, but why is it that we hate eventbus these days? It's a relatively established and long-living project that won't disappear tomorrow.", "author": "mario", "createdAt": "2020-02-14T09:58:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTM0MTMwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTU1OTkzNA==", "url": "https://github.com/nextcloud/android/pull/5447#discussion_r379559934", "bodyText": "@tobiasKaminsky I didn't add it - I just extracted a dependency that was explicitly created in a job constructor.\n@mario Good question!\nEventBus is not a bad piece of engineering in itself. However, how it's being used in practice is another story and mileage will vary.\nI wouldn't say I personally hate it. Event bus design pattern has it's place. I think that - as usual with engineering concepts - some people observed abuses and spoke loud about them. Some were more mature at verbalizing the issues, some - maybe pursuing social maedia traction - just vented out anger calling ppl names.\nIf we ask ourselves \"why\" in a serious manner, I can find few issues with event bus pattern in general, in no relation to Nextcloud app:\n\nit's very temping to inroduce hidden tight coupling between componets (no direct source-level dependency, but dependencies caused by complex event patterns)\ncascade of event posts makes callstack analysis challenging; it becomes very tricky if events are sent bi-directionally between many actors; this is what makes contribues seriously to microservices debugging difficulty and market is raging with fancy distributed-log-as-a-service solutions\nevent storms :-)\nupredictable and untraceable code paths - your component can be called from many places\n\nThose issues don't necessarily make event bus an anti-pattern, but migh influence a decision of using it or not. It can surely save you some typing, but typing is not a bottleneck in more complex systems. Also, at certain level of complexity, team/company social considerations cannot be dismissed lightly and more involving patterns, but requiring less engineering discipline might be preferred over more convenient ones, but requiring more informed or governed approach.\nBTW, we have LocalBroadcastManager that can serve this role as well. The drawback of LMB is that it requires Android platform in tests, so I wouldn't be so sure at all that we are anxious to remove EventBus. :-)", "author": "ezaquarii", "createdAt": "2020-02-14T17:42:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTM0MTMwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTg3ODcyNw==", "url": "https://github.com/nextcloud/android/pull/5447#discussion_r379878727", "bodyText": "I am aware of \"people\" complaining and the bad patterns surrounding EventBus, some of which are also inside Nextcloud (not the least, some written by me). Nevertheless, I really appreciate you taking the time to explain your thoughts in detail. Thank you once again for being awesome!", "author": "mario", "createdAt": "2020-02-16T06:28:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTM0MTMwMQ=="}], "type": "inlineReview", "revised_code": {"commit": "7b4e1b82e3b48756f75f135451825fe25e43838d", "chunk": "diff --git a/src/main/java/com/owncloud/android/jobs/AccountRemovalJob.java b/src/main/java/com/owncloud/android/jobs/AccountRemovalJob.java\nindex a79b9804a..2e36c39f2 100644\n--- a/src/main/java/com/owncloud/android/jobs/AccountRemovalJob.java\n+++ b/src/main/java/com/owncloud/android/jobs/AccountRemovalJob.java\n\n@@ -68,7 +67,6 @@ import java.util.ArrayList;\n import java.util.List;\n \n import androidx.annotation.NonNull;\n-import androidx.annotation.Nullable;\n \n import static android.content.Context.ACCOUNT_SERVICE;\n import static com.owncloud.android.ui.activity.ManageAccountsActivity.PENDING_FOR_REMOVAL;\n"}}, {"oid": "7b4e1b82e3b48756f75f135451825fe25e43838d", "url": "https://github.com/nextcloud/android/commit/7b4e1b82e3b48756f75f135451825fe25e43838d", "message": "change cancelContactBackupJobForAccount to user new User class\n\nSigned-off-by: tobiasKaminsky <tobias@kaminsky.me>", "committedDate": "2020-02-14T10:08:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTM0ODc4Mg==", "url": "https://github.com/nextcloud/android/pull/5447#discussion_r379348782", "bodyText": "Issue found: Avoid instantiating new objects inside loops", "author": "nextcloud-android-bot", "createdAt": "2020-02-14T10:11:48Z", "path": "src/main/java/com/owncloud/android/jobs/OfflineSyncJob.java", "diffHunk": "@@ -89,10 +90,10 @@ protected Result onRunJob(@NonNull Params params) {\n                 }\n             }\n \n-            Account[] accounts = userAccountManager.getAccounts();\n+            List<User> users = userAccountManager.getAllUsers();\n \n-            for (Account account : accounts) {\n-                FileDataStorageManager storageManager = new FileDataStorageManager(account,\n+            for (User user : users) {\n+                FileDataStorageManager storageManager = new FileDataStorageManager(user.toPlatformAccount(),", "originalCommit": "7b4e1b82e3b48756f75f135451825fe25e43838d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTM0ODc5Mg==", "url": "https://github.com/nextcloud/android/pull/5447#discussion_r379348792", "bodyText": "Issue found: Avoid instantiating new objects inside loops", "author": "nextcloud-android-bot", "createdAt": "2020-02-14T10:11:49Z", "path": "src/main/java/com/owncloud/android/jobs/OfflineSyncJob.java", "diffHunk": "@@ -101,7 +102,7 @@ protected Result onRunJob(@NonNull Params params) {\n                     break;\n                 }\n \n-                recursive(new File(ocRoot.getStoragePath()), storageManager, account);\n+                recursive(new File(ocRoot.getStoragePath()), storageManager, user);", "originalCommit": "7b4e1b82e3b48756f75f135451825fe25e43838d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTM0ODgwMg==", "url": "https://github.com/nextcloud/android/pull/5447#discussion_r379348802", "bodyText": "Issue found: Deeply nested if..then statements are hard to read", "author": "nextcloud-android-bot", "createdAt": "2020-02-14T10:11:50Z", "path": "src/main/java/com/owncloud/android/jobs/MediaFoldersDetectionJob.java", "diffHunk": "@@ -138,32 +138,41 @@ protected Result onRunJob(@NonNull Params params) {\n                 videoMediaFolderPaths.removeAll(mediaFoldersModel.getVideoMediaFolders());\n \n                 if (!imageMediaFolderPaths.isEmpty() || !videoMediaFolderPaths.isEmpty()) {\n-                    Account[] accounts = userAccountManager.getAccounts();\n-                    List<Account> accountList = new ArrayList<>();\n-                    for (Account account : accounts) {\n-                        if (!arbitraryDataProvider.getBooleanValue(account, ManageAccountsActivity.PENDING_FOR_REMOVAL)) {\n-                            accountList.add(account);\n+                    List<User> allUsers = userAccountManager.getAllUsers();\n+                    List<User> activeUsers = new ArrayList<>();\n+                    for (User account : allUsers) {\n+                        if (!arbitraryDataProvider.getBooleanValue(account.toPlatformAccount(),\n+                                                                   ManageAccountsActivity.PENDING_FOR_REMOVAL)) {\n+                            activeUsers.add(account);\n                         }\n                     }\n \n-                    for (Account account : accountList) {\n+                    for (User user : activeUsers) {\n                         for (String imageMediaFolder : imageMediaFolderPaths) {\n-                            if (syncedFolderProvider.findByLocalPathAndAccount(imageMediaFolder, account) == null) {\n-                                sendNotification(String.format(context.getString(R.string.new_media_folder_detected),\n-                                    context.getString(R.string.new_media_folder_photos)),\n-                                    imageMediaFolder.substring(imageMediaFolder.lastIndexOf('/') + 1\n-                                    ),\n-                                    account, imageMediaFolder, 1);\n+                            final SyncedFolder folder = syncedFolderProvider.findByLocalPathAndAccount(imageMediaFolder,\n+                                                                                                       user.toPlatformAccount());\n+                            if (folder == null) {\n+                                String contentTitle = String.format(context.getString(R.string.new_media_folder_detected),\n+                                                                    context.getString(R.string.new_media_folder_photos));\n+                                sendNotification(contentTitle,\n+                                                imageMediaFolder.substring(imageMediaFolder.lastIndexOf('/') + 1),\n+                                                user,\n+                                                imageMediaFolder,\n+                                                 1);\n                             }\n                         }\n \n                         for (String videoMediaFolder : videoMediaFolderPaths) {\n-                            if (syncedFolderProvider.findByLocalPathAndAccount(videoMediaFolder, account) == null) {\n-                                sendNotification(String.format(context.getString(R.string.new_media_folder_detected),\n-                                    context.getString(R.string.new_media_folder_videos)),\n-                                    videoMediaFolder.substring(videoMediaFolder.lastIndexOf('/') + 1\n-                                    ),\n-                                    account, videoMediaFolder, 2);\n+                            final SyncedFolder folder = syncedFolderProvider.findByLocalPathAndAccount(videoMediaFolder,\n+                                                                                                       user.toPlatformAccount());\n+                            if (folder == null) {", "originalCommit": "7b4e1b82e3b48756f75f135451825fe25e43838d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTM0ODgxOQ==", "url": "https://github.com/nextcloud/android/pull/5447#discussion_r379348819", "bodyText": "Issue found: Deeply nested if..then statements are hard to read", "author": "nextcloud-android-bot", "createdAt": "2020-02-14T10:11:51Z", "path": "src/main/java/com/owncloud/android/jobs/MediaFoldersDetectionJob.java", "diffHunk": "@@ -138,32 +138,41 @@ protected Result onRunJob(@NonNull Params params) {\n                 videoMediaFolderPaths.removeAll(mediaFoldersModel.getVideoMediaFolders());\n \n                 if (!imageMediaFolderPaths.isEmpty() || !videoMediaFolderPaths.isEmpty()) {\n-                    Account[] accounts = userAccountManager.getAccounts();\n-                    List<Account> accountList = new ArrayList<>();\n-                    for (Account account : accounts) {\n-                        if (!arbitraryDataProvider.getBooleanValue(account, ManageAccountsActivity.PENDING_FOR_REMOVAL)) {\n-                            accountList.add(account);\n+                    List<User> allUsers = userAccountManager.getAllUsers();\n+                    List<User> activeUsers = new ArrayList<>();\n+                    for (User account : allUsers) {\n+                        if (!arbitraryDataProvider.getBooleanValue(account.toPlatformAccount(),", "originalCommit": "7b4e1b82e3b48756f75f135451825fe25e43838d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}