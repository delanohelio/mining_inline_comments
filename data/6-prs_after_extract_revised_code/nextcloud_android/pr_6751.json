{"pr_number": 6751, "pr_title": "Reset last sync date of files written via DocumentsProvider", "pr_createdAt": "2020-08-19T15:05:00Z", "pr_url": "https://github.com/nextcloud/android/pull/6751", "timeline": [{"oid": "f23010c97f190cd14bf64f56d65626022b4e860b", "url": "https://github.com/nextcloud/android/commit/f23010c97f190cd14bf64f56d65626022b4e860b", "message": "Reset last sync date of files written via DocumentsProvider\n\nThe sync operation detects changes by comparing timestamps in\nmilliseconds. However, the local modification time only has a precision\nof seconds (even though given in milliseconds).\nWhen the DocumentsProvider is used programmatically, operations such as\na create and a subsequent write can happen within the same second\ncausing the sync operation to not detect the change and therefore\nfailing to upload a file causing data loss.\n\nThis commit also moves the file close listener to the thread used by the\nDocumentsStorageProvider as this is more appropriate than the UI thread.\n\nFixes #6726\n\nSigned-off-by: Torsten Grote <t@grobox.de>", "committedDate": "2020-08-19T15:05:16Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDU3NTYxNg==", "url": "https://github.com/nextcloud/android/pull/6751#discussion_r474575616", "bodyText": "Why did you extracted the handler to a member of this class?", "author": "tobiasKaminsky", "createdAt": "2020-08-21T09:29:52Z", "path": "src/main/java/com/owncloud/android/providers/DocumentsStorageProvider.java", "diffHunk": "@@ -101,6 +101,7 @@\n     private static final long CACHE_EXPIRATION = TimeUnit.MILLISECONDS.convert(1, TimeUnit.MINUTES);\n \n     UserAccountManager accountManager;\n+    Handler handler;", "originalCommit": "f23010c97f190cd14bf64f56d65626022b4e860b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDY2MDQ4NQ==", "url": "https://github.com/nextcloud/android/pull/6751#discussion_r474660485", "bodyText": "Good you ask. I had assumed that by moving the Handler creation here, we could get the OnCloseListener executed on the I/OI Thread that the document provider methods are called on. However, it seems that the provider's onCreate() is also called from the main/UI thread, so creating the Handler differently doesn't help. I have thus reverted this change.", "author": "grote", "createdAt": "2020-08-21T12:18:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDU3NTYxNg=="}], "type": "inlineReview", "revised_code": {"commit": "64ec7053989e16f5353204ddb79c1a58beb90baa", "chunk": "diff --git a/src/main/java/com/owncloud/android/providers/DocumentsStorageProvider.java b/src/main/java/com/owncloud/android/providers/DocumentsStorageProvider.java\nindex ec285ecb0..e5d324b33 100644\n--- a/src/main/java/com/owncloud/android/providers/DocumentsStorageProvider.java\n+++ b/src/main/java/com/owncloud/android/providers/DocumentsStorageProvider.java\n\n@@ -101,7 +101,6 @@ public class DocumentsStorageProvider extends DocumentsProvider {\n     private static final long CACHE_EXPIRATION = TimeUnit.MILLISECONDS.convert(1, TimeUnit.MINUTES);\n \n     UserAccountManager accountManager;\n-    Handler handler;\n \n     private static final String DOCUMENTID_SEPARATOR = \"/\";\n     private static final int DOCUMENTID_PARTS = 2;\n"}}, {"oid": "64ec7053989e16f5353204ddb79c1a58beb90baa", "url": "https://github.com/nextcloud/android/commit/64ec7053989e16f5353204ddb79c1a58beb90baa", "message": "Reset last sync date of files written via DocumentsProvider\n\nThe sync operation detects changes by comparing timestamps in\nmilliseconds. However, the local modification time only has a precision\nof seconds (even though given in milliseconds).\nWhen the DocumentsProvider is used programmatically, operations such as\na create and a subsequent write can happen within the same second\ncausing the sync operation to not detect the change and therefore\nfailing to upload a file causing data loss.\n\nThis commit also moves the file close listener to the thread used by the\nDocumentsStorageProvider as this is more appropriate than the UI thread.\n\nFixes #6726\n\nSigned-off-by: Torsten Grote <t@grobox.de>", "committedDate": "2020-08-21T12:15:19Z", "type": "commit"}, {"oid": "64ec7053989e16f5353204ddb79c1a58beb90baa", "url": "https://github.com/nextcloud/android/commit/64ec7053989e16f5353204ddb79c1a58beb90baa", "message": "Reset last sync date of files written via DocumentsProvider\n\nThe sync operation detects changes by comparing timestamps in\nmilliseconds. However, the local modification time only has a precision\nof seconds (even though given in milliseconds).\nWhen the DocumentsProvider is used programmatically, operations such as\na create and a subsequent write can happen within the same second\ncausing the sync operation to not detect the change and therefore\nfailing to upload a file causing data loss.\n\nThis commit also moves the file close listener to the thread used by the\nDocumentsStorageProvider as this is more appropriate than the UI thread.\n\nFixes #6726\n\nSigned-off-by: Torsten Grote <t@grobox.de>", "committedDate": "2020-08-21T12:15:19Z", "type": "forcePushed"}]}