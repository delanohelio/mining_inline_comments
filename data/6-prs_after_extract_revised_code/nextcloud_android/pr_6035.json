{"pr_number": 6035, "pr_title": "Add etag column to capabilities table", "pr_createdAt": "2020-05-09T16:02:39Z", "pr_url": "https://github.com/nextcloud/android/pull/6035", "timeline": [{"oid": "4dd87cc07081bc317790065a46ad57cd99beb888", "url": "https://github.com/nextcloud/android/commit/4dd87cc07081bc317790065a46ad57cd99beb888", "message": "Add etag column to capabilities table\n\nSigned-off-by: Daniel Kesselberg <mail@danielkesselberg.de>", "committedDate": "2020-05-09T16:03:27Z", "type": "forcePushed"}, {"oid": "552a058fc6a05bd4086f6a494ed8d330529b5b46", "url": "https://github.com/nextcloud/android/commit/552a058fc6a05bd4086f6a494ed8d330529b5b46", "message": "Update androidLibraryVersion for testing\n\nSigned-off-by: Daniel Kesselberg <mail@danielkesselberg.de>", "committedDate": "2020-05-09T16:13:01Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjU0OTQ0NQ==", "url": "https://github.com/nextcloud/android/pull/6035#discussion_r422549445", "bodyText": "there should be 1 statement per line\nsave the storage manager into a final so we don't need to call the getter over and over again; bonus: value returned by the getter can become null between invocations, defying safety null check.\nsame for account", "author": "ezaquarii", "createdAt": "2020-05-09T21:40:06Z", "path": "src/main/java/com/owncloud/android/operations/GetCapabilitiesOperation.java", "diffHunk": "@@ -32,8 +32,13 @@\n \n     @Override\n     protected RemoteOperationResult run(OwnCloudClient client) {\n-        GetCapabilitiesRemoteOperation getCapabilities = new GetCapabilitiesRemoteOperation();\n-        RemoteOperationResult result = getCapabilities.execute(client);\n+        OCCapability currentCapability = null;\n+\n+        if (getStorageManager() != null && getStorageManager().getAccount() != null) {", "originalCommit": "552a058fc6a05bd4086f6a494ed8d330529b5b46", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f6876d4698a24afd5bce9ab0070d5d37034a7acf", "chunk": "diff --git a/src/main/java/com/owncloud/android/operations/GetCapabilitiesOperation.java b/src/main/java/com/owncloud/android/operations/GetCapabilitiesOperation.java\nindex 87ff88e23..dbb6aec5d 100644\n--- a/src/main/java/com/owncloud/android/operations/GetCapabilitiesOperation.java\n+++ b/src/main/java/com/owncloud/android/operations/GetCapabilitiesOperation.java\n\n@@ -32,10 +33,11 @@ public class GetCapabilitiesOperation extends SyncOperation {\n \n     @Override\n     protected RemoteOperationResult run(OwnCloudClient client) {\n-        OCCapability currentCapability = null;\n+        final FileDataStorageManager storageManager = getStorageManager();\n \n-        if (getStorageManager() != null && getStorageManager().getAccount() != null) {\n-            currentCapability = getStorageManager().getCapability(getStorageManager().getAccount().name);\n+        OCCapability currentCapability = null;\n+        if (storageManager.getAccount() != null) {\n+            currentCapability = storageManager.getCapability(storageManager.getAccount().name);\n         }\n \n         RemoteOperationResult result = new GetCapabilitiesRemoteOperation(currentCapability).execute(client);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjU0OTYyMA==", "url": "https://github.com/nextcloud/android/pull/6035#discussion_r422549620", "bodyText": "Ok, so what happens if the upgrade fails? It looks like we completely ignore that fac and just happily continue like all is fine. This is pretty much undefined behavior.", "author": "ezaquarii", "createdAt": "2020-05-09T21:41:52Z", "path": "src/main/java/com/owncloud/android/providers/FileContentProvider.java", "diffHunk": "@@ -2193,6 +2194,24 @@ public void onUpgrade(SQLiteDatabase db, int oldVersion, int newVersion) {\n             if (!upgraded) {\n                 Log_OC.i(SQL, String.format(Locale.ENGLISH, UPGRADE_VERSION_MSG, oldVersion, newVersion));\n             }\n+\n+            if (oldVersion < 56 && newVersion >= 56) {\n+                Log_OC.i(SQL, \"Entering in the #56 add etag for capabilities\");\n+                db.beginTransaction();\n+                try {\n+                    db.execSQL(ALTER_TABLE + ProviderTableMeta.CAPABILITIES_TABLE_NAME +\n+                                   ADD_COLUMN + ProviderTableMeta.CAPABILITIES_ETAG + \" TEXT \");\n+\n+                    upgraded = true;\n+                    db.setTransactionSuccessful();\n+                } finally {\n+                    db.endTransaction();\n+                }\n+            }\n+\n+            if (!upgraded) {\n+                Log_OC.i(SQL, String.format(Locale.ENGLISH, UPGRADE_VERSION_MSG, oldVersion, newVersion));", "originalCommit": "552a058fc6a05bd4086f6a494ed8d330529b5b46", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjU1MDA2NA==", "url": "https://github.com/nextcloud/android/pull/6035#discussion_r422550064", "bodyText": "That seemed to be enough for the 56 upgrades before :)", "author": "kesselb", "createdAt": "2020-05-09T21:46:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjU0OTYyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjU1MTc0Ng==", "url": "https://github.com/nextcloud/android/pull/6035#discussion_r422551746", "bodyText": "I'm not a fan of idea that it's ok make bad things worse.\nIf the upgrade fails, we should be notified about it properly, not via some urelated crash. If we can't or don't want to do anything, I'd throw exception. This will trigger an error message pop-up that - with a bit of luck - will land in our issues page with a spot-on error message.\nHopefully, if we set a good example, this behaviour will stop here.", "author": "ezaquarii", "createdAt": "2020-05-09T22:03:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjU0OTYyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjU1MzA1MA==", "url": "https://github.com/nextcloud/android/pull/6035#discussion_r422553050", "bodyText": "One thing that is nasty about database migrations is that if failed, the user is left with app that is disfunctional, potentially leading to a data loss.\nIf we throw a well defined exception here, we can catch that in ShowErrorActivity and propose a workaround of downgrading the app to previous version.\n@tobiasKaminsky Worth pursuing from UX point of view?", "author": "ezaquarii", "createdAt": "2020-05-09T22:16:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjU0OTYyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzYwNzExMA==", "url": "https://github.com/nextcloud/android/pull/6035#discussion_r423607110", "bodyText": "Let us move this away from this PR.\nBoth of you are right: it is a nasty way, but we are doing it since the beginning of the app.\nLet us discus it in a new issue and then we can change it afterwards.", "author": "tobiasKaminsky", "createdAt": "2020-05-12T09:49:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjU0OTYyMA=="}], "type": "inlineReview", "revised_code": {"commit": "ca8a89b9303a6f9c158c01c883b6ea4ffe36011b", "chunk": "diff --git a/src/main/java/com/owncloud/android/providers/FileContentProvider.java b/src/main/java/com/owncloud/android/providers/FileContentProvider.java\nindex 48275c26d..eb7b0d63a 100644\n--- a/src/main/java/com/owncloud/android/providers/FileContentProvider.java\n+++ b/src/main/java/com/owncloud/android/providers/FileContentProvider.java\n\n@@ -2196,7 +2197,26 @@ public class FileContentProvider extends ContentProvider {\n             }\n \n             if (oldVersion < 56 && newVersion >= 56) {\n-                Log_OC.i(SQL, \"Entering in the #56 add etag for capabilities\");\n+                Log_OC.i(SQL, \"Entering in the #56 add decrypted remote path\");\n+                db.beginTransaction();\n+                try {\n+                    // Add synced.name_collision_policy\n+                    db.execSQL(ALTER_TABLE + ProviderTableMeta.FILE_TABLE_NAME +\n+                                   ADD_COLUMN + ProviderTableMeta.FILE_PATH_DECRYPTED + \" TEXT \"); // strin\n+\n+                    upgraded = true;\n+                    db.setTransactionSuccessful();\n+                } finally {\n+                    db.endTransaction();\n+                }\n+            }\n+\n+            if (!upgraded) {\n+                Log_OC.i(SQL, String.format(Locale.ENGLISH, UPGRADE_VERSION_MSG, oldVersion, newVersion));\n+            }\n+\n+            if (oldVersion < 57 && newVersion >= 57) {\n+                Log_OC.i(SQL, \"Entering in the #57 add etag for capabilities\");\n                 db.beginTransaction();\n                 try {\n                     db.execSQL(ALTER_TABLE + ProviderTableMeta.CAPABILITIES_TABLE_NAME +\n"}}, {"oid": "f6876d4698a24afd5bce9ab0070d5d37034a7acf", "url": "https://github.com/nextcloud/android/commit/f6876d4698a24afd5bce9ab0070d5d37034a7acf", "message": "Add local variable for storageManager\n\nSigned-off-by: Daniel Kesselberg <mail@danielkesselberg.de>", "committedDate": "2020-05-18T12:03:27Z", "type": "forcePushed"}, {"oid": "ca8a89b9303a6f9c158c01c883b6ea4ffe36011b", "url": "https://github.com/nextcloud/android/commit/ca8a89b9303a6f9c158c01c883b6ea4ffe36011b", "message": "Add etag column to capabilities table\n\nSigned-off-by: Daniel Kesselberg <mail@danielkesselberg.de>", "committedDate": "2020-06-04T13:14:55Z", "type": "commit"}, {"oid": "a86038ebabec98286b5fa5572ba639ab6459c8b2", "url": "https://github.com/nextcloud/android/commit/a86038ebabec98286b5fa5572ba639ab6459c8b2", "message": "Add local variable for storageManager\n\nSigned-off-by: Daniel Kesselberg <mail@danielkesselberg.de>", "committedDate": "2020-06-04T13:14:57Z", "type": "commit"}, {"oid": "2a3fd4287e3f5ea364ad9d1b84f4e3e5eb8eea14", "url": "https://github.com/nextcloud/android/commit/2a3fd4287e3f5ea364ad9d1b84f4e3e5eb8eea14", "message": "Fix after rebase\n\nSigned-off-by: tobiasKaminsky <tobias@kaminsky.me>", "committedDate": "2020-06-04T13:16:57Z", "type": "commit"}, {"oid": "2a3fd4287e3f5ea364ad9d1b84f4e3e5eb8eea14", "url": "https://github.com/nextcloud/android/commit/2a3fd4287e3f5ea364ad9d1b84f4e3e5eb8eea14", "message": "Fix after rebase\n\nSigned-off-by: tobiasKaminsky <tobias@kaminsky.me>", "committedDate": "2020-06-04T13:16:57Z", "type": "forcePushed"}]}