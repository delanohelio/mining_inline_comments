{"pr_number": 5707, "pr_title": "Fix OOM during image browsing", "pr_createdAt": "2020-03-22T07:53:23Z", "pr_url": "https://github.com/nextcloud/android/pull/5707", "timeline": [{"oid": "88cf0b57d86a1dde4ce8e806d22fdf2b87e629ba", "url": "https://github.com/nextcloud/android/commit/88cf0b57d86a1dde4ce8e806d22fdf2b87e629ba", "message": "wip\n\nSigned-off-by: tobiasKaminsky <tobias@kaminsky.me>", "committedDate": "2020-03-26T13:45:34Z", "type": "forcePushed"}, {"oid": "6d8a440d1a580a3d932e6d2bc7026379cf0b6066", "url": "https://github.com/nextcloud/android/commit/6d8a440d1a580a3d932e6d2bc7026379cf0b6066", "message": "Fix OOM during image browsing\n\nSigned-off-by: tobiasKaminsky <tobias@kaminsky.me>", "committedDate": "2020-03-30T05:43:51Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDk4NDUzMQ==", "url": "https://github.com/nextcloud/android/pull/5707#discussion_r400984531", "bodyText": "InputStream indoesn't get closed\nclosing buffIn and in should probably be handled in a finally block too (like above)", "author": "AndyScherzinger", "createdAt": "2020-03-31T15:00:49Z", "path": "src/main/java/com/owncloud/android/ui/adapter/DiskLruImageCache.java", "diffHunk": "@@ -116,9 +180,9 @@ public Bitmap getBitmap(String key) {\n             }\n             final InputStream in = snapshot.getInputStream(0);\n             if (in != null) {\n-                final BufferedInputStream buffIn =\n-                        new BufferedInputStream(in, IO_BUFFER_SIZE);\n+                final BufferedInputStream buffIn = new BufferedInputStream(in, IO_BUFFER_SIZE);\n                 bitmap = BitmapFactory.decodeStream(buffIn);\n+                buffIn.close();", "originalCommit": "6d8a440d1a580a3d932e6d2bc7026379cf0b6066", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ0OTE5Ng==", "url": "https://github.com/nextcloud/android/pull/5707#discussion_r403449196", "bodyText": "Changed", "author": "tobiasKaminsky", "createdAt": "2020-04-04T09:38:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDk4NDUzMQ=="}], "type": "inlineReview", "revised_code": {"commit": "f20f67b77d1b4125c5ae6baa59b9273f61865395", "chunk": "diff --git a/src/main/java/com/owncloud/android/ui/adapter/DiskLruImageCache.java b/src/main/java/com/owncloud/android/ui/adapter/DiskLruImageCache.java\nindex bcd7bbf0e..e81d67f74 100644\n--- a/src/main/java/com/owncloud/android/ui/adapter/DiskLruImageCache.java\n+++ b/src/main/java/com/owncloud/android/ui/adapter/DiskLruImageCache.java\n\n@@ -178,11 +180,10 @@ public class DiskLruImageCache {\n             if (snapshot == null) {\n                 return null;\n             }\n-            final InputStream in = snapshot.getInputStream(0);\n+            in = snapshot.getInputStream(0);\n             if (in != null) {\n-                final BufferedInputStream buffIn = new BufferedInputStream(in, IO_BUFFER_SIZE);\n+                buffIn = new BufferedInputStream(in, IO_BUFFER_SIZE);\n                 bitmap = BitmapFactory.decodeStream(buffIn);\n-                buffIn.close();\n             }\n         } catch (IOException e) {\n             Log_OC.e(TAG, e.getMessage(), e);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDk4NzUzNg==", "url": "https://github.com/nextcloud/android/pull/5707#discussion_r400987536", "bodyText": "Annotate with @Nullable since return can be null?", "author": "AndyScherzinger", "createdAt": "2020-03-31T15:04:40Z", "path": "src/main/java/com/owncloud/android/ui/preview/PreviewImageFragment.java", "diffHunk": "@@ -306,6 +309,26 @@ public void onStart() {\n         }\n     }\n \n+    private Bitmap getResizedBitmap(OCFile file, int width, int height) {", "originalCommit": "6d8a440d1a580a3d932e6d2bc7026379cf0b6066", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ0OTIyNA==", "url": "https://github.com/nextcloud/android/pull/5707#discussion_r403449224", "bodyText": "Totally true, we need to somehow enforce this.", "author": "tobiasKaminsky", "createdAt": "2020-04-04T09:38:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDk4NzUzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ0OTU4NA==", "url": "https://github.com/nextcloud/android/pull/5707#discussion_r403449584", "bodyText": "https://developer.android.com/studio/write/annotations#nullability-analysis\nI'll give this a try.", "author": "tobiasKaminsky", "createdAt": "2020-04-04T09:42:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDk4NzUzNg=="}], "type": "inlineReview", "revised_code": {"commit": "f20f67b77d1b4125c5ae6baa59b9273f61865395", "chunk": "diff --git a/src/main/java/com/owncloud/android/ui/preview/PreviewImageFragment.java b/src/main/java/com/owncloud/android/ui/preview/PreviewImageFragment.java\nindex dab273ce3..8d8d0d961 100644\n--- a/src/main/java/com/owncloud/android/ui/preview/PreviewImageFragment.java\n+++ b/src/main/java/com/owncloud/android/ui/preview/PreviewImageFragment.java\n\n@@ -309,7 +310,8 @@ public class PreviewImageFragment extends FileFragment implements Injectable {\n         }\n     }\n \n-    private Bitmap getResizedBitmap(OCFile file, int width, int height) {\n+    private @Nullable\n+    Bitmap getResizedBitmap(OCFile file, int width, int height) {\n         Bitmap cachedImage = null;\n         int scaledWidth = width;\n         int scaledHeight = height;\n"}}, {"oid": "f20f67b77d1b4125c5ae6baa59b9273f61865395", "url": "https://github.com/nextcloud/android/commit/f20f67b77d1b4125c5ae6baa59b9273f61865395", "message": "Fix OOM during image browsing\n\nSigned-off-by: tobiasKaminsky <tobias@kaminsky.me>", "committedDate": "2020-04-04T09:40:19Z", "type": "forcePushed"}, {"oid": "ad4186ed13e7882a42f74bf4f8892aa0f0a54cf8", "url": "https://github.com/nextcloud/android/commit/ad4186ed13e7882a42f74bf4f8892aa0f0a54cf8", "message": "Fix OOM during image browsing\n\nSigned-off-by: tobiasKaminsky <tobias@kaminsky.me>", "committedDate": "2020-04-08T11:10:13Z", "type": "forcePushed"}, {"oid": "58873a8a22d3ae55be9fae5159ab1174eeda4a88", "url": "https://github.com/nextcloud/android/commit/58873a8a22d3ae55be9fae5159ab1174eeda4a88", "message": "Fix OOM during image browsing\n\nSigned-off-by: tobiasKaminsky <tobias@kaminsky.me>", "committedDate": "2020-04-09T06:47:01Z", "type": "forcePushed"}, {"oid": "45315f148635040ad44131cdd1f2f9ca8a79c594", "url": "https://github.com/nextcloud/android/commit/45315f148635040ad44131cdd1f2f9ca8a79c594", "message": "Fix OOM during image browsing\n\nSigned-off-by: tobiasKaminsky <tobias@kaminsky.me>", "committedDate": "2020-04-09T08:16:58Z", "type": "commit"}, {"oid": "45315f148635040ad44131cdd1f2f9ca8a79c594", "url": "https://github.com/nextcloud/android/commit/45315f148635040ad44131cdd1f2f9ca8a79c594", "message": "Fix OOM during image browsing\n\nSigned-off-by: tobiasKaminsky <tobias@kaminsky.me>", "committedDate": "2020-04-09T08:16:58Z", "type": "forcePushed"}]}