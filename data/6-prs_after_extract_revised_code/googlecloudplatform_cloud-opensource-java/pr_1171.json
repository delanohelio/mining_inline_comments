{"pr_number": 1171, "pr_title": "Linkage Monitor to ignore Gradle's build directory", "pr_createdAt": "2020-01-31T20:13:58Z", "pr_url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1171", "timeline": [{"oid": "a3ba174c0b186e1b76549ba170e047e01771b6b5", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/a3ba174c0b186e1b76549ba170e047e01771b6b5", "message": "Linkage Monitor to ignore build directory", "committedDate": "2020-01-31T20:10:32Z", "type": "commit"}, {"oid": "6632398639feff188e548705ecfc48691f975d63", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/6632398639feff188e548705ecfc48691f975d63", "message": "README for Gradle", "committedDate": "2020-01-31T20:13:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzY3NTkwNg==", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1171#discussion_r373675906", "bodyText": "Is this truly necessary? Usually there's a cleaner approach that does not use continue. Here I think you can reverse the if and avoid continue.", "author": "elharo", "createdAt": "2020-01-31T20:40:35Z", "path": "linkage-monitor/src/main/java/com/google/cloud/tools/dependencies/linkagemonitor/LinkageMonitor.java", "diffHunk": "@@ -105,10 +105,20 @@ public static void main(String[] arguments)\n       RepositorySystem repositorySystem, RepositorySystemSession session, Path projectDirectory) {\n     ImmutableMap.Builder<String, String> artifactToVersion = ImmutableMap.builder();\n     Iterable<Path> paths = MoreFiles.fileTraverser().breadthFirst(projectDirectory);\n+\n+    PATHS_LOOP:\n     for (Path path : paths) {\n       if (!path.getFileName().endsWith(\"pom.xml\")) {\n         continue;\n       }\n+      for (Path pathElement : path) {\n+        String name = pathElement.toString();\n+        if (name.equals(\"build\") || name.equals(\"target\")) {\n+          // Exclude Gradle's build directory and Maven's target directory.\n+          continue PATHS_LOOP;", "originalCommit": "6632398639feff188e548705ecfc48691f975d63", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzY5MzQ4Ng==", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1171#discussion_r373693486", "bodyText": "Removed the label. Does this look good now?", "author": "suztomo", "createdAt": "2020-01-31T21:28:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzY3NTkwNg=="}], "type": "inlineReview", "revised_code": {"commit": "e72da6d2f5794a3a2c0af5d0babfaf8343799a42", "chunk": "diff --git a/linkage-monitor/src/main/java/com/google/cloud/tools/dependencies/linkagemonitor/LinkageMonitor.java b/linkage-monitor/src/main/java/com/google/cloud/tools/dependencies/linkagemonitor/LinkageMonitor.java\nindex 5e995fa2..c29ef342 100644\n--- a/linkage-monitor/src/main/java/com/google/cloud/tools/dependencies/linkagemonitor/LinkageMonitor.java\n+++ b/linkage-monitor/src/main/java/com/google/cloud/tools/dependencies/linkagemonitor/LinkageMonitor.java\n\n@@ -106,17 +106,15 @@ public class LinkageMonitor {\n     ImmutableMap.Builder<String, String> artifactToVersion = ImmutableMap.builder();\n     Iterable<Path> paths = MoreFiles.fileTraverser().breadthFirst(projectDirectory);\n \n-    PATHS_LOOP:\n     for (Path path : paths) {\n       if (!path.getFileName().endsWith(\"pom.xml\")) {\n         continue;\n       }\n-      for (Path pathElement : path) {\n-        String name = pathElement.toString();\n-        if (name.equals(\"build\") || name.equals(\"target\")) {\n-          // Exclude Gradle's build directory and Maven's target directory.\n-          continue PATHS_LOOP;\n-        }\n+\n+      ImmutableSet<Path> elements = ImmutableSet.copyOf(path);\n+      if (elements.contains(Paths.get(\"build\")) || elements.contains(Paths.get(\"target\"))) {\n+        // Exclude Gradle's build directory and Maven's target directory.\n+        continue;\n       }\n \n       ModelBuildingRequest modelRequest = new DefaultModelBuildingRequest();\n"}}, {"oid": "e72da6d2f5794a3a2c0af5d0babfaf8343799a42", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/e72da6d2f5794a3a2c0af5d0babfaf8343799a42", "message": "Path elements as set", "committedDate": "2020-01-31T21:27:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzcwMDEzMg==", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1171#discussion_r373700132", "bodyText": "Does it matter where in the path this directory occurs? Can it be only at the end? What if a something several levels up has the name build or target?", "author": "elharo", "createdAt": "2020-01-31T21:47:07Z", "path": "linkage-monitor/src/main/java/com/google/cloud/tools/dependencies/linkagemonitor/LinkageMonitor.java", "diffHunk": "@@ -105,10 +105,18 @@ public static void main(String[] arguments)\n       RepositorySystem repositorySystem, RepositorySystemSession session, Path projectDirectory) {\n     ImmutableMap.Builder<String, String> artifactToVersion = ImmutableMap.builder();\n     Iterable<Path> paths = MoreFiles.fileTraverser().breadthFirst(projectDirectory);\n+\n     for (Path path : paths) {\n       if (!path.getFileName().endsWith(\"pom.xml\")) {\n         continue;\n       }\n+\n+      ImmutableSet<Path> elements = ImmutableSet.copyOf(path);\n+      if (elements.contains(Paths.get(\"build\")) || elements.contains(Paths.get(\"target\"))) {", "originalCommit": "e72da6d2f5794a3a2c0af5d0babfaf8343799a42", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzcwMzg0Mg==", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1171#discussion_r373703842", "bodyText": "I would say it does not matter.\nFrom my experience, it's a common practice to avoid using \"build\" or \"target\" directory to place something to be published.", "author": "suztomo", "createdAt": "2020-01-31T21:58:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzcwMDEzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc1NTIzNw==", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1171#discussion_r373755237", "bodyText": "Another logic I have in mind: flags to indicate the existence of \"build.gradle\" and \"pom.xml\" files. (It gets complicated as it seeks for accuracy)", "author": "suztomo", "createdAt": "2020-02-01T03:44:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzcwMDEzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDY2NTA1Mw==", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1171#discussion_r374665053", "bodyText": "Perhaps we can talk about this offline, but I don't think this one is answered. As written, this seems buggy to me.", "author": "elharo", "createdAt": "2020-02-04T13:21:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzcwMDEzMg=="}], "type": "inlineReview", "revised_code": {"commit": "3df642ae1fdac168a2d65bbff1ee3bc9a3495d3b", "chunk": "diff --git a/linkage-monitor/src/main/java/com/google/cloud/tools/dependencies/linkagemonitor/LinkageMonitor.java b/linkage-monitor/src/main/java/com/google/cloud/tools/dependencies/linkagemonitor/LinkageMonitor.java\nindex c29ef342..0d8e108c 100644\n--- a/linkage-monitor/src/main/java/com/google/cloud/tools/dependencies/linkagemonitor/LinkageMonitor.java\n+++ b/linkage-monitor/src/main/java/com/google/cloud/tools/dependencies/linkagemonitor/LinkageMonitor.java\n\n@@ -104,6 +113,8 @@ public class LinkageMonitor {\n   static ImmutableMap<String, String> findLocalArtifacts(\n       RepositorySystem repositorySystem, RepositorySystemSession session, Path projectDirectory) {\n     ImmutableMap.Builder<String, String> artifactToVersion = ImmutableMap.builder();\n+\n+    // Relative paths to the files in the project\n     Iterable<Path> paths = MoreFiles.fileTraverser().breadthFirst(projectDirectory);\n \n     for (Path path : paths) {\n"}}, {"oid": "a47d7420209dde5961db2690f619de929bca66d0", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/a47d7420209dde5961db2690f619de929bca66d0", "message": "Merge remote-tracking branch 'origin/master' into linkage-monitor-gradle", "committedDate": "2020-02-03T21:12:47Z", "type": "commit"}, {"oid": "9c7feebb161174cb06b7c5bbf48ab88d4541dcde", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/9c7feebb161174cb06b7c5bbf48ab88d4541dcde", "message": "Merge remote-tracking branch 'origin/master' into linkage-monitor-gradle", "committedDate": "2020-02-04T17:07:12Z", "type": "commit"}, {"oid": "3df642ae1fdac168a2d65bbff1ee3bc9a3495d3b", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/3df642ae1fdac168a2d65bbff1ee3bc9a3495d3b", "message": "Ensure releative path", "committedDate": "2020-02-04T17:12:52Z", "type": "commit"}, {"oid": "3f488463a24d4d6960ef727dff636f851b73d041", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/3f488463a24d4d6960ef727dff636f851b73d041", "message": "\"in the local Maven repository\"", "committedDate": "2020-02-04T17:13:54Z", "type": "commit"}, {"oid": "49741ccc40092e2cf1f3a0810d2c101455c887b8", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/49741ccc40092e2cf1f3a0810d2c101455c887b8", "message": "Clarify the target of exclusion in comment", "committedDate": "2020-02-04T17:16:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDgwODA0NA==", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1171#discussion_r374808044", "bodyText": "This will throw an exception the calling code isn't prepared to handle. This method should handle both cases here.", "author": "elharo", "createdAt": "2020-02-04T17:16:12Z", "path": "linkage-monitor/src/main/java/com/google/cloud/tools/dependencies/linkagemonitor/LinkageMonitor.java", "diffHunk": "@@ -112,13 +113,18 @@ public static void main(String[] arguments)\n   static ImmutableMap<String, String> findLocalArtifacts(\n       RepositorySystem repositorySystem, RepositorySystemSession session, Path projectDirectory) {\n     ImmutableMap.Builder<String, String> artifactToVersion = ImmutableMap.builder();\n+\n+    // Relative paths to the files in the project\n     Iterable<Path> paths = MoreFiles.fileTraverser().breadthFirst(projectDirectory);\n \n     for (Path path : paths) {\n       if (!path.getFileName().endsWith(\"pom.xml\")) {\n         continue;\n       }\n \n+      Verify.verify(", "originalCommit": "3df642ae1fdac168a2d65bbff1ee3bc9a3495d3b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDgxNTMxMw==", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1171#discussion_r374815313", "bodyText": "Updated to use path.relativize in case it is an absolute path.", "author": "suztomo", "createdAt": "2020-02-04T17:29:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDgwODA0NA=="}], "type": "inlineReview", "revised_code": {"commit": "28881f7481cf504b1086874a3d10e5a41861c4d7", "chunk": "diff --git a/linkage-monitor/src/main/java/com/google/cloud/tools/dependencies/linkagemonitor/LinkageMonitor.java b/linkage-monitor/src/main/java/com/google/cloud/tools/dependencies/linkagemonitor/LinkageMonitor.java\nindex 0d8e108c..45bccbde 100644\n--- a/linkage-monitor/src/main/java/com/google/cloud/tools/dependencies/linkagemonitor/LinkageMonitor.java\n+++ b/linkage-monitor/src/main/java/com/google/cloud/tools/dependencies/linkagemonitor/LinkageMonitor.java\n\n@@ -113,8 +113,6 @@ public class LinkageMonitor {\n   static ImmutableMap<String, String> findLocalArtifacts(\n       RepositorySystem repositorySystem, RepositorySystemSession session, Path projectDirectory) {\n     ImmutableMap.Builder<String, String> artifactToVersion = ImmutableMap.builder();\n-\n-    // Relative paths to the files in the project\n     Iterable<Path> paths = MoreFiles.fileTraverser().breadthFirst(projectDirectory);\n \n     for (Path path : paths) {\n"}}, {"oid": "28881f7481cf504b1086874a3d10e5a41861c4d7", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/28881f7481cf504b1086874a3d10e5a41861c4d7", "message": "Handling absolute path", "committedDate": "2020-02-04T17:27:28Z", "type": "commit"}]}