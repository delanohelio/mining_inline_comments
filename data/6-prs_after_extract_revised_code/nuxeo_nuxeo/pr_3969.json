{"pr_number": 3969, "pr_title": "NXP-28869: Add a new API to refresh AWS tokens in the batch handler", "pr_createdAt": "2020-04-24T09:10:57Z", "pr_url": "https://github.com/nuxeo/nuxeo/pull/3969", "timeline": [{"oid": "c4848799735933fd96f40f790dad1378dbd08f42", "url": "https://github.com/nuxeo/nuxeo/commit/c4848799735933fd96f40f790dad1378dbd08f42", "message": "NXP-28869: Clean-up", "committedDate": "2020-04-22T15:12:14Z", "type": "commit"}, {"oid": "a23f0431ff67ea70a85109d0b8052898e4f26efc", "url": "https://github.com/nuxeo/nuxeo/commit/a23f0431ff67ea70a85109d0b8052898e4f26efc", "message": "NXP-28869: Add a new API to refresh AWS tokens in the batch handler\n\nThe new API can be used from `/upload/{batchId}/refresh`.\nIt will return new tokens when the batch handler can\nhandle the request, else it will throw an error.", "committedDate": "2020-04-24T09:12:04Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQyNTA0NQ==", "url": "https://github.com/nuxeo/nuxeo/pull/3969#discussion_r414425045", "bodyText": "body can be removed, right?", "author": "BoboTiG", "createdAt": "2020-04-24T09:17:37Z", "path": "modules/platform/rest-api/nuxeo-rest-api-server/src/main/java/org/nuxeo/ecm/restapi/server/jaxrs/BatchUploadObject.java", "diffHunk": "@@ -434,6 +436,28 @@ public Response getBatchExtraInfo(@PathParam(REQUEST_BATCH_ID) String batchId) t\n         return buildResponse(Status.OK, result);\n     }\n \n+    /** @since 11.1 */\n+    @POST\n+    @Path(\"{batchId}/refresh\")\n+    public Response refreshToken(@PathParam(REQUEST_BATCH_ID) String batchId,\n+            String body) throws IOException {", "originalCommit": "a23f0431ff67ea70a85109d0b8052898e4f26efc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ1Njg0Mw==", "url": "https://github.com/nuxeo/nuxeo/pull/3969#discussion_r414456843", "bodyText": "unused, yep", "author": "ataillefer", "createdAt": "2020-04-24T10:07:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQyNTA0NQ=="}], "type": "inlineReview", "revised_code": {"commit": "b94b2c2d7e33605965dbba3f2fcafb2eecf5d307", "chunk": "diff --git a/modules/platform/rest-api/nuxeo-rest-api-server/src/main/java/org/nuxeo/ecm/restapi/server/jaxrs/BatchUploadObject.java b/modules/platform/rest-api/nuxeo-rest-api-server/src/main/java/org/nuxeo/ecm/restapi/server/jaxrs/BatchUploadObject.java\nindex be1744ef7fe..79e2ffae313 100644\n--- a/modules/platform/rest-api/nuxeo-rest-api-server/src/main/java/org/nuxeo/ecm/restapi/server/jaxrs/BatchUploadObject.java\n+++ b/modules/platform/rest-api/nuxeo-rest-api-server/src/main/java/org/nuxeo/ecm/restapi/server/jaxrs/BatchUploadObject.java\n\n@@ -439,8 +439,7 @@ public class BatchUploadObject extends AbstractResource<ResourceTypeImpl> {\n     /** @since 11.1 */\n     @POST\n     @Path(\"{batchId}/refresh\")\n-    public Response refreshToken(@PathParam(REQUEST_BATCH_ID) String batchId,\n-            String body) throws IOException {\n+    public Response refreshToken(@PathParam(REQUEST_BATCH_ID) String batchId) throws IOException {\n         BatchManager bm = Framework.getService(BatchManager.class);\n \n         Batch batch = bm.getBatch(batchId);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ1ODg3Nw==", "url": "https://github.com/nuxeo/nuxeo/pull/3969#discussion_r414458877", "bodyText": "Better to use awaitility instead, see https://github.com/nuxeo/nuxeo/blob/master/modules/platform/nuxeo-platform-tag-service/nuxeo-platform-tag-core/src/test/java/org/nuxeo/ecm/platform/tag/AbstractTestTagService.java#L120 for instance.", "author": "ataillefer", "createdAt": "2020-04-24T10:10:48Z", "path": "modules/core/nuxeo-core-binarymanager-cloud/nuxeo-core-binarymanager-s3/src/test/java/org/nuxeo/ecm/core/storage/sql/TestS3DirectBatchHandler.java", "diffHunk": "@@ -162,6 +164,51 @@ public void test20MB() throws SdkBaseException, InterruptedException {\n         test(\"s3\", 20 * 1024 * 1024);\n     }\n \n+    @Test\n+    @Deploy(\"org.nuxeo.ecm.core.storage.binarymanager.s3.tests:OSGI-INF/test-s3directupload-contrib.xml\")\n+    public void testTokenRenewal() throws SdkBaseException, InterruptedException {\n+        // Test that refreshing tokens actually returns back valid and different tokens.\n+        S3DirectBatchHandler handler = (S3DirectBatchHandler) batchManager.getHandler(\"s3\");\n+        Batch newBatch = handler.newBatch(null);\n+        Batch batch = handler.getBatch(newBatch.getKey());\n+\n+        // Save current details\n+        Map<String, Object> properties = batch.getProperties();\n+        String secretKeyId = (String) properties.get(S3DirectBatchHandler.INFO_AWS_SECRET_KEY_ID);\n+        String secretAccessKey = (String) properties.get(S3DirectBatchHandler.INFO_AWS_SECRET_ACCESS_KEY);\n+        String sessionToken = (String) properties.get(S3DirectBatchHandler.INFO_AWS_SESSION_TOKEN);\n+        Long expiration = (Long) properties.get(S3DirectBatchHandler.INFO_EXPIRATION);\n+\n+        // Wait for some time else the new expiration will not be updated\n+        Thread.sleep(1000); // 1s", "originalCommit": "a23f0431ff67ea70a85109d0b8052898e4f26efc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDU2MjE1Mw==", "url": "https://github.com/nuxeo/nuxeo/pull/3969#discussion_r414562153", "bodyText": "I finally removed that logic, it would introduce random failures. The new check is less error prone.", "author": "BoboTiG", "createdAt": "2020-04-24T13:08:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ1ODg3Nw=="}], "type": "inlineReview", "revised_code": {"commit": "b94b2c2d7e33605965dbba3f2fcafb2eecf5d307", "chunk": "diff --git a/modules/core/nuxeo-core-binarymanager-cloud/nuxeo-core-binarymanager-s3/src/test/java/org/nuxeo/ecm/core/storage/sql/TestS3DirectBatchHandler.java b/modules/core/nuxeo-core-binarymanager-cloud/nuxeo-core-binarymanager-s3/src/test/java/org/nuxeo/ecm/core/storage/sql/TestS3DirectBatchHandler.java\nindex ecdd1ea8626..91b6ebee8b3 100644\n--- a/modules/core/nuxeo-core-binarymanager-cloud/nuxeo-core-binarymanager-s3/src/test/java/org/nuxeo/ecm/core/storage/sql/TestS3DirectBatchHandler.java\n+++ b/modules/core/nuxeo-core-binarymanager-cloud/nuxeo-core-binarymanager-s3/src/test/java/org/nuxeo/ecm/core/storage/sql/TestS3DirectBatchHandler.java\n\n@@ -179,9 +179,6 @@ public class TestS3DirectBatchHandler {\n         String sessionToken = (String) properties.get(S3DirectBatchHandler.INFO_AWS_SESSION_TOKEN);\n         Long expiration = (Long) properties.get(S3DirectBatchHandler.INFO_EXPIRATION);\n \n-        // Wait for some time else the new expiration will not be updated\n-        Thread.sleep(1000); // 1s\n-\n         // Renew tokens\n         properties = handler.refreshToken(newBatch.getKey());\n         String newSecretKeyId = (String) properties.get(S3DirectBatchHandler.INFO_AWS_SECRET_KEY_ID);\n"}}, {"oid": "b94b2c2d7e33605965dbba3f2fcafb2eecf5d307", "url": "https://github.com/nuxeo/nuxeo/commit/b94b2c2d7e33605965dbba3f2fcafb2eecf5d307", "message": "NXP-28869: Add a new API to refresh AWS tokens in the batch handler\n\nThe new API can be used from `/upload/{batchId}/refresh`.\nIt will return new tokens when the batch handler can\nhandle the request, else it will throw an error.", "committedDate": "2020-04-24T13:07:33Z", "type": "forcePushed"}, {"oid": "b15cd8e72d3825e832080f9b45f29e69e91f4316", "url": "https://github.com/nuxeo/nuxeo/commit/b15cd8e72d3825e832080f9b45f29e69e91f4316", "message": "NXP-28869: Add a new API to refresh AWS tokens in the batch handler\n\nThe new API can be used from `/upload/{batchId}/refresh`.\nIt will return new tokens when the batch handler can\nhandle the request, else it will throw an error.", "committedDate": "2020-04-24T14:09:59Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDYxNzI5MA==", "url": "https://github.com/nuxeo/nuxeo/pull/3969#discussion_r414617290", "bodyText": "You should move this to a default method in the interface as others may have custom batch handlers. Adapt the message of course (the default -> this).", "author": "efge", "createdAt": "2020-04-24T14:25:30Z", "path": "modules/platform/nuxeo-automation/nuxeo-automation-server/src/main/java/org/nuxeo/ecm/automation/server/jaxrs/batch/handler/impl/DefaultBatchHandler.java", "diffHunk": "@@ -55,4 +56,9 @@ public boolean completeUpload(String batchId, String fileIndex, BatchFileInfo fi\n                 && Objects.equals(fileEntry.getBlob().getDigest(), fileInfo.getMd5());\n     }\n \n+    @Override\n+    public Map<String, Object> refreshToken(String batchId) {\n+        throw new UnsupportedOperationException(\"Refresh token is not supported for the default batch handler.\");", "originalCommit": "b15cd8e72d3825e832080f9b45f29e69e91f4316", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDYzOTA1OA==", "url": "https://github.com/nuxeo/nuxeo/pull/3969#discussion_r414639058", "bodyText": "[For the history of that specific ticket] It has been decided to use default only for backports.", "author": "BoboTiG", "createdAt": "2020-04-24T14:53:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDYxNzI5MA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDYxODg3Mw==", "url": "https://github.com/nuxeo/nuxeo/pull/3969#discussion_r414618873", "bodyText": "I'd call it /refreshToken to be more explicit. \"refresh\" in the context of a batch upload does not immediately evoke the auth token.", "author": "efge", "createdAt": "2020-04-24T14:27:33Z", "path": "modules/platform/rest-api/nuxeo-rest-api-server/src/main/java/org/nuxeo/ecm/restapi/server/jaxrs/BatchUploadObject.java", "diffHunk": "@@ -434,6 +436,27 @@ public Response getBatchExtraInfo(@PathParam(REQUEST_BATCH_ID) String batchId) t\n         return buildResponse(Status.OK, result);\n     }\n \n+    /** @since 11.1 */\n+    @POST\n+    @Path(\"{batchId}/refresh\")", "originalCommit": "b15cd8e72d3825e832080f9b45f29e69e91f4316", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1d16a2cb33bdf3a817283e4cce992a0751873104", "chunk": "diff --git a/modules/platform/rest-api/nuxeo-rest-api-server/src/main/java/org/nuxeo/ecm/restapi/server/jaxrs/BatchUploadObject.java b/modules/platform/rest-api/nuxeo-rest-api-server/src/main/java/org/nuxeo/ecm/restapi/server/jaxrs/BatchUploadObject.java\nindex ce03d8e0a99..bcbd54ba313 100644\n--- a/modules/platform/rest-api/nuxeo-rest-api-server/src/main/java/org/nuxeo/ecm/restapi/server/jaxrs/BatchUploadObject.java\n+++ b/modules/platform/rest-api/nuxeo-rest-api-server/src/main/java/org/nuxeo/ecm/restapi/server/jaxrs/BatchUploadObject.java\n\n@@ -438,7 +438,7 @@ public class BatchUploadObject extends AbstractResource<ResourceTypeImpl> {\n \n     /** @since 11.1 */\n     @POST\n-    @Path(\"{batchId}/refresh\")\n+    @Path(\"{batchId}/refreshToken\")\n     public Response refreshToken(@PathParam(REQUEST_BATCH_ID) String batchId) throws IOException {\n         BatchManager bm = Framework.getService(BatchManager.class);\n \n"}}, {"oid": "1d16a2cb33bdf3a817283e4cce992a0751873104", "url": "https://github.com/nuxeo/nuxeo/commit/1d16a2cb33bdf3a817283e4cce992a0751873104", "message": "NXP-28869: Add a new API to refresh AWS tokens in the batch handler\n\nThe new API can be used from `/upload/{batchId}/refreshToken`.\nIt will return new tokens when the batch handler can\nhandle the request, else it will throw an error.", "committedDate": "2020-04-24T14:51:49Z", "type": "commit"}, {"oid": "1d16a2cb33bdf3a817283e4cce992a0751873104", "url": "https://github.com/nuxeo/nuxeo/commit/1d16a2cb33bdf3a817283e4cce992a0751873104", "message": "NXP-28869: Add a new API to refresh AWS tokens in the batch handler\n\nThe new API can be used from `/upload/{batchId}/refreshToken`.\nIt will return new tokens when the batch handler can\nhandle the request, else it will throw an error.", "committedDate": "2020-04-24T14:51:49Z", "type": "forcePushed"}]}