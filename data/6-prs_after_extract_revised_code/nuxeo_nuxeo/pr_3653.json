{"pr_number": 3653, "pr_title": "feature-NXP-28488-blobprovider-supportssync-10.10", "pr_createdAt": "2020-01-07T19:17:50Z", "pr_url": "https://github.com/nuxeo/nuxeo/pull/3653", "timeline": [{"oid": "b409d413fd9f0ea214df5f303e04078f39102482", "url": "https://github.com/nuxeo/nuxeo/commit/b409d413fd9f0ea214df5f303e04078f39102482", "message": "NXP-28276: add BlobProvider.supportsSync to avoid relying on BinaryManager", "committedDate": "2020-01-07T22:13:28Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDEzOTc5NA==", "url": "https://github.com/nuxeo/nuxeo/pull/3653#discussion_r364139794", "bodyText": "Isn't it better to keep it as deprecated in a HF?\nI know it's probably not used by any customer, but well, let's be safe.", "author": "troger", "createdAt": "2020-01-08T09:39:37Z", "path": "addons/nuxeo-wopi/nuxeo-wopi/src/main/java/org/nuxeo/wopi/Helpers.java", "diffHunk": "@@ -100,20 +100,20 @@ public static Blob getEditableBlob(DocumentModel doc, String xpath) {\n                     () -> xpath);\n             return null;\n         }\n-        // ignore external blob providers\n-        if (isExternalBlobProvider(blob)) {\n+        // ignore blob providers that don't support sync\n+        if (!supportsSync(blob)) {\n             log.debug(\n-                    \"Blobs: repository={} docId={} xpath={} Ignoring blob as it is backed by a BlobProvider preventing updates\",\n+                    \"Blobs: repository={} docId={} xpath={} Ignoring blob as it is backed by a BlobProvider preventing sync\",\n                     doc::getRepositoryName, doc::getId, () -> xpath);\n             return null;\n         }\n         return blob;\n     }\n \n-    protected static boolean isExternalBlobProvider(Blob blob) {", "originalCommit": "b409d413fd9f0ea214df5f303e04078f39102482", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDIzMzExNg==", "url": "https://github.com/nuxeo/nuxeo/pull/3653#discussion_r364233116", "bodyText": "It's protected so a customer would really have to go through contortions to be able to use it... I'm willing to take the risk here.", "author": "efge", "createdAt": "2020-01-08T13:36:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDEzOTc5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDMzNjU5MA==", "url": "https://github.com/nuxeo/nuxeo/pull/3653#discussion_r364336590", "bodyText": "Well, I do not agree. We should always keep and deprecate public/protected stuff on the maintenance branches, that's the \"rule\".\nDo as you wish.", "author": "troger", "createdAt": "2020-01-08T16:54:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDEzOTc5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDM1NDU1Mw==", "url": "https://github.com/nuxeo/nuxeo/pull/3653#discussion_r364354553", "bodyText": "Ok you're right, updated.", "author": "efge", "createdAt": "2020-01-08T17:34:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDEzOTc5NA=="}], "type": "inlineReview", "revised_code": {"commit": "3668f554a763d776503c82821ee5d964e21c61cc", "chunk": "diff --git a/addons/nuxeo-wopi/nuxeo-wopi/src/main/java/org/nuxeo/wopi/Helpers.java b/addons/nuxeo-wopi/nuxeo-wopi/src/main/java/org/nuxeo/wopi/Helpers.java\nindex eaf59678b3b..5ddfae821c8 100644\n--- a/addons/nuxeo-wopi/nuxeo-wopi/src/main/java/org/nuxeo/wopi/Helpers.java\n+++ b/addons/nuxeo-wopi/nuxeo-wopi/src/main/java/org/nuxeo/wopi/Helpers.java\n\n@@ -110,6 +110,16 @@ public class Helpers {\n         return blob;\n     }\n \n+    /**\n+     * @deprecated since 11.1, use {@link #supportsSync} (with opposite semantics) instead\n+     */\n+    @Deprecated\n+    protected static boolean isExternalBlobProvider(Blob blob) {\n+        BlobManager blobManager = Framework.getService(BlobManager.class);\n+        BlobProvider blobProvider = blobManager.getBlobProvider(blob);\n+        return blobProvider != null && (!blobProvider.supportsUserUpdate() || blobProvider.getBinaryManager() == null);\n+    }\n+\n     protected static boolean supportsSync(Blob blob) {\n         BlobManager blobManager = Framework.getService(BlobManager.class);\n         BlobProvider blobProvider = blobManager.getBlobProvider(blob);\n"}}, {"oid": "3668f554a763d776503c82821ee5d964e21c61cc", "url": "https://github.com/nuxeo/nuxeo/commit/3668f554a763d776503c82821ee5d964e21c61cc", "message": "NXP-28276: add BlobProvider.supportsSync to avoid relying on BinaryManager", "committedDate": "2020-01-08T17:33:12Z", "type": "commit"}, {"oid": "3668f554a763d776503c82821ee5d964e21c61cc", "url": "https://github.com/nuxeo/nuxeo/commit/3668f554a763d776503c82821ee5d964e21c61cc", "message": "NXP-28276: add BlobProvider.supportsSync to avoid relying on BinaryManager", "committedDate": "2020-01-08T17:33:12Z", "type": "forcePushed"}]}