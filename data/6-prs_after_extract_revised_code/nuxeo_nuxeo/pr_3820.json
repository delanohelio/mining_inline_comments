{"pr_number": 3820, "pr_title": "fix-NXP-28727-Document-created-under-a-placeless-document-Mustnt-be-a-placeless", "pr_createdAt": "2020-03-09T14:05:03Z", "pr_url": "https://github.com/nuxeo/nuxeo/pull/3820", "timeline": [{"oid": "e46c9ef99dea43bdc4e253dae9a3152e712dbe3a", "url": "https://github.com/nuxeo/nuxeo/commit/e46c9ef99dea43bdc4e253dae9a3152e712dbe3a", "message": "NXP-28719: Fix Comment Migration failure due to versions", "committedDate": "2020-03-09T14:56:45Z", "type": "forcePushed"}, {"oid": "b4782bf0081c1bea749fc98179b6765c5dbf376f", "url": "https://github.com/nuxeo/nuxeo/commit/b4782bf0081c1bea749fc98179b6765c5dbf376f", "message": "NXP-28719: Fix Comment Migration failure due to versions", "committedDate": "2020-03-09T15:08:59Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTExMDY1MQ==", "url": "https://github.com/nuxeo/nuxeo/pull/3820#discussion_r391110651", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * @since 10.10-HF23\n          \n          \n            \n                 * @since 11.1", "author": "kevinleturc", "createdAt": "2020-03-11T16:43:19Z", "path": "nuxeo-core/nuxeo-core-api/src/main/java/org/nuxeo/ecm/core/api/CoreSession.java", "diffHunk": "@@ -477,6 +477,22 @@\n      */\n     DocumentModel createDocumentModel(String parentPath, String name, String typeName);\n \n+    /**\n+     * Creates a new document model using required information.\n+     * <p>\n+     * Used to fetch initial datamodels from the type definition.\n+     * <p>\n+     * DocumentModel creation notifies a {@link DocumentEventTypes#EMPTY_DOCUMENTMODEL_CREATED} so that core event\n+     * listener can initialize its content with computed properties.\n+     *\n+     * @param parentRef the parent document ref {@link DocumentRef}\n+     * @param name The destination name\n+     * @param typeName the type name\n+     * @return the initial document model\n+     * @since 10.10-HF23", "originalCommit": "b4782bf0081c1bea749fc98179b6765c5dbf376f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTEyMzMzMQ==", "url": "https://github.com/nuxeo/nuxeo/pull/3820#discussion_r391123331", "bodyText": "I was thinking we should keep the same since, I mean by that if we did the modification on master -> @since 11.1 we should keep it when we backport and I was thing this is also true from 10.10 to 11.1, when the method is added on 10.10 and forwarded we should keep it.", "author": "RSalem07", "createdAt": "2020-03-11T17:02:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTExMDY1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTE1NTkzNA==", "url": "https://github.com/nuxeo/nuxeo/pull/3820#discussion_r391155934", "bodyText": "Not in this direction, what is important to know is the introduction in Master. Then you can change the since for backport if you want to be explicit, but it adds more work.", "author": "kevinleturc", "createdAt": "2020-03-11T17:50:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTExMDY1MQ=="}], "type": "inlineReview", "revised_code": {"commit": "3dfc72c5ef3efb355e49583a5f47d2a123570824", "chunk": "diff --git a/nuxeo-core/nuxeo-core-api/src/main/java/org/nuxeo/ecm/core/api/CoreSession.java b/nuxeo-core/nuxeo-core-api/src/main/java/org/nuxeo/ecm/core/api/CoreSession.java\nindex 6fce512c452..cd8be899e8f 100644\n--- a/nuxeo-core/nuxeo-core-api/src/main/java/org/nuxeo/ecm/core/api/CoreSession.java\n+++ b/nuxeo-core/nuxeo-core-api/src/main/java/org/nuxeo/ecm/core/api/CoreSession.java\n\n@@ -489,7 +489,7 @@ public interface CoreSession {\n      * @param name The destination name\n      * @param typeName the type name\n      * @return the initial document model\n-     * @since 10.10-HF23\n+     * @since 11.1\n      */\n     DocumentModel newDocumentModel(DocumentRef parentRef, String name, String typeName);\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTExMzgxMw==", "url": "https://github.com/nuxeo/nuxeo/pull/3820#discussion_r391113813", "bodyText": "Don't we want to use this new API with parentRef for former methods with String? I'm talking about the setPathInfo in this method which could be removed I think.", "author": "kevinleturc", "createdAt": "2020-03-11T16:48:05Z", "path": "nuxeo-core/nuxeo-core/src/main/java/org/nuxeo/ecm/core/api/AbstractSession.java", "diffHunk": "@@ -616,12 +616,16 @@ public void cancel() {\n     }\n \n     private DocumentModel createDocumentModelFromTypeName(String typeName, Map<String, Serializable> options) {\n-        SchemaManager schemaManager = Framework.getService(SchemaManager.class);\n-        DocumentType docType = schemaManager.getDocumentType(typeName);\n+        return createDocumentModelFromParentAndType(null, typeName, options);\n+    }\n+\n+    private DocumentModel createDocumentModelFromParentAndType(DocumentRef parentRef, String typeName,", "originalCommit": "b4782bf0081c1bea749fc98179b6765c5dbf376f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTEzMDE4NA==", "url": "https://github.com/nuxeo/nuxeo/pull/3820#discussion_r391130184", "bodyText": "I see what you mean, but perhaps we should keep it, because this method compute the path and the ref:\n @Override\n    public void setPathInfo(String parentPath, String name) {\n        path = new Path(parentPath == null ? name : parentPath + '/' + name);\n        ref = new PathRef(parentPath, name);\n    }\n\ni think if we want to remove it from former method, we should rewrite this once, and I thinking about the case where the DocumentRef parentRef that we pass as parameter if it is a IdRef we can do a meeting to clarify the things :)", "author": "RSalem07", "createdAt": "2020-03-11T17:12:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTExMzgxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTE1NzY2Nw==", "url": "https://github.com/nuxeo/nuxeo/pull/3820#discussion_r391157667", "bodyText": "Of course for a meeting \ud83d\udc4c\nSome answer:\nIdref shouldn't be a problem as we resolve the reference to get the path from Document.", "author": "kevinleturc", "createdAt": "2020-03-11T17:53:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTExMzgxMw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTExNzA1Mg==", "url": "https://github.com/nuxeo/nuxeo/pull/3820#discussion_r391117052", "bodyText": "Since 11.1", "author": "kevinleturc", "createdAt": "2020-03-11T16:52:51Z", "path": "nuxeo-core/nuxeo-core/src/main/java/org/nuxeo/ecm/core/api/DocumentModelFactory.java", "diffHunk": "@@ -166,8 +166,23 @@ public static DocumentModelImpl createDocumentModel(String docType) {\n      * @return the document model\n      */\n     public static DocumentModelImpl createDocumentModel(String sessionId, DocumentType docType) {\n-        DocumentModelImpl docModel = new DocumentModelImpl(sessionId, docType.getName(), null, null, null, null, null,\n-                null, null, null, null);\n+        return createDocumentModel(sessionId, docType, null);\n+    }\n+\n+    /**\n+     * Creates a document model for a new document.\n+     * <p>\n+     * Initializes the proper data models according to the type info.\n+     *\n+     * @param sessionId the CoreSession id\n+     * @param docType the document type\n+     * @param parentRef the parent ref\n+     * @return the document model\n+     * @since 10.10-HF23", "originalCommit": "b4782bf0081c1bea749fc98179b6765c5dbf376f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3dfc72c5ef3efb355e49583a5f47d2a123570824", "chunk": "diff --git a/nuxeo-core/nuxeo-core/src/main/java/org/nuxeo/ecm/core/api/DocumentModelFactory.java b/nuxeo-core/nuxeo-core/src/main/java/org/nuxeo/ecm/core/api/DocumentModelFactory.java\nindex 7cb654c4179..5390a4b1e97 100644\n--- a/nuxeo-core/nuxeo-core/src/main/java/org/nuxeo/ecm/core/api/DocumentModelFactory.java\n+++ b/nuxeo-core/nuxeo-core/src/main/java/org/nuxeo/ecm/core/api/DocumentModelFactory.java\n\n@@ -178,7 +178,7 @@ public class DocumentModelFactory {\n      * @param docType the document type\n      * @param parentRef the parent ref\n      * @return the document model\n-     * @since 10.10-HF23\n+     * @since 11.1\n      */\n     public static DocumentModelImpl createDocumentModel(String sessionId, DocumentType docType, DocumentRef parentRef) {\n         DocumentModelImpl docModel = new DocumentModelImpl(sessionId, docType.getName(), null, null, null, null,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTExNzU4Nw==", "url": "https://github.com/nuxeo/nuxeo/pull/3820#discussion_r391117587", "bodyText": "since 11.1", "author": "kevinleturc", "createdAt": "2020-03-11T16:53:37Z", "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/main/java/org/nuxeo/ecm/platform/comment/impl/TreeCommentManager.java", "diffHunk": "@@ -308,21 +308,26 @@ public void deleteComment(DocumentModel doc, DocumentModel comment) {\n         throw new UnsupportedOperationException(SERVICE_WITHOUT_IMPLEMENTATION_MESSAGE);\n     }\n \n-    @Override\n-    public String getLocationOfCommentCreation(CoreSession session, DocumentModel commentedDoc) {\n+    /**\n+     * Returns the {@link DocumentRef} of the comments location in repository for the given commented document model.\n+     *\n+     * @param session the session needs to be privileged\n+     * @return the document model container of the comments of the given {@code commentedDoc}\n+     * @since 10.10-HF23", "originalCommit": "b4782bf0081c1bea749fc98179b6765c5dbf376f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3dfc72c5ef3efb355e49583a5f47d2a123570824", "chunk": "diff --git a/nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/main/java/org/nuxeo/ecm/platform/comment/impl/TreeCommentManager.java b/nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/main/java/org/nuxeo/ecm/platform/comment/impl/TreeCommentManager.java\nindex e06c883e43d..223c2674fbe 100644\n--- a/nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/main/java/org/nuxeo/ecm/platform/comment/impl/TreeCommentManager.java\n+++ b/nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/main/java/org/nuxeo/ecm/platform/comment/impl/TreeCommentManager.java\n\n@@ -313,7 +313,7 @@ public class TreeCommentManager extends AbstractCommentManager {\n      *\n      * @param session the session needs to be privileged\n      * @return the document model container of the comments of the given {@code commentedDoc}\n-     * @since 10.10-HF23\n+     * @since 11.1\n      */\n     protected DocumentRef getLocationRefOfCommentCreation(CoreSession session, DocumentModel commentedDoc) {\n         if (commentedDoc.hasSchema(COMMENT_SCHEMA)) {\n"}}, {"oid": "3dfc72c5ef3efb355e49583a5f47d2a123570824", "url": "https://github.com/nuxeo/nuxeo/commit/3dfc72c5ef3efb355e49583a5f47d2a123570824", "message": "NXP-28719: Fix Comment Migration failure due to versions", "committedDate": "2020-03-12T08:32:58Z", "type": "forcePushed"}, {"oid": "1db9568191545b007a70e3a68cc030d36f3b06d5", "url": "https://github.com/nuxeo/nuxeo/commit/1db9568191545b007a70e3a68cc030d36f3b06d5", "message": "NXP-28719: Fix Comment Migration failure due to versions", "committedDate": "2020-03-12T13:54:13Z", "type": "forcePushed"}, {"oid": "8b3253a6f2b38353bc1b05ee1704679a939633cc", "url": "https://github.com/nuxeo/nuxeo/commit/8b3253a6f2b38353bc1b05ee1704679a939633cc", "message": "NXP-28727: Document created under a placeless document Mustnt be a placeless", "committedDate": "2020-03-12T14:00:02Z", "type": "commit"}, {"oid": "c0f62f76712c026c8d2de67f5ecad24116cc8438", "url": "https://github.com/nuxeo/nuxeo/commit/c0f62f76712c026c8d2de67f5ecad24116cc8438", "message": "NXP-28731: Create comments on a placeless document must be effective", "committedDate": "2020-03-12T14:00:03Z", "type": "commit"}, {"oid": "d8d8ffdea5888643567a1875785b4e5e3f886ba6", "url": "https://github.com/nuxeo/nuxeo/commit/d8d8ffdea5888643567a1875785b4e5e3f886ba6", "message": "NXP-28719: Fix Comment Migration failure due to versions", "committedDate": "2020-03-12T14:00:03Z", "type": "commit"}, {"oid": "d8d8ffdea5888643567a1875785b4e5e3f886ba6", "url": "https://github.com/nuxeo/nuxeo/commit/d8d8ffdea5888643567a1875785b4e5e3f886ba6", "message": "NXP-28719: Fix Comment Migration failure due to versions", "committedDate": "2020-03-12T14:00:03Z", "type": "forcePushed"}]}