{"pr_number": 4222, "pr_title": "9.10-HF/fix-29270-children-trashed-by-system", "pr_createdAt": "2020-07-21T11:36:14Z", "pr_url": "https://github.com/nuxeo/nuxeo/pull/4222", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODE1NTU4Ng==", "url": "https://github.com/nuxeo/nuxeo/pull/4222#discussion_r458155586", "bodyText": "We may want to keep the existing #getReconnectedCoreSession(String) method for backward compatibility?\nWDYT @efge ?", "author": "troger", "createdAt": "2020-07-21T14:47:18Z", "path": "nuxeo-core/nuxeo-core-event/src/main/java/org/nuxeo/ecm/core/event/impl/ReconnectedEventBundleImpl.java", "diffHunk": "@@ -82,15 +84,15 @@ public ReconnectedEventBundleImpl(EventBundle sourceEventBundle, String listener\n         this.listenerName = listenerName;\n     }\n \n-    protected CoreSession getReconnectedCoreSession(String repoName) {\n+    protected CoreSession getReconnectedCoreSession(String repoName, String originatingUsername) {", "originalCommit": "b9d7acf8f8f849f639f0b4f97699c6e55d306077", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODE1Nzg0NQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4222#discussion_r458157845", "bodyText": "Yes we must have 100% compatibility in backports.", "author": "efge", "createdAt": "2020-07-21T14:50:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODE1NTU4Ng=="}], "type": "inlineReview", "revised_code": {"commit": "b43e33544e14ed311638be9c69a255a3ed192de5", "chunk": "diff --git a/nuxeo-core/nuxeo-core-event/src/main/java/org/nuxeo/ecm/core/event/impl/ReconnectedEventBundleImpl.java b/nuxeo-core/nuxeo-core-event/src/main/java/org/nuxeo/ecm/core/event/impl/ReconnectedEventBundleImpl.java\nindex cfac964ff95..31ec0530ee8 100644\n--- a/nuxeo-core/nuxeo-core-event/src/main/java/org/nuxeo/ecm/core/event/impl/ReconnectedEventBundleImpl.java\n+++ b/nuxeo-core/nuxeo-core-event/src/main/java/org/nuxeo/ecm/core/event/impl/ReconnectedEventBundleImpl.java\n\n@@ -84,6 +84,28 @@ public class ReconnectedEventBundleImpl implements ReconnectedEventBundle {\n         this.listenerName = listenerName;\n     }\n \n+    /** @Deprecated since 9.10-HF46 see NXP-29270. Use {@link #getReconnectedCoreSession(String, String)} instead */\n+    protected CoreSession getReconnectedCoreSession(String repoName) {\n+        if (reconnectedCoreSession == null) {\n+            try {\n+                loginCtx = Framework.login();\n+            } catch (LoginException e) {\n+                log.error(\"Cannot log in\", e);\n+                return null;\n+            }\n+            reconnectedCoreSession = CoreInstance.openCoreSessionSystem(repoName);\n+        } else {\n+            // Sanity Check\n+            if (!reconnectedCoreSession.getRepositoryName().equals(repoName)) {\n+                if (repoName != null) {\n+                    throw new IllegalStateException(\"Can no reconnected a Bundle tied to several Core instances !\");\n+                }\n+            }\n+        }\n+        return reconnectedCoreSession;\n+    }\n+\n+    /** @since 9.10-HF46 see NXP-29270 */\n     protected CoreSession getReconnectedCoreSession(String repoName, String originatingUsername) {\n         if (reconnectedCoreSession == null) {\n             try {\n"}}, {"oid": "b43e33544e14ed311638be9c69a255a3ed192de5", "url": "https://github.com/nuxeo/nuxeo/commit/b43e33544e14ed311638be9c69a255a3ed192de5", "message": "NXP-29270: log acting user, not 'system', in audit", "committedDate": "2020-07-22T09:24:42Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODc4Njc5Mg==", "url": "https://github.com/nuxeo/nuxeo/pull/4222#discussion_r458786792", "bodyText": "Missing @Deprecated annotation.", "author": "troger", "createdAt": "2020-07-22T13:22:09Z", "path": "nuxeo-core/nuxeo-core-event/src/main/java/org/nuxeo/ecm/core/event/impl/ReconnectedEventBundleImpl.java", "diffHunk": "@@ -82,6 +84,7 @@ public ReconnectedEventBundleImpl(EventBundle sourceEventBundle, String listener\n         this.listenerName = listenerName;\n     }\n \n+    /** @Deprecated since 9.10-HF46 see NXP-29270. Use {@link #getReconnectedCoreSession(String, String)} instead */\n     protected CoreSession getReconnectedCoreSession(String repoName) {", "originalCommit": "b43e33544e14ed311638be9c69a255a3ed192de5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "7e03bd9413eda31b51fe8fcd7099a54a600348cf", "chunk": "diff --git a/nuxeo-core/nuxeo-core-event/src/main/java/org/nuxeo/ecm/core/event/impl/ReconnectedEventBundleImpl.java b/nuxeo-core/nuxeo-core-event/src/main/java/org/nuxeo/ecm/core/event/impl/ReconnectedEventBundleImpl.java\nindex 31ec0530ee8..f13bff14e8a 100644\n--- a/nuxeo-core/nuxeo-core-event/src/main/java/org/nuxeo/ecm/core/event/impl/ReconnectedEventBundleImpl.java\n+++ b/nuxeo-core/nuxeo-core-event/src/main/java/org/nuxeo/ecm/core/event/impl/ReconnectedEventBundleImpl.java\n\n@@ -84,7 +84,8 @@ public class ReconnectedEventBundleImpl implements ReconnectedEventBundle {\n         this.listenerName = listenerName;\n     }\n \n-    /** @Deprecated since 9.10-HF46 see NXP-29270. Use {@link #getReconnectedCoreSession(String, String)} instead */\n+    /** @deprecated since 9.10-HF46 see NXP-29270. Use {@link #getReconnectedCoreSession(String, String)} instead */\n+    @Deprecated\n     protected CoreSession getReconnectedCoreSession(String repoName) {\n         if (reconnectedCoreSession == null) {\n             try {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODc4NjkyNQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4222#discussion_r458786925", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                /** @Deprecated since 9.10-HF46 see NXP-29270. Use {@link #getReconnectedCoreSession(String, String)} instead */\n          \n          \n            \n                /** @deprecated since 9.10-HF46 see NXP-29270. Use {@link #getReconnectedCoreSession(String, String)} instead */", "author": "troger", "createdAt": "2020-07-22T13:22:21Z", "path": "nuxeo-core/nuxeo-core-event/src/main/java/org/nuxeo/ecm/core/event/impl/ReconnectedEventBundleImpl.java", "diffHunk": "@@ -82,6 +84,7 @@ public ReconnectedEventBundleImpl(EventBundle sourceEventBundle, String listener\n         this.listenerName = listenerName;\n     }\n \n+    /** @Deprecated since 9.10-HF46 see NXP-29270. Use {@link #getReconnectedCoreSession(String, String)} instead */", "originalCommit": "b43e33544e14ed311638be9c69a255a3ed192de5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "7e03bd9413eda31b51fe8fcd7099a54a600348cf", "chunk": "diff --git a/nuxeo-core/nuxeo-core-event/src/main/java/org/nuxeo/ecm/core/event/impl/ReconnectedEventBundleImpl.java b/nuxeo-core/nuxeo-core-event/src/main/java/org/nuxeo/ecm/core/event/impl/ReconnectedEventBundleImpl.java\nindex 31ec0530ee8..f13bff14e8a 100644\n--- a/nuxeo-core/nuxeo-core-event/src/main/java/org/nuxeo/ecm/core/event/impl/ReconnectedEventBundleImpl.java\n+++ b/nuxeo-core/nuxeo-core-event/src/main/java/org/nuxeo/ecm/core/event/impl/ReconnectedEventBundleImpl.java\n\n@@ -84,7 +84,8 @@ public class ReconnectedEventBundleImpl implements ReconnectedEventBundle {\n         this.listenerName = listenerName;\n     }\n \n-    /** @Deprecated since 9.10-HF46 see NXP-29270. Use {@link #getReconnectedCoreSession(String, String)} instead */\n+    /** @deprecated since 9.10-HF46 see NXP-29270. Use {@link #getReconnectedCoreSession(String, String)} instead */\n+    @Deprecated\n     protected CoreSession getReconnectedCoreSession(String repoName) {\n         if (reconnectedCoreSession == null) {\n             try {\n"}}, {"oid": "7e03bd9413eda31b51fe8fcd7099a54a600348cf", "url": "https://github.com/nuxeo/nuxeo/commit/7e03bd9413eda31b51fe8fcd7099a54a600348cf", "message": "NXP-29270: log acting user, not 'system', in audit", "committedDate": "2020-07-22T16:16:00Z", "type": "commit"}, {"oid": "7e03bd9413eda31b51fe8fcd7099a54a600348cf", "url": "https://github.com/nuxeo/nuxeo/commit/7e03bd9413eda31b51fe8fcd7099a54a600348cf", "message": "NXP-29270: log acting user, not 'system', in audit", "committedDate": "2020-07-22T16:16:00Z", "type": "forcePushed"}]}