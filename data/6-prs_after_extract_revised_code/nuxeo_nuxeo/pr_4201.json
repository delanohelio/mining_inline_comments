{"pr_number": 4201, "pr_title": "10.10-HF/fix-NXP-29246-import-MHTLM-in-chrome", "pr_createdAt": "2020-07-06T12:03:28Z", "pr_url": "https://github.com/nuxeo/nuxeo/pull/4201", "timeline": [{"oid": "7e090ad507a83d7630c58fadef54fd7d79cbaf82", "url": "https://github.com/nuxeo/nuxeo/commit/7e090ad507a83d7630c58fadef54fd7d79cbaf82", "message": "NXP-29246: add MHTML mime-type support", "committedDate": "2020-07-07T17:48:34Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA0ODE3OA==", "url": "https://github.com/nuxeo/nuxeo/pull/4201#discussion_r451048178", "bodyText": "new lines removed in next push", "author": "NourNuxeo", "createdAt": "2020-07-07T18:02:40Z", "path": "nuxeo-features/rest-api/nuxeo-rest-api-server/src/main/java/org/nuxeo/ecm/restapi/server/jaxrs/BatchUploadObject.java", "diffHunk": "@@ -130,6 +137,8 @@\n \n     public static final String MD5 = \"md5\";\n \n+\n+", "originalCommit": "7e090ad507a83d7630c58fadef54fd7d79cbaf82", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e1f9695141e3da596b4b504a9b9c9ef8a2101138", "chunk": "diff --git a/nuxeo-features/rest-api/nuxeo-rest-api-server/src/main/java/org/nuxeo/ecm/restapi/server/jaxrs/BatchUploadObject.java b/nuxeo-features/rest-api/nuxeo-rest-api-server/src/main/java/org/nuxeo/ecm/restapi/server/jaxrs/BatchUploadObject.java\nindex 4b9b8a5fa49..5a999b2a657 100644\n--- a/nuxeo-features/rest-api/nuxeo-rest-api-server/src/main/java/org/nuxeo/ecm/restapi/server/jaxrs/BatchUploadObject.java\n+++ b/nuxeo-features/rest-api/nuxeo-rest-api-server/src/main/java/org/nuxeo/ecm/restapi/server/jaxrs/BatchUploadObject.java\n\n@@ -137,8 +137,6 @@ public class BatchUploadObject extends AbstractResource<ResourceTypeImpl> {\n \n     public static final String MD5 = \"md5\";\n \n-\n-\n     protected Map<String, String> mapWithName(String name) {\n         return Collections.singletonMap(\"name\", name);\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA3OTcyMw==", "url": "https://github.com/nuxeo/nuxeo/pull/4201#discussion_r451079723", "bodyText": "comment removed in next push", "author": "NourNuxeo", "createdAt": "2020-07-07T19:02:14Z", "path": "nuxeo-features/rest-api/nuxeo-rest-api-test/src/test/java/org/nuxeo/ecm/restapi/test/BatchUploadFixture.java", "diffHunk": "@@ -1045,6 +1046,33 @@ public void testErrorOnRefreshedTokenError() throws Exception {\n         }\n     }\n \n+    @Test\n+    public void testUploadMHTML() throws Exception {\n+        try (CloseableClientResponse response = getResponse(RequestType.POST, \"upload/\" + initializeNewBatch() + \"/0\",\n+                \"dummy\", Collections.singletonMap(\"Content-Type\", \"multipart/related\"))) {\n+            assertEquals(Status.INTERNAL_SERVER_ERROR.getStatusCode(), response.getStatus());\n+        }\n+    }\n+\n+    @Test\n+    @Deploy(\"org.nuxeo.ecm.platform.restapi.server:batch-upload-contrib-test.xml\")\n+    public void testUploadMHTMLMultipartDisabled() throws Exception {\n+        String batchId = initializeNewBatch();\n+        Map<String, String> headers = new HashMap<>();\n+        headers.put(\"Content-Type\", \"multipart/related\");\n+        headers.put(\"X-File-Name\", \"dummy.mhtml\");\n+        // typed via mime-type", "originalCommit": "7e090ad507a83d7630c58fadef54fd7d79cbaf82", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e1f9695141e3da596b4b504a9b9c9ef8a2101138", "chunk": "diff --git a/nuxeo-features/rest-api/nuxeo-rest-api-test/src/test/java/org/nuxeo/ecm/restapi/test/BatchUploadFixture.java b/nuxeo-features/rest-api/nuxeo-rest-api-test/src/test/java/org/nuxeo/ecm/restapi/test/BatchUploadFixture.java\nindex ed23cea7d0f..1e372d480e8 100644\n--- a/nuxeo-features/rest-api/nuxeo-rest-api-test/src/test/java/org/nuxeo/ecm/restapi/test/BatchUploadFixture.java\n+++ b/nuxeo-features/rest-api/nuxeo-rest-api-test/src/test/java/org/nuxeo/ecm/restapi/test/BatchUploadFixture.java\n\n@@ -1055,13 +1055,12 @@ public class BatchUploadFixture extends BaseTest {\n     }\n \n     @Test\n-    @Deploy(\"org.nuxeo.ecm.platform.restapi.server:batch-upload-contrib-test.xml\")\n+    @Deploy(\"org.nuxeo.ecm.platform.restapi.test.test:batch-upload-contrib-test.xml\")\n     public void testUploadMHTMLMultipartDisabled() throws Exception {\n         String batchId = initializeNewBatch();\n         Map<String, String> headers = new HashMap<>();\n         headers.put(\"Content-Type\", \"multipart/related\");\n         headers.put(\"X-File-Name\", \"dummy.mhtml\");\n-        // typed via mime-type\n         try (CloseableClientResponse response = getResponse(RequestType.POST, \"upload/\" + batchId + \"/0\",\n                 \"dummy\", headers)) {\n             assertEquals(Status.CREATED.getStatusCode(), response.getStatus());\n"}}, {"oid": "e1f9695141e3da596b4b504a9b9c9ef8a2101138", "url": "https://github.com/nuxeo/nuxeo/commit/e1f9695141e3da596b4b504a9b9c9ef8a2101138", "message": "NXP-29246: add MHTML mime-type support", "committedDate": "2020-07-08T09:40:44Z", "type": "forcePushed"}, {"oid": "f99385045a8d9652e6a4854cc5f984da3490196b", "url": "https://github.com/nuxeo/nuxeo/commit/f99385045a8d9652e6a4854cc5f984da3490196b", "message": "NXP-29246: add MHTML mime-type support", "committedDate": "2020-07-08T13:42:57Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjIxNDg2Mw==", "url": "https://github.com/nuxeo/nuxeo/pull/4201#discussion_r452214863", "bodyText": "add nxp ticket in jdoc", "author": "NourNuxeo", "createdAt": "2020-07-09T13:25:21Z", "path": "nuxeo-features/rest-api/nuxeo-rest-api-test/src/test/java/org/nuxeo/ecm/restapi/test/BatchUploadFixture.java", "diffHunk": "@@ -1045,6 +1046,32 @@ public void testErrorOnRefreshedTokenError() throws Exception {\n         }\n     }\n \n+    @Test", "originalCommit": "f99385045a8d9652e6a4854cc5f984da3490196b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6603f4fae2ca110843679c0ea839fa94121f1706", "chunk": "diff --git a/nuxeo-features/rest-api/nuxeo-rest-api-test/src/test/java/org/nuxeo/ecm/restapi/test/BatchUploadFixture.java b/nuxeo-features/rest-api/nuxeo-rest-api-test/src/test/java/org/nuxeo/ecm/restapi/test/BatchUploadFixture.java\nindex 1e372d480e8..1ad48bef90c 100644\n--- a/nuxeo-features/rest-api/nuxeo-rest-api-test/src/test/java/org/nuxeo/ecm/restapi/test/BatchUploadFixture.java\n+++ b/nuxeo-features/rest-api/nuxeo-rest-api-test/src/test/java/org/nuxeo/ecm/restapi/test/BatchUploadFixture.java\n\n@@ -1047,7 +1047,8 @@ public class BatchUploadFixture extends BaseTest {\n     }\n \n     @Test\n-    public void testUploadMHTML() throws Exception {\n+    /** NXP-29246: Fix import of MHTML file using Chrome */\n+    public void testUploadMHTMLMultipartEnabled() throws Exception {\n         try (CloseableClientResponse response = getResponse(RequestType.POST, \"upload/\" + initializeNewBatch() + \"/0\",\n                 \"dummy\", Collections.singletonMap(\"Content-Type\", \"multipart/related\"))) {\n             assertEquals(Status.INTERNAL_SERVER_ERROR.getStatusCode(), response.getStatus());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjIxODg2MQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4201#discussion_r452218861", "bodyText": "check isMultipartDisabled first to short-circuit", "author": "NourNuxeo", "createdAt": "2020-07-09T13:31:05Z", "path": "nuxeo-features/rest-api/nuxeo-rest-api-server/src/main/java/org/nuxeo/ecm/restapi/server/jaxrs/BatchUploadObject.java", "diffHunk": "@@ -232,7 +239,7 @@ protected Response uploadNoTransaction(@Context HttpServletRequest request,\n         // TODO NXP-18247: should be set to the actual number of bytes uploaded instead of relying on the Content-Length\n         // header which is not necessarily set\n         long uploadedSize = getUploadedSize(request);\n-        boolean isMultipart = contentType != null && contentType.contains(\"multipart\");\n+        boolean isMultipart = contentType != null && contentType.contains(\"multipart\") && !isMultipartDisabled();", "originalCommit": "f99385045a8d9652e6a4854cc5f984da3490196b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6603f4fae2ca110843679c0ea839fa94121f1706", "chunk": "diff --git a/nuxeo-features/rest-api/nuxeo-rest-api-server/src/main/java/org/nuxeo/ecm/restapi/server/jaxrs/BatchUploadObject.java b/nuxeo-features/rest-api/nuxeo-rest-api-server/src/main/java/org/nuxeo/ecm/restapi/server/jaxrs/BatchUploadObject.java\nindex 5a999b2a657..73200b869d7 100644\n--- a/nuxeo-features/rest-api/nuxeo-rest-api-server/src/main/java/org/nuxeo/ecm/restapi/server/jaxrs/BatchUploadObject.java\n+++ b/nuxeo-features/rest-api/nuxeo-rest-api-server/src/main/java/org/nuxeo/ecm/restapi/server/jaxrs/BatchUploadObject.java\n\n@@ -239,7 +236,7 @@ public class BatchUploadObject extends AbstractResource<ResourceTypeImpl> {\n         // TODO NXP-18247: should be set to the actual number of bytes uploaded instead of relying on the Content-Length\n         // header which is not necessarily set\n         long uploadedSize = getUploadedSize(request);\n-        boolean isMultipart = contentType != null && contentType.contains(\"multipart\") && !isMultipartDisabled();\n+        boolean isMultipart = !isMultipartDisabled() && contentType != null && contentType.contains(\"multipart\");\n \n         // Handle multipart case: mainly MSIE with jQueryFileupload\n         if (isMultipart) {\n"}}, {"oid": "6603f4fae2ca110843679c0ea839fa94121f1706", "url": "https://github.com/nuxeo/nuxeo/commit/6603f4fae2ca110843679c0ea839fa94121f1706", "message": "NXP-29246: add MHTML mime-type support", "committedDate": "2020-07-15T11:09:52Z", "type": "forcePushed"}, {"oid": "ee04e2f516f9e7f6300044755b1e196e2ccedac5", "url": "https://github.com/nuxeo/nuxeo/commit/ee04e2f516f9e7f6300044755b1e196e2ccedac5", "message": "NXP-29246: add MHTML mime-type support", "committedDate": "2020-07-15T17:06:52Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQwMTgyMw==", "url": "https://github.com/nuxeo/nuxeo/pull/4201#discussion_r457401823", "bodyText": "As this property does not exist in 11.2, I would update the since for the next HF.", "author": "troger", "createdAt": "2020-07-20T13:49:41Z", "path": "nuxeo-features/rest-api/nuxeo-rest-api-server/src/main/java/org/nuxeo/ecm/restapi/server/jaxrs/BatchUploadObject.java", "diffHunk": "@@ -116,6 +117,9 @@\n \n     protected static final String REQUEST_HANDLER_NAME = \"handlerName\";\n \n+    /** @since 11.2 */", "originalCommit": "ee04e2f516f9e7f6300044755b1e196e2ccedac5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzcwODYzMg==", "url": "https://github.com/nuxeo/nuxeo/pull/4201#discussion_r457708632", "bodyText": "aligned with 10.10-HF30", "author": "NourNuxeo", "createdAt": "2020-07-20T21:43:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQwMTgyMw=="}], "type": "inlineReview", "revised_code": {"commit": "d88feb7f464b7b88b4965984a8889999876723be", "chunk": "diff --git a/nuxeo-features/rest-api/nuxeo-rest-api-server/src/main/java/org/nuxeo/ecm/restapi/server/jaxrs/BatchUploadObject.java b/nuxeo-features/rest-api/nuxeo-rest-api-server/src/main/java/org/nuxeo/ecm/restapi/server/jaxrs/BatchUploadObject.java\nindex 73200b869d7..a00ab2ba9b6 100644\n--- a/nuxeo-features/rest-api/nuxeo-rest-api-server/src/main/java/org/nuxeo/ecm/restapi/server/jaxrs/BatchUploadObject.java\n+++ b/nuxeo-features/rest-api/nuxeo-rest-api-server/src/main/java/org/nuxeo/ecm/restapi/server/jaxrs/BatchUploadObject.java\n\n@@ -117,8 +117,8 @@ public class BatchUploadObject extends AbstractResource<ResourceTypeImpl> {\n \n     protected static final String REQUEST_HANDLER_NAME = \"handlerName\";\n \n-    /** @since 11.2 */\n-    protected static final String MULTIPART_CONFIG_KEY = \"nuxeo.batch.upload.multipart.disabled\";\n+    /** @since 10.10-HF30 */\n+    protected static final String MULTIPART_DISABLED_CONFIG_KEY = \"nuxeo.batch.upload.multipart.disabled\";\n \n     public static final String UPLOAD_TYPE_NORMAL = \"normal\";\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQwMjg3MA==", "url": "https://github.com/nuxeo/nuxeo/pull/4201#discussion_r457402870", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                protected static final String MULTIPART_CONFIG_KEY = \"nuxeo.batch.upload.multipart.disabled\";\n          \n          \n            \n                protected static final String MULTIPART_DISABLED_CONFIG_KEY = \"nuxeo.batch.upload.multipart.disabled\";", "author": "troger", "createdAt": "2020-07-20T13:50:48Z", "path": "nuxeo-features/rest-api/nuxeo-rest-api-server/src/main/java/org/nuxeo/ecm/restapi/server/jaxrs/BatchUploadObject.java", "diffHunk": "@@ -116,6 +117,9 @@\n \n     protected static final String REQUEST_HANDLER_NAME = \"handlerName\";\n \n+    /** @since 11.2 */\n+    protected static final String MULTIPART_CONFIG_KEY = \"nuxeo.batch.upload.multipart.disabled\";", "originalCommit": "ee04e2f516f9e7f6300044755b1e196e2ccedac5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d88feb7f464b7b88b4965984a8889999876723be", "chunk": "diff --git a/nuxeo-features/rest-api/nuxeo-rest-api-server/src/main/java/org/nuxeo/ecm/restapi/server/jaxrs/BatchUploadObject.java b/nuxeo-features/rest-api/nuxeo-rest-api-server/src/main/java/org/nuxeo/ecm/restapi/server/jaxrs/BatchUploadObject.java\nindex 73200b869d7..a00ab2ba9b6 100644\n--- a/nuxeo-features/rest-api/nuxeo-rest-api-server/src/main/java/org/nuxeo/ecm/restapi/server/jaxrs/BatchUploadObject.java\n+++ b/nuxeo-features/rest-api/nuxeo-rest-api-server/src/main/java/org/nuxeo/ecm/restapi/server/jaxrs/BatchUploadObject.java\n\n@@ -117,8 +117,8 @@ public class BatchUploadObject extends AbstractResource<ResourceTypeImpl> {\n \n     protected static final String REQUEST_HANDLER_NAME = \"handlerName\";\n \n-    /** @since 11.2 */\n-    protected static final String MULTIPART_CONFIG_KEY = \"nuxeo.batch.upload.multipart.disabled\";\n+    /** @since 10.10-HF30 */\n+    protected static final String MULTIPART_DISABLED_CONFIG_KEY = \"nuxeo.batch.upload.multipart.disabled\";\n \n     public static final String UPLOAD_TYPE_NORMAL = \"normal\";\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQwMzkzMQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4201#discussion_r457403931", "bodyText": "What about:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    boolean isMultipart = !isMultipartDisabled() && contentType != null && contentType.contains(\"multipart\");\n          \n          \n            \n                    boolean isMultipart = isMultipartEnabled() && contentType != null && contentType.contains(\"multipart\");\n          \n      \n    \n    \n  \n\n?", "author": "troger", "createdAt": "2020-07-20T13:51:55Z", "path": "nuxeo-features/rest-api/nuxeo-rest-api-server/src/main/java/org/nuxeo/ecm/restapi/server/jaxrs/BatchUploadObject.java", "diffHunk": "@@ -232,7 +236,7 @@ protected Response uploadNoTransaction(@Context HttpServletRequest request,\n         // TODO NXP-18247: should be set to the actual number of bytes uploaded instead of relying on the Content-Length\n         // header which is not necessarily set\n         long uploadedSize = getUploadedSize(request);\n-        boolean isMultipart = contentType != null && contentType.contains(\"multipart\");\n+        boolean isMultipart = !isMultipartDisabled() && contentType != null && contentType.contains(\"multipart\");", "originalCommit": "ee04e2f516f9e7f6300044755b1e196e2ccedac5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzcwODQyNQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4201#discussion_r457708425", "bodyText": "d\u00f4\u00f4ne", "author": "NourNuxeo", "createdAt": "2020-07-20T21:42:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQwMzkzMQ=="}], "type": "inlineReview", "revised_code": {"commit": "d88feb7f464b7b88b4965984a8889999876723be", "chunk": "diff --git a/nuxeo-features/rest-api/nuxeo-rest-api-server/src/main/java/org/nuxeo/ecm/restapi/server/jaxrs/BatchUploadObject.java b/nuxeo-features/rest-api/nuxeo-rest-api-server/src/main/java/org/nuxeo/ecm/restapi/server/jaxrs/BatchUploadObject.java\nindex 73200b869d7..a00ab2ba9b6 100644\n--- a/nuxeo-features/rest-api/nuxeo-rest-api-server/src/main/java/org/nuxeo/ecm/restapi/server/jaxrs/BatchUploadObject.java\n+++ b/nuxeo-features/rest-api/nuxeo-rest-api-server/src/main/java/org/nuxeo/ecm/restapi/server/jaxrs/BatchUploadObject.java\n\n@@ -236,7 +236,7 @@ public class BatchUploadObject extends AbstractResource<ResourceTypeImpl> {\n         // TODO NXP-18247: should be set to the actual number of bytes uploaded instead of relying on the Content-Length\n         // header which is not necessarily set\n         long uploadedSize = getUploadedSize(request);\n-        boolean isMultipart = !isMultipartDisabled() && contentType != null && contentType.contains(\"multipart\");\n+        boolean isMultipart = isMultipartEnabled() && contentType != null && contentType.contains(\"multipart\");\n \n         // Handle multipart case: mainly MSIE with jQueryFileupload\n         if (isMultipart) {\n"}}, {"oid": "d88feb7f464b7b88b4965984a8889999876723be", "url": "https://github.com/nuxeo/nuxeo/commit/d88feb7f464b7b88b4965984a8889999876723be", "message": "NXP-29246: add MHTML mime-type support", "committedDate": "2020-07-20T21:41:46Z", "type": "commit"}, {"oid": "d88feb7f464b7b88b4965984a8889999876723be", "url": "https://github.com/nuxeo/nuxeo/commit/d88feb7f464b7b88b4965984a8889999876723be", "message": "NXP-29246: add MHTML mime-type support", "committedDate": "2020-07-20T21:41:46Z", "type": "forcePushed"}]}