{"pr_number": 4452, "pr_title": "Fix NXP-29529 es passthrough", "pr_createdAt": "2020-11-10T12:45:08Z", "pr_url": "https://github.com/nuxeo/nuxeo/pull/4452", "timeline": [{"oid": "5821e3bc35e20a6e2aeb77e9430f0208b704a02c", "url": "https://github.com/nuxeo/nuxeo/commit/5821e3bc35e20a6e2aeb77e9430f0208b704a02c", "message": "NXP-29529: Cleanup / Format", "committedDate": "2020-11-10T12:31:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTk1OTExMw==", "url": "https://github.com/nuxeo/nuxeo/pull/4452#discussion_r521959113", "bodyText": "extra { I guess", "author": "ataillefer", "createdAt": "2020-11-12T09:26:42Z", "path": "modules/platform/nuxeo-elasticsearch/nuxeo-elasticsearch-http-read-only/src/main/java/org/nuxeo/elasticsearch/http/readonly/DocRequestFilter.java", "diffHunk": "@@ -32,23 +32,33 @@\n \n     private final String indices;\n \n-    private final String types;\n+    /** @deprecated since 11.4, types have been removed since Elasticsearch 7.x */\n+    @Deprecated\n+    private final String types = null;\n \n     private final String documentId;\n \n     private final String rawQuery;\n \n-    public DocRequestFilter(NuxeoPrincipal principal, String indices, String types, String documentId,\n-            String rawQuery) {\n+    public DocRequestFilter(NuxeoPrincipal principal, String indices, String documentId, String rawQuery) {\n         this.principal = principal;\n         this.indices = indices;\n-        this.types = types;\n         this.documentId = documentId;\n         this.rawQuery = rawQuery;\n     }\n \n+    /**\n+     * @deprecated since 11.4, types have been removed since Elasticsearch 7.x, use\n+     *             {{@link #DocRequestFilter(NuxeoPrincipal, String, String, String)} instead", "originalCommit": "341948787efc89622a1b66228ac74ffdda9a0add", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f743dd435eb6f0e206cc9ac0979e361968d573f0", "chunk": "diff --git a/modules/platform/nuxeo-elasticsearch/nuxeo-elasticsearch-http-read-only/src/main/java/org/nuxeo/elasticsearch/http/readonly/DocRequestFilter.java b/modules/platform/nuxeo-elasticsearch/nuxeo-elasticsearch-http-read-only/src/main/java/org/nuxeo/elasticsearch/http/readonly/DocRequestFilter.java\nindex 0ab53383a30..c0762838b62 100644\n--- a/modules/platform/nuxeo-elasticsearch/nuxeo-elasticsearch-http-read-only/src/main/java/org/nuxeo/elasticsearch/http/readonly/DocRequestFilter.java\n+++ b/modules/platform/nuxeo-elasticsearch/nuxeo-elasticsearch-http-read-only/src/main/java/org/nuxeo/elasticsearch/http/readonly/DocRequestFilter.java\n\n@@ -33,7 +33,7 @@ public class DocRequestFilter {\n     private final String indices;\n \n     /** @deprecated since 11.4, types have been removed since Elasticsearch 7.x */\n-    @Deprecated\n+    @Deprecated(since = \"11.4\", forRemoval = true)\n     private final String types = null;\n \n     private final String documentId;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTk1OTgxMA==", "url": "https://github.com/nuxeo/nuxeo/pull/4452#discussion_r521959810", "bodyText": "extra {, and the following ones", "author": "ataillefer", "createdAt": "2020-11-12T09:27:42Z", "path": "modules/platform/nuxeo-elasticsearch/nuxeo-elasticsearch-http-read-only/src/main/java/org/nuxeo/elasticsearch/http/readonly/Main.java", "diffHunk": "@@ -101,37 +100,58 @@ public String searchWithPayload(@PathParam(\"indices\") String indices, @Context U\n     @Produces(MediaType.APPLICATION_JSON)\n     public String searchWithPost(@PathParam(\"indices\") String indices, @Context UriInfo uriInf, String payload)\n             throws IOException, JSONException {\n-        return doSearchWithPayload(indices, \"_all\", uriInf.getRequestUri().getRawQuery(), payload);\n+        return doSearchWithPayload(indices, uriInf.getRequestUri().getRawQuery(), payload);\n     }\n \n+    /**\n+     * @deprecated since 11.4, types have been removed since Elasticsearch 7.x, use\n+     *             {{@link #searchWithPayload(String, UriInfo, MultivaluedMap)} instead", "originalCommit": "341948787efc89622a1b66228ac74ffdda9a0add", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f743dd435eb6f0e206cc9ac0979e361968d573f0", "chunk": "diff --git a/modules/platform/nuxeo-elasticsearch/nuxeo-elasticsearch-http-read-only/src/main/java/org/nuxeo/elasticsearch/http/readonly/Main.java b/modules/platform/nuxeo-elasticsearch/nuxeo-elasticsearch-http-read-only/src/main/java/org/nuxeo/elasticsearch/http/readonly/Main.java\nindex 2209ae66fa3..18c8844b209 100644\n--- a/modules/platform/nuxeo-elasticsearch/nuxeo-elasticsearch-http-read-only/src/main/java/org/nuxeo/elasticsearch/http/readonly/Main.java\n+++ b/modules/platform/nuxeo-elasticsearch/nuxeo-elasticsearch-http-read-only/src/main/java/org/nuxeo/elasticsearch/http/readonly/Main.java\n\n@@ -105,13 +105,13 @@ public class Main extends ModuleRoot {\n \n     /**\n      * @deprecated since 11.4, types have been removed since Elasticsearch 7.x, use\n-     *             {{@link #searchWithPayload(String, UriInfo, MultivaluedMap)} instead\n+     *             {@link #searchWithPayload(String, UriInfo, MultivaluedMap)} instead\n      */\n     @GET\n     @Path(\"{indices}/{types}/_search\")\n     @Consumes(MediaType.APPLICATION_FORM_URLENCODED)\n     @Produces(MediaType.APPLICATION_JSON)\n-    @Deprecated\n+    @Deprecated(since = \"11.4\", forRemoval = true)\n     public String searchWithPayload(@PathParam(\"indices\") String indices, @PathParam(\"types\") String types,\n             @Context UriInfo uriInf, MultivaluedMap<String, String> formParams) throws IOException, JSONException {\n         return doSearchWithPayload(indices, types, uriInf.getRequestUri().getRawQuery(),\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTk2MDUxMg==", "url": "https://github.com/nuxeo/nuxeo/pull/4452#discussion_r521960512", "bodyText": "don't we want the since in the annotation?", "author": "ataillefer", "createdAt": "2020-11-12T09:28:45Z", "path": "modules/platform/nuxeo-elasticsearch/nuxeo-elasticsearch-http-read-only/src/main/java/org/nuxeo/elasticsearch/http/readonly/Main.java", "diffHunk": "@@ -101,37 +100,58 @@ public String searchWithPayload(@PathParam(\"indices\") String indices, @Context U\n     @Produces(MediaType.APPLICATION_JSON)\n     public String searchWithPost(@PathParam(\"indices\") String indices, @Context UriInfo uriInf, String payload)\n             throws IOException, JSONException {\n-        return doSearchWithPayload(indices, \"_all\", uriInf.getRequestUri().getRawQuery(), payload);\n+        return doSearchWithPayload(indices, uriInf.getRequestUri().getRawQuery(), payload);\n     }\n \n+    /**\n+     * @deprecated since 11.4, types have been removed since Elasticsearch 7.x, use\n+     *             {{@link #searchWithPayload(String, UriInfo, MultivaluedMap)} instead\n+     */\n     @GET\n     @Path(\"{indices}/{types}/_search\")\n     @Consumes(MediaType.APPLICATION_FORM_URLENCODED)\n     @Produces(MediaType.APPLICATION_JSON)\n+    @Deprecated", "originalCommit": "341948787efc89622a1b66228ac74ffdda9a0add", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTk2ODAyNw==", "url": "https://github.com/nuxeo/nuxeo/pull/4452#discussion_r521968027", "bodyText": "Indeed, forRemoval added too.", "author": "kevinleturc", "createdAt": "2020-11-12T09:40:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTk2MDUxMg=="}], "type": "inlineReview", "revised_code": {"commit": "f743dd435eb6f0e206cc9ac0979e361968d573f0", "chunk": "diff --git a/modules/platform/nuxeo-elasticsearch/nuxeo-elasticsearch-http-read-only/src/main/java/org/nuxeo/elasticsearch/http/readonly/Main.java b/modules/platform/nuxeo-elasticsearch/nuxeo-elasticsearch-http-read-only/src/main/java/org/nuxeo/elasticsearch/http/readonly/Main.java\nindex 2209ae66fa3..18c8844b209 100644\n--- a/modules/platform/nuxeo-elasticsearch/nuxeo-elasticsearch-http-read-only/src/main/java/org/nuxeo/elasticsearch/http/readonly/Main.java\n+++ b/modules/platform/nuxeo-elasticsearch/nuxeo-elasticsearch-http-read-only/src/main/java/org/nuxeo/elasticsearch/http/readonly/Main.java\n\n@@ -105,13 +105,13 @@ public class Main extends ModuleRoot {\n \n     /**\n      * @deprecated since 11.4, types have been removed since Elasticsearch 7.x, use\n-     *             {{@link #searchWithPayload(String, UriInfo, MultivaluedMap)} instead\n+     *             {@link #searchWithPayload(String, UriInfo, MultivaluedMap)} instead\n      */\n     @GET\n     @Path(\"{indices}/{types}/_search\")\n     @Consumes(MediaType.APPLICATION_FORM_URLENCODED)\n     @Produces(MediaType.APPLICATION_JSON)\n-    @Deprecated\n+    @Deprecated(since = \"11.4\", forRemoval = true)\n     public String searchWithPayload(@PathParam(\"indices\") String indices, @PathParam(\"types\") String types,\n             @Context UriInfo uriInf, MultivaluedMap<String, String> formParams) throws IOException, JSONException {\n         return doSearchWithPayload(indices, types, uriInf.getRequestUri().getRawQuery(),\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTk2MjU4OQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4452#discussion_r521962589", "bodyText": "why?", "author": "ataillefer", "createdAt": "2020-11-12T09:31:50Z", "path": "modules/platform/nuxeo-elasticsearch/nuxeo-elasticsearch-http-read-only/src/test/java/org/nuxeo/elasticsearch/http/readonly/TestRequestValidator.java", "diffHunk": "@@ -47,14 +47,18 @@ public void initValidator() {\n     }\n \n     @Test\n-    public void testCheckValidDocumentId() throws Exception {\n+    public void testCheckValidDocumentId() {\n         validator.checkValidDocumentId(\"123\");\n         exception.expect(IllegalArgumentException.class);\n         validator.checkValidDocumentId(null);\n     }\n \n+    /**\n+     * @since 11.4", "originalCommit": "341948787efc89622a1b66228ac74ffdda9a0add", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTk2NTcxMg==", "url": "https://github.com/nuxeo/nuxeo/pull/4452#discussion_r521965712", "bodyText": "My bad, it should be a @deprecated since 11.4.", "author": "kevinleturc", "createdAt": "2020-11-12T09:36:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTk2MjU4OQ=="}], "type": "inlineReview", "revised_code": {"commit": "f743dd435eb6f0e206cc9ac0979e361968d573f0", "chunk": "diff --git a/modules/platform/nuxeo-elasticsearch/nuxeo-elasticsearch-http-read-only/src/test/java/org/nuxeo/elasticsearch/http/readonly/TestRequestValidator.java b/modules/platform/nuxeo-elasticsearch/nuxeo-elasticsearch-http-read-only/src/test/java/org/nuxeo/elasticsearch/http/readonly/TestRequestValidator.java\nindex 54b9fe08a2e..f4d798cce17 100644\n--- a/modules/platform/nuxeo-elasticsearch/nuxeo-elasticsearch-http-read-only/src/test/java/org/nuxeo/elasticsearch/http/readonly/TestRequestValidator.java\n+++ b/modules/platform/nuxeo-elasticsearch/nuxeo-elasticsearch-http-read-only/src/test/java/org/nuxeo/elasticsearch/http/readonly/TestRequestValidator.java\n\n@@ -54,10 +54,10 @@ public class TestRequestValidator {\n     }\n \n     /**\n-     * @since 11.4\n+     * @deprecated since 11.4\n      */\n     @Test\n-    @Deprecated\n+    @Deprecated(since = \"11.4\", forRemoval = true)\n     public void testGetTypes() {\n         validator.getTypes(\"nxutest\", \"doc\");\n         validator.getTypes(\"nxutest\", \"doc,doc\");\n"}}, {"oid": "f743dd435eb6f0e206cc9ac0979e361968d573f0", "url": "https://github.com/nuxeo/nuxeo/commit/f743dd435eb6f0e206cc9ac0979e361968d573f0", "message": "NXP-29529: Remove Elasticsearch types from passpathrough", "committedDate": "2020-11-12T09:40:05Z", "type": "commit"}, {"oid": "f743dd435eb6f0e206cc9ac0979e361968d573f0", "url": "https://github.com/nuxeo/nuxeo/commit/f743dd435eb6f0e206cc9ac0979e361968d573f0", "message": "NXP-29529: Remove Elasticsearch types from passpathrough", "committedDate": "2020-11-12T09:40:05Z", "type": "forcePushed"}]}