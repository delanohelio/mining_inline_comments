{"pr_number": 3675, "pr_title": "Fix-NXP-28527-Fix-TestMongoDBIndices.shouldFailWhenCreatingExistingChildNameDocument", "pr_createdAt": "2020-01-17T12:32:57Z", "pr_url": "https://github.com/nuxeo/nuxeo/pull/3675", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzkyMzQ4MA==", "url": "https://github.com/nuxeo/nuxeo/pull/3675#discussion_r367923480", "bodyText": "This is too complex, we don't care about the detailed format of the human-readable message that MongoDB returns. Just check for presence of \"E11000 duplicate key error\" and the folder id, and avoid all this complexity (which looks way too much like white-box testing).", "author": "efge", "createdAt": "2020-01-17T13:00:16Z", "path": "nuxeo-core/nuxeo-core-mongodb/src/test/java/org/nuxeo/ecm/core/mongodb/TestMongoDBIndices.java", "diffHunk": "@@ -83,11 +84,13 @@ public void shouldFailWhenCreatingExistingChildNameDocument() {\n             fail(\"should throw a ConcurrentUpdateException\");\n         } catch (ConcurrentUpdateException cue) {\n             assertEquals(SC_CONFLICT, cue.getStatusCode());\n+            String mongoDBName = Framework.getProperties().getProperty(MONGODB_DBNAME_PROPERTY);\n             assertTrue(\n                     cue.getMessage()\n                        .contains(String.format(\n                                \"E11000 duplicate key error collection: %s.test index: ecm:parentId_1_ecm:name_1 dup key: { : \\\"%s\\\", : \\\"%s\\\" }\",\n-                               DEFAULT_MONGODB_DBNAME, folder.getId(), DOCUMENT_NAME)));\n+                               mongoDBName, folder.getId(), DOCUMENT_NAME)));\n+", "originalCommit": "2635f1ad7c3810adba803f3a620b831825e40fd5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzk1MTk1MA==", "url": "https://github.com/nuxeo/nuxeo/pull/3675#discussion_r367951950", "bodyText": "this is  what i did on the first dev, but i changed because most of times on our tests we check the whole message. but i will change  it to keep it more simple and readable :)", "author": "RSalem07", "createdAt": "2020-01-17T14:08:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzkyMzQ4MA=="}], "type": "inlineReview", "revised_code": {"commit": "8b1ce84c5e599875b866e8d0ae374816d32dccb3", "chunk": "diff --git a/nuxeo-core/nuxeo-core-mongodb/src/test/java/org/nuxeo/ecm/core/mongodb/TestMongoDBIndices.java b/nuxeo-core/nuxeo-core-mongodb/src/test/java/org/nuxeo/ecm/core/mongodb/TestMongoDBIndices.java\nindex 3c918b871bd..d588e7ede83 100644\n--- a/nuxeo-core/nuxeo-core-mongodb/src/test/java/org/nuxeo/ecm/core/mongodb/TestMongoDBIndices.java\n+++ b/nuxeo-core/nuxeo-core-mongodb/src/test/java/org/nuxeo/ecm/core/mongodb/TestMongoDBIndices.java\n\n@@ -84,13 +82,9 @@ public class TestMongoDBIndices {\n             fail(\"should throw a ConcurrentUpdateException\");\n         } catch (ConcurrentUpdateException cue) {\n             assertEquals(SC_CONFLICT, cue.getStatusCode());\n-            String mongoDBName = Framework.getProperties().getProperty(MONGODB_DBNAME_PROPERTY);\n-            assertTrue(\n-                    cue.getMessage()\n-                       .contains(String.format(\n-                               \"E11000 duplicate key error collection: %s.test index: ecm:parentId_1_ecm:name_1 dup key: { : \\\"%s\\\", : \\\"%s\\\" }\",\n-                               mongoDBName, folder.getId(), DOCUMENT_NAME)));\n-\n+            assertTrue(cue.getMessage().contains(\"E11000 duplicate key error collection\"));\n+            assertTrue(cue.getMessage().contains(String.format(\"%s\", DOCUMENT_NAME)));\n+            assertTrue(cue.getMessage().contains(String.format(\"%s\", folder.getId())));\n         }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzk0MTUyMw==", "url": "https://github.com/nuxeo/nuxeo/pull/3675#discussion_r367941523", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        String mongoDBName = Framework.getProperties().getProperty(MONGODB_DBNAME_PROPERTY);\n          \n          \n            \n                        String mongoDBName = Framework.getProperty(MONGODB_DBNAME_PROPERTY);\n          \n      \n    \n    \n  \n\nno?", "author": "ataillefer", "createdAt": "2020-01-17T13:45:16Z", "path": "nuxeo-core/nuxeo-core-mongodb/src/test/java/org/nuxeo/ecm/core/mongodb/TestMongoDBIndices.java", "diffHunk": "@@ -83,11 +84,13 @@ public void shouldFailWhenCreatingExistingChildNameDocument() {\n             fail(\"should throw a ConcurrentUpdateException\");\n         } catch (ConcurrentUpdateException cue) {\n             assertEquals(SC_CONFLICT, cue.getStatusCode());\n+            String mongoDBName = Framework.getProperties().getProperty(MONGODB_DBNAME_PROPERTY);", "originalCommit": "2635f1ad7c3810adba803f3a620b831825e40fd5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzk1MTI4NQ==", "url": "https://github.com/nuxeo/nuxeo/pull/3675#discussion_r367951285", "bodyText": "yep i just copied/past the code that was on MongoDBFeature", "author": "RSalem07", "createdAt": "2020-01-17T14:06:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzk0MTUyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzk1NjUwNg==", "url": "https://github.com/nuxeo/nuxeo/pull/3675#discussion_r367956506", "bodyText": "to keep the things simple/more readable i took #3675 (comment) into account which removes the dependency to Framework.getProp...", "author": "RSalem07", "createdAt": "2020-01-17T14:17:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzk0MTUyMw=="}], "type": "inlineReview", "revised_code": {"commit": "8b1ce84c5e599875b866e8d0ae374816d32dccb3", "chunk": "diff --git a/nuxeo-core/nuxeo-core-mongodb/src/test/java/org/nuxeo/ecm/core/mongodb/TestMongoDBIndices.java b/nuxeo-core/nuxeo-core-mongodb/src/test/java/org/nuxeo/ecm/core/mongodb/TestMongoDBIndices.java\nindex 3c918b871bd..d588e7ede83 100644\n--- a/nuxeo-core/nuxeo-core-mongodb/src/test/java/org/nuxeo/ecm/core/mongodb/TestMongoDBIndices.java\n+++ b/nuxeo-core/nuxeo-core-mongodb/src/test/java/org/nuxeo/ecm/core/mongodb/TestMongoDBIndices.java\n\n@@ -84,13 +82,9 @@ public class TestMongoDBIndices {\n             fail(\"should throw a ConcurrentUpdateException\");\n         } catch (ConcurrentUpdateException cue) {\n             assertEquals(SC_CONFLICT, cue.getStatusCode());\n-            String mongoDBName = Framework.getProperties().getProperty(MONGODB_DBNAME_PROPERTY);\n-            assertTrue(\n-                    cue.getMessage()\n-                       .contains(String.format(\n-                               \"E11000 duplicate key error collection: %s.test index: ecm:parentId_1_ecm:name_1 dup key: { : \\\"%s\\\", : \\\"%s\\\" }\",\n-                               mongoDBName, folder.getId(), DOCUMENT_NAME)));\n-\n+            assertTrue(cue.getMessage().contains(\"E11000 duplicate key error collection\"));\n+            assertTrue(cue.getMessage().contains(String.format(\"%s\", DOCUMENT_NAME)));\n+            assertTrue(cue.getMessage().contains(String.format(\"%s\", folder.getId())));\n         }\n     }\n \n"}}, {"oid": "8b1ce84c5e599875b866e8d0ae374816d32dccb3", "url": "https://github.com/nuxeo/nuxeo/commit/8b1ce84c5e599875b866e8d0ae374816d32dccb3", "message": "NXP-28527: Fix TestMongoDBIndices.shouldFailWhenCreatingExistingChildNameDocument", "committedDate": "2020-01-17T14:16:09Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzk1NzQxNg==", "url": "https://github.com/nuxeo/nuxeo/pull/3675#discussion_r367957416", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        assertTrue(cue.getMessage().contains(String.format(\"%s\", DOCUMENT_NAME)));\n          \n          \n            \n                        assertTrue(cue.getMessage().contains(DOCUMENT_NAME));", "author": "ataillefer", "createdAt": "2020-01-17T14:19:13Z", "path": "nuxeo-core/nuxeo-core-mongodb/src/test/java/org/nuxeo/ecm/core/mongodb/TestMongoDBIndices.java", "diffHunk": "@@ -83,11 +82,9 @@ public void shouldFailWhenCreatingExistingChildNameDocument() {\n             fail(\"should throw a ConcurrentUpdateException\");\n         } catch (ConcurrentUpdateException cue) {\n             assertEquals(SC_CONFLICT, cue.getStatusCode());\n-            assertTrue(\n-                    cue.getMessage()\n-                       .contains(String.format(\n-                               \"E11000 duplicate key error collection: %s.test index: ecm:parentId_1_ecm:name_1 dup key: { : \\\"%s\\\", : \\\"%s\\\" }\",\n-                               DEFAULT_MONGODB_DBNAME, folder.getId(), DOCUMENT_NAME)));\n+            assertTrue(cue.getMessage().contains(\"E11000 duplicate key error collection\"));\n+            assertTrue(cue.getMessage().contains(String.format(\"%s\", DOCUMENT_NAME)));", "originalCommit": "8b1ce84c5e599875b866e8d0ae374816d32dccb3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "137540b70c4968a65fd55f8eb1ed8c57959a6707", "chunk": "diff --git a/nuxeo-core/nuxeo-core-mongodb/src/test/java/org/nuxeo/ecm/core/mongodb/TestMongoDBIndices.java b/nuxeo-core/nuxeo-core-mongodb/src/test/java/org/nuxeo/ecm/core/mongodb/TestMongoDBIndices.java\nindex d588e7ede83..527dd3b5af2 100644\n--- a/nuxeo-core/nuxeo-core-mongodb/src/test/java/org/nuxeo/ecm/core/mongodb/TestMongoDBIndices.java\n+++ b/nuxeo-core/nuxeo-core-mongodb/src/test/java/org/nuxeo/ecm/core/mongodb/TestMongoDBIndices.java\n\n@@ -82,9 +82,10 @@ public class TestMongoDBIndices {\n             fail(\"should throw a ConcurrentUpdateException\");\n         } catch (ConcurrentUpdateException cue) {\n             assertEquals(SC_CONFLICT, cue.getStatusCode());\n-            assertTrue(cue.getMessage().contains(\"E11000 duplicate key error collection\"));\n-            assertTrue(cue.getMessage().contains(String.format(\"%s\", DOCUMENT_NAME)));\n-            assertTrue(cue.getMessage().contains(String.format(\"%s\", folder.getId())));\n+            String message = cue.getMessage();\n+            assertTrue(message.contains(\"E11000 duplicate key error collection\"));\n+            assertTrue(message.contains(DOCUMENT_NAME));\n+            assertTrue(message.contains(folder.getId()));\n         }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzk1Njg5OA==", "url": "https://github.com/nuxeo/nuxeo/pull/3675#discussion_r367956898", "bodyText": "Just contains(DOCUMENT_NAME) and contains(folder.getId())\nAlso you could put cue.getMessage() in a local variable.", "author": "efge", "createdAt": "2020-01-17T14:18:19Z", "path": "nuxeo-core/nuxeo-core-mongodb/src/test/java/org/nuxeo/ecm/core/mongodb/TestMongoDBIndices.java", "diffHunk": "@@ -83,11 +82,9 @@ public void shouldFailWhenCreatingExistingChildNameDocument() {\n             fail(\"should throw a ConcurrentUpdateException\");\n         } catch (ConcurrentUpdateException cue) {\n             assertEquals(SC_CONFLICT, cue.getStatusCode());\n-            assertTrue(\n-                    cue.getMessage()\n-                       .contains(String.format(\n-                               \"E11000 duplicate key error collection: %s.test index: ecm:parentId_1_ecm:name_1 dup key: { : \\\"%s\\\", : \\\"%s\\\" }\",\n-                               DEFAULT_MONGODB_DBNAME, folder.getId(), DOCUMENT_NAME)));\n+            assertTrue(cue.getMessage().contains(\"E11000 duplicate key error collection\"));\n+            assertTrue(cue.getMessage().contains(String.format(\"%s\", DOCUMENT_NAME)));\n+            assertTrue(cue.getMessage().contains(String.format(\"%s\", folder.getId())));", "originalCommit": "8b1ce84c5e599875b866e8d0ae374816d32dccb3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzk1ODU5OQ==", "url": "https://github.com/nuxeo/nuxeo/pull/3675#discussion_r367958599", "bodyText": "sorry i didn't know why i did it with String.format :(", "author": "RSalem07", "createdAt": "2020-01-17T14:21:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzk1Njg5OA=="}], "type": "inlineReview", "revised_code": {"commit": "137540b70c4968a65fd55f8eb1ed8c57959a6707", "chunk": "diff --git a/nuxeo-core/nuxeo-core-mongodb/src/test/java/org/nuxeo/ecm/core/mongodb/TestMongoDBIndices.java b/nuxeo-core/nuxeo-core-mongodb/src/test/java/org/nuxeo/ecm/core/mongodb/TestMongoDBIndices.java\nindex d588e7ede83..527dd3b5af2 100644\n--- a/nuxeo-core/nuxeo-core-mongodb/src/test/java/org/nuxeo/ecm/core/mongodb/TestMongoDBIndices.java\n+++ b/nuxeo-core/nuxeo-core-mongodb/src/test/java/org/nuxeo/ecm/core/mongodb/TestMongoDBIndices.java\n\n@@ -82,9 +82,10 @@ public class TestMongoDBIndices {\n             fail(\"should throw a ConcurrentUpdateException\");\n         } catch (ConcurrentUpdateException cue) {\n             assertEquals(SC_CONFLICT, cue.getStatusCode());\n-            assertTrue(cue.getMessage().contains(\"E11000 duplicate key error collection\"));\n-            assertTrue(cue.getMessage().contains(String.format(\"%s\", DOCUMENT_NAME)));\n-            assertTrue(cue.getMessage().contains(String.format(\"%s\", folder.getId())));\n+            String message = cue.getMessage();\n+            assertTrue(message.contains(\"E11000 duplicate key error collection\"));\n+            assertTrue(message.contains(DOCUMENT_NAME));\n+            assertTrue(message.contains(folder.getId()));\n         }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzk1NzU1Nw==", "url": "https://github.com/nuxeo/nuxeo/pull/3675#discussion_r367957557", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        assertTrue(cue.getMessage().contains(String.format(\"%s\", folder.getId())));\n          \n          \n            \n                        assertTrue(cue.getMessage().contains(folder.getId()));", "author": "ataillefer", "createdAt": "2020-01-17T14:19:32Z", "path": "nuxeo-core/nuxeo-core-mongodb/src/test/java/org/nuxeo/ecm/core/mongodb/TestMongoDBIndices.java", "diffHunk": "@@ -83,11 +82,9 @@ public void shouldFailWhenCreatingExistingChildNameDocument() {\n             fail(\"should throw a ConcurrentUpdateException\");\n         } catch (ConcurrentUpdateException cue) {\n             assertEquals(SC_CONFLICT, cue.getStatusCode());\n-            assertTrue(\n-                    cue.getMessage()\n-                       .contains(String.format(\n-                               \"E11000 duplicate key error collection: %s.test index: ecm:parentId_1_ecm:name_1 dup key: { : \\\"%s\\\", : \\\"%s\\\" }\",\n-                               DEFAULT_MONGODB_DBNAME, folder.getId(), DOCUMENT_NAME)));\n+            assertTrue(cue.getMessage().contains(\"E11000 duplicate key error collection\"));\n+            assertTrue(cue.getMessage().contains(String.format(\"%s\", DOCUMENT_NAME)));\n+            assertTrue(cue.getMessage().contains(String.format(\"%s\", folder.getId())));", "originalCommit": "8b1ce84c5e599875b866e8d0ae374816d32dccb3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "137540b70c4968a65fd55f8eb1ed8c57959a6707", "chunk": "diff --git a/nuxeo-core/nuxeo-core-mongodb/src/test/java/org/nuxeo/ecm/core/mongodb/TestMongoDBIndices.java b/nuxeo-core/nuxeo-core-mongodb/src/test/java/org/nuxeo/ecm/core/mongodb/TestMongoDBIndices.java\nindex d588e7ede83..527dd3b5af2 100644\n--- a/nuxeo-core/nuxeo-core-mongodb/src/test/java/org/nuxeo/ecm/core/mongodb/TestMongoDBIndices.java\n+++ b/nuxeo-core/nuxeo-core-mongodb/src/test/java/org/nuxeo/ecm/core/mongodb/TestMongoDBIndices.java\n\n@@ -82,9 +82,10 @@ public class TestMongoDBIndices {\n             fail(\"should throw a ConcurrentUpdateException\");\n         } catch (ConcurrentUpdateException cue) {\n             assertEquals(SC_CONFLICT, cue.getStatusCode());\n-            assertTrue(cue.getMessage().contains(\"E11000 duplicate key error collection\"));\n-            assertTrue(cue.getMessage().contains(String.format(\"%s\", DOCUMENT_NAME)));\n-            assertTrue(cue.getMessage().contains(String.format(\"%s\", folder.getId())));\n+            String message = cue.getMessage();\n+            assertTrue(message.contains(\"E11000 duplicate key error collection\"));\n+            assertTrue(message.contains(DOCUMENT_NAME));\n+            assertTrue(message.contains(folder.getId()));\n         }\n     }\n \n"}}, {"oid": "137540b70c4968a65fd55f8eb1ed8c57959a6707", "url": "https://github.com/nuxeo/nuxeo/commit/137540b70c4968a65fd55f8eb1ed8c57959a6707", "message": "NXP-28527: Fix TestMongoDBIndices.shouldFailWhenCreatingExistingChildNameDocument", "committedDate": "2020-01-17T14:21:56Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzk2NzQzMg==", "url": "https://github.com/nuxeo/nuxeo/pull/3675#discussion_r367967432", "bodyText": "Sorry, one last change: please put message as the first argument to assertTrue, so that if there's a mismatch we have the full message in the logs.\nassertTrue(message, message.contains(\"E11000 duplicate key error collection\"));\nassertTrue(message, message.contains(DOCUMENT_NAME));\nassertTrue(message, message.contains(folder.getId()));", "author": "efge", "createdAt": "2020-01-17T14:39:02Z", "path": "nuxeo-core/nuxeo-core-mongodb/src/test/java/org/nuxeo/ecm/core/mongodb/TestMongoDBIndices.java", "diffHunk": "@@ -83,11 +82,10 @@ public void shouldFailWhenCreatingExistingChildNameDocument() {\n             fail(\"should throw a ConcurrentUpdateException\");\n         } catch (ConcurrentUpdateException cue) {\n             assertEquals(SC_CONFLICT, cue.getStatusCode());\n-            assertTrue(\n-                    cue.getMessage()\n-                       .contains(String.format(\n-                               \"E11000 duplicate key error collection: %s.test index: ecm:parentId_1_ecm:name_1 dup key: { : \\\"%s\\\", : \\\"%s\\\" }\",\n-                               DEFAULT_MONGODB_DBNAME, folder.getId(), DOCUMENT_NAME)));\n+            String message = cue.getMessage();\n+            assertTrue(message.contains(\"E11000 duplicate key error collection\"));\n+            assertTrue(message.contains(DOCUMENT_NAME));\n+            assertTrue(message.contains(folder.getId()));", "originalCommit": "137540b70c4968a65fd55f8eb1ed8c57959a6707", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1bd45d1e49dd49b22188de0b52b7b523c41c8d06", "chunk": "diff --git a/nuxeo-core/nuxeo-core-mongodb/src/test/java/org/nuxeo/ecm/core/mongodb/TestMongoDBIndices.java b/nuxeo-core/nuxeo-core-mongodb/src/test/java/org/nuxeo/ecm/core/mongodb/TestMongoDBIndices.java\nindex 527dd3b5af2..30238d5889f 100644\n--- a/nuxeo-core/nuxeo-core-mongodb/src/test/java/org/nuxeo/ecm/core/mongodb/TestMongoDBIndices.java\n+++ b/nuxeo-core/nuxeo-core-mongodb/src/test/java/org/nuxeo/ecm/core/mongodb/TestMongoDBIndices.java\n\n@@ -83,9 +83,9 @@ public class TestMongoDBIndices {\n         } catch (ConcurrentUpdateException cue) {\n             assertEquals(SC_CONFLICT, cue.getStatusCode());\n             String message = cue.getMessage();\n-            assertTrue(message.contains(\"E11000 duplicate key error collection\"));\n-            assertTrue(message.contains(DOCUMENT_NAME));\n-            assertTrue(message.contains(folder.getId()));\n+            assertTrue(message, message.contains(\"E11000 duplicate key error collection\"));\n+            assertTrue(message, message.contains(DOCUMENT_NAME));\n+            assertTrue(message, message.contains(folder.getId()));\n         }\n     }\n \n"}}, {"oid": "1bd45d1e49dd49b22188de0b52b7b523c41c8d06", "url": "https://github.com/nuxeo/nuxeo/commit/1bd45d1e49dd49b22188de0b52b7b523c41c8d06", "message": "NXP-28527: Fix TestMongoDBIndices.shouldFailWhenCreatingExistingChildNameDocument", "committedDate": "2020-01-17T14:43:33Z", "type": "commit"}, {"oid": "1bd45d1e49dd49b22188de0b52b7b523c41c8d06", "url": "https://github.com/nuxeo/nuxeo/commit/1bd45d1e49dd49b22188de0b52b7b523c41c8d06", "message": "NXP-28527: Fix TestMongoDBIndices.shouldFailWhenCreatingExistingChildNameDocument", "committedDate": "2020-01-17T14:43:33Z", "type": "forcePushed"}]}