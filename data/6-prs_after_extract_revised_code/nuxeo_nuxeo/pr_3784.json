{"pr_number": 3784, "pr_title": "NXP-26690: transactional DBS", "pr_createdAt": "2020-02-25T13:53:36Z", "pr_url": "https://github.com/nuxeo/nuxeo/pull/3784", "timeline": [{"oid": "abcb2681ec82809adbf3f438f34dbf7d5de621b2", "url": "https://github.com/nuxeo/nuxeo/commit/abcb2681ec82809adbf3f438f34dbf7d5de621b2", "message": "NXP-26690: transactional DBS (WIP)", "committedDate": "2020-03-17T21:39:53Z", "type": "forcePushed"}, {"oid": "a57e1b8b7e8f5b4a1bd187977788b02cdb8ffd08", "url": "https://github.com/nuxeo/nuxeo/commit/a57e1b8b7e8f5b4a1bd187977788b02cdb8ffd08", "message": "NXP-26690: transactional DBS", "committedDate": "2020-03-23T18:48:10Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY5NTE1NQ==", "url": "https://github.com/nuxeo/nuxeo/pull/3784#discussion_r396695155", "bodyText": "Can we make DBSTransactionState a Closeable?", "author": "kevinleturc", "createdAt": "2020-03-23T19:14:58Z", "path": "nuxeo-core/nuxeo-core-storage-dbs/src/main/java/org/nuxeo/ecm/core/storage/dbs/DBSTransactionState.java", "diffHunk": "@@ -151,13 +161,24 @@\n \n     protected final Set<String> browsePermissions;\n \n-    public DBSTransactionState(DBSRepository repository, DBSSession session) {\n+    public DBSTransactionState(DBSRepository repository, DBSConnection connection, DBSSession session) {\n         this.repository = repository;\n+        this.connection = connection;\n         this.session = session;\n         SecurityService securityService = Framework.getService(SecurityService.class);\n         browsePermissions = new HashSet<>(Arrays.asList(securityService.getPermissionsToCheck(BROWSE)));\n     }\n \n+    /** @since 11.1 */\n+    public void close() {\n+        connection.close();\n+    }", "originalCommit": "a57e1b8b7e8f5b4a1bd187977788b02cdb8ffd08", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA1NTQ0Mg==", "url": "https://github.com/nuxeo/nuxeo/pull/3784#discussion_r397055442", "bodyText": "Yes I don't think it's a problem.", "author": "efge", "createdAt": "2020-03-24T10:41:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY5NTE1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzI3MTU3OA==", "url": "https://github.com/nuxeo/nuxeo/pull/3784#discussion_r397271578", "bodyText": "Autocloseable actually has this really has nothing to do with java.io", "author": "efge", "createdAt": "2020-03-24T16:04:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY5NTE1NQ=="}], "type": "inlineReview", "revised_code": {"commit": "3f9cb9edd49afd50f5f4217e396aa8681fed27f7", "chunk": "diff --git a/nuxeo-core/nuxeo-core-storage-dbs/src/main/java/org/nuxeo/ecm/core/storage/dbs/DBSTransactionState.java b/nuxeo-core/nuxeo-core-storage-dbs/src/main/java/org/nuxeo/ecm/core/storage/dbs/DBSTransactionState.java\nindex 5af4763bb06..82462ef4780 100644\n--- a/nuxeo-core/nuxeo-core-storage-dbs/src/main/java/org/nuxeo/ecm/core/storage/dbs/DBSTransactionState.java\n+++ b/nuxeo-core/nuxeo-core-storage-dbs/src/main/java/org/nuxeo/ecm/core/storage/dbs/DBSTransactionState.java\n\n@@ -161,24 +151,13 @@ public class DBSTransactionState implements LockManager {\n \n     protected final Set<String> browsePermissions;\n \n-    public DBSTransactionState(DBSRepository repository, DBSConnection connection, DBSSession session) {\n+    public DBSTransactionState(DBSRepository repository, DBSSession session) {\n         this.repository = repository;\n-        this.connection = connection;\n         this.session = session;\n         SecurityService securityService = Framework.getService(SecurityService.class);\n         browsePermissions = new HashSet<>(Arrays.asList(securityService.getPermissionsToCheck(BROWSE)));\n     }\n \n-    /** @since 11.1 */\n-    public void close() {\n-        connection.close();\n-    }\n-\n-    /** @since 11.1 */\n-    public String getRootId() {\n-        return connection.getRootId();\n-    }\n-\n     /**\n      * New transient state for something just read from the repository.\n      */\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjcwMTUzMg==", "url": "https://github.com/nuxeo/nuxeo/pull/3784#discussion_r396701532", "bodyText": "I didn't find any other instantiation of DBSTransactionState which makes me think we don't need to change the DBSTransactionState constructor and just do the getConnection into it, wdy?", "author": "kevinleturc", "createdAt": "2020-03-23T19:26:29Z", "path": "nuxeo-core/nuxeo-core-storage-dbs/src/main/java/org/nuxeo/ecm/core/storage/dbs/DBSSession.java", "diffHunk": "@@ -192,7 +192,9 @@\n \n     public DBSSession(DBSRepository repository) {\n         this.repository = repository;\n-        transaction = new DBSTransactionState(repository, this);\n+        @SuppressWarnings(\"resource\") // connection closed by DBSTransactionState.close\n+        DBSConnection connection = repository.getConnection();\n+        transaction = new DBSTransactionState(repository, connection, this);", "originalCommit": "a57e1b8b7e8f5b4a1bd187977788b02cdb8ffd08", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA1NDA1MA==", "url": "https://github.com/nuxeo/nuxeo/pull/3784#discussion_r397054050", "bodyText": "Yes I'll do that", "author": "efge", "createdAt": "2020-03-24T10:38:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjcwMTUzMg=="}], "type": "inlineReview", "revised_code": {"commit": "3f9cb9edd49afd50f5f4217e396aa8681fed27f7", "chunk": "diff --git a/nuxeo-core/nuxeo-core-storage-dbs/src/main/java/org/nuxeo/ecm/core/storage/dbs/DBSSession.java b/nuxeo-core/nuxeo-core-storage-dbs/src/main/java/org/nuxeo/ecm/core/storage/dbs/DBSSession.java\nindex ee6390d5126..8677f8f4271 100644\n--- a/nuxeo-core/nuxeo-core-storage-dbs/src/main/java/org/nuxeo/ecm/core/storage/dbs/DBSSession.java\n+++ b/nuxeo-core/nuxeo-core-storage-dbs/src/main/java/org/nuxeo/ecm/core/storage/dbs/DBSSession.java\n\n@@ -192,9 +192,7 @@ public class DBSSession implements Session<QueryFilter> {\n \n     public DBSSession(DBSRepository repository) {\n         this.repository = repository;\n-        @SuppressWarnings(\"resource\") // connection closed by DBSTransactionState.close\n-        DBSConnection connection = repository.getConnection();\n-        transaction = new DBSTransactionState(repository, connection, this);\n+        transaction = new DBSTransactionState(repository, this);\n         FulltextConfiguration fulltextConfiguration = repository.getFulltextConfiguration();\n         fulltextSearchDisabled = fulltextConfiguration == null || fulltextConfiguration.fulltextSearchDisabled;\n         changeTokenEnabled = repository.isChangeTokenEnabled();\n"}}, {"oid": "3f9cb9edd49afd50f5f4217e396aa8681fed27f7", "url": "https://github.com/nuxeo/nuxeo/commit/3f9cb9edd49afd50f5f4217e396aa8681fed27f7", "message": "NXP-26690: simplify LockManager code", "committedDate": "2020-03-24T15:56:43Z", "type": "commit"}, {"oid": "6a08ba44557df75e904fa632ebadb4ad560a8dab", "url": "https://github.com/nuxeo/nuxeo/commit/6a08ba44557df75e904fa632ebadb4ad560a8dab", "message": "NXP-26690: factor out VCS and DBS invalidators classes", "committedDate": "2020-03-24T15:56:43Z", "type": "commit"}, {"oid": "10ca36d2a9b7944f2a8866b765fde8a5404ecb3d", "url": "https://github.com/nuxeo/nuxeo/commit/10ca36d2a9b7944f2a8866b765fde8a5404ecb3d", "message": "NXP-26690: copy code before separating repository and connection APIs", "committedDate": "2020-03-24T15:56:43Z", "type": "commit"}, {"oid": "b024ecadbc3c46662634bcc84bb1703ae59e896f", "url": "https://github.com/nuxeo/nuxeo/commit/b024ecadbc3c46662634bcc84bb1703ae59e896f", "message": "NXP-26690: transactional DBS", "committedDate": "2020-03-24T16:02:30Z", "type": "commit"}, {"oid": "b024ecadbc3c46662634bcc84bb1703ae59e896f", "url": "https://github.com/nuxeo/nuxeo/commit/b024ecadbc3c46662634bcc84bb1703ae59e896f", "message": "NXP-26690: transactional DBS", "committedDate": "2020-03-24T16:02:30Z", "type": "forcePushed"}]}