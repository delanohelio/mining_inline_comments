{"pr_number": 4318, "pr_title": "NXP-29652: Use an Elasticsearch cluster for Elasticsearch unit tests", "pr_createdAt": "2020-09-14T20:21:19Z", "pr_url": "https://github.com/nuxeo/nuxeo/pull/4318", "timeline": [{"oid": "5666e8a74070ec7f4038f3898e3a5fdd60431fc3", "url": "https://github.com/nuxeo/nuxeo/commit/5666e8a74070ec7f4038f3898e3a5fdd60431fc3", "message": "NXP-29652: Use an Elasticsearch cluster for Elasticsearch unit tests\n\nWhen run in the PostgreSQL/MongoDB environments.", "committedDate": "2020-09-15T15:15:04Z", "type": "forcePushed"}, {"oid": "cc63dc892b64adab1f16392068de379e6ed42e95", "url": "https://github.com/nuxeo/nuxeo/commit/cc63dc892b64adab1f16392068de379e6ed42e95", "message": "NXP-29652: Use an Elasticsearch cluster for Elasticsearch unit tests\n\nWhen run in the PostgreSQL/MongoDB environments.", "committedDate": "2020-09-15T22:13:37Z", "type": "forcePushed"}, {"oid": "90c65117cba02b5810c1ae938b7a3ffa9b44b28c", "url": "https://github.com/nuxeo/nuxeo/commit/90c65117cba02b5810c1ae938b7a3ffa9b44b28c", "message": "NXP-29652: Fix some SonarQube issues", "committedDate": "2020-09-16T08:59:06Z", "type": "commit"}, {"oid": "5a55f88d83b1b45b79646acfd1d475635c701d6b", "url": "https://github.com/nuxeo/nuxeo/commit/5a55f88d83b1b45b79646acfd1d475635c701d6b", "message": "NXP-29652: Use an Elasticsearch cluster for Elasticsearch unit tests\n\nWhen run in the PostgreSQL/MongoDB environments.", "committedDate": "2020-09-16T08:59:34Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQ5OTkyMw==", "url": "https://github.com/nuxeo/nuxeo/pull/4318#discussion_r489499923", "bodyText": "What's the point of keeping commented code/test here? It will be never executed/run.", "author": "troger", "createdAt": "2020-09-16T14:51:18Z", "path": "modules/platform/nuxeo-elasticsearch/nuxeo-elasticsearch-core/src/test/java/org/nuxeo/elasticsearch/test/TestMapping.java", "diffHunk": "@@ -128,8 +128,13 @@ public void testIlikeSearch() throws Exception {\n         Assert.assertEquals(0, ret.totalSize());\n         ret = ess.query(new NxQueryBuilder(session).nxql(\"SELECT * FROM Document WHERE dc:description LIKE 'Upper%'\"));\n         Assert.assertEquals(0, ret.totalSize());\n-        ret = ess.query(new NxQueryBuilder(session).nxql(\"SELECT * FROM Document WHERE dc:description LIKE 'UPPER%'\"));\n-        Assert.assertEquals(0, ret.totalSize());\n+        // match_phrase_prefix query against a keyword field behaves differently depending on the Elasticsearch version\n+        // prior to 6.7.0, it doesn't match\n+        // since 6.7.0, it matches, yet we're not sure if it is really expected\n+        // since 7, it raises an exception\n+        // ret = ess.query(new NxQueryBuilder(session).nxql(\"SELECT * FROM Document WHERE dc:description LIKE\n+        // 'UPPER%'\"));\n+        // Assert.assertEquals(0, ret.totalSize());", "originalCommit": "5a55f88d83b1b45b79646acfd1d475635c701d6b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTUwNTQ0Nw==", "url": "https://github.com/nuxeo/nuxeo/pull/4318#discussion_r489505447", "bodyText": "It's to illustrate this interesting mapping edge case and make it easily testable against an ES cluster of the right version.\n@bdelbosc WDYT?", "author": "ataillefer", "createdAt": "2020-09-16T14:58:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQ5OTkyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDA3Njk1Mw==", "url": "https://github.com/nuxeo/nuxeo/pull/4318#discussion_r490076953", "bodyText": "we don't mind, this is a temporary code until the es7 upgrade is merged", "author": "bdelbosc", "createdAt": "2020-09-17T08:47:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQ5OTkyMw=="}], "type": "inlineReview", "revised_code": {"commit": "3686c018af5077e1384f5efacd8094000dc2e062", "chunk": "diff --git a/modules/platform/nuxeo-elasticsearch/nuxeo-elasticsearch-core/src/test/java/org/nuxeo/elasticsearch/test/TestMapping.java b/modules/platform/nuxeo-elasticsearch/nuxeo-elasticsearch-core/src/test/java/org/nuxeo/elasticsearch/test/TestMapping.java\nindex c885741ffca..797101554dd 100644\n--- a/modules/platform/nuxeo-elasticsearch/nuxeo-elasticsearch-core/src/test/java/org/nuxeo/elasticsearch/test/TestMapping.java\n+++ b/modules/platform/nuxeo-elasticsearch/nuxeo-elasticsearch-core/src/test/java/org/nuxeo/elasticsearch/test/TestMapping.java\n\n@@ -128,13 +128,6 @@ public class TestMapping {\n         Assert.assertEquals(0, ret.totalSize());\n         ret = ess.query(new NxQueryBuilder(session).nxql(\"SELECT * FROM Document WHERE dc:description LIKE 'Upper%'\"));\n         Assert.assertEquals(0, ret.totalSize());\n-        // match_phrase_prefix query against a keyword field behaves differently depending on the Elasticsearch version\n-        // prior to 6.7.0, it doesn't match\n-        // since 6.7.0, it matches, yet we're not sure if it is really expected\n-        // since 7, it raises an exception\n-        // ret = ess.query(new NxQueryBuilder(session).nxql(\"SELECT * FROM Document WHERE dc:description LIKE\n-        // 'UPPER%'\"));\n-        // Assert.assertEquals(0, ret.totalSize());\n \n         ret = ess.query(new NxQueryBuilder(session).nxql(\n                 \"SELECT * FROM Document WHERE ecm:fulltext.dc:description LIKE '%Case%'\"));\n"}}, {"oid": "3686c018af5077e1384f5efacd8094000dc2e062", "url": "https://github.com/nuxeo/nuxeo/commit/3686c018af5077e1384f5efacd8094000dc2e062", "message": "NXP-29652: Use an Elasticsearch cluster for Elasticsearch unit tests\n\nWhen run in the PostgreSQL/MongoDB environments.", "committedDate": "2020-09-17T08:55:27Z", "type": "forcePushed"}, {"oid": "ff23bdbb37e8df5b8ed2781959cae25552e1a27a", "url": "https://github.com/nuxeo/nuxeo/commit/ff23bdbb37e8df5b8ed2781959cae25552e1a27a", "message": "NXP-29652: Use an Elasticsearch cluster for Elasticsearch unit tests\n\nWhen run in the PostgreSQL/MongoDB environments.\nNote that we've removed an assertion from TestMapping#testIlikeSearch since a match_phrase_prefix query against a keyword field behaves differently depending on the Elasticsearch version:\n- prior to 6.7.0, it doesn't match\n- since 6.7.0, it matches, yet we're not sure if it is really expected\n- since 7, it raises an exception", "committedDate": "2020-09-17T09:17:08Z", "type": "commit"}, {"oid": "ff23bdbb37e8df5b8ed2781959cae25552e1a27a", "url": "https://github.com/nuxeo/nuxeo/commit/ff23bdbb37e8df5b8ed2781959cae25552e1a27a", "message": "NXP-29652: Use an Elasticsearch cluster for Elasticsearch unit tests\n\nWhen run in the PostgreSQL/MongoDB environments.\nNote that we've removed an assertion from TestMapping#testIlikeSearch since a match_phrase_prefix query against a keyword field behaves differently depending on the Elasticsearch version:\n- prior to 6.7.0, it doesn't match\n- since 6.7.0, it matches, yet we're not sure if it is really expected\n- since 7, it raises an exception", "committedDate": "2020-09-17T09:17:08Z", "type": "forcePushed"}]}