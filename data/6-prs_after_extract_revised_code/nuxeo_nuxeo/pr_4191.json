{"pr_number": 4191, "pr_title": "fix-NXP-29325-blob-preview", "pr_createdAt": "2020-06-30T13:19:21Z", "pr_url": "https://github.com/nuxeo/nuxeo/pull/4191", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzcyMTY1NQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4191#discussion_r447721655", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * Enrich {@link Blob} json with embed preview link when available.\n          \n          \n            \n             * Enriches {@link Blob} json with embed preview link when available.", "author": "troger", "createdAt": "2020-06-30T14:21:06Z", "path": "modules/platform/nuxeo-preview-core/src/main/java/org/nuxeo/ecm/platform/preview/io/BlobPreviewJsonEnricher.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Nelson Silva <nsilva@nuxeo.com>\n+ */\n+\n+package org.nuxeo.ecm.platform.preview.io;\n+\n+import static org.nuxeo.ecm.core.io.registry.reflect.Instantiations.SINGLETON;\n+import static org.nuxeo.ecm.core.io.registry.reflect.Priorities.REFERENCE;\n+\n+import java.io.IOException;\n+import java.net.URI;\n+\n+import org.nuxeo.ecm.core.api.Blob;\n+import org.nuxeo.ecm.core.api.model.impl.primitives.BlobProperty;\n+import org.nuxeo.ecm.core.blob.BlobManager;\n+import org.nuxeo.ecm.core.blob.ManagedBlob;\n+import org.nuxeo.ecm.core.io.marshallers.json.enrichers.AbstractJsonEnricher;\n+import org.nuxeo.ecm.core.io.registry.reflect.Setup;\n+import org.nuxeo.runtime.api.Framework;\n+\n+import com.fasterxml.jackson.core.JsonGenerator;\n+\n+/**\n+ * Enrich {@link Blob} json with embed preview link when available.", "originalCommit": "b982ee55aa03de01db1b1dd54a7de9a8f9cc81f3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "4e47bc78891c4b50af48352dfbfdfe9c08dcdf42", "chunk": "diff --git a/modules/platform/nuxeo-preview-core/src/main/java/org/nuxeo/ecm/platform/preview/io/BlobPreviewJsonEnricher.java b/modules/platform/nuxeo-preview-core/src/main/java/org/nuxeo/ecm/platform/preview/io/BlobPreviewJsonEnricher.java\nindex 33df1dd4211..100d29eb57a 100644\n--- a/modules/platform/nuxeo-preview-core/src/main/java/org/nuxeo/ecm/platform/preview/io/BlobPreviewJsonEnricher.java\n+++ b/modules/platform/nuxeo-preview-core/src/main/java/org/nuxeo/ecm/platform/preview/io/BlobPreviewJsonEnricher.java\n\n@@ -36,7 +36,7 @@ import org.nuxeo.runtime.api.Framework;\n import com.fasterxml.jackson.core.JsonGenerator;\n \n /**\n- * Enrich {@link Blob} json with embed preview link when available.\n+ * Enriches {@link Blob} json with embed preview link when available.\n  * <p>\n  * Enabled when parameter enrichers-blob=preview is present.\n  * <p>\n"}}, {"oid": "4e47bc78891c4b50af48352dfbfdfe9c08dcdf42", "url": "https://github.com/nuxeo/nuxeo/commit/4e47bc78891c4b50af48352dfbfdfe9c08dcdf42", "message": "NXP-29325: add managed blob preview enricher", "committedDate": "2020-06-30T16:40:40Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg0NzYyNw==", "url": "https://github.com/nuxeo/nuxeo/pull/4191#discussion_r447847627", "bodyText": "You must use toASCIIString instead of toString here.", "author": "efge", "createdAt": "2020-06-30T17:12:10Z", "path": "modules/platform/nuxeo-preview-core/src/main/java/org/nuxeo/ecm/platform/preview/io/BlobPreviewJsonEnricher.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Nelson Silva <nsilva@nuxeo.com>\n+ */\n+\n+package org.nuxeo.ecm.platform.preview.io;\n+\n+import static org.nuxeo.ecm.core.io.registry.reflect.Instantiations.SINGLETON;\n+import static org.nuxeo.ecm.core.io.registry.reflect.Priorities.REFERENCE;\n+\n+import java.io.IOException;\n+import java.net.URI;\n+\n+import org.nuxeo.ecm.core.api.Blob;\n+import org.nuxeo.ecm.core.api.model.impl.primitives.BlobProperty;\n+import org.nuxeo.ecm.core.blob.BlobManager;\n+import org.nuxeo.ecm.core.blob.ManagedBlob;\n+import org.nuxeo.ecm.core.io.marshallers.json.enrichers.AbstractJsonEnricher;\n+import org.nuxeo.ecm.core.io.registry.reflect.Setup;\n+import org.nuxeo.runtime.api.Framework;\n+\n+import com.fasterxml.jackson.core.JsonGenerator;\n+\n+/**\n+ * Enriches {@link Blob} json with embed preview link when available.\n+ * <p>\n+ * Enabled when parameter enrichers-blob=preview is present.\n+ * <p>\n+ * Blob format is:\n+ *\n+ * <pre>\n+ * {@code\n+ * {\n+ *  \"name\": \"...\",\n+ *  \"mime-type\": \"...\",\n+ *  ...\n+ *  \"preview\": \"<url>\"\n+ * }\n+ * }\n+ * </pre>\n+ *\n+ * @since 11.2\n+ */\n+@Setup(mode = SINGLETON, priority = REFERENCE)\n+public class BlobPreviewJsonEnricher extends AbstractJsonEnricher<BlobProperty> {\n+\n+    public static final String NAME = \"preview\";\n+\n+    public BlobPreviewJsonEnricher() {\n+        super(NAME);\n+    }\n+\n+    @Override\n+    public void write(JsonGenerator jg, BlobProperty blobProperty) throws IOException {\n+        Blob blob = (Blob) blobProperty.getValue();\n+        if (!(blob instanceof ManagedBlob)) {\n+            return;\n+        }\n+\n+        // if it's a managed blob try to use the embed uri for preview\n+        BlobManager blobManager = Framework.getService(BlobManager.class);\n+        URI uri = blobManager.getURI(blob, BlobManager.UsageHint.EMBED, null);\n+        if (uri != null) {\n+            jg.writeStringField(NAME, uri.toString());", "originalCommit": "4e47bc78891c4b50af48352dfbfdfe9c08dcdf42", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "86bb0a54922575919c4c367be023d12dd659ceb9", "chunk": "diff --git a/modules/platform/nuxeo-preview-core/src/main/java/org/nuxeo/ecm/platform/preview/io/BlobPreviewJsonEnricher.java b/modules/platform/nuxeo-preview-core/src/main/java/org/nuxeo/ecm/platform/preview/io/BlobPreviewJsonEnricher.java\nindex 100d29eb57a..23837289ddb 100644\n--- a/modules/platform/nuxeo-preview-core/src/main/java/org/nuxeo/ecm/platform/preview/io/BlobPreviewJsonEnricher.java\n+++ b/modules/platform/nuxeo-preview-core/src/main/java/org/nuxeo/ecm/platform/preview/io/BlobPreviewJsonEnricher.java\n\n@@ -75,7 +75,7 @@ public class BlobPreviewJsonEnricher extends AbstractJsonEnricher<BlobProperty>\n         BlobManager blobManager = Framework.getService(BlobManager.class);\n         URI uri = blobManager.getURI(blob, BlobManager.UsageHint.EMBED, null);\n         if (uri != null) {\n-            jg.writeStringField(NAME, uri.toString());\n+            jg.writeStringField(NAME, uri.toASCIIString());\n         }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg1MDQ4OA==", "url": "https://github.com/nuxeo/nuxeo/pull/4191#discussion_r447850488", "bodyText": "Could you use a real example.com URI to be clearer in the test?", "author": "efge", "createdAt": "2020-06-30T17:16:58Z", "path": "modules/platform/nuxeo-preview-core/src/test/java/org/nuxeo/ecm/platform/preview/io/DummyManagedBlobProvider.java", "diffHunk": "@@ -0,0 +1,45 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Nelson Silva <nsilva@nuxeo.com>\n+ */\n+\n+package org.nuxeo.ecm.platform.preview.io;\n+\n+import org.nuxeo.ecm.core.blob.BlobManager;\n+import org.nuxeo.ecm.core.blob.DummyBlobProvider;\n+import org.nuxeo.ecm.core.blob.ManagedBlob;\n+\n+import javax.servlet.http.HttpServletRequest;\n+import java.io.IOException;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+\n+/**\n+ * Dummy storage in memory.\n+ */\n+public class DummyManagedBlobProvider extends DummyBlobProvider {\n+    @Override\n+    public URI getURI(ManagedBlob blob, BlobManager.UsageHint usage, HttpServletRequest servletRequest) throws IOException {\n+        URI uri = null;\n+        try {\n+            uri = new URI(usage.name());", "originalCommit": "4e47bc78891c4b50af48352dfbfdfe9c08dcdf42", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "86bb0a54922575919c4c367be023d12dd659ceb9", "chunk": "diff --git a/modules/platform/nuxeo-preview-core/src/test/java/org/nuxeo/ecm/platform/preview/io/DummyManagedBlobProvider.java b/modules/platform/nuxeo-preview-core/src/test/java/org/nuxeo/ecm/platform/preview/io/DummyManagedBlobProvider.java\nindex 773c3900e12..84e0bf37a4d 100644\n--- a/modules/platform/nuxeo-preview-core/src/test/java/org/nuxeo/ecm/platform/preview/io/DummyManagedBlobProvider.java\n+++ b/modules/platform/nuxeo-preview-core/src/test/java/org/nuxeo/ecm/platform/preview/io/DummyManagedBlobProvider.java\n\n@@ -19,27 +19,27 @@\n \n package org.nuxeo.ecm.platform.preview.io;\n \n+import java.net.URI;\n+\n+import javax.servlet.http.HttpServletRequest;\n+\n import org.nuxeo.ecm.core.blob.BlobManager;\n import org.nuxeo.ecm.core.blob.DummyBlobProvider;\n import org.nuxeo.ecm.core.blob.ManagedBlob;\n \n-import javax.servlet.http.HttpServletRequest;\n-import java.io.IOException;\n-import java.net.URI;\n-import java.net.URISyntaxException;\n-\n /**\n  * Dummy storage in memory.\n  */\n public class DummyManagedBlobProvider extends DummyBlobProvider {\n+\n+    public static String getBlobKey(ManagedBlob blob) {\n+        String key = blob.getKey();\n+        int colon = key.indexOf(':');\n+        return colon < 0 ? key : key.substring(colon + 1);\n+    }\n+\n     @Override\n-    public URI getURI(ManagedBlob blob, BlobManager.UsageHint usage, HttpServletRequest servletRequest) throws IOException {\n-        URI uri = null;\n-        try {\n-            uri = new URI(usage.name());\n-        } catch (URISyntaxException e) {\n-            //\n-        }\n-        return uri;\n+    public URI getURI(ManagedBlob blob, BlobManager.UsageHint usage, HttpServletRequest servletRequest) {\n+        return URI.create(\"http://example.com/\" + getBlobKey(blob) + \"/\" + usage.name().toLowerCase());\n     }\n }\n"}}, {"oid": "86bb0a54922575919c4c367be023d12dd659ceb9", "url": "https://github.com/nuxeo/nuxeo/commit/86bb0a54922575919c4c367be023d12dd659ceb9", "message": "NXP-29325: add managed blob preview enricher", "committedDate": "2020-06-30T21:58:02Z", "type": "forcePushed"}, {"oid": "39f1e8a720b6876d30b5c4457422b1ed3661fe9a", "url": "https://github.com/nuxeo/nuxeo/commit/39f1e8a720b6876d30b5c4457422b1ed3661fe9a", "message": "NXP-29325: add managed blob preview enricher", "committedDate": "2020-07-01T13:14:57Z", "type": "commit"}, {"oid": "39f1e8a720b6876d30b5c4457422b1ed3661fe9a", "url": "https://github.com/nuxeo/nuxeo/commit/39f1e8a720b6876d30b5c4457422b1ed3661fe9a", "message": "NXP-29325: add managed blob preview enricher", "committedDate": "2020-07-01T13:14:57Z", "type": "forcePushed"}]}