{"pr_number": 4200, "pr_title": "9.10-HF/fix-NXP-29246-import-MHTLM-in-chrome", "pr_createdAt": "2020-07-06T11:48:12Z", "pr_url": "https://github.com/nuxeo/nuxeo/pull/4200", "timeline": [{"oid": "d4f905e714e30a37a87a1ed468465965611249df", "url": "https://github.com/nuxeo/nuxeo/commit/d4f905e714e30a37a87a1ed468465965611249df", "message": "NXP-29246: add MHTML mime-type support", "committedDate": "2020-07-07T17:48:50Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA0ODYzOQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4200#discussion_r451048639", "bodyText": "removed in next push", "author": "NourNuxeo", "createdAt": "2020-07-07T18:03:35Z", "path": "nuxeo-features/rest-api/nuxeo-rest-api-server/src/main/java/org/nuxeo/ecm/restapi/server/jaxrs/BatchUploadObject.java", "diffHunk": "@@ -128,6 +135,8 @@\n \n     public static final String MD5 = \"md5\";\n \n+\n+", "originalCommit": "d4f905e714e30a37a87a1ed468465965611249df", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "48c2045e81cc7fd6cf16e5250934690aa13a4d84", "chunk": "diff --git a/nuxeo-features/rest-api/nuxeo-rest-api-server/src/main/java/org/nuxeo/ecm/restapi/server/jaxrs/BatchUploadObject.java b/nuxeo-features/rest-api/nuxeo-rest-api-server/src/main/java/org/nuxeo/ecm/restapi/server/jaxrs/BatchUploadObject.java\nindex c07c0c2782b..9ddbd847f23 100644\n--- a/nuxeo-features/rest-api/nuxeo-rest-api-server/src/main/java/org/nuxeo/ecm/restapi/server/jaxrs/BatchUploadObject.java\n+++ b/nuxeo-features/rest-api/nuxeo-rest-api-server/src/main/java/org/nuxeo/ecm/restapi/server/jaxrs/BatchUploadObject.java\n\n@@ -135,8 +135,6 @@ public class BatchUploadObject extends AbstractResource<ResourceTypeImpl> {\n \n     public static final String MD5 = \"md5\";\n \n-\n-\n     protected Map<String, String> mapWithName(String name) {\n         return Collections.singletonMap(\"name\", name);\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA4MDMxMg==", "url": "https://github.com/nuxeo/nuxeo/pull/4200#discussion_r451080312", "bodyText": "comment removed in next puh", "author": "NourNuxeo", "createdAt": "2020-07-07T19:03:24Z", "path": "nuxeo-features/rest-api/nuxeo-rest-api-test/src/test/java/org/nuxeo/ecm/restapi/test/BatchUploadFixture.java", "diffHunk": "@@ -1083,6 +1085,48 @@ public void testErrorOnRefreshedTokenError() throws Exception {\n         }\n     }\n \n+    @Test\n+    public void testUploadMHTML() throws Exception {\n+        String batchId;\n+        try (CloseableClientResponse response = getResponse(RequestType.POST, \"upload/new/dummy\")) {\n+            assertEquals(Status.OK.getStatusCode(), response.getStatus());\n+            JsonNode responseJson = mapper.readTree(response.getEntityInputStream());\n+            batchId = responseJson.get(\"batchId\").getValueAsText();\n+            assertNotNull(batchId);\n+        }\n+\n+        try (CloseableClientResponse response = getResponse(RequestType.POST, \"upload/\" + batchId + \"/0\",\n+                \"dummy\", Collections.singletonMap(\"Content-Type\", \"multipart/related\"))) {\n+            assertEquals(Status.INTERNAL_SERVER_ERROR.getStatusCode(), response.getStatus());\n+        }\n+    }\n+\n+    @Test\n+    @Deploy(\"org.nuxeo.ecm.platform.restapi.server:batch-upload-contrib-test.xml\")\n+    public void testUploadMHTMLMultipartDisabled() throws Exception {\n+        String batchId;\n+        try (CloseableClientResponse response = getResponse(RequestType.POST, \"upload/new/dummy\")) {\n+            assertEquals(Status.OK.getStatusCode(), response.getStatus());\n+            JsonNode responseJson = mapper.readTree(response.getEntityInputStream());\n+            batchId = responseJson.get(\"batchId\").getValueAsText();\n+            assertNotNull(batchId);\n+        }\n+\n+        Map<String, String> headers = new HashMap<>();\n+        headers.put(\"Content-Type\", \"multipart/related\");\n+        headers.put(\"X-File-Name\", \"dummy.mhtml\");\n+        // typed via mime-type", "originalCommit": "d4f905e714e30a37a87a1ed468465965611249df", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "48c2045e81cc7fd6cf16e5250934690aa13a4d84", "chunk": "diff --git a/nuxeo-features/rest-api/nuxeo-rest-api-test/src/test/java/org/nuxeo/ecm/restapi/test/BatchUploadFixture.java b/nuxeo-features/rest-api/nuxeo-rest-api-test/src/test/java/org/nuxeo/ecm/restapi/test/BatchUploadFixture.java\nindex f7644287d5e..f3e8c811634 100644\n--- a/nuxeo-features/rest-api/nuxeo-rest-api-test/src/test/java/org/nuxeo/ecm/restapi/test/BatchUploadFixture.java\n+++ b/nuxeo-features/rest-api/nuxeo-rest-api-test/src/test/java/org/nuxeo/ecm/restapi/test/BatchUploadFixture.java\n\n@@ -1102,7 +1102,7 @@ public class BatchUploadFixture extends BaseTest {\n     }\n \n     @Test\n-    @Deploy(\"org.nuxeo.ecm.platform.restapi.server:batch-upload-contrib-test.xml\")\n+    @Deploy(\"org.nuxeo.ecm.platform.restapi.test.test:batch-upload-contrib-test.xml\")\n     public void testUploadMHTMLMultipartDisabled() throws Exception {\n         String batchId;\n         try (CloseableClientResponse response = getResponse(RequestType.POST, \"upload/new/dummy\")) {\n"}}, {"oid": "48c2045e81cc7fd6cf16e5250934690aa13a4d84", "url": "https://github.com/nuxeo/nuxeo/commit/48c2045e81cc7fd6cf16e5250934690aa13a4d84", "message": "NXP-29246: add MHTML mime-type support", "committedDate": "2020-07-08T09:40:55Z", "type": "forcePushed"}, {"oid": "1aa03327385f11a36963ee40ce1303b4401f4644", "url": "https://github.com/nuxeo/nuxeo/commit/1aa03327385f11a36963ee40ce1303b4401f4644", "message": "NXP-29246: add MHTML mime-type support", "committedDate": "2020-07-08T13:43:07Z", "type": "forcePushed"}, {"oid": "476998c5235b65d3e155d88fbf254c65d7f61d9b", "url": "https://github.com/nuxeo/nuxeo/commit/476998c5235b65d3e155d88fbf254c65d7f61d9b", "message": "NXP-29246: add MHTML mime-type support", "committedDate": "2020-07-15T11:09:57Z", "type": "forcePushed"}, {"oid": "e93aff578b2e97c6f6b26ca9d516220f7924cae1", "url": "https://github.com/nuxeo/nuxeo/commit/e93aff578b2e97c6f6b26ca9d516220f7924cae1", "message": "NXP-29246: add MHTML mime-type support", "committedDate": "2020-07-15T17:06:47Z", "type": "forcePushed"}, {"oid": "67af5227150ad8a3027c9ef4678bc8ce01bb8e25", "url": "https://github.com/nuxeo/nuxeo/commit/67af5227150ad8a3027c9ef4678bc8ce01bb8e25", "message": "NXP-29246: add MHTML mime-type support", "committedDate": "2020-07-20T21:45:16Z", "type": "forcePushed"}, {"oid": "6356aa53c70c73d349ebfb8e12cb0729992b24d6", "url": "https://github.com/nuxeo/nuxeo/commit/6356aa53c70c73d349ebfb8e12cb0729992b24d6", "message": "NXP-29246: add MHTML mime-type support", "committedDate": "2020-07-20T21:51:04Z", "type": "forcePushed"}, {"oid": "3ab7eba474719389e3149ec5c5db3acafe66d247", "url": "https://github.com/nuxeo/nuxeo/commit/3ab7eba474719389e3149ec5c5db3acafe66d247", "message": "NXP-29246: add MHTML mime-type support", "committedDate": "2020-07-21T13:09:02Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODgzNDE3MA==", "url": "https://github.com/nuxeo/nuxeo/pull/4200#discussion_r458834170", "bodyText": "Comment should be above the annotations.", "author": "kevinleturc", "createdAt": "2020-07-22T14:27:22Z", "path": "nuxeo-features/rest-api/nuxeo-rest-api-test/src/test/java/org/nuxeo/ecm/restapi/test/BatchUploadFixture.java", "diffHunk": "@@ -1083,6 +1085,49 @@ public void testErrorOnRefreshedTokenError() throws Exception {\n         }\n     }\n \n+    @Test\n+    /** NXP-29246: Fix import of MHTML file using Chrome */\n+    public void testUploadMHTMLMultipartEnabled() throws Exception {\n+        String batchId;\n+        try (CloseableClientResponse response = getResponse(RequestType.POST, \"upload/new/dummy\")) {\n+            assertEquals(Status.OK.getStatusCode(), response.getStatus());\n+            JsonNode responseJson = mapper.readTree(response.getEntityInputStream());\n+            batchId = responseJson.get(\"batchId\").getValueAsText();\n+            assertNotNull(batchId);\n+        }\n+\n+        try (CloseableClientResponse response = getResponse(RequestType.POST, \"upload/\" + batchId + \"/0\",\n+                \"dummy\", Collections.singletonMap(\"Content-Type\", \"multipart/related\"))) {\n+            assertEquals(Status.INTERNAL_SERVER_ERROR.getStatusCode(), response.getStatus());\n+        }\n+    }\n+\n+    @Test\n+    /** NXP-29246: Fix import of MHTML file using Chrome */", "originalCommit": "3ab7eba474719389e3149ec5c5db3acafe66d247", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d84a7f93e7891c87f8c09abd0cf80bd07638f044", "chunk": "diff --git a/nuxeo-features/rest-api/nuxeo-rest-api-test/src/test/java/org/nuxeo/ecm/restapi/test/BatchUploadFixture.java b/nuxeo-features/rest-api/nuxeo-rest-api-test/src/test/java/org/nuxeo/ecm/restapi/test/BatchUploadFixture.java\nindex 4e7470ae560..856fc2b6a18 100644\n--- a/nuxeo-features/rest-api/nuxeo-rest-api-test/src/test/java/org/nuxeo/ecm/restapi/test/BatchUploadFixture.java\n+++ b/nuxeo-features/rest-api/nuxeo-rest-api-test/src/test/java/org/nuxeo/ecm/restapi/test/BatchUploadFixture.java\n\n@@ -1085,8 +1085,8 @@ public class BatchUploadFixture extends BaseTest {\n         }\n     }\n \n-    @Test\n     /** NXP-29246: Fix import of MHTML file using Chrome */\n+    @Test\n     public void testUploadMHTMLMultipartEnabled() throws Exception {\n         String batchId;\n         try (CloseableClientResponse response = getResponse(RequestType.POST, \"upload/new/dummy\")) {\n"}}, {"oid": "d84a7f93e7891c87f8c09abd0cf80bd07638f044", "url": "https://github.com/nuxeo/nuxeo/commit/d84a7f93e7891c87f8c09abd0cf80bd07638f044", "message": "NXP-29246: add MHTML mime-type support", "committedDate": "2020-07-22T16:03:25Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDgxNTI2NA==", "url": "https://github.com/nuxeo/nuxeo/pull/4200#discussion_r464815264", "bodyText": "Can you please use the following code instead:\n        String batchId;\n        try (CloseableClientResponse response = getResponse(RequestType.POST, \"upload\")) {\n            assertEquals(Status.CREATED.getStatusCode(), response.getStatus());\n            JsonNode node = mapper.readTree(response.getEntityInputStream());\n            batchId = node.get(\"batchId\").getValueAsText();\n            assertNotNull(batchId);\n        }\n\nThe /upload/new/{handler} endpoint only makes sense when specifying a handler other than the default one (S3 for instance).\nThe fact that the /upload endpoint is marked as deprecated in the documentation is a mistake and should be fixed...", "author": "ataillefer", "createdAt": "2020-08-04T05:52:59Z", "path": "nuxeo-features/rest-api/nuxeo-rest-api-test/src/test/java/org/nuxeo/ecm/restapi/test/BatchUploadFixture.java", "diffHunk": "@@ -1083,6 +1085,49 @@ public void testErrorOnRefreshedTokenError() throws Exception {\n         }\n     }\n \n+    /** NXP-29246: Fix import of MHTML file using Chrome */\n+    @Test\n+    public void testUploadMHTMLMultipartEnabled() throws Exception {\n+        String batchId;\n+        try (CloseableClientResponse response = getResponse(RequestType.POST, \"upload/new/dummy\")) {\n+            assertEquals(Status.OK.getStatusCode(), response.getStatus());\n+            JsonNode responseJson = mapper.readTree(response.getEntityInputStream());\n+            batchId = responseJson.get(\"batchId\").getValueAsText();\n+            assertNotNull(batchId);\n+        }", "originalCommit": "d84a7f93e7891c87f8c09abd0cf80bd07638f044", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDkxNDEwNw==", "url": "https://github.com/nuxeo/nuxeo/pull/4200#discussion_r464914107", "bodyText": "Thanks !", "author": "NourNuxeo", "createdAt": "2020-08-04T09:14:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDgxNTI2NA=="}], "type": "inlineReview", "revised_code": {"commit": "c0d65dc1c43d16f356e186e0b320cc0066b9ffc4", "chunk": "diff --git a/nuxeo-features/rest-api/nuxeo-rest-api-test/src/test/java/org/nuxeo/ecm/restapi/test/BatchUploadFixture.java b/nuxeo-features/rest-api/nuxeo-rest-api-test/src/test/java/org/nuxeo/ecm/restapi/test/BatchUploadFixture.java\nindex 856fc2b6a18..9ae57695c5e 100644\n--- a/nuxeo-features/rest-api/nuxeo-rest-api-test/src/test/java/org/nuxeo/ecm/restapi/test/BatchUploadFixture.java\n+++ b/nuxeo-features/rest-api/nuxeo-rest-api-test/src/test/java/org/nuxeo/ecm/restapi/test/BatchUploadFixture.java\n\n@@ -1089,10 +1089,10 @@ public class BatchUploadFixture extends BaseTest {\n     @Test\n     public void testUploadMHTMLMultipartEnabled() throws Exception {\n         String batchId;\n-        try (CloseableClientResponse response = getResponse(RequestType.POST, \"upload/new/dummy\")) {\n-            assertEquals(Status.OK.getStatusCode(), response.getStatus());\n-            JsonNode responseJson = mapper.readTree(response.getEntityInputStream());\n-            batchId = responseJson.get(\"batchId\").getValueAsText();\n+        try (CloseableClientResponse response = getResponse(RequestType.POST, \"upload\")) {\n+            assertEquals(Status.CREATED.getStatusCode(), response.getStatus());\n+            JsonNode node = mapper.readTree(response.getEntityInputStream());\n+            batchId = node.get(\"batchId\").getValueAsText();\n             assertNotNull(batchId);\n         }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDgxNTc4OA==", "url": "https://github.com/nuxeo/nuxeo/pull/4200#discussion_r464815788", "bodyText": "Same remark as above.", "author": "ataillefer", "createdAt": "2020-08-04T05:54:47Z", "path": "nuxeo-features/rest-api/nuxeo-rest-api-test/src/test/java/org/nuxeo/ecm/restapi/test/BatchUploadFixture.java", "diffHunk": "@@ -1083,6 +1085,49 @@ public void testErrorOnRefreshedTokenError() throws Exception {\n         }\n     }\n \n+    /** NXP-29246: Fix import of MHTML file using Chrome */\n+    @Test\n+    public void testUploadMHTMLMultipartEnabled() throws Exception {\n+        String batchId;\n+        try (CloseableClientResponse response = getResponse(RequestType.POST, \"upload/new/dummy\")) {\n+            assertEquals(Status.OK.getStatusCode(), response.getStatus());\n+            JsonNode responseJson = mapper.readTree(response.getEntityInputStream());\n+            batchId = responseJson.get(\"batchId\").getValueAsText();\n+            assertNotNull(batchId);\n+        }\n+\n+        try (CloseableClientResponse response = getResponse(RequestType.POST, \"upload/\" + batchId + \"/0\",\n+                \"dummy\", Collections.singletonMap(\"Content-Type\", \"multipart/related\"))) {\n+            assertEquals(Status.INTERNAL_SERVER_ERROR.getStatusCode(), response.getStatus());\n+        }\n+    }\n+\n+    /** NXP-29246: Fix import of MHTML file using Chrome */\n+    @Test\n+    @Deploy(\"org.nuxeo.ecm.platform.restapi.test.test:test-batch-upload-properties.xml\")\n+    public void testUploadMHTMLMultipartDisabled() throws Exception {\n+        String batchId;\n+        try (CloseableClientResponse response = getResponse(RequestType.POST, \"upload/new/dummy\")) {\n+            assertEquals(Status.OK.getStatusCode(), response.getStatus());\n+            JsonNode responseJson = mapper.readTree(response.getEntityInputStream());\n+            batchId = responseJson.get(\"batchId\").getValueAsText();\n+            assertNotNull(batchId);\n+        }", "originalCommit": "d84a7f93e7891c87f8c09abd0cf80bd07638f044", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c0d65dc1c43d16f356e186e0b320cc0066b9ffc4", "chunk": "diff --git a/nuxeo-features/rest-api/nuxeo-rest-api-test/src/test/java/org/nuxeo/ecm/restapi/test/BatchUploadFixture.java b/nuxeo-features/rest-api/nuxeo-rest-api-test/src/test/java/org/nuxeo/ecm/restapi/test/BatchUploadFixture.java\nindex 856fc2b6a18..9ae57695c5e 100644\n--- a/nuxeo-features/rest-api/nuxeo-rest-api-test/src/test/java/org/nuxeo/ecm/restapi/test/BatchUploadFixture.java\n+++ b/nuxeo-features/rest-api/nuxeo-rest-api-test/src/test/java/org/nuxeo/ecm/restapi/test/BatchUploadFixture.java\n\n@@ -1089,10 +1089,10 @@ public class BatchUploadFixture extends BaseTest {\n     @Test\n     public void testUploadMHTMLMultipartEnabled() throws Exception {\n         String batchId;\n-        try (CloseableClientResponse response = getResponse(RequestType.POST, \"upload/new/dummy\")) {\n-            assertEquals(Status.OK.getStatusCode(), response.getStatus());\n-            JsonNode responseJson = mapper.readTree(response.getEntityInputStream());\n-            batchId = responseJson.get(\"batchId\").getValueAsText();\n+        try (CloseableClientResponse response = getResponse(RequestType.POST, \"upload\")) {\n+            assertEquals(Status.CREATED.getStatusCode(), response.getStatus());\n+            JsonNode node = mapper.readTree(response.getEntityInputStream());\n+            batchId = node.get(\"batchId\").getValueAsText();\n             assertNotNull(batchId);\n         }\n \n"}}, {"oid": "c0d65dc1c43d16f356e186e0b320cc0066b9ffc4", "url": "https://github.com/nuxeo/nuxeo/commit/c0d65dc1c43d16f356e186e0b320cc0066b9ffc4", "message": "NXP-29246: add MHTML mime-type support", "committedDate": "2020-08-04T09:15:11Z", "type": "commit"}, {"oid": "c0d65dc1c43d16f356e186e0b320cc0066b9ffc4", "url": "https://github.com/nuxeo/nuxeo/commit/c0d65dc1c43d16f356e186e0b320cc0066b9ffc4", "message": "NXP-29246: add MHTML mime-type support", "committedDate": "2020-08-04T09:15:11Z", "type": "forcePushed"}]}