{"pr_number": 4483, "pr_title": "10.10-HF/fix-NXP-29833-Check-ACL-name-not-null", "pr_createdAt": "2020-11-19T17:11:27Z", "pr_url": "https://github.com/nuxeo/nuxeo/pull/4483", "timeline": [{"oid": "8f49ead678c2469ac455ed86bead4ca4e41350c8", "url": "https://github.com/nuxeo/nuxeo/commit/8f49ead678c2469ac455ed86bead4ca4e41350c8", "message": "NXP-29833: format", "committedDate": "2020-11-18T18:01:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzA2ODIwNA==", "url": "https://github.com/nuxeo/nuxeo/pull/4483#discussion_r527068204", "bodyText": "log.trace and others will just log a message, and not the full stacktrace, if there's only one parameter. You need something like:\nlog.trace(\"ACL name is null\", new NuxeoException(\"trace\"));", "author": "efge", "createdAt": "2020-11-19T17:28:15Z", "path": "nuxeo-core/nuxeo-core-api/src/main/java/org/nuxeo/ecm/core/api/security/impl/ACLImpl.java", "diffHunk": "@@ -56,6 +57,13 @@\n     private final boolean isReadOnly;\n \n     public ACLImpl(String name, boolean isReadOnly) {\n+        if (name == null) {\n+            log.debug(\"ACL name is null\");\n+            if (log.isTraceEnabled()) {\n+                log.trace(new NuxeoException(\"ACL name is null\"));", "originalCommit": "fa7d11889484094042cf3e3f4a9e34b03875c634", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "285a349087130f261494c2683a3c349df9caf951", "chunk": "diff --git a/nuxeo-core/nuxeo-core-api/src/main/java/org/nuxeo/ecm/core/api/security/impl/ACLImpl.java b/nuxeo-core/nuxeo-core-api/src/main/java/org/nuxeo/ecm/core/api/security/impl/ACLImpl.java\nindex bd0ba7544fb..eeb7e730f8f 100644\n--- a/nuxeo-core/nuxeo-core-api/src/main/java/org/nuxeo/ecm/core/api/security/impl/ACLImpl.java\n+++ b/nuxeo-core/nuxeo-core-api/src/main/java/org/nuxeo/ecm/core/api/security/impl/ACLImpl.java\n\n@@ -60,7 +60,7 @@ public class ACLImpl extends ArrayList<ACE> implements ACL {\n         if (name == null) {\n             log.debug(\"ACL name is null\");\n             if (log.isTraceEnabled()) {\n-                log.trace(new NuxeoException(\"ACL name is null\"));\n+                log.trace(\"ACL name is null\", new NuxeoException(\"trace\"));\n             }\n             name = ACL.LOCAL_ACL;\n         }\n"}}, {"oid": "285a349087130f261494c2683a3c349df9caf951", "url": "https://github.com/nuxeo/nuxeo/commit/285a349087130f261494c2683a3c349df9caf951", "message": "NXP-29833: log and set null ACL names", "committedDate": "2020-11-19T18:09:37Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY0NzMzNQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4483#discussion_r527647335", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        name = ACL.LOCAL_ACL;\n          \n          \n            \n                        name = LOCAL_ACL;", "author": "kevinleturc", "createdAt": "2020-11-20T12:03:53Z", "path": "nuxeo-core/nuxeo-core-api/src/main/java/org/nuxeo/ecm/core/api/security/impl/ACLImpl.java", "diffHunk": "@@ -56,6 +57,13 @@\n     private final boolean isReadOnly;\n \n     public ACLImpl(String name, boolean isReadOnly) {\n+        if (name == null) {\n+            log.debug(\"ACL name is null\");\n+            if (log.isTraceEnabled()) {\n+                log.trace(\"ACL name is null\", new NuxeoException(\"trace\"));\n+            }\n+            name = ACL.LOCAL_ACL;", "originalCommit": "285a349087130f261494c2683a3c349df9caf951", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "233b490ff7d6cbedee5f3b4e529984ad55e448c2", "chunk": "diff --git a/nuxeo-core/nuxeo-core-api/src/main/java/org/nuxeo/ecm/core/api/security/impl/ACLImpl.java b/nuxeo-core/nuxeo-core-api/src/main/java/org/nuxeo/ecm/core/api/security/impl/ACLImpl.java\nindex eeb7e730f8f..bffd90bdf52 100644\n--- a/nuxeo-core/nuxeo-core-api/src/main/java/org/nuxeo/ecm/core/api/security/impl/ACLImpl.java\n+++ b/nuxeo-core/nuxeo-core-api/src/main/java/org/nuxeo/ecm/core/api/security/impl/ACLImpl.java\n\n@@ -62,7 +62,7 @@ public class ACLImpl extends ArrayList<ACE> implements ACL {\n             if (log.isTraceEnabled()) {\n                 log.trace(\"ACL name is null\", new NuxeoException(\"trace\"));\n             }\n-            name = ACL.LOCAL_ACL;\n+            name = LOCAL_ACL;\n         }\n         this.name = name;\n         this.isReadOnly = isReadOnly;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY1MDk2MA==", "url": "https://github.com/nuxeo/nuxeo/pull/4483#discussion_r527650960", "bodyText": "You're not giving a null name by doing that as the default constructor gives LOCAL_ACL as name.\nFurthermore, it can make sense to capture the logs and check that the debug log ACL name is null is written.", "author": "kevinleturc", "createdAt": "2020-11-20T12:11:33Z", "path": "nuxeo-core/nuxeo-core-api/src/test/java/org/nuxeo/ecm/core/api/security/TestACL.java", "diffHunk": "@@ -46,6 +46,12 @@ public void testGetName() {\n         assertEquals(\"test acl\", acl.getName());\n     }\n \n+    @Test\n+    public void testSetNullName() {\n+        acl = new ACLImpl();\n+        assertEquals(ACL.LOCAL_ACL, acl.getName());\n+    }", "originalCommit": "285a349087130f261494c2683a3c349df9caf951", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "233b490ff7d6cbedee5f3b4e529984ad55e448c2", "chunk": "diff --git a/nuxeo-core/nuxeo-core-api/src/test/java/org/nuxeo/ecm/core/api/security/TestACL.java b/nuxeo-core/nuxeo-core-api/src/test/java/org/nuxeo/ecm/core/api/security/TestACL.java\nindex fbb5badf465..2593fcea547 100644\n--- a/nuxeo-core/nuxeo-core-api/src/test/java/org/nuxeo/ecm/core/api/security/TestACL.java\n+++ b/nuxeo-core/nuxeo-core-api/src/test/java/org/nuxeo/ecm/core/api/security/TestACL.java\n\n@@ -47,9 +62,14 @@ public class TestACL {\n     }\n \n     @Test\n+    @LogCaptureFeature.FilterOn(logLevel = \"DEBUG\")\n     public void testSetNullName() {\n-        acl = new ACLImpl();\n+        acl = new ACLImpl(null, false);\n         assertEquals(ACL.LOCAL_ACL, acl.getName());\n+\n+        // Check the message has been logged\n+        List<String> eventsCaught = logCaptureResult.getCaughtEventMessages();\n+        assertEquals(\"ACL name is null\", eventsCaught.get(0));\n     }\n \n     @Test\n"}}, {"oid": "233b490ff7d6cbedee5f3b4e529984ad55e448c2", "url": "https://github.com/nuxeo/nuxeo/commit/233b490ff7d6cbedee5f3b4e529984ad55e448c2", "message": "NXP-29833: log and set null ACL names", "committedDate": "2020-11-20T14:26:31Z", "type": "forcePushed"}, {"oid": "33926861db276e38b5c3ec93d51cc271881c97fb", "url": "https://github.com/nuxeo/nuxeo/commit/33926861db276e38b5c3ec93d51cc271881c97fb", "message": "NXP-29833: log and set null ACL names", "committedDate": "2020-11-20T14:29:11Z", "type": "forcePushed"}, {"oid": "510749ff2a870b506c9afc31d3972cf4f47cab11", "url": "https://github.com/nuxeo/nuxeo/commit/510749ff2a870b506c9afc31d3972cf4f47cab11", "message": "NXP-29833: log and set null ACL names", "committedDate": "2020-11-20T14:46:35Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODU1OTYyMw==", "url": "https://github.com/nuxeo/nuxeo/pull/4483#discussion_r528559623", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @LogCaptureFeature.FilterOn(logLevel = \"DEBUG\")\n          \n          \n            \n                @LogCaptureFeature.FilterOn(logLevel = \"DEBUG\", loggerClass= ACLImpl.class)", "author": "kevinleturc", "createdAt": "2020-11-23T09:17:58Z", "path": "nuxeo-core/nuxeo-core-api/src/test/java/org/nuxeo/ecm/core/api/security/TestACL.java", "diffHunk": "@@ -46,6 +60,17 @@ public void testGetName() {\n         assertEquals(\"test acl\", acl.getName());\n     }\n \n+    @Test\n+    @LogCaptureFeature.FilterOn(logLevel = \"DEBUG\")", "originalCommit": "510749ff2a870b506c9afc31d3972cf4f47cab11", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3048423fa1ea2ee9b171ac1d5dd1aa202cd3537a", "chunk": "diff --git a/nuxeo-core/nuxeo-core-api/src/test/java/org/nuxeo/ecm/core/api/security/TestACL.java b/nuxeo-core/nuxeo-core-api/src/test/java/org/nuxeo/ecm/core/api/security/TestACL.java\nindex 1e8cdfa0061..a7ec8678d12 100644\n--- a/nuxeo-core/nuxeo-core-api/src/test/java/org/nuxeo/ecm/core/api/security/TestACL.java\n+++ b/nuxeo-core/nuxeo-core-api/src/test/java/org/nuxeo/ecm/core/api/security/TestACL.java\n\n@@ -61,7 +61,7 @@ public class TestACL {\n     }\n \n     @Test\n-    @LogCaptureFeature.FilterOn(logLevel = \"DEBUG\")\n+    @LogCaptureFeature.FilterOn(logLevel = \"DEBUG\", loggerClass = ACLImpl.class)\n     public void testSetNullName() {\n         acl = new ACLImpl(null, false);\n         assertEquals(ACL.LOCAL_ACL, acl.getName());\n"}}, {"oid": "3048423fa1ea2ee9b171ac1d5dd1aa202cd3537a", "url": "https://github.com/nuxeo/nuxeo/commit/3048423fa1ea2ee9b171ac1d5dd1aa202cd3537a", "message": "NXP-29833: log and set null ACL names", "committedDate": "2020-11-23T09:42:14Z", "type": "commit"}, {"oid": "3048423fa1ea2ee9b171ac1d5dd1aa202cd3537a", "url": "https://github.com/nuxeo/nuxeo/commit/3048423fa1ea2ee9b171ac1d5dd1aa202cd3537a", "message": "NXP-29833: log and set null ACL names", "committedDate": "2020-11-23T09:42:14Z", "type": "forcePushed"}]}