{"pr_number": 4321, "pr_title": "Fix NXP-29618 rate limit exceed gcp", "pr_createdAt": "2020-09-15T14:19:21Z", "pr_url": "https://github.com/nuxeo/nuxeo/pull/4321", "timeline": [{"oid": "d426123065f80006afc3e9f4fb8582fe31b6cb79", "url": "https://github.com/nuxeo/nuxeo/commit/d426123065f80006afc3e9f4fb8582fe31b6cb79", "message": "NXP-29618: Cleanup / Format", "committedDate": "2020-09-15T14:18:40Z", "type": "commit"}, {"oid": "4b1760b67d868943c545718b00926b63abc5b42b", "url": "https://github.com/nuxeo/nuxeo/commit/4b1760b67d868943c545718b00926b63abc5b42b", "message": "NXP-29618: Check blob presence before uploading it", "committedDate": "2020-09-15T14:18:44Z", "type": "forcePushed"}, {"oid": "e3c9d28ceda997fdfc416c95398203aed6a5f779", "url": "https://github.com/nuxeo/nuxeo/commit/e3c9d28ceda997fdfc416c95398203aed6a5f779", "message": "NXP-29618: Check blob presence before uploading it", "committedDate": "2020-09-15T14:24:26Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODcxOTI0MQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4321#discussion_r488719241", "bodyText": "I guess that bucket.get(key) only gets metadata and does not get the full blob stream, right?", "author": "efge", "createdAt": "2020-09-15T14:35:53Z", "path": "modules/core/nuxeo-core-binarymanager-cloud/nuxeo-core-binarymanager-gcp/src/main/java/org/nuxeo/ecm/core/storage/gcp/GoogleStorageBinaryManager.java", "diffHunk": "@@ -180,11 +180,19 @@ protected FileStorage getFileStorage() {\n     public class GCPFileStorage implements FileStorage {\n \n         @Override\n-        public void storeFile(String key, File file) {\n-            try {\n-                bucket.create(bucketPrefix + key, new FileInputStream(file));\n-            } catch (IOException e) {\n-                throw new NuxeoException(e);\n+        public void storeFile(String digest, File file) {\n+            long t0 = System.currentTimeMillis();\n+            log.debug(\"Storing blob with digest: {} to GCS\", digest);\n+            String key = bucketPrefix + digest;\n+            if (bucket.get(key) == null) {", "originalCommit": "e3c9d28ceda997fdfc416c95398203aed6a5f779", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODcyNjg4Nw==", "url": "https://github.com/nuxeo/nuxeo/pull/4321#discussion_r488726887", "bodyText": "Indeed, the blob content is retrieved through the Blob#downloadTo method (or reader). I will add  a comment to state that.", "author": "kevinleturc", "createdAt": "2020-09-15T14:45:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODcxOTI0MQ=="}], "type": "inlineReview", "revised_code": {"commit": "df77d11b29fa708624471d94c25ff15aebd325b8", "chunk": "diff --git a/modules/core/nuxeo-core-binarymanager-cloud/nuxeo-core-binarymanager-gcp/src/main/java/org/nuxeo/ecm/core/storage/gcp/GoogleStorageBinaryManager.java b/modules/core/nuxeo-core-binarymanager-cloud/nuxeo-core-binarymanager-gcp/src/main/java/org/nuxeo/ecm/core/storage/gcp/GoogleStorageBinaryManager.java\nindex 95f58626359..f34e980505b 100644\n--- a/modules/core/nuxeo-core-binarymanager-cloud/nuxeo-core-binarymanager-gcp/src/main/java/org/nuxeo/ecm/core/storage/gcp/GoogleStorageBinaryManager.java\n+++ b/modules/core/nuxeo-core-binarymanager-cloud/nuxeo-core-binarymanager-gcp/src/main/java/org/nuxeo/ecm/core/storage/gcp/GoogleStorageBinaryManager.java\n\n@@ -184,6 +184,7 @@ public class GoogleStorageBinaryManager extends AbstractCloudBinaryManager {\n             long t0 = System.currentTimeMillis();\n             log.debug(\"Storing blob with digest: {} to GCS\", digest);\n             String key = bucketPrefix + digest;\n+            // try to get the blob's metadata to check if it exists\n             if (bucket.get(key) == null) {\n                 try (var fis = new FileInputStream(file)) {\n                     bucket.create(key, fis);\n"}}, {"oid": "df77d11b29fa708624471d94c25ff15aebd325b8", "url": "https://github.com/nuxeo/nuxeo/commit/df77d11b29fa708624471d94c25ff15aebd325b8", "message": "NXP-29618: Check blob presence before uploading it", "committedDate": "2020-09-15T15:01:06Z", "type": "commit"}, {"oid": "df77d11b29fa708624471d94c25ff15aebd325b8", "url": "https://github.com/nuxeo/nuxeo/commit/df77d11b29fa708624471d94c25ff15aebd325b8", "message": "NXP-29618: Check blob presence before uploading it", "committedDate": "2020-09-15T15:01:06Z", "type": "forcePushed"}]}