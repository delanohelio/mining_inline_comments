{"pr_number": 3812, "pr_title": "10.10-HF/fix-NXP-28719-Fix-Comment-Migration-failure-due-to-versions", "pr_createdAt": "2020-03-04T23:05:04Z", "pr_url": "https://github.com/nuxeo/nuxeo/pull/3812", "timeline": [{"oid": "97b944d861c79837dcddbe0cccec63b89ece0ea1", "url": "https://github.com/nuxeo/nuxeo/commit/97b944d861c79837dcddbe0cccec63b89ece0ea1", "message": "NXP-28719: Fix Comment Migration failure due to versions", "committedDate": "2020-03-05T09:07:04Z", "type": "forcePushed"}, {"oid": "34d324216d5ab7679eae0c830f870a5ca4f124b1", "url": "https://github.com/nuxeo/nuxeo/commit/34d324216d5ab7679eae0c830f870a5ca4f124b1", "message": "NXP-28719: Fix Comment Migration failure due to versions", "committedDate": "2020-03-05T09:11:31Z", "type": "forcePushed"}, {"oid": "513db85f0f574170ab08fb123f4ee12d97910695", "url": "https://github.com/nuxeo/nuxeo/commit/513db85f0f574170ab08fb123f4ee12d97910695", "message": "NXP-28719: Fix Comment Migration failure due to versions", "committedDate": "2020-03-05T11:16:44Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI0NTYzNA==", "url": "https://github.com/nuxeo/nuxeo/pull/3812#discussion_r388245634", "bodyText": "https://jira.nuxeo.com/browse/NXP-28130 was supposed to fix this but I guess we forgot some cases :(", "author": "efge", "createdAt": "2020-03-05T11:51:19Z", "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/main/java/org/nuxeo/ecm/platform/comment/impl/CommentsMigrator.java", "diffHunk": "@@ -272,8 +272,11 @@ protected void migrateCommentsFromPropertyToSecured(CoreSession session, TreeCom\n \n         // Strip ACLs\n         ACP acp = session.getACP(commentIdRef);\n-        acp.removeACL(LOCAL_ACL);\n-        session.setACP(commentIdRef, acp, true);\n+        // Case where a comment is on a placeless document which has no acp\n+        if (acp != null) {", "originalCommit": "513db85f0f574170ab08fb123f4ee12d97910695", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "da78cca9922dea8b13a1b93be900987f95914a97", "chunk": "diff --git a/nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/main/java/org/nuxeo/ecm/platform/comment/impl/CommentsMigrator.java b/nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/main/java/org/nuxeo/ecm/platform/comment/impl/CommentsMigrator.java\nindex 629f1a2ee24..40e4012bf58 100644\n--- a/nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/main/java/org/nuxeo/ecm/platform/comment/impl/CommentsMigrator.java\n+++ b/nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/main/java/org/nuxeo/ecm/platform/comment/impl/CommentsMigrator.java\n\n@@ -272,11 +272,8 @@ public class CommentsMigrator extends AbstractRepositoryMigrator {\n \n         // Strip ACLs\n         ACP acp = session.getACP(commentIdRef);\n-        // Case where a comment is on a placeless document which has no acp\n-        if (acp != null) {\n-            acp.removeACL(LOCAL_ACL);\n-            session.setACP(commentIdRef, acp, true);\n-        }\n+        acp.removeACL(LOCAL_ACL);\n+        session.setACP(commentIdRef, acp, true);\n \n         session.saveDocument(commentDoc);\n         session.save();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI0NTk0Ng==", "url": "https://github.com/nuxeo/nuxeo/pull/3812#discussion_r388245946", "bodyText": "Empty line not needed", "author": "efge", "createdAt": "2020-03-05T11:51:59Z", "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/test/java/org/nuxeo/ecm/platform/comment/TestCommentsMigrator.java", "diffHunk": "@@ -517,6 +556,17 @@ protected void migrateFromPropertyToSecured(Migrator migrator, boolean commentsW\n                     \"Migrating comments from Property to Secured: 201/250\", //\n                     \"Migrating comments from Property to Secured: 250/250\", //\n                     \"Done Migrating from Property to Secured: 200/250\"));\n+        } else if (commentsWithPlacelessParent) {\n+            expectedLines.addAll(Arrays.asList( //\n+                    \"Initializing: 0/-1\", //\n+                    \"Migrating comments from Property to Secured: 1/250\", //\n+                    \"Migrating comments from Property to Secured: 51/250\", //\n+                    \"Migrating comments from Property to Secured: 101/250\", //\n+                    \"Migrating comments from Property to Secured: 151/250\", //\n+                    \"Migrating comments from Property to Secured: 201/250\", //\n+                    \"Migrating comments from Property to Secured: 250/250\", //\n+                    \"Done Migrating from Property to Secured: 250/250\"));\n+", "originalCommit": "513db85f0f574170ab08fb123f4ee12d97910695", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "472ff9331a45f8b5d6194bc86a02c1df24ad0280", "chunk": "diff --git a/nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/test/java/org/nuxeo/ecm/platform/comment/TestCommentsMigrator.java b/nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/test/java/org/nuxeo/ecm/platform/comment/TestCommentsMigrator.java\nindex 159801d5e90..2a08771dbdc 100644\n--- a/nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/test/java/org/nuxeo/ecm/platform/comment/TestCommentsMigrator.java\n+++ b/nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/test/java/org/nuxeo/ecm/platform/comment/TestCommentsMigrator.java\n\n@@ -566,7 +566,6 @@ public class TestCommentsMigrator {\n                     \"Migrating comments from Property to Secured: 201/250\", //\n                     \"Migrating comments from Property to Secured: 250/250\", //\n                     \"Done Migrating from Property to Secured: 250/250\"));\n-\n         } else {\n             expectedLines.addAll(Arrays.asList( //\n                     \"Initializing: 0/-1\", //\n"}}, {"oid": "472ff9331a45f8b5d6194bc86a02c1df24ad0280", "url": "https://github.com/nuxeo/nuxeo/commit/472ff9331a45f8b5d6194bc86a02c1df24ad0280", "message": "NXP-28719: Fix Comment Migration failure due to versions", "committedDate": "2020-03-06T10:01:20Z", "type": "forcePushed"}, {"oid": "56086e5b87f93bac0ee5c35e144452f7047730f3", "url": "https://github.com/nuxeo/nuxeo/commit/56086e5b87f93bac0ee5c35e144452f7047730f3", "message": "NXP-28719: Fix Comment Migration failure due to versions", "committedDate": "2020-03-06T10:37:04Z", "type": "forcePushed"}, {"oid": "da78cca9922dea8b13a1b93be900987f95914a97", "url": "https://github.com/nuxeo/nuxeo/commit/da78cca9922dea8b13a1b93be900987f95914a97", "message": "NXP-28731: Create comments on a placeless document must be effective", "committedDate": "2020-03-06T16:09:42Z", "type": "commit"}, {"oid": "c57e5f2e0e84ba322d6bac6eeec7be4ed46003dd", "url": "https://github.com/nuxeo/nuxeo/commit/c57e5f2e0e84ba322d6bac6eeec7be4ed46003dd", "message": "NXP-28719: Fix Comment Migration failure due to versions", "committedDate": "2020-03-06T16:09:49Z", "type": "commit"}, {"oid": "c57e5f2e0e84ba322d6bac6eeec7be4ed46003dd", "url": "https://github.com/nuxeo/nuxeo/commit/c57e5f2e0e84ba322d6bac6eeec7be4ed46003dd", "message": "NXP-28719: Fix Comment Migration failure due to versions", "committedDate": "2020-03-06T16:09:49Z", "type": "forcePushed"}]}