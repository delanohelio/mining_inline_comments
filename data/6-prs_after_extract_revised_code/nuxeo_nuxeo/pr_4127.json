{"pr_number": 4127, "pr_title": "fix-NXP-29198-stream-position-offset", "pr_createdAt": "2020-06-09T01:48:08Z", "pr_url": "https://github.com/nuxeo/nuxeo/pull/4127", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzIxODAzMw==", "url": "https://github.com/nuxeo/nuxeo/pull/4127#discussion_r437218033", "bodyText": "Any reason it's not written this way?\nreturn \"Name{id='\" + id + \"', urn='\" + urn + \"'}\";", "author": "ataillefer", "createdAt": "2020-06-09T08:11:43Z", "path": "modules/runtime/nuxeo-stream/src/main/java/org/nuxeo/lib/stream/log/Name.java", "diffHunk": "@@ -115,8 +115,7 @@ public String getUrn() {\n \n     @Override\n     public String toString() {\n-        return \"Name{\" + \"namespace='\" + namespace + '\\'' + \", name='\" + name + '\\'' + \", id='\" + id + '\\'' + \", urn='\"\n-                + urn + '\\'' + '}';\n+        return \"Name{\" + \"id='\" + id + '\\'' + \", urn='\" + urn + '\\'' + '}';", "originalCommit": "8617068112d9afc7c5612ad939463eabc79aa9a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDMzNjI5OQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4127#discussion_r450336299", "bodyText": "generated code", "author": "bdelbosc", "createdAt": "2020-07-06T16:22:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzIxODAzMw=="}], "type": "inlineReview", "revised_code": {"commit": "1282d86ec6a72b7b934d9e4901b4e034620ae5f8", "chunk": "diff --git a/modules/runtime/nuxeo-stream/src/main/java/org/nuxeo/lib/stream/log/Name.java b/modules/runtime/nuxeo-stream/src/main/java/org/nuxeo/lib/stream/log/Name.java\nindex 0c64e86f395..78b09efb496 100644\n--- a/modules/runtime/nuxeo-stream/src/main/java/org/nuxeo/lib/stream/log/Name.java\n+++ b/modules/runtime/nuxeo-stream/src/main/java/org/nuxeo/lib/stream/log/Name.java\n\n@@ -115,7 +115,8 @@ public class Name {\n \n     @Override\n     public String toString() {\n-        return \"Name{\" + \"id='\" + id + '\\'' + \", urn='\" + urn + '\\'' + '}';\n+        return \"Name{\" + \"namespace='\" + namespace + '\\'' + \", name='\" + name + '\\'' + \", id='\" + id + '\\'' + \", urn='\"\n+                + urn + '\\'' + '}';\n     }\n \n     protected static void checkLogName(String name) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzIxOTQzNg==", "url": "https://github.com/nuxeo/nuxeo/pull/4127#discussion_r437219436", "bodyText": "It's a single position right? In which case position.", "author": "ataillefer", "createdAt": "2020-06-09T08:14:07Z", "path": "modules/runtime/nuxeo-stream/src/main/java/org/nuxeo/lib/stream/tools/command/PositionCommand.java", "diffHunk": "@@ -124,6 +126,13 @@ public void updateOptions(Options options) {\n                       .hasArg()\n                       .argName(\"DATE\")\n                       .build());\n+        options.addOption(Option.builder()\n+                                .longOpt(TO_OFFSET_OPT)\n+                                .desc(\"Sets the committed positions to a specific offset.\"", "originalCommit": "e029664a0dec10d75673df5c8bd083068acb03d4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5bf7ee55ec8bd28b6000ef25edb1d93c8ad83927", "chunk": "diff --git a/modules/runtime/nuxeo-stream/src/main/java/org/nuxeo/lib/stream/tools/command/PositionCommand.java b/modules/runtime/nuxeo-stream/src/main/java/org/nuxeo/lib/stream/tools/command/PositionCommand.java\nindex 2d46a7b883f..0917c419abc 100644\n--- a/modules/runtime/nuxeo-stream/src/main/java/org/nuxeo/lib/stream/tools/command/PositionCommand.java\n+++ b/modules/runtime/nuxeo-stream/src/main/java/org/nuxeo/lib/stream/tools/command/PositionCommand.java\n\n@@ -139,6 +145,7 @@ public class PositionCommand extends Command {\n     public boolean run(LogManager manager, CommandLine cmd) throws InterruptedException {\n         Name name = Name.ofUrn(cmd.getOptionValue(\"log-name\"));\n         Name group = Name.ofUrn(cmd.getOptionValue(\"group\", \"admin/tools\"));\n+        String codec = cmd.getOptionValue(\"codec\");\n         int partition = Integer.parseInt(cmd.getOptionValue(\"partition\", \"-1\"));\n         if (cmd.hasOption(AFTER_DATE_OPT)) {\n             long timestamp = getTimestampFromDate(cmd.getOptionValue(AFTER_DATE_OPT));\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzIyMDI1OQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4127#discussion_r437220259", "bodyText": "Why? Is it an abnormal behavior?", "author": "ataillefer", "createdAt": "2020-06-09T08:15:32Z", "path": "modules/runtime/nuxeo-stream/src/main/java/org/nuxeo/lib/stream/tools/command/PositionCommand.java", "diffHunk": "@@ -212,7 +224,7 @@ protected boolean positionAfterDate(LogManager manager, Name group, Name name, i\n                 }\n                 tailer.seek(logOffset);\n                 movedOffset = true;\n-                log.info(String.format(\"# Set log %s, group: %s, to offset %s\", labelFor(name, part), group,\n+                log.warn(String.format(\"# Set log %s, group: %s, to offset %s\", labelFor(name, part), group,", "originalCommit": "e029664a0dec10d75673df5c8bd083068acb03d4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc1OTI4NA==", "url": "https://github.com/nuxeo/nuxeo/pull/4127#discussion_r450759284", "bodyText": "it is not abnormal, but moving consumer offset is an important administrative operation so it is important to warn", "author": "bdelbosc", "createdAt": "2020-07-07T10:17:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzIyMDI1OQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzIyMjc4Nw==", "url": "https://github.com/nuxeo/nuxeo/pull/4127#discussion_r437222787", "bodyText": "Do we want:\nlog.error(\"Interrupted\", e);\n\n?", "author": "ataillefer", "createdAt": "2020-06-09T08:19:46Z", "path": "modules/runtime/nuxeo-stream/src/main/java/org/nuxeo/lib/stream/tools/command/PositionCommand.java", "diffHunk": "@@ -280,4 +292,38 @@ protected LogOffset searchWatermarkOffset(LogTailer<Record> tailer, long timesta\n         return lastOffset;\n     }\n \n+    protected boolean positionToOffset(LogManager manager, Name group, Name name, int partition, long offset) {\n+        LogLag lag = getLag(manager, group, name, partition);\n+        long pos = lag.lower();\n+        boolean goToStart = false;\n+        if (offset < pos) {\n+            goToStart = true;\n+        } else if (offset == pos) {\n+            log.error(String.format(\"Current offset for group %s on %s is already %d\", group, labelFor(name, partition),\n+                    pos));\n+            return false;\n+        }\n+        try (LogTailer<Externalizable> tailer = manager.createTailer(group, LogPartition.of(name, partition))) {\n+            if (goToStart) {\n+                tailer.toStart();\n+            }\n+            for (;;) {\n+                LogRecord<Externalizable> record = tailer.read(Duration.ofSeconds(1));\n+                if (record == null || record.offset().offset() > offset) {\n+                    log.error(\"No offset found for the specified partition\");\n+                    return false;\n+                }\n+                if (record.offset().offset() == offset) {\n+                    tailer.commit();\n+                    log.warn(String.format(\"# Move group %s on %s from %d to %d\", group, labelFor(name, partition), pos,\n+                            offset));\n+                    return true;\n+                }\n+            }\n+        } catch (InterruptedException e) {\n+            Thread.currentThread().interrupt();\n+            log.error(\"Interrupted\");", "originalCommit": "e029664a0dec10d75673df5c8bd083068acb03d4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzMzNTUyMw==", "url": "https://github.com/nuxeo/nuxeo/pull/4127#discussion_r437335523", "bodyText": "No I don't think so, interrupts aren't error so the location that caught the exception doesn't matter. I'm not sure why we would log at all to be honest.", "author": "efge", "createdAt": "2020-06-09T11:26:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzIyMjc4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDM0MjA1Ng==", "url": "https://github.com/nuxeo/nuxeo/pull/4127#discussion_r450342056", "bodyText": "This is the output of a command-line tool, not trace of a Nuxeo Service, the output can be copy/pasted for support purpose and if someone hit Ctrl-C It is important to know that the command was interrupted, the stack trace is useless.", "author": "bdelbosc", "createdAt": "2020-07-06T16:31:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzIyMjc4Nw=="}], "type": "inlineReview", "revised_code": null}, {"oid": "dea8c60a4be83ea178cbd2078784e23b109de16e", "url": "https://github.com/nuxeo/nuxeo/commit/dea8c60a4be83ea178cbd2078784e23b109de16e", "message": "NXP-29108: Use an explicit transaction timeout for the bulk scroll computation", "committedDate": "2020-07-03T15:43:27Z", "type": "forcePushed"}, {"oid": "2e868d44d4b1a12a98fb54b185451dc52e3d4882", "url": "https://github.com/nuxeo/nuxeo/commit/2e868d44d4b1a12a98fb54b185451dc52e3d4882", "message": "NXP-29108: Use an explicit transaction timeout for the bulk scroll computation", "committedDate": "2020-07-06T10:15:39Z", "type": "forcePushed"}, {"oid": "5bf7ee55ec8bd28b6000ef25edb1d93c8ad83927", "url": "https://github.com/nuxeo/nuxeo/commit/5bf7ee55ec8bd28b6000ef25edb1d93c8ad83927", "message": "NXP-29108: Use an explicit transaction timeout for the bulk scroll computation", "committedDate": "2020-07-06T10:33:43Z", "type": "forcePushed"}, {"oid": "f5eed83150e6695937fb5e73cfeb5f3adfe6ad9e", "url": "https://github.com/nuxeo/nuxeo/commit/f5eed83150e6695937fb5e73cfeb5f3adfe6ad9e", "message": "NXP-29108: Use an explicit transaction timeout for the bulk scroll computation", "committedDate": "2020-07-06T14:01:23Z", "type": "forcePushed"}, {"oid": "714761c943c30efb301d38d2cab2fb1c9c210165", "url": "https://github.com/nuxeo/nuxeo/commit/714761c943c30efb301d38d2cab2fb1c9c210165", "message": "NXP-29108: Use an explicit transaction timeout for the bulk scroll computation", "committedDate": "2020-07-06T16:32:19Z", "type": "forcePushed"}, {"oid": "91a0ac854c646914fe05cb1a69c8200d638fa015", "url": "https://github.com/nuxeo/nuxeo/commit/91a0ac854c646914fe05cb1a69c8200d638fa015", "message": "NXP-29108: Bulk scroller with a long transaction\n\nWe don't want to timeout during a scroll, an explicit long\ntransaction timeout is used.", "committedDate": "2020-07-07T07:11:16Z", "type": "forcePushed"}, {"oid": "991ab47ba59e5a6794d0555591883381aaf6eadd", "url": "https://github.com/nuxeo/nuxeo/commit/991ab47ba59e5a6794d0555591883381aaf6eadd", "message": "NXP-29108: Bulk scroller with a long transaction\n\nWe don't want to timeout during a scroll, an explicit long\ntransaction timeout is used.", "committedDate": "2020-07-07T07:14:17Z", "type": "forcePushed"}, {"oid": "355ba62dad1d0d6732ba9878f0cd16999f55d16a", "url": "https://github.com/nuxeo/nuxeo/commit/355ba62dad1d0d6732ba9878f0cd16999f55d16a", "message": "NXP-29108: Bulk scroller with a long transaction\n\nWe don't want to timeout during a scroll, an explicit long\ntransaction timeout is used.", "committedDate": "2020-07-07T07:20:32Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDcxNDQyNA==", "url": "https://github.com/nuxeo/nuxeo/pull/4127#discussion_r450714424", "bodyText": "since and final?", "author": "troger", "createdAt": "2020-07-07T08:59:42Z", "path": "modules/core/nuxeo-core-bulk/src/main/java/org/nuxeo/ecm/core/bulk/BulkAdminServiceImpl.java", "diffHunk": "@@ -47,11 +47,15 @@\n \n     public static final String BULK_SCROLL_PRODUCE_IMMEDIATE_PROPERTY = \"nuxeo.core.bulk.scroller.produceImmediate\";\n \n-\n     public static final int DEFAULT_SCROLL_SIZE = 100;\n \n     public static final int DEFAULT_SCROLL_KEEP_ALIVE = 60;\n \n+    // @since 11.2\n+    public static final String BULK_SCROLL_TRANSACTION_TIMEOUT_PROPERTY = \"nuxeo.core.bulk.scroller.transactionTimeout\";\n+\n+    public static Duration DEFAULT_SCROLL_TRANSACTION_TIMEOUT = Duration.ofDays(2);", "originalCommit": "355ba62dad1d0d6732ba9878f0cd16999f55d16a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1282d86ec6a72b7b934d9e4901b4e034620ae5f8", "chunk": "diff --git a/modules/core/nuxeo-core-bulk/src/main/java/org/nuxeo/ecm/core/bulk/BulkAdminServiceImpl.java b/modules/core/nuxeo-core-bulk/src/main/java/org/nuxeo/ecm/core/bulk/BulkAdminServiceImpl.java\nindex d57dc789754..620eb9ae5dd 100644\n--- a/modules/core/nuxeo-core-bulk/src/main/java/org/nuxeo/ecm/core/bulk/BulkAdminServiceImpl.java\n+++ b/modules/core/nuxeo-core-bulk/src/main/java/org/nuxeo/ecm/core/bulk/BulkAdminServiceImpl.java\n\n@@ -47,15 +47,11 @@ public class BulkAdminServiceImpl implements BulkAdminService {\n \n     public static final String BULK_SCROLL_PRODUCE_IMMEDIATE_PROPERTY = \"nuxeo.core.bulk.scroller.produceImmediate\";\n \n+\n     public static final int DEFAULT_SCROLL_SIZE = 100;\n \n     public static final int DEFAULT_SCROLL_KEEP_ALIVE = 60;\n \n-    // @since 11.2\n-    public static final String BULK_SCROLL_TRANSACTION_TIMEOUT_PROPERTY = \"nuxeo.core.bulk.scroller.transactionTimeout\";\n-\n-    public static Duration DEFAULT_SCROLL_TRANSACTION_TIMEOUT = Duration.ofDays(2);\n-\n     public static final Duration STOP_DURATION = Duration.ofSeconds(1);\n \n     protected final Map<String, BulkActionDescriptor> descriptors;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDcxNzU1Mg==", "url": "https://github.com/nuxeo/nuxeo/pull/4127#discussion_r450717552", "bodyText": "since", "author": "troger", "createdAt": "2020-07-07T09:05:05Z", "path": "modules/runtime/nuxeo-stream/src/main/java/org/nuxeo/lib/stream/tools/command/PositionCommand.java", "diffHunk": "@@ -59,6 +59,8 @@\n \n     public static final String TO_WATERMARK_OPT = \"to-watermark\";\n \n+    public static final String TO_OFFSET_OPT = \"to-offset\";", "originalCommit": "355ba62dad1d0d6732ba9878f0cd16999f55d16a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1282d86ec6a72b7b934d9e4901b4e034620ae5f8", "chunk": "diff --git a/modules/runtime/nuxeo-stream/src/main/java/org/nuxeo/lib/stream/tools/command/PositionCommand.java b/modules/runtime/nuxeo-stream/src/main/java/org/nuxeo/lib/stream/tools/command/PositionCommand.java\nindex 36d2fdd4237..b6d3f62c810 100644\n--- a/modules/runtime/nuxeo-stream/src/main/java/org/nuxeo/lib/stream/tools/command/PositionCommand.java\n+++ b/modules/runtime/nuxeo-stream/src/main/java/org/nuxeo/lib/stream/tools/command/PositionCommand.java\n\n@@ -59,6 +59,7 @@ public class PositionCommand extends Command {\n \n     public static final String TO_WATERMARK_OPT = \"to-watermark\";\n \n+    // @since 11.2\n     public static final String TO_OFFSET_OPT = \"to-offset\";\n \n     protected static long getTimestampFromDate(String dateIso8601) {\n"}}, {"oid": "1282d86ec6a72b7b934d9e4901b4e034620ae5f8", "url": "https://github.com/nuxeo/nuxeo/commit/1282d86ec6a72b7b934d9e4901b4e034620ae5f8", "message": "NXP-29198: Enable to move a consumer group to a specific offset", "committedDate": "2020-07-07T10:33:33Z", "type": "commit"}, {"oid": "e92a10eca54289bb5fa6f7ab1da174008ce6d0bf", "url": "https://github.com/nuxeo/nuxeo/commit/e92a10eca54289bb5fa6f7ab1da174008ce6d0bf", "message": "NXP-29198: Support codec for stream.sh position to-watermark", "committedDate": "2020-07-07T10:33:33Z", "type": "commit"}, {"oid": "f0c4b02ae5857141eed47eae4166a90c4bb67f1d", "url": "https://github.com/nuxeo/nuxeo/commit/f0c4b02ae5857141eed47eae4166a90c4bb67f1d", "message": "NXP-29198: Add a quiet option to stream.sh lag command\n\nIt is easier to pinpoint consumer groups that lag.", "committedDate": "2020-07-07T10:33:33Z", "type": "commit"}, {"oid": "0323b13ed2328a1755213cb8468e8e27a0d7c20e", "url": "https://github.com/nuxeo/nuxeo/commit/0323b13ed2328a1755213cb8468e8e27a0d7c20e", "message": "NXP-28877: Use namespace also in tools and unit test", "committedDate": "2020-07-07T10:33:33Z", "type": "commit"}, {"oid": "1ed5e11a947bf8ad943dd0ac0e48c7ec74651eab", "url": "https://github.com/nuxeo/nuxeo/commit/1ed5e11a947bf8ad943dd0ac0e48c7ec74651eab", "message": "NXP-28877: Use a more compact Name rendering\n\nBecause toString is used on stream.sh tool output.", "committedDate": "2020-07-07T10:33:33Z", "type": "commit"}, {"oid": "22464cc688e04e419b00c9327f8607f6bb46d08e", "url": "https://github.com/nuxeo/nuxeo/commit/22464cc688e04e419b00c9327f8607f6bb46d08e", "message": "NXP-29108: Bulk scroller with a long transaction\n\nWe don't want to timeout during a scroll, an explicit long\ntransaction timeout is used.", "committedDate": "2020-07-07T10:33:33Z", "type": "commit"}, {"oid": "22464cc688e04e419b00c9327f8607f6bb46d08e", "url": "https://github.com/nuxeo/nuxeo/commit/22464cc688e04e419b00c9327f8607f6bb46d08e", "message": "NXP-29108: Bulk scroller with a long transaction\n\nWe don't want to timeout during a scroll, an explicit long\ntransaction timeout is used.", "committedDate": "2020-07-07T10:33:33Z", "type": "forcePushed"}]}