{"pr_number": 3674, "pr_title": "fix-NXP-28443-tags-trashed-documents", "pr_createdAt": "2020-01-16T21:27:20Z", "pr_url": "https://github.com/nuxeo/nuxeo/pull/3674", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzY2MjUzNA==", "url": "https://github.com/nuxeo/nuxeo/pull/3674#discussion_r367662534", "bodyText": "I see it's just a copy/paste of similar code above, but note that you can do just file.refresh() instead.", "author": "efge", "createdAt": "2020-01-16T21:36:05Z", "path": "nuxeo-features/nuxeo-platform-tag-service/nuxeo-platform-tag-core/src/test/java/org/nuxeo/ecm/platform/tag/AbstractTestTagService.java", "diffHunk": "@@ -194,12 +194,14 @@ public void testUntagOnTrash() {\n         // trash doc\n         Framework.getService(TrashService.class).trashDocument(file);\n \n-        // wait for async tag removal\n-        coreFeature.waitForAsyncCompletion();\n+        // wait for async tag listener\n+        txFeature.nextTransaction();\n \n-        // check no more tag\n+        // check tag is still present\n+        file = session.getDocument(file.getRef());", "originalCommit": "522b294cfb14de53029f5c5f0b0baf6336db5411", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzg0NTI4NQ==", "url": "https://github.com/nuxeo/nuxeo/pull/3674#discussion_r367845285", "bodyText": "\ud83d\udc4d\nIs this the right way to do it now? (just asking)\nIf yes, I will change my code and cleanup the whole file.", "author": "troger", "createdAt": "2020-01-17T09:40:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzY2MjUzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzkwNTU0OA==", "url": "https://github.com/nuxeo/nuxeo/pull/3674#discussion_r367905548", "bodyText": "They're equivalent but refresh is shorter and better shows intent so we might as well use it yes. Note that there's probably dozens of other test files with the old way too...", "author": "efge", "createdAt": "2020-01-17T12:08:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzY2MjUzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzkyNjMxMQ==", "url": "https://github.com/nuxeo/nuxeo/pull/3674#discussion_r367926311", "bodyText": "\ud83d\udc4d\nProbably yes, but I will just handle this one \ud83d\ude2c", "author": "troger", "createdAt": "2020-01-17T13:07:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzY2MjUzNA=="}], "type": "inlineReview", "revised_code": {"commit": "2f1b2fd82f7a9fdc4183592da203f722a51e4d9f", "chunk": "diff --git a/nuxeo-features/nuxeo-platform-tag-service/nuxeo-platform-tag-core/src/test/java/org/nuxeo/ecm/platform/tag/AbstractTestTagService.java b/nuxeo-features/nuxeo-platform-tag-service/nuxeo-platform-tag-core/src/test/java/org/nuxeo/ecm/platform/tag/AbstractTestTagService.java\nindex e5b404260ce..e32e9f979a5 100644\n--- a/nuxeo-features/nuxeo-platform-tag-service/nuxeo-platform-tag-core/src/test/java/org/nuxeo/ecm/platform/tag/AbstractTestTagService.java\n+++ b/nuxeo-features/nuxeo-platform-tag-service/nuxeo-platform-tag-core/src/test/java/org/nuxeo/ecm/platform/tag/AbstractTestTagService.java\n\n@@ -194,14 +193,12 @@ public abstract class AbstractTestTagService {\n         // trash doc\n         Framework.getService(TrashService.class).trashDocument(file);\n \n-        // wait for async tag listener\n-        txFeature.nextTransaction();\n+        // wait for async tag removal\n+        coreFeature.waitForAsyncCompletion();\n \n-        // check tag is still present\n-        file = session.getDocument(file.getRef());\n-        assertTrue(file.isTrashed());\n+        // check no more tag\n         tags = tagService.getTags(session, file1Id);\n-        assertEquals(Collections.singleton(\"mytag\"), tags);\n+        assertEquals(Collections.emptySet(), tags);\n     }\n \n     @Test\n"}}, {"oid": "2f1b2fd82f7a9fdc4183592da203f722a51e4d9f", "url": "https://github.com/nuxeo/nuxeo/commit/2f1b2fd82f7a9fdc4183592da203f722a51e4d9f", "message": "NXP-28443: cleanup/format", "committedDate": "2020-01-17T13:16:59Z", "type": "commit"}, {"oid": "f803735d11d3f9953f5c554c14ab6844dcfd99de", "url": "https://github.com/nuxeo/nuxeo/commit/f803735d11d3f9953f5c554c14ab6844dcfd99de", "message": "NXP-28443: do not remove tags when trashing a document", "committedDate": "2020-01-17T13:17:39Z", "type": "commit"}, {"oid": "f803735d11d3f9953f5c554c14ab6844dcfd99de", "url": "https://github.com/nuxeo/nuxeo/commit/f803735d11d3f9953f5c554c14ab6844dcfd99de", "message": "NXP-28443: do not remove tags when trashing a document", "committedDate": "2020-01-17T13:17:39Z", "type": "forcePushed"}]}