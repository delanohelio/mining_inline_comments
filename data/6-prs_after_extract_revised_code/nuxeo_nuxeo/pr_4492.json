{"pr_number": 4492, "pr_title": "Feature NXP-29836 gcp chunk upload", "pr_createdAt": "2020-11-24T12:23:54Z", "pr_url": "https://github.com/nuxeo/nuxeo/pull/4492", "timeline": [{"oid": "634b38eb68313789d43cc5f15bcd019667fcb59c", "url": "https://github.com/nuxeo/nuxeo/commit/634b38eb68313789d43cc5f15bcd019667fcb59c", "message": "NXP-29836: Cleanup / Format", "committedDate": "2020-11-24T09:58:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTUwNzg2Nw==", "url": "https://github.com/nuxeo/nuxeo/pull/4492#discussion_r529507867", "bodyText": "Mo -> MB", "author": "efge", "createdAt": "2020-11-24T12:28:15Z", "path": "modules/core/nuxeo-core-binarymanager-cloud/nuxeo-core-binarymanager-gcp/src/main/java/org/nuxeo/ecm/core/storage/gcp/GoogleStorageBinaryManager.java", "diffHunk": "@@ -76,6 +79,16 @@\n \n     public static final String BUCKET_PREFIX_PROPERTY = \"storage.bucket_prefix\";\n \n+    /** @since 11.4 */\n+    public static final String UPLOAD_CHUNK_SIZE_PROPERTY = \"storage.upload.chunk.size\";\n+\n+    /**\n+     * Default is taken from {@link com.google.cloud.BaseWriteChannel}.\n+     *\n+     * @since 11.4\n+     */\n+    public static final int DEFAULT_UPLOAD_CHUNK_SIZE = 2048 * 1024; // 2 Mo", "originalCommit": "9aa9d8476c28e3627c5f431f546eec5349dfdd49", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ab5d776c5b692fcb89dfd2b49cea92bcd0cfa0ad", "chunk": "diff --git a/modules/core/nuxeo-core-binarymanager-cloud/nuxeo-core-binarymanager-gcp/src/main/java/org/nuxeo/ecm/core/storage/gcp/GoogleStorageBinaryManager.java b/modules/core/nuxeo-core-binarymanager-cloud/nuxeo-core-binarymanager-gcp/src/main/java/org/nuxeo/ecm/core/storage/gcp/GoogleStorageBinaryManager.java\nindex 5320e0a6bd3..caa236c25c3 100644\n--- a/modules/core/nuxeo-core-binarymanager-cloud/nuxeo-core-binarymanager-gcp/src/main/java/org/nuxeo/ecm/core/storage/gcp/GoogleStorageBinaryManager.java\n+++ b/modules/core/nuxeo-core-binarymanager-cloud/nuxeo-core-binarymanager-gcp/src/main/java/org/nuxeo/ecm/core/storage/gcp/GoogleStorageBinaryManager.java\n\n@@ -87,7 +86,7 @@ public class GoogleStorageBinaryManager extends AbstractCloudBinaryManager {\n      *\n      * @since 11.4\n      */\n-    public static final int DEFAULT_UPLOAD_CHUNK_SIZE = 2048 * 1024; // 2 Mo\n+    public static final int DEFAULT_UPLOAD_CHUNK_SIZE = 2048 * 1024; // 2 MB\n \n     public static final String PROJECT_ID_PROPERTY = \"project\";\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTUxMTM5OA==", "url": "https://github.com/nuxeo/nuxeo/pull/4492#discussion_r529511398", "bodyText": "bufferLength definition can be moved inside the try.\nProbably buffer too.", "author": "efge", "createdAt": "2020-11-24T12:34:29Z", "path": "modules/core/nuxeo-core-binarymanager-cloud/nuxeo-core-binarymanager-gcp/src/main/java/org/nuxeo/ecm/core/storage/gcp/GoogleStorageBinaryManager.java", "diffHunk": "@@ -186,8 +203,14 @@ public void storeFile(String digest, File file) {\n             String key = bucketPrefix + digest;\n             // try to get the blob's metadata to check if it exists\n             if (bucket.get(key) == null) {\n-                try (var fis = new FileInputStream(file)) {\n-                    bucket.create(key, fis);\n+                int bufferLength;", "originalCommit": "9aa9d8476c28e3627c5f431f546eec5349dfdd49", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ab5d776c5b692fcb89dfd2b49cea92bcd0cfa0ad", "chunk": "diff --git a/modules/core/nuxeo-core-binarymanager-cloud/nuxeo-core-binarymanager-gcp/src/main/java/org/nuxeo/ecm/core/storage/gcp/GoogleStorageBinaryManager.java b/modules/core/nuxeo-core-binarymanager-cloud/nuxeo-core-binarymanager-gcp/src/main/java/org/nuxeo/ecm/core/storage/gcp/GoogleStorageBinaryManager.java\nindex 5320e0a6bd3..caa236c25c3 100644\n--- a/modules/core/nuxeo-core-binarymanager-cloud/nuxeo-core-binarymanager-gcp/src/main/java/org/nuxeo/ecm/core/storage/gcp/GoogleStorageBinaryManager.java\n+++ b/modules/core/nuxeo-core-binarymanager-cloud/nuxeo-core-binarymanager-gcp/src/main/java/org/nuxeo/ecm/core/storage/gcp/GoogleStorageBinaryManager.java\n\n@@ -203,10 +200,10 @@ public class GoogleStorageBinaryManager extends AbstractCloudBinaryManager {\n             String key = bucketPrefix + digest;\n             // try to get the blob's metadata to check if it exists\n             if (bucket.get(key) == null) {\n-                int bufferLength;\n-                byte[] buffer = new byte[chunkSize];\n                 try (var is = new BufferedInputStream(new FileInputStream(file));\n                         var writer = storage.writer(BlobInfo.newBuilder(bucketName, key).build())) {\n+                    int bufferLength;\n+                    byte[] buffer = new byte[chunkSize];\n                     writer.setChunkSize(chunkSize);\n                     while ((bufferLength = is.read(buffer)) > 0) {\n                         writer.write(ByteBuffer.wrap(buffer, 0, bufferLength));\n"}}, {"oid": "ab5d776c5b692fcb89dfd2b49cea92bcd0cfa0ad", "url": "https://github.com/nuxeo/nuxeo/commit/ab5d776c5b692fcb89dfd2b49cea92bcd0cfa0ad", "message": "NXP-29836: Fix gcp-credentials.json retrieval when property is empty", "committedDate": "2020-11-24T12:57:32Z", "type": "forcePushed"}, {"oid": "746a434b58224a82e5dc43a2e3cd2ba1b853fb57", "url": "https://github.com/nuxeo/nuxeo/commit/746a434b58224a82e5dc43a2e3cd2ba1b853fb57", "message": "NXP-29836: Upload to GCS by chunks", "committedDate": "2020-11-24T13:08:56Z", "type": "commit"}, {"oid": "4b980b16ad5ac7087cee994d0e4c85938923a499", "url": "https://github.com/nuxeo/nuxeo/commit/4b980b16ad5ac7087cee994d0e4c85938923a499", "message": "NXP-29836: Fix gcp-credentials.json retrieval when property is empty", "committedDate": "2020-11-24T13:08:59Z", "type": "commit"}, {"oid": "4b980b16ad5ac7087cee994d0e4c85938923a499", "url": "https://github.com/nuxeo/nuxeo/commit/4b980b16ad5ac7087cee994d0e4c85938923a499", "message": "NXP-29836: Fix gcp-credentials.json retrieval when property is empty", "committedDate": "2020-11-24T13:08:59Z", "type": "forcePushed"}]}