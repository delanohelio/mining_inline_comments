{"pr_number": 2022, "pr_title": "[JBPM-9015] KIE-Server rendererd forms bind data to incorrect process variable names", "pr_createdAt": "2020-02-20T08:25:48Z", "pr_url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2022", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTg2NjE2Mw==", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2022#discussion_r381866163", "bodyText": "could we use this org.kie.server.services.jbpm.ui.form.render.model.FormInstance.getNestedForm(String) instead here?\nmeaning topLevelForm..getNestedForm(form.getId())", "author": "mswiderski", "createdAt": "2020-02-20T09:06:58Z", "path": "kie-server-parent/kie-server-services/kie-server-services-jbpm-ui/src/main/java/org/kie/server/services/jbpm/ui/form/render/AbstractFormRenderer.java", "diffHunk": "@@ -293,16 +293,21 @@ protected void processFormLayout(FormInstance topLevelForm,\n             List<String> scriptDataList) {\n         FormLayout layout = form.getLayout();\n         \n+\n         if (form.getModel().getClassName() != null && wrapJson) {\n-            jsonTemplate                \n-                .append(\"'\")\n-                .append(form.getModel().getName())\n-                .append(\"' : \")\n-                .append(\"{\")\n-                .append(\"'\")\n-                .append(form.getModel().getClassName())                \n-                .append(\"' : \")\n-                .append(\"{\");\n+            Optional<FormField> fieldForm = topLevelForm.getFields().stream().filter(e -> e.getNestedForm().equals(form.getId())).findAny();", "originalCommit": "1285834db829434f945a93c1cca9b9d60bb807fb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTg5NjQwMg==", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2022#discussion_r381896402", "bodyText": "I am lost with this comment.\nfieldForm.getNestedForm().equals(form.getId()) is not equivalent to\ntopLevelForm..getNestedForm(form.getId())\nwhat exactly you want to change ?", "author": "elguardian", "createdAt": "2020-02-20T10:00:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTg2NjE2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTk1MDYwNw==", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2022#discussion_r381950607", "bodyText": "wouldn't getNestedForm return the form or null for given formId? U mean to replace the entire stream, filter, etc", "author": "mswiderski", "createdAt": "2020-02-20T11:48:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTg2NjE2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjAyNTU3MA==", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2022#discussion_r382025570", "bodyText": "The idea is to find the binding in the top level form. Each field has the nested form id that belongs to (AFAIK)", "author": "elguardian", "createdAt": "2020-02-20T14:16:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTg2NjE2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjAyNjU1OA==", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2022#discussion_r382026558", "bodyText": "there should be a resolver that can look through all children forms so might be able to find any that is defined for the top level one", "author": "mswiderski", "createdAt": "2020-02-20T14:18:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTg2NjE2Mw=="}], "type": "inlineReview", "revised_code": {"commit": "c7e923ede34e3aed75b2ab133cd2b4c745ec1364", "chunk": "diff --git a/kie-server-parent/kie-server-services/kie-server-services-jbpm-ui/src/main/java/org/kie/server/services/jbpm/ui/form/render/AbstractFormRenderer.java b/kie-server-parent/kie-server-services/kie-server-services-jbpm-ui/src/main/java/org/kie/server/services/jbpm/ui/form/render/AbstractFormRenderer.java\nindex 08efa5a2f..b0bd5d19b 100644\n--- a/kie-server-parent/kie-server-services/kie-server-services-jbpm-ui/src/main/java/org/kie/server/services/jbpm/ui/form/render/AbstractFormRenderer.java\n+++ b/kie-server-parent/kie-server-services/kie-server-services-jbpm-ui/src/main/java/org/kie/server/services/jbpm/ui/form/render/AbstractFormRenderer.java\n\n@@ -295,7 +295,9 @@ public abstract class AbstractFormRenderer implements FormRenderer {\n         \n \n         if (form.getModel().getClassName() != null && wrapJson) {\n-            Optional<FormField> fieldForm = topLevelForm.getFields().stream().filter(e -> e.getNestedForm().equals(form.getId())).findAny();\n+            Optional<FormField> fieldForm = topLevelForm.getFields().stream()\n+                                                        .filter(e -> e.getNestedForm() != null && e.getNestedForm().equals(form.getId()))\n+                                                        .findAny();\n             jsonTemplate.append(\"'\");\n             if (fieldForm.isPresent()) {\n                 jsonTemplate.append(fieldForm.get().getBinding());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTg2NjU3Mg==", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2022#discussion_r381866572", "bodyText": "this would be ideal to be already added to the FormModel class next to classname and name. Have you looked if this can be achieved?", "author": "mswiderski", "createdAt": "2020-02-20T09:07:43Z", "path": "kie-server-parent/kie-server-services/kie-server-services-jbpm-ui/src/main/java/org/kie/server/services/jbpm/ui/form/render/AbstractFormRenderer.java", "diffHunk": "@@ -293,16 +293,21 @@ protected void processFormLayout(FormInstance topLevelForm,\n             List<String> scriptDataList) {\n         FormLayout layout = form.getLayout();\n         \n+\n         if (form.getModel().getClassName() != null && wrapJson) {\n-            jsonTemplate                \n-                .append(\"'\")\n-                .append(form.getModel().getName())\n-                .append(\"' : \")\n-                .append(\"{\")\n-                .append(\"'\")\n-                .append(form.getModel().getClassName())                \n-                .append(\"' : \")\n-                .append(\"{\");\n+            Optional<FormField> fieldForm = topLevelForm.getFields().stream().filter(e -> e.getNestedForm().equals(form.getId())).findAny();\n+            jsonTemplate.append(\"'\");\n+            if (fieldForm.isPresent()) {\n+                jsonTemplate.append(fieldForm.get().getBinding());", "originalCommit": "1285834db829434f945a93c1cca9b9d60bb807fb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTg5NjY2MA==", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2022#discussion_r381896660", "bodyText": "The problem is that FormModel is \"clean\" in the sense that the binding is introduced in the top level form and not here so you only have local information. Those comes from unmarshalling files.", "author": "elguardian", "createdAt": "2020-02-20T10:01:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTg2NjU3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTk1MDc3MA==", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2022#discussion_r381950770", "bodyText": "ok, fair enough", "author": "mswiderski", "createdAt": "2020-02-20T11:48:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTg2NjU3Mg=="}], "type": "inlineReview", "revised_code": {"commit": "c7e923ede34e3aed75b2ab133cd2b4c745ec1364", "chunk": "diff --git a/kie-server-parent/kie-server-services/kie-server-services-jbpm-ui/src/main/java/org/kie/server/services/jbpm/ui/form/render/AbstractFormRenderer.java b/kie-server-parent/kie-server-services/kie-server-services-jbpm-ui/src/main/java/org/kie/server/services/jbpm/ui/form/render/AbstractFormRenderer.java\nindex 08efa5a2f..b0bd5d19b 100644\n--- a/kie-server-parent/kie-server-services/kie-server-services-jbpm-ui/src/main/java/org/kie/server/services/jbpm/ui/form/render/AbstractFormRenderer.java\n+++ b/kie-server-parent/kie-server-services/kie-server-services-jbpm-ui/src/main/java/org/kie/server/services/jbpm/ui/form/render/AbstractFormRenderer.java\n\n@@ -295,7 +295,9 @@ public abstract class AbstractFormRenderer implements FormRenderer {\n         \n \n         if (form.getModel().getClassName() != null && wrapJson) {\n-            Optional<FormField> fieldForm = topLevelForm.getFields().stream().filter(e -> e.getNestedForm().equals(form.getId())).findAny();\n+            Optional<FormField> fieldForm = topLevelForm.getFields().stream()\n+                                                        .filter(e -> e.getNestedForm() != null && e.getNestedForm().equals(form.getId()))\n+                                                        .findAny();\n             jsonTemplate.append(\"'\");\n             if (fieldForm.isPresent()) {\n                 jsonTemplate.append(fieldForm.get().getBinding());\n"}}, {"oid": "c7e923ede34e3aed75b2ab133cd2b4c745ec1364", "url": "https://github.com/kiegroup/droolsjbpm-integration/commit/c7e923ede34e3aed75b2ab133cd2b4c745ec1364", "message": "[JBPM-9015] KIE-Server rendererd forms bind data to incorrect process variable names\n\nAssociate the model with the top nested form field binding name", "committedDate": "2020-02-20T14:27:38Z", "type": "commit"}, {"oid": "c7e923ede34e3aed75b2ab133cd2b4c745ec1364", "url": "https://github.com/kiegroup/droolsjbpm-integration/commit/c7e923ede34e3aed75b2ab133cd2b4c745ec1364", "message": "[JBPM-9015] KIE-Server rendererd forms bind data to incorrect process variable names\n\nAssociate the model with the top nested form field binding name", "committedDate": "2020-02-20T14:27:38Z", "type": "forcePushed"}]}