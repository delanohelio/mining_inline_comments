{"pr_number": 929, "pr_title": "Add trailers after gRPC `BlockingStreamingRoute` response", "pr_createdAt": "2020-01-29T01:31:54Z", "pr_url": "https://github.com/apple/servicetalk/pull/929", "timeline": [{"oid": "a494e36564f7a96765ebc953bbfbc3a355bbc628", "url": "https://github.com/apple/servicetalk/commit/a494e36564f7a96765ebc953bbfbc3a355bbc628", "message": "Add trailers after gRPC `BlockingStreamingRoute` response\n\nMotivation:\n\ngRPC protocol requires server to send trailers after the response\npayload body to notify client about status of this response\nprocessing. We add trailers for all service APIs except\n`BlockingStreamingRoute` when service responds successfully.\n\nModifications:\n\n- Add trailers with `grpc-status: 0` if `BlockingStreamingRoute`\nresponds without errors;\n\nResult:\n\nServer sends complete response with trailers from\n`BlockingStreamingRoute`.", "committedDate": "2020-01-28T19:40:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjUxNzQzMw==", "url": "https://github.com/apple/servicetalk/pull/929#discussion_r372517433", "bodyText": "Did you consider setting a status in grpcPayloadWriter.close() if it is not set?", "author": "NiteshKant", "createdAt": "2020-01-29T17:15:04Z", "path": "servicetalk-grpc-api/src/main/java/io/servicetalk/grpc/api/GrpcRouter.java", "diffHunk": "@@ -444,8 +445,12 @@ public void handle(final HttpServiceContext ctx, final BlockingStreamingHttpRequ\n                             final DefaultGrpcPayloadWriter<Resp> grpcPayloadWriter =\n                                     new DefaultGrpcPayloadWriter<>(response.sendMetaData(serializer));\n                             try {\n+                                // Set status OK before invoking handle methods because users can close PayloadWriter\n+                                final HttpPayloadWriter<Resp> payloadWriter = grpcPayloadWriter.payloadWriter();\n+                                setStatusOk(payloadWriter.trailers(), ctx.executionContext().bufferAllocator());", "originalCommit": "a494e36564f7a96765ebc953bbfbc3a355bbc628", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU1MTMyMg==", "url": "https://github.com/apple/servicetalk/pull/929#discussion_r372551322", "bodyText": "Yes, I considered that approach, but then we have to store the ref for BufferAllocator inside DefaultGrpcPayloadWriter and do a look up for the header before setting OK.\nBecause OK is the most common case and we do not expose trailers in handle method (users can't change them), this approach is good enough.", "author": "idelpivnitskiy", "createdAt": "2020-01-29T18:21:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjUxNzQzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU1ODEwOA==", "url": "https://github.com/apple/servicetalk/pull/929#discussion_r372558108", "bodyText": "this approach is good enough.\n\n\nAgreed, thanks for the explanation", "author": "NiteshKant", "createdAt": "2020-01-29T18:34:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjUxNzQzMw=="}], "type": "inlineReview", "revised_code": null}, {"oid": "e663a6fb2e81b3b90fb1e37674721a178583d500", "url": "https://github.com/apple/servicetalk/commit/e663a6fb2e81b3b90fb1e37674721a178583d500", "message": "few more minor fixes", "committedDate": "2020-01-29T23:07:28Z", "type": "commit"}]}