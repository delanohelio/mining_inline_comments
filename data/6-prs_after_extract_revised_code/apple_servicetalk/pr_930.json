{"pr_number": 930, "pr_title": "Prevent misconfigurations for gRPC router", "pr_createdAt": "2020-02-01T19:41:12Z", "pr_url": "https://github.com/apple/servicetalk/pull/930", "timeline": [{"oid": "aa226d4d79afbefea695dd8c73766a3c31f5a200", "url": "https://github.com/apple/servicetalk/commit/aa226d4d79afbefea695dd8c73766a3c31f5a200", "message": "Prevent misconfigurations for gRPC router\n\nMotivation:\n\ngRPC server allows users to register routes in different ways:\n- using multiple instances of `ServiceFactory`;\n- using `ServiceFactory.Builder` with different\n`GrpcExecutionStrategy` configuration;\n- using `ServiceFactory.Builder` with different API variants;\n\nUsers can accidentally misconfigure the router by registering\nthe same RPC more than once. Currently, gRPC server silently\noverrides the old RPC with the new one. It may lead to\nunexpected behavior in production and hard to diagnose issues.\n\nModifications:\n\n- Throw `IllegalStateException` when users register an RPC for\nthe same path more than one time;\n\nResult:\n\nUsers will be notified at the build time if they registered\nmultiple RPC implementations for the same path.", "committedDate": "2020-02-01T19:40:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDM4NTkyNA==", "url": "https://github.com/apple/servicetalk/pull/930#discussion_r374385924", "bodyText": "nit: rename to mergeRoutes()?", "author": "NiteshKant", "createdAt": "2020-02-03T22:48:34Z", "path": "servicetalk-grpc-api/src/main/java/io/servicetalk/grpc/api/GrpcRouter.java", "diffHunk": "@@ -199,19 +201,26 @@ RouteProviders drainRoutes() {\n             final Map<String, RouteProvider> blockingRoutes = new HashMap<>();\n             final Map<String, RouteProvider> blockingStreamingRoutes = new HashMap<>();\n             for (Builder builder : builders) {\n-                routes.putAll(builder.routes);\n-                streamingRoutes.putAll(builder.streamingRoutes);\n-                blockingRoutes.putAll(builder.blockingRoutes);\n-                blockingStreamingRoutes.putAll(builder.blockingStreamingRoutes);\n+                mergeMaps(routes, builder.routes);\n+                mergeMaps(streamingRoutes, builder.streamingRoutes);\n+                mergeMaps(blockingRoutes, builder.blockingRoutes);\n+                mergeMaps(blockingStreamingRoutes, builder.blockingStreamingRoutes);\n             }\n             return new Builder(routes, streamingRoutes, blockingRoutes, blockingStreamingRoutes);\n         }\n \n+        private static void mergeMaps(final Map<String, RouteProvider> first, final Map<String, RouteProvider> second) {", "originalCommit": "aa226d4d79afbefea695dd8c73766a3c31f5a200", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c2dd3a704ec887197a849eb217fb7d7c17657756", "chunk": "diff --git a/servicetalk-grpc-api/src/main/java/io/servicetalk/grpc/api/GrpcRouter.java b/servicetalk-grpc-api/src/main/java/io/servicetalk/grpc/api/GrpcRouter.java\nindex bff0b7b21..9739b2ad7 100644\n--- a/servicetalk-grpc-api/src/main/java/io/servicetalk/grpc/api/GrpcRouter.java\n+++ b/servicetalk-grpc-api/src/main/java/io/servicetalk/grpc/api/GrpcRouter.java\n\n@@ -201,15 +201,16 @@ final class GrpcRouter {\n             final Map<String, RouteProvider> blockingRoutes = new HashMap<>();\n             final Map<String, RouteProvider> blockingStreamingRoutes = new HashMap<>();\n             for (Builder builder : builders) {\n-                mergeMaps(routes, builder.routes);\n-                mergeMaps(streamingRoutes, builder.streamingRoutes);\n-                mergeMaps(blockingRoutes, builder.blockingRoutes);\n-                mergeMaps(blockingStreamingRoutes, builder.blockingStreamingRoutes);\n+                mergeRoutes(routes, builder.routes);\n+                mergeRoutes(streamingRoutes, builder.streamingRoutes);\n+                mergeRoutes(blockingRoutes, builder.blockingRoutes);\n+                mergeRoutes(blockingStreamingRoutes, builder.blockingStreamingRoutes);\n             }\n             return new Builder(routes, streamingRoutes, blockingRoutes, blockingStreamingRoutes);\n         }\n \n-        private static void mergeMaps(final Map<String, RouteProvider> first, final Map<String, RouteProvider> second) {\n+        private static void mergeRoutes(final Map<String, RouteProvider> first,\n+                                        final Map<String, RouteProvider> second) {\n             for (Map.Entry<String, RouteProvider> entry : second.entrySet()) {\n                 final String path = entry.getKey();\n                 verifyNoOverrides(first.put(path, entry.getValue()), path, emptyMap());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDM4OTc1MQ==", "url": "https://github.com/apple/servicetalk/pull/930#discussion_r374389751", "bodyText": "It is somewhat non-intuitive that we are only checking for one alternative Map when we have 3 more Maps of routes.\nConsider adding a comment to explain that we only assume duplication across blocking and async variant of the same API and not between scalar and streaming.", "author": "NiteshKant", "createdAt": "2020-02-03T22:58:35Z", "path": "servicetalk-grpc-api/src/main/java/io/servicetalk/grpc/api/GrpcRouter.java", "diffHunk": "@@ -247,15 +256,15 @@ public Completable closeAsyncGracefully() {\n                         }\n                     }, strategy -> executionStrategy == null ? strategy : executionStrategy),\n                     () -> toStreaming(route), () -> toRequestStreamingRoute(route),\n-                    () -> toResponseStreamingRoute(route), () -> route, route));\n+                    () -> toResponseStreamingRoute(route), () -> route, route)), path, blockingRoutes);", "originalCommit": "aa226d4d79afbefea695dd8c73766a3c31f5a200", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c2dd3a704ec887197a849eb217fb7d7c17657756", "chunk": "diff --git a/servicetalk-grpc-api/src/main/java/io/servicetalk/grpc/api/GrpcRouter.java b/servicetalk-grpc-api/src/main/java/io/servicetalk/grpc/api/GrpcRouter.java\nindex bff0b7b21..9739b2ad7 100644\n--- a/servicetalk-grpc-api/src/main/java/io/servicetalk/grpc/api/GrpcRouter.java\n+++ b/servicetalk-grpc-api/src/main/java/io/servicetalk/grpc/api/GrpcRouter.java\n\n@@ -256,7 +257,11 @@ final class GrpcRouter {\n                         }\n                     }, strategy -> executionStrategy == null ? strategy : executionStrategy),\n                     () -> toStreaming(route), () -> toRequestStreamingRoute(route),\n-                    () -> toResponseStreamingRoute(route), () -> route, route)), path, blockingRoutes);\n+                    () -> toResponseStreamingRoute(route), () -> route, route)),\n+                    // We only assume duplication across blocking and async variant of the same API and not between\n+                    // aggregated and streaming. Therefore, verify that there is no blocking-aggregated route registered\n+                    // for the same path:\n+                    path, blockingRoutes);\n             return this;\n         }\n \n"}}, {"oid": "c2dd3a704ec887197a849eb217fb7d7c17657756", "url": "https://github.com/apple/servicetalk/commit/c2dd3a704ec887197a849eb217fb7d7c17657756", "message": "Address comments", "committedDate": "2020-02-04T00:26:59Z", "type": "commit"}]}