{"pr_number": 1135, "pr_title": "Provide a public factory for `BiTransportObserver`", "pr_createdAt": "2020-08-25T00:55:05Z", "pr_url": "https://github.com/apple/servicetalk/pull/1135", "timeline": [{"oid": "bc49f19f77dd701e7ead20706863a962756d3ff2", "url": "https://github.com/apple/servicetalk/commit/bc49f19f77dd701e7ead20706863a962756d3ff2", "message": "Provide a public factory for `BiTransportObserver`\n\nMotivation:\n\nUsers who need to report events to two `TransportObserver`s simultaneously\non the server side or who need their own variant of\n`TransportObserverConnectionFactoryFilter` will find it useful.\n\nModifications:\n\n- Move `BiTransportObserver` from `client-api` to `transport-api`;\n- Convert passes first and second observers into safe observers;\n- Add public `TransportObservers.biTransportObserver` factory;\n\nResult:\n\nUsers can easily report events to two `TransportObserver`s.", "committedDate": "2020-08-25T00:54:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjAyMDQ3NQ==", "url": "https://github.com/apple/servicetalk/pull/1135#discussion_r476020475", "bodyText": "For a public API, I would prefer a combine() method with a var-arg and if we want, we can optimize for 2 vs many cases.", "author": "NiteshKant", "createdAt": "2020-08-25T01:00:28Z", "path": "servicetalk-transport-api/src/main/java/io/servicetalk/transport/api/TransportObservers.java", "diffHunk": "@@ -38,4 +38,16 @@ public static TransportObserver asSafeObserver(final TransportObserver observer)\n         }\n         return new CatchAllTransportObserver(observer);\n     }\n+\n+    /**\n+     * Combines two {@link TransportObserver}s into a single {@link TransportObserver}.\n+     *\n+     * @param first the {@link TransportObserver} that will receive events first\n+     * @param second the {@link TransportObserver} that will receive events second\n+     * @return a {@link TransportObserver} that delegates all invocations to the {@code first} and {@code second}\n+     * {@link TransportObserver}s\n+     */\n+    public static TransportObserver biTransportObserver(final TransportObserver first, final TransportObserver second) {", "originalCommit": "bc49f19f77dd701e7ead20706863a962756d3ff2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjA3NTQ3MA==", "url": "https://github.com/apple/servicetalk/pull/1135#discussion_r476075470", "bodyText": "Good idea! Added support for multiple", "author": "idelpivnitskiy", "createdAt": "2020-08-25T02:23:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjAyMDQ3NQ=="}], "type": "inlineReview", "revised_code": {"commit": "e70112b6c8e7e2c7ecf569b34a438282bc212941", "chunk": "diff --git a/servicetalk-transport-api/src/main/java/io/servicetalk/transport/api/TransportObservers.java b/servicetalk-transport-api/src/main/java/io/servicetalk/transport/api/TransportObservers.java\nindex b4e969d79..9f89868df 100644\n--- a/servicetalk-transport-api/src/main/java/io/servicetalk/transport/api/TransportObservers.java\n+++ b/servicetalk-transport-api/src/main/java/io/servicetalk/transport/api/TransportObservers.java\n\n@@ -36,18 +36,27 @@ public final class TransportObservers {\n         if (observer instanceof CatchAllTransportObserver) {\n             return observer;\n         }\n+        if (observer instanceof BiTransportObserver) {\n+            // BiTransportObserver is always safe\n+            return observer;\n+        }\n         return new CatchAllTransportObserver(observer);\n     }\n \n     /**\n-     * Combines two {@link TransportObserver}s into a single {@link TransportObserver}.\n+     * Combines multiple {@link TransportObserver}s into a single {@link TransportObserver}.\n      *\n      * @param first the {@link TransportObserver} that will receive events first\n      * @param second the {@link TransportObserver} that will receive events second\n-     * @return a {@link TransportObserver} that delegates all invocations to the {@code first} and {@code second}\n-     * {@link TransportObserver}s\n+     * @param others additional {@link TransportObserver}s that will receive events\n+     * @return a {@link TransportObserver} that delegates all invocations to the provided {@link TransportObserver}s\n      */\n-    public static TransportObserver biTransportObserver(final TransportObserver first, final TransportObserver second) {\n-        return new BiTransportObserver(first, second);\n+    public static TransportObserver combine(final TransportObserver first, final TransportObserver second,\n+                                            final TransportObserver... others) {\n+        BiTransportObserver bi = new BiTransportObserver(first, second);\n+        for (TransportObserver other : others) {\n+            bi = new BiTransportObserver(bi, other);\n+        }\n+        return bi;\n     }\n }\n"}}, {"oid": "e70112b6c8e7e2c7ecf569b34a438282bc212941", "url": "https://github.com/apple/servicetalk/commit/e70112b6c8e7e2c7ecf569b34a438282bc212941", "message": "Support multiple `TransportObserver`s", "committedDate": "2020-08-25T02:22:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU3OTg1NQ==", "url": "https://github.com/apple/servicetalk/pull/1135#discussion_r476579855", "bodyText": "Why not just have combine(final TransportObserver... observers) ?\nAlso, may be modify the BiTransportObserver to accept an array instead of two observers.", "author": "NiteshKant", "createdAt": "2020-08-25T16:28:54Z", "path": "servicetalk-transport-api/src/main/java/io/servicetalk/transport/api/TransportObservers.java", "diffHunk": "@@ -36,18 +36,27 @@ public static TransportObserver asSafeObserver(final TransportObserver observer)\n         if (observer instanceof CatchAllTransportObserver) {\n             return observer;\n         }\n+        if (observer instanceof BiTransportObserver) {\n+            // BiTransportObserver is always safe\n+            return observer;\n+        }\n         return new CatchAllTransportObserver(observer);\n     }\n \n     /**\n-     * Combines two {@link TransportObserver}s into a single {@link TransportObserver}.\n+     * Combines multiple {@link TransportObserver}s into a single {@link TransportObserver}.\n      *\n      * @param first the {@link TransportObserver} that will receive events first\n      * @param second the {@link TransportObserver} that will receive events second\n-     * @return a {@link TransportObserver} that delegates all invocations to the {@code first} and {@code second}\n-     * {@link TransportObserver}s\n+     * @param others additional {@link TransportObserver}s that will receive events\n+     * @return a {@link TransportObserver} that delegates all invocations to the provided {@link TransportObserver}s\n      */\n-    public static TransportObserver biTransportObserver(final TransportObserver first, final TransportObserver second) {\n-        return new BiTransportObserver(first, second);\n+    public static TransportObserver combine(final TransportObserver first, final TransportObserver second,", "originalCommit": "e70112b6c8e7e2c7ecf569b34a438282bc212941", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU4ODA0Mw==", "url": "https://github.com/apple/servicetalk/pull/1135#discussion_r476588043", "bodyText": "At least two observer are required to combine. Good to highlight that in the API instead of verifying at runtime.\nHaving an array inside BiTransportObserver will require an array inside every observer level, producing boilerplate at every level to traverse the array. Let's start with simplified approach and we can reconsider if necessary.", "author": "idelpivnitskiy", "createdAt": "2020-08-25T16:41:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU3OTg1NQ=="}], "type": "inlineReview", "revised_code": {"commit": "98d29d5a0bcdd581e946e19be7360b19b318a292", "chunk": "diff --git a/servicetalk-transport-api/src/main/java/io/servicetalk/transport/api/TransportObservers.java b/servicetalk-transport-api/src/main/java/io/servicetalk/transport/api/TransportObservers.java\nindex 9f89868df..b5e6269ff 100644\n--- a/servicetalk-transport-api/src/main/java/io/servicetalk/transport/api/TransportObservers.java\n+++ b/servicetalk-transport-api/src/main/java/io/servicetalk/transport/api/TransportObservers.java\n\n@@ -46,17 +48,21 @@ public final class TransportObservers {\n     /**\n      * Combines multiple {@link TransportObserver}s into a single {@link TransportObserver}.\n      *\n-     * @param first the {@link TransportObserver} that will receive events first\n-     * @param second the {@link TransportObserver} that will receive events second\n-     * @param others additional {@link TransportObserver}s that will receive events\n+     * @param other {@link TransportObserver}s to combine\n      * @return a {@link TransportObserver} that delegates all invocations to the provided {@link TransportObserver}s\n      */\n-    public static TransportObserver combine(final TransportObserver first, final TransportObserver second,\n-                                            final TransportObserver... others) {\n-        BiTransportObserver bi = new BiTransportObserver(first, second);\n-        for (TransportObserver other : others) {\n-            bi = new BiTransportObserver(bi, other);\n+    public static TransportObserver combine(final TransportObserver... other) {\n+        switch (other.length) {\n+            case 0:\n+                throw new IllegalArgumentException(\"At least one TransportObserver is required to combine\");\n+            case 1:\n+                return requireNonNull(other[0]);\n+            default:\n+                BiTransportObserver bi = new BiTransportObserver(other[0], other[1]);\n+                for (int i = 2; i < other.length; i++) {\n+                    bi = new BiTransportObserver(bi, other[i]);\n+                }\n+                return bi;\n         }\n-        return bi;\n     }\n }\n"}}, {"oid": "98d29d5a0bcdd581e946e19be7360b19b318a292", "url": "https://github.com/apple/servicetalk/commit/98d29d5a0bcdd581e946e19be7360b19b318a292", "message": "use varargs only", "committedDate": "2020-08-25T21:24:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Njc1MjU0OQ==", "url": "https://github.com/apple/servicetalk/pull/1135#discussion_r476752549", "bodyText": "This is what I was trying to avoid by having first, second, others arguments: http://jtechies.blogspot.com/2012/07/item-42-use-varargs-judiciously.html", "author": "idelpivnitskiy", "createdAt": "2020-08-25T21:28:50Z", "path": "servicetalk-transport-api/src/main/java/io/servicetalk/transport/api/TransportObservers.java", "diffHunk": "@@ -36,6 +38,31 @@ public static TransportObserver asSafeObserver(final TransportObserver observer)\n         if (observer instanceof CatchAllTransportObserver) {\n             return observer;\n         }\n+        if (observer instanceof BiTransportObserver) {\n+            // BiTransportObserver is always safe\n+            return observer;\n+        }\n         return new CatchAllTransportObserver(observer);\n     }\n+\n+    /**\n+     * Combines multiple {@link TransportObserver}s into a single {@link TransportObserver}.\n+     *\n+     * @param other {@link TransportObserver}s to combine\n+     * @return a {@link TransportObserver} that delegates all invocations to the provided {@link TransportObserver}s\n+     */\n+    public static TransportObserver combine(final TransportObserver... other) {\n+        switch (other.length) {\n+            case 0:\n+                throw new IllegalArgumentException(\"At least one TransportObserver is required to combine\");", "originalCommit": "98d29d5a0bcdd581e946e19be7360b19b318a292", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Njc2NjUzNA==", "url": "https://github.com/apple/servicetalk/pull/1135#discussion_r476766534", "bodyText": "I think this is OK and inline with what we do elsewhere:\nhttps://github.com/apple/servicetalk/blob/main/servicetalk-concurrent-api/src/main/java/io/servicetalk/concurrent/api/MergeCompletable.java#L41", "author": "NiteshKant", "createdAt": "2020-08-25T21:45:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Njc1MjU0OQ=="}], "type": "inlineReview", "revised_code": null}]}