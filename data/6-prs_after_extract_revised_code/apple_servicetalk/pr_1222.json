{"pr_number": 1222, "pr_title": "Publisher#flatMapConcatIterable drain demand on onNext exception", "pr_createdAt": "2020-11-18T22:49:43Z", "pr_url": "https://github.com/apple/servicetalk/pull/1222", "timeline": [{"oid": "2417d2455560767d1d8121c71fe5db7e27f87fd3", "url": "https://github.com/apple/servicetalk/commit/2417d2455560767d1d8121c71fe5db7e27f87fd3", "message": "Publisher#flatMapConcatIterable drain demand on onNext exception\n\nMotivation:\nPublisher#flatMapConcatIterable rethrows any exceptions from donwstream\nonNext delivery, but it does not attempt to drain pending demand.\nBecause this operator holds on to demand internally (e.g. requests 1\nafter each element is processed) that may result in deadlock due to\ndemand being swallowed in the event of exception and upstream\nrecoverWith continues control flow.\n\nModifications:\n- PublisherConcatMapIterable should attempt to request more from the\nsubscription if demand is still pending.\n- Offloaders should dispatch exception before cancellation. This will\nallow control flow to get a more meaningful exception based upon\napplication control flow (e.g. instead of CancellationException).\n\nResult:\nPublisher#flatMapConcatIterable does not swallow demand in the event of\nexceptions and can be used with upstream recoverWith operators.", "committedDate": "2020-11-18T22:44:23Z", "type": "commit"}, {"oid": "d2a7a0c9e0928c57874ce9f18083767cad83dc41", "url": "https://github.com/apple/servicetalk/commit/d2a7a0c9e0928c57874ce9f18083767cad83dc41", "message": "fix log statment to use the exception", "committedDate": "2020-11-18T22:50:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjUyMDIyOQ==", "url": "https://github.com/apple/servicetalk/pull/1222#discussion_r526520229", "bodyText": "Inside sendOnErrorToOriginal, it looks like we should do the opposite:\n        private void sendOnErrorToOriginal(final Throwable throwable) {\n            try {\n                original.onError(throwable);\n            } catch (Throwable t) {\n                t.addSuppressed(throwable);\n                LOGGER.error(\"Ignored unexpected exception terminating subscriber: {}.\", original, t);\n            }\n        }\nWDYT?", "author": "idelpivnitskiy", "createdAt": "2020-11-19T00:52:12Z", "path": "servicetalk-concurrent-internal/src/main/java/io/servicetalk/concurrent/internal/ThreadBasedSignalOffloader.java", "diffHunk": "@@ -499,6 +499,7 @@ public void sendSignals0() {\n                         original.onNext(signal == NULL_ON_NEXT ? null : uncheckedCast(signal));\n                     } catch (Throwable throwable) {\n                         setTerminated();\n+                        sendOnErrorToOriginal(throwable);", "originalCommit": "d2a7a0c9e0928c57874ce9f18083767cad83dc41", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjUyMTAyOQ==", "url": "https://github.com/apple/servicetalk/pull/1222#discussion_r526521029", "bodyText": "Should we also flip sendCancel/sendOnErrorToOriginal order in lines 485-486?", "author": "idelpivnitskiy", "createdAt": "2020-11-19T00:54:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjUyMDIyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjUzMjg3MQ==", "url": "https://github.com/apple/servicetalk/pull/1222#discussion_r526532871", "bodyText": "I don't think addSuppressed provides much value here, I would be in favor of removing it but lets do this in a followup PR.", "author": "Scottmitch", "createdAt": "2020-11-19T01:30:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjUyMDIyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjUzNzkxNw==", "url": "https://github.com/apple/servicetalk/pull/1222#discussion_r526537917", "bodyText": "actually now that you mention safeOnError in the other comment ... I will take a pass here and update the code to use the common utilities.", "author": "Scottmitch", "createdAt": "2020-11-19T01:46:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjUyMDIyOQ=="}], "type": "inlineReview", "revised_code": {"commit": "36a222f7cfaef6d99796b1d4aa985d320c8e88e9", "chunk": "diff --git a/servicetalk-concurrent-internal/src/main/java/io/servicetalk/concurrent/internal/ThreadBasedSignalOffloader.java b/servicetalk-concurrent-internal/src/main/java/io/servicetalk/concurrent/internal/ThreadBasedSignalOffloader.java\nindex 4ccf09ab2..d746a8353 100644\n--- a/servicetalk-concurrent-internal/src/main/java/io/servicetalk/concurrent/internal/ThreadBasedSignalOffloader.java\n+++ b/servicetalk-concurrent-internal/src/main/java/io/servicetalk/concurrent/internal/ThreadBasedSignalOffloader.java\n\n@@ -479,19 +483,17 @@ final class ThreadBasedSignalOffloader implements SignalOffloader, Runnable {\n                     try {\n                         original.onSubscribe(subscription);\n                     } catch (Throwable throwable) {\n-                        LOGGER.error(\"Ignored unexpected exception from onSubscribe. Subscriber: {}, Subscription: {}.\",\n-                                original, subscription, throwable);\n                         setTerminated();\n-                        sendCancel(subscription, null);\n-                        sendOnErrorToOriginal(throwable);\n+                        safeOnError(original, throwable);\n+                        safeCancel(subscription);\n                     }\n                 } else if (signal instanceof TerminalNotification) {\n                     setTerminated();\n                     TerminalNotification terminalNotification = (TerminalNotification) signal;\n                     if (terminalNotification.cause() != null) {\n-                        sendOnErrorToOriginal(terminalNotification.cause());\n+                        safeOnError(original, terminalNotification.cause());\n                     } else {\n-                        sendOnCompleteToOriginal();\n+                        safeOnComplete(original);\n                     }\n                 } else {\n                     try {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjUyMjkzMg==", "url": "https://github.com/apple/servicetalk/pull/1222#discussion_r526522932", "bodyText": "Because we try-catch target.onError(th) invocation, finally is not necessary anymore. Consider using SubscriberUtils.safeOnError for simplicity.", "author": "idelpivnitskiy", "createdAt": "2020-11-19T00:59:50Z", "path": "servicetalk-concurrent-internal/src/main/java/io/servicetalk/concurrent/internal/TaskBasedSignalOffloader.java", "diffHunk": "@@ -358,15 +358,13 @@ public void run() {\n                         } catch (Throwable th) {\n                             clearSignalsFromExecutorThread();\n                             try {\n+                                target.onError(th);\n+                            } catch (Throwable throwable) {\n+                                LOGGER.error(\"Ignored unexpected exception from onError(). Subscriber: {}\", target,\n+                                        throwable);\n+                            } finally {", "originalCommit": "d2a7a0c9e0928c57874ce9f18083767cad83dc41", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "36a222f7cfaef6d99796b1d4aa985d320c8e88e9", "chunk": "diff --git a/servicetalk-concurrent-internal/src/main/java/io/servicetalk/concurrent/internal/TaskBasedSignalOffloader.java b/servicetalk-concurrent-internal/src/main/java/io/servicetalk/concurrent/internal/TaskBasedSignalOffloader.java\nindex 84ce4929f..eb95c29f2 100644\n--- a/servicetalk-concurrent-internal/src/main/java/io/servicetalk/concurrent/internal/TaskBasedSignalOffloader.java\n+++ b/servicetalk-concurrent-internal/src/main/java/io/servicetalk/concurrent/internal/TaskBasedSignalOffloader.java\n\n@@ -357,15 +356,9 @@ final class TaskBasedSignalOffloader implements SignalOffloader {\n                             target.onNext(t);\n                         } catch (Throwable th) {\n                             clearSignalsFromExecutorThread();\n-                            try {\n-                                target.onError(th);\n-                            } catch (Throwable throwable) {\n-                                LOGGER.error(\"Ignored unexpected exception from onError(). Subscriber: {}\", target,\n-                                        throwable);\n-                            } finally {\n-                                assert subscription != null;\n-                                subscription.cancel();\n-                            }\n+                            safeOnError(target, th);\n+                            assert subscription != null;\n+                            safeCancel(subscription);\n                             return; // We can't interact with the queue any more because we terminated, so bail.\n                         }\n                     }\n"}}, {"oid": "36a222f7cfaef6d99796b1d4aa985d320c8e88e9", "url": "https://github.com/apple/servicetalk/commit/36a222f7cfaef6d99796b1d4aa985d320c8e88e9", "message": "use safe methods from SubscriberUtils", "committedDate": "2020-11-19T01:59:31Z", "type": "commit"}]}