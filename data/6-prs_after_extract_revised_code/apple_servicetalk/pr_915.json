{"pr_number": 915, "pr_title": "Generated gRPC interfaces should be annotated as `@FunctionalInterface`", "pr_createdAt": "2020-01-09T10:18:51Z", "pr_url": "https://github.com/apple/servicetalk/pull/915", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTM2MDYxNg==", "url": "https://github.com/apple/servicetalk/pull/915#discussion_r365360616", "bodyText": "This will add annotation only for the Blocking*Rpc interfaces, you should do the same in another forEach above.", "author": "idelpivnitskiy", "createdAt": "2020-01-10T18:05:56Z", "path": "servicetalk-grpc-protoc/src/main/java/io/servicetalk/grpc/protoc/Generator.java", "diffHunk": "@@ -252,6 +252,7 @@ private void addServiceRpcInterfaces(final State state, final TypeSpec.Builder s\n             final FieldSpec.Builder pathSpecBuilder = FieldSpec.builder(String.class, RPC_PATH, PUBLIC, STATIC, FINAL);\n             pathSpecBuilder.initializer(\"$T.$L\", rpcInterface.className, RPC_PATH);\n             final TypeSpec.Builder interfaceSpecBuilder = interfaceBuilder(name)\n+                    .addAnnotation(FunctionalInterface.class)", "originalCommit": "bc2802d2f35daa976654b5a29316bd7f25795fa1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQzMjQyNg==", "url": "https://github.com/apple/servicetalk/pull/915#discussion_r365432426", "bodyText": "done", "author": "volyx", "createdAt": "2020-01-10T21:13:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTM2MDYxNg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTM2MTUwNA==", "url": "https://github.com/apple/servicetalk/pull/915#discussion_r365361504", "bodyText": "Please, prefer assertThat instead of assertNotNull and assertEquals. It produces better exception messages in case of failures.", "author": "idelpivnitskiy", "createdAt": "2020-01-10T18:08:15Z", "path": "servicetalk-grpc-netty/src/test/java/io/servicetalk/grpc/protoc/GeneratorTest.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Copyright \u00a9 2019 Apple Inc. and the ServiceTalk project authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.servicetalk.grpc.protoc;\n+\n+import io.servicetalk.grpc.netty.TesterProto.Tester;\n+import io.servicetalk.grpc.netty.TesterProto.Tester.RpcPaths;\n+\n+import org.junit.Test;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import static io.servicetalk.grpc.protoc.Words.Blocking;\n+import static io.servicetalk.grpc.protoc.Words.Rpc;\n+import static java.lang.Character.toUpperCase;\n+import static java.util.Arrays.stream;\n+import static java.util.stream.Collectors.toList;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertNotNull;\n+\n+public class GeneratorTest {\n+\n+    @Test\n+    public void testGeneratedFunctionalInterfaces() {\n+\n+        final List<String> generatedInterfaces = new ArrayList<>();\n+\n+        for (RpcPaths rpcPath : RpcPaths.values()) {\n+            final String interfaceName = toUpperCase(rpcPath.name().charAt(0)) + rpcPath.name().substring(1);\n+            generatedInterfaces.add(interfaceName + Rpc);\n+            generatedInterfaces.add(Blocking + interfaceName + Rpc);\n+        }\n+\n+        final List<Class<?>> generatedRpcInterfaces = stream(Tester.class.getDeclaredClasses())\n+                .filter(declaredClass -> generatedInterfaces.contains(declaredClass.getSimpleName()))\n+                .collect(toList());\n+\n+        assertEquals(RpcPaths.values().length * 2, generatedRpcInterfaces.size());\n+\n+        for (Class<?> declaredClass : generatedRpcInterfaces) {\n+            assertNotNull(declaredClass.getAnnotation(FunctionalInterface.class));", "originalCommit": "bc2802d2f35daa976654b5a29316bd7f25795fa1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6d8d8788184bc97452c96ca63bf39fe2d9cd3a1f", "chunk": "diff --git a/servicetalk-grpc-netty/src/test/java/io/servicetalk/grpc/protoc/GeneratorTest.java b/servicetalk-grpc-netty/src/test/java/io/servicetalk/grpc/protoc/GeneratorTest.java\nindex 59b9d339e..3a1c50c19 100644\n--- a/servicetalk-grpc-netty/src/test/java/io/servicetalk/grpc/protoc/GeneratorTest.java\n+++ b/servicetalk-grpc-netty/src/test/java/io/servicetalk/grpc/protoc/GeneratorTest.java\n\n@@ -16,42 +16,36 @@\n package io.servicetalk.grpc.protoc;\n \n import io.servicetalk.grpc.netty.TesterProto.Tester;\n-import io.servicetalk.grpc.netty.TesterProto.Tester.RpcPaths;\n \n import org.junit.Test;\n \n-import java.util.ArrayList;\n import java.util.List;\n \n import static io.servicetalk.grpc.protoc.Words.Blocking;\n import static io.servicetalk.grpc.protoc.Words.Rpc;\n-import static java.lang.Character.toUpperCase;\n import static java.util.Arrays.stream;\n import static java.util.stream.Collectors.toList;\n-import static org.junit.Assert.assertEquals;\n-import static org.junit.Assert.assertNotNull;\n+import static org.hamcrest.Matchers.is;\n+import static org.junit.Assert.assertThat;\n \n public class GeneratorTest {\n \n     @Test\n     public void testGeneratedFunctionalInterfaces() {\n \n-        final List<String> generatedInterfaces = new ArrayList<>();\n-\n-        for (RpcPaths rpcPath : RpcPaths.values()) {\n-            final String interfaceName = toUpperCase(rpcPath.name().charAt(0)) + rpcPath.name().substring(1);\n-            generatedInterfaces.add(interfaceName + Rpc);\n-            generatedInterfaces.add(Blocking + interfaceName + Rpc);\n-        }\n-\n         final List<Class<?>> generatedRpcInterfaces = stream(Tester.class.getDeclaredClasses())\n-                .filter(declaredClass -> generatedInterfaces.contains(declaredClass.getSimpleName()))\n+                .filter(declaredClass -> declaredClass.getAnnotation(FunctionalInterface.class) != null\n+                        && !declaredClass.getSimpleName().startsWith(Blocking)\n+                        && declaredClass.getSimpleName().endsWith(Rpc))\n                 .collect(toList());\n \n-        assertEquals(RpcPaths.values().length * 2, generatedRpcInterfaces.size());\n+        final List<Class<?>> generatedBlockingRpcInterfaces = stream(Tester.class.getDeclaredClasses())\n+                .filter(declaredClass -> declaredClass.getAnnotation(FunctionalInterface.class) != null\n+                        && declaredClass.getSimpleName().startsWith(Blocking)\n+                        && declaredClass.getSimpleName().endsWith(Rpc))\n+                .collect(toList());\n \n-        for (Class<?> declaredClass : generatedRpcInterfaces) {\n-            assertNotNull(declaredClass.getAnnotation(FunctionalInterface.class));\n-        }\n+        assertThat(generatedRpcInterfaces.size(), is(4));\n+        assertThat(generatedRpcInterfaces.size(), is(generatedBlockingRpcInterfaces.size()));\n     }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTM2MzI1MA==", "url": "https://github.com/apple/servicetalk/pull/915#discussion_r365363250", "bodyText": "We do not have RpcPaths enum anymore. Looks like you used the old generated code. To regenerate it, use ./gradlew clean classes testClasses.", "author": "idelpivnitskiy", "createdAt": "2020-01-10T18:12:47Z", "path": "servicetalk-grpc-netty/src/test/java/io/servicetalk/grpc/protoc/GeneratorTest.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Copyright \u00a9 2019 Apple Inc. and the ServiceTalk project authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.servicetalk.grpc.protoc;\n+\n+import io.servicetalk.grpc.netty.TesterProto.Tester;\n+import io.servicetalk.grpc.netty.TesterProto.Tester.RpcPaths;\n+\n+import org.junit.Test;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import static io.servicetalk.grpc.protoc.Words.Blocking;\n+import static io.servicetalk.grpc.protoc.Words.Rpc;\n+import static java.lang.Character.toUpperCase;\n+import static java.util.Arrays.stream;\n+import static java.util.stream.Collectors.toList;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertNotNull;\n+\n+public class GeneratorTest {\n+\n+    @Test\n+    public void testGeneratedFunctionalInterfaces() {\n+\n+        final List<String> generatedInterfaces = new ArrayList<>();\n+\n+        for (RpcPaths rpcPath : RpcPaths.values()) {", "originalCommit": "bc2802d2f35daa976654b5a29316bd7f25795fa1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6d8d8788184bc97452c96ca63bf39fe2d9cd3a1f", "chunk": "diff --git a/servicetalk-grpc-netty/src/test/java/io/servicetalk/grpc/protoc/GeneratorTest.java b/servicetalk-grpc-netty/src/test/java/io/servicetalk/grpc/protoc/GeneratorTest.java\nindex 59b9d339e..3a1c50c19 100644\n--- a/servicetalk-grpc-netty/src/test/java/io/servicetalk/grpc/protoc/GeneratorTest.java\n+++ b/servicetalk-grpc-netty/src/test/java/io/servicetalk/grpc/protoc/GeneratorTest.java\n\n@@ -16,42 +16,36 @@\n package io.servicetalk.grpc.protoc;\n \n import io.servicetalk.grpc.netty.TesterProto.Tester;\n-import io.servicetalk.grpc.netty.TesterProto.Tester.RpcPaths;\n \n import org.junit.Test;\n \n-import java.util.ArrayList;\n import java.util.List;\n \n import static io.servicetalk.grpc.protoc.Words.Blocking;\n import static io.servicetalk.grpc.protoc.Words.Rpc;\n-import static java.lang.Character.toUpperCase;\n import static java.util.Arrays.stream;\n import static java.util.stream.Collectors.toList;\n-import static org.junit.Assert.assertEquals;\n-import static org.junit.Assert.assertNotNull;\n+import static org.hamcrest.Matchers.is;\n+import static org.junit.Assert.assertThat;\n \n public class GeneratorTest {\n \n     @Test\n     public void testGeneratedFunctionalInterfaces() {\n \n-        final List<String> generatedInterfaces = new ArrayList<>();\n-\n-        for (RpcPaths rpcPath : RpcPaths.values()) {\n-            final String interfaceName = toUpperCase(rpcPath.name().charAt(0)) + rpcPath.name().substring(1);\n-            generatedInterfaces.add(interfaceName + Rpc);\n-            generatedInterfaces.add(Blocking + interfaceName + Rpc);\n-        }\n-\n         final List<Class<?>> generatedRpcInterfaces = stream(Tester.class.getDeclaredClasses())\n-                .filter(declaredClass -> generatedInterfaces.contains(declaredClass.getSimpleName()))\n+                .filter(declaredClass -> declaredClass.getAnnotation(FunctionalInterface.class) != null\n+                        && !declaredClass.getSimpleName().startsWith(Blocking)\n+                        && declaredClass.getSimpleName().endsWith(Rpc))\n                 .collect(toList());\n \n-        assertEquals(RpcPaths.values().length * 2, generatedRpcInterfaces.size());\n+        final List<Class<?>> generatedBlockingRpcInterfaces = stream(Tester.class.getDeclaredClasses())\n+                .filter(declaredClass -> declaredClass.getAnnotation(FunctionalInterface.class) != null\n+                        && declaredClass.getSimpleName().startsWith(Blocking)\n+                        && declaredClass.getSimpleName().endsWith(Rpc))\n+                .collect(toList());\n \n-        for (Class<?> declaredClass : generatedRpcInterfaces) {\n-            assertNotNull(declaredClass.getAnnotation(FunctionalInterface.class));\n-        }\n+        assertThat(generatedRpcInterfaces.size(), is(4));\n+        assertThat(generatedRpcInterfaces.size(), is(generatedBlockingRpcInterfaces.size()));\n     }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQ1MDg4MA==", "url": "https://github.com/apple/servicetalk/pull/915#discussion_r365450880", "bodyText": "Because we want to test all 4 different API variants and we know that Tester class defines them all, I would make sure that the size of both Lists is 4.", "author": "idelpivnitskiy", "createdAt": "2020-01-10T22:11:51Z", "path": "servicetalk-grpc-netty/src/test/java/io/servicetalk/grpc/protoc/GeneratorTest.java", "diffHunk": "@@ -0,0 +1,52 @@\n+/*\n+ * Copyright \u00a9 2019 Apple Inc. and the ServiceTalk project authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.servicetalk.grpc.protoc;\n+\n+import io.servicetalk.grpc.netty.TesterProto.Tester;\n+\n+import org.junit.Test;\n+\n+import java.util.List;\n+\n+import static io.servicetalk.grpc.protoc.Words.Blocking;\n+import static io.servicetalk.grpc.protoc.Words.Rpc;\n+import static java.util.Arrays.stream;\n+import static java.util.stream.Collectors.toList;\n+import static org.hamcrest.Matchers.greaterThan;\n+import static org.hamcrest.Matchers.is;\n+import static org.junit.Assert.assertThat;\n+\n+public class GeneratorTest {\n+\n+    @Test\n+    public void testGeneratedFunctionalInterfaces() {\n+\n+        final List<Class<?>> generatedRpcInterfaces = stream(Tester.class.getDeclaredClasses())\n+                .filter(declaredClass -> declaredClass.getAnnotation(FunctionalInterface.class) != null\n+                        && !declaredClass.getSimpleName().startsWith(Blocking)\n+                        && declaredClass.getSimpleName().endsWith(Rpc))\n+                .collect(toList());\n+\n+        final List<Class<?>> generatedBlockingRpcInterfaces = stream(Tester.class.getDeclaredClasses())\n+                .filter(declaredClass -> declaredClass.getAnnotation(FunctionalInterface.class) != null\n+                        && declaredClass.getSimpleName().startsWith(Blocking)\n+                        && declaredClass.getSimpleName().endsWith(Rpc))\n+                .collect(toList());\n+\n+        assertThat(generatedRpcInterfaces.size(), greaterThan(0));", "originalCommit": "68170a8261b6b020f5bf20bf1507931cbac86f14", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6d8d8788184bc97452c96ca63bf39fe2d9cd3a1f", "chunk": "diff --git a/servicetalk-grpc-netty/src/test/java/io/servicetalk/grpc/protoc/GeneratorTest.java b/servicetalk-grpc-netty/src/test/java/io/servicetalk/grpc/protoc/GeneratorTest.java\nindex 448c64108..3a1c50c19 100644\n--- a/servicetalk-grpc-netty/src/test/java/io/servicetalk/grpc/protoc/GeneratorTest.java\n+++ b/servicetalk-grpc-netty/src/test/java/io/servicetalk/grpc/protoc/GeneratorTest.java\n\n@@ -25,7 +25,6 @@ import static io.servicetalk.grpc.protoc.Words.Blocking;\n import static io.servicetalk.grpc.protoc.Words.Rpc;\n import static java.util.Arrays.stream;\n import static java.util.stream.Collectors.toList;\n-import static org.hamcrest.Matchers.greaterThan;\n import static org.hamcrest.Matchers.is;\n import static org.junit.Assert.assertThat;\n \n"}}, {"oid": "6d8d8788184bc97452c96ca63bf39fe2d9cd3a1f", "url": "https://github.com/apple/servicetalk/commit/6d8d8788184bc97452c96ca63bf39fe2d9cd3a1f", "message": "Generated gRPC RPC interfaces should be annotated as `@FunctionalInterface` #908\n\nMotivation:\n\nGenerated gRPC RPC interfaces should be annotated as `@FunctionalInterface` #908\n\nModifications:\n\n- add `@FunctionalInterface` to generated interfaces as part of the method addServiceRpcInterfaces()\n- add test scope dependency `servicetalk-grpc-protoc` for `servicetalk-grpc-netty`\n- add `GeneratorTest`\n\nResult:\n\nFixes #908", "committedDate": "2020-01-12T15:59:41Z", "type": "commit"}, {"oid": "6d8d8788184bc97452c96ca63bf39fe2d9cd3a1f", "url": "https://github.com/apple/servicetalk/commit/6d8d8788184bc97452c96ca63bf39fe2d9cd3a1f", "message": "Generated gRPC RPC interfaces should be annotated as `@FunctionalInterface` #908\n\nMotivation:\n\nGenerated gRPC RPC interfaces should be annotated as `@FunctionalInterface` #908\n\nModifications:\n\n- add `@FunctionalInterface` to generated interfaces as part of the method addServiceRpcInterfaces()\n- add test scope dependency `servicetalk-grpc-protoc` for `servicetalk-grpc-netty`\n- add `GeneratorTest`\n\nResult:\n\nFixes #908", "committedDate": "2020-01-12T15:59:41Z", "type": "forcePushed"}]}