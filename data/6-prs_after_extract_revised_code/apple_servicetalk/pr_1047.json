{"pr_number": 1047, "pr_title": "Publisher#flatMapMergeSingle avoid queue if no concurrency", "pr_createdAt": "2020-05-09T23:09:31Z", "pr_url": "https://github.com/apple/servicetalk/pull/1047", "timeline": [{"oid": "030afdc28b89ae5a2dd9000e77741b7e49066633", "url": "https://github.com/apple/servicetalk/commit/030afdc28b89ae5a2dd9000e77741b7e49066633", "message": "Publisher#flatMapMergeSingle avoid queue if no concurrency\n\nMotivation:\nPublisher#flatMapMergeSingle currently enqueues all signals before\nemitting to the downstream Subscriber. Going through the queue leverages\nthe concurrency controls around the queue to prevent concurrent\nemissions and also provides an ordering of emissions. The ordering of\nemissions is only necessary for terminal completion events to ensure we\nprocess all outstanding signals before terminating, and otherwise there\nis no ordering requirements between independent mapped Singles.\n\nModifications:\n- add PublisherFlatMapSingle#tryEmitSignal which supports a fast path\nfor direct emission without going through the queue if there is no\nconcurrency detected.\n\nResult:\nPublisher#flatMapMergeSingle uses less memory and avoids queuing signals\nif no concurrency.", "committedDate": "2020-05-12T20:14:38Z", "type": "commit"}, {"oid": "030afdc28b89ae5a2dd9000e77741b7e49066633", "url": "https://github.com/apple/servicetalk/commit/030afdc28b89ae5a2dd9000e77741b7e49066633", "message": "Publisher#flatMapMergeSingle avoid queue if no concurrency\n\nMotivation:\nPublisher#flatMapMergeSingle currently enqueues all signals before\nemitting to the downstream Subscriber. Going through the queue leverages\nthe concurrency controls around the queue to prevent concurrent\nemissions and also provides an ordering of emissions. The ordering of\nemissions is only necessary for terminal completion events to ensure we\nprocess all outstanding signals before terminating, and otherwise there\nis no ordering requirements between independent mapped Singles.\n\nModifications:\n- add PublisherFlatMapSingle#tryEmitSignal which supports a fast path\nfor direct emission without going through the queue if there is no\nconcurrency detected.\n\nResult:\nPublisher#flatMapMergeSingle uses less memory and avoids queuing signals\nif no concurrency.", "committedDate": "2020-05-12T20:14:38Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTkyNTM1OQ==", "url": "https://github.com/apple/servicetalk/pull/1047#discussion_r425925359", "bodyText": "Do we care about requesting more if sendToTarget() failed? I think we can do without this finally block:\ntry {\n    sendToTarget(item);\n    doDrainPostProcessing(1);\n} finally {", "author": "NiteshKant", "createdAt": "2020-05-15T16:47:41Z", "path": "servicetalk-concurrent-api/src/main/java/io/servicetalk/concurrent/api/PublisherFlatMapSingle.java", "diffHunk": "@@ -248,6 +248,24 @@ private boolean onError0(Throwable throwable, boolean overrideComplete,\n             return false;\n         }\n \n+        private void tryEmitItem(final Object item) {\n+            if (tryAcquireLock(emittingUpdater, this)) { // fast path. no concurrency, avoid the queue and emit.\n+                try {\n+                    try {\n+                        sendToTarget(item);\n+                    } finally {\n+                        doDrainPostProcessing(1);", "originalCommit": "030afdc28b89ae5a2dd9000e77741b7e49066633", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY4NTk5Mg==", "url": "https://github.com/apple/servicetalk/pull/1047#discussion_r427685992", "bodyText": "agreed, I think we can skip it. I will make this consistent with the drainPending loop too.", "author": "Scottmitch", "createdAt": "2020-05-20T01:10:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTkyNTM1OQ=="}], "type": "inlineReview", "revised_code": {"commit": "f1be078f215b645244d110dab7a148363409a41e", "chunk": "diff --git a/servicetalk-concurrent-api/src/main/java/io/servicetalk/concurrent/api/PublisherFlatMapSingle.java b/servicetalk-concurrent-api/src/main/java/io/servicetalk/concurrent/api/PublisherFlatMapSingle.java\nindex 1ea43d927..bb780b6e8 100644\n--- a/servicetalk-concurrent-api/src/main/java/io/servicetalk/concurrent/api/PublisherFlatMapSingle.java\n+++ b/servicetalk-concurrent-api/src/main/java/io/servicetalk/concurrent/api/PublisherFlatMapSingle.java\n\n@@ -251,11 +251,8 @@ final class PublisherFlatMapSingle<T, R> extends AbstractAsynchronousPublisherOp\n         private void tryEmitItem(final Object item) {\n             if (tryAcquireLock(emittingUpdater, this)) { // fast path. no concurrency, avoid the queue and emit.\n                 try {\n-                    try {\n-                        sendToTarget(item);\n-                    } finally {\n-                        doDrainPostProcessing(1);\n-                    }\n+                    sendToTarget(item);\n+                    doDrainPostProcessing(1);\n                 } finally {\n                     if (!releaseLock(emittingUpdater, this)) {\n                         drainPending();\n"}}, {"oid": "f1be078f215b645244d110dab7a148363409a41e", "url": "https://github.com/apple/servicetalk/commit/f1be078f215b645244d110dab7a148363409a41e", "message": "avoid doDrainPostProcessing if exception", "committedDate": "2020-05-20T01:10:15Z", "type": "commit"}]}