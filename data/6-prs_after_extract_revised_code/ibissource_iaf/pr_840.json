{"pr_number": 840, "pr_title": "impl#803 iMessageHandler and Listeners using Message", "pr_createdAt": "2020-06-17T16:54:18Z", "pr_url": "https://github.com/ibissource/iaf/pull/840", "timeline": [{"oid": "532c6a00da18d880d8ba6995ad64618c2a458c71", "url": "https://github.com/ibissource/iaf/commit/532c6a00da18d880d8ba6995ad64618c2a458c71", "message": "IMessageHandler using Message instead of String", "committedDate": "2020-06-17T07:23:54Z", "type": "commit"}, {"oid": "e30c45f993db6c8b8293ab436bda7361f937415f", "url": "https://github.com/ibissource/iaf/commit/e30c45f993db6c8b8293ab436bda7361f937415f", "message": "Fix issues", "committedDate": "2020-06-17T12:08:25Z", "type": "commit"}, {"oid": "e13c56fe3a657eef0ece585118bc59d6207157a5", "url": "https://github.com/ibissource/iaf/commit/e13c56fe3a657eef0ece585118bc59d6207157a5", "message": "Merge branch 'master' into #803_IMessageHandler_using_Message(2)", "committedDate": "2020-06-17T12:14:47Z", "type": "commit"}, {"oid": "362c005fcfed0ef0da6c8f9214dd86845441bc4b", "url": "https://github.com/ibissource/iaf/commit/362c005fcfed0ef0da6c8f9214dd86845441bc4b", "message": "make Listeners use Message", "committedDate": "2020-06-17T16:52:37Z", "type": "commit"}, {"oid": "4306bb287dc91660fb9d38cca8f0707579104426", "url": "https://github.com/ibissource/iaf/commit/4306bb287dc91660fb9d38cca8f0707579104426", "message": "Fix Codacy issues", "committedDate": "2020-06-17T17:01:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjE1NzA2OQ==", "url": "https://github.com/ibissource/iaf/pull/840#discussion_r442157069", "bodyText": "Message.asMessage()", "author": "nielsm5", "createdAt": "2020-06-18T11:27:48Z", "path": "core/src/main/java/nl/nn/adapterframework/cache/CacheAdapterBase.java", "diffHunk": "@@ -102,26 +103,26 @@ public String transformKey(String input, IPipeLineSession session) {\n \t}\n \n \t@Override\n-\tpublic V transformValue(String value, IPipeLineSession session) {\n+\tpublic V transformValue(Message value, IPipeLineSession session) {\n \t\tif (StringUtils.isNotEmpty(getValueInputSessionKey()) && session!=null) {\n-\t\t\tvalue=(String)session.get(getValueInputSessionKey());\n+\t\t\tvalue=Message.asMessage(session.get(getValueInputSessionKey()));\n \t\t}\n \t\tif (valueTp!=null) {\n \t\t\ttry{\n-\t\t\t\tvalue=valueTp.transform(value, null);\n+\t\t\t\tvalue=new Message(valueTp.transform(value, null));", "originalCommit": "4306bb287dc91660fb9d38cca8f0707579104426", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjE2MDkyNA==", "url": "https://github.com/ibissource/iaf/pull/840#discussion_r442160924", "bodyText": "Graag in de warning ook het messageid verwerken zodat het aan iets gecorreleerd kan worden.", "author": "nielsm5", "createdAt": "2020-06-18T11:35:47Z", "path": "core/src/main/java/nl/nn/adapterframework/errormessageformatters/ErrorMessageFormatter.java", "diffHunk": "@@ -92,7 +94,12 @@ public String format(String errorMessage, Throwable t, INamedObject location, St\n \t\t\toriginalMessageXml.addAttribute(\"receivedTime\", new Date(receivedTime).toString());\n \t\t}\n \t\t// originalMessageXml.setCdataValue(originalMessage);\n-\t\toriginalMessageXml.setValue(originalMessage, true);\n+\t\ttry {\n+\t\t\toriginalMessageXml.setValue(originalMessage.asString(), true);\n+\t\t} catch (IOException e) {\n+\t\t\tlog.warn(\"Could not transform originalMessage\",e);", "originalCommit": "4306bb287dc91660fb9d38cca8f0707579104426", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d2001904a1da2b063a2a34eee12c586ef31e1548", "chunk": "diff --git a/core/src/main/java/nl/nn/adapterframework/errormessageformatters/ErrorMessageFormatter.java b/core/src/main/java/nl/nn/adapterframework/errormessageformatters/ErrorMessageFormatter.java\nindex 835fe99e9..ca2c66427 100644\n--- a/core/src/main/java/nl/nn/adapterframework/errormessageformatters/ErrorMessageFormatter.java\n+++ b/core/src/main/java/nl/nn/adapterframework/errormessageformatters/ErrorMessageFormatter.java\n\n@@ -97,7 +97,7 @@ public class ErrorMessageFormatter implements IErrorMessageFormatter {\n \t\ttry {\n \t\t\toriginalMessageXml.setValue(originalMessage.asString(), true);\n \t\t} catch (IOException e) {\n-\t\t\tlog.warn(\"Could not transform originalMessage\",e);\n+\t\t\tlog.warn(\"Could not convert originalMessage for messageId [\"+messageId+\"]\",e);\n \t\t\toriginalMessageXml.setValue(originalMessage.toString(), true);\n \t\t}\n \t\terrorXml.addSubElement(originalMessageXml);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjE2MjA0MQ==", "url": "https://github.com/ibissource/iaf/pull/840#discussion_r442162041", "bodyText": "Is het niet verstanding/handig hier Message.asMessage() te gebruiken?", "author": "nielsm5", "createdAt": "2020-06-18T11:38:10Z", "path": "core/src/main/java/nl/nn/adapterframework/extensions/bis/BisJmsListener.java", "diffHunk": "@@ -204,20 +205,20 @@ public String extractMessageBody(String rawMessageText, Map<String,Object> conte\n \t}\n \n \t@Override\n-\tpublic String prepareReply(String rawReply, Map<String,Object> threadContext) throws ListenerException {\n+\tpublic Message prepareReply(Message rawReply, Map<String,Object> threadContext) throws ListenerException {\n \t\tString originalMessageText = (String) threadContext.get(MESSAGETEXT_KEY);\n \t\tString messageBodyNamespace = (String) threadContext.get(MESSAGEBODYNAMESPACE_KEY);\n-\t\tif (isLayByNamespace() && messageBodyNamespace != null) {\n-\t\t\trawReply = XmlUtils.addRootNamespace(rawReply, messageBodyNamespace);\n-\t\t}\n-\t\tString errorCode = null;\n-\t\tif (StringUtils.isNotEmpty(getErrorCodeSessionKey())) {\n-\t\t\terrorCode = (String) threadContext.get(getErrorCodeSessionKey());\n-\t\t}\n \t\tString messageHeader;\n \t\tString payload;\n-\t\tString result;\n \t\ttry {\n+\t\t\tif (isLayByNamespace() && messageBodyNamespace != null) {\n+\t\t\t\trawReply = new Message(XmlUtils.addRootNamespace(rawReply.asString(), messageBodyNamespace));", "originalCommit": "4306bb287dc91660fb9d38cca8f0707579104426", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d2001904a1da2b063a2a34eee12c586ef31e1548", "chunk": "diff --git a/core/src/main/java/nl/nn/adapterframework/extensions/bis/BisJmsListener.java b/core/src/main/java/nl/nn/adapterframework/extensions/bis/BisJmsListener.java\nindex 861a5b39d..80d96d123 100644\n--- a/core/src/main/java/nl/nn/adapterframework/extensions/bis/BisJmsListener.java\n+++ b/core/src/main/java/nl/nn/adapterframework/extensions/bis/BisJmsListener.java\n\n@@ -208,8 +208,6 @@ public class BisJmsListener extends JmsListener {\n \tpublic Message prepareReply(Message rawReply, Map<String,Object> threadContext) throws ListenerException {\n \t\tString originalMessageText = (String) threadContext.get(MESSAGETEXT_KEY);\n \t\tString messageBodyNamespace = (String) threadContext.get(MESSAGEBODYNAMESPACE_KEY);\n-\t\tString messageHeader;\n-\t\tString payload;\n \t\ttry {\n \t\t\tif (isLayByNamespace() && messageBodyNamespace != null) {\n \t\t\t\trawReply = new Message(XmlUtils.addRootNamespace(rawReply.asString(), messageBodyNamespace));\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjE2MzI0Ng==", "url": "https://github.com/ibissource/iaf/pull/840#discussion_r442163246", "bodyText": "Is het handig om deze methode een Message terug te laten geven? in de super zit een soapwrapper die, hopelijk, ook omgezet wordt naar een message. Het zou zonde zijn als in die methode asString kwam te staan.", "author": "nielsm5", "createdAt": "2020-06-18T11:40:37Z", "path": "core/src/main/java/nl/nn/adapterframework/extensions/bis/BisJmsListener.java", "diffHunk": "@@ -229,7 +230,7 @@ public String prepareReply(String rawReply, Map<String,Object> threadContext) th\n \t\t} catch (Exception e) {\n \t\t\tthrow new ListenerException(e);\n \t\t}\n-\t\treturn super.prepareReply(payload, threadContext, isMessageHeaderInSoapBody() ? null : messageHeader);\n+\t\treturn super.prepareReply(new Message(payload), threadContext, isMessageHeaderInSoapBody() ? null : messageHeader);", "originalCommit": "4306bb287dc91660fb9d38cca8f0707579104426", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d2001904a1da2b063a2a34eee12c586ef31e1548", "chunk": "diff --git a/core/src/main/java/nl/nn/adapterframework/extensions/bis/BisJmsListener.java b/core/src/main/java/nl/nn/adapterframework/extensions/bis/BisJmsListener.java\nindex 861a5b39d..80d96d123 100644\n--- a/core/src/main/java/nl/nn/adapterframework/extensions/bis/BisJmsListener.java\n+++ b/core/src/main/java/nl/nn/adapterframework/extensions/bis/BisJmsListener.java\n\n@@ -219,18 +217,17 @@ public class BisJmsListener extends JmsListener {\n \t\t\t\terrorCode = (String) threadContext.get(getErrorCodeSessionKey());\n \t\t\t}\n \t\t\tString result;\n-\t\t\tmessageHeader = bisUtils.prepareMessageHeader(originalMessageText, isMessageHeaderInSoapBody());\n+\t\t\tString messageHeader = bisUtils.prepareMessageHeader(originalMessageText, isMessageHeaderInSoapBody());\n \t\t\tif (isOmitResult()) {\n \t\t\t\tresult = null;\n \t\t\t} else {\n \t\t\t\tresult = prepareResult(errorCode, threadContext);\n \t\t\t}\n-\t\t\tpayload = bisUtils.prepareReply(rawReply, isMessageHeaderInSoapBody() ? messageHeader : null, result, isResultInPayload());\n-\n+\t\t\tMessage payload = bisUtils.prepareReply(rawReply, isMessageHeaderInSoapBody() ? messageHeader : null, result, isResultInPayload());\n+\t\t\treturn super.prepareReply(payload, threadContext, isMessageHeaderInSoapBody() ? null : messageHeader);\n \t\t} catch (Exception e) {\n \t\t\tthrow new ListenerException(e);\n \t\t}\n-\t\treturn super.prepareReply(new Message(payload), threadContext, isMessageHeaderInSoapBody() ? null : messageHeader);\n \t}\n \n \tpublic String prepareResult(String errorCode, Map<String,Object> threadContext) throws DomBuilderException, IOException, TransformerException {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjE2NjI3Nw==", "url": "https://github.com/ibissource/iaf/pull/840#discussion_r442166277", "bodyText": "Ik snap wat er gebeurd maar vind het stom. Nu wordt een byte[] omgezet naar een String (met de juiste charset) om vervolgens een Message te worken. Is het een idee Message een charset mee te geven?", "author": "nielsm5", "createdAt": "2020-06-18T11:47:03Z", "path": "core/src/main/java/nl/nn/adapterframework/extensions/mqtt/MqttListener.java", "diffHunk": "@@ -164,9 +166,12 @@ public String getIdFromRawMessage(MqttMessage rawMessage, Map<String, Object> co\n \t}\n \n \t@Override\n-\tpublic String getStringFromRawMessage(MqttMessage rawMessage, Map<String, Object> context) throws ListenerException {\n+\tpublic Message extractMessage(MqttMessage rawMessage, Map<String, Object> context) throws ListenerException {\n+\t\tif (StreamUtil.DEFAULT_INPUT_STREAM_ENCODING.equalsIgnoreCase(getCharset())) {\n+\t\t\treturn new Message(rawMessage.getPayload());\n+\t\t}\n \t\ttry {\n-\t\t\treturn new String(rawMessage.getPayload(), getCharset());\n+\t\t\treturn new Message(new String(rawMessage.getPayload(), getCharset()));", "originalCommit": "4306bb287dc91660fb9d38cca8f0707579104426", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d2001904a1da2b063a2a34eee12c586ef31e1548", "chunk": "diff --git a/core/src/main/java/nl/nn/adapterframework/extensions/mqtt/MqttListener.java b/core/src/main/java/nl/nn/adapterframework/extensions/mqtt/MqttListener.java\nindex 6b4b8aeaa..4eace795b 100644\n--- a/core/src/main/java/nl/nn/adapterframework/extensions/mqtt/MqttListener.java\n+++ b/core/src/main/java/nl/nn/adapterframework/extensions/mqtt/MqttListener.java\n\n@@ -167,14 +167,7 @@ public class MqttListener extends MqttFacade implements ReceiverAware<MqttMessag\n \n \t@Override\n \tpublic Message extractMessage(MqttMessage rawMessage, Map<String, Object> context) throws ListenerException {\n-\t\tif (StreamUtil.DEFAULT_INPUT_STREAM_ENCODING.equalsIgnoreCase(getCharset())) {\n-\t\t\treturn new Message(rawMessage.getPayload());\n-\t\t}\n-\t\ttry {\n-\t\t\treturn new Message(new String(rawMessage.getPayload(), getCharset()));\n-\t\t} catch (UnsupportedEncodingException e) {\n-\t\t\tthrow new ListenerException(\"Could not encode message\", e);\n-\t\t}\n+\t\treturn new Message(rawMessage.getPayload(),getCharset());\n \t}\n \n \t@Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjE2OTc2Mg==", "url": "https://github.com/ibissource/iaf/pull/840#discussion_r442169762", "bodyText": "Kan je niet beter of een combined catch cause van maken of een catch(IOException e){...} toevoegen?", "author": "nielsm5", "createdAt": "2020-06-18T11:53:56Z", "path": "core/src/main/java/nl/nn/adapterframework/http/PushingListenerAdapter.java", "diffHunk": "@@ -84,14 +86,18 @@ public String processRequest(String correlationId, String message, Map<String, O\n \t\ttry {\n \t\t\tlog.debug(\"PushingListenerAdapter.processRequest() for correlationId [\"+correlationId+\"]\");\n \t\t\t// serviceclient has no rawMessage, but it has no afterMessageProcessed either, therefor rawMessage can safely be null in handler.processRequest()\n-\t\t\treturn handler.processRequest(this, correlationId, null, message, requestContext); \n+\t\t\ttry {\n+\t\t\t\treturn handler.processRequest(this, correlationId, null, new Message(message), requestContext).asString();\n+\t\t\t} catch (IOException e) {\n+\t\t\t\tthrow new ListenerException(e);\n+\t\t\t} \n \t\t} catch (ListenerException e) {\n \t\t\tif (isApplicationFaultsAsExceptions()) {\n \t\t\t\tlog.debug(\"PushingListenerAdapter.processRequest() rethrows ListenerException...\");\n \t\t\t\tthrow e;\n \t\t\t} ", "originalCommit": "4306bb287dc91660fb9d38cca8f0707579104426", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjMwNjY2Mg==", "url": "https://github.com/ibissource/iaf/pull/840#discussion_r442306662", "bodyText": "Dan moet ik ook die afhandelingscode dupliceren, of daarin gaan checken of het een ListenerException is", "author": "gvanbrakel", "createdAt": "2020-06-18T15:19:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjE2OTc2Mg=="}], "type": "inlineReview", "revised_code": {"commit": "735a66bf698278c7f464200f23acb117b9834171", "chunk": "diff --git a/core/src/main/java/nl/nn/adapterframework/http/PushingListenerAdapter.java b/core/src/main/java/nl/nn/adapterframework/http/PushingListenerAdapter.java\nindex 9f47526fa..9c63426fb 100644\n--- a/core/src/main/java/nl/nn/adapterframework/http/PushingListenerAdapter.java\n+++ b/core/src/main/java/nl/nn/adapterframework/http/PushingListenerAdapter.java\n\n@@ -82,12 +82,12 @@ public class PushingListenerAdapter<M> implements IPushingListener<M>, ServiceCl\n \t}\n \n \t@Override\n-\tpublic String processRequest(String correlationId, String message, Map<String, Object> requestContext) throws ListenerException {\n+\tpublic String processRequest(String correlationId, String rawMessage, Map<String, Object> requestContext) throws ListenerException {\n+\t\tMessage message = extractMessage((M)rawMessage, requestContext);\n \t\ttry {\n-\t\t\tlog.debug(\"PushingListenerAdapter.processRequest() for correlationId [\"+correlationId+\"]\");\n-\t\t\t// serviceclient has no rawMessage, but it has no afterMessageProcessed either, therefor rawMessage can safely be null in handler.processRequest()\n+\t\t\tlog.debug(\"PushingListenerAdapter.processRequerawMmessagest() for correlationId [\"+correlationId+\"]\");\n \t\t\ttry {\n-\t\t\t\treturn handler.processRequest(this, correlationId, null, new Message(message), requestContext).asString();\n+\t\t\t\treturn handler.processRequest(this, correlationId, (M)rawMessage, message, requestContext).asString();\n \t\t\t} catch (IOException e) {\n \t\t\t\tthrow new ListenerException(e);\n \t\t\t} \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjE3MDc1MQ==", "url": "https://github.com/ibissource/iaf/pull/840#discussion_r442170751", "bodyText": "Hier zou het mee kunnen geven van de charset aan de Message ook goed van pas komen", "author": "nielsm5", "createdAt": "2020-06-18T11:55:51Z", "path": "core/src/main/java/nl/nn/adapterframework/jdbc/JdbcListener.java", "diffHunk": "@@ -209,20 +210,20 @@ protected Object getRawMessage(Connection conn, Map<String,Object> threadContext\n \t\t\t\t\t\tString key=rs.getString(getKeyField());\n \t\t\t\t\t\t\n \t\t\t\t\t\tif (StringUtils.isNotEmpty(getMessageField())) {\n-\t\t\t\t\t\t\tString message;\n+\t\t\t\t\t\t\tMessage message;\n \t\t\t\t\t\t\tif (\"clob\".equalsIgnoreCase(getMessageFieldType())) {\n-\t\t\t\t\t\t\t\tmessage=JdbcUtil.getClobAsString(rs,getMessageField(),false);\n+\t\t\t\t\t\t\t\tmessage=new Message(JdbcUtil.getClobAsString(rs,getMessageField(),false));\n \t\t\t\t\t\t\t} else {\n \t\t\t\t\t\t\t\tif (\"blob\".equalsIgnoreCase(getMessageFieldType())) {\n-\t\t\t\t\t\t\t\t\tmessage=JdbcUtil.getBlobAsString(rs,getMessageField(),getBlobCharset(),false,isBlobsCompressed(),isBlobSmartGet(),false);\n+\t\t\t\t\t\t\t\t\tmessage=new Message(JdbcUtil.getBlobAsString(rs,getMessageField(),getBlobCharset(),false,isBlobsCompressed(),isBlobSmartGet(),false)); // TODO: should not convert Blob to String, but keep as byte array", "originalCommit": "4306bb287dc91660fb9d38cca8f0707579104426", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjMwODQ0Mw==", "url": "https://github.com/ibissource/iaf/pull/840#discussion_r442308443", "bodyText": "Eens, maar ga nu niet de blob handling overhoop halen. Heb er een issue voor gemaakt.", "author": "gvanbrakel", "createdAt": "2020-06-18T15:21:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjE3MDc1MQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjE3MTYwMg==", "url": "https://github.com/ibissource/iaf/pull/840#discussion_r442171602", "bodyText": "Als je hem niet meer gebruikt mag hij weg toch?", "author": "nielsm5", "createdAt": "2020-06-18T11:57:28Z", "path": "core/src/main/java/nl/nn/adapterframework/jms/JMSFacade.java", "diffHunk": "@@ -24,7 +24,7 @@\n import javax.jms.Destination;\n import javax.jms.InvalidDestinationException;\n import javax.jms.JMSException;\n-import javax.jms.Message;\n+//import javax.jms.Message;", "originalCommit": "4306bb287dc91660fb9d38cca8f0707579104426", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d2001904a1da2b063a2a34eee12c586ef31e1548", "chunk": "diff --git a/core/src/main/java/nl/nn/adapterframework/jms/JMSFacade.java b/core/src/main/java/nl/nn/adapterframework/jms/JMSFacade.java\nindex ce1f34af9..7848a4546 100644\n--- a/core/src/main/java/nl/nn/adapterframework/jms/JMSFacade.java\n+++ b/core/src/main/java/nl/nn/adapterframework/jms/JMSFacade.java\n\n@@ -24,7 +24,6 @@ import javax.jms.DeliveryMode;\n import javax.jms.Destination;\n import javax.jms.InvalidDestinationException;\n import javax.jms.JMSException;\n-//import javax.jms.Message;\n import javax.jms.MessageConsumer;\n import javax.jms.MessageProducer;\n import javax.jms.Queue;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjE3Mjg3Ng==", "url": "https://github.com/ibissource/iaf/pull/840#discussion_r442172876", "bodyText": "Hier misschien ook Message.asMessage(..) gebruiken?", "author": "nielsm5", "createdAt": "2020-06-18T11:59:53Z", "path": "core/src/main/java/nl/nn/adapterframework/jms/JmsListenerBase.java", "diffHunk": "@@ -250,29 +251,33 @@ protected String retrieveIdFromMessage(Message message, Map<String, Object> thre\n \t * other parameters from the message and put those in the threadContext.\n \t * @return String  input message for adapter.\n \t */\n-\tpublic String getStringFromRawMessage(Message rawMessage, Map<String,Object> threadContext) throws ListenerException {\n+\tpublic Message extractMessage(javax.jms.Message rawMessage, Map<String,Object> threadContext) throws ListenerException {\n \t\ttry {\n-\t\t\treturn getStringFromRawMessage(rawMessage, threadContext, isSoap(), getSoapHeaderSessionKey(),soapWrapper);\n+\t\t\treturn extractMessage(rawMessage, threadContext, isSoap(), getSoapHeaderSessionKey(), soapWrapper);\n \t\t} catch (Exception e) {\n \t\t\tthrow new ListenerException(e);\n \t\t}\n \t}\n \n-\tpublic String prepareReply(String rawReply, Map<String,Object> threadContext) throws ListenerException {\n+\tpublic Message prepareReply(Message rawReply, Map<String,Object> threadContext) throws ListenerException {\n \t\treturn prepareReply(rawReply, threadContext, null);\n \t}\n \n-\tpublic String prepareReply(String rawReply, Map<String,Object> threadContext, String soapHeader) throws ListenerException {\n+\tpublic Message prepareReply(Message rawReply, Map<String,Object> threadContext, String soapHeader) throws ListenerException {\n \t\tif (!isSoap()) {\n \t\t\treturn rawReply;\n \t\t}\n-\t\tString replyMessage;\n+\t\tMessage replyMessage;\n \t\tif (soapHeader==null) {\n \t\t\tif (StringUtils.isNotEmpty(getSoapHeaderSessionKey())) {\n \t\t\t\tsoapHeader=(String)threadContext.get(getSoapHeaderSessionKey());\n \t\t\t}\n \t\t}\n-\t\treplyMessage = soapWrapper.putInEnvelope(rawReply, getReplyEncodingStyleURI(),getReplyNamespaceURI(),soapHeader);\n+\t\ttry {\n+\t\t\treplyMessage = new Message(soapWrapper.putInEnvelope(rawReply.asString(), getReplyEncodingStyleURI(),getReplyNamespaceURI(),soapHeader));", "originalCommit": "4306bb287dc91660fb9d38cca8f0707579104426", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjE3ODcxOQ==", "url": "https://github.com/ibissource/iaf/pull/840#discussion_r442178719", "bodyText": "Ik denk dat het mooier is als de send message hier een adaperframework message accepteert. Wij gebruiken nu alleen jms TextMessages, maar er zijn er nog meer.. (BytesMessage, MapMessage, ObjectMessage, StreamMessage).\nDie hoeft niet nu, maar misschien handig als comment ergens bij te zetten.", "author": "nielsm5", "createdAt": "2020-06-18T12:11:34Z", "path": "core/src/main/java/nl/nn/adapterframework/jms/PullingJmsListener.java", "diffHunk": "@@ -212,12 +211,12 @@ public void afterMessageProcessed(PipeLineResult plr, Object rawMessageOrWrapper\n \t\t\t\tif (session==null) { \n \t\t\t\t\ttry {\n \t\t\t\t\t\tsession=getSession(threadContext);\n-\t\t\t\t\t\tsend(session, replyTo, cid, prepareReply(plr.getResult(),threadContext), getReplyMessageType(), timeToLive, stringToDeliveryMode(getReplyDeliveryMode()), getReplyPriority(), ignoreInvalidDestinationException);\n+\t\t\t\t\t\tsend(session, replyTo, cid, prepareReply(plr.getResult(),threadContext).asString(), getReplyMessageType(), timeToLive, stringToDeliveryMode(getReplyDeliveryMode()), getReplyPriority(), ignoreInvalidDestinationException);\n \t\t\t\t\t} finally {\n \t\t\t\t\t\treleaseSession(session);\t\t\t\t\t \n \t\t\t\t\t}\n \t\t\t\t}  else {\n-\t\t\t\t\tsend(session, replyTo, cid, plr.getResult(), getReplyMessageType(), timeToLive, stringToDeliveryMode(getReplyDeliveryMode()), getReplyPriority(), ignoreInvalidDestinationException); \n+\t\t\t\t\tsend(session, replyTo, cid, plr.getResult().asString(), getReplyMessageType(), timeToLive, stringToDeliveryMode(getReplyDeliveryMode()), getReplyPriority(), ignoreInvalidDestinationException); \n \t\t\t\t}\n \t\t\t} else {", "originalCommit": "4306bb287dc91660fb9d38cca8f0707579104426", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjE5NzQwMQ==", "url": "https://github.com/ibissource/iaf/pull/840#discussion_r442197401", "bodyText": "hoeft de Misc.cleanseMessage niet meer?", "author": "nielsm5", "createdAt": "2020-06-18T12:44:33Z", "path": "core/src/main/java/nl/nn/adapterframework/receivers/ReceiverBase.java", "diffHunk": "@@ -863,38 +857,38 @@ private void moveInProcessToError(String originalMessageId, String correlationId\n \t\t\t} \n \t\t\ttxManager.commit(txStatus);\n \t\t} catch (Exception e) {\n-\t\t\tlog.error(getLogPrefix()+\"Exception moving message with id [\"+originalMessageId+\"] correlationId [\"+correlationId+\"] to error sender, original message: [\" + Misc.cleanseMessage(message, getHideRegex(), getHideMethod()) + \"]\", e);\n+\t\t\tlog.error(getLogPrefix()+\"Exception moving message with id [\"+originalMessageId+\"] correlationId [\"+correlationId+\"] to error sender, original message: [\" + message.toString() + \"]\", e);\n \t\t\ttry {\n \t\t\t\tif (!txStatus.isCompleted()) {\n \t\t\t\t\ttxManager.rollback(txStatus);\n \t\t\t\t}\n \t\t\t} catch (Exception rbe) {\n-\t\t\t\tlog.error(getLogPrefix()+\"Exception while rolling back transaction for message  with id [\"+originalMessageId+\"] correlationId [\"+correlationId+\"], original message: [\" + Misc.cleanseMessage(message, getHideRegex(), getHideMethod()) + \"]\", rbe);\n+\t\t\t\tlog.error(getLogPrefix()+\"Exception while rolling back transaction for message  with id [\"+originalMessageId+\"] correlationId [\"+correlationId+\"], original message: [\" + message.toString() + \"]\", rbe);", "originalCommit": "4306bb287dc91660fb9d38cca8f0707579104426", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjMxNDMwNw==", "url": "https://github.com/ibissource/iaf/pull/840#discussion_r442314307", "bodyText": "Inderdaad, dat gebeurt al in de IbisMaskingLayout", "author": "gvanbrakel", "createdAt": "2020-06-18T15:29:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjE5NzQwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjY5MTc5NA==", "url": "https://github.com/ibissource/iaf/pull/840#discussion_r442691794", "bodyText": "Dat klopt, die klasse heb ik zelf nog gemaakt... oops, vergeten!", "author": "nielsm5", "createdAt": "2020-06-19T07:57:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjE5NzQwMQ=="}], "type": "inlineReview", "revised_code": {"commit": "735a66bf698278c7f464200f23acb117b9834171", "chunk": "diff --git a/core/src/main/java/nl/nn/adapterframework/receivers/ReceiverBase.java b/core/src/main/java/nl/nn/adapterframework/receivers/ReceiverBase.java\nindex ca9a3ceaa..b7037f3c9 100644\n--- a/core/src/main/java/nl/nn/adapterframework/receivers/ReceiverBase.java\n+++ b/core/src/main/java/nl/nn/adapterframework/receivers/ReceiverBase.java\n\n@@ -842,14 +842,22 @@ public class ReceiverBase<M> implements IReceiver<M>, IReceiverStatistics, IMess\n \t\t\t\terrorSender.sendMessage(message, null);\n \t\t\t}\n \t\t\tSerializable sobj;\n-\t\t\tif (rawMessage instanceof Serializable) {\n-\t\t\t\tsobj=(Serializable)rawMessage;\n+\t\t\tif (rawMessage == null) {\n+\t\t\t\tif (message.isBinary()) {\n+\t\t\t\t\tsobj = message.asByteArray();\n+\t\t\t\t} else {\n+\t\t\t\t\tsobj = message.asString();\n+\t\t\t\t}\n \t\t\t} else {\n-\t\t\t\ttry {\n-\t\t\t\t\tsobj = new MessageWrapper(rawMessage, getListener());\n-\t\t\t\t} catch (ListenerException e) {\n-\t\t\t\t\tlog.error(getLogPrefix()+\"could not wrap non serializable message for messageId [\"+originalMessageId+\"]\",e);\n-\t\t\t\t\tsobj=message;\n+\t\t\t\tif (rawMessage instanceof Serializable) {\n+\t\t\t\t\tsobj=(Serializable)rawMessage;\n+\t\t\t\t} else {\n+\t\t\t\t\ttry {\n+\t\t\t\t\t\tsobj = new MessageWrapper(rawMessage, getListener());\n+\t\t\t\t\t} catch (ListenerException e) {\n+\t\t\t\t\t\tlog.error(getLogPrefix()+\"could not wrap non serializable message for messageId [\"+originalMessageId+\"]\",e);\n+\t\t\t\t\t\tsobj=message;\n+\t\t\t\t\t}\n \t\t\t\t}\n \t\t\t}\n \t\t\tif (errorStorage!=null) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjE5ODMwOA==", "url": "https://github.com/ibissource/iaf/pull/840#discussion_r442198308", "bodyText": "voorheen was dit return null. Nu ineens een Message, waarom niet null?", "author": "nielsm5", "createdAt": "2020-06-18T12:46:03Z", "path": "core/src/main/java/nl/nn/adapterframework/receivers/ReceiverBase.java", "diffHunk": "@@ -1141,11 +1131,11 @@ private String processMessageInAdapter(Object rawMessageOrWrapper, String messag\n \t\t\t\t\tlog.warn(getLogPrefix()+\"received message with messageId [\" + messageId + \"] which has a problematic history; aborting processing\");\n \t\t\t\t}\n \t\t\t\tnumRejected.increase();\n-\t\t\t\treturn result;\n+\t\t\t\treturn new Message(\"\");\n \t\t\t}\n \t\t\tif (isDuplicateAndSkip(getMessageLog(), messageId, businessCorrelationId)) {\n \t\t\t\tnumRejected.increase();\n-\t\t\t\treturn result;\n+\t\t\t\treturn new Message(\"\");", "originalCommit": "4306bb287dc91660fb9d38cca8f0707579104426", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjMxNjg4MQ==", "url": "https://github.com/ibissource/iaf/pull/840#discussion_r442316881", "bodyText": "Omdat er op een aantal plekken .asString() van het resultaat wordt gedaan", "author": "gvanbrakel", "createdAt": "2020-06-18T15:33:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjE5ODMwOA=="}], "type": "inlineReview", "revised_code": {"commit": "735a66bf698278c7f464200f23acb117b9834171", "chunk": "diff --git a/core/src/main/java/nl/nn/adapterframework/receivers/ReceiverBase.java b/core/src/main/java/nl/nn/adapterframework/receivers/ReceiverBase.java\nindex ca9a3ceaa..b7037f3c9 100644\n--- a/core/src/main/java/nl/nn/adapterframework/receivers/ReceiverBase.java\n+++ b/core/src/main/java/nl/nn/adapterframework/receivers/ReceiverBase.java\n\n@@ -1131,11 +1139,11 @@ public class ReceiverBase<M> implements IReceiver<M>, IReceiverStatistics, IMess\n \t\t\t\t\tlog.warn(getLogPrefix()+\"received message with messageId [\" + messageId + \"] which has a problematic history; aborting processing\");\n \t\t\t\t}\n \t\t\t\tnumRejected.increase();\n-\t\t\t\treturn new Message(\"\");\n+\t\t\t\treturn Message.nullMessage();\n \t\t\t}\n \t\t\tif (isDuplicateAndSkip(getMessageLog(), messageId, businessCorrelationId)) {\n \t\t\t\tnumRejected.increase();\n-\t\t\t\treturn new Message(\"\");\n+\t\t\t\treturn Message.nullMessage();\n \t\t\t}\n \t\t\tif (getCachedProcessResult(messageId)!=null) {\n \t\t\t\tnumRetried.increase();\n"}}, {"oid": "d2001904a1da2b063a2a34eee12c586ef31e1548", "url": "https://github.com/ibissource/iaf/commit/d2001904a1da2b063a2a34eee12c586ef31e1548", "message": "Fix issues", "committedDate": "2020-06-18T15:49:04Z", "type": "commit"}, {"oid": "8d239e58e8c97137eb96cc46338f0b34c190f269", "url": "https://github.com/ibissource/iaf/commit/8d239e58e8c97137eb96cc46338f0b34c190f269", "message": "Fix Codacy issues", "committedDate": "2020-06-19T06:19:40Z", "type": "commit"}, {"oid": "735a66bf698278c7f464200f23acb117b9834171", "url": "https://github.com/ibissource/iaf/commit/735a66bf698278c7f464200f23acb117b9834171", "message": "Add nullMessage and fix errorStorage if rawMessage is null", "committedDate": "2020-06-19T11:20:41Z", "type": "commit"}, {"oid": "bb4a9d1c85143556fa28efcd4872f3fbf79e266b", "url": "https://github.com/ibissource/iaf/commit/bb4a9d1c85143556fa28efcd4872f3fbf79e266b", "message": "Improve title of number of messages processed in Adapter Status", "committedDate": "2020-06-19T11:21:37Z", "type": "commit"}, {"oid": "43094af54b802f4dc40897e622ed75bcdbd862c4", "url": "https://github.com/ibissource/iaf/commit/43094af54b802f4dc40897e622ed75bcdbd862c4", "message": "Update title messages in process", "committedDate": "2020-06-19T13:28:52Z", "type": "commit"}]}