{"pr_number": 650, "pr_title": "Fix recursive property resolution in log4j2 configuration files", "pr_createdAt": "2020-04-28T17:58:49Z", "pr_url": "https://github.com/ibissource/iaf/pull/650", "timeline": [{"oid": "1d891ba308da7642b86744e748bab7032f9bbd87", "url": "https://github.com/ibissource/iaf/commit/1d891ba308da7642b86744e748bab7032f9bbd87", "message": "Fix recursive property resolution in log4j2 configuration files", "committedDate": "2020-04-28T17:57:46Z", "type": "commit"}, {"oid": "365898fcc0404c0863220aa67af3bb973690dc94", "url": "https://github.com/ibissource/iaf/commit/365898fcc0404c0863220aa67af3bb973690dc94", "message": "Fix typo and log configuration error to system.err", "committedDate": "2020-04-28T18:03:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzA5NTIxMQ==", "url": "https://github.com/ibissource/iaf/pull/650#discussion_r417095211", "bodyText": "Ik vind dat als je een then clause op een volgende regel zet, je dan snorhaken moet gebruiken (accolades mag ook)", "author": "gvanbrakel", "createdAt": "2020-04-29T06:37:24Z", "path": "core/src/main/java/nl/nn/adapterframework/logging/IbisLoggerConfigurationFactory.java", "diffHunk": "@@ -80,7 +82,10 @@ public Configuration getConfiguration(LoggerContext loggerContext, Configuration\n \t\t\tMap<String, String> substitutions = new HashMap<>();\n \t\t\twhile (m.find()) {\n \t\t\t\tString key = m.group(1);\n-\t\t\t\tsubstitutions.put(key, properties.getProperty(key));\n+\t\t\t\tString value = resolveValueRecursively(properties, key);\n+\n+\t\t\t\tif(value != null)\n+\t\t\t\t\tsubstitutions.put(key, value);", "originalCommit": "365898fcc0404c0863220aa67af3bb973690dc94", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzEwOTA4MQ==", "url": "https://github.com/ibissource/iaf/pull/650#discussion_r417109081", "bodyText": "Dan gebruik ik accolades! (maar er is geen then clause)", "author": "nielsm5", "createdAt": "2020-04-29T07:10:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzA5NTIxMQ=="}], "type": "inlineReview", "revised_code": {"commit": "09b09ffc37dd0a506af95f0b6ff3fa38f42f81c9", "chunk": "diff --git a/core/src/main/java/nl/nn/adapterframework/logging/IbisLoggerConfigurationFactory.java b/core/src/main/java/nl/nn/adapterframework/logging/IbisLoggerConfigurationFactory.java\nindex 7893458b6..a1828bea3 100644\n--- a/core/src/main/java/nl/nn/adapterframework/logging/IbisLoggerConfigurationFactory.java\n+++ b/core/src/main/java/nl/nn/adapterframework/logging/IbisLoggerConfigurationFactory.java\n\n@@ -78,14 +78,15 @@ public class IbisLoggerConfigurationFactory extends ConfigurationFactory {\n \n \t\t\tString configuration = readLog4jConfiguration(source.getInputStream());\n \t\t\tProperties properties = getProperties();\n-\t\t\tMatcher m = Pattern.compile(\"\\\\$\\\\{ctx:([^}]*)\\\\}\").matcher(configuration); //Look for properties in the Log4J2 XML\n+\t\t\tMatcher m = Pattern.compile(\"\\\\$\\\\{(?:ctx:)?([^}]*)\\\\}\").matcher(configuration); //Look for properties in the Log4J2 XML\n \t\t\tMap<String, String> substitutions = new HashMap<>();\n \t\t\twhile (m.find()) {\n \t\t\t\tString key = m.group(1);\n \t\t\t\tString value = resolveValueRecursively(properties, key);\n \n-\t\t\t\tif(value != null)\n+\t\t\t\tif(value != null) {\n \t\t\t\t\tsubstitutions.put(key, value);\n+\t\t\t\t}\n \t\t\t}\n \t\t\tThreadContext.putAll(substitutions); //Only add the substituted variables to the ThreadContext\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzA5Nzc1NQ==", "url": "https://github.com/ibissource/iaf/pull/650#discussion_r417097755", "bodyText": "Je weet niet of het obsolete is, je hebt alleen maar geen \"<log4j2:Configuration\" gezien.\nIk denk dat je moet zeggen: \"did not recognize configuration format, expected log4j2 layout.\nWordt het vervolgens nog wel ge\u00efnterpreteerd? dan dat ook zeggen.", "author": "gvanbrakel", "createdAt": "2020-04-29T06:44:18Z", "path": "core/src/main/java/nl/nn/adapterframework/logging/IbisLoggerConfigurationFactory.java", "diffHunk": "@@ -140,6 +157,7 @@ public static String readLog4jConfiguration(InputStream stream) throws IOExcepti\n \t\t\t\tif(checkVersionOnlyFirst1024Characters) {\n \t\t\t\t\t//See if log4j2 prefix is somewhere in the first 1024 characters\n \t\t\t\t\tif(!stringWriter.toString().contains(\"<log4j2:Configuration\")) {\n+\t\t\t\t\t\tSystem.err.println(LOG_PREFIX + \"detected obsolete configuration format. Please use the log4j2 layout in file log4j4ibis.xml\");\n \t\t\t\t\t\tthrow new IllegalStateException(\"Detected obsolete configuration format. Please use the log4j2 layout in file log4j4ibis.xml\");", "originalCommit": "365898fcc0404c0863220aa67af3bb973690dc94", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "09b09ffc37dd0a506af95f0b6ff3fa38f42f81c9", "chunk": "diff --git a/core/src/main/java/nl/nn/adapterframework/logging/IbisLoggerConfigurationFactory.java b/core/src/main/java/nl/nn/adapterframework/logging/IbisLoggerConfigurationFactory.java\nindex 7893458b6..a1828bea3 100644\n--- a/core/src/main/java/nl/nn/adapterframework/logging/IbisLoggerConfigurationFactory.java\n+++ b/core/src/main/java/nl/nn/adapterframework/logging/IbisLoggerConfigurationFactory.java\n\n@@ -157,8 +158,8 @@ public class IbisLoggerConfigurationFactory extends ConfigurationFactory {\n \t\t\t\tif(checkVersionOnlyFirst1024Characters) {\n \t\t\t\t\t//See if log4j2 prefix is somewhere in the first 1024 characters\n \t\t\t\t\tif(!stringWriter.toString().contains(\"<log4j2:Configuration\")) {\n-\t\t\t\t\t\tSystem.err.println(LOG_PREFIX + \"detected obsolete configuration format. Please use the log4j2 layout in file log4j4ibis.xml\");\n-\t\t\t\t\t\tthrow new IllegalStateException(\"Detected obsolete configuration format. Please use the log4j2 layout in file log4j4ibis.xml\");\n+\t\t\t\t\t\tSystem.err.println(LOG_PREFIX + \"did not recognize configuration format, unable to configure Log4j2. Please use the log4j2 layout in file log4j4ibis.xml\");\n+\t\t\t\t\t\tthrow new IllegalStateException(\"Did not recognize configuration format, unable to configure Log4j2. Please use the log4j2 layout in file log4j4ibis.xml\");\n \t\t\t\t\t}\n \t\t\t\t\tcheckVersionOnlyFirst1024Characters = false;\n \t\t\t\t}\n"}}, {"oid": "09b09ffc37dd0a506af95f0b6ff3fa38f42f81c9", "url": "https://github.com/ibissource/iaf/commit/09b09ffc37dd0a506af95f0b6ff3fa38f42f81c9", "message": "Fix logging in other modules", "committedDate": "2020-04-29T07:57:25Z", "type": "commit"}]}