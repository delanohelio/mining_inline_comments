{"pr_number": 776, "pr_title": "Add ability to set character encoding on the response header", "pr_createdAt": "2020-05-30T14:04:46Z", "pr_url": "https://github.com/ibissource/iaf/pull/776", "timeline": [{"oid": "e6cdb2615a3e95141c014fa3b5242371afe73bac", "url": "https://github.com/ibissource/iaf/commit/e6cdb2615a3e95141c014fa3b5242371afe73bac", "message": "Add ability to set character encoding on the response header", "committedDate": "2020-05-30T14:01:45Z", "type": "commit"}, {"oid": "88963a32d6844cceeba6399bec69e0c123509712", "url": "https://github.com/ibissource/iaf/commit/88963a32d6844cceeba6399bec69e0c123509712", "message": "Move contentType stuff to it's own class", "committedDate": "2020-05-31T14:20:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDUzODg2OA==", "url": "https://github.com/ibissource/iaf/pull/776#discussion_r434538868", "bodyText": "If a charset is required, UTF-8 should be used by default. For binary content no charset must be used.", "author": "gvanbrakel", "createdAt": "2020-06-03T12:45:57Z", "path": "core/src/main/java/nl/nn/adapterframework/http/rest/ApiListener.java", "diffHunk": "@@ -50,12 +50,14 @@\n \n \tprivate MediaTypes consumes = MediaTypes.ANY;\n \tprivate MediaTypes produces = MediaTypes.ANY;\n+\tprivate ContentType producedContentType;\n \tprivate String multipartBodyName = null;\n \n \tprivate IReceiver receiver;\n \n \tprivate ClassLoader configurationClassLoader = Thread.currentThread().getContextClassLoader();\n \tprivate String messageIdHeader = AppConstants.getInstance(configurationClassLoader).getString(\"apiListener.messageIdHeader\", \"Message-Id\");\n+\tprivate String charset = null; //Use system default or UTF-8?", "originalCommit": "88963a32d6844cceeba6399bec69e0c123509712", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f8d14dfd61c4aa724a3551f3e332e74058c7b68b", "chunk": "diff --git a/core/src/main/java/nl/nn/adapterframework/http/rest/ApiListener.java b/core/src/main/java/nl/nn/adapterframework/http/rest/ApiListener.java\nindex ec4a9fd35..2ad8e7c88 100644\n--- a/core/src/main/java/nl/nn/adapterframework/http/rest/ApiListener.java\n+++ b/core/src/main/java/nl/nn/adapterframework/http/rest/ApiListener.java\n\n@@ -57,7 +58,7 @@ public class ApiListener extends PushingListenerAdapter<String> implements HasPh\n \n \tprivate ClassLoader configurationClassLoader = Thread.currentThread().getContextClassLoader();\n \tprivate String messageIdHeader = AppConstants.getInstance(configurationClassLoader).getString(\"apiListener.messageIdHeader\", \"Message-Id\");\n-\tprivate String charset = null; //Use system default or UTF-8?\n+\tprivate String charset = null;\n \n \tpublic enum AuthenticationMethods {\n \t\tNONE, COOKIE, HEADER, AUTHROLE;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDU0MTQ4Nw==", "url": "https://github.com/ibissource/iaf/pull/776#discussion_r434541487", "bodyText": "Dit is een rare test, om een binair formaat te gebruiken en er dan een charset bij te doen.\nAls anderen het zien kan het bovendien verwarrend zijn. Je moet zo'n test met een tekst content-type doen.", "author": "gvanbrakel", "createdAt": "2020-06-03T12:50:13Z", "path": "core/src/test/java/nl/nn/adapterframework/http/rest/ApiListenerTest.java", "diffHunk": "@@ -56,6 +56,16 @@ public void testProducesUpperCase() throws ConfigurationException {\n \t\tassertEquals(\"XML\", listener.getProduces());\n \t}\n \n+\t@Test\n+\tpublic void testProducesPdfWithCharset() throws ConfigurationException {\n+\t\tlistener.setProduces(\"PDF\");\n+\t\tlistener.setCharacterEncoding(\"utf-8\");\n+\t\tlistener.configure();\n+\n+\t\tassertEquals(\"PDF\", listener.getProduces());\n+\t\tassertEquals(\"application/pdf;charset=UTF-8\", listener.getContentType());\n+\t}", "originalCommit": "88963a32d6844cceeba6399bec69e0c123509712", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f8d14dfd61c4aa724a3551f3e332e74058c7b68b", "chunk": "diff --git a/core/src/test/java/nl/nn/adapterframework/http/rest/ApiListenerTest.java b/core/src/test/java/nl/nn/adapterframework/http/rest/ApiListenerTest.java\nindex 6bcbf57ae..3752352a4 100644\n--- a/core/src/test/java/nl/nn/adapterframework/http/rest/ApiListenerTest.java\n+++ b/core/src/test/java/nl/nn/adapterframework/http/rest/ApiListenerTest.java\n\n@@ -57,13 +57,13 @@ public class ApiListenerTest {\n \t}\n \n \t@Test\n-\tpublic void testProducesPdfWithCharset() throws ConfigurationException {\n-\t\tlistener.setProduces(\"PDF\");\n+\tpublic void testProducesTextWithCharset() throws ConfigurationException {\n+\t\tlistener.setProduces(\"TEXT\");\n \t\tlistener.setCharacterEncoding(\"utf-8\");\n \t\tlistener.configure();\n \n-\t\tassertEquals(\"PDF\", listener.getProduces());\n-\t\tassertEquals(\"application/pdf;charset=UTF-8\", listener.getContentType());\n+\t\tassertEquals(\"TEXT\", listener.getProduces());\n+\t\tassertEquals(\"text/plain;charset=UTF-8\", listener.getContentType());\n \t}\n \n \t@Test(expected=IllegalArgumentException.class)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDU0MTg4Mw==", "url": "https://github.com/ibissource/iaf/pull/776#discussion_r434541883", "bodyText": "Dit is een rare test, om een binair formaat te gebruiken en er dan een charset bij te doen.\nAls anderen het zien kan het bovendien verwarrend zijn. Je moet zo'n test met een tekst content-type doen.", "author": "gvanbrakel", "createdAt": "2020-06-03T12:50:55Z", "path": "core/src/test/java/nl/nn/adapterframework/http/rest/ContentTypeTest.java", "diffHunk": "@@ -0,0 +1,41 @@\n+/*\n+Copyright 2020 WeAreFrank!\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+*/\n+package nl.nn.adapterframework.http.rest;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertNull;\n+\n+import org.junit.Test;\n+\n+public class ContentTypeTest {\n+\n+\t@Test\n+\tpublic void defaultTest() {\n+\t\tContentType contenType = new ContentType(MediaTypes.ANY);\n+\t\tassertNull(\"MediaType should not have a charset by default\", contenType.getCharset());\n+\t\tassertEquals(\"ContentType should be */* without charset\", \"*/*\", contenType.getContentType());\n+\t}\n+\n+\t@Test\n+\tpublic void withCharset() {\n+\t\tContentType contenType = new ContentType(MediaTypes.PDF);\n+\t\tassertNull(\"ContentType should not have a charset by default\", contenType.getCharset());", "originalCommit": "88963a32d6844cceeba6399bec69e0c123509712", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f8d14dfd61c4aa724a3551f3e332e74058c7b68b", "chunk": "diff --git a/core/src/test/java/nl/nn/adapterframework/http/rest/ContentTypeTest.java b/core/src/test/java/nl/nn/adapterframework/http/rest/ContentTypeTest.java\nindex d9aeac8e7..48fe4d061 100644\n--- a/core/src/test/java/nl/nn/adapterframework/http/rest/ContentTypeTest.java\n+++ b/core/src/test/java/nl/nn/adapterframework/http/rest/ContentTypeTest.java\n\n@@ -18,24 +18,43 @@ package nl.nn.adapterframework.http.rest;\n import static org.junit.Assert.assertEquals;\n import static org.junit.Assert.assertNull;\n \n+import java.nio.charset.UnsupportedCharsetException;\n+\n import org.junit.Test;\n \n public class ContentTypeTest {\n \n \t@Test\n \tpublic void defaultTest() {\n-\t\tContentType contenType = new ContentType(MediaTypes.ANY);\n-\t\tassertNull(\"MediaType should not have a charset by default\", contenType.getCharset());\n-\t\tassertEquals(\"ContentType should be */* without charset\", \"*/*\", contenType.getContentType());\n+\t\tContentType contentType = new ContentType(MediaTypes.ANY);\n+\t\tassertNull(\"MediaType should not have a charset by default\", contentType.getCharset());\n+\t\tassertEquals(\"ContentType should be */* without charset\", \"*/*\", contentType.getContentType());\n+\t}\n+\n+\t@Test\n+\tpublic void utf8Charset() {\n+\t\tContentType contentType = new ContentType(MediaTypes.TEXT);\n+\t\tassertEquals(\"ContentType should have a charset UTF-8\", \"UTF-8\", contentType.getCharset().name());\n+\t\tassertEquals(\"ContentType should be application/pdf with utf-8 charset\", \"text/plain;charset=UTF-8\", contentType.getContentType());\n \t}\n \n \t@Test\n-\tpublic void withCharset() {\n-\t\tContentType contenType = new ContentType(MediaTypes.PDF);\n-\t\tassertNull(\"ContentType should not have a charset by default\", contenType.getCharset());\n-\t\tassertEquals(\"ContentType should be application/pdf without charset\", \"application/pdf\", contenType.getContentType());\n+\tpublic void isoCharset() {\n+\t\tContentType contentType = new ContentType(MediaTypes.TEXT);\n+\t\tcontentType.setCharset(\"ISO-8859-1\");\n+\t\tassertEquals(\"text/plain;charset=ISO-8859-1\", contentType.getContentType());\n+\t}\n+\n+\t@Test\n+\tpublic void asciiCharset() {\n+\t\tContentType contentType = new ContentType(MediaTypes.TEXT);\n+\t\tcontentType.setCharset(\"US-ASCII\");\n+\t\tassertEquals(\"text/plain;charset=US-ASCII\", contentType.getContentType());\n+\t}\n \n-\t\tcontenType.setCharset(\"Utf-8\");\n-\t\tassertEquals(\"application/pdf;charset=UTF-8\", contenType.getContentType());\n+\t@Test(expected=UnsupportedCharsetException.class)\n+\tpublic void faultyCharset() {\n+\t\tContentType contentType = new ContentType(MediaTypes.TEXT);\n+\t\tcontentType.setCharset(\"ISO-1234\");\n \t}\n }\n"}}, {"oid": "f8d14dfd61c4aa724a3551f3e332e74058c7b68b", "url": "https://github.com/ibissource/iaf/commit/f8d14dfd61c4aa724a3551f3e332e74058c7b68b", "message": "only allow charset on certain mediatypes", "committedDate": "2020-06-03T18:21:08Z", "type": "commit"}, {"oid": "dd2568f0f1cda53f5a80e0b6a8baf2bb8e970989", "url": "https://github.com/ibissource/iaf/commit/dd2568f0f1cda53f5a80e0b6a8baf2bb8e970989", "message": "Fix Accept header", "committedDate": "2020-06-05T08:42:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjU1NTQ1Mg==", "url": "https://github.com/ibissource/iaf/pull/776#discussion_r436555452", "bodyText": "Hier bedoel je dan denk ik if (this.charset == null)", "author": "gvanbrakel", "createdAt": "2020-06-08T09:07:46Z", "path": "core/src/main/java/nl/nn/adapterframework/http/rest/ContentType.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+Copyright 2020 WeAreFrank!\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+*/\n+package nl.nn.adapterframework.http.rest;\n+\n+import java.nio.charset.Charset;\n+import java.nio.charset.UnsupportedCharsetException;\n+\n+import org.apache.commons.lang3.StringUtils;\n+\n+public class ContentType {\n+\tpublic static final String CHARSET_PARAMETER = \"charset\";\n+\tprivate MediaTypes mediaType;\n+\tprivate Charset charset;\n+\n+\tpublic ContentType(MediaTypes mediaType) {\n+\t\tthis.mediaType = mediaType;\n+\t\tthis.charset = mediaType.getCharset(); // when charset = NULL it means setting it is disallowed\n+\t}\n+\n+\tpublic void setCharset(String charset) {\n+\t\tif(charset == null) {\n+\t\t\tthrow new UnsupportedCharsetException(\"provided mediatype does not support setting charset\");\n+\t\t}", "originalCommit": "dd2568f0f1cda53f5a80e0b6a8baf2bb8e970989", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ2MzgzMQ==", "url": "https://github.com/ibissource/iaf/pull/776#discussion_r437463831", "bodyText": "Ja dat klopt!", "author": "nielsm5", "createdAt": "2020-06-09T14:24:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjU1NTQ1Mg=="}], "type": "inlineReview", "revised_code": {"commit": "fdbd2bdab212af38f7bc6e32c87935a56a6439c1", "chunk": "diff --git a/core/src/main/java/nl/nn/adapterframework/http/rest/ContentType.java b/core/src/main/java/nl/nn/adapterframework/http/rest/ContentType.java\nindex 5751a72c6..7aa8f772c 100644\n--- a/core/src/main/java/nl/nn/adapterframework/http/rest/ContentType.java\n+++ b/core/src/main/java/nl/nn/adapterframework/http/rest/ContentType.java\n\n@@ -27,11 +27,11 @@ public class ContentType {\n \n \tpublic ContentType(MediaTypes mediaType) {\n \t\tthis.mediaType = mediaType;\n-\t\tthis.charset = mediaType.getCharset(); // when charset = NULL it means setting it is disallowed\n+\t\tthis.charset = mediaType.getDefaultCharset(); // when charset = NULL it means setting it is disallowed\n \t}\n \n \tpublic void setCharset(String charset) {\n-\t\tif(charset == null) {\n+\t\tif(this.charset == null) {\n \t\t\tthrow new UnsupportedCharsetException(\"provided mediatype does not support setting charset\");\n \t\t}\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjU1NzQ5Mg==", "url": "https://github.com/ibissource/iaf/pull/776#discussion_r436557492", "bodyText": "Kan je hier niet net zo goed een boolean hebben met 'hasCharset'?", "author": "gvanbrakel", "createdAt": "2020-06-08T09:11:00Z", "path": "core/src/main/java/nl/nn/adapterframework/http/rest/MediaTypes.java", "diffHunk": "@@ -15,21 +15,43 @@\n */\n package nl.nn.adapterframework.http.rest;\n \n+import java.nio.charset.Charset;\n+\n public enum MediaTypes {\n \n-\tANY(\"*/*\"),\n+\tANY(\"*/*\", null),\n \tTEXT(\"text/plain\"),\n \tXML(\"application/xml\"),\n \tJSON(\"application/json\"),\n-\tPDF(\"application/pdf\"),\n+\tPDF(\"application/pdf\", null), //raw binary formats do not have a charset\n+\tOCTET(\"application/octet-stream\", null), //raw binary formats do not have a charset\n \tMULTIPART_RELATED(\"multipart/related\"),\n \tMULTIPART_FORMDATA(\"multipart/form-data\"),\n \tMULTIPART(\"multipart/*\");\n \n \tprivate final String mediaType;\n+\tprivate final Charset charset;", "originalCommit": "dd2568f0f1cda53f5a80e0b6a8baf2bb8e970989", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ2ODY0Mw==", "url": "https://github.com/ibissource/iaf/pull/776#discussion_r437468643", "bodyText": "Ja ik dacht ik gebruik een Charset want dan kunnen we ooit misschien nog besluiten ergens een andere default charset op te geven", "author": "nielsm5", "createdAt": "2020-06-09T14:30:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjU1NzQ5Mg=="}], "type": "inlineReview", "revised_code": {"commit": "fdbd2bdab212af38f7bc6e32c87935a56a6439c1", "chunk": "diff --git a/core/src/main/java/nl/nn/adapterframework/http/rest/MediaTypes.java b/core/src/main/java/nl/nn/adapterframework/http/rest/MediaTypes.java\nindex 508465506..883fbf6a1 100644\n--- a/core/src/main/java/nl/nn/adapterframework/http/rest/MediaTypes.java\n+++ b/core/src/main/java/nl/nn/adapterframework/http/rest/MediaTypes.java\n\n@@ -17,6 +17,8 @@ package nl.nn.adapterframework.http.rest;\n \n import java.nio.charset.Charset;\n \n+import nl.nn.adapterframework.util.StreamUtil;\n+\n public enum MediaTypes {\n \n \tANY(\"*/*\", null),\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjY1OTQwMw==", "url": "https://github.com/ibissource/iaf/pull/776#discussion_r436659403", "bodyText": "steamutil.defaultCharset", "author": "nielsm5", "createdAt": "2020-06-08T12:35:56Z", "path": "core/src/main/java/nl/nn/adapterframework/http/rest/MediaTypes.java", "diffHunk": "@@ -15,21 +15,43 @@\n */\n package nl.nn.adapterframework.http.rest;\n \n+import java.nio.charset.Charset;\n+\n public enum MediaTypes {\n \n-\tANY(\"*/*\"),\n+\tANY(\"*/*\", null),\n \tTEXT(\"text/plain\"),\n \tXML(\"application/xml\"),\n \tJSON(\"application/json\"),\n-\tPDF(\"application/pdf\"),\n+\tPDF(\"application/pdf\", null), //raw binary formats do not have a charset\n+\tOCTET(\"application/octet-stream\", null), //raw binary formats do not have a charset\n \tMULTIPART_RELATED(\"multipart/related\"),\n \tMULTIPART_FORMDATA(\"multipart/form-data\"),\n \tMULTIPART(\"multipart/*\");\n \n \tprivate final String mediaType;\n+\tprivate final Charset charset;\n \n+\t/**\n+\t * Creates a new MediaType with the default charset (UTF-8)\n+\t */\n \tprivate MediaTypes(String mediaType) {\n+\t\tthis(mediaType, Charset.forName(\"utf-8\"));", "originalCommit": "dd2568f0f1cda53f5a80e0b6a8baf2bb8e970989", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "fdbd2bdab212af38f7bc6e32c87935a56a6439c1", "chunk": "diff --git a/core/src/main/java/nl/nn/adapterframework/http/rest/MediaTypes.java b/core/src/main/java/nl/nn/adapterframework/http/rest/MediaTypes.java\nindex 508465506..883fbf6a1 100644\n--- a/core/src/main/java/nl/nn/adapterframework/http/rest/MediaTypes.java\n+++ b/core/src/main/java/nl/nn/adapterframework/http/rest/MediaTypes.java\n\n@@ -17,6 +17,8 @@ package nl.nn.adapterframework.http.rest;\n \n import java.nio.charset.Charset;\n \n+import nl.nn.adapterframework.util.StreamUtil;\n+\n public enum MediaTypes {\n \n \tANY(\"*/*\", null),\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjY1OTU2MA==", "url": "https://github.com/ibissource/iaf/pull/776#discussion_r436659560", "bodyText": "Rename to getDefaultCharset()", "author": "nielsm5", "createdAt": "2020-06-08T12:36:13Z", "path": "core/src/main/java/nl/nn/adapterframework/http/rest/MediaTypes.java", "diffHunk": "@@ -15,21 +15,43 @@\n */\n package nl.nn.adapterframework.http.rest;\n \n+import java.nio.charset.Charset;\n+\n public enum MediaTypes {\n \n-\tANY(\"*/*\"),\n+\tANY(\"*/*\", null),\n \tTEXT(\"text/plain\"),\n \tXML(\"application/xml\"),\n \tJSON(\"application/json\"),\n-\tPDF(\"application/pdf\"),\n+\tPDF(\"application/pdf\", null), //raw binary formats do not have a charset\n+\tOCTET(\"application/octet-stream\", null), //raw binary formats do not have a charset\n \tMULTIPART_RELATED(\"multipart/related\"),\n \tMULTIPART_FORMDATA(\"multipart/form-data\"),\n \tMULTIPART(\"multipart/*\");\n \n \tprivate final String mediaType;\n+\tprivate final Charset charset;\n \n+\t/**\n+\t * Creates a new MediaType with the default charset (UTF-8)\n+\t */\n \tprivate MediaTypes(String mediaType) {\n+\t\tthis(mediaType, Charset.forName(\"utf-8\"));\n+\t}\n+\n+\t/**\n+\t * Creates a new MediaType with the given charset\n+\t */\n+\tprivate MediaTypes(String mediaType, Charset charset) {\n \t\tthis.mediaType = mediaType;\n+\t\tthis.charset = charset;\n+\t}\n+\n+\t/**\n+\t * returns the default charset for the given mediatype or null when non is allowed\n+\t */\n+\tpublic Charset getCharset() {", "originalCommit": "dd2568f0f1cda53f5a80e0b6a8baf2bb8e970989", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "fdbd2bdab212af38f7bc6e32c87935a56a6439c1", "chunk": "diff --git a/core/src/main/java/nl/nn/adapterframework/http/rest/MediaTypes.java b/core/src/main/java/nl/nn/adapterframework/http/rest/MediaTypes.java\nindex 508465506..883fbf6a1 100644\n--- a/core/src/main/java/nl/nn/adapterframework/http/rest/MediaTypes.java\n+++ b/core/src/main/java/nl/nn/adapterframework/http/rest/MediaTypes.java\n\n@@ -17,6 +17,8 @@ package nl.nn.adapterframework.http.rest;\n \n import java.nio.charset.Charset;\n \n+import nl.nn.adapterframework.util.StreamUtil;\n+\n public enum MediaTypes {\n \n \tANY(\"*/*\", null),\n"}}, {"oid": "fdbd2bdab212af38f7bc6e32c87935a56a6439c1", "url": "https://github.com/ibissource/iaf/commit/fdbd2bdab212af38f7bc6e32c87935a56a6439c1", "message": "Fix feedback", "committedDate": "2020-06-09T18:22:01Z", "type": "commit"}]}