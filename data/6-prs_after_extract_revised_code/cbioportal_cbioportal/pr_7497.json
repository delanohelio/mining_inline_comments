{"pr_number": 7497, "pr_title": "Phase 1 of Fusion-SV migration", "pr_createdAt": "2020-05-13T17:03:55Z", "pr_url": "https://github.com/cBioPortal/cbioportal/pull/7497", "timeline": [{"oid": "8e3c74c9ad94de08eb3e9e35712d0959f309ad2d", "url": "https://github.com/cBioPortal/cbioportal/commit/8e3c74c9ad94de08eb3e9e35712d0959f309ad2d", "message": "Remove Fusions from mutations api's", "committedDate": "2020-05-13T16:58:52Z", "type": "commit"}, {"oid": "5f7a8f75cefee04450ffd059d69ab8f192fe7b33", "url": "https://github.com/cBioPortal/cbioportal/commit/5f7a8f75cefee04450ffd059d69ab8f192fe7b33", "message": "Rename fusion to structual variant genes in study-view api", "committedDate": "2020-05-13T17:52:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjgzODA2MA==", "url": "https://github.com/cBioPortal/cbioportal/pull/7497#discussion_r426838060", "bodyText": "We need @Cacheable tags here.", "author": "n1zea144", "createdAt": "2020-05-18T19:10:06Z", "path": "persistence/persistence-api/src/main/java/org/cbioportal/persistence/StructuralVariantRepository.java", "diffHunk": "@@ -1,11 +1,15 @@\n package org.cbioportal.persistence;\n \n import org.cbioportal.model.StructuralVariant;\n+import org.cbioportal.model.StructuralVariantCountByGene;\n \n import java.util.List;\n \n public interface StructuralVariantRepository {\n \n-    List<StructuralVariant> fetchStructuralVariants(List<String> molecularProfileIds, \n-            List<Integer> entrezGeneIds, List<String> sampleIds);\n+    List<StructuralVariant> fetchStructuralVariants(List<String> molecularProfileIds, List<Integer> entrezGeneIds,", "originalCommit": "5f7a8f75cefee04450ffd059d69ab8f192fe7b33", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "0cb58fdb67f39f1aec96e4b443211c33dc130bcb", "chunk": "diff --git a/persistence/persistence-api/src/main/java/org/cbioportal/persistence/StructuralVariantRepository.java b/persistence/persistence-api/src/main/java/org/cbioportal/persistence/StructuralVariantRepository.java\nindex c360a6dbb..f89a72877 100644\n--- a/persistence/persistence-api/src/main/java/org/cbioportal/persistence/StructuralVariantRepository.java\n+++ b/persistence/persistence-api/src/main/java/org/cbioportal/persistence/StructuralVariantRepository.java\n\n@@ -2,14 +2,17 @@ package org.cbioportal.persistence;\n \n import org.cbioportal.model.StructuralVariant;\n import org.cbioportal.model.StructuralVariantCountByGene;\n+import org.springframework.cache.annotation.Cacheable;\n \n import java.util.List;\n \n public interface StructuralVariantRepository {\n \n+    @Cacheable(cacheNames = \"GeneralRepositoryCache\", condition = \"@cacheEnabledConfig.getEnabled()\")\n     List<StructuralVariant> fetchStructuralVariants(List<String> molecularProfileIds, List<Integer> entrezGeneIds,\n             List<String> sampleIds);\n \n+    @Cacheable(cacheNames = \"GeneralRepositoryCache\", condition = \"@cacheEnabledConfig.getEnabled()\")\n     List<StructuralVariantCountByGene> getSampleCountInMultipleMolecularProfiles(List<String> molecularProfileIds,\n             List<String> sampleIds, List<Integer> entrezGeneIds);\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjgzOTg3NQ==", "url": "https://github.com/cBioPortal/cbioportal/pull/7497#discussion_r426839875", "bodyText": "For consistency with other service classes, can we move validation checks to service layer?", "author": "n1zea144", "createdAt": "2020-05-18T19:13:33Z", "path": "persistence/persistence-mybatis/src/main/java/org/cbioportal/persistence/mybatis/StructuralVariantMyBatisRepository.java", "diffHunk": "@@ -35,16 +36,23 @@\n \n     @Autowired\n     private StructuralVariantMapper structuralVariantMapper;\n-    \n+\n     @Override\n-    public List<StructuralVariant> fetchStructuralVariants(List<String> molecularProfileIds, \n+    public List<StructuralVariant> fetchStructuralVariants(List<String> molecularProfileIds,\n             List<Integer> entrezGeneIds, List<String> sampleIds) {\n \n         if ((sampleIds.size() > 0) && (molecularProfileIds.size() != sampleIds.size())) {\n             throw new RuntimeException(\"molecularProfileIds list and sampleIds list should be the same length.\");\n         }\n \n-        return structuralVariantMapper.fetchStructuralVariants(molecularProfileIds,\n-                entrezGeneIds, sampleIds);\n+        return structuralVariantMapper.fetchStructuralVariants(molecularProfileIds, entrezGeneIds, sampleIds);", "originalCommit": "5f7a8f75cefee04450ffd059d69ab8f192fe7b33", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "0cb58fdb67f39f1aec96e4b443211c33dc130bcb", "chunk": "diff --git a/persistence/persistence-mybatis/src/main/java/org/cbioportal/persistence/mybatis/StructuralVariantMyBatisRepository.java b/persistence/persistence-mybatis/src/main/java/org/cbioportal/persistence/mybatis/StructuralVariantMyBatisRepository.java\nindex e00b26c7c..26567860e 100644\n--- a/persistence/persistence-mybatis/src/main/java/org/cbioportal/persistence/mybatis/StructuralVariantMyBatisRepository.java\n+++ b/persistence/persistence-mybatis/src/main/java/org/cbioportal/persistence/mybatis/StructuralVariantMyBatisRepository.java\n\n@@ -41,10 +41,6 @@ public class StructuralVariantMyBatisRepository implements StructuralVariantRepo\n     public List<StructuralVariant> fetchStructuralVariants(List<String> molecularProfileIds,\n             List<Integer> entrezGeneIds, List<String> sampleIds) {\n \n-        if ((sampleIds.size() > 0) && (molecularProfileIds.size() != sampleIds.size())) {\n-            throw new RuntimeException(\"molecularProfileIds list and sampleIds list should be the same length.\");\n-        }\n-\n         return structuralVariantMapper.fetchStructuralVariants(molecularProfileIds, entrezGeneIds, sampleIds);\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg0NjcyNg==", "url": "https://github.com/cBioPortal/cbioportal/pull/7497#discussion_r426846726", "bodyText": "Nice.  Should we add a \"TODO\" comment here to remove once fusions are migrated to sv table in database?", "author": "n1zea144", "createdAt": "2020-05-18T19:27:26Z", "path": "service/src/main/java/org/cbioportal/service/impl/StructuralVariantServiceImpl.java", "diffHunk": "@@ -36,12 +40,42 @@\n \n     @Autowired\n     private StructuralVariantRepository structuralVariantRepository;\n-    \n+    @Autowired\n+    private MutationRepository mutationRepository;\n+    @Autowired\n+    private MutationMapperUtils mutationMapperUtils;\n+    @Autowired\n+    private AlterationEnrichmentUtil<StructuralVariantCountByGene> alterationEnrichmentUtil;\n+\n     @Override\n-    public List<StructuralVariant> fetchStructuralVariants(List<String> molecularProfileIds, \n-            List<Integer> entrezGeneIds,  List<String> sampleIds) {\n-        \n-        return structuralVariantRepository.fetchStructuralVariants(molecularProfileIds, entrezGeneIds, sampleIds);\n+    public List<StructuralVariant> fetchStructuralVariants(List<String> molecularProfileIds,\n+            List<Integer> entrezGeneIds, List<String> sampleIds) {\n+\n+        List<StructuralVariant> structuralVariants = mutationMapperUtils.mapFusionsToStructuralVariants(", "originalCommit": "5f7a8f75cefee04450ffd059d69ab8f192fe7b33", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "0cb58fdb67f39f1aec96e4b443211c33dc130bcb", "chunk": "diff --git a/service/src/main/java/org/cbioportal/service/impl/StructuralVariantServiceImpl.java b/service/src/main/java/org/cbioportal/service/impl/StructuralVariantServiceImpl.java\nindex b9ab0cd65..f34e6a982 100644\n--- a/service/src/main/java/org/cbioportal/service/impl/StructuralVariantServiceImpl.java\n+++ b/service/src/main/java/org/cbioportal/service/impl/StructuralVariantServiceImpl.java\n\n@@ -51,12 +57,14 @@ public class StructuralVariantServiceImpl implements StructuralVariantService {\n     public List<StructuralVariant> fetchStructuralVariants(List<String> molecularProfileIds,\n             List<Integer> entrezGeneIds, List<String> sampleIds) {\n \n-        List<StructuralVariant> structuralVariants = mutationMapperUtils.mapFusionsToStructuralVariants(\n-                mutationRepository.getFusionsInMultipleMolecularProfiles(molecularProfileIds, sampleIds, entrezGeneIds,\n-                        \"DETAILED\", null, null, null, null));\n+        List<StructuralVariant> structuralVariants = structuralVariantRepository\n+                .fetchStructuralVariants(molecularProfileIds, entrezGeneIds, sampleIds);\n \n-        structuralVariants.addAll(\n-                structuralVariantRepository.fetchStructuralVariants(molecularProfileIds, entrezGeneIds, sampleIds));\n+        // TODO: Remove once fusions are removed from mutation table\n+        structuralVariants.addAll(mutationMapperUtils.mapFusionsToStructuralVariants(\n+                mutationRepository.getFusionsInMultipleMolecularProfiles(molecularProfileIds, sampleIds, entrezGeneIds,\n+                        \"DETAILED\", null, null, null, null)));\n+        // TODO: Remove once fusions are removed from mutation table\n \n         return structuralVariants;\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg0Nzc4Mg==", "url": "https://github.com/cBioPortal/cbioportal/pull/7497#discussion_r426847782", "bodyText": "Typo here - s/Couts/Counts/", "author": "n1zea144", "createdAt": "2020-05-18T19:29:45Z", "path": "service/src/main/java/org/cbioportal/service/util/MutationMapperUtils.java", "diffHunk": "@@ -0,0 +1,54 @@\n+package org.cbioportal.service.util;\n+\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+import org.cbioportal.model.Mutation;\n+import org.cbioportal.model.MutationCountByGene;\n+import org.cbioportal.model.StructuralVariant;\n+import org.cbioportal.model.StructuralVariantCountByGene;\n+import org.springframework.stereotype.Component;\n+\n+@Component\n+public class MutationMapperUtils {\n+\n+    public List<StructuralVariant> mapFusionsToStructuralVariants(List<Mutation> fusions) {\n+\n+        return fusions.stream().map(fusion -> {\n+            StructuralVariant structuralVariant = new StructuralVariant();\n+\n+            // Sample details\n+            structuralVariant.setPatientId(fusion.getPatientId());\n+            structuralVariant.setSampleId(fusion.getSampleId());\n+            structuralVariant.setStudyId(fusion.getStudyId());\n+            structuralVariant.setMolecularProfileId(fusion.getMolecularProfileId());\n+\n+            // Fusion details\n+            structuralVariant.setSite1EntrezGeneId(fusion.getEntrezGeneId());\n+            structuralVariant.setSite1HugoSymbol(fusion.getGene().getHugoGeneSymbol());\n+            structuralVariant.setSite1Chromosome(fusion.getChr());\n+            structuralVariant.setCenter(fusion.getCenter());\n+            structuralVariant.setSite1Position(fusion.getStartPosition().intValue());\n+            structuralVariant.setComments(fusion.getKeyword());\n+            structuralVariant.setNcbiBuild(fusion.getNcbiBuild());\n+\n+            return structuralVariant;\n+        }).collect(Collectors.toList());\n+    }\n+\n+    public List<StructuralVariantCountByGene> mapFusionCoutsToStructuralVariantCounts(", "originalCommit": "5f7a8f75cefee04450ffd059d69ab8f192fe7b33", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "0cb58fdb67f39f1aec96e4b443211c33dc130bcb", "chunk": "diff --git a/service/src/main/java/org/cbioportal/service/util/MutationMapperUtils.java b/service/src/main/java/org/cbioportal/service/util/MutationMapperUtils.java\nindex fe6a1dcfd..f523dca44 100644\n--- a/service/src/main/java/org/cbioportal/service/util/MutationMapperUtils.java\n+++ b/service/src/main/java/org/cbioportal/service/util/MutationMapperUtils.java\n\n@@ -36,7 +36,7 @@ public class MutationMapperUtils {\n         }).collect(Collectors.toList());\n     }\n \n-    public List<StructuralVariantCountByGene> mapFusionCoutsToStructuralVariantCounts(\n+    public List<StructuralVariantCountByGene> mapFusionCountsToStructuralVariantCounts(\n             List<MutationCountByGene> mutationCountByGenes) {\n \n         return mutationCountByGenes.stream().map(fusion -> {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg0ODA1Ng==", "url": "https://github.com/cBioPortal/cbioportal/pull/7497#discussion_r426848056", "bodyText": "Looks like typo here s/Couts/Counts/", "author": "n1zea144", "createdAt": "2020-05-18T19:30:15Z", "path": "service/src/main/java/org/cbioportal/service/impl/StructuralVariantServiceImpl.java", "diffHunk": "@@ -36,12 +40,42 @@\n \n     @Autowired\n     private StructuralVariantRepository structuralVariantRepository;\n-    \n+    @Autowired\n+    private MutationRepository mutationRepository;\n+    @Autowired\n+    private MutationMapperUtils mutationMapperUtils;\n+    @Autowired\n+    private AlterationEnrichmentUtil<StructuralVariantCountByGene> alterationEnrichmentUtil;\n+\n     @Override\n-    public List<StructuralVariant> fetchStructuralVariants(List<String> molecularProfileIds, \n-            List<Integer> entrezGeneIds,  List<String> sampleIds) {\n-        \n-        return structuralVariantRepository.fetchStructuralVariants(molecularProfileIds, entrezGeneIds, sampleIds);\n+    public List<StructuralVariant> fetchStructuralVariants(List<String> molecularProfileIds,\n+            List<Integer> entrezGeneIds, List<String> sampleIds) {\n+\n+        List<StructuralVariant> structuralVariants = mutationMapperUtils.mapFusionsToStructuralVariants(\n+                mutationRepository.getFusionsInMultipleMolecularProfiles(molecularProfileIds, sampleIds, entrezGeneIds,\n+                        \"DETAILED\", null, null, null, null));\n+\n+        structuralVariants.addAll(\n+                structuralVariantRepository.fetchStructuralVariants(molecularProfileIds, entrezGeneIds, sampleIds));\n+\n+        return structuralVariants;\n+    }\n+\n+    @Override\n+    public List<StructuralVariantCountByGene> getSampleCountInMultipleMolecularProfiles(\n+            List<String> molecularProfileIds, List<String> sampleIds, List<Integer> entrezGeneIds,\n+            boolean includeFrequency, boolean includeMissingAlterationsFromGenePanel) {\n+\n+        List<StructuralVariantCountByGene> countByGenes = mutationMapperUtils.mapFusionCoutsToStructuralVariantCounts(", "originalCommit": "5f7a8f75cefee04450ffd059d69ab8f192fe7b33", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "0cb58fdb67f39f1aec96e4b443211c33dc130bcb", "chunk": "diff --git a/service/src/main/java/org/cbioportal/service/impl/StructuralVariantServiceImpl.java b/service/src/main/java/org/cbioportal/service/impl/StructuralVariantServiceImpl.java\nindex b9ab0cd65..f34e6a982 100644\n--- a/service/src/main/java/org/cbioportal/service/impl/StructuralVariantServiceImpl.java\n+++ b/service/src/main/java/org/cbioportal/service/impl/StructuralVariantServiceImpl.java\n\n@@ -51,12 +57,14 @@ public class StructuralVariantServiceImpl implements StructuralVariantService {\n     public List<StructuralVariant> fetchStructuralVariants(List<String> molecularProfileIds,\n             List<Integer> entrezGeneIds, List<String> sampleIds) {\n \n-        List<StructuralVariant> structuralVariants = mutationMapperUtils.mapFusionsToStructuralVariants(\n-                mutationRepository.getFusionsInMultipleMolecularProfiles(molecularProfileIds, sampleIds, entrezGeneIds,\n-                        \"DETAILED\", null, null, null, null));\n+        List<StructuralVariant> structuralVariants = structuralVariantRepository\n+                .fetchStructuralVariants(molecularProfileIds, entrezGeneIds, sampleIds);\n \n-        structuralVariants.addAll(\n-                structuralVariantRepository.fetchStructuralVariants(molecularProfileIds, entrezGeneIds, sampleIds));\n+        // TODO: Remove once fusions are removed from mutation table\n+        structuralVariants.addAll(mutationMapperUtils.mapFusionsToStructuralVariants(\n+                mutationRepository.getFusionsInMultipleMolecularProfiles(molecularProfileIds, sampleIds, entrezGeneIds,\n+                        \"DETAILED\", null, null, null, null)));\n+        // TODO: Remove once fusions are removed from mutation table\n \n         return structuralVariants;\n     }\n"}}, {"oid": "0cb58fdb67f39f1aec96e4b443211c33dc130bcb", "url": "https://github.com/cBioPortal/cbioportal/commit/0cb58fdb67f39f1aec96e4b443211c33dc130bcb", "message": "Cleanup", "committedDate": "2020-05-19T13:40:28Z", "type": "commit"}]}