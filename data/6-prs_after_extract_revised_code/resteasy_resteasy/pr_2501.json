{"pr_number": 2501, "pr_title": "[RESTEASY-2683] NPE in ApacheHttpClient43Test because cache is null in MediaTypeMap", "pr_createdAt": "2020-08-31T09:49:01Z", "pr_url": "https://github.com/resteasy/resteasy/pull/2501", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTAxOTQ3OA==", "url": "https://github.com/resteasy/resteasy/pull/2501#discussion_r481019478", "bodyText": "Why is this line moved out of check block ?", "author": "jimma", "createdAt": "2020-09-01T10:02:05Z", "path": "resteasy-core/src/main/java/org/jboss/resteasy/core/MediaTypeMap.java", "diffHunk": "@@ -550,8 +551,8 @@ private void mergeEverything(Entry<T> entry) {\n       CachedMediaTypeAndClass cacheEntry = null;\r\n       if (useCache)\r\n       {\r\n+         cacheEntry = new CachedMediaTypeAndClass(type, accept);\r", "originalCommit": "77a67bcd2ae67442ed49dd7d7083609f0c89db34", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTAzMTE2MA==", "url": "https://github.com/resteasy/resteasy/pull/2501#discussion_r481031160", "bodyText": "This is just because the first time when the classCache is null the cacheEntry is not initialized, it remains null, and therefore the put at the end is done with cacheEntry=null, so nothing is cached the first time (indeed it's cached wrong, with a wrong key). I just fixed this minor issue too. This change is minor, as this is just executed differently the first time when classCache is null, all the rest of times is exactly the same.", "author": "rmartinc", "createdAt": "2020-09-01T10:16:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTAxOTQ3OA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTAyMDI5OQ==", "url": "https://github.com/resteasy/resteasy/pull/2501#discussion_r481020299", "bodyText": "if (cache== null) check again here ?", "author": "jimma", "createdAt": "2020-09-01T10:03:35Z", "path": "resteasy-core/src/main/java/org/jboss/resteasy/core/MediaTypeMap.java", "diffHunk": "@@ -576,14 +577,14 @@ private void mergeEverything(Entry<T> entry) {\n       cached = convert(matches);\r\n       if (useCache) {\r\n          Map<CachedMediaTypeAndClass, List<T>> cache = classCache;\r\n-         if (classCache == null) {\r\n+         if (cache == null) {\r\n             synchronized (this)\r\n             {\r\n                if (classCache == null)\r", "originalCommit": "77a67bcd2ae67442ed49dd7d7083609f0c89db34", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTA0MTk3NQ==", "url": "https://github.com/resteasy/resteasy/pull/2501#discussion_r481041975", "bodyText": "I think that it's not needed to repeat the check for the cache var, cache is local to the method, so if it was null then it's null now. Only classCache can be initialized by other threads.", "author": "rmartinc", "createdAt": "2020-09-01T10:36:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTAyMDI5OQ=="}], "type": "inlineReview", "revised_code": {"commit": "49e4c8f2f1bca480a1e696552081aa2275b86ece", "chunk": "diff --git a/resteasy-core/src/main/java/org/jboss/resteasy/core/MediaTypeMap.java b/resteasy-core/src/main/java/org/jboss/resteasy/core/MediaTypeMap.java\nindex d2194370e..e6900b5b2 100644\n--- a/resteasy-core/src/main/java/org/jboss/resteasy/core/MediaTypeMap.java\n+++ b/resteasy-core/src/main/java/org/jboss/resteasy/core/MediaTypeMap.java\n\n@@ -582,7 +581,7 @@ public class MediaTypeMap<T>\n             {\n                if (classCache == null)\n                {\n-                  classCache = new ConcurrentHashMap<>();\n+                  classCache = new HashMap<>();\n                }\n                cache = classCache;\n             }\n"}}, {"oid": "49e4c8f2f1bca480a1e696552081aa2275b86ece", "url": "https://github.com/resteasy/resteasy/commit/49e4c8f2f1bca480a1e696552081aa2275b86ece", "message": "[RESTEASY-2683] NPE in ApacheHttpClient43Test because cache is null in MediaTypeMap", "committedDate": "2020-09-01T12:27:33Z", "type": "commit"}, {"oid": "49e4c8f2f1bca480a1e696552081aa2275b86ece", "url": "https://github.com/resteasy/resteasy/commit/49e4c8f2f1bca480a1e696552081aa2275b86ece", "message": "[RESTEASY-2683] NPE in ApacheHttpClient43Test because cache is null in MediaTypeMap", "committedDate": "2020-09-01T12:27:33Z", "type": "forcePushed"}]}