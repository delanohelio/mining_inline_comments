{"pr_number": 993, "pr_title": "OKAPI-868 Add timer to capture metrics of top slow methods", "pr_createdAt": "2020-10-09T03:37:43Z", "pr_url": "https://github.com/folio-org/okapi/pull/993", "timeline": [{"oid": "b2a1daeeeebcac0fd6938420bfee55a708767f52", "url": "https://github.com/folio-org/okapi/commit/b2a1daeeeebcac0fd6938420bfee55a708767f52", "message": "Add metrics for some slow methods", "committedDate": "2020-10-06T22:59:59Z", "type": "commit"}, {"oid": "0802b352d4a9db3237dce56ce8ece8c7d2b04f18", "url": "https://github.com/folio-org/okapi/commit/0802b352d4a9db3237dce56ce8ece8c7d2b04f18", "message": "Add metrics for one more decode call", "committedDate": "2020-10-09T03:02:47Z", "type": "commit"}, {"oid": "88a6aa6010a05d6dc653e57f9ebce8cdfca26e87", "url": "https://github.com/folio-org/okapi/commit/88a6aa6010a05d6dc653e57f9ebce8cdfca26e87", "message": "Merge branch 'master' into OKAPI-868", "committedDate": "2020-10-09T03:38:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI0NTMyNA==", "url": "https://github.com/folio-org/okapi/pull/993#discussion_r502245324", "bodyText": "This is the slowest method reported in OKAPI-868.\nCan you put in more granular metrics? For example\n\nProxyService.getModulesForRequest for enabledModules\nProxyService.getModulesForRequest for rr 1\nProxyService.getModulesForRequest for rr 2\nProxyService.getModulesForRequest sort\nProxyService.getModulesForRequest for mods", "author": "julianladisch", "createdAt": "2020-10-09T07:42:17Z", "path": "okapi-core/src/main/java/org/folio/okapi/managers/ProxyService.java", "diffHunk": "@@ -186,6 +189,9 @@ private boolean resolveRedirects(ProxyContext pc,\n   private List<ModuleInstance> getModulesForRequest(ProxyContext pc,\n                                                     List<ModuleDescriptor> enabledModules) {", "originalCommit": "88a6aa6010a05d6dc653e57f9ebce8cdfca26e87", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQwNDk3OQ==", "url": "https://github.com/folio-org/okapi/pull/993#discussion_r502404979", "bodyText": "Thanks @julianladisch. Looks like all slowness of getModulesForRequest are from moduleManager.getEnabledModules. I updated the OKAPI-868 with perf report link and relevant stacktraces screenshots. Please take a look the report and let me know if you feel strongly we should add more granular metrics for getModulesForRequest calls.", "author": "hjiebsco", "createdAt": "2020-10-09T12:51:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI0NTMyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQwNzExOA==", "url": "https://github.com/folio-org/okapi/pull/993#discussion_r502407118", "bodyText": "Never mind. I see what you mean. It is not about callers, but parts within getModulesForRequest itself.", "author": "hjiebsco", "createdAt": "2020-10-09T12:55:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI0NTMyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQzODQyMQ==", "url": "https://github.com/folio-org/okapi/pull/993#discussion_r502438421", "bodyText": "@julianladisch, I added granular metrics as suggested.", "author": "hjiebsco", "createdAt": "2020-10-09T13:46:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI0NTMyNA=="}], "type": "inlineReview", "revised_code": {"commit": "aebd99fc6c4d3ae95fcdbbddde4fbbc36e1516aa", "chunk": "diff --git a/okapi-core/src/main/java/org/folio/okapi/managers/ProxyService.java b/okapi-core/src/main/java/org/folio/okapi/managers/ProxyService.java\nindex 8195f7419..52f1d059d 100644\n--- a/okapi-core/src/main/java/org/folio/okapi/managers/ProxyService.java\n+++ b/okapi-core/src/main/java/org/folio/okapi/managers/ProxyService.java\n\n@@ -197,6 +197,7 @@ public class ProxyService {\n     final String id = req.getHeader(XOkapiHeaders.MODULE_ID);\n     pc.debug(\"getMods: Matching \" + req.method() + \" \" + req.uri());\n \n+    Timer.Sample sampleLoopEnabledModules = MetricsHelper.getTimerSample();\n     for (ModuleDescriptor md : enabledModules) {\n       pc.debug(\"getMods:  looking at \" + md.getId());\n       List<RoutingEntry> rr = null;\n"}}, {"oid": "ffc1d95b58c0d5921cdb3f9bda320df56903fa2d", "url": "https://github.com/folio-org/okapi/commit/ffc1d95b58c0d5921cdb3f9bda320df56903fa2d", "message": "Merge branch 'master' into OKAPI-868", "committedDate": "2020-10-09T12:55:18Z", "type": "commit"}, {"oid": "aebd99fc6c4d3ae95fcdbbddde4fbbc36e1516aa", "url": "https://github.com/folio-org/okapi/commit/aebd99fc6c4d3ae95fcdbbddde4fbbc36e1516aa", "message": "Add granual metrics for ProxyService.getModulesForRequest", "committedDate": "2020-10-09T13:29:32Z", "type": "commit"}]}