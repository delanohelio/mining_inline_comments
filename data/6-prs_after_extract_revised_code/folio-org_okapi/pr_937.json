{"pr_number": 937, "pr_title": "OKAPI-835 secure APIs is by default", "pr_createdAt": "2020-06-10T20:33:07Z", "pr_url": "https://github.com/folio-org/okapi/pull/937", "timeline": [{"oid": "3911d7a992dda5d992979ad40950780b3030f4de", "url": "https://github.com/folio-org/okapi/commit/3911d7a992dda5d992979ad40950780b3030f4de", "message": "Secure OKAPI internal APIs OKAPI-835\n\nDoes not pass yet.", "committedDate": "2020-06-09T13:56:23Z", "type": "commit"}, {"oid": "d2c43708165d40fdcaf3605608308436b5a9627f", "url": "https://github.com/folio-org/okapi/commit/d2c43708165d40fdcaf3605608308436b5a9627f", "message": "Missing use of token", "committedDate": "2020-06-10T20:01:55Z", "type": "commit"}, {"oid": "75fdeff7efb2aa15b5745e75f9b9715e12215447", "url": "https://github.com/folio-org/okapi/commit/75fdeff7efb2aa15b5745e75f9b9715e12215447", "message": "Complete; set version to 4.0.0-SNAPSHOT OKAPI-835", "committedDate": "2020-06-10T20:31:07Z", "type": "commit"}, {"oid": "8c11efe2e572b42aacdd695f186e3296d627a462", "url": "https://github.com/folio-org/okapi/commit/8c11efe2e572b42aacdd695f186e3296d627a462", "message": "Merge branch 'master' into OKAPI-835-secure-APIs-by-default", "committedDate": "2020-06-10T20:34:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQzMTE3MQ==", "url": "https://github.com/folio-org/okapi/pull/937#discussion_r438431171", "bodyText": "Can you fix the comment in lines 98-101?", "author": "julianladisch", "createdAt": "2020-06-10T21:58:14Z", "path": "okapi-core/src/main/java/org/folio/okapi/managers/InternalModule.java", "diffHunk": "@@ -216,12 +216,12 @@ public static ModuleDescriptor moduleDescriptor(String okapiVersion) {\n         + \"   }, {\"\n         + \"    \\\"methods\\\" :  [ \\\"GET\\\" ],\"\n         + \"    \\\"pathPattern\\\" : \\\"/_/proxy/modules\\\",\"\n-        + \"    \\\"permissionsRequired\\\" : [ ], \"\n+        + \"    \\\"permissionsRequired\\\" : [ \\\"okapi.proxy.modules.list\\\" ], \"", "originalCommit": "8c11efe2e572b42aacdd695f186e3296d627a462", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU2NTQyOA==", "url": "https://github.com/folio-org/okapi/pull/937#discussion_r438565428", "bodyText": "Sure.", "author": "adamdickmeiss", "createdAt": "2020-06-11T06:18:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQzMTE3MQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "bf45a5712218bbe6cb6aedcafd4f567f741ce8d3", "url": "https://github.com/folio-org/okapi/commit/bf45a5712218bbe6cb6aedcafd4f567f741ce8d3", "message": "permissionSets and okapi.readonly set", "committedDate": "2020-06-11T07:49:24Z", "type": "commit"}, {"oid": "5304b75137b6b5500d3f391ef3493b4951b57b32", "url": "https://github.com/folio-org/okapi/commit/5304b75137b6b5500d3f391ef3493b4951b57b32", "message": "Rework inspection of tenant permissions results in tests\n\nThe X-Tenant-Perms-Result was used to return permissions that\nwere posted (_tenantPermissions). A very bad idea when permissions\ncan become larger than 8k. Instead header module has a service\nto retrieve most recently permissions (/permResult).", "committedDate": "2020-06-11T09:35:46Z", "type": "commit"}, {"oid": "fcceeaf4eed0fdabb880fafe0af0f1b18b905e24", "url": "https://github.com/folio-org/okapi/commit/fcceeaf4eed0fdabb880fafe0af0f1b18b905e24", "message": "Remove useless curly brace", "committedDate": "2020-06-11T09:48:51Z", "type": "commit"}, {"oid": "99bff29bac49f4d74259dfdc8e30e2ec5ca5d43c", "url": "https://github.com/folio-org/okapi/commit/99bff29bac49f4d74259dfdc8e30e2ec5ca5d43c", "message": "Test trace header for system call", "committedDate": "2020-06-11T10:28:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODc5NjY4NA==", "url": "https://github.com/folio-org/okapi/pull/937#discussion_r438796684", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    .extract().body().asString();\n          \n          \n            \n            \n          \n          \n            \n                JsonArray ar = new JsonArray(body);\n          \n          \n            \n                context.assertEquals(2, ar.size());\n          \n          \n            \n                context.assertEquals(\"okapi-0.0.0\", ar.getJsonObject(0).getString(\"moduleId\"));\n          \n          \n            \n                context.assertEquals(\"header-1\", ar.getJsonObject(1).getString(\"moduleId\"));\n          \n          \n            \n                .body(\"$\", hasSize(2))\n          \n          \n            \n                .body(\"[0].moduleId\", is(\"okapi-0.0.0\"))\n          \n          \n            \n                .body(\"[1].moduleId\", is(\"header-1\"));\n          \n      \n    \n    \n  \n\nRestAssured has JSON path (GPath syntax) support. Simply use a recent RestAssured version, put RestAssured.defaultParser = Parser.JSON; into setUp, and import the hamcrest matcher:\n+import static org.hamcrest.collection.IsCollectionWithSize.hasSize;\n+import static org.hamcrest.Matchers.is;", "author": "julianladisch", "createdAt": "2020-06-11T13:46:43Z", "path": "okapi-core/src/test/java/org/folio/okapi/ModuleTest.java", "diffHunk": "@@ -1241,12 +1250,21 @@ public void testSystemInterfaces(TestContext context) {\n       .log().ifValidationFails()\n       .extract().headers();\n     final String locHdrEnable = headers.getValue(\"Location\");\n-    List<Header> list = headers.getList(\"X-Tenant-Perms-Result\");\n-    Assert.assertEquals(2, list.size()); // one for okapi, one for header-1\n-    Assert.assertThat(\"okapi perm result\",\n-      list.get(0).getValue(), containsString(\"okapi.all\"));\n-    Assert.assertThat(\"header-1perm result\",\n-      list.get(1).getValue(), containsString(\"header-1\"));\n+    // one trace from Okapi, two from the header module since it's called twice\n+    context.assertEquals(3, headers.getValues(\"X-Okapi-Trace\").size());\n+\n+    String body = given()\n+        .header(\"X-Okapi-Tenant\", okapiTenant)\n+        .get(\"/permResult\")\n+        .then()\n+        .statusCode(200)\n+        .log().ifValidationFails()\n+        .extract().body().asString();\n+\n+    JsonArray ar = new JsonArray(body);\n+    context.assertEquals(2, ar.size());\n+    context.assertEquals(\"okapi-0.0.0\", ar.getJsonObject(0).getString(\"moduleId\"));\n+    context.assertEquals(\"header-1\", ar.getJsonObject(1).getString(\"moduleId\"));", "originalCommit": "99bff29bac49f4d74259dfdc8e30e2ec5ca5d43c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM5MzM1Mg==", "url": "https://github.com/folio-org/okapi/pull/937#discussion_r441393352", "bodyText": "yet another way of doing things.. But shorter, so I've done that.", "author": "adamdickmeiss", "createdAt": "2020-06-17T09:00:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODc5NjY4NA=="}], "type": "inlineReview", "revised_code": {"commit": "0dc7e6444ecb280894902e9685e1838bdf99001e", "chunk": "diff --git a/okapi-core/src/test/java/org/folio/okapi/ModuleTest.java b/okapi-core/src/test/java/org/folio/okapi/ModuleTest.java\nindex 04811a28..4abd5bda 100644\n--- a/okapi-core/src/test/java/org/folio/okapi/ModuleTest.java\n+++ b/okapi-core/src/test/java/org/folio/okapi/ModuleTest.java\n\n@@ -1253,18 +1252,15 @@ public class ModuleTest {\n     // one trace from Okapi, two from the header module since it's called twice\n     context.assertEquals(3, headers.getValues(\"X-Okapi-Trace\").size());\n \n-    String body = given()\n+    given()\n         .header(\"X-Okapi-Tenant\", okapiTenant)\n         .get(\"/permResult\")\n         .then()\n         .statusCode(200)\n         .log().ifValidationFails()\n-        .extract().body().asString();\n-\n-    JsonArray ar = new JsonArray(body);\n-    context.assertEquals(2, ar.size());\n-    context.assertEquals(\"okapi-0.0.0\", ar.getJsonObject(0).getString(\"moduleId\"));\n-    context.assertEquals(\"header-1\", ar.getJsonObject(1).getString(\"moduleId\"));\n+        .body(\"$\", hasSize(2))\n+        .body(\"[0].moduleId\", is(\"okapi-0.0.0\"))\n+        .body(\"[1].moduleId\", is(\"header-1\"));\n \n     // Set up the test module\n     // It provides a _tenant interface, but no _tenantPermissions\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgwMDYwNw==", "url": "https://github.com/folio-org/okapi/pull/937#discussion_r438800607", "bodyText": "encode() does not guarantee the order of the keys. You probably want to compare without encode().", "author": "julianladisch", "createdAt": "2020-06-11T13:51:07Z", "path": "okapi-core/src/test/java/org/folio/okapi/ModuleTest.java", "diffHunk": "@@ -1330,9 +1348,20 @@ public void testSystemInterfaces(TestContext context) {\n       .then()\n       .statusCode(201)\n       .log().ifValidationFails()\n-      .header(\"X-Tenant-Perms-Result\", expPerms)\n       .extract().header(\"Location\");\n \n+    body = given()\n+        .header(\"X-Okapi-Tenant\", okapiTenant)\n+        .get(\"/permResult\")\n+        .then()\n+        .statusCode(200)\n+        .log().ifValidationFails()\n+        .extract().body().asString();\n+\n+    ar = new JsonArray(body);\n+    context.assertEquals(1, ar.size());\n+    context.assertEquals(new JsonObject(expPerms).encode(), ar.getJsonObject(0).encode());", "originalCommit": "99bff29bac49f4d74259dfdc8e30e2ec5ca5d43c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM5MjkwNQ==", "url": "https://github.com/folio-org/okapi/pull/937#discussion_r441392905", "bodyText": "yes", "author": "adamdickmeiss", "createdAt": "2020-06-17T08:59:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgwMDYwNw=="}], "type": "inlineReview", "revised_code": {"commit": "0dc7e6444ecb280894902e9685e1838bdf99001e", "chunk": "diff --git a/okapi-core/src/test/java/org/folio/okapi/ModuleTest.java b/okapi-core/src/test/java/org/folio/okapi/ModuleTest.java\nindex 04811a28..4abd5bda 100644\n--- a/okapi-core/src/test/java/org/folio/okapi/ModuleTest.java\n+++ b/okapi-core/src/test/java/org/folio/okapi/ModuleTest.java\n\n@@ -1350,7 +1346,7 @@ public class ModuleTest {\n       .log().ifValidationFails()\n       .extract().header(\"Location\");\n \n-    body = given()\n+    String body = given()\n         .header(\"X-Okapi-Tenant\", okapiTenant)\n         .get(\"/permResult\")\n         .then()\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgwMTEwNQ==", "url": "https://github.com/folio-org/okapi/pull/937#discussion_r438801105", "bodyText": "encode() does not guarantee the order of the keys. You probably want to compare without encode().", "author": "julianladisch", "createdAt": "2020-06-11T13:51:37Z", "path": "okapi-core/src/test/java/org/folio/okapi/ModuleTest.java", "diffHunk": "@@ -1361,9 +1390,20 @@ public void testSystemInterfaces(TestContext context) {\n       .then()\n       .statusCode(201)\n       .log().ifValidationFails()\n-      .header(\"X-Tenant-Perms-Result\", expPerms2)\n       .extract().header(\"Location\");\n \n+    body = given()\n+        .header(\"X-Okapi-Tenant\", okapiTenant)\n+        .get(\"/permResult\")\n+        .then()\n+        .statusCode(200)\n+        .log().ifValidationFails()\n+        .extract().body().asString();\n+\n+    ar = new JsonArray(body);\n+    context.assertEquals(1, ar.size());\n+    context.assertEquals(new JsonObject(expPerms2).encode(), ar.getJsonObject(0).encode());", "originalCommit": "99bff29bac49f4d74259dfdc8e30e2ec5ca5d43c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM5Mjg2Mg==", "url": "https://github.com/folio-org/okapi/pull/937#discussion_r441392862", "bodyText": "yes", "author": "adamdickmeiss", "createdAt": "2020-06-17T08:59:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgwMTEwNQ=="}], "type": "inlineReview", "revised_code": {"commit": "0dc7e6444ecb280894902e9685e1838bdf99001e", "chunk": "diff --git a/okapi-core/src/test/java/org/folio/okapi/ModuleTest.java b/okapi-core/src/test/java/org/folio/okapi/ModuleTest.java\nindex 04811a28..4abd5bda 100644\n--- a/okapi-core/src/test/java/org/folio/okapi/ModuleTest.java\n+++ b/okapi-core/src/test/java/org/folio/okapi/ModuleTest.java\n\n@@ -1402,7 +1398,7 @@ public class ModuleTest {\n \n     ar = new JsonArray(body);\n     context.assertEquals(1, ar.size());\n-    context.assertEquals(new JsonObject(expPerms2).encode(), ar.getJsonObject(0).encode());\n+    context.assertEquals(new JsonObject(expPerms2), ar.getJsonObject(0));\n \n     // Tests to see that we get a new auth token for the system calls\n     // Disable sample, so we can re-enable it after we have established auth\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgwMTI3Mg==", "url": "https://github.com/folio-org/okapi/pull/937#discussion_r438801272", "bodyText": "encode() does not guarantee the order of the keys. You probably want to compare without encode().", "author": "julianladisch", "createdAt": "2020-06-11T13:51:48Z", "path": "okapi-core/src/test/java/org/folio/okapi/ModuleTest.java", "diffHunk": "@@ -1420,8 +1460,20 @@ public void testSystemInterfaces(TestContext context) {\n       .then()\n       .statusCode(201)\n       .log().ifValidationFails()\n-      .header(\"X-Tenant-Perms-Result\", expPerms)\n       .extract().header(\"Location\");\n+\n+    body = given()\n+        .header(\"X-Okapi-Tenant\", okapiTenant)\n+        .get(\"/permResult\")\n+        .then()\n+        .statusCode(200)\n+        .log().ifValidationFails()\n+        .extract().body().asString();\n+\n+    ar = new JsonArray(body);\n+    context.assertEquals(2, ar.size());\n+    context.assertEquals(new JsonObject(expPerms).encode(), ar.getJsonObject(1).encode());", "originalCommit": "99bff29bac49f4d74259dfdc8e30e2ec5ca5d43c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM5Mjc4Mg==", "url": "https://github.com/folio-org/okapi/pull/937#discussion_r441392782", "bodyText": "yes", "author": "adamdickmeiss", "createdAt": "2020-06-17T08:59:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgwMTI3Mg=="}], "type": "inlineReview", "revised_code": {"commit": "0dc7e6444ecb280894902e9685e1838bdf99001e", "chunk": "diff --git a/okapi-core/src/test/java/org/folio/okapi/ModuleTest.java b/okapi-core/src/test/java/org/folio/okapi/ModuleTest.java\nindex 04811a28..4abd5bda 100644\n--- a/okapi-core/src/test/java/org/folio/okapi/ModuleTest.java\n+++ b/okapi-core/src/test/java/org/folio/okapi/ModuleTest.java\n\n@@ -1472,7 +1468,7 @@ public class ModuleTest {\n \n     ar = new JsonArray(body);\n     context.assertEquals(2, ar.size());\n-    context.assertEquals(new JsonObject(expPerms).encode(), ar.getJsonObject(1).encode());\n+    context.assertEquals(new JsonObject(expPerms), ar.getJsonObject(1));\n \n     // Check that the tenant interface and the tenantpermission interfaces\n     // were called with proper auth tokens and with ModulePermissions\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgwMzM4Mw==", "url": "https://github.com/folio-org/okapi/pull/937#discussion_r438803383", "bodyText": "encode() does not guarantee the order of the keys. You probably want to compare without encode().", "author": "julianladisch", "createdAt": "2020-06-11T13:53:53Z", "path": "okapi-test-header-module/src/test/java/HeaderModuleTest.java", "diffHunk": "@@ -78,11 +81,19 @@ public void test3(TestContext context, Async async) {\n     HashMap<String, String> headers = new HashMap<>();\n \n     OkapiClient cli = new OkapiClient(URL, vertx, headers);\n-    cli.post(\"/_/tenantPermissions\", \"a, b,\\nc\", res -> {\n-      cli.close();\n-      context.assertTrue(res.succeeded());\n-      context.assertEquals(\"a, b, c\", cli.getRespHeaders().get(\"X-Tenant-Perms-Result\"));\n-      async.complete();\n+    cli.post(\"/_/tenantPermissions\", \"{\", res1 -> {\n+      context.assertTrue(res1.failed());\n+      JsonObject perm = new JsonObject(\"{\\\"k\\\": \\\"v\\\"}\");\n+      cli.post(\"/_/tenantPermissions\", perm.encode(), res2 -> {\n+        context.assertTrue(res2.succeeded());\n+        context.assertEquals(\"GET test-header-module /_/tenantPermissions 200 -\",\n+            cli.getRespHeaders().get(XOkapiHeaders.TRACE));\n+        cli.get(\"/permResult\", res3 -> {\n+          cli.close();\n+          context.assertEquals(perm.encode(), new JsonArray(res3.result()).getJsonObject(0).encode());", "originalCommit": "99bff29bac49f4d74259dfdc8e30e2ec5ca5d43c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM5MjcyOQ==", "url": "https://github.com/folio-org/okapi/pull/937#discussion_r441392729", "bodyText": "yes.", "author": "adamdickmeiss", "createdAt": "2020-06-17T08:59:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgwMzM4Mw=="}], "type": "inlineReview", "revised_code": {"commit": "0dc7e6444ecb280894902e9685e1838bdf99001e", "chunk": "diff --git a/okapi-test-header-module/src/test/java/HeaderModuleTest.java b/okapi-test-header-module/src/test/java/HeaderModuleTest.java\nindex bdff457d..fcd4931b 100644\n--- a/okapi-test-header-module/src/test/java/HeaderModuleTest.java\n+++ b/okapi-test-header-module/src/test/java/HeaderModuleTest.java\n\n@@ -90,7 +90,7 @@ public class HeaderModuleTest {\n             cli.getRespHeaders().get(XOkapiHeaders.TRACE));\n         cli.get(\"/permResult\", res3 -> {\n           cli.close();\n-          context.assertEquals(perm.encode(), new JsonArray(res3.result()).getJsonObject(0).encode());\n+          context.assertEquals(perm, new JsonArray(res3.result()).getJsonObject(0));\n           async.complete();\n         });\n       });\n"}}, {"oid": "0dc7e6444ecb280894902e9685e1838bdf99001e", "url": "https://github.com/folio-org/okapi/commit/0dc7e6444ecb280894902e9685e1838bdf99001e", "message": "Merge branch 'master' into OKAPI-835-secure-APIs-by-default", "committedDate": "2020-06-17T08:52:38Z", "type": "commit"}, {"oid": "3bf792bdf16673180a247909b4fbe01c7cfc3903", "url": "https://github.com/folio-org/okapi/commit/3bf792bdf16673180a247909b4fbe01c7cfc3903", "message": "Merge remote-tracking branch 'origin/master' into OKAPI-835-secure-APIs-by-default", "committedDate": "2020-06-18T08:01:50Z", "type": "commit"}, {"oid": "0daa51de370764ba01a683715878eceb254e62d6", "url": "https://github.com/folio-org/okapi/commit/0daa51de370764ba01a683715878eceb254e62d6", "message": "Merge branch 'master' into OKAPI-835-secure-APIs-by-default", "committedDate": "2020-06-19T10:44:54Z", "type": "commit"}, {"oid": "e7bf60ff89051dc6e851ce699a4037e6a57fa7d4", "url": "https://github.com/folio-org/okapi/commit/e7bf60ff89051dc6e851ce699a4037e6a57fa7d4", "message": "Merge branch 'master' into OKAPI-835-secure-APIs-by-default", "committedDate": "2020-06-24T16:34:38Z", "type": "commit"}, {"oid": "0ae39d188f4c06e77868c7a60ae62b50e9f31234", "url": "https://github.com/folio-org/okapi/commit/0ae39d188f4c06e77868c7a60ae62b50e9f31234", "message": "Merge branch 'master' into OKAPI-835-secure-APIs-by-default", "committedDate": "2020-07-01T18:21:56Z", "type": "commit"}, {"oid": "a3b56aea21242829d736ec00626e1758d58b602e", "url": "https://github.com/folio-org/okapi/commit/a3b56aea21242829d736ec00626e1758d58b602e", "message": "Merge branch 'master' into OKAPI-835-secure-APIs-by-default", "committedDate": "2020-07-02T13:03:05Z", "type": "commit"}]}