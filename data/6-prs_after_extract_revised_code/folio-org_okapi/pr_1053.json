{"pr_number": 1053, "pr_title": "OKAPI-875 async tenant init", "pr_createdAt": "2020-12-05T18:25:31Z", "pr_url": "https://github.com/folio-org/okapi/pull/1053", "timeline": [{"oid": "c30b2d35ce5ece48dba17998ecb8d2bca90beaf0", "url": "https://github.com/folio-org/okapi/commit/c30b2d35ce5ece48dba17998ecb8d2bca90beaf0", "message": "Ignore idea iml files", "committedDate": "2020-12-04T10:04:54Z", "type": "commit"}, {"oid": "4045153865cbfcc7631b0ab9a5a201f64231f3db", "url": "https://github.com/folio-org/okapi/commit/4045153865cbfcc7631b0ab9a5a201f64231f3db", "message": "Make a few methods static", "committedDate": "2020-12-04T10:05:09Z", "type": "commit"}, {"oid": "19138a8a1cab580aa880f71a8c2f78cbd6a16342", "url": "https://github.com/folio-org/okapi/commit/19138a8a1cab580aa880f71a8c2f78cbd6a16342", "message": "Start work on module with async tenant init", "committedDate": "2020-12-04T10:47:04Z", "type": "commit"}, {"oid": "ae3b0712a21dae7d6cf8ace70a92d4511cda2c5f", "url": "https://github.com/folio-org/okapi/commit/ae3b0712a21dae7d6cf8ace70a92d4511cda2c5f", "message": "Begin test for tenant init v2", "committedDate": "2020-12-04T11:46:58Z", "type": "commit"}, {"oid": "9d2b5bcee907a2b1b91aa1644759cb4c61e4bcdc", "url": "https://github.com/folio-org/okapi/commit/9d2b5bcee907a2b1b91aa1644759cb4c61e4bcdc", "message": "Begin supporting version 2", "committedDate": "2020-12-04T15:17:36Z", "type": "commit"}, {"oid": "d9c2bb1b39c61c93c452389e026da1703a85a29d", "url": "https://github.com/folio-org/okapi/commit/d9c2bb1b39c61c93c452389e026da1703a85a29d", "message": "Codestyle fixes", "committedDate": "2020-12-04T21:23:42Z", "type": "commit"}, {"oid": "d37e28561f3d1ea004d7fd8dca825f2b1b4a3441", "url": "https://github.com/folio-org/okapi/commit/d37e28561f3d1ea004d7fd8dca825f2b1b4a3441", "message": "Async tenant init operational OKAPI-875", "committedDate": "2020-12-05T08:24:11Z", "type": "commit"}, {"oid": "b26104743f58a35367a6b237b2195621d21c5e88", "url": "https://github.com/folio-org/okapi/commit/b26104743f58a35367a6b237b2195621d21c5e88", "message": "Fail for missing id property or no Location in v2 response", "committedDate": "2020-12-05T18:25:03Z", "type": "commit"}, {"oid": "1a2fc1f891ec73edfbe513d00efdbf5a92bca938", "url": "https://github.com/folio-org/okapi/commit/1a2fc1f891ec73edfbe513d00efdbf5a92bca938", "message": "Merge remote-tracking branch 'origin/master' into OKAPI-875-async-tenant-init", "committedDate": "2020-12-05T18:25:44Z", "type": "commit"}, {"oid": "b994a36f5516ce4957437030f4601e342e3f53ee", "url": "https://github.com/folio-org/okapi/commit/b994a36f5516ce4957437030f4601e342e3f53ee", "message": "Return empty rather than null", "committedDate": "2020-12-06T10:11:55Z", "type": "commit"}, {"oid": "b2608933c0fb96f294009f67e9e17f1c439118a3", "url": "https://github.com/folio-org/okapi/commit/b2608933c0fb96f294009f67e9e17f1c439118a3", "message": "delete async tenant init job as well", "committedDate": "2020-12-06T11:00:12Z", "type": "commit"}, {"oid": "271d29769e092c965524409afd8e1d5400f79fa3", "url": "https://github.com/folio-org/okapi/commit/271d29769e092c965524409afd8e1d5400f79fa3", "message": "Fixes to accommodate codestyle", "committedDate": "2020-12-06T12:10:14Z", "type": "commit"}, {"oid": "1068a3e6191ed67214334477b69b964d5fef721e", "url": "https://github.com/folio-org/okapi/commit/1068a3e6191ed67214334477b69b964d5fef721e", "message": "No need to check for null", "committedDate": "2020-12-06T12:25:13Z", "type": "commit"}, {"oid": "1276edc6e88706c02eedb4b24a00bf5bc3fdcf58", "url": "https://github.com/folio-org/okapi/commit/1276edc6e88706c02eedb4b24a00bf5bc3fdcf58", "message": "Test tenant init error case; delete also init job on error", "committedDate": "2020-12-06T14:19:37Z", "type": "commit"}, {"oid": "8d9bac517c02383d87d4a4a8aa5b8c1e8320d528", "url": "https://github.com/folio-org/okapi/commit/8d9bac517c02383d87d4a4a8aa5b8c1e8320d528", "message": "Supply module in various test calls", "committedDate": "2020-12-07T07:51:49Z", "type": "commit"}, {"oid": "295e388e604f942e293bd859843a7bae9705d490", "url": "https://github.com/folio-org/okapi/commit/295e388e604f942e293bd859843a7bae9705d490", "message": "Refactor; not a timer module in install test", "committedDate": "2020-12-07T08:59:38Z", "type": "commit"}, {"oid": "74ef7ffbfdd7ceaed380be3f94ea46b8d3487651", "url": "https://github.com/folio-org/okapi/commit/74ef7ffbfdd7ceaed380be3f94ea46b8d3487651", "message": "Relay error messages as well; refactorings", "committedDate": "2020-12-07T09:15:54Z", "type": "commit"}, {"oid": "f3babc3a5fa3e83ee59ea9b6193590a171e4b8b6", "url": "https://github.com/folio-org/okapi/commit/f3babc3a5fa3e83ee59ea9b6193590a171e4b8b6", "message": "Allow POST with no Location for tenant init v2\n\nWhile not in the RAML it might be convenient for some modules\nto just be sync - if they know it will be \"fast\".", "committedDate": "2020-12-07T11:05:20Z", "type": "commit"}, {"oid": "f6a4931a13cb1a2848592ff31f3674042cb07582", "url": "https://github.com/folio-org/okapi/commit/f6a4931a13cb1a2848592ff31f3674042cb07582", "message": "Fail if Location is returned and v1", "committedDate": "2020-12-07T12:20:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUxNTQxNQ==", "url": "https://github.com/folio-org/okapi/pull/1053#discussion_r537515415", "bodyText": "Are there plans for other substitutions or can we use\n/**\n * Substitute {id} in path\n */\npublic void substPathId(String id) {\n  path = path.replace(\"{id}\", id);\n}", "author": "julianladisch", "createdAt": "2020-12-07T13:43:34Z", "path": "okapi-core/src/main/java/org/folio/okapi/bean/ModuleInstance.java", "diffHunk": "@@ -44,6 +44,10 @@ public ModuleInstance(ModuleDescriptor md, RoutingEntry re,\n     this.withRetry = false;\n   }\n \n+  public void substPath(String pattern, String value) {\n+    path = path.replace(pattern, value);\n+  }\n+", "originalCommit": "f6a4931a13cb1a2848592ff31f3674042cb07582", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUyMzA1MA==", "url": "https://github.com/folio-org/okapi/pull/1053#discussion_r537523050", "bodyText": "Not now. Can change it, if you like.", "author": "adamdickmeiss", "createdAt": "2020-12-07T13:54:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUxNTQxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc3NDk0MA==", "url": "https://github.com/folio-org/okapi/pull/1053#discussion_r538774940", "bodyText": "I like it. Otherwise the task is split: Call to replace in ModuleInstance, substitution string \"{id}\" in TenantManager.", "author": "julianladisch", "createdAt": "2020-12-08T20:14:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUxNTQxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTIwNDExOA==", "url": "https://github.com/folio-org/okapi/pull/1053#discussion_r539204118", "bodyText": "Done.", "author": "adamdickmeiss", "createdAt": "2020-12-09T10:51:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUxNTQxNQ=="}], "type": "inlineReview", "revised_code": {"commit": "809cace0e1d1a256f79671cafb188fd3cb6caf66", "chunk": "diff --git a/okapi-core/src/main/java/org/folio/okapi/bean/ModuleInstance.java b/okapi-core/src/main/java/org/folio/okapi/bean/ModuleInstance.java\nindex c530a551..a907ef9c 100644\n--- a/okapi-core/src/main/java/org/folio/okapi/bean/ModuleInstance.java\n+++ b/okapi-core/src/main/java/org/folio/okapi/bean/ModuleInstance.java\n\n@@ -44,8 +44,12 @@ public class ModuleInstance {\n     this.withRetry = false;\n   }\n \n-  public void substPath(String pattern, String value) {\n-    path = path.replace(pattern, value);\n+  /**\n+   * Substitute {id} in path.\n+   * @param id identifier\n+   */\n+  public void substPathId(String id) {\n+    path = path.replace(\"{id}\", id);\n   }\n \n   public ModuleDescriptor getModuleDescriptor() {\n"}}, {"oid": "a5336110510098695c126ca1f8b0ba430b2766b7", "url": "https://github.com/folio-org/okapi/commit/a5336110510098695c126ca1f8b0ba430b2766b7", "message": "Update raml-util and documentation", "committedDate": "2020-12-08T09:53:24Z", "type": "commit"}, {"oid": "7b078d16c8e6ad33689e51a4a51b30b15a37b74d", "url": "https://github.com/folio-org/okapi/commit/7b078d16c8e6ad33689e51a4a51b30b15a37b74d", "message": "Merge remote-tracking branch 'origin/master' into OKAPI-875-async-tenant-init", "committedDate": "2020-12-08T09:55:11Z", "type": "commit"}, {"oid": "fd0d0d3c2bcf6be2fe9e4223fe0d249d4a5497c4", "url": "https://github.com/folio-org/okapi/commit/fd0d0d3c2bcf6be2fe9e4223fe0d249d4a5497c4", "message": "Remove reference to permissions raml\n\nTenant permissions RAML is only defined in mod-permissions\nmodule. It should be shared in raml-util.", "committedDate": "2020-12-08T10:23:45Z", "type": "commit"}, {"oid": "0d2f9f8b46c3a48aa6b78a445836a1fd94259762", "url": "https://github.com/folio-org/okapi/commit/0d2f9f8b46c3a48aa6b78a445836a1fd94259762", "message": "Typo", "committedDate": "2020-12-08T10:26:51Z", "type": "commit"}, {"oid": "b0aaea881b45afe0f8fd10f594d8eb4bb14e2083", "url": "https://github.com/folio-org/okapi/commit/b0aaea881b45afe0f8fd10f594d8eb4bb14e2083", "message": "Minor reformatting", "committedDate": "2020-12-08T10:32:21Z", "type": "commit"}, {"oid": "25877f91101ff95000c83fdd9fc440bba735dddd", "url": "https://github.com/folio-org/okapi/commit/25877f91101ff95000c83fdd9fc440bba735dddd", "message": "Avoid two sections called \"Tenant Interface\"", "committedDate": "2020-12-08T10:36:56Z", "type": "commit"}, {"oid": "60970d469c20df017606ff7e216860b2fa1ae8ea", "url": "https://github.com/folio-org/okapi/commit/60970d469c20df017606ff7e216860b2fa1ae8ea", "message": "Update doc/guide.md\n\nCo-authored-by: julianladisch <julianladisch@users.noreply.github.com>", "committedDate": "2020-12-08T20:43:47Z", "type": "commit"}, {"oid": "1a7248c80a41e0ad40bb9f3ca97add86679705d2", "url": "https://github.com/folio-org/okapi/commit/1a7248c80a41e0ad40bb9f3ca97add86679705d2", "message": "Update doc/guide.md\n\nCo-authored-by: julianladisch <julianladisch@users.noreply.github.com>", "committedDate": "2020-12-08T20:44:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc5OTUyMQ==", "url": "https://github.com/folio-org/okapi/pull/1053#discussion_r538799521", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                String reqId = inst.getPath().replaceFirst(\"^[/_]*([^/]+).*\", \"$1\");\n          \n          \n            \n                // first path segment, but skip leading /_\n          \n          \n            \n                String reqId = inst.getPath().replaceFirst(\"^(/_)?/([^/]+).*\", \"$2\");", "author": "julianladisch", "createdAt": "2020-12-08T20:54:47Z", "path": "okapi-core/src/main/java/org/folio/okapi/managers/ProxyService.java", "diffHunk": "@@ -1193,6 +1193,40 @@ private static DeploymentDescriptor pickInstance(List<DeploymentDescriptor> inst\n         });\n   }\n \n+  private Future<OkapiClient> doCallSystemInterface2(\n+      MultiMap headersIn, String tenantId, String authToken,\n+      ModuleInstance inst, String modPerms, String request) {\n+\n+    Map<String, String> headers = sysReqHeaders(headersIn, tenantId, authToken, inst, modPerms);\n+    headers.put(XOkapiHeaders.URL_TO, inst.getUrl());\n+    logger.debug(\"syscall begin {} {}{}\", inst.getMethod(), inst.getUrl(), inst.getPath());\n+    OkapiClient cli = new OkapiClient(this.httpClient, inst.getUrl(), vertx, headers);\n+    String reqId = inst.getPath().replaceFirst(\"^[/_]*([^/]+).*\", \"$1\");", "originalCommit": "25877f91101ff95000c83fdd9fc440bba735dddd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTA5MTA0OA==", "url": "https://github.com/folio-org/okapi/pull/1053#discussion_r539091048", "bodyText": "This replaceFirst was not part of PR (only due to refactorings)..\nThe initial replaceFirst would make tenant from path  /_/tenant. Your suggestion ends up with an empty string.", "author": "adamdickmeiss", "createdAt": "2020-12-09T08:09:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc5OTUyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTIwNzkwNQ==", "url": "https://github.com/folio-org/okapi/pull/1053#discussion_r539207905", "bodyText": "System.out.println(\"/_/tenant\".replaceFirst(\"^(/_)?/([^/]+).*\", \"$2\"));\noutputs\ntenant\nFor all unit tests my suggestion returns the same result as before.", "author": "julianladisch", "createdAt": "2020-12-09T10:57:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc5OTUyMQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODgwODU3OQ==", "url": "https://github.com/folio-org/okapi/pull/1053#discussion_r538808579", "bodyText": "indexOf(\"/_/\") is always 0.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                String locationInstallJob = r.getHeader(\"Location\");\n          \n          \n            \n            \n          \n          \n            \n                String path = locationInstallJob.substring(locationInstallJob.indexOf(\"/_/\"));\n          \n          \n            \n                String path = r.getHeader(\"Location\");", "author": "julianladisch", "createdAt": "2020-12-08T21:08:19Z", "path": "okapi-core/src/test/java/org/folio/okapi/InstallTest.java", "diffHunk": "@@ -1119,7 +1047,325 @@ public void installTenantInit(TestContext context) {\n     Assert.assertTrue(\n         \"raml: \" + c.getLastReport().toString(),\n         c.getLastReport().isEmpty());\n-    timerServer.close();\n+    httpServerV1.close();\n+  }\n+\n+  void createAsyncInitModule(TestContext context, String module) {\n+    final String docModule = \"{\" + LS\n+        + \"  \\\"id\\\" : \\\"\" + module + \"\\\",\" + LS\n+        + \"  \\\"name\\\" : \\\"async tenant init module\\\",\" + LS\n+        + \"  \\\"provides\\\" : [ {\" + LS\n+        + \"    \\\"id\\\" : \\\"_tenant\\\",\" + LS\n+        + \"    \\\"version\\\" : \\\"2.0\\\",\" + LS\n+        + \"    \\\"interfaceType\\\" : \\\"system\\\",\" + LS\n+        + \"    \\\"handlers\\\" : [ {\" + LS\n+        + \"      \\\"methods\\\" : [ \\\"POST\\\" ],\" + LS\n+        + \"      \\\"pathPattern\\\" : \\\"/_/tenant\\\",\" + LS\n+        + \"      \\\"permissionsRequired\\\" : [ ]\" + LS\n+        + \"    }, {\" + LS\n+        + \"      \\\"methods\\\" : [ \\\"GET\\\", \\\"DELETE\\\" ],\" + LS\n+        + \"      \\\"pathPattern\\\" : \\\"/_/tenant/{id}\\\",\" + LS\n+        + \"      \\\"permissionsRequired\\\" : [ ]\" + LS\n+        + \"    } ]\" + LS\n+        + \"  } ],\" + LS\n+        + \"  \\\"requires\\\" : [ ]\" + LS\n+        + \"}\";\n+\n+    RestAssuredClient c = api.createRestAssured3();\n+    c.given()\n+        .header(\"Content-Type\", \"application/json\")\n+        .body(docModule).post(\"/_/proxy/modules\").then().statusCode(201);\n+  }\n+\n+  void deployAsyncInitModule(TestContext context, String module, int port) {\n+    final String nodeDoc1 = \"{\" + LS\n+        + \"  \\\"instId\\\" : \\\"localhost-\" + Integer.toString(port) + \"\\\",\" + LS\n+        + \"  \\\"srvcId\\\" : \\\"\" + module + \"\\\",\" + LS\n+        + \"  \\\"url\\\" : \\\"http://localhost:\" + Integer.toString(port) + \"\\\"\" + LS\n+        + \"}\";\n+\n+    RestAssuredClient c = api.createRestAssured3();\n+    c.given().header(\"Content-Type\", \"application/json\")\n+        .body(nodeDoc1).post(\"/_/discovery/modules\")\n+        .then().statusCode(201);\n+    Assert.assertTrue(\"raml: \" + c.getLastReport().toString(),\n+        c.getLastReport().isEmpty());\n+  }\n+\n+  JsonObject enableAndWait(TestContext context, String tenant, String module) {\n+    RestAssuredClient c = api.createRestAssured3();\n+    Response r = c.given()\n+        .header(\"Content-Type\", \"application/json\")\n+        .body(\"[ {\\\"id\\\" : \\\"\" + module + \"\\\", \\\"action\\\" : \\\"enable\\\"} ]\")\n+        .post(\"/_/proxy/tenants/\" + tenant + \"/install?async=true\")\n+        .then().statusCode(201)\n+        .body(equalTo(\"[ {\" + LS\n+            + \"  \\\"id\\\" : \\\"\"+ module + \"\\\",\" + LS\n+            + \"  \\\"action\\\" : \\\"enable\\\"\" + LS\n+            + \"} ]\"))\n+        .extract().response();\n+    Assert.assertTrue(\n+        \"raml: \" + c.getLastReport().toString(),\n+        c.getLastReport().isEmpty());\n+    String locationInstallJob = r.getHeader(\"Location\");\n+\n+    String path = locationInstallJob.substring(locationInstallJob.indexOf(\"/_/\"));", "originalCommit": "25877f91101ff95000c83fdd9fc440bba735dddd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTA5Mzc1MQ==", "url": "https://github.com/folio-org/okapi/pull/1053#discussion_r539093751", "bodyText": "LOL. Yes.. I was probably thinking that Location could be absolute URL!", "author": "adamdickmeiss", "createdAt": "2020-12-09T08:12:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODgwODU3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTIwNDc1Ng==", "url": "https://github.com/folio-org/okapi/pull/1053#discussion_r539204756", "bodyText": "LOL. Yes.. I was probably thinking that Location could be absolute URL!\n\nIs this the location for the status of the install task in Okapi or the location of the status of an individual module upgrade?", "author": "marcjohnson-kint", "createdAt": "2020-12-09T10:52:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODgwODU3OQ=="}], "type": "inlineReview", "revised_code": {"commit": "7d2ae07dfc5a6262dd610830d43608e591cb6cc9", "chunk": "diff --git a/okapi-core/src/test/java/org/folio/okapi/InstallTest.java b/okapi-core/src/test/java/org/folio/okapi/InstallTest.java\nindex 0f0381d3..2958e349 100644\n--- a/okapi-core/src/test/java/org/folio/okapi/InstallTest.java\n+++ b/okapi-core/src/test/java/org/folio/okapi/InstallTest.java\n\n@@ -1107,9 +1107,7 @@ public class InstallTest {\n     Assert.assertTrue(\n         \"raml: \" + c.getLastReport().toString(),\n         c.getLastReport().isEmpty());\n-    String locationInstallJob = r.getHeader(\"Location\");\n-\n-    String path = locationInstallJob.substring(locationInstallJob.indexOf(\"/_/\"));\n+    String path = r.getHeader(\"Location\");\n \n     return pollCompleteStrip(context, path);\n   }\n"}}, {"oid": "7dc652c6da0c14838ce9c3ace4e9c14ba4ad5eaf", "url": "https://github.com/folio-org/okapi/commit/7dc652c6da0c14838ce9c3ace4e9c14ba4ad5eaf", "message": "Update doc/guide.md\n\nCo-authored-by: julianladisch <julianladisch@users.noreply.github.com>", "committedDate": "2020-12-09T07:50:42Z", "type": "commit"}, {"oid": "809cace0e1d1a256f79671cafb188fd3cb6caf66", "url": "https://github.com/folio-org/okapi/commit/809cace0e1d1a256f79671cafb188fd3cb6caf66", "message": "substPathId", "committedDate": "2020-12-09T08:13:14Z", "type": "commit"}, {"oid": "7d2ae07dfc5a6262dd610830d43608e591cb6cc9", "url": "https://github.com/folio-org/okapi/commit/7d2ae07dfc5a6262dd610830d43608e591cb6cc9", "message": "Location is relative URL for our case", "committedDate": "2020-12-09T08:13:58Z", "type": "commit"}]}