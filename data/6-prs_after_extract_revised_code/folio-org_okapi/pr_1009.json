{"pr_number": 1009, "pr_title": "Fixes install does not honor dependencies OKAPI-925", "pr_createdAt": "2020-10-21T17:26:18Z", "pr_url": "https://github.com/folio-org/okapi/pull/1009", "timeline": [{"oid": "ceb807238687146f567cfe18dc838c271ae4d0ee", "url": "https://github.com/folio-org/okapi/commit/ceb807238687146f567cfe18dc838c271ae4d0ee", "message": "Fixes install does not honor dependencies OKAPI-925\n\nBut needs a good test for it.", "committedDate": "2020-10-21T17:25:47Z", "type": "commit"}, {"oid": "75fba27d8a6fb0eb62f2b662191da92c5811c02a", "url": "https://github.com/folio-org/okapi/commit/75fba27d8a6fb0eb62f2b662191da92c5811c02a", "message": "Little more testing", "committedDate": "2020-10-22T08:24:07Z", "type": "commit"}, {"oid": "a75380804e2d96d327ec1ddbfa626955be7a0e00", "url": "https://github.com/folio-org/okapi/commit/a75380804e2d96d327ec1ddbfa626955be7a0e00", "message": "Provoke upgradeLeafs error", "committedDate": "2020-10-22T08:58:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDEyOTA5OQ==", "url": "https://github.com/folio-org/okapi/pull/1009#discussion_r510129099", "bodyText": "The list values are not needed. This can be simplified if upgradeLeafs2 returns a boolean that is true if something upgraded:\nwhile (upgradeLeafs2(modsAvailable, modsEnabled, tml)) {\n  // something upgraded.. try again\n}", "author": "julianladisch", "createdAt": "2020-10-22T12:43:21Z", "path": "okapi-core/src/main/java/org/folio/okapi/util/DepResolution.java", "diffHunk": "@@ -506,27 +506,41 @@ private static void addOrReplace(List<TenantModuleDescriptor> tml, ModuleDescrip\n   }\n \n   private static void upgradeLeafs(\n-      ModuleDescriptor md, Map<String, ModuleDescriptor> modsAvailable,\n+      Map<String, ModuleDescriptor> modsAvailable,\n       Map<String, ModuleDescriptor> modsEnabled, List<TenantModuleDescriptor> tml) {\n-    Iterator<ModuleDescriptor> it = modsEnabled.values().iterator();\n-    while (it.hasNext()) {\n-      ModuleDescriptor me = it.next();\n-      if (me.equals(md)) {\n-        continue;\n+    while (true) {\n+      List<String> ret = upgradeLeafs2(modsAvailable, modsEnabled, tml);\n+      if (ret == null) { // nothing done\n+        return;\n+      }\n+      if (!ret.isEmpty()) { // error\n+        return;\n       }\n-      ModuleDescriptor mdTo = null;\n-      for (InterfaceDescriptor prov : md.getProvidesList()) {\n-        for (InterfaceDescriptor req : me.getRequiresOptionalList()) {\n-          if (prov.getId().equals(req.getId()) && !prov.isCompatible(req)) {\n-            mdTo = lookupAvailableForProvided(modsAvailable, me, prov, mdTo);\n+      // something upgraded.. try again\n+    }\n+  }", "originalCommit": "a75380804e2d96d327ec1ddbfa626955be7a0e00", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDEzNzU0Mw==", "url": "https://github.com/folio-org/okapi/pull/1009#discussion_r510137543", "bodyText": "ok", "author": "adamdickmeiss", "createdAt": "2020-10-22T12:55:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDEyOTA5OQ=="}], "type": "inlineReview", "revised_code": {"commit": "bd837d110d798ad6584232980cdf3f7aa2120c44", "chunk": "diff --git a/okapi-core/src/main/java/org/folio/okapi/util/DepResolution.java b/okapi-core/src/main/java/org/folio/okapi/util/DepResolution.java\nindex fe98a357..792eebe8 100644\n--- a/okapi-core/src/main/java/org/folio/okapi/util/DepResolution.java\n+++ b/okapi-core/src/main/java/org/folio/okapi/util/DepResolution.java\n\n@@ -508,19 +508,12 @@ public class DepResolution {\n   private static void upgradeLeafs(\n       Map<String, ModuleDescriptor> modsAvailable,\n       Map<String, ModuleDescriptor> modsEnabled, List<TenantModuleDescriptor> tml) {\n-    while (true) {\n-      List<String> ret = upgradeLeafs2(modsAvailable, modsEnabled, tml);\n-      if (ret == null) { // nothing done\n-        return;\n-      }\n-      if (!ret.isEmpty()) { // error\n-        return;\n-      }\n+    while (upgradeLeafs2(modsAvailable, modsEnabled, tml)) {\n       // something upgraded.. try again\n     }\n   }\n \n-  private static List<String> upgradeLeafs2(\n+  private static boolean upgradeLeafs2(\n       Map<String, ModuleDescriptor> modsAvailable,\n       Map<String, ModuleDescriptor> modsEnabled, List<TenantModuleDescriptor> tml) {\n \n"}}, {"oid": "bd837d110d798ad6584232980cdf3f7aa2120c44", "url": "https://github.com/folio-org/okapi/commit/bd837d110d798ad6584232980cdf3f7aa2120c44", "message": "upgradeLeafs2 returns boolean", "committedDate": "2020-10-22T13:01:49Z", "type": "commit"}, {"oid": "5cf7aba3040e3d958e6686b78d84437e249c8160", "url": "https://github.com/folio-org/okapi/commit/5cf7aba3040e3d958e6686b78d84437e249c8160", "message": "Merge remote-tracking branch 'origin/master' into OKAPI-925-install-does-not-honor-specified-modules-ids", "committedDate": "2020-10-22T13:12:48Z", "type": "commit"}, {"oid": "a09dd855474c45eac58c6ca4c5c0cae1f8644e6c", "url": "https://github.com/folio-org/okapi/commit/a09dd855474c45eac58c6ca4c5c0cae1f8644e6c", "message": "Merge branch 'master' into OKAPI-925-install-does-not-honor-specified-modules-ids", "committedDate": "2020-10-22T13:20:09Z", "type": "commit"}]}