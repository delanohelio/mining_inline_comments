{"pr_number": 1063, "pr_title": "OKAPI-968: Unhandled exception in DockerModuleHandle.request", "pr_createdAt": "2020-12-18T22:54:04Z", "pr_url": "https://github.com/folio-org/okapi/pull/1063", "timeline": [{"oid": "8127a1345ac9073376b0105498c930d4cea614fe", "url": "https://github.com/folio-org/okapi/commit/8127a1345ac9073376b0105498c930d4cea614fe", "message": "OKAPI-968: Unhandled exception in DockerModuleHandle.request\n\nVert.x HttpClient.request doesn't return all exceptions as a failed future but also directly throws some of them.\n\nExample:\n```\n2020-12-18T22:03:31,099 INFO  DockerModuleHandle   delete container 8ee1e1ec95ecc311d7d603a4d5871ac17dd67c860a48f613ce0c7199e4e4c59b image folioci/mod-gobi:1.\n8.0-SNAPSHOT.98\n2020-12-18T22:03:31,102 ERROR ?                    Unhandled exception\njava.lang.IllegalStateException: Client is closed\n        at io.vertx.core.http.impl.HttpClientImpl.checkClosed(HttpClientImpl.java:634) ~[okapi-core-fat.jar:?]\n        at io.vertx.core.http.impl.HttpClientImpl.request(HttpClientImpl.java:542) ~[okapi-core-fat.jar:?]\n        at io.vertx.core.http.impl.HttpClientImpl.request(HttpClientImpl.java:396) ~[okapi-core-fat.jar:?]\n        at io.vertx.core.http.impl.HttpClientImpl.request(HttpClientImpl.java:391) ~[okapi-core-fat.jar:?]\n        at org.folio.okapi.service.impl.DockerModuleHandle.request(DockerModuleHandle.java:145) ~[okapi-core-fat.jar:?]\n        at org.folio.okapi.service.impl.DockerModuleHandle.deleteUrl(DockerModuleHandle.java:159) ~[okapi-core-fat.jar:?]\n        at org.folio.okapi.service.impl.DockerModuleHandle.deleteContainer(DockerModuleHandle.java:175) ~[okapi-core-fat.jar:?]\n        at org.folio.okapi.service.impl.DockerModuleHandle.lambda$prepareContainer$18(DockerModuleHandle.java:430) ~[okapi-core-fat.jar:?]\n```\n\nTask:\nCatch them and pass them as a failed future.", "committedDate": "2020-12-18T22:51:51Z", "type": "commit"}, {"oid": "82e3afea3c0cb1712840965e978162a59d85f92a", "url": "https://github.com/folio-org/okapi/commit/82e3afea3c0cb1712840965e978162a59d85f92a", "message": "Merge branch 'master' into OKAPI-968-DockerModuleHandle.request-exception", "committedDate": "2021-01-12T16:15:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTk2NDk1Ng==", "url": "https://github.com/folio-org/okapi/pull/1063#discussion_r555964956", "bodyText": "Should make the try block smaller to start from line 146?", "author": "hjiebsco", "createdAt": "2021-01-12T17:54:12Z", "path": "okapi-core/src/main/java/org/folio/okapi/service/impl/DockerModuleHandle.java", "diffHunk": "@@ -136,18 +136,22 @@ static String setupDockerAddress(StringBuilder socketAddress, String u) {\n   private Future<HttpClientResponse> request(HttpMethod method, String url,\n                                              MultiMap headers, Buffer body) {\n \n-    RequestOptions requestOptions = new RequestOptions()\n-        .setMethod(method)\n-        .setAbsoluteURI(dockerUrl + url);\n-    if (socketAddress != null) {\n-      requestOptions.setServer(socketAddress);\n-    }\n-    return client.request(requestOptions).compose(request -> {\n-      if (headers != null) {\n-        request.headers().setAll(headers);\n+    try {", "originalCommit": "8127a1345ac9073376b0105498c930d4cea614fe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjExMjA1Ng==", "url": "https://github.com/folio-org/okapi/pull/1063#discussion_r556112056", "bodyText": "Done.", "author": "julianladisch", "createdAt": "2021-01-12T21:38:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTk2NDk1Ng=="}], "type": "inlineReview", "revised_code": {"commit": "f084cbd1e5c81f372983db77ee830b85eb10d2e5", "chunk": "diff --git a/okapi-core/src/main/java/org/folio/okapi/service/impl/DockerModuleHandle.java b/okapi-core/src/main/java/org/folio/okapi/service/impl/DockerModuleHandle.java\nindex c31777eb..8e772f9e 100644\n--- a/okapi-core/src/main/java/org/folio/okapi/service/impl/DockerModuleHandle.java\n+++ b/okapi-core/src/main/java/org/folio/okapi/service/impl/DockerModuleHandle.java\n\n@@ -136,22 +136,18 @@ public class DockerModuleHandle implements ModuleHandle {\n   private Future<HttpClientResponse> request(HttpMethod method, String url,\n                                              MultiMap headers, Buffer body) {\n \n-    try {\n-      RequestOptions requestOptions = new RequestOptions()\n-          .setMethod(method)\n-          .setAbsoluteURI(dockerUrl + url);\n-      if (socketAddress != null) {\n-        requestOptions.setServer(socketAddress);\n-      }\n-      return client.request(requestOptions).compose(request -> {\n-        if (headers != null) {\n-          request.headers().setAll(headers);\n-        }\n-        return request.send(body);\n-      });\n-    } catch (Throwable e) {\n-      return Future.failedFuture(e);\n+    RequestOptions requestOptions = new RequestOptions()\n+        .setMethod(method)\n+        .setAbsoluteURI(dockerUrl + url);\n+    if (socketAddress != null) {\n+      requestOptions.setServer(socketAddress);\n     }\n+    return client.request(requestOptions).compose(request -> {\n+      if (headers != null) {\n+        request.headers().setAll(headers);\n+      }\n+      return request.send(body);\n+    });\n   }\n \n   Future<Void> postUrl(String url, String msg) {\n"}}, {"oid": "f084cbd1e5c81f372983db77ee830b85eb10d2e5", "url": "https://github.com/folio-org/okapi/commit/f084cbd1e5c81f372983db77ee830b85eb10d2e5", "message": "Extract try-catch into FuturisedHttpClient; reuse", "committedDate": "2021-01-12T21:33:18Z", "type": "commit"}, {"oid": "703a71f2332e3e14b0905c31794caa5adcf3b357", "url": "https://github.com/folio-org/okapi/commit/703a71f2332e3e14b0905c31794caa5adcf3b357", "message": "Merge branch 'master' into OKAPI-968-DockerModuleHandle.request-exception", "committedDate": "2021-01-12T21:44:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjEzMDAxMw==", "url": "https://github.com/folio-org/okapi/pull/1063#discussion_r556130013", "bodyText": "OkapiClient does not need this new FuturisedHttpClient?", "author": "hjiebsco", "createdAt": "2021-01-12T22:13:03Z", "path": "okapi-core/src/main/java/org/folio/okapi/managers/ProxyService.java", "diffHunk": "@@ -1201,7 +1201,7 @@ private static DeploymentDescriptor pickInstance(List<DeploymentDescriptor> inst\n     Map<String, String> headers = sysReqHeaders(headersIn, tenantId, authToken, inst, modPerms);\n     headers.put(XOkapiHeaders.URL_TO, inst.getUrl());\n     logger.debug(\"syscall begin {} {}{}\", inst.getMethod(), inst.getUrl(), inst.getPath());\n-    OkapiClient cli = new OkapiClient(this.httpClient, inst.getUrl(), vertx, headers);\n+    OkapiClient cli = new OkapiClient(httpClient.getHttpClient(), inst.getUrl(), vertx, headers);", "originalCommit": "703a71f2332e3e14b0905c31794caa5adcf3b357", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjE0ODg1NA==", "url": "https://github.com/folio-org/okapi/pull/1063#discussion_r556148854", "bodyText": "OkapiClient wraps HttpClient into WebClient, and WebClient wraps the call into a try-catch-block: https://github.com/vert-x3/vertx-web/blob/4.0.0/vertx-web-client/src/main/java/io/vertx/ext/web/client/impl/HttpContext.java#L305", "author": "julianladisch", "createdAt": "2021-01-12T22:50:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjEzMDAxMw=="}], "type": "inlineReview", "revised_code": null}, {"oid": "e645af97b04564104b5b54c166134a36d794b4b0", "url": "https://github.com/folio-org/okapi/commit/e645af97b04564104b5b54c166134a36d794b4b0", "message": "Fix FuturisedHttpClient test; fix 'Connection refused' translation", "committedDate": "2021-01-12T22:36:13Z", "type": "commit"}]}