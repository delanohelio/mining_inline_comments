{"pr_number": 990, "pr_title": "OKAPI-911: Unit test failures for ProcessModuleHandleTest", "pr_createdAt": "2020-10-07T08:36:52Z", "pr_url": "https://github.com/folio-org/okapi/pull/990", "timeline": [{"oid": "aca0c51d21bae5bb27716ac6ca5e92f81a952bbb", "url": "https://github.com/folio-org/okapi/commit/aca0c51d21bae5bb27716ac6ca5e92f81a952bbb", "message": "Test double start+stop", "committedDate": "2020-10-07T08:34:47Z", "type": "commit"}, {"oid": "92484ab9c9cf46e4ef3a80a1f179eddd8f5c4522", "url": "https://github.com/folio-org/okapi/commit/92484ab9c9cf46e4ef3a80a1f179eddd8f5c4522", "message": "Avoid executeBlocking for ProcessModuleHandle", "committedDate": "2020-10-07T08:34:51Z", "type": "commit"}, {"oid": "7e2465576a0ea44fe8697372d6fbf508d25a8e7f", "url": "https://github.com/folio-org/okapi/commit/7e2465576a0ea44fe8697372d6fbf508d25a8e7f", "message": "No need to wait for cmdineStop", "committedDate": "2020-10-07T09:03:20Z", "type": "commit"}, {"oid": "6d1265d08d64f3dfbd4aa53c51567490e6ad44d2", "url": "https://github.com/folio-org/okapi/commit/6d1265d08d64f3dfbd4aa53c51567490e6ad44d2", "message": "Shut down that NetClient for each tryConnect attempt", "committedDate": "2020-10-07T17:25:07Z", "type": "commit"}, {"oid": "87e886738bec5cea8137cb09a6a9573e83a2df09", "url": "https://github.com/folio-org/okapi/commit/87e886738bec5cea8137cb09a6a9573e83a2df09", "message": "Merge branch 'master' into OKAPI-911-unit-test-failures-for-process-module-handle-test", "committedDate": "2020-10-08T08:05:29Z", "type": "commit"}, {"oid": "0a2d04b1c728930aab051bec2e87764f0348e1ed", "url": "https://github.com/folio-org/okapi/commit/0a2d04b1c728930aab051bec2e87764f0348e1ed", "message": "testExecMultiple: spawn 3 rather than 9 modules\n\nSpawning 9 takes a long time on slower systems which gives\ntest errors (when in reality waiting longer would make it succeed).", "committedDate": "2020-10-08T09:07:29Z", "type": "commit"}, {"oid": "361afa6474a222b8bbf607fc0906de10ab7af0ca", "url": "https://github.com/folio-org/okapi/commit/361afa6474a222b8bbf607fc0906de10ab7af0ca", "message": "Merge branch 'master' into OKAPI-911-unit-test-failures-for-process-module-handle-test", "committedDate": "2020-10-08T09:10:14Z", "type": "commit"}, {"oid": "b46c873d6504431e80178c4eb738670b402a1465", "url": "https://github.com/folio-org/okapi/commit/b46c873d6504431e80178c4eb738670b402a1465", "message": "Increase wait for install/deployment in InstallTest", "committedDate": "2020-10-08T13:34:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTc2NjY3Ng==", "url": "https://github.com/folio-org/okapi/pull/990#discussion_r501766676", "bodyText": "Can you also remove the import of TimeUnit?", "author": "julianladisch", "createdAt": "2020-10-08T14:28:45Z", "path": "okapi-core/src/main/java/org/folio/okapi/service/impl/ProcessModuleHandle.java", "diffHunk": "@@ -125,48 +129,39 @@ private NuProcess launch(Vertx vertx, String id, EnvEntry[] env,\n     return process;\n   }\n \n-  @SuppressWarnings(\"indentation\")\n   private Future<Void> start2() {\n-    return vertx.executeBlocking(future -> {\n-      if (process == null) {\n-        String c = \"\";\n-        try {\n-          String[] l;\n-          if (exec != null) {\n-            if (!exec.contains(\"%p\")) {\n-              future.fail(\"Can not deploy: No %p in the exec line\");\n-              return;\n-            }\n-            c = exec.replace(\"%p\", Integer.toString(port));\n-            l = c.split(\" \");\n-          } else if (cmdlineStart != null) {\n-            if (!cmdlineStart.contains(\"%p\")) {\n-              future.fail(\"Can not deploy: No %p in the cmdlineStart\");\n-              return;\n-            }\n-            c = cmdlineStart.replace(\"%p\", Integer.toString(port));\n-            l = new String[]{\"sh\", \"-c\", c};\n-          } else {\n-            future.fail(\"Can not deploy: No exec, no CmdlineStart in LaunchDescriptor\");\n-            return;\n-          }\n-          process = launch(vertx, id, env, l);\n-          process.waitFor(1, TimeUnit.SECONDS);", "originalCommit": "b46c873d6504431e80178c4eb738670b402a1465", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c4c6f24fc529082619a1dd26d05667379f235789", "chunk": "diff --git a/okapi-core/src/main/java/org/folio/okapi/service/impl/ProcessModuleHandle.java b/okapi-core/src/main/java/org/folio/okapi/service/impl/ProcessModuleHandle.java\nindex a4ba813c..15e9bef1 100644\n--- a/okapi-core/src/main/java/org/folio/okapi/service/impl/ProcessModuleHandle.java\n+++ b/okapi-core/src/main/java/org/folio/okapi/service/impl/ProcessModuleHandle.java\n\n@@ -150,22 +149,21 @@ public class ProcessModuleHandle extends NuAbstractProcessHandler implements Mod\n     final String commandLineF = commandLine;\n     process = launch(vertx, id, env, l);\n     Promise<Void> promise = Promise.promise();\n-    vertx.setTimer(1000, timerRes -> {\n-      if (!process.isRunning() && exitCode != 0) {\n-        if (exitCode == Integer.MIN_VALUE) {\n-          promise.fail(messages.getMessage(\"11504\", commandLineF));\n-        } else {\n-          promise.fail(messages.getMessage(\"11500\", exitCode));\n-        }\n-      } else {\n+    // time to wait for process status.. when a port is present (always in real life)..\n+    // The waitReady will check if process eventually starts listening on port\n+    vertx.setTimer(port == 0 ? 3000 : 1000, timerRes -> {\n+      if (process.isRunning() || exitCode == 0) {\n         promise.complete();\n+        return;\n+      }\n+      if (exitCode == Integer.MIN_VALUE) {\n+        promise.fail(messages.getMessage(\"11504\", commandLineF));\n+      } else {\n+        promise.fail(messages.getMessage(\"11500\", exitCode));\n       }\n     });\n-    return promise.future().compose(x -> start3());\n-  }\n-\n-  private Future<Void> start3() {\n-    return tcpPortWaiting.waitReady(process).onFailure(x -> stopProcess());\n+    return promise.future()\n+        .compose(x -> tcpPortWaiting.waitReady(process).onFailure(y -> stopProcess()));\n   }\n \n   private Future<Void> waitPortToClose(int iter) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTc4MzMzNA==", "url": "https://github.com/folio-org/okapi/pull/990#discussion_r501783334", "bodyText": "A few lines below we have this code:\n  socket.close();\n  return Future.failedFuture(messages.getMessage(\"11502\", Integer.toString(port)));\n\nThis doesn't wait until the socket has been closed. Better:\n  return socket.close().otherwiseEmpty()\n      .compose(x -> Future.failedFuture(messages.getMessage(\"11502\", Integer.toString(port))));", "author": "julianladisch", "createdAt": "2020-10-08T14:49:51Z", "path": "okapi-core/src/main/java/org/folio/okapi/service/impl/ProcessModuleHandle.java", "diffHunk": "@@ -72,6 +73,9 @@ public ProcessModuleHandle(Vertx vertx, LaunchDescriptor desc, String id,\n \n   @Override\n   public Future<Void> start() {\n+    if (process != null) {\n+      return Future.failedFuture(\"already started \" + commandLine);\n+    }\n     if (port == 0) {\n       return start2();\n     }", "originalCommit": "b46c873d6504431e80178c4eb738670b402a1465", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTg2NDgxMQ==", "url": "https://github.com/folio-org/okapi/pull/990#discussion_r501864811", "bodyText": "ok.", "author": "adamdickmeiss", "createdAt": "2020-10-08T16:46:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTc4MzMzNA=="}], "type": "inlineReview", "revised_code": {"commit": "fbcd20f96bddecb0ba00afc38f6bcb4cbce718a4", "chunk": "diff --git a/okapi-core/src/main/java/org/folio/okapi/service/impl/ProcessModuleHandle.java b/okapi-core/src/main/java/org/folio/okapi/service/impl/ProcessModuleHandle.java\nindex a4ba813c..21875d9a 100644\n--- a/okapi-core/src/main/java/org/folio/okapi/service/impl/ProcessModuleHandle.java\n+++ b/okapi-core/src/main/java/org/folio/okapi/service/impl/ProcessModuleHandle.java\n\n@@ -83,8 +82,8 @@ public class ProcessModuleHandle extends NuAbstractProcessHandler implements Mod\n     NetClientOptions options = new NetClientOptions().setConnectTimeout(200);\n     NetClient c = vertx.createNetClient(options);\n     return c.connect(port, \"localhost\").compose(socket -> {\n-      socket.close();\n-      return Future.failedFuture(messages.getMessage(\"11502\", Integer.toString(port)));\n+      return socket.close().otherwiseEmpty()\n+          .compose(x -> Future.failedFuture(messages.getMessage(\"11502\", Integer.toString(port))));\n     }, fail -> start2());\n   }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTc4NzkzMg==", "url": "https://github.com/folio-org/okapi/pull/990#discussion_r501787932", "bodyText": "Easier to read:\nif (process.isRunning() || exitCode == 0) {\n  promise.complete();\n  return;\n}\nif (exitCode == Integer.MIN_VALUE) {\n  promise.fail(messages.getMessage(\"11504\", commandLineF));\n} else {\n  promise.fail(messages.getMessage(\"11500\", exitCode));\n}", "author": "julianladisch", "createdAt": "2020-10-08T14:55:36Z", "path": "okapi-core/src/main/java/org/folio/okapi/service/impl/ProcessModuleHandle.java", "diffHunk": "@@ -125,48 +129,39 @@ private NuProcess launch(Vertx vertx, String id, EnvEntry[] env,\n     return process;\n   }\n \n-  @SuppressWarnings(\"indentation\")\n   private Future<Void> start2() {\n-    return vertx.executeBlocking(future -> {\n-      if (process == null) {\n-        String c = \"\";\n-        try {\n-          String[] l;\n-          if (exec != null) {\n-            if (!exec.contains(\"%p\")) {\n-              future.fail(\"Can not deploy: No %p in the exec line\");\n-              return;\n-            }\n-            c = exec.replace(\"%p\", Integer.toString(port));\n-            l = c.split(\" \");\n-          } else if (cmdlineStart != null) {\n-            if (!cmdlineStart.contains(\"%p\")) {\n-              future.fail(\"Can not deploy: No %p in the cmdlineStart\");\n-              return;\n-            }\n-            c = cmdlineStart.replace(\"%p\", Integer.toString(port));\n-            l = new String[]{\"sh\", \"-c\", c};\n-          } else {\n-            future.fail(\"Can not deploy: No exec, no CmdlineStart in LaunchDescriptor\");\n-            return;\n-          }\n-          process = launch(vertx, id, env, l);\n-          process.waitFor(1, TimeUnit.SECONDS);\n-        } catch (InterruptedException ex) {\n-          logger.warn(\"when starting {}\", c, ex);\n-          Thread.currentThread().interrupt();\n-        }\n-        if (!process.isRunning() && exitCode != 0) {\n-          if (exitCode == Integer.MIN_VALUE) {\n-            future.handle(Future.failedFuture(messages.getMessage(\"11504\", c)));\n-          } else {\n-            future.handle(Future.failedFuture(messages.getMessage(\"11500\", exitCode)));\n-          }\n-          return;\n+    commandLine = \"\";\n+    String[] l;\n+    if (exec != null) {\n+      if (!exec.contains(\"%p\")) {\n+        return Future.failedFuture(\"Can not deploy: No %p in the exec line\");\n+      }\n+      commandLine = exec.replace(\"%p\", Integer.toString(port));\n+      l = commandLine.split(\" \");\n+    } else if (cmdlineStart != null) {\n+      if (!cmdlineStart.contains(\"%p\")) {\n+        return Future.failedFuture(\"Can not deploy: No %p in the cmdlineStart\");\n+      }\n+      commandLine = cmdlineStart.replace(\"%p\", Integer.toString(port));\n+      l = new String[]{\"sh\", \"-c\", commandLine};\n+    } else {\n+      return Future.failedFuture(\"Can not deploy: No exec, no CmdlineStart in LaunchDescriptor\");\n+    }\n+    final String commandLineF = commandLine;\n+    process = launch(vertx, id, env, l);\n+    Promise<Void> promise = Promise.promise();\n+    vertx.setTimer(1000, timerRes -> {\n+      if (!process.isRunning() && exitCode != 0) {", "originalCommit": "b46c873d6504431e80178c4eb738670b402a1465", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTg2NDkzOQ==", "url": "https://github.com/folio-org/okapi/pull/990#discussion_r501864939", "bodyText": "ok. In two places.", "author": "adamdickmeiss", "createdAt": "2020-10-08T16:46:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTc4NzkzMg=="}], "type": "inlineReview", "revised_code": {"commit": "c4c6f24fc529082619a1dd26d05667379f235789", "chunk": "diff --git a/okapi-core/src/main/java/org/folio/okapi/service/impl/ProcessModuleHandle.java b/okapi-core/src/main/java/org/folio/okapi/service/impl/ProcessModuleHandle.java\nindex a4ba813c..15e9bef1 100644\n--- a/okapi-core/src/main/java/org/folio/okapi/service/impl/ProcessModuleHandle.java\n+++ b/okapi-core/src/main/java/org/folio/okapi/service/impl/ProcessModuleHandle.java\n\n@@ -150,22 +149,21 @@ public class ProcessModuleHandle extends NuAbstractProcessHandler implements Mod\n     final String commandLineF = commandLine;\n     process = launch(vertx, id, env, l);\n     Promise<Void> promise = Promise.promise();\n-    vertx.setTimer(1000, timerRes -> {\n-      if (!process.isRunning() && exitCode != 0) {\n-        if (exitCode == Integer.MIN_VALUE) {\n-          promise.fail(messages.getMessage(\"11504\", commandLineF));\n-        } else {\n-          promise.fail(messages.getMessage(\"11500\", exitCode));\n-        }\n-      } else {\n+    // time to wait for process status.. when a port is present (always in real life)..\n+    // The waitReady will check if process eventually starts listening on port\n+    vertx.setTimer(port == 0 ? 3000 : 1000, timerRes -> {\n+      if (process.isRunning() || exitCode == 0) {\n         promise.complete();\n+        return;\n+      }\n+      if (exitCode == Integer.MIN_VALUE) {\n+        promise.fail(messages.getMessage(\"11504\", commandLineF));\n+      } else {\n+        promise.fail(messages.getMessage(\"11500\", exitCode));\n       }\n     });\n-    return promise.future().compose(x -> start3());\n-  }\n-\n-  private Future<Void> start3() {\n-    return tcpPortWaiting.waitReady(process).onFailure(x -> stopProcess());\n+    return promise.future()\n+        .compose(x -> tcpPortWaiting.waitReady(process).onFailure(y -> stopProcess()));\n   }\n \n   private Future<Void> waitPortToClose(int iter) {\n"}}, {"oid": "4e5bdd4dae769e1293d42351eca9344941931164", "url": "https://github.com/folio-org/okapi/commit/4e5bdd4dae769e1293d42351eca9344941931164", "message": "Unused import", "committedDate": "2020-10-08T16:42:21Z", "type": "commit"}, {"oid": "fbcd20f96bddecb0ba00afc38f6bcb4cbce718a4", "url": "https://github.com/folio-org/okapi/commit/fbcd20f96bddecb0ba00afc38f6bcb4cbce718a4", "message": "Wait for socket to close", "committedDate": "2020-10-08T16:42:34Z", "type": "commit"}, {"oid": "c4c6f24fc529082619a1dd26d05667379f235789", "url": "https://github.com/folio-org/okapi/commit/c4c6f24fc529082619a1dd26d05667379f235789", "message": "Wait 3 seconds for process stop/start wo port\n\nWHen there is a port, it is still 1 second, at which point\nthe exit code is checked if the process has shut down. If not,\nwhen a port is in use the system will wait for listener to\nbe present or be gone.", "committedDate": "2020-10-08T16:43:10Z", "type": "commit"}, {"oid": "77b16ea376255b1e349a88949f374259814524d1", "url": "https://github.com/folio-org/okapi/commit/77b16ea376255b1e349a88949f374259814524d1", "message": "Merge branch 'master' into OKAPI-911-unit-test-failures-for-process-module-handle-test", "committedDate": "2020-10-08T17:03:14Z", "type": "commit"}, {"oid": "6b353c1b900b05d36fc5903a05dee4bade9c03e6", "url": "https://github.com/folio-org/okapi/commit/6b353c1b900b05d36fc5903a05dee4bade9c03e6", "message": "Wait for socket.close to complete", "committedDate": "2020-10-09T07:56:31Z", "type": "commit"}, {"oid": "01f1d66f64e2466227466c260b221529a2922ff1", "url": "https://github.com/folio-org/okapi/commit/01f1d66f64e2466227466c260b221529a2922ff1", "message": "Merge branch 'OKAPI-911-unit-test-failures-for-process-module-handle-test' of github.com:folio-org/okapi into OKAPI-911-unit-test-failures-for-process-module-handle-test", "committedDate": "2020-10-09T07:56:54Z", "type": "commit"}, {"oid": "ef16ed1bac3a5df99ce933dd5f3f1b7c4b4345a6", "url": "https://github.com/folio-org/okapi/commit/ef16ed1bac3a5df99ce933dd5f3f1b7c4b4345a6", "message": "Merge remote-tracking branch 'origin/master' into OKAPI-911-unit-test-failures-for-process-module-handle-test", "committedDate": "2020-10-09T07:57:18Z", "type": "commit"}, {"oid": "959441ee517ac33310ffb63df8c0515557b0f5cf", "url": "https://github.com/folio-org/okapi/commit/959441ee517ac33310ffb63df8c0515557b0f5cf", "message": "Spelling", "committedDate": "2020-10-09T08:05:57Z", "type": "commit"}]}