{"pr_number": 1002, "pr_title": "OKAPI-921 skip token cache if no request token is present", "pr_createdAt": "2020-10-16T21:24:39Z", "pr_url": "https://github.com/folio-org/okapi/pull/1002", "timeline": [{"oid": "38c3e89d3c2ad3a5feea0ebf07da1401a21d804d", "url": "https://github.com/folio-org/okapi/commit/38c3e89d3c2ad3a5feea0ebf07da1401a21d804d", "message": "OKAPI-921 skip cache if no token", "committedDate": "2020-10-16T21:23:02Z", "type": "commit"}, {"oid": "dab4739dc57fb4c0eb470d1a84fee8aedd1ff467", "url": "https://github.com/folio-org/okapi/commit/dab4739dc57fb4c0eb470d1a84fee8aedd1ff467", "message": "OKAPI-921 fix indentation", "committedDate": "2020-10-16T21:28:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzY5ODgyMw==", "url": "https://github.com/folio-org/okapi/pull/1002#discussion_r507698823", "bodyText": "Checking for tokenCache == null seems redundant. It is always constructed. Perhaps it should be final?", "author": "adamdickmeiss", "createdAt": "2020-10-19T12:17:29Z", "path": "okapi-core/src/main/java/org/folio/okapi/managers/ProxyService.java", "diffHunk": "@@ -203,9 +203,20 @@ private boolean resolveRedirects(ProxyContext pc,\n    */\n   private boolean checkTokenCache(String tenant, HttpServerRequest req, String pathPattern,\n       ModuleInstance mi) {\n-    CacheEntry cached =\n-        tokenCache.get(tenant, req.method().name(), pathPattern == null ? req.path() : pathPattern,\n-            req.getHeader(XOkapiHeaders.USER_ID), req.headers().get(XOkapiHeaders.TOKEN));\n+    String token = req.headers().get(XOkapiHeaders.TOKEN);\n+    if (token == null) {\n+      mi.setAuthToken(null);\n+      mi.setUserId(null);\n+      mi.setPermissions(null);\n+      return false;\n+    }\n+\n+    String pathComponent = pathPattern == null ? req.path() : pathPattern;\n+\n+    CacheEntry cached = tokenCache == null ? null\n+        : tokenCache.get(tenant, req.method().name(),", "originalCommit": "dab4739dc57fb4c0eb470d1a84fee8aedd1ff467", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b6d0083335bb9836ea4ef5eee7c016d1495f039b", "chunk": "diff --git a/okapi-core/src/main/java/org/folio/okapi/managers/ProxyService.java b/okapi-core/src/main/java/org/folio/okapi/managers/ProxyService.java\nindex 2f18428c..70d67e0b 100644\n--- a/okapi-core/src/main/java/org/folio/okapi/managers/ProxyService.java\n+++ b/okapi-core/src/main/java/org/folio/okapi/managers/ProxyService.java\n\n@@ -213,8 +213,7 @@ public class ProxyService {\n \n     String pathComponent = pathPattern == null ? req.path() : pathPattern;\n \n-    CacheEntry cached = tokenCache == null ? null\n-        : tokenCache.get(tenant, req.method().name(),\n+    CacheEntry cached = tokenCache.get(tenant, req.method().name(),\n             pathComponent, req.getHeader(XOkapiHeaders.USER_ID),\n             token);\n \n"}}, {"oid": "4e280b5abc8394d829840a46685f995097a48127", "url": "https://github.com/folio-org/okapi/commit/4e280b5abc8394d829840a46685f995097a48127", "message": "Merge branch 'master' into OKAPI-921", "committedDate": "2020-10-19T12:48:40Z", "type": "commit"}, {"oid": "b6d0083335bb9836ea4ef5eee7c016d1495f039b", "url": "https://github.com/folio-org/okapi/commit/b6d0083335bb9836ea4ef5eee7c016d1495f039b", "message": "OKAPI-921 remove unneeded null check", "committedDate": "2020-10-19T12:53:05Z", "type": "commit"}]}