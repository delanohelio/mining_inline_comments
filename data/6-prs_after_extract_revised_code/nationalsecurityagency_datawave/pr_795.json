{"pr_number": 795, "pr_title": "Fix potential NPE in TermFrequencyIndexIterator.", "pr_createdAt": "2020-04-01T17:01:43Z", "pr_url": "https://github.com/NationalSecurityAgency/datawave/pull/795", "timeline": [{"oid": "fa5da234b65150d3ef58ff1f1cba6b7fbbfa19df", "url": "https://github.com/NationalSecurityAgency/datawave/commit/fa5da234b65150d3ef58ff1f1cba6b7fbbfa19df", "message": "Fix potential NPE in TermFrequencyIndexIterator.", "committedDate": "2020-04-01T17:00:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTgwMTAzNQ==", "url": "https://github.com/NationalSecurityAgency/datawave/pull/795#discussion_r401801035", "bodyText": "Reusing tk here is not good here.  Say we get through this loop without tk being null, and then the check at line 204 is true.  This would result in a seek and we would immediately pop out of the outer while loop because tk is not null and would not be holding the correct field name!  Use a separate Key variable instead.", "author": "ivakegg", "createdAt": "2020-04-01T17:52:29Z", "path": "warehouse/query-core/src/main/java/datawave/query/iterator/logic/TermFrequencyIndexIterator.java", "diffHunk": "@@ -187,12 +187,20 @@ public void next() throws IOException {\n             \n             for (int i = 0; i < 256 && source.hasTop() && key.getFieldName().compareTo(field) < 0; ++i) {\n                 source.next();\n-                key = new DatawaveKey(source.getTopKey());\n+                \n+                tk = source.getTopKey();", "originalCommit": "fa5da234b65150d3ef58ff1f1cba6b7fbbfa19df", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTgwMTU3Nw==", "url": "https://github.com/NationalSecurityAgency/datawave/pull/795#discussion_r401801577", "bodyText": "Will do", "author": "apmoriarty", "createdAt": "2020-04-01T17:53:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTgwMTAzNQ=="}], "type": "inlineReview", "revised_code": {"commit": "c4d45f0c536dc55248564177dea9333c62160f7a", "chunk": "diff --git a/warehouse/query-core/src/main/java/datawave/query/iterator/logic/TermFrequencyIndexIterator.java b/warehouse/query-core/src/main/java/datawave/query/iterator/logic/TermFrequencyIndexIterator.java\nindex 1ab7822b9..c9f008aec 100644\n--- a/warehouse/query-core/src/main/java/datawave/query/iterator/logic/TermFrequencyIndexIterator.java\n+++ b/warehouse/query-core/src/main/java/datawave/query/iterator/logic/TermFrequencyIndexIterator.java\n\n@@ -184,21 +184,22 @@ public class TermFrequencyIndexIterator implements SortedKeyValueIterator<Key,Va\n             }\n             \n             DatawaveKey key = new DatawaveKey(top);\n+            Key nextTop = null;\n             \n             for (int i = 0; i < 256 && source.hasTop() && key.getFieldName().compareTo(field) < 0; ++i) {\n                 source.next();\n                 \n-                tk = source.getTopKey();\n-                if (tk == null)\n+                nextTop = source.getTopKey();\n+                if (nextTop == null)\n                     break;\n                 \n-                key = new DatawaveKey(tk);\n+                key = new DatawaveKey(nextTop);\n                 if (log.isTraceEnabled()) {\n                     log.trace(\"Have key \" + key + \" < \" + field);\n                 }\n             }\n             \n-            if (tk == null)\n+            if (nextTop == null)\n                 continue;\n             \n             if (key.getFieldName().compareTo(field) < 0) {\n"}}, {"oid": "c4d45f0c536dc55248564177dea9333c62160f7a", "url": "https://github.com/NationalSecurityAgency/datawave/commit/c4d45f0c536dc55248564177dea9333c62160f7a", "message": "Address PR comments.", "committedDate": "2020-04-01T18:16:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTgyMDM4Mg==", "url": "https://github.com/NationalSecurityAgency/datawave/pull/795#discussion_r401820382", "bodyText": "I wouldn't hold it up over this, and some could argue it's too esoteric, but it seems like this could actually be a good use of a labelled continue statement. Label the outer while loop, change this to continue <label> and remove the addition at line 202. At that point, nextTop could also be local to this loop.", "author": "brianloss", "createdAt": "2020-04-01T18:25:27Z", "path": "warehouse/query-core/src/main/java/datawave/query/iterator/logic/TermFrequencyIndexIterator.java", "diffHunk": "@@ -184,15 +184,24 @@ public void next() throws IOException {\n             }\n             \n             DatawaveKey key = new DatawaveKey(top);\n+            Key nextTop = null;\n             \n             for (int i = 0; i < 256 && source.hasTop() && key.getFieldName().compareTo(field) < 0; ++i) {\n                 source.next();\n-                key = new DatawaveKey(source.getTopKey());\n+                \n+                nextTop = source.getTopKey();\n+                if (nextTop == null)\n+                    break;", "originalCommit": "c4d45f0c536dc55248564177dea9333c62160f7a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU5NzE1Ng==", "url": "https://github.com/NationalSecurityAgency/datawave/pull/795#discussion_r402597156", "bodyText": "This leads to an infinite loop if we never go in to the for loop on line 188/189 (which would happen if we already have the right key). All of the github actions have been stuck due to this. Initializing nextTop as Key nextTop = top; on line 187 will solve.", "author": "brianloss", "createdAt": "2020-04-02T21:08:04Z", "path": "warehouse/query-core/src/main/java/datawave/query/iterator/logic/TermFrequencyIndexIterator.java", "diffHunk": "@@ -184,15 +184,24 @@ public void next() throws IOException {\n             }\n             \n             DatawaveKey key = new DatawaveKey(top);\n+            Key nextTop = null;\n             \n             for (int i = 0; i < 256 && source.hasTop() && key.getFieldName().compareTo(field) < 0; ++i) {\n                 source.next();\n-                key = new DatawaveKey(source.getTopKey());\n+                \n+                nextTop = source.getTopKey();\n+                if (nextTop == null)\n+                    break;\n+                \n+                key = new DatawaveKey(nextTop);\n                 if (log.isTraceEnabled()) {\n                     log.trace(\"Have key \" + key + \" < \" + field);\n                 }\n             }\n             \n+            if (nextTop == null)\n+                continue;", "originalCommit": "c4d45f0c536dc55248564177dea9333c62160f7a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU5OTE4NQ==", "url": "https://github.com/NationalSecurityAgency/datawave/pull/795#discussion_r402599185", "bodyText": "I'll have that fix up in a moment", "author": "apmoriarty", "createdAt": "2020-04-02T21:12:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU5NzE1Ng=="}], "type": "inlineReview", "revised_code": null}]}