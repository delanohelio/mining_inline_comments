{"pr_number": 775, "pr_title": "Better way to configure unique terms within an expression", "pr_createdAt": "2020-03-04T14:43:23Z", "pr_url": "https://github.com/NationalSecurityAgency/datawave/pull/775", "timeline": [{"oid": "d2055bc5ab851714936af87ce5d93049e66aa308", "url": "https://github.com/NationalSecurityAgency/datawave/commit/d2055bc5ab851714936af87ce5d93049e66aa308", "message": "Push the configuration for the UniqueExpressionTermsVisitor down to the logic level vs. the DefaultQueryPlanner level.", "committedDate": "2020-03-05T15:38:53Z", "type": "commit"}, {"oid": "9c56a7402304ddfe859455d1600a385f39300601", "url": "https://github.com/NationalSecurityAgency/datawave/commit/9c56a7402304ddfe859455d1600a385f39300601", "message": "Don't drop config options when tuning lookupUUID.", "committedDate": "2020-03-05T15:38:58Z", "type": "commit"}, {"oid": "9c56a7402304ddfe859455d1600a385f39300601", "url": "https://github.com/NationalSecurityAgency/datawave/commit/9c56a7402304ddfe859455d1600a385f39300601", "message": "Don't drop config options when tuning lookupUUID.", "committedDate": "2020-03-05T15:38:58Z", "type": "forcePushed"}, {"oid": "89cbd2e6e90ead3853ed1f8445faa671e08777f2", "url": "https://github.com/NationalSecurityAgency/datawave/commit/89cbd2e6e90ead3853ed1f8445faa671e08777f2", "message": "Merge branch 'release/version2.9' into task/UniqueExpressionTermVisitor_betterConfigs", "committedDate": "2020-03-05T15:48:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM4NjIxNg==", "url": "https://github.com/NationalSecurityAgency/datawave/pull/775#discussion_r388386216", "bodyText": "Is the conditional here really necessary?", "author": "jwomeara", "createdAt": "2020-03-05T15:54:54Z", "path": "warehouse/query-core/src/main/java/datawave/query/config/LookupUUIDTune.java", "diffHunk": "@@ -54,6 +54,8 @@ public void configure(BaseQueryLogic<Entry<Key,Value>> logic) {\n             rsq.setSpeculativeScanning(speculativeScanning);\n             rsq.setCacheModel(enableCaching);\n             rsq.setPrimaryToSecondaryFieldMap(primaryToSecondaryFieldMap);\n+            if (enforceUniqueTermsWithinExpressions)\n+                rsq.setEnforceUniqueTermsWithinExpressions(true);", "originalCommit": "89cbd2e6e90ead3853ed1f8445faa671e08777f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQwMzMzNg==", "url": "https://github.com/NationalSecurityAgency/datawave/pull/775#discussion_r388403336", "bodyText": "Nope, resolving in next commit.", "author": "apmoriarty", "createdAt": "2020-03-05T16:19:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM4NjIxNg=="}], "type": "inlineReview", "revised_code": {"commit": "3f464803cf8e10532c60a424efd608b703bebd11", "chunk": "diff --git a/warehouse/query-core/src/main/java/datawave/query/config/LookupUUIDTune.java b/warehouse/query-core/src/main/java/datawave/query/config/LookupUUIDTune.java\nindex c6d5c83e3..514d80d02 100644\n--- a/warehouse/query-core/src/main/java/datawave/query/config/LookupUUIDTune.java\n+++ b/warehouse/query-core/src/main/java/datawave/query/config/LookupUUIDTune.java\n\n@@ -54,8 +54,7 @@ public class LookupUUIDTune implements Profile {\n             rsq.setSpeculativeScanning(speculativeScanning);\n             rsq.setCacheModel(enableCaching);\n             rsq.setPrimaryToSecondaryFieldMap(primaryToSecondaryFieldMap);\n-            if (enforceUniqueTermsWithinExpressions)\n-                rsq.setEnforceUniqueTermsWithinExpressions(true);\n+            rsq.setEnforceUniqueTermsWithinExpressions(enforceUniqueTermsWithinExpressions);\n             \n             if (querySyntaxParsers != null) {\n                 rsq.setQuerySyntaxParsers(querySyntaxParsers);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM4NjM4OA==", "url": "https://github.com/NationalSecurityAgency/datawave/pull/775#discussion_r388386388", "bodyText": "Same comment as above.", "author": "jwomeara", "createdAt": "2020-03-05T15:55:08Z", "path": "warehouse/query-core/src/main/java/datawave/query/config/LookupUUIDTune.java", "diffHunk": "@@ -66,6 +68,9 @@ public void configure(BaseQueryLogic<Entry<Key,Value>> logic) {\n                 SeekingQueryPlanner planner = new SeekingQueryPlanner();\n                 planner.setMaxFieldHitsBeforeSeek(maxFieldHitsBeforeSeek);\n                 planner.setMaxKeysBeforeSeek(maxKeysBeforeSeek);\n+                if (enforceUniqueTermsWithinExpressions)\n+                    planner.setEnforceUniqueTermsWithinExpressions(true);", "originalCommit": "89cbd2e6e90ead3853ed1f8445faa671e08777f2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3f464803cf8e10532c60a424efd608b703bebd11", "chunk": "diff --git a/warehouse/query-core/src/main/java/datawave/query/config/LookupUUIDTune.java b/warehouse/query-core/src/main/java/datawave/query/config/LookupUUIDTune.java\nindex c6d5c83e3..514d80d02 100644\n--- a/warehouse/query-core/src/main/java/datawave/query/config/LookupUUIDTune.java\n+++ b/warehouse/query-core/src/main/java/datawave/query/config/LookupUUIDTune.java\n\n@@ -68,8 +67,6 @@ public class LookupUUIDTune implements Profile {\n                 SeekingQueryPlanner planner = new SeekingQueryPlanner();\n                 planner.setMaxFieldHitsBeforeSeek(maxFieldHitsBeforeSeek);\n                 planner.setMaxKeysBeforeSeek(maxKeysBeforeSeek);\n-                if (enforceUniqueTermsWithinExpressions)\n-                    planner.setEnforceUniqueTermsWithinExpressions(true);\n                 \n                 rsq.setQueryPlanner(planner);\n                 \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM4NjU5OQ==", "url": "https://github.com/NationalSecurityAgency/datawave/pull/775#discussion_r388386599", "bodyText": "Same comment as above.", "author": "jwomeara", "createdAt": "2020-03-05T15:55:28Z", "path": "warehouse/query-core/src/main/java/datawave/query/config/LookupUUIDTune.java", "diffHunk": "@@ -125,6 +130,8 @@ public void configure(GenericQueryConfiguration configuration) {\n             if (maxShardsPerDayThreshold != -1) {\n                 rsqc.setShardsPerDayThreshold(maxShardsPerDayThreshold);\n             }\n+            if (enforceUniqueTermsWithinExpressions)\n+                rsqc.setEnforceUniqueTermsWithinExpressions(true);", "originalCommit": "89cbd2e6e90ead3853ed1f8445faa671e08777f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQwMzQ5Ng==", "url": "https://github.com/NationalSecurityAgency/datawave/pull/775#discussion_r388403496", "bodyText": "Resolved", "author": "apmoriarty", "createdAt": "2020-03-05T16:19:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM4NjU5OQ=="}], "type": "inlineReview", "revised_code": {"commit": "3f464803cf8e10532c60a424efd608b703bebd11", "chunk": "diff --git a/warehouse/query-core/src/main/java/datawave/query/config/LookupUUIDTune.java b/warehouse/query-core/src/main/java/datawave/query/config/LookupUUIDTune.java\nindex c6d5c83e3..514d80d02 100644\n--- a/warehouse/query-core/src/main/java/datawave/query/config/LookupUUIDTune.java\n+++ b/warehouse/query-core/src/main/java/datawave/query/config/LookupUUIDTune.java\n\n@@ -130,8 +125,8 @@ public class LookupUUIDTune implements Profile {\n             if (maxShardsPerDayThreshold != -1) {\n                 rsqc.setShardsPerDayThreshold(maxShardsPerDayThreshold);\n             }\n-            if (enforceUniqueTermsWithinExpressions)\n-                rsqc.setEnforceUniqueTermsWithinExpressions(true);\n+            rsqc.setEnforceUniqueTermsWithinExpressions(enforceUniqueTermsWithinExpressions);\n+            \n             // we need this since we've finished the deep copy already\n             rsqc.setSpeculativeScanning(speculativeScanning);\n             rsqc.setTrackSizes(trackSizes);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM4NzMwMg==", "url": "https://github.com/NationalSecurityAgency/datawave/pull/775#discussion_r388387302", "bodyText": "Why does this term exist in two places?  Why not only have it in the shard query configuration?", "author": "jwomeara", "createdAt": "2020-03-05T15:56:26Z", "path": "warehouse/query-core/src/main/java/datawave/query/planner/DefaultQueryPlanner.java", "diffHunk": "@@ -746,7 +746,8 @@ protected ASTJexlScript updateQueryTree(ScannerFactory scannerFactory, MetadataH\n         \n         stopwatch.stop();\n         \n-        if (enforceUniqueTermsWithinExpressions) {\n+        // Enforce if either DefaultQueryPlanner or ShardQueryConfig is true\n+        if (enforceUniqueTermsWithinExpressions || config.getEnforceUniqueTermsWithinExpressions()) {", "originalCommit": "89cbd2e6e90ead3853ed1f8445faa671e08777f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM5MjE2Mw==", "url": "https://github.com/NationalSecurityAgency/datawave/pull/775#discussion_r388392163", "bodyText": "I can remove the DQP hook and rely solely on the ShardQueryConfig", "author": "apmoriarty", "createdAt": "2020-03-05T16:02:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM4NzMwMg=="}], "type": "inlineReview", "revised_code": {"commit": "3f464803cf8e10532c60a424efd608b703bebd11", "chunk": "diff --git a/warehouse/query-core/src/main/java/datawave/query/planner/DefaultQueryPlanner.java b/warehouse/query-core/src/main/java/datawave/query/planner/DefaultQueryPlanner.java\nindex e1ea7b210..57fd8888c 100644\n--- a/warehouse/query-core/src/main/java/datawave/query/planner/DefaultQueryPlanner.java\n+++ b/warehouse/query-core/src/main/java/datawave/query/planner/DefaultQueryPlanner.java\n\n@@ -746,8 +740,8 @@ public class DefaultQueryPlanner extends QueryPlanner {\n         \n         stopwatch.stop();\n         \n-        // Enforce if either DefaultQueryPlanner or ShardQueryConfig is true\n-        if (enforceUniqueTermsWithinExpressions || config.getEnforceUniqueTermsWithinExpressions()) {\n+        // Enforce unique terms within an AND or OR expression.\n+        if (config.getEnforceUniqueTermsWithinExpressions()) {\n             stopwatch = timers.newStartedStopwatch(\"DefaultQueryPlanner - Enforce unique terms within AND and OR expressions\");\n             queryTree = UniqueExpressionTermsVisitor.enforce(queryTree);\n             if (log.isDebugEnabled()) {\n"}}, {"oid": "3f464803cf8e10532c60a424efd608b703bebd11", "url": "https://github.com/NationalSecurityAgency/datawave/commit/3f464803cf8e10532c60a424efd608b703bebd11", "message": "Remove UniqueExpressionVisitor hook form DefaultQueryPlanner, rely solely on the shardQueryConfig.", "committedDate": "2020-03-05T16:18:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODgyODIzOQ==", "url": "https://github.com/NationalSecurityAgency/datawave/pull/775#discussion_r388828239", "bodyText": "we only need to set this once. If the value is stored in the BaseQueryLogic, no need to set it again in the ShardQueryConfiguration", "author": "FineAndDandy", "createdAt": "2020-03-06T10:32:25Z", "path": "warehouse/query-core/src/main/java/datawave/query/config/LookupUUIDTune.java", "diffHunk": "@@ -125,6 +125,8 @@ public void configure(GenericQueryConfiguration configuration) {\n             if (maxShardsPerDayThreshold != -1) {\n                 rsqc.setShardsPerDayThreshold(maxShardsPerDayThreshold);\n             }\n+            rsqc.setEnforceUniqueTermsWithinExpressions(enforceUniqueTermsWithinExpressions);\n+            ", "originalCommit": "3f464803cf8e10532c60a424efd608b703bebd11", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODgyODg4Nw==", "url": "https://github.com/NationalSecurityAgency/datawave/pull/775#discussion_r388828887", "bodyText": "I'll make that change, thanks", "author": "apmoriarty", "createdAt": "2020-03-06T10:33:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODgyODIzOQ=="}], "type": "inlineReview", "revised_code": {"commit": "00ba807d2cc8a31cc8762322883f204f7cf32df2", "chunk": "diff --git a/warehouse/query-core/src/main/java/datawave/query/config/LookupUUIDTune.java b/warehouse/query-core/src/main/java/datawave/query/config/LookupUUIDTune.java\nindex 514d80d02..afe9b24c7 100644\n--- a/warehouse/query-core/src/main/java/datawave/query/config/LookupUUIDTune.java\n+++ b/warehouse/query-core/src/main/java/datawave/query/config/LookupUUIDTune.java\n\n@@ -125,7 +125,6 @@ public class LookupUUIDTune implements Profile {\n             if (maxShardsPerDayThreshold != -1) {\n                 rsqc.setShardsPerDayThreshold(maxShardsPerDayThreshold);\n             }\n-            rsqc.setEnforceUniqueTermsWithinExpressions(enforceUniqueTermsWithinExpressions);\n             \n             // we need this since we've finished the deep copy already\n             rsqc.setSpeculativeScanning(speculativeScanning);\n"}}, {"oid": "00ba807d2cc8a31cc8762322883f204f7cf32df2", "url": "https://github.com/NationalSecurityAgency/datawave/commit/00ba807d2cc8a31cc8762322883f204f7cf32df2", "message": "Only set config option once.", "committedDate": "2020-03-06T10:45:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODk3MTY0OA==", "url": "https://github.com/NationalSecurityAgency/datawave/pull/775#discussion_r388971648", "bodyText": "YES!", "author": "jwomeara", "createdAt": "2020-03-06T15:33:05Z", "path": "warehouse/query-core/src/main/java/datawave/query/planner/DefaultQueryPlanner.java", "diffHunk": "@@ -746,7 +740,8 @@ protected ASTJexlScript updateQueryTree(ScannerFactory scannerFactory, MetadataH\n         \n         stopwatch.stop();\n         \n-        if (enforceUniqueTermsWithinExpressions) {\n+        // Enforce unique terms within an AND or OR expression.\n+        if (config.getEnforceUniqueTermsWithinExpressions()) {", "originalCommit": "00ba807d2cc8a31cc8762322883f204f7cf32df2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}