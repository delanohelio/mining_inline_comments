{"pr_number": 1014, "pr_title": "fixes #1010 fix SpringCDIExtension applicationContext and serialization/deserialization of DatawavePrincipals", "pr_createdAt": "2020-12-14T17:32:52Z", "pr_url": "https://github.com/NationalSecurityAgency/datawave/pull/1014", "timeline": [{"oid": "f0fd2808e25d35d4c7197bfef926482e03ea4add", "url": "https://github.com/NationalSecurityAgency/datawave/commit/f0fd2808e25d35d4c7197bfef926482e03ea4add", "message": "fixes #1010 fix SpringCDIExtension applicationContext and serialization/deserialization of DatawavePrincipals\n\nAdditional changes", "committedDate": "2020-12-14T17:30:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjY4Nzc3NQ==", "url": "https://github.com/NationalSecurityAgency/datawave/pull/1014#discussion_r542687775", "bodyText": "Does this allow us to remove the infinispan dependency from the POM?", "author": "keith-ratcliffe", "createdAt": "2020-12-14T19:33:21Z", "path": "web-services/map-reduce-embedded/src/main/java/datawave/security/system/EmbeddedCallerPrincipalProducer.java", "diffHunk": "@@ -7,7 +7,11 @@\n import javax.interceptor.Interceptor;\n \n import datawave.security.authorization.DatawavePrincipal;\n-import org.infinispan.commons.util.Base64;\n+import org.apache.commons.codec.binary.Base64;", "originalCommit": "f0fd2808e25d35d4c7197bfef926482e03ea4add", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzM4MTc0MA==", "url": "https://github.com/NationalSecurityAgency/datawave/pull/1014#discussion_r543381740", "bodyText": "No - it looks like infinispan is used elsewhere.", "author": "billoley", "createdAt": "2020-12-15T14:17:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjY4Nzc3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzM4NDk2Mw==", "url": "https://github.com/NationalSecurityAgency/datawave/pull/1014#discussion_r543384963", "bodyText": "Looks like we can probably delete it from the map-reduce-embedded pom", "author": "billoley", "createdAt": "2020-12-15T14:20:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjY4Nzc3NQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjY5MjY0OA==", "url": "https://github.com/NationalSecurityAgency/datawave/pull/1014#discussion_r542692648", "bodyText": "Try-with-resources instead?", "author": "keith-ratcliffe", "createdAt": "2020-12-14T19:37:48Z", "path": "web-services/map-reduce-embedded/src/main/java/datawave/security/system/EmbeddedCallerPrincipalProducer.java", "diffHunk": "@@ -31,8 +35,21 @@ public DatawavePrincipal produceCallerPrincipal() {\n     \n     private void initializeCallerPrincipal() {\n         String encodedCallerPrincipal = System.getProperty(\"caller.principal\");\n-        if (encodedCallerPrincipal == null)\n-            throw new IllegalStateException(\"System property caller.principal must be set to a serialized, gzip'd, base64 encoded principal.\");\n-        callerPrincipal = (DatawavePrincipal) Base64.decodeToObject(encodedCallerPrincipal);\n+        if (encodedCallerPrincipal == null) {\n+            throw new IllegalStateException(\"System property caller.principal must be set to a serialized, base64 encoded principal.\");\n+        }\n+        ByteArrayInputStream bais = new ByteArrayInputStream(Base64.decodeBase64(encodedCallerPrincipal));\n+        try {", "originalCommit": "f0fd2808e25d35d4c7197bfef926482e03ea4add", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzM4MDg0NQ==", "url": "https://github.com/NationalSecurityAgency/datawave/pull/1014#discussion_r543380845", "bodyText": "Updated to use try with resources", "author": "billoley", "createdAt": "2020-12-15T14:17:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjY5MjY0OA=="}], "type": "inlineReview", "revised_code": {"commit": "37903032202801b312aecc161c171dc71090989a", "chunk": "diff --git a/web-services/map-reduce-embedded/src/main/java/datawave/security/system/EmbeddedCallerPrincipalProducer.java b/web-services/map-reduce-embedded/src/main/java/datawave/security/system/EmbeddedCallerPrincipalProducer.java\nindex 8cfed52cd..d4efb9394 100644\n--- a/web-services/map-reduce-embedded/src/main/java/datawave/security/system/EmbeddedCallerPrincipalProducer.java\n+++ b/web-services/map-reduce-embedded/src/main/java/datawave/security/system/EmbeddedCallerPrincipalProducer.java\n\n@@ -38,18 +38,12 @@ public class EmbeddedCallerPrincipalProducer {\n         if (encodedCallerPrincipal == null) {\n             throw new IllegalStateException(\"System property caller.principal must be set to a serialized, base64 encoded principal.\");\n         }\n-        ByteArrayInputStream bais = new ByteArrayInputStream(Base64.decodeBase64(encodedCallerPrincipal));\n-        try {\n-            ObjectInputStream ois = new ObjectInputStream(bais);\n+        byte[] decodedCallerPrincipal = Base64.decodeBase64(encodedCallerPrincipal);\n+        \n+        try (ByteArrayInputStream bais = new ByteArrayInputStream(decodedCallerPrincipal); ObjectInputStream ois = new ObjectInputStream(bais)) {\n             callerPrincipal = (DatawavePrincipal) ois.readObject();\n         } catch (Exception e) {\n             throw new IllegalStateException(e);\n-        } finally {\n-            try {\n-                bais.close();\n-            } catch (IOException e) {\n-                throw new IllegalStateException(e);\n-            }\n         }\n     }\n }\n"}}, {"oid": "37903032202801b312aecc161c171dc71090989a", "url": "https://github.com/NationalSecurityAgency/datawave/commit/37903032202801b312aecc161c171dc71090989a", "message": "Use try with resources", "committedDate": "2020-12-15T14:15:45Z", "type": "commit"}, {"oid": "76e89802d352e83b244c00d279c36af55e5a0c11", "url": "https://github.com/NationalSecurityAgency/datawave/commit/76e89802d352e83b244c00d279c36af55e5a0c11", "message": "remove infinispan dependency from map-reduce-embedded pom", "committedDate": "2020-12-15T14:27:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzQ3MTEzNA==", "url": "https://github.com/NationalSecurityAgency/datawave/pull/1014#discussion_r543471134", "bodyText": "try-with-resources, same as above? Sorry, thought I'd flagged this one already...guess not", "author": "keith-ratcliffe", "createdAt": "2020-12-15T15:59:58Z", "path": "web-services/map-reduce/src/main/java/datawave/webservice/mr/configuration/BulkResultsJobConfiguration.java", "diffHunk": "@@ -304,7 +306,21 @@ private void setupJob(Job job, Path jobDir, GenericQueryConfiguration queryConfi\n     }\n     \n     private String encodePrincipal(DatawavePrincipal principal) throws IOException {\n-        return Base64.encodeObject(principal, Base64.GZIP | Base64.DONT_BREAK_LINES);\n+        ByteArrayOutputStream baos = new ByteArrayOutputStream();\n+        ObjectOutputStream oos = null;\n+        try {\n+            oos = new ObjectOutputStream(baos);\n+            // create a copy because this DatawavePrincipal might be CDI injected and have a reference to Weld\n+            oos.writeObject(new DatawavePrincipal(principal.getProxiedUsers(), principal.getCreationTime()));\n+            return Base64.encodeBase64String(baos.toByteArray());\n+        } finally {\n+            if (oos != null) {\n+                oos.close();\n+            }\n+            if (baos != null) {\n+                baos.close();\n+            }", "originalCommit": "76e89802d352e83b244c00d279c36af55e5a0c11", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b60894a39d42b4e48d53e356cf6a1177521a259d", "chunk": "diff --git a/web-services/map-reduce/src/main/java/datawave/webservice/mr/configuration/BulkResultsJobConfiguration.java b/web-services/map-reduce/src/main/java/datawave/webservice/mr/configuration/BulkResultsJobConfiguration.java\nindex b440e33ee..07d076244 100644\n--- a/web-services/map-reduce/src/main/java/datawave/webservice/mr/configuration/BulkResultsJobConfiguration.java\n+++ b/web-services/map-reduce/src/main/java/datawave/webservice/mr/configuration/BulkResultsJobConfiguration.java\n\n@@ -306,20 +306,12 @@ public class BulkResultsJobConfiguration extends MapReduceJobConfiguration imple\n     }\n     \n     private String encodePrincipal(DatawavePrincipal principal) throws IOException {\n-        ByteArrayOutputStream baos = new ByteArrayOutputStream();\n-        ObjectOutputStream oos = null;\n-        try {\n-            oos = new ObjectOutputStream(baos);\n+        \n+        try (ByteArrayOutputStream baos = new ByteArrayOutputStream(); ObjectOutputStream oos = new ObjectOutputStream(baos)) {\n+            \n             // create a copy because this DatawavePrincipal might be CDI injected and have a reference to Weld\n             oos.writeObject(new DatawavePrincipal(principal.getProxiedUsers(), principal.getCreationTime()));\n             return Base64.encodeBase64String(baos.toByteArray());\n-        } finally {\n-            if (oos != null) {\n-                oos.close();\n-            }\n-            if (baos != null) {\n-                baos.close();\n-            }\n         }\n     }\n     \n"}}, {"oid": "b60894a39d42b4e48d53e356cf6a1177521a259d", "url": "https://github.com/NationalSecurityAgency/datawave/commit/b60894a39d42b4e48d53e356cf6a1177521a259d", "message": "Use try with resources in another place", "committedDate": "2020-12-15T18:13:20Z", "type": "commit"}]}