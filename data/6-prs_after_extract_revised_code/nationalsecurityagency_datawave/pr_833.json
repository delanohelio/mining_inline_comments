{"pr_number": 833, "pr_title": "fixes #826 Stop looping over terms once threshold is reached", "pr_createdAt": "2020-06-18T17:15:45Z", "pr_url": "https://github.com/NationalSecurityAgency/datawave/pull/833", "timeline": [{"oid": "9925307950fa0829becb5dc71688b9b3d5204178", "url": "https://github.com/NationalSecurityAgency/datawave/commit/9925307950fa0829becb5dc71688b9b3d5204178", "message": "fixes #826 Stop looping over terms once threshold is reached", "committedDate": "2020-06-18T17:05:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDIwMDk5MA==", "url": "https://github.com/NationalSecurityAgency/datawave/pull/833#discussion_r444200990", "bodyText": "I don't think this is correct.  Using the return value from fieldsToValues.put being false does not mean that fieldsToValues.get(field).isThresholdExceeded().  The return value could be false because that value was already in the set.", "author": "ivakegg", "createdAt": "2020-06-23T12:56:00Z", "path": "warehouse/query-core/src/main/java/datawave/query/jexl/lookups/LookupTermsFromRegex.java", "diffHunk": "@@ -256,15 +258,25 @@ public IndexLookupMap lookup(ShardQueryConfiguration config, ScannerFactory scan\n                             topKey.getColumnFamily(holder);\n                             String field = holder.toString();\n                             \n-                            // We are only returning a mapping of field value to field name, no need to\n-                            // determine cardinality and such at this point.\n-                            fieldsToValues.put(field, term);\n-                            // conditional states that if we exceed the key threshold OR field name is not null and we've exceeded\n-                            // the value threshold for that field name ( in the case where we have a fielded lookup ).\n-                            if (fieldsToValues.isKeyThresholdExceeded() || (fields.size() == 1 && fieldsToValues.get(field).isThresholdExceeded())) {\n-                                if (log.isTraceEnabled())\n-                                    log.trace(\"We've passed term expansion threshold\");\n-                                return true;\n+                            // if the limits haven't already been surpassed\n+                            if (!fieldsToValues.isKeyThresholdExceeded()\n+                                            && (fieldsToValues.get(field) == null || !fieldsToValues.get(field).isThresholdExceeded())) {\n+                                // We are only returning a mapping of field value to field name, no need to\n+                                // determine cardinality and such at this point.\n+                                boolean added = fieldsToValues.put(field, term);\n+                                \n+                                // if there was a failure to add, and the key threshold isn't exceeded, increment the value exceeded count\n+                                if (!added && !fieldsToValues.isKeyThresholdExceeded()) {\n+                                    valueExceededCount++;", "originalCommit": "9925307950fa0829becb5dc71688b9b3d5204178", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA2NTgxMQ==", "url": "https://github.com/NationalSecurityAgency/datawave/pull/833#discussion_r463065811", "bodyText": "you are right, if the key is already present in the underlying value hashset it will return false.", "author": "FineAndDandy", "createdAt": "2020-07-30T15:06:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDIwMDk5MA=="}], "type": "inlineReview", "revised_code": {"commit": "4212501308ffb1b07622139430ced40ee4d395a4", "chunk": "diff --git a/warehouse/query-core/src/main/java/datawave/query/jexl/lookups/LookupTermsFromRegex.java b/warehouse/query-core/src/main/java/datawave/query/jexl/lookups/LookupTermsFromRegex.java\nindex 6d75316fe..85301784f 100644\n--- a/warehouse/query-core/src/main/java/datawave/query/jexl/lookups/LookupTermsFromRegex.java\n+++ b/warehouse/query-core/src/main/java/datawave/query/jexl/lookups/LookupTermsFromRegex.java\n\n@@ -266,7 +266,7 @@ public class LookupTermsFromRegex extends RegexIndexLookup {\n                                 boolean added = fieldsToValues.put(field, term);\n                                 \n                                 // if there was a failure to add, and the key threshold isn't exceeded, increment the value exceeded count\n-                                if (!added && !fieldsToValues.isKeyThresholdExceeded()) {\n+                                if (!added && !fieldsToValues.isKeyThresholdExceeded() && fieldsToValues.get(field).isThresholdExceeded()) {\n                                     valueExceededCount++;\n                                 }\n                                 \n"}}, {"oid": "946df859b102bd32377b47f9a8a147d8017607e0", "url": "https://github.com/NationalSecurityAgency/datawave/commit/946df859b102bd32377b47f9a8a147d8017607e0", "message": "Merge branch 'release/version2.9' into 2.9-maxTermThreshold", "committedDate": "2020-06-23T13:09:13Z", "type": "commit"}, {"oid": "4212501308ffb1b07622139430ced40ee4d395a4", "url": "https://github.com/NationalSecurityAgency/datawave/commit/4212501308ffb1b07622139430ced40ee4d395a4", "message": "fixes #826: check field values exceeded before incrementing valueExceededCount", "committedDate": "2020-07-30T16:17:54Z", "type": "commit"}, {"oid": "ffbc6e5d9f75bcc43c763268ba3475ba3f4d4887", "url": "https://github.com/NationalSecurityAgency/datawave/commit/ffbc6e5d9f75bcc43c763268ba3475ba3f4d4887", "message": "Merge branch '2.9-maxTermThreshold' of https://github.com/FineAndDandy/datawave-1 into 2.9-maxTermThreshold", "committedDate": "2020-07-30T16:19:45Z", "type": "commit"}, {"oid": "5ccd847d7884273cd578de658905ea633200f37b", "url": "https://github.com/NationalSecurityAgency/datawave/commit/5ccd847d7884273cd578de658905ea633200f37b", "message": "Merge branch 'release/version2.9' into 2.9-maxTermThreshold", "committedDate": "2020-07-30T16:30:47Z", "type": "commit"}, {"oid": "9b5573db432efed58f1f4b43cae7c6636988346a", "url": "https://github.com/NationalSecurityAgency/datawave/commit/9b5573db432efed58f1f4b43cae7c6636988346a", "message": "Merge branch 'release/version2.9' into 2.9-maxTermThreshold", "committedDate": "2020-07-31T12:47:31Z", "type": "commit"}]}