{"pr_number": 1318, "pr_title": "Do not drop static peers when connection limit is reached", "pr_createdAt": "2020-03-09T00:28:06Z", "pr_url": "https://github.com/ConsenSys/teku/pull/1318", "timeline": [{"oid": "4a1e45cc0b937634031f3ee5eabf107bca8b3f1d", "url": "https://github.com/ConsenSys/teku/commit/4a1e45cc0b937634031f3ee5eabf107bca8b3f1d", "message": "Do not drop static peers when connection limit is reached.", "committedDate": "2020-03-09T00:23:28Z", "type": "commit"}, {"oid": "f601e72f1febf53966045cccecc242b9b6546f8b", "url": "https://github.com/ConsenSys/teku/commit/f601e72f1febf53966045cccecc242b9b6546f8b", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into do-not-drop-static-peers", "committedDate": "2020-03-09T02:16:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTc2Mjc0MA==", "url": "https://github.com/ConsenSys/teku/pull/1318#discussion_r389762740", "bodyText": "Stale comment:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                // Should disconnect one peer to get back down to our target of max 1 peer.\n          \n          \n            \n                // Should not disconnect static peers", "author": "mbaxter", "createdAt": "2020-03-09T15:22:25Z", "path": "networking/p2p/src/test/java/tech/pegasys/artemis/networking/p2p/discovery/ConnectionManagerTest.java", "diffHunk": "@@ -362,6 +362,26 @@ public void shouldDisconnectPeersWhenPeerCountExceedsLimit() {\n     assertThat(peer1.isConnected()).isTrue();\n   }\n \n+  @Test\n+  public void shouldNotDisconnectStaticPeersWhenPeerCountExceedsLimit() {\n+    final StubPeer peer1 = new StubPeer(new MockNodeId(1));\n+    final StubPeer peer2 = new StubPeer(new MockNodeId(2));\n+    final ConnectionManager manager = createManager(new TargetPeerRange(1, 1), PEER1, PEER2);\n+    when(network.connect(PEER1)).thenReturn(SafeFuture.completedFuture(peer1));\n+    when(network.connect(PEER2)).thenReturn(SafeFuture.completedFuture(peer2));\n+    manager.start().join();\n+\n+    final PeerConnectedSubscriber<Peer> peerConnectedSubscriber = getPeerConnectedSubscriber();\n+\n+    when(network.streamPeers()).thenReturn(Stream.of(peer2, peer1));\n+    when(network.getPeerCount()).thenReturn(2);\n+    peerConnectedSubscriber.onConnected(peer1);\n+\n+    // Should disconnect one peer to get back down to our target of max 1 peer.", "originalCommit": "f601e72f1febf53966045cccecc242b9b6546f8b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3747771e6ba234da2614144792a38a86e88df54e", "chunk": "diff --git a/networking/p2p/src/test/java/tech/pegasys/artemis/networking/p2p/discovery/ConnectionManagerTest.java b/networking/p2p/src/test/java/tech/pegasys/artemis/networking/p2p/discovery/ConnectionManagerTest.java\nindex 6151a27f0e..463b0f4585 100644\n--- a/networking/p2p/src/test/java/tech/pegasys/artemis/networking/p2p/discovery/ConnectionManagerTest.java\n+++ b/networking/p2p/src/test/java/tech/pegasys/artemis/networking/p2p/discovery/ConnectionManagerTest.java\n\n@@ -377,7 +377,7 @@ class ConnectionManagerTest {\n     when(network.getPeerCount()).thenReturn(2);\n     peerConnectedSubscriber.onConnected(peer1);\n \n-    // Should disconnect one peer to get back down to our target of max 1 peer.\n+    // Should not disconnect static peers\n     assertThat(peer2.isConnected()).isTrue();\n     assertThat(peer1.isConnected()).isTrue();\n   }\n"}}, {"oid": "3747771e6ba234da2614144792a38a86e88df54e", "url": "https://github.com/ConsenSys/teku/commit/3747771e6ba234da2614144792a38a86e88df54e", "message": "Update networking/p2p/src/test/java/tech/pegasys/artemis/networking/p2p/discovery/ConnectionManagerTest.java\n\nCo-Authored-By: mbaxter <meredith.baxter@consensys.net>", "committedDate": "2020-03-09T20:45:32Z", "type": "commit"}, {"oid": "bd1fd7936a75cdbb28c5fdabbda7bd72ec5b0520", "url": "https://github.com/ConsenSys/teku/commit/bd1fd7936a75cdbb28c5fdabbda7bd72ec5b0520", "message": "Merge branch 'master' into do-not-drop-static-peers", "committedDate": "2020-03-09T20:45:40Z", "type": "commit"}]}