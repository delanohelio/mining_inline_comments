{"pr_number": 2636, "pr_title": "split out duties scheduler into separate schedulers", "pr_createdAt": "2020-08-21T04:35:10Z", "pr_url": "https://github.com/ConsenSys/teku/pull/2636", "timeline": [{"oid": "7d50b22d87db8cee64da5c48661d1c47b240b60c", "url": "https://github.com/ConsenSys/teku/commit/7d50b22d87db8cee64da5c48661d1c47b240b60c", "message": "split out duties scheduler into separate schedulers\n\n - attestation and block production schedulers have different requirements, so splitting them out will allow different processing\n\nIncomplete\n\n - several regression tests need to be enabled again\n\n - further testing on validator nodes other than just minimal will be needed to ensure we haven't degraded processing.\n\npartially addresses #2529\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-08-21T04:31:10Z", "type": "commit"}, {"oid": "cd5e5c6acb66be3e64e3e8ea043d5bcad57020db", "url": "https://github.com/ConsenSys/teku/commit/cd5e5c6acb66be3e64e3e8ea043d5bcad57020db", "message": "spotless\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-08-21T04:41:39Z", "type": "commit"}, {"oid": "17d01d1672ce4fda66c87579fa88d5f4dde4bc66", "url": "https://github.com/ConsenSys/teku/commit/17d01d1672ce4fda66c87579fa88d5f4dde4bc66", "message": "build fix\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-08-21T05:06:04Z", "type": "commit"}, {"oid": "62f1726d5be6135ad60c1198938e248451b24d4d", "url": "https://github.com/ConsenSys/teku/commit/62f1726d5be6135ad60c1198938e248451b24d4d", "message": "Merge remote-tracking branch 'upstream/master' into 2529", "committedDate": "2020-08-24T20:59:44Z", "type": "commit"}, {"oid": "7a4befd3b6a9d25f5f359e28c0469761afa82df1", "url": "https://github.com/ConsenSys/teku/commit/7a4befd3b6a9d25f5f359e28c0469761afa82df1", "message": "fix disabled test cases\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-08-24T23:44:20Z", "type": "commit"}, {"oid": "22a872ec3ad2c2b1cbd86876b45d9be80aad7c26", "url": "https://github.com/ConsenSys/teku/commit/22a872ec3ad2c2b1cbd86876b45d9be80aad7c26", "message": "clean up tests\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-08-25T01:00:00Z", "type": "commit"}, {"oid": "29969cdc63c0dd007ae77f499335131678f9ba34", "url": "https://github.com/ConsenSys/teku/commit/29969cdc63c0dd007ae77f499335131678f9ba34", "message": "Merge remote-tracking branch 'upstream/master' into 2529", "committedDate": "2020-08-25T01:12:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjIxOTc5OQ==", "url": "https://github.com/ConsenSys/teku/pull/2636#discussion_r476219799", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                LOG.debug(\"Chain reorganisation detected. Recalculating validator attestation duties\");\n          \n          \n            \n                LOG.debug(\"Chain reorganisation detected. Recalculating validator duties\");\n          \n      \n    \n    \n  \n\nsince this is the base class used for both attestations and blocks. Or just remove this and leave logging to the subclasses.", "author": "ajsutton", "createdAt": "2020-08-25T06:59:13Z", "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/AbstractDutyScheduler.java", "diffHunk": "@@ -0,0 +1,83 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.validator.client;\n+\n+import static tech.pegasys.teku.datastructures.util.BeaconStateUtil.compute_epoch_at_slot;\n+\n+import java.util.NavigableMap;\n+import java.util.TreeMap;\n+import java.util.function.BiConsumer;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import tech.pegasys.teku.infrastructure.unsigned.UInt64;\n+import tech.pegasys.teku.validator.api.ValidatorTimingChannel;\n+\n+public abstract class AbstractDutyScheduler implements ValidatorTimingChannel {\n+  private static final Logger LOG = LogManager.getLogger();\n+  private final DutyLoader epochDutiesScheduler;\n+\n+  protected final NavigableMap<UInt64, DutyQueue> dutiesByEpoch = new TreeMap<>();\n+\n+  protected AbstractDutyScheduler(final DutyLoader epochDutiesScheduler) {\n+    this.epochDutiesScheduler = epochDutiesScheduler;\n+  }\n+\n+  protected DutyQueue requestDutiesForEpoch(final UInt64 epochNumber) {\n+    return new DutyQueue(epochDutiesScheduler.loadDutiesForEpoch(epochNumber));\n+  }\n+\n+  protected void notifyDutyQueue(final BiConsumer<DutyQueue, UInt64> action, final UInt64 slot) {\n+    final DutyQueue dutyQueue = dutiesByEpoch.get(compute_epoch_at_slot(slot));\n+    if (dutyQueue != null) {\n+      action.accept(dutyQueue, slot);\n+    }\n+  }\n+\n+  @Override\n+  public void onSlot(final UInt64 slot) {\n+    final UInt64 epochNumber = compute_epoch_at_slot(slot);\n+    removePriorEpochs(epochNumber);\n+    dutiesByEpoch.computeIfAbsent(epochNumber, this::requestDutiesForEpoch);\n+  }\n+\n+  @Override\n+  public void onChainReorg(final UInt64 newSlot) {\n+    LOG.debug(\"Chain reorganisation detected. Recalculating validator attestation duties\");", "originalCommit": "29969cdc63c0dd007ae77f499335131678f9ba34", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjcwMjg2Ng==", "url": "https://github.com/ConsenSys/teku/pull/2636#discussion_r476702866", "bodyText": "ah yes, i moved this yesterday last thing and didnt catch the message!", "author": "rolfyone", "createdAt": "2020-08-25T19:59:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjIxOTc5OQ=="}], "type": "inlineReview", "revised_code": {"commit": "455700e6c2195d0d21af81de9b81333f5efa1377", "chunk": "diff --git a/validator/client/src/main/java/tech/pegasys/teku/validator/client/AbstractDutyScheduler.java b/validator/client/src/main/java/tech/pegasys/teku/validator/client/AbstractDutyScheduler.java\nindex fee485dc28..57a69d167d 100644\n--- a/validator/client/src/main/java/tech/pegasys/teku/validator/client/AbstractDutyScheduler.java\n+++ b/validator/client/src/main/java/tech/pegasys/teku/validator/client/AbstractDutyScheduler.java\n\n@@ -48,15 +48,18 @@ public abstract class AbstractDutyScheduler implements ValidatorTimingChannel {\n   public void onSlot(final UInt64 slot) {\n     final UInt64 epochNumber = compute_epoch_at_slot(slot);\n     removePriorEpochs(epochNumber);\n-    dutiesByEpoch.computeIfAbsent(epochNumber, this::requestDutiesForEpoch);\n+    recalculateDuties(epochNumber);\n   }\n \n   @Override\n   public void onChainReorg(final UInt64 newSlot) {\n-    LOG.debug(\"Chain reorganisation detected. Recalculating validator attestation duties\");\n+    LOG.debug(\"Chain reorganisation detected. Recalculating validator duties\");\n     dutiesByEpoch.clear();\n-    final UInt64 epochNumber = compute_epoch_at_slot(newSlot);\n-    dutiesByEpoch.put(epochNumber, requestDutiesForEpoch(epochNumber));\n+    recalculateDuties(compute_epoch_at_slot(newSlot));\n+  }\n+\n+  protected void recalculateDuties(final UInt64 epochNumber) {\n+    dutiesByEpoch.computeIfAbsent(epochNumber, this::requestDutiesForEpoch);\n   }\n \n   protected void removePriorEpochs(final UInt64 epochNumber) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjIyMTYxMg==", "url": "https://github.com/ConsenSys/teku/pull/2636#discussion_r476221612", "bodyText": "Probably worth extracting a dedicated method to compute duties relative to a given epoch (ie this line) which the attestation duties scheduler would override to calculate for this epoch and next rather than having to override both onSlot and onReorg to do it.", "author": "ajsutton", "createdAt": "2020-08-25T07:02:53Z", "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/AbstractDutyScheduler.java", "diffHunk": "@@ -0,0 +1,83 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.validator.client;\n+\n+import static tech.pegasys.teku.datastructures.util.BeaconStateUtil.compute_epoch_at_slot;\n+\n+import java.util.NavigableMap;\n+import java.util.TreeMap;\n+import java.util.function.BiConsumer;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import tech.pegasys.teku.infrastructure.unsigned.UInt64;\n+import tech.pegasys.teku.validator.api.ValidatorTimingChannel;\n+\n+public abstract class AbstractDutyScheduler implements ValidatorTimingChannel {\n+  private static final Logger LOG = LogManager.getLogger();\n+  private final DutyLoader epochDutiesScheduler;\n+\n+  protected final NavigableMap<UInt64, DutyQueue> dutiesByEpoch = new TreeMap<>();\n+\n+  protected AbstractDutyScheduler(final DutyLoader epochDutiesScheduler) {\n+    this.epochDutiesScheduler = epochDutiesScheduler;\n+  }\n+\n+  protected DutyQueue requestDutiesForEpoch(final UInt64 epochNumber) {\n+    return new DutyQueue(epochDutiesScheduler.loadDutiesForEpoch(epochNumber));\n+  }\n+\n+  protected void notifyDutyQueue(final BiConsumer<DutyQueue, UInt64> action, final UInt64 slot) {\n+    final DutyQueue dutyQueue = dutiesByEpoch.get(compute_epoch_at_slot(slot));\n+    if (dutyQueue != null) {\n+      action.accept(dutyQueue, slot);\n+    }\n+  }\n+\n+  @Override\n+  public void onSlot(final UInt64 slot) {\n+    final UInt64 epochNumber = compute_epoch_at_slot(slot);\n+    removePriorEpochs(epochNumber);\n+    dutiesByEpoch.computeIfAbsent(epochNumber, this::requestDutiesForEpoch);", "originalCommit": "29969cdc63c0dd007ae77f499335131678f9ba34", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "455700e6c2195d0d21af81de9b81333f5efa1377", "chunk": "diff --git a/validator/client/src/main/java/tech/pegasys/teku/validator/client/AbstractDutyScheduler.java b/validator/client/src/main/java/tech/pegasys/teku/validator/client/AbstractDutyScheduler.java\nindex fee485dc28..57a69d167d 100644\n--- a/validator/client/src/main/java/tech/pegasys/teku/validator/client/AbstractDutyScheduler.java\n+++ b/validator/client/src/main/java/tech/pegasys/teku/validator/client/AbstractDutyScheduler.java\n\n@@ -48,15 +48,18 @@ public abstract class AbstractDutyScheduler implements ValidatorTimingChannel {\n   public void onSlot(final UInt64 slot) {\n     final UInt64 epochNumber = compute_epoch_at_slot(slot);\n     removePriorEpochs(epochNumber);\n-    dutiesByEpoch.computeIfAbsent(epochNumber, this::requestDutiesForEpoch);\n+    recalculateDuties(epochNumber);\n   }\n \n   @Override\n   public void onChainReorg(final UInt64 newSlot) {\n-    LOG.debug(\"Chain reorganisation detected. Recalculating validator attestation duties\");\n+    LOG.debug(\"Chain reorganisation detected. Recalculating validator duties\");\n     dutiesByEpoch.clear();\n-    final UInt64 epochNumber = compute_epoch_at_slot(newSlot);\n-    dutiesByEpoch.put(epochNumber, requestDutiesForEpoch(epochNumber));\n+    recalculateDuties(compute_epoch_at_slot(newSlot));\n+  }\n+\n+  protected void recalculateDuties(final UInt64 epochNumber) {\n+    dutiesByEpoch.computeIfAbsent(epochNumber, this::requestDutiesForEpoch);\n   }\n \n   protected void removePriorEpochs(final UInt64 epochNumber) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjIyMjQ1NQ==", "url": "https://github.com/ConsenSys/teku/pull/2636#discussion_r476222455", "bodyText": "This is an important test to keep for the attestation duty scheduler but will have to be converted to checking it doesn't publish attestations for the same slot rather than blocks in this case.", "author": "ajsutton", "createdAt": "2020-08-25T07:04:49Z", "path": "validator/client/src/test/java/tech/pegasys/teku/validator/client/AttestationDutySchedulerTest.java", "diffHunk": "@@ -264,43 +175,14 @@ public void shouldDelayExecutingDutiesUntilSchedulingIsComplete() {\n     dutyScheduler.onAttestationCreationDue(ZERO);\n     dutyScheduler.onAttestationAggregationDue(ZERO);\n     // Duties haven't been loaded yet.\n-    verify(scheduledDuties, never()).produceBlock(ZERO);\n     verify(scheduledDuties, never()).produceAttestations(ZERO);\n     verify(scheduledDuties, never()).performAggregation(ZERO);\n \n     epoch0Duties.complete(Optional.of(emptyList()));\n-    verify(scheduledDuties).produceBlock(ZERO);\n     verify(scheduledDuties).produceAttestations(ZERO);\n     verify(scheduledDuties).performAggregation(ZERO);\n   }\n \n-  @Test\n-  public void shouldNotPerformDutiesForSameSlotTwice() {", "originalCommit": "29969cdc63c0dd007ae77f499335131678f9ba34", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "455700e6c2195d0d21af81de9b81333f5efa1377", "chunk": "diff --git a/validator/client/src/test/java/tech/pegasys/teku/validator/client/AttestationDutySchedulerTest.java b/validator/client/src/test/java/tech/pegasys/teku/validator/client/AttestationDutySchedulerTest.java\nindex 9797038c02..870fb8d742 100644\n--- a/validator/client/src/test/java/tech/pegasys/teku/validator/client/AttestationDutySchedulerTest.java\n+++ b/validator/client/src/test/java/tech/pegasys/teku/validator/client/AttestationDutySchedulerTest.java\n\n@@ -183,6 +183,34 @@ public class AttestationDutySchedulerTest extends AbstractDutySchedulerTest {\n     verify(scheduledDuties).performAggregation(ZERO);\n   }\n \n+  @Test\n+  public void shouldNotPerformDutiesForSameSlotTwice() {\n+    final UInt64 attestationProductionSlot = UInt64.valueOf(5);\n+    final ValidatorDuties validator1Duties =\n+        ValidatorDuties.withDuties(\n+            VALIDATOR1_KEY, 5, 3, 6, 0, List.of(), attestationProductionSlot);\n+    when(validatorApiChannel.getDuties(eq(ZERO), any()))\n+        .thenReturn(completedFuture(Optional.of(List.of(validator1Duties))));\n+\n+    final AttestationProductionDuty attestationDuty = mock(AttestationProductionDuty.class);\n+    when(attestationDuty.performDuty()).thenReturn(new SafeFuture<>());\n+    when(dutyFactory.createAttestationProductionDuty(attestationProductionSlot))\n+        .thenReturn(attestationDuty);\n+\n+    // Load duties\n+    dutyScheduler.onSlot(compute_start_slot_at_epoch(ZERO));\n+    verify(attestationDuty).addValidator(validator1, 3, 6, 5);\n+\n+    // Execute\n+    dutyScheduler.onAttestationCreationDue(attestationProductionSlot);\n+    verify(attestationDuty).performDuty();\n+\n+    // Somehow we triggered the same slot again.\n+    dutyScheduler.onAttestationCreationDue(attestationProductionSlot);\n+    // But shouldn't produce another block and get ourselves slashed.\n+    verifyNoMoreInteractions(attestationDuty);\n+  }\n+\n   @Test\n   public void shouldScheduleAttestationDuties() {\n     final UInt64 attestationSlot = UInt64.valueOf(5);\n"}}, {"oid": "455700e6c2195d0d21af81de9b81333f5efa1377", "url": "https://github.com/ConsenSys/teku/commit/455700e6c2195d0d21af81de9b81333f5efa1377", "message": "review feedback\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-08-25T20:46:12Z", "type": "commit"}, {"oid": "73ea105653f6c0e0c625562fd37f7be7fe156587", "url": "https://github.com/ConsenSys/teku/commit/73ea105653f6c0e0c625562fd37f7be7fe156587", "message": "Merge remote-tracking branch 'upstream/master' into 2529", "committedDate": "2020-08-25T20:51:29Z", "type": "commit"}]}