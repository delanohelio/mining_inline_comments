{"pr_number": 3073, "pr_title": "If the requested slot is empty, get the block header for the latest block.", "pr_createdAt": "2020-10-25T22:47:03Z", "pr_url": "https://github.com/ConsenSys/teku/pull/3073", "timeline": [{"oid": "a7006af1674091d92286318eeebd90d3f5c851c2", "url": "https://github.com/ConsenSys/teku/commit/a7006af1674091d92286318eeebd90d3f5c851c2", "message": "If the current slot is empty, get the block header for the latest block.\n\n - Previously an empty head slot would result in a 404 (not found) error.\n\n - It was possible for the slot of the finalized epoch to be empty, which would result in 404.\n\n - Retrieval of a specific slot may now result in a different slot being returned by `/eth/v1/beacon/headers/*` endpoints if the numeric requested slot had no block.\n\n - An empty slot will have the block header from the most recent block at that point, complete with the slot it was produced for.\n\n fixes #3071\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-10-25T22:45:28Z", "type": "commit"}, {"oid": "8020ba69ef13288062f597710b79e8e6a54f913a", "url": "https://github.com/ConsenSys/teku/commit/8020ba69ef13288062f597710b79e8e6a54f913a", "message": "spotless\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-10-25T22:47:11Z", "type": "commit"}, {"oid": "13a1018384dfbcaf2207203b7f5426de612d0d73", "url": "https://github.com/ConsenSys/teku/commit/13a1018384dfbcaf2207203b7f5426de612d0d73", "message": "refactor to factory.\n\nFixed broken regression test\n\nfixes #3069\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-10-26T20:55:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI2OTU5OQ==", "url": "https://github.com/ConsenSys/teku/pull/3073#discussion_r512269599", "bodyText": "We could have a default method getSingleBlock in the BlockSelector interface that does this conversion from list to Optional.  Could just do a blockList.stream().findFirst() so simplify it.", "author": "ajsutton", "createdAt": "2020-10-26T21:09:05Z", "path": "data/provider/src/main/java/tech/pegasys/teku/api/ChainDataProvider.java", "diffHunk": "@@ -196,24 +199,14 @@ public GetForkResponse getForkInfo() {\n       return chainUnavailable();\n     }\n \n-    final Optional<UInt64> maybeSlot = blockParameterToSlot(slotParameter);\n-    if (maybeSlot.isEmpty()) {\n-      return getBlockHeaderByBlockRoot(Bytes32.fromHexString(slotParameter));\n-    }\n-\n-    final UInt64 slot = maybeSlot.get();\n-    return combinedChainDataClient\n-        .getBlockAtSlotExact(slot)\n-        .thenApply(maybeBlock -> maybeBlock.map(block -> new BlockHeader(block, true)));\n-  }\n-\n-  // because this is called after attempting to match a block to a slot, this function\n-  // will only ever be run for non canonical blocks. if made public, it will have to be updated to\n-  // first check that the block doesnt have a slot, before it can make that assumption.\n-  SafeFuture<Optional<BlockHeader>> getBlockHeaderByBlockRoot(final Bytes32 blockRoot) {\n-    return combinedChainDataClient\n-        .getBlockByBlockRoot(blockRoot)\n-        .thenApply(maybeBlock -> maybeBlock.map(block -> new BlockHeader(block, false)));\n+    return defaultBlockSelectorFactory\n+        .defaultBlockSelector(slotParameter)\n+        .getBlock()\n+        .thenApply(\n+            blockList ->\n+                blockList.isEmpty()\n+                    ? Optional.empty()\n+                    : Optional.of(new BlockHeader(blockList.get(0), true)));", "originalCommit": "13a1018384dfbcaf2207203b7f5426de612d0d73", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI3MzQ4Ng==", "url": "https://github.com/ConsenSys/teku/pull/3073#discussion_r512273486", "bodyText": "Also I'd have expected the handler to convert the String slotParameter to a BlockSelector and then pass the BlockSelector into this method.  That way the handler is responsible for interpreting the request and the provider has the business logic.  With it this way the provider is interpreting the request and doing the business logic.", "author": "ajsutton", "createdAt": "2020-10-26T21:16:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI2OTU5OQ=="}], "type": "inlineReview", "revised_code": {"commit": "55a5b1d8482dc229d4d1c465d7597ce9a0168043", "chunk": "diff --git a/data/provider/src/main/java/tech/pegasys/teku/api/ChainDataProvider.java b/data/provider/src/main/java/tech/pegasys/teku/api/ChainDataProvider.java\nindex 6690617f55..6a223ddf54 100644\n--- a/data/provider/src/main/java/tech/pegasys/teku/api/ChainDataProvider.java\n+++ b/data/provider/src/main/java/tech/pegasys/teku/api/ChainDataProvider.java\n\n@@ -194,19 +194,17 @@ public class ChainDataProvider {\n         .thenApply(block -> block.map(GetBlockResponse::new));\n   }\n \n-  public SafeFuture<Optional<BlockHeader>> getBlockHeaderByBlockId(final String slotParameter) {\n+  public SafeFuture<Optional<BlockHeader>> getBlockHeader(final String slotParameter) {\n     if (!isStoreAvailable()) {\n       return chainUnavailable();\n     }\n \n     return defaultBlockSelectorFactory\n         .defaultBlockSelector(slotParameter)\n-        .getBlock()\n-        .thenApply(\n-            blockList ->\n-                blockList.isEmpty()\n-                    ? Optional.empty()\n-                    : Optional.of(new BlockHeader(blockList.get(0), true)));\n+        .getSingleBlock()\n+        .thenApply(maybeBlock ->\n+            maybeBlock.map(block -> new BlockHeader(block, true)));\n+\n   }\n \n   public boolean isStoreAvailable() {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI3MDcwMw==", "url": "https://github.com/ConsenSys/teku/pull/3073#discussion_r512270703", "bodyText": "We shouldn't be expecting this and it probably shouldn't be in this change.  Need to work out why it's being released twice and fix that in a different PR. :)", "author": "ajsutton", "createdAt": "2020-10-26T21:10:57Z", "path": "networking/eth2/src/test/java/tech/pegasys/teku/networking/eth2/rpc/core/Eth2OutgoingRequestHandlerTest.java", "diffHunk": "@@ -280,7 +282,7 @@ public void shouldCompleteExceptionallyWhenClosedWithTruncatedMessage() {\n \n     asyncRequestRunner.executeQueuedActions();\n \n-    complete();\n+    assertThrows(IllegalReferenceCountException.class, this::complete);", "originalCommit": "13a1018384dfbcaf2207203b7f5426de612d0d73", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjMxNjYyMA==", "url": "https://github.com/ConsenSys/teku/pull/3073#discussion_r512316620", "bodyText": "alright but it blocks every build i do, so basically i cant get a green build on my machine before i push", "author": "rolfyone", "createdAt": "2020-10-26T22:53:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI3MDcwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjMxNzE3Nw==", "url": "https://github.com/ConsenSys/teku/pull/3073#discussion_r512317177", "bodyText": "I don't think this is the right fix either - complete exceptionally is different to throws exception.  I wouldn't have expected to get this exception from a call to complete.", "author": "ajsutton", "createdAt": "2020-10-26T22:54:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI3MDcwMw=="}], "type": "inlineReview", "revised_code": {"commit": "4b2a5e95587efda449c1cc3bc2ac56c232666374", "chunk": "diff --git a/networking/eth2/src/test/java/tech/pegasys/teku/networking/eth2/rpc/core/Eth2OutgoingRequestHandlerTest.java b/networking/eth2/src/test/java/tech/pegasys/teku/networking/eth2/rpc/core/Eth2OutgoingRequestHandlerTest.java\nindex 0c3269ab47..25a6a5ace9 100644\n--- a/networking/eth2/src/test/java/tech/pegasys/teku/networking/eth2/rpc/core/Eth2OutgoingRequestHandlerTest.java\n+++ b/networking/eth2/src/test/java/tech/pegasys/teku/networking/eth2/rpc/core/Eth2OutgoingRequestHandlerTest.java\n\n@@ -282,7 +282,7 @@ public abstract class Eth2OutgoingRequestHandlerTest\n \n     asyncRequestRunner.executeQueuedActions();\n \n-    assertThrows(IllegalReferenceCountException.class, this::complete);\n+    complete();\n \n     assertThat(finishedProcessingFuture).isCompletedExceptionally();\n   }\n"}}, {"oid": "4b2a5e95587efda449c1cc3bc2ac56c232666374", "url": "https://github.com/ConsenSys/teku/commit/4b2a5e95587efda449c1cc3bc2ac56c232666374", "message": "review feedback.\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-10-26T22:54:27Z", "type": "commit"}, {"oid": "55a5b1d8482dc229d4d1c465d7597ce9a0168043", "url": "https://github.com/ConsenSys/teku/commit/55a5b1d8482dc229d4d1c465d7597ce9a0168043", "message": "review feedback.\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-10-26T23:38:10Z", "type": "commit"}, {"oid": "5781cd9919a0dfefe04f49c7e03b71fb7775a79f", "url": "https://github.com/ConsenSys/teku/commit/5781cd9919a0dfefe04f49c7e03b71fb7775a79f", "message": "spotless\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-10-26T23:46:05Z", "type": "commit"}, {"oid": "b4055517ca72514dab9dcf522536ac6bb8d6d302", "url": "https://github.com/ConsenSys/teku/commit/b4055517ca72514dab9dcf522536ac6bb8d6d302", "message": "Merge remote-tracking branch 'upstream/master' into 3071", "committedDate": "2020-10-26T23:52:10Z", "type": "commit"}, {"oid": "6ce34c5b72adbac2af69caf8122a33746fc84272", "url": "https://github.com/ConsenSys/teku/commit/6ce34c5b72adbac2af69caf8122a33746fc84272", "message": "Merge branch 'master' into 3071", "committedDate": "2020-10-27T00:06:50Z", "type": "commit"}]}