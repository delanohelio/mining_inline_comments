{"pr_number": 1701, "pr_title": "Skip requesting genesis block in PeerChainValidator", "pr_createdAt": "2020-05-01T00:59:54Z", "pr_url": "https://github.com/ConsenSys/teku/pull/1701", "timeline": [{"oid": "aa4f8e1577e888921d46e07a9804071560738741", "url": "https://github.com/ConsenSys/teku/commit/aa4f8e1577e888921d46e07a9804071560738741", "message": "Skip checking that the genesis block matches.  The fork digest check is enough of a check.", "committedDate": "2020-05-01T00:56:05Z", "type": "commit"}, {"oid": "852514a31fdccfd10826f68380f5c9453650f18c", "url": "https://github.com/ConsenSys/teku/commit/852514a31fdccfd10826f68380f5c9453650f18c", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into skip-checking-genesis", "committedDate": "2020-05-01T00:56:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU2ODk5Mg==", "url": "https://github.com/ConsenSys/teku/pull/1701#discussion_r418568992", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private void remoteOnSameChainButReturnsResponseWhenGenesisRequested() {\n          \n          \n            \n              private void remoteOnSameChainButReturnsInvalidResponseWhenGenesisRequested() {", "author": "mbaxter", "createdAt": "2020-05-01T14:36:44Z", "path": "networking/eth2/src/test/java/tech/pegasys/artemis/networking/eth2/peers/PeerChainValidatorTest.java", "diffHunk": "@@ -317,15 +317,18 @@ private void remoteChainIsAheadOnSameChain() {\n     when(peer.requestBlockBySlot(earlierBlockSlot)).thenReturn(blockFuture);\n   }\n \n-  private void remoteOnSameChainButWillNotReturnGenesis() {\n-    final SafeFuture<SignedBeaconBlock> postGenesisBlock = SafeFuture.completedFuture(earlierBlock);\n+  private void remoteOnSameChainButReturnsResponseWhenGenesisRequested() {", "originalCommit": "852514a31fdccfd10826f68380f5c9453650f18c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODc0NjAwMA==", "url": "https://github.com/ConsenSys/teku/pull/1701#discussion_r418746000", "bodyText": "Done.", "author": "ajsutton", "createdAt": "2020-05-01T21:29:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU2ODk5Mg=="}], "type": "inlineReview", "revised_code": {"commit": "d512cfcc7472a6d3b0695692aeea9e9cd584076e", "chunk": "diff --git a/networking/eth2/src/test/java/tech/pegasys/artemis/networking/eth2/peers/PeerChainValidatorTest.java b/networking/eth2/src/test/java/tech/pegasys/artemis/networking/eth2/peers/PeerChainValidatorTest.java\nindex 69c5409772..6f32c60d59 100644\n--- a/networking/eth2/src/test/java/tech/pegasys/artemis/networking/eth2/peers/PeerChainValidatorTest.java\n+++ b/networking/eth2/src/test/java/tech/pegasys/artemis/networking/eth2/peers/PeerChainValidatorTest.java\n\n@@ -317,7 +317,7 @@ public class PeerChainValidatorTest {\n     when(peer.requestBlockBySlot(earlierBlockSlot)).thenReturn(blockFuture);\n   }\n \n-  private void remoteOnSameChainButReturnsResponseWhenGenesisRequested() {\n+  private void remoteOnSameChainButReturnsInvalidResponseWhenGenesisRequested() {\n     final SafeFuture<Optional<SignedBeaconBlock>> optionalBlockFuture =\n         SafeFuture.completedFuture(Optional.of(genesisBlock));\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU3MDMwMg==", "url": "https://github.com/ConsenSys/teku/pull/1701#discussion_r418570302", "bodyText": "I think we can return early before we pull this block by checking if the finalizedEpochSlot is the genesis slot", "author": "mbaxter", "createdAt": "2020-05-01T14:39:12Z", "path": "networking/eth2/src/main/java/tech/pegasys/artemis/networking/eth2/peers/PeerChainValidator.java", "diffHunk": "@@ -193,11 +193,14 @@ private boolean remoteEpochIsInvalid(\n         .thenApply(maybeBlock -> blockToSlot(finalizedEpochSlot, maybeBlock))\n         .thenCompose(\n             blockSlot -> {\n+              if (blockSlot.equals(UnsignedLong.valueOf(Constants.GENESIS_SLOT))) {", "originalCommit": "852514a31fdccfd10826f68380f5c9453650f18c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODc0NTgwMg==", "url": "https://github.com/ConsenSys/teku/pull/1701#discussion_r418745802", "bodyText": "We can but we need the existing check as well.  We might have finalised epoch 1 without any blocks ever being produced, so the block in effect would still be the genesis block.", "author": "ajsutton", "createdAt": "2020-05-01T21:28:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU3MDMwMg=="}], "type": "inlineReview", "revised_code": {"commit": "d512cfcc7472a6d3b0695692aeea9e9cd584076e", "chunk": "diff --git a/networking/eth2/src/main/java/tech/pegasys/artemis/networking/eth2/peers/PeerChainValidator.java b/networking/eth2/src/main/java/tech/pegasys/artemis/networking/eth2/peers/PeerChainValidator.java\nindex ebbf763d97..53842e82d6 100644\n--- a/networking/eth2/src/main/java/tech/pegasys/artemis/networking/eth2/peers/PeerChainValidator.java\n+++ b/networking/eth2/src/main/java/tech/pegasys/artemis/networking/eth2/peers/PeerChainValidator.java\n\n@@ -188,6 +188,11 @@ public class PeerChainValidator {\n   private SafeFuture<Boolean> verifyPeerAgreesWithOurFinalizedCheckpoint(\n       Checkpoint finalizedCheckpoint) {\n     final UnsignedLong finalizedEpochSlot = finalizedCheckpoint.getEpochStartSlot();\n+    if (finalizedEpochSlot.equals(UnsignedLong.valueOf(Constants.GENESIS_SLOT))) {\n+      // Assume that our genesis blocks match because we've already verified the fork\n+      // digest.\n+      return SafeFuture.completedFuture(true);\n+    }\n     return historicalChainData\n         .getLatestFinalizedBlockAtSlot(finalizedEpochSlot)\n         .thenApply(maybeBlock -> blockToSlot(finalizedEpochSlot, maybeBlock))\n"}}, {"oid": "1d1417e7427ef33c8e0ddf206fe6671770c5297a", "url": "https://github.com/ConsenSys/teku/commit/1d1417e7427ef33c8e0ddf206fe6671770c5297a", "message": "Merge branch 'master' into skip-checking-genesis", "committedDate": "2020-05-01T15:56:36Z", "type": "commit"}, {"oid": "93a90a897beeb8eb94784f5a8276f8899ab873e3", "url": "https://github.com/ConsenSys/teku/commit/93a90a897beeb8eb94784f5a8276f8899ab873e3", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into skip-checking-genesis", "committedDate": "2020-05-01T21:26:02Z", "type": "commit"}, {"oid": "d512cfcc7472a6d3b0695692aeea9e9cd584076e", "url": "https://github.com/ConsenSys/teku/commit/d512cfcc7472a6d3b0695692aeea9e9cd584076e", "message": "Review feedback.", "committedDate": "2020-05-01T21:29:10Z", "type": "commit"}, {"oid": "4576feed5b864a5eb11b3977f752989c3546c754", "url": "https://github.com/ConsenSys/teku/commit/4576feed5b864a5eb11b3977f752989c3546c754", "message": "Merge branch 'skip-checking-genesis' of github.com:ajsutton/teku into skip-checking-genesis", "committedDate": "2020-05-01T21:30:42Z", "type": "commit"}]}