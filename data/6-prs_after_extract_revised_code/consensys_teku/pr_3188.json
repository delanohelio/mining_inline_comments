{"pr_number": 3188, "pr_title": "Implement v1.0.0 message ID calculation", "pr_createdAt": "2020-11-09T21:39:06Z", "pr_url": "https://github.com/ConsenSys/teku/pull/3188", "timeline": [{"oid": "8cad082f6d00e73ed4579b2996c6e1970b0f1673", "url": "https://github.com/ConsenSys/teku/commit/8cad082f6d00e73ed4579b2996c6e1970b0f1673", "message": "Bump Libp2p version to 0.5.8", "committedDate": "2020-10-15T10:50:29Z", "type": "commit"}, {"oid": "941fad675db292488302efad51931d7a571c6575", "url": "https://github.com/ConsenSys/teku/commit/941fad675db292488302efad51931d7a571c6575", "message": "Set Gossip seenTTL parameter as per Eth2 spec", "committedDate": "2020-10-15T10:51:20Z", "type": "commit"}, {"oid": "c0b7035597044eff554a10fa8dd6db096a1db1ad", "url": "https://github.com/ConsenSys/teku/commit/c0b7035597044eff554a10fa8dd6db096a1db1ad", "message": "Merge branch 'master' into feature/update-libp2p-0.5.8", "committedDate": "2020-10-27T18:08:08Z", "type": "commit"}, {"oid": "f00dd277741f7743e2fcef4ee28216b2503dddc5", "url": "https://github.com/ConsenSys/teku/commit/f00dd277741f7743e2fcef4ee28216b2503dddc5", "message": "Add Log4j dependencies which were transitively pulled from Libp2p before", "committedDate": "2020-10-28T19:15:02Z", "type": "commit"}, {"oid": "b026ec531012f7185d7fdc056d7a003dfa6f44cf", "url": "https://github.com/ConsenSys/teku/commit/b026ec531012f7185d7fdc056d7a003dfa6f44cf", "message": "Merge remote-tracking branch 'Nashat/feature/update-libp2p-0.5.8' into feature/update-libp2p-0.5.8", "committedDate": "2020-10-28T19:15:31Z", "type": "commit"}, {"oid": "d0803fba0e6bedd9752dffe7409240de51b23391", "url": "https://github.com/ConsenSys/teku/commit/d0803fba0e6bedd9752dffe7409240de51b23391", "message": "Add another lost Log4j dependency", "committedDate": "2020-10-28T19:35:34Z", "type": "commit"}, {"oid": "6ec24d004e407d7cc9c7d267c82fa3fcf061d02d", "url": "https://github.com/ConsenSys/teku/commit/6ec24d004e407d7cc9c7d267c82fa3fcf061d02d", "message": "Add GossipMessage and GossipMessageFactory interfaces to abstract over gossip message and add possibility to decompress a message just once on earlier stage for calculating message-id and reuse decompressed payload when the message is actually handled", "committedDate": "2020-11-02T17:52:43Z", "type": "commit"}, {"oid": "f7552b555b6e73dc9f30cec7985de1a10f8b606e", "url": "https://github.com/ConsenSys/teku/commit/f7552b555b6e73dc9f30cec7985de1a10f8b606e", "message": "Merge remote-tracking branch 'origin/master' into feature/uncompressed-message-id\n\n# Conflicts:\n#\tnetworking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/gossip/topics/topichandlers/Eth2TopicHandler.java\n#\tnetworking/eth2/src/test/java/tech/pegasys/teku/networking/eth2/gossip/topics/AttesterSlashingTopicHandlerTest.java\n#\tnetworking/eth2/src/test/java/tech/pegasys/teku/networking/eth2/gossip/topics/BlockTopicHandlerTest.java\n#\tnetworking/eth2/src/test/java/tech/pegasys/teku/networking/eth2/gossip/topics/ProposerSlashingTopicHandlerTest.java\n#\tnetworking/eth2/src/test/java/tech/pegasys/teku/networking/eth2/gossip/topics/VoluntaryExitTopicHandlerTest.java", "committedDate": "2020-11-02T17:56:00Z", "type": "commit"}, {"oid": "fff9c2c4d449df61bdb55f1b78525197e2e1e698", "url": "https://github.com/ConsenSys/teku/commit/fff9c2c4d449df61bdb55f1b78525197e2e1e698", "message": "Resolve merge conflicts", "committedDate": "2020-11-02T18:01:55Z", "type": "commit"}, {"oid": "6d0c0b9376e34e199d52520ab1a8292af1d2aedd", "url": "https://github.com/ConsenSys/teku/commit/6d0c0b9376e34e199d52520ab1a8292af1d2aedd", "message": "Fix the test", "committedDate": "2020-11-05T12:11:18Z", "type": "commit"}, {"oid": "44f08546a611a1ca82f7c59d2199c4ae2dee4900", "url": "https://github.com/ConsenSys/teku/commit/44f08546a611a1ca82f7c59d2199c4ae2dee4900", "message": "Merge remote-tracking branch 'origin/master' into feature/uncompressed-message-id\n\n# Conflicts:\n#\tnetworking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/gossip/topics/Eth2TopicHandler.java\n#\tnetworking/eth2/src/test/java/tech/pegasys/teku/networking/eth2/gossip/topics/AttesterSlashingTopicHandlerTest.java\n#\tnetworking/eth2/src/test/java/tech/pegasys/teku/networking/eth2/gossip/topics/BlockTopicHandlerTest.java\n#\tnetworking/eth2/src/test/java/tech/pegasys/teku/networking/eth2/gossip/topics/ProposerSlashingTopicHandlerTest.java\n#\tnetworking/eth2/src/test/java/tech/pegasys/teku/networking/eth2/gossip/topics/VoluntaryExitTopicHandlerTest.java", "committedDate": "2020-11-05T12:14:03Z", "type": "commit"}, {"oid": "f3eb71d0f8015dd099a92aeb2852e70a4f4b6335", "url": "https://github.com/ConsenSys/teku/commit/f3eb71d0f8015dd099a92aeb2852e70a4f4b6335", "message": "Resolve merge conflict", "committedDate": "2020-11-05T12:17:36Z", "type": "commit"}, {"oid": "0e299fc77753ff8d47b3f0931316f82fe3b5f89a", "url": "https://github.com/ConsenSys/teku/commit/0e299fc77753ff8d47b3f0931316f82fe3b5f89a", "message": "Remove uncompress from SszSnappyEncoding", "committedDate": "2020-11-05T13:16:10Z", "type": "commit"}, {"oid": "c3529644f23e7cd0123f947389731f7dde2417a9", "url": "https://github.com/ConsenSys/teku/commit/c3529644f23e7cd0123f947389731f7dde2417a9", "message": "Refactor: rely message id calculation to GossipEncoding.", "committedDate": "2020-11-05T17:48:59Z", "type": "commit"}, {"oid": "a82cd0c36fd5ed3b8cd9adcef84cb270c640cfda", "url": "https://github.com/ConsenSys/teku/commit/a82cd0c36fd5ed3b8cd9adcef84cb270c640cfda", "message": "Add GossipEncoding.prepareUnknownMessage()", "committedDate": "2020-11-09T11:21:48Z", "type": "commit"}, {"oid": "89757e1474b6ec5973072605889ce78ca599f590", "url": "https://github.com/ConsenSys/teku/commit/89757e1474b6ec5973072605889ce78ca599f590", "message": "Replace GossipRouter default SeenCache", "committedDate": "2020-11-09T20:56:26Z", "type": "commit"}, {"oid": "18575f2e4db4a168c5cd8efb71132e531d90de17", "url": "https://github.com/ConsenSys/teku/commit/18575f2e4db4a168c5cd8efb71132e531d90de17", "message": "Apply spotless", "committedDate": "2020-11-10T08:40:17Z", "type": "commit"}, {"oid": "e1e49ab66ebdce9e7481079863eb4228f8aa8c32", "url": "https://github.com/ConsenSys/teku/commit/e1e49ab66ebdce9e7481079863eb4228f8aa8c32", "message": "Fix gradle dependency", "committedDate": "2020-11-10T08:40:36Z", "type": "commit"}, {"oid": "0d9bf8c900fd1c247b20f2112e7984a347689d12", "url": "https://github.com/ConsenSys/teku/commit/0d9bf8c900fd1c247b20f2112e7984a347689d12", "message": "Use system path separator for test", "committedDate": "2020-11-10T10:07:31Z", "type": "commit"}, {"oid": "ccf96d0d7d56d20e379e3769908b08c16bc7df24", "url": "https://github.com/ConsenSys/teku/commit/ccf96d0d7d56d20e379e3769908b08c16bc7df24", "message": "For Windows '.*' files are not hidden so just ignore these cases", "committedDate": "2020-11-10T10:16:07Z", "type": "commit"}, {"oid": "0af2777a5beef4a2e1f32e683141ca38ed9841df", "url": "https://github.com/ConsenSys/teku/commit/0af2777a5beef4a2e1f32e683141ca38ed9841df", "message": "Creating symbolic links requires elevated privileges on Windows. Without them FileSystemException is thrown. So just catching any IOException on a link creation attempt would handle the Windows case (the test would be ignored)", "committedDate": "2020-11-10T10:34:27Z", "type": "commit"}, {"oid": "82b6eac730467b8cdcfbe84638391230b1304560", "url": "https://github.com/ConsenSys/teku/commit/82b6eac730467b8cdcfbe84638391230b1304560", "message": "Spotless", "committedDate": "2020-11-10T10:40:46Z", "type": "commit"}, {"oid": "97f9a676208e23fb973a496e2e179e47e3d1f8a4", "url": "https://github.com/ConsenSys/teku/commit/97f9a676208e23fb973a496e2e179e47e3d1f8a4", "message": "Make comparing multi-line strings cross-platform", "committedDate": "2020-11-10T11:08:53Z", "type": "commit"}, {"oid": "355985a1ed0b2dcd80681bdacf4ed837daf05482", "url": "https://github.com/ConsenSys/teku/commit/355985a1ed0b2dcd80681bdacf4ed837daf05482", "message": "Temporarily adjust test to not fail on Windows", "committedDate": "2020-11-10T12:45:39Z", "type": "commit"}, {"oid": "5af79c02d2655f5a04d362c64f318724f9bb816c", "url": "https://github.com/ConsenSys/teku/commit/5af79c02d2655f5a04d362c64f318724f9bb816c", "message": "Exclude KeyStoreFilesLocatorTest symlink testcase for Windows platform", "committedDate": "2020-11-10T12:52:56Z", "type": "commit"}, {"oid": "59ae77af2e30f65a82a50d29f98e1c791d776693", "url": "https://github.com/ConsenSys/teku/commit/59ae77af2e30f65a82a50d29f98e1c791d776693", "message": "Merge remote-tracking branch 'origin/master' into feature/uncompressed-message-id\n\n# Conflicts:\n#\tgradle/versions.gradle\n#\tnetworking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/ActiveEth2Network.java\n#\tnetworking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/gossip/topics/topichandlers/Eth2TopicHandler.java\n#\tnetworking/eth2/src/test/java/tech/pegasys/teku/networking/eth2/gossip/topics/BlockTopicHandlerTest.java\n#\tnetworking/eth2/src/test/java/tech/pegasys/teku/networking/eth2/gossip/topics/Eth2TopicHandlerTest.java\n#\tnetworking/p2p/src/main/java/tech/pegasys/teku/networking/p2p/libp2p/LibP2PNetwork.java", "committedDate": "2020-11-10T14:04:07Z", "type": "commit"}, {"oid": "b402ee0d64f7ca859e6f15fef12e1145fedf319d", "url": "https://github.com/ConsenSys/teku/commit/b402ee0d64f7ca859e6f15fef12e1145fedf319d", "message": "Resolve merge conflicts", "committedDate": "2020-11-10T14:47:28Z", "type": "commit"}, {"oid": "4d9e21f1332e4dfdb27529394116d5124ca93b28", "url": "https://github.com/ConsenSys/teku/commit/4d9e21f1332e4dfdb27529394116d5124ca93b28", "message": "Fix the class for deserialization", "committedDate": "2020-11-10T15:05:11Z", "type": "commit"}, {"oid": "a10383d7ead085c02db4f6ea6bfe526365ae22a2", "url": "https://github.com/ConsenSys/teku/commit/a10383d7ead085c02db4f6ea6bfe526365ae22a2", "message": "Merge branch 'fix/win-keys-file-test' into feature/uncompressed-message-id", "committedDate": "2020-11-10T15:19:51Z", "type": "commit"}, {"oid": "bce6aba96f4d4b70f1e189c675f1d8d41cf722da", "url": "https://github.com/ConsenSys/teku/commit/bce6aba96f4d4b70f1e189c675f1d8d41cf722da", "message": "Rename classes and add some javadocs", "committedDate": "2020-11-10T16:17:18Z", "type": "commit"}, {"oid": "5a4220fe3796828c3ba8952047be5b54d5623170", "url": "https://github.com/ConsenSys/teku/commit/5a4220fe3796828c3ba8952047be5b54d5623170", "message": "Refactor GossipEncoding", "committedDate": "2020-11-10T16:38:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTEyNDg1NQ==", "url": "https://github.com/ConsenSys/teku/pull/3188#discussion_r521124855", "bodyText": "Probably worth keeping these Windows test fixes to the other PR but that one's ready to merge anyway so should all work out.", "author": "ajsutton", "createdAt": "2020-11-11T05:41:14Z", "path": "infrastructure/io/src/test/java/tech/pegasys/teku/infrastructure/io/resource/FileResourceLoaderTest.java", "diffHunk": "@@ -43,10 +43,7 @@ public void shouldReturnEmptyWhenFileDoesNotExist(@TempDir Path tempDir) throws\n   }\n \n   @Test\n-  public void shouldCreateInputStreamWhenPathIsADirectory(@TempDir Path tempDir) throws Exception {\n-    // We could potentially return empty for directories, but it is going to be confusing for users\n-    // to say we couldn't find something that exists. We should report that we couldn't read it.\n-    assertThat(loader.load(tempDir.toAbsolutePath().toString())).isNotEmpty();", "originalCommit": "5a4220fe3796828c3ba8952047be5b54d5623170", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ab9a929adf4e38b66c751031110eb8e7f70ed31c", "chunk": "diff --git a/infrastructure/io/src/test/java/tech/pegasys/teku/infrastructure/io/resource/FileResourceLoaderTest.java b/infrastructure/io/src/test/java/tech/pegasys/teku/infrastructure/io/resource/FileResourceLoaderTest.java\nindex fbded0d3ca..f88969b5fd 100644\n--- a/infrastructure/io/src/test/java/tech/pegasys/teku/infrastructure/io/resource/FileResourceLoaderTest.java\n+++ b/infrastructure/io/src/test/java/tech/pegasys/teku/infrastructure/io/resource/FileResourceLoaderTest.java\n\n@@ -44,6 +46,24 @@ class FileResourceLoaderTest {\n \n   @Test\n   public void shouldThrowWhenPathIsADirectory(@TempDir Path tempDir) throws Exception {\n+\n+    // should throw either on opening InputStream from directory or reading from created InputStream\n+    assertThatThrownBy(\n+            () -> {\n+              Optional<InputStream> inputStream = loader.load(tempDir.toAbsolutePath().toString());\n+\n+              // if load() call didn't cause exception then InputStream should exist\n+              // We could potentially return empty for directories, but it is going to be confusing\n+              // for users\n+              // to say we couldn't find something that exists. We should report that we couldn't\n+              // read it.\n+              assertThat(inputStream).isNotEmpty();\n+\n+              // At least the read() call should throw\n+              inputStream.get().read();\n+            })\n+        .isInstanceOf(IOException.class);\n+\n     assertThatThrownBy(() -> loader.loadBytes(tempDir.toAbsolutePath().toString()))\n         .isInstanceOf(IOException.class);\n   }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTEyNTgzMg==", "url": "https://github.com/ConsenSys/teku/pull/3188#discussion_r521125832", "bodyText": "I think its probably better to continue just using the gossipEncoding passed in here - especially since it's still being passed into the constructor anyway.", "author": "ajsutton", "createdAt": "2020-11-11T05:44:41Z", "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/ActiveEth2Network.java", "diffHunk": "@@ -107,7 +106,6 @@ public ActiveEth2Network(\n     this.peerManager = peerManager;\n     this.eventBus = eventBus;\n     this.recentChainData = recentChainData;\n-    this.gossipEncoding = gossipEncoding;", "originalCommit": "5a4220fe3796828c3ba8952047be5b54d5623170", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTI2ODUyMQ==", "url": "https://github.com/ConsenSys/teku/pull/3188#discussion_r521268521", "bodyText": "Yep, totally makes sense with the final PR version (this was done for the previous PR incarnation)", "author": "Nashatyrev", "createdAt": "2020-11-11T10:41:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTEyNTgzMg=="}], "type": "inlineReview", "revised_code": {"commit": "3ea0b883de8176de7f380a477eefff77cb1eb7fa", "chunk": "diff --git a/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/ActiveEth2Network.java b/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/ActiveEth2Network.java\nindex 6ae91d22ae..542684fc75 100644\n--- a/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/ActiveEth2Network.java\n+++ b/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/ActiveEth2Network.java\n\n@@ -106,6 +107,7 @@ public class ActiveEth2Network extends DelegatingP2PNetwork<Eth2Peer> implements\n     this.peerManager = peerManager;\n     this.eventBus = eventBus;\n     this.recentChainData = recentChainData;\n+    this.gossipEncoding = gossipEncoding;\n     this.attestationSubnetService = attestationSubnetService;\n     this.blockProcessor = blockProcessor;\n     this.attestationProcessor = attestationProcessor;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTEyNjE1Mw==", "url": "https://github.com/ConsenSys/teku/pull/3188#discussion_r521126153", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               * Preprocess the raw Gossip message. The returned preprocessed message is be passed later to\n          \n          \n            \n               * Preprocess the raw Gossip message. The returned preprocessed message will be later passed to", "author": "ajsutton", "createdAt": "2020-11-11T05:45:44Z", "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/gossip/encoding/GossipEncoding.java", "diffHunk": "@@ -36,10 +36,34 @@\n   <T> Bytes encode(T value);\n \n   /**\n+   * Preprocess the raw Gossip message. The returned preprocessed message is be passed later to", "originalCommit": "5a4220fe3796828c3ba8952047be5b54d5623170", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b34e65596e59e3dcfa9742ec025eaeb6c8490866", "chunk": "diff --git a/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/gossip/encoding/GossipEncoding.java b/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/gossip/encoding/GossipEncoding.java\nindex d42d5d3824..ed58802e0f 100644\n--- a/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/gossip/encoding/GossipEncoding.java\n+++ b/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/gossip/encoding/GossipEncoding.java\n\n@@ -36,7 +36,7 @@ public interface GossipEncoding {\n   <T> Bytes encode(T value);\n \n   /**\n-   * Preprocess the raw Gossip message. The returned preprocessed message is be passed later to\n+   * Preprocess the raw Gossip message. The returned preprocessed message will be later passed to\n    * {@link #decodeMessage(PreparedGossipMessage, Class)}\n    *\n    * <p>If there is a problem while preprocessing a message the error should be memorized and later\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTEyNjcwMA==", "url": "https://github.com/ConsenSys/teku/pull/3188#discussion_r521126700", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                Optional<Bytes> maybeUncompressed = getMaybeUncompressed();\n          \n          \n            \n                if (maybeUncompressed.isPresent()) {\n          \n          \n            \n                  return maybeUncompressed.get();\n          \n          \n            \n                } else {\n          \n          \n            \n                  throw new DecodingException(\"Couldn't uncompress the message\", uncompressException);\n          \n          \n            \n                }\n          \n          \n            \n                return getMaybeUncompressed().orElseThrow(() -> new DecodingException(\"Couldn't uncompress the message\", uncompressException));", "author": "ajsutton", "createdAt": "2020-11-11T05:47:50Z", "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/gossip/encoding/SnappyPreparedGossipMessage.java", "diffHunk": "@@ -0,0 +1,104 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.networking.eth2.gossip.encoding;\n+\n+import com.google.common.base.Supplier;\n+import com.google.common.base.Suppliers;\n+import java.util.Optional;\n+import org.apache.tuweni.bytes.Bytes;\n+import org.apache.tuweni.crypto.Hash;\n+import tech.pegasys.teku.datastructures.util.LengthBounds;\n+import tech.pegasys.teku.datastructures.util.SimpleOffsetSerializer;\n+import tech.pegasys.teku.networking.p2p.gossip.PreparedGossipMessage;\n+\n+/**\n+ * {@link PreparedGossipMessage} implementation which calculates Gossip 'message-id' according to\n+ * Eth2 spec based on uncompressed gossip message payload: <code>\n+ *   SHA256(MESSAGE_DOMAIN_VALID_SNAPPY + snappy_decompress(message.data))[:20]\n+ * </code> The message payload is uncompressed lazily and cached for the final message handling:\n+ * {@link tech.pegasys.teku.networking.p2p.gossip.TopicHandler#handleMessage(PreparedGossipMessage)}\n+ */\n+class SnappyPreparedGossipMessage implements PreparedGossipMessage {\n+  // 4-byte domain for gossip message-id isolation of *invalid* snappy messages\n+  public static final Bytes MESSAGE_DOMAIN_INVALID_SNAPPY = Bytes.fromHexString(\"0x00000000\");\n+  // 4-byte domain for gossip message-id isolation of *valid* snappy messages\n+  public static final Bytes MESSAGE_DOMAIN_VALID_SNAPPY = Bytes.fromHexString(\"0x01000000\");\n+\n+  private final Bytes compressedData;\n+  private final Class<?> valueType;\n+  private final SnappyBlockCompressor snappyCompressor;\n+  private final Supplier<Optional<Bytes>> uncompressed =\n+      Suppliers.memoize(this::maybeUncompressPayload);\n+  private DecodingException uncompressException;\n+\n+  static SnappyPreparedGossipMessage createUnknown(Bytes compressedData) {\n+    return new SnappyPreparedGossipMessage(compressedData, null, null);\n+  }\n+\n+  static SnappyPreparedGossipMessage create(\n+      Bytes compressedData, Class<?> valueType, SnappyBlockCompressor snappyCompressor) {\n+    return new SnappyPreparedGossipMessage(compressedData, valueType, snappyCompressor);\n+  }\n+\n+  private SnappyPreparedGossipMessage(\n+      Bytes compressedData, Class<?> valueType, SnappyBlockCompressor snappyCompressor) {\n+    this.compressedData = compressedData;\n+    this.valueType = valueType;\n+    this.snappyCompressor = snappyCompressor;\n+  }\n+\n+  public Bytes getUncompressedOrThrow() throws DecodingException {\n+    Optional<Bytes> maybeUncompressed = getMaybeUncompressed();\n+    if (maybeUncompressed.isPresent()) {\n+      return maybeUncompressed.get();\n+    } else {\n+      throw new DecodingException(\"Couldn't uncompress the message\", uncompressException);\n+    }", "originalCommit": "5a4220fe3796828c3ba8952047be5b54d5623170", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ece2a92ad7d11402ae0606523e563fe8ec03afba", "chunk": "diff --git a/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/gossip/encoding/SnappyPreparedGossipMessage.java b/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/gossip/encoding/SnappyPreparedGossipMessage.java\nindex 16d886b1ab..7134dd1d3c 100644\n--- a/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/gossip/encoding/SnappyPreparedGossipMessage.java\n+++ b/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/gossip/encoding/SnappyPreparedGossipMessage.java\n\n@@ -59,12 +59,7 @@ class SnappyPreparedGossipMessage implements PreparedGossipMessage {\n   }\n \n   public Bytes getUncompressedOrThrow() throws DecodingException {\n-    Optional<Bytes> maybeUncompressed = getMaybeUncompressed();\n-    if (maybeUncompressed.isPresent()) {\n-      return maybeUncompressed.get();\n-    } else {\n-      throw new DecodingException(\"Couldn't uncompress the message\", uncompressException);\n-    }\n+    return getMaybeUncompressed().orElseThrow(() -> new DecodingException(\"Couldn't uncompress the message\", uncompressException));\n   }\n \n   public Optional<Bytes> getMaybeUncompressed() {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTEyODgyOA==", "url": "https://github.com/ConsenSys/teku/pull/3188#discussion_r521128828", "bodyText": "Good idea to move this init out of LibP2pNetwork but might be better to introduce a static create method rather than doing all the work in the constructor.", "author": "ajsutton", "createdAt": "2020-11-11T05:55:14Z", "path": "networking/p2p/src/main/java/tech/pegasys/teku/networking/p2p/libp2p/gossip/LibP2PGossipNetwork.java", "diffHunk": "@@ -13,39 +13,70 @@\n \n package tech.pegasys.teku.networking.p2p.libp2p.gossip;\n \n+import com.google.common.base.Preconditions;\n import io.libp2p.core.PeerId;\n+import io.libp2p.core.pubsub.PubsubApi;\n+import io.libp2p.core.pubsub.PubsubApiKt;\n import io.libp2p.core.pubsub.PubsubPublisherApi;\n import io.libp2p.core.pubsub.PubsubSubscription;\n import io.libp2p.core.pubsub.Topic;\n+import io.libp2p.core.pubsub.ValidationResult;\n+import io.libp2p.pubsub.FastIdSeenCache;\n+import io.libp2p.pubsub.PubsubRouterMessageValidator;\n+import io.libp2p.pubsub.SeenCache;\n+import io.libp2p.pubsub.TTLSeenCache;\n import io.libp2p.pubsub.gossip.Gossip;\n+import io.libp2p.pubsub.gossip.GossipParams;\n+import io.libp2p.pubsub.gossip.GossipRouter;\n import io.netty.buffer.Unpooled;\n+import io.netty.channel.ChannelHandler;\n+import io.netty.handler.logging.LogLevel;\n+import io.netty.handler.logging.LoggingHandler;\n import java.util.Collection;\n import java.util.HashMap;\n import java.util.HashSet;\n import java.util.Map;\n+import java.util.Optional;\n import java.util.Set;\n+import java.util.concurrent.ConcurrentHashMap;\n+import kotlin.jvm.functions.Function0;\n import org.apache.logging.log4j.LogManager;\n import org.apache.logging.log4j.Logger;\n import org.apache.tuweni.bytes.Bytes;\n import org.hyperledger.besu.plugin.services.MetricsSystem;\n+import org.jetbrains.annotations.NotNull;\n import tech.pegasys.teku.infrastructure.async.SafeFuture;\n+import tech.pegasys.teku.networking.p2p.gossip.GossipNetwork;\n+import tech.pegasys.teku.networking.p2p.gossip.PreparedGossipMessage;\n+import tech.pegasys.teku.networking.p2p.gossip.PreparedGossipMessageFactory;\n import tech.pegasys.teku.networking.p2p.gossip.TopicChannel;\n import tech.pegasys.teku.networking.p2p.gossip.TopicHandler;\n import tech.pegasys.teku.networking.p2p.libp2p.LibP2PNodeId;\n+import tech.pegasys.teku.networking.p2p.network.GossipConfig;\n import tech.pegasys.teku.networking.p2p.peer.NodeId;\n \n-public class LibP2PGossipNetwork implements tech.pegasys.teku.networking.p2p.gossip.GossipNetwork {\n+public class LibP2PGossipNetwork implements GossipNetwork {\n+\n   private static final Logger LOG = LogManager.getLogger();\n+  private static final PubsubRouterMessageValidator STRICT_FIELDS_VALIDATOR =\n+      new GossipWireValidator();\n+  private static final Function0<Long> NULL_SEQNO_GENERATOR = () -> null;\n \n   private final MetricsSystem metricsSystem;\n   private final Gossip gossip;\n   private final PubsubPublisherApi publisher;\n+  private final Map<String, TopicHandler> topicHandlerMap = new ConcurrentHashMap<>();\n+  private final PreparedGossipMessageFactory defaultMessageFactory;\n \n   public LibP2PGossipNetwork(\n-      final MetricsSystem metricsSystem, final Gossip gossip, final PubsubPublisherApi publisher) {\n+      MetricsSystem metricsSystem,\n+      GossipConfig gossipConfig,\n+      PreparedGossipMessageFactory defaultMessageFactory,\n+      boolean logWireGossip) {\n     this.metricsSystem = metricsSystem;\n-    this.gossip = gossip;\n-    this.publisher = publisher;\n+    this.defaultMessageFactory = defaultMessageFactory;\n+    this.gossip = createGossip(gossipConfig, logWireGossip);\n+    this.publisher = gossip.createPublisher(null, NULL_SEQNO_GENERATOR);", "originalCommit": "5a4220fe3796828c3ba8952047be5b54d5623170", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTI3NjI2OQ==", "url": "https://github.com/ConsenSys/teku/pull/3188#discussion_r521276269", "bodyText": "Please check this change: fa656bb. Is that what you have in mind?", "author": "Nashatyrev", "createdAt": "2020-11-11T10:55:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTEyODgyOA=="}], "type": "inlineReview", "revised_code": {"commit": "fa656bbbe2b2abc45fd28861845c279530fd53e3", "chunk": "diff --git a/networking/p2p/src/main/java/tech/pegasys/teku/networking/p2p/libp2p/gossip/LibP2PGossipNetwork.java b/networking/p2p/src/main/java/tech/pegasys/teku/networking/p2p/libp2p/gossip/LibP2PGossipNetwork.java\nindex 6d4ab35655..84f9d2f1f9 100644\n--- a/networking/p2p/src/main/java/tech/pegasys/teku/networking/p2p/libp2p/gossip/LibP2PGossipNetwork.java\n+++ b/networking/p2p/src/main/java/tech/pegasys/teku/networking/p2p/libp2p/gossip/LibP2PGossipNetwork.java\n\n@@ -63,18 +63,30 @@ public class LibP2PGossipNetwork implements GossipNetwork {\n   private static final Function0<Long> NULL_SEQNO_GENERATOR = () -> null;\n \n   private final MetricsSystem metricsSystem;\n-  private final Gossip gossip;\n-  private final PubsubPublisherApi publisher;\n+  private Gossip gossip;\n+  private PubsubPublisherApi publisher;\n   private final Map<String, TopicHandler> topicHandlerMap = new ConcurrentHashMap<>();\n   private final PreparedGossipMessageFactory defaultMessageFactory;\n \n-  public LibP2PGossipNetwork(\n+  public static LibP2PGossipNetwork create(\n       MetricsSystem metricsSystem,\n       GossipConfig gossipConfig,\n       PreparedGossipMessageFactory defaultMessageFactory,\n       boolean logWireGossip) {\n+\n+    LibP2PGossipNetwork gossipNetwork =\n+        new LibP2PGossipNetwork(metricsSystem, defaultMessageFactory);\n+    gossipNetwork.initGossip(gossipConfig, logWireGossip);\n+    return gossipNetwork;\n+  }\n+\n+  private LibP2PGossipNetwork(\n+      MetricsSystem metricsSystem, PreparedGossipMessageFactory defaultMessageFactory) {\n     this.metricsSystem = metricsSystem;\n     this.defaultMessageFactory = defaultMessageFactory;\n+  }\n+\n+  private void initGossip(GossipConfig gossipConfig, boolean logWireGossip) {\n     this.gossip = createGossip(gossipConfig, logWireGossip);\n     this.publisher = gossip.createPublisher(null, NULL_SEQNO_GENERATOR);\n   }\n"}}, {"oid": "b34e65596e59e3dcfa9742ec025eaeb6c8490866", "url": "https://github.com/ConsenSys/teku/commit/b34e65596e59e3dcfa9742ec025eaeb6c8490866", "message": "Fix javadoc wording\n\nCo-authored-by: Adrian Sutton <adrian.sutton@consensys.net>", "committedDate": "2020-11-11T08:16:33Z", "type": "commit"}, {"oid": "ece2a92ad7d11402ae0606523e563fe8ec03afba", "url": "https://github.com/ConsenSys/teku/commit/ece2a92ad7d11402ae0606523e563fe8ec03afba", "message": "Use Optional functional methods\n\nCo-authored-by: Adrian Sutton <adrian.sutton@consensys.net>", "committedDate": "2020-11-11T08:17:21Z", "type": "commit"}, {"oid": "b261e9c70443a2cc11720cefdd2991ab35e8abc6", "url": "https://github.com/ConsenSys/teku/commit/b261e9c70443a2cc11720cefdd2991ab35e8abc6", "message": "Merge remote-tracking branch 'origin/master' into feature/uncompressed-message-id", "committedDate": "2020-11-11T08:20:31Z", "type": "commit"}, {"oid": "ab9a929adf4e38b66c751031110eb8e7f70ed31c", "url": "https://github.com/ConsenSys/teku/commit/ab9a929adf4e38b66c751031110eb8e7f70ed31c", "message": "Merge remote-tracking branch 'origin/master' into feature/uncompressed-message-id\n\n# Conflicts:\n#\tinfrastructure/io/src/test/java/tech/pegasys/teku/infrastructure/io/resource/FileResourceLoaderTest.java", "committedDate": "2020-11-11T08:22:43Z", "type": "commit"}, {"oid": "fa656bbbe2b2abc45fd28861845c279530fd53e3", "url": "https://github.com/ConsenSys/teku/commit/fa656bbbe2b2abc45fd28861845c279530fd53e3", "message": "Add static LibP2PGossipNetwork.create() method", "committedDate": "2020-11-11T09:35:55Z", "type": "commit"}, {"oid": "188dd6337784f34e614b73c44e7012a39164e7db", "url": "https://github.com/ConsenSys/teku/commit/188dd6337784f34e614b73c44e7012a39164e7db", "message": "Spotless", "committedDate": "2020-11-11T09:37:45Z", "type": "commit"}, {"oid": "3ea0b883de8176de7f380a477eefff77cb1eb7fa", "url": "https://github.com/ConsenSys/teku/commit/3ea0b883de8176de7f380a477eefff77cb1eb7fa", "message": "Return back parametrized GossipEncoding to ActiveEth2Network", "committedDate": "2020-11-11T10:03:34Z", "type": "commit"}, {"oid": "0a9d838771351de43728e5b473200d19d11ad9cd", "url": "https://github.com/ConsenSys/teku/commit/0a9d838771351de43728e5b473200d19d11ad9cd", "message": "Fix messageIdCalculation", "committedDate": "2020-11-11T13:49:26Z", "type": "commit"}, {"oid": "5647d7fc2be150874ef60d2482bea5c0d5702597", "url": "https://github.com/ConsenSys/teku/commit/5647d7fc2be150874ef60d2482bea5c0d5702597", "message": "Merge branch 'master' into feature/uncompressed-message-id", "committedDate": "2020-11-12T10:31:59Z", "type": "commit"}, {"oid": "6689f115162972a2b530ffcc624f2335d5a7917d", "url": "https://github.com/ConsenSys/teku/commit/6689f115162972a2b530ffcc624f2335d5a7917d", "message": "Decouple Gossip and LibP2PGossipNetwork construction", "committedDate": "2020-11-12T14:15:38Z", "type": "commit"}, {"oid": "0c69fc752d2c6d70cfb7fe8fd7f41dee81f93562", "url": "https://github.com/ConsenSys/teku/commit/0c69fc752d2c6d70cfb7fe8fd7f41dee81f93562", "message": "Merge remote-tracking branch 'origin/feature/uncompressed-message-id' into feature/uncompressed-message-id", "committedDate": "2020-11-12T14:15:49Z", "type": "commit"}, {"oid": "5528f50626b9521689cf01195d0638bfd9d5665c", "url": "https://github.com/ConsenSys/teku/commit/5528f50626b9521689cf01195d0638bfd9d5665c", "message": "Merge branch 'master' into feature/uncompressed-message-id", "committedDate": "2020-11-12T20:18:22Z", "type": "commit"}, {"oid": "9adb9ca8036119113b99e8b3cf163c0c650ebea3", "url": "https://github.com/ConsenSys/teku/commit/9adb9ca8036119113b99e8b3cf163c0c650ebea3", "message": "Merge branch 'master' into feature/uncompressed-message-id", "committedDate": "2020-11-13T11:08:22Z", "type": "commit"}]}