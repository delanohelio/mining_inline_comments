{"pr_number": 2514, "pr_title": "Added attestation pool size tracking", "pr_createdAt": "2020-08-05T21:11:27Z", "pr_url": "https://github.com/ConsenSys/teku/pull/2514", "timeline": [{"oid": "fd0228ad56b563b61faaeb7f2b3cb58070a29b00", "url": "https://github.com/ConsenSys/teku/commit/fd0228ad56b563b61faaeb7f2b3cb58070a29b00", "message": "Added attestation pool size tracking", "committedDate": "2020-08-05T21:08:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA2OTA0NA==", "url": "https://github.com/ConsenSys/teku/pull/2514#discussion_r466069044", "bodyText": "The attestation winds up being added to a set so it deduplicates - we'd need to have the add call return a flag to indicate if the attestation was actually added or not.", "author": "ajsutton", "createdAt": "2020-08-06T00:01:04Z", "path": "ethereum/statetransition/src/main/java/tech/pegasys/teku/statetransition/attestation/AggregatingAttestationPool.java", "diffHunk": "@@ -59,6 +62,7 @@ public AggregatingAttestationPool(\n   public synchronized void add(final ValidateableAttestation attestation) {\n     final AttestationData attestationData = attestation.getAttestation().getData();\n     final Bytes32 dataRoot = attestationData.hash_tree_root();\n+    size.getAndIncrement();\n     attestationGroupByDataHash\n         .computeIfAbsent(dataRoot, key -> new MatchingDataAttestationGroup(attestationData))\n         .add(attestation);", "originalCommit": "fd0228ad56b563b61faaeb7f2b3cb58070a29b00", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8d5258415cc3cb2db1db7027124a4f39429675da", "chunk": "diff --git a/ethereum/statetransition/src/main/java/tech/pegasys/teku/statetransition/attestation/AggregatingAttestationPool.java b/ethereum/statetransition/src/main/java/tech/pegasys/teku/statetransition/attestation/AggregatingAttestationPool.java\nindex 254354e1e..19b0e2300 100644\n--- a/ethereum/statetransition/src/main/java/tech/pegasys/teku/statetransition/attestation/AggregatingAttestationPool.java\n+++ b/ethereum/statetransition/src/main/java/tech/pegasys/teku/statetransition/attestation/AggregatingAttestationPool.java\n\n@@ -62,11 +61,13 @@ public class AggregatingAttestationPool implements SlotEventsChannel {\n   public synchronized void add(final ValidateableAttestation attestation) {\n     final AttestationData attestationData = attestation.getAttestation().getData();\n     final Bytes32 dataRoot = attestationData.hash_tree_root();\n-    size.getAndIncrement();\n-    attestationGroupByDataHash\n-        .computeIfAbsent(dataRoot, key -> new MatchingDataAttestationGroup(attestationData))\n-        .add(attestation);\n-\n+    final boolean add =\n+        attestationGroupByDataHash\n+            .computeIfAbsent(dataRoot, key -> new MatchingDataAttestationGroup(attestationData))\n+            .add(attestation);\n+    if (add) {\n+      size.incrementAndGet();\n+    }\n     dataHashBySlot\n         .computeIfAbsent(attestationData.getSlot(), slot -> new HashSet<>())\n         .add(dataRoot);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA2OTA3Mw==", "url": "https://github.com/ConsenSys/teku/pull/2514#discussion_r466069073", "bodyText": "Discussed offline but this will need to be a little smarter - attestations.remove will need to return the number of attestations it actually removed because it intelligently handles aggregates.\nSo if I remove an aggregate that includes validators 1,2,3,4,5 it will remove any single attestations for the same data from those validators or any combination thereof.  But it won\u2019t remove an aggregate with 1,2,3,4,5,6 because 6 is still new info.", "author": "ajsutton", "createdAt": "2020-08-06T00:01:10Z", "path": "ethereum/statetransition/src/main/java/tech/pegasys/teku/statetransition/attestation/AggregatingAttestationPool.java", "diffHunk": "@@ -90,6 +94,7 @@ public synchronized void remove(final Attestation attestation) {\n       return;\n     }\n     attestations.remove(attestation);\n+    size.decrementAndGet();", "originalCommit": "fd0228ad56b563b61faaeb7f2b3cb58070a29b00", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njk4NDI0Mw==", "url": "https://github.com/ConsenSys/teku/pull/2514#discussion_r466984243", "bodyText": "I've pushed up the changes which should address this as discussed.  I'm not confident that this is quite right yet, and need to write a couple more tests and talk through this.", "author": "rojotek", "createdAt": "2020-08-07T11:34:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA2OTA3Mw=="}], "type": "inlineReview", "revised_code": {"commit": "8d5258415cc3cb2db1db7027124a4f39429675da", "chunk": "diff --git a/ethereum/statetransition/src/main/java/tech/pegasys/teku/statetransition/attestation/AggregatingAttestationPool.java b/ethereum/statetransition/src/main/java/tech/pegasys/teku/statetransition/attestation/AggregatingAttestationPool.java\nindex 254354e1e..19b0e2300 100644\n--- a/ethereum/statetransition/src/main/java/tech/pegasys/teku/statetransition/attestation/AggregatingAttestationPool.java\n+++ b/ethereum/statetransition/src/main/java/tech/pegasys/teku/statetransition/attestation/AggregatingAttestationPool.java\n\n@@ -93,8 +94,8 @@ public class AggregatingAttestationPool implements SlotEventsChannel {\n     if (attestations == null) {\n       return;\n     }\n-    attestations.remove(attestation);\n-    size.decrementAndGet();\n+    final int numRemoved = attestations.remove(attestation);\n+    size.addAndGet(-numRemoved);\n     if (attestations.isEmpty()) {\n       attestationGroupByDataHash.remove(dataRoot);\n       removeFromSlotMappings(attestationData.getSlot(), dataRoot);\n"}}, {"oid": "8d5258415cc3cb2db1db7027124a4f39429675da", "url": "https://github.com/ConsenSys/teku/commit/8d5258415cc3cb2db1db7027124a4f39429675da", "message": "Ensured that the size is tracked properly, and added in API for viewing the same.", "committedDate": "2020-08-07T11:33:19Z", "type": "commit"}, {"oid": "8d5258415cc3cb2db1db7027124a4f39429675da", "url": "https://github.com/ConsenSys/teku/commit/8d5258415cc3cb2db1db7027124a4f39429675da", "message": "Ensured that the size is tracked properly, and added in API for viewing the same.", "committedDate": "2020-08-07T11:33:19Z", "type": "forcePushed"}, {"oid": "c497ec1116a049421553fa19a4d7221f52d0753c", "url": "https://github.com/ConsenSys/teku/commit/c497ec1116a049421553fa19a4d7221f52d0753c", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into pending-attestation-count", "committedDate": "2020-08-10T01:49:24Z", "type": "commit"}, {"oid": "d67a9008c63b8182ca50c3119a770df25e9a47b8", "url": "https://github.com/ConsenSys/teku/commit/d67a9008c63b8182ca50c3119a770df25e9a47b8", "message": "Added test around removing across attestation groups, and updated code to ensure it passes.", "committedDate": "2020-08-11T02:44:34Z", "type": "commit"}, {"oid": "6345e0703a6f1be6e49308366b034befa9504dfd", "url": "https://github.com/ConsenSys/teku/commit/6345e0703a6f1be6e49308366b034befa9504dfd", "message": "Merge branch 'master' into pending-attestation-count", "committedDate": "2020-08-11T02:48:33Z", "type": "commit"}, {"oid": "51e7dc8a2eb909162408f8386dfac6182eea3e1b", "url": "https://github.com/ConsenSys/teku/commit/51e7dc8a2eb909162408f8386dfac6182eea3e1b", "message": "Made test match correct code.", "committedDate": "2020-08-11T10:16:26Z", "type": "commit"}, {"oid": "62d75521495e479661e9893efd1d5d20a4b3a800", "url": "https://github.com/ConsenSys/teku/commit/62d75521495e479661e9893efd1d5d20a4b3a800", "message": "Merge branch 'master' into pending-attestation-count", "committedDate": "2020-08-11T10:20:31Z", "type": "commit"}]}