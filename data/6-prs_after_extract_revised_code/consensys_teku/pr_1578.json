{"pr_number": 1578, "pr_title": "[1356] API -> Internal converters required for validator API.", "pr_createdAt": "2020-04-14T00:33:48Z", "pr_url": "https://github.com/ConsenSys/teku/pull/1578", "timeline": [{"oid": "1b8c6b08a6b4be300aa6c3d623979f20fafac092", "url": "https://github.com/ConsenSys/teku/commit/1b8c6b08a6b4be300aa6c3d623979f20fafac092", "message": "[1356] API -> Internal converters required for validator API.", "committedDate": "2020-04-14T00:29:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzc5OTkzMg==", "url": "https://github.com/ConsenSys/teku/pull/1578#discussion_r407799932", "bodyText": "we could potentially use the defined constants when creating a SSZList since at this point we can identify which one is appropriate\nConstants.MAX_VALIDATORS_PER_COMMITTEE appears to be the best max size in this case. not sure if @ajsutton has a preference re. using the current size, or the defined constants.", "author": "rolfyone", "createdAt": "2020-04-14T00:43:50Z", "path": "data/provider/src/main/java/tech/pegasys/artemis/api/schema/IndexedAttestation.java", "diffHunk": "@@ -29,4 +30,12 @@ public IndexedAttestation(\n     this.data = new AttestationData(indexedAttestation.getData());\n     this.signature = new BLSSignature(indexedAttestation.getSignature());\n   }\n+\n+  public tech.pegasys.artemis.datastructures.operations.IndexedAttestation\n+      asInternalIndexedAttestation() {\n+    return new tech.pegasys.artemis.datastructures.operations.IndexedAttestation(\n+        SSZList.createMutable(attesting_indices, attesting_indices.size(), UnsignedLong.class),", "originalCommit": "1b8c6b08a6b4be300aa6c3d623979f20fafac092", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzgwMzIyNA==", "url": "https://github.com/ConsenSys/teku/pull/1578#discussion_r407803224", "bodyText": "The only function that max size provides is to specify an upper bound on the size of list you have to read in - thus preventing DOS attacks where you get sent stupidly large data.\nSo the ideal case is to use the correct max size per the spec and enforce that when reading the data.  We'll need to do that kind of protection if we ever intend to be able to make these APIs available publicly.\nBut otherwise it doesn't really matter.  It's probably safer to use the spec defined max size whenever possible in case some function downstream needs to add to the list (e.g. if we deserialise a state and then process slots it might add a new validator as part of epoch processing).  If you use current size in that case the operation will fail because the max size will be exceeded.", "author": "ajsutton", "createdAt": "2020-04-14T00:55:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzc5OTkzMg=="}], "type": "inlineReview", "revised_code": {"commit": "100b21b4020389bab1a5a72332f9595329b5eb0a", "chunk": "diff --git a/data/provider/src/main/java/tech/pegasys/artemis/api/schema/IndexedAttestation.java b/data/provider/src/main/java/tech/pegasys/artemis/api/schema/IndexedAttestation.java\nindex 3e956e73c8..59c4feee60 100644\n--- a/data/provider/src/main/java/tech/pegasys/artemis/api/schema/IndexedAttestation.java\n+++ b/data/provider/src/main/java/tech/pegasys/artemis/api/schema/IndexedAttestation.java\n\n@@ -34,7 +36,7 @@ public class IndexedAttestation {\n   public tech.pegasys.artemis.datastructures.operations.IndexedAttestation\n       asInternalIndexedAttestation() {\n     return new tech.pegasys.artemis.datastructures.operations.IndexedAttestation(\n-        SSZList.createMutable(attesting_indices, attesting_indices.size(), UnsignedLong.class),\n+        SSZList.createMutable(attesting_indices, MAX_VALIDATORS_PER_COMMITTEE, UnsignedLong.class),\n         data.asInternalAttestationData(),\n         signature.asInternalBLSSignature());\n   }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzgwMTI1OQ==", "url": "https://github.com/ConsenSys/teku/pull/1578#discussion_r407801259", "bodyText": "If we decide to use constants, blocks/BeaconBlockBody has all the constants in line comments with each list.", "author": "rolfyone", "createdAt": "2020-04-14T00:48:31Z", "path": "data/provider/src/main/java/tech/pegasys/artemis/api/schema/BeaconBlockBody.java", "diffHunk": "@@ -69,4 +70,32 @@ public BeaconBlockBody(tech.pegasys.artemis.datastructures.blocks.BeaconBlockBod\n             .map(SignedVoluntaryExit::new)\n             .collect(Collectors.toList());\n   }\n+\n+  public tech.pegasys.artemis.datastructures.blocks.BeaconBlockBody asInternalBeaconBlockBody() {\n+    return new tech.pegasys.artemis.datastructures.blocks.BeaconBlockBody(\n+        randao_reveal.asInternalBLSSignature(),\n+        new tech.pegasys.artemis.datastructures.blocks.Eth1Data(\n+            eth1_data.deposit_root, eth1_data.deposit_count, eth1_data.block_hash),\n+        graffiti,\n+        SSZList.createMutable(\n+            proposer_slashings.stream().map(ProposerSlashing::asInternalProposerSlashing),\n+            proposer_slashings.size(),", "originalCommit": "1b8c6b08a6b4be300aa6c3d623979f20fafac092", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "100b21b4020389bab1a5a72332f9595329b5eb0a", "chunk": "diff --git a/data/provider/src/main/java/tech/pegasys/artemis/api/schema/BeaconBlockBody.java b/data/provider/src/main/java/tech/pegasys/artemis/api/schema/BeaconBlockBody.java\nindex f0eb8297b2..a58a6ab48b 100644\n--- a/data/provider/src/main/java/tech/pegasys/artemis/api/schema/BeaconBlockBody.java\n+++ b/data/provider/src/main/java/tech/pegasys/artemis/api/schema/BeaconBlockBody.java\n\n@@ -79,23 +85,23 @@ public class BeaconBlockBody {\n         graffiti,\n         SSZList.createMutable(\n             proposer_slashings.stream().map(ProposerSlashing::asInternalProposerSlashing),\n-            proposer_slashings.size(),\n+            MAX_PROPOSER_SLASHINGS,\n             tech.pegasys.artemis.datastructures.operations.ProposerSlashing.class),\n         SSZList.createMutable(\n             attester_slashings.stream().map(AttesterSlashing::asInternalAttesterSlashing),\n-            attester_slashings.size(),\n+            MAX_ATTESTER_SLASHINGS,\n             tech.pegasys.artemis.datastructures.operations.AttesterSlashing.class),\n         SSZList.createMutable(\n             attestations.stream().map(Attestation::asInternalAttestation),\n-            attestations.size(),\n+            MAX_ATTESTATIONS,\n             tech.pegasys.artemis.datastructures.operations.Attestation.class),\n         SSZList.createMutable(\n             deposits.stream().map(Deposit::asInternalDeposit),\n-            deposits.size(),\n+            MAX_DEPOSITS,\n             tech.pegasys.artemis.datastructures.operations.Deposit.class),\n         SSZList.createMutable(\n             voluntary_exits.stream().map(SignedVoluntaryExit::asInternalSignedVoluntaryExit),\n-            voluntary_exits.size(),\n+            MAX_VOLUNTARY_EXITS,\n             tech.pegasys.artemis.datastructures.operations.SignedVoluntaryExit.class));\n   }\n }\n"}}, {"oid": "100b21b4020389bab1a5a72332f9595329b5eb0a", "url": "https://github.com/ConsenSys/teku/commit/100b21b4020389bab1a5a72332f9595329b5eb0a", "message": "[1356] Replaced .size() with constants where appropriate.", "committedDate": "2020-04-14T02:12:26Z", "type": "commit"}, {"oid": "c9d3eff9c34e5289e2022880823c48f972737e55", "url": "https://github.com/ConsenSys/teku/commit/c9d3eff9c34e5289e2022880823c48f972737e55", "message": "Merge branch 'master' into 1356-WIP-1", "committedDate": "2020-04-14T03:47:06Z", "type": "commit"}]}