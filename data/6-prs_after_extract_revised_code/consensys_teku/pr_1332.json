{"pr_number": 1332, "pr_title": "[BC-291] Complete rpc stream future on peer disconnect", "pr_createdAt": "2020-03-09T21:00:22Z", "pr_url": "https://github.com/ConsenSys/teku/pull/1332", "timeline": [{"oid": "c934246b5696296c1faef32aa8688203759bbe2c", "url": "https://github.com/ConsenSys/teku/commit/c934246b5696296c1faef32aa8688203759bbe2c", "message": "Add timeout and disconnenct handling to RpcHandler", "committedDate": "2020-03-09T20:35:41Z", "type": "commit"}, {"oid": "d6692c1a671c5dc87966346e1132fa4b63a05183", "url": "https://github.com/ConsenSys/teku/commit/d6692c1a671c5dc87966346e1132fa4b63a05183", "message": "Add integration tests that query a disconnected peer", "committedDate": "2020-03-09T20:39:39Z", "type": "commit"}, {"oid": "a6baef004f07835e4adc94425b51aa08d8e2f147", "url": "https://github.com/ConsenSys/teku/commit/a6baef004f07835e4adc94425b51aa08d8e2f147", "message": "Cleanup - cut unused code, name exceptions consistently", "committedDate": "2020-03-09T20:48:57Z", "type": "commit"}, {"oid": "4b21b7361e1cf68672b718fee2658090ebb35f25", "url": "https://github.com/ConsenSys/teku/commit/4b21b7361e1cf68672b718fee2658090ebb35f25", "message": "Cut untested changes", "committedDate": "2020-03-09T20:55:46Z", "type": "commit"}, {"oid": "f9c7a52a944a8c8c53be8c76da9d9bcf6d0904bf", "url": "https://github.com/ConsenSys/teku/commit/f9c7a52a944a8c8c53be8c76da9d9bcf6d0904bf", "message": "Merge branch 'master' into bc-291/complete-stream-on-peer-disconnect", "committedDate": "2020-03-09T21:22:58Z", "type": "commit"}, {"oid": "fde1a2e6a455c9da96ef68f564fbb0ed59cdb57c", "url": "https://github.com/ConsenSys/teku/commit/fde1a2e6a455c9da96ef68f564fbb0ed59cdb57c", "message": "Merge branch 'master' into bc-291/complete-stream-on-peer-disconnect", "committedDate": "2020-03-09T21:45:13Z", "type": "commit"}, {"oid": "2c0e1981bb68674dac510afe48ff775da79d942a", "url": "https://github.com/ConsenSys/teku/commit/2c0e1981bb68674dac510afe48ff775da79d942a", "message": "Merge branch 'master' into bc-291/complete-stream-on-peer-disconnect", "committedDate": "2020-03-09T21:45:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAyMzc0MQ==", "url": "https://github.com/ConsenSys/teku/pull/1332#discussion_r390023741", "bodyText": "Where are you completing succesfully?", "author": "cemozerr", "createdAt": "2020-03-09T23:55:08Z", "path": "networking/p2p/src/main/java/tech/pegasys/artemis/networking/p2p/libp2p/rpc/RpcHandler.java", "diffHunk": "@@ -22,45 +22,92 @@\n import io.netty.buffer.ByteBuf;\n import io.netty.channel.ChannelHandlerContext;\n import io.netty.channel.SimpleChannelInboundHandler;\n+import java.time.Duration;\n import java.util.ArrayList;\n import java.util.List;\n+import java.util.concurrent.TimeUnit;\n import org.apache.logging.log4j.LogManager;\n import org.apache.logging.log4j.Logger;\n import org.apache.tuweni.bytes.Bytes;\n import org.jetbrains.annotations.NotNull;\n import tech.pegasys.artemis.networking.p2p.libp2p.LibP2PNodeId;\n import tech.pegasys.artemis.networking.p2p.libp2p.rpc.RpcHandler.Controller;\n import tech.pegasys.artemis.networking.p2p.peer.NodeId;\n+import tech.pegasys.artemis.networking.p2p.peer.PeerDisconnectedException;\n import tech.pegasys.artemis.networking.p2p.rpc.RpcMethod;\n import tech.pegasys.artemis.networking.p2p.rpc.RpcRequestHandler;\n import tech.pegasys.artemis.networking.p2p.rpc.RpcStream;\n+import tech.pegasys.artemis.networking.p2p.rpc.StreamClosedException;\n+import tech.pegasys.artemis.networking.p2p.rpc.StreamTimeoutException;\n+import tech.pegasys.artemis.util.async.AsyncRunner;\n import tech.pegasys.artemis.util.async.SafeFuture;\n \n public class RpcHandler implements ProtocolBinding<Controller> {\n+  private static final Duration TIMEOUT = Duration.ofSeconds(5);\n   private static final Logger LOG = LogManager.getLogger();\n \n   private final RpcMethod rpcMethod;\n+  private final AsyncRunner asyncRunner;\n \n-  public RpcHandler(RpcMethod rpcMethod) {\n+  public RpcHandler(final AsyncRunner asyncRunner, RpcMethod rpcMethod) {\n+    this.asyncRunner = asyncRunner;\n     this.rpcMethod = rpcMethod;\n   }\n \n   @SuppressWarnings(\"unchecked\")\n   public SafeFuture<RpcStream> sendRequest(\n       Connection connection, Bytes initialPayload, RpcRequestHandler handler) {\n-    return SafeFuture.of(\n-            connection\n-                .muxerSession()\n-                .createStream(\n-                    Multistream.create(this.toInitiator(rpcMethod.getId())).toStreamHandler())\n-                .getController())\n-        .thenCompose(\n+    if (connection.closeFuture().isDone()) {\n+      return SafeFuture.failedFuture(new PeerDisconnectedException());\n+    }\n+\n+    SafeFuture<RpcStream> streamFuture = new SafeFuture<>();\n+\n+    // Complete future if peer disconnects\n+    SafeFuture.of(connection.closeFuture())\n+        .always(() -> streamFuture.completeExceptionally(new PeerDisconnectedException()));\n+    // Complete future if we fail to initialize\n+    asyncRunner\n+        .getDelayedFuture(TIMEOUT.toMillis(), TimeUnit.MILLISECONDS)\n+        .thenAccept(\n+            __ ->\n+                streamFuture.completeExceptionally(\n+                    new StreamTimeoutException(\"Timed out waiting to initialize stream\")))\n+        .reportExceptions();\n+\n+    // Try to initiate stream\n+    connection\n+        .muxerSession()\n+        .createStream(Multistream.create(this.toInitiator(rpcMethod.getId())).toStreamHandler())\n+        .getController()\n+        .thenAccept(\n             ctr -> {\n               ctr.setRequestHandler(handler);\n-              return ctr.getRpcStream()\n+              ctr.getRpcStream()\n                   .writeBytes(initialPayload)\n-                  .thenApply(f -> ctr.getRpcStream());\n+                  .thenApply(f -> ctr.getRpcStream())\n+                  .thenAccept(\n+                      rpcStream -> {\n+                        if (!streamFuture.complete(rpcStream)) {", "originalCommit": "2c0e1981bb68674dac510afe48ff775da79d942a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDM5MzI0Nw==", "url": "https://github.com/ConsenSys/teku/pull/1332#discussion_r390393247", "bodyText": "Right on that line, I see :D. My bad.", "author": "cemozerr", "createdAt": "2020-03-10T15:18:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAyMzc0MQ=="}], "type": "inlineReview", "revised_code": {"commit": "147c2bc02940ba8ef1cd865b72fae4eb3020a963", "chunk": "diff --git a/networking/p2p/src/main/java/tech/pegasys/artemis/networking/p2p/libp2p/rpc/RpcHandler.java b/networking/p2p/src/main/java/tech/pegasys/artemis/networking/p2p/libp2p/rpc/RpcHandler.java\nindex 0f35282b7..3e3e5e24c 100644\n--- a/networking/p2p/src/main/java/tech/pegasys/artemis/networking/p2p/libp2p/rpc/RpcHandler.java\n+++ b/networking/p2p/src/main/java/tech/pegasys/artemis/networking/p2p/libp2p/rpc/RpcHandler.java\n\n@@ -76,36 +76,32 @@ public class RpcHandler implements ProtocolBinding<Controller> {\n         .reportExceptions();\n \n     // Try to initiate stream\n-    connection\n-        .muxerSession()\n-        .createStream(Multistream.create(this.toInitiator(rpcMethod.getId())).toStreamHandler())\n-        .getController()\n-        .thenAccept(\n+    SafeFuture.of(\n+            connection\n+                .muxerSession()\n+                .createStream(\n+                    Multistream.create(this.toInitiator(rpcMethod.getId())).toStreamHandler())\n+                .getController())\n+        .thenCompose(\n             ctr -> {\n               ctr.setRequestHandler(handler);\n-              ctr.getRpcStream()\n+              return ctr.getRpcStream()\n                   .writeBytes(initialPayload)\n                   .thenApply(f -> ctr.getRpcStream())\n                   .thenAccept(\n                       rpcStream -> {\n                         if (!streamFuture.complete(rpcStream)) {\n-                          // If future was already completed exceptionally, close down the\n-                          // controller\n+                          // If future was already completed exceptionally, close the controller\n                           ctr.close();\n                         }\n-                      })\n-                  .exceptionally(\n-                      err -> {\n-                        streamFuture.completeExceptionally(err);\n-                        return null;\n-                      })\n-                  .reportExceptions();\n+                      });\n             })\n         .exceptionally(\n             err -> {\n               streamFuture.completeExceptionally(err);\n               return null;\n-            });\n+            })\n+        .reportExceptions();\n \n     return streamFuture;\n   }\n"}}, {"oid": "afeb495e8660c613cccadd0fbc3789f349a59693", "url": "https://github.com/ConsenSys/teku/commit/afeb495e8660c613cccadd0fbc3789f349a59693", "message": "Merge branch 'master' into bc-291/complete-stream-on-peer-disconnect", "committedDate": "2020-03-10T15:18:09Z", "type": "commit"}, {"oid": "147c2bc02940ba8ef1cd865b72fae4eb3020a963", "url": "https://github.com/ConsenSys/teku/commit/147c2bc02940ba8ef1cd865b72fae4eb3020a963", "message": "Consolidate exception handling", "committedDate": "2020-03-10T15:31:05Z", "type": "commit"}]}