{"pr_number": 1669, "pr_title": "Add ForkDigestValue to topic names", "pr_createdAt": "2020-04-24T19:03:45Z", "pr_url": "https://github.com/ConsenSys/teku/pull/1669", "timeline": [{"oid": "616e2c5fb2fd1cc80876c67239452c3da1061598", "url": "https://github.com/ConsenSys/teku/commit/616e2c5fb2fd1cc80876c67239452c3da1061598", "message": "Add ForkDigestValue to topic names", "committedDate": "2020-04-24T19:02:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDgwOTc0Ng==", "url": "https://github.com/ConsenSys/teku/pull/1669#discussion_r414809746", "bodyText": "I'd pass the ForkDigest into the topic handler rather than passing in recentChainData.  We'll need to be able to explicitly create topics for specific forks.", "author": "mbaxter", "createdAt": "2020-04-24T19:24:08Z", "path": "networking/eth2/src/main/java/tech/pegasys/artemis/networking/eth2/gossip/topics/BlockTopicHandler.java", "diffHunk": "@@ -21,14 +21,18 @@\n import tech.pegasys.artemis.networking.eth2.gossip.events.GossipedBlockEvent;\n import tech.pegasys.artemis.networking.eth2.gossip.topics.validation.BlockValidationResult;\n import tech.pegasys.artemis.networking.eth2.gossip.topics.validation.BlockValidator;\n+import tech.pegasys.artemis.storage.client.RecentChainData;\n \n public class BlockTopicHandler extends Eth2TopicHandler<SignedBeaconBlock> {\n-  public static final String BLOCKS_TOPIC = \"/eth2/beacon_block/ssz\";\n+  public static String TOPIC_NAME = \"beacon_block\";\n   private final EventBus eventBus;\n   private final BlockValidator blockValidator;\n \n-  public BlockTopicHandler(final EventBus eventBus, final BlockValidator blockValidator) {\n-    super(eventBus);\n+  public BlockTopicHandler(\n+      final EventBus eventBus,\n+      final BlockValidator blockValidator,\n+      final RecentChainData recentChainData) {", "originalCommit": "616e2c5fb2fd1cc80876c67239452c3da1061598", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDgyMzM4NA==", "url": "https://github.com/ConsenSys/teku/pull/1669#discussion_r414823384", "bodyText": "Done.", "author": "cemozerr", "createdAt": "2020-04-24T19:49:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDgwOTc0Ng=="}], "type": "inlineReview", "revised_code": {"commit": "fd27d6cbc6f1fa75826277d21605d89006608f03", "chunk": "diff --git a/networking/eth2/src/main/java/tech/pegasys/artemis/networking/eth2/gossip/topics/BlockTopicHandler.java b/networking/eth2/src/main/java/tech/pegasys/artemis/networking/eth2/gossip/topics/BlockTopicHandler.java\nindex 974f4edc0f..d296eb451c 100644\n--- a/networking/eth2/src/main/java/tech/pegasys/artemis/networking/eth2/gossip/topics/BlockTopicHandler.java\n+++ b/networking/eth2/src/main/java/tech/pegasys/artemis/networking/eth2/gossip/topics/BlockTopicHandler.java\n\n@@ -21,7 +21,7 @@ import tech.pegasys.artemis.datastructures.util.SimpleOffsetSerializer;\n import tech.pegasys.artemis.networking.eth2.gossip.events.GossipedBlockEvent;\n import tech.pegasys.artemis.networking.eth2.gossip.topics.validation.BlockValidationResult;\n import tech.pegasys.artemis.networking.eth2.gossip.topics.validation.BlockValidator;\n-import tech.pegasys.artemis.storage.client.RecentChainData;\n+import tech.pegasys.artemis.ssz.SSZTypes.Bytes4;\n \n public class BlockTopicHandler extends Eth2TopicHandler<SignedBeaconBlock> {\n   public static String TOPIC_NAME = \"beacon_block\";\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDgxMTE4Nw==", "url": "https://github.com/ConsenSys/teku/pull/1669#discussion_r414811187", "bodyText": "We'll need to wait for the store to initialize (via recentChainData.subscribeStoreInitialized()) so we can get a correct ForkDigest value.  Otherwise, we may end up setting up meaningless topics for the \"pre-genesis\" fork digest.", "author": "mbaxter", "createdAt": "2020-04-24T19:26:45Z", "path": "networking/eth2/src/main/java/tech/pegasys/artemis/networking/eth2/gossip/BlockGossipManager.java", "diffHunk": "@@ -32,8 +33,10 @@\n   public BlockGossipManager(\n       final GossipNetwork gossipNetwork,\n       final EventBus eventBus,\n-      final BlockValidator blockValidator) {\n-    final BlockTopicHandler topicHandler = new BlockTopicHandler(eventBus, blockValidator);\n+      final BlockValidator blockValidator,\n+      final RecentChainData recentChainData) {\n+    final BlockTopicHandler topicHandler =", "originalCommit": "616e2c5fb2fd1cc80876c67239452c3da1061598", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDgyODc3Ng==", "url": "https://github.com/ConsenSys/teku/pull/1669#discussion_r414828776", "bodyText": "Makes sense. Done.", "author": "cemozerr", "createdAt": "2020-04-24T19:59:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDgxMTE4Nw=="}], "type": "inlineReview", "revised_code": {"commit": "fd27d6cbc6f1fa75826277d21605d89006608f03", "chunk": "diff --git a/networking/eth2/src/main/java/tech/pegasys/artemis/networking/eth2/gossip/BlockGossipManager.java b/networking/eth2/src/main/java/tech/pegasys/artemis/networking/eth2/gossip/BlockGossipManager.java\nindex f9093f6a8b..1418770745 100644\n--- a/networking/eth2/src/main/java/tech/pegasys/artemis/networking/eth2/gossip/BlockGossipManager.java\n+++ b/networking/eth2/src/main/java/tech/pegasys/artemis/networking/eth2/gossip/BlockGossipManager.java\n\n@@ -36,7 +36,7 @@ public class BlockGossipManager {\n       final BlockValidator blockValidator,\n       final RecentChainData recentChainData) {\n     final BlockTopicHandler topicHandler =\n-        new BlockTopicHandler(eventBus, blockValidator, recentChainData);\n+        new BlockTopicHandler(eventBus, blockValidator, recentChainData.getCurrentForkDigest());\n     this.eventBus = eventBus;\n     channel = gossipNetwork.subscribe(topicHandler.getTopic(), topicHandler);\n     eventBus.register(this);\n"}}, {"oid": "fd27d6cbc6f1fa75826277d21605d89006608f03", "url": "https://github.com/ConsenSys/teku/commit/fd27d6cbc6f1fa75826277d21605d89006608f03", "message": "Explicitly pass fork digest to topic handlers", "committedDate": "2020-04-24T20:06:08Z", "type": "commit"}, {"oid": "1d165aff0ee24ff650035f2438d8633162bbf8c0", "url": "https://github.com/ConsenSys/teku/commit/1d165aff0ee24ff650035f2438d8633162bbf8c0", "message": "Inhibit access to gossip manager requiring methods before init", "committedDate": "2020-04-24T20:29:58Z", "type": "commit"}, {"oid": "4eef33940417dde1aa9502e08f803dd3bc5a2930", "url": "https://github.com/ConsenSys/teku/commit/4eef33940417dde1aa9502e08f803dd3bc5a2930", "message": "Run spotless", "committedDate": "2020-04-24T20:36:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDg2MzA2MA==", "url": "https://github.com/ConsenSys/teku/pull/1669#discussion_r414863060", "bodyText": "I think these GossipManagers need to be volatile.  And we can just check if they're null.", "author": "mbaxter", "createdAt": "2020-04-24T21:06:00Z", "path": "networking/eth2/src/main/java/tech/pegasys/artemis/networking/eth2/ActiveEth2Network.java", "diffHunk": "@@ -123,11 +132,21 @@ public BeaconChainMethods getBeaconChainMethods() {\n \n   @Override\n   public void subscribeToAttestationCommitteeTopic(final int committeeIndex) {\n+    if (state.get() != State.RUNNING) {\n+      LOG.warn(\n+          \"Attestation committee can not be subscribed due to Gossip Managers not being initialized\");\n+      return;\n+    }\n     attestationGossipManager.subscribeToCommitteeTopic(committeeIndex);", "originalCommit": "4eef33940417dde1aa9502e08f803dd3bc5a2930", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDg3MDA0Mg==", "url": "https://github.com/ConsenSys/teku/pull/1669#discussion_r414870042", "bodyText": "I've reverted to using an atomic boolean instead. I believe that also solves this issue.", "author": "cemozerr", "createdAt": "2020-04-24T21:20:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDg2MzA2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDg4Nzk0MQ==", "url": "https://github.com/ConsenSys/teku/pull/1669#discussion_r414887941", "bodyText": "I think attestationGossipManager etc still need to be volatile ...", "author": "mbaxter", "createdAt": "2020-04-24T22:01:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDg2MzA2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTQ0NDA4MQ==", "url": "https://github.com/ConsenSys/teku/pull/1669#discussion_r415444081", "bodyText": "Doesn't necessarily have to be this PR, but we need to change our startup so that P2P networking is only started after genesis is known.  I suspect a lot of these concerns should all disappear then as the network can be all be at once without having to wait for genesis to init the gossip managers.\nThat said, we are potentially going to have a race condition here because validators should start calculating their duties once genesis is known and subscribing to subnets - we need to make sure the P2P network is fully created before they start doing that and not just ignore the requests to subscribe.  Right now we'll get away with it because validators don't calculate their duties until the first slot.\nI've logged https://pegasys1.atlassian.net/browse/BC-394 and https://pegasys1.atlassian.net/browse/BC-395", "author": "ajsutton", "createdAt": "2020-04-27T00:55:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDg2MzA2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjE5NDU2NA==", "url": "https://github.com/ConsenSys/teku/pull/1669#discussion_r416194564", "bodyText": "Now that the PR #1679 is merged in, and the JIRA issue BC-394 is dealt with, this shouldn't be a big issue anymore. I've reverted the changes I made in ActiveEth2Network around gossip managers waiting for the store to initialize.", "author": "cemozerr", "createdAt": "2020-04-27T22:32:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDg2MzA2MA=="}], "type": "inlineReview", "revised_code": {"commit": "59cbfecd83515507e53d502c7d3bccc9f2f12fce", "chunk": "diff --git a/networking/eth2/src/main/java/tech/pegasys/artemis/networking/eth2/ActiveEth2Network.java b/networking/eth2/src/main/java/tech/pegasys/artemis/networking/eth2/ActiveEth2Network.java\nindex f4e3f5eb2e..fc9b546688 100644\n--- a/networking/eth2/src/main/java/tech/pegasys/artemis/networking/eth2/ActiveEth2Network.java\n+++ b/networking/eth2/src/main/java/tech/pegasys/artemis/networking/eth2/ActiveEth2Network.java\n\n@@ -132,7 +135,7 @@ public class ActiveEth2Network extends DelegatingP2PNetwork<Eth2Peer> implements\n \n   @Override\n   public void subscribeToAttestationCommitteeTopic(final int committeeIndex) {\n-    if (state.get() != State.RUNNING) {\n+    if (!gossipManagersInitialized.get()) {\n       LOG.warn(\n           \"Attestation committee can not be subscribed due to Gossip Managers not being initialized\");\n       return;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDg2NDgzMQ==", "url": "https://github.com/ConsenSys/teku/pull/1669#discussion_r414864831", "bodyText": "I think returning from start() before moving to the RUNNING state violates the intention of the start / stop methods.  You'd expect to be able to successfully stop() the network after successfully starting it.", "author": "mbaxter", "createdAt": "2020-04-24T21:09:52Z", "path": "networking/eth2/src/main/java/tech/pegasys/artemis/networking/eth2/ActiveEth2Network.java", "diffHunk": "@@ -63,15 +67,20 @@ public ActiveEth2Network(\n   }\n \n   private void startup() {\n-    state.set(State.RUNNING);\n+    recentChainData.subscribeBestBlockInitialized(this::initGossipManagers);\n+  }\n+\n+  public void initGossipManagers() {\n     BlockValidator blockValidator = new BlockValidator(recentChainData, new StateTransition());\n     AttestationSubnetSubscriptions attestationSubnetSubscriptions =\n         new AttestationSubnetSubscriptions(discoveryNetwork, recentChainData, eventBus);\n-    blockGossipManager = new BlockGossipManager(discoveryNetwork, eventBus, blockValidator);\n+    blockGossipManager =\n+        new BlockGossipManager(discoveryNetwork, eventBus, blockValidator, recentChainData);\n     attestationGossipManager =\n         new AttestationGossipManager(eventBus, attestationSubnetSubscriptions);\n     aggregateGossipManager =\n         new AggregateGossipManager(discoveryNetwork, eventBus, recentChainData);\n+    state.set(State.RUNNING);", "originalCommit": "4eef33940417dde1aa9502e08f803dd3bc5a2930", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDg3MDE5Mg==", "url": "https://github.com/ConsenSys/teku/pull/1669#discussion_r414870192", "bodyText": "Reverted that change.", "author": "cemozerr", "createdAt": "2020-04-24T21:21:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDg2NDgzMQ=="}], "type": "inlineReview", "revised_code": {"commit": "59cbfecd83515507e53d502c7d3bccc9f2f12fce", "chunk": "diff --git a/networking/eth2/src/main/java/tech/pegasys/artemis/networking/eth2/ActiveEth2Network.java b/networking/eth2/src/main/java/tech/pegasys/artemis/networking/eth2/ActiveEth2Network.java\nindex f4e3f5eb2e..fc9b546688 100644\n--- a/networking/eth2/src/main/java/tech/pegasys/artemis/networking/eth2/ActiveEth2Network.java\n+++ b/networking/eth2/src/main/java/tech/pegasys/artemis/networking/eth2/ActiveEth2Network.java\n\n@@ -67,6 +69,7 @@ public class ActiveEth2Network extends DelegatingP2PNetwork<Eth2Peer> implements\n   }\n \n   private void startup() {\n+    state.set(State.RUNNING);\n     recentChainData.subscribeBestBlockInitialized(this::initGossipManagers);\n   }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDg2ODI3Mg==", "url": "https://github.com/ConsenSys/teku/pull/1669#discussion_r414868272", "bodyText": "Do we have any tests around the topic format?  Probably worth adding a test here to make sure the topic looks like what we expect.", "author": "mbaxter", "createdAt": "2020-04-24T21:16:56Z", "path": "networking/eth2/src/test/java/tech/pegasys/artemis/networking/eth2/gossip/topics/Eth2TopicHandlerTest.java", "diffHunk": "@@ -28,13 +28,17 @@\n import org.junit.jupiter.api.Test;\n import tech.pegasys.artemis.datastructures.operations.Attestation;\n import tech.pegasys.artemis.datastructures.util.DataStructureUtil;\n+import tech.pegasys.artemis.ssz.SSZTypes.Bytes4;\n+import tech.pegasys.artemis.storage.client.RecentChainData;\n \n public class Eth2TopicHandlerTest {", "originalCommit": "4eef33940417dde1aa9502e08f803dd3bc5a2930", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDg3Njc5Ng==", "url": "https://github.com/ConsenSys/teku/pull/1669#discussion_r414876796", "bodyText": "Done.", "author": "cemozerr", "createdAt": "2020-04-24T21:35:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDg2ODI3Mg=="}], "type": "inlineReview", "revised_code": {"commit": "d4d621558aae26a0caeaeb8d7e8e4454e7a2946b", "chunk": "diff --git a/networking/eth2/src/test/java/tech/pegasys/artemis/networking/eth2/gossip/topics/Eth2TopicHandlerTest.java b/networking/eth2/src/test/java/tech/pegasys/artemis/networking/eth2/gossip/topics/Eth2TopicHandlerTest.java\nindex 83061fdaf7..1c8a84ac24 100644\n--- a/networking/eth2/src/test/java/tech/pegasys/artemis/networking/eth2/gossip/topics/Eth2TopicHandlerTest.java\n+++ b/networking/eth2/src/test/java/tech/pegasys/artemis/networking/eth2/gossip/topics/Eth2TopicHandlerTest.java\n\n@@ -19,12 +19,14 @@ import static org.mockito.Mockito.mock;\n import static org.mockito.Mockito.never;\n import static org.mockito.Mockito.spy;\n import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n \n import com.google.common.base.Suppliers;\n import com.google.common.eventbus.EventBus;\n import java.util.function.Supplier;\n import org.apache.tuweni.bytes.Bytes;\n import org.apache.tuweni.ssz.SSZException;\n+import org.junit.jupiter.api.BeforeEach;\n import org.junit.jupiter.api.Test;\n import tech.pegasys.artemis.datastructures.operations.Attestation;\n import tech.pegasys.artemis.datastructures.util.DataStructureUtil;\n"}}, {"oid": "59cbfecd83515507e53d502c7d3bccc9f2f12fce", "url": "https://github.com/ConsenSys/teku/commit/59cbfecd83515507e53d502c7d3bccc9f2f12fce", "message": "Resolve comments", "committedDate": "2020-04-24T21:22:24Z", "type": "commit"}, {"oid": "e2d819a0b49c82116bf1eba636e30a5cf8650dde", "url": "https://github.com/ConsenSys/teku/commit/e2d819a0b49c82116bf1eba636e30a5cf8650dde", "message": "Add test for topic format", "committedDate": "2020-04-24T21:34:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDg4NDM0NQ==", "url": "https://github.com/ConsenSys/teku/pull/1669#discussion_r414884345", "bodyText": "I think there's still some potential messiness when we shutdown: if the gossip managers aren't yet set, we'll get NullPointerException's.", "author": "mbaxter", "createdAt": "2020-04-24T21:52:21Z", "path": "networking/eth2/src/main/java/tech/pegasys/artemis/networking/eth2/ActiveEth2Network.java", "diffHunk": "@@ -35,11 +38,14 @@\n import tech.pegasys.artemis.util.async.SafeFuture;\n \n public class ActiveEth2Network extends DelegatingP2PNetwork<Eth2Peer> implements Eth2Network {\n+  private static final Logger LOG = LogManager.getLogger();\n+\n   private final DiscoveryNetwork<?> discoveryNetwork;\n   private final Eth2PeerManager peerManager;\n   private final EventBus eventBus;\n   private final RecentChainData recentChainData;\n   private final AtomicReference<State> state = new AtomicReference<>(State.IDLE);\n+  private final AtomicBoolean gossipManagersInitialized = new AtomicBoolean(false);", "originalCommit": "e2d819a0b49c82116bf1eba636e30a5cf8650dde", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "48a49f1c029f0622760c9515699c64dfc3c4e381", "chunk": "diff --git a/networking/eth2/src/main/java/tech/pegasys/artemis/networking/eth2/ActiveEth2Network.java b/networking/eth2/src/main/java/tech/pegasys/artemis/networking/eth2/ActiveEth2Network.java\nindex fc9b546688..10e47bba93 100644\n--- a/networking/eth2/src/main/java/tech/pegasys/artemis/networking/eth2/ActiveEth2Network.java\n+++ b/networking/eth2/src/main/java/tech/pegasys/artemis/networking/eth2/ActiveEth2Network.java\n\n@@ -45,11 +45,10 @@ public class ActiveEth2Network extends DelegatingP2PNetwork<Eth2Peer> implements\n   private final EventBus eventBus;\n   private final RecentChainData recentChainData;\n   private final AtomicReference<State> state = new AtomicReference<>(State.IDLE);\n-  private final AtomicBoolean gossipManagersInitialized = new AtomicBoolean(false);\n \n-  private BlockGossipManager blockGossipManager;\n-  private AttestationGossipManager attestationGossipManager;\n-  private AggregateGossipManager aggregateGossipManager;\n+  private volatile BlockGossipManager blockGossipManager;\n+  private volatile AttestationGossipManager attestationGossipManager;\n+  private volatile AggregateGossipManager aggregateGossipManager;\n \n   public ActiveEth2Network(\n       final DiscoveryNetwork<?> discoveryNetwork,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDg4OTc5Mg==", "url": "https://github.com/ConsenSys/teku/pull/1669#discussion_r414889792", "bodyText": "We should probably validate that the subnetId int is positive", "author": "mbaxter", "createdAt": "2020-04-24T22:06:30Z", "path": "networking/eth2/src/main/java/tech/pegasys/artemis/networking/eth2/gossip/topics/AttestationTopicHandler.java", "diffHunk": "@@ -27,29 +27,29 @@\n import tech.pegasys.artemis.datastructures.operations.IndexedAttestation;\n import tech.pegasys.artemis.datastructures.state.BeaconState;\n import tech.pegasys.artemis.datastructures.util.SimpleOffsetSerializer;\n+import tech.pegasys.artemis.ssz.SSZTypes.Bytes4;\n import tech.pegasys.artemis.storage.client.RecentChainData;\n \n public class AttestationTopicHandler extends Eth2TopicHandler<Attestation> {\n \n   private static final Logger LOG = LogManager.getLogger();\n \n-  private final String attestationsTopic;\n   private final RecentChainData recentChainData;\n+  private final UnsignedLong subnetId;\n \n   public AttestationTopicHandler(\n-      final EventBus eventBus, final RecentChainData recentChainData, final UnsignedLong subnetId) {\n-    super(eventBus);\n-    this.attestationsTopic = getTopic(subnetId);\n+      final EventBus eventBus,\n+      final RecentChainData recentChainData,\n+      final UnsignedLong subnetId,\n+      final Bytes4 forkDigest) {\n+    super(eventBus, forkDigest);\n     this.recentChainData = recentChainData;\n-  }\n-\n-  private static String getTopic(final UnsignedLong subnetId) {\n-    return \"/eth2/committee_index\" + toIntExact(subnetId.longValue()) + \"_beacon_attestation/ssz\";\n+    this.subnetId = subnetId;\n   }\n \n   @Override\n-  public String getTopic() {\n-    return attestationsTopic;\n+  public String getTopicName() {\n+    return \"committee_index\" + toIntExact(subnetId.longValue()) + \"_beacon_attestation\";", "originalCommit": "e2d819a0b49c82116bf1eba636e30a5cf8650dde", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDg5NTk5Mg==", "url": "https://github.com/ConsenSys/teku/pull/1669#discussion_r414895992", "bodyText": "It's an UnsignedLong?", "author": "cemozerr", "createdAt": "2020-04-24T22:23:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDg4OTc5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDkxNjcyNw==", "url": "https://github.com/ConsenSys/teku/pull/1669#discussion_r414916727", "bodyText": "UnsignedLong.MAX_VALUE.longValue() == -1", "author": "mbaxter", "createdAt": "2020-04-24T23:27:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDg4OTc5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjE5NzU5NA==", "url": "https://github.com/ConsenSys/teku/pull/1669#discussion_r416197594", "bodyText": "In most parts of the codebase if we were dealing with values from 2^63 to 2^64-1 we would have the same issue but I don't think it's in the scope of this PR.", "author": "cemozerr", "createdAt": "2020-04-27T22:39:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDg4OTc5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjE5ODQ2Mg==", "url": "https://github.com/ConsenSys/teku/pull/1669#discussion_r416198462", "bodyText": "It's a good point though, so I made a ticket: https://pegasys1.atlassian.net/browse/BC-397", "author": "cemozerr", "createdAt": "2020-04-27T22:41:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDg4OTc5Mg=="}], "type": "inlineReview", "revised_code": {"commit": "825e0291fdebaff288f6e1b18274289a918d2183", "chunk": "diff --git a/networking/eth2/src/main/java/tech/pegasys/artemis/networking/eth2/gossip/topics/AttestationTopicHandler.java b/networking/eth2/src/main/java/tech/pegasys/artemis/networking/eth2/gossip/topics/AttestationTopicHandler.java\nindex 96af65f95e..d2dcc49b36 100644\n--- a/networking/eth2/src/main/java/tech/pegasys/artemis/networking/eth2/gossip/topics/AttestationTopicHandler.java\n+++ b/networking/eth2/src/main/java/tech/pegasys/artemis/networking/eth2/gossip/topics/AttestationTopicHandler.java\n\n@@ -14,26 +14,20 @@\n package tech.pegasys.artemis.networking.eth2.gossip.topics;\n \n import static java.lang.StrictMath.toIntExact;\n-import static tech.pegasys.artemis.datastructures.util.AttestationUtil.get_indexed_attestation;\n-import static tech.pegasys.artemis.datastructures.util.AttestationUtil.is_valid_indexed_attestation;\n \n import com.google.common.eventbus.EventBus;\n import com.google.common.primitives.UnsignedLong;\n-import org.apache.logging.log4j.LogManager;\n-import org.apache.logging.log4j.Logger;\n import org.apache.tuweni.bytes.Bytes;\n import org.apache.tuweni.ssz.SSZException;\n import tech.pegasys.artemis.datastructures.operations.Attestation;\n-import tech.pegasys.artemis.datastructures.operations.IndexedAttestation;\n-import tech.pegasys.artemis.datastructures.state.BeaconState;\n import tech.pegasys.artemis.datastructures.util.SimpleOffsetSerializer;\n import tech.pegasys.artemis.ssz.SSZTypes.Bytes4;\n import tech.pegasys.artemis.storage.client.RecentChainData;\n+import tech.pegasys.artemis.networking.eth2.gossip.topics.validation.AttestationValidator;\n+import tech.pegasys.artemis.networking.eth2.gossip.topics.validation.ValidationResult;\n \n public class AttestationTopicHandler extends Eth2TopicHandler<Attestation> {\n \n-  private static final Logger LOG = LogManager.getLogger();\n-\n   private final RecentChainData recentChainData;\n   private final UnsignedLong subnetId;\n \n"}}, {"oid": "48a49f1c029f0622760c9515699c64dfc3c4e381", "url": "https://github.com/ConsenSys/teku/commit/48a49f1c029f0622760c9515699c64dfc3c4e381", "message": "Remove atomic boolean & make variables null instead", "committedDate": "2020-04-24T22:19:30Z", "type": "commit"}, {"oid": "fad6eb85e6da52ff8f76adac490a0f736ce709bc", "url": "https://github.com/ConsenSys/teku/commit/fad6eb85e6da52ff8f76adac490a0f736ce709bc", "message": "Run spotless", "committedDate": "2020-04-24T22:29:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTQ0NTc3MA==", "url": "https://github.com/ConsenSys/teku/pull/1669#discussion_r415445770", "bodyText": "nit: Could we add a toUnprefixedHexString to Bytes4 which calls toUnprefixedHexString on the underlying bytes rather than truncating the first two characters here?", "author": "ajsutton", "createdAt": "2020-04-27T01:02:44Z", "path": "networking/eth2/src/main/java/tech/pegasys/artemis/networking/eth2/gossip/topics/Eth2TopicHandler.java", "diffHunk": "@@ -54,7 +58,13 @@ protected Object createEvent(T data) {\n     return data;\n   }\n \n-  public abstract String getTopic();\n+  public String getTopic() {\n+    return \"/eth2/\" + this.getForkDigestString() + \"/\" + getTopicName() + \"/ssz\";\n+  }\n+\n+  private String getForkDigestString() {\n+    return forkDigest.toHexString().substring(2);", "originalCommit": "fad6eb85e6da52ff8f76adac490a0f736ce709bc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjE5NjMzNw==", "url": "https://github.com/ConsenSys/teku/pull/1669#discussion_r416196337", "bodyText": "Done.", "author": "cemozerr", "createdAt": "2020-04-27T22:36:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTQ0NTc3MA=="}], "type": "inlineReview", "revised_code": {"commit": "b3b3dd478619a0c4178501ed9093df9073ddc28f", "chunk": "diff --git a/networking/eth2/src/main/java/tech/pegasys/artemis/networking/eth2/gossip/topics/Eth2TopicHandler.java b/networking/eth2/src/main/java/tech/pegasys/artemis/networking/eth2/gossip/topics/Eth2TopicHandler.java\nindex c8096e41e1..d3fe140b90 100644\n--- a/networking/eth2/src/main/java/tech/pegasys/artemis/networking/eth2/gossip/topics/Eth2TopicHandler.java\n+++ b/networking/eth2/src/main/java/tech/pegasys/artemis/networking/eth2/gossip/topics/Eth2TopicHandler.java\n\n@@ -59,12 +59,10 @@ public abstract class Eth2TopicHandler<T extends SimpleOffsetSerializable> imple\n   }\n \n   public String getTopic() {\n-    return \"/eth2/\" + this.getForkDigestString() + \"/\" + getTopicName() + \"/ssz\";\n+    return \"/eth2/\" + forkDigest.toUnprefixedHexString() + \"/\" + getTopicName() + \"/ssz\";\n   }\n \n-  private String getForkDigestString() {\n-    return forkDigest.toHexString().substring(2);\n-  }\n+  protected abstract String getTopicName();\n \n   protected abstract T deserialize(Bytes bytes) throws SSZException;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTQ0NjMyMQ==", "url": "https://github.com/ConsenSys/teku/pull/1669#discussion_r415446321", "bodyText": "nit: I think this should have just been an abstract method in Eth2TopicHandler rather than pulled all the way up to the interface.", "author": "ajsutton", "createdAt": "2020-04-27T01:05:20Z", "path": "networking/p2p/src/main/java/tech/pegasys/artemis/networking/p2p/gossip/TopicHandler.java", "diffHunk": "@@ -17,6 +17,8 @@\n \n public interface TopicHandler {\n \n+  String getTopicName();", "originalCommit": "fad6eb85e6da52ff8f76adac490a0f736ce709bc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjE5NjY4OA==", "url": "https://github.com/ConsenSys/teku/pull/1669#discussion_r416196688", "bodyText": "Makes sense. Done.", "author": "cemozerr", "createdAt": "2020-04-27T22:37:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTQ0NjMyMQ=="}], "type": "inlineReview", "revised_code": {"commit": "b3b3dd478619a0c4178501ed9093df9073ddc28f", "chunk": "diff --git a/networking/p2p/src/main/java/tech/pegasys/artemis/networking/p2p/gossip/TopicHandler.java b/networking/p2p/src/main/java/tech/pegasys/artemis/networking/p2p/gossip/TopicHandler.java\nindex 8c46fda919..bab1c653f0 100644\n--- a/networking/p2p/src/main/java/tech/pegasys/artemis/networking/p2p/gossip/TopicHandler.java\n+++ b/networking/p2p/src/main/java/tech/pegasys/artemis/networking/p2p/gossip/TopicHandler.java\n\n@@ -17,8 +17,6 @@ import org.apache.tuweni.bytes.Bytes;\n \n public interface TopicHandler {\n \n-  String getTopicName();\n-\n   /**\n    * Validate and process gossip message\n    *\n"}}, {"oid": "6ee14389dcc6e9e6bad4284ec05bda53fb28fc47", "url": "https://github.com/ConsenSys/teku/commit/6ee14389dcc6e9e6bad4284ec05bda53fb28fc47", "message": "Revert ActiveEth2Network changes related to p2p network start", "committedDate": "2020-04-27T19:28:25Z", "type": "commit"}, {"oid": "825e0291fdebaff288f6e1b18274289a918d2183", "url": "https://github.com/ConsenSys/teku/commit/825e0291fdebaff288f6e1b18274289a918d2183", "message": "Merge remote-tracking branch 'remotes/origin/master' into addForkDigestValueToTopicNames\n\n# Conflicts:\n#\tnetworking/eth2/src/main/java/tech/pegasys/artemis/networking/eth2/ActiveEth2Network.java\n#\tnetworking/eth2/src/main/java/tech/pegasys/artemis/networking/eth2/gossip/AttestationSubnetSubscriptions.java\n#\tnetworking/eth2/src/main/java/tech/pegasys/artemis/networking/eth2/gossip/topics/AttestationTopicHandler.java\n#\tnetworking/eth2/src/main/java/tech/pegasys/artemis/networking/eth2/gossip/topics/BlockTopicHandler.java\n#\tnetworking/eth2/src/test/java/tech/pegasys/artemis/networking/eth2/gossip/AttestationGossipManagerTest.java\n#\tnetworking/eth2/src/test/java/tech/pegasys/artemis/networking/eth2/gossip/AttestationSubnetSubscriptionsTest.java\n#\tnetworking/eth2/src/test/java/tech/pegasys/artemis/networking/eth2/gossip/topics/AttestationTopicHandlerTest.java", "committedDate": "2020-04-27T21:21:54Z", "type": "commit"}, {"oid": "d4d621558aae26a0caeaeb8d7e8e4454e7a2946b", "url": "https://github.com/ConsenSys/teku/commit/d4d621558aae26a0caeaeb8d7e8e4454e7a2946b", "message": "Fix merge errors", "committedDate": "2020-04-27T22:33:42Z", "type": "commit"}, {"oid": "b3b3dd478619a0c4178501ed9093df9073ddc28f", "url": "https://github.com/ConsenSys/teku/commit/b3b3dd478619a0c4178501ed9093df9073ddc28f", "message": "Make getTopicName an Eth2TopicHandler abstract method", "committedDate": "2020-04-27T22:44:15Z", "type": "commit"}, {"oid": "a777a2d324c9f60b35ca637e76e5843aa4c16c17", "url": "https://github.com/ConsenSys/teku/commit/a777a2d324c9f60b35ca637e76e5843aa4c16c17", "message": "Merge branch 'master' into addForkDigestValueToTopicNames", "committedDate": "2020-04-27T23:06:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjIxNzk0Nw==", "url": "https://github.com/ConsenSys/teku/pull/1669#discussion_r416217947", "bodyText": "Do we need this now that we only start the network post-genesis?", "author": "ajsutton", "createdAt": "2020-04-27T23:28:30Z", "path": "ethereum/datastructures/src/main/java/tech/pegasys/artemis/datastructures/networking/libp2p/rpc/StatusMessage.java", "diffHunk": "@@ -57,7 +57,7 @@ public static StatusMessage createPreGenesisStatus() {\n         UnsignedLong.ZERO);\n   }\n \n-  private static Bytes4 createPreGenesisForkDigest() {\n+  public static Bytes4 createPreGenesisForkDigest() {", "originalCommit": "a777a2d324c9f60b35ca637e76e5843aa4c16c17", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjc5NTQ5NA==", "url": "https://github.com/ConsenSys/teku/pull/1669#discussion_r416795494", "bodyText": "No. Switching back.", "author": "cemozerr", "createdAt": "2020-04-28T17:30:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjIxNzk0Nw=="}], "type": "inlineReview", "revised_code": {"commit": "9e781c096df20321dd9323f3b92992f10f7994c7", "chunk": "diff --git a/ethereum/datastructures/src/main/java/tech/pegasys/artemis/datastructures/networking/libp2p/rpc/StatusMessage.java b/ethereum/datastructures/src/main/java/tech/pegasys/artemis/datastructures/networking/libp2p/rpc/StatusMessage.java\nindex a2cc1b583a..ec2ac0f321 100644\n--- a/ethereum/datastructures/src/main/java/tech/pegasys/artemis/datastructures/networking/libp2p/rpc/StatusMessage.java\n+++ b/ethereum/datastructures/src/main/java/tech/pegasys/artemis/datastructures/networking/libp2p/rpc/StatusMessage.java\n\n@@ -57,7 +57,7 @@ public class StatusMessage implements RpcRequest, SimpleOffsetSerializable, SSZC\n         UnsignedLong.ZERO);\n   }\n \n-  public static Bytes4 createPreGenesisForkDigest() {\n+  private static Bytes4 createPreGenesisForkDigest() {\n     final Bytes4 genesisFork = Constants.GENESIS_FORK_VERSION;\n     final Bytes32 emptyValidatorsRoot = Bytes32.ZERO;\n     return compute_fork_digest(genesisFork, emptyValidatorsRoot);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjIyMTIzNQ==", "url": "https://github.com/ConsenSys/teku/pull/1669#discussion_r416221235", "bodyText": "This still worries me.  I suspect we should be storing a list of topics to subscribe to when we do startup or at least throwing an exception to let the caller know the subscription failed rather than ignoring the request.  At the moment it's only called from the ValidatorApiHandler so throwing an exception probably makes sense so the validator knows it's subscription failed.  It shouldn't hit it at the moment because of the way it manages timing.", "author": "ajsutton", "createdAt": "2020-04-27T23:36:39Z", "path": "networking/eth2/src/main/java/tech/pegasys/artemis/networking/eth2/ActiveEth2Network.java", "diffHunk": "@@ -125,11 +131,21 @@ public BeaconChainMethods getBeaconChainMethods() {\n \n   @Override\n   public void subscribeToAttestationCommitteeTopic(final int committeeIndex) {\n+    if (aggregateGossipManager == null) {\n+      LOG.warn(\n+          \"Attestation committee can not be subscribed due to gossip manager not being initialized\");\n+      return;\n+    }", "originalCommit": "a777a2d324c9f60b35ca637e76e5843aa4c16c17", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjc5MzkwOQ==", "url": "https://github.com/ConsenSys/teku/pull/1669#discussion_r416793909", "bodyText": "Makes sense. Done.", "author": "cemozerr", "createdAt": "2020-04-28T17:28:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjIyMTIzNQ=="}], "type": "inlineReview", "revised_code": {"commit": "37fbb562f404f75025512a9383b759e6829e8cd9", "chunk": "diff --git a/networking/eth2/src/main/java/tech/pegasys/artemis/networking/eth2/ActiveEth2Network.java b/networking/eth2/src/main/java/tech/pegasys/artemis/networking/eth2/ActiveEth2Network.java\nindex d0143c829c..a1ac76c713 100644\n--- a/networking/eth2/src/main/java/tech/pegasys/artemis/networking/eth2/ActiveEth2Network.java\n+++ b/networking/eth2/src/main/java/tech/pegasys/artemis/networking/eth2/ActiveEth2Network.java\n\n@@ -132,9 +132,8 @@ public class ActiveEth2Network extends DelegatingP2PNetwork<Eth2Peer> implements\n   @Override\n   public void subscribeToAttestationCommitteeTopic(final int committeeIndex) {\n     if (aggregateGossipManager == null) {\n-      LOG.warn(\n+      throw new IllegalStateException(\n           \"Attestation committee can not be subscribed due to gossip manager not being initialized\");\n-      return;\n     }\n     attestationGossipManager.subscribeToCommitteeTopic(committeeIndex);\n   }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjIyMjYxMg==", "url": "https://github.com/ConsenSys/teku/pull/1669#discussion_r416222612", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                return toHexString().substring(2);\n          \n          \n            \n                return bytes.toUnprefixedHexString()", "author": "ajsutton", "createdAt": "2020-04-27T23:40:26Z", "path": "ssz/src/main/java/tech/pegasys/artemis/ssz/SSZTypes/Bytes4.java", "diffHunk": "@@ -98,6 +98,10 @@ public int hashCode() {\n     return Objects.hash(bytes);\n   }\n \n+  public String toUnprefixedHexString() {\n+    return toHexString().substring(2);", "originalCommit": "a777a2d324c9f60b35ca637e76e5843aa4c16c17", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjc5NDU0OQ==", "url": "https://github.com/ConsenSys/teku/pull/1669#discussion_r416794549", "bodyText": "Done.", "author": "cemozerr", "createdAt": "2020-04-28T17:29:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjIyMjYxMg=="}], "type": "inlineReview", "revised_code": {"commit": "6a63ecd3de2b816a815874c61aecee475a336dff", "chunk": "diff --git a/ssz/src/main/java/tech/pegasys/artemis/ssz/SSZTypes/Bytes4.java b/ssz/src/main/java/tech/pegasys/artemis/ssz/SSZTypes/Bytes4.java\nindex 3343491af1..17fbee274d 100644\n--- a/ssz/src/main/java/tech/pegasys/artemis/ssz/SSZTypes/Bytes4.java\n+++ b/ssz/src/main/java/tech/pegasys/artemis/ssz/SSZTypes/Bytes4.java\n\n@@ -99,7 +99,7 @@ public class Bytes4 {\n   }\n \n   public String toUnprefixedHexString() {\n-    return toHexString().substring(2);\n+    return bytes.toUnprefixedHexString();\n   }\n \n   @Override\n"}}, {"oid": "37fbb562f404f75025512a9383b759e6829e8cd9", "url": "https://github.com/ConsenSys/teku/commit/37fbb562f404f75025512a9383b759e6829e8cd9", "message": "Throw exception when subscription fails", "committedDate": "2020-04-28T17:44:32Z", "type": "commit"}, {"oid": "6a63ecd3de2b816a815874c61aecee475a336dff", "url": "https://github.com/ConsenSys/teku/commit/6a63ecd3de2b816a815874c61aecee475a336dff", "message": "Use string method of Bytes", "committedDate": "2020-04-28T17:45:00Z", "type": "commit"}, {"oid": "9e781c096df20321dd9323f3b92992f10f7994c7", "url": "https://github.com/ConsenSys/teku/commit/9e781c096df20321dd9323f3b92992f10f7994c7", "message": "Make createPreGenesisForkDigest private", "committedDate": "2020-04-28T17:45:27Z", "type": "commit"}, {"oid": "f4494f4de854ec0d2772ad42b4904bfe8380e639", "url": "https://github.com/ConsenSys/teku/commit/f4494f4de854ec0d2772ad42b4904bfe8380e639", "message": "Remove unused variable", "committedDate": "2020-04-28T18:09:30Z", "type": "commit"}, {"oid": "6de90c55d8f10ab9a7b79cbadc31f96932723083", "url": "https://github.com/ConsenSys/teku/commit/6de90c55d8f10ab9a7b79cbadc31f96932723083", "message": "Merge branch 'master' into addForkDigestValueToTopicNames", "committedDate": "2020-04-28T18:10:11Z", "type": "commit"}, {"oid": "02bcef6efe54fc4357bea6b74f584ce3b88b06a7", "url": "https://github.com/ConsenSys/teku/commit/02bcef6efe54fc4357bea6b74f584ce3b88b06a7", "message": "Merge branch 'master' into addForkDigestValueToTopicNames", "committedDate": "2020-04-28T19:12:04Z", "type": "commit"}]}