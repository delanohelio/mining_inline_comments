{"pr_number": 2555, "pr_title": "[Issue-2438] Be more careful about disabling validator duties while \"syncing\"", "pr_createdAt": "2020-08-11T16:22:16Z", "pr_url": "https://github.com/ConsenSys/teku/pull/2555", "timeline": [{"oid": "fea26a058b07baf8fbf1dfc5254518ac28315979", "url": "https://github.com/ConsenSys/teku/commit/fea26a058b07baf8fbf1dfc5254518ac28315979", "message": "Be more careful about disabling duties while \"syncing\"", "committedDate": "2020-08-11T16:17:59Z", "type": "commit"}, {"oid": "ccfb8e08905530e017630e46f8d70facce2bf453", "url": "https://github.com/ConsenSys/teku/commit/ccfb8e08905530e017630e46f8d70facce2bf453", "message": "Merge branch 'master' into issue-2438/double-check-head-slot-before-skipping-duties", "committedDate": "2020-08-11T19:46:27Z", "type": "commit"}, {"oid": "d66bb78aa5c85228e4d2be3c87018460571aab30", "url": "https://github.com/ConsenSys/teku/commit/d66bb78aa5c85228e4d2be3c87018460571aab30", "message": "Merge branch 'master' into issue-2438/double-check-head-slot-before-skipping-duties", "committedDate": "2020-08-11T20:07:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODg0MTQwMQ==", "url": "https://github.com/ConsenSys/teku/pull/2555#discussion_r468841401", "bodyText": "Should we apply this rename to recentChainData.getBestSlot() too? I must admit I'm getting confused about best vs head vs current slot and what they all mean.  It may be worth adding some JavaDoc to define them.", "author": "ajsutton", "createdAt": "2020-08-11T20:21:15Z", "path": "storage/src/main/java/tech/pegasys/teku/storage/client/CombinedChainDataClient.java", "diffHunk": "@@ -333,10 +334,22 @@ public boolean isChainDataFullyAvailable() {\n     return result;\n   }\n \n-  public UInt64 getBestSlot() {\n+  public UInt64 getHeadSlot() {\n     return this.recentChainData.getBestSlot();", "originalCommit": "d66bb78aa5c85228e4d2be3c87018460571aab30", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODg0ODI4Nw==", "url": "https://github.com/ConsenSys/teku/pull/2555#discussion_r468848287", "bodyText": "Yeah, I've thought about doing this several times and just avoided it because of the noise, but worth doing here since its kind of topical.", "author": "mbaxter", "createdAt": "2020-08-11T20:33:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODg0MTQwMQ=="}], "type": "inlineReview", "revised_code": {"commit": "7085d19831ced27f51f47fd61b68e00a2b5c0bb4", "chunk": "diff --git a/storage/src/main/java/tech/pegasys/teku/storage/client/CombinedChainDataClient.java b/storage/src/main/java/tech/pegasys/teku/storage/client/CombinedChainDataClient.java\nindex 2f9ec4a5ec..404546afd7 100644\n--- a/storage/src/main/java/tech/pegasys/teku/storage/client/CombinedChainDataClient.java\n+++ b/storage/src/main/java/tech/pegasys/teku/storage/client/CombinedChainDataClient.java\n\n@@ -334,18 +334,22 @@ public class CombinedChainDataClient {\n     return result;\n   }\n \n+  /** @return The slot at which the chain head block was proposed */\n   public UInt64 getHeadSlot() {\n-    return this.recentChainData.getBestSlot();\n+    return this.recentChainData.getHeadSlot();\n   }\n \n+  /** @return The epoch in which the chain head block was proposed */\n   public UInt64 getHeadEpoch() {\n     return compute_epoch_at_slot(getHeadSlot());\n   }\n \n+  /** @return The current slot according to clock time */\n   public UInt64 getCurrentSlot() {\n     return this.recentChainData.getCurrentSlot().orElseGet(this::getHeadSlot);\n   }\n \n+  /** @return The current epoch according to clock time */\n   public UInt64 getCurrentEpoch() {\n     return compute_epoch_at_slot(getCurrentSlot());\n   }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODg0Mjc0Ng==", "url": "https://github.com/ConsenSys/teku/pull/2555#discussion_r468842746", "bodyText": "I'd extract getCurrentSyncState to a variable so we have a consistent view of it rather than it potentially changing part way through this logic (should still work out fine but is easier to reason about if its fixed).", "author": "ajsutton", "createdAt": "2020-08-11T20:23:51Z", "path": "validator/coordinator/src/main/java/tech/pegasys/teku/validator/coordinator/ValidatorApiHandler.java", "diffHunk": "@@ -307,8 +308,16 @@ public void sendSignedBlock(final SignedBeaconBlock block) {\n     eventBus.post(new ProposedBlockEvent(block));\n   }\n \n-  private boolean isSyncActive() {\n-    return !syncStateTracker.getCurrentSyncState().isInSync();\n+  @VisibleForTesting\n+  boolean isSyncActive() {\n+    return syncStateTracker.getCurrentSyncState().isStartingUp()\n+        || (syncStateTracker.getCurrentSyncState().isSyncing() && headBlockIsTooFarBehind());", "originalCommit": "d66bb78aa5c85228e4d2be3c87018460571aab30", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "92c3c7f76b4f48c14619304508cb828149c77369", "chunk": "diff --git a/validator/coordinator/src/main/java/tech/pegasys/teku/validator/coordinator/ValidatorApiHandler.java b/validator/coordinator/src/main/java/tech/pegasys/teku/validator/coordinator/ValidatorApiHandler.java\nindex 1d0652c7c6..03a0290c4c 100644\n--- a/validator/coordinator/src/main/java/tech/pegasys/teku/validator/coordinator/ValidatorApiHandler.java\n+++ b/validator/coordinator/src/main/java/tech/pegasys/teku/validator/coordinator/ValidatorApiHandler.java\n\n@@ -310,8 +311,8 @@ public class ValidatorApiHandler implements ValidatorApiChannel {\n \n   @VisibleForTesting\n   boolean isSyncActive() {\n-    return syncStateTracker.getCurrentSyncState().isStartingUp()\n-        || (syncStateTracker.getCurrentSyncState().isSyncing() && headBlockIsTooFarBehind());\n+    final SyncState syncState = syncStateTracker.getCurrentSyncState();\n+    return syncState.isStartingUp() || (syncState.isSyncing() && headBlockIsTooFarBehind());\n   }\n \n   private boolean headBlockIsTooFarBehind() {\n"}}, {"oid": "98aea18ddc3d9b758db6c467c4cf566c30df724f", "url": "https://github.com/ConsenSys/teku/commit/98aea18ddc3d9b758db6c467c4cf566c30df724f", "message": "Merge branch 'master' into issue-2438/double-check-head-slot-before-skipping-duties", "committedDate": "2020-08-11T21:26:49Z", "type": "commit"}, {"oid": "92c3c7f76b4f48c14619304508cb828149c77369", "url": "https://github.com/ConsenSys/teku/commit/92c3c7f76b4f48c14619304508cb828149c77369", "message": "Extract syncState to a variable for clarity", "committedDate": "2020-08-11T21:29:14Z", "type": "commit"}, {"oid": "7085d19831ced27f51f47fd61b68e00a2b5c0bb4", "url": "https://github.com/ConsenSys/teku/commit/7085d19831ced27f51f47fd61b68e00a2b5c0bb4", "message": "Rework naming conventions related to head block data", "committedDate": "2020-08-11T21:46:50Z", "type": "commit"}]}