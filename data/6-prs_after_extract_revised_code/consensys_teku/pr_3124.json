{"pr_number": 3124, "pr_title": "Migrate away from protoarray snapshots", "pr_createdAt": "2020-11-02T07:06:28Z", "pr_url": "https://github.com/ConsenSys/teku/pull/3124", "timeline": [{"oid": "22dabb067bb95eee134f66343d1ee51e73d7f8f2", "url": "https://github.com/ConsenSys/teku/commit/22dabb067bb95eee134f66343d1ee51e73d7f8f2", "message": "Store checkpoint epochs with new blocks.\nLoad full block information when creating store. Currently still loading protoarray from snapshot and no migration.", "committedDate": "2020-11-02T05:48:01Z", "type": "commit"}, {"oid": "22b95878d483eedf7d8b611d763a933a9489a18a", "url": "https://github.com/ConsenSys/teku/commit/22b95878d483eedf7d8b611d763a933a9489a18a", "message": "Load protoarray from same block information used for store.\nAdd migration to store checkpoint epochs when not already present.", "committedDate": "2020-11-02T06:55:49Z", "type": "commit"}, {"oid": "d449e30ea4210318a1303258ffeb7e7b7e7e45df", "url": "https://github.com/ConsenSys/teku/commit/d449e30ea4210318a1303258ffeb7e7b7e7e45df", "message": "Delete protoarray snapshot after migration.", "committedDate": "2020-11-02T07:01:32Z", "type": "commit"}, {"oid": "f872514e00d0d8eb32e4faf04f1300283169e982", "url": "https://github.com/ConsenSys/teku/commit/f872514e00d0d8eb32e4faf04f1300283169e982", "message": "Update tests.", "committedDate": "2020-11-02T07:24:57Z", "type": "commit"}, {"oid": "227af7ff8392a8bb78057d58f833395e48a21704", "url": "https://github.com/ConsenSys/teku/commit/227af7ff8392a8bb78057d58f833395e48a21704", "message": "Merge branch 'master' of github.com:ConsenSys/teku into no-proto-snapshots", "committedDate": "2020-11-02T07:25:04Z", "type": "commit"}, {"oid": "8b863ef19023f1b1e30bf1eab8d11df5c728f701", "url": "https://github.com/ConsenSys/teku/commit/8b863ef19023f1b1e30bf1eab8d11df5c728f701", "message": "Merge branch 'master' of github.com:ConsenSys/teku into no-proto-snapshots", "committedDate": "2020-11-02T20:17:13Z", "type": "commit"}, {"oid": "6c4e7f68c1117021d9a351a11558603da0e67bb7", "url": "https://github.com/ConsenSys/teku/commit/6c4e7f68c1117021d9a351a11558603da0e67bb7", "message": "Merge branch 'master' of github.com:ConsenSys/teku into no-proto-snapshots", "committedDate": "2020-11-02T20:20:22Z", "type": "commit"}, {"oid": "7e388758d187eeded56f6bdf16d28b2d637686ca", "url": "https://github.com/ConsenSys/teku/commit/7e388758d187eeded56f6bdf16d28b2d637686ca", "message": "Add more tests.", "committedDate": "2020-11-03T00:36:26Z", "type": "commit"}, {"oid": "4efe624f6c0da7c6a250e5e949b2e849b4dac433", "url": "https://github.com/ConsenSys/teku/commit/4efe624f6c0da7c6a250e5e949b2e849b4dac433", "message": "Errorprone.", "committedDate": "2020-11-03T00:50:31Z", "type": "commit"}, {"oid": "a3d970957358c47a20ae4aea13973bb6628aa6e7", "url": "https://github.com/ConsenSys/teku/commit/a3d970957358c47a20ae4aea13973bb6628aa6e7", "message": "Merge branch 'master' of github.com:ConsenSys/teku into no-proto-snapshots\n\n# Conflicts:\n#\tstorage/src/main/java/tech/pegasys/teku/storage/server/rocksdb/RocksDbDatabase.java\n#\tstorage/src/main/java/tech/pegasys/teku/storage/store/StoreBuilder.java", "committedDate": "2020-11-03T01:10:55Z", "type": "commit"}, {"oid": "17f0484f9ad1d03f09d6d1d9437651265ea09c4e", "url": "https://github.com/ConsenSys/teku/commit/17f0484f9ad1d03f09d6d1d9437651265ea09c4e", "message": "Merge branch 'master' of github.com:ConsenSys/teku into no-proto-snapshots", "committedDate": "2020-11-03T20:52:06Z", "type": "commit"}, {"oid": "0b6832b795a29d71493de05f257c436e9cf5396d", "url": "https://github.com/ConsenSys/teku/commit/0b6832b795a29d71493de05f257c436e9cf5396d", "message": "Merge branch 'master' into no-proto-snapshots", "committedDate": "2020-11-04T00:47:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzUzOTI0OQ==", "url": "https://github.com/ConsenSys/teku/pull/3124#discussion_r517539249", "bodyText": "I think this should be:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                          new CheckpointEpochs(anchorCheckpoint.getEpoch(), anchorCheckpoint.getEpoch())));\n          \n          \n            \n                          new CheckpointEpochs(anchorState.getCurrent_justified_checkpoint().getEpoch(), anchorState.getFinalized_checkpoint().getEpoch())));", "author": "mbaxter", "createdAt": "2020-11-04T18:14:20Z", "path": "storage/src/main/java/tech/pegasys/teku/storage/server/rocksdb/RocksDbDatabase.java", "diffHunk": "@@ -207,7 +210,10 @@ public void storeInitialAnchor(final AnchorPoint anchor) {\n       // We need to store the anchor block in both hot and cold storage so that on restart\n       // we're guaranteed to have at least one block / state to load into RecentChainData.\n       // Save to hot storage\n-      hotUpdater.addHotBlock(anchorBlock);\n+      hotUpdater.addHotBlock(\n+          new BlockAndCheckpointEpochs(\n+              anchorBlock,\n+              new CheckpointEpochs(anchorCheckpoint.getEpoch(), anchorCheckpoint.getEpoch())));", "originalCommit": "0b6832b795a29d71493de05f257c436e9cf5396d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a70710c0eae3dc06d34f9844c22a3d1d4a1165a4", "chunk": "diff --git a/storage/src/main/java/tech/pegasys/teku/storage/server/rocksdb/RocksDbDatabase.java b/storage/src/main/java/tech/pegasys/teku/storage/server/rocksdb/RocksDbDatabase.java\nindex ffa30c5ff..c95706949 100644\n--- a/storage/src/main/java/tech/pegasys/teku/storage/server/rocksdb/RocksDbDatabase.java\n+++ b/storage/src/main/java/tech/pegasys/teku/storage/server/rocksdb/RocksDbDatabase.java\n\n@@ -213,7 +207,9 @@ public class RocksDbDatabase implements Database {\n       hotUpdater.addHotBlock(\n           new BlockAndCheckpointEpochs(\n               anchorBlock,\n-              new CheckpointEpochs(anchorCheckpoint.getEpoch(), anchorCheckpoint.getEpoch())));\n+              new CheckpointEpochs(\n+                  anchorState.getCurrent_justified_checkpoint().getEpoch(),\n+                  anchorState.getFinalized_checkpoint().getEpoch())));\n       // Save to cold storage\n       finalizedUpdater.addFinalizedBlock(anchorBlock);\n       putFinalizedState(finalizedUpdater, anchorRoot, anchorState);\n"}}, {"oid": "a70710c0eae3dc06d34f9844c22a3d1d4a1165a4", "url": "https://github.com/ConsenSys/teku/commit/a70710c0eae3dc06d34f9844c22a3d1d4a1165a4", "message": "Fix checkpoint epochs from anchor state.", "committedDate": "2020-11-04T21:04:46Z", "type": "commit"}, {"oid": "8ab40848a47802d5cb1f92ac9e3901406da4e786", "url": "https://github.com/ConsenSys/teku/commit/8ab40848a47802d5cb1f92ac9e3901406da4e786", "message": "Merge branch 'master' of github.com:ConsenSys/teku into no-proto-snapshots", "committedDate": "2020-11-04T21:05:13Z", "type": "commit"}, {"oid": "1c07c9044cbf7e29241e5bf4e04d0d82da9d1b6c", "url": "https://github.com/ConsenSys/teku/commit/1c07c9044cbf7e29241e5bf4e04d0d82da9d1b6c", "message": "Spotless.", "committedDate": "2020-11-04T21:05:27Z", "type": "commit"}, {"oid": "4ec60663ff2c6ec2e06c4f9487a5c848b8c46569", "url": "https://github.com/ConsenSys/teku/commit/4ec60663ff2c6ec2e06c4f9487a5c848b8c46569", "message": "Merge branch 'no-proto-snapshots' of github.com:ajsutton/teku into no-proto-snapshots", "committedDate": "2020-11-04T21:07:42Z", "type": "commit"}, {"oid": "4c9ada95a6418f73faa877aad163435a01003897", "url": "https://github.com/ConsenSys/teku/commit/4c9ada95a6418f73faa877aad163435a01003897", "message": "Merge branch 'master' into no-proto-snapshots", "committedDate": "2020-11-05T00:43:59Z", "type": "commit"}, {"oid": "e260bc9e5f531f30cfd6fec023863c347955f10a", "url": "https://github.com/ConsenSys/teku/commit/e260bc9e5f531f30cfd6fec023863c347955f10a", "message": "Merge branch 'master' into no-proto-snapshots", "committedDate": "2020-11-05T03:09:14Z", "type": "commit"}]}