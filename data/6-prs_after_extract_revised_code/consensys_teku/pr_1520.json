{"pr_number": 1520, "pr_title": "Implement validator duties", "pr_createdAt": "2020-04-01T05:20:01Z", "pr_url": "https://github.com/ConsenSys/teku/pull/1520", "timeline": [{"oid": "c124f2ec7bc6359fc2437c71ed5fa9a74614a655", "url": "https://github.com/ConsenSys/teku/commit/c124f2ec7bc6359fc2437c71ed5fa9a74614a655", "message": "Add getFork() to ValidatorApiChannel.", "committedDate": "2020-03-27T01:36:23Z", "type": "commit"}, {"oid": "8bacb6c7f2161e437599855d2976c3c82163e286", "url": "https://github.com/ConsenSys/teku/commit/8bacb6c7f2161e437599855d2976c3c82163e286", "message": "Add sendSignedAttestation to ValidatorApiChannel.", "committedDate": "2020-03-27T01:56:22Z", "type": "commit"}, {"oid": "fad1b2967cbc30b7fe1ae181288f2fcd90b50bed", "url": "https://github.com/ConsenSys/teku/commit/fad1b2967cbc30b7fe1ae181288f2fcd90b50bed", "message": "Add sendSignedBlock to ValidatorApiChannel.", "committedDate": "2020-03-27T02:04:24Z", "type": "commit"}, {"oid": "ca7bd414ad3ae9b8785ed0525c9d6cc410271e87", "url": "https://github.com/ConsenSys/teku/commit/ca7bd414ad3ae9b8785ed0525c9d6cc410271e87", "message": "Fix unit test.", "committedDate": "2020-03-27T03:21:00Z", "type": "commit"}, {"oid": "de93afd44ccf88218c60a7c9d487a4d476f188ae", "url": "https://github.com/ConsenSys/teku/commit/de93afd44ccf88218c60a7c9d487a4d476f188ae", "message": "Compare signatures on submitted attestations to 0 as the empty signature isn't valid so can't be compared with equals.", "committedDate": "2020-03-27T03:33:05Z", "type": "commit"}, {"oid": "0678b3b55a9173932255df7a8418bdc91ac84f71", "url": "https://github.com/ConsenSys/teku/commit/0678b3b55a9173932255df7a8418bdc91ac84f71", "message": "Test that empty signature is rejected.", "committedDate": "2020-03-27T03:37:45Z", "type": "commit"}, {"oid": "bb558516bb7c79b17328f42cc0b73d40bb30fd00", "url": "https://github.com/ConsenSys/teku/commit/bb558516bb7c79b17328f42cc0b73d40bb30fd00", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into add-get-fork", "committedDate": "2020-03-27T03:39:29Z", "type": "commit"}, {"oid": "35c110a41067d72e7c31bdd9342a57cf4663bf4a", "url": "https://github.com/ConsenSys/teku/commit/35c110a41067d72e7c31bdd9342a57cf4663bf4a", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into add-validator-client", "committedDate": "2020-03-28T09:29:57Z", "type": "commit"}, {"oid": "b8cc57fcaa17401a39f0e3b98b209b48e498f3ce", "url": "https://github.com/ConsenSys/teku/commit/b8cc57fcaa17401a39f0e3b98b209b48e498f3ce", "message": "Add validator client service and duty scheduler.", "committedDate": "2020-03-29T21:40:51Z", "type": "commit"}, {"oid": "4a979ca12013de31290d9c64d91a14996150374b", "url": "https://github.com/ConsenSys/teku/commit/4a979ca12013de31290d9c64d91a14996150374b", "message": "Load validators into ValidatorClientService.", "committedDate": "2020-03-29T23:49:23Z", "type": "commit"}, {"oid": "495c6f30e9c406116c79ff4ff08dc4df545d565c", "url": "https://github.com/ConsenSys/teku/commit/495c6f30e9c406116c79ff4ff08dc4df545d565c", "message": "Add timeout for requests to get duties.", "committedDate": "2020-03-29T23:52:59Z", "type": "commit"}, {"oid": "bfb32e8ff216cdd137b85092145dbb074c61b22d", "url": "https://github.com/ConsenSys/teku/commit/bfb32e8ff216cdd137b85092145dbb074c61b22d", "message": "Move test resources.", "committedDate": "2020-03-30T02:35:05Z", "type": "commit"}, {"oid": "103fd99ec4a3c328339c0be64523182ca9649af7", "url": "https://github.com/ConsenSys/teku/commit/103fd99ec4a3c328339c0be64523182ca9649af7", "message": "Load validators into ValidatorClientService.", "committedDate": "2020-03-30T02:41:52Z", "type": "commit"}, {"oid": "a53a42ef4978f842d4219b65a7a65bfeaa857890", "url": "https://github.com/ConsenSys/teku/commit/a53a42ef4978f842d4219b65a7a65bfeaa857890", "message": "Move test resources.", "committedDate": "2020-03-30T02:41:54Z", "type": "commit"}, {"oid": "28aa2a0af8394ca8ce32e209ef23b78f8e7c748f", "url": "https://github.com/ConsenSys/teku/commit/28aa2a0af8394ca8ce32e209ef23b78f8e7c748f", "message": "Move all production signing root calculation and signing to Signer.", "committedDate": "2020-03-30T03:37:12Z", "type": "commit"}, {"oid": "e97e0eaeed6f27e96604c1a31ed20c29c46ac530", "url": "https://github.com/ConsenSys/teku/commit/e97e0eaeed6f27e96604c1a31ed20c29c46ac530", "message": "Move test signing to Signer.", "committedDate": "2020-03-30T03:45:35Z", "type": "commit"}, {"oid": "3bb32a55ca31d259d813102bc453dcc6460e0f36", "url": "https://github.com/ConsenSys/teku/commit/3bb32a55ca31d259d813102bc453dcc6460e0f36", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into introducer-signer", "committedDate": "2020-03-30T03:48:56Z", "type": "commit"}, {"oid": "4a722547aa7fe5cba14b733d77ccecfc28ee54f9", "url": "https://github.com/ConsenSys/teku/commit/4a722547aa7fe5cba14b733d77ccecfc28ee54f9", "message": "Add an integration test.", "committedDate": "2020-03-30T03:50:17Z", "type": "commit"}, {"oid": "bc1a30f6571046af70ce5f7ca4fa512ec250d2ea", "url": "https://github.com/ConsenSys/teku/commit/bc1a30f6571046af70ce5f7ca4fa512ec250d2ea", "message": "Spotless.", "committedDate": "2020-03-30T03:54:23Z", "type": "commit"}, {"oid": "18024ab10ed399c1fe26f9807a06b73ed22aef2b", "url": "https://github.com/ConsenSys/teku/commit/18024ab10ed399c1fe26f9807a06b73ed22aef2b", "message": "Go back to loading a map of validators.", "committedDate": "2020-03-30T04:06:04Z", "type": "commit"}, {"oid": "419aa31b593d4951b40cd279e199f7620d08f66f", "url": "https://github.com/ConsenSys/teku/commit/419aa31b593d4951b40cd279e199f7620d08f66f", "message": "Merge branch 'introducer-signer' into validator-split", "committedDate": "2020-03-30T04:19:06Z", "type": "commit"}, {"oid": "4d4552a3be9f2d090aa55a7cef9376d8775dbb53", "url": "https://github.com/ConsenSys/teku/commit/4d4552a3be9f2d090aa55a7cef9376d8775dbb53", "message": "Move signing classes to a signer package.", "committedDate": "2020-03-30T04:22:33Z", "type": "commit"}, {"oid": "d04258139ebdc8d2c2c5258dafa5cef053c1aefe", "url": "https://github.com/ConsenSys/teku/commit/d04258139ebdc8d2c2c5258dafa5cef053c1aefe", "message": "Spotless.", "committedDate": "2020-03-30T04:25:45Z", "type": "commit"}, {"oid": "042933fb115a9ebfe8ea46c867674a44e6586ceb", "url": "https://github.com/ConsenSys/teku/commit/042933fb115a9ebfe8ea46c867674a44e6586ceb", "message": "Merge branch 'introducer-signer' into validator-split", "committedDate": "2020-03-30T04:25:59Z", "type": "commit"}, {"oid": "378b4cc2c14723c53a82c402696f9b4b51e05d70", "url": "https://github.com/ConsenSys/teku/commit/378b4cc2c14723c53a82c402696f9b4b51e05d70", "message": "Update imports.", "committedDate": "2020-03-30T04:28:26Z", "type": "commit"}, {"oid": "8994bd67bf49344843db9ecfd3e15a329ed8491d", "url": "https://github.com/ConsenSys/teku/commit/8994bd67bf49344843db9ecfd3e15a329ed8491d", "message": "Spotless.", "committedDate": "2020-03-30T05:05:40Z", "type": "commit"}, {"oid": "a509bd7c2aaf577783795edc68f0528a8a9e6bec", "url": "https://github.com/ConsenSys/teku/commit/a509bd7c2aaf577783795edc68f0528a8a9e6bec", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into validator-split", "committedDate": "2020-03-30T21:30:04Z", "type": "commit"}, {"oid": "54aec2a92b10f4efdd1b52bb3a9240790738f536", "url": "https://github.com/ConsenSys/teku/commit/54aec2a92b10f4efdd1b52bb3a9240790738f536", "message": "Handle epoch changes as part of slot processing so we catch up on epoch events even if we miss the first slot of the epoch.", "committedDate": "2020-03-31T00:26:20Z", "type": "commit"}, {"oid": "4fdcc27511d8122c2647f47ad3ec09474341d187", "url": "https://github.com/ConsenSys/teku/commit/4fdcc27511d8122c2647f47ad3ec09474341d187", "message": "Add ForkProvider to be able to load the current fork.", "committedDate": "2020-03-31T02:53:19Z", "type": "commit"}, {"oid": "0b8b1ef76f2131a1207150dade25b25242b12a6e", "url": "https://github.com/ConsenSys/teku/commit/0b8b1ef76f2131a1207150dade25b25242b12a6e", "message": "Remove unused variable.", "committedDate": "2020-03-31T02:54:16Z", "type": "commit"}, {"oid": "cbf6e7ad9a61bf10d9facef9bb04a3e62ac58ce0", "url": "https://github.com/ConsenSys/teku/commit/cbf6e7ad9a61bf10d9facef9bb04a3e62ac58ce0", "message": "Quick and dirty implementation of BlockProductionDuty and AttestationProductionDuty", "committedDate": "2020-03-31T03:28:19Z", "type": "commit"}, {"oid": "f18054414d1f6edc2e0b7771fb94a07805f1640d", "url": "https://github.com/ConsenSys/teku/commit/f18054414d1f6edc2e0b7771fb94a07805f1640d", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into validator-split", "committedDate": "2020-03-31T23:20:19Z", "type": "commit"}, {"oid": "7b0ae55a20cb4eff1130e65a0abd72aa6744cbc9", "url": "https://github.com/ConsenSys/teku/commit/7b0ae55a20cb4eff1130e65a0abd72aa6744cbc9", "message": "Uncomment.", "committedDate": "2020-03-31T23:31:08Z", "type": "commit"}, {"oid": "7cc7eb15850f1498c5a9ac0b2a2af516f0db7956", "url": "https://github.com/ConsenSys/teku/commit/7cc7eb15850f1498c5a9ac0b2a2af516f0db7956", "message": "Remove EventBusAdapter it's been replaced by BeaconChainEventAdapter.", "committedDate": "2020-04-01T00:11:27Z", "type": "commit"}, {"oid": "cfde8713a275474f949ea807115a86b3d7bec037", "url": "https://github.com/ConsenSys/teku/commit/cfde8713a275474f949ea807115a86b3d7bec037", "message": "Modify allOf to capture all errors thrown by the futures, not just the first.", "committedDate": "2020-04-01T02:16:23Z", "type": "commit"}, {"oid": "258fbd6314bde1c67d85dcf9b67887243849d469", "url": "https://github.com/ConsenSys/teku/commit/258fbd6314bde1c67d85dcf9b67887243849d469", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into validator-split", "committedDate": "2020-04-01T03:14:02Z", "type": "commit"}, {"oid": "563d3283d74ea7402b7e27fef577e0c2dbe36e20", "url": "https://github.com/ConsenSys/teku/commit/563d3283d74ea7402b7e27fef577e0c2dbe36e20", "message": "Add tests for AttestationProductionDuty.", "committedDate": "2020-04-01T03:38:07Z", "type": "commit"}, {"oid": "a3c73d92cd4052840d48ee9447eec93829b53478", "url": "https://github.com/ConsenSys/teku/commit/a3c73d92cd4052840d48ee9447eec93829b53478", "message": "Toggle off.", "committedDate": "2020-04-01T03:38:35Z", "type": "commit"}, {"oid": "a5db812df26afde2a8f745b477307adf3b7656e9", "url": "https://github.com/ConsenSys/teku/commit/a5db812df26afde2a8f745b477307adf3b7656e9", "message": "Fix tests.", "committedDate": "2020-04-01T03:51:53Z", "type": "commit"}, {"oid": "f02162bd15e3bbc312d524e497d14e30dc726c19", "url": "https://github.com/ConsenSys/teku/commit/f02162bd15e3bbc312d524e497d14e30dc726c19", "message": "Disable block production in ValidatorCoordinator when validator client service is enabled.", "committedDate": "2020-04-01T04:02:57Z", "type": "commit"}, {"oid": "910ee05d706cd83a8ad82ba48f2449851582e1ab", "url": "https://github.com/ConsenSys/teku/commit/910ee05d706cd83a8ad82ba48f2449851582e1ab", "message": "Set attestation data index correctly when generating unsigned attestations.", "committedDate": "2020-04-01T04:44:40Z", "type": "commit"}, {"oid": "8ff16572646c8f09852fdee2681b1bb89aeb4445", "url": "https://github.com/ConsenSys/teku/commit/8ff16572646c8f09852fdee2681b1bb89aeb4445", "message": "Fix scheduling of duties when each slot in an epoch has been processed.", "committedDate": "2020-04-01T05:07:52Z", "type": "commit"}, {"oid": "7dfa7d84f51ea2fd1f41811f9fd1eeb3e3c606bc", "url": "https://github.com/ConsenSys/teku/commit/7dfa7d84f51ea2fd1f41811f9fd1eeb3e3c606bc", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into validator-split", "committedDate": "2020-04-01T05:08:34Z", "type": "commit"}, {"oid": "234aeb2d6514aea8c203071644351b63bd153b08", "url": "https://github.com/ConsenSys/teku/commit/234aeb2d6514aea8c203071644351b63bd153b08", "message": "Remove block production for now.", "committedDate": "2020-04-01T05:17:09Z", "type": "commit"}, {"oid": "e347d3d5192f8057f2924d3587405247af1214f0", "url": "https://github.com/ConsenSys/teku/commit/e347d3d5192f8057f2924d3587405247af1214f0", "message": "Revert \"Fix scheduling of duties when each slot in an epoch has been processed.\"\n\nThis reverts commit 8ff16572646c8f09852fdee2681b1bb89aeb4445.", "committedDate": "2020-04-01T05:17:43Z", "type": "commit"}, {"oid": "04bdb13c86be52824a08e0c082e94d39b04cef2a", "url": "https://github.com/ConsenSys/teku/commit/04bdb13c86be52824a08e0c082e94d39b04cef2a", "message": "Revert \"Disable block production in ValidatorCoordinator when validator client service is enabled.\"\n\nThis reverts commit f02162bd15e3bbc312d524e497d14e30dc726c19.", "committedDate": "2020-04-01T05:18:36Z", "type": "commit"}, {"oid": "fc0fa55857f63779e57bfc44599c2c1b9940ce31", "url": "https://github.com/ConsenSys/teku/commit/fc0fa55857f63779e57bfc44599c2c1b9940ce31", "message": "Revert \"Revert \"Disable block production in ValidatorCoordinator when validator client service is enabled.\"\"\n\nThis reverts commit 04bdb13c86be52824a08e0c082e94d39b04cef2a.", "committedDate": "2020-04-01T06:41:18Z", "type": "commit"}, {"oid": "2b11711ff56a8debf855bda69f661b1afcf46a70", "url": "https://github.com/ConsenSys/teku/commit/2b11711ff56a8debf855bda69f661b1afcf46a70", "message": "Revert \"Remove block production for now.\"\n\nThis reverts commit 234aeb2d6514aea8c203071644351b63bd153b08.", "committedDate": "2020-04-01T06:41:21Z", "type": "commit"}, {"oid": "5f6fc99fb2b4920a9a3f9fe49809c93dda72a5fd", "url": "https://github.com/ConsenSys/teku/commit/5f6fc99fb2b4920a9a3f9fe49809c93dda72a5fd", "message": "Add tests for block production.", "committedDate": "2020-04-01T06:41:26Z", "type": "commit"}, {"oid": "7fc4dab59a86c72ced3e648ef3b226cd465cce48", "url": "https://github.com/ConsenSys/teku/commit/7fc4dab59a86c72ced3e648ef3b226cd465cce48", "message": "Spotless.", "committedDate": "2020-04-01T06:45:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTc1NzkxMw==", "url": "https://github.com/ConsenSys/teku/pull/1520#discussion_r401757913", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private final Map<Integer, List<ValidatorWithCommitteePosition>> validators = new HashMap<>();\n          \n          \n            \n              private final Map<Integer, List<ValidatorWithCommitteePosition>> validatorsByCommitteeIndex = new HashMap<>();", "author": "mbaxter", "createdAt": "2020-04-01T16:44:03Z", "path": "validator/client/src/main/java/tech/pegasys/artemis/validator/client/duties/AttestationProductionDuty.java", "diffHunk": "@@ -13,29 +13,136 @@\n \n package tech.pegasys.artemis.validator.client.duties;\n \n+import static tech.pegasys.artemis.util.async.SafeFuture.failedFuture;\n+\n import com.google.common.primitives.UnsignedLong;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n import org.apache.logging.log4j.LogManager;\n import org.apache.logging.log4j.Logger;\n+import tech.pegasys.artemis.datastructures.operations.Attestation;\n+import tech.pegasys.artemis.datastructures.state.Fork;\n+import tech.pegasys.artemis.util.SSZTypes.Bitlist;\n+import tech.pegasys.artemis.util.async.SafeFuture;\n+import tech.pegasys.artemis.util.bls.BLSSignature;\n import tech.pegasys.artemis.validator.api.ValidatorApiChannel;\n import tech.pegasys.artemis.validator.client.ForkProvider;\n import tech.pegasys.artemis.validator.client.Validator;\n+import tech.pegasys.artemis.validator.client.signer.Signer;\n \n public class AttestationProductionDuty implements Duty {\n   private static final Logger LOG = LogManager.getLogger();\n+  private final Map<Integer, List<ValidatorWithCommitteePosition>> validators = new HashMap<>();", "originalCommit": "7fc4dab59a86c72ced3e648ef3b226cd465cce48", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg4MjMzOQ==", "url": "https://github.com/ConsenSys/teku/pull/1520#discussion_r401882339", "bodyText": "Good idea.", "author": "ajsutton", "createdAt": "2020-04-01T20:15:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTc1NzkxMw=="}], "type": "inlineReview", "revised_code": {"commit": "6466be44994e4a91785ac2baab29d6b7f6d2953d", "chunk": "diff --git a/validator/client/src/main/java/tech/pegasys/artemis/validator/client/duties/AttestationProductionDuty.java b/validator/client/src/main/java/tech/pegasys/artemis/validator/client/duties/AttestationProductionDuty.java\nindex e6e1aa2dc..ba40fd9b8 100644\n--- a/validator/client/src/main/java/tech/pegasys/artemis/validator/client/duties/AttestationProductionDuty.java\n+++ b/validator/client/src/main/java/tech/pegasys/artemis/validator/client/duties/AttestationProductionDuty.java\n\n@@ -34,7 +34,8 @@ import tech.pegasys.artemis.validator.client.signer.Signer;\n \n public class AttestationProductionDuty implements Duty {\n   private static final Logger LOG = LogManager.getLogger();\n-  private final Map<Integer, List<ValidatorWithCommitteePosition>> validators = new HashMap<>();\n+  private final Map<Integer, List<ValidatorWithCommitteePosition>> validatorsByCommitteeIndex =\n+      new HashMap<>();\n   private final UnsignedLong slot;\n   private final ForkProvider forkProvider;\n   private final ValidatorApiChannel validatorApiChannel;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTc1ODYzNg==", "url": "https://github.com/ConsenSys/teku/pull/1520#discussion_r401758636", "bodyText": "Did you mean to keep this log?", "author": "mbaxter", "createdAt": "2020-04-01T16:45:13Z", "path": "validator/client/src/main/java/tech/pegasys/artemis/validator/client/duties/BlockProductionDuty.java", "diffHunk": "@@ -24,18 +32,52 @@\n   private static final Logger LOG = LogManager.getLogger();\n   private final Validator validator;\n   private final UnsignedLong slot;\n+  private final ForkProvider forkProvider;\n+  private final ValidatorApiChannel validatorApiChannel;\n \n   public BlockProductionDuty(\n       final Validator validator,\n       final UnsignedLong slot,\n       final ForkProvider forkProvider,\n       final ValidatorApiChannel validatorApiChannel) {\n+    LOG.trace(\"Created\");", "originalCommit": "7fc4dab59a86c72ced3e648ef3b226cd465cce48", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg4MjI3OA==", "url": "https://github.com/ConsenSys/teku/pull/1520#discussion_r401882278", "bodyText": "Nope, removed.", "author": "ajsutton", "createdAt": "2020-04-01T20:15:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTc1ODYzNg=="}], "type": "inlineReview", "revised_code": {"commit": "6466be44994e4a91785ac2baab29d6b7f6d2953d", "chunk": "diff --git a/validator/client/src/main/java/tech/pegasys/artemis/validator/client/duties/BlockProductionDuty.java b/validator/client/src/main/java/tech/pegasys/artemis/validator/client/duties/BlockProductionDuty.java\nindex 18e328f1f..860d78e4e 100644\n--- a/validator/client/src/main/java/tech/pegasys/artemis/validator/client/duties/BlockProductionDuty.java\n+++ b/validator/client/src/main/java/tech/pegasys/artemis/validator/client/duties/BlockProductionDuty.java\n\n@@ -40,7 +40,6 @@ public class BlockProductionDuty implements Duty {\n       final UnsignedLong slot,\n       final ForkProvider forkProvider,\n       final ValidatorApiChannel validatorApiChannel) {\n-    LOG.trace(\"Created\");\n     this.validator = validator;\n     this.slot = slot;\n     this.forkProvider = forkProvider;\n"}}, {"oid": "a6de945bee6af01b82603687250484cb189a1f48", "url": "https://github.com/ConsenSys/teku/commit/a6de945bee6af01b82603687250484cb189a1f48", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into create-attestations", "committedDate": "2020-04-01T19:58:11Z", "type": "commit"}, {"oid": "6466be44994e4a91785ac2baab29d6b7f6d2953d", "url": "https://github.com/ConsenSys/teku/commit/6466be44994e4a91785ac2baab29d6b7f6d2953d", "message": "Review fixes.", "committedDate": "2020-04-01T19:58:53Z", "type": "commit"}]}