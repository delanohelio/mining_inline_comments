{"pr_number": 2517, "pr_title": "limit parallel tasks when loading validators from keystore.", "pr_createdAt": "2020-08-06T03:51:47Z", "pr_url": "https://github.com/ConsenSys/teku/pull/2517", "timeline": [{"oid": "f6ad0c37fde991ed6998584ff21d5649aaacc40e", "url": "https://github.com/ConsenSys/teku/commit/f6ad0c37fde991ed6998584ff21d5649aaacc40e", "message": "limit parallel tasks when loading validators from keystore.\n\nFixes #2492\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-08-06T03:40:50Z", "type": "commit"}, {"oid": "cc506b9f4fa5849b8d5531dee640b46c1bfb0136", "url": "https://github.com/ConsenSys/teku/commit/cc506b9f4fa5849b8d5531dee640b46c1bfb0136", "message": "Merge remote-tracking branch 'upstream/master' into 2492", "committedDate": "2020-08-06T03:53:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjI3MzA0MA==", "url": "https://github.com/ConsenSys/teku/pull/2517#discussion_r466273040", "bodyText": "This is a bit of a \"magic number\", though probably safe. Each Scrypt keystore takes about 300MB, so four in parallel is 1200mb, which is as low as we realistically might want to set the heap size, I guess.\nFor reference, I played with some code like this, which works well, but didn't manage to convince myself that it was a good idea:\n    // This is a guess. Actual parameters seem to be in tech.pegasys.signers.bls.keystore.model.ScryptParam.java\n    // final long memoryPerThread = 300_000_000L;\n    final long memoryPerThread = 128L * 262_144L * 8L;\n    final long allocatedMemory = (Runtime.getRuntime().totalMemory()-Runtime.getRuntime().freeMemory());\n    final long presumableFreeMemory = Runtime.getRuntime().maxMemory() - allocatedMemory;\n    final int nThreads = (int) Math.max(1, Math.min(Runtime.getRuntime().availableProcessors(), (presumableFreeMemory / memoryPerThread)));\n\n    ForkJoinPool forkJoinPool = null;\n\n    try {\n\n      System.out.println(\"Available processors: \" + Runtime.getRuntime().availableProcessors());\n      System.out.println(\"Using \" + nThreads + \" threads to load validator keys\");\n      forkJoinPool = new ForkJoinPool(nThreads);\n\n      StatusLogger.STATUS_LOG.loadingValidators(keystorePasswordFilePairs.size());\n      // return distinct loaded key pairs\n      return forkJoinPool.submit(() -> keystorePasswordFilePairs.stream()\n              .parallel()\n              .map(pair -> loadBLSPrivateKey(pair.getLeft(), loadPassword(pair.getRight())))\n              .distinct()\n              .map(privKey -> new BLSKeyPair(BLSSecretKey.fromBytes(privKey)))\n              .collect(toList())).get();\netc...", "author": "benjaminion", "createdAt": "2020-08-06T09:24:19Z", "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/KeystoresValidatorKeyProvider.java", "diffHunk": "@@ -46,12 +52,35 @@\n \n     StatusLogger.STATUS_LOG.loadingValidators(keystorePasswordFilePairs.size());\n     // return distinct loaded key pairs\n-    return keystorePasswordFilePairs.stream()\n-        .parallel()\n-        .map(pair -> loadBLSPrivateKey(pair.getLeft(), loadPassword(pair.getRight())))\n-        .distinct()\n-        .map(privKey -> new BLSKeyPair(BLSSecretKey.fromBytes(privKey)))\n-        .collect(toList());\n+\n+    final ExecutorService executorService =\n+        Executors.newFixedThreadPool(Math.min(4, Runtime.getRuntime().availableProcessors()));", "originalCommit": "cc506b9f4fa5849b8d5531dee640b46c1bfb0136", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "775df9d03cb0b675b762c1be2b7716c80a477768", "url": "https://github.com/ConsenSys/teku/commit/775df9d03cb0b675b762c1be2b7716c80a477768", "message": "Merge remote-tracking branch 'upstream/master' into 2492", "committedDate": "2020-08-06T20:03:29Z", "type": "commit"}]}