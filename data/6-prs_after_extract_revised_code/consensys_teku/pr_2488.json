{"pr_number": 2488, "pr_title": "add rate limiting to peers, and implement for BlocksByRange and BlocksByRoot messages.", "pr_createdAt": "2020-07-31T05:47:49Z", "pr_url": "https://github.com/ConsenSys/teku/pull/2488", "timeline": [{"oid": "64ec3dee8a3447bac05c4e78c6af8adcdf4e809b", "url": "https://github.com/ConsenSys/teku/commit/64ec3dee8a3447bac05c4e78c6af8adcdf4e809b", "message": "add rate limiting to peers, and implement for BlocksByRange messages.\n\n - defaulted the limit per minute to 500 blocks.\n\n - if you are at the boundary (499) and request more, that request will be filled, but if you are at 500, and request any more you will get disconnected.\n\n - can alter limit by using --Xpeer-rate-limit=<NUMBER> if required.\n\n partially addresses #2481\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-07-31T05:46:13Z", "type": "commit"}, {"oid": "ba19b54083da5ecb0c27b1059db5931c3569f398", "url": "https://github.com/ConsenSys/teku/commit/ba19b54083da5ecb0c27b1059db5931c3569f398", "message": "Merge remote-tracking branch 'upstream/master' into 2481", "committedDate": "2020-07-31T21:43:00Z", "type": "commit"}, {"oid": "ddab301c5f6d302d2d921cccc1918b59c2326865", "url": "https://github.com/ConsenSys/teku/commit/ddab301c5f6d302d2d921cccc1918b59c2326865", "message": "add message limiting for blocksByRange\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-07-31T22:40:41Z", "type": "commit"}, {"oid": "87279c88e50669337b98520350ec3eca14667fdc", "url": "https://github.com/ConsenSys/teku/commit/87279c88e50669337b98520350ec3eca14667fdc", "message": "Merge remote-tracking branch 'upstream/master' into 2481", "committedDate": "2020-08-01T23:19:15Z", "type": "commit"}, {"oid": "c82e129e9b935d83d94145f95ed493f599b9011a", "url": "https://github.com/ConsenSys/teku/commit/c82e129e9b935d83d94145f95ed493f599b9011a", "message": "Merge remote-tracking branch 'upstream/master' into 2481", "committedDate": "2020-08-03T01:05:48Z", "type": "commit"}, {"oid": "622cef628698d1c5563cb0e629b483e3f10ebb17", "url": "https://github.com/ConsenSys/teku/commit/622cef628698d1c5563cb0e629b483e3f10ebb17", "message": "Merge remote-tracking branch 'upstream/master' into 2481", "committedDate": "2020-08-03T21:17:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzkyNTg1MA==", "url": "https://github.com/ConsenSys/teku/pull/2488#discussion_r463925850", "bodyText": "nit: int not Integer", "author": "ajsutton", "createdAt": "2020-08-01T05:33:24Z", "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/Eth2NetworkBuilder.java", "diffHunk": "@@ -74,6 +74,7 @@\n   private Duration eth2RpcPingInterval = DEFAULT_ETH2_RPC_PING_INTERVAL;\n   private int eth2RpcOutstandingPingThreshold = DEFAULT_ETH2_RPC_OUTSTANDING_PING_THRESHOLD;\n   private Duration eth2StatusUpdateInterval = DEFAULT_ETH2_STATUS_UPDATE_INTERVAL;\n+  private Integer peerRateLimit = 500;", "originalCommit": "ddab301c5f6d302d2d921cccc1918b59c2326865", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b1fc15ed12e09409385c95b6ff1b84d76553ffc1", "chunk": "diff --git a/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/Eth2NetworkBuilder.java b/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/Eth2NetworkBuilder.java\nindex 4683cfc2a8..8cc9c051cd 100644\n--- a/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/Eth2NetworkBuilder.java\n+++ b/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/Eth2NetworkBuilder.java\n\n@@ -74,7 +74,7 @@ public class Eth2NetworkBuilder {\n   private Duration eth2RpcPingInterval = DEFAULT_ETH2_RPC_PING_INTERVAL;\n   private int eth2RpcOutstandingPingThreshold = DEFAULT_ETH2_RPC_OUTSTANDING_PING_THRESHOLD;\n   private Duration eth2StatusUpdateInterval = DEFAULT_ETH2_STATUS_UPDATE_INTERVAL;\n-  private Integer peerRateLimit = 500;\n+  private int peerRateLimit = 500;\n \n   private Eth2NetworkBuilder() {}\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzkyNTg1NA==", "url": "https://github.com/ConsenSys/teku/pull/2488#discussion_r463925854", "bodyText": "int not Integer", "author": "ajsutton", "createdAt": "2020-08-01T05:33:31Z", "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/Eth2NetworkBuilder.java", "diffHunk": "@@ -167,6 +170,11 @@ public Eth2NetworkBuilder config(final NetworkConfig config) {\n     return this;\n   }\n \n+  public Eth2NetworkBuilder peerRateLimit(final Integer peerRateLimit) {\n+    this.peerRateLimit = peerRateLimit;\n+    return this;\n+  }\n+\n   public Eth2NetworkBuilder eth2Config(final Eth2Config eth2Config) {", "originalCommit": "ddab301c5f6d302d2d921cccc1918b59c2326865", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b1fc15ed12e09409385c95b6ff1b84d76553ffc1", "chunk": "diff --git a/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/Eth2NetworkBuilder.java b/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/Eth2NetworkBuilder.java\nindex 4683cfc2a8..8cc9c051cd 100644\n--- a/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/Eth2NetworkBuilder.java\n+++ b/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/Eth2NetworkBuilder.java\n\n@@ -170,7 +170,7 @@ public class Eth2NetworkBuilder {\n     return this;\n   }\n \n-  public Eth2NetworkBuilder peerRateLimit(final Integer peerRateLimit) {\n+  public Eth2NetworkBuilder peerRateLimit(final int peerRateLimit) {\n     this.peerRateLimit = peerRateLimit;\n     return this;\n   }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzkyNTg2Mg==", "url": "https://github.com/ConsenSys/teku/pull/2488#discussion_r463925862", "bodyText": "int not Integer", "author": "ajsutton", "createdAt": "2020-08-01T05:33:39Z", "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/peers/Eth2Peer.java", "diffHunk": "@@ -63,16 +64,20 @@\n   private final AtomicBoolean chainValidated = new AtomicBoolean(false);\n   private final AtomicInteger outstandingRequests = new AtomicInteger(0);\n   private final AtomicInteger outstandingPings = new AtomicInteger();\n+  private final RateTracker rateTracker;\n \n   public Eth2Peer(\n       final Peer peer,\n       final BeaconChainMethods rpcMethods,\n       final StatusMessageFactory statusMessageFactory,\n-      final MetadataMessagesFactory metadataMessagesFactory) {\n+      final MetadataMessagesFactory metadataMessagesFactory,\n+      final TimeProvider timeProvider,\n+      final Integer peerRateLimit) {", "originalCommit": "ddab301c5f6d302d2d921cccc1918b59c2326865", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b1fc15ed12e09409385c95b6ff1b84d76553ffc1", "chunk": "diff --git a/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/peers/Eth2Peer.java b/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/peers/Eth2Peer.java\nindex f54db27c70..297f682710 100644\n--- a/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/peers/Eth2Peer.java\n+++ b/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/peers/Eth2Peer.java\n\n@@ -72,7 +74,7 @@ public class Eth2Peer extends DelegatingPeer implements Peer {\n       final StatusMessageFactory statusMessageFactory,\n       final MetadataMessagesFactory metadataMessagesFactory,\n       final TimeProvider timeProvider,\n-      final Integer peerRateLimit) {\n+      final int peerRateLimit) {\n     super(peer);\n     this.rpcMethods = rpcMethods;\n     this.statusMessageFactory = statusMessageFactory;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzkyNTkxMw==", "url": "https://github.com/ConsenSys/teku/pull/2488#discussion_r463925913", "bodyText": "int not Integer", "author": "ajsutton", "createdAt": "2020-08-01T05:34:14Z", "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/peers/Eth2PeerFactory.java", "diffHunk": "@@ -17,20 +17,33 @@\n import tech.pegasys.teku.networking.eth2.rpc.beaconchain.methods.MetadataMessagesFactory;\n import tech.pegasys.teku.networking.eth2.rpc.beaconchain.methods.StatusMessageFactory;\n import tech.pegasys.teku.networking.p2p.peer.Peer;\n+import tech.pegasys.teku.util.time.TimeProvider;\n \n public class Eth2PeerFactory {\n \n   private final StatusMessageFactory statusMessageFactory;\n   private final MetadataMessagesFactory metadataMessagesFactory;\n+  private final TimeProvider timeProvider;\n+  private final Integer peerRateLimit;\n \n   public Eth2PeerFactory(\n       final StatusMessageFactory statusMessageFactory,\n-      final MetadataMessagesFactory metadataMessagesFactory) {\n+      final MetadataMessagesFactory metadataMessagesFactory,\n+      final TimeProvider timeProvider,\n+      final Integer peerRateLimit) {", "originalCommit": "ddab301c5f6d302d2d921cccc1918b59c2326865", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b1fc15ed12e09409385c95b6ff1b84d76553ffc1", "chunk": "diff --git a/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/peers/Eth2PeerFactory.java b/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/peers/Eth2PeerFactory.java\nindex 898fb09474..a3fc6cb0ec 100644\n--- a/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/peers/Eth2PeerFactory.java\n+++ b/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/peers/Eth2PeerFactory.java\n\n@@ -24,13 +24,13 @@ public class Eth2PeerFactory {\n   private final StatusMessageFactory statusMessageFactory;\n   private final MetadataMessagesFactory metadataMessagesFactory;\n   private final TimeProvider timeProvider;\n-  private final Integer peerRateLimit;\n+  private final int peerRateLimit;\n \n   public Eth2PeerFactory(\n       final StatusMessageFactory statusMessageFactory,\n       final MetadataMessagesFactory metadataMessagesFactory,\n       final TimeProvider timeProvider,\n-      final Integer peerRateLimit) {\n+      final int peerRateLimit) {\n     this.timeProvider = timeProvider;\n     this.statusMessageFactory = statusMessageFactory;\n     this.metadataMessagesFactory = metadataMessagesFactory;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzkyNTkxOA==", "url": "https://github.com/ConsenSys/teku/pull/2488#discussion_r463925918", "bodyText": "int not Integer", "author": "ajsutton", "createdAt": "2020-08-01T05:34:20Z", "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/peers/Eth2PeerFactory.java", "diffHunk": "@@ -17,20 +17,33 @@\n import tech.pegasys.teku.networking.eth2.rpc.beaconchain.methods.MetadataMessagesFactory;\n import tech.pegasys.teku.networking.eth2.rpc.beaconchain.methods.StatusMessageFactory;\n import tech.pegasys.teku.networking.p2p.peer.Peer;\n+import tech.pegasys.teku.util.time.TimeProvider;\n \n public class Eth2PeerFactory {\n \n   private final StatusMessageFactory statusMessageFactory;\n   private final MetadataMessagesFactory metadataMessagesFactory;\n+  private final TimeProvider timeProvider;\n+  private final Integer peerRateLimit;", "originalCommit": "ddab301c5f6d302d2d921cccc1918b59c2326865", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b1fc15ed12e09409385c95b6ff1b84d76553ffc1", "chunk": "diff --git a/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/peers/Eth2PeerFactory.java b/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/peers/Eth2PeerFactory.java\nindex 898fb09474..a3fc6cb0ec 100644\n--- a/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/peers/Eth2PeerFactory.java\n+++ b/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/peers/Eth2PeerFactory.java\n\n@@ -24,13 +24,13 @@ public class Eth2PeerFactory {\n   private final StatusMessageFactory statusMessageFactory;\n   private final MetadataMessagesFactory metadataMessagesFactory;\n   private final TimeProvider timeProvider;\n-  private final Integer peerRateLimit;\n+  private final int peerRateLimit;\n \n   public Eth2PeerFactory(\n       final StatusMessageFactory statusMessageFactory,\n       final MetadataMessagesFactory metadataMessagesFactory,\n       final TimeProvider timeProvider,\n-      final Integer peerRateLimit) {\n+      final int peerRateLimit) {\n     this.timeProvider = timeProvider;\n     this.statusMessageFactory = statusMessageFactory;\n     this.metadataMessagesFactory = metadataMessagesFactory;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzkyNTkyNQ==", "url": "https://github.com/ConsenSys/teku/pull/2488#discussion_r463925925", "bodyText": "int not Integer", "author": "ajsutton", "createdAt": "2020-08-01T05:34:35Z", "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/peers/Eth2PeerManager.java", "diffHunk": "@@ -104,7 +105,9 @@ public static Eth2PeerManager create(\n       final RpcEncoding rpcEncoding,\n       final Duration eth2RpcPingInterval,\n       final int eth2RpcOutstandingPingThreshold,\n-      Duration eth2StatusUpdateInterval) {\n+      final Duration eth2StatusUpdateInterval,\n+      final TimeProvider timeProvider,\n+      final Integer peerRateLimit) {", "originalCommit": "ddab301c5f6d302d2d921cccc1918b59c2326865", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b1fc15ed12e09409385c95b6ff1b84d76553ffc1", "chunk": "diff --git a/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/peers/Eth2PeerManager.java b/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/peers/Eth2PeerManager.java\nindex 274c7f52ff..b61ae7b0b5 100644\n--- a/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/peers/Eth2PeerManager.java\n+++ b/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/peers/Eth2PeerManager.java\n\n@@ -107,7 +107,7 @@ public class Eth2PeerManager implements PeerLookup, PeerHandler {\n       final int eth2RpcOutstandingPingThreshold,\n       final Duration eth2StatusUpdateInterval,\n       final TimeProvider timeProvider,\n-      final Integer peerRateLimit) {\n+      final int peerRateLimit) {\n \n     final PeerValidatorFactory peerValidatorFactory =\n         (peer, status) ->\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzkyNTk0OA==", "url": "https://github.com/ConsenSys/teku/pull/2488#discussion_r463925948", "bodyText": "long not Long", "author": "ajsutton", "createdAt": "2020-08-01T05:34:52Z", "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/peers/RateTracker.java", "diffHunk": "@@ -0,0 +1,58 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.networking.eth2.peers;\n+\n+import com.google.common.primitives.UnsignedLong;\n+import java.util.NavigableMap;\n+import java.util.TreeMap;\n+import tech.pegasys.teku.util.time.TimeProvider;\n+\n+public class RateTracker {\n+  private final NavigableMap<UnsignedLong, Long> requestCount;\n+  private final int peerRateLimit;\n+  private final UnsignedLong timeoutSeconds;\n+  private Long requestsWithinWindow;", "originalCommit": "ddab301c5f6d302d2d921cccc1918b59c2326865", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b1fc15ed12e09409385c95b6ff1b84d76553ffc1", "chunk": "diff --git a/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/peers/RateTracker.java b/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/peers/RateTracker.java\nindex 2fbebee9ac..30fec9289b 100644\n--- a/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/peers/RateTracker.java\n+++ b/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/peers/RateTracker.java\n\n@@ -22,7 +22,7 @@ public class RateTracker {\n   private final NavigableMap<UnsignedLong, Long> requestCount;\n   private final int peerRateLimit;\n   private final UnsignedLong timeoutSeconds;\n-  private Long requestsWithinWindow;\n+  private long requestsWithinWindow = 0L;\n   private final TimeProvider timeProvider;\n \n   public RateTracker(\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzkyNjE2Ng==", "url": "https://github.com/ConsenSys/teku/pull/2488#discussion_r463926166", "bodyText": "Given we wound up going through peer we should do the disconnect inside Eth2Peer and save duplicating the code.  Would still need to check if the result is 0.  And it probably could then throw the RpcException to automatically bail out - though would need to double check exactly how that gets handled.  Given we're disconnecting we don't need to send an error response at all.", "author": "ajsutton", "createdAt": "2020-08-01T05:38:11Z", "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/rpc/beaconchain/methods/BeaconBlocksByRangeMessageHandler.java", "diffHunk": "@@ -73,6 +74,12 @@ public void onIncomingMessage(\n               \"Only a maximum of \" + MAX_REQUEST_BLOCKS + \" blocks can be requested per request\"));\n       return;\n     }\n+    if (peer.wantToReceiveObjects(min(maxRequestSize, message.getCount()).longValue()) == 0L) {\n+      LOG.debug(\"Peer {} disconnected due to rate limits\", peer.getId());\n+      peer.disconnectCleanly(DisconnectReason.RATE_LIMITING);\n+      callback.completeWithErrorResponse(new RpcException(INVALID_REQUEST_CODE, \"rate limited\"));\n+      return;\n+    }", "originalCommit": "ddab301c5f6d302d2d921cccc1918b59c2326865", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b1fc15ed12e09409385c95b6ff1b84d76553ffc1", "chunk": "diff --git a/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/rpc/beaconchain/methods/BeaconBlocksByRangeMessageHandler.java b/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/rpc/beaconchain/methods/BeaconBlocksByRangeMessageHandler.java\nindex 15e3ed5224..a545bb4a8d 100644\n--- a/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/rpc/beaconchain/methods/BeaconBlocksByRangeMessageHandler.java\n+++ b/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/rpc/beaconchain/methods/BeaconBlocksByRangeMessageHandler.java\n\n@@ -74,12 +73,10 @@ public class BeaconBlocksByRangeMessageHandler\n               \"Only a maximum of \" + MAX_REQUEST_BLOCKS + \" blocks can be requested per request\"));\n       return;\n     }\n-    if (peer.wantToReceiveObjects(min(maxRequestSize, message.getCount()).longValue()) == 0L) {\n-      LOG.debug(\"Peer {} disconnected due to rate limits\", peer.getId());\n-      peer.disconnectCleanly(DisconnectReason.RATE_LIMITING);\n-      callback.completeWithErrorResponse(new RpcException(INVALID_REQUEST_CODE, \"rate limited\"));\n+    if (!peer.wantToReceiveObjects(callback, min(maxRequestSize, message.getCount()).longValue())) {\n       return;\n     }\n+\n     sendMatchingBlocks(message, callback)\n         .finish(\n             callback::completeSuccessfully,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY4NTk3NQ==", "url": "https://github.com/ConsenSys/teku/pull/2488#discussion_r464685975", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                      \"the number of requested objects per peer to allow before disconnecting the peer.\",\n          \n          \n            \n                      \"The number of requested objects per peer to allow per minute before disconnecting the peer.\",", "author": "ajsutton", "createdAt": "2020-08-03T22:03:45Z", "path": "teku/src/main/java/tech/pegasys/teku/cli/options/NetworkOptions.java", "diffHunk": "@@ -46,6 +46,15 @@\n       hidden = true)\n   private Integer startupTimeoutSeconds;\n \n+  @Option(\n+      names = {\"--Xpeer-rate-limit\"},\n+      paramLabel = \"<NUMBER>\",\n+      description =\n+          \"the number of requested objects per peer to allow before disconnecting the peer.\",", "originalCommit": "622cef628698d1c5563cb0e629b483e3f10ebb17", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b1fc15ed12e09409385c95b6ff1b84d76553ffc1", "chunk": "diff --git a/teku/src/main/java/tech/pegasys/teku/cli/options/NetworkOptions.java b/teku/src/main/java/tech/pegasys/teku/cli/options/NetworkOptions.java\nindex af0e8ae36b..ce465ede97 100644\n--- a/teku/src/main/java/tech/pegasys/teku/cli/options/NetworkOptions.java\n+++ b/teku/src/main/java/tech/pegasys/teku/cli/options/NetworkOptions.java\n\n@@ -50,7 +50,7 @@ public class NetworkOptions {\n       names = {\"--Xpeer-rate-limit\"},\n       paramLabel = \"<NUMBER>\",\n       description =\n-          \"the number of requested objects per peer to allow before disconnecting the peer.\",\n+          \"The number of requested objects per peer to allow per minute before disconnecting the peer.\",\n       arity = \"1\",\n       hidden = true)\n   private Integer peerRateLimit = 500;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY4NjI4OQ==", "url": "https://github.com/ConsenSys/teku/pull/2488#discussion_r464686289", "bodyText": "nit: I'd just move this allocation to the field declaration.", "author": "ajsutton", "createdAt": "2020-08-03T22:04:30Z", "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/peers/RateTracker.java", "diffHunk": "@@ -0,0 +1,58 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.networking.eth2.peers;\n+\n+import com.google.common.primitives.UnsignedLong;\n+import java.util.NavigableMap;\n+import java.util.TreeMap;\n+import tech.pegasys.teku.util.time.TimeProvider;\n+\n+public class RateTracker {\n+  private final NavigableMap<UnsignedLong, Long> requestCount;\n+  private final int peerRateLimit;\n+  private final UnsignedLong timeoutSeconds;\n+  private Long requestsWithinWindow;\n+  private final TimeProvider timeProvider;\n+\n+  public RateTracker(\n+      final int peerRateLimit, final long timeoutSeconds, final TimeProvider timeProvider) {\n+    this.timeoutSeconds = UnsignedLong.valueOf(timeoutSeconds);\n+    requestCount = new TreeMap<>();\n+    this.peerRateLimit = peerRateLimit;\n+    this.timeProvider = timeProvider;\n+    this.requestsWithinWindow = 0L;", "originalCommit": "622cef628698d1c5563cb0e629b483e3f10ebb17", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b1fc15ed12e09409385c95b6ff1b84d76553ffc1", "chunk": "diff --git a/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/peers/RateTracker.java b/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/peers/RateTracker.java\nindex 2fbebee9ac..30fec9289b 100644\n--- a/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/peers/RateTracker.java\n+++ b/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/peers/RateTracker.java\n\n@@ -22,7 +22,7 @@ public class RateTracker {\n   private final NavigableMap<UnsignedLong, Long> requestCount;\n   private final int peerRateLimit;\n   private final UnsignedLong timeoutSeconds;\n-  private Long requestsWithinWindow;\n+  private long requestsWithinWindow = 0L;\n   private final TimeProvider timeProvider;\n \n   public RateTracker(\n"}}, {"oid": "b1fc15ed12e09409385c95b6ff1b84d76553ffc1", "url": "https://github.com/ConsenSys/teku/commit/b1fc15ed12e09409385c95b6ff1b84d76553ffc1", "message": "review feedback.\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-08-04T00:36:18Z", "type": "commit"}, {"oid": "e2ef68a3d1a763e72428fd8b8b7b6b35892f17d3", "url": "https://github.com/ConsenSys/teku/commit/e2ef68a3d1a763e72428fd8b8b7b6b35892f17d3", "message": "Merge remote-tracking branch 'upstream/master' into 2481", "committedDate": "2020-08-04T00:44:08Z", "type": "commit"}]}