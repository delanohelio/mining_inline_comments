{"pr_number": 2629, "pr_title": "Use CacheableTaskQueue for state generation and caching", "pr_createdAt": "2020-08-20T07:47:45Z", "pr_url": "https://github.com/ConsenSys/teku/pull/2629", "timeline": [{"oid": "dd8a7c0b6242c4aa93a6a95e6b5eccef51075c9d", "url": "https://github.com/ConsenSys/teku/commit/dd8a7c0b6242c4aa93a6a95e6b5eccef51075c9d", "message": "Add CacheableTaskQueue and use it to avoid duplicate checkpoint state generation.", "committedDate": "2020-08-20T05:05:29Z", "type": "commit"}, {"oid": "d009276d3bac8cc01fa1de45ec0360de57307aaa", "url": "https://github.com/ConsenSys/teku/commit/d009276d3bac8cc01fa1de45ec0360de57307aaa", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into task-queue", "committedDate": "2020-08-20T05:05:45Z", "type": "commit"}, {"oid": "e9fd53724ff6ee13e9c7ffc07ca06ed0d917ab2e", "url": "https://github.com/ConsenSys/teku/commit/e9fd53724ff6ee13e9c7ffc07ca06ed0d917ab2e", "message": "Make errorprone happy.", "committedDate": "2020-08-20T05:26:42Z", "type": "commit"}, {"oid": "2d21d745bde72c5cbfba2ef6d1a2e5402ede8657", "url": "https://github.com/ConsenSys/teku/commit/2d21d745bde72c5cbfba2ef6d1a2e5402ede8657", "message": "Remove tests for what is now just a test fixture.", "committedDate": "2020-08-20T05:39:28Z", "type": "commit"}, {"oid": "f7d885a024ebb5c7272b8bab8791bef52f1ef076", "url": "https://github.com/ConsenSys/teku/commit/f7d885a024ebb5c7272b8bab8791bef52f1ef076", "message": "Use CacheableTaskQueue for state generation and caching.", "committedDate": "2020-08-20T07:42:23Z", "type": "commit"}, {"oid": "af0e3a2db56b1e6f68c91bf04580d742a9508732", "url": "https://github.com/ConsenSys/teku/commit/af0e3a2db56b1e6f68c91bf04580d742a9508732", "message": "Simplify a little.", "committedDate": "2020-08-20T07:46:51Z", "type": "commit"}, {"oid": "f964219029ac41967f22ef25cad602c29e373f58", "url": "https://github.com/ConsenSys/teku/commit/f964219029ac41967f22ef25cad602c29e373f58", "message": "Make errorprone happy.", "committedDate": "2020-08-20T07:51:34Z", "type": "commit"}, {"oid": "f430c5fd179741b35a825f8167c065c5d1c7ebea", "url": "https://github.com/ConsenSys/teku/commit/f430c5fd179741b35a825f8167c065c5d1c7ebea", "message": "ofNullable.", "committedDate": "2020-08-20T08:20:53Z", "type": "commit"}, {"oid": "eb021510b08f347bbee8145b456f6146fd9d2c9e", "url": "https://github.com/ConsenSys/teku/commit/eb021510b08f347bbee8145b456f6146fd9d2c9e", "message": "Fix more tests.", "committedDate": "2020-08-20T09:07:00Z", "type": "commit"}, {"oid": "926fa30848bd5be59545df454aa793c2bb9ad5e5", "url": "https://github.com/ConsenSys/teku/commit/926fa30848bd5be59545df454aa793c2bb9ad5e5", "message": "Don't try to compare Store with equals.", "committedDate": "2020-08-20T20:49:57Z", "type": "commit"}, {"oid": "8189f3727c7bde7ece488a2b98813e38b23eba6b", "url": "https://github.com/ConsenSys/teku/commit/8189f3727c7bde7ece488a2b98813e38b23eba6b", "message": "Merge branch 'master' into state-tasks", "committedDate": "2020-08-20T22:18:19Z", "type": "commit"}, {"oid": "a2ff5d8ef92d43cd74fa6127de90ad46d50e7c78", "url": "https://github.com/ConsenSys/teku/commit/a2ff5d8ef92d43cd74fa6127de90ad46d50e7c78", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into state-tasks", "committedDate": "2020-08-20T22:27:15Z", "type": "commit"}, {"oid": "7582d15ffb94ecd20d6ace2a07d320fe4ee5b939", "url": "https://github.com/ConsenSys/teku/commit/7582d15ffb94ecd20d6ace2a07d320fe4ee5b939", "message": "Merge branch 'state-tasks' of github.com:ajsutton/teku into state-tasks", "committedDate": "2020-08-20T22:27:36Z", "type": "commit"}, {"oid": "fc8eb323c0c8525875cf1550ee2fe97796178173", "url": "https://github.com/ConsenSys/teku/commit/fc8eb323c0c8525875cf1550ee2fe97796178173", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into state-tasks", "committedDate": "2020-08-20T23:38:20Z", "type": "commit"}, {"oid": "8a65ab0ca03a7eb3d4734fb149826cf9c8eb85de", "url": "https://github.com/ConsenSys/teku/commit/8a65ab0ca03a7eb3d4734fb149826cf9c8eb85de", "message": "Remove checkpoint_states from StoreAssertions ignore list.", "committedDate": "2020-08-20T23:38:39Z", "type": "commit"}, {"oid": "1be675b20b591714ac3125ec800f0a2e45afad80", "url": "https://github.com/ConsenSys/teku/commit/1be675b20b591714ac3125ec800f0a2e45afad80", "message": "Merge branch 'master' into state-tasks", "committedDate": "2020-08-21T00:51:29Z", "type": "commit"}, {"oid": "5ad46f6eae39e8c13ccf81053500c0c9087d741e", "url": "https://github.com/ConsenSys/teku/commit/5ad46f6eae39e8c13ccf81053500c0c9087d741e", "message": "Add some extra test.", "committedDate": "2020-08-21T01:04:24Z", "type": "commit"}, {"oid": "4186dcabcc1da26e68fe255dd505418246a18d73", "url": "https://github.com/ConsenSys/teku/commit/4186dcabcc1da26e68fe255dd505418246a18d73", "message": "Merge branch 'state-tasks' of github.com:ajsutton/teku into state-tasks", "committedDate": "2020-08-21T01:26:40Z", "type": "commit"}, {"oid": "66fb329c3c991de9e8d3d6398c2e7457e7a58330", "url": "https://github.com/ConsenSys/teku/commit/66fb329c3c991de9e8d3d6398c2e7457e7a58330", "message": "Minor tidyups.", "committedDate": "2020-08-21T01:29:49Z", "type": "commit"}, {"oid": "70a0fc4ddb13740d70c7061bdd1a4f6e4ddaf32b", "url": "https://github.com/ConsenSys/teku/commit/70a0fc4ddb13740d70c7061bdd1a4f6e4ddaf32b", "message": "Update ignore list.", "committedDate": "2020-08-21T01:36:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDg2NjI0Nw==", "url": "https://github.com/ConsenSys/teku/pull/2629#discussion_r474866247", "bodyText": "To make it clearer what's happening here, maybe we should add some validation in the constructor:\ncheckArgument(tree.getRootHash().equals(baseBlockAndState.getRoot()), \"Tree must be rooted at the base block\");", "author": "mbaxter", "createdAt": "2020-08-21T18:44:14Z", "path": "ethereum/core/src/main/java/tech/pegasys/teku/core/stategenerator/StateGenerationTask.java", "diffHunk": "@@ -0,0 +1,118 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.core.stategenerator;\n+\n+import java.util.Optional;\n+import java.util.stream.Stream;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.apache.tuweni.bytes.Bytes32;\n+import tech.pegasys.teku.core.lookup.BlockProvider;\n+import tech.pegasys.teku.core.lookup.StateAndBlockProvider;\n+import tech.pegasys.teku.core.stategenerator.CachingTaskQueue.CacheableTask;\n+import tech.pegasys.teku.datastructures.blocks.SignedBlockAndState;\n+import tech.pegasys.teku.datastructures.hashtree.HashTree;\n+import tech.pegasys.teku.infrastructure.async.SafeFuture;\n+\n+public class StateGenerationTask implements CacheableTask<Bytes32, SignedBlockAndState> {\n+  private static final Logger LOG = LogManager.getLogger();\n+  private final HashTree tree;\n+  private final SignedBlockAndState baseBlockAndState;\n+  protected final Optional<Bytes32> epochBoundaryRoot;\n+  private final BlockProvider blockProvider;\n+  protected final StateAndBlockProvider stateAndBlockProvider;\n+  private final Bytes32 blockRoot;\n+\n+  public StateGenerationTask(\n+      final Bytes32 blockRoot,\n+      final HashTree tree,\n+      final SignedBlockAndState baseBlockAndState,\n+      final Optional<Bytes32> epochBoundaryRoot,\n+      final BlockProvider blockProvider,\n+      final StateAndBlockProvider stateAndBlockProvider) {\n+    this.tree = tree;\n+    this.baseBlockAndState = baseBlockAndState;\n+    this.epochBoundaryRoot = epochBoundaryRoot;\n+    this.blockProvider = blockProvider;\n+    this.stateAndBlockProvider = stateAndBlockProvider;\n+    this.blockRoot = blockRoot;\n+  }\n+\n+  @Override\n+  public Bytes32 getKey() {\n+    return blockRoot;\n+  }\n+\n+  @Override\n+  public Stream<Bytes32> streamIntermediateSteps() {\n+    final Bytes32 rootParent = tree.getParent(tree.getRootHash()).orElseThrow();\n+    return Stream.iterate(\n+            tree.getParent(blockRoot),\n+            Optional::isPresent,\n+            current -> current.flatMap(tree::getParent))\n+        .flatMap(Optional::stream)\n+        // The root's parent is in the tree but is worse that the current starting point so exclude\n+        .filter(ancestorRoot -> !ancestorRoot.equals(rootParent));", "originalCommit": "70a0fc4ddb13740d70c7061bdd1a4f6e4ddaf32b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTkzNjUwNQ==", "url": "https://github.com/ConsenSys/teku/pull/2629#discussion_r475936505", "bodyText": "Done.", "author": "ajsutton", "createdAt": "2020-08-24T22:49:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDg2NjI0Nw=="}], "type": "inlineReview", "revised_code": {"commit": "4684b774141270c44c09779fbbad356e2a8f8173", "chunk": "diff --git a/ethereum/core/src/main/java/tech/pegasys/teku/core/stategenerator/StateGenerationTask.java b/ethereum/core/src/main/java/tech/pegasys/teku/core/stategenerator/StateGenerationTask.java\nindex c95d26a0b5..7bf96e6fb8 100644\n--- a/ethereum/core/src/main/java/tech/pegasys/teku/core/stategenerator/StateGenerationTask.java\n+++ b/ethereum/core/src/main/java/tech/pegasys/teku/core/stategenerator/StateGenerationTask.java\n\n@@ -13,6 +13,8 @@\n \n package tech.pegasys.teku.core.stategenerator;\n \n+import static com.google.common.base.Preconditions.checkArgument;\n+\n import java.util.Optional;\n import java.util.stream.Stream;\n import org.apache.logging.log4j.LogManager;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDg4NDk2MQ==", "url": "https://github.com/ConsenSys/teku/pull/2629#discussion_r474884961", "bodyText": "Now that we're passing stateAndBlockProvider into Store directly, I think we need to add this assert to assertValid() as well.", "author": "mbaxter", "createdAt": "2020-08-21T19:19:04Z", "path": "storage/src/main/java/tech/pegasys/teku/storage/store/StoreBuilder.java", "diffHunk": "@@ -106,16 +107,17 @@ public static StoreBuilder forkChoiceStoreBuilder(\n   }\n \n   private void createDefaults() {\n-    if (stateGenerationQueue == null) {\n+    if (stateTaskQueue == null) {\n       checkState(stateAndBlockProvider != null, \"StateAndBlockProvider must be defined\");", "originalCommit": "70a0fc4ddb13740d70c7061bdd1a4f6e4ddaf32b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTkzNjQwOA==", "url": "https://github.com/ConsenSys/teku/pull/2629#discussion_r475936408", "bodyText": "Done.", "author": "ajsutton", "createdAt": "2020-08-24T22:48:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDg4NDk2MQ=="}], "type": "inlineReview", "revised_code": {"commit": "4684b774141270c44c09779fbbad356e2a8f8173", "chunk": "diff --git a/storage/src/main/java/tech/pegasys/teku/storage/store/StoreBuilder.java b/storage/src/main/java/tech/pegasys/teku/storage/store/StoreBuilder.java\nindex f97958d616..c6c34822cf 100644\n--- a/storage/src/main/java/tech/pegasys/teku/storage/store/StoreBuilder.java\n+++ b/storage/src/main/java/tech/pegasys/teku/storage/store/StoreBuilder.java\n\n@@ -106,18 +102,10 @@ public class StoreBuilder {\n         storeConfig);\n   }\n \n-  private void createDefaults() {\n-    if (stateTaskQueue == null) {\n-      checkState(stateAndBlockProvider != null, \"StateAndBlockProvider must be defined\");\n-      stateTaskQueue =\n-          CachingTaskQueue.create(metricsSystem, \"memory_states\", storeConfig.getStateCacheSize());\n-    }\n-  }\n-\n   private void assertValid() {\n     checkState(metricsSystem != null, \"Metrics system must be defined\");\n     checkState(blockProvider != null, \"Block provider must be defined\");\n-    checkState(stateTaskQueue != null, \"State task queue must be defined\");\n+    checkState(stateAndBlockProvider != null, \"StateAndBlockProvider must be defined\");\n     checkState(time != null, \"Time must be defined\");\n     checkState(genesisTime != null, \"Genesis time must be defined\");\n     checkState(justifiedCheckpoint != null, \"Justified checkpoint must be defined\");\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDg4NjA1OQ==", "url": "https://github.com/ConsenSys/teku/pull/2629#discussion_r474886059", "bodyText": "We could probably just construct this inside of Store.", "author": "mbaxter", "createdAt": "2020-08-21T19:20:24Z", "path": "storage/src/main/java/tech/pegasys/teku/storage/store/StoreBuilder.java", "diffHunk": "@@ -106,16 +107,17 @@ public static StoreBuilder forkChoiceStoreBuilder(\n   }\n \n   private void createDefaults() {\n-    if (stateGenerationQueue == null) {\n+    if (stateTaskQueue == null) {\n       checkState(stateAndBlockProvider != null, \"StateAndBlockProvider must be defined\");\n-      stateGenerationQueue = StateGenerationQueue.create(stateAndBlockProvider, metricsSystem);\n+      stateTaskQueue =\n+          CachingTaskQueue.create(metricsSystem, \"memory_states\", storeConfig.getStateCacheSize());", "originalCommit": "70a0fc4ddb13740d70c7061bdd1a4f6e4ddaf32b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTkzNjQ3Ng==", "url": "https://github.com/ConsenSys/teku/pull/2629#discussion_r475936476", "bodyText": "Yep, makes sense - then it follows the same pattern as for checkpoint states.", "author": "ajsutton", "createdAt": "2020-08-24T22:48:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDg4NjA1OQ=="}], "type": "inlineReview", "revised_code": {"commit": "4684b774141270c44c09779fbbad356e2a8f8173", "chunk": "diff --git a/storage/src/main/java/tech/pegasys/teku/storage/store/StoreBuilder.java b/storage/src/main/java/tech/pegasys/teku/storage/store/StoreBuilder.java\nindex f97958d616..c6c34822cf 100644\n--- a/storage/src/main/java/tech/pegasys/teku/storage/store/StoreBuilder.java\n+++ b/storage/src/main/java/tech/pegasys/teku/storage/store/StoreBuilder.java\n\n@@ -106,18 +102,10 @@ public class StoreBuilder {\n         storeConfig);\n   }\n \n-  private void createDefaults() {\n-    if (stateTaskQueue == null) {\n-      checkState(stateAndBlockProvider != null, \"StateAndBlockProvider must be defined\");\n-      stateTaskQueue =\n-          CachingTaskQueue.create(metricsSystem, \"memory_states\", storeConfig.getStateCacheSize());\n-    }\n-  }\n-\n   private void assertValid() {\n     checkState(metricsSystem != null, \"Metrics system must be defined\");\n     checkState(blockProvider != null, \"Block provider must be defined\");\n-    checkState(stateTaskQueue != null, \"State task queue must be defined\");\n+    checkState(stateAndBlockProvider != null, \"StateAndBlockProvider must be defined\");\n     checkState(time != null, \"Time must be defined\");\n     checkState(genesisTime != null, \"Genesis time must be defined\");\n     checkState(justifiedCheckpoint != null, \"Justified checkpoint must be defined\");\n"}}, {"oid": "4684b774141270c44c09779fbbad356e2a8f8173", "url": "https://github.com/ConsenSys/teku/commit/4684b774141270c44c09779fbbad356e2a8f8173", "message": "Review feedback.", "committedDate": "2020-08-24T22:49:25Z", "type": "commit"}, {"oid": "775987b4f97ed87d43c4655607a8a3ef09c427f5", "url": "https://github.com/ConsenSys/teku/commit/775987b4f97ed87d43c4655607a8a3ef09c427f5", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into state-tasks", "committedDate": "2020-08-24T22:49:29Z", "type": "commit"}, {"oid": "b66183e328d817100ef8442aef7533fc9b26481f", "url": "https://github.com/ConsenSys/teku/commit/b66183e328d817100ef8442aef7533fc9b26481f", "message": "Add unit tests.", "committedDate": "2020-08-24T23:36:56Z", "type": "commit"}, {"oid": "b0fb654b558103617f3207573cb3b11378cc5b2d", "url": "https://github.com/ConsenSys/teku/commit/b0fb654b558103617f3207573cb3b11378cc5b2d", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into state-tasks", "committedDate": "2020-08-24T23:37:46Z", "type": "commit"}]}