{"pr_number": 3030, "pr_title": "Fix unhandled exception on stream abort", "pr_createdAt": "2020-10-20T15:54:21Z", "pr_url": "https://github.com/ConsenSys/teku/pull/3030", "timeline": [{"oid": "6085dbb90d55c08ee24c96cd76860799835838ca", "url": "https://github.com/ConsenSys/teku/commit/6085dbb90d55c08ee24c96cd76860799835838ca", "message": "Add a test reproducing the issue", "committedDate": "2020-10-20T15:35:00Z", "type": "commit"}, {"oid": "616b6d7e80a4c82930003a587c4aa5334c2a7205", "url": "https://github.com/ConsenSys/teku/commit/616b6d7e80a4c82930003a587c4aa5334c2a7205", "message": "Add explicit close() methods to abort decoder and release resources", "committedDate": "2020-10-20T15:47:41Z", "type": "commit"}, {"oid": "bcc9bdc3d5aba5489524545a3eabfaf10b1feeed", "url": "https://github.com/ConsenSys/teku/commit/bcc9bdc3d5aba5489524545a3eabfaf10b1feeed", "message": "Though the close() method is not expected to throw, use call Future completion in finally block to make 100% sure the critical Future is completed", "committedDate": "2020-10-20T15:48:48Z", "type": "commit"}, {"oid": "239d715f6ee138aff2735a867592ac2487495f45", "url": "https://github.com/ConsenSys/teku/commit/239d715f6ee138aff2735a867592ac2487495f45", "message": "Spotless apply", "committedDate": "2020-10-20T15:49:59Z", "type": "commit"}, {"oid": "8eb7ac59e43ad179bc0b30c1cafc825ea9c6c764", "url": "https://github.com/ConsenSys/teku/commit/8eb7ac59e43ad179bc0b30c1cafc825ea9c6c764", "message": "Fix warning.", "committedDate": "2020-10-20T16:01:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODY5MDIzMA==", "url": "https://github.com/ConsenSys/teku/pull/3030#discussion_r508690230", "bodyText": "(nit)\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (broken) throw new CompressionException(\"Compressed stream is broken\");\n          \n          \n            \n                    if (disposed) throw new DisposedDecompressorException();\n          \n          \n            \n                    if (broken) {\n          \n          \n            \n                        throw new CompressionException(\"Compressed stream is broken\");\n          \n          \n            \n                    }\n          \n          \n            \n                    if (disposed) {\n          \n          \n            \n                        throw new DisposedDecompressorException();\n          \n          \n            \n                    }", "author": "mbaxter", "createdAt": "2020-10-20T16:56:34Z", "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/rpc/core/encodings/compression/snappy/SnappyFramedCompressor.java", "diffHunk": "@@ -103,16 +94,24 @@ public SnappyFramedDecompressor(int uncompressedPayloadSize) {\n \n     @Override\n     public void complete() throws CompressionException {\n-      if (broken) throw new CompressionException(\"Compressed stream is broken\");\n-      if (disposed) throw new DisposedDecompressorException();\n-      disposed = true;\n-      boolean unreturnedFrames = !decodedSnappyFrames.isEmpty();\n+      try {\n+        if (broken) throw new CompressionException(\"Compressed stream is broken\");\n+        if (disposed) throw new DisposedDecompressorException();", "originalCommit": "8eb7ac59e43ad179bc0b30c1cafc825ea9c6c764", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3486b59fcd28376dbc8cdb00433954f127e7d5ca", "chunk": "diff --git a/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/rpc/core/encodings/compression/snappy/SnappyFramedCompressor.java b/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/rpc/core/encodings/compression/snappy/SnappyFramedCompressor.java\nindex 4968139ab..1a1c543ab 100644\n--- a/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/rpc/core/encodings/compression/snappy/SnappyFramedCompressor.java\n+++ b/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/rpc/core/encodings/compression/snappy/SnappyFramedCompressor.java\n\n@@ -95,8 +95,12 @@ public class SnappyFramedCompressor implements Compressor {\n     @Override\n     public void complete() throws CompressionException {\n       try {\n-        if (broken) throw new CompressionException(\"Compressed stream is broken\");\n-        if (disposed) throw new DisposedDecompressorException();\n+        if (broken) {\n+            throw new CompressionException(\"Compressed stream is broken\");\n+        }\n+        if (disposed) {\n+            throw new DisposedDecompressorException();\n+        }\n         disposed = true;\n         boolean unreturnedFrames = !decodedSnappyFrames.isEmpty();\n         if (unreturnedFrames) {\n"}}, {"oid": "3486b59fcd28376dbc8cdb00433954f127e7d5ca", "url": "https://github.com/ConsenSys/teku/commit/3486b59fcd28376dbc8cdb00433954f127e7d5ca", "message": "Always use blocks for if's\n\nCo-authored-by: mbaxter <meredith.baxter@consensys.net>", "committedDate": "2020-10-20T17:03:05Z", "type": "commit"}, {"oid": "e889630dc109ca03938fa8a276f89c09d5f5df16", "url": "https://github.com/ConsenSys/teku/commit/e889630dc109ca03938fa8a276f89c09d5f5df16", "message": "Spotless apply", "committedDate": "2020-10-20T17:19:40Z", "type": "commit"}, {"oid": "96b33fefd604f9437ff069776c3451ddf02a0264", "url": "https://github.com/ConsenSys/teku/commit/96b33fefd604f9437ff069776c3451ddf02a0264", "message": "Merge remote-tracking branch 'pegasys/master' into fix/unhandled-exception-on-stream-abort", "committedDate": "2020-10-20T17:19:50Z", "type": "commit"}]}