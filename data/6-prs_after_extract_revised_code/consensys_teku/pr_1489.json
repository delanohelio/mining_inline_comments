{"pr_number": 1489, "pr_title": "Use createUnsignedAttestation when creating attestations in ValidatorCoordinator", "pr_createdAt": "2020-03-27T00:06:47Z", "pr_url": "https://github.com/ConsenSys/teku/pull/1489", "timeline": [{"oid": "56e5dde19cbca306c8fa5f1d9bcbfd8f8ce2a95d", "url": "https://github.com/ConsenSys/teku/commit/56e5dde19cbca306c8fa5f1d9bcbfd8f8ce2a95d", "message": "Use createUnsignedAttestation when creating attestations in ValidatorCoordinator.", "committedDate": "2020-03-27T00:00:26Z", "type": "commit"}, {"oid": "287e65431e7653e25e2a17164eb4a2c5491bdede", "url": "https://github.com/ConsenSys/teku/commit/287e65431e7653e25e2a17164eb4a2c5491bdede", "message": "Use existing bitlist.", "committedDate": "2020-03-27T00:16:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk2OTUzMw==", "url": "https://github.com/ConsenSys/teku/pull/1489#discussion_r398969533", "bodyText": "Might be a good idea to name this as dutyFailure or something.", "author": "cemozerr", "createdAt": "2020-03-27T00:27:06Z", "path": "logging/src/main/java/tech/pegasys/teku/logging/StatusLogger.java", "diffHunk": "@@ -72,7 +72,7 @@ public void blockCreationFailure(final Exception cause) {\n     log.error(\"Error during block creation\", cause);\n   }\n \n-  public void attestationFailure(final IllegalArgumentException cause) {\n+  public void attestationFailure(final Throwable cause) {", "originalCommit": "287e65431e7653e25e2a17164eb4a2c5491bdede", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk2OTkzMQ==", "url": "https://github.com/ConsenSys/teku/pull/1489#discussion_r398969931", "bodyText": "That message is specifically for failing to create an attestation - there's a separate status event for failing to create a block.", "author": "ajsutton", "createdAt": "2020-03-27T00:28:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk2OTUzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk3MTM4Mg==", "url": "https://github.com/ConsenSys/teku/pull/1489#discussion_r398971382", "bodyText": "Then we should probably change the log.warn() string below at some point.", "author": "cemozerr", "createdAt": "2020-03-27T00:34:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk2OTUzMw=="}], "type": "inlineReview", "revised_code": {"commit": "ad90ed9e70d07c2623daeeb176fd9197a7bcdd1a", "chunk": "diff --git a/logging/src/main/java/tech/pegasys/teku/logging/StatusLogger.java b/logging/src/main/java/tech/pegasys/teku/logging/StatusLogger.java\nindex cb85761089..978a0b1cea 100644\n--- a/logging/src/main/java/tech/pegasys/teku/logging/StatusLogger.java\n+++ b/logging/src/main/java/tech/pegasys/teku/logging/StatusLogger.java\n\n@@ -73,7 +73,7 @@ public class StatusLogger {\n   }\n \n   public void attestationFailure(final Throwable cause) {\n-    log.warn(\"Cannot produce attestations or create a block\", cause);\n+    log.error(\"Error during attestation creation\", cause);\n   }\n \n   public void validatorDepositYamlKeyWriterFailure(final Path file) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk3MTA1MQ==", "url": "https://github.com/ConsenSys/teku/pull/1489#discussion_r398971051", "bodyText": "Nice.", "author": "cemozerr", "createdAt": "2020-03-27T00:32:54Z", "path": "validator/coordinator/src/main/java/tech/pegasys/artemis/validator/coordinator/ValidatorCoordinator.java", "diffHunk": "@@ -197,27 +194,82 @@ public void onAttestationEvent(BroadcastAttestationEvent event) throws IllegalAr\n       }\n \n       // Get attester information to prepare AttestationAggregator for new slot's aggregation\n-      List<AttesterInformation> attesterInformations = committeeAssignments.get(slot);\n+      List<AttesterInformation> attestersInformation = committeeAssignments.get(slot);\n \n       // If our beacon node does have any attestation responsibilities for this slot\n-      if (attesterInformations == null) {\n+      if (attestersInformation == null) {\n         return;\n       }\n \n       // Pass attestationAggregator all the attester information necessary\n       // for aggregation\n-      attestationAggregator.updateAggregatorInformations(attesterInformations);\n-\n-      asyncProduceAttestations(\n-          attesterInformations, headState, getGenericAttestationData(headState, headBlock));\n-\n-      // Save headState to check for slashings\n-      //      this.headState = headState;\n+      attestationAggregator.updateAggregatorInformations(attestersInformation);\n+\n+      final Map<UnsignedLong, List<AttesterInformation>> attestersByCommittee =\n+          attestersInformation.stream()\n+              .collect(Collectors.groupingBy(info -> info.getCommittee().getIndex()));", "originalCommit": "287e65431e7653e25e2a17164eb4a2c5491bdede", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "ad90ed9e70d07c2623daeeb176fd9197a7bcdd1a", "url": "https://github.com/ConsenSys/teku/commit/ad90ed9e70d07c2623daeeb176fd9197a7bcdd1a", "message": "Update failed attestation message to match reality.", "committedDate": "2020-03-27T00:37:05Z", "type": "commit"}]}