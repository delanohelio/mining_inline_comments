{"pr_number": 2084, "pr_title": "Use new gossipsub API", "pr_createdAt": "2020-06-08T20:58:13Z", "pr_url": "https://github.com/ConsenSys/teku/pull/2084", "timeline": [{"oid": "a1c3159d28239f7977fc3690155311282c2edc30", "url": "https://github.com/ConsenSys/teku/commit/a1c3159d28239f7977fc3690155311282c2edc30", "message": "Use new gossipsub API", "committedDate": "2020-06-08T20:56:55Z", "type": "commit"}, {"oid": "e6ba3792d577ba58c9f033a62cab4725deb55b22", "url": "https://github.com/ConsenSys/teku/commit/e6ba3792d577ba58c9f033a62cab4725deb55b22", "message": "Fix test", "committedDate": "2020-06-08T21:16:56Z", "type": "commit"}, {"oid": "08ccddbae6cd0ff39c140c95f3417e70da09ac77", "url": "https://github.com/ConsenSys/teku/commit/08ccddbae6cd0ff39c140c95f3417e70da09ac77", "message": "Fix rest of the tests", "committedDate": "2020-06-08T21:21:34Z", "type": "commit"}, {"oid": "08ccddbae6cd0ff39c140c95f3417e70da09ac77", "url": "https://github.com/ConsenSys/teku/commit/08ccddbae6cd0ff39c140c95f3417e70da09ac77", "message": "Fix rest of the tests", "committedDate": "2020-06-08T21:21:34Z", "type": "forcePushed"}, {"oid": "c211a724aae766bc4f5f27838a9fcf843d124263", "url": "https://github.com/ConsenSys/teku/commit/c211a724aae766bc4f5f27838a9fcf843d124263", "message": "Merge branch 'master' into useNewGossipSubApi", "committedDate": "2020-06-08T21:24:52Z", "type": "commit"}, {"oid": "b82fab6a83613115642fe169404ef4eed8c71356", "url": "https://github.com/ConsenSys/teku/commit/b82fab6a83613115642fe169404ef4eed8c71356", "message": "Fix tests", "committedDate": "2020-06-08T22:19:35Z", "type": "commit"}, {"oid": "dfa6eba65d627480a60ed55464b735b5f3e61894", "url": "https://github.com/ConsenSys/teku/commit/dfa6eba65d627480a60ed55464b735b5f3e61894", "message": "Revert changes on rejecting unknown block root attestations", "committedDate": "2020-06-08T23:11:22Z", "type": "commit"}, {"oid": "78c96e81ce2f6922c8adde1183bf5c9d2d6f993a", "url": "https://github.com/ConsenSys/teku/commit/78c96e81ce2f6922c8adde1183bf5c9d2d6f993a", "message": "Merge branch 'master' into useNewGossipSubApi", "committedDate": "2020-06-08T23:12:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA3NzUyMw==", "url": "https://github.com/ConsenSys/teku/pull/2084#discussion_r437077523", "bodyText": "Probably should restore the old version of this comment:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                // If it's not in the store, it must not have passed validation.\n          \n          \n            \n                // If it's not in the store, it may not have been processed yet so save for future.", "author": "ajsutton", "createdAt": "2020-06-09T00:51:15Z", "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/gossip/topics/validation/AttestationValidator.java", "diffHunk": "@@ -111,19 +113,19 @@ ValidationResult singleOrAggregateAttestationChecks(final Attestation attestatio\n     final UnsignedLong currentTimeMillis = secondsToMillis(recentChainData.getStore().getTime());\n     if (isCurrentTimeAfterAttestationPropagationSlotRange(currentTimeMillis, attestation)\n         || isFromFarFuture(attestation, currentTimeMillis)) {\n-      return INVALID;\n+      return IGNORE;\n     }\n     if (isCurrentTimeBeforeMinimumAttestationBroadcastTime(attestation, currentTimeMillis)) {\n-      return SAVED_FOR_FUTURE;\n+      return SAVE_FOR_FUTURE;\n     }\n \n     // The block being voted for (attestation.data.beacon_block_root) passes validation.\n     // It must pass validation to be in the store.\n-    // If it's not in the store, it may not have been processed yet so save for future.\n+    // If it's not in the store, it must not have passed validation.", "originalCommit": "78c96e81ce2f6922c8adde1183bf5c9d2d6f993a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ3MDMxOA==", "url": "https://github.com/ConsenSys/teku/pull/2084#discussion_r437470318", "bodyText": "Good catch. Done.", "author": "cemozerr", "createdAt": "2020-06-09T14:32:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA3NzUyMw=="}], "type": "inlineReview", "revised_code": {"commit": "edd8da65a5a2acea6d9102f90ddad60a2af4c598", "chunk": "diff --git a/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/gossip/topics/validation/AttestationValidator.java b/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/gossip/topics/validation/AttestationValidator.java\nindex 5c96155eb6..7c74a7c38e 100644\n--- a/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/gossip/topics/validation/AttestationValidator.java\n+++ b/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/gossip/topics/validation/AttestationValidator.java\n\n@@ -121,7 +121,7 @@ public class AttestationValidator {\n \n     // The block being voted for (attestation.data.beacon_block_root) passes validation.\n     // It must pass validation to be in the store.\n-    // If it's not in the store, it must not have passed validation.\n+    // If it's not in the store, it may not have been processed yet so save for future.\n     final Optional<BeaconState> maybeState =\n         recentChainData.getBlockState(attestation.getData().getBeacon_block_root());\n     if (maybeState.isEmpty()) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA3Nzg2OQ==", "url": "https://github.com/ConsenSys/teku/pull/2084#discussion_r437077869", "bodyText": "I'd suggest adding a constructor parameter so each enum value holds it's gossip sub validation result rather than having to switch here. That way it's impossible to have an unknown mapping.", "author": "ajsutton", "createdAt": "2020-06-09T00:52:24Z", "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/gossip/topics/validation/InternalValidationResult.java", "diffHunk": "@@ -13,8 +13,23 @@\n \n package tech.pegasys.teku.networking.eth2.gossip.topics.validation;\n \n-public enum ValidationResult {\n-  VALID,\n-  SAVED_FOR_FUTURE,\n-  INVALID\n+public enum InternalValidationResult {\n+  ACCEPT,\n+  SAVE_FOR_FUTURE,\n+  IGNORE,\n+  REJECT;\n+\n+  public io.libp2p.core.pubsub.ValidationResult getGossipSubValidationResult() {\n+    switch (this) {\n+      case SAVE_FOR_FUTURE:\n+      case IGNORE:\n+        return io.libp2p.core.pubsub.ValidationResult.Ignore;\n+      case REJECT:\n+        return io.libp2p.core.pubsub.ValidationResult.Invalid;\n+      case ACCEPT:\n+        return io.libp2p.core.pubsub.ValidationResult.Valid;\n+      default:\n+        throw new UnsupportedOperationException(\"Enum missing value\");\n+    }", "originalCommit": "78c96e81ce2f6922c8adde1183bf5c9d2d6f993a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzIzMTU3Mw==", "url": "https://github.com/ConsenSys/teku/pull/2084#discussion_r437231573", "bodyText": "After the class renaming you can import io.libp2p.core.pubsub.ValidationResult", "author": "Nashatyrev", "createdAt": "2020-06-09T08:33:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA3Nzg2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ3NDcxMw==", "url": "https://github.com/ConsenSys/teku/pull/2084#discussion_r437474713", "bodyText": "Both good catches. Thank you. Made the changes.", "author": "cemozerr", "createdAt": "2020-06-09T14:38:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA3Nzg2OQ=="}], "type": "inlineReview", "revised_code": {"commit": "edd8da65a5a2acea6d9102f90ddad60a2af4c598", "chunk": "diff --git a/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/gossip/topics/validation/InternalValidationResult.java b/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/gossip/topics/validation/InternalValidationResult.java\nindex 1b3c4c38c6..eac2faace6 100644\n--- a/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/gossip/topics/validation/InternalValidationResult.java\n+++ b/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/gossip/topics/validation/InternalValidationResult.java\n\n@@ -13,23 +13,21 @@\n \n package tech.pegasys.teku.networking.eth2.gossip.topics.validation;\n \n+import io.libp2p.core.pubsub.ValidationResult;\n+\n public enum InternalValidationResult {\n-  ACCEPT,\n-  SAVE_FOR_FUTURE,\n-  IGNORE,\n-  REJECT;\n+  ACCEPT(ValidationResult.Valid),\n+  SAVE_FOR_FUTURE(ValidationResult.Ignore),\n+  IGNORE(ValidationResult.Ignore),\n+  REJECT(ValidationResult.Invalid);\n+\n+  private final ValidationResult gossipSubValidationResult;\n+\n+  InternalValidationResult(ValidationResult validationResult) {\n+    this.gossipSubValidationResult = validationResult;\n+  }\n \n-  public io.libp2p.core.pubsub.ValidationResult getGossipSubValidationResult() {\n-    switch (this) {\n-      case SAVE_FOR_FUTURE:\n-      case IGNORE:\n-        return io.libp2p.core.pubsub.ValidationResult.Ignore;\n-      case REJECT:\n-        return io.libp2p.core.pubsub.ValidationResult.Invalid;\n-      case ACCEPT:\n-        return io.libp2p.core.pubsub.ValidationResult.Valid;\n-      default:\n-        throw new UnsupportedOperationException(\"Enum missing value\");\n-    }\n+  public ValidationResult getGossipSubValidationResult() {\n+    return this.gossipSubValidationResult;\n   }\n }\n"}}, {"oid": "edd8da65a5a2acea6d9102f90ddad60a2af4c598", "url": "https://github.com/ConsenSys/teku/commit/edd8da65a5a2acea6d9102f90ddad60a2af4c598", "message": "Revert comment & refactor InternalValidationResult", "committedDate": "2020-06-09T14:42:27Z", "type": "commit"}, {"oid": "b794c1d3864cef8fd77c5e18fa158bfa4ba9f8db", "url": "https://github.com/ConsenSys/teku/commit/b794c1d3864cef8fd77c5e18fa158bfa4ba9f8db", "message": "Merge branch 'master' into useNewGossipSubApi", "committedDate": "2020-06-09T14:57:22Z", "type": "commit"}]}