{"pr_number": 3382, "pr_title": "SSZ deserialization based on backing tree ViewType", "pr_createdAt": "2020-12-09T17:57:27Z", "pr_url": "https://github.com/ConsenSys/teku/pull/3382", "timeline": [{"oid": "a6cc9945c92ab3da3825c7ebda8294a44cb8b82c", "url": "https://github.com/ConsenSys/teku/commit/a6cc9945c92ab3da3825c7ebda8294a44cb8b82c", "message": "Add SszSuperNode, TypeHints and add a hint to BeaconState.validators to use SszSuperNode in the list backing tree", "committedDate": "2020-12-02T14:33:13Z", "type": "commit"}, {"oid": "f2706b50bc8f61bbc661a5d2b90e91d0ee7c96da", "url": "https://github.com/ConsenSys/teku/commit/f2706b50bc8f61bbc661a5d2b90e91d0ee7c96da", "message": "Spotless", "committedDate": "2020-12-02T14:34:59Z", "type": "commit"}, {"oid": "6e3067f811359e5d37649bb50ccb52e42ef1b0cd", "url": "https://github.com/ConsenSys/teku/commit/6e3067f811359e5d37649bb50ccb52e42ef1b0cd", "message": "Remove obsolete test", "committedDate": "2020-12-02T14:36:31Z", "type": "commit"}, {"oid": "64c96d16d1893afa6b7551cfd902bee25a0a49a8", "url": "https://github.com/ConsenSys/teku/commit/64c96d16d1893afa6b7551cfd902bee25a0a49a8", "message": "Fix compiler warns", "committedDate": "2020-12-02T14:55:28Z", "type": "commit"}, {"oid": "5fd6687c3e09993c5dece307e0537f0e10ab994c", "url": "https://github.com/ConsenSys/teku/commit/5fd6687c3e09993c5dece307e0537f0e10ab994c", "message": "Fix TreeNode.toString() for large trees", "committedDate": "2020-12-03T12:03:52Z", "type": "commit"}, {"oid": "4e723a951d7d935638c7d6dee0ca1d150ef3bc38", "url": "https://github.com/ConsenSys/teku/commit/4e723a951d7d935638c7d6dee0ca1d150ef3bc38", "message": "Refactor SszNodeTemplate to be able to return subTemplate and fix SszSuperNode to be able to return subtrees", "committedDate": "2020-12-03T12:05:16Z", "type": "commit"}, {"oid": "9472146f850a9bd93e8729c69476b12d09c1933d", "url": "https://github.com/ConsenSys/teku/commit/9472146f850a9bd93e8729c69476b12d09c1933d", "message": "Fix SszSuperNode.hashTreeRoot bug", "committedDate": "2020-12-03T13:41:48Z", "type": "commit"}, {"oid": "5fa04833754c92bd8fd12953fa819d5620200952", "url": "https://github.com/ConsenSys/teku/commit/5fa04833754c92bd8fd12953fa819d5620200952", "message": "Spotless", "committedDate": "2020-12-03T13:47:20Z", "type": "commit"}, {"oid": "27e3e5ddab46290d25c9ad570dc8612804aa6dee", "url": "https://github.com/ConsenSys/teku/commit/27e3e5ddab46290d25c9ad570dc8612804aa6dee", "message": "Remove obsolete test", "committedDate": "2020-12-03T13:59:35Z", "type": "commit"}, {"oid": "8dd83b358df4a49c8a43cdb256e8c30a36bcdbce", "url": "https://github.com/ConsenSys/teku/commit/8dd83b358df4a49c8a43cdb256e8c30a36bcdbce", "message": "Add test for ListView with TypeHints", "committedDate": "2020-12-04T14:50:53Z", "type": "commit"}, {"oid": "57d712306942c530860a4775213fc785d8f9b6c9", "url": "https://github.com/ConsenSys/teku/commit/57d712306942c530860a4775213fc785d8f9b6c9", "message": "Add equals/hashCode to List/VectorViewRead", "committedDate": "2020-12-07T09:26:06Z", "type": "commit"}, {"oid": "66bc0008cfebd67b63386498422cb87b03bfe306", "url": "https://github.com/ConsenSys/teku/commit/66bc0008cfebd67b63386498422cb87b03bfe306", "message": "Add tests", "committedDate": "2020-12-07T16:05:04Z", "type": "commit"}, {"oid": "b330a1aa59d4672a057b8c757828108b3bcdab52", "url": "https://github.com/ConsenSys/teku/commit/b330a1aa59d4672a057b8c757828108b3bcdab52", "message": "Refactor SszNodeTemplate to use GeneralizedIndex based map", "committedDate": "2020-12-07T16:05:49Z", "type": "commit"}, {"oid": "ab9192d84594e4d967704eebcd534dfb1e054c4b", "url": "https://github.com/ConsenSys/teku/commit/ab9192d84594e4d967704eebcd534dfb1e054c4b", "message": "Spotless", "committedDate": "2020-12-07T16:10:35Z", "type": "commit"}, {"oid": "01ad85d72c866a5b45115d1ae6917e5907be0ffb", "url": "https://github.com/ConsenSys/teku/commit/01ad85d72c866a5b45115d1ae6917e5907be0ffb", "message": "Implement optimized SszSuperNode.updated variant", "committedDate": "2020-12-07T16:50:35Z", "type": "commit"}, {"oid": "76b5ab5e9cb854f59fd1752d7fc316b53be86805", "url": "https://github.com/ConsenSys/teku/commit/76b5ab5e9cb854f59fd1752d7fc316b53be86805", "message": "Add javadocs", "committedDate": "2020-12-07T17:22:45Z", "type": "commit"}, {"oid": "bf8e497a9c6bc7712e57ed115f116bfddf19e504", "url": "https://github.com/ConsenSys/teku/commit/bf8e497a9c6bc7712e57ed115f116bfddf19e504", "message": "Remove accidentally committed debug code", "committedDate": "2020-12-07T17:25:52Z", "type": "commit"}, {"oid": "eb9659586403f90447511464e312877134dcd68e", "url": "https://github.com/ConsenSys/teku/commit/eb9659586403f90447511464e312877134dcd68e", "message": "Fix the LeafDataNode class name and add javadocs", "committedDate": "2020-12-07T17:33:03Z", "type": "commit"}, {"oid": "60ea403a35293925bea3ce790607086c52b7abcc", "url": "https://github.com/ConsenSys/teku/commit/60ea403a35293925bea3ce790607086c52b7abcc", "message": "Minor refactoring of SszNodeTemplate", "committedDate": "2020-12-07T17:37:09Z", "type": "commit"}, {"oid": "2881b5fa48b0f51577a2f5de73014910fc598ff9", "url": "https://github.com/ConsenSys/teku/commit/2881b5fa48b0f51577a2f5de73014910fc598ff9", "message": "Fix javadoc html", "committedDate": "2020-12-07T18:00:46Z", "type": "commit"}, {"oid": "b3d07885c2ff6ee726d799eb39df027de952319e", "url": "https://github.com/ConsenSys/teku/commit/b3d07885c2ff6ee726d799eb39df027de952319e", "message": "Merge branch 'master' into optimize/state-tree-validators", "committedDate": "2020-12-07T18:17:59Z", "type": "commit"}, {"oid": "1554d54345af7929bfeb27c9776afbd68a050251", "url": "https://github.com/ConsenSys/teku/commit/1554d54345af7929bfeb27c9776afbd68a050251", "message": "Draft temp commit", "committedDate": "2020-12-08T17:25:56Z", "type": "commit"}, {"oid": "d6eec77b174ac25eaf5fad12d24d10cfaa3b51a9", "url": "https://github.com/ConsenSys/teku/commit/d6eec77b174ac25eaf5fad12d24d10cfaa3b51a9", "message": "Add assertion to double check offset", "committedDate": "2020-12-08T17:37:30Z", "type": "commit"}, {"oid": "9f44ee31e3b8fba63b0a9f61c2a8d92498052c33", "url": "https://github.com/ConsenSys/teku/commit/9f44ee31e3b8fba63b0a9f61c2a8d92498052c33", "message": "Merge remote-tracking branch 'origin/optimize/state-tree-validators' into optimize/state-tree-validators", "committedDate": "2020-12-08T17:38:01Z", "type": "commit"}, {"oid": "d13c3dd72882bb512be13886dfa2e4c22787bd58", "url": "https://github.com/ConsenSys/teku/commit/d13c3dd72882bb512be13886dfa2e4c22787bd58", "message": "Merge branch 'optimize/state-tree-validators' into feature/view-ssz-deserialize", "committedDate": "2020-12-09T10:23:24Z", "type": "commit"}, {"oid": "4331b605cb485d59e6132eacb273b52ff8d33b55", "url": "https://github.com/ConsenSys/teku/commit/4331b605cb485d59e6132eacb273b52ff8d33b55", "message": "Merge remote-tracking branch 'ConsenSys/master' into optimize/state-tree-validators", "committedDate": "2020-12-09T10:24:40Z", "type": "commit"}, {"oid": "8bb0152371c48e5fb29c31bcdcf0a93258f74dbf", "url": "https://github.com/ConsenSys/teku/commit/8bb0152371c48e5fb29c31bcdcf0a93258f74dbf", "message": "Merge branch 'optimize/state-tree-validators' into feature/view-ssz-deserialize", "committedDate": "2020-12-09T10:25:14Z", "type": "commit"}, {"oid": "af1642e6e23a65ef5b72e74da3bd3625a8e38855", "url": "https://github.com/ConsenSys/teku/commit/af1642e6e23a65ef5b72e74da3bd3625a8e38855", "message": "Remove obsolete method", "committedDate": "2020-12-09T15:10:39Z", "type": "commit"}, {"oid": "e56692ea2ebdd1b4d6448a9646fc5596183e2a3e", "url": "https://github.com/ConsenSys/teku/commit/e56692ea2ebdd1b4d6448a9646fc5596183e2a3e", "message": "Initial implementation of sszDeserialize()", "committedDate": "2020-12-09T15:11:27Z", "type": "commit"}, {"oid": "06cb6aa4a8cf24b359544e498eba576c263a7bc3", "url": "https://github.com/ConsenSys/teku/commit/06cb6aa4a8cf24b359544e498eba576c263a7bc3", "message": "Fix a bug", "committedDate": "2020-12-09T16:08:49Z", "type": "commit"}, {"oid": "7c65f70b766650fad2554db96cecd98b8a37a389", "url": "https://github.com/ConsenSys/teku/commit/7c65f70b766650fad2554db96cecd98b8a37a389", "message": "Fix another bug", "committedDate": "2020-12-09T16:09:02Z", "type": "commit"}, {"oid": "f1390473b37f3484671a11db2ec5469886a83b07", "url": "https://github.com/ConsenSys/teku/commit/f1390473b37f3484671a11db2ec5469886a83b07", "message": "Fix another bug", "committedDate": "2020-12-09T16:15:02Z", "type": "commit"}, {"oid": "eb8ebc579d26eb5f51eb8a4f0111cc43c882bbfd", "url": "https://github.com/ConsenSys/teku/commit/eb8ebc579d26eb5f51eb8a4f0111cc43c882bbfd", "message": "Get ViewType from Class based on annotation", "committedDate": "2020-12-09T16:49:11Z", "type": "commit"}, {"oid": "bbe983da5af1ced9978a0338db58f06f901b89b3", "url": "https://github.com/ConsenSys/teku/commit/bbe983da5af1ced9978a0338db58f06f901b89b3", "message": "Check no bytes left at the end of container ssz deserialize", "committedDate": "2020-12-09T16:57:07Z", "type": "commit"}, {"oid": "9789d26915f3505db723bafb74328f54dd6344d2", "url": "https://github.com/ConsenSys/teku/commit/9789d26915f3505db723bafb74328f54dd6344d2", "message": "Spotless", "committedDate": "2020-12-09T17:06:38Z", "type": "commit"}, {"oid": "346a35cfff47d320f7e12d5b289dc72e1d518aa1", "url": "https://github.com/ConsenSys/teku/commit/346a35cfff47d320f7e12d5b289dc72e1d518aa1", "message": "Fix a couple of bugs", "committedDate": "2020-12-09T17:42:45Z", "type": "commit"}, {"oid": "0bb2a00a4460569debd3b261ad0498d2a48a1a9c", "url": "https://github.com/ConsenSys/teku/commit/0bb2a00a4460569debd3b261ad0498d2a48a1a9c", "message": "Fix @SszTypeDescriptor search", "committedDate": "2020-12-09T17:43:15Z", "type": "commit"}, {"oid": "195cbed4c9f7db5fd3fab6171147727779c45e7c", "url": "https://github.com/ConsenSys/teku/commit/195cbed4c9f7db5fd3fab6171147727779c45e7c", "message": "Spotless", "committedDate": "2020-12-09T17:44:17Z", "type": "commit"}, {"oid": "5a8710bf2691120ba95824736fc8903a66d6a5e8", "url": "https://github.com/ConsenSys/teku/commit/5a8710bf2691120ba95824736fc8903a66d6a5e8", "message": "Spotless", "committedDate": "2020-12-10T09:14:53Z", "type": "commit"}, {"oid": "c49ef0eac26932a1e15b662616f70b38ef2c171c", "url": "https://github.com/ConsenSys/teku/commit/c49ef0eac26932a1e15b662616f70b38ef2c171c", "message": "Merge remote-tracking branch 'ConsenSys/master' into feature/view-ssz-deserialize", "committedDate": "2020-12-10T15:03:32Z", "type": "commit"}, {"oid": "91b666c809a8788e6dd46cc582e223cc4315a4f6", "url": "https://github.com/ConsenSys/teku/commit/91b666c809a8788e6dd46cc582e223cc4315a4f6", "message": "Spotless", "committedDate": "2020-12-10T16:56:13Z", "type": "commit"}, {"oid": "2bd6a23d749eeff4e2daab63571d45cb2dfbc52c", "url": "https://github.com/ConsenSys/teku/commit/2bd6a23d749eeff4e2daab63571d45cb2dfbc52c", "message": "Use dedicated SSZDeserializeException", "committedDate": "2020-12-10T17:24:05Z", "type": "commit"}, {"oid": "4cdf25b4bb7b6a94c77986e39365270ac1585392", "url": "https://github.com/ConsenSys/teku/commit/4cdf25b4bb7b6a94c77986e39365270ac1585392", "message": "Fix empty list case", "committedDate": "2020-12-10T17:40:58Z", "type": "commit"}, {"oid": "768a1085d7d19d1f7ae41ff5ff270ed2d983d1fd", "url": "https://github.com/ConsenSys/teku/commit/768a1085d7d19d1f7ae41ff5ff270ed2d983d1fd", "message": "Cache Types factories instead of Types instances cause tests may change constants and some types need to be recreated", "committedDate": "2020-12-11T08:48:21Z", "type": "commit"}, {"oid": "9c1d117719679c5683ed6e033e092bbfe663e77d", "url": "https://github.com/ConsenSys/teku/commit/9c1d117719679c5683ed6e033e092bbfe663e77d", "message": "Slightly flatten confusing multi-level functional construct", "committedDate": "2020-12-11T08:55:53Z", "type": "commit"}, {"oid": "8701e6ccf9dbfc913e2c5edd18009717456f1663", "url": "https://github.com/ConsenSys/teku/commit/8701e6ccf9dbfc913e2c5edd18009717456f1663", "message": "Refactor SszReader", "committedDate": "2020-12-11T11:05:02Z", "type": "commit"}, {"oid": "30ab75b846f1f2408c99252dd73f32cae0ffdfd3", "url": "https://github.com/ConsenSys/teku/commit/30ab75b846f1f2408c99252dd73f32cae0ffdfd3", "message": "Fix compile warning", "committedDate": "2020-12-11T11:24:34Z", "type": "commit"}, {"oid": "fc2ebd4282e9afe1e0198c2384177b0ee35a3141", "url": "https://github.com/ConsenSys/teku/commit/fc2ebd4282e9afe1e0198c2384177b0ee35a3141", "message": "A bit more refactor", "committedDate": "2020-12-11T11:55:08Z", "type": "commit"}, {"oid": "9199db9a96e169a1ba542a28faaf708b08ba7b3e", "url": "https://github.com/ConsenSys/teku/commit/9199db9a96e169a1ba542a28faaf708b08ba7b3e", "message": "Move bitlist ssz math to the Bitlist class", "committedDate": "2020-12-11T12:43:50Z", "type": "commit"}, {"oid": "1b1c4e2a756c17dc8e814a1c5041d4d529f67d46", "url": "https://github.com/ConsenSys/teku/commit/1b1c4e2a756c17dc8e814a1c5041d4d529f67d46", "message": "Temp commit", "committedDate": "2020-12-11T13:17:22Z", "type": "commit"}, {"oid": "dfebc2e8a7f9cdc6492068d9f9b9e9c37238ce4b", "url": "https://github.com/ConsenSys/teku/commit/dfebc2e8a7f9cdc6492068d9f9b9e9c37238ce4b", "message": "Fix refactor regression", "committedDate": "2020-12-11T13:32:23Z", "type": "commit"}, {"oid": "37c3cff64ad7c16aefecfbf84b08f4ab3b18e284", "url": "https://github.com/ConsenSys/teku/commit/37c3cff64ad7c16aefecfbf84b08f4ab3b18e284", "message": "Fix bitlist refactor regression", "committedDate": "2020-12-11T13:43:28Z", "type": "commit"}, {"oid": "289af788bd62fd54f81f0d5fba3a0bb9690b165f", "url": "https://github.com/ConsenSys/teku/commit/289af788bd62fd54f81f0d5fba3a0bb9690b165f", "message": "Remove temp file", "committedDate": "2020-12-11T13:46:07Z", "type": "commit"}, {"oid": "66d62ffe9e6e71983a518aa9d962f3cbf7c023d1", "url": "https://github.com/ConsenSys/teku/commit/66d62ffe9e6e71983a518aa9d962f3cbf7c023d1", "message": "Remove redundant and invalid check. Move package private class to the bottom", "committedDate": "2020-12-11T13:55:11Z", "type": "commit"}, {"oid": "c159af94bd76d45573d82cc04d98c6b56934057d", "url": "https://github.com/ConsenSys/teku/commit/c159af94bd76d45573d82cc04d98c6b56934057d", "message": "Merge remote-tracking branch 'ConsenSys/master' into feature/view-ssz-deserialize", "committedDate": "2020-12-11T13:57:26Z", "type": "commit"}, {"oid": "7cb8e97ce4006a4045bcc1ce16c9f0401ca86648", "url": "https://github.com/ConsenSys/teku/commit/7cb8e97ce4006a4045bcc1ce16c9f0401ca86648", "message": "Fix Bitlist refactor regression", "committedDate": "2020-12-11T14:13:55Z", "type": "commit"}, {"oid": "9d316b4ae3a0e4e9f9eb35613858bcf4b03685e1", "url": "https://github.com/ConsenSys/teku/commit/9d316b4ae3a0e4e9f9eb35613858bcf4b03685e1", "message": "Fix Bitlist refactor regression, add bitlist test cases", "committedDate": "2020-12-11T15:00:30Z", "type": "commit"}, {"oid": "ae722360e605f6778c3aecccd8a2b0cea3c8c3e1", "url": "https://github.com/ConsenSys/teku/commit/ae722360e605f6778c3aecccd8a2b0cea3c8c3e1", "message": "Merge branch 'master' into feature/view-ssz-deserialize", "committedDate": "2020-12-11T15:01:29Z", "type": "commit"}, {"oid": "469784f6895380f352c4fa3ef824e432a57f7a84", "url": "https://github.com/ConsenSys/teku/commit/469784f6895380f352c4fa3ef824e432a57f7a84", "message": "Fix compiler warnings", "committedDate": "2020-12-11T15:05:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTI2MjEzMA==", "url": "https://github.com/ConsenSys/teku/pull/3382#discussion_r541262130", "bodyText": "Looks like the changes to this file were for debugging - should we revert this?", "author": "mbaxter", "createdAt": "2020-12-11T20:36:20Z", "path": "eth-reference-tests/src/referenceTest/java/tech/pegasys/teku/reference/phase0/ManualReferenceTestRunner.java", "diffHunk": "@@ -30,7 +29,7 @@\n  * <p>The test case is disabled as the tests run via the generated classes in CI, but it still runs\n  * without removing the @Disabled in IntelliJ.\n  */\n-@Disabled\n+// @Disabled", "originalCommit": "469784f6895380f352c4fa3ef824e432a57f7a84", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzI1NTcxNQ==", "url": "https://github.com/ConsenSys/teku/pull/3382#discussion_r543255715", "bodyText": "Ouch", "author": "Nashatyrev", "createdAt": "2020-12-15T11:14:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTI2MjEzMA=="}], "type": "inlineReview", "revised_code": {"commit": "cb79a6bad4bbe32099faff57c67de91413edb3a7", "chunk": "diff --git a/eth-reference-tests/src/referenceTest/java/tech/pegasys/teku/reference/phase0/ManualReferenceTestRunner.java b/eth-reference-tests/src/referenceTest/java/tech/pegasys/teku/reference/phase0/ManualReferenceTestRunner.java\nindex 6b6d53abe5..9e4330da3a 100644\n--- a/eth-reference-tests/src/referenceTest/java/tech/pegasys/teku/reference/phase0/ManualReferenceTestRunner.java\n+++ b/eth-reference-tests/src/referenceTest/java/tech/pegasys/teku/reference/phase0/ManualReferenceTestRunner.java\n\n@@ -29,7 +30,7 @@ import tech.pegasys.teku.ethtests.finder.TestDefinition;\n  * <p>The test case is disabled as the tests run via the generated classes in CI, but it still runs\n  * without removing the @Disabled in IntelliJ.\n  */\n-// @Disabled\n+@Disabled\n public class ManualReferenceTestRunner extends Eth2ReferenceTestCase {\n \n   /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTI5OTg1MQ==", "url": "https://github.com/ConsenSys/teku/pull/3382#discussion_r541299851", "bodyText": "(nit) Probably worth asserting on the message to make sure we're throwing the error we expect", "author": "mbaxter", "createdAt": "2020-12-11T21:16:12Z", "path": "ethereum/datastructures/src/test/java/tech/pegasys/teku/datastructures/util/SimpleOffsetSerializerTest.java", "diffHunk": "@@ -87,8 +88,7 @@ public void deserialize_extraDataAppended() {\n     final Bytes checkpointData = SimpleOffsetSerializer.serialize(checkpoint);\n     final Bytes encoded = Bytes.concatenate(checkpointData, extraData);\n     assertThatThrownBy(() -> SimpleOffsetSerializer.deserialize(encoded, Checkpoint.class))\n-        .isInstanceOf(IllegalStateException.class)\n-        .hasMessageContaining(\"Unread data detected\");\n+        .isInstanceOf(SSZDeserializeException.class);", "originalCommit": "469784f6895380f352c4fa3ef824e432a57f7a84", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzI2NzE3Ng==", "url": "https://github.com/ConsenSys/teku/pull/3382#discussion_r543267176", "bodyText": "Done: c7632ce. Also differentiate the exception messages to be more exact on the reason", "author": "Nashatyrev", "createdAt": "2020-12-15T11:33:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTI5OTg1MQ=="}], "type": "inlineReview", "revised_code": {"commit": "c7632ce431be25be738ff575120c4f5d0b0e3316", "chunk": "diff --git a/ethereum/datastructures/src/test/java/tech/pegasys/teku/datastructures/util/SimpleOffsetSerializerTest.java b/ethereum/datastructures/src/test/java/tech/pegasys/teku/datastructures/util/SimpleOffsetSerializerTest.java\nindex a55c03f1d3..22d41b96b9 100644\n--- a/ethereum/datastructures/src/test/java/tech/pegasys/teku/datastructures/util/SimpleOffsetSerializerTest.java\n+++ b/ethereum/datastructures/src/test/java/tech/pegasys/teku/datastructures/util/SimpleOffsetSerializerTest.java\n\n@@ -88,7 +88,8 @@ class SimpleOffsetSerializerTest {\n     final Bytes checkpointData = SimpleOffsetSerializer.serialize(checkpoint);\n     final Bytes encoded = Bytes.concatenate(checkpointData, extraData);\n     assertThatThrownBy(() -> SimpleOffsetSerializer.deserialize(encoded, Checkpoint.class))\n-        .isInstanceOf(SSZDeserializeException.class);\n+        .isInstanceOf(SSZDeserializeException.class)\n+        .hasMessageContaining(\"unread bytes\");\n   }\n \n   @Test\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTMyNjY4Ng==", "url": "https://github.com/ConsenSys/teku/pull/3382#discussion_r541326686", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  int lastByteWithLeadingBit = lastByte ^ (1 << (length % 8));\n          \n          \n            \n                  int lastByteWithLeadingBit = lastByte ^ leadingBit;", "author": "mbaxter", "createdAt": "2020-12-11T21:45:53Z", "path": "ssz/src/main/java/tech/pegasys/teku/ssz/SSZTypes/Bitlist.java", "diffHunk": "@@ -141,6 +133,41 @@ public static Bitlist fromBytes(Bytes bytes, long maxSize) {\n     return new Bitlist(bitlistSize, byteArray, maxSize);\n   }\n \n+  public static Bytes sszTruncateLeadingBit(Bytes bytes, int length) {\n+    Bytes bytesWithoutLast = bytes.slice(0, bytes.size() - 1);\n+    if (length % 8 == 0) {\n+      return bytesWithoutLast;\n+    } else {\n+      int lastByte = 0xFF & bytes.get(bytes.size() - 1);\n+      int leadingBit = 1 << (length % 8);\n+      int lastByteWithoutLeadingBit = lastByte ^ leadingBit;\n+      return Bytes.concatenate(bytesWithoutLast, Bytes.of(lastByteWithoutLeadingBit));\n+    }\n+  }\n+\n+  public static Bytes sszAppendLeadingBit(Bytes bytes, int length) {\n+    checkArgument(length <= bytes.size() * 8 && length > (bytes.size() - 1) * 8);\n+    if (length % 8 == 0) {\n+      return Bytes.wrap(bytes, Bytes.of(1));\n+    } else {\n+      int lastByte = 0xFF & bytes.get(bytes.size() - 1);\n+      int leadingBit = 1 << (length % 8);\n+      checkArgument((-leadingBit & lastByte) == 0, \"Bits higher than length should be 0\");\n+      int lastByteWithLeadingBit = lastByte ^ (1 << (length % 8));", "originalCommit": "469784f6895380f352c4fa3ef824e432a57f7a84", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzI2ODAyMQ==", "url": "https://github.com/ConsenSys/teku/pull/3382#discussion_r543268021", "bodyText": "Good catch, thanks \ud83d\udc4d", "author": "Nashatyrev", "createdAt": "2020-12-15T11:34:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTMyNjY4Ng=="}], "type": "inlineReview", "revised_code": {"commit": "3aa13c6c6b5553bfa7f657fcbeb54cad812a04c3", "chunk": "diff --git a/ssz/src/main/java/tech/pegasys/teku/ssz/SSZTypes/Bitlist.java b/ssz/src/main/java/tech/pegasys/teku/ssz/SSZTypes/Bitlist.java\nindex 02b96257a4..70a129b1b9 100644\n--- a/ssz/src/main/java/tech/pegasys/teku/ssz/SSZTypes/Bitlist.java\n+++ b/ssz/src/main/java/tech/pegasys/teku/ssz/SSZTypes/Bitlist.java\n\n@@ -153,7 +153,7 @@ public class Bitlist {\n       int lastByte = 0xFF & bytes.get(bytes.size() - 1);\n       int leadingBit = 1 << (length % 8);\n       checkArgument((-leadingBit & lastByte) == 0, \"Bits higher than length should be 0\");\n-      int lastByteWithLeadingBit = lastByte ^ (1 << (length % 8));\n+      int lastByteWithLeadingBit = lastByte ^ leadingBit;\n       Bytes bytesWithoutLast = bytes.slice(0, bytes.size() - 1);\n       return Bytes.concatenate(bytesWithoutLast, Bytes.of(lastByteWithLeadingBit));\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTMzMDIxOQ==", "url": "https://github.com/ConsenSys/teku/pull/3382#discussion_r541330219", "bodyText": "nit - these nodes aren't necessarily terminal leaf nodes:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public static TreeNode createTree(List<? extends TreeNode> leafNodes) {\n          \n          \n            \n              public static TreeNode createTree(List<? extends TreeNode> children) {", "author": "mbaxter", "createdAt": "2020-12-11T21:49:43Z", "path": "ssz/src/main/java/tech/pegasys/teku/ssz/backing/tree/TreeUtil.java", "diffHunk": "@@ -77,7 +77,7 @@ public static TreeNode createDefaultTree(long maxLength, TreeNode defaultNode) {\n   }\n \n   /** Creates a binary tree of width `nextPowerOf2(leafNodes.size())` with specific leaf nodes */\n-  public static TreeNode createTree(List<TreeNode> leafNodes) {\n+  public static TreeNode createTree(List<? extends TreeNode> leafNodes) {", "originalCommit": "469784f6895380f352c4fa3ef824e432a57f7a84", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzI3MDU1Mw==", "url": "https://github.com/ConsenSys/teku/pull/3382#discussion_r543270553", "bodyText": "Yep, still trying to find the correct term for such nodes, but right children is closer than leaf here", "author": "Nashatyrev", "createdAt": "2020-12-15T11:38:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTMzMDIxOQ=="}], "type": "inlineReview", "revised_code": {"commit": "5e3388091150c04fa5366de57c4c36f4dd2c0978", "chunk": "diff --git a/ssz/src/main/java/tech/pegasys/teku/ssz/backing/tree/TreeUtil.java b/ssz/src/main/java/tech/pegasys/teku/ssz/backing/tree/TreeUtil.java\nindex 6e296b0e99..6d49e345b1 100644\n--- a/ssz/src/main/java/tech/pegasys/teku/ssz/backing/tree/TreeUtil.java\n+++ b/ssz/src/main/java/tech/pegasys/teku/ssz/backing/tree/TreeUtil.java\n\n@@ -77,8 +77,8 @@ public class TreeUtil {\n   }\n \n   /** Creates a binary tree of width `nextPowerOf2(leafNodes.size())` with specific leaf nodes */\n-  public static TreeNode createTree(List<? extends TreeNode> leafNodes) {\n-    return createTree(leafNodes, treeDepth(leafNodes.size()));\n+  public static TreeNode createTree(List<? extends TreeNode> children) {\n+    return createTree(children, treeDepth(children.size()));\n   }\n \n   private static TreeNode createTree(TreeNode defaultNode, long defaultNodesCount, int depth) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTM1MzA2MQ==", "url": "https://github.com/ConsenSys/teku/pull/3382#discussion_r541353061", "bodyText": "(nit) Probably worth adding a non-empty error string?", "author": "mbaxter", "createdAt": "2020-12-11T22:15:28Z", "path": "ssz/src/main/java/tech/pegasys/teku/ssz/backing/type/CollectionViewType.java", "diffHunk": "@@ -123,6 +138,123 @@ private int sszSerializeVariableVector(\n     return variableOffset;\n   }\n \n+  protected DeserializedData sszDeserializeVector(SszReader reader) {\n+    if (getElementType().isFixedSize()) {\n+      Optional<SszSuperNodeHint> sszSuperNodeHint = getHints().getHint(SszSuperNodeHint.class);\n+      if (sszSuperNodeHint.isPresent()) {\n+        return sszDeserializeSupernode(reader, sszSuperNodeHint.get().getDepth());\n+      } else {\n+        return sszDeserializeFixed(reader);\n+      }\n+    } else {\n+      return sszDeserializeVariable(reader);\n+    }\n+  }\n+\n+  private DeserializedData sszDeserializeSupernode(SszReader reader, int supernodeDepth) {\n+    SszNodeTemplate template = elementSszSupernodeTemplate.get();\n+    int sszSize = reader.getAvailableBytes();\n+    if (sszSize % template.getSszLength() != 0) {\n+      throw new SSZDeserializeException(\"Ssz length is not multiple of element length\");\n+    }\n+    int elementsCount = sszSize / template.getSszLength();\n+    List<SszSuperNode> sszNodes =\n+        chunks(sszSize, (1 << supernodeDepth) * template.getSszLength())\n+            .mapToObj(reader::read)\n+            .map(bb -> new SszSuperNode(supernodeDepth, template, bb))\n+            .collect(Collectors.toList());\n+    TreeNode tree =\n+        TreeUtil.createTree(\n+            sszNodes,\n+            new SszSuperNode(supernodeDepth, template, Bytes.EMPTY),\n+            treeDepth() - supernodeDepth);\n+    return new DeserializedData(tree, elementsCount);\n+  }\n+\n+  private DeserializedData sszDeserializeFixed(SszReader reader) {\n+    int bytesSize = reader.getAvailableBytes();\n+    if (getElementType() instanceof BasicViewType) {\n+      checkSsz(bytesSize % getElementType().getFixedPartSize() == 0, \"\");", "originalCommit": "469784f6895380f352c4fa3ef824e432a57f7a84", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9b19d9186959587fd69485043aa9048ebfa67230", "chunk": "diff --git a/ssz/src/main/java/tech/pegasys/teku/ssz/backing/type/CollectionViewType.java b/ssz/src/main/java/tech/pegasys/teku/ssz/backing/type/CollectionViewType.java\nindex 42a85208d0..5d87f74d1a 100644\n--- a/ssz/src/main/java/tech/pegasys/teku/ssz/backing/type/CollectionViewType.java\n+++ b/ssz/src/main/java/tech/pegasys/teku/ssz/backing/type/CollectionViewType.java\n\n@@ -174,7 +174,8 @@ public abstract class CollectionViewType implements CompositeViewType {\n   private DeserializedData sszDeserializeFixed(SszReader reader) {\n     int bytesSize = reader.getAvailableBytes();\n     if (getElementType() instanceof BasicViewType) {\n-      checkSsz(bytesSize % getElementType().getFixedPartSize() == 0, \"\");\n+      checkSsz(bytesSize % getElementType().getFixedPartSize() == 0,\n+          \"SSZ sequence length is not multiple of fixed element size\");\n       List<LeafNode> childNodes =\n           chunks(bytesSize, LeafNode.MAX_BYTE_SIZE)\n               .mapToObj(reader::read)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTM2Nzc3MQ==", "url": "https://github.com/ConsenSys/teku/pull/3382#discussion_r541367771", "bodyText": "Looks like this can be private:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public static ViewRead deserialize(Bytes bytes, ViewType sszViewType) {\n          \n          \n            \n              private static ViewRead deserialize(Bytes bytes, ViewType sszViewType) {", "author": "mbaxter", "createdAt": "2020-12-11T22:31:44Z", "path": "ethereum/datastructures/src/main/java/tech/pegasys/teku/datastructures/util/SimpleOffsetSerializer.java", "diffHunk": "@@ -229,6 +236,12 @@ public static Bytes serializeVariableCompositeList(\n     }\n   }\n \n+  public static ViewRead deserialize(Bytes bytes, ViewType sszViewType) {", "originalCommit": "469784f6895380f352c4fa3ef824e432a57f7a84", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e82d44e8ae4dcb613403153a1a32cfe762e019f6", "chunk": "diff --git a/ethereum/datastructures/src/main/java/tech/pegasys/teku/datastructures/util/SimpleOffsetSerializer.java b/ethereum/datastructures/src/main/java/tech/pegasys/teku/datastructures/util/SimpleOffsetSerializer.java\nindex 427483f279..62ae4b5824 100644\n--- a/ethereum/datastructures/src/main/java/tech/pegasys/teku/datastructures/util/SimpleOffsetSerializer.java\n+++ b/ethereum/datastructures/src/main/java/tech/pegasys/teku/datastructures/util/SimpleOffsetSerializer.java\n\n@@ -236,7 +236,7 @@ public class SimpleOffsetSerializer {\n     }\n   }\n \n-  public static ViewRead deserialize(Bytes bytes, ViewType sszViewType) {\n+  private static ViewRead deserialize(Bytes bytes, ViewType sszViewType) {\n     try (SszReader sszReader = SszReader.fromBytes(bytes)) {\n       return sszViewType.sszDeserialize(sszReader);\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTM2OTg3NA==", "url": "https://github.com/ConsenSys/teku/pull/3382#discussion_r541369874", "bodyText": "Does this mean we can remove all of the tree-backed classes from SimpleOffsetSerializer.setConstants()?", "author": "mbaxter", "createdAt": "2020-12-11T22:34:32Z", "path": "ethereum/datastructures/src/main/java/tech/pegasys/teku/datastructures/util/SimpleOffsetSerializer.java", "diffHunk": "@@ -210,14 +212,19 @@ public static Bytes serializeVariableCompositeList(\n   public static <T> T deserialize(Bytes bytes, Class<T> classInfo) {\n     MutableInt bytePointer = new MutableInt(0);\n     if (!isPrimitive(classInfo)) {\n-      return SSZ.decode(\n-          bytes,\n-          reader -> {\n-            final T result =\n-                deserializeContainerErrorWrapper(classInfo, reader, bytePointer, bytes.size());\n-            assertAllDataRead(reader);\n-            return result;\n-          });\n+      Optional<ViewType> maybeViewType = ViewType.getType(classInfo);\n+      if (maybeViewType.isPresent()) {", "originalCommit": "469784f6895380f352c4fa3ef824e432a57f7a84", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzI3OTc2MQ==", "url": "https://github.com/ConsenSys/teku/pull/3382#discussion_r543279761", "bodyText": "Seems there are classLengthBounds which are still actual. I was going to do the final cleanup in a subsequent PR while removing old SSZ code", "author": "Nashatyrev", "createdAt": "2020-12-15T11:53:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTM2OTg3NA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "cb79a6bad4bbe32099faff57c67de91413edb3a7", "url": "https://github.com/ConsenSys/teku/commit/cb79a6bad4bbe32099faff57c67de91413edb3a7", "message": "Revert debugging change", "committedDate": "2020-12-15T11:13:49Z", "type": "commit"}, {"oid": "c7632ce431be25be738ff575120c4f5d0b0e3316", "url": "https://github.com/ConsenSys/teku/commit/c7632ce431be25be738ff575120c4f5d0b0e3316", "message": "Throw SSZDeserializeException with more correct message. Add message check to the test", "committedDate": "2020-12-15T11:31:42Z", "type": "commit"}, {"oid": "3aa13c6c6b5553bfa7f657fcbeb54cad812a04c3", "url": "https://github.com/ConsenSys/teku/commit/3aa13c6c6b5553bfa7f657fcbeb54cad812a04c3", "message": "Use already calculated value", "committedDate": "2020-12-15T11:34:20Z", "type": "commit"}, {"oid": "5e3388091150c04fa5366de57c4c36f4dd2c0978", "url": "https://github.com/ConsenSys/teku/commit/5e3388091150c04fa5366de57c4c36f4dd2c0978", "message": "Rename parameter to be more exact: these nodes aren't necessarily terminal leaf nodes", "committedDate": "2020-12-15T11:37:19Z", "type": "commit"}, {"oid": "9b19d9186959587fd69485043aa9048ebfa67230", "url": "https://github.com/ConsenSys/teku/commit/9b19d9186959587fd69485043aa9048ebfa67230", "message": "Add error string", "committedDate": "2020-12-15T11:46:42Z", "type": "commit"}, {"oid": "e82d44e8ae4dcb613403153a1a32cfe762e019f6", "url": "https://github.com/ConsenSys/teku/commit/e82d44e8ae4dcb613403153a1a32cfe762e019f6", "message": "Make the method private for now", "committedDate": "2020-12-15T11:49:16Z", "type": "commit"}, {"oid": "96354a4edf5325c93a4854c94ebe6ded1938c812", "url": "https://github.com/ConsenSys/teku/commit/96354a4edf5325c93a4854c94ebe6ded1938c812", "message": "Spotless", "committedDate": "2020-12-15T11:55:19Z", "type": "commit"}, {"oid": "015ea90e3bdc0e214e3ad982ca9ec6c63eb98586", "url": "https://github.com/ConsenSys/teku/commit/015ea90e3bdc0e214e3ad982ca9ec6c63eb98586", "message": "Merge remote-tracking branch 'ConsenSys/master' into feature/view-ssz-deserialize", "committedDate": "2020-12-15T11:55:29Z", "type": "commit"}]}