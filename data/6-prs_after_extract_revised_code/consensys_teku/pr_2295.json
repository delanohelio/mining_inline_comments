{"pr_number": 2295, "pr_title": "rpc exceptions now output a limited 256 bytes of message", "pr_createdAt": "2020-07-02T05:29:15Z", "pr_url": "https://github.com/ConsenSys/teku/pull/2295", "timeline": [{"oid": "222e60c0b03718065c8406bc155dbc25342a196f", "url": "https://github.com/ConsenSys/teku/commit/222e60c0b03718065c8406bc155dbc25342a196f", "message": "rpc exceptions now output a limited 256 bytes of message\n\n - renamed SimpleOffsetSszEncoder to DefaultRpcPayloadEncoder\n\n - added a round trip encoder to demonstrate the same message that is encoded comes out of the decoder.\n\n - Added log message for decode failure.\n\npartially addresses #2078\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-07-02T05:28:34Z", "type": "commit"}, {"oid": "d9d08d969513de41f214577cd840e070182fceee", "url": "https://github.com/ConsenSys/teku/commit/d9d08d969513de41f214577cd840e070182fceee", "message": "Merge remote-tracking branch 'upstream/master' into 2078-exception-bytes", "committedDate": "2020-07-02T05:29:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTI2NTI3Mw==", "url": "https://github.com/ConsenSys/teku/pull/2295#discussion_r449265273", "bodyText": "nit: shouldn't we be casting to (Bytes) here since the clazz is Bytes.class anyway? or does the compiler not allow that? or lastly is that just unnecessary?", "author": "cemozerr", "createdAt": "2020-07-02T21:04:52Z", "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/rpc/core/encodings/ssz/DefaultRpcPayloadEncoder.java", "diffHunk": "@@ -22,22 +22,28 @@\n import tech.pegasys.teku.networking.eth2.rpc.core.encodings.RpcPayloadEncoder;\n import tech.pegasys.teku.ssz.sos.SimpleOffsetSerializable;\n \n-public class SimpleOffsetSszEncoder<T> implements RpcPayloadEncoder<T> {\n+public class DefaultRpcPayloadEncoder<T> implements RpcPayloadEncoder<T> {\n   private static final Logger LOG = LogManager.getLogger();\n   private final Class<T> clazz;\n \n-  public SimpleOffsetSszEncoder(final Class<T> clazz) {\n+  public DefaultRpcPayloadEncoder(final Class<T> clazz) {\n     this.clazz = clazz;\n   }\n \n   @Override\n   public Bytes encode(final T message) {\n-    return SimpleOffsetSerializer.serialize((SimpleOffsetSerializable) message);\n+    return message instanceof Bytes\n+        ? (Bytes) message\n+        : SimpleOffsetSerializer.serialize((SimpleOffsetSerializable) message);\n   }\n \n+  @SuppressWarnings(\"unchecked\")\n   @Override\n   public T decode(final Bytes message) throws RpcException {\n     try {\n+      if (clazz.equals(Bytes.class)) {\n+        return (T) message;", "originalCommit": "d9d08d969513de41f214577cd840e070182fceee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTI2NjE5MA==", "url": "https://github.com/ConsenSys/teku/pull/2295#discussion_r449266190", "bodyText": "we're basically bypassing the decoder if its already bytes. the compiler wasn't happy! This is the other half of the encode bypass basically. If we don't bypass it here, then we attempt to go and decode it, and it fails.", "author": "rolfyone", "createdAt": "2020-07-02T21:07:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTI2NTI3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTI2Nzk1OA==", "url": "https://github.com/ConsenSys/teku/pull/2295#discussion_r449267958", "bodyText": "Oh yeah I understand that. I mean, on line 45, can we not do:\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return (T) message;\n          \n          \n            \n                    return (Bytes) message;", "author": "cemozerr", "createdAt": "2020-07-02T21:11:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTI2NTI3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTI2OTA5MA==", "url": "https://github.com/ConsenSys/teku/pull/2295#discussion_r449269090", "bodyText": "No because the compiler doesn't know that T is Bytes.  We do because we can make the leap from Class<T> clazz being equal to Bytes.class to knowing that T is Bytes but the compiler can't.", "author": "ajsutton", "createdAt": "2020-07-02T21:15:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTI2NTI3Mw=="}], "type": "inlineReview", "revised_code": {"commit": "7ac2d672e2f0c2db52ce19f51a9a1f0b63cacef0", "chunk": "diff --git a/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/rpc/core/encodings/ssz/DefaultRpcPayloadEncoder.java b/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/rpc/core/encodings/ssz/DefaultRpcPayloadEncoder.java\nindex 237b53a60..53e5ada11 100644\n--- a/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/rpc/core/encodings/ssz/DefaultRpcPayloadEncoder.java\n+++ b/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/rpc/core/encodings/ssz/DefaultRpcPayloadEncoder.java\n\n@@ -19,6 +19,7 @@ import org.apache.tuweni.bytes.Bytes;\n import org.apache.tuweni.ssz.InvalidSSZTypeException;\n import tech.pegasys.teku.datastructures.util.SimpleOffsetSerializer;\n import tech.pegasys.teku.networking.eth2.rpc.core.RpcException;\n+import tech.pegasys.teku.networking.eth2.rpc.core.RpcException.DeserializationFailedException;\n import tech.pegasys.teku.networking.eth2.rpc.core.encodings.RpcPayloadEncoder;\n import tech.pegasys.teku.ssz.sos.SimpleOffsetSerializable;\n \n"}}, {"oid": "0de0af0db187b25a1d75e8e546775247615aa52f", "url": "https://github.com/ConsenSys/teku/commit/0de0af0db187b25a1d75e8e546775247615aa52f", "message": "Merge remote-tracking branch 'upstream/master' into 2078-exception-bytes", "committedDate": "2020-07-02T21:07:45Z", "type": "commit"}, {"oid": "7ac2d672e2f0c2db52ce19f51a9a1f0b63cacef0", "url": "https://github.com/ConsenSys/teku/commit/7ac2d672e2f0c2db52ce19f51a9a1f0b63cacef0", "message": "Merge remote-tracking branch 'upstream/master' into 2078-exception-bytes\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>\n\n# Conflicts:\n#\tnetworking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/rpc/core/RpcResponseDecoder.java\n#\tnetworking/eth2/src/test/java/tech/pegasys/teku/networking/eth2/rpc/core/encodings/DefaultRpcPayloadEncoderTest.java", "committedDate": "2020-07-02T21:36:09Z", "type": "commit"}, {"oid": "5a87c0b798424f89a3acb2590f3ee3b88bd7c9e7", "url": "https://github.com/ConsenSys/teku/commit/5a87c0b798424f89a3acb2590f3ee3b88bd7c9e7", "message": "Merge remote-tracking branch 'upstream/master' into 2078-exception-bytes", "committedDate": "2020-07-02T21:54:58Z", "type": "commit"}]}