{"pr_number": 1543, "pr_title": "added peers metric", "pr_createdAt": "2020-04-07T01:26:02Z", "pr_url": "https://github.com/ConsenSys/teku/pull/1543", "timeline": [{"oid": "e538dbee29371750e816b8218d221c1ff4e0f826", "url": "https://github.com/ConsenSys/teku/commit/e538dbee29371750e816b8218d221c1ff4e0f826", "message": "added peers metric\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-04-07T01:24:54Z", "type": "commit"}, {"oid": "4e82f1d5a7b8ff4c21fe9ece8c6de60f595da777", "url": "https://github.com/ConsenSys/teku/commit/4e82f1d5a7b8ff4c21fe9ece8c6de60f595da777", "message": "formatting\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-04-07T01:28:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ4Mzg4Mw==", "url": "https://github.com/ConsenSys/teku/pull/1543#discussion_r404483883", "bodyText": "This feels like the wrong approach.  Rather than a settable gauge you could just use the normal gauge and read from getPeerCount() on demand.", "author": "ajsutton", "createdAt": "2020-04-07T01:29:00Z", "path": "networking/p2p/src/main/java/tech/pegasys/artemis/networking/p2p/libp2p/PeerManager.java", "diffHunk": "@@ -59,7 +62,12 @@ public PeerManager(\n     this.reputationManager = reputationManager;\n     this.peerHandlers = peerHandlers;\n     this.rpcHandlers = rpcHandlers;\n-    // TODO - add metrics\n+    peerGauge =\n+        SettableGauge.create(\n+            metricsSystem,\n+            ArtemisMetricCategory.NETWORK,\n+            \"libp2p_peers\",\n+            \"Total number of peers\");", "originalCommit": "e538dbee29371750e816b8218d221c1ff4e0f826", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ4NzAyNg==", "url": "https://github.com/ConsenSys/teku/pull/1543#discussion_r404487026", "bodyText": "changed to regular gauge", "author": "macfarla", "createdAt": "2020-04-07T01:40:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ4Mzg4Mw=="}], "type": "inlineReview", "revised_code": {"commit": "ac9dc5ed147eb47d8963878b157598c5bc5e7225", "chunk": "diff --git a/networking/p2p/src/main/java/tech/pegasys/artemis/networking/p2p/libp2p/PeerManager.java b/networking/p2p/src/main/java/tech/pegasys/artemis/networking/p2p/libp2p/PeerManager.java\nindex 4a95608b2..fd07aa0e1 100644\n--- a/networking/p2p/src/main/java/tech/pegasys/artemis/networking/p2p/libp2p/PeerManager.java\n+++ b/networking/p2p/src/main/java/tech/pegasys/artemis/networking/p2p/libp2p/PeerManager.java\n\n@@ -62,12 +60,8 @@ public class PeerManager implements ConnectionHandler {\n     this.reputationManager = reputationManager;\n     this.peerHandlers = peerHandlers;\n     this.rpcHandlers = rpcHandlers;\n-    peerGauge =\n-        SettableGauge.create(\n-            metricsSystem,\n-            ArtemisMetricCategory.NETWORK,\n-            \"libp2p_peers\",\n-            \"Total number of peers\");\n+    metricsSystem.createGauge(\n+        ArtemisMetricCategory.NETWORK, \"libp2p_peers\", \"total number of peers\", this::getPeerCount);\n   }\n \n   @Override\n"}}, {"oid": "ac9dc5ed147eb47d8963878b157598c5bc5e7225", "url": "https://github.com/ConsenSys/teku/commit/ac9dc5ed147eb47d8963878b157598c5bc5e7225", "message": "use regular gauge\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-04-07T01:39:44Z", "type": "commit"}, {"oid": "fe4fd19a2aa15fceeb66f146232f0647a07a0e95", "url": "https://github.com/ConsenSys/teku/commit/fe4fd19a2aa15fceeb66f146232f0647a07a0e95", "message": "use regular gauge\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-04-07T01:40:57Z", "type": "commit"}, {"oid": "fd34c7959ab1aaae11b46b945d5a91f98a8393cd", "url": "https://github.com/ConsenSys/teku/commit/fd34c7959ab1aaae11b46b945d5a91f98a8393cd", "message": "Merge branch 'peers-metrics' of github.com:macfarla/teku into peers-metrics", "committedDate": "2020-04-07T01:41:44Z", "type": "commit"}]}