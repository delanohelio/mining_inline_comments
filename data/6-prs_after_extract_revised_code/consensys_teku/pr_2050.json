{"pr_number": 2050, "pr_title": "Fix deposit inclusion bug", "pr_createdAt": "2020-06-03T20:24:40Z", "pr_url": "https://github.com/ConsenSys/teku/pull/2050", "timeline": [{"oid": "fbbc93a37abafcbdd828a701ccae1baf77f2426e", "url": "https://github.com/ConsenSys/teku/commit/fbbc93a37abafcbdd828a701ccae1baf77f2426e", "message": "Account for own block eth1data updating deposit count", "committedDate": "2020-06-03T20:16:14Z", "type": "commit"}, {"oid": "a4b882bbf1c1e7214f8492935d35989cb1a7607c", "url": "https://github.com/ConsenSys/teku/commit/a4b882bbf1c1e7214f8492935d35989cb1a7607c", "message": "Run spotless & fix implicit casting", "committedDate": "2020-06-03T20:16:14Z", "type": "commit"}, {"oid": "b9f833580af63def6a2de914c882e325f0337c59", "url": "https://github.com/ConsenSys/teku/commit/b9f833580af63def6a2de914c882e325f0337c59", "message": "Fix new tests", "committedDate": "2020-06-03T20:22:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDkwMzM4Nw==", "url": "https://github.com/ConsenSys/teku/pull/2050#discussion_r434903387", "bodyText": "nit: shouldn't need to move this assignment to setUp (field can be non-final with an assignment if needed).", "author": "ajsutton", "createdAt": "2020-06-03T23:00:31Z", "path": "validator/coordinator/src/test/java/tech/pegasys/teku/validator/coordinator/DepositProviderTest.java", "diffHunk": "@@ -41,23 +41,27 @@\n import tech.pegasys.teku.datastructures.util.OptimizedMerkleTree;\n import tech.pegasys.teku.pow.event.DepositsFromBlockEvent;\n import tech.pegasys.teku.ssz.SSZTypes.SSZList;\n+import tech.pegasys.teku.ssz.SSZTypes.SSZMutableList;\n import tech.pegasys.teku.storage.client.RecentChainData;\n import tech.pegasys.teku.util.config.Constants;\n \n public class DepositProviderTest {\n \n   private final DataStructureUtil dataStructureUtil = new DataStructureUtil();\n   private final RecentChainData recentChainData = mock(RecentChainData.class);\n-  private final BeaconState beaconState = mock(BeaconState.class);\n+  private final BeaconState state = mock(BeaconState.class);\n   private final Eth1DataCache eth1DataCache = mock(Eth1DataCache.class);\n-  private final MerkleTree depositMerkleTree =\n-      new OptimizedMerkleTree(Constants.DEPOSIT_CONTRACT_TREE_DEPTH);\n   private List<tech.pegasys.teku.pow.event.Deposit> allSeenDepositsList;\n   private final DepositProvider depositProvider =\n       new DepositProvider(recentChainData, eth1DataCache);\n+  private final Eth1Data randomEth1Data = dataStructureUtil.randomEth1Data();\n+\n+  private MerkleTree depositMerkleTree;\n \n   @BeforeEach\n   void setUp() {\n+    depositMerkleTree = new OptimizedMerkleTree(Constants.DEPOSIT_CONTRACT_TREE_DEPTH);", "originalCommit": "b9f833580af63def6a2de914c882e325f0337c59", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTM2Nzg2NQ==", "url": "https://github.com/ConsenSys/teku/pull/2050#discussion_r435367865", "bodyText": "But in that case, we'd be adding duplicate deposit data roots to the Merkle tree between tests since multiple tests call mockDepositsFromEth1Block", "author": "cemozerr", "createdAt": "2020-06-04T15:54:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDkwMzM4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU5MTYxMg==", "url": "https://github.com/ConsenSys/teku/pull/2050#discussion_r435591612", "bodyText": "No a new instance of the test class is created for every test so field values are not shared between test methods.", "author": "ajsutton", "createdAt": "2020-06-04T22:41:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDkwMzM4Nw=="}], "type": "inlineReview", "revised_code": null}, {"oid": "6edd8454cd495c26a75bf51edee25ed998df7de8", "url": "https://github.com/ConsenSys/teku/commit/6edd8454cd495c26a75bf51edee25ed998df7de8", "message": "Merge branch 'master' into fixDepositInclusionError", "committedDate": "2020-06-04T15:49:57Z", "type": "commit"}]}