{"pr_number": 1812, "pr_title": "Rework reference test framework", "pr_createdAt": "2020-05-19T05:00:38Z", "pr_url": "https://github.com/ConsenSys/teku/pull/1812", "timeline": [{"oid": "fa05f7d6b493a31d24d295b65a4d05b60d2326b8", "url": "https://github.com/ConsenSys/teku/commit/fa05f7d6b493a31d24d295b65a4d05b60d2326b8", "message": "Generate reference tests to ensure we run them all.", "committedDate": "2020-05-19T04:59:00Z", "type": "commit"}, {"oid": "25d105f27ac2a945bf8028451ebf149b44f42fa1", "url": "https://github.com/ConsenSys/teku/commit/25d105f27ac2a945bf8028451ebf149b44f42fa1", "message": "Don't compile the reference tests until we've downloaded them.", "committedDate": "2020-05-19T05:09:27Z", "type": "commit"}, {"oid": "529fb1961040437d7aa22b739b0e15e93c2fe959", "url": "https://github.com/ConsenSys/teku/commit/529fb1961040437d7aa22b739b0e15e93c2fe959", "message": "Merge branch 'master' into fix-ref-tests", "committedDate": "2020-05-19T05:23:02Z", "type": "commit"}, {"oid": "69c7c9a38932ba62506da0d547b15bd6412f066d", "url": "https://github.com/ConsenSys/teku/commit/69c7c9a38932ba62506da0d547b15bd6412f066d", "message": "Capture test reports as an artifact.", "committedDate": "2020-05-19T06:03:20Z", "type": "commit"}, {"oid": "68befc9fb3015d5ac9235ee26c9dd0fa7a4c3d57", "url": "https://github.com/ConsenSys/teku/commit/68befc9fb3015d5ac9235ee26c9dd0fa7a4c3d57", "message": "Merge branch 'fix-ref-tests' of github.com:ajsutton/teku into fix-ref-tests", "committedDate": "2020-05-19T06:03:31Z", "type": "commit"}, {"oid": "8dcb702c8c42b3a12c02ec985916fe3760d4f551", "url": "https://github.com/ConsenSys/teku/commit/8dcb702c8c42b3a12c02ec985916fe3760d4f551", "message": "Simplify executors.", "committedDate": "2020-05-19T06:12:38Z", "type": "commit"}, {"oid": "df35c3677bdb28b2f5cb3e8f8e60b166f410f843", "url": "https://github.com/ConsenSys/teku/commit/df35c3677bdb28b2f5cb3e8f8e60b166f410f843", "message": "Capture test results xml files as a tarball.", "committedDate": "2020-05-19T08:45:48Z", "type": "commit"}, {"oid": "19c27fdd479c809c6a944e54aadbb9e82743bc0d", "url": "https://github.com/ConsenSys/teku/commit/19c27fdd479c809c6a944e54aadbb9e82743bc0d", "message": "Standardise approach.", "committedDate": "2020-05-19T09:22:33Z", "type": "commit"}, {"oid": "472d481ca5b3f1caedc07accb3da174c5f69be4d", "url": "https://github.com/ConsenSys/teku/commit/472d481ca5b3f1caedc07accb3da174c5f69be4d", "message": "Load ssz roots the modern way.", "committedDate": "2020-05-19T09:25:36Z", "type": "commit"}, {"oid": "87e9ec733cd22fd28c41faf60757c822d2e6d4bb", "url": "https://github.com/ConsenSys/teku/commit/87e9ec733cd22fd28c41faf60757c822d2e6d4bb", "message": "Don't capture test XML.", "committedDate": "2020-05-19T09:27:12Z", "type": "commit"}, {"oid": "ae1d0726e9d67343d03157a8e78db3d8a16a1a80", "url": "https://github.com/ConsenSys/teku/commit/ae1d0726e9d67343d03157a8e78db3d8a16a1a80", "message": "Rename and tidy up.", "committedDate": "2020-05-19T09:34:20Z", "type": "commit"}, {"oid": "549230c63976d30cfd616b202c443b2c9d2e0bbe", "url": "https://github.com/ConsenSys/teku/commit/549230c63976d30cfd616b202c443b2c9d2e0bbe", "message": "Dead code.", "committedDate": "2020-05-19T09:35:39Z", "type": "commit"}, {"oid": "8b3c1dd2ea8fc5b07635c8a96aa208819f2e4129", "url": "https://github.com/ConsenSys/teku/commit/8b3c1dd2ea8fc5b07635c8a96aa208819f2e4129", "message": "Remove commented out main.", "committedDate": "2020-05-19T09:47:44Z", "type": "commit"}, {"oid": "a14d54b5d7548c4c00b917fdd4e32ceaa9d67b6f", "url": "https://github.com/ConsenSys/teku/commit/a14d54b5d7548c4c00b917fdd4e32ceaa9d67b6f", "message": "Use loadYaml", "committedDate": "2020-05-19T09:50:22Z", "type": "commit"}, {"oid": "7ce9c521c17d1564cc29bb7f907b1384c01cbb65", "url": "https://github.com/ConsenSys/teku/commit/7ce9c521c17d1564cc29bb7f907b1384c01cbb65", "message": "Remove TODO.", "committedDate": "2020-05-19T09:52:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ3Nzk5OQ==", "url": "https://github.com/ConsenSys/teku/pull/1812#discussion_r427477999", "bodyText": "Why are we ignoring these tests?", "author": "cemozerr", "createdAt": "2020-05-19T17:33:05Z", "path": "eth-reference-tests/src/referenceTest/java/tech/pegasys/teku/reference/phase0/ssz_static/SszTestExecutor.java", "diffHunk": "@@ -0,0 +1,131 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.reference.phase0.ssz_static;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.google.common.collect.ImmutableMap;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import org.apache.tuweni.bytes.Bytes;\n+import org.apache.tuweni.bytes.Bytes32;\n+import tech.pegasys.teku.datastructures.blocks.BeaconBlock;\n+import tech.pegasys.teku.datastructures.blocks.BeaconBlockBody;\n+import tech.pegasys.teku.datastructures.blocks.BeaconBlockHeader;\n+import tech.pegasys.teku.datastructures.blocks.Eth1Data;\n+import tech.pegasys.teku.datastructures.blocks.SignedBeaconBlock;\n+import tech.pegasys.teku.datastructures.blocks.SignedBeaconBlockHeader;\n+import tech.pegasys.teku.datastructures.operations.AggregateAndProof;\n+import tech.pegasys.teku.datastructures.operations.Attestation;\n+import tech.pegasys.teku.datastructures.operations.AttestationData;\n+import tech.pegasys.teku.datastructures.operations.AttesterSlashing;\n+import tech.pegasys.teku.datastructures.operations.Deposit;\n+import tech.pegasys.teku.datastructures.operations.DepositData;\n+import tech.pegasys.teku.datastructures.operations.DepositMessage;\n+import tech.pegasys.teku.datastructures.operations.IndexedAttestation;\n+import tech.pegasys.teku.datastructures.operations.ProposerSlashing;\n+import tech.pegasys.teku.datastructures.operations.SignedAggregateAndProof;\n+import tech.pegasys.teku.datastructures.operations.SignedVoluntaryExit;\n+import tech.pegasys.teku.datastructures.operations.VoluntaryExit;\n+import tech.pegasys.teku.datastructures.state.BeaconStateImpl;\n+import tech.pegasys.teku.datastructures.state.Checkpoint;\n+import tech.pegasys.teku.datastructures.state.Fork;\n+import tech.pegasys.teku.datastructures.state.ForkData;\n+import tech.pegasys.teku.datastructures.state.HistoricalBatch;\n+import tech.pegasys.teku.datastructures.state.PendingAttestation;\n+import tech.pegasys.teku.datastructures.state.Validator;\n+import tech.pegasys.teku.datastructures.util.SimpleOffsetSerializer;\n+import tech.pegasys.teku.ethtests.finder.TestDefinition;\n+import tech.pegasys.teku.reference.phase0.TestDataUtils;\n+import tech.pegasys.teku.reference.phase0.TestExecutor;\n+import tech.pegasys.teku.ssz.sos.SimpleOffsetSerializable;\n+import tech.pegasys.teku.util.hashtree.Merkleizable;\n+\n+public class SszTestExecutor<T extends SimpleOffsetSerializable & Merkleizable>\n+    implements TestExecutor {\n+  private final Class<T> clazz;\n+\n+  public static ImmutableMap<String, TestExecutor> SSZ_TEST_TYPES =\n+      ImmutableMap.<String, TestExecutor>builder()\n+          // SSZ Static\n+          .put(\"ssz_static/AggregateAndProof\", new SszTestExecutor<>(AggregateAndProof.class))\n+          .put(\"ssz_static/Attestation\", new SszTestExecutor<>(Attestation.class))\n+          .put(\"ssz_static/AttestationData\", new SszTestExecutor<>(AttestationData.class))\n+          .put(\"ssz_static/AttesterSlashing\", new SszTestExecutor<>(AttesterSlashing.class))\n+          .put(\"ssz_static/BeaconBlock\", new SszTestExecutor<>(BeaconBlock.class))\n+          .put(\"ssz_static/BeaconBlockBody\", new SszTestExecutor<>(BeaconBlockBody.class))\n+          .put(\"ssz_static/BeaconBlockHeader\", new SszTestExecutor<>(BeaconBlockHeader.class))\n+          .put(\"ssz_static/BeaconState\", new SszTestExecutor<>(BeaconStateImpl.class))\n+          .put(\"ssz_static/Checkpoint\", new SszTestExecutor<>(Checkpoint.class))\n+          .put(\"ssz_static/Deposit\", new SszTestExecutor<>(Deposit.class))\n+          .put(\"ssz_static/DepositData\", new SszTestExecutor<>(DepositData.class))\n+          .put(\"ssz_static/DepositMessage\", new SszTestExecutor<>(DepositMessage.class))\n+          .put(\"ssz_static/Eth1Block\", IGNORE_TESTS) // We don't have an Eth1Block structure\n+          .put(\"ssz_static/Eth1Data\", new SszTestExecutor<>(Eth1Data.class))\n+          .put(\"ssz_static/Fork\", new SszTestExecutor<>(Fork.class))\n+          .put(\"ssz_static/ForkData\", new SszTestExecutor<>(ForkData.class))\n+          .put(\"ssz_static/HistoricalBatch\", new SszTestExecutor<>(HistoricalBatch.class))\n+          .put(\"ssz_static/IndexedAttestation\", new SszTestExecutor<>(IndexedAttestation.class))\n+          .put(\"ssz_static/PendingAttestation\", new SszTestExecutor<>(PendingAttestation.class))\n+          .put(\"ssz_static/ProposerSlashing\", new SszTestExecutor<>(ProposerSlashing.class))\n+          .put(\n+              \"ssz_static/SignedAggregateAndProof\",\n+              new SszTestExecutor<>(SignedAggregateAndProof.class))\n+          .put(\"ssz_static/SignedBeaconBlock\", new SszTestExecutor<>(SignedBeaconBlock.class))\n+          .put(\n+              \"ssz_static/SignedBeaconBlockHeader\",\n+              new SszTestExecutor<>(SignedBeaconBlockHeader.class))\n+          .put(\"ssz_static/SignedVoluntaryExit\", new SszTestExecutor<>(SignedVoluntaryExit.class))\n+          .put(\"ssz_static/SigningRoot\", IGNORE_TESTS) // TODO: Should make this work\n+          .put(\"ssz_static/Validator\", new SszTestExecutor<>(Validator.class))\n+          .put(\"ssz_static/VoluntaryExit\", new SszTestExecutor<>(VoluntaryExit.class))\n+\n+          // SSZ Generic\n+          .put(\"ssz_generic/basic_vector\", IGNORE_TESTS)", "originalCommit": "7ce9c521c17d1564cc29bb7f907b1384c01cbb65", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzUzMDEzMQ==", "url": "https://github.com/ConsenSys/teku/pull/1812#discussion_r427530131", "bodyText": "We've never run the ssz_generic tests previously.  Would be good to enable at least some of them like bitvector and bitlist which should be a lot simpler now.", "author": "ajsutton", "createdAt": "2020-05-19T18:57:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ3Nzk5OQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzUxMDg5Mg==", "url": "https://github.com/ConsenSys/teku/pull/1812#discussion_r427510892", "bodyText": "Would it make sense for these TestFinder classes to throw if they don't find any tests? Since that is unexpected.", "author": "cemozerr", "createdAt": "2020-05-19T18:25:37Z", "path": "eth-tests/src/main/java/tech/pegasys/teku/ethtests/finder/ShufflingTestFinder.java", "diffHunk": "@@ -0,0 +1,43 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.ethtests.finder;\n+\n+import com.google.errorprone.annotations.MustBeClosed;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.stream.Stream;\n+\n+public class ShufflingTestFinder implements TestFinder {", "originalCommit": "7ce9c521c17d1564cc29bb7f907b1384c01cbb65", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzUzMDU4Mg==", "url": "https://github.com/ConsenSys/teku/pull/1812#discussion_r427530582", "bodyText": "It's expected that they won't find tests in some cases - for example there are no shuffling tests under general and no genesis tests under mainnet.", "author": "ajsutton", "createdAt": "2020-05-19T18:58:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzUxMDg5Mg=="}], "type": "inlineReview", "revised_code": null}]}