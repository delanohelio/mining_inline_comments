{"pr_number": 3092, "pr_title": "Avoid regenerating all finalized states", "pr_createdAt": "2020-10-27T19:37:08Z", "pr_url": "https://github.com/ConsenSys/teku/pull/3092", "timeline": [{"oid": "26c5ea41b42ce6b6c53ba7fed27aa43a186c24a7", "url": "https://github.com/ConsenSys/teku/commit/26c5ea41b42ce6b6c53ba7fed27aa43a186c24a7", "message": "Avoid regenerating all finalized states", "committedDate": "2020-10-27T19:34:33Z", "type": "commit"}, {"oid": "1a51f39130e82960e771e167b671d198673e813d", "url": "https://github.com/ConsenSys/teku/commit/1a51f39130e82960e771e167b671d198673e813d", "message": "Merge branch 'master' of github.com:ConsenSys/teku into fix-finalization-pause", "committedDate": "2020-10-27T19:37:17Z", "type": "commit"}, {"oid": "f99ef5200f076f9aabb79c945ed0e6cb502c1be0", "url": "https://github.com/ConsenSys/teku/commit/f99ef5200f076f9aabb79c945ed0e6cb502c1be0", "message": "Spotless.", "committedDate": "2020-10-27T19:47:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjk5MjIzNw==", "url": "https://github.com/ConsenSys/teku/pull/3092#discussion_r512992237", "bodyText": "Why are we filtering for epoch boundary states?  Is this because we're storing hot states at every epoch boundary?", "author": "mbaxter", "createdAt": "2020-10-27T19:58:18Z", "path": "storage/src/test/java/tech/pegasys/teku/storage/server/AbstractDatabaseTest.java", "diffHunk": "@@ -495,7 +495,19 @@ public void handleFinalizationWhenCacheLimitsExceeded() {\n     assertThat(tx.commit()).isCompleted();\n \n     // All finalized blocks and states should be available\n-    assertFinalizedBlocksAndStatesAvailable(newBlocks);\n+    final List<SignedBeaconBlock> expectedFinalizedBlocks =\n+        newBlocks.stream().map(SignedBlockAndState::getBlock).collect(toList());\n+    final Map<Bytes32, BeaconState> expectedFinalizedStates =\n+        newBlocks.stream()\n+            .filter(\n+                blockAndState ->\n+                    blockAndState\n+                        .getSlot()\n+                        .equals(compute_start_slot_at_epoch(blockAndState.getSlot())))", "originalCommit": "f99ef5200f076f9aabb79c945ed0e6cb502c1be0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjk5NDEyMQ==", "url": "https://github.com/ConsenSys/teku/pull/3092#discussion_r512994121", "bodyText": "Probably worth a comment", "author": "mbaxter", "createdAt": "2020-10-27T20:01:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjk5MjIzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjk5NjM3OQ==", "url": "https://github.com/ConsenSys/teku/pull/3092#discussion_r512996379", "bodyText": "Yes the test configuration is setup to store a hot state every epoch. I'll add a comment.", "author": "ajsutton", "createdAt": "2020-10-27T20:05:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjk5MjIzNw=="}], "type": "inlineReview", "revised_code": {"commit": "56865db1b0cec3f433613b74c1b6579f6c305dad", "chunk": "diff --git a/storage/src/test/java/tech/pegasys/teku/storage/server/AbstractDatabaseTest.java b/storage/src/test/java/tech/pegasys/teku/storage/server/AbstractDatabaseTest.java\nindex 7195c4bd43..0a4476e9f7 100644\n--- a/storage/src/test/java/tech/pegasys/teku/storage/server/AbstractDatabaseTest.java\n+++ b/storage/src/test/java/tech/pegasys/teku/storage/server/AbstractDatabaseTest.java\n\n@@ -499,6 +499,9 @@ public abstract class AbstractDatabaseTest {\n         newBlocks.stream().map(SignedBlockAndState::getBlock).collect(toList());\n     final Map<Bytes32, BeaconState> expectedFinalizedStates =\n         newBlocks.stream()\n+            // Hot state is recorded for the first block of each epoch and we only use the available\n+            // states, so ensure that at least those are available (some others will be available\n+            // because they were in cache)\n             .filter(\n                 blockAndState ->\n                     blockAndState\n"}}, {"oid": "56865db1b0cec3f433613b74c1b6579f6c305dad", "url": "https://github.com/ConsenSys/teku/commit/56865db1b0cec3f433613b74c1b6579f6c305dad", "message": "Add comment explaining why not all states are available.", "committedDate": "2020-10-27T20:01:58Z", "type": "commit"}]}