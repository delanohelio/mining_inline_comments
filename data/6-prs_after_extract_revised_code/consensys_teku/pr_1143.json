{"pr_number": 1143, "pr_title": "Make Sync Work", "pr_createdAt": "2020-02-08T00:21:03Z", "pr_url": "https://github.com/ConsenSys/teku/pull/1143", "timeline": [{"oid": "e03f4c32c9b8038aec316f0c4e1e7fdbe5c29232", "url": "https://github.com/ConsenSys/teku/commit/e03f4c32c9b8038aec316f0c4e1e7fdbe5c29232", "message": "Update PeerSync to work with BlocksByRange changes", "committedDate": "2020-02-08T00:13:36Z", "type": "commit"}, {"oid": "c09ae70af58e722df75ff5d6353c4f75edf8f6eb", "url": "https://github.com/ConsenSys/teku/commit/c09ae70af58e722df75ff5d6353c4f75edf8f6eb", "message": "Clean up peer reconnect logic", "committedDate": "2020-02-08T00:13:36Z", "type": "commit"}, {"oid": "50035d4f12b4b9148853d2922b439c7a079ec143", "url": "https://github.com/ConsenSys/teku/commit/50035d4f12b4b9148853d2922b439c7a079ec143", "message": "Add more logging", "committedDate": "2020-02-08T00:13:36Z", "type": "commit"}, {"oid": "c645bb915b0de1a401407bbea23c21eb7b26e485", "url": "https://github.com/ConsenSys/teku/commit/c645bb915b0de1a401407bbea23c21eb7b26e485", "message": "Add more logging, tweak retry logic in SyncManager", "committedDate": "2020-02-08T00:13:36Z", "type": "commit"}, {"oid": "e05003deca574491bb0fb335640da781e5d76ced", "url": "https://github.com/ConsenSys/teku/commit/e05003deca574491bb0fb335640da781e5d76ced", "message": "Update PeerManagerTest to use AsyncRunner", "committedDate": "2020-02-08T00:13:36Z", "type": "commit"}, {"oid": "24833388d783644b9b724a8c76569acd6f3185a2", "url": "https://github.com/ConsenSys/teku/commit/24833388d783644b9b724a8c76569acd6f3185a2", "message": "Add explicit handling for status send to make logs quieter", "committedDate": "2020-02-08T00:13:37Z", "type": "commit"}, {"oid": "fb30e277e4cdb9dc973adb508f4cfc85d9c04f6e", "url": "https://github.com/ConsenSys/teku/commit/fb30e277e4cdb9dc973adb508f4cfc85d9c04f6e", "message": "Make private key optional", "committedDate": "2020-02-08T00:13:37Z", "type": "commit"}, {"oid": "ad81c3bad7ee247b013bcf5a433aec15ae1123ee", "url": "https://github.com/ConsenSys/teku/commit/ad81c3bad7ee247b013bcf5a433aec15ae1123ee", "message": "Fully close rpc stream when we're done receiving responses", "committedDate": "2020-02-08T00:13:37Z", "type": "commit"}, {"oid": "65918c15b722c513afec01fc78e5c3016b882bb7", "url": "https://github.com/ConsenSys/teku/commit/65918c15b722c513afec01fc78e5c3016b882bb7", "message": "Catch and log unexpected errors during block import", "committedDate": "2020-02-08T00:13:37Z", "type": "commit"}, {"oid": "5217e6739697a3454087f56e4c7ae81bc9977984", "url": "https://github.com/ConsenSys/teku/commit/5217e6739697a3454087f56e4c7ae81bc9977984", "message": "To avoid rate limiting, pause before issuing follow-up request to peer", "committedDate": "2020-02-08T00:13:37Z", "type": "commit"}, {"oid": "062dea981264c7d9eaf45e0d3713b57c79711c75", "url": "https://github.com/ConsenSys/teku/commit/062dea981264c7d9eaf45e0d3713b57c79711c75", "message": "Account for prysm's special handling of genesis blocks", "committedDate": "2020-02-08T00:13:37Z", "type": "commit"}, {"oid": "6d5b86166956006c4195d7e31cd538e8b27561b3", "url": "https://github.com/ConsenSys/teku/commit/6d5b86166956006c4195d7e31cd538e8b27561b3", "message": "Merge branch 'master' into sync/rework-peer-sync", "committedDate": "2020-02-10T15:32:30Z", "type": "commit"}, {"oid": "e0d6468e8de993f1d0b8936ebedb6d8e102de13e", "url": "https://github.com/ConsenSys/teku/commit/e0d6468e8de993f1d0b8936ebedb6d8e102de13e", "message": "Return initial connection future from connect()", "committedDate": "2020-02-10T15:46:33Z", "type": "commit"}, {"oid": "ca56949601e2341e64a45d4c0c13ff222ee6375f", "url": "https://github.com/ConsenSys/teku/commit/ca56949601e2341e64a45d4c0c13ff222ee6375f", "message": "Ignore retry future", "committedDate": "2020-02-10T15:51:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM4MjI3Ng==", "url": "https://github.com/ConsenSys/teku/pull/1143#discussion_r377382276", "bodyText": "Given that this shouldn't ever complete exceptionally, could we use reportExceptions() on the end instead of ignoreFuture?  That way if for some reason an exception does bubble up because of a bug somewhere it will get logged instead of silently ignored.", "author": "ajsutton", "createdAt": "2020-02-10T23:40:22Z", "path": "networking/p2p/src/main/java/tech/pegasys/artemis/networking/p2p/libp2p/PeerManager.java", "diffHunk": "@@ -83,36 +84,34 @@ public void unsubscribeConnect(final long subscriptionId) {\n \n   public SafeFuture<?> connect(final Multiaddr peer, final Network network) {\n     STDOUT.log(Level.DEBUG, \"Connecting to \" + peer);\n-    return SafeFuture.of(network.connect(peer))\n-        .whenComplete(\n-            (conn, throwable) -> {\n-              if (throwable != null) {\n-                STDOUT.log(\n-                    Level.DEBUG,\n-                    \"Connection to \" + peer + \" failed. Will retry shortly: \" + throwable);\n-                ignoreFuture(\n-                    scheduler.schedule(\n-                        () -> connect(peer, network).reportExceptions(),\n-                        RECONNECT_TIMEOUT,\n-                        TimeUnit.MILLISECONDS));\n-              } else {\n-                STDOUT.log(\n-                    Level.DEBUG,\n-                    \"Connection to peer: \"\n-                        + conn.secureSession().getRemoteId()\n-                        + \" was successful\");\n-                SafeFuture.of(conn.closeFuture())\n-                    .finish(\n-                        () -> {\n-                          LOG.debug(\"Connection to {} closed. Will retry shortly\", peer);\n-                          ignoreFuture(\n-                              scheduler.schedule(\n-                                  () -> connect(peer, network).reportExceptions(),\n-                                  RECONNECT_TIMEOUT,\n-                                  TimeUnit.MILLISECONDS));\n-                        });\n-              }\n-            });\n+    final SafeFuture<Connection> initialConnectionFuture = SafeFuture.of(network.connect(peer));\n+    final SafeFuture<?> retryLoop =\n+        initialConnectionFuture\n+            .thenCompose(\n+                conn -> {\n+                  LOG.debug(\n+                      \"Connection to peer {} was successful\", conn.secureSession().getRemoteId());\n+                  return SafeFuture.of(conn.closeFuture());\n+                })\n+            .exceptionally(\n+                (err) -> {\n+                  LOG.debug(\"Connection to {} failed: {}\", peer, err);\n+                  return null;\n+                })\n+            .thenCompose(\n+                (res) -> {\n+                  LOG.debug(\n+                      \"Connection to {} was closed. Will retry in {} sec\",\n+                      peer,\n+                      RECONNECT_TIMEOUT.toSeconds());\n+\n+                  return asynRunner.runAfterDelay(\n+                      () -> connect(peer, network),\n+                      RECONNECT_TIMEOUT.toMillis(),\n+                      TimeUnit.MILLISECONDS);\n+                });\n+    ignoreFuture(retryLoop);", "originalCommit": "ca56949601e2341e64a45d4c0c13ff222ee6375f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzY5MTE1NA==", "url": "https://github.com/ConsenSys/teku/pull/1143#discussion_r377691154", "bodyText": "\ud83d\udc4dupdated", "author": "mbaxter", "createdAt": "2020-02-11T15:04:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM4MjI3Ng=="}], "type": "inlineReview", "revised_code": {"commit": "d395399da45c123ec3d6054f51c8ad0694cbdf09", "chunk": "diff --git a/networking/p2p/src/main/java/tech/pegasys/artemis/networking/p2p/libp2p/PeerManager.java b/networking/p2p/src/main/java/tech/pegasys/artemis/networking/p2p/libp2p/PeerManager.java\nindex 3bfc6e370c..7207952ece 100644\n--- a/networking/p2p/src/main/java/tech/pegasys/artemis/networking/p2p/libp2p/PeerManager.java\n+++ b/networking/p2p/src/main/java/tech/pegasys/artemis/networking/p2p/libp2p/PeerManager.java\n\n@@ -83,34 +82,34 @@ public class PeerManager implements ConnectionHandler {\n   }\n \n   public SafeFuture<?> connect(final Multiaddr peer, final Network network) {\n-    STDOUT.log(Level.DEBUG, \"Connecting to \" + peer);\n+    LOG.debug(\"Connecting to {}\", peer);\n     final SafeFuture<Connection> initialConnectionFuture = SafeFuture.of(network.connect(peer));\n-    final SafeFuture<?> retryLoop =\n-        initialConnectionFuture\n-            .thenCompose(\n-                conn -> {\n-                  LOG.debug(\n-                      \"Connection to peer {} was successful\", conn.secureSession().getRemoteId());\n-                  return SafeFuture.of(conn.closeFuture());\n-                })\n-            .exceptionally(\n-                (err) -> {\n-                  LOG.debug(\"Connection to {} failed: {}\", peer, err);\n-                  return null;\n-                })\n-            .thenCompose(\n-                (res) -> {\n-                  LOG.debug(\n-                      \"Connection to {} was closed. Will retry in {} sec\",\n-                      peer,\n-                      RECONNECT_TIMEOUT.toSeconds());\n-\n-                  return asynRunner.runAfterDelay(\n-                      () -> connect(peer, network),\n-                      RECONNECT_TIMEOUT.toMillis(),\n-                      TimeUnit.MILLISECONDS);\n-                });\n-    ignoreFuture(retryLoop);\n+\n+    // Retry if peer disconnects or we fail to connect\n+    initialConnectionFuture\n+        .thenCompose(\n+            conn -> {\n+              LOG.debug(\"Connection to peer {} was successful\", conn.secureSession().getRemoteId());\n+              return SafeFuture.of(conn.closeFuture());\n+            })\n+        .exceptionally(\n+            (err) -> {\n+              LOG.debug(\"Connection to {} failed: {}\", peer, err);\n+              return null;\n+            })\n+        .thenCompose(\n+            (res) -> {\n+              LOG.debug(\n+                  \"Connection to {} was closed. Will retry in {} sec\",\n+                  peer,\n+                  RECONNECT_TIMEOUT.toSeconds());\n+              return asyncRunner.runAfterDelay(\n+                  () -> connect(peer, network).exceptionally(err -> null),\n+                  RECONNECT_TIMEOUT.toMillis(),\n+                  TimeUnit.MILLISECONDS);\n+            })\n+        .reportExceptions();\n+\n     return initialConnectionFuture;\n   }\n \n"}}, {"oid": "966ebcfef795a5dac256e319c8608cdb6cd3b9e8", "url": "https://github.com/ConsenSys/teku/commit/966ebcfef795a5dac256e319c8608cdb6cd3b9e8", "message": "Merge branch 'master' into sync/rework-peer-sync", "committedDate": "2020-02-11T00:17:52Z", "type": "commit"}, {"oid": "d395399da45c123ec3d6054f51c8ad0694cbdf09", "url": "https://github.com/ConsenSys/teku/commit/d395399da45c123ec3d6054f51c8ad0694cbdf09", "message": "Report async scheduling exceptions", "committedDate": "2020-02-11T15:00:28Z", "type": "commit"}, {"oid": "34b818372546952fc7844e0a49d3e0a85e989656", "url": "https://github.com/ConsenSys/teku/commit/34b818372546952fc7844e0a49d3e0a85e989656", "message": "Increase connectionn retry rate for more stable integration tests", "committedDate": "2020-02-11T15:13:51Z", "type": "commit"}]}