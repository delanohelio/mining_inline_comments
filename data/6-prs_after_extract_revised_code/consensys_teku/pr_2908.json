{"pr_number": 2908, "pr_title": "[QS-9-10] Reject attestations that fail ancestry condition", "pr_createdAt": "2020-10-07T16:07:18Z", "pr_url": "https://github.com/ConsenSys/teku/pull/2908", "timeline": [{"oid": "074e82fba9b4e4e8e3025194a5540ea41a1e2aea", "url": "https://github.com/ConsenSys/teku/commit/074e82fba9b4e4e8e3025194a5540ea41a1e2aea", "message": "Reject attestations that fail ancestry condition", "committedDate": "2020-10-07T16:05:46Z", "type": "commit"}, {"oid": "49fa197b1574ebdbed34ebc4ca8a6d72baa1d890", "url": "https://github.com/ConsenSys/teku/commit/49fa197b1574ebdbed34ebc4ca8a6d72baa1d890", "message": "Run spotless", "committedDate": "2020-10-07T16:06:31Z", "type": "commit"}, {"oid": "6c69ca5e79fbb4caa405063af2ae17b9b5517c1e", "url": "https://github.com/ConsenSys/teku/commit/6c69ca5e79fbb4caa405063af2ae17b9b5517c1e", "message": "Merge branch 'master' into qs-9-10/reject-attestations-that-fail-ancestry-condition", "committedDate": "2020-10-07T16:07:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTIwNDUzMQ==", "url": "https://github.com/ConsenSys/teku/pull/2908#discussion_r501204531", "bodyText": "BTW can't it be the concurrency case when recentChainData updates its finalized checkpoint between calls recentChainData.getFinalizedEpoch() and recentChainData.getFinalizedCheckpoint()?\nMay be get recentChainData.getFinalizedCheckpoint() once into local var to be certainly safe on this?", "author": "Nashatyrev", "createdAt": "2020-10-07T17:57:15Z", "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/gossip/topics/validation/AttestationValidator.java", "diffHunk": "@@ -191,6 +191,21 @@ private InternalValidationResult singleAttestationChecks(final Attestation attes\n                 return REJECT;\n               }\n \n+              // The current finalized_checkpoint is an ancestor of the block defined by\n+              // aggregate.data.beacon_block_root\n+              if (!forkChoiceUtilWrapper\n+                  .get_ancestor(\n+                      recentChainData.getForkChoiceStrategy().orElseThrow(),\n+                      data.getBeacon_block_root(),\n+                      compute_start_slot_at_epoch(recentChainData.getFinalizedEpoch()))\n+                  .map(\n+                      ancestorOfLMDVote ->\n+                          ancestorOfLMDVote.equals(\n+                              recentChainData.getFinalizedCheckpoint().orElseThrow().getRoot()))", "originalCommit": "6c69ca5e79fbb4caa405063af2ae17b9b5517c1e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTI0NTQ3Nw==", "url": "https://github.com/ConsenSys/teku/pull/2908#discussion_r501245477", "bodyText": "Good point. Will make the change.", "author": "cemozerr", "createdAt": "2020-10-07T19:05:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTIwNDUzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTI2MDIxNA==", "url": "https://github.com/ConsenSys/teku/pull/2908#discussion_r501260214", "bodyText": "Done.", "author": "cemozerr", "createdAt": "2020-10-07T19:32:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTIwNDUzMQ=="}], "type": "inlineReview", "revised_code": {"commit": "4f64149775a24f5e7ee3909acf5310e6ef411341", "chunk": "diff --git a/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/gossip/topics/validation/AttestationValidator.java b/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/gossip/topics/validation/AttestationValidator.java\nindex 80ddbdda47..45f42a5c2d 100644\n--- a/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/gossip/topics/validation/AttestationValidator.java\n+++ b/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/gossip/topics/validation/AttestationValidator.java\n\n@@ -193,15 +194,15 @@ public class AttestationValidator {\n \n               // The current finalized_checkpoint is an ancestor of the block defined by\n               // aggregate.data.beacon_block_root\n+              Checkpoint finalizedCheckpoint = recentChainData.getFinalizedCheckpoint().orElseThrow();\n               if (!forkChoiceUtilWrapper\n                   .get_ancestor(\n                       recentChainData.getForkChoiceStrategy().orElseThrow(),\n                       data.getBeacon_block_root(),\n-                      compute_start_slot_at_epoch(recentChainData.getFinalizedEpoch()))\n+                      compute_start_slot_at_epoch(finalizedCheckpoint.getEpoch()))\n                   .map(\n                       ancestorOfLMDVote ->\n-                          ancestorOfLMDVote.equals(\n-                              recentChainData.getFinalizedCheckpoint().orElseThrow().getRoot()))\n+                          ancestorOfLMDVote.equals(finalizedCheckpoint.getRoot()))\n                   .orElse(false)) {\n                 return REJECT;\n               }\n"}}, {"oid": "4f64149775a24f5e7ee3909acf5310e6ef411341", "url": "https://github.com/ConsenSys/teku/commit/4f64149775a24f5e7ee3909acf5310e6ef411341", "message": "Resolve comment", "committedDate": "2020-10-07T19:11:32Z", "type": "commit"}, {"oid": "080a2ee33daefdcb92b5dfca660e3dc9e91a4684", "url": "https://github.com/ConsenSys/teku/commit/080a2ee33daefdcb92b5dfca660e3dc9e91a4684", "message": "Run spotless", "committedDate": "2020-10-07T19:11:32Z", "type": "commit"}, {"oid": "6b2c048c4aa31f201cb7e26c84d8e6a4310534d2", "url": "https://github.com/ConsenSys/teku/commit/6b2c048c4aa31f201cb7e26c84d8e6a4310534d2", "message": "Merge branch 'master' into qs-9-10/reject-attestations-that-fail-ancestry-condition", "committedDate": "2020-10-07T19:32:48Z", "type": "commit"}]}