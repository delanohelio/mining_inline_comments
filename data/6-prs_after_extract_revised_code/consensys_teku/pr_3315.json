{"pr_number": 3315, "pr_title": "Optimize ValidatorsUtil.getValidatorIndex", "pr_createdAt": "2020-11-25T12:37:10Z", "pr_url": "https://github.com/ConsenSys/teku/pull/3315", "timeline": [{"oid": "fd7ef91e11b6e6bb8992bc5b8354b3406609147c", "url": "https://github.com/ConsenSys/teku/commit/fd7ef91e11b6e6bb8992bc5b8354b3406609147c", "message": "Make Validator.getPubkey() to return Bytes48 instead of construction-expensive BLSPublicKey\nUse ValidatorsUtil.getValidatorPubKey where possible to make use of BLSPublicKey instance cache", "committedDate": "2020-11-25T10:14:24Z", "type": "commit"}, {"oid": "803cfeb706d74352860a966e1383b59cc2e4a2d1", "url": "https://github.com/ConsenSys/teku/commit/803cfeb706d74352860a966e1383b59cc2e4a2d1", "message": "Add javadoc", "committedDate": "2020-11-25T10:34:25Z", "type": "commit"}, {"oid": "d88b16c422c517e3388e0afe28cacad0df637ab6", "url": "https://github.com/ConsenSys/teku/commit/d88b16c422c517e3388e0afe28cacad0df637ab6", "message": "Fix Validator SSZ", "committedDate": "2020-11-25T11:12:47Z", "type": "commit"}, {"oid": "e9fc54ab10669681a35c1b2620f96584690c1cc7", "url": "https://github.com/ConsenSys/teku/commit/e9fc54ab10669681a35c1b2620f96584690c1cc7", "message": "Fix ValidatorApiHandler.createAttesterDuties handling of invalid validatorIndex", "committedDate": "2020-11-25T11:54:18Z", "type": "commit"}, {"oid": "0ebac5eb2ad425009742347ec27d40b2fd51550d", "url": "https://github.com/ConsenSys/teku/commit/0ebac5eb2ad425009742347ec27d40b2fd51550d", "message": "Eagerly pre-cache pubKey => validatorIndex mapping in ValidatorsUtil.getValidatorPubKey", "committedDate": "2020-11-25T12:17:23Z", "type": "commit"}, {"oid": "0aebecd684752f5c3f67fa4421d38e3181de5523", "url": "https://github.com/ConsenSys/teku/commit/0aebecd684752f5c3f67fa4421d38e3181de5523", "message": "Add opposite pubkey => index caching only on index => pubkey cache miss", "committedDate": "2020-11-25T12:29:18Z", "type": "commit"}, {"oid": "18d4c4e4212548a378a24f9a7ef0adea87645514", "url": "https://github.com/ConsenSys/teku/commit/18d4c4e4212548a378a24f9a7ef0adea87645514", "message": "Spotless", "committedDate": "2020-11-25T12:39:13Z", "type": "commit"}, {"oid": "d3bcd471cd515f9601767b60df51fdea0b49e2eb", "url": "https://github.com/ConsenSys/teku/commit/d3bcd471cd515f9601767b60df51fdea0b49e2eb", "message": "Merge branch 'master' into optimize/get-validator-index-by-pubkey", "committedDate": "2020-11-25T22:21:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDY4MDU1Nw==", "url": "https://github.com/ConsenSys/teku/pull/3315#discussion_r530680557", "bodyText": "I like this - nice and simple but very effective.", "author": "ajsutton", "createdAt": "2020-11-25T22:47:19Z", "path": "ethereum/datastructures/src/main/java/tech/pegasys/teku/datastructures/util/ValidatorsUtil.java", "diffHunk": "@@ -77,7 +77,19 @@ public static boolean is_eligible_for_activation(BeaconState state, Validator va\n     return Optional.of(\n         BeaconStateCache.getTransitionCaches(state)\n             .getValidatorsPubKeys()\n-            .get(validatorIndex, i -> state.getValidators().get(i.intValue()).getPubkey()));\n+            .get(\n+                validatorIndex,\n+                i -> {\n+                  BLSPublicKey pubKey =\n+                      BLSPublicKey.fromBytesCompressed(\n+                          state.getValidators().get(i.intValue()).getPubkey());\n+\n+                  // eagerly pre-cache pubKey => validatorIndex mapping\n+                  BeaconStateCache.getTransitionCaches(state)\n+                      .getValidatorIndex()\n+                      .invalidateWithNewValue(pubKey, i.intValue());\n+                  return pubKey;\n+                }));", "originalCommit": "18d4c4e4212548a378a24f9a7ef0adea87645514", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8596af11603f587a622c3e039ecc8678255c22e8", "chunk": "diff --git a/ethereum/datastructures/src/main/java/tech/pegasys/teku/datastructures/util/ValidatorsUtil.java b/ethereum/datastructures/src/main/java/tech/pegasys/teku/datastructures/util/ValidatorsUtil.java\nindex d74befd4a8..55e1902048 100644\n--- a/ethereum/datastructures/src/main/java/tech/pegasys/teku/datastructures/util/ValidatorsUtil.java\n+++ b/ethereum/datastructures/src/main/java/tech/pegasys/teku/datastructures/util/ValidatorsUtil.java\n\n@@ -79,17 +79,9 @@ public class ValidatorsUtil {\n             .getValidatorsPubKeys()\n             .get(\n                 validatorIndex,\n-                i -> {\n-                  BLSPublicKey pubKey =\n-                      BLSPublicKey.fromBytesCompressed(\n-                          state.getValidators().get(i.intValue()).getPubkey());\n-\n-                  // eagerly pre-cache pubKey => validatorIndex mapping\n-                  BeaconStateCache.getTransitionCaches(state)\n-                      .getValidatorIndex()\n-                      .invalidateWithNewValue(pubKey, i.intValue());\n-                  return pubKey;\n-                }));\n+                i ->\n+                    BLSPublicKey.fromBytesCompressed(\n+                        state.getValidators().get(i.intValue()).getPubkey())));\n   }\n \n   /**\n"}}, {"oid": "8596af11603f587a622c3e039ecc8678255c22e8", "url": "https://github.com/ConsenSys/teku/commit/8596af11603f587a622c3e039ecc8678255c22e8", "message": "Throw BlocksProcessingException instead of NoSuchelementException\n\nCo-authored-by: Adrian Sutton <adrian@symphonious.net>", "committedDate": "2020-11-26T08:09:43Z", "type": "commit"}, {"oid": "7679f337aa64f39129226adc56653b863fe5aff0", "url": "https://github.com/ConsenSys/teku/commit/7679f337aa64f39129226adc56653b863fe5aff0", "message": "Just return false from verifySignature() when slashing proposer index is invalid", "committedDate": "2020-11-26T08:26:11Z", "type": "commit"}, {"oid": "d3042c92e86b6a509f420ffc2d5e0987d3c9c0df", "url": "https://github.com/ConsenSys/teku/commit/d3042c92e86b6a509f420ffc2d5e0987d3c9c0df", "message": "Shorten the code\n\nCo-authored-by: Adrian Sutton <adrian@symphonious.net>", "committedDate": "2020-11-26T08:40:07Z", "type": "commit"}, {"oid": "ed0b0c699878bce301426294320dd58107072651", "url": "https://github.com/ConsenSys/teku/commit/ed0b0c699878bce301426294320dd58107072651", "message": "Just return false from verifySignature() when voluntary exit validator index is invalid", "committedDate": "2020-11-26T08:46:59Z", "type": "commit"}, {"oid": "dabded072f40eaaed51b5b611935321e2c1e8e25", "url": "https://github.com/ConsenSys/teku/commit/dabded072f40eaaed51b5b611935321e2c1e8e25", "message": "Merge branch 'fix/use-validator-pubkey-cache' of https://github.com/Nashatyrev/artemis into fix/use-validator-pubkey-cache", "committedDate": "2020-11-26T08:48:44Z", "type": "commit"}, {"oid": "9ab78ffbbd6fad063a9d702734e298cc288e9d20", "url": "https://github.com/ConsenSys/teku/commit/9ab78ffbbd6fad063a9d702734e298cc288e9d20", "message": "Merge branch 'master' into fix/use-validator-pubkey-cache", "committedDate": "2020-11-26T08:49:37Z", "type": "commit"}, {"oid": "0f2e03da07c7a088082563f0efee708fd4a798fe", "url": "https://github.com/ConsenSys/teku/commit/0f2e03da07c7a088082563f0efee708fd4a798fe", "message": "Sptoless", "committedDate": "2020-11-26T09:06:04Z", "type": "commit"}, {"oid": "14f7c8763b17d0e838983d220a8419bbca85b641", "url": "https://github.com/ConsenSys/teku/commit/14f7c8763b17d0e838983d220a8419bbca85b641", "message": "Merge remote-tracking branch 'ConsenSys/master' into fix/use-validator-pubkey-cache", "committedDate": "2020-11-26T09:21:12Z", "type": "commit"}, {"oid": "e2418b1e52768bca8d8b5219c7170d3bda4ed4a8", "url": "https://github.com/ConsenSys/teku/commit/e2418b1e52768bca8d8b5219c7170d3bda4ed4a8", "message": "Merge branch 'fix/use-validator-pubkey-cache' into optimize/get-validator-index-by-pubkey", "committedDate": "2020-11-26T09:22:19Z", "type": "commit"}]}