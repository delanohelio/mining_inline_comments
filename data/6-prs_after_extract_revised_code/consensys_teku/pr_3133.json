{"pr_number": 3133, "pr_title": "[Issue 3063] Add BeaconBlockSummary interface", "pr_createdAt": "2020-11-03T01:09:01Z", "pr_url": "https://github.com/ConsenSys/teku/pull/3133", "timeline": [{"oid": "8a8d8a15f2ebbcb243f9a2ab50aaa21ad2df4f2e", "url": "https://github.com/ConsenSys/teku/commit/8a8d8a15f2ebbcb243f9a2ab50aaa21ad2df4f2e", "message": "Remove CheckpointState.getBlock() method", "committedDate": "2020-11-03T00:35:00Z", "type": "commit"}, {"oid": "a586505aa2fdc0d35c9a4dabb7807e6da7b675fd", "url": "https://github.com/ConsenSys/teku/commit/a586505aa2fdc0d35c9a4dabb7807e6da7b675fd", "message": "Remove block requirement from AnchorPoint and CheckpointState", "committedDate": "2020-11-03T00:35:00Z", "type": "commit"}, {"oid": "d342fb45e894bfea575846f168638f1478b7825b", "url": "https://github.com/ConsenSys/teku/commit/d342fb45e894bfea575846f168638f1478b7825b", "message": "Add BeaconBlockSummary interface", "committedDate": "2020-11-03T00:35:00Z", "type": "commit"}, {"oid": "9d03135a1df4df5bcb57928e99f1f0eb8da90630", "url": "https://github.com/ConsenSys/teku/commit/9d03135a1df4df5bcb57928e99f1f0eb8da90630", "message": "Use generic summary type to allow Store.states to cache latest finalized", "committedDate": "2020-11-03T00:35:00Z", "type": "commit"}, {"oid": "ae2b6350c4d7a0d04feeb595f5960a2b9c89e6a9", "url": "https://github.com/ConsenSys/teku/commit/ae2b6350c4d7a0d04feeb595f5960a2b9c89e6a9", "message": "Update AnchorPoint to extend summary interface", "committedDate": "2020-11-03T00:35:00Z", "type": "commit"}, {"oid": "edb0aadf929645cc736de7dc76048573b6ee27f3", "url": "https://github.com/ConsenSys/teku/commit/edb0aadf929645cc736de7dc76048573b6ee27f3", "message": "Update Chainhead to extend summary interface", "committedDate": "2020-11-03T00:35:00Z", "type": "commit"}, {"oid": "b10ca8fa2d739b6b482be828a39a9ec49b83a64a", "url": "https://github.com/ConsenSys/teku/commit/b10ca8fa2d739b6b482be828a39a9ec49b83a64a", "message": "Update BeaconBlockAndState to extend summary class", "committedDate": "2020-11-03T00:35:00Z", "type": "commit"}, {"oid": "4653e2145a756ed340142b14c8b393368e19e1a1", "url": "https://github.com/ConsenSys/teku/commit/4653e2145a756ed340142b14c8b393368e19e1a1", "message": "Fix store assertions", "committedDate": "2020-11-03T00:35:00Z", "type": "commit"}, {"oid": "742983cf1bba1a3e5e04aae515e0c59f304245bb", "url": "https://github.com/ConsenSys/teku/commit/742983cf1bba1a3e5e04aae515e0c59f304245bb", "message": "Fix call to pull latest finalized block", "committedDate": "2020-11-03T00:35:00Z", "type": "commit"}, {"oid": "6fb5697c9a13e8382dbf9e7577a9ac9b8120ef79", "url": "https://github.com/ConsenSys/teku/commit/6fb5697c9a13e8382dbf9e7577a9ac9b8120ef79", "message": "Fix test mocks", "committedDate": "2020-11-03T00:35:00Z", "type": "commit"}, {"oid": "3e9b993c8bd476854f6470d72597b3989f113b84", "url": "https://github.com/ConsenSys/teku/commit/3e9b993c8bd476854f6470d72597b3989f113b84", "message": "Rework ChainHead accessor to return summary type", "committedDate": "2020-11-03T00:35:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjM5NzcxNA==", "url": "https://github.com/ConsenSys/teku/pull/3133#discussion_r516397714", "bodyText": "nit: I think you can just use:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    block.getBody().hash_tree_root());\n          \n          \n            \n                    block.getBodyRoot());", "author": "ajsutton", "createdAt": "2020-11-03T02:30:20Z", "path": "ethereum/datastructures/src/main/java/tech/pegasys/teku/datastructures/blocks/BeaconBlockHeader.java", "diffHunk": "@@ -87,6 +94,43 @@ public BeaconBlockHeader() {\n     super(TYPE);\n   }\n \n+  /**\n+   * Returns the block header associated with this state\n+   *\n+   * @param state A beacon state\n+   * @return The latest block header from the state, with stateRoot pointing to the supplied state\n+   */\n+  public static BeaconBlockHeader fromState(final BeaconState state) {\n+    BeaconBlockHeader latestHeader = state.getLatest_block_header();\n+\n+    if (latestHeader.getStateRoot().isZero()) {\n+      // If the state root is empty, replace it with the current state root\n+      final Bytes32 stateRoot = state.hash_tree_root();\n+      latestHeader =\n+          new BeaconBlockHeader(\n+              latestHeader.getSlot(),\n+              latestHeader.getProposerIndex(),\n+              latestHeader.getParentRoot(),\n+              stateRoot,\n+              latestHeader.getBodyRoot());\n+    }\n+\n+    return latestHeader;\n+  }\n+\n+  public static BeaconBlockHeader fromBlock(final BeaconBlock block) {\n+    return new BeaconBlockHeader(\n+        block.getSlot(),\n+        block.getProposerIndex(),\n+        block.getParentRoot(),\n+        block.getStateRoot(),\n+        block.getBody().hash_tree_root());", "originalCommit": "3e9b993c8bd476854f6470d72597b3989f113b84", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bde0c779edc8b827c310999aef735e8e2ea5e4c6", "chunk": "diff --git a/ethereum/datastructures/src/main/java/tech/pegasys/teku/datastructures/blocks/BeaconBlockHeader.java b/ethereum/datastructures/src/main/java/tech/pegasys/teku/datastructures/blocks/BeaconBlockHeader.java\nindex 8303ca3dcb..44cd2dad34 100644\n--- a/ethereum/datastructures/src/main/java/tech/pegasys/teku/datastructures/blocks/BeaconBlockHeader.java\n+++ b/ethereum/datastructures/src/main/java/tech/pegasys/teku/datastructures/blocks/BeaconBlockHeader.java\n\n@@ -124,7 +124,7 @@ public class BeaconBlockHeader extends AbstractImmutableContainer\n         block.getProposerIndex(),\n         block.getParentRoot(),\n         block.getStateRoot(),\n-        block.getBody().hash_tree_root());\n+        block.getBodyRoot());\n   }\n \n   public static BeaconBlockHeader fromBlock(final SignedBeaconBlock block) {\n"}}, {"oid": "beda0ce2c56a01a426d23455506908bc50b4f624", "url": "https://github.com/ConsenSys/teku/commit/beda0ce2c56a01a426d23455506908bc50b4f624", "message": "Fix spotless error", "committedDate": "2020-11-03T19:52:53Z", "type": "commit"}, {"oid": "bde0c779edc8b827c310999aef735e8e2ea5e4c6", "url": "https://github.com/ConsenSys/teku/commit/bde0c779edc8b827c310999aef735e8e2ea5e4c6", "message": "Clean up", "committedDate": "2020-11-03T20:25:27Z", "type": "commit"}, {"oid": "3773bf06ff65df61d7e4a597962a3b9da6dc07b8", "url": "https://github.com/ConsenSys/teku/commit/3773bf06ff65df61d7e4a597962a3b9da6dc07b8", "message": "Don't lookup / cache block when retrieving block summary", "committedDate": "2020-11-03T20:26:05Z", "type": "commit"}, {"oid": "58e0309ff68fcdd584d7d23dc0aef3ba48816920", "url": "https://github.com/ConsenSys/teku/commit/58e0309ff68fcdd584d7d23dc0aef3ba48816920", "message": "Fix state regeneration tests", "committedDate": "2020-11-03T20:49:38Z", "type": "commit"}, {"oid": "86730e39584491125c144ce7fd05b7bdd649f7ec", "url": "https://github.com/ConsenSys/teku/commit/86730e39584491125c144ce7fd05b7bdd649f7ec", "message": "Fix ProtoArray test", "committedDate": "2020-11-03T20:53:47Z", "type": "commit"}, {"oid": "fae86428b93601da3efe43e99cf9c3e8d9d2d5b1", "url": "https://github.com/ConsenSys/teku/commit/fae86428b93601da3efe43e99cf9c3e8d9d2d5b1", "message": "Hold a BlockSummary rather than a BlockHeader in CheckpointState", "committedDate": "2020-11-04T21:08:34Z", "type": "commit"}, {"oid": "519a5e7dca78c14648b0aa0bc8b6e94fe42b7913", "url": "https://github.com/ConsenSys/teku/commit/519a5e7dca78c14648b0aa0bc8b6e94fe42b7913", "message": "Fix tests", "committedDate": "2020-11-04T21:14:30Z", "type": "commit"}, {"oid": "f51e653b5d10cd879c6f8200590c8c32c17d4d62", "url": "https://github.com/ConsenSys/teku/commit/f51e653b5d10cd879c6f8200590c8c32c17d4d62", "message": "Simplify AnchorPoint", "committedDate": "2020-11-04T21:19:29Z", "type": "commit"}, {"oid": "79567956621c69f1600c5435a111ad58e1047e9a", "url": "https://github.com/ConsenSys/teku/commit/79567956621c69f1600c5435a111ad58e1047e9a", "message": "Update WeakSubjectivityValidatorTest", "committedDate": "2020-11-04T22:41:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzY4ODE1MQ==", "url": "https://github.com/ConsenSys/teku/pull/3133#discussion_r517688151", "bodyText": "This is potentially a bit heavy handed as it removes all compile time checking.  Can we get away with:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        .map(BeaconBlockSummary.class::cast)\n          \n          \n            \n                        .<BeaconBlockSummary>map(a -> a)\n          \n      \n    \n    \n  \n\nIt doesn't read quite as well, but will give compile errors if block ever winds up not actually being a BeaconBlockSummary.", "author": "ajsutton", "createdAt": "2020-11-04T23:19:10Z", "path": "ethereum/datastructures/src/main/java/tech/pegasys/teku/datastructures/state/AnchorPoint.java", "diffHunk": "@@ -30,33 +34,36 @@\n  * Represents an \"anchor\" - a trusted, finalized (block, state, checkpoint) tuple from which we can\n  * sync.\n  */\n-public class AnchorPoint {\n+public class AnchorPoint extends StateAndBlockSummary {\n   private final Checkpoint checkpoint;\n-  private final SignedBeaconBlock block;\n-  private final BeaconState state;\n   private final boolean isGenesis;\n-  private final SignedBlockAndState blockAndState;\n \n   private AnchorPoint(\n-      final Checkpoint checkpoint, final SignedBeaconBlock block, final BeaconState state) {\n+      final Checkpoint checkpoint, final BeaconState state, final BeaconBlockSummary blockSummary) {\n+    super(blockSummary, state);\n     checkArgument(\n-        block.getStateRoot().equals(state.hash_tree_root()), \"Block and state must match\");\n-    checkArgument(checkpoint.getRoot().equals(block.getRoot()), \"Checkpoint and block must match\");\n+        checkpoint.getRoot().equals(blockSummary.getRoot()), \"Checkpoint and block must match\");\n \n     this.checkpoint = checkpoint;\n-    this.block = block;\n-    this.state = state;\n     this.isGenesis = checkpoint.getEpoch().equals(UInt64.valueOf(Constants.GENESIS_EPOCH));\n-    this.blockAndState = new SignedBlockAndState(block, state);\n+  }\n+\n+  public static AnchorPoint create(\n+      Checkpoint checkpoint, BeaconState state, Optional<SignedBeaconBlock> block) {\n+    final BeaconBlockSummary blockSummary =\n+        block\n+            .map(BeaconBlockSummary.class::cast)", "originalCommit": "79567956621c69f1600c5435a111ad58e1047e9a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODE4MTE2Mw==", "url": "https://github.com/ConsenSys/teku/pull/3133#discussion_r518181163", "bodyText": "good call \ud83d\udc4d", "author": "mbaxter", "createdAt": "2020-11-05T16:22:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzY4ODE1MQ=="}], "type": "inlineReview", "revised_code": {"commit": "0ff483e24e53449c2e27ec9f700c147084b08890", "chunk": "diff --git a/ethereum/datastructures/src/main/java/tech/pegasys/teku/datastructures/state/AnchorPoint.java b/ethereum/datastructures/src/main/java/tech/pegasys/teku/datastructures/state/AnchorPoint.java\nindex 76c2008790..17ca2d4a14 100644\n--- a/ethereum/datastructures/src/main/java/tech/pegasys/teku/datastructures/state/AnchorPoint.java\n+++ b/ethereum/datastructures/src/main/java/tech/pegasys/teku/datastructures/state/AnchorPoint.java\n\n@@ -51,9 +51,7 @@ public class AnchorPoint extends StateAndBlockSummary {\n   public static AnchorPoint create(\n       Checkpoint checkpoint, BeaconState state, Optional<SignedBeaconBlock> block) {\n     final BeaconBlockSummary blockSummary =\n-        block\n-            .map(BeaconBlockSummary.class::cast)\n-            .orElseGet(() -> BeaconBlockHeader.fromState(state));\n+        block.<BeaconBlockSummary>map(a -> a).orElseGet(() -> BeaconBlockHeader.fromState(state));\n     return new AnchorPoint(checkpoint, state, blockSummary);\n   }\n \n"}}, {"oid": "0ff483e24e53449c2e27ec9f700c147084b08890", "url": "https://github.com/ConsenSys/teku/commit/0ff483e24e53449c2e27ec9f700c147084b08890", "message": "Use safer casting approach", "committedDate": "2020-11-05T16:22:51Z", "type": "commit"}, {"oid": "9844365f81184ae2b39aab4053ff68b42fd36b97", "url": "https://github.com/ConsenSys/teku/commit/9844365f81184ae2b39aab4053ff68b42fd36b97", "message": "Merge branch 'master' into issue-3063/add-block-summary-interface\n\n Conflicts:\n\tstorage/src/main/java/tech/pegasys/teku/storage/server/rocksdb/RocksDbDatabase.java\n\tstorage/src/main/java/tech/pegasys/teku/storage/store/StoreBuilder.java\n\tstorage/src/main/java/tech/pegasys/teku/storage/store/StoreTransactionUpdates.java\n\tstorage/src/test/java/tech/pegasys/teku/storage/client/RecentChainDataTest.java\n\tstorage/src/test/java/tech/pegasys/teku/storage/client/StorageBackedRecentChainDataTest.java\n\tstorage/src/test/java/tech/pegasys/teku/storage/server/rocksdb/AbstractRocksDbDatabaseTest.java", "committedDate": "2020-11-05T17:00:58Z", "type": "commit"}, {"oid": "ab328ba6c66d60907258c2630a0a714661fed5a0", "url": "https://github.com/ConsenSys/teku/commit/ab328ba6c66d60907258c2630a0a714661fed5a0", "message": "Require hot tx updates to hold full blocks", "committedDate": "2020-11-05T17:12:12Z", "type": "commit"}, {"oid": "c73bc30b85118e43ee7c1c189afa93079ffcc64f", "url": "https://github.com/ConsenSys/teku/commit/c73bc30b85118e43ee7c1c189afa93079ffcc64f", "message": "Use safer casting approach", "committedDate": "2020-11-05T18:30:42Z", "type": "commit"}, {"oid": "368e634f2040f8b31ccdcf9a0c07c9da534e309a", "url": "https://github.com/ConsenSys/teku/commit/368e634f2040f8b31ccdcf9a0c07c9da534e309a", "message": "Cut unused methods", "committedDate": "2020-11-05T18:31:55Z", "type": "commit"}]}