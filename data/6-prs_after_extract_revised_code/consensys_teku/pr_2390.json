{"pr_number": 2390, "pr_title": "[Issue 2291] Remove RecentChainData.getBlockState()", "pr_createdAt": "2020-07-20T18:45:56Z", "pr_url": "https://github.com/ConsenSys/teku/pull/2390", "timeline": [{"oid": "714944b6455255c7bee42c3f23fe855f72e764a1", "url": "https://github.com/ConsenSys/teku/commit/714944b6455255c7bee42c3f23fe855f72e764a1", "message": "Update DepositProvider to use new async state retrieval method", "committedDate": "2020-07-20T18:19:16Z", "type": "commit"}, {"oid": "c15056f6764608088d0020812ff4ba120bee1476", "url": "https://github.com/ConsenSys/teku/commit/c15056f6764608088d0020812ff4ba120bee1476", "message": "Remove unused method", "committedDate": "2020-07-20T18:23:58Z", "type": "commit"}, {"oid": "feb905943a8b60629ff69df94f13331f38e117e3", "url": "https://github.com/ConsenSys/teku/commit/feb905943a8b60629ff69df94f13331f38e117e3", "message": "Update tests to use async state retrieval method", "committedDate": "2020-07-20T18:24:50Z", "type": "commit"}, {"oid": "24ca5afde7f5589e6cef577d73362ce45fbff586", "url": "https://github.com/ConsenSys/teku/commit/24ca5afde7f5589e6cef577d73362ce45fbff586", "message": "Remove RecentChainData.getBlockState()", "committedDate": "2020-07-20T18:29:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY4OTQ3Ng==", "url": "https://github.com/ConsenSys/teku/pull/2390#discussion_r457689476", "bodyText": "Probably should just log an error here and exit rather than throwing.  It should never happen so probably doesn't matter but if the checkpoint state isn't available it's not actually that big a deal - we just won't prune deposits so don't want to be too noisy about it.", "author": "ajsutton", "createdAt": "2020-07-20T21:01:35Z", "path": "validator/coordinator/src/main/java/tech/pegasys/teku/validator/coordinator/DepositProvider.java", "diffHunk": "@@ -80,14 +80,22 @@ public synchronized void onDepositsFromBlock(DepositsFromBlockEvent event) {\n   }\n \n   @Override\n-  public synchronized void onNewFinalizedCheckpoint(final Checkpoint checkpoint) {\n-    BeaconState finalizedState =\n-        recentChainData\n-            .getBlockState(checkpoint.getRoot())\n-            .orElseThrow(\n-                () -> new IllegalArgumentException(\"Finalized Checkpoint state can not be found.\"));\n-\n-    depositNavigableMap.headMap(finalizedState.getEth1_deposit_index(), false).clear();\n+  public void onNewFinalizedCheckpoint(final Checkpoint checkpoint) {\n+    recentChainData\n+        .retrieveBlockState(checkpoint.getRoot())\n+        .thenAccept(\n+            finalizedState -> {\n+              if (finalizedState.isEmpty()) {\n+                throw new IllegalStateException(\"Finalized Checkpoint state cannot be found.\");", "originalCommit": "24ca5afde7f5589e6cef577d73362ce45fbff586", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b76e120d1706cfe3fdbb7eec1b40e7d68fe67fc3", "chunk": "diff --git a/validator/coordinator/src/main/java/tech/pegasys/teku/validator/coordinator/DepositProvider.java b/validator/coordinator/src/main/java/tech/pegasys/teku/validator/coordinator/DepositProvider.java\nindex 9754ae679..0bf2dd00c 100644\n--- a/validator/coordinator/src/main/java/tech/pegasys/teku/validator/coordinator/DepositProvider.java\n+++ b/validator/coordinator/src/main/java/tech/pegasys/teku/validator/coordinator/DepositProvider.java\n\n@@ -86,7 +86,8 @@ public class DepositProvider implements Eth1EventsChannel, FinalizedCheckpointCh\n         .thenAccept(\n             finalizedState -> {\n               if (finalizedState.isEmpty()) {\n-                throw new IllegalStateException(\"Finalized Checkpoint state cannot be found.\");\n+                LOG.error(\"Finalized checkpoint state not found.\");\n+                return;\n               }\n               final UnsignedLong depositIndex = finalizedState.get().getEth1_deposit_index();\n               pruneDeposits(depositIndex);\n"}}, {"oid": "b76e120d1706cfe3fdbb7eec1b40e7d68fe67fc3", "url": "https://github.com/ConsenSys/teku/commit/b76e120d1706cfe3fdbb7eec1b40e7d68fe67fc3", "message": "Log error and return rather than throwing", "committedDate": "2020-07-20T22:35:30Z", "type": "commit"}]}