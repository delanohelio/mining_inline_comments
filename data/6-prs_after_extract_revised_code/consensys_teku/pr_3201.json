{"pr_number": 3201, "pr_title": "limit the available options for voluntary-exit.", "pr_createdAt": "2020-11-12T01:31:38Z", "pr_url": "https://github.com/ConsenSys/teku/pull/3201", "timeline": [{"oid": "04dbf2c7002325c1054c323940d89ef5106eaf51", "url": "https://github.com/ConsenSys/teku/commit/04dbf2c7002325c1054c323940d89ef5106eaf51", "message": "limit the available options for voluntary-exit.\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-11-12T01:30:18Z", "type": "commit"}, {"oid": "04ac9a15552f8510f547b4c99996f0df53e17a09", "url": "https://github.com/ConsenSys/teku/commit/04ac9a15552f8510f547b4c99996f0df53e17a09", "message": "Merge remote-tracking branch 'upstream/master' into voluntary-exit-cli", "committedDate": "2020-11-12T01:33:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTc2NzEwMQ==", "url": "https://github.com/ConsenSys/teku/pull/3201#discussion_r521767101", "bodyText": "This isn't enough.  We also need the options to specify external signers:\n\nvalidators-external-signer-public-keys\n--validators-external-signer-url\n--validators-external-signer-timeout", "author": "ajsutton", "createdAt": "2020-11-12T01:51:22Z", "path": "teku/src/main/java/tech/pegasys/teku/cli/options/ValidatorKeysOptions.java", "diffHunk": "@@ -0,0 +1,38 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.cli.options;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import picocli.CommandLine;\n+import tech.pegasys.teku.config.TekuConfiguration;\n+\n+public class ValidatorKeysOptions {\n+\n+  @CommandLine.Option(\n+      names = {\"--validator-keys\"},\n+      paramLabel = \"<KEY_DIR>:<PASS_DIR> | <KEY_FILE>:<PASS_FILE>\",\n+      description =\n+          \"<KEY_DIR>:<PASS_DIR> will find <KEY_DIR>/**.json, and expect to find <PASS_DIR>/**.txt.\\n\"\n+              + \"<KEY_FILE>:<PASS_FILE> will expect that the file <KEY_FILE> exists, \"\n+              + \"and the file containing the password for it is <PASS_FILE>.\\n\"\n+              + \"The path separator is operating system dependent, and should be ';' in windows rather than ':'.\",\n+      split = \",\",\n+      arity = \"1..*\")\n+  private List<String> validatorKeys = new ArrayList<>();", "originalCommit": "04ac9a15552f8510f547b4c99996f0df53e17a09", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTc2ODE0NQ==", "url": "https://github.com/ConsenSys/teku/pull/3201#discussion_r521768145", "bodyText": "May as well move the old validators-key-files and validators-key-password-files options into here too just for consistency.  They're hidden and will be removed soon but its tidier to keep all the key loading options in one place.", "author": "ajsutton", "createdAt": "2020-11-12T01:54:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTc2NzEwMQ=="}], "type": "inlineReview", "revised_code": {"commit": "4dd095b2942a0b9da7b10be9e33c842357711cea", "chunk": "diff --git a/teku/src/main/java/tech/pegasys/teku/cli/options/ValidatorKeysOptions.java b/teku/src/main/java/tech/pegasys/teku/cli/options/ValidatorKeysOptions.java\nindex e1939dd79..50017e849 100644\n--- a/teku/src/main/java/tech/pegasys/teku/cli/options/ValidatorKeysOptions.java\n+++ b/teku/src/main/java/tech/pegasys/teku/cli/options/ValidatorKeysOptions.java\n\n@@ -13,10 +13,18 @@\n \n package tech.pegasys.teku.cli.options;\n \n+import com.google.common.base.Strings;\n+import java.net.MalformedURLException;\n+import java.net.URL;\n import java.util.ArrayList;\n+import java.util.Collections;\n import java.util.List;\n+import java.util.stream.Collectors;\n+import org.apache.tuweni.bytes.Bytes;\n import picocli.CommandLine;\n+import tech.pegasys.teku.bls.BLSPublicKey;\n import tech.pegasys.teku.config.TekuConfiguration;\n+import tech.pegasys.teku.util.config.InvalidConfigurationException;\n \n public class ValidatorKeysOptions {\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTc2NzY1Mg==", "url": "https://github.com/ConsenSys/teku/pull/3201#discussion_r521767652", "bodyText": "Probably worth making SlashingProtector an interface so we can just supply a FORBID_ALL option here (validator exit shouldn't ask to sign any attestations or blocks so if it does, slashing protector should reject the request)", "author": "ajsutton", "createdAt": "2020-11-12T01:53:14Z", "path": "teku/src/main/java/tech/pegasys/teku/cli/subcommand/VoluntaryExitCommand.java", "diffHunk": "@@ -179,10 +164,10 @@ private void initialise() {\n     }\n     genesisRoot = maybeRoot.get();\n \n-    // get the validator\n-    final Path slashProtectionPath = getSlashingProtectionPath(dataOptions);\n+    // slashing protection won't be looked at, but it is required to create a validator loader.\n+    // No files will be created in the path\n     final SlashingProtector slashingProtector =\n-        new SlashingProtector(new SyncDataAccessor(), slashProtectionPath);\n+        new SlashingProtector(new SyncDataAccessor(), Path.of(\".\"));", "originalCommit": "04ac9a15552f8510f547b4c99996f0df53e17a09", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTgyODUxOQ==", "url": "https://github.com/ConsenSys/teku/pull/3201#discussion_r521828519", "bodyText": "hopefully i encapsulated pretty much what you're saying here.", "author": "rolfyone", "createdAt": "2020-11-12T04:13:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTc2NzY1Mg=="}], "type": "inlineReview", "revised_code": {"commit": "5bbb7e188d03e47a3969fc86021a76f9ed6da66f", "chunk": "diff --git a/teku/src/main/java/tech/pegasys/teku/cli/subcommand/VoluntaryExitCommand.java b/teku/src/main/java/tech/pegasys/teku/cli/subcommand/VoluntaryExitCommand.java\nindex ea660d7cd..013dd971c 100644\n--- a/teku/src/main/java/tech/pegasys/teku/cli/subcommand/VoluntaryExitCommand.java\n+++ b/teku/src/main/java/tech/pegasys/teku/cli/subcommand/VoluntaryExitCommand.java\n\n@@ -164,11 +188,8 @@ public class VoluntaryExitCommand implements Runnable {\n     }\n     genesisRoot = maybeRoot.get();\n \n-    // slashing protection won't be looked at, but it is required to create a validator loader.\n-    // No files will be created in the path\n-    final SlashingProtector slashingProtector =\n-        new SlashingProtector(new SyncDataAccessor(), Path.of(\".\"));\n-    final ValidatorLoader validatorLoader = new ValidatorLoader(slashingProtector, asyncRunner);\n+    final ValidatorLoader validatorLoader =\n+        new ValidatorLoader(new RejectingSlashingProtector(), asyncRunner);\n \n     try {\n       blsPublicKeyValidatorMap =\n"}}, {"oid": "4dd095b2942a0b9da7b10be9e33c842357711cea", "url": "https://github.com/ConsenSys/teku/commit/4dd095b2942a0b9da7b10be9e33c842357711cea", "message": "move the external-signer flags so they can be used by the voluntary exit command.\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-11-12T02:53:48Z", "type": "commit"}, {"oid": "a592d8ce42808c1616724d7f639aa415509f0f75", "url": "https://github.com/ConsenSys/teku/commit/a592d8ce42808c1616724d7f639aa415509f0f75", "message": "add confirmation to the workflow, and a 'loading configuration' option because it can be slow if many validators are being loaded.\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-11-12T03:27:44Z", "type": "commit"}, {"oid": "5bbb7e188d03e47a3969fc86021a76f9ed6da66f", "url": "https://github.com/ConsenSys/teku/commit/5bbb7e188d03e47a3969fc86021a76f9ed6da66f", "message": "change SlashingProtector to be an interface, and provide a protector that rejects all requests.\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-11-12T04:12:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTgzNTAzNg==", "url": "https://github.com/ConsenSys/teku/pull/3201#discussion_r521835036", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    \"\\nThese validators won't be able to be re-activated, and withdrawals aren't likely to be possible until Phase 2 of eth2 Mainnet.\");\n          \n          \n            \n                    \"\\nThese validators won't be able to be re-activated, and withdrawals are unlikely to be possible until Phase 2 of eth2 Mainnet.\");", "author": "ajsutton", "createdAt": "2020-11-12T04:40:19Z", "path": "teku/src/main/java/tech/pegasys/teku/cli/subcommand/VoluntaryExitCommand.java", "diffHunk": "@@ -98,10 +84,33 @@\n \n   @Override\n   public void run() {\n+    SUB_COMMAND_LOG.display(\"Loading configuration...\");\n     initialise();\n+    confirmExits();\n     getValidatorIndices(blsPublicKeyValidatorMap).forEach(this::submitExitForValidator);\n   }\n \n+  private void confirmExits() {\n+    SUB_COMMAND_LOG.display(\"Exits are going to be generated for validators: \");\n+    SUB_COMMAND_LOG.display(getValidatorAbbreviatedKeys());\n+    SUB_COMMAND_LOG.display(\n+        \"\\nThese validators won't be able to be re-activated, and withdrawals aren't likely to be possible until Phase 2 of eth2 Mainnet.\");", "originalCommit": "5bbb7e188d03e47a3969fc86021a76f9ed6da66f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTgzNTM1MA==", "url": "https://github.com/ConsenSys/teku/pull/3201#discussion_r521835350", "bodyText": "Also, can't hard code \\n - should separate calls to display for each line.", "author": "ajsutton", "createdAt": "2020-11-12T04:41:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTgzNTAzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTgzNzc4Ng==", "url": "https://github.com/ConsenSys/teku/pull/3201#discussion_r521837786", "bodyText": "that was for an extra line, i could put in a blank display call?", "author": "rolfyone", "createdAt": "2020-11-12T04:51:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTgzNTAzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTgzODI3NA==", "url": "https://github.com/ConsenSys/teku/pull/3201#discussion_r521838274", "bodyText": "Yeah a blank call would work.  \\n isn't the line separator on all systems.", "author": "ajsutton", "createdAt": "2020-11-12T04:53:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTgzNTAzNg=="}], "type": "inlineReview", "revised_code": {"commit": "ec6ec1ba3f134fd78e9a15303d940e25283c50eb", "chunk": "diff --git a/teku/src/main/java/tech/pegasys/teku/cli/subcommand/VoluntaryExitCommand.java b/teku/src/main/java/tech/pegasys/teku/cli/subcommand/VoluntaryExitCommand.java\nindex 013dd971c..481df4761 100644\n--- a/teku/src/main/java/tech/pegasys/teku/cli/subcommand/VoluntaryExitCommand.java\n+++ b/teku/src/main/java/tech/pegasys/teku/cli/subcommand/VoluntaryExitCommand.java\n\n@@ -93,8 +93,9 @@ public class VoluntaryExitCommand implements Runnable {\n   private void confirmExits() {\n     SUB_COMMAND_LOG.display(\"Exits are going to be generated for validators: \");\n     SUB_COMMAND_LOG.display(getValidatorAbbreviatedKeys());\n+    SUB_COMMAND_LOG.display(\"\");\n     SUB_COMMAND_LOG.display(\n-        \"\\nThese validators won't be able to be re-activated, and withdrawals aren't likely to be possible until Phase 2 of eth2 Mainnet.\");\n+        \"These validators won't be able to be re-activated, and withdrawals aren't likely to be possible until Phase 2 of eth2 Mainnet.\");\n     SUB_COMMAND_LOG.display(\"Are you sure you wish to continue (yes/no)? \");\n     Scanner scanner = new Scanner(System.in, Charset.defaultCharset().name());\n     final String confirmation = scanner.next();\n"}}, {"oid": "ec6ec1ba3f134fd78e9a15303d940e25283c50eb", "url": "https://github.com/ConsenSys/teku/commit/ec6ec1ba3f134fd78e9a15303d940e25283c50eb", "message": "review feedback\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-11-12T04:57:30Z", "type": "commit"}, {"oid": "4c1048e1540563a26a9b22bb6a7441f91f3be184", "url": "https://github.com/ConsenSys/teku/commit/4c1048e1540563a26a9b22bb6a7441f91f3be184", "message": "Merge remote-tracking branch 'upstream/master' into voluntary-exit-cli", "committedDate": "2020-11-12T04:58:20Z", "type": "commit"}]}