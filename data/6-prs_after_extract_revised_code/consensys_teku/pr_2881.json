{"pr_number": 2881, "pr_title": "Be more lenient when handling gossip errors", "pr_createdAt": "2020-10-05T23:22:48Z", "pr_url": "https://github.com/ConsenSys/teku/pull/2881", "timeline": [{"oid": "a20c853176370c80a1bc9df970deadfbf834e7e1", "url": "https://github.com/ConsenSys/teku/commit/a20c853176370c80a1bc9df970deadfbf834e7e1", "message": "Be more lenient when handling gossip errors", "committedDate": "2020-10-05T23:21:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDA5MTM2NA==", "url": "https://github.com/ConsenSys/teku/pull/2881#discussion_r500091364", "bodyText": "From my perspective I would Ignore only the cases when we are 100% sure this is not the remote peer guilt.\nI'm almost sure there are still cases when other exceptions could be thrown beside DecodingException and this could be the attack target and in this case the peer would not be banned. IMHO it's better to unfairly ban a honest peer than keep being DoSed by a malicious peer.", "author": "Nashatyrev", "createdAt": "2020-10-06T08:20:30Z", "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/gossip/topics/Eth2TopicHandler.java", "diffHunk": "@@ -62,15 +62,20 @@ protected abstract void processMessage(\n       final TWrapped message, InternalValidationResult internalValidationResult);\n \n   protected ValidationResult handleMessageProcessingError(Throwable err) {\n+    final ValidationResult response;\n     if (Throwables.getRootCause(err) instanceof DecodingException) {\n       LOG.trace(\"Received malformed gossip message on {}\", getTopic());\n+      response = ValidationResult.Invalid;\n     } else if (Throwables.getRootCause(err) instanceof RejectedExecutionException) {\n       LOG.warn(\n           \"Discarding gossip message for topic {} because the executor queue is full\", getTopic());\n+      response = ValidationResult.Ignore;\n     } else {\n       LOG.warn(\"Encountered exception while processing message for topic {}\", getTopic(), err);\n+      response = ValidationResult.Ignore;", "originalCommit": "a20c853176370c80a1bc9df970deadfbf834e7e1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDM5NzkzOA==", "url": "https://github.com/ConsenSys/teku/pull/2881#discussion_r500397938", "bodyText": "Yeah, on second thought this makes a lot of sense \ud83d\udc4d  And we do log a warning, so we should be able to detect any cases where we're being too strict.", "author": "mbaxter", "createdAt": "2020-10-06T15:36:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDA5MTM2NA=="}], "type": "inlineReview", "revised_code": {"commit": "574be79b16906512f06085d2a6dfa9f9007f27cd", "chunk": "diff --git a/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/gossip/topics/Eth2TopicHandler.java b/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/gossip/topics/Eth2TopicHandler.java\nindex faca04dfe..7c65cd77d 100644\n--- a/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/gossip/topics/Eth2TopicHandler.java\n+++ b/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/gossip/topics/Eth2TopicHandler.java\n\n@@ -63,16 +63,16 @@ public abstract class Eth2TopicHandler<T extends SimpleOffsetSerializable, TWrap\n \n   protected ValidationResult handleMessageProcessingError(Throwable err) {\n     final ValidationResult response;\n-    if (Throwables.getRootCause(err) instanceof DecodingException) {\n+    if (ExceptionUtil.getCause(err, DecodingException.class).isPresent()) {\n       LOG.trace(\"Received malformed gossip message on {}\", getTopic());\n       response = ValidationResult.Invalid;\n-    } else if (Throwables.getRootCause(err) instanceof RejectedExecutionException) {\n+    } else if (ExceptionUtil.getCause(err, RejectedExecutionException.class).isPresent()) {\n       LOG.warn(\n           \"Discarding gossip message for topic {} because the executor queue is full\", getTopic());\n       response = ValidationResult.Ignore;\n     } else {\n       LOG.warn(\"Encountered exception while processing message for topic {}\", getTopic(), err);\n-      response = ValidationResult.Ignore;\n+      response = ValidationResult.Invalid;\n     }\n \n     return response;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDA5MjIwMw==", "url": "https://github.com/ConsenSys/teku/pull/2881#discussion_r500092203", "bodyText": "BTW I'd fix this check since there are cases when DecodingException is not the innermost. E.g.:\n    } catch (SSZException e) {\n      throw new DecodingException(\"Failed to deserialize value\", e);\n    } catch (Exception e) {\n      throw new DecodingException(\"Encountered exception while deserializing value\", e);\n    }", "author": "Nashatyrev", "createdAt": "2020-10-06T08:21:45Z", "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/gossip/topics/Eth2TopicHandler.java", "diffHunk": "@@ -62,15 +62,20 @@ protected abstract void processMessage(\n       final TWrapped message, InternalValidationResult internalValidationResult);\n \n   protected ValidationResult handleMessageProcessingError(Throwable err) {\n+    final ValidationResult response;\n     if (Throwables.getRootCause(err) instanceof DecodingException) {", "originalCommit": "a20c853176370c80a1bc9df970deadfbf834e7e1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDM5ODExNA==", "url": "https://github.com/ConsenSys/teku/pull/2881#discussion_r500398114", "bodyText": "good catch!", "author": "mbaxter", "createdAt": "2020-10-06T15:36:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDA5MjIwMw=="}], "type": "inlineReview", "revised_code": {"commit": "574be79b16906512f06085d2a6dfa9f9007f27cd", "chunk": "diff --git a/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/gossip/topics/Eth2TopicHandler.java b/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/gossip/topics/Eth2TopicHandler.java\nindex faca04dfe..7c65cd77d 100644\n--- a/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/gossip/topics/Eth2TopicHandler.java\n+++ b/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/gossip/topics/Eth2TopicHandler.java\n\n@@ -63,16 +63,16 @@ public abstract class Eth2TopicHandler<T extends SimpleOffsetSerializable, TWrap\n \n   protected ValidationResult handleMessageProcessingError(Throwable err) {\n     final ValidationResult response;\n-    if (Throwables.getRootCause(err) instanceof DecodingException) {\n+    if (ExceptionUtil.getCause(err, DecodingException.class).isPresent()) {\n       LOG.trace(\"Received malformed gossip message on {}\", getTopic());\n       response = ValidationResult.Invalid;\n-    } else if (Throwables.getRootCause(err) instanceof RejectedExecutionException) {\n+    } else if (ExceptionUtil.getCause(err, RejectedExecutionException.class).isPresent()) {\n       LOG.warn(\n           \"Discarding gossip message for topic {} because the executor queue is full\", getTopic());\n       response = ValidationResult.Ignore;\n     } else {\n       LOG.warn(\"Encountered exception while processing message for topic {}\", getTopic(), err);\n-      response = ValidationResult.Ignore;\n+      response = ValidationResult.Invalid;\n     }\n \n     return response;\n"}}, {"oid": "574be79b16906512f06085d2a6dfa9f9007f27cd", "url": "https://github.com/ConsenSys/teku/commit/574be79b16906512f06085d2a6dfa9f9007f27cd", "message": "Fix throwable analysis, be strict on unknown errors, add tests", "committedDate": "2020-10-06T15:20:46Z", "type": "commit"}, {"oid": "46c6bdeab2df25f0d6d5d00ab2758c42383fac54", "url": "https://github.com/ConsenSys/teku/commit/46c6bdeab2df25f0d6d5d00ab2758c42383fac54", "message": "Merge branch 'master' into qs-1/ignore-gossip-messages-rejected-due-to-capacity", "committedDate": "2020-10-06T15:37:16Z", "type": "commit"}]}