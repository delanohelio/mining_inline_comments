{"pr_number": 1388, "pr_title": "Add Validator status", "pr_createdAt": "2020-03-17T03:30:27Z", "pr_url": "https://github.com/ConsenSys/teku/pull/1388", "timeline": [{"oid": "7a5c5ae69998b6c5fea638d8865b3dfcda424a4d", "url": "https://github.com/ConsenSys/teku/commit/7a5c5ae69998b6c5fea638d8865b3dfcda424a4d", "message": "added status\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-03-16T02:49:39Z", "type": "commit"}, {"oid": "10a192bb615329f80169af072bd1bb97d6e4b472", "url": "https://github.com/ConsenSys/teku/commit/10a192bb615329f80169af072bd1bb97d6e4b472", "message": "added getValidatorStatus() to data provider\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-03-17T00:47:25Z", "type": "commit"}, {"oid": "66ffe524b4eb05a7e5aa5174e85b3c763501d5e2", "url": "https://github.com/ConsenSys/teku/commit/66ffe524b4eb05a7e5aa5174e85b3c763501d5e2", "message": "added tests for status in validatorDuties\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-03-17T03:28:55Z", "type": "commit"}, {"oid": "4ecb87452337b83ffffa4d9eda097da564273d4f", "url": "https://github.com/ConsenSys/teku/commit/4ecb87452337b83ffffa4d9eda097da564273d4f", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into validator-status", "committedDate": "2020-03-17T03:30:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQyNzQxNA==", "url": "https://github.com/ConsenSys/teku/pull/1388#discussion_r393427414", "bodyText": "i'd be super tempted to use a ternary here\nreturn validator.isSlashed() ? SLASHING : EXITING;", "author": "rolfyone", "createdAt": "2020-03-17T03:35:49Z", "path": "data/provider/src/main/java/tech/pegasys/artemis/api/ChainDataProvider.java", "diffHunk": "@@ -59,6 +61,29 @@ public ChainDataProvider(\n     this.chainStorageClient = chainStorageClient;\n   }\n \n+  public static ValidatorStatus getValidatorStatus(Validator validator, UnsignedLong epoch) {\n+    if (epoch.compareTo(validator.getActivation_eligibility_epoch()) < 0) {\n+      return ValidatorStatus.DEPOSITED;\n+    }\n+    if (epoch.compareTo(validator.getActivation_epoch()) < 0) {\n+      return ValidatorStatus.PENDING;\n+    }\n+    if (validator.getExit_epoch().equals(Constants.FAR_FUTURE_EPOCH)) {\n+      return ValidatorStatus.ACTIVE;\n+    }\n+    if (epoch.compareTo(validator.getExit_epoch()) < 0) {\n+      if (validator.isSlashed()) {\n+        return ValidatorStatus.SLASHING;\n+      } else {\n+        return ValidatorStatus.EXITING;", "originalCommit": "4ecb87452337b83ffffa4d9eda097da564273d4f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQzMDEzNQ==", "url": "https://github.com/ConsenSys/teku/pull/1388#discussion_r393430135", "bodyText": "done", "author": "macfarla", "createdAt": "2020-03-17T03:47:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQyNzQxNA=="}], "type": "inlineReview", "revised_code": {"commit": "6b7b443629f2dccaa31a0afb2eb828f0f98bbfd0", "chunk": "diff --git a/data/provider/src/main/java/tech/pegasys/artemis/api/ChainDataProvider.java b/data/provider/src/main/java/tech/pegasys/artemis/api/ChainDataProvider.java\nindex a22f7bd877..501789ee64 100644\n--- a/data/provider/src/main/java/tech/pegasys/artemis/api/ChainDataProvider.java\n+++ b/data/provider/src/main/java/tech/pegasys/artemis/api/ChainDataProvider.java\n\n@@ -62,26 +69,25 @@ public class ChainDataProvider {\n   }\n \n   public static ValidatorStatus getValidatorStatus(Validator validator, UnsignedLong epoch) {\n+    if (validator == null || epoch.compareTo(UnsignedLong.ZERO) < 0) {\n+      return UNKNOWN_STATUS;\n+    }\n     if (epoch.compareTo(validator.getActivation_eligibility_epoch()) < 0) {\n-      return ValidatorStatus.DEPOSITED;\n+      return DEPOSITED;\n     }\n     if (epoch.compareTo(validator.getActivation_epoch()) < 0) {\n-      return ValidatorStatus.PENDING;\n+      return PENDING;\n     }\n     if (validator.getExit_epoch().equals(Constants.FAR_FUTURE_EPOCH)) {\n-      return ValidatorStatus.ACTIVE;\n+      return ACTIVE;\n     }\n     if (epoch.compareTo(validator.getExit_epoch()) < 0) {\n-      if (validator.isSlashed()) {\n-        return ValidatorStatus.SLASHING;\n-      } else {\n-        return ValidatorStatus.EXITING;\n-      }\n+      return validator.isSlashed() ? SLASHING : EXITING;\n     }\n     if (epoch.compareTo(validator.getExit_epoch()) >= 0) {\n-      return ValidatorStatus.EXITED;\n+      return EXITED;\n     }\n-    return ValidatorStatus.UNKNOWN_STATUS;\n+    return UNKNOWN_STATUS;\n   }\n \n   public Optional<UnsignedLong> getGenesisTime() {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQyOTAyMQ==", "url": "https://github.com/ConsenSys/teku/pull/1388#discussion_r393429021", "bodyText": "nit: can probably just static import?", "author": "rolfyone", "createdAt": "2020-03-17T03:42:59Z", "path": "data/provider/src/main/java/tech/pegasys/artemis/api/ChainDataProvider.java", "diffHunk": "@@ -59,6 +61,29 @@ public ChainDataProvider(\n     this.chainStorageClient = chainStorageClient;\n   }\n \n+  public static ValidatorStatus getValidatorStatus(Validator validator, UnsignedLong epoch) {\n+    if (epoch.compareTo(validator.getActivation_eligibility_epoch()) < 0) {\n+      return ValidatorStatus.DEPOSITED;\n+    }\n+    if (epoch.compareTo(validator.getActivation_epoch()) < 0) {\n+      return ValidatorStatus.PENDING;\n+    }\n+    if (validator.getExit_epoch().equals(Constants.FAR_FUTURE_EPOCH)) {\n+      return ValidatorStatus.ACTIVE;", "originalCommit": "4ecb87452337b83ffffa4d9eda097da564273d4f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQzMDExMg==", "url": "https://github.com/ConsenSys/teku/pull/1388#discussion_r393430112", "bodyText": "done", "author": "macfarla", "createdAt": "2020-03-17T03:47:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQyOTAyMQ=="}], "type": "inlineReview", "revised_code": {"commit": "6b7b443629f2dccaa31a0afb2eb828f0f98bbfd0", "chunk": "diff --git a/data/provider/src/main/java/tech/pegasys/artemis/api/ChainDataProvider.java b/data/provider/src/main/java/tech/pegasys/artemis/api/ChainDataProvider.java\nindex a22f7bd877..501789ee64 100644\n--- a/data/provider/src/main/java/tech/pegasys/artemis/api/ChainDataProvider.java\n+++ b/data/provider/src/main/java/tech/pegasys/artemis/api/ChainDataProvider.java\n\n@@ -62,26 +69,25 @@ public class ChainDataProvider {\n   }\n \n   public static ValidatorStatus getValidatorStatus(Validator validator, UnsignedLong epoch) {\n+    if (validator == null || epoch.compareTo(UnsignedLong.ZERO) < 0) {\n+      return UNKNOWN_STATUS;\n+    }\n     if (epoch.compareTo(validator.getActivation_eligibility_epoch()) < 0) {\n-      return ValidatorStatus.DEPOSITED;\n+      return DEPOSITED;\n     }\n     if (epoch.compareTo(validator.getActivation_epoch()) < 0) {\n-      return ValidatorStatus.PENDING;\n+      return PENDING;\n     }\n     if (validator.getExit_epoch().equals(Constants.FAR_FUTURE_EPOCH)) {\n-      return ValidatorStatus.ACTIVE;\n+      return ACTIVE;\n     }\n     if (epoch.compareTo(validator.getExit_epoch()) < 0) {\n-      if (validator.isSlashed()) {\n-        return ValidatorStatus.SLASHING;\n-      } else {\n-        return ValidatorStatus.EXITING;\n-      }\n+      return validator.isSlashed() ? SLASHING : EXITING;\n     }\n     if (epoch.compareTo(validator.getExit_epoch()) >= 0) {\n-      return ValidatorStatus.EXITED;\n+      return EXITED;\n     }\n-    return ValidatorStatus.UNKNOWN_STATUS;\n+    return UNKNOWN_STATUS;\n   }\n \n   public Optional<UnsignedLong> getGenesisTime() {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQyOTI0Nw==", "url": "https://github.com/ConsenSys/teku/pull/1388#discussion_r393429247", "bodyText": "probably want to check validator and return unknown if null before we start this whole process..", "author": "rolfyone", "createdAt": "2020-03-17T03:43:55Z", "path": "data/provider/src/main/java/tech/pegasys/artemis/api/ChainDataProvider.java", "diffHunk": "@@ -59,6 +61,29 @@ public ChainDataProvider(\n     this.chainStorageClient = chainStorageClient;\n   }\n \n+  public static ValidatorStatus getValidatorStatus(Validator validator, UnsignedLong epoch) {", "originalCommit": "4ecb87452337b83ffffa4d9eda097da564273d4f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQzMDA4Ng==", "url": "https://github.com/ConsenSys/teku/pull/1388#discussion_r393430086", "bodyText": "done", "author": "macfarla", "createdAt": "2020-03-17T03:47:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQyOTI0Nw=="}], "type": "inlineReview", "revised_code": {"commit": "6b7b443629f2dccaa31a0afb2eb828f0f98bbfd0", "chunk": "diff --git a/data/provider/src/main/java/tech/pegasys/artemis/api/ChainDataProvider.java b/data/provider/src/main/java/tech/pegasys/artemis/api/ChainDataProvider.java\nindex a22f7bd877..501789ee64 100644\n--- a/data/provider/src/main/java/tech/pegasys/artemis/api/ChainDataProvider.java\n+++ b/data/provider/src/main/java/tech/pegasys/artemis/api/ChainDataProvider.java\n\n@@ -62,26 +69,25 @@ public class ChainDataProvider {\n   }\n \n   public static ValidatorStatus getValidatorStatus(Validator validator, UnsignedLong epoch) {\n+    if (validator == null || epoch.compareTo(UnsignedLong.ZERO) < 0) {\n+      return UNKNOWN_STATUS;\n+    }\n     if (epoch.compareTo(validator.getActivation_eligibility_epoch()) < 0) {\n-      return ValidatorStatus.DEPOSITED;\n+      return DEPOSITED;\n     }\n     if (epoch.compareTo(validator.getActivation_epoch()) < 0) {\n-      return ValidatorStatus.PENDING;\n+      return PENDING;\n     }\n     if (validator.getExit_epoch().equals(Constants.FAR_FUTURE_EPOCH)) {\n-      return ValidatorStatus.ACTIVE;\n+      return ACTIVE;\n     }\n     if (epoch.compareTo(validator.getExit_epoch()) < 0) {\n-      if (validator.isSlashed()) {\n-        return ValidatorStatus.SLASHING;\n-      } else {\n-        return ValidatorStatus.EXITING;\n-      }\n+      return validator.isSlashed() ? SLASHING : EXITING;\n     }\n     if (epoch.compareTo(validator.getExit_epoch()) >= 0) {\n-      return ValidatorStatus.EXITED;\n+      return EXITED;\n     }\n-    return ValidatorStatus.UNKNOWN_STATUS;\n+    return UNKNOWN_STATUS;\n   }\n \n   public Optional<UnsignedLong> getGenesisTime() {\n"}}, {"oid": "6b7b443629f2dccaa31a0afb2eb828f0f98bbfd0", "url": "https://github.com/ConsenSys/teku/commit/6b7b443629f2dccaa31a0afb2eb828f0f98bbfd0", "message": "PR comments\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-03-17T03:48:22Z", "type": "commit"}]}