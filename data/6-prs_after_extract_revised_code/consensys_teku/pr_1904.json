{"pr_number": 1904, "pr_title": "Improve error handling", "pr_createdAt": "2020-05-25T23:34:14Z", "pr_url": "https://github.com/ConsenSys/teku/pull/1904", "timeline": [{"oid": "b86bb8e25360b69a8b1e176ff1b1c02230b6e8cd", "url": "https://github.com/ConsenSys/teku/commit/b86bb8e25360b69a8b1e176ff1b1c02230b6e8cd", "message": "Add a default exception handler so that uncaught exceptions are sent to Log4J.\nExit the process when OutOfMemoryError occurs.", "committedDate": "2020-05-25T23:30:04Z", "type": "commit"}, {"oid": "3cbe0c7b87ec7f840d1c81c372dc3d9106978fab", "url": "https://github.com/ConsenSys/teku/commit/3cbe0c7b87ec7f840d1c81c372dc3d9106978fab", "message": "Fix SafeFutureTest.", "committedDate": "2020-05-25T23:59:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDU0OTQxMg==", "url": "https://github.com/ConsenSys/teku/pull/1904#discussion_r430549412", "bodyText": "This is a pretty bad test - we should probably make this more sophisticated at some point :D", "author": "mbaxter", "createdAt": "2020-05-26T16:33:05Z", "path": "teku/src/main/java/tech/pegasys/teku/TekuDefaultExceptionHandler.java", "diffHunk": "@@ -0,0 +1,98 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.eventbus.SubscriberExceptionContext;\n+import com.google.common.eventbus.SubscriberExceptionHandler;\n+import java.lang.Thread.UncaughtExceptionHandler;\n+import java.lang.reflect.Method;\n+import java.util.function.Function;\n+import tech.pegasys.teku.events.ChannelExceptionHandler;\n+import tech.pegasys.teku.logging.StatusLogger;\n+\n+public final class TekuDefaultExceptionHandler\n+    implements SubscriberExceptionHandler,\n+        ChannelExceptionHandler,\n+        UncaughtExceptionHandler,\n+        Function<Throwable, Void> {\n+\n+  private final StatusLogger log;\n+\n+  public TekuDefaultExceptionHandler() {\n+    this(StatusLogger.STATUS_LOG);\n+  }\n+\n+  @VisibleForTesting\n+  TekuDefaultExceptionHandler(final StatusLogger log) {\n+    this.log = log;\n+  }\n+\n+  @Override\n+  public void handleException(final Throwable exception, final SubscriberExceptionContext context) {\n+    handleException(\n+        exception,\n+        \"event '\"\n+            + context.getEvent().getClass().getName()\n+            + \"'\"\n+            + \" in handler '\"\n+            + context.getSubscriber().getClass().getName()\n+            + \"'\"\n+            + \" (method  '\"\n+            + context.getSubscriberMethod().getName()\n+            + \"')\");\n+  }\n+\n+  @Override\n+  public void handleException(\n+      final Throwable error,\n+      final Object subscriber,\n+      final Method invokedMethod,\n+      final Object[] args) {\n+    handleException(\n+        error,\n+        \"event '\"\n+            + invokedMethod.getDeclaringClass()\n+            + \".\"\n+            + invokedMethod.getName()\n+            + \"' in handler '\"\n+            + subscriber.getClass().getName()\n+            + \"'\");\n+  }\n+\n+  @Override\n+  public void uncaughtException(final Thread t, final Throwable e) {\n+    handleException(e, t.getName());\n+  }\n+\n+  private void handleException(final Throwable exception, final String subscriberDescription) {\n+    if (isSpecFailure(exception)) {\n+      log.specificationFailure(subscriberDescription, exception);\n+    } else {\n+      log.unexpectedFailure(subscriberDescription, exception);\n+    }\n+    if (exception instanceof OutOfMemoryError) {\n+      System.exit(2);\n+    }\n+  }\n+\n+  private static boolean isSpecFailure(final Throwable exception) {\n+    return exception instanceof IllegalArgumentException;", "originalCommit": "3cbe0c7b87ec7f840d1c81c372dc3d9106978fab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDcxMTE5MQ==", "url": "https://github.com/ConsenSys/teku/pull/1904#discussion_r430711191", "bodyText": "Yeah, I'm really quite keen to remove all the checkArgument calls from within the spec code - even if we just replace them with a specPrecondition that throws a custom exception it would make this check a lot better.", "author": "ajsutton", "createdAt": "2020-05-26T21:13:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDU0OTQxMg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDU1MDA0NQ==", "url": "https://github.com/ConsenSys/teku/pull/1904#discussion_r430550045", "bodyText": "This seems like a good idea - but I'm afraid we'll end up bubbling up a lot of noise to the status logger now ...  Maybe the right answer is to make this change and add more custom handling where too much noise bubbles up.", "author": "mbaxter", "createdAt": "2020-05-26T16:34:03Z", "path": "util/src/main/java/tech/pegasys/teku/util/async/SafeFuture.java", "diffHunk": "@@ -22,18 +22,16 @@\n import java.util.function.Function;\n import java.util.function.Supplier;\n import java.util.stream.Stream;\n-import org.apache.logging.log4j.LogManager;\n-import org.apache.logging.log4j.Logger;\n \n public class SafeFuture<T> extends CompletableFuture<T> {\n-  private static final Logger LOG = LogManager.getLogger();\n \n   public static SafeFuture<Void> COMPLETE = SafeFuture.completedFuture(null);\n \n   public static void reportExceptions(final CompletionStage<?> future) {\n     future.exceptionally(\n         error -> {\n-          LOG.error(\"Unhandled exception\", error);\n+          final Thread currentThread = Thread.currentThread();\n+          currentThread.getUncaughtExceptionHandler().uncaughtException(currentThread, error);", "originalCommit": "3cbe0c7b87ec7f840d1c81c372dc3d9106978fab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDcxMjA4OA==", "url": "https://github.com/ConsenSys/teku/pull/1904#discussion_r430712088", "bodyText": "Yeah, we've have a lot of people confused that Teku was \"doing nothing\" because they couldn't see the errors on the console but in the logs errors were appearing all over the place.  Adding all the needed error handling instead of letting things reach the uncaught exception level (which is what reportExceptions is meant to be (possibly need a better name) is good.  We potentially should also set things up so that the console log doesn't show stack traces but the log file does.", "author": "ajsutton", "createdAt": "2020-05-26T21:15:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDU1MDA0NQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDU1MjI0NA==", "url": "https://github.com/ConsenSys/teku/pull/1904#discussion_r430552244", "bodyText": "nice \ud83d\udcaf", "author": "mbaxter", "createdAt": "2020-05-26T16:37:30Z", "path": "teku/src/main/java/tech/pegasys/teku/TekuDefaultExceptionHandler.java", "diffHunk": "@@ -0,0 +1,98 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.eventbus.SubscriberExceptionContext;\n+import com.google.common.eventbus.SubscriberExceptionHandler;\n+import java.lang.Thread.UncaughtExceptionHandler;\n+import java.lang.reflect.Method;\n+import java.util.function.Function;\n+import tech.pegasys.teku.events.ChannelExceptionHandler;\n+import tech.pegasys.teku.logging.StatusLogger;\n+\n+public final class TekuDefaultExceptionHandler\n+    implements SubscriberExceptionHandler,\n+        ChannelExceptionHandler,\n+        UncaughtExceptionHandler,\n+        Function<Throwable, Void> {\n+\n+  private final StatusLogger log;\n+\n+  public TekuDefaultExceptionHandler() {\n+    this(StatusLogger.STATUS_LOG);\n+  }\n+\n+  @VisibleForTesting\n+  TekuDefaultExceptionHandler(final StatusLogger log) {\n+    this.log = log;\n+  }\n+\n+  @Override\n+  public void handleException(final Throwable exception, final SubscriberExceptionContext context) {\n+    handleException(\n+        exception,\n+        \"event '\"\n+            + context.getEvent().getClass().getName()\n+            + \"'\"\n+            + \" in handler '\"\n+            + context.getSubscriber().getClass().getName()\n+            + \"'\"\n+            + \" (method  '\"\n+            + context.getSubscriberMethod().getName()\n+            + \"')\");\n+  }\n+\n+  @Override\n+  public void handleException(\n+      final Throwable error,\n+      final Object subscriber,\n+      final Method invokedMethod,\n+      final Object[] args) {\n+    handleException(\n+        error,\n+        \"event '\"\n+            + invokedMethod.getDeclaringClass()\n+            + \".\"\n+            + invokedMethod.getName()\n+            + \"' in handler '\"\n+            + subscriber.getClass().getName()\n+            + \"'\");\n+  }\n+\n+  @Override\n+  public void uncaughtException(final Thread t, final Throwable e) {\n+    handleException(e, t.getName());\n+  }\n+\n+  private void handleException(final Throwable exception, final String subscriberDescription) {\n+    if (isSpecFailure(exception)) {\n+      log.specificationFailure(subscriberDescription, exception);\n+    } else {\n+      log.unexpectedFailure(subscriberDescription, exception);\n+    }\n+    if (exception instanceof OutOfMemoryError) {\n+      System.exit(2);", "originalCommit": "3cbe0c7b87ec7f840d1c81c372dc3d9106978fab", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "e6a1604b1bd8f844867b437027cbe2ec2bd2add0", "url": "https://github.com/ConsenSys/teku/commit/e6a1604b1bd8f844867b437027cbe2ec2bd2add0", "message": "Merge branch 'master' into crash-properly", "committedDate": "2020-05-26T21:15:37Z", "type": "commit"}]}