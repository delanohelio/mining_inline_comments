{"pr_number": 2953, "pr_title": "Switch validator over to load attestation and block duties separately", "pr_createdAt": "2020-10-12T23:27:40Z", "pr_url": "https://github.com/ConsenSys/teku/pull/2953", "timeline": [{"oid": "d578177e494e05a0ef4e408d3b4df7ebad99cfc2", "url": "https://github.com/ConsenSys/teku/commit/d578177e494e05a0ef4e408d3b4df7ebad99cfc2", "message": "Switch validator over to load attestation and block duties separately.", "committedDate": "2020-10-12T23:26:05Z", "type": "commit"}, {"oid": "32bb7b391a582e0e344f3c9f022177c68bb13730", "url": "https://github.com/ConsenSys/teku/commit/32bb7b391a582e0e344f3c9f022177c68bb13730", "message": "Merge branch 'master' into new-duty-loaders", "committedDate": "2020-10-12T23:57:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzYwNDYxMg==", "url": "https://github.com/ConsenSys/teku/pull/2953#discussion_r503604612", "bodyText": "todo without ticket number..", "author": "rolfyone", "createdAt": "2020-10-13T00:37:04Z", "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/AbstractDutyLoader.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.validator.client;\n+\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.function.Supplier;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import tech.pegasys.teku.bls.BLSPublicKey;\n+import tech.pegasys.teku.infrastructure.async.SafeFuture;\n+import tech.pegasys.teku.infrastructure.unsigned.UInt64;\n+import tech.pegasys.teku.validator.client.duties.ScheduledDuties;\n+\n+public abstract class AbstractDutyLoader<D> implements DutyLoader {\n+\n+  private static final Logger LOG = LogManager.getLogger();\n+  private final Supplier<ScheduledDuties> scheduledDutiesFactory;\n+  protected final Map<BLSPublicKey, Validator> validators;\n+  private final ValidatorIndexProvider validatorIndexProvider;\n+\n+  protected AbstractDutyLoader(\n+      final Supplier<ScheduledDuties> scheduledDutiesFactory,\n+      final Map<BLSPublicKey, Validator> validators,\n+      final ValidatorIndexProvider validatorIndexProvider) {\n+    this.scheduledDutiesFactory = scheduledDutiesFactory;\n+    this.validators = validators;\n+    this.validatorIndexProvider = validatorIndexProvider;\n+    // TODO: Find a new place to set the local_validator_count metric", "originalCommit": "32bb7b391a582e0e344f3c9f022177c68bb13730", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzYwODU4Nw==", "url": "https://github.com/ConsenSys/teku/pull/2953#discussion_r503608587", "bodyText": "Restored the metric.", "author": "ajsutton", "createdAt": "2020-10-13T00:54:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzYwNDYxMg=="}], "type": "inlineReview", "revised_code": {"commit": "180c1b7526d1118996d18415fa33a7c7e8d3089e", "chunk": "diff --git a/validator/client/src/main/java/tech/pegasys/teku/validator/client/AbstractDutyLoader.java b/validator/client/src/main/java/tech/pegasys/teku/validator/client/AbstractDutyLoader.java\nindex 5e578651b..c407c0fde 100644\n--- a/validator/client/src/main/java/tech/pegasys/teku/validator/client/AbstractDutyLoader.java\n+++ b/validator/client/src/main/java/tech/pegasys/teku/validator/client/AbstractDutyLoader.java\n\n@@ -39,7 +39,6 @@ public abstract class AbstractDutyLoader<D> implements DutyLoader {\n     this.scheduledDutiesFactory = scheduledDutiesFactory;\n     this.validators = validators;\n     this.validatorIndexProvider = validatorIndexProvider;\n-    // TODO: Find a new place to set the local_validator_count metric\n   }\n \n   @Override\n"}}, {"oid": "180c1b7526d1118996d18415fa33a7c7e8d3089e", "url": "https://github.com/ConsenSys/teku/commit/180c1b7526d1118996d18415fa33a7c7e8d3089e", "message": "Restore validator count metric.", "committedDate": "2020-10-13T00:43:18Z", "type": "commit"}, {"oid": "e599a7b0f8c6af8b2041a1776eaa6963fd2f9a81", "url": "https://github.com/ConsenSys/teku/commit/e599a7b0f8c6af8b2041a1776eaa6963fd2f9a81", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into new-duty-loaders", "committedDate": "2020-10-13T00:43:22Z", "type": "commit"}, {"oid": "b1387764f4d55f955b075b99f892618fe99d8175", "url": "https://github.com/ConsenSys/teku/commit/b1387764f4d55f955b075b99f892618fe99d8175", "message": "Merge branch 'new-duty-loaders' of github.com:ajsutton/teku into new-duty-loaders", "committedDate": "2020-10-13T00:45:09Z", "type": "commit"}, {"oid": "b1ba125441da76739bd1107ea57200e3ab8a7d17", "url": "https://github.com/ConsenSys/teku/commit/b1ba125441da76739bd1107ea57200e3ab8a7d17", "message": "Replace epoch in URL correctly.\nInclude url in error message when a request fails.\nMap attester duty response to internal representation correctly.", "committedDate": "2020-10-13T01:23:48Z", "type": "commit"}, {"oid": "9d829080c5756f08b88e37e90e7266bb7e203e2e", "url": "https://github.com/ConsenSys/teku/commit/9d829080c5756f08b88e37e90e7266bb7e203e2e", "message": "Add tests for the duties api client.", "committedDate": "2020-10-13T01:35:03Z", "type": "commit"}, {"oid": "9814fbed3e64b3370f3b9036e9a5f25f41193f9f", "url": "https://github.com/ConsenSys/teku/commit/9814fbed3e64b3370f3b9036e9a5f25f41193f9f", "message": "Throw exception when a bad request response is received so the RetryingDutyLoader can handle it rather than suppressing the exception and reporting chain data unavailable.", "committedDate": "2020-10-13T01:55:17Z", "type": "commit"}, {"oid": "abb17592568bafeb53363eea5fe1863f490993ce", "url": "https://github.com/ConsenSys/teku/commit/abb17592568bafeb53363eea5fe1863f490993ce", "message": "Errorprone.", "committedDate": "2020-10-13T01:57:06Z", "type": "commit"}]}