{"pr_number": 2923, "pr_title": "[Issue-2273] Disconnect peers for weak-subjectivity check failures", "pr_createdAt": "2020-10-08T21:04:44Z", "pr_url": "https://github.com/ConsenSys/teku/pull/2923", "timeline": [{"oid": "1984905fb451addf7149fc22e3e42770f62fedb6", "url": "https://github.com/ConsenSys/teku/commit/1984905fb451addf7149fc22e3e42770f62fedb6", "message": "Update PeerSync to handle weak subjectivity errors", "committedDate": "2020-10-08T19:04:44Z", "type": "commit"}, {"oid": "ed5e1a5a69b57d7f8436e7983510389f555ec241", "url": "https://github.com/ConsenSys/teku/commit/ed5e1a5a69b57d7f8436e7983510389f555ec241", "message": "Update multipeer sync to handle weak subjectivity errors", "committedDate": "2020-10-08T20:42:58Z", "type": "commit"}, {"oid": "d27ff128663993eb42744dac1bcb6de1ef1f54ae", "url": "https://github.com/ConsenSys/teku/commit/d27ff128663993eb42744dac1bcb6de1ef1f54ae", "message": "Fix threading issue", "committedDate": "2020-10-08T20:59:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAxMjc2MQ==", "url": "https://github.com/ConsenSys/teku/pull/2923#discussion_r502012761", "bodyText": "All blocks in the batch will have come from the same source so we can probably skip the map here.  Otherwise all the other checks and penalties don't work out anyway.", "author": "ajsutton", "createdAt": "2020-10-08T21:07:08Z", "path": "sync/src/main/java/tech/pegasys/teku/sync/multipeer/BatchImporter.java", "diffHunk": "@@ -46,19 +50,23 @@ public BatchImporter(final BlockImporter blockImporter, final AsyncRunner asyncR\n    * @return a future reporting the result of the import\n    */\n   public SafeFuture<BatchImportResult> importBatch(final Batch batch) {\n-    // Copy the blocks as we're going to use them from off the event thread.\n+    // Copy the data from batch as we're going to use them from off the event thread.\n     final List<SignedBeaconBlock> blocks = new ArrayList<>(batch.getBlocks());\n+    final Map<SignedBeaconBlock, SyncSource> blockToSource =\n+        blocks.stream().collect(Collectors.toUnmodifiableMap(b -> b, batch::getBlockSource));", "originalCommit": "d27ff128663993eb42744dac1bcb6de1ef1f54ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAxOTI1Ng==", "url": "https://github.com/ConsenSys/teku/pull/2923#discussion_r502019256", "bodyText": "Makes sense - will simplify.", "author": "mbaxter", "createdAt": "2020-10-08T21:20:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAxMjc2MQ=="}], "type": "inlineReview", "revised_code": {"commit": "405d3e20027fea7d985e3428096ca95eb8b6e7cc", "chunk": "diff --git a/sync/src/main/java/tech/pegasys/teku/sync/multipeer/BatchImporter.java b/sync/src/main/java/tech/pegasys/teku/sync/multipeer/BatchImporter.java\nindex e447043be8..241788a4a9 100644\n--- a/sync/src/main/java/tech/pegasys/teku/sync/multipeer/BatchImporter.java\n+++ b/sync/src/main/java/tech/pegasys/teku/sync/multipeer/BatchImporter.java\n\n@@ -52,21 +51,20 @@ public class BatchImporter {\n   public SafeFuture<BatchImportResult> importBatch(final Batch batch) {\n     // Copy the data from batch as we're going to use them from off the event thread.\n     final List<SignedBeaconBlock> blocks = new ArrayList<>(batch.getBlocks());\n-    final Map<SignedBeaconBlock, SyncSource> blockToSource =\n-        blocks.stream().collect(Collectors.toUnmodifiableMap(b -> b, batch::getBlockSource));\n+    final Optional<SyncSource> source = batch.getSource();\n \n     checkState(!blocks.isEmpty(), \"Batch has no blocks to import\");\n     return asyncRunner.runAsync(\n         () -> {\n           SafeFuture<BlockImportResult> importResult =\n-              importBlock(blocks.get(0), blockToSource.get(blocks.get(0)));\n+              importBlock(blocks.get(0), source.orElseThrow());\n           for (int i = 1; i < blocks.size(); i++) {\n             final SignedBeaconBlock block = blocks.get(i);\n             importResult =\n                 importResult.thenCompose(\n                     previousResult -> {\n                       if (previousResult.isSuccessful()) {\n-                        return importBlock(block, blockToSource.get(block));\n+                        return importBlock(block, source.orElseThrow());\n                       } else {\n                         return SafeFuture.completedFuture(previousResult);\n                       }\n"}}, {"oid": "405d3e20027fea7d985e3428096ca95eb8b6e7cc", "url": "https://github.com/ConsenSys/teku/commit/405d3e20027fea7d985e3428096ca95eb8b6e7cc", "message": "Simplify multipeer updates", "committedDate": "2020-10-08T22:37:59Z", "type": "commit"}, {"oid": "fe994874ad542abb0fbdd89d9bb447f43638e4a0", "url": "https://github.com/ConsenSys/teku/commit/fe994874ad542abb0fbdd89d9bb447f43638e4a0", "message": "Fix test", "committedDate": "2020-10-09T00:55:15Z", "type": "commit"}, {"oid": "8e0a862f368c4bc41247a57e929a79fd5d1a1c0d", "url": "https://github.com/ConsenSys/teku/commit/8e0a862f368c4bc41247a57e929a79fd5d1a1c0d", "message": "Merge branch 'master' into issue-2273/disconnect-peers-for-ws-check-failure", "committedDate": "2020-10-09T21:59:43Z", "type": "commit"}, {"oid": "daf4b3e9e059d0ae5b6a6994047a5c8fab9255a9", "url": "https://github.com/ConsenSys/teku/commit/daf4b3e9e059d0ae5b6a6994047a5c8fab9255a9", "message": "Merge branch 'master' into issue-2273/disconnect-peers-for-ws-check-failure", "committedDate": "2020-10-12T14:37:30Z", "type": "commit"}]}