{"pr_number": 1612, "pr_title": "Publish events when the chain reorgs", "pr_createdAt": "2020-04-17T05:19:45Z", "pr_url": "https://github.com/ConsenSys/teku/pull/1612", "timeline": [{"oid": "4f66d8b734411f19d7a5e97edb46384ee6885980", "url": "https://github.com/ConsenSys/teku/commit/4f66d8b734411f19d7a5e97edb46384ee6885980", "message": "Publish events when the chain reorgs.", "committedDate": "2020-04-17T05:13:33Z", "type": "commit"}, {"oid": "4d2d81671f7d636fdebdc3d7a1ffc24eb12ebc54", "url": "https://github.com/ConsenSys/teku/commit/4d2d81671f7d636fdebdc3d7a1ffc24eb12ebc54", "message": "Add comment.", "committedDate": "2020-04-17T05:19:11Z", "type": "commit"}, {"oid": "ee34502fd078bef632078d4395bd7f2871ed9d25", "url": "https://github.com/ConsenSys/teku/commit/ee34502fd078bef632078d4395bd7f2871ed9d25", "message": "Spotless.", "committedDate": "2020-04-17T05:38:22Z", "type": "commit"}, {"oid": "392caf7c31b39f82e3b1994ddd3356d691c0a33c", "url": "https://github.com/ConsenSys/teku/commit/392caf7c31b39f82e3b1994ddd3356d691c0a33c", "message": "Fix compilation.", "committedDate": "2020-04-17T05:38:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDMxMzYxMA==", "url": "https://github.com/ConsenSys/teku/pull/1612#discussion_r410313610", "bodyText": "nit: A bit of explanation on how getBlockRootBySlot might return a different root at that slot would be nice, since the updating of the canonical chain with the switch to a new bestBlockRoot is a bit implicit.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                // Get the block root in effect at the old best slot on the new chain\n          \n          \n            \n                // Get the block root in effect at the old best slot on the new chain, which might be different from originalBestRoot due to getBlockRootBySlot potentially using a new chain as the correct fork", "author": "cemozerr", "createdAt": "2020-04-17T15:52:53Z", "path": "storage/src/main/java/tech/pegasys/artemis/storage/client/RecentChainData.java", "diffHunk": "@@ -130,9 +134,22 @@ public Store getStore() {\n    * @param slot\n    */\n   public void updateBestBlock(Bytes32 root, UnsignedLong slot) {\n+    final Optional<Bytes32> originalBestRoot = bestBlockRoot;\n+    final UnsignedLong originalBestSlot = bestSlot;\n     this.bestBlockRoot = Optional.of(root);\n     this.bestSlot = slot;\n     bestBlockInitialized.complete(null);\n+\n+    if (originalBestRoot.map(original -> isReorg(original, originalBestSlot)).orElse(false)) {\n+      reorgEventChannel.reorgOccurred();\n+    }\n+  }\n+\n+  private boolean isReorg(final Bytes32 originalBestRoot, final UnsignedLong originalBestSlot) {\n+    // Get the block root in effect at the old best slot on the new chain", "originalCommit": "392caf7c31b39f82e3b1994ddd3356d691c0a33c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ5ODQ5MQ==", "url": "https://github.com/ConsenSys/teku/pull/1612#discussion_r410498491", "bodyText": "Renamed the method and improved the comment to make it clearer.", "author": "ajsutton", "createdAt": "2020-04-17T22:25:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDMxMzYxMA=="}], "type": "inlineReview", "revised_code": {"commit": "5fcb66059760e105ac8f24a16d5b07602fbe7f48", "chunk": "diff --git a/storage/src/main/java/tech/pegasys/artemis/storage/client/RecentChainData.java b/storage/src/main/java/tech/pegasys/artemis/storage/client/RecentChainData.java\nindex 2f6998d9e0..631d712492 100644\n--- a/storage/src/main/java/tech/pegasys/artemis/storage/client/RecentChainData.java\n+++ b/storage/src/main/java/tech/pegasys/artemis/storage/client/RecentChainData.java\n\n@@ -140,13 +140,18 @@ public abstract class RecentChainData implements StoreUpdateHandler {\n     this.bestSlot = slot;\n     bestBlockInitialized.complete(null);\n \n-    if (originalBestRoot.map(original -> isReorg(original, originalBestSlot)).orElse(false)) {\n+    if (originalBestRoot\n+        .map(original -> hasReorgedFrom(original, originalBestSlot))\n+        .orElse(false)) {\n       reorgEventChannel.reorgOccurred();\n     }\n   }\n \n-  private boolean isReorg(final Bytes32 originalBestRoot, final UnsignedLong originalBestSlot) {\n-    // Get the block root in effect at the old best slot on the new chain\n+  private boolean hasReorgedFrom(\n+      final Bytes32 originalBestRoot, final UnsignedLong originalBestSlot) {\n+    // Get the block root in effect at the old best slot on the current best chain. If this is a\n+    // different fork to the previous chain the root at originalBestSlot will be different from\n+    // originalBestRoot. If it's an extension of the same chain it will match.\n     return getBlockRootBySlot(originalBestSlot)\n         .map(rootAtOldBestSlot -> !rootAtOldBestSlot.equals(originalBestRoot))\n         .orElse(true);\n"}}, {"oid": "5fcb66059760e105ac8f24a16d5b07602fbe7f48", "url": "https://github.com/ConsenSys/teku/commit/5fcb66059760e105ac8f24a16d5b07602fbe7f48", "message": "Improve comment.", "committedDate": "2020-04-17T22:13:19Z", "type": "commit"}, {"oid": "e15370756310860be4017abbd339d91a66c3a45b", "url": "https://github.com/ConsenSys/teku/commit/e15370756310860be4017abbd339d91a66c3a45b", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into detect-reorg", "committedDate": "2020-04-17T22:13:28Z", "type": "commit"}]}