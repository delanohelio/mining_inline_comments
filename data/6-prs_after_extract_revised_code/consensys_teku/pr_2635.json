{"pr_number": 2635, "pr_title": "Regenerate checkpoint state before taking out the fork choice lock to avoid deadlock", "pr_createdAt": "2020-08-20T23:18:31Z", "pr_url": "https://github.com/ConsenSys/teku/pull/2635", "timeline": [{"oid": "3445d5b06a4806db96ce5eb786eb5b3335fd5e0c", "url": "https://github.com/ConsenSys/teku/commit/3445d5b06a4806db96ce5eb786eb5b3335fd5e0c", "message": "Regenerate checkpoint state before taking out the fork choice lock to avoid a risk of deadlock.", "committedDate": "2020-08-20T23:14:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDMzMjU1MA==", "url": "https://github.com/ConsenSys/teku/pull/2635#discussion_r474332550", "bodyText": "if this is going to be an info, does it need to have more context?", "author": "rolfyone", "createdAt": "2020-08-20T23:52:09Z", "path": "ethereum/statetransition/src/main/java/tech/pegasys/teku/statetransition/forkchoice/ForkChoice.java", "diffHunk": "@@ -61,38 +63,42 @@ public void processHead(UInt64 nodeSlot) {\n   }\n \n   private void processHead(Optional<UInt64> nodeSlot) {\n-    withLock(\n-            () -> {\n-              final Checkpoint finalizedCheckpoint =\n-                  recentChainData.getStore().getFinalizedCheckpoint();\n-              final Checkpoint justifiedCheckpoint =\n-                  recentChainData.getStore().getJustifiedCheckpoint();\n-              return recentChainData\n-                  .retrieveCheckpointState(justifiedCheckpoint)\n-                  .thenCompose(\n-                      justifiedCheckpointState -> {\n-                        final StoreTransaction transaction =\n-                            recentChainData.startStoreTransaction();\n-                        final ForkChoiceStrategy forkChoiceStrategy = getForkChoiceStrategy();\n-                        Bytes32 headBlockRoot =\n-                            forkChoiceStrategy.findHead(\n-                                transaction,\n-                                finalizedCheckpoint,\n-                                justifiedCheckpoint,\n-                                justifiedCheckpointState.orElseThrow());\n-\n-                        recentChainData.updateHead(\n-                            headBlockRoot,\n-                            nodeSlot.orElse(\n-                                forkChoiceStrategy\n-                                    .blockSlot(headBlockRoot)\n-                                    .orElseThrow(\n-                                        () ->\n-                                            new IllegalStateException(\n-                                                \"Unable to retrieve the slot of fork choice head\"))));\n-                        return transaction.commit();\n-                      });\n-            })\n+    final Checkpoint retrievedJustifiedCheckpoint =\n+        recentChainData.getStore().getJustifiedCheckpoint();\n+    recentChainData\n+        .retrieveCheckpointState(retrievedJustifiedCheckpoint)\n+        .thenCompose(\n+            justifiedCheckpointState ->\n+                withLock(\n+                    () -> {\n+                      final Checkpoint finalizedCheckpoint =\n+                          recentChainData.getStore().getFinalizedCheckpoint();\n+                      final Checkpoint justifiedCheckpoint =\n+                          recentChainData.getStore().getJustifiedCheckpoint();\n+                      if (!justifiedCheckpoint.equals(retrievedJustifiedCheckpoint)) {\n+                        LOG.info(\n+                            \"Skipping head block update as justified checkpoint was updated while loading checkpoint state.\");", "originalCommit": "3445d5b06a4806db96ce5eb786eb5b3335fd5e0c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDM0NDU3MA==", "url": "https://github.com/ConsenSys/teku/pull/2635#discussion_r474344570", "bodyText": "Added some extra info.", "author": "ajsutton", "createdAt": "2020-08-21T00:36:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDMzMjU1MA=="}], "type": "inlineReview", "revised_code": {"commit": "7178c63a3aea570bee4d6fe306736258ceaa5cdc", "chunk": "diff --git a/ethereum/statetransition/src/main/java/tech/pegasys/teku/statetransition/forkchoice/ForkChoice.java b/ethereum/statetransition/src/main/java/tech/pegasys/teku/statetransition/forkchoice/ForkChoice.java\nindex 67cd8e3089..75d9e9e08e 100644\n--- a/ethereum/statetransition/src/main/java/tech/pegasys/teku/statetransition/forkchoice/ForkChoice.java\n+++ b/ethereum/statetransition/src/main/java/tech/pegasys/teku/statetransition/forkchoice/ForkChoice.java\n\n@@ -77,7 +77,11 @@ public class ForkChoice {\n                           recentChainData.getStore().getJustifiedCheckpoint();\n                       if (!justifiedCheckpoint.equals(retrievedJustifiedCheckpoint)) {\n                         LOG.info(\n-                            \"Skipping head block update as justified checkpoint was updated while loading checkpoint state.\");\n+                            \"Skipping head block update as justified checkpoint was updated while loading checkpoint state. Was {} ({}) but now {} ({})\",\n+                            retrievedJustifiedCheckpoint.getEpoch(),\n+                            retrievedJustifiedCheckpoint.getRoot(),\n+                            justifiedCheckpoint.getEpoch(),\n+                            justifiedCheckpoint.getRoot());\n                       }\n                       final StoreTransaction transaction = recentChainData.startStoreTransaction();\n                       final ForkChoiceStrategy forkChoiceStrategy = getForkChoiceStrategy();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDMzMjcyMg==", "url": "https://github.com/ConsenSys/teku/pull/2635#discussion_r474332722", "bodyText": "did we want to include the headBlockRoot in here?", "author": "rolfyone", "createdAt": "2020-08-20T23:52:50Z", "path": "ethereum/statetransition/src/main/java/tech/pegasys/teku/statetransition/forkchoice/ForkChoice.java", "diffHunk": "@@ -61,38 +63,42 @@ public void processHead(UInt64 nodeSlot) {\n   }\n \n   private void processHead(Optional<UInt64> nodeSlot) {\n-    withLock(\n-            () -> {\n-              final Checkpoint finalizedCheckpoint =\n-                  recentChainData.getStore().getFinalizedCheckpoint();\n-              final Checkpoint justifiedCheckpoint =\n-                  recentChainData.getStore().getJustifiedCheckpoint();\n-              return recentChainData\n-                  .retrieveCheckpointState(justifiedCheckpoint)\n-                  .thenCompose(\n-                      justifiedCheckpointState -> {\n-                        final StoreTransaction transaction =\n-                            recentChainData.startStoreTransaction();\n-                        final ForkChoiceStrategy forkChoiceStrategy = getForkChoiceStrategy();\n-                        Bytes32 headBlockRoot =\n-                            forkChoiceStrategy.findHead(\n-                                transaction,\n-                                finalizedCheckpoint,\n-                                justifiedCheckpoint,\n-                                justifiedCheckpointState.orElseThrow());\n-\n-                        recentChainData.updateHead(\n-                            headBlockRoot,\n-                            nodeSlot.orElse(\n-                                forkChoiceStrategy\n-                                    .blockSlot(headBlockRoot)\n-                                    .orElseThrow(\n-                                        () ->\n-                                            new IllegalStateException(\n-                                                \"Unable to retrieve the slot of fork choice head\"))));\n-                        return transaction.commit();\n-                      });\n-            })\n+    final Checkpoint retrievedJustifiedCheckpoint =\n+        recentChainData.getStore().getJustifiedCheckpoint();\n+    recentChainData\n+        .retrieveCheckpointState(retrievedJustifiedCheckpoint)\n+        .thenCompose(\n+            justifiedCheckpointState ->\n+                withLock(\n+                    () -> {\n+                      final Checkpoint finalizedCheckpoint =\n+                          recentChainData.getStore().getFinalizedCheckpoint();\n+                      final Checkpoint justifiedCheckpoint =\n+                          recentChainData.getStore().getJustifiedCheckpoint();\n+                      if (!justifiedCheckpoint.equals(retrievedJustifiedCheckpoint)) {\n+                        LOG.info(\n+                            \"Skipping head block update as justified checkpoint was updated while loading checkpoint state.\");\n+                      }\n+                      final StoreTransaction transaction = recentChainData.startStoreTransaction();\n+                      final ForkChoiceStrategy forkChoiceStrategy = getForkChoiceStrategy();\n+                      Bytes32 headBlockRoot =\n+                          forkChoiceStrategy.findHead(\n+                              transaction,\n+                              finalizedCheckpoint,\n+                              justifiedCheckpoint,\n+                              justifiedCheckpointState.orElseThrow());\n+\n+                      recentChainData.updateHead(\n+                          headBlockRoot,\n+                          nodeSlot.orElse(\n+                              forkChoiceStrategy\n+                                  .blockSlot(headBlockRoot)\n+                                  .orElseThrow(\n+                                      () ->\n+                                          new IllegalStateException(\n+                                              \"Unable to retrieve the slot of fork choice head\"))));", "originalCommit": "3445d5b06a4806db96ce5eb786eb5b3335fd5e0c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDM0NDUxNw==", "url": "https://github.com/ConsenSys/teku/pull/2635#discussion_r474344517", "bodyText": "Done.  Pretty sure this is an \"impossible\" situation since we just found the root from protoarray and we're still holding the lock so nothing can change it in the meantime.", "author": "ajsutton", "createdAt": "2020-08-21T00:35:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDMzMjcyMg=="}], "type": "inlineReview", "revised_code": {"commit": "7178c63a3aea570bee4d6fe306736258ceaa5cdc", "chunk": "diff --git a/ethereum/statetransition/src/main/java/tech/pegasys/teku/statetransition/forkchoice/ForkChoice.java b/ethereum/statetransition/src/main/java/tech/pegasys/teku/statetransition/forkchoice/ForkChoice.java\nindex 67cd8e3089..75d9e9e08e 100644\n--- a/ethereum/statetransition/src/main/java/tech/pegasys/teku/statetransition/forkchoice/ForkChoice.java\n+++ b/ethereum/statetransition/src/main/java/tech/pegasys/teku/statetransition/forkchoice/ForkChoice.java\n\n@@ -77,7 +77,11 @@ public class ForkChoice {\n                           recentChainData.getStore().getJustifiedCheckpoint();\n                       if (!justifiedCheckpoint.equals(retrievedJustifiedCheckpoint)) {\n                         LOG.info(\n-                            \"Skipping head block update as justified checkpoint was updated while loading checkpoint state.\");\n+                            \"Skipping head block update as justified checkpoint was updated while loading checkpoint state. Was {} ({}) but now {} ({})\",\n+                            retrievedJustifiedCheckpoint.getEpoch(),\n+                            retrievedJustifiedCheckpoint.getRoot(),\n+                            justifiedCheckpoint.getEpoch(),\n+                            justifiedCheckpoint.getRoot());\n                       }\n                       final StoreTransaction transaction = recentChainData.startStoreTransaction();\n                       final ForkChoiceStrategy forkChoiceStrategy = getForkChoiceStrategy();\n"}}, {"oid": "7178c63a3aea570bee4d6fe306736258ceaa5cdc", "url": "https://github.com/ConsenSys/teku/commit/7178c63a3aea570bee4d6fe306736258ceaa5cdc", "message": "Add more context to messages.", "committedDate": "2020-08-21T00:35:20Z", "type": "commit"}, {"oid": "ca22ada2e3afb83907dd7bf57f7bf39784fe2d7a", "url": "https://github.com/ConsenSys/teku/commit/ca22ada2e3afb83907dd7bf57f7bf39784fe2d7a", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into regenerate-before-forkchoice", "committedDate": "2020-08-21T00:36:09Z", "type": "commit"}]}