{"pr_number": 1554, "pr_title": "added a default path for data folder", "pr_createdAt": "2020-04-08T03:11:34Z", "pr_url": "https://github.com/ConsenSys/teku/pull/1554", "timeline": [{"oid": "964a1ea065b2eaa225e7866b822cfc103203892b", "url": "https://github.com/ConsenSys/teku/commit/964a1ea065b2eaa225e7866b822cfc103203892b", "message": "added a default path for data folder\n\nadded a default path for log files\n\nUpdated regression tests to cope with the user path based defaults.\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-04-08T03:10:31Z", "type": "commit"}, {"oid": "16bc210cf4b349be51d55bab9d872d3b0830846c", "url": "https://github.com/ConsenSys/teku/commit/16bc210cf4b349be51d55bab9d872d3b0830846c", "message": "Merge remote-tracking branch 'upstream/master' into 1411-default-storage-path", "committedDate": "2020-04-08T03:11:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI4NDk5Ng==", "url": "https://github.com/ConsenSys/teku/pull/1554#discussion_r405284996", "bodyText": "interesting - I changed BEACONCHAIN to BEACON", "author": "macfarla", "createdAt": "2020-04-08T06:24:48Z", "path": "artemis/src/test/java/tech/pegasys/artemis/cli/BeaconNodeCommandTest.java", "diffHunk": "@@ -228,9 +242,9 @@ private ArtemisConfigurationBuilder expectedConfigurationBuilder() {\n         .setMetricsInterface(\"127.0.0.1\")\n         .setMetricsCategories(Arrays.asList(\"BEACONCHAIN\", \"JVM\", \"PROCESS\"))", "originalCommit": "16bc210cf4b349be51d55bab9d872d3b0830846c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e26e19d08a4937eaf814a0d4f92d53b7c7b7d3ea", "chunk": "diff --git a/artemis/src/test/java/tech/pegasys/artemis/cli/BeaconNodeCommandTest.java b/artemis/src/test/java/tech/pegasys/artemis/cli/BeaconNodeCommandTest.java\nindex 7e4245cbb..9c2055f06 100644\n--- a/artemis/src/test/java/tech/pegasys/artemis/cli/BeaconNodeCommandTest.java\n+++ b/artemis/src/test/java/tech/pegasys/artemis/cli/BeaconNodeCommandTest.java\n\n@@ -240,7 +256,7 @@ public class BeaconNodeCommandTest {\n         .setMetricsEnabled(false)\n         .setMetricsPort(8008)\n         .setMetricsInterface(\"127.0.0.1\")\n-        .setMetricsCategories(Arrays.asList(\"BEACONCHAIN\", \"JVM\", \"PROCESS\"))\n+        .setMetricsCategories(Arrays.asList(\"BEACON\", \"JVM\", \"PROCESS\"))\n         .setLogColorEnabled(true)\n         .setLogDestination(DEFAULT_LOG_DESTINATION)\n         .setLogFile(DEFAULT_LOG_FILE)\n"}}, {"oid": "2db08c1b3434854fa3385c22851c3ad7903cd9fa", "url": "https://github.com/ConsenSys/teku/commit/2db08c1b3434854fa3385c22851c3ad7903cd9fa", "message": "Merge remote-tracking branch 'remotes/upstream/master' into 1411_default_storage-path\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-04-08T10:13:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTQ1MTE4NA==", "url": "https://github.com/ConsenSys/teku/pull/1554#discussion_r405451184", "bodyText": "This should be the $XDG_DATA_HOME:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                return \"~/.teku\";\n          \n          \n            \n                return \"~/.local/share/teku\";\n          \n      \n    \n    \n  \n\n\n$XDG_DATA_HOME defines the base directory relative to which user specific data files should be stored. If $XDG_DATA_HOME is either not set or empty, a default equal to $HOME/.local/share should be used.\n\nhttps://specifications.freedesktop.org/basedir-spec/basedir-spec-latest.html\n\nHistorically, Unix programs were free to spread their data all over the $HOME directory, putting their data in dot-files (files starting with \".\") or subdirectories such as ~/.vimrc and ~/.vim. The new specification is intended to make this behavior more predictable.\n\nhttps://askubuntu.com/questions/14535/whats-the-local-folder-for-in-my-home-directory", "author": "q9f", "createdAt": "2020-04-08T11:24:23Z", "path": "util/src/main/java/tech/pegasys/artemis/util/cli/VersionProvider.java", "diffHunk": "@@ -45,6 +45,16 @@ public static String detectJvm() {\n     return detectedVM + \"-java-\" + detectedJavaVersion;\n   }\n \n+  public static String defaultStoragePath() {\n+    final String detectedOS = normalizeOS(normalize(\"os.name\"));\n+    if (detectedOS.equals(\"windows\")) {\n+      return System.getenv(\"LOCALAPPDATA\") + \"/teku\";\n+    } else if (detectedOS.equals(\"osx\")) {\n+      return System.getenv(\"HOME\") + \"/Library/teku\";\n+    }\n+    return \"~/.teku\";", "originalCommit": "16bc210cf4b349be51d55bab9d872d3b0830846c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkxNjk3MA==", "url": "https://github.com/ConsenSys/teku/pull/1554#discussion_r405916970", "bodyText": "Thanks for the feedback, I appreciate the level of information you've given, it's a compelling argument. I've made a larger change to incorporate your suggestion so that I can test the behaviors and make sure they're what is expected.", "author": "rolfyone", "createdAt": "2020-04-09T02:12:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTQ1MTE4NA=="}], "type": "inlineReview", "revised_code": {"commit": "b88ea92227fa54a5bfae3d0f392e62d909c6b09c", "chunk": "diff --git a/util/src/main/java/tech/pegasys/artemis/util/cli/VersionProvider.java b/util/src/main/java/tech/pegasys/artemis/util/cli/VersionProvider.java\nindex 7d86d03cd..0e496270a 100644\n--- a/util/src/main/java/tech/pegasys/artemis/util/cli/VersionProvider.java\n+++ b/util/src/main/java/tech/pegasys/artemis/util/cli/VersionProvider.java\n\n@@ -47,12 +51,21 @@ public class VersionProvider implements CommandLine.IVersionProvider {\n \n   public static String defaultStoragePath() {\n     final String detectedOS = normalizeOS(normalize(\"os.name\"));\n+    return defaultStoragePathForNormalisedOS(detectedOS, System.getenv());\n+  }\n+\n+  static String defaultStoragePathForNormalisedOS(\n+      final String detectedOS, Map<String, String> env) {\n     if (detectedOS.equals(\"windows\")) {\n-      return System.getenv(\"LOCALAPPDATA\") + \"/teku\";\n+      return env.get(ENV_LOCALAPPDATA) + \"\\\\teku\";\n     } else if (detectedOS.equals(\"osx\")) {\n-      return System.getenv(\"HOME\") + \"/Library/teku\";\n+      return env.get(ENV_HOME) + \"/Library/teku\";\n+    }\n+    String dataHome = env.get(ENV_XDG_DATA_HOME);\n+    if (StringUtils.isEmpty(dataHome)) {\n+      dataHome = env.get(ENV_HOME) + \"/.local/share\";\n     }\n-    return \"~/.teku\";\n+    return dataHome + \"/teku\";\n   }\n \n   private static String normalizeOS(final String osName) {\n"}}, {"oid": "c375a1572dabdf2e3524576f81d1e89335fddcea", "url": "https://github.com/ConsenSys/teku/commit/c375a1572dabdf2e3524576f81d1e89335fddcea", "message": "Merge pull request #1 from usmansaleem/1411_default_storage-path\n\nFix Merge conflicts from Teku master", "committedDate": "2020-04-09T00:03:24Z", "type": "commit"}, {"oid": "93831e8e7ff77e6cacb21c676bcea8b2dcc819dd", "url": "https://github.com/ConsenSys/teku/commit/93831e8e7ff77e6cacb21c676bcea8b2dcc819dd", "message": "Merge remote-tracking branch 'upstream/master' into 1411-default-storage-path", "committedDate": "2020-04-09T00:03:47Z", "type": "commit"}, {"oid": "b88ea92227fa54a5bfae3d0f392e62d909c6b09c", "url": "https://github.com/ConsenSys/teku/commit/b88ea92227fa54a5bfae3d0f392e62d909c6b09c", "message": "changes from review feedback\n\nalso restructured to allow testing.\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-04-09T02:10:40Z", "type": "commit"}, {"oid": "e26e19d08a4937eaf814a0d4f92d53b7c7b7d3ea", "url": "https://github.com/ConsenSys/teku/commit/e26e19d08a4937eaf814a0d4f92d53b7c7b7d3ea", "message": "Merge remote-tracking branch 'upstream/master' into 1411-default-storage-path", "committedDate": "2020-04-09T02:12:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkyMDU4OQ==", "url": "https://github.com/ConsenSys/teku/pull/1554#discussion_r405920589", "bodyText": "nit: our standard is US spelling ie ize", "author": "macfarla", "createdAt": "2020-04-09T02:26:06Z", "path": "util/src/test/java/tech/pegasys/artemis/util/cli/VersionProviderTest.java", "diffHunk": "@@ -0,0 +1,67 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.util.cli;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static tech.pegasys.artemis.util.cli.VersionProvider.ENV_HOME;\n+import static tech.pegasys.artemis.util.cli.VersionProvider.ENV_LOCALAPPDATA;\n+import static tech.pegasys.artemis.util.cli.VersionProvider.ENV_XDG_DATA_HOME;\n+\n+import java.util.Map;\n+import org.apache.logging.log4j.util.Strings;\n+import org.junit.jupiter.api.Test;\n+\n+class VersionProviderTest {\n+  private final String TEKU = \"/teku\";\n+\n+  @Test\n+  void defaultStoragePath_shouldHandleWindowsPath() {\n+    final String homeFolder = \"c:\\\\users\\\\myUser\\\\AppData\\\\local\";\n+    final Map<String, String> env = Map.of(ENV_LOCALAPPDATA, homeFolder);\n+    assertThat(VersionProvider.defaultStoragePathForNormalisedOS(\"windows\", env))\n+        .isEqualTo(homeFolder + \"\\\\teku\");\n+  }\n+\n+  @Test\n+  void defaultStoragePath_shouldHandleMacPath() {\n+    final String homeFolder = \"/Users/myUser\";\n+    Map<String, String> env = Map.of(ENV_HOME, homeFolder);\n+    assertThat(VersionProvider.defaultStoragePathForNormalisedOS(\"osx\", env))\n+        .isEqualTo(homeFolder + \"/Library\" + TEKU);\n+  }\n+\n+  @Test\n+  void defaultStoragePath_shouldHandleXdgHome() {\n+    final String homeFolder = \"/data/myUser\";\n+    Map<String, String> env = Map.of(ENV_XDG_DATA_HOME, homeFolder);\n+    assertThat(VersionProvider.defaultStoragePathForNormalisedOS(\"linux\", env))", "originalCommit": "e26e19d08a4937eaf814a0d4f92d53b7c7b7d3ea", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "cefd923138745cae35660d68d23132b2c479d091", "chunk": "diff --git a/util/src/test/java/tech/pegasys/artemis/util/cli/VersionProviderTest.java b/util/src/test/java/tech/pegasys/artemis/util/cli/VersionProviderTest.java\nindex e5e87be01..30bc97983 100644\n--- a/util/src/test/java/tech/pegasys/artemis/util/cli/VersionProviderTest.java\n+++ b/util/src/test/java/tech/pegasys/artemis/util/cli/VersionProviderTest.java\n\n@@ -29,7 +29,7 @@ class VersionProviderTest {\n   void defaultStoragePath_shouldHandleWindowsPath() {\n     final String homeFolder = \"c:\\\\users\\\\myUser\\\\AppData\\\\local\";\n     final Map<String, String> env = Map.of(ENV_LOCALAPPDATA, homeFolder);\n-    assertThat(VersionProvider.defaultStoragePathForNormalisedOS(\"windows\", env))\n+    assertThat(VersionProvider.defaultStoragePathForNormalizedOS(\"windows\", env))\n         .isEqualTo(homeFolder + \"\\\\teku\");\n   }\n \n"}}, {"oid": "cefd923138745cae35660d68d23132b2c479d091", "url": "https://github.com/ConsenSys/teku/commit/cefd923138745cae35660d68d23132b2c479d091", "message": "changes from review feedback\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-04-09T02:29:14Z", "type": "commit"}]}