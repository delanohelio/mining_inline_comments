{"pr_number": 1085, "pr_title": "Improve sync logging", "pr_createdAt": "2020-01-11T00:08:53Z", "pr_url": "https://github.com/ConsenSys/teku/pull/1085", "timeline": [{"oid": "553461a52d3b2decb697e992ead593937c5c5c62", "url": "https://github.com/ConsenSys/teku/commit/553461a52d3b2decb697e992ead593937c5c5c62", "message": "Improve sync logging", "committedDate": "2020-01-11T00:07:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTYwNzcxNw==", "url": "https://github.com/ConsenSys/teku/pull/1085#discussion_r365607717", "bodyText": "The ALogger in this case will wind up going to stdout whereas LogManager.getLogger won't.  I'd be tempted to remove the ALogger from here and always use Log4J directly but then edit the default log4j.xml to send logs from this class to stdout. Or if you prefer, add a method to ALogger so that it can print exception stack traces and stick with using it.", "author": "ajsutton", "createdAt": "2020-01-12T20:16:32Z", "path": "artemis/src/main/java/tech/pegasys/artemis/BeaconNode.java", "diffHunk": "@@ -116,7 +118,7 @@ public void stop() {\n   public final void handleException(\n       final Throwable exception, final SubscriberExceptionContext context) {\n     if (!isSpecFailure(exception)) {\n-      logger.log(Level.FATAL, \"Unexpected exception thrown in handler - PLEASE FIX OR REPORT\");\n+      LOG.error(\"Unhandled exception in handler for event \" + context.getEvent(), exception);", "originalCommit": "553461a52d3b2decb697e992ead593937c5c5c62", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTkzMjYzMg==", "url": "https://github.com/ConsenSys/teku/pull/1085#discussion_r365932632", "bodyText": "Added some ALogger methods that accept exceptions.", "author": "mbaxter", "createdAt": "2020-01-13T17:33:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTYwNzcxNw=="}], "type": "inlineReview", "revised_code": {"commit": "176e05a4ac8a6c0fdb775e2d97c89a91286492f4", "chunk": "diff --git a/artemis/src/main/java/tech/pegasys/artemis/BeaconNode.java b/artemis/src/main/java/tech/pegasys/artemis/BeaconNode.java\nindex abb9e9568..d69ace43b 100644\n--- a/artemis/src/main/java/tech/pegasys/artemis/BeaconNode.java\n+++ b/artemis/src/main/java/tech/pegasys/artemis/BeaconNode.java\n\n@@ -118,7 +116,11 @@ final class EventBusExceptionHandler implements SubscriberExceptionHandler {\n   public final void handleException(\n       final Throwable exception, final SubscriberExceptionContext context) {\n     if (!isSpecFailure(exception)) {\n-      LOG.error(\"Unhandled exception in handler for event \" + context.getEvent(), exception);\n+      logger.log(\n+          Level.FATAL,\n+          \"PLEASE FIX OR REPORT | Unexpected exception thrown for \"\n+              + describeSubscriberException(exception, context),\n+          Color.RED);\n       throw new RuntimeException(exception);\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTYwNzg1OA==", "url": "https://github.com/ConsenSys/teku/pull/1085#discussion_r365607858", "bodyText": "Note that this will print the exception message, but not the full stack trace. Not sure if that's what you wanted or not.  You can't use placeholders and get a full stack trace.", "author": "ajsutton", "createdAt": "2020-01-12T20:19:03Z", "path": "sync/src/main/java/tech/pegasys/artemis/sync/PeerSync.java", "diffHunk": "@@ -48,12 +48,20 @@ public PeerSync(final ChainStorageClient storageClient, final BlockImporter bloc\n   }\n \n   public SafeFuture<PeerSyncResult> sync(final Eth2Peer peer) {\n+    LOG.debug(\"Start syncing to peer {}\", peer);\n     // Begin requesting blocks at our first non-finalized slot\n     final UnsignedLong finalizedEpoch = storageClient.getFinalizedEpoch();\n     final UnsignedLong latestFinalizedSlot = compute_start_slot_at_epoch(finalizedEpoch);\n     final UnsignedLong firstNonFinalSlot = latestFinalizedSlot.plus(UnsignedLong.ONE);\n \n-    return executeSync(peer, peer.getStatus(), firstNonFinalSlot);\n+    return executeSync(peer, peer.getStatus(), firstNonFinalSlot)\n+      .whenComplete((res,err) -> {\n+        if (err != null) {\n+          LOG.debug(\"Failed to sync with peer {}: {}\", peer, err);", "originalCommit": "553461a52d3b2decb697e992ead593937c5c5c62", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "675bc6bb6db5ac31bc5f3358ea4e078bad7c02c4", "chunk": "diff --git a/sync/src/main/java/tech/pegasys/artemis/sync/PeerSync.java b/sync/src/main/java/tech/pegasys/artemis/sync/PeerSync.java\nindex 29c257a1b..4224169d2 100644\n--- a/sync/src/main/java/tech/pegasys/artemis/sync/PeerSync.java\n+++ b/sync/src/main/java/tech/pegasys/artemis/sync/PeerSync.java\n\n@@ -55,13 +55,14 @@ public class PeerSync {\n     final UnsignedLong firstNonFinalSlot = latestFinalizedSlot.plus(UnsignedLong.ONE);\n \n     return executeSync(peer, peer.getStatus(), firstNonFinalSlot)\n-      .whenComplete((res,err) -> {\n-        if (err != null) {\n-          LOG.debug(\"Failed to sync with peer {}: {}\", peer, err);\n-        } else {\n-          LOG.debug(\"Finished syncing (with status {}) to peer {}\", res.name(), peer);\n-        }\n-      });\n+        .whenComplete(\n+            (res, err) -> {\n+              if (err != null) {\n+                LOG.debug(\"Failed to sync with peer {}: {}\", peer, err);\n+              } else {\n+                LOG.debug(\"Finished syncing (with status {}) to peer {}\", res.name(), peer);\n+              }\n+            });\n   }\n \n   public void stop() {\n"}}, {"oid": "675bc6bb6db5ac31bc5f3358ea4e078bad7c02c4", "url": "https://github.com/ConsenSys/teku/commit/675bc6bb6db5ac31bc5f3358ea4e078bad7c02c4", "message": "Run spotless", "committedDate": "2020-01-13T15:37:06Z", "type": "commit"}, {"oid": "176e05a4ac8a6c0fdb775e2d97c89a91286492f4", "url": "https://github.com/ConsenSys/teku/commit/176e05a4ac8a6c0fdb775e2d97c89a91286492f4", "message": "Log BeaconNode errors to stdout", "committedDate": "2020-01-13T16:22:14Z", "type": "commit"}, {"oid": "a689a186efff9f38628ff2bc8d30cf682d4eae7d", "url": "https://github.com/ConsenSys/teku/commit/a689a186efff9f38628ff2bc8d30cf682d4eae7d", "message": "Log exception rather than rethrowing", "committedDate": "2020-01-13T16:37:54Z", "type": "commit"}, {"oid": "c9c05b7e11fa10c6f447e0af9519e97f6479ab3f", "url": "https://github.com/ConsenSys/teku/commit/c9c05b7e11fa10c6f447e0af9519e97f6479ab3f", "message": "Merge branch 'master' into minor/improve-sync-logging", "committedDate": "2020-01-13T16:38:11Z", "type": "commit"}, {"oid": "080128d5f04f15f31f05517ac068a0e88db99b54", "url": "https://github.com/ConsenSys/teku/commit/080128d5f04f15f31f05517ac068a0e88db99b54", "message": "Update EventBusExceptionHandler test", "committedDate": "2020-01-13T17:21:31Z", "type": "commit"}]}