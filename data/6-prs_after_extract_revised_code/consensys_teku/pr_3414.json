{"pr_number": 3414, "pr_title": "[Issue-3373] Graffiti loading without restart", "pr_createdAt": "2020-12-15T19:30:18Z", "pr_url": "https://github.com/ConsenSys/teku/pull/3414", "timeline": [{"oid": "2fc146319eba212a3d33cbd3b228f0435e8653ca", "url": "https://github.com/ConsenSys/teku/commit/2fc146319eba212a3d33cbd3b228f0435e8653ca", "message": "[Issue-3373] Implement a Graffiti class and a file loader in order to\nread graffiti from a file without restarting the validator", "committedDate": "2020-12-15T19:36:47Z", "type": "forcePushed"}, {"oid": "0de7c4bfec4df1bc582106309f460104f0a10dbb", "url": "https://github.com/ConsenSys/teku/commit/0de7c4bfec4df1bc582106309f460104f0a10dbb", "message": "[Issue-3373] Implement a Graffiti class and a file loader in order to\nread graffiti from a file without restarting the validator", "committedDate": "2020-12-15T19:49:34Z", "type": "forcePushed"}, {"oid": "01f20e1d0ce3c31f3913d6e6e7d95bdeb0edc08c", "url": "https://github.com/ConsenSys/teku/commit/01f20e1d0ce3c31f3913d6e6e7d95bdeb0edc08c", "message": "[Issue-3373] Implement a Graffiti class and a file loader in order to\nread graffiti from a file without restarting the validator", "committedDate": "2020-12-15T19:52:18Z", "type": "forcePushed"}, {"oid": "bc5d51c4b2bdd2217b036ac8b5c880437f860845", "url": "https://github.com/ConsenSys/teku/commit/bc5d51c4b2bdd2217b036ac8b5c880437f860845", "message": "[Issue-3373] Implement a Graffiti class and a file loader in order to\nread graffiti from a file without restarting the validator", "committedDate": "2020-12-15T20:47:35Z", "type": "forcePushed"}, {"oid": "b794d161b1796af7b2f4932942d4b2ff551e5ba4", "url": "https://github.com/ConsenSys/teku/commit/b794d161b1796af7b2f4932942d4b2ff551e5ba4", "message": "[Issue-3373] Implement a Graffiti class and a file loader in order to\nread graffiti from a file without restarting the validator", "committedDate": "2020-12-15T20:52:14Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzY1MTM5Nw==", "url": "https://github.com/ConsenSys/teku/pull/3414#discussion_r543651397", "bodyText": "(nit) May be worth adding a method to  Bytes32Converter that directly accepts a String as well.", "author": "mbaxter", "createdAt": "2020-12-15T20:07:14Z", "path": "teku/src/main/java/tech/pegasys/teku/cli/converter/GraffitiConverter.java", "diffHunk": "@@ -16,22 +16,21 @@\n import java.nio.charset.StandardCharsets;\n import org.apache.tuweni.bytes.Bytes32;\n import picocli.CommandLine;\n+import tech.pegasys.teku.validator.client.loader.graffiti.Bytes32Converter;\n \n public class GraffitiConverter implements CommandLine.ITypeConverter<Bytes32> {\n   @Override\n   public Bytes32 convert(final String value) {\n     byte[] input = value.getBytes(StandardCharsets.UTF_8);\n-    if (input.length > 32) {\n+    try {\n+      return Bytes32Converter.toBytes32(input);", "originalCommit": "01f20e1d0ce3c31f3913d6e6e7d95bdeb0edc08c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "4248ac57e2a9200bdb5561f113a515bde6e095ca", "chunk": "diff --git a/teku/src/main/java/tech/pegasys/teku/cli/converter/GraffitiConverter.java b/teku/src/main/java/tech/pegasys/teku/cli/converter/GraffitiConverter.java\nindex 60b128813b..e7abc09194 100644\n--- a/teku/src/main/java/tech/pegasys/teku/cli/converter/GraffitiConverter.java\n+++ b/teku/src/main/java/tech/pegasys/teku/cli/converter/GraffitiConverter.java\n\n@@ -16,14 +16,14 @@ package tech.pegasys.teku.cli.converter;\n import java.nio.charset.StandardCharsets;\n import org.apache.tuweni.bytes.Bytes32;\n import picocli.CommandLine;\n-import tech.pegasys.teku.validator.client.loader.graffiti.Bytes32Converter;\n+import tech.pegasys.teku.validator.client.loader.graffiti.Bytes32Parser;\n \n public class GraffitiConverter implements CommandLine.ITypeConverter<Bytes32> {\n   @Override\n   public Bytes32 convert(final String value) {\n     byte[] input = value.getBytes(StandardCharsets.UTF_8);\n     try {\n-      return Bytes32Converter.toBytes32(input);\n+      return Bytes32Parser.toBytes32(input);\n     } catch (final IllegalArgumentException e) {\n       throw (new CommandLine.TypeConversionException(\n           \"'\"\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzY2MTI3Mw==", "url": "https://github.com/ConsenSys/teku/pull/3414#discussion_r543661273", "bodyText": "Rather than using readAllBytes, it's probably safer to use something like FileInputStream to read at most 32 bytes, and then detect if there's extra unread data and, if so, throw an error.", "author": "mbaxter", "createdAt": "2020-12-15T20:23:53Z", "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/graffiti/GraffitiLoader.java", "diffHunk": "@@ -0,0 +1,38 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.validator.client.loader.graffiti;\n+\n+import static com.google.common.base.Preconditions.checkNotNull;\n+\n+import java.io.FileNotFoundException;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import org.apache.tuweni.bytes.Bytes32;\n+\n+public class GraffitiLoader {\n+  public static Bytes32 loadFromFile(final Path graffitiFile) throws GraffitiLoaderException {\n+    checkNotNull(graffitiFile, \"GraffitiFile path cannot be null\");\n+    try {\n+      return Bytes32Converter.toBytes32(Files.readAllBytes(graffitiFile));", "originalCommit": "01f20e1d0ce3c31f3913d6e6e7d95bdeb0edc08c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzcwMTY1Ng==", "url": "https://github.com/ConsenSys/teku/pull/3414#discussion_r543701656", "bodyText": "Great idea. What if we just read in the first 32 and ignored the rest?\nThinking out loud... I think that would error in the case of users adding 32 chars and a new line char?", "author": "EdwardPrentice", "createdAt": "2020-12-15T21:32:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzY2MTI3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQzMzEzNw==", "url": "https://github.com/ConsenSys/teku/pull/3414#discussion_r544433137", "bodyText": "That's a good point.  I think to start, I'd err on the side of being strict (fail to read from the file if the format is unexpected).  This could help prevent errors where the node operator has pointed to the wrong file, for example.  We want to be pretty careful about what we post to the chain - no way to remove it later :D", "author": "mbaxter", "createdAt": "2020-12-16T16:19:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzY2MTI3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQzNDI4Mg==", "url": "https://github.com/ConsenSys/teku/pull/3414#discussion_r544434282", "bodyText": "We could always add some validation at startup - try to read from the provided file and if it fails, refuse to start.  This would give the node operator a heads up that the format is wrong.", "author": "mbaxter", "createdAt": "2020-12-16T16:20:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzY2MTI3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDU5OTQxOA==", "url": "https://github.com/ConsenSys/teku/pull/3414#discussion_r544599418", "bodyText": "I've put a stricter check in. Of course we can't rely on failing at start up because the file can change subsequently. Let me know what you think.", "author": "EdwardPrentice", "createdAt": "2020-12-16T20:25:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzY2MTI3Mw=="}], "type": "inlineReview", "revised_code": {"commit": "bc5d51c4b2bdd2217b036ac8b5c880437f860845", "chunk": "diff --git a/validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/graffiti/GraffitiLoader.java b/validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/graffiti/GraffitiLoader.java\nindex 38a763d0b3..915a968360 100644\n--- a/validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/graffiti/GraffitiLoader.java\n+++ b/validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/graffiti/GraffitiLoader.java\n\n@@ -23,15 +23,15 @@ import org.apache.tuweni.bytes.Bytes32;\n \n public class GraffitiLoader {\n   public static Bytes32 loadFromFile(final Path graffitiFile) throws GraffitiLoaderException {\n-    checkNotNull(graffitiFile, \"GraffitiFile path cannot be null\");\n     try {\n+      checkNotNull(graffitiFile, \"GraffitiFile path cannot be null\");\n       return Bytes32Converter.toBytes32(Files.readAllBytes(graffitiFile));\n     } catch (final FileNotFoundException e) {\n       throw new GraffitiLoaderException(\"GraffitiFile file not found: \" + graffitiFile, e);\n     } catch (final IOException e) {\n       throw new GraffitiLoaderException(\n           \"Unexpected IO error while reading GraffitiFile: \" + e.getMessage(), e);\n-    } catch (final IllegalArgumentException e) {\n+    } catch (final Exception e) {\n       throw new GraffitiLoaderException(e);\n     }\n   }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzY2MzQ0OQ==", "url": "https://github.com/ConsenSys/teku/pull/3414#discussion_r543663449", "bodyText": "Looks like Bytes32.wrap expects the byte array to have exactly 32 bytes, so I don't think this will work.   With the current implementation we're allocating a single byte array which should be faster than creating a smaller Bytes object and then resizing it.", "author": "mbaxter", "createdAt": "2020-12-15T20:27:38Z", "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/graffiti/Bytes32Converter.java", "diffHunk": "@@ -0,0 +1,38 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.validator.client.loader.graffiti;\n+\n+import java.nio.charset.StandardCharsets;\n+import org.apache.tuweni.bytes.Bytes32;\n+\n+public class Bytes32Converter {\n+  public static Bytes32 toBytes32(final byte[] input) {\n+    if (input.length > 32) {\n+      throw new IllegalArgumentException(\n+          \"'\"\n+              + new String(input, StandardCharsets.UTF_8)\n+              + \"' converts to \"\n+              + input.length\n+              + \" bytes. Input must be 32 bytes or less.\");\n+    }\n+\n+    // TODO note to self and code reviewer. Is this implementation better or worse than\n+    //     return Bytes32.rightPad(Bytes32.wrap(\"myString\".getBytes(UTF_*)));", "originalCommit": "01f20e1d0ce3c31f3913d6e6e7d95bdeb0edc08c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bc5d51c4b2bdd2217b036ac8b5c880437f860845", "chunk": "diff --git a/validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/graffiti/Bytes32Converter.java b/validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/graffiti/Bytes32Converter.java\nindex f261d16d90..cd5b787070 100644\n--- a/validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/graffiti/Bytes32Converter.java\n+++ b/validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/graffiti/Bytes32Converter.java\n\n@@ -13,26 +13,21 @@\n \n package tech.pegasys.teku.validator.client.loader.graffiti;\n \n-import java.nio.charset.StandardCharsets;\n+import org.apache.tuweni.bytes.Bytes;\n import org.apache.tuweni.bytes.Bytes32;\n \n+import static java.nio.charset.StandardCharsets.UTF_8;\n+\n public class Bytes32Converter {\n   public static Bytes32 toBytes32(final byte[] input) {\n     if (input.length > 32) {\n       throw new IllegalArgumentException(\n           \"'\"\n-              + new String(input, StandardCharsets.UTF_8)\n+              + new String(input, UTF_8)\n               + \"' converts to \"\n               + input.length\n               + \" bytes. Input must be 32 bytes or less.\");\n     }\n-\n-    // TODO note to self and code reviewer. Is this implementation better or worse than\n-    //     return Bytes32.rightPad(Bytes32.wrap(\"myString\".getBytes(UTF_*)));\n-    // ?\n-    // Perhaps I should write a unit test to prove they are at least equivalent...\n-    byte[] bytes = new byte[32];\n-    System.arraycopy(input, 0, bytes, 0, input.length);\n-    return Bytes32.wrap(bytes);\n+    return Bytes32.wrap(Bytes32.rightPad(Bytes.wrap(input)));\n   }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzY2NTc1MA==", "url": "https://github.com/ConsenSys/teku/pull/3414#discussion_r543665750", "bodyText": "(nit) I think I'd call this something like GraffitiParser.  We use \"converters\" in the CLI package because this is a picocli concept.", "author": "mbaxter", "createdAt": "2020-12-15T20:31:34Z", "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/graffiti/Bytes32Converter.java", "diffHunk": "@@ -0,0 +1,38 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.validator.client.loader.graffiti;\n+\n+import java.nio.charset.StandardCharsets;\n+import org.apache.tuweni.bytes.Bytes32;\n+\n+public class Bytes32Converter {", "originalCommit": "01f20e1d0ce3c31f3913d6e6e7d95bdeb0edc08c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzY4NDQ3NA==", "url": "https://github.com/ConsenSys/teku/pull/3414#discussion_r543684474", "bodyText": "I think what I am trying to achieve here is separating the dirty business of converting from a String of some length to a Bytes32 from the higher level concept of Graffiti.\nAnd then \"GraffitiParser\" would ask this \"Bytes32parsingconvertingthingy\" to do most of the work for it. So maybe we need both names.\nDoes that make sense?", "author": "EdwardPrentice", "createdAt": "2020-12-15T21:03:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzY2NTc1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzY5NDI3Ng==", "url": "https://github.com/ConsenSys/teku/pull/3414#discussion_r543694276", "bodyText": "You mean we'd have GraffitiConverter, GraffitiParser, and Bytes32Parser ?", "author": "mbaxter", "createdAt": "2020-12-15T21:20:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzY2NTc1MA=="}], "type": "inlineReview", "revised_code": {"commit": "bc5d51c4b2bdd2217b036ac8b5c880437f860845", "chunk": "diff --git a/validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/graffiti/Bytes32Converter.java b/validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/graffiti/Bytes32Converter.java\nindex f261d16d90..cd5b787070 100644\n--- a/validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/graffiti/Bytes32Converter.java\n+++ b/validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/graffiti/Bytes32Converter.java\n\n@@ -13,26 +13,21 @@\n \n package tech.pegasys.teku.validator.client.loader.graffiti;\n \n-import java.nio.charset.StandardCharsets;\n+import org.apache.tuweni.bytes.Bytes;\n import org.apache.tuweni.bytes.Bytes32;\n \n+import static java.nio.charset.StandardCharsets.UTF_8;\n+\n public class Bytes32Converter {\n   public static Bytes32 toBytes32(final byte[] input) {\n     if (input.length > 32) {\n       throw new IllegalArgumentException(\n           \"'\"\n-              + new String(input, StandardCharsets.UTF_8)\n+              + new String(input, UTF_8)\n               + \"' converts to \"\n               + input.length\n               + \" bytes. Input must be 32 bytes or less.\");\n     }\n-\n-    // TODO note to self and code reviewer. Is this implementation better or worse than\n-    //     return Bytes32.rightPad(Bytes32.wrap(\"myString\".getBytes(UTF_*)));\n-    // ?\n-    // Perhaps I should write a unit test to prove they are at least equivalent...\n-    byte[] bytes = new byte[32];\n-    System.arraycopy(input, 0, bytes, 0, input.length);\n-    return Bytes32.wrap(bytes);\n+    return Bytes32.wrap(Bytes32.rightPad(Bytes.wrap(input)));\n   }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzY2NjY3Ng==", "url": "https://github.com/ConsenSys/teku/pull/3414#discussion_r543666676", "bodyText": "I'd keep this signature the same (returning Optional<Bytes32> and just load the graffiti here.", "author": "mbaxter", "createdAt": "2020-12-15T20:33:05Z", "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/Validator.java", "diffHunk": "@@ -38,7 +35,7 @@ public Signer getSigner() {\n     return signer;\n   }\n \n-  public Optional<Bytes32> getGraffiti() {\n+  public Graffiti getGraffiti() {", "originalCommit": "01f20e1d0ce3c31f3913d6e6e7d95bdeb0edc08c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "394876973e96b0ba65ba3e5abc5ad004ffb60cb8", "chunk": "diff --git a/validator/client/src/main/java/tech/pegasys/teku/validator/client/Validator.java b/validator/client/src/main/java/tech/pegasys/teku/validator/client/Validator.java\nindex 29326c5e74..9151b115a2 100644\n--- a/validator/client/src/main/java/tech/pegasys/teku/validator/client/Validator.java\n+++ b/validator/client/src/main/java/tech/pegasys/teku/validator/client/Validator.java\n\n@@ -35,8 +37,8 @@ public class Validator {\n     return signer;\n   }\n \n-  public Graffiti getGraffiti() {\n-    return graffiti;\n+  public Optional<Bytes32> getGraffiti() {\n+    return graffiti.getGraffiti();\n   }\n \n   @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzY3MDQ5NQ==", "url": "https://github.com/ConsenSys/teku/pull/3414#discussion_r543670495", "bodyText": "I think we could simplify and make this more easily customizable by defining a GraffitiProvider interface:\n@FunctionalInterface\ninterface GraffitiProvider {\n  Optional<Bytes32> get();\n}\n\nValidatorConfig could then just have a single graffitiProvider(...) setter.\nWe could then move the new Graffiti class to FileBackedGraffitiProvider implements GraffitiProvider.   The actual provider instance would be constructed in ValidatorOptions.", "author": "mbaxter", "createdAt": "2020-12-15T20:39:48Z", "path": "validator/api/src/main/java/tech/pegasys/teku/validator/api/ValidatorConfig.java", "diffHunk": "@@ -259,6 +267,11 @@ public Builder graffiti(Bytes32 graffiti) {\n       return this;\n     }\n \n+    public Builder graffitiFile(Path graffitiFile) {\n+      this.graffitiFile = graffitiFile;\n+      return this;\n+    }", "originalCommit": "01f20e1d0ce3c31f3913d6e6e7d95bdeb0edc08c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzczMDk0MQ==", "url": "https://github.com/ConsenSys/teku/pull/3414#discussion_r543730941", "bodyText": "I'm unsure \ud83d\ude15 I think that would yield some different behaviour if the graffiti were to be removed at some point (the fallback behaviour changes). I guess we need to pin that down first?", "author": "EdwardPrentice", "createdAt": "2020-12-15T22:23:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzY3MDQ5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQxNzc4Mg==", "url": "https://github.com/ConsenSys/teku/pull/3414#discussion_r544417782", "bodyText": "Not suggesting any different functionality here, just an interface to simplify the dependencies.  So we can pass around 1 value (graffitiProvider) instead of 2 (graffiti and graffitiFile).", "author": "mbaxter", "createdAt": "2020-12-16T16:00:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzY3MDQ5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDU5MjgzMg==", "url": "https://github.com/ConsenSys/teku/pull/3414#discussion_r544592832", "bodyText": "I'm not sure I'm totally following at this point. I'll make some changes and see if that's what you mean.", "author": "EdwardPrentice", "createdAt": "2020-12-16T20:14:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzY3MDQ5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDYwNzE4NQ==", "url": "https://github.com/ConsenSys/teku/pull/3414#discussion_r544607185", "bodyText": "Happy to make a quick patch to show you what I mean as well - let me know if you think that would be helpful", "author": "mbaxter", "createdAt": "2020-12-16T20:39:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzY3MDQ5NQ=="}], "type": "inlineReview", "revised_code": {"commit": "2eb23562f9eab4bfdbf45adb343c26b5b1e76924", "chunk": "diff --git a/validator/api/src/main/java/tech/pegasys/teku/validator/api/ValidatorConfig.java b/validator/api/src/main/java/tech/pegasys/teku/validator/api/ValidatorConfig.java\nindex c2d3915b42..680f36f7d8 100644\n--- a/validator/api/src/main/java/tech/pegasys/teku/validator/api/ValidatorConfig.java\n+++ b/validator/api/src/main/java/tech/pegasys/teku/validator/api/ValidatorConfig.java\n\n@@ -262,13 +254,8 @@ public class ValidatorConfig {\n       return this;\n     }\n \n-    public Builder graffiti(Bytes32 graffiti) {\n-      this.graffiti = graffiti;\n-      return this;\n-    }\n-\n-    public Builder graffitiFile(Path graffitiFile) {\n-      this.graffitiFile = graffitiFile;\n+    public Builder graffitiProvider(GraffitiProvider graffitiProvider) {\n+      this.graffitiProvider = graffitiProvider;\n       return this;\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzY3MjM4Ng==", "url": "https://github.com/ConsenSys/teku/pull/3414#discussion_r543672386", "bodyText": "Looks like this name was accidentally updated?", "author": "mbaxter", "createdAt": "2020-12-15T20:43:02Z", "path": "teku/src/test/java/tech/pegasys/teku/cli/converter/Bytes32ConverterTest.java", "diffHunk": "@@ -20,7 +20,7 @@\n import org.junit.jupiter.api.Test;\n import picocli.CommandLine;\n \n-public class GraffitiConverterTest {\n+public class Bytes32ConverterTest {", "originalCommit": "01f20e1d0ce3c31f3913d6e6e7d95bdeb0edc08c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "394876973e96b0ba65ba3e5abc5ad004ffb60cb8", "chunk": "diff --git a/teku/src/test/java/tech/pegasys/teku/cli/converter/Bytes32ConverterTest.java b/teku/src/test/java/tech/pegasys/teku/cli/converter/GraffitiConverterTest.java\nsimilarity index 97%\nrename from teku/src/test/java/tech/pegasys/teku/cli/converter/Bytes32ConverterTest.java\nrename to teku/src/test/java/tech/pegasys/teku/cli/converter/GraffitiConverterTest.java\nindex f7a6b06605..0e64e7daf9 100644\n--- a/teku/src/test/java/tech/pegasys/teku/cli/converter/Bytes32ConverterTest.java\n+++ b/teku/src/test/java/tech/pegasys/teku/cli/converter/GraffitiConverterTest.java\n\n@@ -20,7 +20,7 @@ import org.apache.tuweni.bytes.Bytes32;\n import org.junit.jupiter.api.Test;\n import picocli.CommandLine;\n \n-public class Bytes32ConverterTest {\n+public class GraffitiConverterTest {\n   private final String data = \"The quick brown fox jumps over the lazy dog\";\n \n   final GraffitiConverter converter = new GraffitiConverter();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzY4MDA0NQ==", "url": "https://github.com/ConsenSys/teku/pull/3414#discussion_r543680045", "bodyText": "Thought I left a comment here, but it seems to have been lost.  We'll have to handle the case where one or both of these values are not provided via the CLI.  I'd suggest making these 2 value Optional.  Then we can load from file if that argument exists, otherwise we can return the default value.", "author": "mbaxter", "createdAt": "2020-12-15T20:55:58Z", "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/Graffiti.java", "diffHunk": "@@ -0,0 +1,58 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.validator.client;\n+\n+import java.nio.file.Path;\n+import java.util.Optional;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.apache.tuweni.bytes.Bytes32;\n+import tech.pegasys.teku.validator.client.loader.graffiti.GraffitiLoader;\n+import tech.pegasys.teku.validator.client.loader.graffiti.GraffitiLoaderException;\n+\n+/**\n+ * A type to hold the current graffiti value. Graffiti can be loaded from 2 places:\n+ *\n+ * <ul>\n+ *   <li>The config file at initialisation\n+ *   <li>The graffiti file which will be regularly checked\n+ * </ul>\n+ *\n+ * In the case that the file cannot be read, the graffiti value will remain unchanged from its\n+ * previous value.\n+ */\n+public class Graffiti {\n+  private static final Logger LOG = LogManager.getLogger();\n+\n+  private Bytes32 graffiti;\n+  private final Path graffitiFile;\n+\n+  public Graffiti(final Bytes32 graffiti, final Path graffitiFile) {\n+    this.graffiti = graffiti;\n+    this.graffitiFile = graffitiFile;", "originalCommit": "000f9fe104efddd24a0e159c49878974a0ac5213", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzcwNTI1NQ==", "url": "https://github.com/ConsenSys/teku/pull/3414#discussion_r543705255", "bodyText": "Agreed. Unless I'm missing something I think that's what the code currently is designed to do.\nThe logic is currently:\nUse the new value in the file if possible else fall back to previous value of graffiti\nIf no value is set the default value will be blank\nSo I'm unsure exactly what to change here?", "author": "EdwardPrentice", "createdAt": "2020-12-15T21:39:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzY4MDA0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQxNTQ1Ng==", "url": "https://github.com/ConsenSys/teku/pull/3414#discussion_r544415456", "bodyText": "The issue is I don't think we're handling null values safely.  In general, we tend to prefer explicit Optional's in the codebase when a value may be missing.  For example, if the graffitiFile is null, I believe we'll currently throw a NullPointerException.   If we have Optional's, we can do something like:\n  private final Optional<Bytes32> defaultGraffiti;\n  private final Optional<Path> graffitiFile;\n\n  public Graffiti(final Optional<Bytes32> defaultGraffiti, final Optional<Path> graffitiFile) {\n    this.defaultGraffiti = defaultGraffiti;\n    this.graffitiFile = graffitiFile;\n  }\n\n  public Optional<Bytes32> getGraffiti() {\n    return graffitiFile.flatMap(this::loadGraffitiFromFile).or(() -> defaultGraffiti);\n  }\n\n  private Optional<Bytes32> loadGraffitiFromFile(final Path path) {\n    try {\n      return Optional.ofNullable(GraffitiParser.loadFromFile(path));\n    } catch (final GraffitiLoaderException e) {\n      LOG.error(\"Loading graffiti from file \" + graffitiFile + \" failed.\", e);\n      return Optional.empty();\n    }\n  }\n\nNote - I have changed the behavior a bit here ^.  Instead of keeping the previous value in graffiti we just have a static default value to use if the file reading fails.  I think this ends up being a little more intuitive and a little safer:\n\nIf I'm supplying both a graffitiFile and a graffiti value, it seems more intuitive that the static value will be treated as a default rather than potentially being used only on the first block proposal if file reading fails.\nIf you're running multiple validators, you can set a default value to an empty Bytes32 to avoid potentially linking 2 different validators.  Say someone has a set up that writes new data to the file every slot so that each validator will broadcast unique graffiti.  If a file read fails, rather than using the previous value, we just use an empty value.  This prevents us from broadcasting the same graffiti for different validators.", "author": "mbaxter", "createdAt": "2020-12-16T15:57:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzY4MDA0NQ=="}], "type": "inlineReview", "revised_code": {"commit": "4248ac57e2a9200bdb5561f113a515bde6e095ca", "chunk": "diff --git a/validator/client/src/main/java/tech/pegasys/teku/validator/client/Graffiti.java b/validator/client/src/main/java/tech/pegasys/teku/validator/client/Graffiti.java\nindex 947b9e1359..2f4f2e8e62 100644\n--- a/validator/client/src/main/java/tech/pegasys/teku/validator/client/Graffiti.java\n+++ b/validator/client/src/main/java/tech/pegasys/teku/validator/client/Graffiti.java\n\n@@ -18,8 +18,8 @@ import java.util.Optional;\n import org.apache.logging.log4j.LogManager;\n import org.apache.logging.log4j.Logger;\n import org.apache.tuweni.bytes.Bytes32;\n-import tech.pegasys.teku.validator.client.loader.graffiti.GraffitiLoader;\n import tech.pegasys.teku.validator.client.loader.graffiti.GraffitiLoaderException;\n+import tech.pegasys.teku.validator.client.loader.graffiti.GraffitiParser;\n \n /**\n  * A type to hold the current graffiti value. Graffiti can be loaded from 2 places:\n"}}, {"oid": "394876973e96b0ba65ba3e5abc5ad004ffb60cb8", "url": "https://github.com/ConsenSys/teku/commit/394876973e96b0ba65ba3e5abc5ad004ffb60cb8", "message": "[Issue-3373] Implement a Graffiti class and a file loader in order to\nread graffiti from a file without restarting the validator", "committedDate": "2020-12-15T21:58:35Z", "type": "forcePushed"}, {"oid": "ec6491f0e9428f0abca78a4f43b54609d1d2cfe8", "url": "https://github.com/ConsenSys/teku/commit/ec6491f0e9428f0abca78a4f43b54609d1d2cfe8", "message": "[Issue-3373] Implement a Graffiti class and a file loader in order to\nread graffiti from a file without restarting the validator", "committedDate": "2020-12-15T22:00:26Z", "type": "forcePushed"}, {"oid": "4248ac57e2a9200bdb5561f113a515bde6e095ca", "url": "https://github.com/ConsenSys/teku/commit/4248ac57e2a9200bdb5561f113a515bde6e095ca", "message": "[Issue-3373] Implement a Graffiti class and a file loader in order to\nread graffiti from a file without restarting the validator", "committedDate": "2020-12-15T22:06:08Z", "type": "forcePushed"}, {"oid": "c8eea55be00a7b89f3f383b707666e1c4d61fcd1", "url": "https://github.com/ConsenSys/teku/commit/c8eea55be00a7b89f3f383b707666e1c4d61fcd1", "message": "[Issue-3373] Implement a Graffiti class and a file loader in order to\nread graffiti from a file without restarting the validator", "committedDate": "2020-12-15T22:25:12Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQxOTM4MA==", "url": "https://github.com/ConsenSys/teku/pull/3414#discussion_r544419380", "bodyText": "We're not currently using this setter.  This will need to be hooked up in ValidatorOptions.", "author": "mbaxter", "createdAt": "2020-12-16T16:02:21Z", "path": "validator/api/src/main/java/tech/pegasys/teku/validator/api/ValidatorConfig.java", "diffHunk": "@@ -143,6 +146,10 @@ public Bytes32 getGraffiti() {\n     return graffiti;\n   }\n \n+  public Path getGraffitiFile() {", "originalCommit": "c8eea55be00a7b89f3f383b707666e1c4d61fcd1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2eb23562f9eab4bfdbf45adb343c26b5b1e76924", "chunk": "diff --git a/validator/api/src/main/java/tech/pegasys/teku/validator/api/ValidatorConfig.java b/validator/api/src/main/java/tech/pegasys/teku/validator/api/ValidatorConfig.java\nindex c2d3915b42..680f36f7d8 100644\n--- a/validator/api/src/main/java/tech/pegasys/teku/validator/api/ValidatorConfig.java\n+++ b/validator/api/src/main/java/tech/pegasys/teku/validator/api/ValidatorConfig.java\n\n@@ -142,12 +139,8 @@ public class ValidatorConfig {\n     return beaconNodeApiEndpoint;\n   }\n \n-  public Bytes32 getGraffiti() {\n-    return graffiti;\n-  }\n-\n-  public Path getGraffitiFile() {\n-    return graffitiFile;\n+  public GraffitiProvider getGraffitiProvider() {\n+    return graffitiProvider;\n   }\n \n   public List<String> getValidatorKeys() {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQyMTU5OQ==", "url": "https://github.com/ConsenSys/teku/pull/3414#discussion_r544421599", "bodyText": "We really don't want to throw when we're trying to propose a block, so we should probably go ahead and add a general catch block as well:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                } catch (final GraffitiLoaderException e) {\n          \n          \n            \n                  LOG.error(\"Loading graffiti from file \" + graffitiFile + \" failed.\", e);\n          \n          \n            \n                }\n          \n          \n            \n                } catch (final GraffitiLoaderException e) {\n          \n          \n            \n                  LOG.error(\"Loading graffiti from file \" + graffitiFile + \" failed.\", e);\n          \n          \n            \n                } catch (final Exception e) {\n          \n          \n            \n                  LOG.error(\"Encountered unexpected exception while loading graffiti from file \" + graffitiFile, e);\n          \n          \n            \n                }", "author": "mbaxter", "createdAt": "2020-12-16T16:05:13Z", "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/Graffiti.java", "diffHunk": "@@ -0,0 +1,58 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.validator.client;\n+\n+import java.nio.file.Path;\n+import java.util.Optional;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.apache.tuweni.bytes.Bytes32;\n+import tech.pegasys.teku.validator.client.loader.graffiti.GraffitiLoaderException;\n+import tech.pegasys.teku.validator.client.loader.graffiti.GraffitiParser;\n+\n+/**\n+ * A type to hold the current graffiti value. Graffiti can be loaded from 2 places:\n+ *\n+ * <ul>\n+ *   <li>The config file at initialisation\n+ *   <li>The graffiti file which will be regularly checked\n+ * </ul>\n+ *\n+ * In the case that the file cannot be read, the graffiti value will remain unchanged from its\n+ * previous value.\n+ */\n+public class Graffiti {\n+  private static final Logger LOG = LogManager.getLogger();\n+\n+  private Bytes32 graffiti;\n+  private final Path graffitiFile;\n+\n+  public Graffiti(final Bytes32 graffiti, final Path graffitiFile) {\n+    this.graffiti = graffiti;\n+    this.graffitiFile = graffitiFile;\n+  }\n+\n+  public Optional<Bytes32> getGraffiti() {\n+    reloadGraffitiFromFile(graffitiFile);\n+    return Optional.of(graffiti);\n+  }\n+\n+  private void reloadGraffitiFromFile(final Path path) {\n+    try {\n+      this.graffiti = GraffitiParser.loadFromFile(path);\n+    } catch (final GraffitiLoaderException e) {\n+      LOG.error(\"Loading graffiti from file \" + graffitiFile + \" failed.\", e);\n+    }", "originalCommit": "c8eea55be00a7b89f3f383b707666e1c4d61fcd1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2eb23562f9eab4bfdbf45adb343c26b5b1e76924", "chunk": "diff --git a/validator/client/src/main/java/tech/pegasys/teku/validator/client/Graffiti.java b/validator/api/src/main/java/tech/pegasys/teku/validator/api/FileBackedGraffitiProvider.java\nsimilarity index 62%\nrename from validator/client/src/main/java/tech/pegasys/teku/validator/client/Graffiti.java\nrename to validator/api/src/main/java/tech/pegasys/teku/validator/api/FileBackedGraffitiProvider.java\nindex 2f4f2e8e62..1052098e72 100644\n--- a/validator/client/src/main/java/tech/pegasys/teku/validator/client/Graffiti.java\n+++ b/validator/api/src/main/java/tech/pegasys/teku/validator/api/FileBackedGraffitiProvider.java\n\n@@ -11,15 +11,13 @@\n  * specific language governing permissions and limitations under the License.\n  */\n \n-package tech.pegasys.teku.validator.client;\n+package tech.pegasys.teku.validator.api;\n \n import java.nio.file.Path;\n import java.util.Optional;\n import org.apache.logging.log4j.LogManager;\n import org.apache.logging.log4j.Logger;\n import org.apache.tuweni.bytes.Bytes32;\n-import tech.pegasys.teku.validator.client.loader.graffiti.GraffitiLoaderException;\n-import tech.pegasys.teku.validator.client.loader.graffiti.GraffitiParser;\n \n /**\n  * A type to hold the current graffiti value. Graffiti can be loaded from 2 places:\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQyNDM1MQ==", "url": "https://github.com/ConsenSys/teku/pull/3414#discussion_r544424351", "bodyText": "Let's add some tests for this class.  A few cases I can think of:\n\ngraffiti and graffitiFile are empty / null\ngraffiti is empty / null\ngraffitiFile is empty / null\ngraffitiFile is set, but the actual file doesn't exist\nread from file successfully, remove file from disk, read again", "author": "mbaxter", "createdAt": "2020-12-16T16:08:34Z", "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/Graffiti.java", "diffHunk": "@@ -0,0 +1,58 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.validator.client;\n+\n+import java.nio.file.Path;\n+import java.util.Optional;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.apache.tuweni.bytes.Bytes32;\n+import tech.pegasys.teku.validator.client.loader.graffiti.GraffitiLoaderException;\n+import tech.pegasys.teku.validator.client.loader.graffiti.GraffitiParser;\n+\n+/**\n+ * A type to hold the current graffiti value. Graffiti can be loaded from 2 places:\n+ *\n+ * <ul>\n+ *   <li>The config file at initialisation\n+ *   <li>The graffiti file which will be regularly checked\n+ * </ul>\n+ *\n+ * In the case that the file cannot be read, the graffiti value will remain unchanged from its\n+ * previous value.\n+ */\n+public class Graffiti {", "originalCommit": "c8eea55be00a7b89f3f383b707666e1c4d61fcd1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDYxOTI0OA==", "url": "https://github.com/ConsenSys/teku/pull/3414#discussion_r544619248", "bodyText": "Will come back to this once we're settled on the structure. Totally agree.", "author": "EdwardPrentice", "createdAt": "2020-12-16T20:59:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQyNDM1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODA5NzM1OA==", "url": "https://github.com/ConsenSys/teku/pull/3414#discussion_r548097358", "bodyText": "Done", "author": "EdwardPrentice", "createdAt": "2020-12-23T18:02:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQyNDM1MQ=="}], "type": "inlineReview", "revised_code": {"commit": "2eb23562f9eab4bfdbf45adb343c26b5b1e76924", "chunk": "diff --git a/validator/client/src/main/java/tech/pegasys/teku/validator/client/Graffiti.java b/validator/api/src/main/java/tech/pegasys/teku/validator/api/FileBackedGraffitiProvider.java\nsimilarity index 62%\nrename from validator/client/src/main/java/tech/pegasys/teku/validator/client/Graffiti.java\nrename to validator/api/src/main/java/tech/pegasys/teku/validator/api/FileBackedGraffitiProvider.java\nindex 2f4f2e8e62..1052098e72 100644\n--- a/validator/client/src/main/java/tech/pegasys/teku/validator/client/Graffiti.java\n+++ b/validator/api/src/main/java/tech/pegasys/teku/validator/api/FileBackedGraffitiProvider.java\n\n@@ -11,15 +11,13 @@\n  * specific language governing permissions and limitations under the License.\n  */\n \n-package tech.pegasys.teku.validator.client;\n+package tech.pegasys.teku.validator.api;\n \n import java.nio.file.Path;\n import java.util.Optional;\n import org.apache.logging.log4j.LogManager;\n import org.apache.logging.log4j.Logger;\n import org.apache.tuweni.bytes.Bytes32;\n-import tech.pegasys.teku.validator.client.loader.graffiti.GraffitiLoaderException;\n-import tech.pegasys.teku.validator.client.loader.graffiti.GraffitiParser;\n \n /**\n  * A type to hold the current graffiti value. Graffiti can be loaded from 2 places:\n"}}, {"oid": "2eb23562f9eab4bfdbf45adb343c26b5b1e76924", "url": "https://github.com/ConsenSys/teku/commit/2eb23562f9eab4bfdbf45adb343c26b5b1e76924", "message": "Implemented all comments", "committedDate": "2020-12-16T20:55:20Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTk1NDM4Ng==", "url": "https://github.com/ConsenSys/teku/pull/3414#discussion_r545954386", "bodyText": "(nit) I think we can use your String -> Bytes32 helper directly here:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  return Bytes32Parser.toBytes32(input);\n          \n          \n            \n                  return Bytes32Parser.toBytes32(value);", "author": "mbaxter", "createdAt": "2020-12-18T16:43:33Z", "path": "teku/src/main/java/tech/pegasys/teku/cli/converter/GraffitiConverter.java", "diffHunk": "@@ -16,22 +16,21 @@\n import java.nio.charset.StandardCharsets;\n import org.apache.tuweni.bytes.Bytes32;\n import picocli.CommandLine;\n+import tech.pegasys.teku.validator.api.Bytes32Parser;\n \n public class GraffitiConverter implements CommandLine.ITypeConverter<Bytes32> {\n   @Override\n   public Bytes32 convert(final String value) {\n     byte[] input = value.getBytes(StandardCharsets.UTF_8);\n-    if (input.length > 32) {\n+    try {\n+      return Bytes32Parser.toBytes32(input);", "originalCommit": "2eb23562f9eab4bfdbf45adb343c26b5b1e76924", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ff7cb8bf9e5730766aebadbd9aa7be90a0203937", "chunk": "diff --git a/teku/src/main/java/tech/pegasys/teku/cli/converter/GraffitiConverter.java b/teku/src/main/java/tech/pegasys/teku/cli/converter/GraffitiConverter.java\nindex f76b1246cf..543346b7ab 100644\n--- a/teku/src/main/java/tech/pegasys/teku/cli/converter/GraffitiConverter.java\n+++ b/teku/src/main/java/tech/pegasys/teku/cli/converter/GraffitiConverter.java\n\n@@ -21,15 +21,14 @@ import tech.pegasys.teku.validator.api.Bytes32Parser;\n public class GraffitiConverter implements CommandLine.ITypeConverter<Bytes32> {\n   @Override\n   public Bytes32 convert(final String value) {\n-    byte[] input = value.getBytes(StandardCharsets.UTF_8);\n     try {\n-      return Bytes32Parser.toBytes32(input);\n+      return Bytes32Parser.toBytes32(value);\n     } catch (final IllegalArgumentException e) {\n       throw (new CommandLine.TypeConversionException(\n           \"'\"\n               + value\n               + \"' converts to \"\n-              + input.length\n+              + value.length()\n               + \" bytes. A maximum of 32 bytes can be used as graffiti.\"));\n     }\n   }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTk1NTgyOA==", "url": "https://github.com/ConsenSys/teku/pull/3414#discussion_r545955828", "bodyText": "(nit)\nI'd revert to the original code here as it's a bit more efficient:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                return Bytes32.wrap(Bytes32.rightPad(Bytes.wrap(input)));\n          \n          \n            \n                byte[] bytes = new byte[32];\n          \n          \n            \n                System.arraycopy(input, 0, bytes, 0, input.length);\n          \n          \n            \n                return Bytes32.wrap(bytes);", "author": "mbaxter", "createdAt": "2020-12-18T16:45:53Z", "path": "validator/api/src/main/java/tech/pegasys/teku/validator/api/Bytes32Parser.java", "diffHunk": "@@ -0,0 +1,38 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.validator.api;\n+\n+import static java.nio.charset.StandardCharsets.UTF_8;\n+\n+import org.apache.tuweni.bytes.Bytes;\n+import org.apache.tuweni.bytes.Bytes32;\n+\n+public class Bytes32Parser {\n+\n+  public static Bytes32 toBytes32(final String input) {\n+    return toBytes32(input.getBytes(UTF_8));\n+  }\n+\n+  public static Bytes32 toBytes32(final byte[] input) {\n+    if (input.length > 32) {\n+      throw new IllegalArgumentException(\n+          \"'\"\n+              + new String(input, UTF_8)\n+              + \"' converts to \"\n+              + input.length\n+              + \" bytes. Input must be 32 bytes or less.\");\n+    }\n+    return Bytes32.wrap(Bytes32.rightPad(Bytes.wrap(input)));", "originalCommit": "2eb23562f9eab4bfdbf45adb343c26b5b1e76924", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ff7cb8bf9e5730766aebadbd9aa7be90a0203937", "chunk": "diff --git a/validator/api/src/main/java/tech/pegasys/teku/validator/api/Bytes32Parser.java b/validator/api/src/main/java/tech/pegasys/teku/validator/api/Bytes32Parser.java\nindex 17e0f0d122..64a0393719 100644\n--- a/validator/api/src/main/java/tech/pegasys/teku/validator/api/Bytes32Parser.java\n+++ b/validator/api/src/main/java/tech/pegasys/teku/validator/api/Bytes32Parser.java\n\n@@ -33,6 +33,8 @@ public class Bytes32Parser {\n               + input.length\n               + \" bytes. Input must be 32 bytes or less.\");\n     }\n-    return Bytes32.wrap(Bytes32.rightPad(Bytes.wrap(input)));\n+    byte[] bytes = new byte[32];\n+    System.arraycopy(input, 0, bytes, 0, input.length);\n+    return Bytes32.wrap(bytes);\n   }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTk1OTM4MQ==", "url": "https://github.com/ConsenSys/teku/pull/3414#discussion_r545959381", "bodyText": "This reproduces the current behavior (users can optionally supply a static graffiti value).  If you want to make the new file-based option available, we'll need to add another instance variable to ValidatorOptions that accepts the graffiti file path.  For a similar example, see the --data-path annotations here.\nThen this can become:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            .graffitiProvider(() -> Optional.of(graffiti)));\n          \n          \n            \n                            .graffitiProvider(new FileBackedGraffitiProvider(Optional.ofNullable(graffiti), Optional.ofNullable(graffitiFile)));", "author": "mbaxter", "createdAt": "2020-12-18T16:51:44Z", "path": "teku/src/main/java/tech/pegasys/teku/cli/options/ValidatorOptions.java", "diffHunk": "@@ -82,7 +85,7 @@ public void configure(TekuConfiguration.Builder builder) {\n                 .validatorPerformanceTrackingMode(validatorPerformanceTrackingMode)\n                 .validatorExternalSignerSlashingProtectionEnabled(\n                     validatorExternalSignerSlashingProtectionEnabled)\n-                .graffiti(graffiti));\n+                .graffitiProvider(() -> Optional.of(graffiti)));", "originalCommit": "2eb23562f9eab4bfdbf45adb343c26b5b1e76924", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ff7cb8bf9e5730766aebadbd9aa7be90a0203937", "chunk": "diff --git a/teku/src/main/java/tech/pegasys/teku/cli/options/ValidatorOptions.java b/teku/src/main/java/tech/pegasys/teku/cli/options/ValidatorOptions.java\nindex 7a6d367e5d..53aea31efd 100644\n--- a/teku/src/main/java/tech/pegasys/teku/cli/options/ValidatorOptions.java\n+++ b/teku/src/main/java/tech/pegasys/teku/cli/options/ValidatorOptions.java\n\n@@ -85,7 +95,7 @@ public class ValidatorOptions {\n                 .validatorPerformanceTrackingMode(validatorPerformanceTrackingMode)\n                 .validatorExternalSignerSlashingProtectionEnabled(\n                     validatorExternalSignerSlashingProtectionEnabled)\n-                .graffitiProvider(() -> Optional.of(graffiti)));\n+                .graffitiProvider(new FileBackedGraffitiProvider(Optional.ofNullable(graffiti), Optional.ofNullable(graffitiFile))));\n     validatorKeysOptions.configure(builder);\n   }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTk2MjA0Nw==", "url": "https://github.com/ConsenSys/teku/pull/3414#discussion_r545962047", "bodyText": "(nit) This package shouldn't care about details around config files and CLI arguments - those are higher-level concerns that might change\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             *   <li>The config file at initialisation\n          \n          \n            \n             *   <li>The default value supplied at initialisation", "author": "mbaxter", "createdAt": "2020-12-18T16:56:21Z", "path": "validator/api/src/main/java/tech/pegasys/teku/validator/api/FileBackedGraffitiProvider.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.validator.api;\n+\n+import java.nio.file.Path;\n+import java.util.Optional;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.apache.tuweni.bytes.Bytes32;\n+\n+/**\n+ * A type to hold the current graffiti value. Graffiti can be loaded from 2 places:\n+ *\n+ * <ul>\n+ *   <li>The config file at initialisation", "originalCommit": "2eb23562f9eab4bfdbf45adb343c26b5b1e76924", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ff7cb8bf9e5730766aebadbd9aa7be90a0203937", "chunk": "diff --git a/validator/api/src/main/java/tech/pegasys/teku/validator/api/FileBackedGraffitiProvider.java b/validator/api/src/main/java/tech/pegasys/teku/validator/api/FileBackedGraffitiProvider.java\nindex 1052098e72..41e3e8d3ba 100644\n--- a/validator/api/src/main/java/tech/pegasys/teku/validator/api/FileBackedGraffitiProvider.java\n+++ b/validator/api/src/main/java/tech/pegasys/teku/validator/api/FileBackedGraffitiProvider.java\n\n@@ -23,7 +23,7 @@ import org.apache.tuweni.bytes.Bytes32;\n  * A type to hold the current graffiti value. Graffiti can be loaded from 2 places:\n  *\n  * <ul>\n- *   <li>The config file at initialisation\n+ *   <li>The default value supplied at initialisation\n  *   <li>The graffiti file which will be regularly checked\n  * </ul>\n  *\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTk2NDAwOQ==", "url": "https://github.com/ConsenSys/teku/pull/3414#discussion_r545964009", "bodyText": "(nit) For these tests, I'd just use a simple lambda to return the empty value\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  new Validator(VALIDATOR1_KEY, validator1Signer, new FileBackedGraffitiProvider(Optional.empty(), Optional.empty()));\n          \n          \n            \n                  new Validator(VALIDATOR1_KEY, validator1Signer, () -> Optional.empty());", "author": "mbaxter", "createdAt": "2020-12-18T16:59:35Z", "path": "validator/client/src/test/java/tech/pegasys/teku/validator/client/AbstractDutySchedulerTest.java", "diffHunk": "@@ -44,8 +45,10 @@\n   final ValidatorIndexProvider validatorIndexProvider = mock(ValidatorIndexProvider.class);\n   final Signer validator1Signer = mock(Signer.class);\n   final Signer validator2Signer = mock(Signer.class);\n-  final Validator validator1 = new Validator(VALIDATOR1_KEY, validator1Signer, Optional.empty());\n-  final Validator validator2 = new Validator(VALIDATOR2_KEY, validator2Signer, Optional.empty());\n+  final Validator validator1 =\n+      new Validator(VALIDATOR1_KEY, validator1Signer, new FileBackedGraffitiProvider(Optional.empty(), Optional.empty()));", "originalCommit": "2eb23562f9eab4bfdbf45adb343c26b5b1e76924", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ff7cb8bf9e5730766aebadbd9aa7be90a0203937", "chunk": "diff --git a/validator/client/src/test/java/tech/pegasys/teku/validator/client/AbstractDutySchedulerTest.java b/validator/client/src/test/java/tech/pegasys/teku/validator/client/AbstractDutySchedulerTest.java\nindex 5493bb7e2d..209c9398ce 100644\n--- a/validator/client/src/test/java/tech/pegasys/teku/validator/client/AbstractDutySchedulerTest.java\n+++ b/validator/client/src/test/java/tech/pegasys/teku/validator/client/AbstractDutySchedulerTest.java\n\n@@ -45,10 +45,8 @@ public abstract class AbstractDutySchedulerTest {\n   final ValidatorIndexProvider validatorIndexProvider = mock(ValidatorIndexProvider.class);\n   final Signer validator1Signer = mock(Signer.class);\n   final Signer validator2Signer = mock(Signer.class);\n-  final Validator validator1 =\n-      new Validator(VALIDATOR1_KEY, validator1Signer, new FileBackedGraffitiProvider(Optional.empty(), Optional.empty()));\n-  final Validator validator2 =\n-      new Validator(VALIDATOR2_KEY, validator2Signer, new FileBackedGraffitiProvider(Optional.empty(), Optional.empty()));\n+  final Validator validator1 = new Validator(VALIDATOR1_KEY, validator1Signer, Optional::empty);\n+  final Validator validator2 = new Validator(VALIDATOR2_KEY, validator2Signer, Optional::empty);\n \n   final ValidatorApiChannel validatorApiChannel = mock(ValidatorApiChannel.class);\n   final ValidatorDutyFactory dutyFactory = mock(ValidatorDutyFactory.class);\n"}}, {"oid": "0bf9a7d9a10bf825124a726fc1f99c6da3db7b03", "url": "https://github.com/ConsenSys/teku/commit/0bf9a7d9a10bf825124a726fc1f99c6da3db7b03", "message": "Implemented all comments", "committedDate": "2020-12-21T17:18:49Z", "type": "forcePushed"}, {"oid": "ff7cb8bf9e5730766aebadbd9aa7be90a0203937", "url": "https://github.com/ConsenSys/teku/commit/ff7cb8bf9e5730766aebadbd9aa7be90a0203937", "message": "WIP nearly there...", "committedDate": "2020-12-21T22:38:18Z", "type": "forcePushed"}, {"oid": "f3016ad9c3d5104bcc9f0573540908f8011776bb", "url": "https://github.com/ConsenSys/teku/commit/f3016ad9c3d5104bcc9f0573540908f8011776bb", "message": "[Issue-3373] Implement a Graffiti class and a file loader in order to\nread graffiti from a file without restarting the validator", "committedDate": "2020-12-23T18:03:38Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODA1MTY5MQ==", "url": "https://github.com/ConsenSys/teku/pull/3414#discussion_r548051691", "bodyText": "(nit) Might be worth noting here that if the file read fails, we'll fall back to the --graffiti value if supplied:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                      \"File to load graffiti value to include during block creation. Value gets converted to bytes and padded to Bytes32).\",\n          \n          \n            \n                      \"File to load graffiti value to include during block creation. Value gets converted to bytes and padded to Bytes32).  If file reading fails during block creation, teku will fall back to any value supplied via --graffiti.\",", "author": "mbaxter", "createdAt": "2020-12-23T16:53:55Z", "path": "teku/src/main/java/tech/pegasys/teku/cli/options/ValidatorOptions.java", "diffHunk": "@@ -30,10 +35,18 @@\n       converter = GraffitiConverter.class,\n       paramLabel = \"<GRAFFITI STRING>\",\n       description =\n-          \"Graffiti to include during block creation (gets converted to bytes and padded to Bytes32).\",\n+          \"Graffiti value to include during block creation. Value gets converted to bytes and padded to Bytes32).\",\n       arity = \"1\")\n   private Bytes32 graffiti;\n \n+  @Option(\n+      names = {\"--validators-graffiti-file\"},\n+      paramLabel = \"<GRAFFITI FILE>\",\n+      description =\n+          \"File to load graffiti value to include during block creation. Value gets converted to bytes and padded to Bytes32).\",", "originalCommit": "ff7cb8bf9e5730766aebadbd9aa7be90a0203937", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "db4ab6e25dfbcbc484d371260a967dc863b69757", "chunk": "diff --git a/teku/src/main/java/tech/pegasys/teku/cli/options/ValidatorOptions.java b/teku/src/main/java/tech/pegasys/teku/cli/options/ValidatorOptions.java\nindex 53aea31efd..9e5f1ad3fe 100644\n--- a/teku/src/main/java/tech/pegasys/teku/cli/options/ValidatorOptions.java\n+++ b/teku/src/main/java/tech/pegasys/teku/cli/options/ValidatorOptions.java\n\n@@ -43,7 +41,7 @@ public class ValidatorOptions {\n       names = {\"--validators-graffiti-file\"},\n       paramLabel = \"<GRAFFITI FILE>\",\n       description =\n-          \"File to load graffiti value to include during block creation. Value gets converted to bytes and padded to Bytes32).\",\n+          \"File to load graffiti value to include during block creation. Value gets converted to bytes and padded to Bytes32).  If file reading fails during block creation, teku will fall back to any value supplied via --graffiti.\",\n       arity = \"1\")\n   private Path graffitiFile;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODA1MzQ1Ng==", "url": "https://github.com/ConsenSys/teku/pull/3414#discussion_r548053456", "bodyText": "Since we no longer know how many bytes are contained in the string here, I'd simplify the error message to something like: \"'\" + value + \"' contains too many bytes.  A maximum of 32 bytes can be used as graffiti.\"", "author": "mbaxter", "createdAt": "2020-12-23T16:58:05Z", "path": "teku/src/main/java/tech/pegasys/teku/cli/converter/GraffitiConverter.java", "diffHunk": "@@ -16,22 +16,20 @@\n import java.nio.charset.StandardCharsets;\n import org.apache.tuweni.bytes.Bytes32;\n import picocli.CommandLine;\n+import tech.pegasys.teku.validator.api.Bytes32Parser;\n \n public class GraffitiConverter implements CommandLine.ITypeConverter<Bytes32> {\n   @Override\n   public Bytes32 convert(final String value) {\n-    byte[] input = value.getBytes(StandardCharsets.UTF_8);\n-    if (input.length > 32) {\n+    try {\n+      return Bytes32Parser.toBytes32(value);\n+    } catch (final IllegalArgumentException e) {\n       throw (new CommandLine.TypeConversionException(\n           \"'\"\n               + value\n               + \"' converts to \"\n-              + input.length\n+              + value.length()\n               + \" bytes. A maximum of 32 bytes can be used as graffiti.\"));", "originalCommit": "ff7cb8bf9e5730766aebadbd9aa7be90a0203937", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f3016ad9c3d5104bcc9f0573540908f8011776bb", "chunk": "diff --git a/teku/src/main/java/tech/pegasys/teku/cli/converter/GraffitiConverter.java b/teku/src/main/java/tech/pegasys/teku/cli/converter/GraffitiConverter.java\nindex 543346b7ab..a1271b6f07 100644\n--- a/teku/src/main/java/tech/pegasys/teku/cli/converter/GraffitiConverter.java\n+++ b/teku/src/main/java/tech/pegasys/teku/cli/converter/GraffitiConverter.java\n\n@@ -13,7 +13,6 @@\n \n package tech.pegasys.teku.cli.converter;\n \n-import java.nio.charset.StandardCharsets;\n import org.apache.tuweni.bytes.Bytes32;\n import picocli.CommandLine;\n import tech.pegasys.teku.validator.api.Bytes32Parser;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODE3ODA5Nw==", "url": "https://github.com/ConsenSys/teku/pull/3414#discussion_r548178097", "bodyText": "If we want to use the default value on failure, this should be:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                return graffitiFile.map(this::loadGraffitiFromFile).orElse(defaultGraffiti);\n          \n          \n            \n                return graffitiFile.flatMap(this::loadGraffitiFromFile).or(() -> defaultGraffiti);", "author": "mbaxter", "createdAt": "2020-12-23T19:45:48Z", "path": "validator/api/src/main/java/tech/pegasys/teku/validator/api/FileBackedGraffitiProvider.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.validator.api;\n+\n+import java.nio.file.Path;\n+import java.util.Optional;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.apache.tuweni.bytes.Bytes32;\n+\n+/**\n+ * A type to hold the current graffiti value. Graffiti can be loaded from 2 places:\n+ *\n+ * <ul>\n+ *   <li>The default value supplied at initialisation\n+ *   <li>The graffiti file which will be regularly checked\n+ * </ul>\n+ *\n+ * In the case that the file cannot be read, the default graffiti value will be used.\n+ */\n+public class FileBackedGraffitiProvider implements GraffitiProvider {\n+  private static final Logger LOG = LogManager.getLogger();\n+\n+  private final Optional<Bytes32> defaultGraffiti;\n+  private final Optional<Path> graffitiFile;\n+\n+  public FileBackedGraffitiProvider(\n+      final Optional<Bytes32> defaultGraffiti, final Optional<Path> graffitiFile) {\n+    this.defaultGraffiti = defaultGraffiti;\n+    this.graffitiFile = graffitiFile;\n+  }\n+\n+  @Override\n+  public Optional<Bytes32> get() {\n+    return graffitiFile.map(this::loadGraffitiFromFile).orElse(defaultGraffiti);", "originalCommit": "f3016ad9c3d5104bcc9f0573540908f8011776bb", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "db4ab6e25dfbcbc484d371260a967dc863b69757", "chunk": "diff --git a/validator/api/src/main/java/tech/pegasys/teku/validator/api/FileBackedGraffitiProvider.java b/validator/api/src/main/java/tech/pegasys/teku/validator/api/FileBackedGraffitiProvider.java\nindex 7ef9f3b578..27673e8511 100644\n--- a/validator/api/src/main/java/tech/pegasys/teku/validator/api/FileBackedGraffitiProvider.java\n+++ b/validator/api/src/main/java/tech/pegasys/teku/validator/api/FileBackedGraffitiProvider.java\n\n@@ -43,7 +43,7 @@ public class FileBackedGraffitiProvider implements GraffitiProvider {\n \n   @Override\n   public Optional<Bytes32> get() {\n-    return graffitiFile.map(this::loadGraffitiFromFile).orElse(defaultGraffiti);\n+    return graffitiFile.flatMap(this::loadGraffitiFromFile).or(() -> defaultGraffiti);\n   }\n \n   private Optional<Bytes32> loadGraffitiFromFile(final Path path) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODE3ODY2MQ==", "url": "https://github.com/ConsenSys/teku/pull/3414#discussion_r548178661", "bodyText": "I believe this should be:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                assertThat(graffitiProvider.get()).isEqualTo(Optional.empty());\n          \n          \n            \n                assertThat(graffitiProvider.get()).isEqualTo(Optional.of(graffiti));", "author": "mbaxter", "createdAt": "2020-12-23T19:46:24Z", "path": "validator/api/src/test/java/tech/pegasys/teku/validator/api/FileBackedGraffitiProviderTest.java", "diffHunk": "@@ -0,0 +1,62 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.validator.api;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import java.nio.file.Path;\n+import java.util.Optional;\n+import org.apache.tuweni.bytes.Bytes32;\n+import org.junit.jupiter.api.Test;\n+\n+public class FileBackedGraffitiProviderTest {\n+  private static final Bytes32 graffiti = Bytes32Parser.toBytes32(\"myGraffiti\");\n+  private static final Bytes32 graffitiFromSampleFile = Bytes32Parser.toBytes32(\"123456789\");\n+\n+  @Test\n+  public void testBothEmpty() {\n+    var graffitiProvider = new FileBackedGraffitiProvider(Optional.empty(), Optional.empty());\n+    assertThat(graffitiProvider.get()).isNotPresent();\n+  }\n+\n+  @Test\n+  public void testGraffitiWithoutFile() {\n+    var graffitiProvider = new FileBackedGraffitiProvider(Optional.of(graffiti), Optional.empty());\n+    assertThat(graffitiProvider.get()).isEqualTo(Optional.of(graffiti));\n+  }\n+\n+  @Test\n+  public void testEmptyGraffitiWithFile() {\n+    var graffitiProvider =\n+        new FileBackedGraffitiProvider(\n+            Optional.empty(), Optional.of(Path.of(\"src/test/resources/graffitiSample.txt\")));\n+    assertThat(graffitiProvider.get()).isEqualTo(Optional.of(graffitiFromSampleFile));\n+  }\n+\n+  @Test\n+  public void testGraffitiWithFile() {\n+    var graffitiProvider =\n+        new FileBackedGraffitiProvider(\n+            Optional.of(graffiti), Optional.of(Path.of(\"src/test/resources/graffitiSample.txt\")));\n+    assertThat(graffitiProvider.get()).isEqualTo(Optional.of(graffitiFromSampleFile));\n+  }\n+\n+  @Test\n+  public void testFileDoesntExist() {\n+    var graffitiProvider =\n+        new FileBackedGraffitiProvider(\n+            Optional.of(graffiti), Optional.of(Path.of(\"src/test/resources/noGraffitiFound.txt\")));\n+    assertThat(graffitiProvider.get()).isEqualTo(Optional.empty());", "originalCommit": "f3016ad9c3d5104bcc9f0573540908f8011776bb", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "db4ab6e25dfbcbc484d371260a967dc863b69757", "chunk": "diff --git a/validator/api/src/test/java/tech/pegasys/teku/validator/api/FileBackedGraffitiProviderTest.java b/validator/api/src/test/java/tech/pegasys/teku/validator/api/FileBackedGraffitiProviderTest.java\nindex a1d9d856e1..549acf92d6 100644\n--- a/validator/api/src/test/java/tech/pegasys/teku/validator/api/FileBackedGraffitiProviderTest.java\n+++ b/validator/api/src/test/java/tech/pegasys/teku/validator/api/FileBackedGraffitiProviderTest.java\n\n@@ -53,10 +53,10 @@ public class FileBackedGraffitiProviderTest {\n   }\n \n   @Test\n-  public void testFileDoesntExist() {\n+  public void testDefaultGraffitiIsUsedIfFileReadFails() {\n     var graffitiProvider =\n         new FileBackedGraffitiProvider(\n             Optional.of(graffiti), Optional.of(Path.of(\"src/test/resources/noGraffitiFound.txt\")));\n-    assertThat(graffitiProvider.get()).isEqualTo(Optional.empty());\n+    assertThat(graffitiProvider.get()).isEqualTo(Optional.of(graffiti));\n   }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTMzMjgyNg==", "url": "https://github.com/ConsenSys/teku/pull/3414#discussion_r549332826", "bodyText": "InputStream (and the underlying file descriptor) is not closed after calling readNBytes. This would cause Validator.getGraffiti() to repeatedly open the graffiti file when producing a block. Of course, during finalization the FD would be closed, but I'd assume it's better practice to explicitely close it.", "author": "systemfreund", "createdAt": "2020-12-28T12:36:51Z", "path": "validator/api/src/main/java/tech/pegasys/teku/validator/api/GraffitiParser.java", "diffHunk": "@@ -0,0 +1,44 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.validator.api;\n+\n+import static com.google.common.base.Preconditions.checkNotNull;\n+\n+import java.io.FileNotFoundException;\n+import java.io.IOException;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import org.apache.tuweni.bytes.Bytes32;\n+\n+public class GraffitiParser {\n+  public static Bytes32 loadFromFile(final Path graffitiFile) throws GraffitiLoaderException {\n+    try {\n+      checkNotNull(graffitiFile, \"GraffitiFile path cannot be null\");\n+      if (Files.size(graffitiFile) > 32) {\n+        throw new GraffitiLoaderException(\"GraffitiFile size too big, maximum size is 32 bytes\");\n+      }\n+      return Bytes32Parser.toBytes32(strip(Files.newInputStream(graffitiFile).readNBytes(32)));", "originalCommit": "f3016ad9c3d5104bcc9f0573540908f8011776bb", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "db4ab6e25dfbcbc484d371260a967dc863b69757", "chunk": "diff --git a/validator/api/src/main/java/tech/pegasys/teku/validator/api/GraffitiParser.java b/validator/api/src/main/java/tech/pegasys/teku/validator/api/GraffitiParser.java\nindex e4115ef891..6a69db3a29 100644\n--- a/validator/api/src/main/java/tech/pegasys/teku/validator/api/GraffitiParser.java\n+++ b/validator/api/src/main/java/tech/pegasys/teku/validator/api/GraffitiParser.java\n\n@@ -17,6 +17,7 @@ import static com.google.common.base.Preconditions.checkNotNull;\n \n import java.io.FileNotFoundException;\n import java.io.IOException;\n+import java.io.InputStream;\n import java.nio.charset.StandardCharsets;\n import java.nio.file.Files;\n import java.nio.file.Path;\n"}}, {"oid": "db4ab6e25dfbcbc484d371260a967dc863b69757", "url": "https://github.com/ConsenSys/teku/commit/db4ab6e25dfbcbc484d371260a967dc863b69757", "message": "Addressed all comments", "committedDate": "2020-12-29T15:57:38Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTgzNDk1NA==", "url": "https://github.com/ConsenSys/teku/pull/3414#discussion_r549834954", "bodyText": "A couple of boundary conditions:\n\nEmpty file\nfile of exactly 32 bytes\nfile of 33 bytes\n\nFor the 33 bytes i'd probably just shrink the 64 bytes file, but the test at the actual bound is worthwhile to demonstrate.\nI'd leave the current sample of 10 bytes, the middle sizes are most likely scenarios.\nGiven the file is read as bytes, could write 0x00 to file, this could be the '32 bytes' test from above... it would show that we can read 32 bytes, and that that 32 bytes can be 0x00.\nEmpty file and Bytes32.ZERO in file should both result in Bytes32.ZERO so it should be asserted against that value once it's been read.\nI like the tests overall, but boundaries tend to be where things can get fragile :)", "author": "rolfyone", "createdAt": "2020-12-29T20:19:06Z", "path": "validator/api/src/test/java/tech/pegasys/teku/validator/api/GraffitiParserTest.java", "diffHunk": "@@ -0,0 +1,47 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.validator.api;\n+\n+import static java.nio.charset.StandardCharsets.UTF_8;\n+import static org.assertj.core.api.AssertionsForClassTypes.assertThat;\n+import static org.assertj.core.api.AssertionsForClassTypes.assertThatThrownBy;\n+\n+import java.nio.file.Path;\n+import org.apache.tuweni.bytes.Bytes;\n+import org.apache.tuweni.bytes.Bytes32;\n+import org.junit.jupiter.api.Test;\n+\n+class GraffitiParserTest {", "originalCommit": "db4ab6e25dfbcbc484d371260a967dc863b69757", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDgwOTA1NQ==", "url": "https://github.com/ConsenSys/teku/pull/3414#discussion_r550809055", "bodyText": "Made some changes", "author": "EdwardPrentice", "createdAt": "2021-01-01T21:28:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTgzNDk1NA=="}], "type": "inlineReview", "revised_code": {"commit": "15b6661c40b349a401b7a9f313467a4bafedca1b", "chunk": "diff --git a/validator/api/src/test/java/tech/pegasys/teku/validator/api/GraffitiParserTest.java b/validator/api/src/test/java/tech/pegasys/teku/validator/api/GraffitiParserTest.java\nindex e3dcd54a8e..bb7d1fd21d 100644\n--- a/validator/api/src/test/java/tech/pegasys/teku/validator/api/GraffitiParserTest.java\n+++ b/validator/api/src/test/java/tech/pegasys/teku/validator/api/GraffitiParserTest.java\n\n@@ -27,6 +27,8 @@ class GraffitiParserTest {\n   void testGraffitiParserLoadsAFileSucessfully() throws Exception {\n     assertThat(GraffitiParser.loadFromFile(Path.of(\"src/test/resources/graffitiSample.txt\")))\n         .isEqualTo(Bytes32.rightPad(Bytes.wrap(\"123456789\".getBytes(UTF_8))));\n+    assertThat(GraffitiParser.loadFromFile(Path.of(\"src/test/resources/32NullBytes.txt\")))\n+            .isEqualTo(Bytes32.fromHexString(\"00\".repeat(32)));\n   }\n \n   @Test\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTg0MTU1OA==", "url": "https://github.com/ConsenSys/teku/pull/3414#discussion_r549841558", "bodyText": "nit: could consider creating a default constructor\npublic FileBackedGraffitiProvider() {\nthis(Optional.empty(), Optional.empty());\n}\n\nnearly half the calls to this provider are empty, so it'd clean up some of that...\nas an aside, generally when we say 'nit' we're just nit-picking and its optional - just in case that's not something you generally see...", "author": "rolfyone", "createdAt": "2020-12-29T20:45:54Z", "path": "validator/api/src/main/java/tech/pegasys/teku/validator/api/FileBackedGraffitiProvider.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.validator.api;\n+\n+import java.nio.file.Path;\n+import java.util.Optional;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.apache.tuweni.bytes.Bytes32;\n+\n+/**\n+ * A type to hold the current graffiti value. Graffiti can be loaded from 2 places:\n+ *\n+ * <ul>\n+ *   <li>The default value supplied at initialisation\n+ *   <li>The graffiti file which will be regularly checked\n+ * </ul>\n+ *\n+ * In the case that the file cannot be read, the default graffiti value will be used.\n+ */\n+public class FileBackedGraffitiProvider implements GraffitiProvider {\n+  private static final Logger LOG = LogManager.getLogger();\n+\n+  private final Optional<Bytes32> defaultGraffiti;\n+  private final Optional<Path> graffitiFile;\n+\n+  public FileBackedGraffitiProvider(", "originalCommit": "db4ab6e25dfbcbc484d371260a967dc863b69757", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDgwOTI1Mw==", "url": "https://github.com/ConsenSys/teku/pull/3414#discussion_r550809253", "bodyText": "Ha - thanks. I haven't seen nit before. In general as long as I agree with a nit I'll strive to implement it.", "author": "EdwardPrentice", "createdAt": "2021-01-01T21:30:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTg0MTU1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDgxMDI1Mw==", "url": "https://github.com/ConsenSys/teku/pull/3414#discussion_r550810253", "bodyText": "For completeness, type erasure prevents the introduction of these constructors\n  public FileBackedGraffitiProvider(final Optional<Bytes32> defaultGraffiti) {\n    this(defaultGraffiti, Optional.empty());\n  }\n\n  public FileBackedGraffitiProvider(final Optional<Path> graffitiFile) {\n    this(Optional.empty(), graffitiFile);\n  }\n\nso I explored adding\n  public FileBackedGraffitiProvider(final Bytes32 defaultGraffiti) {\n    this(Optional.ofNullable(defaultGraffiti), Optional.empty());\n  }\n\n  public FileBackedGraffitiProvider(final Path graffitiFile) {\n    this(Optional.empty(), Optional.ofNullable(graffitiFile));\n  }\n\nbut as both of these constructors would only be used by test code I chose not to implement them.", "author": "EdwardPrentice", "createdAt": "2021-01-01T21:43:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTg0MTU1OA=="}], "type": "inlineReview", "revised_code": {"commit": "674e3ec37f042159e30be5619027aac820d483ca", "chunk": "diff --git a/validator/api/src/main/java/tech/pegasys/teku/validator/api/FileBackedGraffitiProvider.java b/validator/api/src/main/java/tech/pegasys/teku/validator/api/FileBackedGraffitiProvider.java\nindex 27673e8511..7ef9f3b578 100644\n--- a/validator/api/src/main/java/tech/pegasys/teku/validator/api/FileBackedGraffitiProvider.java\n+++ b/validator/api/src/main/java/tech/pegasys/teku/validator/api/FileBackedGraffitiProvider.java\n\n@@ -43,7 +43,7 @@ public class FileBackedGraffitiProvider implements GraffitiProvider {\n \n   @Override\n   public Optional<Bytes32> get() {\n-    return graffitiFile.flatMap(this::loadGraffitiFromFile).or(() -> defaultGraffiti);\n+    return graffitiFile.map(this::loadGraffitiFromFile).orElse(defaultGraffiti);\n   }\n \n   private Optional<Bytes32> loadGraffitiFromFile(final Path path) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTg0MjUxNQ==", "url": "https://github.com/ConsenSys/teku/pull/3414#discussion_r549842515", "bodyText": "nit: could read the file size to variable and add context to the message, so it could be 'Graffiti file is too big (33 bytes), maximum size is 32 bytes'", "author": "rolfyone", "createdAt": "2020-12-29T20:49:22Z", "path": "validator/api/src/main/java/tech/pegasys/teku/validator/api/GraffitiParser.java", "diffHunk": "@@ -0,0 +1,47 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.validator.api;\n+\n+import static com.google.common.base.Preconditions.checkNotNull;\n+\n+import java.io.FileNotFoundException;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import org.apache.tuweni.bytes.Bytes32;\n+\n+public class GraffitiParser {\n+  public static Bytes32 loadFromFile(final Path graffitiFile) throws GraffitiLoaderException {\n+    try {\n+      checkNotNull(graffitiFile, \"GraffitiFile path cannot be null\");\n+      if (Files.size(graffitiFile) > 32) {\n+        throw new GraffitiLoaderException(\"GraffitiFile size too big, maximum size is 32 bytes\");\n+      }", "originalCommit": "db4ab6e25dfbcbc484d371260a967dc863b69757", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDgxMDMyNQ==", "url": "https://github.com/ConsenSys/teku/pull/3414#discussion_r550810325", "bodyText": "This relates to when/if we strip whitespace so won't directly address here yet", "author": "EdwardPrentice", "createdAt": "2021-01-01T21:44:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTg0MjUxNQ=="}], "type": "inlineReview", "revised_code": {"commit": "674e3ec37f042159e30be5619027aac820d483ca", "chunk": "diff --git a/validator/api/src/main/java/tech/pegasys/teku/validator/api/GraffitiParser.java b/validator/api/src/main/java/tech/pegasys/teku/validator/api/GraffitiParser.java\nindex 6a69db3a29..e4115ef891 100644\n--- a/validator/api/src/main/java/tech/pegasys/teku/validator/api/GraffitiParser.java\n+++ b/validator/api/src/main/java/tech/pegasys/teku/validator/api/GraffitiParser.java\n\n@@ -17,7 +17,6 @@ import static com.google.common.base.Preconditions.checkNotNull;\n \n import java.io.FileNotFoundException;\n import java.io.IOException;\n-import java.io.InputStream;\n import java.nio.charset.StandardCharsets;\n import java.nio.file.Files;\n import java.nio.file.Path;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTg0ODIzNA==", "url": "https://github.com/ConsenSys/teku/pull/3414#discussion_r549848234", "bodyText": "this is all just really a question and some thoughts to ponder:\nthis puts an interesting twist on the concept of 'file is too big' really... If it's a file with a bunch of whitespace that puts it over, this would strip that whitespace and you might be left with valid graffiti? I guess what I'm thinking is the poor person that has '\\n' at the end of their file that pushes them over the graffiti limit, but equally accidentally putting whitespace before?\nI'm not sure what the answer is, just a question, because really if we're stripping we could potentially not check file size up front but rather attempt to get 32 bytes of graffiti from the file.\nso realistic use cases\n\nbytes32\\n\n bytes32 (leading space)\n\\nbytes32\\n\n\nCurrently these stripped characters would be basically 'your loss', I guess, you have a \\n at the end, so only get 31 bytes of graffiti, but this does seem like you'd potentially have a frustrating time figuring out where that byte disappears...", "author": "rolfyone", "createdAt": "2020-12-29T21:11:28Z", "path": "validator/api/src/main/java/tech/pegasys/teku/validator/api/GraffitiParser.java", "diffHunk": "@@ -0,0 +1,47 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.validator.api;\n+\n+import static com.google.common.base.Preconditions.checkNotNull;\n+\n+import java.io.FileNotFoundException;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import org.apache.tuweni.bytes.Bytes32;\n+\n+public class GraffitiParser {\n+  public static Bytes32 loadFromFile(final Path graffitiFile) throws GraffitiLoaderException {\n+    try {\n+      checkNotNull(graffitiFile, \"GraffitiFile path cannot be null\");\n+      if (Files.size(graffitiFile) > 32) {\n+        throw new GraffitiLoaderException(\"GraffitiFile size too big, maximum size is 32 bytes\");\n+      }\n+      try (final InputStream graffitiFileInputStream = Files.newInputStream(graffitiFile)) {\n+        return Bytes32Parser.toBytes32(strip(graffitiFileInputStream.readNBytes(32)));\n+      }\n+    } catch (final FileNotFoundException e) {\n+      throw new GraffitiLoaderException(\"GraffitiFile file not found: \" + graffitiFile, e);\n+    } catch (final IOException e) {\n+      throw new GraffitiLoaderException(\n+          \"Unexpected IO error while reading GraffitiFile: \" + e.getMessage(), e);\n+    }\n+  }\n+\n+  private static byte[] strip(final byte[] value) {\n+    return new String(value, StandardCharsets.UTF_8).strip().getBytes(StandardCharsets.UTF_8);\n+  }", "originalCommit": "db4ab6e25dfbcbc484d371260a967dc863b69757", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDgxMjMyMQ==", "url": "https://github.com/ConsenSys/teku/pull/3414#discussion_r550812321", "bodyText": "Lovely \ud83d\udc4d\nI think I'd prefer to do the kindest thing for well meaning users, so I think we should accommodate the \"32 bytes and a[n accidental] new line character\" scenario.\nOne concern Meredith raised was that we want to fail fast and if possible avoid reading a totally inappropriate file into memory at all.\nIn their current form I think these ideas are mutually exclusive - either we read the file to strip the whitespace to measure the length of the bytes that are left or we don't and we rely on the file metadata supplied by the OS which gives us the length inc any whitespace.\nA hybrid solution could be to test for a file of 40 bytes or less, and consider it unreasonable for a user to supply more than 8 bytes of leading or trailing whitespace. Once we've read the file, use the existing implementation here which will strip and convert to a Bytes32 (or fail). This allows users to make minor mistakes but also maintains our shared desire to not read files which are obviously too large or the wrong file altogether.\nHow does that sound?\nFor example, with a couple of tweaks to some tests, something like this:\n      if (Files.size(graffitiFile) > 40) {\n        throw new GraffitiLoaderException(\"GraffitiFile size too big, maximum size for graffiti is 32 bytes\");\n      }", "author": "EdwardPrentice", "createdAt": "2021-01-01T22:07:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTg0ODIzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTA0NzQ1OQ==", "url": "https://github.com/ConsenSys/teku/pull/3414#discussion_r551047459", "bodyText": "Yep i think reading a few extra bytes and allowing the fast fail is still good, and it just means we need to check the graffiti is only 32 bytes once we're done and potentially throw the error at the end too...\nI completely agree that reading a large buffer wouldn't be great, I was thinking just being nice and allowing a few bytes either side, so this is good.\nThe other scenario (i think there's a ticket somewhere!) is to read binary from file....\nIn that scenario we wouldn't be able to do this conversion at all, so it'd become a moot point and we'd just read the 32 bytes max and move on, but i think given this ticket is looking at text, we get that in and worry about the other scenario later...", "author": "rolfyone", "createdAt": "2021-01-03T19:54:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTg0ODIzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTM3MzE0Mg==", "url": "https://github.com/ConsenSys/teku/pull/3414#discussion_r551373142", "bodyText": "Sounds like a good plan @EdwardPrentice.  I think the main thing we want to avoid is reading in an excessive amount of data, but reading in even 64 bytes and then cleaning up / validating sounds good to me \ud83d\udc4d", "author": "mbaxter", "createdAt": "2021-01-04T15:08:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTg0ODIzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTM4ODY1Mw==", "url": "https://github.com/ConsenSys/teku/pull/3414#discussion_r551388653", "bodyText": "Ok awesome. Will go for 40 and can optimise for change so it can be tweaked in the future if needed", "author": "EdwardPrentice", "createdAt": "2021-01-04T15:34:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTg0ODIzNA=="}], "type": "inlineReview", "revised_code": {"commit": "674e3ec37f042159e30be5619027aac820d483ca", "chunk": "diff --git a/validator/api/src/main/java/tech/pegasys/teku/validator/api/GraffitiParser.java b/validator/api/src/main/java/tech/pegasys/teku/validator/api/GraffitiParser.java\nindex 6a69db3a29..e4115ef891 100644\n--- a/validator/api/src/main/java/tech/pegasys/teku/validator/api/GraffitiParser.java\n+++ b/validator/api/src/main/java/tech/pegasys/teku/validator/api/GraffitiParser.java\n\n@@ -17,7 +17,6 @@ import static com.google.common.base.Preconditions.checkNotNull;\n \n import java.io.FileNotFoundException;\n import java.io.IOException;\n-import java.io.InputStream;\n import java.nio.charset.StandardCharsets;\n import java.nio.file.Files;\n import java.nio.file.Path;\n"}}, {"oid": "674e3ec37f042159e30be5619027aac820d483ca", "url": "https://github.com/ConsenSys/teku/commit/674e3ec37f042159e30be5619027aac820d483ca", "message": "[Issue-3373] Implement a Graffiti class and a file loader in order to\nread graffiti from a file without restarting the validator", "committedDate": "2021-01-01T22:16:22Z", "type": "commit"}, {"oid": "6fa1d3cccea306237b10c1a7accaedce77150bcc", "url": "https://github.com/ConsenSys/teku/commit/6fa1d3cccea306237b10c1a7accaedce77150bcc", "message": "Update teku/src/main/java/tech/pegasys/teku/cli/options/ValidatorOptions.java\n\nCo-authored-by: mbaxter <meredith.baxter@consensys.net>", "committedDate": "2021-01-01T22:16:22Z", "type": "commit"}, {"oid": "09f4d654239fec853e082932e21ef0dab60bb6dd", "url": "https://github.com/ConsenSys/teku/commit/09f4d654239fec853e082932e21ef0dab60bb6dd", "message": "Update validator/api/src/test/java/tech/pegasys/teku/validator/api/FileBackedGraffitiProviderTest.java\n\nCo-authored-by: mbaxter <meredith.baxter@consensys.net>", "committedDate": "2021-01-01T22:16:22Z", "type": "commit"}, {"oid": "852a0b56d92249b1e140e204d4cfffe71f809917", "url": "https://github.com/ConsenSys/teku/commit/852a0b56d92249b1e140e204d4cfffe71f809917", "message": "Addressed all comments", "committedDate": "2021-01-01T22:16:22Z", "type": "commit"}, {"oid": "15b6661c40b349a401b7a9f313467a4bafedca1b", "url": "https://github.com/ConsenSys/teku/commit/15b6661c40b349a401b7a9f313467a4bafedca1b", "message": "WIPity WIPity WIP", "committedDate": "2021-01-01T22:16:22Z", "type": "commit"}, {"oid": "70518034670ff2020cf16f9f7b407b2547459f0c", "url": "https://github.com/ConsenSys/teku/commit/70518034670ff2020cf16f9f7b407b2547459f0c", "message": "WIP SpotlessApply", "committedDate": "2021-01-01T22:16:22Z", "type": "commit"}, {"oid": "70518034670ff2020cf16f9f7b407b2547459f0c", "url": "https://github.com/ConsenSys/teku/commit/70518034670ff2020cf16f9f7b407b2547459f0c", "message": "WIP SpotlessApply", "committedDate": "2021-01-01T22:16:22Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTM3MTI2MQ==", "url": "https://github.com/ConsenSys/teku/pull/3414#discussion_r551371261", "bodyText": "(nit) For tests that don't directly care about graffiti loading, we can just use Optional::empty as the graffiti provider:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    dataStructureUtil.randomPublicKey(), signer, new FileBackedGraffitiProvider());\n          \n          \n            \n                    dataStructureUtil.randomPublicKey(), signer, Optional::empty);", "author": "mbaxter", "createdAt": "2021-01-04T15:05:28Z", "path": "validator/client/src/test/java/tech/pegasys/teku/validator/client/duties/AttestationProductionDutyTest.java", "diffHunk": "@@ -353,7 +354,8 @@ public void shouldCreateAttestationForMultipleValidatorsInDifferentCommittees()\n \n   public Validator createValidator() {\n     final Signer signer = mock(Signer.class);\n-    return new Validator(dataStructureUtil.randomPublicKey(), signer, Optional.empty());\n+    return new Validator(\n+        dataStructureUtil.randomPublicKey(), signer, new FileBackedGraffitiProvider());", "originalCommit": "70518034670ff2020cf16f9f7b407b2547459f0c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "748742f80ab262ac35ef04c8dbf793f4de9cc758", "url": "https://github.com/ConsenSys/teku/commit/748742f80ab262ac35ef04c8dbf793f4de9cc758", "message": "32 to 40", "committedDate": "2021-01-04T16:25:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjAwNzkzOQ==", "url": "https://github.com/ConsenSys/teku/pull/3414#discussion_r552007939", "bodyText": "There's a stray paren:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                      \"Graffiti value to include during block creation. Value gets converted to bytes and padded to Bytes32).\",\n          \n          \n            \n                      \"Graffiti value to include during block creation. Value gets converted to bytes and padded to Bytes32.\",", "author": "mbaxter", "createdAt": "2021-01-05T15:34:37Z", "path": "teku/src/main/java/tech/pegasys/teku/cli/options/ValidatorOptions.java", "diffHunk": "@@ -30,10 +33,18 @@\n       converter = GraffitiConverter.class,\n       paramLabel = \"<GRAFFITI STRING>\",\n       description =\n-          \"Graffiti to include during block creation (gets converted to bytes and padded to Bytes32).\",\n+          \"Graffiti value to include during block creation. Value gets converted to bytes and padded to Bytes32).\",", "originalCommit": "748742f80ab262ac35ef04c8dbf793f4de9cc758", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6bad39ae55bde0958dd40aaa7899bd322bb29fcf", "chunk": "diff --git a/teku/src/main/java/tech/pegasys/teku/cli/options/ValidatorOptions.java b/teku/src/main/java/tech/pegasys/teku/cli/options/ValidatorOptions.java\nindex 9e5f1ad3fe..9af535c167 100644\n--- a/teku/src/main/java/tech/pegasys/teku/cli/options/ValidatorOptions.java\n+++ b/teku/src/main/java/tech/pegasys/teku/cli/options/ValidatorOptions.java\n\n@@ -33,7 +33,7 @@ public class ValidatorOptions {\n       converter = GraffitiConverter.class,\n       paramLabel = \"<GRAFFITI STRING>\",\n       description =\n-          \"Graffiti value to include during block creation. Value gets converted to bytes and padded to Bytes32).\",\n+          \"Graffiti value to include during block creation. Value gets converted to bytes and padded to Bytes32.\",\n       arity = \"1\")\n   private Bytes32 graffiti;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjAwODUwOQ==", "url": "https://github.com/ConsenSys/teku/pull/3414#discussion_r552008509", "bodyText": "Another stray parenthesis:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                      \"File to load graffiti value to include during block creation. Value gets converted to bytes and padded to Bytes32).  If file reading fails during block creation, teku will fall back to any value supplied via --graffiti.\",\n          \n          \n            \n                      \"File to load graffiti value to include during block creation. Value gets converted to bytes and padded to Bytes32.  If file reading fails during block creation, teku will fall back to any value supplied via --graffiti.\",", "author": "mbaxter", "createdAt": "2021-01-05T15:35:28Z", "path": "teku/src/main/java/tech/pegasys/teku/cli/options/ValidatorOptions.java", "diffHunk": "@@ -30,10 +33,18 @@\n       converter = GraffitiConverter.class,\n       paramLabel = \"<GRAFFITI STRING>\",\n       description =\n-          \"Graffiti to include during block creation (gets converted to bytes and padded to Bytes32).\",\n+          \"Graffiti value to include during block creation. Value gets converted to bytes and padded to Bytes32).\",\n       arity = \"1\")\n   private Bytes32 graffiti;\n \n+  @Option(\n+      names = {\"--validators-graffiti-file\"},\n+      paramLabel = \"<GRAFFITI FILE>\",\n+      description =\n+          \"File to load graffiti value to include during block creation. Value gets converted to bytes and padded to Bytes32).  If file reading fails during block creation, teku will fall back to any value supplied via --graffiti.\",", "originalCommit": "748742f80ab262ac35ef04c8dbf793f4de9cc758", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6bad39ae55bde0958dd40aaa7899bd322bb29fcf", "chunk": "diff --git a/teku/src/main/java/tech/pegasys/teku/cli/options/ValidatorOptions.java b/teku/src/main/java/tech/pegasys/teku/cli/options/ValidatorOptions.java\nindex 9e5f1ad3fe..9af535c167 100644\n--- a/teku/src/main/java/tech/pegasys/teku/cli/options/ValidatorOptions.java\n+++ b/teku/src/main/java/tech/pegasys/teku/cli/options/ValidatorOptions.java\n\n@@ -33,7 +33,7 @@ public class ValidatorOptions {\n       converter = GraffitiConverter.class,\n       paramLabel = \"<GRAFFITI STRING>\",\n       description =\n-          \"Graffiti value to include during block creation. Value gets converted to bytes and padded to Bytes32).\",\n+          \"Graffiti value to include during block creation. Value gets converted to bytes and padded to Bytes32.\",\n       arity = \"1\")\n   private Bytes32 graffiti;\n \n"}}, {"oid": "6bad39ae55bde0958dd40aaa7899bd322bb29fcf", "url": "https://github.com/ConsenSys/teku/commit/6bad39ae55bde0958dd40aaa7899bd322bb29fcf", "message": "Cut stray paren", "committedDate": "2021-01-05T15:37:39Z", "type": "commit"}, {"oid": "a781355ce6884a383ee6d6d6000cde71282b73a9", "url": "https://github.com/ConsenSys/teku/commit/a781355ce6884a383ee6d6d6000cde71282b73a9", "message": "Cut stray paren again", "committedDate": "2021-01-05T15:38:12Z", "type": "commit"}]}