{"pr_number": 1630, "pr_title": "Improve genesis performance and logging", "pr_createdAt": "2020-04-21T05:44:44Z", "pr_url": "https://github.com/ConsenSys/teku/pull/1630", "timeline": [{"oid": "8f81523813bdb4ab3d792a3da1310a678ce9ad0a", "url": "https://github.com/ConsenSys/teku/commit/8f81523813bdb4ab3d792a3da1310a678ce9ad0a", "message": "Send status logs to the console not the file.\nImprove logging at startup around source of genesis state.", "committedDate": "2020-04-21T04:19:37Z", "type": "commit"}, {"oid": "7d905852ca95b3663509a13d14d891f81355ee8d", "url": "https://github.com/ConsenSys/teku/commit/7d905852ca95b3663509a13d14d891f81355ee8d", "message": "Request block data in the order they will be required (not reverse order) so we start processing deposits sooner.\nProvide status logs for each whole percentage increase in the number of registered validators.", "committedDate": "2020-04-21T05:38:46Z", "type": "commit"}, {"oid": "dd1b854141a76a5f89500c51ed84867d4c66c10e", "url": "https://github.com/ConsenSys/teku/commit/dd1b854141a76a5f89500c51ed84867d4c66c10e", "message": "Fix grammar.", "committedDate": "2020-04-21T05:40:08Z", "type": "commit"}, {"oid": "a067af24ce420e4cbe30dec048d3838f29cdf2b7", "url": "https://github.com/ConsenSys/teku/commit/a067af24ce420e4cbe30dec048d3838f29cdf2b7", "message": "Ignore min genesis time block if we have already loaded genesis.", "committedDate": "2020-04-21T10:44:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjI3ODYxMQ==", "url": "https://github.com/ConsenSys/teku/pull/1630#discussion_r412278611", "bodyText": "nice.", "author": "cemozerr", "createdAt": "2020-04-21T15:18:55Z", "path": "ethereum/statetransition/src/main/java/tech/pegasys/artemis/statetransition/genesis/GenesisHandler.java", "diffHunk": "@@ -54,16 +56,31 @@ public void onDepositsFromBlock(final DepositsFromBlockEvent event) {\n \n   @Override\n   public void onMinGenesisTimeBlock(MinGenesisTimeBlockEvent event) {\n+    if (!recentChainData.isPreGenesis()) {\n+      return;\n+    }\n+    STATUS_LOG.minGenesisTimeReached();\n     processNewData(event.getBlockHash(), event.getTimestamp(), List.of());\n   }\n \n   private void processNewData(\n       Bytes32 blockHash, UnsignedLong timestamp, List<DepositWithIndex> deposits) {\n+    final int previousValidatorRequirementPercent =\n+        roundPercent(genesisGenerator.getActiveValidatorCount());\n     genesisGenerator.updateCandidateState(blockHash, timestamp, deposits);\n \n-    genesisGenerator\n-        .getGenesisStateIfValid(BeaconStateUtil::is_valid_genesis_state)\n-        .ifPresent(this::eth2Genesis);\n+    final int newActiveValidatorCount = genesisGenerator.getActiveValidatorCount();\n+    if (BeaconStateUtil.is_valid_genesis_state(\n+        genesisGenerator.getGenesisTime(), newActiveValidatorCount)) {\n+      eth2Genesis(genesisGenerator.getGenesisState());\n+    } else if (roundPercent(newActiveValidatorCount) > previousValidatorRequirementPercent) {", "originalCommit": "a067af24ce420e4cbe30dec048d3838f29cdf2b7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjI4NzM2Ng==", "url": "https://github.com/ConsenSys/teku/pull/1630#discussion_r412287366", "bodyText": "What's is the reasoning behind getting all the status logs in one place? It seems similar to having all constants in one file, which we seem to not want to be doing going forward.", "author": "cemozerr", "createdAt": "2020-04-21T15:29:24Z", "path": "logging/src/main/java/tech/pegasys/teku/logging/StatusLogger.java", "diffHunk": "@@ -60,10 +61,37 @@ public void validatorDepositEncryptedKeystoreWriterFailure(\n   }\n \n   public void beginInitializingChainData() {\n-    log.info(\"Begin initializing chain data from storage\");\n+    log.info(\"Initializing storage\");\n   }\n \n   public void finishInitializingChainData() {\n-    log.info(\"Finish initializing chain data from storage\");\n+    log.info(\"Storage initialization complete\");\n+  }\n+\n+  public void generatingMockStartGenesis(final long genesisTime, final int size) {", "originalCommit": "a067af24ce420e4cbe30dec048d3838f29cdf2b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjQ3MjA0Nw==", "url": "https://github.com/ConsenSys/teku/pull/1630#discussion_r412472047", "bodyText": "It wasn't my idea.  At the moment it's a pretty small set so I can live with it but I'm not a huge fan of the approach.", "author": "ajsutton", "createdAt": "2020-04-21T20:33:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjI4NzM2Ng=="}], "type": "inlineReview", "revised_code": null}]}