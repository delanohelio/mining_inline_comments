{"pr_number": 2887, "pr_title": "rename reorgEventChannel to ChainHeadChannel", "pr_createdAt": "2020-10-06T04:05:21Z", "pr_url": "https://github.com/ConsenSys/teku/pull/2887", "timeline": [{"oid": "0a15e583f692534ea1695ff13cf54f932f6ce622", "url": "https://github.com/ConsenSys/teku/commit/0a15e583f692534ea1695ff13cf54f932f6ce622", "message": "rename reorgEventChannel to ChainHeadChannel\n\n - ChainHeadChannel will also notify of a new chain head, but initially the intent is to replace the Reorg functionality currently in use.\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-10-06T04:04:51Z", "type": "commit"}, {"oid": "a32e3c3819dc79913e75bc40099c1e64fc0bfa23", "url": "https://github.com/ConsenSys/teku/commit/a32e3c3819dc79913e75bc40099c1e64fc0bfa23", "message": "fix test that hard coded epoch transition\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-10-06T04:14:19Z", "type": "commit"}, {"oid": "3aff1c630fd2951b819cd61089403e34ddf0530b", "url": "https://github.com/ConsenSys/teku/commit/3aff1c630fd2951b819cd61089403e34ddf0530b", "message": "remove fixme\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-10-06T04:20:41Z", "type": "commit"}, {"oid": "6c9284ed0565f09f0639cb6e4ef1fb0df6352e2f", "url": "https://github.com/ConsenSys/teku/commit/6c9284ed0565f09f0639cb6e4ef1fb0df6352e2f", "message": "Merge remote-tracking branch 'upstream/master' into 2885-refactor-reorg", "committedDate": "2020-10-06T04:25:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTk5ODM1Mw==", "url": "https://github.com/ConsenSys/teku/pull/2887#discussion_r499998353", "bodyText": "This doesn't appear to be used?", "author": "ajsutton", "createdAt": "2020-10-06T04:25:33Z", "path": "ethereum/datastructures/src/main/java/tech/pegasys/teku/datastructures/util/BeaconStateUtil.java", "diffHunk": "@@ -464,6 +464,10 @@ public static UInt64 compute_start_slot_at_epoch(UInt64 epoch) {\n     return epoch.times(SLOTS_PER_EPOCH);\n   }\n \n+  public static boolean is_start_slot_of_epoch(final UInt64 slot) {\n+    return slot.mod(SLOTS_PER_EPOCH).equals(UInt64.ZERO);\n+  }", "originalCommit": "3aff1c630fd2951b819cd61089403e34ddf0530b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDAwMDYwOA==", "url": "https://github.com/ConsenSys/teku/pull/2887#discussion_r500000608", "bodyText": "at the moment its only in test code but the RecentChainData.updateChainHead will call it so i dont have to code the decision into that...", "author": "rolfyone", "createdAt": "2020-10-06T04:35:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTk5ODM1Mw=="}], "type": "inlineReview", "revised_code": {"commit": "c78f59d29070a416bd7fa6f57b005704f315177d", "chunk": "diff --git a/ethereum/datastructures/src/main/java/tech/pegasys/teku/datastructures/util/BeaconStateUtil.java b/ethereum/datastructures/src/main/java/tech/pegasys/teku/datastructures/util/BeaconStateUtil.java\nindex 37fe9f072f..e09f71980d 100644\n--- a/ethereum/datastructures/src/main/java/tech/pegasys/teku/datastructures/util/BeaconStateUtil.java\n+++ b/ethereum/datastructures/src/main/java/tech/pegasys/teku/datastructures/util/BeaconStateUtil.java\n\n@@ -464,10 +464,6 @@ public class BeaconStateUtil {\n     return epoch.times(SLOTS_PER_EPOCH);\n   }\n \n-  public static boolean is_start_slot_of_epoch(final UInt64 slot) {\n-    return slot.mod(SLOTS_PER_EPOCH).equals(UInt64.ZERO);\n-  }\n-\n   /**\n    * Initiate the exit of the validator with index ``index``.\n    *\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTk5OTkwOQ==", "url": "https://github.com/ConsenSys/teku/pull/2887#discussion_r499999909", "bodyText": "I don't think this is right.  We might wind up skipping multiple slots and so miss the first slot of the epoch.  I think it should check if the forkChoiceSlot from previousChainHead is from an earlier epoch than the forkChoiceSlot from newChainHead.", "author": "ajsutton", "createdAt": "2020-10-06T04:32:15Z", "path": "storage/src/main/java/tech/pegasys/teku/storage/client/RecentChainData.java", "diffHunk": "@@ -260,14 +262,18 @@ private void updateChainHead(\n               commonAncestorSlot);\n         }\n \n+        final UInt64 epoch = compute_epoch_at_slot(newChainHead.getSlot());\n+        final boolean epochTransition =\n+            newChainHead.getSlot().equals(compute_start_slot_at_epoch(epoch));", "originalCommit": "3aff1c630fd2951b819cd61089403e34ddf0530b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDAwMTI1OQ==", "url": "https://github.com/ConsenSys/teku/pull/2887#discussion_r500001259", "bodyText": "The point is that you're not looking for the first slot in the epoch.  You might be going from slot 30 to 50 in one update and that's an epoch transition even though you never got to slot 32.", "author": "ajsutton", "createdAt": "2020-10-06T04:38:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTk5OTkwOQ=="}], "type": "inlineReview", "revised_code": {"commit": "d65123b0bcdb35a787f1d469ea57f1cce5cf0f47", "chunk": "diff --git a/storage/src/main/java/tech/pegasys/teku/storage/client/RecentChainData.java b/storage/src/main/java/tech/pegasys/teku/storage/client/RecentChainData.java\nindex b196abc571..85cc8da487 100644\n--- a/storage/src/main/java/tech/pegasys/teku/storage/client/RecentChainData.java\n+++ b/storage/src/main/java/tech/pegasys/teku/storage/client/RecentChainData.java\n\n@@ -262,9 +261,9 @@ public abstract class RecentChainData implements StoreUpdateHandler {\n               commonAncestorSlot);\n         }\n \n-        final UInt64 epoch = compute_epoch_at_slot(newChainHead.getSlot());\n         final boolean epochTransition =\n-            newChainHead.getSlot().equals(compute_start_slot_at_epoch(epoch));\n+            compute_epoch_at_slot(previousChainHead.getForkChoiceSlot())\n+                .isLessThan(compute_epoch_at_slot(newChainHead.getForkChoiceSlot()));\n \n         reorgCounter.inc();\n         chainHeadChannel.chainHeadUpdated(\n"}}, {"oid": "d65123b0bcdb35a787f1d469ea57f1cce5cf0f47", "url": "https://github.com/ConsenSys/teku/commit/d65123b0bcdb35a787f1d469ea57f1cce5cf0f47", "message": "review feedback\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-10-06T04:51:27Z", "type": "commit"}, {"oid": "c78f59d29070a416bd7fa6f57b005704f315177d", "url": "https://github.com/ConsenSys/teku/commit/c78f59d29070a416bd7fa6f57b005704f315177d", "message": "review feedback\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-10-06T04:59:32Z", "type": "commit"}, {"oid": "2b904e80818d94b2d92d558b4f3db89f5c153c41", "url": "https://github.com/ConsenSys/teku/commit/2b904e80818d94b2d92d558b4f3db89f5c153c41", "message": "Merge remote-tracking branch 'upstream/master' into 2885-refactor-reorg", "committedDate": "2020-10-06T06:05:13Z", "type": "commit"}]}