{"pr_number": 2804, "pr_title": "Add BatchImporter", "pr_createdAt": "2020-09-16T03:09:58Z", "pr_url": "https://github.com/ConsenSys/teku/pull/2804", "timeline": [{"oid": "6b2004fc64187d5ff62d15fa0d085e239080ff22", "url": "https://github.com/ConsenSys/teku/commit/6b2004fc64187d5ff62d15fa0d085e239080ff22", "message": "Start of finalized sync.", "committedDate": "2020-09-10T05:43:46Z", "type": "commit"}, {"oid": "568a8432302d0ae988ea075e55f7fa6e9584db6d", "url": "https://github.com/ConsenSys/teku/commit/568a8432302d0ae988ea075e55f7fa6e9584db6d", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into finalized-sync", "committedDate": "2020-09-10T06:25:30Z", "type": "commit"}, {"oid": "5fc317649970c286af7e91e0419118704135e4f9", "url": "https://github.com/ConsenSys/teku/commit/5fc317649970c286af7e91e0419118704135e4f9", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into finalized-sync", "committedDate": "2020-09-10T23:22:53Z", "type": "commit"}, {"oid": "7dd7b4f0dced3a33ec5036e7556528aa192bdf01", "url": "https://github.com/ConsenSys/teku/commit/7dd7b4f0dced3a33ec5036e7556528aa192bdf01", "message": "Implement more tests, deal with more cases.", "committedDate": "2020-09-11T03:09:05Z", "type": "commit"}, {"oid": "e8d942abd4f448a7fca8f791c5cb1981356ad581", "url": "https://github.com/ConsenSys/teku/commit/e8d942abd4f448a7fca8f791c5cb1981356ad581", "message": "Only import one batch at a time.", "committedDate": "2020-09-11T03:16:19Z", "type": "commit"}, {"oid": "1aa096105c7537f9da3da7b976df87345bf77acc", "url": "https://github.com/ConsenSys/teku/commit/1aa096105c7537f9da3da7b976df87345bf77acc", "message": "Extract NavigableSet logic to BatchChain.", "committedDate": "2020-09-11T04:45:39Z", "type": "commit"}, {"oid": "1cc9d52b0903dda28408477a87025f575590fe62", "url": "https://github.com/ConsenSys/teku/commit/1cc9d52b0903dda28408477a87025f575590fe62", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into finalized-sync", "committedDate": "2020-09-11T04:45:47Z", "type": "commit"}, {"oid": "5d32b018e502c4f78a2f216fdaa7ca25f712315a", "url": "https://github.com/ConsenSys/teku/commit/5d32b018e502c4f78a2f216fdaa7ca25f712315a", "message": "Handle changing which chain we sync to.", "committedDate": "2020-09-11T05:56:48Z", "type": "commit"}, {"oid": "6dcad90452c9dba02c6b66c9ea3b6bdb6ec29470", "url": "https://github.com/ConsenSys/teku/commit/6dcad90452c9dba02c6b66c9ea3b6bdb6ec29470", "message": "Add missing dependency.", "committedDate": "2020-09-11T06:24:54Z", "type": "commit"}, {"oid": "45d5f73a04f26f4249508c64648a61f2bbf0d48c", "url": "https://github.com/ConsenSys/teku/commit/45d5f73a04f26f4249508c64648a61f2bbf0d48c", "message": "Implement BatchImporter.", "committedDate": "2020-09-11T21:16:58Z", "type": "commit"}, {"oid": "097b2fb86801fc8d2545f07a7088dde51d0a2206", "url": "https://github.com/ConsenSys/teku/commit/097b2fb86801fc8d2545f07a7088dde51d0a2206", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into finalized-sync", "committedDate": "2020-09-11T21:17:02Z", "type": "commit"}, {"oid": "65e5bc0e83647d8f607fb84de08deceee83b5930", "url": "https://github.com/ConsenSys/teku/commit/65e5bc0e83647d8f607fb84de08deceee83b5930", "message": "Implement the happy path for a real batch implementation.", "committedDate": "2020-09-13T21:28:03Z", "type": "commit"}, {"oid": "ef6da95951bb068cfe31b55d22bc6c02acd5ea95", "url": "https://github.com/ConsenSys/teku/commit/ef6da95951bb068cfe31b55d22bc6c02acd5ea95", "message": "Report exceptions.", "committedDate": "2020-09-13T21:36:28Z", "type": "commit"}, {"oid": "cef1ff7f9ce1429788f9dad33681553236de11d3", "url": "https://github.com/ConsenSys/teku/commit/cef1ff7f9ce1429788f9dad33681553236de11d3", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into finalized-sync", "committedDate": "2020-09-13T21:48:50Z", "type": "commit"}, {"oid": "9bfe8c8295e2907ddac64b349f88822e33f1f342", "url": "https://github.com/ConsenSys/teku/commit/9bfe8c8295e2907ddac64b349f88822e33f1f342", "message": "Errorprone.", "committedDate": "2020-09-13T22:07:25Z", "type": "commit"}, {"oid": "2517c362f8e7c6f953827301e688feb17d5d237a", "url": "https://github.com/ConsenSys/teku/commit/2517c362f8e7c6f953827301e688feb17d5d237a", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into finalized-sync", "committedDate": "2020-09-13T22:23:53Z", "type": "commit"}, {"oid": "0655190758b60d2aed9b66513b099b736da7f926", "url": "https://github.com/ConsenSys/teku/commit/0655190758b60d2aed9b66513b099b736da7f926", "message": "Reduce batch size.", "committedDate": "2020-09-13T22:26:24Z", "type": "commit"}, {"oid": "0599450254201c540df193e15094f6a40068f0b8", "url": "https://github.com/ConsenSys/teku/commit/0599450254201c540df193e15094f6a40068f0b8", "message": "Limit the number of non-empty batches in progress at any time, not just the number of requests for more blocks.", "committedDate": "2020-09-14T02:01:49Z", "type": "commit"}, {"oid": "ff191d92a92a8876ab22bc3aaf7f778ffa50bd08", "url": "https://github.com/ConsenSys/teku/commit/ff191d92a92a8876ab22bc3aaf7f778ffa50bd08", "message": "Fix last slot calculations.\nHandle disconnected peers and errors when requesting blocks.\nVery basic support for handling contested blocks.\nMore debug level output.", "committedDate": "2020-09-14T05:56:02Z", "type": "commit"}, {"oid": "42cace7c802944a707ed80db9cb716f135cd52f8", "url": "https://github.com/ConsenSys/teku/commit/42cace7c802944a707ed80db9cb716f135cd52f8", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into finalized-sync\nReturn sync result.", "committedDate": "2020-09-15T00:49:46Z", "type": "commit"}, {"oid": "c029be02d4640ba92f770b4c88baf263b4d57281", "url": "https://github.com/ConsenSys/teku/commit/c029be02d4640ba92f770b4c88baf263b4d57281", "message": "Mark future complete when there are no more batches to process.", "committedDate": "2020-09-15T00:59:59Z", "type": "commit"}, {"oid": "bba02a0ce70866a73d732f1be8ea515e32e8b2ef", "url": "https://github.com/ConsenSys/teku/commit/bba02a0ce70866a73d732f1be8ea515e32e8b2ef", "message": "Fix SyncSourceBatchTest.", "committedDate": "2020-09-15T01:10:49Z", "type": "commit"}, {"oid": "b2f0736b5beab1664951ab977ca8fe8b0448af34", "url": "https://github.com/ConsenSys/teku/commit/b2f0736b5beab1664951ab977ca8fe8b0448af34", "message": "Split requesting of batches into a separate class.", "committedDate": "2020-09-15T01:26:56Z", "type": "commit"}, {"oid": "d9264ba62a69c2ee8400588bed3d362ac817ae8f", "url": "https://github.com/ConsenSys/teku/commit/d9264ba62a69c2ee8400588bed3d362ac817ae8f", "message": "Apply event thread checks to batches in production code too.", "committedDate": "2020-09-15T01:33:26Z", "type": "commit"}, {"oid": "436ae359b93ea1a6cd97412a6eefbf3041a2f82b", "url": "https://github.com/ConsenSys/teku/commit/436ae359b93ea1a6cd97412a6eefbf3041a2f82b", "message": "Implement markInvalid.", "committedDate": "2020-09-15T03:17:22Z", "type": "commit"}, {"oid": "38ddae967fe3f0cb5a0aaae4f86bdffe04265d9c", "url": "https://github.com/ConsenSys/teku/commit/38ddae967fe3f0cb5a0aaae4f86bdffe04265d9c", "message": "Introduce ConflictResolutionStrategy with a single pessimistic strategy that marks every contested batch as invalid and re-downloads.\nFix issue where incomplete batches were marked as contested because they appeared empty.", "committedDate": "2020-09-15T04:05:28Z", "type": "commit"}, {"oid": "56ac8b28270d503fe38b9c3334d727e38c3e60bd", "url": "https://github.com/ConsenSys/teku/commit/56ac8b28270d503fe38b9c3334d727e38c3e60bd", "message": "Fix assertions.", "committedDate": "2020-09-15T04:10:18Z", "type": "commit"}, {"oid": "bb5d39ab481784867bdceed839a1c5886960a9ea", "url": "https://github.com/ConsenSys/teku/commit/bb5d39ab481784867bdceed839a1c5886960a9ea", "message": "Log when multipeer sync is in use.", "committedDate": "2020-09-15T04:20:30Z", "type": "commit"}, {"oid": "63e0f53b217c1e8143eb217ba67418c7371233b0", "url": "https://github.com/ConsenSys/teku/commit/63e0f53b217c1e8143eb217ba67418c7371233b0", "message": "Handle errors raised when requesting blocks because the response is internally inconsistent.", "committedDate": "2020-09-15T04:58:25Z", "type": "commit"}, {"oid": "f400d9e09d78271133bb89ed6c185751b5a8e775", "url": "https://github.com/ConsenSys/teku/commit/f400d9e09d78271133bb89ed6c185751b5a8e775", "message": "Verify blocks received from separate requests within the same batch form a chain.", "committedDate": "2020-09-15T05:09:30Z", "type": "commit"}, {"oid": "7ac5a214123687c90f587950c7c0ab32d7942762", "url": "https://github.com/ConsenSys/teku/commit/7ac5a214123687c90f587950c7c0ab32d7942762", "message": "Fail sync when there are no peers left on the target chain.\nHandle not having any peers when attempting to make requests.", "committedDate": "2020-09-15T06:11:44Z", "type": "commit"}, {"oid": "bc3c6017c679a29c2efb87a4c19ce31527f02a91", "url": "https://github.com/ConsenSys/teku/commit/bc3c6017c679a29c2efb87a4c19ce31527f02a91", "message": "Spotless.", "committedDate": "2020-09-15T06:13:39Z", "type": "commit"}, {"oid": "1345a163a1350c7a770b77656b8fb8f5caa48730", "url": "https://github.com/ConsenSys/teku/commit/1345a163a1350c7a770b77656b8fb8f5caa48730", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into finalized-sync", "committedDate": "2020-09-16T00:33:21Z", "type": "commit"}, {"oid": "c503e6c500e95863938af0af661c9331ab14c908", "url": "https://github.com/ConsenSys/teku/commit/c503e6c500e95863938af0af661c9331ab14c908", "message": "Add debug logging when conflict resolution occurs.", "committedDate": "2020-09-16T01:39:28Z", "type": "commit"}, {"oid": "1bcb92d398a39878361b40182d93902c82389802", "url": "https://github.com/ConsenSys/teku/commit/1bcb92d398a39878361b40182d93902c82389802", "message": "More debugging progressSync when target chain switches instead of just filling queue.", "committedDate": "2020-09-16T01:48:49Z", "type": "commit"}, {"oid": "725caf2c284b4381b038043966c933800ed18be6", "url": "https://github.com/ConsenSys/teku/commit/725caf2c284b4381b038043966c933800ed18be6", "message": "Avoid stalling when a batch completes importing after it has been dropped from the active batches.", "committedDate": "2020-09-16T02:15:03Z", "type": "commit"}, {"oid": "109001a47dff4a1856f9e2c0936807aaca02604f", "url": "https://github.com/ConsenSys/teku/commit/109001a47dff4a1856f9e2c0936807aaca02604f", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into finalized-sync", "committedDate": "2020-09-16T02:15:20Z", "type": "commit"}, {"oid": "fbe8b807bd3ab80a823af02d58a21b59a8bce043", "url": "https://github.com/ConsenSys/teku/commit/fbe8b807bd3ab80a823af02d58a21b59a8bce043", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into finalized-sync", "committedDate": "2020-09-16T02:59:19Z", "type": "commit"}, {"oid": "37a06f18e53a69a06748180cdb03c858df34e0a9", "url": "https://github.com/ConsenSys/teku/commit/37a06f18e53a69a06748180cdb03c858df34e0a9", "message": "Remove todo.", "committedDate": "2020-09-16T03:03:56Z", "type": "commit"}, {"oid": "0becd6ed7bbb48548e0f4da7f88ee05e5e8fe205", "url": "https://github.com/ConsenSys/teku/commit/0becd6ed7bbb48548e0f4da7f88ee05e5e8fe205", "message": "Add BatchImporter.", "committedDate": "2020-09-16T03:09:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTMwMTgwNw==", "url": "https://github.com/ConsenSys/teku/pull/2804#discussion_r489301807", "bodyText": "Why do we need runAsync here if the importBlock is async itself?", "author": "Nashatyrev", "createdAt": "2020-09-16T09:35:45Z", "path": "sync/src/main/java/tech/pegasys/teku/sync/multipeer/BatchImporter.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.sync.multipeer;\n+\n+import static com.google.common.base.Preconditions.checkState;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import tech.pegasys.teku.core.results.BlockImportResult;\n+import tech.pegasys.teku.datastructures.blocks.SignedBeaconBlock;\n+import tech.pegasys.teku.infrastructure.async.AsyncRunner;\n+import tech.pegasys.teku.infrastructure.async.SafeFuture;\n+import tech.pegasys.teku.statetransition.blockimport.BlockImporter;\n+import tech.pegasys.teku.sync.multipeer.batches.Batch;\n+\n+public class BatchImporter {\n+\n+  private final BlockImporter blockImporter;\n+  private final AsyncRunner asyncRunner;\n+\n+  public BatchImporter(final BlockImporter blockImporter, final AsyncRunner asyncRunner) {\n+    this.blockImporter = blockImporter;\n+    this.asyncRunner = asyncRunner;\n+  }\n+\n+  /**\n+   * Import the blocks in the specified batch.\n+   *\n+   * <p>Guaranteed to return immediately and perform the import on worker threads.\n+   *\n+   * @param batch the batch to import\n+   * @return a future reporting the result of the import\n+   */\n+  public SafeFuture<BatchImportResult> importBatch(final Batch batch) {\n+    // Copy the blocks as we're going to use them from off the event thread.\n+    final List<SignedBeaconBlock> blocks = new ArrayList<>(batch.getBlocks());\n+    checkState(!blocks.isEmpty(), \"Batch has no blocks to import\");\n+    return asyncRunner.runAsync(", "originalCommit": "0becd6ed7bbb48548e0f4da7f88ee05e5e8fe205", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc1OTg4Mg==", "url": "https://github.com/ConsenSys/teku/pull/2804#discussion_r489759882", "bodyText": "importBlock may be async but isn't guaranteed to be. If the checkpoints and state required are already available in the in-memory store, the block import will happen synchronously.", "author": "ajsutton", "createdAt": "2020-09-16T21:18:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTMwMTgwNw=="}], "type": "inlineReview", "revised_code": null}]}