{"pr_number": 1249, "pr_title": "Load BLS Keys from encrypted keystore", "pr_createdAt": "2020-03-02T01:18:47Z", "pr_url": "https://github.com/ConsenSys/teku/pull/1249", "timeline": [{"oid": "b483a230469afa44bb2530e7f8a17dd7ed1f5c8d", "url": "https://github.com/ConsenSys/teku/commit/b483a230469afa44bb2530e7f8a17dd7ed1f5c8d", "message": "Adding validator.validatorsKeystoreConfFile in artimis configuration class\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-03-01T23:31:01Z", "type": "commit"}, {"oid": "a8e8b9421d498dff5dc3efa980cd2fb50e3132fe", "url": "https://github.com/ConsenSys/teku/commit/a8e8b9421d498dff5dc3efa980cd2fb50e3132fe", "message": "Updating ValidatorLoader to load both from encrypted keystore and unencrypted yaml key provider\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-03-02T01:14:56Z", "type": "commit"}, {"oid": "3dcdadeec4d614a8e09806f3b96cca8d858bc175", "url": "https://github.com/ConsenSys/teku/commit/3dcdadeec4d614a8e09806f3b96cca8d858bc175", "message": "Merge remote-tracking branch 'upstream/master' into keystore_config_1176\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-03-02T01:19:14Z", "type": "commit"}, {"oid": "6ad711146e01fab2cfbc7b70606114fa27cdf307", "url": "https://github.com/ConsenSys/teku/commit/6ad711146e01fab2cfbc7b70606114fa27cdf307", "message": "removing unnecessary trim method\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-03-02T01:21:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjE2NDI4Mg==", "url": "https://github.com/ConsenSys/teku/pull/1249#discussion_r386164282", "bodyText": "Why do we need a config entry that points to another config file that lists the keystores?", "author": "ajsutton", "createdAt": "2020-03-02T01:27:20Z", "path": "util/src/main/java/tech/pegasys/artemis/util/config/ArtemisConfiguration.java", "diffHunk": "@@ -54,6 +54,12 @@ static final Schema createSchema() {\n     builder.addString(\"node.bootnodes\", \"\", \"ENR of the bootnode\", null);\n     builder.addString(\n         \"validator.validatorsKeyFile\", \"\", \"The file to load validator keys from\", null);\n+    builder.addString(\n+        \"validator.validatorsKeystoreConfFile\",\n+        \"\",\n+        \"The file containing paths to encrypted keystore files and password files to decrypt them\",\n+        null);", "originalCommit": "6ad711146e01fab2cfbc7b70606114fa27cdf307", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjE2NTEyNw==", "url": "https://github.com/ConsenSys/teku/pull/1249#discussion_r386165127", "bodyText": "I'll change it to specify all the keystores files and corresponding password files instead of using another configuration file.", "author": "usmansaleem", "createdAt": "2020-03-02T01:34:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjE2NDI4Mg=="}], "type": "inlineReview", "revised_code": {"commit": "916a3b39816703e83b6fd29bac3dc09e1be50d96", "chunk": "diff --git a/util/src/main/java/tech/pegasys/artemis/util/config/ArtemisConfiguration.java b/util/src/main/java/tech/pegasys/artemis/util/config/ArtemisConfiguration.java\nindex 741ffd2513..e33108f5e8 100644\n--- a/util/src/main/java/tech/pegasys/artemis/util/config/ArtemisConfiguration.java\n+++ b/util/src/main/java/tech/pegasys/artemis/util/config/ArtemisConfiguration.java\n\n@@ -54,10 +56,15 @@ public class ArtemisConfiguration {\n     builder.addString(\"node.bootnodes\", \"\", \"ENR of the bootnode\", null);\n     builder.addString(\n         \"validator.validatorsKeyFile\", \"\", \"The file to load validator keys from\", null);\n-    builder.addString(\n-        \"validator.validatorsKeystoreConfFile\",\n-        \"\",\n-        \"The file containing paths to encrypted keystore files and password files to decrypt them\",\n+    builder.addListOfString(\n+        \"validator.validatorsKeystoreFiles\",\n+        Collections.emptyList(),\n+        \"The list of encrypted keystore files to load the validator keys from\",\n+        null);\n+    builder.addListOfString(\n+        \"validator.validatorsKeystorePasswordFiles\",\n+        Collections.emptyList(),\n+        \"The list of password files to decrypt the keystores\",\n         null);\n \n     builder.addInteger(\n"}}, {"oid": "916a3b39816703e83b6fd29bac3dc09e1be50d96", "url": "https://github.com/ConsenSys/teku/commit/916a3b39816703e83b6fd29bac3dc09e1be50d96", "message": "keystore files and keystore password files directly from artemis configuration instead of redirection to an intermediate configuration file\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-03-02T02:30:21Z", "type": "commit"}, {"oid": "10d1e89a88f737181ce4f6fda179e709f15b26c7", "url": "https://github.com/ConsenSys/teku/commit/10d1e89a88f737181ce4f6fda179e709f15b26c7", "message": "Merge remote-tracking branch 'upstream/master' into keystore_config_1176\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-03-02T03:12:17Z", "type": "commit"}, {"oid": "96750d85e012e0ec850196d5b91e9b425d72f0eb", "url": "https://github.com/ConsenSys/teku/commit/96750d85e012e0ec850196d5b91e9b425d72f0eb", "message": "Adding mock call to ValidatorCoordinatorTest\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-03-02T03:16:39Z", "type": "commit"}, {"oid": "696b6aee9f5bd6e0a59475b78c5cf8348ec19484", "url": "https://github.com/ConsenSys/teku/commit/696b6aee9f5bd6e0a59475b78c5cf8348ec19484", "message": "Merge remote-tracking branch 'upstream/master' into keystore_config_1176\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-03-02T04:16:30Z", "type": "commit"}, {"oid": "752162514afaa3347f926d72f875bfaf85233fd7", "url": "https://github.com/ConsenSys/teku/commit/752162514afaa3347f926d72f875bfaf85233fd7", "message": "Adding unit test cases for validator configurations\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-03-02T04:53:22Z", "type": "commit"}, {"oid": "f77e7b33f2cef47e3555ba18592d66283e2611ec", "url": "https://github.com/ConsenSys/teku/commit/f77e7b33f2cef47e3555ba18592d66283e2611ec", "message": "Modify option names\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-03-02T05:20:30Z", "type": "commit"}, {"oid": "8c3004cbe62ebbb432660ef9b2171756c2709861", "url": "https://github.com/ConsenSys/teku/commit/8c3004cbe62ebbb432660ef9b2171756c2709861", "message": "keystore validator key provider logic\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-03-02T05:59:11Z", "type": "commit"}, {"oid": "822a765eb50ee8cea8b7bbc31dd9b483b96039a5", "url": "https://github.com/ConsenSys/teku/commit/822a765eb50ee8cea8b7bbc31dd9b483b96039a5", "message": "unit test cases for Keystore validator key provider\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-03-02T07:15:20Z", "type": "commit"}, {"oid": "4e53948e8563833fceac2a966f28948192c818c6", "url": "https://github.com/ConsenSys/teku/commit/4e53948e8563833fceac2a966f28948192c818c6", "message": "wrapping key store validation exception to illegalargumentexception to allow reporting error during initialization\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-03-02T12:38:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjcyODY3MA==", "url": "https://github.com/ConsenSys/teku/pull/1249#discussion_r386728670", "bodyText": "You can just use:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                return new ArrayList<>(\n          \n          \n            \n                    keystorePasswordFilePairs.stream()\n          \n          \n            \n                        .map(\n          \n          \n            \n                            pair -> {\n          \n          \n            \n                              final String password = loadPassword(pair.getRight());\n          \n          \n            \n                              final Bytes privKey = loadBLSPrivateKey(pair.getLeft(), password);\n          \n          \n            \n                              return new BLSKeyPair(new KeyPair(SecretKey.fromBytes(padLeft(privKey))));\n          \n          \n            \n                            })\n          \n          \n            \n                        .collect(\n          \n          \n            \n                            toMap(\n          \n          \n            \n                                blsKeyPair -> blsKeyPair.getPublicKey().toString(),\n          \n          \n            \n                                Function.identity(),\n          \n          \n            \n                                (dupKey1, dupKey2) -> dupKey2))\n          \n          \n            \n                        .values());\n          \n          \n            \n                 return keystorePasswordFilePairs.stream()\n          \n          \n            \n                    .map(pair -> padLeft(loadBLSPrivateKey(pair.getLeft(), loadPassword(pair.getRight()))))\n          \n          \n            \n                    .distinct()\n          \n          \n            \n                    .map(privKey -> new BLSKeyPair(new KeyPair(SecretKey.fromBytes(privKey))))\n          \n          \n            \n                    .collect(toList());", "author": "ajsutton", "createdAt": "2020-03-03T00:14:42Z", "path": "validator/coordinator/src/main/java/tech/pegasys/artemis/validator/coordinator/KeystoresValidatorKeyProvider.java", "diffHunk": "@@ -0,0 +1,105 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.validator.coordinator;\n+\n+import static com.google.common.base.Preconditions.checkNotNull;\n+import static java.lang.String.format;\n+import static java.nio.charset.StandardCharsets.UTF_8;\n+import static java.util.stream.Collectors.toMap;\n+import static org.apache.commons.lang3.StringUtils.isEmpty;\n+import static tech.pegasys.artemis.util.alogger.ALogger.STDOUT;\n+\n+import com.google.common.io.Files;\n+import java.io.FileNotFoundException;\n+import java.io.IOException;\n+import java.io.UncheckedIOException;\n+import java.nio.file.Path;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.function.Function;\n+import org.apache.commons.lang3.tuple.Pair;\n+import org.apache.logging.log4j.Level;\n+import org.apache.tuweni.bytes.Bytes;\n+import tech.pegasys.artemis.bls.keystore.KeyStore;\n+import tech.pegasys.artemis.bls.keystore.KeyStoreLoader;\n+import tech.pegasys.artemis.bls.keystore.KeyStoreValidationException;\n+import tech.pegasys.artemis.bls.keystore.model.KeyStoreData;\n+import tech.pegasys.artemis.util.bls.BLSKeyPair;\n+import tech.pegasys.artemis.util.config.ArtemisConfiguration;\n+import tech.pegasys.artemis.util.mikuli.KeyPair;\n+import tech.pegasys.artemis.util.mikuli.SecretKey;\n+\n+public class KeystoresValidatorKeyProvider implements ValidatorKeyProvider {\n+  static final int KEY_LENGTH = 48;\n+\n+  @Override\n+  public List<BLSKeyPair> loadValidatorKeys(final ArtemisConfiguration config) {\n+    final List<Pair<Path, Path>> keystorePasswordFilePairs =\n+        config.getValidatorKeystorePasswordFilePairs();\n+    checkNotNull(keystorePasswordFilePairs, \"validator keystore and password pairs cannot be null\");\n+\n+    // return distinct loaded key pairs\n+\n+    return new ArrayList<>(\n+        keystorePasswordFilePairs.stream()\n+            .map(\n+                pair -> {\n+                  final String password = loadPassword(pair.getRight());\n+                  final Bytes privKey = loadBLSPrivateKey(pair.getLeft(), password);\n+                  return new BLSKeyPair(new KeyPair(SecretKey.fromBytes(padLeft(privKey))));\n+                })\n+            .collect(\n+                toMap(\n+                    blsKeyPair -> blsKeyPair.getPublicKey().toString(),\n+                    Function.identity(),\n+                    (dupKey1, dupKey2) -> dupKey2))\n+            .values());", "originalCommit": "4e53948e8563833fceac2a966f28948192c818c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjczMzkxNA==", "url": "https://github.com/ConsenSys/teku/pull/1249#discussion_r386733914", "bodyText": "very clever, i forgot we have distinct in streams api as well.", "author": "usmansaleem", "createdAt": "2020-03-03T00:31:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjcyODY3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjczNjc5OA==", "url": "https://github.com/ConsenSys/teku/pull/1249#discussion_r386736798", "bodyText": "in fact this has taken care of the reason why I used publickey as map key because BLsKeyPair was always getting multiple instances even with same private/public key (because of raw bytes comparison somewhere deep within).", "author": "usmansaleem", "createdAt": "2020-03-03T00:41:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjcyODY3MA=="}], "type": "inlineReview", "revised_code": {"commit": "2e80f940a77d75375b254bc5f80fc99125f2f5e7", "chunk": "diff --git a/validator/coordinator/src/main/java/tech/pegasys/artemis/validator/coordinator/KeystoresValidatorKeyProvider.java b/validator/coordinator/src/main/java/tech/pegasys/artemis/validator/coordinator/KeystoresValidatorKeyProvider.java\nindex 1f33f3527f..d6432d72cd 100644\n--- a/validator/coordinator/src/main/java/tech/pegasys/artemis/validator/coordinator/KeystoresValidatorKeyProvider.java\n+++ b/validator/coordinator/src/main/java/tech/pegasys/artemis/validator/coordinator/KeystoresValidatorKeyProvider.java\n\n@@ -16,7 +16,7 @@ package tech.pegasys.artemis.validator.coordinator;\n import static com.google.common.base.Preconditions.checkNotNull;\n import static java.lang.String.format;\n import static java.nio.charset.StandardCharsets.UTF_8;\n-import static java.util.stream.Collectors.toMap;\n+import static java.util.stream.Collectors.toList;\n import static org.apache.commons.lang3.StringUtils.isEmpty;\n import static tech.pegasys.artemis.util.alogger.ALogger.STDOUT;\n \n"}}, {"oid": "2e80f940a77d75375b254bc5f80fc99125f2f5e7", "url": "https://github.com/ConsenSys/teku/commit/2e80f940a77d75375b254bc5f80fc99125f2f5e7", "message": "review suggestion - simplifying loadValidatorKeys\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-03-03T00:33:09Z", "type": "commit"}, {"oid": "9a5db6b07f37bb93a1c046daa3c6ef6994ad3c9b", "url": "https://github.com/ConsenSys/teku/commit/9a5db6b07f37bb93a1c046daa3c6ef6994ad3c9b", "message": "Merge remote-tracking branch 'upstream/master' into keystore_config_1176\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-03-03T00:59:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njc0OTUzNA==", "url": "https://github.com/ConsenSys/teku/pull/1249#discussion_r386749534", "bodyText": "Be nice to pass in the values you are validating", "author": "jframe", "createdAt": "2020-03-03T01:24:52Z", "path": "util/src/main/java/tech/pegasys/artemis/util/config/ArtemisConfiguration.java", "diffHunk": "@@ -313,6 +360,20 @@ public void validateConfig() throws IllegalArgumentException {\n     if (getNumValidators() < Constants.SLOTS_PER_EPOCH) {\n       throw new IllegalArgumentException(\"Invalid config.toml\");\n     }\n+    validateKeyStoreFilesAndPasswordFilesSize();\n+  }\n+\n+  private void validateKeyStoreFilesAndPasswordFilesSize() {\n+    final List<String> validatorKeystoreFiles = getValidatorKeystoreFiles();", "originalCommit": "9a5db6b07f37bb93a1c046daa3c6ef6994ad3c9b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njc1MDE5OA==", "url": "https://github.com/ConsenSys/teku/pull/1249#discussion_r386750198", "bodyText": "Why does this need to be distinct? Is it an error if a user has duplicate validator keys?", "author": "jframe", "createdAt": "2020-03-03T01:27:09Z", "path": "validator/coordinator/src/main/java/tech/pegasys/artemis/validator/coordinator/KeystoresValidatorKeyProvider.java", "diffHunk": "@@ -0,0 +1,93 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.validator.coordinator;\n+\n+import static com.google.common.base.Preconditions.checkNotNull;\n+import static java.lang.String.format;\n+import static java.nio.charset.StandardCharsets.UTF_8;\n+import static java.util.stream.Collectors.toList;\n+import static org.apache.commons.lang3.StringUtils.isEmpty;\n+import static tech.pegasys.artemis.util.alogger.ALogger.STDOUT;\n+\n+import com.google.common.io.Files;\n+import java.io.FileNotFoundException;\n+import java.io.IOException;\n+import java.io.UncheckedIOException;\n+import java.nio.file.Path;\n+import java.util.List;\n+import org.apache.commons.lang3.tuple.Pair;\n+import org.apache.logging.log4j.Level;\n+import org.apache.tuweni.bytes.Bytes;\n+import tech.pegasys.artemis.bls.keystore.KeyStore;\n+import tech.pegasys.artemis.bls.keystore.KeyStoreLoader;\n+import tech.pegasys.artemis.bls.keystore.KeyStoreValidationException;\n+import tech.pegasys.artemis.bls.keystore.model.KeyStoreData;\n+import tech.pegasys.artemis.util.bls.BLSKeyPair;\n+import tech.pegasys.artemis.util.config.ArtemisConfiguration;\n+import tech.pegasys.artemis.util.mikuli.KeyPair;\n+import tech.pegasys.artemis.util.mikuli.SecretKey;\n+\n+public class KeystoresValidatorKeyProvider implements ValidatorKeyProvider {\n+  static final int KEY_LENGTH = 48;\n+\n+  @Override\n+  public List<BLSKeyPair> loadValidatorKeys(final ArtemisConfiguration config) {\n+    final List<Pair<Path, Path>> keystorePasswordFilePairs =\n+        config.getValidatorKeystorePasswordFilePairs();\n+    checkNotNull(keystorePasswordFilePairs, \"validator keystore and password pairs cannot be null\");\n+\n+    // return distinct loaded key pairs", "originalCommit": "9a5db6b07f37bb93a1c046daa3c6ef6994ad3c9b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njc2ODUyMw==", "url": "https://github.com/ConsenSys/teku/pull/1249#discussion_r386768523", "bodyText": "I suspect it will wind up going through a map and becoming distinct naturally anyway, but running two instances of the same validator is the quickest and easiest way to get yourself slashed, so making sure keys are distinct is a really good idea.", "author": "ajsutton", "createdAt": "2020-03-03T02:35:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njc1MDE5OA=="}], "type": "inlineReview", "revised_code": null}]}