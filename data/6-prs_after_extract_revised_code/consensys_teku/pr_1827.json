{"pr_number": 1827, "pr_title": "Faster G2 cofactor clearing and membership checks", "pr_createdAt": "2020-05-20T11:55:54Z", "pr_url": "https://github.com/ConsenSys/teku/pull/1827", "timeline": [{"oid": "c6401d2b67e82c75d90dcd4954993fed12a16f84", "url": "https://github.com/ConsenSys/teku/commit/c6401d2b67e82c75d90dcd4954993fed12a16f84", "message": "Implement fast version of clear_h2()", "committedDate": "2020-04-02T17:09:02Z", "type": "commit"}, {"oid": "11b2b299f3b0127f2bf85410281ecb42f6a4c377", "url": "https://github.com/ConsenSys/teku/commit/11b2b299f3b0127f2bf85410281ecb42f6a4c377", "message": "SpotlessApply", "committedDate": "2020-04-02T17:20:50Z", "type": "commit"}, {"oid": "2f0c316a80d7379d04ec35dc19717868fa7d17c8", "url": "https://github.com/ConsenSys/teku/commit/2f0c316a80d7379d04ec35dc19717868fa7d17c8", "message": "Faster cofactor clearing and subgroup check for G2", "committedDate": "2020-05-20T10:38:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODIzMTkxMw==", "url": "https://github.com/ConsenSys/teku/pull/1827#discussion_r428231913", "bodyText": "(nit) Might be a good idea to make the methods that are directly used in production public, and either mark the other methods private or keep them package-private and annotate them with @VisibleForTesting.  This just makes it easier to see which methods are internal-only vs used externally.", "author": "mbaxter", "createdAt": "2020-05-20T18:42:36Z", "path": "bls/src/main/java/tech/pegasys/teku/bls/hashToG2/Helper.java", "diffHunk": "@@ -54,14 +58,25 @@ static boolean isOnCurve(JacobianPoint p) {\n   /**\n    * Tests whether the given point lies in the G2 group.\n    *\n-   * <p>Once the GLV patent has expired we can replace the qChain with the endomorphism here:\n-   * https://eprint.iacr.org/2019/814.pdf\n-   *\n    * @param p a JacobianPoint\n    * @return true if the point is in G2, false otherwise\n    */\n   static boolean isInG2(JacobianPoint p) {", "originalCommit": "2f0c316a80d7379d04ec35dc19717868fa7d17c8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI5ODM3OQ==", "url": "https://github.com/ConsenSys/teku/pull/1827#discussion_r428298379", "bodyText": "I'll be doing another pass through everything for the v0.12 update, and will consider holding my nose and adding @VisibleForTesting to everything. Very little can be marked private currently as just about every method has a corresponding unit test.\nThis is another reason I try not to write too much Java \ud83d\ude1b.", "author": "benjaminion", "createdAt": "2020-05-20T20:48:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODIzMTkxMw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODIzODc5Nw==", "url": "https://github.com/ConsenSys/teku/pull/1827#discussion_r428238797", "bodyText": "(optional) Might be worth running this a few times, although looks like we have another test that basically does this already.", "author": "mbaxter", "createdAt": "2020-05-20T18:55:02Z", "path": "bls/src/test/java/tech/pegasys/teku/bls/hashToG2/HelperTest.java", "diffHunk": "@@ -206,8 +212,32 @@ void clearH2Test() {\n   }\n \n   @Test\n-  void pointIsInG2() {\n+  void clearH2TestCompare() {\n+    // Check that the implementation of clear_h2() matches the slower method for an arbitrary point\n     JacobianPoint a =\n+        new JacobianPoint(\n+            new FP2Immutable(\n+                \"0x0c8977fab5175ac2f09e5f39e29d016f11c094ef10f237d2a5e23f482d0bfb4466688527cd31685bfe481725c31462cc\",\n+                \"0x0b305838069012861bb63501841c91bd5bc7e1359d44cd196681fb14c03e544c22205bced326d490eb886aaa3ed52918\"),\n+            new FP2Immutable(\n+                \"0x172cf997b3501882861c07e852fadbf5753eb8a3e1d2ce375e6aed07cf9c1b5ff1cbf1124c6e3b0cf4607c683eafd1a4\",\n+                \"0x0d9dacf241a753d55cff6d45b568b716a2ad68ba29d23f92dea6e7cf6ed54e96cdac4a2b95213f93439b946ebc63349c\"),\n+            new FP2Immutable(\n+                \"0x05594bb289f0ebfd8fa3f020c6e1eaf4c49b97d8ccaf3470a3a02da4b3e7104778105bd6c7e0caf97206c77a8b501d4d\",\n+                \"0x0625151f905fad40eb0e2b9b0a46d9afe531256c6d5e39897a27d94700f037a761a741d11275180bd18e620289e02a16\"));\n+    assertEquals(clear_h2_slow(a), clear_h2(a));\n+  }\n+\n+  @Test\n+  void G2MapToInfinityTest() {\n+    // The generator point of G2 is certainly in G2\n+    JacobianPoint g2Generator = new JacobianPoint(ECP2.generator());\n+    assertTrue(g2_map_to_infinity(g2Generator).isInfinity());", "originalCommit": "2f0c316a80d7379d04ec35dc19717868fa7d17c8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI5OTI0NQ==", "url": "https://github.com/ConsenSys/teku/pull/1827#discussion_r428299245", "bodyText": "Yes, this is just a quick unit test to catch if it get's broken somehow. The smoke test exercises things more thoroughly.", "author": "benjaminion", "createdAt": "2020-05-20T20:50:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODIzODc5Nw=="}], "type": "inlineReview", "revised_code": null}, {"oid": "e8a0125e935397831794673f951f21afd5104cd1", "url": "https://github.com/ConsenSys/teku/commit/e8a0125e935397831794673f951f21afd5104cd1", "message": "Merge branch 'master' into faster-g2", "committedDate": "2020-05-20T20:50:20Z", "type": "commit"}, {"oid": "794baa8b400e07e39f9888e4e869a5918216ba8f", "url": "https://github.com/ConsenSys/teku/commit/794baa8b400e07e39f9888e4e869a5918216ba8f", "message": "Merge branch 'master' into faster-g2", "committedDate": "2020-05-20T20:58:30Z", "type": "commit"}]}