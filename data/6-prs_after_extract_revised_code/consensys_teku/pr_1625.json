{"pr_number": 1625, "pr_title": "Recalculate duties when a reorg occurs", "pr_createdAt": "2020-04-20T04:41:42Z", "pr_url": "https://github.com/ConsenSys/teku/pull/1625", "timeline": [{"oid": "b6fa7b1fc64fda8b2db9a722b6f0e7e5e8e7faa0", "url": "https://github.com/ConsenSys/teku/commit/b6fa7b1fc64fda8b2db9a722b6f0e7e5e8e7faa0", "message": "Recalculate duties when a reorg occurs.", "committedDate": "2020-04-20T04:34:59Z", "type": "commit"}, {"oid": "4463fa89943c7c6ef82b634ff1ddfb936cfab81c", "url": "https://github.com/ConsenSys/teku/commit/4463fa89943c7c6ef82b634ff1ddfb936cfab81c", "message": "Remove static NONE.", "committedDate": "2020-04-20T04:40:29Z", "type": "commit"}, {"oid": "ce19ac17955858fba85bc5ea90812ddb0cece27b", "url": "https://github.com/ConsenSys/teku/commit/ce19ac17955858fba85bc5ea90812ddb0cece27b", "message": "Remove toString.", "committedDate": "2020-04-20T04:41:09Z", "type": "commit"}, {"oid": "622a558f7519e16b2d826bd1e776626a64be7093", "url": "https://github.com/ConsenSys/teku/commit/622a558f7519e16b2d826bd1e776626a64be7093", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into duties-on-reorg", "committedDate": "2020-04-20T04:42:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQ1OTQwOQ==", "url": "https://github.com/ConsenSys/teku/pull/1625#discussion_r411459409", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                final ValidatorTimingChannel validatorClient =\n          \n          \n            \n                final ValidatorTimingChannel validatorTimingChannel =", "author": "mbaxter", "createdAt": "2020-04-20T15:12:51Z", "path": "validator/client/src/main/java/tech/pegasys/artemis/validator/client/ValidatorClientService.java", "diffHunk": "@@ -48,10 +48,14 @@ public static ValidatorClientService create(final ServiceConfig config) {\n         ValidatorLoader.initializeValidators(config.getConfig());\n     final ValidatorDutyFactory validatorDutyFactory =\n         new ValidatorDutyFactory(forkProvider, validatorApiChannel);\n-    final ScheduledDuties scheduledDuties = new ScheduledDuties(validatorDutyFactory);\n-    final DutyScheduler validatorClient =\n+    final ValidatorTimingChannel validatorClient =", "originalCommit": "622a558f7519e16b2d826bd1e776626a64be7093", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "373951c8224d17005519c4e4dd9845fbaee83e87", "chunk": "diff --git a/validator/client/src/main/java/tech/pegasys/artemis/validator/client/ValidatorClientService.java b/validator/client/src/main/java/tech/pegasys/artemis/validator/client/ValidatorClientService.java\nindex 8175127ac6..0660251f53 100644\n--- a/validator/client/src/main/java/tech/pegasys/artemis/validator/client/ValidatorClientService.java\n+++ b/validator/client/src/main/java/tech/pegasys/artemis/validator/client/ValidatorClientService.java\n\n@@ -48,7 +48,7 @@ public class ValidatorClientService extends Service {\n         ValidatorLoader.initializeValidators(config.getConfig());\n     final ValidatorDutyFactory validatorDutyFactory =\n         new ValidatorDutyFactory(forkProvider, validatorApiChannel);\n-    final ValidatorTimingChannel validatorClient =\n+    final DutyScheduler dutyScheduler =\n         new DutyScheduler(\n             new EpochDutiesScheduler(\n                 asyncRunner,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQ2Mjc0OQ==", "url": "https://github.com/ConsenSys/teku/pull/1625#discussion_r411462749", "bodyText": "Do we need to make sure to refresh the fork info when a reorg occurs?", "author": "mbaxter", "createdAt": "2020-04-20T15:16:47Z", "path": "validator/client/src/main/java/tech/pegasys/artemis/validator/client/EpochDutiesScheduler.java", "diffHunk": "@@ -0,0 +1,189 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.validator.client;\n+\n+import com.google.common.base.Throwables;\n+import com.google.common.primitives.UnsignedLong;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.concurrent.TimeUnit;\n+import java.util.function.Supplier;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import tech.pegasys.artemis.bls.BLSPublicKey;\n+import tech.pegasys.artemis.datastructures.operations.Attestation;\n+import tech.pegasys.artemis.datastructures.util.CommitteeUtil;\n+import tech.pegasys.artemis.util.async.AsyncRunner;\n+import tech.pegasys.artemis.util.async.SafeFuture;\n+import tech.pegasys.artemis.validator.api.NodeSyncingException;\n+import tech.pegasys.artemis.validator.api.ValidatorApiChannel;\n+import tech.pegasys.artemis.validator.api.ValidatorDuties;\n+import tech.pegasys.artemis.validator.client.duties.ScheduledDuties;\n+\n+class EpochDutiesScheduler {\n+  private static final Logger LOG = LogManager.getLogger();\n+  private final AsyncRunner asyncRunner;\n+  private final ValidatorApiChannel validatorApiChannel;\n+  private final ForkProvider forkProvider;", "originalCommit": "622a558f7519e16b2d826bd1e776626a64be7093", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTcwMTM5OA==", "url": "https://github.com/ConsenSys/teku/pull/1625#discussion_r411701398", "bodyText": "I don't think so.  The Fork data includes both \"current\" and \"previous\" forks and which epoch \"current\" takes effect.  Forks would be scheduled well in advance (and would require upgraded client software) so even if the reorg activated or deactivated a fork, the actual Fork data would still be the same - just a question of whether we are now before or after the appropriate epoch.", "author": "ajsutton", "createdAt": "2020-04-20T21:22:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQ2Mjc0OQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQ2MzQ3NQ==", "url": "https://github.com/ConsenSys/teku/pull/1625#discussion_r411463475", "bodyText": "Nice refactor :D", "author": "mbaxter", "createdAt": "2020-04-20T15:17:47Z", "path": "validator/client/src/main/java/tech/pegasys/artemis/validator/client/DutyScheduler.java", "diffHunk": "@@ -16,232 +16,65 @@\n import static com.google.common.primitives.UnsignedLong.ONE;\n import static tech.pegasys.artemis.datastructures.util.BeaconStateUtil.compute_epoch_at_slot;\n \n-import com.google.common.base.Throwables;\n import com.google.common.primitives.UnsignedLong;\n-import java.util.Map;\n-import java.util.Optional;\n-import java.util.concurrent.ConcurrentHashMap;\n-import java.util.concurrent.ConcurrentMap;\n-import java.util.concurrent.TimeUnit;\n-import java.util.concurrent.atomic.AtomicReference;\n-import java.util.function.Consumer;\n-import org.apache.logging.log4j.LogManager;\n-import org.apache.logging.log4j.Logger;\n-import tech.pegasys.artemis.bls.BLSPublicKey;\n-import tech.pegasys.artemis.datastructures.operations.Attestation;\n-import tech.pegasys.artemis.datastructures.util.CommitteeUtil;\n-import tech.pegasys.artemis.util.async.AsyncRunner;\n-import tech.pegasys.artemis.util.async.SafeFuture;\n-import tech.pegasys.artemis.util.config.Constants;\n-import tech.pegasys.artemis.validator.api.NodeSyncingException;\n-import tech.pegasys.artemis.validator.api.ValidatorApiChannel;\n-import tech.pegasys.artemis.validator.api.ValidatorDuties;\n+import java.util.NavigableMap;\n+import java.util.TreeMap;\n+import java.util.function.BiConsumer;\n import tech.pegasys.artemis.validator.api.ValidatorTimingChannel;\n-import tech.pegasys.artemis.validator.client.duties.ScheduledDuties;\n \n public class DutyScheduler implements ValidatorTimingChannel {", "originalCommit": "622a558f7519e16b2d826bd1e776626a64be7093", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "5625b0dbc6df51a98b1a2e7a238431fa6e3aac0d", "url": "https://github.com/ConsenSys/teku/commit/5625b0dbc6df51a98b1a2e7a238431fa6e3aac0d", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into duties-on-reorg", "committedDate": "2020-04-20T21:20:04Z", "type": "commit"}, {"oid": "373951c8224d17005519c4e4dd9845fbaee83e87", "url": "https://github.com/ConsenSys/teku/commit/373951c8224d17005519c4e4dd9845fbaee83e87", "message": "Rename.", "committedDate": "2020-04-20T21:23:09Z", "type": "commit"}, {"oid": "88157edf2b4c71516a601b002019f35d6e0591c5", "url": "https://github.com/ConsenSys/teku/commit/88157edf2b4c71516a601b002019f35d6e0591c5", "message": "Send logs to console.", "committedDate": "2020-04-20T22:59:49Z", "type": "commit"}, {"oid": "8d10467f9893e4fc5fc70df1e33b9fb85930e7f1", "url": "https://github.com/ConsenSys/teku/commit/8d10467f9893e4fc5fc70df1e33b9fb85930e7f1", "message": "Merge branch 'master' into duties-on-reorg", "committedDate": "2020-04-20T23:47:22Z", "type": "commit"}]}