{"pr_number": 13859, "pr_title": "[FLINK-19902][coordination][tests] Adjust JobMasterTest to be compatible with declarative resource management", "pr_createdAt": "2020-10-30T11:28:24Z", "pr_url": "https://github.com/apache/flink/pull/13859", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODE4OTM5Mw==", "url": "https://github.com/apache/flink/pull/13859#discussion_r518189393", "bodyText": "This is a busy waiting loop, right? Maybe we can add a pause.", "author": "tillrohrmann", "createdAt": "2020-11-05T16:33:29Z", "path": "flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/JobMasterTest.java", "diffHunk": "@@ -962,30 +952,23 @@ public void testSlotRequestTimeoutWhenNoSlotOffering() throws Exception {\n \n \t\t\tjobMasterGateway.registerTaskManager(taskExecutorGateway.getAddress(), taskManagerUnresolvedLocation, testingTimeout).get();\n \n-\t\t\t// wait for the slot request timeout\n-\t\t\tfinal SlotRequest slotRequest = blockingQueue.take();\n+\t\t\t// wait for the job to restart, due to the slot request timing out\n+\t\t\twhile (jobMasterGateway.requestJob(testingTimeout).join().getStatusTimestamp(JobStatus.RESTARTING) <= 0) {}", "originalCommit": "30a05a4fe4a92077162d823bc115413141fdeb57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODE5MjYxMg==", "url": "https://github.com/apache/flink/pull/13859#discussion_r518192612", "bodyText": "You might also use CommonTestUtils.waitUntilCondition.", "author": "tillrohrmann", "createdAt": "2020-11-05T16:37:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODE4OTM5Mw=="}], "type": "inlineReview", "revised_code": {"commit": "c0a258918865e4383c06f7048e6523d8d13aacb0", "chunk": "diff --git a/flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/JobMasterTest.java b/flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/JobMasterTest.java\nindex deab7a9778a..9bd08da2d62 100644\n--- a/flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/JobMasterTest.java\n+++ b/flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/JobMasterTest.java\n\n@@ -953,7 +953,10 @@ public class JobMasterTest extends TestLogger {\n \t\t\tjobMasterGateway.registerTaskManager(taskExecutorGateway.getAddress(), taskManagerUnresolvedLocation, testingTimeout).get();\n \n \t\t\t// wait for the job to restart, due to the slot request timing out\n-\t\t\twhile (jobMasterGateway.requestJob(testingTimeout).join().getStatusTimestamp(JobStatus.RESTARTING) <= 0) {}\n+\t\t\tCommonTestUtils.waitUntilCondition(\n+\t\t\t\t\t() -> jobMasterGateway.requestJob(testingTimeout).join().getStatusTimestamp(JobStatus.RESTARTING) <= 0,\n+\t\t\t\t\tDeadline.fromNow(Duration.ofSeconds(5)),\n+\t\t\t\t\t50L);\n \t\t\tfinal long end = System.nanoTime();\n \n \t\t\t// we rely on the slot request timeout to fail a stuck scheduling operation\n"}}, {"oid": "c0a258918865e4383c06f7048e6523d8d13aacb0", "url": "https://github.com/apache/flink/commit/c0a258918865e4383c06f7048e6523d8d13aacb0", "message": "[FLINK-19902][coordination][tests] Adjust JobMasterTest to be compatible with declarative resource management", "committedDate": "2020-11-06T09:16:25Z", "type": "commit"}, {"oid": "c0a258918865e4383c06f7048e6523d8d13aacb0", "url": "https://github.com/apache/flink/commit/c0a258918865e4383c06f7048e6523d8d13aacb0", "message": "[FLINK-19902][coordination][tests] Adjust JobMasterTest to be compatible with declarative resource management", "committedDate": "2020-11-06T09:16:25Z", "type": "forcePushed"}]}