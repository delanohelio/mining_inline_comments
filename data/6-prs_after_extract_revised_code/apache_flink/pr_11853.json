{"pr_number": 11853, "pr_title": "[FLINK-15006][table-planner] Add option to shuffle-by-partition when dynamic inserting", "pr_createdAt": "2020-04-22T06:22:35Z", "pr_url": "https://github.com/apache/flink/pull/11853", "timeline": [{"oid": "258a96c64c409102c679382b054d17602df65953", "url": "https://github.com/apache/flink/commit/258a96c64c409102c679382b054d17602df65953", "message": "[FLINK-15006][table-planner] Add option to shuffle-by-partition when dynamic partition inserting", "committedDate": "2020-04-24T03:57:11Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDYzNDg4Mw==", "url": "https://github.com/apache/flink/pull/11853#discussion_r414634883", "bodyText": "How about this \uff1f\"The option to enable shuffle data by dynamic partition fields in sink phase, this can greatly reduce the number of file for filesystem sink but may lead data skew, the default value is disabled.\"", "author": "leonardBang", "createdAt": "2020-04-24T14:48:24Z", "path": "flink-table/flink-table-runtime-blink/src/main/java/org/apache/flink/table/filesystem/FileSystemTableFactory.java", "diffHunk": "@@ -71,6 +71,12 @@\n \t\t\t.withDescription(\"The default partition name in case the dynamic partition\" +\n \t\t\t\t\t\" column value is null/empty string\");\n \n+\tpublic static final ConfigOption<Boolean> SINK_SHUFFLE_BY_PARTITION = key(\"sink.shuffle-by-partition.enable\")\n+\t\t\t.booleanType()\n+\t\t\t.defaultValue(false)\n+\t\t\t.withDescription(\"Before sink, can shuffle by dynamic partition fields to sink parallelisms,\" +\n+\t\t\t\t\t\" this can greatly reduce the number of files. But will lead to data skew too.\");\n+", "originalCommit": "258a96c64c409102c679382b054d17602df65953", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "44db9715e7ff6ba4f650eea1cff50bf2cb769f7a", "chunk": "diff --git a/flink-table/flink-table-runtime-blink/src/main/java/org/apache/flink/table/filesystem/FileSystemTableFactory.java b/flink-table/flink-table-runtime-blink/src/main/java/org/apache/flink/table/filesystem/FileSystemTableFactory.java\nindex d81ec7b67dc..4ade3e000cd 100644\n--- a/flink-table/flink-table-runtime-blink/src/main/java/org/apache/flink/table/filesystem/FileSystemTableFactory.java\n+++ b/flink-table/flink-table-runtime-blink/src/main/java/org/apache/flink/table/filesystem/FileSystemTableFactory.java\n\n@@ -71,11 +71,22 @@ public class FileSystemTableFactory implements\n \t\t\t.withDescription(\"The default partition name in case the dynamic partition\" +\n \t\t\t\t\t\" column value is null/empty string\");\n \n+\tpublic static final ConfigOption<Long> SINK_ROLLING_POLICY_FILE_SIZE = key(\"sink.rolling-policy.file-size\")\n+\t\t\t.longType()\n+\t\t\t.defaultValue(1024L * 1024L * 128L)\n+\t\t\t.withDescription(\"The maximum part file size before rolling (by default 128MB).\");\n+\n+\tpublic static final ConfigOption<Long> SINK_ROLLING_POLICY_TIME_INTERVAL = key(\"sink.rolling-policy.time.interval\")\n+\t\t\t.longType()\n+\t\t\t.defaultValue(60L * 1000L)\n+\t\t\t.withDescription(\"The maximum time duration a part file can stay open before rolling (by default 60 sec).\");\n+\n \tpublic static final ConfigOption<Boolean> SINK_SHUFFLE_BY_PARTITION = key(\"sink.shuffle-by-partition.enable\")\n \t\t\t.booleanType()\n \t\t\t.defaultValue(false)\n-\t\t\t.withDescription(\"Before sink, can shuffle by dynamic partition fields to sink parallelisms,\" +\n-\t\t\t\t\t\" this can greatly reduce the number of files. But will lead to data skew too.\");\n+\t\t\t.withDescription(\"The option to enable shuffle data by dynamic partition fields in sink\" +\n+\t\t\t\t\t\" phase, this can greatly reduce the number of file for filesystem sink but may\" +\n+\t\t\t\t\t\" lead data skew, the default value is disabled.\");\n \n \t@Override\n \tpublic Map<String, String> requiredContext() {\n"}}, {"oid": "44db9715e7ff6ba4f650eea1cff50bf2cb769f7a", "url": "https://github.com/apache/flink/commit/44db9715e7ff6ba4f650eea1cff50bf2cb769f7a", "message": "[FLINK-15006][table-planner] Add option to shuffle-by-partition when dynamic partition inserting", "committedDate": "2020-04-26T05:09:29Z", "type": "commit"}, {"oid": "44db9715e7ff6ba4f650eea1cff50bf2cb769f7a", "url": "https://github.com/apache/flink/commit/44db9715e7ff6ba4f650eea1cff50bf2cb769f7a", "message": "[FLINK-15006][table-planner] Add option to shuffle-by-partition when dynamic partition inserting", "committedDate": "2020-04-26T05:09:29Z", "type": "forcePushed"}, {"oid": "d131987407d758558ea29386d9e1d8a100625a28", "url": "https://github.com/apache/flink/commit/d131987407d758558ea29386d9e1d8a100625a28", "message": "minor", "committedDate": "2020-04-26T05:11:33Z", "type": "commit"}]}