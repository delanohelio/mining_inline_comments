{"pr_number": 11868, "pr_title": " [FLINK-17258][tests] Enabling unaligned checkpoint in all tests by default", "pr_createdAt": "2020-04-22T19:20:02Z", "pr_url": "https://github.com/apache/flink/pull/11868", "timeline": [{"oid": "62d69e24f84ee20cf72159c7fc237e605939127b", "url": "https://github.com/apache/flink/commit/62d69e24f84ee20cf72159c7fc237e605939127b", "message": "run all tests", "committedDate": "2020-04-29T19:29:13Z", "type": "forcePushed"}, {"oid": "1ed80167a0655c9fb579e93cd94a49517eaa9b42", "url": "https://github.com/apache/flink/commit/1ed80167a0655c9fb579e93cd94a49517eaa9b42", "message": "run all tests", "committedDate": "2020-04-29T20:36:30Z", "type": "forcePushed"}, {"oid": "3e9d1f3e44586ee55f3f21866d2f6c3fec2cfa57", "url": "https://github.com/apache/flink/commit/3e9d1f3e44586ee55f3f21866d2f6c3fec2cfa57", "message": "run all tests", "committedDate": "2020-04-30T06:50:54Z", "type": "forcePushed"}, {"oid": "18dae971690bacdf06b98112b0601ff811af845c", "url": "https://github.com/apache/flink/commit/18dae971690bacdf06b98112b0601ff811af845c", "message": "run all tests", "committedDate": "2020-04-30T07:33:19Z", "type": "forcePushed"}, {"oid": "b2cc73752f5b68fbaee9f4dc7a8386662570b8c9", "url": "https://github.com/apache/flink/commit/b2cc73752f5b68fbaee9f4dc7a8386662570b8c9", "message": "run all tests", "committedDate": "2020-05-12T21:59:17Z", "type": "forcePushed"}, {"oid": "3cdcb4d692b6858521b91fc35c66968e2a083f2f", "url": "https://github.com/apache/flink/commit/3cdcb4d692b6858521b91fc35c66968e2a083f2f", "message": "[temp] Run all tests", "committedDate": "2020-05-13T09:38:32Z", "type": "forcePushed"}, {"oid": "a0003fcda21e117347201de8e438930af942ebb5", "url": "https://github.com/apache/flink/commit/a0003fcda21e117347201de8e438930af942ebb5", "message": "[temp] Run all tests", "committedDate": "2020-05-13T11:07:35Z", "type": "forcePushed"}, {"oid": "c0b977fa422b664ab99d6635163cdcce1a12e3c6", "url": "https://github.com/apache/flink/commit/c0b977fa422b664ab99d6635163cdcce1a12e3c6", "message": "[temp] Run all tests", "committedDate": "2020-05-13T11:17:47Z", "type": "forcePushed"}, {"oid": "96e3d0b5ef65a61fee4d87c10a9f46c68a66ee0e", "url": "https://github.com/apache/flink/commit/96e3d0b5ef65a61fee4d87c10a9f46c68a66ee0e", "message": "[hotfix][configuration] CheckpointConfig#disableUnalignedCheckpoints actually disables", "committedDate": "2020-06-09T13:16:23Z", "type": "forcePushed"}, {"oid": "f70161c2fb957268a15e651c06025f205cd5de0f", "url": "https://github.com/apache/flink/commit/f70161c2fb957268a15e651c06025f205cd5de0f", "message": "[hotfix][configuration] CheckpointConfig#disableUnalignedCheckpoints actually disables", "committedDate": "2020-06-10T09:45:02Z", "type": "forcePushed"}, {"oid": "5e0ee9d37266b84ba2b0944dce19febca7fc66c9", "url": "https://github.com/apache/flink/commit/5e0ee9d37266b84ba2b0944dce19febca7fc66c9", "message": "[FLINK-17218][tests] Disable unaligned checkpoint for externalized checkpoints.", "committedDate": "2020-06-11T18:40:22Z", "type": "forcePushed"}, {"oid": "630eb3fde0a46398a0c05ee74fa242bfb9bfe7ff", "url": "https://github.com/apache/flink/commit/630eb3fde0a46398a0c05ee74fa242bfb9bfe7ff", "message": "[FLINK-17218][tests] Disable unaligned checkpoint for externalized checkpoints.", "committedDate": "2020-06-12T08:45:59Z", "type": "forcePushed"}, {"oid": "bb82d064832f65f0aecba46d48bc2b6ecba04b1e", "url": "https://github.com/apache/flink/commit/bb82d064832f65f0aecba46d48bc2b6ecba04b1e", "message": "[FLINK-18094][checkpointing] Unifies the creation of BarrierHandlers and CheckpointedInputGate.\n\nFor multi-gate inputs, there existed inconsistent offset handling of BarrierHandlers and CheckpointedInputGates for unaligned checkpoints.\nThis commit uses the non-unioned (Indexed)InputGates as the main information source that is needed to create handlers.\nUnioned input gates are only used to create the CheckpointedInputGate.", "committedDate": "2020-06-12T10:00:42Z", "type": "forcePushed"}, {"oid": "d386861a97fa22ddf5d341e2866e6e71462447a5", "url": "https://github.com/apache/flink/commit/d386861a97fa22ddf5d341e2866e6e71462447a5", "message": "[FLINK-17258][tests] Enabling unaligned checkpoint in all tests by default.\n\nOverWindowITCase disables unaligned checkpoint because currently watermarks are not handled correctly on recovery.\nExternalized checkpoints disables unaligned checkpoint on rescaling as rescaling from unaligned checkpoints is not supported yet.", "committedDate": "2020-06-16T08:10:48Z", "type": "forcePushed"}, {"oid": "2e55484af53240b19097d2536853b09c575f06d4", "url": "https://github.com/apache/flink/commit/2e55484af53240b19097d2536853b09c575f06d4", "message": "[FLINK-17258][tests] Enabling unaligned checkpoint in all tests by default.\n\nOverWindowITCase disables unaligned checkpoint because currently watermarks are not handled correctly on recovery.\nExternalized checkpoints disables unaligned checkpoint on rescaling as rescaling from unaligned checkpoints is not supported yet.", "committedDate": "2020-06-17T14:18:24Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA5NzYyMg==", "url": "https://github.com/apache/flink/pull/11868#discussion_r442097622", "bodyText": "Do we really need this method? Isn't enableUnalignedCheckpoints(false); enough? enableUnalignedCheckpoints() also is kind of redundant but probably more common.\nFor another boolean property we have just a single setter setPreferCheckpointForRecovery", "author": "pnowojski", "createdAt": "2020-06-18T09:34:26Z", "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/api/environment/CheckpointConfig.java", "diffHunk": "@@ -414,9 +417,19 @@ public void enableUnalignedCheckpoints() {\n \t}\n \n \t/**\n-\t * Returns whether checkpoints should be persisted externally.\n+\t * Disables unaligned checkpoints.\n \t *\n-\t * @return <code>true</code> if checkpoints should be externalized.\n+\t * @see #enableUnalignedCheckpoints()\n+\t */\n+\t@PublicEvolving\n+\tpublic void disableUnalignedCheckpoints() {", "originalCommit": "2e55484af53240b19097d2536853b09c575f06d4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg2MDA0NQ==", "url": "https://github.com/apache/flink/pull/11868#discussion_r442860045", "bodyText": "No we don't need it and I have no hard feelings for removing it.\ndisableUnalignedCheckpoints would be relevant when UC becomes the default (see also StreamExecutionEnvironment#disableOperatorChaining).", "author": "AHeise", "createdAt": "2020-06-19T14:04:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA5NzYyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjkzODgyOQ==", "url": "https://github.com/apache/flink/pull/11868#discussion_r442938829", "bodyText": "would be relevant when UC becomes the default\n\nThat's a point, but maybe more in favour of dropping enableUnalignedCheckpoints ()? What about keeping and using just setUnalignedCheckpoints(boolean) (without the Enable infix)?", "author": "pnowojski", "createdAt": "2020-06-19T16:31:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA5NzYyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzM3MzQ1NQ==", "url": "https://github.com/apache/flink/pull/11868#discussion_r443373455", "bodyText": "Yes, I'd probably go this way. Should we mend that also on 1.11?", "author": "AHeise", "createdAt": "2020-06-22T07:45:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA5NzYyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQ5MzEyNQ==", "url": "https://github.com/apache/flink/pull/11868#discussion_r443493125", "bodyText": "Extracted FLINK-18403, which will be backported (while this PR should only go to master).", "author": "AHeise", "createdAt": "2020-06-22T11:29:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA5NzYyMg=="}], "type": "inlineReview", "revised_code": {"commit": "54bb898e9c5616e615fd2660b2ddef5281900277", "chunk": "diff --git a/flink-streaming-java/src/main/java/org/apache/flink/streaming/api/environment/CheckpointConfig.java b/flink-streaming-java/src/main/java/org/apache/flink/streaming/api/environment/CheckpointConfig.java\nindex ba81710afc..7d23a05cfb 100644\n--- a/flink-streaming-java/src/main/java/org/apache/flink/streaming/api/environment/CheckpointConfig.java\n+++ b/flink-streaming-java/src/main/java/org/apache/flink/streaming/api/environment/CheckpointConfig.java\n\n@@ -402,34 +399,9 @@ public class CheckpointConfig implements java.io.Serializable {\n \t}\n \n \t/**\n-\t * Enables unaligned checkpoints, which greatly reduce checkpointing times under backpressure.\n-\t *\n-\t * <p>Unaligned checkpoints contain data stored in buffers as part of the checkpoint state, which allows\n-\t * checkpoint barriers to overtake these buffers. Thus, the checkpoint duration becomes independent of the\n-\t * current throughput as checkpoint barriers are effectively not embedded into the stream of data anymore.\n-\t *\n-\t * <p>Unaligned checkpoints can only be enabled if {@link #checkpointingMode} is\n-\t * {@link CheckpointingMode#EXACTLY_ONCE}.\n-\t */\n-\t@PublicEvolving\n-\tpublic void enableUnalignedCheckpoints() {\n-\t\tenableUnalignedCheckpoints(true);\n-\t}\n-\n-\t/**\n-\t * Disables unaligned checkpoints.\n-\t *\n-\t * @see #enableUnalignedCheckpoints()\n-\t */\n-\t@PublicEvolving\n-\tpublic void disableUnalignedCheckpoints() {\n-\t\tenableUnalignedCheckpoints(false);\n-\t}\n-\n-\t/**\n-\t * Returns whether unaligned checkpoints are enabled.\n+\t * Returns whether checkpoints should be persisted externally.\n \t *\n-\t * @return <code>true</code> if unaligned checkpoints are enabled.\n+\t * @return <code>true</code> if checkpoints should be externalized.\n \t */\n \t@PublicEvolving\n \tpublic boolean isUnalignedCheckpointsEnabled() {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA5Nzk2Mg==", "url": "https://github.com/apache/flink/pull/11868#discussion_r442097962", "bodyText": "Isn't this an independent bug fix?", "author": "pnowojski", "createdAt": "2020-06-18T09:35:00Z", "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/api/graph/StreamingJobGraphGenerator.java", "diffHunk": "@@ -500,8 +500,9 @@ private void setVertexConfig(Integer vertexID, StreamConfig config,\n \n \t\tconfig.setStateBackend(streamGraph.getStateBackend());\n \t\tconfig.setCheckpointingEnabled(checkpointCfg.isCheckpointingEnabled());\n-\t\tconfig.setUnalignedCheckpointsEnabled(checkpointCfg.isUnalignedCheckpointsEnabled());\n \t\tconfig.setCheckpointMode(getCheckpointingMode(checkpointCfg));\n+\t\tconfig.setUnalignedCheckpointsEnabled(config.getCheckpointMode() == CheckpointingMode.EXACTLY_ONCE &&", "originalCommit": "2e55484af53240b19097d2536853b09c575f06d4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg2Mjk2MA==", "url": "https://github.com/apache/flink/pull/11868#discussion_r442862960", "bodyText": "So far, we have assumed that the user only sets UC when checkpoint mode is exactly once. In this PR, we ignoring checkpoint mode and set it for all.\nThe question is where to address that:\n\nWe could fail on that combination. Then we would need to disable UC for every at least once test. Not my favorite.\nWe change checkpointing mode with a warning. Not my favorite.\nWe disable/ignore UC (current way) with a warning (needs to be added).\nWe could have a value UC if exactly once and make checkpointCfg.isUnalignedCheckpointsEnabled() more intelligent. Would also be plausible.", "author": "AHeise", "createdAt": "2020-06-19T14:10:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA5Nzk2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk0MzAxNQ==", "url": "https://github.com/apache/flink/pull/11868#discussion_r442943015", "bodyText": "I guess I would prefer the most:\n\nWe could fail on that combination. Then we would need to disable UC for every at least once test. Not my favorite.\n\nBut this one is probably also fine:\n\nWe disable/ignore UC (current way) with a warning (needs to be added).\n\nBut either way, I think this should deserve it's own ticket.", "author": "pnowojski", "createdAt": "2020-06-19T16:41:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA5Nzk2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQ5MzE0NQ==", "url": "https://github.com/apache/flink/pull/11868#discussion_r443493145", "bodyText": "Extracted FLINK-18403, which will be backported (while this PR should only go to master).", "author": "AHeise", "createdAt": "2020-06-22T11:29:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA5Nzk2Mg=="}], "type": "inlineReview", "revised_code": {"commit": "54bb898e9c5616e615fd2660b2ddef5281900277", "chunk": "diff --git a/flink-streaming-java/src/main/java/org/apache/flink/streaming/api/graph/StreamingJobGraphGenerator.java b/flink-streaming-java/src/main/java/org/apache/flink/streaming/api/graph/StreamingJobGraphGenerator.java\nindex 7133526a93..9022eaa9eb 100644\n--- a/flink-streaming-java/src/main/java/org/apache/flink/streaming/api/graph/StreamingJobGraphGenerator.java\n+++ b/flink-streaming-java/src/main/java/org/apache/flink/streaming/api/graph/StreamingJobGraphGenerator.java\n\n@@ -500,9 +500,8 @@ public class StreamingJobGraphGenerator {\n \n \t\tconfig.setStateBackend(streamGraph.getStateBackend());\n \t\tconfig.setCheckpointingEnabled(checkpointCfg.isCheckpointingEnabled());\n+\t\tconfig.setUnalignedCheckpointsEnabled(checkpointCfg.isUnalignedCheckpointsEnabled());\n \t\tconfig.setCheckpointMode(getCheckpointingMode(checkpointCfg));\n-\t\tconfig.setUnalignedCheckpointsEnabled(config.getCheckpointMode() == CheckpointingMode.EXACTLY_ONCE &&\n-\t\t\tcheckpointCfg.isUnalignedCheckpointsEnabled());\n \n \t\tfor (int i = 0; i < vertex.getStatePartitioners().length; i++) {\n \t\t\tconfig.setStatePartitioner(i, vertex.getStatePartitioners()[i]);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA5ODYzNQ==", "url": "https://github.com/apache/flink/pull/11868#discussion_r442098635", "bodyText": "This check seems duplicated exactlyOnce && cfg.isUnalignedCheckpointsEnabled() in two places. Maybe hide exactlyOnce && check inside isUnalignedCheckpointsEnabled?", "author": "pnowojski", "createdAt": "2020-06-18T09:36:09Z", "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/api/graph/StreamingJobGraphGenerator.java", "diffHunk": "@@ -958,10 +960,10 @@ private void configureCheckpointing() {\n \t\t\t\t.setMinPauseBetweenCheckpoints(cfg.getMinPauseBetweenCheckpoints())\n \t\t\t\t.setMaxConcurrentCheckpoints(cfg.getMaxConcurrentCheckpoints())\n \t\t\t\t.setCheckpointRetentionPolicy(retentionAfterTermination)\n-\t\t\t\t.setExactlyOnce(getCheckpointingMode(cfg) == CheckpointingMode.EXACTLY_ONCE)\n+\t\t\t\t.setExactlyOnce(exactlyOnce)\n \t\t\t\t.setPreferCheckpointForRecovery(cfg.isPreferCheckpointForRecovery())\n \t\t\t\t.setTolerableCheckpointFailureNumber(cfg.getTolerableCheckpointFailureNumber())\n-\t\t\t\t.setUnalignedCheckpointsEnabled(cfg.isUnalignedCheckpointsEnabled())\n+\t\t\t\t.setUnalignedCheckpointsEnabled(exactlyOnce && cfg.isUnalignedCheckpointsEnabled())", "originalCommit": "2e55484af53240b19097d2536853b09c575f06d4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg2MzY2NA==", "url": "https://github.com/apache/flink/pull/11868#discussion_r442863664", "bodyText": "Also possible way, it's pretty much ignoring UC when at least once is set. See also above for a deeper discussion.", "author": "AHeise", "createdAt": "2020-06-19T14:11:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA5ODYzNQ=="}], "type": "inlineReview", "revised_code": {"commit": "54bb898e9c5616e615fd2660b2ddef5281900277", "chunk": "diff --git a/flink-streaming-java/src/main/java/org/apache/flink/streaming/api/graph/StreamingJobGraphGenerator.java b/flink-streaming-java/src/main/java/org/apache/flink/streaming/api/graph/StreamingJobGraphGenerator.java\nindex 7133526a93..9022eaa9eb 100644\n--- a/flink-streaming-java/src/main/java/org/apache/flink/streaming/api/graph/StreamingJobGraphGenerator.java\n+++ b/flink-streaming-java/src/main/java/org/apache/flink/streaming/api/graph/StreamingJobGraphGenerator.java\n\n@@ -960,10 +958,10 @@ public class StreamingJobGraphGenerator {\n \t\t\t\t.setMinPauseBetweenCheckpoints(cfg.getMinPauseBetweenCheckpoints())\n \t\t\t\t.setMaxConcurrentCheckpoints(cfg.getMaxConcurrentCheckpoints())\n \t\t\t\t.setCheckpointRetentionPolicy(retentionAfterTermination)\n-\t\t\t\t.setExactlyOnce(exactlyOnce)\n+\t\t\t\t.setExactlyOnce(getCheckpointingMode(cfg) == CheckpointingMode.EXACTLY_ONCE)\n \t\t\t\t.setPreferCheckpointForRecovery(cfg.isPreferCheckpointForRecovery())\n \t\t\t\t.setTolerableCheckpointFailureNumber(cfg.getTolerableCheckpointFailureNumber())\n-\t\t\t\t.setUnalignedCheckpointsEnabled(exactlyOnce && cfg.isUnalignedCheckpointsEnabled())\n+\t\t\t\t.setUnalignedCheckpointsEnabled(cfg.isUnalignedCheckpointsEnabled())\n \t\t\t\t.build(),\n \t\t\tserializedStateBackend,\n \t\t\tserializedHooks);\n"}}, {"oid": "54bb898e9c5616e615fd2660b2ddef5281900277", "url": "https://github.com/apache/flink/commit/54bb898e9c5616e615fd2660b2ddef5281900277", "message": "[hotfix][config] Remove CheckpointConfig#enableUnalignedCheckpoints without parameters.\n\nCheckpointConfig#enableUnalignedCheckpoints(boolean) makes it explicit and also is more future-proof. When unaligned checkpoints become the default, this method will be mostly useless and we would need to add a #disableUnalignedCheckpoints() for consistency.", "committedDate": "2020-06-22T09:42:25Z", "type": "commit"}, {"oid": "633d0f7aa6b9ee669d2b376d3bc4310ee2a9fd56", "url": "https://github.com/apache/flink/commit/633d0f7aa6b9ee669d2b376d3bc4310ee2a9fd56", "message": "[FLINK-18403][checkpointing] Ensure that unaligned checkpointing is only activated for EXACTLY_ONCE.", "committedDate": "2020-06-22T09:51:42Z", "type": "commit"}, {"oid": "5b05578dd320dc32441ec1c374c99f94d0c1e0c9", "url": "https://github.com/apache/flink/commit/5b05578dd320dc32441ec1c374c99f94d0c1e0c9", "message": "[FLINK-17258][tests] Enabling unaligned checkpoint in all tests by default.", "committedDate": "2020-06-22T11:23:02Z", "type": "commit"}, {"oid": "5b05578dd320dc32441ec1c374c99f94d0c1e0c9", "url": "https://github.com/apache/flink/commit/5b05578dd320dc32441ec1c374c99f94d0c1e0c9", "message": "[FLINK-17258][tests] Enabling unaligned checkpoint in all tests by default.", "committedDate": "2020-06-22T11:23:02Z", "type": "forcePushed"}]}