{"pr_number": 12563, "pr_title": "[FLINK-16225] Implement user class loading exception handler", "pr_createdAt": "2020-06-09T18:23:22Z", "pr_url": "https://github.com/apache/flink/pull/12563", "timeline": [{"oid": "c1d0d9befd392aa787f498efc6b3f7e3f2badfe6", "url": "https://github.com/apache/flink/commit/c1d0d9befd392aa787f498efc6b3f7e3f2badfe6", "message": "[FLINK-16225] Implement user class loading exception handler\n\nThis closes #12446.", "committedDate": "2020-06-10T06:45:59Z", "type": "forcePushed"}, {"oid": "dd4bb7283e4b52e5646c9809f21d39f1a95bb550", "url": "https://github.com/apache/flink/commit/dd4bb7283e4b52e5646c9809f21d39f1a95bb550", "message": "[FLINK-16225] Implement user class loading exception handler\n\nThis closes #12446.", "committedDate": "2020-07-20T16:14:36Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODU5NDExNg==", "url": "https://github.com/apache/flink/pull/12563#discussion_r458594116", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\t\tfatalErrorHandler);\n          \n          \n            \n            \t\t\t\tfailOnJvmMetaspaceOomError ? fatalErrorHandler : null);", "author": "tillrohrmann", "createdAt": "2020-07-22T07:36:00Z", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/JobManagerSharedServices.java", "diffHunk": "@@ -144,11 +146,13 @@ public static JobManagerSharedServices fromConfiguration(\n \n \t\tfinal String[] alwaysParentFirstLoaderPatterns = CoreOptions.getParentFirstLoaderPatterns(config);\n \n+\t\tfinal boolean failOnJvmMetaspaceOomError = config.getBoolean(CoreOptions.FAIL_ON_USER_CLASS_LOADING_METASPACE_OOM);\n \t\tfinal BlobLibraryCacheManager libraryCacheManager =\n \t\t\tnew BlobLibraryCacheManager(\n \t\t\t\tblobServer,\n \t\t\t\tFlinkUserCodeClassLoaders.ResolveOrder.fromString(classLoaderResolveOrder),\n-\t\t\t\talwaysParentFirstLoaderPatterns);\n+\t\t\t\talwaysParentFirstLoaderPatterns,\n+\t\t\t\tfatalErrorHandler);", "originalCommit": "dd4bb7283e4b52e5646c9809f21d39f1a95bb550", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "14423007176fa5cbb1ea06ac7c5c4c9fb2d64cc4", "chunk": "diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/JobManagerSharedServices.java b/flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/JobManagerSharedServices.java\nindex 703d5ba2caf..19557d28977 100644\n--- a/flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/JobManagerSharedServices.java\n+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/JobManagerSharedServices.java\n\n@@ -146,13 +144,11 @@ public class JobManagerSharedServices {\n \n \t\tfinal String[] alwaysParentFirstLoaderPatterns = CoreOptions.getParentFirstLoaderPatterns(config);\n \n-\t\tfinal boolean failOnJvmMetaspaceOomError = config.getBoolean(CoreOptions.FAIL_ON_USER_CLASS_LOADING_METASPACE_OOM);\n \t\tfinal BlobLibraryCacheManager libraryCacheManager =\n \t\t\tnew BlobLibraryCacheManager(\n \t\t\t\tblobServer,\n \t\t\t\tFlinkUserCodeClassLoaders.ResolveOrder.fromString(classLoaderResolveOrder),\n-\t\t\t\talwaysParentFirstLoaderPatterns,\n-\t\t\t\tfatalErrorHandler);\n+\t\t\t\talwaysParentFirstLoaderPatterns);\n \n \t\tfinal Duration akkaTimeout;\n \t\ttry {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODU5NzMyNQ==", "url": "https://github.com/apache/flink/pull/12563#discussion_r458597325", "bodyText": "Here we are not respecting FAIL_ON_USER_CLASS_LOADING_METASPACE_OOM.", "author": "tillrohrmann", "createdAt": "2020-07-22T07:41:58Z", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/taskexecutor/TaskExecutor.java", "diffHunk": "@@ -1326,7 +1326,8 @@ private JobManagerConnection associateWithJobManager(\n \t\tfinal LibraryCacheManager libraryCacheManager = new BlobLibraryCacheManager(\n \t\t\tblobCacheService.getPermanentBlobService(),\n \t\t\ttaskManagerConfiguration.getClassLoaderResolveOrder(),\n-\t\t\ttaskManagerConfiguration.getAlwaysParentFirstLoaderPatterns());\n+\t\t\ttaskManagerConfiguration.getAlwaysParentFirstLoaderPatterns(),\n+\t\t\tfatalErrorHandler);", "originalCommit": "dd4bb7283e4b52e5646c9809f21d39f1a95bb550", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "14423007176fa5cbb1ea06ac7c5c4c9fb2d64cc4", "chunk": "diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/taskexecutor/TaskExecutor.java b/flink-runtime/src/main/java/org/apache/flink/runtime/taskexecutor/TaskExecutor.java\nindex fe38b87ae9d..f5c6ce312cd 100644\n--- a/flink-runtime/src/main/java/org/apache/flink/runtime/taskexecutor/TaskExecutor.java\n+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/taskexecutor/TaskExecutor.java\n\n@@ -1326,8 +1326,7 @@ public class TaskExecutor extends RpcEndpoint implements TaskExecutorGateway {\n \t\tfinal LibraryCacheManager libraryCacheManager = new BlobLibraryCacheManager(\n \t\t\tblobCacheService.getPermanentBlobService(),\n \t\t\ttaskManagerConfiguration.getClassLoaderResolveOrder(),\n-\t\t\ttaskManagerConfiguration.getAlwaysParentFirstLoaderPatterns(),\n-\t\t\tfatalErrorHandler);\n+\t\t\ttaskManagerConfiguration.getAlwaysParentFirstLoaderPatterns());\n \n \t\tResultPartitionConsumableNotifier resultPartitionConsumableNotifier = new RpcResultPartitionConsumableNotifier(\n \t\t\tjobMasterGateway,\n"}}, {"oid": "14423007176fa5cbb1ea06ac7c5c4c9fb2d64cc4", "url": "https://github.com/apache/flink/commit/14423007176fa5cbb1ea06ac7c5c4c9fb2d64cc4", "message": "[FLINK-15962][network] Reduce the default chunk size to 4M in netty stack", "committedDate": "2020-07-22T11:58:56Z", "type": "commit"}, {"oid": "0cc21da1c18a9da8544deee5f1aa6d5d1a919479", "url": "https://github.com/apache/flink/commit/0cc21da1c18a9da8544deee5f1aa6d5d1a919479", "message": "[FLINK-16225] Implement user class loading exception handler\n\nThis closes #12563.", "committedDate": "2020-07-22T11:59:05Z", "type": "forcePushed"}, {"oid": "bfe6c2eddedaf3b8067c973ba82a06b36d5095f9", "url": "https://github.com/apache/flink/commit/bfe6c2eddedaf3b8067c973ba82a06b36d5095f9", "message": "[FLINK-16225] Implement user class loading exception handler\n\nThis closes #12563.", "committedDate": "2020-07-22T12:06:28Z", "type": "commit"}, {"oid": "bfe6c2eddedaf3b8067c973ba82a06b36d5095f9", "url": "https://github.com/apache/flink/commit/bfe6c2eddedaf3b8067c973ba82a06b36d5095f9", "message": "[FLINK-16225] Implement user class loading exception handler\n\nThis closes #12563.", "committedDate": "2020-07-22T12:06:28Z", "type": "forcePushed"}]}