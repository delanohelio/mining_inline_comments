{"pr_number": 13422, "pr_title": "[FLINK-19286][runtime] Improve pipelined region scheduling performance", "pr_createdAt": "2020-09-18T10:03:55Z", "pr_url": "https://github.com/apache/flink/pull/13422", "timeline": [{"oid": "0fbcfe1a114aac8d3258d349ab375579a62e77cc", "url": "https://github.com/apache/flink/commit/0fbcfe1a114aac8d3258d349ab375579a62e77cc", "message": "[FLINK-19286][runtime] Replace java streams on critical paths with normal for-loop", "committedDate": "2020-09-18T09:05:14Z", "type": "commit"}, {"oid": "2f83ae1d3e63dd910dda897f2a60fa3f802b464e", "url": "https://github.com/apache/flink/commit/2f83ae1d3e63dd910dda897f2a60fa3f802b464e", "message": "[FLINK-19286][runtime] Improve region vertex sorting performance", "committedDate": "2020-09-18T09:47:31Z", "type": "commit"}, {"oid": "62e3ab653c5b01e5ad7b750e1db97d3d066ef287", "url": "https://github.com/apache/flink/commit/62e3ab653c5b01e5ad7b750e1db97d3d066ef287", "message": "[FLINK-19286][runtime] Improve region sorting performance", "committedDate": "2020-09-18T09:55:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTg3MDIyNA==", "url": "https://github.com/apache/flink/pull/13422#discussion_r491870224", "bodyText": "should we also do this optimisation for other strategies to compare performance in a cleaner way?", "author": "azagrebin", "createdAt": "2020-09-21T08:30:28Z", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/scheduler/strategy/PipelinedRegionSchedulingStrategy.java", "diffHunk": "@@ -127,13 +136,9 @@ private void maybeScheduleRegion(final SchedulingPipelinedRegion region) {\n \n \t\tcheckState(areRegionVerticesAllInCreatedState(region), \"BUG: trying to schedule a region which is not in CREATED state\");\n \n-\t\tfinal Set<ExecutionVertexID> verticesToSchedule = IterableUtils.toStream(region.getVertices())\n-\t\t\t.map(SchedulingExecutionVertex::getId)\n-\t\t\t.collect(Collectors.toSet());\n \t\tfinal List<ExecutionVertexDeploymentOption> vertexDeploymentOptions =\n-\t\t\tSchedulingStrategyUtils.createExecutionVertexDeploymentOptionsInTopologicalOrder(\n-\t\t\t\tschedulingTopology,\n-\t\t\t\tverticesToSchedule,\n+\t\t\tSchedulingStrategyUtils.createExecutionVertexDeploymentOptions(", "originalCommit": "2f83ae1d3e63dd910dda897f2a60fa3f802b464e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTg3ODQ3Ng==", "url": "https://github.com/apache/flink/pull/13422#discussion_r491878476", "bodyText": "I think it's not needed. Because the sorting is not a problem for other strategies where the sorting is invoked once per triggering event. While for pipelined region scheduling, it is invoked multiple times, each for one region.\nAnd doing it like this requires to add a sorted region vertex map for other strategies, which would be an unnecessary complication.", "author": "zhuzhurk", "createdAt": "2020-09-21T08:44:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTg3MDIyNA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTg3MjA5OA==", "url": "https://github.com/apache/flink/pull/13422#discussion_r491872098", "bodyText": "maybe we should also convert stream to a loop for performance in sortPipelinedRegionsInTopologicalOrder?", "author": "azagrebin", "createdAt": "2020-09-21T08:33:40Z", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/scheduler/strategy/SchedulingStrategyUtils.java", "diffHunk": "@@ -81,6 +82,14 @@\n \t\t\tfinal SchedulingTopology topology,\n \t\t\tfinal Set<SchedulingPipelinedRegion> regions) {\n \n+\t\t// Avoid the O(V) (V is the number of vertices in the topology) sorting\n+\t\t// complexity if the given set of regions is small enough\n+\t\tif (regions.size() == 0) {\n+\t\t\treturn Collections.emptyList();\n+\t\t} else if (regions.size() == 1) {\n+\t\t\treturn Collections.singletonList(regions.iterator().next());\n+\t\t}\n+\n \t\treturn IterableUtils.toStream(topology.getVertices())", "originalCommit": "62e3ab653c5b01e5ad7b750e1db97d3d066ef287", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTg4MjU2MQ==", "url": "https://github.com/apache/flink/pull/13422#discussion_r491882561", "bodyText": "I think we can keep it as is to be simpler because it is not the critical part.\nThe reworked java streams are in per-region code path, while this one is invoked the per-event code path. But even the reworked loops are not most critical, because it is in a O(V) complexity.\nThe other 2 commits to fix the vertex/region sorting, reduces O(V^2) complexity to O(V) in each valid triggering event.", "author": "zhuzhurk", "createdAt": "2020-09-21T08:51:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTg3MjA5OA=="}], "type": "inlineReview", "revised_code": null}]}