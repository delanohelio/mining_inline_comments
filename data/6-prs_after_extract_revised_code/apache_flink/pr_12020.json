{"pr_number": 12020, "pr_title": "[FLINK-17552][network] Do not cache InputChannels in UnionInputGate", "pr_createdAt": "2020-05-07T09:40:09Z", "pr_url": "https://github.com/apache/flink/pull/12020", "timeline": [{"oid": "70088254d856c0b18e664e5e05105b536502ac3d", "url": "https://github.com/apache/flink/commit/70088254d856c0b18e664e5e05105b536502ac3d", "message": "[hotfix][network] Add debug message marking end of output recovery for unaligned checkpoints", "committedDate": "2020-05-07T09:42:07Z", "type": "forcePushed"}, {"oid": "4203b2dffa8493394a8f9c3dc5723801b15dd163", "url": "https://github.com/apache/flink/commit/4203b2dffa8493394a8f9c3dc5723801b15dd163", "message": "[hotfix][network] Add debug message marking end of output recovery for unaligned checkpoints", "committedDate": "2020-05-07T09:49:30Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTM4OTg0Nw==", "url": "https://github.com/apache/flink/pull/12020#discussion_r421389847", "bodyText": "total = Arrays.stream(inputGates).mapToInt(IndexedInputGate::getNumberOfInputChannels).sum() ?", "author": "AHeise", "createdAt": "2020-05-07T10:05:33Z", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/UnionInputGate.java", "diffHunk": "@@ -101,14 +99,19 @@ public UnionInputGate(IndexedInputGate... inputGates) {\n \n \t\tfinal int maxGateIndex = Arrays.stream(inputGates).mapToInt(IndexedInputGate::getGateIndex).max().orElse(0);\n \t\tinputGateChannelIndexOffsets = new int[maxGateIndex + 1];\n+\t\tint totalNumberOfInputChannels = 0;", "originalCommit": "ccd796d1e157abf7052996f185b80bccc1e5b5dc", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1d86f6e4d02824dbb3747e67f1e515be8f55c1e4", "chunk": "diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/UnionInputGate.java b/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/UnionInputGate.java\nindex 484c4c24fc..343bba71f4 100644\n--- a/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/UnionInputGate.java\n+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/UnionInputGate.java\n\n@@ -99,10 +99,7 @@ public class UnionInputGate extends InputGate {\n \n \t\tfinal int maxGateIndex = Arrays.stream(inputGates).mapToInt(IndexedInputGate::getGateIndex).max().orElse(0);\n \t\tinputGateChannelIndexOffsets = new int[maxGateIndex + 1];\n-\t\tint totalNumberOfInputChannels = 0;\n-\t\tfor (final IndexedInputGate inputGate : inputGates) {\n-\t\t\ttotalNumberOfInputChannels += inputGate.getNumberOfInputChannels();\n-\t\t}\n+\t\tint totalNumberOfInputChannels = Arrays.stream(inputGates).mapToInt(IndexedInputGate::getNumberOfInputChannels).sum();\n \t\tinputChannelToInputGateIndex = new int[totalNumberOfInputChannels];\n \n \t\tint currentNumberOfInputChannels = 0;\n"}}, {"oid": "1d86f6e4d02824dbb3747e67f1e515be8f55c1e4", "url": "https://github.com/apache/flink/commit/1d86f6e4d02824dbb3747e67f1e515be8f55c1e4", "message": "[FLINK-17552][network] Do not cache InputChannels in UnionInputGate\n\nThis is a simple fix for a bug on the master branch that is not visible currently in anyway, but which is causing\nan inconsistent state with UnionInputGate if underlying channels are updated inside SingleInputGate", "committedDate": "2020-05-07T10:44:16Z", "type": "commit"}, {"oid": "6dad1301491a163324578ea1c3ae3a98355888b6", "url": "https://github.com/apache/flink/commit/6dad1301491a163324578ea1c3ae3a98355888b6", "message": "[hotfix][network] Add debug message marking end of output recovery for unaligned checkpoints", "committedDate": "2020-05-07T10:44:17Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTQzOTUzMQ==", "url": "https://github.com/apache/flink/pull/12020#discussion_r421439531", "bodyText": "nit: Add ChannelStateWriterImpl to commit msg.", "author": "AHeise", "createdAt": "2020-05-07T11:41:31Z", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/channel/ChannelStateWriterImpl.java", "diffHunk": "@@ -19,6 +19,8 @@\n \n import org.apache.flink.annotation.Internal;\n import org.apache.flink.runtime.checkpoint.CheckpointOptions;\n+import org.apache.flink.runtime.event.AbstractEvent;", "originalCommit": "f3cf37ca5100642d67f72382b5d01b1f3e974e16", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "abb91c3f912e993b65f5d592b467c3e052218ab3", "url": "https://github.com/apache/flink/commit/abb91c3f912e993b65f5d592b467c3e052218ab3", "message": "[hotfix][network] Improve error message in ChannelStateWriterImpl", "committedDate": "2020-05-07T13:32:20Z", "type": "commit"}, {"oid": "e6d125b56355296b67542900256948ca7de714c9", "url": "https://github.com/apache/flink/commit/e6d125b56355296b67542900256948ca7de714c9", "message": "[hotfix][network] Add debug message marking end of output recovery for unaligned checkpoints", "committedDate": "2020-05-07T13:32:32Z", "type": "commit"}, {"oid": "e6d125b56355296b67542900256948ca7de714c9", "url": "https://github.com/apache/flink/commit/e6d125b56355296b67542900256948ca7de714c9", "message": "[hotfix][network] Add debug message marking end of output recovery for unaligned checkpoints", "committedDate": "2020-05-07T13:32:32Z", "type": "forcePushed"}]}