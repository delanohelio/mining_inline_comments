{"pr_number": 11444, "pr_title": "[FLINK-16608][python] Support primitive data types for vectorized Python UDF", "pr_createdAt": "2020-03-18T14:50:37Z", "pr_url": "https://github.com/apache/flink/pull/11444", "timeline": [{"oid": "3a8d77a70ea38f6652f5bc5d8a2b451efe895ae0", "url": "https://github.com/apache/flink/commit/3a8d77a70ea38f6652f5bc5d8a2b451efe895ae0", "message": "[FLINK-16608][python] Remove the method which derives the LogicalType from the Arrow ValueVector", "committedDate": "2020-03-18T14:44:15Z", "type": "commit"}, {"oid": "474eb675e42e12a40743ed618521652c5b0d1968", "url": "https://github.com/apache/flink/commit/474eb675e42e12a40743ed618521652c5b0d1968", "message": "[FLINK-16608][python] Support BooleanType in vectorized Python UDF", "committedDate": "2020-03-18T14:44:40Z", "type": "commit"}, {"oid": "b3a6ae47d0ff7ad4bc13aca221d6f4a06a492115", "url": "https://github.com/apache/flink/commit/b3a6ae47d0ff7ad4bc13aca221d6f4a06a492115", "message": "[FLINK-16608][python] Support FloatType in vectorized Python UDF", "committedDate": "2020-03-18T14:44:48Z", "type": "commit"}, {"oid": "1caa7595273accdd02d1a66a0ee4e396838ebe42", "url": "https://github.com/apache/flink/commit/1caa7595273accdd02d1a66a0ee4e396838ebe42", "message": "[FLINK-16608][python] Support DoubleType in vectorized Python UDF", "committedDate": "2020-03-18T14:44:54Z", "type": "commit"}, {"oid": "307c75523c6fb4afadb2f54f9fac843f10a2362b", "url": "https://github.com/apache/flink/commit/307c75523c6fb4afadb2f54f9fac843f10a2362b", "message": "[FLINK-16608][python] Support VarCharType in vectorized Python UDF", "committedDate": "2020-03-18T14:45:01Z", "type": "commit"}, {"oid": "95574f67e9f3c3e3a4fc8fd3e847239f008a4b34", "url": "https://github.com/apache/flink/commit/95574f67e9f3c3e3a4fc8fd3e847239f008a4b34", "message": "[FLINK-16608][python] Support VarBinaryType in vectorized Python UDF", "committedDate": "2020-03-18T14:45:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjIzNzQwMg==", "url": "https://github.com/apache/flink/pull/11444#discussion_r396237402", "bodyText": "Should we also adjust the precision and scale here, like it in DecimalWriter? If we pass a decimal with different precision and scale, an exception will be thrown.", "author": "hequn8128", "createdAt": "2020-03-23T06:41:01Z", "path": "flink-python/src/main/java/org/apache/flink/table/runtime/arrow/writers/BaseRowDecimalWriter.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.table.runtime.arrow.writers;\n+\n+import org.apache.flink.annotation.Internal;\n+import org.apache.flink.table.dataformat.BaseRow;\n+\n+import org.apache.arrow.vector.DecimalVector;\n+\n+/**\n+ * {@link ArrowFieldWriter} for Decimal.\n+ */\n+@Internal\n+public final class BaseRowDecimalWriter extends ArrowFieldWriter<BaseRow> {\n+\n+\tprivate final int precision;\n+\tprivate final int scale;\n+\n+\tpublic BaseRowDecimalWriter(DecimalVector decimalVector, int precision, int scale) {\n+\t\tsuper(decimalVector);\n+\t\tthis.precision = precision;\n+\t\tthis.scale = scale;\n+\t}\n+\n+\t@Override\n+\tpublic void doWrite(BaseRow row, int ordinal) {\n+\t\tif (row.isNullAt(ordinal)) {\n+\t\t\t((DecimalVector) getValueVector()).setNull(getCount());\n+\t\t} else {\n+\t\t\t((DecimalVector) getValueVector()).setSafe(", "originalCommit": "f2ef0c0c560faa93cc7663ae7080676488066a10", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b71ecc25d378f9d33a133b7bd2a85d89268580a9", "chunk": "diff --git a/flink-python/src/main/java/org/apache/flink/table/runtime/arrow/writers/BaseRowDecimalWriter.java b/flink-python/src/main/java/org/apache/flink/table/runtime/arrow/writers/BaseRowDecimalWriter.java\nindex 78665006a7c..ee0ddad8511 100644\n--- a/flink-python/src/main/java/org/apache/flink/table/runtime/arrow/writers/BaseRowDecimalWriter.java\n+++ b/flink-python/src/main/java/org/apache/flink/table/runtime/arrow/writers/BaseRowDecimalWriter.java\n\n@@ -23,6 +23,10 @@ import org.apache.flink.table.dataformat.BaseRow;\n \n import org.apache.arrow.vector.DecimalVector;\n \n+import java.math.BigDecimal;\n+\n+import static org.apache.flink.table.runtime.typeutils.PythonTypeUtils.fromBigDecimal;\n+\n /**\n  * {@link ArrowFieldWriter} for Decimal.\n  */\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjIzNzU4OA==", "url": "https://github.com/apache/flink/pull/11444#discussion_r396237588", "bodyText": "Should we also adjust the precision and scale here, like it in DecimalWriter? If we pass a decimal with different precision and scale for the BaseRowDecimalWriter, an exception will be thrown.", "author": "hequn8128", "createdAt": "2020-03-23T06:41:39Z", "path": "flink-python/src/main/java/org/apache/flink/table/runtime/arrow/writers/BaseRowDecimalWriter.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.table.runtime.arrow.writers;\n+\n+import org.apache.flink.annotation.Internal;\n+import org.apache.flink.table.dataformat.BaseRow;\n+\n+import org.apache.arrow.vector.DecimalVector;\n+\n+/**\n+ * {@link ArrowFieldWriter} for Decimal.\n+ */\n+@Internal\n+public final class BaseRowDecimalWriter extends ArrowFieldWriter<BaseRow> {\n+\n+\tprivate final int precision;\n+\tprivate final int scale;\n+\n+\tpublic BaseRowDecimalWriter(DecimalVector decimalVector, int precision, int scale) {\n+\t\tsuper(decimalVector);\n+\t\tthis.precision = precision;\n+\t\tthis.scale = scale;\n+\t}\n+\n+\t@Override\n+\tpublic void doWrite(BaseRow row, int ordinal) {\n+\t\tif (row.isNullAt(ordinal)) {\n+\t\t\t((DecimalVector) getValueVector()).setNull(getCount());\n+\t\t} else {\n+\t\t\t((DecimalVector) getValueVector()).setSafe(", "originalCommit": "f2ef0c0c560faa93cc7663ae7080676488066a10", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b71ecc25d378f9d33a133b7bd2a85d89268580a9", "chunk": "diff --git a/flink-python/src/main/java/org/apache/flink/table/runtime/arrow/writers/BaseRowDecimalWriter.java b/flink-python/src/main/java/org/apache/flink/table/runtime/arrow/writers/BaseRowDecimalWriter.java\nindex 78665006a7c..ee0ddad8511 100644\n--- a/flink-python/src/main/java/org/apache/flink/table/runtime/arrow/writers/BaseRowDecimalWriter.java\n+++ b/flink-python/src/main/java/org/apache/flink/table/runtime/arrow/writers/BaseRowDecimalWriter.java\n\n@@ -23,6 +23,10 @@ import org.apache.flink.table.dataformat.BaseRow;\n \n import org.apache.arrow.vector.DecimalVector;\n \n+import java.math.BigDecimal;\n+\n+import static org.apache.flink.table.runtime.typeutils.PythonTypeUtils.fromBigDecimal;\n+\n /**\n  * {@link ArrowFieldWriter} for Decimal.\n  */\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjI0MzIzMw==", "url": "https://github.com/apache/flink/pull/11444#discussion_r396243233", "bodyText": "DateWriter is used for the old planner. It seems we can't use the blink planner class directly here, otherwise, Pyflink will depend on blink planner even it is configured to use the old planner.", "author": "hequn8128", "createdAt": "2020-03-23T07:01:01Z", "path": "flink-python/src/main/java/org/apache/flink/table/runtime/arrow/writers/DateWriter.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.table.runtime.arrow.writers;\n+\n+import org.apache.flink.annotation.Internal;\n+import org.apache.flink.table.runtime.functions.SqlDateTimeUtils;\n+import org.apache.flink.types.Row;\n+\n+import org.apache.arrow.vector.DateDayVector;\n+\n+import java.sql.Date;\n+\n+/**\n+ * {@link ArrowFieldWriter} for Date.\n+ */\n+@Internal\n+public final class DateWriter extends ArrowFieldWriter<Row> {\n+\n+\tpublic DateWriter(DateDayVector dateDayVector) {\n+\t\tsuper(dateDayVector);\n+\t}\n+\n+\t@Override\n+\tpublic void doWrite(Row value, int ordinal) {\n+\t\tif (value.getField(ordinal) == null) {\n+\t\t\t((DateDayVector) getValueVector()).setNull(getCount());\n+\t\t} else {\n+\t\t\t((DateDayVector) getValueVector()).setSafe(\n+\t\t\t\tgetCount(), SqlDateTimeUtils.dateToInternal(((Date) value.getField(ordinal))));", "originalCommit": "f2ef0c0c560faa93cc7663ae7080676488066a10", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b71ecc25d378f9d33a133b7bd2a85d89268580a9", "chunk": "diff --git a/flink-python/src/main/java/org/apache/flink/table/runtime/arrow/writers/DateWriter.java b/flink-python/src/main/java/org/apache/flink/table/runtime/arrow/writers/DateWriter.java\nindex 9f38d9bfc2b..27a6a91a184 100644\n--- a/flink-python/src/main/java/org/apache/flink/table/runtime/arrow/writers/DateWriter.java\n+++ b/flink-python/src/main/java/org/apache/flink/table/runtime/arrow/writers/DateWriter.java\n\n@@ -19,7 +19,7 @@\n package org.apache.flink.table.runtime.arrow.writers;\n \n import org.apache.flink.annotation.Internal;\n-import org.apache.flink.table.runtime.functions.SqlDateTimeUtils;\n+import org.apache.flink.table.runtime.typeutils.PythonTypeUtils;\n import org.apache.flink.types.Row;\n \n import org.apache.arrow.vector.DateDayVector;\n"}}, {"oid": "b71ecc25d378f9d33a133b7bd2a85d89268580a9", "url": "https://github.com/apache/flink/commit/b71ecc25d378f9d33a133b7bd2a85d89268580a9", "message": "[FLINK-16608][python] Support TimeType in vectorized Python UDF", "committedDate": "2020-03-23T10:32:40Z", "type": "forcePushed"}, {"oid": "2b2ff6f60ffba45037b76169b9b23aa7d4de3e9d", "url": "https://github.com/apache/flink/commit/2b2ff6f60ffba45037b76169b9b23aa7d4de3e9d", "message": "[FLINK-16608][python] Support DecimalType in vectorized Python UDF", "committedDate": "2020-03-24T00:32:28Z", "type": "commit"}, {"oid": "52399b23f52c868d27daa27034b7a8d23dcccaad", "url": "https://github.com/apache/flink/commit/52399b23f52c868d27daa27034b7a8d23dcccaad", "message": "[FLINK-16608][python] Support DateType in vectorized Python UDF", "committedDate": "2020-03-24T00:32:31Z", "type": "commit"}, {"oid": "527f5dd8b6dcef9d1064186a20e9c4faf9ab65b2", "url": "https://github.com/apache/flink/commit/527f5dd8b6dcef9d1064186a20e9c4faf9ab65b2", "message": "[FLINK-16608][python] Support TimeType in vectorized Python UDF", "committedDate": "2020-03-24T00:32:32Z", "type": "commit"}, {"oid": "527f5dd8b6dcef9d1064186a20e9c4faf9ab65b2", "url": "https://github.com/apache/flink/commit/527f5dd8b6dcef9d1064186a20e9c4faf9ab65b2", "message": "[FLINK-16608][python] Support TimeType in vectorized Python UDF", "committedDate": "2020-03-24T00:32:32Z", "type": "forcePushed"}]}