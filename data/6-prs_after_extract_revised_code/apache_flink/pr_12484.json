{"pr_number": 12484, "pr_title": "[FLINK-18127][tests] Streamline manual execution of Java E2E tests", "pr_createdAt": "2020-06-04T12:44:32Z", "pr_url": "https://github.com/apache/flink/pull/12484", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjAxMTc1MA==", "url": "https://github.com/apache/flink/pull/12484#discussion_r436011750", "bodyText": "I guess this can be removed.", "author": "tillrohrmann", "createdAt": "2020-06-05T15:52:27Z", "path": "flink-end-to-end-tests/flink-end-to-end-tests-common/src/main/java/org/apache/flink/tests/util/flink/LocalStandaloneFlinkResourceFactory.java", "diffHunk": "@@ -33,19 +37,83 @@\n public final class LocalStandaloneFlinkResourceFactory implements FlinkResourceFactory {\n \tprivate static final Logger LOG = LoggerFactory.getLogger(LocalStandaloneFlinkResourceFactory.class);\n \n+\tprivate static final ParameterProperty<Path> PROJECT_ROOT_DIRECTORY = new ParameterProperty<>(\"rootDir\", Paths::get);\n \tprivate static final ParameterProperty<Path> DISTRIBUTION_DIRECTORY = new ParameterProperty<>(\"distDir\", Paths::get);\n \tprivate static final ParameterProperty<Path> DISTRIBUTION_LOG_BACKUP_DIRECTORY = new ParameterProperty<>(\"logBackupDir\", Paths::get);\n \n \t@Override\n \tpublic FlinkResource create(FlinkResourceSetup setup) {\n \t\tOptional<Path> distributionDirectory = DISTRIBUTION_DIRECTORY.get();\n \t\tif (!distributionDirectory.isPresent()) {\n-\t\t\tthrow new IllegalArgumentException(\"The distDir property was not set. You can set it when running maven via -DdistDir=<path> .\");\n+\t\t\t// distDir was not explicitly set, let's search for it\n+\n+\t\t\tPath projectRootPath;\n+\t\t\tOptional<Path> projectRoot = PROJECT_ROOT_DIRECTORY.get();\n+\t\t\tif (projectRoot.isPresent()) {\n+\t\t\t\t// running with maven\n+\t\t\t\tprojectRootPath = projectRoot.get();\n+\t\t\t} else {\n+\t\t\t\t// running in the IDE; working directory is test module\n+\t\t\t\tOptional<Path> projectRootDirectory = findProjectRootDirectory(Paths.get(\"\").toAbsolutePath());\n+\t\t\t\t// this distinction is required in case this class is used outside of Flink\n+\t\t\t\tif (projectRootDirectory.isPresent()) {\n+\t\t\t\t\tprojectRootPath = projectRootDirectory.get();\n+\t\t\t\t} else {\n+\t\t\t\t\tthrow new IllegalArgumentException(\n+\t\t\t\t\t\t\"The 'distDir' property was not set and the flink-dist module could not be found automatically.\" +\n+\t\t\t\t\t\t\t\" Please point the 'distDir' property to the directory containing distribution; you can set it when running maven via -DdistDir=<path> .\");\n+\t\t\t\t}\n+\t\t\t}\n+\t\t\tOptional<Path> distribution = findDistribution(projectRootPath);\n+\t\t\tif (!distribution.isPresent()) {\n+\t\t\t\tthrow new IllegalArgumentException(\n+\t\t\t\t\t\"The 'distDir' property was not set and a distribution could not be found automatically.\" +\n+\t\t\t\t\t\t\" Please point the 'distDir' property to the directory containing distribution; you can set it when running maven via -DdistDir=<path> .\");\n+\t\t\t} else {\n+\t\t\t\tdistributionDirectory = distribution;\n+\t\t\t}\n \t\t}\n \t\tOptional<Path> logBackupDirectory = DISTRIBUTION_LOG_BACKUP_DIRECTORY.get();\n \t\tif (!logBackupDirectory.isPresent()) {\n \t\t\tLOG.warn(\"Property {} not set, logs will not be backed up in case of test failures.\", DISTRIBUTION_LOG_BACKUP_DIRECTORY.getPropertyName());\n \t\t}\n \t\treturn new LocalStandaloneFlinkResource(distributionDirectory.get(), logBackupDirectory.orElse(null), setup);\n \t}\n+\n+\tpublic static void main(String[] args) {\n+\t\tSystem.out.println(findProjectRootDirectory(Paths.get(\"\").toAbsolutePath()));\n+\t}", "originalCommit": "30b3c3dfdc501e2f8c54877d6a9c950e688dfd09", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjA2Nzc1Ng==", "url": "https://github.com/apache/flink/pull/12484#discussion_r436067756", "bodyText": "whoops,", "author": "zentol", "createdAt": "2020-06-05T17:40:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjAxMTc1MA=="}], "type": "inlineReview", "revised_code": {"commit": "46b5fa0b9c408360a69469a5eaceed902ae3dfeb", "chunk": "diff --git a/flink-end-to-end-tests/flink-end-to-end-tests-common/src/main/java/org/apache/flink/tests/util/flink/LocalStandaloneFlinkResourceFactory.java b/flink-end-to-end-tests/flink-end-to-end-tests-common/src/main/java/org/apache/flink/tests/util/flink/LocalStandaloneFlinkResourceFactory.java\nindex 1b44dc60d7f..047a57de8fb 100644\n--- a/flink-end-to-end-tests/flink-end-to-end-tests-common/src/main/java/org/apache/flink/tests/util/flink/LocalStandaloneFlinkResourceFactory.java\n+++ b/flink-end-to-end-tests/flink-end-to-end-tests-common/src/main/java/org/apache/flink/tests/util/flink/LocalStandaloneFlinkResourceFactory.java\n\n@@ -37,7 +33,6 @@ import java.util.Optional;\n public final class LocalStandaloneFlinkResourceFactory implements FlinkResourceFactory {\n \tprivate static final Logger LOG = LoggerFactory.getLogger(LocalStandaloneFlinkResourceFactory.class);\n \n-\tprivate static final ParameterProperty<Path> PROJECT_ROOT_DIRECTORY = new ParameterProperty<>(\"rootDir\", Paths::get);\n \tprivate static final ParameterProperty<Path> DISTRIBUTION_DIRECTORY = new ParameterProperty<>(\"distDir\", Paths::get);\n \tprivate static final ParameterProperty<Path> DISTRIBUTION_LOG_BACKUP_DIRECTORY = new ParameterProperty<>(\"logBackupDir\", Paths::get);\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjAxNDI0NA==", "url": "https://github.com/apache/flink/pull/12484#discussion_r436014244", "bodyText": "Won't flink-dist/target also contain flink-dist_2.11-1.12-SNAPSHOT.jar? At least this is the case for me. Can this be a problem?", "author": "tillrohrmann", "createdAt": "2020-06-05T15:56:45Z", "path": "flink-end-to-end-tests/flink-end-to-end-tests-common/src/main/java/org/apache/flink/tests/util/flink/LocalStandaloneFlinkResourceFactory.java", "diffHunk": "@@ -33,19 +37,83 @@\n public final class LocalStandaloneFlinkResourceFactory implements FlinkResourceFactory {\n \tprivate static final Logger LOG = LoggerFactory.getLogger(LocalStandaloneFlinkResourceFactory.class);\n \n+\tprivate static final ParameterProperty<Path> PROJECT_ROOT_DIRECTORY = new ParameterProperty<>(\"rootDir\", Paths::get);\n \tprivate static final ParameterProperty<Path> DISTRIBUTION_DIRECTORY = new ParameterProperty<>(\"distDir\", Paths::get);\n \tprivate static final ParameterProperty<Path> DISTRIBUTION_LOG_BACKUP_DIRECTORY = new ParameterProperty<>(\"logBackupDir\", Paths::get);\n \n \t@Override\n \tpublic FlinkResource create(FlinkResourceSetup setup) {\n \t\tOptional<Path> distributionDirectory = DISTRIBUTION_DIRECTORY.get();\n \t\tif (!distributionDirectory.isPresent()) {\n-\t\t\tthrow new IllegalArgumentException(\"The distDir property was not set. You can set it when running maven via -DdistDir=<path> .\");\n+\t\t\t// distDir was not explicitly set, let's search for it\n+\n+\t\t\tPath projectRootPath;\n+\t\t\tOptional<Path> projectRoot = PROJECT_ROOT_DIRECTORY.get();\n+\t\t\tif (projectRoot.isPresent()) {\n+\t\t\t\t// running with maven\n+\t\t\t\tprojectRootPath = projectRoot.get();\n+\t\t\t} else {\n+\t\t\t\t// running in the IDE; working directory is test module\n+\t\t\t\tOptional<Path> projectRootDirectory = findProjectRootDirectory(Paths.get(\"\").toAbsolutePath());\n+\t\t\t\t// this distinction is required in case this class is used outside of Flink\n+\t\t\t\tif (projectRootDirectory.isPresent()) {\n+\t\t\t\t\tprojectRootPath = projectRootDirectory.get();\n+\t\t\t\t} else {\n+\t\t\t\t\tthrow new IllegalArgumentException(\n+\t\t\t\t\t\t\"The 'distDir' property was not set and the flink-dist module could not be found automatically.\" +\n+\t\t\t\t\t\t\t\" Please point the 'distDir' property to the directory containing distribution; you can set it when running maven via -DdistDir=<path> .\");\n+\t\t\t\t}\n+\t\t\t}\n+\t\t\tOptional<Path> distribution = findDistribution(projectRootPath);\n+\t\t\tif (!distribution.isPresent()) {\n+\t\t\t\tthrow new IllegalArgumentException(\n+\t\t\t\t\t\"The 'distDir' property was not set and a distribution could not be found automatically.\" +\n+\t\t\t\t\t\t\" Please point the 'distDir' property to the directory containing distribution; you can set it when running maven via -DdistDir=<path> .\");\n+\t\t\t} else {\n+\t\t\t\tdistributionDirectory = distribution;\n+\t\t\t}\n \t\t}\n \t\tOptional<Path> logBackupDirectory = DISTRIBUTION_LOG_BACKUP_DIRECTORY.get();\n \t\tif (!logBackupDirectory.isPresent()) {\n \t\t\tLOG.warn(\"Property {} not set, logs will not be backed up in case of test failures.\", DISTRIBUTION_LOG_BACKUP_DIRECTORY.getPropertyName());\n \t\t}\n \t\treturn new LocalStandaloneFlinkResource(distributionDirectory.get(), logBackupDirectory.orElse(null), setup);\n \t}\n+\n+\tpublic static void main(String[] args) {\n+\t\tSystem.out.println(findProjectRootDirectory(Paths.get(\"\").toAbsolutePath()));\n+\t}\n+\n+\tprivate static Optional<Path> findProjectRootDirectory(Path currentDirectory) {\n+\t\t// move up the module structure until we find flink-dist; relies on all modules being prefixed with 'flink'\n+\t\tdo {\n+\t\t\tif (Files.exists(currentDirectory.resolve(\"flink-dist\"))) {\n+\t\t\t\treturn Optional.of(currentDirectory);\n+\t\t\t}\n+\t\t\tcurrentDirectory = currentDirectory.getParent();\n+\t\t}  while (currentDirectory.getFileName().toString().startsWith(\"flink\"));\n+\t\treturn Optional.empty();\n+\t}\n+\n+\tprivate static Optional<Path> findDistribution(Path projectRootDirectory) {\n+\t\tfinal Path distTargetDirectory = projectRootDirectory.resolve(\"flink-dist\").resolve(\"target\");\n+\t\ttry {\n+\t\t\tCollection<Path> paths = FileUtils.listFilesInDirectory(distTargetDirectory, p -> p.getFileName().toString().contains(\"flink-dist\"));\n+\t\t\tif (paths.size() == 0) {\n+\t\t\t\t// likely due to flink-dist not having been built\n+\t\t\t\treturn Optional.empty();\n+\t\t\t}\n+\t\t\tif (paths.size() > 1) {", "originalCommit": "30b3c3dfdc501e2f8c54877d6a9c950e688dfd09", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjAxNzc4NQ==", "url": "https://github.com/apache/flink/pull/12484#discussion_r436017785", "bodyText": "I guess this works because we first descend recursively in a dfs manner so that we find the flink/flink-dist/target/flink-1.12-SNAPSHOT-bin/flink-1.12-SNAPSHOT/lib/flink-dist_2.11-1.12-SNAPSHOT.jar", "author": "tillrohrmann", "createdAt": "2020-06-05T16:02:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjAxNDI0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjA2NzYzNg==", "url": "https://github.com/apache/flink/pull/12484#discussion_r436067636", "bodyText": "We could harden this be explicitly checking for flink-dist.jar; this one should only be in the distribution.", "author": "zentol", "createdAt": "2020-06-05T17:39:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjAxNDI0NA=="}], "type": "inlineReview", "revised_code": {"commit": "46b5fa0b9c408360a69469a5eaceed902ae3dfeb", "chunk": "diff --git a/flink-end-to-end-tests/flink-end-to-end-tests-common/src/main/java/org/apache/flink/tests/util/flink/LocalStandaloneFlinkResourceFactory.java b/flink-end-to-end-tests/flink-end-to-end-tests-common/src/main/java/org/apache/flink/tests/util/flink/LocalStandaloneFlinkResourceFactory.java\nindex 1b44dc60d7f..047a57de8fb 100644\n--- a/flink-end-to-end-tests/flink-end-to-end-tests-common/src/main/java/org/apache/flink/tests/util/flink/LocalStandaloneFlinkResourceFactory.java\n+++ b/flink-end-to-end-tests/flink-end-to-end-tests-common/src/main/java/org/apache/flink/tests/util/flink/LocalStandaloneFlinkResourceFactory.java\n\n@@ -37,7 +33,6 @@ import java.util.Optional;\n public final class LocalStandaloneFlinkResourceFactory implements FlinkResourceFactory {\n \tprivate static final Logger LOG = LoggerFactory.getLogger(LocalStandaloneFlinkResourceFactory.class);\n \n-\tprivate static final ParameterProperty<Path> PROJECT_ROOT_DIRECTORY = new ParameterProperty<>(\"rootDir\", Paths::get);\n \tprivate static final ParameterProperty<Path> DISTRIBUTION_DIRECTORY = new ParameterProperty<>(\"distDir\", Paths::get);\n \tprivate static final ParameterProperty<Path> DISTRIBUTION_LOG_BACKUP_DIRECTORY = new ParameterProperty<>(\"logBackupDir\", Paths::get);\n \n"}}, {"oid": "46b5fa0b9c408360a69469a5eaceed902ae3dfeb", "url": "https://github.com/apache/flink/commit/46b5fa0b9c408360a69469a5eaceed902ae3dfeb", "message": "[FLINK-18042][tests] Log path of used distribution", "committedDate": "2020-06-08T16:55:48Z", "type": "commit"}, {"oid": "a00c4924c99ec35e97cb31e93a54882e4e5c1448", "url": "https://github.com/apache/flink/commit/a00c4924c99ec35e97cb31e93a54882e4e5c1448", "message": "[FLINK-18042][tests] Auto-detect moduleDir", "committedDate": "2020-06-08T16:55:48Z", "type": "commit"}, {"oid": "e0ba8d82be72df77d87b55cf089bd1fbd4f7f74c", "url": "https://github.com/apache/flink/commit/e0ba8d82be72df77d87b55cf089bd1fbd4f7f74c", "message": "[FLINK-18042][tests] More helpful error message if jar cannot be found", "committedDate": "2020-06-08T16:55:48Z", "type": "commit"}, {"oid": "63e7c7bc83847ad7e2bc383081e051875e3429f9", "url": "https://github.com/apache/flink/commit/63e7c7bc83847ad7e2bc383081e051875e3429f9", "message": "[FLINK-18042][tests] Auto-detect distDir", "committedDate": "2020-06-08T16:55:48Z", "type": "commit"}, {"oid": "63e7c7bc83847ad7e2bc383081e051875e3429f9", "url": "https://github.com/apache/flink/commit/63e7c7bc83847ad7e2bc383081e051875e3429f9", "message": "[FLINK-18042][tests] Auto-detect distDir", "committedDate": "2020-06-08T16:55:48Z", "type": "forcePushed"}]}