{"pr_number": 12457, "pr_title": "[FLINK-18050][task][checkpointing] Fix double buffer recycling", "pr_createdAt": "2020-06-03T07:40:58Z", "pr_url": "https://github.com/apache/flink/pull/12457", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDgwNjQzOA==", "url": "https://github.com/apache/flink/pull/12457#discussion_r434806438", "bodyText": "Should be flinkBuffer (or simply buffer).", "author": "AHeise", "createdAt": "2020-06-03T19:36:06Z", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/channel/ChannelStateCheckpointWriter.java", "diffHunk": "@@ -108,32 +108,30 @@\n \t\trunWithChecks(() -> serializer.writeHeader(dataStream));\n \t}\n \n-\tvoid writeInput(InputChannelInfo info, Buffer... flinkBuffers) throws Exception {\n+\tvoid writeInput(InputChannelInfo info, Buffer flinkBuffers) throws Exception {", "originalCommit": "7e7fa184fdc100b55d436011081b645dc4ef069c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTA1ODE1Ng==", "url": "https://github.com/apache/flink/pull/12457#discussion_r435058156", "bodyText": "Renamed to buffer.\nThanks.", "author": "rkhachatryan", "createdAt": "2020-06-04T07:48:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDgwNjQzOA=="}], "type": "inlineReview", "revised_code": {"commit": "c82a846fddbc958f8f7dbd34b67e720147e517d5", "chunk": "diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/channel/ChannelStateCheckpointWriter.java b/flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/channel/ChannelStateCheckpointWriter.java\nindex a2e496863a0..8ce8fc01a65 100644\n--- a/flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/channel/ChannelStateCheckpointWriter.java\n+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/channel/ChannelStateCheckpointWriter.java\n\n@@ -108,12 +108,12 @@ class ChannelStateCheckpointWriter {\n \t\trunWithChecks(() -> serializer.writeHeader(dataStream));\n \t}\n \n-\tvoid writeInput(InputChannelInfo info, Buffer flinkBuffers) throws Exception {\n-\t\twrite(inputChannelOffsets, info, flinkBuffers, !allInputsReceived);\n+\tvoid writeInput(InputChannelInfo info, Buffer buffer) throws Exception {\n+\t\twrite(inputChannelOffsets, info, buffer, !allInputsReceived);\n \t}\n \n-\tvoid writeOutput(ResultSubpartitionInfo info, Buffer flinkBuffers) throws Exception {\n-\t\twrite(resultSubpartitionOffsets, info, flinkBuffers, !allOutputsReceived);\n+\tvoid writeOutput(ResultSubpartitionInfo info, Buffer buffer) throws Exception {\n+\t\twrite(resultSubpartitionOffsets, info, buffer, !allOutputsReceived);\n \t}\n \n \tprivate <K> void write(Map<K, StateContentMetaInfo> offsets, K key, Buffer buffer, boolean precondition) throws Exception {\n"}}, {"oid": "c82a846fddbc958f8f7dbd34b67e720147e517d5", "url": "https://github.com/apache/flink/commit/c82a846fddbc958f8f7dbd34b67e720147e517d5", "message": "[FLINK-18050][task][checkpointing] Simplify ChannelStateCheckpointWriter interface", "committedDate": "2020-06-04T07:47:46Z", "type": "forcePushed"}, {"oid": "3f7a6a0cdf9514bd87fcbd4738b8373b73771d4f", "url": "https://github.com/apache/flink/commit/3f7a6a0cdf9514bd87fcbd4738b8373b73771d4f", "message": "[FLINK-18050][task][checkpointing] Simplify ChannelStateCheckpointWriter interface", "committedDate": "2020-06-04T07:48:12Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTY4NzI5OA==", "url": "https://github.com/apache/flink/pull/12457#discussion_r435687298", "bodyText": "What's the difference to the previous version? Especially in the behaviour? It looks like a subtle change that I'm missing.", "author": "pnowojski", "createdAt": "2020-06-05T04:45:50Z", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/channel/ChannelStateWriteRequest.java", "diffHunk": "@@ -52,6 +53,10 @@ static ChannelStateWriteRequest write(long checkpointId, InputChannelInfo info,\n \t\treturn buildWriteRequest(checkpointId, \"writeInput\", iterator, (writer, buffer) -> writer.writeInput(info, buffer));\n \t}\n \n+\tstatic ChannelStateWriteRequest write(long checkpointId, ResultSubpartitionInfo info, Buffer... buffers) {\n+\t\treturn buildWriteRequest(checkpointId, \"writeOutput\", ofElements(Buffer::recycleBuffer, buffers), (writer, buffer) -> writer.writeOutput(info, buffer));\n+\t}\n+", "originalCommit": "16d10ec923bd6af73a5188d9d4b86105f252d6f7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc0MTc5Nw==", "url": "https://github.com/apache/flink/pull/12457#discussion_r435741797", "bodyText": "It is using CloseableIterator now, which recycles on unused elements on close().\nPrevious version recycled all buffers in cancel regardless of whether they were used or not.", "author": "rkhachatryan", "createdAt": "2020-06-05T07:36:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTY4NzI5OA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTY4NzM5MQ==", "url": "https://github.com/apache/flink/pull/12457#discussion_r435687391", "bodyText": "Can you copy JIRA description to this commit description? By looking at it, it's quite hard to understand what is it fixing and how.", "author": "pnowojski", "createdAt": "2020-06-05T04:46:17Z", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/channel/ChannelStateWriteRequest.java", "diffHunk": "@@ -32,6 +32,7 @@\n import static org.apache.flink.runtime.checkpoint.channel.CheckpointInProgressRequestState.EXECUTING;\n import static org.apache.flink.runtime.checkpoint.channel.CheckpointInProgressRequestState.FAILED;\n import static org.apache.flink.runtime.checkpoint.channel.CheckpointInProgressRequestState.NEW;\n+import static org.apache.flink.util.CloseableIterator.ofElements;", "originalCommit": "16d10ec923bd6af73a5188d9d4b86105f252d6f7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc0NTkyMA==", "url": "https://github.com/apache/flink/pull/12457#discussion_r435745920", "bodyText": "Done.", "author": "rkhachatryan", "createdAt": "2020-06-05T07:44:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTY4NzM5MQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTY4Nzg2OQ==", "url": "https://github.com/apache/flink/pull/12457#discussion_r435687869", "bodyText": "Why have you dropped checkBufferType call? It was actually quite helpful couple of times when debugging. Can not we try to keep it?", "author": "pnowojski", "createdAt": "2020-06-05T04:48:16Z", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/channel/ChannelStateWriterImpl.java", "diffHunk": "@@ -129,7 +129,7 @@ public void addOutputData(long checkpointId, ResultSubpartitionInfo info, int st\n \t\t\tinfo,\n \t\t\tstartSeqNum,\n \t\t\tdata == null ? 0 : data.length);\n-\t\tenqueue(write(checkpointId, info, checkBufferType(data)), false);\n+\t\tenqueue(write(checkpointId, info, data), false);", "originalCommit": "16d10ec923bd6af73a5188d9d4b86105f252d6f7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc0MjQ2OQ==", "url": "https://github.com/apache/flink/pull/12457#discussion_r435742469", "bodyText": "It is now called when building iterator - in the same way as for InputChannel buffers.", "author": "rkhachatryan", "createdAt": "2020-06-05T07:37:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTY4Nzg2OQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "a90076edd01cef67caa4afd80fa2e0d7bca50c68", "url": "https://github.com/apache/flink/commit/a90076edd01cef67caa4afd80fa2e0d7bca50c68", "message": "[FLINK-18050][task][checkpointing] Simplify ChannelStateCheckpointWriter interface", "committedDate": "2020-06-05T07:44:14Z", "type": "forcePushed"}, {"oid": "4f13d5351c3aab2467703f61f4c214ae914c9997", "url": "https://github.com/apache/flink/commit/4f13d5351c3aab2467703f61f4c214ae914c9997", "message": "[FLINK-18050][task][checkpointing] Use CloseableIterator to write ResultSubpartition state\n\nCurrently, buffers passed to ChannelStateWriterImpl can be recycled\ntwice: once in normal case after writing; second in\nCheckpointInProgressRequest.cancel (called from ChannelStateWriteRequestDispatcher\nand other places).\n\nThis change prevents this by using CloseableIterator which distinguishes\nused and unused elements.", "committedDate": "2020-06-08T08:06:18Z", "type": "commit"}, {"oid": "ecde35e592929909c3151aeefdb0f7a934447dd3", "url": "https://github.com/apache/flink/commit/ecde35e592929909c3151aeefdb0f7a934447dd3", "message": "[FLINK-18050][task][checkpointing] Simplify ChannelStateCheckpointWriter interface", "committedDate": "2020-06-08T08:07:27Z", "type": "commit"}, {"oid": "ecde35e592929909c3151aeefdb0f7a934447dd3", "url": "https://github.com/apache/flink/commit/ecde35e592929909c3151aeefdb0f7a934447dd3", "message": "[FLINK-18050][task][checkpointing] Simplify ChannelStateCheckpointWriter interface", "committedDate": "2020-06-08T08:07:27Z", "type": "forcePushed"}]}