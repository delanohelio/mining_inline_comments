{"pr_number": 12323, "pr_title": "[FLINK-17925][fs-connector] Fix Filesystem options to default values and types", "pr_createdAt": "2020-05-25T13:41:02Z", "pr_url": "https://github.com/apache/flink/pull/12323", "timeline": [{"oid": "32ca1d9dfc0cb2ab212c123240de70d084f7bc12", "url": "https://github.com/apache/flink/commit/32ca1d9dfc0cb2ab212c123240de70d084f7bc12", "message": "[FLINK-17925][fs-connector] Fix Filesystem options to default values and types", "committedDate": "2020-05-26T06:47:23Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDIyMDI3OA==", "url": "https://github.com/apache/flink/pull/12323#discussion_r430220278", "bodyText": "I'm not sure if the error message is easy to understand. What is \"a table without metastore\"?", "author": "lirui-apache", "createdAt": "2020-05-26T07:50:14Z", "path": "flink-table/flink-table-runtime-blink/src/main/java/org/apache/flink/table/filesystem/PartitionCommitPolicy.java", "diffHunk": "@@ -121,4 +122,20 @@\n \t\t\t}\n \t\t}).collect(Collectors.toList());\n \t}\n+\n+\t/**\n+\t * Validate commit policy.\n+\t */\n+\tstatic void validatePolicyChain(boolean isEmptyMetastore, String policyKind) {\n+\t\tif (policyKind != null) {\n+\t\t\tString[] policyStrings = policyKind.split(\",\");\n+\t\t\tfor (String policy : policyStrings) {\n+\t\t\t\tif (isEmptyMetastore && METASTORE.equalsIgnoreCase(policy)) {\n+\t\t\t\t\tthrow new ValidationException(\n+\t\t\t\t\t\t\t\"Can not configure a metastore partition commit policy for\" +\n+\t\t\t\t\t\t\t\t\t\" a table without metastore.\");", "originalCommit": "32ca1d9dfc0cb2ab212c123240de70d084f7bc12", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDg1OTkyMg==", "url": "https://github.com/apache/flink/pull/12323#discussion_r430859922", "bodyText": "I think we can just say file system connector.\nCan not configure a 'metastore' partition commit policy for a file system table. You can only configure 'metastore' partition commit policy for a hive table.", "author": "JingsongLi", "createdAt": "2020-05-27T05:09:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDIyMDI3OA=="}], "type": "inlineReview", "revised_code": {"commit": "98969a631431250b1dcd51384af00083f3dc0f9e", "chunk": "diff --git a/flink-table/flink-table-runtime-blink/src/main/java/org/apache/flink/table/filesystem/PartitionCommitPolicy.java b/flink-table/flink-table-runtime-blink/src/main/java/org/apache/flink/table/filesystem/PartitionCommitPolicy.java\nindex 2d3ef3446d0..9074b7f5990 100644\n--- a/flink-table/flink-table-runtime-blink/src/main/java/org/apache/flink/table/filesystem/PartitionCommitPolicy.java\n+++ b/flink-table/flink-table-runtime-blink/src/main/java/org/apache/flink/table/filesystem/PartitionCommitPolicy.java\n\n@@ -131,9 +131,9 @@ public interface PartitionCommitPolicy {\n \t\t\tString[] policyStrings = policyKind.split(\",\");\n \t\t\tfor (String policy : policyStrings) {\n \t\t\t\tif (isEmptyMetastore && METASTORE.equalsIgnoreCase(policy)) {\n-\t\t\t\t\tthrow new ValidationException(\n-\t\t\t\t\t\t\t\"Can not configure a metastore partition commit policy for\" +\n-\t\t\t\t\t\t\t\t\t\" a table without metastore.\");\n+\t\t\t\t\tthrow new ValidationException(\"Can not configure a 'metastore' partition commit\" +\n+\t\t\t\t\t\t\t\" policy for a file system table. You can only configure 'metastore'\" +\n+\t\t\t\t\t\t\t\" partition commit policy for a hive table.\");\n \t\t\t\t}\n \t\t\t}\n \t\t}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDIyOTA3MQ==", "url": "https://github.com/apache/flink/pull/12323#discussion_r430229071", "bodyText": "I find this config a little bit weird.\nprocess-time means \"process-time > partition dir create time + delay\"\npartition-time means \"watermark > partition-time + delay\"\nSeems the two options configure different parts of the inequation. What if user wants to compare watermark with partition dir create time, or compare process-time with time extracted from partition values?", "author": "lirui-apache", "createdAt": "2020-05-26T08:05:12Z", "path": "flink-table/flink-table-runtime-blink/src/main/java/org/apache/flink/table/filesystem/FileSystemOptions.java", "diffHunk": "@@ -132,12 +133,12 @@\n \tpublic static final ConfigOption<String> SINK_PARTITION_COMMIT_TRIGGER =\n \t\t\tkey(\"sink.partition-commit.trigger\")\n \t\t\t\t\t.stringType()\n-\t\t\t\t\t.defaultValue(\"partition-time\")\n+\t\t\t\t\t.defaultValue(\"process-time\")\n \t\t\t\t\t.withDescription(\"Trigger type for partition commit:\" +", "originalCommit": "32ca1d9dfc0cb2ab212c123240de70d084f7bc12", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDg2MTMyMA==", "url": "https://github.com/apache/flink/pull/12323#discussion_r430861320", "bodyText": "'process-time': use processing time, if 'current time' > 'partition creation time' + 'delay', will commit the partition.\n'partition-time': extract time from partition, if 'current event time' > 'time from partition values' + 'delay', will commit the partition.\n\ntime from partition values is a kind of event time.\npartition creation time is from processing time.\nSo they're not orthogonal.", "author": "JingsongLi", "createdAt": "2020-05-27T05:14:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDIyOTA3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDg3OTg5MA==", "url": "https://github.com/apache/flink/pull/12323#discussion_r430879890", "bodyText": "Maybe not all combinations make sense. But my point is these two options are counter-intuitive therefore hard to understand. partition-time specifies how to extract time attribute for a partition, while process-time specifies how to use the time attribute extracted from a partition. So we're using one config to specify different things. Perhaps the two options should be either partition-dir-time vs partition-value-time, or process-time vs event-time?\nBesides, I think we should be consistent with terminologies in our docs. Is 'current time' the same thing as 'process time'? If so, let's stick to 'process time' because that's what we've been using in other documentations. If not, then we need to define what 'current time' is so that users can understand.", "author": "lirui-apache", "createdAt": "2020-05-27T06:16:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDIyOTA3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDkzNjY5OQ==", "url": "https://github.com/apache/flink/pull/12323#discussion_r430936699", "bodyText": "After some offline discussion, I think partition-time is more direct. Adjust the comments further.", "author": "JingsongLi", "createdAt": "2020-05-27T08:14:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDIyOTA3MQ=="}], "type": "inlineReview", "revised_code": {"commit": "98969a631431250b1dcd51384af00083f3dc0f9e", "chunk": "diff --git a/flink-table/flink-table-runtime-blink/src/main/java/org/apache/flink/table/filesystem/FileSystemOptions.java b/flink-table/flink-table-runtime-blink/src/main/java/org/apache/flink/table/filesystem/FileSystemOptions.java\nindex 375467df635..667bb834fe7 100644\n--- a/flink-table/flink-table-runtime-blink/src/main/java/org/apache/flink/table/filesystem/FileSystemOptions.java\n+++ b/flink-table/flink-table-runtime-blink/src/main/java/org/apache/flink/table/filesystem/FileSystemOptions.java\n\n@@ -135,10 +135,11 @@ public class FileSystemOptions {\n \t\t\t\t\t.stringType()\n \t\t\t\t\t.defaultValue(\"process-time\")\n \t\t\t\t\t.withDescription(\"Trigger type for partition commit:\" +\n-\t\t\t\t\t\t\t\" 'process-time': use processing time, if 'current processing time' > \" +\n-\t\t\t\t\t\t\t\"'partition directory creation time' + 'delay', will commit the partition.\" +\n+\t\t\t\t\t\t\t\" 'process-time': use processing time, if 'current time' > \" +\n+\t\t\t\t\t\t\t\"'partition creation time' + 'delay', will commit the partition.\" +\n \t\t\t\t\t\t\t\" 'partition-time': extract time from partition,\" +\n-\t\t\t\t\t\t\t\" if 'watermark' > 'partition-time' + 'delay', will commit the partition.\");\n+\t\t\t\t\t\t\t\" if 'current event time' > 'time from partition values' + 'delay',\" +\n+\t\t\t\t\t\t\t\" will commit the partition.\");\n \n \tpublic static final ConfigOption<Duration> SINK_PARTITION_COMMIT_DELAY =\n \t\t\tkey(\"sink.partition-commit.delay\")\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDIzMjIyNg==", "url": "https://github.com/apache/flink/pull/12323#discussion_r430232226", "bodyText": "It's not really an empty implementation right? Because we still need it to get the location path?", "author": "lirui-apache", "createdAt": "2020-05-26T08:11:01Z", "path": "flink-table/flink-table-runtime-blink/src/main/java/org/apache/flink/table/filesystem/EmptyMetaStoreFactory.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.table.filesystem;\n+\n+import org.apache.flink.annotation.Internal;\n+import org.apache.flink.core.fs.Path;\n+\n+import java.util.LinkedHashMap;\n+import java.util.Optional;\n+\n+/**\n+ * Empty implementation {@link TableMetaStoreFactory}.", "originalCommit": "32ca1d9dfc0cb2ab212c123240de70d084f7bc12", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDg1OTIyMg==", "url": "https://github.com/apache/flink/pull/12323#discussion_r430859222", "bodyText": "I will deprecate getLocationPath(Only deprecated batch sink use this). It should be empty implementation.", "author": "JingsongLi", "createdAt": "2020-05-27T05:06:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDIzMjIyNg=="}], "type": "inlineReview", "revised_code": null}, {"oid": "381435ead9d1708a0e58ca29d2b8a625441465ab", "url": "https://github.com/apache/flink/commit/381435ead9d1708a0e58ca29d2b8a625441465ab", "message": "[FLINK-17925][fs-connector] Fix Filesystem options to default values and types", "committedDate": "2020-05-27T09:18:46Z", "type": "commit"}, {"oid": "98969a631431250b1dcd51384af00083f3dc0f9e", "url": "https://github.com/apache/flink/commit/98969a631431250b1dcd51384af00083f3dc0f9e", "message": "Fix comments", "committedDate": "2020-05-27T09:18:46Z", "type": "commit"}, {"oid": "9fc43be9e2ab8106c66a130fb0e9e75078d6e412", "url": "https://github.com/apache/flink/commit/9fc43be9e2ab8106c66a130fb0e9e75078d6e412", "message": "Update sink.partition-commit.trigger comments", "committedDate": "2020-05-27T09:18:46Z", "type": "commit"}, {"oid": "15c87e13feeee57424aa261c656e1d0d37c5b734", "url": "https://github.com/apache/flink/commit/15c87e13feeee57424aa261c656e1d0d37c5b734", "message": "Update sink.partition-commit.trigger comments", "committedDate": "2020-05-27T09:18:46Z", "type": "commit"}, {"oid": "7fc0274d7c1e9eb3b7682278274b08d9cb0ae950", "url": "https://github.com/apache/flink/commit/7fc0274d7c1e9eb3b7682278274b08d9cb0ae950", "message": "Fix cases", "committedDate": "2020-05-27T09:20:16Z", "type": "commit"}, {"oid": "7fc0274d7c1e9eb3b7682278274b08d9cb0ae950", "url": "https://github.com/apache/flink/commit/7fc0274d7c1e9eb3b7682278274b08d9cb0ae950", "message": "Fix cases", "committedDate": "2020-05-27T09:20:16Z", "type": "forcePushed"}]}