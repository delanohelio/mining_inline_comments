{"pr_number": 13594, "pr_title": "[FLINK-19423][jdbc] Fix ArrayIndexOutOfBoundsException when executing DELETE statement in JDBC upsert sink", "pr_createdAt": "2020-10-12T13:15:49Z", "pr_url": "https://github.com/apache/flink/pull/13594", "timeline": [{"oid": "9bcebe7b1ec733192f6b96067ede9ecd7c18115a", "url": "https://github.com/apache/flink/commit/9bcebe7b1ec733192f6b96067ede9ecd7c18115a", "message": "[FLINK-19423][jdbc] Fix ArrayIndexOutOfBoundsException when executing DELETE statement in JDBC upsert sink", "committedDate": "2020-10-12T13:13:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzgwMzAzOA==", "url": "https://github.com/apache/flink/pull/13594#discussion_r503803038", "bodyText": "nice catch", "author": "leonardBang", "createdAt": "2020-10-13T09:26:52Z", "path": "flink-connectors/flink-connector-jdbc/src/main/java/org/apache/flink/connector/jdbc/table/JdbcDynamicOutputFormatBuilder.java", "diffHunk": "@@ -182,7 +168,12 @@ public JdbcDynamicOutputFormatBuilder setFieldDataTypes(DataType[] fieldDataType\n \t\tcheckArgument(dmlOptions.getKeyFields().isPresent());\n \t\tString[] pkNames = Arrays.stream(pkFields).mapToObj(k -> dmlOptions.getFieldNames()[k]).toArray(String[]::new);\n \t\tString deleteSql = dmlOptions.getDialect().getDeleteStatement(dmlOptions.getTableName(), pkNames);\n-\t\treturn createKeyedRowExecutor(dmlOptions.getDialect(), pkFields, pkTypes, deleteSql, fieldTypes);\n+\t\tJdbcRowConverter rowConverter = dmlOptions.getDialect().getRowConverter(RowType.of(pkTypes));\n+\t\tFunction<RowData, RowData> keyExtractor = createRowKeyExtractor(fieldTypes, pkFields);\n+\t\treturn JdbcBatchStatementExecutor.keyed(\n+\t\t\tdeleteSql,\n+\t\t\tkeyExtractor,\n+\t\t\t(st, key) -> rowConverter.toExternal(key, st));", "originalCommit": "9bcebe7b1ec733192f6b96067ede9ecd7c18115a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}