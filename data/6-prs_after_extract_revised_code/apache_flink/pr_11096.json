{"pr_number": 11096, "pr_title": "[FLINK-16056][runtime][tests] fix CFRO creation in tests", "pr_createdAt": "2020-02-14T13:11:41Z", "pr_url": "https://github.com/apache/flink/pull/11096", "timeline": [{"oid": "6f1f37ee8baceee6d08b4c4d2439d46f2c144688", "url": "https://github.com/apache/flink/commit/6f1f37ee8baceee6d08b4c4d2439d46f2c144688", "message": "[FLINK-16056][runtime][tests] create CFRO using factory only\nAlso drop test constructor and make the class package-private.", "committedDate": "2020-02-14T13:25:24Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTQ3MTQ1MA==", "url": "https://github.com/apache/flink/pull/11096#discussion_r379471450", "bodyText": "should that also complete future?", "author": "AHeise", "createdAt": "2020-02-14T14:52:04Z", "path": "flink-fs-tests/src/test/java/org/apache/flink/hdfstests/ContinuousFileProcessingITCase.java", "diffHunk": "@@ -140,29 +141,25 @@ public void testProgram() throws Exception {\n \t\tTestingSinkFunction sink = new TestingSinkFunction();\n \t\tcontent.addSink(sink).setParallelism(1);\n \n-\t\tThread job = new Thread() {\n-\n-\t\t\t@Override\n-\t\t\tpublic void run() {\n-\t\t\t\ttry {\n-\t\t\t\t\tenv.execute(\"ContinuousFileProcessingITCase Job.\");\n-\t\t\t\t} catch (Exception e) {\n-\t\t\t\t\tThrowable th = e;\n-\t\t\t\t\tfor (int depth = 0; depth < 20; depth++) {\n-\t\t\t\t\t\tif (th instanceof SuccessException) {\n-\t\t\t\t\t\t\treturn;\n-\t\t\t\t\t\t} else if (th.getCause() != null) {\n-\t\t\t\t\t\t\tth = th.getCause();\n-\t\t\t\t\t\t} else {\n-\t\t\t\t\t\t\tbreak;\n-\t\t\t\t\t\t}\n+\t\tCompletableFuture<Void> jobFuture = new CompletableFuture<>();\n+\t\tnew Thread(() -> {\n+\t\t\ttry {\n+\t\t\t\tenv.execute(\"ContinuousFileProcessingITCase Job.\");\n+\t\t\t\tjobFuture.complete(null);\n+\t\t\t} catch (Exception e) {\n+\t\t\t\tThrowable th = e;\n+\t\t\t\tfor (int depth = 0; depth < 20; depth++) {\n+\t\t\t\t\tif (th instanceof SuccessException) {\n+\t\t\t\t\t\treturn;", "originalCommit": "42cb3bf3fb7e78c0525d330c6289861601d68ba6", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "0dba3ab8494396950450c3a94d1a215c19783b70", "chunk": "diff --git a/flink-fs-tests/src/test/java/org/apache/flink/hdfstests/ContinuousFileProcessingITCase.java b/flink-fs-tests/src/test/java/org/apache/flink/hdfstests/ContinuousFileProcessingITCase.java\nindex 73c2e38147b..8dadbb34a13 100644\n--- a/flink-fs-tests/src/test/java/org/apache/flink/hdfstests/ContinuousFileProcessingITCase.java\n+++ b/flink-fs-tests/src/test/java/org/apache/flink/hdfstests/ContinuousFileProcessingITCase.java\n\n@@ -147,17 +148,11 @@ public class ContinuousFileProcessingITCase extends AbstractTestBase {\n \t\t\t\tenv.execute(\"ContinuousFileProcessingITCase Job.\");\n \t\t\t\tjobFuture.complete(null);\n \t\t\t} catch (Exception e) {\n-\t\t\t\tThrowable th = e;\n-\t\t\t\tfor (int depth = 0; depth < 20; depth++) {\n-\t\t\t\t\tif (th instanceof SuccessException) {\n-\t\t\t\t\t\treturn;\n-\t\t\t\t\t} else if (th.getCause() != null) {\n-\t\t\t\t\t\tth = th.getCause();\n-\t\t\t\t\t} else {\n-\t\t\t\t\t\tbreak;\n-\t\t\t\t\t}\n+\t\t\t\tif (ExceptionUtils.findThrowable(e, SuccessException.class).isPresent()) {\n+\t\t\t\t\tjobFuture.complete(null);\n+\t\t\t\t} else {\n+\t\t\t\t\tjobFuture.completeExceptionally(e);\n \t\t\t\t}\n-\t\t\t\tjobFuture.completeExceptionally(e);\n \t\t\t}\n \t\t}).start();\n \n"}}, {"oid": "0dba3ab8494396950450c3a94d1a215c19783b70", "url": "https://github.com/apache/flink/commit/0dba3ab8494396950450c3a94d1a215c19783b70", "message": "[FLINK-16056][runtime][tests] do fail ContinuousFileProcessingITCase on failure", "committedDate": "2020-02-14T17:05:09Z", "type": "commit"}, {"oid": "f65641913b8e78475a174d4c45fcf6720324e894", "url": "https://github.com/apache/flink/commit/f65641913b8e78475a174d4c45fcf6720324e894", "message": "[FLINK-16056][runtime][tests] create CFRO using factory only\nAlso drop test constructor and make the class package-private.", "committedDate": "2020-02-14T17:05:09Z", "type": "forcePushed"}, {"oid": "34ac6e03b86281ba56a4108f0f713f7a769b1291", "url": "https://github.com/apache/flink/commit/34ac6e03b86281ba56a4108f0f713f7a769b1291", "message": "[FLINK-16056][runtime][tests] create CFRO using factory only\nAlso drop test constructor and make the class package-private.", "committedDate": "2020-02-14T19:52:47Z", "type": "forcePushed"}, {"oid": "03ed8e68f6175a3fa9cb86e4ab1e22fe3844b56b", "url": "https://github.com/apache/flink/commit/03ed8e68f6175a3fa9cb86e4ab1e22fe3844b56b", "message": "[FLINK-16056][runtime][tests] create ContinuousFileReaderOperator using factory only\nAlso drop test constructor and make the class package-private.", "committedDate": "2020-02-17T12:50:35Z", "type": "commit"}, {"oid": "03ed8e68f6175a3fa9cb86e4ab1e22fe3844b56b", "url": "https://github.com/apache/flink/commit/03ed8e68f6175a3fa9cb86e4ab1e22fe3844b56b", "message": "[FLINK-16056][runtime][tests] create ContinuousFileReaderOperator using factory only\nAlso drop test constructor and make the class package-private.", "committedDate": "2020-02-17T12:50:35Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDUxMDAwNA==", "url": "https://github.com/apache/flink/pull/11096#discussion_r380510004", "bodyText": "One more thing. Doesn't removal of line brake the java docs for this class (@Public so quite important)?\nReplace {@link ContinuousFileReaderOperator readers} with full class reference?", "author": "pnowojski", "createdAt": "2020-02-18T08:05:50Z", "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/api/environment/StreamExecutionEnvironment.java", "diffHunk": "@@ -70,7 +70,6 @@\n import org.apache.flink.streaming.api.datastream.DataStreamSource;\n import org.apache.flink.streaming.api.datastream.SingleOutputStreamOperator;\n import org.apache.flink.streaming.api.functions.source.ContinuousFileMonitoringFunction;\n-import org.apache.flink.streaming.api.functions.source.ContinuousFileReaderOperator;", "originalCommit": "03ed8e68f6175a3fa9cb86e4ab1e22fe3844b56b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDUxOTk0Ng==", "url": "https://github.com/apache/flink/pull/11096#discussion_r380519946", "bodyText": "Yes, but the actual operator type is now hidden in the factory, so I'd rather remove the reference at all and leave just plain \"readers\".", "author": "rkhachatryan", "createdAt": "2020-02-18T08:29:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDUxMDAwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDUyNjc2MA==", "url": "https://github.com/apache/flink/pull/11096#discussion_r380526760", "bodyText": "I think a reference to the code might be helpful for some more power users. I would be also fine with referencing ContinuousFileReaderOperatorFactory itself, as that wouldn't explode the comment's length.", "author": "pnowojski", "createdAt": "2020-02-18T08:44:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDUxMDAwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDUzNDA0OQ==", "url": "https://github.com/apache/flink/pull/11096#discussion_r380534049", "bodyText": "IMO javadoc of public API shouldn't talk about the implementation classes at all, unless there is a need (here there isn't). And \"power users\" should be able to go inside the method and see the implementation:)", "author": "rkhachatryan", "createdAt": "2020-02-18T08:59:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDUxMDAwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDYyMzE2Mg==", "url": "https://github.com/apache/flink/pull/11096#discussion_r380623162", "bodyText": "Ok, in that case please update the java docs.", "author": "pnowojski", "createdAt": "2020-02-18T11:47:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDUxMDAwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDY0NjYwOA==", "url": "https://github.com/apache/flink/pull/11096#discussion_r380646608", "bodyText": "Done.", "author": "rkhachatryan", "createdAt": "2020-02-18T12:40:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDUxMDAwNA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "1e3e2f44f247790ca4ab7718b005e88708905f1f", "url": "https://github.com/apache/flink/commit/1e3e2f44f247790ca4ab7718b005e88708905f1f", "message": "[FLINK-16056][docs] update StreamExecutionEnvironment javadoc", "committedDate": "2020-02-18T12:38:57Z", "type": "commit"}]}