{"pr_number": 10823, "pr_title": "[FLINK-15497][table-planner-blink] Reduce outputs when rank number is not required in Retractable topN", "pr_createdAt": "2020-01-10T08:13:23Z", "pr_url": "https://github.com/apache/flink/pull/10823", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTgwMzYzMg==", "url": "https://github.com/apache/flink/pull/10823#discussion_r365803632", "bodyText": "We should emit delete/retract record first, then emit accumulate record. Otherwise, there might be some problems, e.g. user may see instantly incorrect results (top3 but see top4 at some point of time).", "author": "wuchong", "createdAt": "2020-01-13T13:30:37Z", "path": "flink-table/flink-table-runtime-blink/src/test/java/org/apache/flink/table/runtime/operators/rank/RetractableTopNFunctionTest.java", "diffHunk": "@@ -209,12 +301,12 @@ public void testDisableGenerateRetraction() throws Exception {\n \t\tList<Object> expectedOutput = new ArrayList<>();\n \t\texpectedOutput.add(record(\"book\", 1L, 12));\n \t\texpectedOutput.add(record(\"book\", 2L, 19));\n-\t\texpectedOutput.add(record(\"book\", 1L, 12));\n \t\texpectedOutput.add(record(\"book\", 4L, 11));\n+\t\texpectedOutput.add(deleteRecord(\"book\", 2L, 19));", "originalCommit": "98b6f5aa1f7623e1aba1d1531a0a2973dbdc5873", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjY5MjAyNg==", "url": "https://github.com/apache/flink/pull/10823#discussion_r366692026", "bodyText": "make sense.", "author": "beyond1920", "createdAt": "2020-01-15T04:31:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTgwMzYzMg=="}], "type": "inlineReview", "revised_code": {"commit": "dafd00b6650ebfe1627fa8c7d08577d93aaf885b", "chunk": "diff --git a/flink-table/flink-table-runtime-blink/src/test/java/org/apache/flink/table/runtime/operators/rank/RetractableTopNFunctionTest.java b/flink-table/flink-table-runtime-blink/src/test/java/org/apache/flink/table/runtime/operators/rank/RetractableTopNFunctionTest.java\nindex 4c776e3e1e..26bfa65925 100644\n--- a/flink-table/flink-table-runtime-blink/src/test/java/org/apache/flink/table/runtime/operators/rank/RetractableTopNFunctionTest.java\n+++ b/flink-table/flink-table-runtime-blink/src/test/java/org/apache/flink/table/runtime/operators/rank/RetractableTopNFunctionTest.java\n\n@@ -301,14 +301,14 @@ public class RetractableTopNFunctionTest extends TopNFunctionTestBase {\n \t\tList<Object> expectedOutput = new ArrayList<>();\n \t\texpectedOutput.add(record(\"book\", 1L, 12));\n \t\texpectedOutput.add(record(\"book\", 2L, 19));\n-\t\texpectedOutput.add(record(\"book\", 4L, 11));\n \t\texpectedOutput.add(deleteRecord(\"book\", 2L, 19));\n+\t\texpectedOutput.add(record(\"book\", 4L, 11));\n \t\texpectedOutput.add(record(\"fruit\", 4L, 33));\n \t\texpectedOutput.add(record(\"fruit\", 3L, 44));\n-\t\texpectedOutput.add(record(\"fruit\", 5L, 22));\n \t\texpectedOutput.add(deleteRecord(\"fruit\", 3L, 44));\n+\t\texpectedOutput.add(record(\"fruit\", 5L, 22));\n \t\tassertorWithoutRowNumber\n-\t\t\t\t.assertOutputEqualsSorted(\"output wrong.\", expectedOutput, testHarness.getOutput());\n+\t\t\t\t.assertOutputEquals(\"output wrong.\", expectedOutput, testHarness.getOutput());\n \t}\n \n \t@Test\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI2MjQ4NQ==", "url": "https://github.com/apache/flink/pull/10823#discussion_r368262485", "bodyText": "Could you add some comments on this? IIUC, this is for padding the last entry because we retract a entry from the top-n.\nBesides, could you improve the local field name of tmpRank? It's not easy to understand what the rank it is.", "author": "wuchong", "createdAt": "2020-01-19T03:18:15Z", "path": "flink-table/flink-table-runtime-blink/src/main/java/org/apache/flink/table/runtime/operators/rank/RetractableTopNFunction.java", "diffHunk": "@@ -374,10 +381,10 @@ private void retractRecordWithoutRowNumber(\n \t\t\t} else if (findsSortKey) {\n \t\t\t\tlong count = entry.getValue();\n \t\t\t\tlong tmpRank = curRank + count;\n-\t\t\t\tif (isInRankEnd(tmpRank)) {\n+\t\t\t\tif (tmpRank < rankEnd) {", "originalCommit": "c57927e992beddecbb3eb93d71919b08abc469a7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b909bf785ad1163d97d8783fd784f2b294caa407", "chunk": "diff --git a/flink-table/flink-table-runtime-blink/src/main/java/org/apache/flink/table/runtime/operators/rank/RetractableTopNFunction.java b/flink-table/flink-table-runtime-blink/src/main/java/org/apache/flink/table/runtime/operators/rank/RetractableTopNFunction.java\nindex 7210a6296f..b40bb2271a 100644\n--- a/flink-table/flink-table-runtime-blink/src/main/java/org/apache/flink/table/runtime/operators/rank/RetractableTopNFunction.java\n+++ b/flink-table/flink-table-runtime-blink/src/main/java/org/apache/flink/table/runtime/operators/rank/RetractableTopNFunction.java\n\n@@ -381,10 +374,10 @@ public class RetractableTopNFunction extends AbstractTopNFunction {\n \t\t\t} else if (findsSortKey) {\n \t\t\t\tlong count = entry.getValue();\n \t\t\t\tlong tmpRank = curRank + count;\n-\t\t\t\tif (tmpRank < rankEnd) {\n+\t\t\t\tif (isInRankEnd(tmpRank)) {\n \t\t\t\t\tcurRank = tmpRank;\n \t\t\t\t} else {\n-\t\t\t\t\tint index = Long.valueOf(rankEnd - curRank -1).intValue();\n+\t\t\t\t\tint index = Long.valueOf(rankEnd - curRank).intValue();\n \t\t\t\t\tList<BaseRow> inputs = dataState.get(key);\n \t\t\t\t\tBaseRow toAdd = inputs.get(index);\n \t\t\t\t\t// send row which upgrades to TopN\n"}}, {"oid": "b909bf785ad1163d97d8783fd784f2b294caa407", "url": "https://github.com/apache/flink/commit/b909bf785ad1163d97d8783fd784f2b294caa407", "message": "[FLINK-15497][table-planner-blink] Reduce outputs when rank number is not required in RetractTopN", "committedDate": "2020-01-20T07:32:54Z", "type": "commit"}, {"oid": "dafd00b6650ebfe1627fa8c7d08577d93aaf885b", "url": "https://github.com/apache/flink/commit/dafd00b6650ebfe1627fa8c7d08577d93aaf885b", "message": "Updates based on comment", "committedDate": "2020-01-20T07:32:54Z", "type": "commit"}, {"oid": "5b1ff9333d79ebec7b5a99373dc7ec5994c52ed9", "url": "https://github.com/apache/flink/commit/5b1ff9333d79ebec7b5a99373dc7ec5994c52ed9", "message": "Minor updates.", "committedDate": "2020-01-20T07:32:54Z", "type": "forcePushed"}, {"oid": "c3e59d245648911d90c7c8488fc8e810e8ff6339", "url": "https://github.com/apache/flink/commit/c3e59d245648911d90c7c8488fc8e810e8ff6339", "message": "Minor updates.", "committedDate": "2020-01-20T07:37:29Z", "type": "commit"}, {"oid": "c3e59d245648911d90c7c8488fc8e810e8ff6339", "url": "https://github.com/apache/flink/commit/c3e59d245648911d90c7c8488fc8e810e8ff6339", "message": "Minor updates.", "committedDate": "2020-01-20T07:37:29Z", "type": "forcePushed"}]}