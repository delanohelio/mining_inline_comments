{"pr_number": 12118, "pr_title": "[FLINK-17636][network][tests] Fix the unstable unit tests in SingleInputGateTest", "pr_createdAt": "2020-05-13T09:45:11Z", "pr_url": "https://github.com/apache/flink/pull/12118", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDMyMDQzMQ==", "url": "https://github.com/apache/flink/pull/12118#discussion_r424320431", "bodyText": "The error message I think is incorrect, as I guess the point is, if the close future is NOT done, no exception should occur?\nif (!inputGate.getCloseFuture().isDone()) {\n  throw new AssertionError(\"Exceptions are expected here only if the gate was closed\", t);\n}", "author": "pnowojski", "createdAt": "2020-05-13T10:01:02Z", "path": "flink-runtime/src/test/java/org/apache/flink/runtime/io/network/partition/consumer/SingleInputGateTest.java", "diffHunk": "@@ -226,7 +225,8 @@ public void testConcurrentReadStateAndProcessAndClose() throws Exception {\n \t\t\t\t\t\tif (!getNextBufferAndVerify(inputGate, states)) {\n \t\t\t\t\t\t\tThread.sleep(1);\n \t\t\t\t\t\t}\n-\t\t\t\t\t} catch (CancelTaskException expected) {\n+\t\t\t\t\t} catch (Throwable t) {\n+\t\t\t\t\t\tassertTrue(\"The gate is expected closed, but the actual exception is \" + t.getMessage(), inputGate.getCloseFuture().isDone());", "originalCommit": "13f80049e7afb86c35be7b275c1cef74d7a81ab8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDMyMzYxNA==", "url": "https://github.com/apache/flink/pull/12118#discussion_r424323614", "bodyText": "Yes, the exception should only happen in the case of closed gate. Your error message seems better.", "author": "zhijiangW", "createdAt": "2020-05-13T10:06:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDMyMDQzMQ=="}], "type": "inlineReview", "revised_code": {"commit": "acd705534e988974406c28afd359821b3e7f3d1a", "chunk": "diff --git a/flink-runtime/src/test/java/org/apache/flink/runtime/io/network/partition/consumer/SingleInputGateTest.java b/flink-runtime/src/test/java/org/apache/flink/runtime/io/network/partition/consumer/SingleInputGateTest.java\nindex d003a2c5b61..abcf563b0bf 100644\n--- a/flink-runtime/src/test/java/org/apache/flink/runtime/io/network/partition/consumer/SingleInputGateTest.java\n+++ b/flink-runtime/src/test/java/org/apache/flink/runtime/io/network/partition/consumer/SingleInputGateTest.java\n\n@@ -226,7 +226,9 @@ public class SingleInputGateTest extends InputGateTestBase {\n \t\t\t\t\t\t\tThread.sleep(1);\n \t\t\t\t\t\t}\n \t\t\t\t\t} catch (Throwable t) {\n-\t\t\t\t\t\tassertTrue(\"The gate is expected closed, but the actual exception is \" + t.getMessage(), inputGate.getCloseFuture().isDone());\n+\t\t\t\t\t\tif (!inputGate.getCloseFuture().isDone()) {\n+\t\t\t\t\t\t\tthrow new AssertionError(\"Exceptions are expected here only if the gate was closed\", t);\n+\t\t\t\t\t\t}\n \t\t\t\t\t\treturn null;\n \t\t\t\t\t}\n \t\t\t\t}\n"}}, {"oid": "acd705534e988974406c28afd359821b3e7f3d1a", "url": "https://github.com/apache/flink/commit/acd705534e988974406c28afd359821b3e7f3d1a", "message": "[FLINK-17636][network][tests] Fix the unstable unit tests in SingleInputGateTest", "committedDate": "2020-05-13T10:10:48Z", "type": "commit"}, {"oid": "acd705534e988974406c28afd359821b3e7f3d1a", "url": "https://github.com/apache/flink/commit/acd705534e988974406c28afd359821b3e7f3d1a", "message": "[FLINK-17636][network][tests] Fix the unstable unit tests in SingleInputGateTest", "committedDate": "2020-05-13T10:10:48Z", "type": "forcePushed"}]}