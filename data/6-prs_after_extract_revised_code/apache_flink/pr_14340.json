{"pr_number": 14340, "pr_title": "[FLINK-20533][datadog] Add Histogram support ", "pr_createdAt": "2020-12-08T16:11:13Z", "pr_url": "https://github.com/apache/flink/pull/14340", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDg5ODYxMg==", "url": "https://github.com/apache/flink/pull/14340#discussion_r540898612", "bodyText": "This runs in a separate thread, but seems quite expensive with the string concat and the MetricsMetaData allocation each time we send the metric.\nDoes it make sense to initialize the MetaData with the different name suffixes in the constructor?", "author": "rmetzger", "createdAt": "2020-12-11T12:01:19Z", "path": "flink-metrics/flink-metrics-datadog/src/main/java/org/apache/flink/metrics/datadog/DHistogram.java", "diffHunk": "@@ -0,0 +1,61 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.metrics.datadog;\n+\n+import org.apache.flink.metrics.Histogram;\n+import org.apache.flink.metrics.HistogramStatistics;\n+\n+import java.util.List;\n+\n+/**\n+ * Maps histograms to datadog gauges.\n+ *\n+ * <p>Note: We cannot map them to datadog histograms because the HTTP API does not support them.\n+ */\n+public class DHistogram {\n+\tprivate final Histogram histogram;\n+\tprivate final MetricMetaData metaData;\n+\n+\tpublic DHistogram(Histogram histogram, String metricName, String host, List<String> tags, Clock clock) {\n+\t\tthis.histogram = histogram;\n+\t\tthis.metaData = new MetricMetaData(MetricType.gauge, metricName, host, tags, clock);\n+\t}\n+\n+\tpublic void addTo(DSeries series) {\n+\t\tfinal HistogramStatistics statistics = histogram.getStatistics();\n+\n+\t\t// this selection is based on https://docs.datadoghq.com/developers/metrics/types/?tab=histogram\n+\t\t// we only exclude 'sum' (which is optional), because we cannot compute it\n+\t\t// the semantics for count are also slightly different, because we don't reset it after a report\n+\t\tseries.add(new StaticDMetric(statistics.getMean(), withMetricNameSuffix(metaData, \"avg\")));\n+\t\tseries.add(new StaticDMetric(histogram.getCount(), withMetricNameSuffix(metaData, \"count\")));\n+\t\tseries.add(new StaticDMetric(statistics.getQuantile(.5), withMetricNameSuffix(metaData, \"median\")));\n+\t\tseries.add(new StaticDMetric(statistics.getQuantile(.95), withMetricNameSuffix(metaData, \"95percentile\")));\n+\t\tseries.add(new StaticDMetric(statistics.getMin(), withMetricNameSuffix(metaData, \"min\")));\n+\t\tseries.add(new StaticDMetric(statistics.getMax(), withMetricNameSuffix(metaData, \"max\")));", "originalCommit": "4f62e23c4ec3c38a510b4d3eb93935c6972b7e7e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDkzMzQ2NQ==", "url": "https://github.com/apache/flink/pull/14340#discussion_r540933465", "bodyText": "Yes, we should do this only once in the constructor; it's a waste of resources to do this every time.", "author": "zentol", "createdAt": "2020-12-11T13:06:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDg5ODYxMg=="}], "type": "inlineReview", "revised_code": {"commit": "ccbb7ca839b16f8d587fbcc88cb42be1fee636fc", "chunk": "diff --git a/flink-metrics/flink-metrics-datadog/src/main/java/org/apache/flink/metrics/datadog/DHistogram.java b/flink-metrics/flink-metrics-datadog/src/main/java/org/apache/flink/metrics/datadog/DHistogram.java\nindex 589575c5970..33a1788ab42 100644\n--- a/flink-metrics/flink-metrics-datadog/src/main/java/org/apache/flink/metrics/datadog/DHistogram.java\n+++ b/flink-metrics/flink-metrics-datadog/src/main/java/org/apache/flink/metrics/datadog/DHistogram.java\n\n@@ -17,6 +17,7 @@\n \n package org.apache.flink.metrics.datadog;\n \n+import org.apache.flink.annotation.VisibleForTesting;\n import org.apache.flink.metrics.Histogram;\n import org.apache.flink.metrics.HistogramStatistics;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDg5OTQzMA==", "url": "https://github.com/apache/flink/pull/14340#discussion_r540899430", "bodyText": "I understand you changed this for the tests, but it's a bit ugly. Maybe add a comment?", "author": "rmetzger", "createdAt": "2020-12-11T12:02:52Z", "path": "flink-metrics/flink-metrics-datadog/src/main/java/org/apache/flink/metrics/datadog/DatadogHttpClient.java", "diffHunk": "@@ -113,8 +113,8 @@ public void send(DSeries request) throws Exception {\n \t\tclient.newCall(r).enqueue(EmptyCallback.getEmptyCallback());\n \t}\n \n-\tpublic static String serialize(Object obj) throws JsonProcessingException {\n-\t\treturn MAPPER.writeValueAsString(obj);\n+\tpublic static String serialize(Object obj, ObjectMapper mapper) throws JsonProcessingException {\n+\t\treturn mapper.writeValueAsString(obj);", "originalCommit": "4f62e23c4ec3c38a510b4d3eb93935c6972b7e7e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDkwMTU3NA==", "url": "https://github.com/apache/flink/pull/14340#discussion_r540901574", "bodyText": "Strictly speaking this mapper is only necessary for having deterministic test results. The proper solution would probably be parsing the JSON response and compare the results not as a string.", "author": "rmetzger", "createdAt": "2020-12-11T12:07:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDg5OTQzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDkzNDE2NA==", "url": "https://github.com/apache/flink/pull/14340#discussion_r540934164", "bodyText": "Yeah I wasn't too happy with it either; it is especially finicky since every setting the reporter uses for the mapper is ignored by the test :/", "author": "zentol", "createdAt": "2020-12-11T13:07:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDg5OTQzMA=="}], "type": "inlineReview", "revised_code": {"commit": "ccbb7ca839b16f8d587fbcc88cb42be1fee636fc", "chunk": "diff --git a/flink-metrics/flink-metrics-datadog/src/main/java/org/apache/flink/metrics/datadog/DatadogHttpClient.java b/flink-metrics/flink-metrics-datadog/src/main/java/org/apache/flink/metrics/datadog/DatadogHttpClient.java\nindex 0407016ad2f..ba635217945 100644\n--- a/flink-metrics/flink-metrics-datadog/src/main/java/org/apache/flink/metrics/datadog/DatadogHttpClient.java\n+++ b/flink-metrics/flink-metrics-datadog/src/main/java/org/apache/flink/metrics/datadog/DatadogHttpClient.java\n\n@@ -113,8 +113,8 @@ public class DatadogHttpClient {\n \t\tclient.newCall(r).enqueue(EmptyCallback.getEmptyCallback());\n \t}\n \n-\tpublic static String serialize(Object obj, ObjectMapper mapper) throws JsonProcessingException {\n-\t\treturn mapper.writeValueAsString(obj);\n+\tpublic static String serialize(Object obj) throws JsonProcessingException {\n+\t\treturn MAPPER.writeValueAsString(obj);\n \t}\n \n \tpublic void close() {\n"}}, {"oid": "ccbb7ca839b16f8d587fbcc88cb42be1fee636fc", "url": "https://github.com/apache/flink/commit/ccbb7ca839b16f8d587fbcc88cb42be1fee636fc", "message": "[FLINK-20533][datadog] Add Histogram support", "committedDate": "2020-12-13T23:36:21Z", "type": "forcePushed"}, {"oid": "b2806b98f4e8c4702435847a5d6d9016a1e5decf", "url": "https://github.com/apache/flink/commit/b2806b98f4e8c4702435847a5d6d9016a1e5decf", "message": "[hotfix][datadog][tests] Cleanup code", "committedDate": "2020-12-15T10:40:23Z", "type": "commit"}, {"oid": "b993db3d01accf1f037129acc421d178a62e2449", "url": "https://github.com/apache/flink/commit/b993db3d01accf1f037129acc421d178a62e2449", "message": "[hotfix][datadog] Merge DSeries#add*()\n\nThe distinction between metric types adds unnecessary complexity.", "committedDate": "2020-12-15T10:40:23Z", "type": "commit"}, {"oid": "f6c7054176fe825ab9f3d53460afb992314f02e2", "url": "https://github.com/apache/flink/commit/f6c7054176fe825ab9f3d53460afb992314f02e2", "message": "[hotfix][datadog] Explicitly mark fields relevant for serialization\n\nIt was difficult to tell which fields are relevant for serialization. Adding annotations makes this more obvious, and allows us more freedom in regards to naming.", "committedDate": "2020-12-15T10:40:23Z", "type": "commit"}, {"oid": "6e6bc099b1ae8eb988f9ef5da218b111daae0689", "url": "https://github.com/apache/flink/commit/6e6bc099b1ae8eb988f9ef5da218b111daae0689", "message": "[hotfix][datadog][tests] Rework tests\n\n- re-parse JSON to ignore order of serialization\n- restrict 'DatadogHttpClient.serialize()' to 'DSeries'\n- test series serialization\n- refer to constants where possible", "committedDate": "2020-12-15T10:40:23Z", "type": "commit"}, {"oid": "98b53561048c58a6140b15a5ba6dcc511dc8e78d", "url": "https://github.com/apache/flink/commit/98b53561048c58a6140b15a5ba6dcc511dc8e78d", "message": "[hotfix][datadog] Remove outdated comments", "committedDate": "2020-12-15T10:40:23Z", "type": "commit"}, {"oid": "700c1788f6127ded1c49a103e01e8c8e0c6897be", "url": "https://github.com/apache/flink/commit/700c1788f6127ded1c49a103e01e8c8e0c6897be", "message": "[FLINK-20533][datadog] Encapsulate metric meta data\n\nThis allows us to use the 'MetricMetaData' container for histograms later on, which will not directly extend 'DMetric'.", "committedDate": "2020-12-15T10:40:23Z", "type": "commit"}, {"oid": "3dfcdba2dc6932632be7ef4391a03c7db3688b63", "url": "https://github.com/apache/flink/commit/3dfcdba2dc6932632be7ef4391a03c7db3688b63", "message": "[FLINK-20533][datadog] Add Histogram support", "committedDate": "2020-12-15T12:06:38Z", "type": "commit"}, {"oid": "3dfcdba2dc6932632be7ef4391a03c7db3688b63", "url": "https://github.com/apache/flink/commit/3dfcdba2dc6932632be7ef4391a03c7db3688b63", "message": "[FLINK-20533][datadog] Add Histogram support", "committedDate": "2020-12-15T12:06:38Z", "type": "forcePushed"}]}