{"pr_number": 11489, "pr_title": "[FLINK-15640][k8s] Support to set labels for jobmanager and taskmanager pod", "pr_createdAt": "2020-03-23T10:04:19Z", "pr_url": "https://github.com/apache/flink/pull/11489", "timeline": [{"oid": "bb02ce865fa48c9259500a8408897605534b35c2", "url": "https://github.com/apache/flink/commit/bb02ce865fa48c9259500a8408897605534b35c2", "message": "[FLINK-15640][k8s] Support to set node selector for jobmanager and taskmanager pod", "committedDate": "2020-03-23T10:25:48Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkwNDk5MQ==", "url": "https://github.com/apache/flink/pull/11489#discussion_r396904991", "bodyText": "According to the order, the users can override the built-in labels by customization. I think the built-in labels should prioritize the user-specified ones. WDYT?", "author": "zhengcanbin", "createdAt": "2020-03-24T05:08:50Z", "path": "flink-kubernetes/src/main/java/org/apache/flink/kubernetes/kubeclient/parameters/KubernetesJobManagerParameters.java", "diffHunk": "@@ -52,10 +54,16 @@ public KubernetesJobManagerParameters(Configuration flinkConfig, ClusterSpecific\n \n \t@Override\n \tpublic Map<String, String> getLabels() {\n-\t\tMap<String, String> labels = getCommonLabels();\n+\t\tfinal Map<String, String> labels = new HashMap<>(getCommonLabels());\n \t\tlabels.put(Constants.LABEL_COMPONENT_KEY, Constants.LABEL_COMPONENT_JOB_MANAGER);\n+\t\tflinkConfig.getOptional(KubernetesConfigOptions.JOB_MANAGER_LABELS).ifPresent(labels::putAll);", "originalCommit": "bb02ce865fa48c9259500a8408897605534b35c2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA1NjA0Nw==", "url": "https://github.com/apache/flink/pull/11489#discussion_r397056047", "bodyText": "I think you are right. I will prioritize the built-in labels.", "author": "wangyang0918", "createdAt": "2020-03-24T10:42:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkwNDk5MQ=="}], "type": "inlineReview", "revised_code": {"commit": "3e878d1bd9107c7827414b484d22bc8d8dbd3c65", "chunk": "diff --git a/flink-kubernetes/src/main/java/org/apache/flink/kubernetes/kubeclient/parameters/KubernetesJobManagerParameters.java b/flink-kubernetes/src/main/java/org/apache/flink/kubernetes/kubeclient/parameters/KubernetesJobManagerParameters.java\nindex 85d8825084..b6120b83e6 100644\n--- a/flink-kubernetes/src/main/java/org/apache/flink/kubernetes/kubeclient/parameters/KubernetesJobManagerParameters.java\n+++ b/flink-kubernetes/src/main/java/org/apache/flink/kubernetes/kubeclient/parameters/KubernetesJobManagerParameters.java\n\n@@ -54,18 +54,13 @@ public class KubernetesJobManagerParameters extends AbstractKubernetesParameters\n \n \t@Override\n \tpublic Map<String, String> getLabels() {\n-\t\tfinal Map<String, String> labels = new HashMap<>(getCommonLabels());\n+\t\tfinal Map<String, String> labels = new HashMap<>();\n+\t\tlabels.putAll(flinkConfig.getOptional(KubernetesConfigOptions.JOB_MANAGER_LABELS).orElse(Collections.emptyMap()));\n+\t\tlabels.putAll(getCommonLabels());\n \t\tlabels.put(Constants.LABEL_COMPONENT_KEY, Constants.LABEL_COMPONENT_JOB_MANAGER);\n-\t\tflinkConfig.getOptional(KubernetesConfigOptions.JOB_MANAGER_LABELS).ifPresent(labels::putAll);\n \t\treturn Collections.unmodifiableMap(labels);\n \t}\n \n-\t@Override\n-\tpublic Map<String, String> getNodeSelector() {\n-\t\treturn Collections.unmodifiableMap(\n-\t\t\tflinkConfig.getOptional(KubernetesConfigOptions.JOB_MANAGER_NODE_SELECTOR).orElse(Collections.emptyMap()));\n-\t}\n-\n \t@Override\n \tpublic Map<String, String> getEnvironments() {\n \t\treturn getPrefixedEnvironments(ResourceManagerOptions.CONTAINERIZED_MASTER_ENV_PREFIX);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkwNjM0Ng==", "url": "https://github.com/apache/flink/pull/11489#discussion_r396906346", "bodyText": "How about changing the key from kubernetes.jobmanager.node-selector to kubernetes.jobmanager.node-selectors? We use the plural for the user-specified annotations and labels, in the meantime use the singular for the node-selector. Could we use a consistent key naming convention for these kind of config options?", "author": "zhengcanbin", "createdAt": "2020-03-24T05:14:59Z", "path": "flink-kubernetes/src/main/java/org/apache/flink/kubernetes/configuration/KubernetesConfigOptions.java", "diffHunk": "@@ -111,6 +112,34 @@\n \t// The following config options could be overridden by KubernetesCliOptions.\n \t// ---------------------------------------------------------------------------------\n \n+\tpublic static final ConfigOption<Map<String, String>> JOB_MANAGER_LABELS =\n+\t\tkey(\"kubernetes.jobmanager.labels\")\n+\t\t.mapType()\n+\t\t.noDefaultValue()\n+\t\t.withDescription(\"The labels to be set for JobManager pod. Specified as key:value pairs separated by commas. \" +\n+\t\t\t\"For example, version:alphav1,deploy:test.\");\n+\n+\tpublic static final ConfigOption<Map<String, String>> TASK_MANAGER_LABELS =\n+\t\tkey(\"kubernetes.taskmanager.labels\")\n+\t\t.mapType()\n+\t\t.noDefaultValue()\n+\t\t.withDescription(\"The labels to be set for TaskManager pods. Specified as key:value pairs separated by commas. \" +\n+\t\t\t\"For example, version:alphav1,deploy:test.\");\n+\n+\tpublic static final ConfigOption<Map<String, String>> JOB_MANAGER_NODE_SELECTOR =\n+\t\tkey(\"kubernetes.jobmanager.node-selector\")", "originalCommit": "bb02ce865fa48c9259500a8408897605534b35c2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA1NTU4Ng==", "url": "https://github.com/apache/flink/pull/11489#discussion_r397055586", "bodyText": "I use singular for node-selector because in the K8s yaml file it is always singular. For labels and annotations, they are plural. So i am just trying to keep the same behavior with K8s document.\nIf you insist of changing it to node-selectors, i could update it.", "author": "wangyang0918", "createdAt": "2020-03-24T10:41:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkwNjM0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA2NzM3NQ==", "url": "https://github.com/apache/flink/pull/11489#discussion_r397067375", "bodyText": "I use singular for node-selector because in the K8s yaml file it is always singular. For labels and annotations, they are plural. So i am just trying to keep the same behavior with K8s document.\nIf you insist of changing it to node-selectors, i could update it.\n\nIndeed, the K8s use the singular for node-selector. I think you are right, we'd better try our best to keep consistent with the K8s side.", "author": "zhengcanbin", "createdAt": "2020-03-24T11:01:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkwNjM0Ng=="}], "type": "inlineReview", "revised_code": {"commit": "3e878d1bd9107c7827414b484d22bc8d8dbd3c65", "chunk": "diff --git a/flink-kubernetes/src/main/java/org/apache/flink/kubernetes/configuration/KubernetesConfigOptions.java b/flink-kubernetes/src/main/java/org/apache/flink/kubernetes/configuration/KubernetesConfigOptions.java\nindex b902362e8e..dc0a6d8fec 100644\n--- a/flink-kubernetes/src/main/java/org/apache/flink/kubernetes/configuration/KubernetesConfigOptions.java\n+++ b/flink-kubernetes/src/main/java/org/apache/flink/kubernetes/configuration/KubernetesConfigOptions.java\n\n@@ -126,20 +126,6 @@ public class KubernetesConfigOptions {\n \t\t.withDescription(\"The labels to be set for TaskManager pods. Specified as key:value pairs separated by commas. \" +\n \t\t\t\"For example, version:alphav1,deploy:test.\");\n \n-\tpublic static final ConfigOption<Map<String, String>> JOB_MANAGER_NODE_SELECTOR =\n-\t\tkey(\"kubernetes.jobmanager.node-selector\")\n-\t\t.mapType()\n-\t\t.noDefaultValue()\n-\t\t.withDescription(\"The node selector to be set for JobManager pod. Specified as key:value pairs separated by \" +\n-\t\t\t\"commas. For example, environment:production,disk:ssd.\");\n-\n-\tpublic static final ConfigOption<Map<String, String>> TASK_MANAGER_NODE_SELECTOR =\n-\t\tkey(\"kubernetes.taskmanager.node-selector\")\n-\t\t.mapType()\n-\t\t.noDefaultValue()\n-\t\t.withDescription(\"The node selector to be set for TaskManager pods. Specified as key:value pairs separated by \" +\n-\t\t\t\"commas. For example, environment:production,disk:ssd.\");\n-\n \tpublic static final ConfigOption<String> CLUSTER_ID =\n \t\tkey(\"kubernetes.cluster-id\")\n \t\t.stringType()\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkwNjk3Mw==", "url": "https://github.com/apache/flink/pull/11489#discussion_r396906973", "bodyText": "The same precedence problem?", "author": "zhengcanbin", "createdAt": "2020-03-24T05:17:58Z", "path": "flink-kubernetes/src/main/java/org/apache/flink/kubernetes/kubeclient/parameters/KubernetesTaskManagerParameters.java", "diffHunk": "@@ -59,7 +62,15 @@ public KubernetesTaskManagerParameters(\n \n \t@Override\n \tpublic Map<String, String> getLabels() {\n-\t\treturn KubernetesUtils.getTaskManagerLabels(getClusterId());\n+\t\tfinal Map<String, String> labels = new HashMap<>(KubernetesUtils.getTaskManagerLabels(getClusterId()));\n+\t\tflinkConfig.getOptional(KubernetesConfigOptions.TASK_MANAGER_LABELS).ifPresent(labels::putAll);", "originalCommit": "bb02ce865fa48c9259500a8408897605534b35c2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3e878d1bd9107c7827414b484d22bc8d8dbd3c65", "chunk": "diff --git a/flink-kubernetes/src/main/java/org/apache/flink/kubernetes/kubeclient/parameters/KubernetesTaskManagerParameters.java b/flink-kubernetes/src/main/java/org/apache/flink/kubernetes/kubeclient/parameters/KubernetesTaskManagerParameters.java\nindex 6db237ced3..7292079dee 100644\n--- a/flink-kubernetes/src/main/java/org/apache/flink/kubernetes/kubeclient/parameters/KubernetesTaskManagerParameters.java\n+++ b/flink-kubernetes/src/main/java/org/apache/flink/kubernetes/kubeclient/parameters/KubernetesTaskManagerParameters.java\n\n@@ -62,17 +62,12 @@ public class KubernetesTaskManagerParameters extends AbstractKubernetesParameter\n \n \t@Override\n \tpublic Map<String, String> getLabels() {\n-\t\tfinal Map<String, String> labels = new HashMap<>(KubernetesUtils.getTaskManagerLabels(getClusterId()));\n-\t\tflinkConfig.getOptional(KubernetesConfigOptions.TASK_MANAGER_LABELS).ifPresent(labels::putAll);\n+\t\tfinal Map<String, String> labels = new HashMap<>();\n+\t\tlabels.putAll(flinkConfig.getOptional(KubernetesConfigOptions.TASK_MANAGER_LABELS).orElse(Collections.emptyMap()));\n+\t\tlabels.putAll(KubernetesUtils.getTaskManagerLabels(getClusterId()));\n \t\treturn Collections.unmodifiableMap(labels);\n \t}\n \n-\t@Override\n-\tpublic Map<String, String> getNodeSelector() {\n-\t\treturn Collections.unmodifiableMap(\n-\t\t\tflinkConfig.getOptional(KubernetesConfigOptions.TASK_MANAGER_NODE_SELECTOR).orElse(Collections.emptyMap()));\n-\t}\n-\n \t@Override\n \tpublic Map<String, String> getEnvironments() {\n \t\treturn this.containeredTaskManagerParameters.taskManagerEnv();\n"}}, {"oid": "3e878d1bd9107c7827414b484d22bc8d8dbd3c65", "url": "https://github.com/apache/flink/commit/3e878d1bd9107c7827414b484d22bc8d8dbd3c65", "message": "[FLINK-15640][k8s] Support to set labels for jobmanager and taskmanager pod", "committedDate": "2020-03-24T13:15:11Z", "type": "forcePushed"}, {"oid": "9a71b6a999e564d76981346f79ecc625df4d1fcd", "url": "https://github.com/apache/flink/commit/9a71b6a999e564d76981346f79ecc625df4d1fcd", "message": "[FLINK-15640][k8s] Support to set labels for jobmanager and taskmanager pod", "committedDate": "2020-03-24T13:18:53Z", "type": "forcePushed"}, {"oid": "9f00be70f392bc99fad2e2ca34a39dacb57f41a2", "url": "https://github.com/apache/flink/commit/9f00be70f392bc99fad2e2ca34a39dacb57f41a2", "message": "[hotfix][k8s] Close kube client in tear down", "committedDate": "2020-03-25T01:21:13Z", "type": "commit"}, {"oid": "496e0c34c6cdc9c6a4b1bf6a72df71328c2580e8", "url": "https://github.com/apache/flink/commit/496e0c34c6cdc9c6a4b1bf6a72df71328c2580e8", "message": "[FLINK-15640][k8s] Support to set labels for jobmanager and taskmanager pod", "committedDate": "2020-03-25T01:26:25Z", "type": "forcePushed"}, {"oid": "5fc814200599cb0f4b8042b8d264e338c94ad2d3", "url": "https://github.com/apache/flink/commit/5fc814200599cb0f4b8042b8d264e338c94ad2d3", "message": "[FLINK-15640][k8s] Support to set labels for jobmanager and taskmanager pod", "committedDate": "2020-03-25T01:34:19Z", "type": "commit"}, {"oid": "5fc814200599cb0f4b8042b8d264e338c94ad2d3", "url": "https://github.com/apache/flink/commit/5fc814200599cb0f4b8042b8d264e338c94ad2d3", "message": "[FLINK-15640][k8s] Support to set labels for jobmanager and taskmanager pod", "committedDate": "2020-03-25T01:34:19Z", "type": "forcePushed"}]}