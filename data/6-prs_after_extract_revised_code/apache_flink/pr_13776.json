{"pr_number": 13776, "pr_title": "[FLINK-19717][connectors/common] Fix spurious InputStatus.END_OF_INPUT from SourceReaderBase.pollNext caused by split reader exception", "pr_createdAt": "2020-10-23T15:01:59Z", "pr_url": "https://github.com/apache/flink/pull/13776", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTQxOTg4Ng==", "url": "https://github.com/apache/flink/pull/13776#discussion_r519419886", "bodyText": "I am curious. Is there a reason that we replace the ThrowableCatchingRunnable wrapper with the explicit error handler passed to the split fetcher here?", "author": "becketqin", "createdAt": "2020-11-08T14:42:35Z", "path": "flink-connectors/flink-connector-base/src/main/java/org/apache/flink/connector/base/source/reader/fetcher/SplitFetcherManager.java", "diffHunk": "@@ -112,7 +111,7 @@ public void accept(Throwable t) {\n \tpublic abstract void addSplits(List<SplitT> splitsToAdd);\n \n \tprotected void startFetcher(SplitFetcher<E, SplitT> fetcher) {\n-\t\texecutors.submit(new ThrowableCatchingRunnable(errorHandler, fetcher));\n+\t\texecutors.submit(fetcher);", "originalCommit": "100b67ca171766bec1ff561a66688471b24745be", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTQzNDgwMw==", "url": "https://github.com/apache/flink/pull/13776#discussion_r519434803", "bodyText": "We need error-setting(errorHandler.accept(t)) happens-before fetcher-removing(shutdownHook.run()) so that newly added error-checking wouldn't lost it. In order to achieve this, we need move errorHandler to SplitFetcher where shutdownHook locates in. After movement, ThrowableCatchingRunnable is useless.\nBesides above semantic changes, I think it would be good to drop extra layer between two concurrent components SourceReaderBase and SplitFetcher.", "author": "kezhuw", "createdAt": "2020-11-08T15:26:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTQxOTg4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTQzNDg0OQ==", "url": "https://github.com/apache/flink/pull/13776#discussion_r519434849", "bodyText": "I personally like the change - less wrapping tends to make code navigation easier. But this is a matter of taste here, either way looks totally fine.", "author": "StephanEwen", "createdAt": "2020-11-08T15:27:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTQxOTg4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTQzNjE1Nw==", "url": "https://github.com/apache/flink/pull/13776#discussion_r519436157", "bodyText": "But I think @kezhuw has a point - having this in the same class (rather than in a separat class ThrowableCatchingRunnable) is a good if there is a strict contract between the exception handling and closing. Otherwise the exception handling is factored out into a separate class (ThrowableCatchingRunnable) but with an implicit contract on how it must be used, to guarantee the happens-before relationship.", "author": "StephanEwen", "createdAt": "2020-11-08T15:30:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTQxOTg4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTQ0MjgzOQ==", "url": "https://github.com/apache/flink/pull/13776#discussion_r519442839", "bodyText": "@becketqin I see new code in SplitFetcher.run throwing exception after shutdownHook.run. Is there any specific reason where run splitReader.close after shutdownHook ? Or, in another word, does exception from splitReader.close should fail job ? I will do rebase to solve conflict, please take a took after rebasing.", "author": "kezhuw", "createdAt": "2020-11-08T15:52:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTQxOTg4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTUyNDk1Nw==", "url": "https://github.com/apache/flink/pull/13776#discussion_r519524957", "bodyText": "@kezhuw Thanks for the explanation. Good point.", "author": "becketqin", "createdAt": "2020-11-09T02:44:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTQxOTg4Ng=="}], "type": "inlineReview", "revised_code": {"commit": "9abbb16d8e84c2ef779d578e1c0d33aeca9b7952", "chunk": "diff --git a/flink-connectors/flink-connector-base/src/main/java/org/apache/flink/connector/base/source/reader/fetcher/SplitFetcherManager.java b/flink-connectors/flink-connector-base/src/main/java/org/apache/flink/connector/base/source/reader/fetcher/SplitFetcherManager.java\nindex f5e762e1aae..efd60f4542b 100644\n--- a/flink-connectors/flink-connector-base/src/main/java/org/apache/flink/connector/base/source/reader/fetcher/SplitFetcherManager.java\n+++ b/flink-connectors/flink-connector-base/src/main/java/org/apache/flink/connector/base/source/reader/fetcher/SplitFetcherManager.java\n\n@@ -111,7 +112,7 @@ public abstract class SplitFetcherManager<E, SplitT extends SourceSplit> {\n \tpublic abstract void addSplits(List<SplitT> splitsToAdd);\n \n \tprotected void startFetcher(SplitFetcher<E, SplitT> fetcher) {\n-\t\texecutors.submit(fetcher);\n+\t\texecutors.submit(new ThrowableCatchingRunnable(errorHandler, fetcher));\n \t}\n \n \t/**\n"}}, {"oid": "34137c2a23fa01e836a8e990c7094ab7359b37fd", "url": "https://github.com/apache/flink/commit/34137c2a23fa01e836a8e990c7094ab7359b37fd", "message": "[hotfix] Throw UnsupportedOperationException for not implemented MockSplitEnumeratorContext.runInCoordinatorThread", "committedDate": "2020-11-08T16:20:42Z", "type": "forcePushed"}, {"oid": "9abbb16d8e84c2ef779d578e1c0d33aeca9b7952", "url": "https://github.com/apache/flink/commit/9abbb16d8e84c2ef779d578e1c0d33aeca9b7952", "message": "[FLINK-19717][connectors/common] Modify SourceReaderBaseTest.testExceptionInSplitReader to assert not END_OF_INPUT in case of split reader exception", "committedDate": "2020-11-08T17:59:57Z", "type": "commit"}, {"oid": "89580c411718035563019a64bbf178dcb6b739e8", "url": "https://github.com/apache/flink/commit/89580c411718035563019a64bbf178dcb6b739e8", "message": "[FLINK-19717][connectors/common] Fix spurious InputStatus.END_OF_INPUT from SourceReaderBase.pollNext caused by split reader exception", "committedDate": "2020-11-08T17:59:57Z", "type": "forcePushed"}, {"oid": "c138c988f40fa5f328f5560750a5ccab744ce279", "url": "https://github.com/apache/flink/commit/c138c988f40fa5f328f5560750a5ccab744ce279", "message": "[FLINK-19717][connectors/common] Fix spurious InputStatus.END_OF_INPUT from SourceReaderBase.pollNext caused by split reader exception", "committedDate": "2020-11-08T18:02:30Z", "type": "commit"}, {"oid": "c138c988f40fa5f328f5560750a5ccab744ce279", "url": "https://github.com/apache/flink/commit/c138c988f40fa5f328f5560750a5ccab744ce279", "message": "[FLINK-19717][connectors/common] Fix spurious InputStatus.END_OF_INPUT from SourceReaderBase.pollNext caused by split reader exception", "committedDate": "2020-11-08T18:02:30Z", "type": "forcePushed"}]}