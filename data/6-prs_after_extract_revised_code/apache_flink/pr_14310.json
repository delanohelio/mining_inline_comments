{"pr_number": 14310, "pr_title": "[FLINK-20486][hive] Hive temporal join shouldn't require a minimal 1h monitor interval", "pr_createdAt": "2020-12-04T11:23:27Z", "pr_url": "https://github.com/apache/flink/pull/14310", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA2OTYxOQ==", "url": "https://github.com/apache/flink/pull/14310#discussion_r536069619", "bodyText": "I'm curious how we decided that 1h is the recommended value for monitor interval, and why a smaller value, say, 30min can cause pressure on metastore?", "author": "lirui-apache", "createdAt": "2020-12-04T12:37:23Z", "path": "flink-connectors/flink-connector-hive/src/main/java/org/apache/flink/connectors/hive/HiveLookupTableSource.java", "diffHunk": "@@ -114,16 +117,16 @@ private void validateLookupConfigurations() {\n \t\t\tDuration monitorInterval = configuration.get(STREAMING_SOURCE_MONITOR_INTERVAL) == null\n \t\t\t\t\t? DEFAULT_LOOKUP_MONITOR_INTERVAL\n \t\t\t\t\t: configuration.get(STREAMING_SOURCE_MONITOR_INTERVAL);\n-\t\t\tPreconditions.checkArgument(\n-\t\t\t\t\tmonitorInterval.toMillis() >= DEFAULT_LOOKUP_MONITOR_INTERVAL.toMillis(),\n-\t\t\t\t\tString.format(\n-\t\t\t\t\t\t\t\"Currently the value of '%s' is required bigger or equal to default value '%s' \" +\n-\t\t\t\t\t\t\t\t\t\"when set '%s' to 'latest', but actual is '%s'\",\n-\t\t\t\t\t\t\tSTREAMING_SOURCE_MONITOR_INTERVAL.key(),\n-\t\t\t\t\t\t\tDEFAULT_LOOKUP_MONITOR_INTERVAL.toMillis(),\n-\t\t\t\t\t\t\tSTREAMING_SOURCE_PARTITION_INCLUDE.key(),\n-\t\t\t\t\t\t\tmonitorInterval.toMillis())\n-\t\t\t);\n+\n+\t\t\tif (monitorInterval.toMillis() < DEFAULT_LOOKUP_MONITOR_INTERVAL.toMillis()) {\n+\t\t\t\tLOG.warn(String.format(\n+\t\t\t\t\t\"Currently the recommended value of '%s' is bigger than default value '%s' \" +", "originalCommit": "cded2fcb5f10c8d6bdbfdece1c591fa658377f90", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA3MDQwMQ==", "url": "https://github.com/apache/flink/pull/14310#discussion_r536070401", "bodyText": "It seems to me that contacting metastore every 30min for new partitions should be absolutely fine.", "author": "lirui-apache", "createdAt": "2020-12-04T12:38:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA2OTYxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE5MDE1Nw==", "url": "https://github.com/apache/flink/pull/14310#discussion_r536190157", "bodyText": "The duration 1h is just an empirical value, compare to 30min, hive partition that use hour is more common that hive partition use  half an hour.", "author": "leonardBang", "createdAt": "2020-12-04T15:42:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA2OTYxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzE5OTc1OA==", "url": "https://github.com/apache/flink/pull/14310#discussion_r537199758", "bodyText": "I agree 1h may be more popular than 30min for partitioning. But just because more users use 1h doesn't mean those using 30min deserve a scary warning.\nWhen writing stream data into hive, we usually tell users that the minimum value supported for sink.partition-commit.delay is around 10min. So I suppose the warning threshold here shouldn't be bigger than that. Because if users can commit new partitions every 10min, it's reasonable to assume they also want to monitor at roughly the same interval. WDYT?", "author": "lirui-apache", "createdAt": "2020-12-07T03:05:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA2OTYxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzIyMDcxMg==", "url": "https://github.com/apache/flink/pull/14310#discussion_r537220712", "bodyText": "I agree with @lirui-apache here.", "author": "wuchong", "createdAt": "2020-12-07T04:20:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA2OTYxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzIyMjQ1MQ==", "url": "https://github.com/apache/flink/pull/14310#discussion_r537222451", "bodyText": "So I suppose the warning threshold here shouldn't be bigger than that.\n\nI totally agree that we should align the behaviour, but as the document reminded, currently the look up hive parttiont implementation is visit metastore from every task and the  hive-streaming source/sink just visit metastore from one task. So, I'm worried about use same value is not a good choice from current situation.", "author": "leonardBang", "createdAt": "2020-12-07T04:26:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA2OTYxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzI1ODU4Mg==", "url": "https://github.com/apache/flink/pull/14310#discussion_r537258582", "bodyText": "@leonardBang  I see your point and I didn't realize it's distributed access to HMS. In that case, I'm fine to keep the threshold as it is. Perhaps we should worry more about how many tasks can concurrently access HMS, than how often they access.\nOne more suggestion about the log message: I think \"Currently the recommended value of '%s' is at least '%s' when set... is easier to understand.", "author": "lirui-apache", "createdAt": "2020-12-07T06:23:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA2OTYxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzI3NjIwMA==", "url": "https://github.com/apache/flink/pull/14310#discussion_r537276200", "bodyText": "@lirui-apache Nice suggestion, will update soon", "author": "leonardBang", "createdAt": "2020-12-07T07:11:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA2OTYxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzMwNjUzOQ==", "url": "https://github.com/apache/flink/pull/14310#discussion_r537306539", "bodyText": "Perhaps we should worry more about how many tasks can concurrently access HMS, than how often they access.\n\nMaybe we need introduce a new mechanism the source can notify the all join subtask when to update in Flink SQL", "author": "leonardBang", "createdAt": "2020-12-07T08:13:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA2OTYxOQ=="}], "type": "inlineReview", "revised_code": {"commit": "9a8532f2384af5fab3b187902da54c32d05b713a", "chunk": "diff --git a/flink-connectors/flink-connector-hive/src/main/java/org/apache/flink/connectors/hive/HiveLookupTableSource.java b/flink-connectors/flink-connector-hive/src/main/java/org/apache/flink/connectors/hive/HiveLookupTableSource.java\nindex 00e1d8a8f1..0d2bf1e529 100644\n--- a/flink-connectors/flink-connector-hive/src/main/java/org/apache/flink/connectors/hive/HiveLookupTableSource.java\n+++ b/flink-connectors/flink-connector-hive/src/main/java/org/apache/flink/connectors/hive/HiveLookupTableSource.java\n\n@@ -120,8 +120,8 @@ public class HiveLookupTableSource extends HiveTableSource implements LookupTabl\n \n \t\t\tif (monitorInterval.toMillis() < DEFAULT_LOOKUP_MONITOR_INTERVAL.toMillis()) {\n \t\t\t\tLOG.warn(String.format(\n-\t\t\t\t\t\"Currently the recommended value of '%s' is bigger than default value '%s' \" +\n-\t\t\t\t\t\t\"when set '%s' to 'latest', but actual is '%s', this may produce big pressure to hive metastore.\",\n+\t\t\t\t\t\"Currently the recommended value of '%s' is at least '%s' when set '%s' to 'latest',\" +\n+\t\t\t\t\t\t\" but actual is '%s', this may produce big pressure to hive metastore.\",\n \t\t\t\t\tSTREAMING_SOURCE_MONITOR_INTERVAL.key(),\n \t\t\t\t\tDEFAULT_LOOKUP_MONITOR_INTERVAL.toMillis(),\n \t\t\t\t\tSTREAMING_SOURCE_PARTITION_INCLUDE.key(),\n"}}, {"oid": "9a8532f2384af5fab3b187902da54c32d05b713a", "url": "https://github.com/apache/flink/commit/9a8532f2384af5fab3b187902da54c32d05b713a", "message": "[FLINK-20486][hive] Hive temporal join shouldn't require a minimal 1h monitor interval", "committedDate": "2020-12-07T07:25:23Z", "type": "commit"}, {"oid": "9a8532f2384af5fab3b187902da54c32d05b713a", "url": "https://github.com/apache/flink/commit/9a8532f2384af5fab3b187902da54c32d05b713a", "message": "[FLINK-20486][hive] Hive temporal join shouldn't require a minimal 1h monitor interval", "committedDate": "2020-12-07T07:25:23Z", "type": "forcePushed"}]}