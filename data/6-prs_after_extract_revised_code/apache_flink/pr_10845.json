{"pr_number": 10845, "pr_title": "[FLINK-15355][plugins]Classloader restricts access to parent to whitelist.", "pr_createdAt": "2020-01-13T15:43:03Z", "pr_url": "https://github.com/apache/flink/pull/10845", "timeline": [{"oid": "ce62e6539d1394a5d27d8ef51db010104852e433", "url": "https://github.com/apache/flink/commit/ce62e6539d1394a5d27d8ef51db010104852e433", "message": "[FLINK-15355][plugins] Classloader avoids loading unrelated services.\n\nExtends child-first class loader to a child-only classloader for service definitions.\n\nPlugins are considered self-contained such that all required services are contained within it. Thus, it would even be possible to use different versions of security providers for different classes.\n\nThis behavior also avoids accidental loading of services outside of the plugin, especially for hadoop distributions in /lib. A service loader from the plugin would detect such services but cannot load them successfully because parts of the service' class hierarchy would have been loaded with the system class loader.", "committedDate": "2020-01-13T15:41:21Z", "type": "forcePushed"}, {"oid": "76bd16a406b4bbbee5d4189b66f1fdd36f98798f", "url": "https://github.com/apache/flink/commit/76bd16a406b4bbbee5d4189b66f1fdd36f98798f", "message": "[FLINK-15355][plugins]Classloader restricts access to parent to whitelist.\n\nNo class/resource in the system class loader (everything in lib/) can be seen in the plugin except those starting with a whitelist prefix.", "committedDate": "2020-01-14T17:31:14Z", "type": "forcePushed"}, {"oid": "726f81492a05cc47657a9c30caf2e397e8c1bd02", "url": "https://github.com/apache/flink/commit/726f81492a05cc47657a9c30caf2e397e8c1bd02", "message": "[FLINK-15355][plugins]Classloader restricts access to parent to whitelist.\n\nNo class/resource in the system class loader (everything in lib/) can be seen in the plugin except those starting with a whitelist prefix.", "committedDate": "2020-01-14T19:55:57Z", "type": "forcePushed"}, {"oid": "18934ef582e5ba278289541d8602b081c4f63367", "url": "https://github.com/apache/flink/commit/18934ef582e5ba278289541d8602b081c4f63367", "message": "[FLINK-15355][plugins]Classloader restricts access to parent to whitelist.\n\nNo class/resource in the system class loader (everything in lib/) can be seen in the plugin except those starting with a whitelist prefix.", "committedDate": "2020-01-14T21:52:38Z", "type": "forcePushed"}, {"oid": "ebd3076a0b24751eca2dce1d3faf646b56fe6426", "url": "https://github.com/apache/flink/commit/ebd3076a0b24751eca2dce1d3faf646b56fe6426", "message": "[FLINK-15355][plugins]Classloader restricts access to whitelisted system classes.\n\nNo class/resource in the system class loader (everything in lib/) can be seen in the plugin except those starting with a whitelist prefix.", "committedDate": "2020-01-15T08:50:26Z", "type": "forcePushed"}, {"oid": "ac9c94daa036cec2cb2bb2d53890e67594046479", "url": "https://github.com/apache/flink/commit/ac9c94daa036cec2cb2bb2d53890e67594046479", "message": "[hotfix][core] Renamed parent first pattern to parent patterns.\n\nClasses with the given pattern have never been resolved through the child loader. The new name makes clear that these classes are only loaded through the parent loader.", "committedDate": "2020-01-15T09:25:58Z", "type": "forcePushed"}, {"oid": "82749633c593106d881301f9ffe59d28e96d4d38", "url": "https://github.com/apache/flink/commit/82749633c593106d881301f9ffe59d28e96d4d38", "message": "[hotfix][core] Renamed parent first pattern to parent patterns.\n\nClasses with the given pattern have never been resolved through the child loader. The new name makes clear that these classes are only loaded through the parent loader.", "committedDate": "2020-01-15T12:20:30Z", "type": "forcePushed"}, {"oid": "1034dba580372caff0bb82196ff9cfb4dde746bd", "url": "https://github.com/apache/flink/commit/1034dba580372caff0bb82196ff9cfb4dde746bd", "message": "[hotfix][core] Renamed parent first pattern to parent patterns.\n\nClasses with the given pattern have never been resolved through the child loader. The new name makes clear that these classes are only loaded through the parent loader.", "committedDate": "2020-01-15T16:44:58Z", "type": "forcePushed"}, {"oid": "50b191d8a123d0e6277bbd6f60bd0c0b4e1db09d", "url": "https://github.com/apache/flink/commit/50b191d8a123d0e6277bbd6f60bd0c0b4e1db09d", "message": "[hotfix][core] Renamed parent first pattern to parent patterns.\n\nClasses with the given pattern have never been resolved through the child loader. The new name makes clear that these classes are only loaded through the parent loader.", "committedDate": "2020-01-15T17:27:32Z", "type": "forcePushed"}, {"oid": "8cf994af7e606da2c92da33d4003293e96ba4c16", "url": "https://github.com/apache/flink/commit/8cf994af7e606da2c92da33d4003293e96ba4c16", "message": "[hotfix][core] Renamed parent first pattern to parent patterns.\n\nClasses with the given pattern have never been resolved through the child loader. The new name makes clear that these classes are only loaded through the parent loader.", "committedDate": "2020-01-15T19:06:01Z", "type": "forcePushed"}, {"oid": "d87188f93fc355553279ec5b0b9343ee09ac478b", "url": "https://github.com/apache/flink/commit/d87188f93fc355553279ec5b0b9343ee09ac478b", "message": "[hotfix][core] Renamed parent first pattern to parent patterns.\n\nClasses with the given pattern have never been resolved through the child loader. The new name makes clear that these classes are only loaded through the parent loader.", "committedDate": "2020-01-15T21:00:13Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzI3NjQxNA==", "url": "https://github.com/apache/flink/pull/10845#discussion_r367276414", "bodyText": "revert?", "author": "pnowojski", "createdAt": "2020-01-16T08:02:41Z", "path": "flink-core/src/main/java/org/apache/flink/configuration/CoreOptions.java", "diffHunk": "@@ -121,7 +121,7 @@\n \tpublic static final ConfigOption<String> PLUGIN_ALWAYS_PARENT_FIRST_LOADER_PATTERNS = ConfigOptions\n \t\t.key(\"plugin.classloader.parent-first-patterns.default\")\n \t\t.stringType()\n-\t\t.defaultValue(\"java.;scala.;org.apache.flink.;javax.annotation.;org.slf4j;org.apache.log4j;org.apache\" +\n+\t\t.defaultValue(\"java.;javax.;scala.;org.apache.flink.;org.slf4j;org.apache.log4j;org.apache\" +", "originalCommit": "c1bd37255a1fbdffba63def90f85f9c1a0557d32", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e725912b1cf6f948c5aa4d3b8c3c647deada9387", "chunk": "diff --git a/flink-core/src/main/java/org/apache/flink/configuration/CoreOptions.java b/flink-core/src/main/java/org/apache/flink/configuration/CoreOptions.java\nindex d1fadffb8c0..d29afddb2c6 100644\n--- a/flink-core/src/main/java/org/apache/flink/configuration/CoreOptions.java\n+++ b/flink-core/src/main/java/org/apache/flink/configuration/CoreOptions.java\n\n@@ -121,7 +121,7 @@ public class CoreOptions {\n \tpublic static final ConfigOption<String> PLUGIN_ALWAYS_PARENT_FIRST_LOADER_PATTERNS = ConfigOptions\n \t\t.key(\"plugin.classloader.parent-first-patterns.default\")\n \t\t.stringType()\n-\t\t.defaultValue(\"java.;javax.;scala.;org.apache.flink.;org.slf4j;org.apache.log4j;org.apache\" +\n+\t\t.defaultValue(\"java.;scala.;org.apache.flink.;javax.annotation.;org.slf4j;org.apache.log4j;org.apache\" +\n \t\t\t\".logging;org.apache.commons.logging;ch.qos.logback\")\n \t\t.withDescription(\"A (semicolon-separated) list of patterns that specifies which classes should always be\" +\n \t\t\t\" resolved through the plugin parent ClassLoader first. A pattern is a simple prefix that is checked \" +\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzI3OTUxOQ==", "url": "https://github.com/apache/flink/pull/10845#discussion_r367279519", "bodyText": "return super.getResource(name);\n\n?", "author": "pnowojski", "createdAt": "2020-01-16T08:12:06Z", "path": "flink-core/src/main/java/org/apache/flink/core/plugin/PluginLoader.java", "diffHunk": "@@ -100,4 +105,97 @@ public P next() {\n \t\t}\n \t}\n \n+\t/**\n+\t * Loads all classes from the plugin jar except for explicitly white-listed packages (org.apache.flink, logging).\n+\t *\n+\t * <p>No class/resource in the system class loader (everything in lib/) can be seen in the plugin except those\n+\t * starting with a whitelist prefix.\n+\t */\n+\tprivate static final class PluginClassLoader extends URLClassLoader {\n+\t\tprivate final ClassLoader flinkClassLoader;\n+\n+\t\tprivate final String[] allowedFlinkPackages;\n+\n+\t\tprivate final String[] allowedResourcePrefixes;\n+\n+\t\tPluginClassLoader(URL[] pluginResourceURLs, ClassLoader flinkClassLoader, String[] allowedFlinkPackages) {\n+\t\t\tsuper(pluginResourceURLs, null);\n+\t\t\tthis.flinkClassLoader = flinkClassLoader;\n+\t\t\tthis.allowedFlinkPackages = allowedFlinkPackages;\n+\t\t\tallowedResourcePrefixes = Arrays.stream(allowedFlinkPackages)\n+\t\t\t\t.map(packageName -> packageName.replace('.', '/'))\n+\t\t\t\t.toArray(String[]::new);\n+\t\t}\n+\n+\t\t@Override\n+\t\tprotected Class<?> loadClass(final String name, final boolean resolve) throws ClassNotFoundException {\n+\t\t\tsynchronized (getClassLoadingLock(name)) {\n+\t\t\t\tfinal Class<?> loadedClass = findLoadedClass(name);\n+\t\t\t\tif (loadedClass != null) {\n+\t\t\t\t\treturn resolveIfNeeded(resolve, loadedClass);\n+\t\t\t\t}\n+\n+\t\t\t\tif (isAllowedFlinkClass(name)) {\n+\t\t\t\t\ttry {\n+\t\t\t\t\t\treturn resolveIfNeeded(resolve, flinkClassLoader.loadClass(name));\n+\t\t\t\t\t} catch (ClassNotFoundException e) {\n+\t\t\t\t\t\t// fallback to resolving it in this classloader\n+\t\t\t\t\t\t// for cases where the plugin uses org.apache.flink namespace\n+\t\t\t\t\t}\n+\t\t\t\t}\n+\n+\t\t\t\treturn super.loadClass(name, resolve);\n+\t\t\t}\n+\t\t}\n+\n+\t\tprivate Class<?> resolveIfNeeded(final boolean resolve, final Class<?> loadedClass) {\n+\t\t\tif (resolve) {\n+\t\t\t\tresolveClass(loadedClass);\n+\t\t\t}\n+\t\t\treturn loadedClass;\n+\t\t}\n+\n+\t\t@Override\n+\t\tpublic URL getResource(final String name) {\n+\t\t\tif (isAllowedFlinkResource(name)) {\n+\t\t\t\treturn flinkClassLoader.getResource(name);\n+\t\t\t}\n+\n+\t\t\tURL urlClassLoaderResource = findResource(name);\n+\n+\t\t\tif (urlClassLoaderResource != null) {\n+\t\t\t\treturn urlClassLoaderResource;\n+\t\t\t}\n+\n+\t\t\treturn null;", "originalCommit": "c1bd37255a1fbdffba63def90f85f9c1a0557d32", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e725912b1cf6f948c5aa4d3b8c3c647deada9387", "chunk": "diff --git a/flink-core/src/main/java/org/apache/flink/core/plugin/PluginLoader.java b/flink-core/src/main/java/org/apache/flink/core/plugin/PluginLoader.java\nindex 41a1d435b0b..94f04a37e15 100644\n--- a/flink-core/src/main/java/org/apache/flink/core/plugin/PluginLoader.java\n+++ b/flink-core/src/main/java/org/apache/flink/core/plugin/PluginLoader.java\n\n@@ -152,6 +152,7 @@ public class PluginLoader {\n \t\t\tif (resolve) {\n \t\t\t\tresolveClass(loadedClass);\n \t\t\t}\n+\n \t\t\treturn loadedClass;\n \t\t}\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzI3OTkxNQ==", "url": "https://github.com/apache/flink/pull/10845#discussion_r367279915", "bodyText": "Why have all the tests changed in this commit?", "author": "pnowojski", "createdAt": "2020-01-16T08:13:13Z", "path": "flink-tests/src/test/java/org/apache/flink/test/plugin/PluginLoaderTest.java", "diffHunk": "@@ -21,6 +21,7 @@\n import org.apache.flink.core.plugin.PluginDescriptor;\n import org.apache.flink.core.plugin.PluginLoader;\n import org.apache.flink.test.plugin.jar.plugina.TestServiceA;\n+import org.apache.flink.test.plugin.spi.TestSpi;", "originalCommit": "c1bd37255a1fbdffba63def90f85f9c1a0557d32", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e725912b1cf6f948c5aa4d3b8c3c647deada9387", "chunk": "diff --git a/flink-tests/src/test/java/org/apache/flink/test/plugin/PluginLoaderTest.java b/flink-tests/src/test/java/org/apache/flink/test/plugin/PluginLoaderTest.java\nindex c57a025ac39..fff49f71a3b 100644\n--- a/flink-tests/src/test/java/org/apache/flink/test/plugin/PluginLoaderTest.java\n+++ b/flink-tests/src/test/java/org/apache/flink/test/plugin/PluginLoaderTest.java\n\n@@ -21,7 +21,6 @@ package org.apache.flink.test.plugin;\n import org.apache.flink.core.plugin.PluginDescriptor;\n import org.apache.flink.core.plugin.PluginLoader;\n import org.apache.flink.test.plugin.jar.plugina.TestServiceA;\n-import org.apache.flink.test.plugin.spi.TestSpi;\n \n import org.junit.Assert;\n import org.junit.Test;\n"}}, {"oid": "e725912b1cf6f948c5aa4d3b8c3c647deada9387", "url": "https://github.com/apache/flink/commit/e725912b1cf6f948c5aa4d3b8c3c647deada9387", "message": " [FLINK-15355][plugins]Classloader restricted to whitelisted system classes.\n\nNo class/resource in the system class loader (everything in lib/) can be seen in the plugin except those starting with a whitelist prefix.", "committedDate": "2020-01-16T09:56:28Z", "type": "commit"}, {"oid": "8cfc8526790aeb1adf7bcb8ca39b4bd33dd6098b", "url": "https://github.com/apache/flink/commit/8cfc8526790aeb1adf7bcb8ca39b4bd33dd6098b", "message": "[hotfix][plugins]Hide classloader pattern options from documentation.", "committedDate": "2020-01-16T10:06:28Z", "type": "commit"}, {"oid": "8cfc8526790aeb1adf7bcb8ca39b4bd33dd6098b", "url": "https://github.com/apache/flink/commit/8cfc8526790aeb1adf7bcb8ca39b4bd33dd6098b", "message": "[hotfix][plugins]Hide classloader pattern options from documentation.", "committedDate": "2020-01-16T10:06:28Z", "type": "forcePushed"}]}