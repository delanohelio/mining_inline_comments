{"pr_number": 11019, "pr_title": "[FLINK-15914][checkpointing][metrics] Miss the barrier alignment metric for the case of two inputs", "pr_createdAt": "2020-02-05T09:12:07Z", "pr_url": "https://github.com/apache/flink/pull/11019", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTEzOTI0MA==", "url": "https://github.com/apache/flink/pull/11019#discussion_r375139240", "bodyText": "nit: pass through constructor? Getting metric group from a variable named toNotifyOnCheckpoint looks a bit strange?", "author": "pnowojski", "createdAt": "2020-02-05T09:21:09Z", "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/io/InputProcessorUtil.java", "diffHunk": "@@ -90,6 +91,10 @@ public static CheckpointedInputGate createCheckpointedInputGate(\n \t\t\tinputGate1.getNumberOfInputChannels() + inputGate2.getNumberOfInputChannels(),\n \t\t\ttaskName,\n \t\t\ttoNotifyOnCheckpoint);\n+\n+\t\tTaskIOMetricGroup taskIOMetricGroup = toNotifyOnCheckpoint.getEnvironment().getMetricGroup().getIOMetricGroup();", "originalCommit": "012203b66328bc46e9af4d37c585521915f450ca", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTE1MjM1Ng==", "url": "https://github.com/apache/flink/pull/11019#discussion_r375152356", "bodyText": "I agree with the point, and the current way is for avoiding the more changes of existing tests. Let me try that.", "author": "zhijiangW", "createdAt": "2020-02-05T09:47:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTEzOTI0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTE2ODQ3OQ==", "url": "https://github.com/apache/flink/pull/11019#discussion_r375168479", "bodyText": "Fixed", "author": "zhijiangW", "createdAt": "2020-02-05T10:17:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTEzOTI0MA=="}], "type": "inlineReview", "revised_code": {"commit": "ac23472fe66b4c534a30aa0bde8e8ecf05021166", "chunk": "diff --git a/flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/io/InputProcessorUtil.java b/flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/io/InputProcessorUtil.java\nindex 0846995035..479e19df69 100644\n--- a/flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/io/InputProcessorUtil.java\n+++ b/flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/io/InputProcessorUtil.java\n\n@@ -91,8 +92,6 @@ public class InputProcessorUtil {\n \t\t\tinputGate1.getNumberOfInputChannels() + inputGate2.getNumberOfInputChannels(),\n \t\t\ttaskName,\n \t\t\ttoNotifyOnCheckpoint);\n-\n-\t\tTaskIOMetricGroup taskIOMetricGroup = toNotifyOnCheckpoint.getEnvironment().getMetricGroup().getIOMetricGroup();\n \t\ttaskIOMetricGroup.gauge(\"checkpointAlignmentTime\", barrierHandler::getAlignmentDurationNanos);\n \n \t\treturn new CheckpointedInputGate[] {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTE0MDM2Mw==", "url": "https://github.com/apache/flink/pull/11019#discussion_r375140363", "bodyText": "deduplicate this code with OneInputStreamTask?\nIn master version I think this is also missing\n\t\t\ttaskIOMetricGroup.gauge(\"checkpointStartDelayNanos\", inputGate::getCheckpointStartDelayNanos);", "author": "pnowojski", "createdAt": "2020-02-05T09:23:23Z", "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/io/InputProcessorUtil.java", "diffHunk": "@@ -90,6 +91,10 @@ public static CheckpointedInputGate createCheckpointedInputGate(\n \t\t\tinputGate1.getNumberOfInputChannels() + inputGate2.getNumberOfInputChannels(),\n \t\t\ttaskName,\n \t\t\ttoNotifyOnCheckpoint);\n+\n+\t\tTaskIOMetricGroup taskIOMetricGroup = toNotifyOnCheckpoint.getEnvironment().getMetricGroup().getIOMetricGroup();\n+\t\ttaskIOMetricGroup.gauge(\"checkpointAlignmentTime\", barrierHandler::getAlignmentDurationNanos);", "originalCommit": "012203b66328bc46e9af4d37c585521915f450ca", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTE1NDMxNQ==", "url": "https://github.com/apache/flink/pull/11019#discussion_r375154315", "bodyText": "deduplicate this code with OneInputStreamTask\n\nI considered that and actually we can remove the method of getAlignmentDurationNanos from CheckpointedInputGate to unify the way all in the constructor of CheckpointBarrierHandler. The current way of touching minimum change is also for catching up with the release ASAP. I would try that if not very hurry.", "author": "zhijiangW", "createdAt": "2020-02-05T09:50:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTE0MDM2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTE1NDYzMQ==", "url": "https://github.com/apache/flink/pull/11019#discussion_r375154631", "bodyText": "Let me check the issue of checkpointStartDelayNanos", "author": "zhijiangW", "createdAt": "2020-02-05T09:51:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTE0MDM2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTE2OTk1MA==", "url": "https://github.com/apache/flink/pull/11019#discussion_r375169950", "bodyText": "After checking the code path, the unification in OneInputStreamTask is not strong related to this fix. So I prefer to submitting a hotfix or separate ticket for handling the case of OneInputStreamTask in master branch.", "author": "zhijiangW", "createdAt": "2020-02-05T10:20:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTE0MDM2Mw=="}], "type": "inlineReview", "revised_code": {"commit": "ac23472fe66b4c534a30aa0bde8e8ecf05021166", "chunk": "diff --git a/flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/io/InputProcessorUtil.java b/flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/io/InputProcessorUtil.java\nindex 0846995035..479e19df69 100644\n--- a/flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/io/InputProcessorUtil.java\n+++ b/flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/io/InputProcessorUtil.java\n\n@@ -91,8 +92,6 @@ public class InputProcessorUtil {\n \t\t\tinputGate1.getNumberOfInputChannels() + inputGate2.getNumberOfInputChannels(),\n \t\t\ttaskName,\n \t\t\ttoNotifyOnCheckpoint);\n-\n-\t\tTaskIOMetricGroup taskIOMetricGroup = toNotifyOnCheckpoint.getEnvironment().getMetricGroup().getIOMetricGroup();\n \t\ttaskIOMetricGroup.gauge(\"checkpointAlignmentTime\", barrierHandler::getAlignmentDurationNanos);\n \n \t\treturn new CheckpointedInputGate[] {\n"}}, {"oid": "ac23472fe66b4c534a30aa0bde8e8ecf05021166", "url": "https://github.com/apache/flink/commit/ac23472fe66b4c534a30aa0bde8e8ecf05021166", "message": "[FLINK-15914][checkpointing][metrics] Miss the barrier alignment metric for the case of two inputs\n\nWhen the StreamTwoInputSelectableProcessor was introduced before, it was missing to add the barrier alignment metric in the constructor.\nBut it does not cause problems then, because only StreamTwoInputProcessor works at that time.\n\nAfter StreamTwoInputProcessor is replaced by StreamTwoInputSelectableProcessor as now, this bug is exposed and we will not see the barrier\nalignment metric for the case of two inputs.\n\nThe solution is to add this metric while constructing the CheckpointBarrierHandler.", "committedDate": "2020-02-05T10:16:05Z", "type": "commit"}, {"oid": "ac23472fe66b4c534a30aa0bde8e8ecf05021166", "url": "https://github.com/apache/flink/commit/ac23472fe66b4c534a30aa0bde8e8ecf05021166", "message": "[FLINK-15914][checkpointing][metrics] Miss the barrier alignment metric for the case of two inputs\n\nWhen the StreamTwoInputSelectableProcessor was introduced before, it was missing to add the barrier alignment metric in the constructor.\nBut it does not cause problems then, because only StreamTwoInputProcessor works at that time.\n\nAfter StreamTwoInputProcessor is replaced by StreamTwoInputSelectableProcessor as now, this bug is exposed and we will not see the barrier\nalignment metric for the case of two inputs.\n\nThe solution is to add this metric while constructing the CheckpointBarrierHandler.", "committedDate": "2020-02-05T10:16:05Z", "type": "forcePushed"}]}