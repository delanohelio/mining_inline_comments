{"pr_number": 12732, "pr_title": "[FLINK-18372][runtime] Fix NPE problem when a slot is offered before JM is connected to a RM", "pr_createdAt": "2020-06-21T08:58:35Z", "pr_url": "https://github.com/apache/flink/pull/12732", "timeline": [{"oid": "e7777affc50bf1433d0aeaad27a285e019fa5f29", "url": "https://github.com/apache/flink/commit/e7777affc50bf1433d0aeaad27a285e019fa5f29", "message": "[FLINK-18372][runtime] Fix NPE problem when a slot is offered before JM is connected to a RM", "committedDate": "2020-06-21T09:03:08Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQyNjQwMg==", "url": "https://github.com/apache/flink/pull/12732#discussion_r443426402", "bodyText": "I think you could directly ask pendingRequest.getAllocationId(). That way you would not need to query pendingRequests again.", "author": "tillrohrmann", "createdAt": "2020-06-22T09:20:09Z", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/slotpool/SlotPoolImpl.java", "diffHunk": "@@ -561,7 +561,11 @@ private void tryFulfillSlotRequestOrMakeAvailable(AllocatedSlot allocatedSlot) {\n \t\t\tallocatedSlots.add(pendingRequest.getSlotRequestId(), allocatedSlot);\n \t\t\tpendingRequest.getAllocatedSlotFuture().complete(allocatedSlot);\n \n-\t\t\tmaybeRemapOrphanedAllocation(allocationIdOfRequest, allocatedSlot.getAllocationId());\n+\t\t\t// the allocation id can be null if the request was fulfilled by a slot directly offered\n+\t\t\t// by a reconnected TaskExecutor before the ResourceManager is connected\n+\t\t\tif (allocationIdOfRequest != null) {", "originalCommit": "e7777affc50bf1433d0aeaad27a285e019fa5f29", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQyOTE4NA==", "url": "https://github.com/apache/flink/pull/12732#discussion_r443429184", "bodyText": "Moreover, there is no invariant which states that pendingRequests contains the mapping. Hence, it would also make sense to directly ask pendingRequest here.", "author": "tillrohrmann", "createdAt": "2020-06-22T09:24:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQyNjQwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQ3NDQ0Mw==", "url": "https://github.com/apache/flink/pull/12732#discussion_r443474443", "bodyText": "Agreed. done.", "author": "zhuzhurk", "createdAt": "2020-06-22T10:49:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQyNjQwMg=="}], "type": "inlineReview", "revised_code": {"commit": "922cafda024ebd4b1426c8be0404175a443ed017", "chunk": "diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/slotpool/SlotPoolImpl.java b/flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/slotpool/SlotPoolImpl.java\nindex 3882a85acf..8fb502c6f7 100644\n--- a/flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/slotpool/SlotPoolImpl.java\n+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/slotpool/SlotPoolImpl.java\n\n@@ -553,18 +553,18 @@ public class SlotPoolImpl implements SlotPool {\n \t\t\tlog.debug(\"Fulfilling pending slot request [{}] with slot [{}]\",\n \t\t\t\tpendingRequest.getSlotRequestId(), allocatedSlot.getAllocationId());\n \n-\t\t\t// this allocation may become orphan once its corresponding request is removed\n-\t\t\tfinal AllocationID allocationIdOfRequest = pendingRequests.getKeyBByKeyA(pendingRequest.getSlotRequestId());\n-\n \t\t\tremovePendingRequest(pendingRequest.getSlotRequestId());\n \n \t\t\tallocatedSlots.add(pendingRequest.getSlotRequestId(), allocatedSlot);\n \t\t\tpendingRequest.getAllocatedSlotFuture().complete(allocatedSlot);\n \n+\t\t\t// this allocation may become orphan once its corresponding request is removed\n+\t\t\tfinal Optional<AllocationID> allocationIdOfRequest = pendingRequest.getAllocationId();\n+\n \t\t\t// the allocation id can be null if the request was fulfilled by a slot directly offered\n \t\t\t// by a reconnected TaskExecutor before the ResourceManager is connected\n-\t\t\tif (allocationIdOfRequest != null) {\n-\t\t\t\tmaybeRemapOrphanedAllocation(allocationIdOfRequest, allocatedSlot.getAllocationId());\n+\t\t\tif (allocationIdOfRequest.isPresent()) {\n+\t\t\t\tmaybeRemapOrphanedAllocation(allocationIdOfRequest.get(), allocatedSlot.getAllocationId());\n \t\t\t}\n \t\t} else {\n \t\t\tlog.debug(\"Adding slot [{}] to available slots\", allocatedSlot.getAllocationId());\n"}}, {"oid": "922cafda024ebd4b1426c8be0404175a443ed017", "url": "https://github.com/apache/flink/commit/922cafda024ebd4b1426c8be0404175a443ed017", "message": "[FLINK-18372][runtime] Fix NPE problem when a slot is offered before JM is connected to a RM", "committedDate": "2020-06-22T10:52:05Z", "type": "commit"}, {"oid": "16edfbea356cc35919495a13e5f8eda8d0de4961", "url": "https://github.com/apache/flink/commit/16edfbea356cc35919495a13e5f8eda8d0de4961", "message": "[hotfix][runtime] Simplify SlotPoolImpl#maybeRemapOrphanedAllocation", "committedDate": "2020-06-22T10:52:06Z", "type": "forcePushed"}, {"oid": "922cafda024ebd4b1426c8be0404175a443ed017", "url": "https://github.com/apache/flink/commit/922cafda024ebd4b1426c8be0404175a443ed017", "message": "[FLINK-18372][runtime] Fix NPE problem when a slot is offered before JM is connected to a RM", "committedDate": "2020-06-22T10:52:05Z", "type": "forcePushed"}]}