{"pr_number": 14316, "pr_title": "[FLINK-20470]MissingNode can't be casted to ObjectNode when deserializing JSON", "pr_createdAt": "2020-12-07T06:46:17Z", "pr_url": "https://github.com/apache/flink/pull/14316", "timeline": [{"oid": "b2ba16cf998b31ec52c2bf0ebd1be8d539aafb98", "url": "https://github.com/apache/flink/commit/b2ba16cf998b31ec52c2bf0ebd1be8d539aafb98", "message": "[FLINK-20470]MissingNode can't be casted to ObjectNode when deserializing JSON", "committedDate": "2020-12-07T06:41:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzMzNDk5NQ==", "url": "https://github.com/apache/flink/pull/14316#discussion_r537334995", "bodyText": "I think this is a little hack. This can't handle nested types. Would be better fix this in org.apache.flink.formats.json.JsonToRowDataConverters#wrapIntoNullableConverter. And call JsonToRowDataConverters#createConverter in the constructor.", "author": "wuchong", "createdAt": "2020-12-07T09:00:30Z", "path": "flink-formats/flink-json/src/main/java/org/apache/flink/formats/json/JsonRowDataDeserializationSchema.java", "diffHunk": "@@ -101,6 +102,9 @@ public JsonRowDataDeserializationSchema(\n \tpublic RowData deserialize(byte[] message) throws IOException {\n \t\ttry {\n \t\t\tfinal JsonNode root = objectMapper.readTree(message);\n+\t\t\tif (root instanceof MissingNode) {", "originalCommit": "b2ba16cf998b31ec52c2bf0ebd1be8d539aafb98", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzY1Nzg2NA==", "url": "https://github.com/apache/flink/pull/14316#discussion_r537657864", "bodyText": "Thanks for your suggestion,i'll update it", "author": "zhuxiaoshang", "createdAt": "2020-12-07T16:46:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzMzNDk5NQ=="}], "type": "inlineReview", "revised_code": {"commit": "5fae69d73f9811547cf17e4e7308b09b00903543", "chunk": "diff --git a/flink-formats/flink-json/src/main/java/org/apache/flink/formats/json/JsonRowDataDeserializationSchema.java b/flink-formats/flink-json/src/main/java/org/apache/flink/formats/json/JsonRowDataDeserializationSchema.java\nindex 5214715215..0a2fb5ef13 100644\n--- a/flink-formats/flink-json/src/main/java/org/apache/flink/formats/json/JsonRowDataDeserializationSchema.java\n+++ b/flink-formats/flink-json/src/main/java/org/apache/flink/formats/json/JsonRowDataDeserializationSchema.java\n\n@@ -102,9 +101,6 @@ public class JsonRowDataDeserializationSchema implements DeserializationSchema<R\n \tpublic RowData deserialize(byte[] message) throws IOException {\n \t\ttry {\n \t\t\tfinal JsonNode root = objectMapper.readTree(message);\n-\t\t\tif (root instanceof MissingNode) {\n-\t\t\t\treturn null;\n-\t\t\t}\n \t\t\treturn (RowData) runtimeConverter.convert(root);\n \t\t} catch (Throwable t) {\n \t\t\tif (ignoreParseErrors) {\n"}}, {"oid": "5fae69d73f9811547cf17e4e7308b09b00903543", "url": "https://github.com/apache/flink/commit/5fae69d73f9811547cf17e4e7308b09b00903543", "message": "[FLINK-20470]MissingNode can't be casted to ObjectNode when deserializing JSON", "committedDate": "2020-12-08T12:17:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODM4MzQxMQ==", "url": "https://github.com/apache/flink/pull/14316#discussion_r538383411", "bodyText": "Would be better to use jsonNode.isMissingNode() here.", "author": "wuchong", "createdAt": "2020-12-08T13:43:13Z", "path": "flink-formats/flink-json/src/main/java/org/apache/flink/formats/json/JsonToRowDataConverters.java", "diffHunk": "@@ -368,7 +369,7 @@ private Object convertField(\n \tprivate JsonToRowDataConverter wrapIntoNullableConverter(\n \t\tJsonToRowDataConverter converter) {\n \t\treturn jsonNode -> {\n-\t\t\tif (jsonNode == null || jsonNode.isNull()) {\n+\t\t\tif (jsonNode == null || jsonNode.isNull() || jsonNode instanceof MissingNode) {", "originalCommit": "5fae69d73f9811547cf17e4e7308b09b00903543", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5073f89f42332ed059ff9c8f88d55f33790d6215", "chunk": "diff --git a/flink-formats/flink-json/src/main/java/org/apache/flink/formats/json/JsonToRowDataConverters.java b/flink-formats/flink-json/src/main/java/org/apache/flink/formats/json/JsonToRowDataConverters.java\nindex d17dad1f69..65feec3532 100644\n--- a/flink-formats/flink-json/src/main/java/org/apache/flink/formats/json/JsonToRowDataConverters.java\n+++ b/flink-formats/flink-json/src/main/java/org/apache/flink/formats/json/JsonToRowDataConverters.java\n\n@@ -369,7 +368,7 @@ public class JsonToRowDataConverters implements Serializable {\n \tprivate JsonToRowDataConverter wrapIntoNullableConverter(\n \t\tJsonToRowDataConverter converter) {\n \t\treturn jsonNode -> {\n-\t\t\tif (jsonNode == null || jsonNode.isNull() || jsonNode instanceof MissingNode) {\n+\t\t\tif (jsonNode == null || jsonNode.isNull() || jsonNode.isMissingNode()) {\n \t\t\t\treturn null;\n \t\t\t}\n \t\t\ttry {\n"}}, {"oid": "5073f89f42332ed059ff9c8f88d55f33790d6215", "url": "https://github.com/apache/flink/commit/5073f89f42332ed059ff9c8f88d55f33790d6215", "message": "[FLINK-20470]MissingNode can't be casted to ObjectNode when deserializing JSON", "committedDate": "2020-12-08T16:24:31Z", "type": "commit"}]}