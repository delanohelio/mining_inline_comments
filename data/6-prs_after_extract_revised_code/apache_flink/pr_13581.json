{"pr_number": 13581, "pr_title": "[FLINK-17331] Explicitly get the ByteBuf length of all classes which \u2026", "pr_createdAt": "2020-10-10T09:19:09Z", "pr_url": "https://github.com/apache/flink/pull/13581", "timeline": [{"oid": "1e187203b15559b08d15a0cca949ca15a8a3bafe", "url": "https://github.com/apache/flink/commit/1e187203b15559b08d15a0cca949ca15a8a3bafe", "message": "[FLINK-17331][runtime] Explicitly get the ByteBuf length of all classes which is written to NettyMessage", "committedDate": "2020-10-10T09:32:44Z", "type": "forcePushed"}, {"oid": "fcc301fbb0d04ada457d2c39d325ede52cc0db8d", "url": "https://github.com/apache/flink/commit/fcc301fbb0d04ada457d2c39d325ede52cc0db8d", "message": "[FLINK-17331][runtime] Explicitly get the ByteBuf length of all classes which is written to NettyMessage", "committedDate": "2020-10-22T03:34:49Z", "type": "forcePushed"}, {"oid": "05751c9777cba4c922adac2fb1f1c5a980b779da", "url": "https://github.com/apache/flink/commit/05751c9777cba4c922adac2fb1f1c5a980b779da", "message": "[FLINK-17331][runtime] Explicitly get the ByteBuf length of all classes which is written to NettyMessage", "committedDate": "2020-12-09T02:15:08Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzcyMjM5Mw==", "url": "https://github.com/apache/flink/pull/13581#discussion_r547722393", "bodyText": "Would you please add a comment here, something like\n\"the length of two long types representing an executionAttemptId, with the lower part and the upper part taking one long type of length each\" or something similar to explain where 16 comes from.", "author": "curcur", "createdAt": "2020-12-23T06:50:32Z", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/executiongraph/ExecutionAttemptID.java", "diffHunk": "@@ -31,6 +31,7 @@\n public class ExecutionAttemptID implements java.io.Serializable {\n \n \tprivate static final long serialVersionUID = -1169683445778281344L;\n+\tprivate static final int BYTEBUF_LEN = 16;", "originalCommit": "05751c9777cba4c922adac2fb1f1c5a980b779da", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "cd05d23ea1ac2a9283e03039a3791b1cc2df1a95", "chunk": "diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/executiongraph/ExecutionAttemptID.java b/flink-runtime/src/main/java/org/apache/flink/runtime/executiongraph/ExecutionAttemptID.java\nindex cd795c20989..03c250cb7ad 100644\n--- a/flink-runtime/src/main/java/org/apache/flink/runtime/executiongraph/ExecutionAttemptID.java\n+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/executiongraph/ExecutionAttemptID.java\n\n@@ -31,6 +31,8 @@ import org.apache.flink.shaded.netty4.io.netty.buffer.ByteBuf;\n public class ExecutionAttemptID implements java.io.Serializable {\n \n \tprivate static final long serialVersionUID = -1169683445778281344L;\n+\t// Represent the number of bytes occupied when writes ExecutionAttemptID to the ByteBuf.\n+\t// It is the sum of two long types(lowerPart and upperPart of the executionAttemptId).\n \tprivate static final int BYTEBUF_LEN = 16;\n \n \tprivate final AbstractID executionAttemptId;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Nzc0MzA3Mg==", "url": "https://github.com/apache/flink/pull/13581#discussion_r547743072", "bodyText": "similarly here, please add a comment to explain.", "author": "curcur", "createdAt": "2020-12-23T07:17:07Z", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/InputChannelID.java", "diffHunk": "@@ -28,6 +28,7 @@\n public class InputChannelID extends AbstractID {\n \n \tprivate static final long serialVersionUID = 1L;\n+\tprivate static final int BYTEBUF_LEN = 16;", "originalCommit": "05751c9777cba4c922adac2fb1f1c5a980b779da", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "cd05d23ea1ac2a9283e03039a3791b1cc2df1a95", "chunk": "diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/InputChannelID.java b/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/InputChannelID.java\nindex 583e753616f..4df0b33c46e 100644\n--- a/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/InputChannelID.java\n+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/InputChannelID.java\n\n@@ -28,6 +28,8 @@ import org.apache.flink.shaded.netty4.io.netty.buffer.ByteBuf;\n public class InputChannelID extends AbstractID {\n \n \tprivate static final long serialVersionUID = 1L;\n+\t// Represent the number of bytes occupied when writes InputChannelID to the ByteBuf.\n+\t// It is the sum of two long types(lowerPart and upperPart).\n \tprivate static final int BYTEBUF_LEN = 16;\n \n \tpublic InputChannelID() {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Nzc0NTI0OQ==", "url": "https://github.com/apache/flink/pull/13581#discussion_r547745249", "bodyText": "similarly here, please add a comment.\nWhere are the extra 4 bytes coming from? partitionNum?", "author": "curcur", "createdAt": "2020-12-23T07:19:51Z", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/jobgraph/IntermediateResultPartitionID.java", "diffHunk": "@@ -30,6 +30,7 @@\n public class IntermediateResultPartitionID implements ResultID {\n \n \tprivate static final long serialVersionUID = 1L;\n+\tprivate static final int BYTEBUF_LEN = 20;", "originalCommit": "05751c9777cba4c922adac2fb1f1c5a980b779da", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Nzc4OTI1Nw==", "url": "https://github.com/apache/flink/pull/13581#discussion_r547789257", "bodyText": "Yes, the extra 4 bytes come from the partitionNum.", "author": "KarmaGYZ", "createdAt": "2020-12-23T08:14:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Nzc0NTI0OQ=="}], "type": "inlineReview", "revised_code": {"commit": "cd05d23ea1ac2a9283e03039a3791b1cc2df1a95", "chunk": "diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/jobgraph/IntermediateResultPartitionID.java b/flink-runtime/src/main/java/org/apache/flink/runtime/jobgraph/IntermediateResultPartitionID.java\nindex a6526f08746..0ed76e71f79 100644\n--- a/flink-runtime/src/main/java/org/apache/flink/runtime/jobgraph/IntermediateResultPartitionID.java\n+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/jobgraph/IntermediateResultPartitionID.java\n\n@@ -30,6 +30,8 @@ import org.apache.flink.shaded.netty4.io.netty.buffer.ByteBuf;\n public class IntermediateResultPartitionID implements ResultID {\n \n \tprivate static final long serialVersionUID = 1L;\n+\t// Represent the number of bytes occupied when writes IntermediateResultPartitionID to the ByteBuf.\n+\t// It is the sum of two long types(lowerPart and upperPart of the intermediateDataSetID) and one int type(partitionNum).\n \tprivate static final int BYTEBUF_LEN = 20;\n \n \tprivate final IntermediateDataSetID intermediateDataSetID;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Nzc1MjIwMw==", "url": "https://github.com/apache/flink/pull/13581#discussion_r547752203", "bodyText": "why isCompressed (boolean) is hardcoded, while everything else is not?", "author": "curcur", "createdAt": "2020-12-23T07:29:22Z", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/netty/NettyMessage.java", "diffHunk": "@@ -259,7 +259,7 @@ protected Object decode(ChannelHandlerContext ctx, ByteBuf in) throws Exception\n \t\tstatic final byte ID = 0;\n \n \t\t// receiver ID (16), sequence number (4), backlog (4), dataType (1), isCompressed (1), buffer size (4)\n-\t\tstatic final int MESSAGE_HEADER_LENGTH = 16 + 4 + 4 + 1 + 1 + 4;\n+\t\tstatic final int MESSAGE_HEADER_LENGTH = InputChannelID.getByteBufLength() + Integer.BYTES + Integer.BYTES + Byte.BYTES + 1 + Integer.BYTES;", "originalCommit": "05751c9777cba4c922adac2fb1f1c5a980b779da", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzgwNDMwMg==", "url": "https://github.com/apache/flink/pull/13581#discussion_r547804302", "bodyText": "After a deeper investigation, I find that a boolean will be treated as a byte in netty. Will change it to Byte.BYTES.", "author": "KarmaGYZ", "createdAt": "2020-12-23T08:31:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Nzc1MjIwMw=="}], "type": "inlineReview", "revised_code": {"commit": "cd05d23ea1ac2a9283e03039a3791b1cc2df1a95", "chunk": "diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/netty/NettyMessage.java b/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/netty/NettyMessage.java\nindex 3d2d7d24cd6..d6d8d802538 100644\n--- a/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/netty/NettyMessage.java\n+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/netty/NettyMessage.java\n\n@@ -259,7 +259,7 @@ public abstract class NettyMessage {\n \t\tstatic final byte ID = 0;\n \n \t\t// receiver ID (16), sequence number (4), backlog (4), dataType (1), isCompressed (1), buffer size (4)\n-\t\tstatic final int MESSAGE_HEADER_LENGTH = InputChannelID.getByteBufLength() + Integer.BYTES + Integer.BYTES + Byte.BYTES + 1 + Integer.BYTES;\n+\t\tstatic final int MESSAGE_HEADER_LENGTH = InputChannelID.getByteBufLength() + Integer.BYTES + Integer.BYTES + Byte.BYTES + Byte.BYTES + Integer.BYTES;\n \n \t\tfinal Buffer buffer;\n \n"}}, {"oid": "cd05d23ea1ac2a9283e03039a3791b1cc2df1a95", "url": "https://github.com/apache/flink/commit/cd05d23ea1ac2a9283e03039a3791b1cc2df1a95", "message": "[FLINK-17331][runtime] Explicitly get the ByteBuf length of all classes which is written to NettyMessage", "committedDate": "2020-12-23T08:32:51Z", "type": "forcePushed"}, {"oid": "008f1e53122962ab10c83e548b60f0e7da5e6654", "url": "https://github.com/apache/flink/commit/008f1e53122962ab10c83e548b60f0e7da5e6654", "message": "[FLINK-17331][runtime] Explicitly get the ByteBuf length of all classes which is written to NettyMessage\n\nCurrently, the length of some header fields in NettyMessage is hardcoded: InputChannelID, ExecutionAttemptID, e.t.c.\nSo if we make some changes for such field, then we are not ware that it also needs to change the respective length for related netty messages component.\nThis PR explicitly get the ByteBuf length of all classes which is written to NettyMessage to avoid such problems.", "committedDate": "2020-12-29T06:06:55Z", "type": "commit"}, {"oid": "008f1e53122962ab10c83e548b60f0e7da5e6654", "url": "https://github.com/apache/flink/commit/008f1e53122962ab10c83e548b60f0e7da5e6654", "message": "[FLINK-17331][runtime] Explicitly get the ByteBuf length of all classes which is written to NettyMessage\n\nCurrently, the length of some header fields in NettyMessage is hardcoded: InputChannelID, ExecutionAttemptID, e.t.c.\nSo if we make some changes for such field, then we are not ware that it also needs to change the respective length for related netty messages component.\nThis PR explicitly get the ByteBuf length of all classes which is written to NettyMessage to avoid such problems.", "committedDate": "2020-12-29T06:06:55Z", "type": "forcePushed"}]}