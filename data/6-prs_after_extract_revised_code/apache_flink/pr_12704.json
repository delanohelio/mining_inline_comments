{"pr_number": 12704, "pr_title": "[FLINK-18360][runtime/web-frontend/HS] fix no jobs/overview.json file created for HS when no archived jobs present", "pr_createdAt": "2020-06-18T09:00:09Z", "pr_url": "https://github.com/apache/flink/pull/12704", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA4NDQ0NA==", "url": "https://github.com/apache/flink/pull/12704#discussion_r442084444", "bodyText": "We could also call this once in the constructor; it is supposed to be part of the startup anyway.", "author": "zentol", "createdAt": "2020-06-18T09:12:22Z", "path": "flink-runtime-web/src/main/java/org/apache/flink/runtime/webmonitor/history/HistoryServerArchiveFetcher.java", "diffHunk": "@@ -285,9 +285,7 @@ public void run() {\n \t\t\t\tif (!jobsToRemove.isEmpty() && processArchiveDeletion) {\n \t\t\t\t\tevents.addAll(cleanupExpiredJobs(jobsToRemove));\n \t\t\t\t}\n-\t\t\t\tif (!events.isEmpty()) {\n-\t\t\t\t\tupdateJobOverview(webOverviewDir, webDir);\n-\t\t\t\t}\n+\t\t\t\tupdateJobOverview(webOverviewDir, webDir);", "originalCommit": "cdbcab3597f7c0f4d48da4fb568d04afd66cfa72", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjE0Nzk0NA==", "url": "https://github.com/apache/flink/pull/12704#discussion_r442147944", "bodyText": "I'm not really sure. That would yield in empty jobs/overview.json file created on startup, thus the UI would show \"no data\" icon during startup/job parsing, and then suddenly it would change into list of  jobs once the startup parsing is done.\nUp until now the UI showed those \"blurred\" lines that we understood as \"startup in progress\" instead.", "author": "jvimr", "createdAt": "2020-06-18T11:08:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA4NDQ0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjgzNzc2MQ==", "url": "https://github.com/apache/flink/pull/12704#discussion_r442837761", "bodyText": "That \"blurring\" is not really intentional, and the result of the request to the REST API actually returning a 404 and the UI not actually handling it.\nFrom the REST API perspective, this file must be there ASAP. By doing this after the first fetch you introduce some delay, since the HistoryServer still has to query all filesystems first.\nWe also have to consider cases where there is actually nothing to be done on startup, as jobs are run later on. In this case, showing \"no data\" is more appropriate, and consistent with the Flink UI.", "author": "zentol", "createdAt": "2020-06-19T13:23:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA4NDQ0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk0NDQyMg==", "url": "https://github.com/apache/flink/pull/12704#discussion_r442944422", "bodyText": "OK, the method updateJobOverview is now called from JobArchiveFetcherTask's contructor too", "author": "jvimr", "createdAt": "2020-06-19T16:44:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA4NDQ0NA=="}], "type": "inlineReview", "revised_code": {"commit": "ae225b23bc5a171e078ddd56dcb5d15218e191c3", "chunk": "diff --git a/flink-runtime-web/src/main/java/org/apache/flink/runtime/webmonitor/history/HistoryServerArchiveFetcher.java b/flink-runtime-web/src/main/java/org/apache/flink/runtime/webmonitor/history/HistoryServerArchiveFetcher.java\nindex 8b9892f490c..318e386a480 100644\n--- a/flink-runtime-web/src/main/java/org/apache/flink/runtime/webmonitor/history/HistoryServerArchiveFetcher.java\n+++ b/flink-runtime-web/src/main/java/org/apache/flink/runtime/webmonitor/history/HistoryServerArchiveFetcher.java\n\n@@ -282,9 +303,12 @@ class HistoryServerArchiveFetcher {\n \t\t\t\t\t}\n \t\t\t\t}\n \n-\t\t\t\tif (!jobsToRemove.isEmpty() && processArchiveDeletion) {\n+\t\t\t\tif (!jobsToRemove.isEmpty() && processExpiredArchiveDeletion) {\n \t\t\t\t\tevents.addAll(cleanupExpiredJobs(jobsToRemove));\n \t\t\t\t}\n+\t\t\t\tif (!archivesBeyondSizeLimit.isEmpty() && processBeyondLimitArchiveDeletion) {\n+\t\t\t\t\tevents.addAll(cleanupJobsBeyondSizeLimit(archivesBeyondSizeLimit));\n+\t\t\t\t}\n \t\t\t\tupdateJobOverview(webOverviewDir, webDir);\n \t\t\t\tevents.forEach(jobArchiveEventListener::accept);\n \t\t\t\tLOG.debug(\"Finished archive fetching.\");\n"}}, {"oid": "3d36644835e7f42fc37370baa243c33582b29aaf", "url": "https://github.com/apache/flink/commit/3d36644835e7f42fc37370baa243c33582b29aaf", "message": "call updateJobOverview from JobArchiveFetcherTask constructor", "committedDate": "2020-06-19T16:43:33Z", "type": "forcePushed"}, {"oid": "ae225b23bc5a171e078ddd56dcb5d15218e191c3", "url": "https://github.com/apache/flink/commit/ae225b23bc5a171e078ddd56dcb5d15218e191c3", "message": "fix no jobs/overview.json file created for HS when no archived jobs are in the archive directory", "committedDate": "2020-06-22T09:04:49Z", "type": "commit"}, {"oid": "b0a636f89ec48e7e3bd3071396d0221a27db1c31", "url": "https://github.com/apache/flink/commit/b0a636f89ec48e7e3bd3071396d0221a27db1c31", "message": "test to verify that HS shows correctly zero completed jobs", "committedDate": "2020-06-22T09:04:50Z", "type": "commit"}, {"oid": "7dc8319084a8ce034ff4853851a231b6278beb08", "url": "https://github.com/apache/flink/commit/7dc8319084a8ce034ff4853851a231b6278beb08", "message": "revert accidently removed test", "committedDate": "2020-06-22T09:04:50Z", "type": "commit"}, {"oid": "a1ea9050d58559d936e4b8464932889922d833e0", "url": "https://github.com/apache/flink/commit/a1ea9050d58559d936e4b8464932889922d833e0", "message": "call updateJobOverview from JobArchiveFetcherTask constructor", "committedDate": "2020-06-22T09:04:50Z", "type": "commit"}, {"oid": "a1ea9050d58559d936e4b8464932889922d833e0", "url": "https://github.com/apache/flink/commit/a1ea9050d58559d936e4b8464932889922d833e0", "message": "call updateJobOverview from JobArchiveFetcherTask constructor", "committedDate": "2020-06-22T09:04:50Z", "type": "forcePushed"}, {"oid": "84f6c9311508c7fbda1d47574d8177815c6ed3e8", "url": "https://github.com/apache/flink/commit/84f6c9311508c7fbda1d47574d8177815c6ed3e8", "message": "cleanup", "committedDate": "2020-06-23T09:08:39Z", "type": "commit"}]}