{"pr_number": 10779, "pr_title": "[FLINK-15327][runtime] No warning of InterruptedException during cancel.", "pr_createdAt": "2020-01-06T14:14:59Z", "pr_url": "https://github.com/apache/flink/pull/10779", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzMzMjY1OA==", "url": "https://github.com/apache/flink/pull/10779#discussion_r363332658", "bodyText": "We could add a simple test coverage for this, for example by extending SourceStreamTaskTest#testInterruptedNotSwallowed with a boolean parameter, controlling whether the exception is thrown wrapped or not (similar pattern as  SourceStreamTaskTest#testCancellationWithSourceBlockedOnLock(boolean, boolean).", "author": "pnowojski", "createdAt": "2020-01-06T15:08:19Z", "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/StreamTask.java", "diffHunk": "@@ -484,27 +484,15 @@ public final void invoke() throws Exception {\n \n \tprivate void runMailboxLoop() throws Exception {\n \t\ttry {\n-\t\t\ttry {\n-\t\t\t\tmailboxProcessor.runMailboxLoop();\n-\t\t\t}\n-\t\t\tcatch (WrappingRuntimeException wrappingException) {\n-\t\t\t\tThrowable unwrapped = wrappingException.unwrap();\n-\t\t\t\tif (unwrapped instanceof Exception) {\n-\t\t\t\t\tthrow (Exception) unwrapped;\n-\t\t\t\t}\n-\t\t\t\telse {\n-\t\t\t\t\tthrow wrappingException;\n-\t\t\t\t}\n-\t\t\t}\n-\t\t}\n-\t\tcatch (InterruptedException e) {\n-\t\t\tif (!canceled) {\n-\t\t\t\tThread.currentThread().interrupt();\n-\t\t\t\tthrow e;\n-\t\t\t}\n+\t\t\tmailboxProcessor.runMailboxLoop();\n \t\t}\n \t\tcatch (Exception e) {\n-\t\t\tif (canceled) {\n+\t\t\tif (ExceptionUtils.findThrowable(e, InterruptedException.class).isPresent()) {", "originalCommit": "87a6ea87ad6acf4f06363912ce28b6b87eb4f1f7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b30a4d297496a904582cb24d036cbb4c5b647149", "chunk": "diff --git a/flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/StreamTask.java b/flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/StreamTask.java\nindex 00c1b1e132..a8633b7768 100644\n--- a/flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/StreamTask.java\n+++ b/flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/StreamTask.java\n\n@@ -487,10 +488,11 @@ public abstract class StreamTask<OUT, OP extends StreamOperator<OUT>>\n \t\t\tmailboxProcessor.runMailboxLoop();\n \t\t}\n \t\tcatch (Exception e) {\n-\t\t\tif (ExceptionUtils.findThrowable(e, InterruptedException.class).isPresent()) {\n+\t\t\tOptional<InterruptedException> interruption = ExceptionUtils.findThrowable(e, InterruptedException.class);\n+\t\t\tif (interruption.isPresent() && !canceled) {\n \t\t\t\tif (!canceled) {\n \t\t\t\t\tThread.currentThread().interrupt();\n-\t\t\t\t\tthrow e;\n+\t\t\t\t\tthrow interruption.get();\n \t\t\t\t}\n \t\t\t} else if (canceled) {\n \t\t\t\tLOG.warn(\"Error while canceling task.\", e);\n"}}, {"oid": "b30a4d297496a904582cb24d036cbb4c5b647149", "url": "https://github.com/apache/flink/commit/b30a4d297496a904582cb24d036cbb4c5b647149", "message": "[temp] enabling all e2e tests in basic build", "committedDate": "2020-01-06T16:16:11Z", "type": "forcePushed"}, {"oid": "e48e4c08207d6e135026bf683c1af8a9d1310a76", "url": "https://github.com/apache/flink/commit/e48e4c08207d6e135026bf683c1af8a9d1310a76", "message": "[temp] enabling all e2e tests in basic build", "committedDate": "2020-01-07T08:02:20Z", "type": "forcePushed"}, {"oid": "19d4be405c97cf220c291475d6804e4183bedf68", "url": "https://github.com/apache/flink/commit/19d4be405c97cf220c291475d6804e4183bedf68", "message": "[temp] enabling all e2e tests in basic build", "committedDate": "2020-01-07T20:31:11Z", "type": "forcePushed"}, {"oid": "3982e03edebfff4a20b6acd4a611400f3ce6d44e", "url": "https://github.com/apache/flink/commit/3982e03edebfff4a20b6acd4a611400f3ce6d44e", "message": "[temp] enabling all e2e tests in basic build", "committedDate": "2020-01-08T12:57:09Z", "type": "forcePushed"}, {"oid": "7530decdd623b9cdc3489e8b6ee1afbaf0643f78", "url": "https://github.com/apache/flink/commit/7530decdd623b9cdc3489e8b6ee1afbaf0643f78", "message": "[temp] enabling all e2e tests in basic build", "committedDate": "2020-01-08T15:20:54Z", "type": "forcePushed"}, {"oid": "2634381d115390c6720bffaf5d4b2e932187dd49", "url": "https://github.com/apache/flink/commit/2634381d115390c6720bffaf5d4b2e932187dd49", "message": "[hotfix][travis] Made shade.sh stan", "committedDate": "2020-01-09T15:38:36Z", "type": "forcePushed"}, {"oid": "c5b4ba1c360a7b04cea60caea894d0233f531e67", "url": "https://github.com/apache/flink/commit/c5b4ba1c360a7b04cea60caea894d0233f531e67", "message": "[temp] enabling all e2e tests in basic build", "committedDate": "2020-01-10T09:04:52Z", "type": "forcePushed"}, {"oid": "96ed39106bee2ad8c55eef665ae8debcbad576f9", "url": "https://github.com/apache/flink/commit/96ed39106bee2ad8c55eef665ae8debcbad576f9", "message": "[FLINK-15327][runtime] No warning of InterruptedException during cancel.\n\nInterruptedException are previously only handled when wrapped in\nWrappingRuntimeException. This patch looks through the whole exception\nchain.", "committedDate": "2020-01-14T11:22:21Z", "type": "commit"}, {"oid": "96ed39106bee2ad8c55eef665ae8debcbad576f9", "url": "https://github.com/apache/flink/commit/96ed39106bee2ad8c55eef665ae8debcbad576f9", "message": "[FLINK-15327][runtime] No warning of InterruptedException during cancel.\n\nInterruptedException are previously only handled when wrapped in\nWrappingRuntimeException. This patch looks through the whole exception\nchain.", "committedDate": "2020-01-14T11:22:21Z", "type": "forcePushed"}]}