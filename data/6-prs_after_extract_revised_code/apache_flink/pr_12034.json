{"pr_number": 12034, "pr_title": "[FLINK-17568][checkpointing] Fix the issue that task may consume input data after checkpoint barrier before checkpoint is performed for unaligned checkpoint", "pr_createdAt": "2020-05-08T10:08:04Z", "pr_url": "https://github.com/apache/flink/pull/12034", "timeline": [{"oid": "6f7d51f627e181949e1311f56897a393471abd06", "url": "https://github.com/apache/flink/commit/6f7d51f627e181949e1311f56897a393471abd06", "message": "[FLINK-17568][checkpointing] Fix the issue that task may consume input data after checkpoint barrier before checkpoint is performed for unaligned checkpoint", "committedDate": "2020-05-08T10:09:11Z", "type": "forcePushed"}, {"oid": "a29ceddd394d563fe95f166a425380f0452ccd71", "url": "https://github.com/apache/flink/commit/a29ceddd394d563fe95f166a425380f0452ccd71", "message": "[FLINK-17568][checkpointing] Fix the issue that task may consume input data after checkpoint barrier before checkpoint is performed for unaligned checkpoint", "committedDate": "2020-05-08T15:49:14Z", "type": "forcePushed"}, {"oid": "74cb677171ff729c4551463c20dd17946df4021d", "url": "https://github.com/apache/flink/commit/74cb677171ff729c4551463c20dd17946df4021d", "message": "[hotfix][tests] Remove redundant test case CheckpointBarrierAlignerTestBase#testMultiChannelSkippingCheckpoints\n\nThis closes #12034.", "committedDate": "2020-05-09T04:06:44Z", "type": "forcePushed"}, {"oid": "f00114189cdddaa5a46148738e55d85854df97ab", "url": "https://github.com/apache/flink/commit/f00114189cdddaa5a46148738e55d85854df97ab", "message": "[hotfix][tests] Remove redundant test case CheckpointBarrierAlignerTestBase#testMultiChannelSkippingCheckpoints\n\nThis closes #12034.", "committedDate": "2020-05-09T04:25:19Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ2OTM0MQ==", "url": "https://github.com/apache/flink/pull/12034#discussion_r422469341", "bodyText": "nit: add an explanation comment:\nInputGate on CheckpointBarrier can enqueue a mailbox action to execute and StreamTaskNetworkInput must\nallow this action to execute before processing a following record.", "author": "pnowojski", "createdAt": "2020-05-09T08:29:11Z", "path": "flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/io/StreamTaskNetworkInputTest.java", "diffHunk": "@@ -74,29 +77,31 @@ public void tearDown() throws Exception {\n \n \t@Test\n \tpublic void testIsAvailableWithBufferedDataInDeserializer() throws Exception {\n-\t\tBufferBuilder bufferBuilder = BufferBuilderTestUtils.createEmptyBufferBuilder(PAGE_SIZE);\n-\t\tBufferConsumer bufferConsumer = bufferBuilder.createBufferConsumer();\n-\n-\t\tserializeRecord(42L, bufferBuilder);\n-\t\tserializeRecord(44L, bufferBuilder);\n-\n-\t\tList<BufferOrEvent> buffers = Collections.singletonList(new BufferOrEvent(bufferConsumer.build(), 0, false));\n+\t\tList<BufferOrEvent> buffers = Collections.singletonList(createDataBuffer());\n \n \t\tVerifyRecordsDataOutput output = new VerifyRecordsDataOutput<>();\n-\t\tStreamTaskNetworkInput input = new StreamTaskNetworkInput<>(\n-\t\t\tnew CheckpointedInputGate(\n-\t\t\t\tnew MockInputGate(1, buffers, false),\n-\t\t\t\tnew CheckpointBarrierTracker(1, new DummyCheckpointInvokable())),\n-\t\t\tLongSerializer.INSTANCE,\n-\t\t\tioManager,\n-\t\t\tnew StatusWatermarkValve(1, output),\n-\t\t\t0);\n+\t\tStreamTaskNetworkInput input = createStreamTaskNetworkInput(buffers, output);\n \n \t\tassertHasNextElement(input, output);\n \t\tassertHasNextElement(input, output);\n \t\tassertEquals(2, output.getNumberOfEmittedRecords());\n \t}\n \n+\t@Test", "originalCommit": "096059e3754e1d202025ea2b3f4475b75d06d34b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "36549732ffe9b53fcdab28404170dd1f8c026072", "chunk": "diff --git a/flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/io/StreamTaskNetworkInputTest.java b/flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/io/StreamTaskNetworkInputTest.java\nindex 7febf7c99e..a9b2ea0ddb 100644\n--- a/flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/io/StreamTaskNetworkInputTest.java\n+++ b/flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/io/StreamTaskNetworkInputTest.java\n\n@@ -87,6 +87,10 @@ public class StreamTaskNetworkInputTest {\n \t\tassertEquals(2, output.getNumberOfEmittedRecords());\n \t}\n \n+\t/**\n+\t * InputGate on CheckpointBarrier can enqueue a mailbox action to execute and StreamTaskNetworkInput must\n+\t * allow this action to execute before processing a following record.\n+\t */\n \t@Test\n \tpublic void testNoDataProcessedAfterCheckpointBarrier() throws Exception {\n \t\tCheckpointBarrier barrier = new CheckpointBarrier(0, 0, CheckpointOptions.forCheckpointWithDefaultLocation());\n"}}, {"oid": "36549732ffe9b53fcdab28404170dd1f8c026072", "url": "https://github.com/apache/flink/commit/36549732ffe9b53fcdab28404170dd1f8c026072", "message": "[FLINK-17568][checkpointing] Fix the issue that task may consume input data after checkpoint barrier before checkpoint is performed for unaligned checkpoint\n\nFor unaligned checkpoint, task may consume data after the checkpoint barrier before performing checkpoint which leads to consumption of duplicated data and corruption of data stream. More specifically, when the Netty thread notifies the checkpoint barrier for the first time and enqueues a checkpointing task in the mailbox, the task thread may still in data processing loop and if it reads a new checkpoint barrier from a input channel it will not return to the mailbox and instead it will continue to read data until all data is consumed or we have a full record, meanwhile, the data after checkpoint barrier may be read and consumed which lead to inconsistency.\n\nThis commit fixes the problem by returning to mailbox each time a checkpoint barrier is processed by the task thread.", "committedDate": "2020-05-09T08:57:22Z", "type": "commit"}, {"oid": "4ad10f85ecce3a1421b6543ea9a030dad542b011", "url": "https://github.com/apache/flink/commit/4ad10f85ecce3a1421b6543ea9a030dad542b011", "message": "[hotfix][tests] Remove redundant test case CheckpointBarrierAlignerTestBase#testMultiChannelSkippingCheckpoints\n\nThis closes #12034.", "committedDate": "2020-05-09T09:08:05Z", "type": "commit"}, {"oid": "4ad10f85ecce3a1421b6543ea9a030dad542b011", "url": "https://github.com/apache/flink/commit/4ad10f85ecce3a1421b6543ea9a030dad542b011", "message": "[hotfix][tests] Remove redundant test case CheckpointBarrierAlignerTestBase#testMultiChannelSkippingCheckpoints\n\nThis closes #12034.", "committedDate": "2020-05-09T09:08:05Z", "type": "forcePushed"}]}