{"pr_number": 4479, "pr_title": "[GEOS-9733]: Importer, stop scanning the whole directory when looking for supplemental files", "pr_createdAt": "2020-09-09T13:41:30Z", "pr_url": "https://github.com/geoserver/geoserver/pull/4479", "timeline": [{"oid": "9346eebf922aa680e32cb9cd0f8f0d44539834cc", "url": "https://github.com/geoserver/geoserver/commit/9346eebf922aa680e32cb9cd0f8f0d44539834cc", "message": "[GEOS-9733]: Importer stop scanning the whole directory when looking for supplemental files", "committedDate": "2020-09-09T13:46:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTcwNTcwOQ==", "url": "https://github.com/geoserver/geoserver/pull/4479#discussion_r485705709", "bodyText": "Better practice, declare interface, create instance.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    HashSet<String> upperCase = new HashSet<>();\n          \n          \n            \n                    Set<String> upperCase = new HashSet<>();", "author": "aaime", "createdAt": "2020-09-09T15:32:09Z", "path": "src/extension/importer/core/src/main/java/org/geoserver/importer/DefaultSupplementalFileExtensionsProvider.java", "diffHunk": "@@ -0,0 +1,46 @@\n+/* (c) 2020 Open Source Geospatial Foundation - all rights reserved\n+ * This code is licensed under the GPL 2.0 license, available at the root\n+ * application directory.\n+ */\n+package org.geoserver.importer;\n+\n+import java.util.Collections;\n+import java.util.HashSet;\n+import java.util.Set;\n+import org.apache.commons.lang.StringUtils;\n+\n+/** Default implementation of a SupplementalFileExtensionsProvider */\n+public class DefaultSupplementalFileExtensionsProvider\n+        implements SupplementalFileExtensionsProvider {\n+    private Set<String> acceptedInputExtensions;\n+    private Set<String> supplementalExtensions;\n+    private Set<String> upperCaseSupplementalExtensions;\n+\n+    public DefaultSupplementalFileExtensionsProvider(\n+            Set<String> acceptedInputExtensions, Set<String> supplementalExtensions) {\n+        this.acceptedInputExtensions = Collections.unmodifiableSet(acceptedInputExtensions);\n+        this.supplementalExtensions = Collections.unmodifiableSet(supplementalExtensions);\n+        HashSet<String> upperCase = new HashSet<>();", "originalCommit": "9346eebf922aa680e32cb9cd0f8f0d44539834cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjEzMzU5Nw==", "url": "https://github.com/geoserver/geoserver/pull/4479#discussion_r486133597", "bodyText": "Fixed", "author": "dromagnoli", "createdAt": "2020-09-10T07:46:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTcwNTcwOQ=="}], "type": "inlineReview", "revised_code": {"commit": "b24c21ec26b9e665c0ec87b692cbc475735b7248", "chunk": "diff --git a/src/extension/importer/core/src/main/java/org/geoserver/importer/DefaultSupplementalFileExtensionsProvider.java b/src/extension/importer/core/src/main/java/org/geoserver/importer/DefaultSupplementalFileExtensionsProvider.java\nindex ce0aab4bd7..668c0abd17 100644\n--- a/src/extension/importer/core/src/main/java/org/geoserver/importer/DefaultSupplementalFileExtensionsProvider.java\n+++ b/src/extension/importer/core/src/main/java/org/geoserver/importer/DefaultSupplementalFileExtensionsProvider.java\n\n@@ -20,7 +20,7 @@ public class DefaultSupplementalFileExtensionsProvider\n             Set<String> acceptedInputExtensions, Set<String> supplementalExtensions) {\n         this.acceptedInputExtensions = Collections.unmodifiableSet(acceptedInputExtensions);\n         this.supplementalExtensions = Collections.unmodifiableSet(supplementalExtensions);\n-        HashSet<String> upperCase = new HashSet<>();\n+        Set<String> upperCase = new HashSet<>();\n         supplementalExtensions.stream().forEach(e -> upperCase.add(e.toUpperCase()));\n         upperCaseSupplementalExtensions = Collections.unmodifiableSet(upperCase);\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTcwNzg0OA==", "url": "https://github.com/geoserver/geoserver/pull/4479#discussion_r485707848", "bodyText": "I would add a comment explaining why it's done this way, on a folder with few files this approach is actually more work. However, it's not that much more work, while on a directory with lots of files, this is more efficient.", "author": "aaime", "createdAt": "2020-09-09T15:35:11Z", "path": "src/extension/importer/core/src/main/java/org/geoserver/importer/SpatialFile.java", "diffHunk": "@@ -99,36 +101,42 @@ public String apply(@Nullable StyleHandler input) {\n \n         // getBaseName only gets the LAST extension so beware for .shp.aux.xml stuff\n         final String baseName = getBaseName(file.getName());\n+        final String baseExtension = getExtension(file.getName());\n+        final String basePath = file.getParent();\n+\n+        // look for style files", "originalCommit": "9346eebf922aa680e32cb9cd0f8f0d44539834cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjEzMzY4OA==", "url": "https://github.com/geoserver/geoserver/pull/4479#discussion_r486133688", "bodyText": "Done", "author": "dromagnoli", "createdAt": "2020-09-10T07:46:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTcwNzg0OA=="}], "type": "inlineReview", "revised_code": {"commit": "b24c21ec26b9e665c0ec87b692cbc475735b7248", "chunk": "diff --git a/src/extension/importer/core/src/main/java/org/geoserver/importer/SpatialFile.java b/src/extension/importer/core/src/main/java/org/geoserver/importer/SpatialFile.java\nindex c21595d2f5..4f591e5206 100644\n--- a/src/extension/importer/core/src/main/java/org/geoserver/importer/SpatialFile.java\n+++ b/src/extension/importer/core/src/main/java/org/geoserver/importer/SpatialFile.java\n\n@@ -115,6 +115,13 @@ public class SpatialFile extends FileData {\n             }\n         }\n \n+        // The previous version of the code was doing a File.listFiles,\n+        // looking for files with same name of the input file. However\n+        // this was resulting in very time consuming operation when importing\n+        // a file living into a directory containing thousands of files.\n+        // Especially on system doing continuous ingest of a new file every few minute\n+        // with a continuously growing directory.\n+\n         // Looking for supplemental files\n         List<SupplementalFileExtensionsProvider> extensionsProviders =\n                 GeoServerExtensions.extensions(SupplementalFileExtensionsProvider.class);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTcxNjYwMg==", "url": "https://github.com/geoserver/geoserver/pull/4479#discussion_r485716602", "bodyText": "This actually changes the behavior, some files that were caught before will not be in the list anymore. However, in fact getSuppFiles is not used for anything active in the import, it's just reflected out in the generated JSON when using the REST API, but not used to drive actual import, or to move files, or anything like that. So in the end, pretty invisible to the user, and not particularly useful (one may even just stop collecting them...).", "author": "aaime", "createdAt": "2020-09-09T15:47:22Z", "path": "src/extension/importer/core/src/main/java/org/geoserver/importer/SpatialFile.java", "diffHunk": "@@ -99,36 +101,42 @@ public String apply(@Nullable StyleHandler input) {\n \n         // getBaseName only gets the LAST extension so beware for .shp.aux.xml stuff\n         final String baseName = getBaseName(file.getName());\n+        final String baseExtension = getExtension(file.getName());\n+        final String basePath = file.getParent();\n+\n+        // look for style files\n+        Iterator styleExtensionsIt = styleExtensions.iterator();\n+        while (styleFile == null && styleExtensionsIt.hasNext()) {\n+            Object ext = styleExtensionsIt.next();\n+            File style = new File(basePath, baseName + \".\" + ext);\n+            if (style.exists()) {\n+                // TODO: deal with multiple style files? for now we just grab the first\n+                styleFile = style;\n+            }\n+        }\n \n-        File[] files = file.getParentFile().listFiles();\n-        if (files != null) {\n-            for (File f : files) {\n-                if (f.equals(file)) {\n-                    continue;\n-                }\n-\n-                if (!f.getName().startsWith(baseName)) {\n-                    continue;\n-                }\n-\n-                if (!f.isFile()) {\n-                    continue;\n-                }\n-\n-                String ext = f.getName().substring(baseName.length());\n-                // once the basename is stripped, extension(s) should be present\n-                if (ext.charAt(0) == '.') {\n-                    if (\".prj\".equalsIgnoreCase(ext)) {\n-                        prjFile = f;\n-                    } else if (styleFile == null && styleExtensions.contains(ext.substring(1))) {\n-                        // TODO: deal with multiple style files? for now we just grab the first\n-                        styleFile = f;\n+        // Looking for supplemental files", "originalCommit": "9346eebf922aa680e32cb9cd0f8f0d44539834cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjEzMzgyNg==", "url": "https://github.com/geoserver/geoserver/pull/4479#discussion_r486133826", "bodyText": "Right", "author": "dromagnoli", "createdAt": "2020-09-10T07:46:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTcxNjYwMg=="}], "type": "inlineReview", "revised_code": {"commit": "b24c21ec26b9e665c0ec87b692cbc475735b7248", "chunk": "diff --git a/src/extension/importer/core/src/main/java/org/geoserver/importer/SpatialFile.java b/src/extension/importer/core/src/main/java/org/geoserver/importer/SpatialFile.java\nindex c21595d2f5..4f591e5206 100644\n--- a/src/extension/importer/core/src/main/java/org/geoserver/importer/SpatialFile.java\n+++ b/src/extension/importer/core/src/main/java/org/geoserver/importer/SpatialFile.java\n\n@@ -115,6 +115,13 @@ public class SpatialFile extends FileData {\n             }\n         }\n \n+        // The previous version of the code was doing a File.listFiles,\n+        // looking for files with same name of the input file. However\n+        // this was resulting in very time consuming operation when importing\n+        // a file living into a directory containing thousands of files.\n+        // Especially on system doing continuous ingest of a new file every few minute\n+        // with a continuously growing directory.\n+\n         // Looking for supplemental files\n         List<SupplementalFileExtensionsProvider> extensionsProviders =\n                 GeoServerExtensions.extensions(SupplementalFileExtensionsProvider.class);\n"}}, {"oid": "b24c21ec26b9e665c0ec87b692cbc475735b7248", "url": "https://github.com/geoserver/geoserver/commit/b24c21ec26b9e665c0ec87b692cbc475735b7248", "message": "[GEOS-9733]: Importer stop scanning the whole directory when looking for supplemental files", "committedDate": "2020-09-10T07:44:51Z", "type": "commit"}, {"oid": "b24c21ec26b9e665c0ec87b692cbc475735b7248", "url": "https://github.com/geoserver/geoserver/commit/b24c21ec26b9e665c0ec87b692cbc475735b7248", "message": "[GEOS-9733]: Importer stop scanning the whole directory when looking for supplemental files", "committedDate": "2020-09-10T07:44:51Z", "type": "forcePushed"}]}