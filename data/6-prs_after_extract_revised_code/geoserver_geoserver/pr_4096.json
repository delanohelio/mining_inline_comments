{"pr_number": 4096, "pr_title": "[GEOS-5188] LegendDecoration does not respect target size", "pr_createdAt": "2020-03-02T13:04:48Z", "pr_url": "https://github.com/geoserver/geoserver/pull/4096", "timeline": [{"oid": "896cabe231eb15848857f823379a6887323359f8", "url": "https://github.com/geoserver/geoserver/commit/896cabe231eb15848857f823379a6887323359f8", "message": "[GEOS-5188] LegendDecoration does not respect target size", "committedDate": "2020-03-02T13:49:46Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTYwNzQ0Ng==", "url": "https://github.com/geoserver/geoserver/pull/4096#discussion_r389607446", "bodyText": "Ok, so you need the legends to be computed, but they are normally done in the method above... and are making sure they are present even if the auto-sizing did not happen. Can you add a code comment to clarify it?", "author": "aaime", "createdAt": "2020-03-09T11:40:11Z", "path": "src/wms/src/main/java/org/geoserver/wms/decoration/LegendDecoration.java", "diffHunk": "@@ -185,8 +122,8 @@ public Dimension findOptimalSize(Graphics2D g2d, WMSMapContent mapContext) {\n \n     public void paint(Graphics2D g2d, Rectangle paintArea, WMSMapContent mapContext)\n             throws Exception {\n-        List<LayerLegend> legends = this.legends.get();\n-\n+        List<LayerLegend> legends =\n+                this.legends.get() != null ? this.legends.get() : getLayerLegend(g2d, mapContext);", "originalCommit": "896cabe231eb15848857f823379a6887323359f8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9846d310862846e535f522eb531872eab5e69d68", "chunk": "diff --git a/src/wms/src/main/java/org/geoserver/wms/decoration/LegendDecoration.java b/src/wms/src/main/java/org/geoserver/wms/decoration/LegendDecoration.java\nindex e56993c8d0..0ddab994ad 100644\n--- a/src/wms/src/main/java/org/geoserver/wms/decoration/LegendDecoration.java\n+++ b/src/wms/src/main/java/org/geoserver/wms/decoration/LegendDecoration.java\n\n@@ -122,6 +122,9 @@ public class LegendDecoration extends AbstractDispatcherCallback implements MapD\n \n     public void paint(Graphics2D g2d, Rectangle paintArea, WMSMapContent mapContext)\n             throws Exception {\n+        // check if LayerLegends have been computed in the above method; if not\n+        // (cause a custom legend size and findOptimalSize has not been called)\n+        // they are produced here\n         List<LayerLegend> legends =\n                 this.legends.get() != null ? this.legends.get() : getLayerLegend(g2d, mapContext);\n         double dpi = RendererUtilities.getDpi(mapContext.getRequest().getFormatOptions());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTYwODUxNw==", "url": "https://github.com/geoserver/geoserver/pull/4096#discussion_r389608517", "bodyText": "So here you're asking for a map that's actually smaller than the legend decoration, so you expect the decoration to cover all of it, map not even being visible, and the decoration be cut as it does not fit.\nPlease clarify it in a comment.", "author": "aaime", "createdAt": "2020-03-09T11:42:34Z", "path": "src/wms/src/test/java/org/geoserver/wms/wms_1_1_1/GetMapIntegrationTest.java", "diffHunk": "@@ -1988,4 +1988,27 @@ public void testLayoutLegendStyleTextFitBox() throws Exception {\n         sInfo.setLegend(null);\n         catalog.save(sInfo);\n     }\n+\n+    @Test\n+    public void testLayoutLegendWithSpecifiedTargetSize() throws Exception {\n+        File layouts = getDataDirectory().findOrCreateDir(\"layouts\");\n+        URL layout = GetMapIntegrationTest.class.getResource(\"../test-layout-with-size.xml\");\n+        FileUtils.copyURLToFile(layout, new File(layouts, \"test-layout-with-size.xml\"));\n+        BufferedImage image =", "originalCommit": "896cabe231eb15848857f823379a6887323359f8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9846d310862846e535f522eb531872eab5e69d68", "chunk": "diff --git a/src/wms/src/test/java/org/geoserver/wms/wms_1_1_1/GetMapIntegrationTest.java b/src/wms/src/test/java/org/geoserver/wms/wms_1_1_1/GetMapIntegrationTest.java\nindex d19017f3a0..1c3bdf2ca4 100644\n--- a/src/wms/src/test/java/org/geoserver/wms/wms_1_1_1/GetMapIntegrationTest.java\n+++ b/src/wms/src/test/java/org/geoserver/wms/wms_1_1_1/GetMapIntegrationTest.java\n\n@@ -1991,6 +1991,9 @@ public class GetMapIntegrationTest extends WMSTestSupport {\n \n     @Test\n     public void testLayoutLegendWithSpecifiedTargetSize() throws Exception {\n+        // checking a legend decoration with a custom size bigger than the\n+        // map size; expecting that the specified legend size is picked up,\n+        // while resizing it accordingly to map dimension\n         File layouts = getDataDirectory().findOrCreateDir(\"layouts\");\n         URL layout = GetMapIntegrationTest.class.getResource(\"../test-layout-with-size.xml\");\n         FileUtils.copyURLToFile(layout, new File(layouts, \"test-layout-with-size.xml\"));\n"}}, {"oid": "9846d310862846e535f522eb531872eab5e69d68", "url": "https://github.com/geoserver/geoserver/commit/9846d310862846e535f522eb531872eab5e69d68", "message": "[GEOS-5188] LegendDecoration does not respect target size", "committedDate": "2020-03-09T15:24:02Z", "type": "commit"}, {"oid": "9846d310862846e535f522eb531872eab5e69d68", "url": "https://github.com/geoserver/geoserver/commit/9846d310862846e535f522eb531872eab5e69d68", "message": "[GEOS-5188] LegendDecoration does not respect target size", "committedDate": "2020-03-09T15:24:02Z", "type": "forcePushed"}]}