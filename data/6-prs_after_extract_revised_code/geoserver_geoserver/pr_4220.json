{"pr_number": 4220, "pr_title": "[GEOS-9592] Assigning raster style to vector layer gives unclear error \u2026", "pr_createdAt": "2020-04-29T09:10:48Z", "pr_url": "https://github.com/geoserver/geoserver/pull/4220", "timeline": [{"oid": "978922961fe9ac3157163e1a1b4057e063b4f098", "url": "https://github.com/geoserver/geoserver/commit/978922961fe9ac3157163e1a1b4057e063b4f098", "message": "GEOS-9592 Assigning raster style to vector layer gives unclear error and stack trace", "committedDate": "2020-04-29T12:10:59Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDg1MTQ5MA==", "url": "https://github.com/geoserver/geoserver/pull/4220#discussion_r420851490", "bodyText": "Better than the previous code, but could be even better:\nfinal Feature feature = DataUtilities.first(mapContent.layers().get(0).getFeatureSource().getFeatures().features());", "author": "aaime", "createdAt": "2020-05-06T14:47:55Z", "path": "src/wms/src/main/java/org/geoserver/wms/map/RenderedImageMapOutputFormat.java", "diffHunk": "@@ -1029,14 +1030,14 @@ private RenderedImage directRasterRender(\n                 //\n                 // Get the reader\n                 //\n-                final Feature feature =\n-                        mapContent\n-                                .layers()\n-                                .get(0)\n-                                .getFeatureSource()\n-                                .getFeatures()\n-                                .features()\n-                                .next();\n+                final Feature feature;\n+                try (FeatureIterator<?> it =", "originalCommit": "978922961fe9ac3157163e1a1b4057e063b4f098", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTc3Mzc3NQ==", "url": "https://github.com/geoserver/geoserver/pull/4220#discussion_r421773775", "bodyText": "done", "author": "NielsCharlier", "createdAt": "2020-05-07T20:28:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDg1MTQ5MA=="}], "type": "inlineReview", "revised_code": {"commit": "fae173a2ca4c2a77434605ec5063b643b8a0e3a3", "chunk": "diff --git a/src/wms/src/main/java/org/geoserver/wms/map/RenderedImageMapOutputFormat.java b/src/wms/src/main/java/org/geoserver/wms/map/RenderedImageMapOutputFormat.java\nindex 6150fe8be9..58bbe52849 100644\n--- a/src/wms/src/main/java/org/geoserver/wms/map/RenderedImageMapOutputFormat.java\n+++ b/src/wms/src/main/java/org/geoserver/wms/map/RenderedImageMapOutputFormat.java\n\n@@ -1030,11 +1030,9 @@ public class RenderedImageMapOutputFormat extends AbstractMapOutputFormat {\n                 //\n                 // Get the reader\n                 //\n-                final Feature feature;\n-                try (FeatureIterator<?> it =\n-                        mapContent.layers().get(0).getFeatureSource().getFeatures().features()) {\n-                    feature = it.next();\n-                }\n+                final Feature feature =\n+                        DataUtilities.first(\n+                                mapContent.layers().get(0).getFeatureSource().getFeatures());\n                 if (feature == null || feature.getProperty(\"grid\") == null) {\n                     return null;\n                 }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDg1MjMxOQ==", "url": "https://github.com/geoserver/geoserver/pull/4220#discussion_r420852319", "bodyText": "This is supposed to return a blank image, if I understand correctly. If so, assert it using the assertBlank utility method.", "author": "aaime", "createdAt": "2020-05-06T14:48:56Z", "path": "src/wms/src/test/java/org/geoserver/wms/map/RenderedImageMapOutputFormatTest.java", "diffHunk": "@@ -1785,6 +1785,21 @@ public void testReprojectionHasNoWhiteLine()\n         assertEquals(width * height, validPixelsCount);\n     }\n \n+    @Test\n+    public void testFaultyStyleDoesntBreak() throws Exception {\n+        MockHttpServletResponse response =\n+                getAsServletResponse(\n+                        \"wms?BBOX=-180,-90,180,90\"\n+                                + \"&styles=raster&layers=cdf:Fifteen&Format=image/png\"\n+                                + \"&request=GetMap\"\n+                                + \"&width=256\"\n+                                + \"&height=256\"\n+                                + \"&srs=EPSG%3A4326\");\n+\n+        BufferedImage image = ImageIO.read(getBinaryInputStream(response));", "originalCommit": "978922961fe9ac3157163e1a1b4057e063b4f098", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTc3MzgzMA==", "url": "https://github.com/geoserver/geoserver/pull/4220#discussion_r421773830", "bodyText": "done", "author": "NielsCharlier", "createdAt": "2020-05-07T20:28:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDg1MjMxOQ=="}], "type": "inlineReview", "revised_code": {"commit": "fae173a2ca4c2a77434605ec5063b643b8a0e3a3", "chunk": "diff --git a/src/wms/src/test/java/org/geoserver/wms/map/RenderedImageMapOutputFormatTest.java b/src/wms/src/test/java/org/geoserver/wms/map/RenderedImageMapOutputFormatTest.java\nindex 29acecda66..00e5b9922a 100644\n--- a/src/wms/src/test/java/org/geoserver/wms/map/RenderedImageMapOutputFormatTest.java\n+++ b/src/wms/src/test/java/org/geoserver/wms/map/RenderedImageMapOutputFormatTest.java\n\n@@ -1798,8 +1798,8 @@ public class RenderedImageMapOutputFormatTest extends WMSTestSupport {\n \n         BufferedImage image = ImageIO.read(getBinaryInputStream(response));\n         assertNotNull(image);\n+        assertBlank(\"testFaultyStyleDoesntBreak\", image);\n     }\n-\n     /**\n      * This dummy producer adds no functionality to DefaultRasterMapOutputFormat, just implements a\n      * void formatImageOutputStream to have a concrete class over which test that\n"}}, {"oid": "fae173a2ca4c2a77434605ec5063b643b8a0e3a3", "url": "https://github.com/geoserver/geoserver/commit/fae173a2ca4c2a77434605ec5063b643b8a0e3a3", "message": "GEOS-9592 Assigning raster style to vector layer gives unclear error and stack trace", "committedDate": "2020-05-07T20:27:04Z", "type": "commit"}, {"oid": "fae173a2ca4c2a77434605ec5063b643b8a0e3a3", "url": "https://github.com/geoserver/geoserver/commit/fae173a2ca4c2a77434605ec5063b643b8a0e3a3", "message": "GEOS-9592 Assigning raster style to vector layer gives unclear error and stack trace", "committedDate": "2020-05-07T20:27:04Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYxMDg5Mw==", "url": "https://github.com/geoserver/geoserver/pull/4220#discussion_r424610893", "bodyText": "The report indicated an unclear error was provided, did you wish to provide a clear error (or log warning) here?", "author": "jodygarnett", "createdAt": "2020-05-13T17:30:53Z", "path": "src/wms/src/main/java/org/geoserver/wms/map/RenderedImageMapOutputFormat.java", "diffHunk": "@@ -1030,13 +1031,11 @@ private RenderedImage directRasterRender(\n                 // Get the reader\n                 //\n                 final Feature feature =\n-                        mapContent\n-                                .layers()\n-                                .get(0)\n-                                .getFeatureSource()\n-                                .getFeatures()\n-                                .features()\n-                                .next();\n+                        DataUtilities.first(\n+                                mapContent.layers().get(0).getFeatureSource().getFeatures());\n+                if (feature == null || feature.getProperty(\"grid\") == null) {\n+                    return null;", "originalCommit": "fae173a2ca4c2a77434605ec5063b643b8a0e3a3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYxNDc4OA==", "url": "https://github.com/geoserver/geoserver/pull/4220#discussion_r424614788", "bodyText": "Questions:\n\nThis also only applies to the fast past, did you need a similar check in streaming renderer?\nHow does this work with geometry transformations, where raster is generated on the fly from feature content? Perhaps that is not on the fast path...", "author": "jodygarnett", "createdAt": "2020-05-13T17:37:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYxMDg5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY2ODY4MA==", "url": "https://github.com/geoserver/geoserver/pull/4220#discussion_r424668680", "bodyText": "I don't think there is a need to provide an error per se, because geoserver never does that when your styling doesn't produce any picture. There are many other cases when that can happen (for example a vector style for a raster layer, a style that has rules that somehow doesn't match with any of your data,...). If your WMS image is blank, I think it is the user's responsibility to double check if an appropriate style has been selected. But in this specific case you get an error and a strack trace that might only cause confusion because it provides no information to the user.\nAnd I guess this answers your other questions as well. In most cases, you will get a blank image, which is expected behaviour the way I see it. Only in this case you get the NPE.", "author": "NielsCharlier", "createdAt": "2020-05-13T19:08:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYxMDg5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzA5MjQ4Ng==", "url": "https://github.com/geoserver/geoserver/pull/4220#discussion_r427092486", "bodyText": "Okay blank image it is!", "author": "jodygarnett", "createdAt": "2020-05-19T07:40:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYxMDg5Mw=="}], "type": "inlineReview", "revised_code": null}]}