{"pr_number": 4095, "pr_title": "[GEOS-9522] SldService generate overlapping rules", "pr_createdAt": "2020-02-28T14:33:52Z", "pr_url": "https://github.com/geoserver/geoserver/pull/4095", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjMwNDcxOA==", "url": "https://github.com/geoserver/geoserver/pull/4095#discussion_r386304718", "bodyText": "I'd also check that the second rule here, and that they won't overlap?", "author": "aaime", "createdAt": "2020-03-02T10:17:32Z", "path": "src/extension/sldService/src/test/java/org/geoserver/sldservice/rest/ClassifierTest.java", "diffHunk": "@@ -1987,4 +1992,134 @@ private void checkRuleLineSymbolizer(Rule rule, String color) {\n         assertNotNull(symbolizer.getStroke());\n         assertEquals(color, symbolizer.getStroke().getColor().toString());\n     }\n+\n+    @Test\n+    public void testOpenIntervalFirstRuleConsistency() throws Exception {\n+        final String restPath =\n+                RestBaseController.ROOT_PATH\n+                        + \"/sldservice/cite:ClassificationPoints2/\"\n+                        + getServiceUrl()\n+                        + \".xml?\"\n+                        + \"attribute=bar&ramp=red&method=quantile&intervals=2&open=true\";\n+        Document dom = getAsDOM(restPath, 200);\n+        print(dom);\n+        ByteArrayOutputStream baos = new ByteArrayOutputStream();\n+        print(dom, baos);\n+        String resultXml = baos.toString().replace(\"\\r\", \"\").replace(\"\\n\", \"\");\n+        Rule[] rules =\n+                checkSLD(resultXml.replace(\"<Rules>\", sldPrefix).replace(\"</Rules>\", sldPostfix));\n+        assertTrue(rules.length == 2);\n+        assertTrue(rules[0].getFilter() instanceof PropertyIsEqualTo);", "originalCommit": "ca500b18f07d8e8f16493108dbabea4f36463c0e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjQwMDQ1MA==", "url": "https://github.com/geoserver/geoserver/pull/4095#discussion_r386400450", "bodyText": "fixed", "author": "taba90", "createdAt": "2020-03-02T13:46:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjMwNDcxOA=="}], "type": "inlineReview", "revised_code": {"commit": "18c5e1084224e3e12d5f3f62854fd39e50a6cc99", "chunk": "diff --git a/src/extension/sldService/src/test/java/org/geoserver/sldservice/rest/ClassifierTest.java b/src/extension/sldService/src/test/java/org/geoserver/sldservice/rest/ClassifierTest.java\nindex c187a7c6c4..a7557c81e6 100644\n--- a/src/extension/sldService/src/test/java/org/geoserver/sldservice/rest/ClassifierTest.java\n+++ b/src/extension/sldService/src/test/java/org/geoserver/sldservice/rest/ClassifierTest.java\n\n@@ -2010,7 +2014,7 @@ public class ClassifierTest extends SLDServiceBaseTest {\n                 checkSLD(resultXml.replace(\"<Rules>\", sldPrefix).replace(\"</Rules>\", sldPostfix));\n         assertTrue(rules.length == 2);\n         assertTrue(rules[0].getFilter() instanceof PropertyIsEqualTo);\n-\n+        assertTrue(rules[1].getFilter() instanceof PropertyIsGreaterThan);\n         final String restPathJenks =\n                 RestBaseController.ROOT_PATH\n                         + \"/sldservice/cite:ClassificationPoints2/\"\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjMwNDc3MA==", "url": "https://github.com/geoserver/geoserver/pull/4095#discussion_r386304770", "bodyText": "Same as above.", "author": "aaime", "createdAt": "2020-03-02T10:17:39Z", "path": "src/extension/sldService/src/test/java/org/geoserver/sldservice/rest/ClassifierTest.java", "diffHunk": "@@ -1987,4 +1992,134 @@ private void checkRuleLineSymbolizer(Rule rule, String color) {\n         assertNotNull(symbolizer.getStroke());\n         assertEquals(color, symbolizer.getStroke().getColor().toString());\n     }\n+\n+    @Test\n+    public void testOpenIntervalFirstRuleConsistency() throws Exception {\n+        final String restPath =\n+                RestBaseController.ROOT_PATH\n+                        + \"/sldservice/cite:ClassificationPoints2/\"\n+                        + getServiceUrl()\n+                        + \".xml?\"\n+                        + \"attribute=bar&ramp=red&method=quantile&intervals=2&open=true\";\n+        Document dom = getAsDOM(restPath, 200);\n+        print(dom);\n+        ByteArrayOutputStream baos = new ByteArrayOutputStream();\n+        print(dom, baos);\n+        String resultXml = baos.toString().replace(\"\\r\", \"\").replace(\"\\n\", \"\");\n+        Rule[] rules =\n+                checkSLD(resultXml.replace(\"<Rules>\", sldPrefix).replace(\"</Rules>\", sldPostfix));\n+        assertTrue(rules.length == 2);\n+        assertTrue(rules[0].getFilter() instanceof PropertyIsEqualTo);\n+\n+        final String restPathJenks =\n+                RestBaseController.ROOT_PATH\n+                        + \"/sldservice/cite:ClassificationPoints2/\"\n+                        + getServiceUrl()\n+                        + \".xml?\"\n+                        + \"attribute=bar&ramp=red&method=jenks&intervals=2&open=true\";\n+        Document domJenks = getAsDOM(restPathJenks, 200);\n+        print(domJenks);\n+        ByteArrayOutputStream baosJenks = new ByteArrayOutputStream();\n+        print(domJenks, baosJenks);\n+        String resultXmlJenks = baosJenks.toString().replace(\"\\r\", \"\").replace(\"\\n\", \"\");\n+        Rule[] rulesJenks =\n+                checkSLD(\n+                        resultXmlJenks\n+                                .replace(\"<Rules>\", sldPrefix)\n+                                .replace(\"</Rules>\", sldPostfix));\n+        assertTrue(rulesJenks.length == 2);\n+        assertTrue(rulesJenks[0].getFilter() instanceof PropertyIsEqualTo);", "originalCommit": "ca500b18f07d8e8f16493108dbabea4f36463c0e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjQwMDQwNg==", "url": "https://github.com/geoserver/geoserver/pull/4095#discussion_r386400406", "bodyText": "fixed", "author": "taba90", "createdAt": "2020-03-02T13:45:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjMwNDc3MA=="}], "type": "inlineReview", "revised_code": {"commit": "18c5e1084224e3e12d5f3f62854fd39e50a6cc99", "chunk": "diff --git a/src/extension/sldService/src/test/java/org/geoserver/sldservice/rest/ClassifierTest.java b/src/extension/sldService/src/test/java/org/geoserver/sldservice/rest/ClassifierTest.java\nindex c187a7c6c4..a7557c81e6 100644\n--- a/src/extension/sldService/src/test/java/org/geoserver/sldservice/rest/ClassifierTest.java\n+++ b/src/extension/sldService/src/test/java/org/geoserver/sldservice/rest/ClassifierTest.java\n\n@@ -2010,7 +2014,7 @@ public class ClassifierTest extends SLDServiceBaseTest {\n                 checkSLD(resultXml.replace(\"<Rules>\", sldPrefix).replace(\"</Rules>\", sldPostfix));\n         assertTrue(rules.length == 2);\n         assertTrue(rules[0].getFilter() instanceof PropertyIsEqualTo);\n-\n+        assertTrue(rules[1].getFilter() instanceof PropertyIsGreaterThan);\n         final String restPathJenks =\n                 RestBaseController.ROOT_PATH\n                         + \"/sldservice/cite:ClassificationPoints2/\"\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjMwOTQ4Mg==", "url": "https://github.com/geoserver/geoserver/pull/4095#discussion_r386309482", "bodyText": "Name suggests a general non overlap test, but in fact it's pretty specific and does not test what happens in the first rule filter.\nSuggestion for a different approach:\nSimpleFeatureType ft = (SimpleFeatureType)= getCatalog().getFeatureTypeByName(\"ClassificationPoints2\").getFeatureType();\nSimpleFeature feature = DataUtilities.create(ft, \"=1|2.0|POINT(4 2.5)\");\nassertTrue(first.getFilter().evaluate(feature));\nassertFalse(second.getFilter().evaluate(feature));", "author": "aaime", "createdAt": "2020-03-02T10:26:41Z", "path": "src/extension/sldService/src/test/java/org/geoserver/sldservice/rest/ClassifierTest.java", "diffHunk": "@@ -1987,4 +1992,134 @@ private void checkRuleLineSymbolizer(Rule rule, String color) {\n         assertNotNull(symbolizer.getStroke());\n         assertEquals(color, symbolizer.getStroke().getColor().toString());\n     }\n+\n+    @Test\n+    public void testOpenIntervalFirstRuleConsistency() throws Exception {\n+        final String restPath =\n+                RestBaseController.ROOT_PATH\n+                        + \"/sldservice/cite:ClassificationPoints2/\"\n+                        + getServiceUrl()\n+                        + \".xml?\"\n+                        + \"attribute=bar&ramp=red&method=quantile&intervals=2&open=true\";\n+        Document dom = getAsDOM(restPath, 200);\n+        print(dom);\n+        ByteArrayOutputStream baos = new ByteArrayOutputStream();\n+        print(dom, baos);\n+        String resultXml = baos.toString().replace(\"\\r\", \"\").replace(\"\\n\", \"\");\n+        Rule[] rules =\n+                checkSLD(resultXml.replace(\"<Rules>\", sldPrefix).replace(\"</Rules>\", sldPostfix));\n+        assertTrue(rules.length == 2);\n+        assertTrue(rules[0].getFilter() instanceof PropertyIsEqualTo);\n+\n+        final String restPathJenks =\n+                RestBaseController.ROOT_PATH\n+                        + \"/sldservice/cite:ClassificationPoints2/\"\n+                        + getServiceUrl()\n+                        + \".xml?\"\n+                        + \"attribute=bar&ramp=red&method=jenks&intervals=2&open=true\";\n+        Document domJenks = getAsDOM(restPathJenks, 200);\n+        print(domJenks);\n+        ByteArrayOutputStream baosJenks = new ByteArrayOutputStream();\n+        print(domJenks, baosJenks);\n+        String resultXmlJenks = baosJenks.toString().replace(\"\\r\", \"\").replace(\"\\n\", \"\");\n+        Rule[] rulesJenks =\n+                checkSLD(\n+                        resultXmlJenks\n+                                .replace(\"<Rules>\", sldPrefix)\n+                                .replace(\"</Rules>\", sldPostfix));\n+        assertTrue(rulesJenks.length == 2);\n+        assertTrue(rulesJenks[0].getFilter() instanceof PropertyIsEqualTo);\n+    }\n+\n+    @Test\n+    public void testNotOverlappingRulesClosed() throws Exception {\n+        final String restPath =\n+                RestBaseController.ROOT_PATH\n+                        + \"/sldservice/cite:ClassificationPoints2/\"\n+                        + getServiceUrl()\n+                        + \".xml?\"\n+                        + \"attribute=bar&ramp=red&method=quantile&intervals=2\";\n+        Document dom = getAsDOM(restPath, 200);\n+        print(dom);\n+        ByteArrayOutputStream baos = new ByteArrayOutputStream();\n+        print(dom, baos);\n+        String resultXml = baos.toString().replace(\"\\r\", \"\").replace(\"\\n\", \"\");\n+        Rule[] rules =\n+                checkSLD(resultXml.replace(\"<Rules>\", sldPrefix).replace(\"</Rules>\", sldPostfix));\n+        assertTrue(rules.length == 2);\n+        Rule first = rules[0];\n+        Rule second = rules[1];\n+        checkNotOverlappingRules(first, second);\n+        final String restPathJenks =\n+                RestBaseController.ROOT_PATH\n+                        + \"/sldservice/cite:ClassificationPoints2/\"\n+                        + getServiceUrl()\n+                        + \".xml?\"\n+                        + \"attribute=bar&ramp=red&method=jenks&intervals=2&\";\n+        Document domJenks = getAsDOM(restPathJenks, 200);\n+        print(domJenks);\n+        ByteArrayOutputStream baosJenks = new ByteArrayOutputStream();\n+        print(domJenks, baosJenks);\n+        String resultXmlJenks = baosJenks.toString().replace(\"\\r\", \"\").replace(\"\\n\", \"\");\n+        Rule[] rulesJenks =\n+                checkSLD(\n+                        resultXmlJenks\n+                                .replace(\"<Rules>\", sldPrefix)\n+                                .replace(\"</Rules>\", sldPostfix));\n+        assertTrue(rulesJenks.length == 2);\n+        Rule firstJenks = rulesJenks[0];\n+        Rule secondJenks = rulesJenks[1];\n+        checkNotOverlappingRules(firstJenks, secondJenks);\n+    }\n+\n+    @Test\n+    public void testNotOverlappingRulesOpen() throws Exception {\n+        final String restPath =\n+                RestBaseController.ROOT_PATH\n+                        + \"/sldservice/cite:ClassificationPoints2/\"\n+                        + getServiceUrl()\n+                        + \".xml?\"\n+                        + \"attribute=bar&ramp=red&method=quantile&intervals=3&open=true\";\n+        Document dom = getAsDOM(restPath, 200);\n+        print(dom);\n+        ByteArrayOutputStream baos = new ByteArrayOutputStream();\n+        print(dom, baos);\n+        String resultXml = baos.toString().replace(\"\\r\", \"\").replace(\"\\n\", \"\");\n+        Rule[] rules =\n+                checkSLD(resultXml.replace(\"<Rules>\", sldPrefix).replace(\"</Rules>\", sldPostfix));\n+        assertTrue(rules.length == 3);\n+        Rule first = rules[0];\n+        Rule second = rules[1];\n+        checkNotOverlappingRules(first, second);\n+        final String restPathJenks =\n+                RestBaseController.ROOT_PATH\n+                        + \"/sldservice/cite:ClassificationPoints2/\"\n+                        + getServiceUrl()\n+                        + \".xml?\"\n+                        + \"attribute=bar&ramp=red&method=jenks&intervals=3&open=true\";\n+        Document domJenks = getAsDOM(restPathJenks, 200);\n+        print(domJenks);\n+        ByteArrayOutputStream baosJenks = new ByteArrayOutputStream();\n+        print(domJenks, baosJenks);\n+        String resultXmlJenks = baosJenks.toString().replace(\"\\r\", \"\").replace(\"\\n\", \"\");\n+        Rule[] rulesJenks =\n+                checkSLD(\n+                        resultXmlJenks\n+                                .replace(\"<Rules>\", sldPrefix)\n+                                .replace(\"</Rules>\", sldPostfix));\n+        assertTrue(rulesJenks.length == 2);\n+        Rule firstJenks = rulesJenks[0];\n+        Rule secondJenks = rulesJenks[1];\n+        checkNotOverlappingRules(firstJenks, secondJenks);\n+    }\n+\n+    private void checkNotOverlappingRules(Rule first, Rule second) {", "originalCommit": "ca500b18f07d8e8f16493108dbabea4f36463c0e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjQwMDM2MA==", "url": "https://github.com/geoserver/geoserver/pull/4095#discussion_r386400360", "bodyText": "Thanks for the suggestion, applied.", "author": "taba90", "createdAt": "2020-03-02T13:45:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjMwOTQ4Mg=="}], "type": "inlineReview", "revised_code": {"commit": "18c5e1084224e3e12d5f3f62854fd39e50a6cc99", "chunk": "diff --git a/src/extension/sldService/src/test/java/org/geoserver/sldservice/rest/ClassifierTest.java b/src/extension/sldService/src/test/java/org/geoserver/sldservice/rest/ClassifierTest.java\nindex c187a7c6c4..a7557c81e6 100644\n--- a/src/extension/sldService/src/test/java/org/geoserver/sldservice/rest/ClassifierTest.java\n+++ b/src/extension/sldService/src/test/java/org/geoserver/sldservice/rest/ClassifierTest.java\n\n@@ -2010,7 +2014,7 @@ public class ClassifierTest extends SLDServiceBaseTest {\n                 checkSLD(resultXml.replace(\"<Rules>\", sldPrefix).replace(\"</Rules>\", sldPostfix));\n         assertTrue(rules.length == 2);\n         assertTrue(rules[0].getFilter() instanceof PropertyIsEqualTo);\n-\n+        assertTrue(rules[1].getFilter() instanceof PropertyIsGreaterThan);\n         final String restPathJenks =\n                 RestBaseController.ROOT_PATH\n                         + \"/sldservice/cite:ClassificationPoints2/\"\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjMxMDQwNw==", "url": "https://github.com/geoserver/geoserver/pull/4095#discussion_r386310407", "bodyText": "Isn't this redundant? If the prev min is the same as the current min, the previous filter must include the value... or not? Asking cause I'm not sure, but if it does, you could reduce the list of arguments of this method.", "author": "aaime", "createdAt": "2020-03-02T10:28:34Z", "path": "src/extension/sldService/src/main/java/org/geoserver/sldservice/utils/classifier/RulesBuilder.java", "diffHunk": "@@ -470,4 +476,29 @@ private Expression normalizeProperty(\n     private boolean isDuplicatedClass(List<Rule> rules, Filter f) {\n         return rules.stream().anyMatch(r -> r.getFilter().equals(f));\n     }\n+\n+    /**\n+     * Compares current min and previous min avoiding the production of overlapping Rules\n+     *\n+     * @param currentIdx\n+     * @param groups\n+     * @param att\n+     * @return\n+     */\n+    private Filter getNotOverlappingFilter(\n+            int currentIdx, RangedClassifier groups, Expression att, List<Rule> list) {\n+        Filter f;\n+        if (currentIdx > 0) {\n+            Rule prevRule = list.get(list.size() - 1);\n+            Object currMin = groups.getMin(currentIdx);\n+            Object prevMin = groups.getMin(currentIdx - 1);\n+            if (!prevMin.equals(currMin) || !(prevRule.getFilter() instanceof PropertyIsEqualTo))", "originalCommit": "ca500b18f07d8e8f16493108dbabea4f36463c0e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjQwMDE4OA==", "url": "https://github.com/geoserver/geoserver/pull/4095#discussion_r386400188", "bodyText": "Indeed it is, removed the check as well as the param.", "author": "taba90", "createdAt": "2020-03-02T13:45:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjMxMDQwNw=="}], "type": "inlineReview", "revised_code": {"commit": "18c5e1084224e3e12d5f3f62854fd39e50a6cc99", "chunk": "diff --git a/src/extension/sldService/src/main/java/org/geoserver/sldservice/utils/classifier/RulesBuilder.java b/src/extension/sldService/src/main/java/org/geoserver/sldservice/utils/classifier/RulesBuilder.java\nindex 6855685f5f..5b3ef145be 100644\n--- a/src/extension/sldService/src/main/java/org/geoserver/sldservice/utils/classifier/RulesBuilder.java\n+++ b/src/extension/sldService/src/main/java/org/geoserver/sldservice/utils/classifier/RulesBuilder.java\n\n@@ -486,13 +485,12 @@ public class RulesBuilder {\n      * @return\n      */\n     private Filter getNotOverlappingFilter(\n-            int currentIdx, RangedClassifier groups, Expression att, List<Rule> list) {\n+            int currentIdx, RangedClassifier groups, Expression att) {\n         Filter f;\n         if (currentIdx > 0) {\n-            Rule prevRule = list.get(list.size() - 1);\n             Object currMin = groups.getMin(currentIdx);\n             Object prevMin = groups.getMin(currentIdx - 1);\n-            if (!prevMin.equals(currMin) || !(prevRule.getFilter() instanceof PropertyIsEqualTo))\n+            if (!prevMin.equals(currMin))\n                 f = FF.greaterOrEqual(att, FF.literal(groups.getMin(currentIdx)));\n             else f = FF.greater(att, FF.literal(groups.getMin(currentIdx)));\n         } else {\n"}}, {"oid": "18c5e1084224e3e12d5f3f62854fd39e50a6cc99", "url": "https://github.com/geoserver/geoserver/commit/18c5e1084224e3e12d5f3f62854fd39e50a6cc99", "message": "[GEOS-9522] SldService generate overlapping rules", "committedDate": "2020-03-02T13:38:36Z", "type": "forcePushed"}, {"oid": "5fe5533ba61652ada6cdec714125ff26036b6bd8", "url": "https://github.com/geoserver/geoserver/commit/5fe5533ba61652ada6cdec714125ff26036b6bd8", "message": "[GEOS-9522] SldService generate overlapping rules", "committedDate": "2020-03-02T13:47:55Z", "type": "commit"}, {"oid": "5fe5533ba61652ada6cdec714125ff26036b6bd8", "url": "https://github.com/geoserver/geoserver/commit/5fe5533ba61652ada6cdec714125ff26036b6bd8", "message": "[GEOS-9522] SldService generate overlapping rules", "committedDate": "2020-03-02T13:47:55Z", "type": "forcePushed"}]}