{"pr_number": 4068, "pr_title": "[GEOS-9504] Avoid duplicated classes in SLDService output", "pr_createdAt": "2020-02-18T10:04:44Z", "pr_url": "https://github.com/geoserver/geoserver/pull/4068", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTE5MjQzMg==", "url": "https://github.com/geoserver/geoserver/pull/4068#discussion_r381192432", "bodyText": "Tests are not covering the changes and requirements fully. In particular:\n\nThere should be three tests, covering open rules, closed rules, and explicit rules (the three modified methods in rules builder)\nCheck that the rules are not just less, but the expected ones (check the threshold values), and also check colors associated (requirement, only the first colors in the provided list are meant to be used)", "author": "aaime", "createdAt": "2020-02-19T10:06:50Z", "path": "src/extension/sldService/src/test/java/org/geoserver/sldservice/rest/ClassifierTest.java", "diffHunk": "@@ -1851,4 +1861,39 @@ public void testCustomRampSingleValue() throws Exception {\n         assertEquals(\"#00FF00\", cm0.getColor().evaluate(null, String.class));\n         assertEquals(1, cm0.getOpacity().evaluate(null, Double.class), 0);\n     }\n+\n+    @Test\n+    public void testNoDuplicatedRulesVectors() throws Exception {\n+        final String restPath =\n+                RestBaseController.ROOT_PATH\n+                        + \"/sldservice/cite:ClassificationLines/\"\n+                        + getServiceUrl()\n+                        + \".xml?\"\n+                        + \"attribute=cat2&ramp=CUSTOM&method=quantile&intervals=7&\"\n+                        + \"colors=#FF071C,#CC0616,#82040E,#68030B,#530209,#420207,#350206\";\n+        Document dom = getAsDOM(restPath, 200);\n+        print(dom);\n+        ByteArrayOutputStream baos = new ByteArrayOutputStream();\n+        print(dom, baos);\n+        String resultXml = baos.toString().replace(\"\\r\", \"\").replace(\"\\n\", \"\");\n+        Rule[] rules =\n+                checkSLD(resultXml.replace(\"<Rules>\", sldPrefix).replace(\"</Rules>\", sldPostfix));\n+        assertTrue(rules.length < 7);", "originalCommit": "6026ccf7818deaead52b2be3c3a12040a016ce36", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTI0MjQ4NA==", "url": "https://github.com/geoserver/geoserver/pull/4068#discussion_r381242484", "bodyText": "Thanks for the review @aaime . feedback have been applied. Regarding explicit rules since I realized now that UniqueIntervalFunction was not affected by the duplicated problem I've removed the fix from corresponding method, but I've added anyway a test for that case.", "author": "taba90", "createdAt": "2020-02-19T11:48:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTE5MjQzMg=="}], "type": "inlineReview", "revised_code": {"commit": "508876445801995e5e6d39ef0f97d0dfe1daff1b", "chunk": "diff --git a/src/extension/sldService/src/test/java/org/geoserver/sldservice/rest/ClassifierTest.java b/src/extension/sldService/src/test/java/org/geoserver/sldservice/rest/ClassifierTest.java\nindex b9df3bf8dc..864d9f4ef5 100644\n--- a/src/extension/sldService/src/test/java/org/geoserver/sldservice/rest/ClassifierTest.java\n+++ b/src/extension/sldService/src/test/java/org/geoserver/sldservice/rest/ClassifierTest.java\n\n@@ -1863,7 +1843,42 @@ public class ClassifierTest extends SLDServiceBaseTest {\n     }\n \n     @Test\n-    public void testNoDuplicatedRulesVectors() throws Exception {\n+    public void testRasterNoDuplicatedClasses() throws Exception {\n+        final String restPath =\n+                RestBaseController.ROOT_PATH\n+                        + \"/sldservice/cite:milanogeo/\"\n+                        + getServiceUrl()\n+                        + \".xml?\"\n+                        + \"method=quantile&ramp=custom&intervals=7\"\n+                        + \"&colors=#FF071C,#CC0616,#82040E,#68030B,#530209,#420207,#350206&fullSLD=true\";\n+        Document dom = getAsDOM(restPath, 200);\n+        RasterSymbolizer rs = getRasterSymbolizer(dom);\n+        ColorMap cm = rs.getColorMap();\n+        ColorMapEntry[] entries = cm.getColorMapEntries();\n+        assertEquals(2, entries.length);\n+        // first color map entry got skipped when applying color ramp, taking the second\n+        ColorMapEntry cm1 = cm.getColorMapEntry(1);\n+        assertEquals(\"#FF071C\", cm1.getColor().evaluate(null, String.class));\n+        final String restPathJenks =\n+                RestBaseController.ROOT_PATH\n+                        + \"/sldservice/cite:milanogeo/\"\n+                        + getServiceUrl()\n+                        + \".xml?\"\n+                        + \"method=jenks&ramp=custom&intervals=7&open=true\"\n+                        + \"&colors=#FF071C,#CC0616,#82040E,#68030B,#530209,#420207,#350206&fullSLD=true\";\n+        Document domJenks = getAsDOM(restPathJenks, 200);\n+        RasterSymbolizer rsJenks = getRasterSymbolizer(domJenks);\n+        ColorMap cmJenks = rsJenks.getColorMap();\n+        ColorMapEntry[] entriesJenks = cmJenks.getColorMapEntries();\n+        assertEquals(2, entriesJenks.length);\n+        ColorMapEntry cm0Jenks = cmJenks.getColorMapEntry(0);\n+        assertEquals(\"#FF071C\", cm0Jenks.getColor().evaluate(null, String.class));\n+        ColorMapEntry cm1Jenks = cmJenks.getColorMapEntry(1);\n+        assertEquals(\"#CC0616\", cm1Jenks.getColor().evaluate(null, String.class));\n+    }\n+\n+    @Test\n+    public void testNoDuplicatedClosedRulesVectors() throws Exception {\n         final String restPath =\n                 RestBaseController.ROOT_PATH\n                         + \"/sldservice/cite:ClassificationLines/\"\n"}}, {"oid": "508876445801995e5e6d39ef0f97d0dfe1daff1b", "url": "https://github.com/geoserver/geoserver/commit/508876445801995e5e6d39ef0f97d0dfe1daff1b", "message": "[GEOS-9504] Avoid duplicated classes in SLDService output", "committedDate": "2020-02-19T11:42:21Z", "type": "forcePushed"}, {"oid": "67386cd29a0a02040e05f9993cdd9918a054b1ad", "url": "https://github.com/geoserver/geoserver/commit/67386cd29a0a02040e05f9993cdd9918a054b1ad", "message": "[GEOS-9504] Avoid duplicated classes in SLDService output", "committedDate": "2020-02-19T12:45:25Z", "type": "commit"}, {"oid": "67386cd29a0a02040e05f9993cdd9918a054b1ad", "url": "https://github.com/geoserver/geoserver/commit/67386cd29a0a02040e05f9993cdd9918a054b1ad", "message": "[GEOS-9504] Avoid duplicated classes in SLDService output", "committedDate": "2020-02-19T12:45:25Z", "type": "forcePushed"}]}