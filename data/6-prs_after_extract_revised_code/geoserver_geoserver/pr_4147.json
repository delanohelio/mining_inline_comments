{"pr_number": 4147, "pr_title": "[GEOS-9539]: avoid fixing correct urls in URLKvpParser", "pr_createdAt": "2020-03-27T08:25:25Z", "pr_url": "https://github.com/geoserver/geoserver/pull/4147", "timeline": [{"oid": "b5dfc56da541d19736209e2669b8984dcb718cbd", "url": "https://github.com/geoserver/geoserver/commit/b5dfc56da541d19736209e2669b8984dcb718cbd", "message": "[GEOS-9539]: avoid fixing correct urls in URLKvpParser", "committedDate": "2020-03-16T07:29:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTEyMTY5Ng==", "url": "https://github.com/geoserver/geoserver/pull/4147#discussion_r399121696", "bodyText": "Is there already a test for invalid URL?", "author": "bradh", "createdAt": "2020-03-27T09:05:35Z", "path": "src/ows/src/test/java/org/geoserver/ows/kvp/URLKvpParserTest.java", "diffHunk": "@@ -0,0 +1,37 @@\n+/* (c) 2020 Open Source Geospatial Foundation - all rights reserved\n+ * This code is licensed under the GPL 2.0 license, available at the root\n+ * application directory.\n+ */\n+package org.geoserver.ows.kvp;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertNotEquals;\n+import static org.junit.Assert.fail;\n+\n+import java.net.URL;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+public class URLKvpParserTest {\n+    URLKvpParser parser;\n+\n+    @Before\n+    public void setUp() {\n+        parser = new URLKvpParser(\"url\");\n+    }\n+\n+    @Test\n+    public void testValidUrl() {", "originalCommit": "b5dfc56da541d19736209e2669b8984dcb718cbd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTEzMjE2Nw==", "url": "https://github.com/geoserver/geoserver/pull/4147#discussion_r399132167", "bodyText": "@bradh the code was not tested before, and it's not even clear to me why the fixUrl was introduced, because it was breaking a valid url, that now is instead working properly.\nTo give you some context: this parser is only used at the moment to parse WMS SLD parameter.\nWhen parsing a url with a complex querystring, used to produce a dynamic style with the sldService extension, the fixed url was indeed broken, while with the new code path it works perfectly.\nThe doubt was if we wanted to remove fixURL completely, but not understanding its real purpose we decided to use it as a fallback.\nLong story short: I couldn't find a test case for an invalid url, because I couldn't imagine the purpose of the original code.", "author": "mbarto", "createdAt": "2020-03-27T09:24:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTEyMTY5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ1MzA3Mw==", "url": "https://github.com/geoserver/geoserver/pull/4147#discussion_r399453073", "bodyText": "My guess is that lots of existing tests in GeoServer are not properly url-encoding the urls, so if you skip the \"fixurl\" part they will start failing. But it's just a guess.", "author": "aaime", "createdAt": "2020-03-27T18:11:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTEyMTY5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ1MzcwNQ==", "url": "https://github.com/geoserver/geoserver/pull/4147#discussion_r399453705", "bodyText": "@jdeolive I know it was from many many years ago, but do you remember by any chance why the \"on the fly url fixing\" was introduced in the URLKvpParser, to start with? Seems like it came in with the first implementation of KVP parsers.", "author": "aaime", "createdAt": "2020-03-27T18:13:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTEyMTY5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA3OTcyMA==", "url": "https://github.com/geoserver/geoserver/pull/4147#discussion_r400079720", "bodyText": "Actually tried it out, removing the fixurl part, letting it throw an exception, and the build still works. Tried to put together a URL that would throw a fixable MalformedURLException, but could not... maybe the behavior of Java own URL class changed over time?\nIn any case, I'd keep the code as is for safety, since we don't know exactly what it fixes, and move on.", "author": "aaime", "createdAt": "2020-03-30T10:17:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTEyMTY5Ng=="}], "type": "inlineReview", "revised_code": null}]}