{"pr_number": 919, "pr_title": "PHOENIX-6185 : Propagate info available in SQLExceptionInfo to SQLTimeoutException", "pr_createdAt": "2020-10-13T13:26:42Z", "pr_url": "https://github.com/apache/phoenix/pull/919", "timeline": [{"oid": "7b829898b2f2598a9446d62f59ff62a23a0791a0", "url": "https://github.com/apache/phoenix/commit/7b829898b2f2598a9446d62f59ff62a23a0791a0", "message": "PHOENIX-6185 : Propagate info available in SQLExceptionInfo to OPERATION_TIMED_OUT", "committedDate": "2020-10-13T13:25:45Z", "type": "commit"}, {"oid": "185654888a2e596b1f807bee73ed3aef42110448", "url": "https://github.com/apache/phoenix/commit/185654888a2e596b1f807bee73ed3aef42110448", "message": "fixing checkstyle", "committedDate": "2020-10-15T15:04:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTYyNDY4OQ==", "url": "https://github.com/apache/phoenix/pull/919#discussion_r505624689", "bodyText": "info.getMessage() != null ? info.getMessage() : \"\"\n\nIn else condition, can we use OPERATION_TIMED_OUT.getMessage(). Atleast we will know it was operation timed out.", "author": "shahrs87", "createdAt": "2020-10-15T15:12:28Z", "path": "phoenix-core/src/main/java/org/apache/phoenix/exception/SQLExceptionCode.java", "diffHunk": "@@ -453,8 +453,13 @@ public SQLException newException(SQLExceptionInfo info) {\n     OPERATION_TIMED_OUT(6000, \"TIM01\", \"Operation timed out.\", new Factory() {\n         @Override\n         public SQLException newException(SQLExceptionInfo info) {\n-            return new SQLTimeoutException(OPERATION_TIMED_OUT.getMessage(),\n-                    OPERATION_TIMED_OUT.getSQLState(), OPERATION_TIMED_OUT.getErrorCode());\n+            final String reason =\n+                (info.getMessage() != null ? info.getMessage() : \"\")", "originalCommit": "185654888a2e596b1f807bee73ed3aef42110448", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ce86a9076b88cb778ae91582eceea486cdf088f7", "chunk": "diff --git a/phoenix-core/src/main/java/org/apache/phoenix/exception/SQLExceptionCode.java b/phoenix-core/src/main/java/org/apache/phoenix/exception/SQLExceptionCode.java\nindex 785c5bab5..fc9dbdefe 100644\n--- a/phoenix-core/src/main/java/org/apache/phoenix/exception/SQLExceptionCode.java\n+++ b/phoenix-core/src/main/java/org/apache/phoenix/exception/SQLExceptionCode.java\n\n@@ -453,13 +453,12 @@ public enum SQLExceptionCode {\n     OPERATION_TIMED_OUT(6000, \"TIM01\", \"Operation timed out.\", new Factory() {\n         @Override\n         public SQLException newException(SQLExceptionInfo info) {\n-            final String reason =\n-                (info.getMessage() != null ? info.getMessage() : \"\")\n-                    + (info.getRootCause() != null ? \" , rootCause: \"\n-                    + info.getRootCause() : \"\");\n+            final String reason = info.getMessage() != null\n+                ? info.getMessage() : OPERATION_TIMED_OUT.getMessage();\n             return new SQLTimeoutException(reason,\n                 OPERATION_TIMED_OUT.getSQLState(),\n-                OPERATION_TIMED_OUT.getErrorCode());\n+                OPERATION_TIMED_OUT.getErrorCode(),\n+                info.getRootCause());\n         }\n     }),\n     FUNCTION_UNDEFINED(6001, \"42F01\", \"Function undefined.\", new Factory() {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTYzMjcyMQ==", "url": "https://github.com/apache/phoenix/pull/919#discussion_r505632721", "bodyText": "Sorry missed this in my previous review.\nIf there is root cause exception present, you should use this constructor to create SQLtimeoutException\npublic SQLTimeoutException(String reason,\n                   String SQLState,\n                   int vendorCode,\n                   Throwable cause)", "author": "shahrs87", "createdAt": "2020-10-15T15:23:17Z", "path": "phoenix-core/src/main/java/org/apache/phoenix/exception/SQLExceptionCode.java", "diffHunk": "@@ -453,8 +453,13 @@ public SQLException newException(SQLExceptionInfo info) {\n     OPERATION_TIMED_OUT(6000, \"TIM01\", \"Operation timed out.\", new Factory() {\n         @Override\n         public SQLException newException(SQLExceptionInfo info) {\n-            return new SQLTimeoutException(OPERATION_TIMED_OUT.getMessage(),\n-                    OPERATION_TIMED_OUT.getSQLState(), OPERATION_TIMED_OUT.getErrorCode());\n+            final String reason =\n+                (info.getMessage() != null ? info.getMessage() : \"\")\n+                    + (info.getRootCause() != null ? \" , rootCause: \"\n+                    + info.getRootCause() : \"\");\n+            return new SQLTimeoutException(reason,", "originalCommit": "185654888a2e596b1f807bee73ed3aef42110448", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTY0MjAxOA==", "url": "https://github.com/apache/phoenix/pull/919#discussion_r505642018", "bodyText": "Done", "author": "virajjasani", "createdAt": "2020-10-15T15:35:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTYzMjcyMQ=="}], "type": "inlineReview", "revised_code": {"commit": "ce86a9076b88cb778ae91582eceea486cdf088f7", "chunk": "diff --git a/phoenix-core/src/main/java/org/apache/phoenix/exception/SQLExceptionCode.java b/phoenix-core/src/main/java/org/apache/phoenix/exception/SQLExceptionCode.java\nindex 785c5bab5..fc9dbdefe 100644\n--- a/phoenix-core/src/main/java/org/apache/phoenix/exception/SQLExceptionCode.java\n+++ b/phoenix-core/src/main/java/org/apache/phoenix/exception/SQLExceptionCode.java\n\n@@ -453,13 +453,12 @@ public enum SQLExceptionCode {\n     OPERATION_TIMED_OUT(6000, \"TIM01\", \"Operation timed out.\", new Factory() {\n         @Override\n         public SQLException newException(SQLExceptionInfo info) {\n-            final String reason =\n-                (info.getMessage() != null ? info.getMessage() : \"\")\n-                    + (info.getRootCause() != null ? \" , rootCause: \"\n-                    + info.getRootCause() : \"\");\n+            final String reason = info.getMessage() != null\n+                ? info.getMessage() : OPERATION_TIMED_OUT.getMessage();\n             return new SQLTimeoutException(reason,\n                 OPERATION_TIMED_OUT.getSQLState(),\n-                OPERATION_TIMED_OUT.getErrorCode());\n+                OPERATION_TIMED_OUT.getErrorCode(),\n+                info.getRootCause());\n         }\n     }),\n     FUNCTION_UNDEFINED(6001, \"42F01\", \"Function undefined.\", new Factory() {\n"}}, {"oid": "ce86a9076b88cb778ae91582eceea486cdf088f7", "url": "https://github.com/apache/phoenix/commit/ce86a9076b88cb778ae91582eceea486cdf088f7", "message": "incorporating review", "committedDate": "2020-10-15T15:34:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTcyMjY2Mg==", "url": "https://github.com/apache/phoenix/pull/919#discussion_r505722662", "bodyText": "Should we check that e.getCause() != null ?", "author": "shahrs87", "createdAt": "2020-10-15T17:38:54Z", "path": "phoenix-core/src/it/java/org/apache/phoenix/end2end/OperationTimeoutWithReasonIT.java", "diffHunk": "@@ -0,0 +1,98 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.phoenix.end2end;\n+\n+import org.apache.phoenix.util.EnvironmentEdge;\n+import org.apache.phoenix.util.EnvironmentEdgeManager;\n+import org.junit.Test;\n+\n+import java.sql.Connection;\n+import java.sql.DriverManager;\n+import java.sql.PreparedStatement;\n+import java.sql.ResultSet;\n+import java.sql.SQLException;\n+import java.sql.Statement;\n+\n+import static org.apache.phoenix.exception.SQLExceptionCode.OPERATION_TIMED_OUT;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertTrue;\n+import static org.junit.Assert.fail;\n+\n+public class OperationTimeoutWithReasonIT extends ParallelStatsDisabledIT {\n+\n+    private static final class MyClock extends EnvironmentEdge {\n+        private long time;\n+        private final long delay;\n+\n+        public MyClock (long time, long delay) {\n+            this.time = time;\n+            this.delay = delay;\n+        }\n+\n+        @Override\n+        public long currentTime() {\n+            long currentTime = this.time;\n+            this.time += this.delay;\n+            return currentTime;\n+        }\n+    }\n+\n+    @Test\n+    public void testOperationTimeout() throws SQLException {\n+        final String tableName = generateUniqueName();\n+        final String ddl = \"CREATE TABLE \" + tableName\n+            + \" (COL1 VARCHAR NOT NULL PRIMARY KEY, COL2 VARCHAR)\";\n+        try (Connection conn = DriverManager.getConnection(getUrl());\n+                 Statement stmt = conn.createStatement()) {\n+            stmt.execute(ddl);\n+            final String dml = String.format(\"UPSERT INTO %s VALUES (?, ?)\",\n+                tableName);\n+            try(PreparedStatement prepStmt = conn.prepareStatement(dml)) {\n+                for (int i = 1; i <= 100; i++) {\n+                    prepStmt.setString(1, \"key\" + i);\n+                    prepStmt.setString(2, \"value\" + i);\n+                    prepStmt.executeUpdate();\n+                }\n+            }\n+            conn.commit();\n+        }\n+\n+        try (Connection conn = DriverManager.getConnection(getUrl());\n+             Statement stmt = conn.createStatement()) {\n+            stmt.setQueryTimeout(5); // 5 sec\n+            ResultSet rs = stmt.executeQuery(String.format(\"SELECT * FROM %s\",\n+                tableName));\n+            // Use custom EnvironmentEdge to timeout query with a longer delay in ms\n+            MyClock clock = new MyClock(10, 10000);\n+            EnvironmentEdgeManager.injectEdge(clock);\n+            try {\n+                rs.next();\n+                fail();\n+            } catch (SQLException e) {\n+                assertEquals(OPERATION_TIMED_OUT.getErrorCode(),\n+                    e.getErrorCode());\n+                assertTrue(e.getMessage().contains(\"Query couldn't be \" +\n+                    \"completed in the allotted time: 5000 ms\"));", "originalCommit": "ce86a9076b88cb778ae91582eceea486cdf088f7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTczMDM0MQ==", "url": "https://github.com/apache/phoenix/pull/919#discussion_r505730341", "bodyText": "Actually it is null in this case because for the test, rootCause is not provided here (BaseResultIterators):\n    throw new SQLExceptionInfo.Builder(OPERATION_TIMED_OUT).setMessage(\n            \". Query couldn't be completed in the allotted time: \"\n                    + queryTimeOut + \" ms\").build().buildException();\n\nHowever, I tested by manually adding rootCause and receiving on test side. Hence, it is working fine but since relevant source code does not add root cause, e.getCause() != null would not be true here.", "author": "virajjasani", "createdAt": "2020-10-15T17:51:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTcyMjY2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTczMzQ5Nw==", "url": "https://github.com/apache/phoenix/pull/919#discussion_r505733497", "bodyText": "@virajjasani  Can we just write a unit test creating OPERATION_TIMED_OUT exception with custom message and custom fake exception. Ideally we wouldn't even need integration test but the test that you wrote is very nice.", "author": "shahrs87", "createdAt": "2020-10-15T17:56:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTcyMjY2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTc1NTg0Mg==", "url": "https://github.com/apache/phoenix/pull/919#discussion_r505755842", "bodyText": "Done. Let's keep both unit and IT.\nThanks", "author": "virajjasani", "createdAt": "2020-10-15T18:30:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTcyMjY2Mg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTc1ODAxMA==", "url": "https://github.com/apache/phoenix/pull/919#discussion_r505758010", "bodyText": "Do we use exceptions from this package anywhere else ? Haven't come across this library. Can we add some generic exception ?", "author": "shahrs87", "createdAt": "2020-10-15T18:34:01Z", "path": "phoenix-core/src/test/java/org/apache/phoenix/util/SQLExceptionCodeTest.java", "diffHunk": "@@ -0,0 +1,59 @@\n+/*\n+ *  Licensed to the Apache Software Foundation (ASF) under one or more\n+ *  contributor license agreements.  See the NOTICE file distributed with\n+ *  this work for additional information regarding copyright ownership.\n+ *  The ASF licenses this file to You under the Apache License, Version 2.0\n+ *  (the \"License\"); you may not use this file except in compliance with\n+ *  the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+\n+package org.apache.phoenix.util;\n+\n+import com.sun.javaws.exceptions.InvalidArgumentException;", "originalCommit": "4b54804dee6df883f06b0d714185951e712fa83c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTc1OTA0MA==", "url": "https://github.com/apache/phoenix/pull/919#discussion_r505759040", "bodyText": "Oh, I actually meant IllegalArgumentException, let me change it.", "author": "virajjasani", "createdAt": "2020-10-15T18:35:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTc1ODAxMA=="}], "type": "inlineReview", "revised_code": {"commit": "a37c3381d215ed5bceacea28fef458f10f57a1b8", "chunk": "diff --git a/phoenix-core/src/test/java/org/apache/phoenix/util/SQLExceptionCodeTest.java b/phoenix-core/src/test/java/org/apache/phoenix/util/SQLExceptionCodeTest.java\nindex 89f9f0eec..c4bf87329 100644\n--- a/phoenix-core/src/test/java/org/apache/phoenix/util/SQLExceptionCodeTest.java\n+++ b/phoenix-core/src/test/java/org/apache/phoenix/util/SQLExceptionCodeTest.java\n\n@@ -17,7 +17,6 @@\n \n package org.apache.phoenix.util;\n \n-import com.sun.javaws.exceptions.InvalidArgumentException;\n import org.apache.phoenix.exception.SQLExceptionCode;\n import org.apache.phoenix.exception.SQLExceptionInfo;\n import org.junit.Assert;\n"}}, {"oid": "a37c3381d215ed5bceacea28fef458f10f57a1b8", "url": "https://github.com/apache/phoenix/commit/a37c3381d215ed5bceacea28fef458f10f57a1b8", "message": "adding unit test", "committedDate": "2020-10-15T18:37:38Z", "type": "forcePushed"}, {"oid": "2e7e2265753831718c429b5b213e989393be93e2", "url": "https://github.com/apache/phoenix/commit/2e7e2265753831718c429b5b213e989393be93e2", "message": "adding unit test", "committedDate": "2020-10-15T18:39:41Z", "type": "commit"}, {"oid": "2e7e2265753831718c429b5b213e989393be93e2", "url": "https://github.com/apache/phoenix/commit/2e7e2265753831718c429b5b213e989393be93e2", "message": "adding unit test", "committedDate": "2020-10-15T18:39:41Z", "type": "forcePushed"}, {"oid": "650912ba1bdcc890201c2e9f72ae5d6e16e6e3d5", "url": "https://github.com/apache/phoenix/commit/650912ba1bdcc890201c2e9f72ae5d6e16e6e3d5", "message": "Merge branch 'master' of github.com:apache/phoenix into PHOENIX-6185-master", "committedDate": "2020-10-16T13:22:30Z", "type": "commit"}]}