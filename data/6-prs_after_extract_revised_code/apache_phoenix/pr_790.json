{"pr_number": 790, "pr_title": "PHOENIX-5922 - IndexUpgradeTool should always re-enable tables on fai\u2026", "pr_createdAt": "2020-05-27T23:20:34Z", "pr_url": "https://github.com/apache/phoenix/pull/790", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUwMzIxNA==", "url": "https://github.com/apache/phoenix/pull/790#discussion_r431503214", "bodyText": "Nit: comment", "author": "abhishek-chouhan", "createdAt": "2020-05-27T23:41:09Z", "path": "phoenix-core/src/main/java/org/apache/phoenix/mapreduce/index/IndexUpgradeTool.java", "diffHunk": "@@ -463,14 +489,20 @@ private void handleFailure(ConnectionQueryServices queryServices,\n             upgrade = !upgrade;\n \n             tablesAndIndexes.remove(dataTableFullName); //removing from the map\n-            tableList.remove(dataTableFullName); //removing from the list\n+            failedTables.add(dataTableFullName); //removing from the list", "originalCommit": "353b2640d6e4ba80c77bf76b15eb22931620310e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUzMTIyNQ==", "url": "https://github.com/apache/phoenix/pull/790#discussion_r431531225", "bodyText": "Fixed", "author": "gjacoby126", "createdAt": "2020-05-28T01:23:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUwMzIxNA=="}], "type": "inlineReview", "revised_code": {"commit": "110ef81f0a63ba7b33eb0a868f97d29d57afa5c3", "chunk": "diff --git a/phoenix-core/src/main/java/org/apache/phoenix/mapreduce/index/IndexUpgradeTool.java b/phoenix-core/src/main/java/org/apache/phoenix/mapreduce/index/IndexUpgradeTool.java\nindex ad3324874..74ccd9106 100644\n--- a/phoenix-core/src/main/java/org/apache/phoenix/mapreduce/index/IndexUpgradeTool.java\n+++ b/phoenix-core/src/main/java/org/apache/phoenix/mapreduce/index/IndexUpgradeTool.java\n\n@@ -489,11 +489,12 @@ public class IndexUpgradeTool extends Configured implements Tool {\n             upgrade = !upgrade;\n \n             tablesAndIndexes.remove(dataTableFullName); //removing from the map\n-            failedTables.add(dataTableFullName); //removing from the list\n+            failedTables.add(dataTableFullName); //everything in failed tables will later be\n+            // removed from the list\n \n             LOGGER.severe(dataTableFullName+\" has been removed from the list as tool failed\"\n                     + \" to perform \"+operation);\n-        } catch (IOException | SQLException | RuntimeException e) {\n+        } catch (Throwable e) {\n             LOGGER.severe(\"Revert of the \"+operation +\" failed in error handling, \"\n                     + \"re-enabling tables and then throwing runtime exception\");\n             LOGGER.severe(\"Confirm the state for \"+getSubListString(tableList, dataTableFullName));\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUwMzk3Mw==", "url": "https://github.com/apache/phoenix/pull/790#discussion_r431503973", "bodyText": "Should we just catch throwable here(and in the mutable case), so that we cover errors too? in all cases i guess we want the tables to be enabled back.", "author": "abhishek-chouhan", "createdAt": "2020-05-27T23:43:28Z", "path": "phoenix-core/src/main/java/org/apache/phoenix/mapreduce/index/IndexUpgradeTool.java", "diffHunk": "@@ -398,28 +414,34 @@ private int executeTool(Connection conn,\n         executeToolForMutableTables(conn, queryServices, conf, mutableList);\n         enableImmutableTables(queryServices, immutableList, startWaitTime);\n         rebuildIndexes(conn, conf, immutableList);\n-        return 0;\n+        if (hasFailure) {\n+            return -1;\n+        } else {\n+            return 0;\n+        }\n     }\n \n     private long executeToolForImmutableTables(ConnectionQueryServices queryServices,\n-            ArrayList<String> immutableList) {\n+            List<String> immutableList) {\n         if (immutableList.isEmpty()) {\n             return 0;\n         }\n         LOGGER.info(\"Started \" + operation + \" for immutable tables\");\n+        List<String> failedTables = new ArrayList<String>();\n         for (String dataTableFullName : immutableList) {\n             try (Admin admin = queryServices.getAdmin()) {\n                 HashSet<String> indexes = tablesAndIndexes.get(dataTableFullName);\n                 LOGGER.info(\"Executing \" + operation + \" of \" + dataTableFullName\n                         + \" (immutable)\");\n                 disableTable(admin, dataTableFullName, indexes);\n                 modifyTable(admin, dataTableFullName, indexes);\n-            } catch (IOException | SQLException e) {\n+            } catch (IOException | SQLException | RuntimeException e) {", "originalCommit": "353b2640d6e4ba80c77bf76b15eb22931620310e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUzMTE4Nw==", "url": "https://github.com/apache/phoenix/pull/790#discussion_r431531187", "bodyText": "Done", "author": "gjacoby126", "createdAt": "2020-05-28T01:23:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUwMzk3Mw=="}], "type": "inlineReview", "revised_code": null}, {"oid": "110ef81f0a63ba7b33eb0a868f97d29d57afa5c3", "url": "https://github.com/apache/phoenix/commit/110ef81f0a63ba7b33eb0a868f97d29d57afa5c3", "message": "PHOENIX-5922 - IndexUpgradeTool should always re-enable tables on failure", "committedDate": "2020-05-28T17:33:08Z", "type": "commit"}, {"oid": "110ef81f0a63ba7b33eb0a868f97d29d57afa5c3", "url": "https://github.com/apache/phoenix/commit/110ef81f0a63ba7b33eb0a868f97d29d57afa5c3", "message": "PHOENIX-5922 - IndexUpgradeTool should always re-enable tables on failure", "committedDate": "2020-05-28T17:33:08Z", "type": "forcePushed"}]}