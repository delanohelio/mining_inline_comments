{"pr_number": 773, "pr_title": "PHOENIX-5874: IndexTool does not set TTL on its log tables correctly", "pr_createdAt": "2020-04-30T21:31:26Z", "pr_url": "https://github.com/apache/phoenix/pull/773", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODMxMzYyNQ==", "url": "https://github.com/apache/phoenix/pull/773#discussion_r418313625", "bodyText": "Can be replaced with TestUtil.getRowCount", "author": "gjacoby126", "createdAt": "2020-04-30T22:00:32Z", "path": "phoenix-core/src/it/java/org/apache/phoenix/end2end/index/IndexVerificationResultRepositoryIT.java", "diffHunk": "@@ -50,24 +67,62 @@ public void testReadResultRow() throws Exception {\n         byte[] indexNameBytes = Bytes.toBytes(indexName);\n         try (Connection conn = DriverManager.getConnection(getUrl())) {\n             createTableAndIndex(conn, tableName, indexName);\n-            IndexVerificationResultRepository resultRepository =\n-                new IndexVerificationResultRepository(conn, indexNameBytes);\n-            resultRepository.createResultTable(conn);\n-            byte[] regionOne = Bytes.toBytes(\"a.1.00000000000000000000\");\n-            byte[] regionTwo = Bytes.toBytes(\"a.2.00000000000000000000\");\n             long scanMaxTs = EnvironmentEdgeManager.currentTimeMillis();\n             IndexToolVerificationResult expectedResult = getExpectedResult(scanMaxTs);\n-            resultRepository.logToIndexToolResultTable(expectedResult, IndexTool.IndexVerifyType.BOTH,\n-                regionOne);\n-            resultRepository.logToIndexToolResultTable(expectedResult, IndexTool.IndexVerifyType.BOTH,\n-                regionTwo);\n+            IndexVerificationResultRepository resultRepository = setupResultRepository(conn, indexNameBytes, expectedResult);\n             IndexToolVerificationResult actualResult =\n                 resultRepository.getVerificationResult(conn, scanMaxTs);\n             assertVerificationResult(expectedResult, actualResult);\n+        }\n+    }\n \n+    @Test\n+    public void testTTLOnResultTable() throws SQLException, IOException {\n+        String mockString = \"mock_value\";\n+        byte[] mockStringBytes = Strings.toByteArray(mockString);\n+        ManualEnvironmentEdge customClock = new ManualEnvironmentEdge();\n+        customClock.setValue(1);\n+        EnvironmentEdgeManager.injectEdge(customClock);\n+        try (Connection conn = DriverManager.getConnection(getUrl())) {\n+            long scanMaxTs = EnvironmentEdgeManager.currentTimeMillis();\n+            IndexToolVerificationResult expectedResult = getExpectedResult(scanMaxTs);\n+            setupResultRepository(conn, mockStringBytes,expectedResult);\n+            customClock.incrementValue(1000*(DEFAULT_LOG_TTL+5));\n+            EnvironmentEdgeManager.injectEdge(customClock);\n+            HTable hTable = new HTable(config, RESULT_TABLE_NAME_BYTES);\n+            int count = countRows(hTable);\n+\n+            Assert.assertEquals(0, count);\n         }\n     }\n \n+    public static int countRows(HTable hTable) throws IOException {", "originalCommit": "45f6bbb14f4f01a12df4a3c724d5b8e29a1c9619", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a632f187a25fa82be5cfd5c504cb62fc0d736a81", "chunk": "diff --git a/phoenix-core/src/it/java/org/apache/phoenix/end2end/index/IndexVerificationResultRepositoryIT.java b/phoenix-core/src/it/java/org/apache/phoenix/end2end/index/IndexVerificationResultRepositoryIT.java\nindex b843d62d7..84df8b965 100644\n--- a/phoenix-core/src/it/java/org/apache/phoenix/end2end/index/IndexVerificationResultRepositoryIT.java\n+++ b/phoenix-core/src/it/java/org/apache/phoenix/end2end/index/IndexVerificationResultRepositoryIT.java\n\n@@ -84,36 +82,27 @@ public class IndexVerificationResultRepositoryIT extends ParallelStatsDisabledIT\n         customClock.setValue(1);\n         EnvironmentEdgeManager.injectEdge(customClock);\n         try (Connection conn = DriverManager.getConnection(getUrl())) {\n+            HTable hTable = new HTable(config, RESULT_TABLE_NAME_BYTES);\n             long scanMaxTs = EnvironmentEdgeManager.currentTimeMillis();\n             IndexToolVerificationResult expectedResult = getExpectedResult(scanMaxTs);\n             setupResultRepository(conn, mockStringBytes,expectedResult);\n+\n+            Assert.assertEquals(2, TestUtil.getRowCount(hTable, false));\n+\n             customClock.incrementValue(1000*(DEFAULT_LOG_TTL+5));\n             EnvironmentEdgeManager.injectEdge(customClock);\n-            HTable hTable = new HTable(config, RESULT_TABLE_NAME_BYTES);\n-            int count = countRows(hTable);\n+            int count = TestUtil.getRowCount(hTable, false);\n \n             Assert.assertEquals(0, count);\n         }\n     }\n \n-    public static int countRows(HTable hTable) throws IOException {\n-        ResultScanner scanner = hTable.getScanner(new Scan());\n-        int count = 0;\n-        try {\n-            for (Result rr = scanner.next(); rr != null; rr = scanner.next()) {\n-                count++;\n-            }\n-        } finally {\n-            scanner.close();\n-        }\n-        return count;\n-    }\n-\n     private IndexVerificationResultRepository setupResultRepository(Connection conn, byte[] indexNameBytes,IndexToolVerificationResult expectedResult)\n             throws SQLException, IOException {\n         IndexVerificationResultRepository resultRepository =\n                 new IndexVerificationResultRepository(conn, indexNameBytes);\n         resultRepository.createResultTable(conn);\n+        TestUtil.assertTableHasTtl(conn, TableName.valueOf(RESULT_TABLE_NAME_BYTES), DEFAULT_LOG_TTL);\n         byte[] regionOne = Bytes.toBytes(\"a.1.00000000000000000000\");\n         byte[] regionTwo = Bytes.toBytes(\"a.2.00000000000000000000\");\n         resultRepository.logToIndexToolResultTable(expectedResult, IndexTool.IndexVerifyType.BOTH,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODMxMzc5Nw==", "url": "https://github.com/apache/phoenix/pull/773#discussion_r418313797", "bodyText": "Can use TestUtil.getRowCount", "author": "gjacoby126", "createdAt": "2020-04-30T22:00:54Z", "path": "phoenix-core/src/it/java/org/apache/phoenix/end2end/index/IndexVerificationOutputRepositoryIT.java", "diffHunk": "@@ -39,6 +48,9 @@\n import java.util.List;\n import java.util.Map;\n \n+import static org.apache.phoenix.coprocessor.MetaDataProtocol.DEFAULT_LOG_TTL;\n+import static org.apache.phoenix.end2end.index.IndexVerificationResultRepositoryIT.countRows;", "originalCommit": "45f6bbb14f4f01a12df4a3c724d5b8e29a1c9619", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a632f187a25fa82be5cfd5c504cb62fc0d736a81", "chunk": "diff --git a/phoenix-core/src/it/java/org/apache/phoenix/end2end/index/IndexVerificationOutputRepositoryIT.java b/phoenix-core/src/it/java/org/apache/phoenix/end2end/index/IndexVerificationOutputRepositoryIT.java\nindex f51c30917..1464e80b5 100644\n--- a/phoenix-core/src/it/java/org/apache/phoenix/end2end/index/IndexVerificationOutputRepositoryIT.java\n+++ b/phoenix-core/src/it/java/org/apache/phoenix/end2end/index/IndexVerificationOutputRepositoryIT.java\n\n@@ -49,7 +50,6 @@ import java.util.List;\n import java.util.Map;\n \n import static org.apache.phoenix.coprocessor.MetaDataProtocol.DEFAULT_LOG_TTL;\n-import static org.apache.phoenix.end2end.index.IndexVerificationResultRepositoryIT.countRows;\n import static org.apache.phoenix.mapreduce.index.IndexVerificationOutputRepository.OUTPUT_TABLE_NAME_BYTES;\n import static org.apache.phoenix.mapreduce.index.IndexVerificationOutputRepository.PHASE_AFTER_VALUE;\n import static org.apache.phoenix.mapreduce.index.IndexVerificationOutputRepository.PHASE_BEFORE_VALUE;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODMzMTY3OQ==", "url": "https://github.com/apache/phoenix/pull/773#discussion_r418331679", "bodyText": "Can you assert here that rowCount is greater than 0", "author": "gokceni", "createdAt": "2020-04-30T22:47:38Z", "path": "phoenix-core/src/it/java/org/apache/phoenix/end2end/index/IndexVerificationOutputRepositoryIT.java", "diffHunk": "@@ -94,6 +106,33 @@ public void testReadIndexVerificationOutputRow() throws Exception {\n \n     }\n \n+    @Test\n+    public void testTTLOnOutputTable() throws SQLException, IOException {\n+        String mockString = \"mock_value\";\n+        byte[] mockStringBytes = Strings.toByteArray(mockString);\n+        ManualEnvironmentEdge customClock = new ManualEnvironmentEdge();\n+        customClock.setValue(1);\n+        EnvironmentEdgeManager.injectEdge(customClock);\n+        try (Connection conn = DriverManager.getConnection(getUrl())) {\n+            IndexVerificationOutputRepository\n+                    outputRepository =\n+                    new IndexVerificationOutputRepository(mockStringBytes, conn);\n+\n+            outputRepository.createOutputTable(conn);\n+            TestUtil.assertTableHasTtl(conn, TableName.valueOf(OUTPUT_TABLE_NAME_BYTES), DEFAULT_LOG_TTL);\n+            outputRepository.logToIndexToolOutputTable(mockStringBytes, mockStringBytes,\n+                    1, 2, mockString, mockStringBytes, mockStringBytes,\n+                    EnvironmentEdgeManager.currentTimeMillis(), mockStringBytes, true);\n+", "originalCommit": "f42a7e5415ee2199c1379717bb09a6cd2bcabda2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODYzMzgzMA==", "url": "https://github.com/apache/phoenix/pull/773#discussion_r418633830", "bodyText": "Done", "author": "swaroopak", "createdAt": "2020-05-01T17:01:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODMzMTY3OQ=="}], "type": "inlineReview", "revised_code": {"commit": "a632f187a25fa82be5cfd5c504cb62fc0d736a81", "chunk": "diff --git a/phoenix-core/src/it/java/org/apache/phoenix/end2end/index/IndexVerificationOutputRepositoryIT.java b/phoenix-core/src/it/java/org/apache/phoenix/end2end/index/IndexVerificationOutputRepositoryIT.java\nindex cd30520af..1464e80b5 100644\n--- a/phoenix-core/src/it/java/org/apache/phoenix/end2end/index/IndexVerificationOutputRepositoryIT.java\n+++ b/phoenix-core/src/it/java/org/apache/phoenix/end2end/index/IndexVerificationOutputRepositoryIT.java\n\n@@ -114,6 +114,8 @@ public class IndexVerificationOutputRepositoryIT extends ParallelStatsDisabledIT\n         customClock.setValue(1);\n         EnvironmentEdgeManager.injectEdge(customClock);\n         try (Connection conn = DriverManager.getConnection(getUrl())) {\n+            HTable hTable = new HTable(config, OUTPUT_TABLE_NAME_BYTES);\n+\n             IndexVerificationOutputRepository\n                     outputRepository =\n                     new IndexVerificationOutputRepository(mockStringBytes, conn);\n"}}, {"oid": "a632f187a25fa82be5cfd5c504cb62fc0d736a81", "url": "https://github.com/apache/phoenix/commit/a632f187a25fa82be5cfd5c504cb62fc0d736a81", "message": "PHOENIX-5874: IndexTool does not set TTL on its log tables correctly", "committedDate": "2020-05-01T16:51:20Z", "type": "commit"}, {"oid": "a632f187a25fa82be5cfd5c504cb62fc0d736a81", "url": "https://github.com/apache/phoenix/commit/a632f187a25fa82be5cfd5c504cb62fc0d736a81", "message": "PHOENIX-5874: IndexTool does not set TTL on its log tables correctly", "committedDate": "2020-05-01T16:51:20Z", "type": "forcePushed"}]}