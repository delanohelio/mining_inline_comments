{"pr_number": 860, "pr_title": "PHOENIX-6080: Add a check to Index Rebuild jobs to check region closi\u2026", "pr_createdAt": "2020-08-17T21:11:26Z", "pr_url": "https://github.com/apache/phoenix/pull/860", "timeline": [{"oid": "c80c1cfe3b87f1f5d582c241be08705ec08cd62c", "url": "https://github.com/apache/phoenix/commit/c80c1cfe3b87f1f5d582c241be08705ec08cd62c", "message": "PHOENIX-6080: Add a check to Index Rebuild jobs to check region closing before every inner batch", "committedDate": "2020-08-17T22:34:29Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTgyOTYxMA==", "url": "https://github.com/apache/phoenix/pull/860#discussion_r471829610", "bodyText": "@swaroopak - do we need the region.closeRegionOperation() and localScanner.close() calls? They appear to already be called in the finally block, which will execute even if we return false early. And a finally block seems like a safer place for them so some other code path doesn't miss them in the future.", "author": "gjacoby126", "createdAt": "2020-08-17T23:30:50Z", "path": "phoenix-core/src/main/java/org/apache/phoenix/coprocessor/IndexRebuildRegionScanner.java", "diffHunk": "@@ -1301,11 +1301,24 @@ public boolean next(List<Cell> results) throws IOException {\n         try {\n             localScanner = getLocalScanner();\n             if (localScanner == null) {\n+                region.closeRegionOperation();\n                 return false;\n             }\n             synchronized (localScanner) {\n                 if (!shouldVerify()) {\n                     skipped = true;\n+                    region.closeRegionOperation();", "originalCommit": "c80c1cfe3b87f1f5d582c241be08705ec08cd62c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTgzODM4MA==", "url": "https://github.com/apache/phoenix/pull/860#discussion_r471838380", "bodyText": "As I stated before, the fix is to check the isRegionClosingOrSplitting attribute of the UngroupedAggregateRegionObserver coproc and return an IOException after every scanner next or table batch operation done during index rebuild or verification if  the region is closing or splitting.", "author": "kadirozde", "createdAt": "2020-08-18T00:01:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTgyOTYxMA=="}], "type": "inlineReview", "revised_code": {"commit": "e0c80024f03c5078d8a3583cdc6b416204a61cf2", "chunk": "diff --git a/phoenix-core/src/main/java/org/apache/phoenix/coprocessor/IndexRebuildRegionScanner.java b/phoenix-core/src/main/java/org/apache/phoenix/coprocessor/IndexRebuildRegionScanner.java\nindex 05c5d45b3..fb13afc7e 100644\n--- a/phoenix-core/src/main/java/org/apache/phoenix/coprocessor/IndexRebuildRegionScanner.java\n+++ b/phoenix-core/src/main/java/org/apache/phoenix/coprocessor/IndexRebuildRegionScanner.java\n\n@@ -1301,14 +1304,11 @@ public class IndexRebuildRegionScanner extends GlobalIndexRegionScanner {\n         try {\n             localScanner = getLocalScanner();\n             if (localScanner == null) {\n-                region.closeRegionOperation();\n                 return false;\n             }\n             synchronized (localScanner) {\n                 if (!shouldVerify()) {\n                     skipped = true;\n-                    region.closeRegionOperation();\n-                    localScanner.close();\n                     return false;\n                 }\n                 /*\n"}}, {"oid": "e0c80024f03c5078d8a3583cdc6b416204a61cf2", "url": "https://github.com/apache/phoenix/commit/e0c80024f03c5078d8a3583cdc6b416204a61cf2", "message": "PHOENIX-6080: Add a check to Index Rebuild jobs to check region closing before every inner batch", "committedDate": "2020-08-18T01:35:42Z", "type": "forcePushed"}, {"oid": "221791033e0c0cb2786b41876c08f0793bd35990", "url": "https://github.com/apache/phoenix/commit/221791033e0c0cb2786b41876c08f0793bd35990", "message": "PHOENIX-6080: Add a check to Index Rebuild jobs to check region closing before every inner batch", "committedDate": "2020-08-18T02:06:50Z", "type": "forcePushed"}, {"oid": "7c155a28589c65000587f39a359b08f286bb7ced", "url": "https://github.com/apache/phoenix/commit/7c155a28589c65000587f39a359b08f286bb7ced", "message": "PHOENIX-6080: Add a check to Index Rebuild jobs to check region closing before every inner batch", "committedDate": "2020-08-18T16:30:09Z", "type": "forcePushed"}, {"oid": "72ca20d51a4377834fbe9108d651224961da0788", "url": "https://github.com/apache/phoenix/commit/72ca20d51a4377834fbe9108d651224961da0788", "message": "PHOENIX-6080: Add a check to Index Rebuild jobs to check region closing before every inner batch", "committedDate": "2020-08-18T17:52:05Z", "type": "forcePushed"}, {"oid": "eb07ca62a0ff6529837b654c6dcc137532d3ed8a", "url": "https://github.com/apache/phoenix/commit/eb07ca62a0ff6529837b654c6dcc137532d3ed8a", "message": "PHOENIX-6080: Add a check to Index Rebuild jobs to check region closing before every inner batch", "committedDate": "2020-08-18T22:25:58Z", "type": "forcePushed"}, {"oid": "d7477ed617fa033fff26ff2b0571521ef53bb41e", "url": "https://github.com/apache/phoenix/commit/d7477ed617fa033fff26ff2b0571521ef53bb41e", "message": "PHOENIX-6080: Add a check to Index Rebuild jobs to check region closing before every inner batch", "committedDate": "2020-08-19T00:13:38Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDIzODc3NA==", "url": "https://github.com/apache/phoenix/pull/860#discussion_r474238774", "bodyText": "You missed the for loop before this (line 903)", "author": "kadirozde", "createdAt": "2020-08-20T19:58:05Z", "path": "phoenix-core/src/main/java/org/apache/phoenix/coprocessor/IndexRebuildRegionScanner.java", "diffHunk": "@@ -899,6 +906,7 @@ private void rebuildIndexRows(Map<byte[], List<Mutation>> indexKeyToMutationMap,\n                 }\n             }\n             if (batchSize > 0) {\n+                ungroupedAggregateRegionObserver.checkForRegionClosing();", "originalCommit": "d7477ed617fa033fff26ff2b0571521ef53bb41e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDIzOTU5OA==", "url": "https://github.com/apache/phoenix/pull/860#discussion_r474239598", "bodyText": "good catch! Thanks!", "author": "swaroopak", "createdAt": "2020-08-20T19:59:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDIzODc3NA=="}], "type": "inlineReview", "revised_code": {"commit": "5246ae833931b4972624b5d74eb3090690832901", "chunk": "diff --git a/phoenix-core/src/main/java/org/apache/phoenix/coprocessor/IndexRebuildRegionScanner.java b/phoenix-core/src/main/java/org/apache/phoenix/coprocessor/IndexRebuildRegionScanner.java\nindex 14b0267e7..06a79e70b 100644\n--- a/phoenix-core/src/main/java/org/apache/phoenix/coprocessor/IndexRebuildRegionScanner.java\n+++ b/phoenix-core/src/main/java/org/apache/phoenix/coprocessor/IndexRebuildRegionScanner.java\n\n@@ -900,6 +900,7 @@ public class IndexRebuildRegionScanner extends GlobalIndexRegionScanner {\n                 indexUpdates.add(mutation);\n                 batchSize ++;\n                 if (batchSize >= maxBatchSize) {\n+                    ungroupedAggregateRegionObserver.checkForRegionClosing();\n                     indexHTable.batch(indexUpdates);\n                     batchSize = 0;\n                     indexUpdates = new ArrayList<Mutation>(maxBatchSize);\n"}}, {"oid": "5246ae833931b4972624b5d74eb3090690832901", "url": "https://github.com/apache/phoenix/commit/5246ae833931b4972624b5d74eb3090690832901", "message": "PHOENIX-6080: Add a check to Index Rebuild jobs to check region closing before every inner batch", "committedDate": "2020-08-20T21:41:59Z", "type": "commit"}, {"oid": "5246ae833931b4972624b5d74eb3090690832901", "url": "https://github.com/apache/phoenix/commit/5246ae833931b4972624b5d74eb3090690832901", "message": "PHOENIX-6080: Add a check to Index Rebuild jobs to check region closing before every inner batch", "committedDate": "2020-08-20T21:41:59Z", "type": "forcePushed"}]}