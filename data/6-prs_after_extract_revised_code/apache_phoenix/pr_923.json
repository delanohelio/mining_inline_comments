{"pr_number": 923, "pr_title": "PHOENIX-6125 : Disable region split for SYSTEM.TASK", "pr_createdAt": "2020-10-15T13:12:22Z", "pr_url": "https://github.com/apache/phoenix/pull/923", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg3MjE4OQ==", "url": "https://github.com/apache/phoenix/pull/923#discussion_r505872189", "bodyText": "Do we really need a separate IT for this? There is an existing IT that uses the upgrade counting driver and services. Let's reuse that instead", "author": "ChinmaySKulkarni", "createdAt": "2020-10-15T21:32:34Z", "path": "phoenix-core/src/it/java/org/apache/phoenix/end2end/DisableSplitForTaskTableIT.java", "diffHunk": "@@ -0,0 +1,134 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.phoenix.end2end;\n+\n+import org.apache.hadoop.hbase.TableName;\n+import org.apache.hadoop.hbase.client.Admin;\n+import org.apache.hadoop.hbase.regionserver.DisabledRegionSplitPolicy;\n+import org.apache.phoenix.coprocessor.MetaDataProtocol;\n+import org.apache.phoenix.jdbc.PhoenixConnection;\n+import org.apache.phoenix.jdbc.PhoenixDatabaseMetaData;\n+import org.apache.phoenix.jdbc.PhoenixEmbeddedDriver;\n+import org.apache.phoenix.jdbc.PhoenixTestDriver;\n+import org.apache.phoenix.query.BaseTest;\n+import org.apache.phoenix.query.ConnectionQueryServices;\n+import org.apache.phoenix.query.ConnectionQueryServicesImpl;\n+import org.apache.phoenix.query.QueryServices;\n+import org.apache.phoenix.query.QueryServicesTestImpl;\n+import org.apache.phoenix.thirdparty.com.google.common.collect.Maps;\n+import org.apache.phoenix.util.ReadOnlyProps;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+\n+import java.sql.DriverManager;\n+import java.sql.SQLException;\n+import java.util.Map;\n+import java.util.Properties;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertTrue;\n+\n+public class DisableSplitForTaskTableIT extends BaseTest {\n+\n+    private static boolean reinitialize;\n+    private static long systemTableVersion = MetaDataProtocol.getPriorVersion();\n+\n+    private static class PhoenixUpgradeCountingServices\n+            extends ConnectionQueryServicesImpl {\n+\n+        public PhoenixUpgradeCountingServices(\n+                QueryServices services,\n+                PhoenixEmbeddedDriver.ConnectionInfo connectionInfo,\n+                Properties info) {\n+            super(services, connectionInfo, info);\n+        }\n+\n+        @Override\n+        protected void setUpgradeRequired() {\n+            super.setUpgradeRequired();\n+        }\n+\n+        @Override\n+        protected long getSystemTableVersion() {\n+            return systemTableVersion;\n+        }\n+\n+        @Override\n+        protected boolean isInitialized() {\n+            return !reinitialize && super.isInitialized();\n+        }\n+    }\n+\n+    public static class PhoenixUpgradeCountingDriver\n+            extends PhoenixTestDriver {\n+        private ConnectionQueryServices connectionQueryServices;\n+        private final ReadOnlyProps overrideProps;\n+\n+        public PhoenixUpgradeCountingDriver(ReadOnlyProps props) {\n+            overrideProps = props;\n+        }\n+\n+        @Override\n+        public boolean acceptsURL(String url) {\n+            return true;\n+        }\n+\n+        @Override\n+        public synchronized ConnectionQueryServices getConnectionQueryServices(\n+                String url, Properties info) throws SQLException {\n+            if (connectionQueryServices == null) {\n+                connectionQueryServices =\n+                    new PhoenixUpgradeCountingServices(\n+                        new QueryServicesTestImpl(getDefaultProps(),\n+                            overrideProps), ConnectionInfo.create(url), info);\n+                connectionQueryServices.init(url, info);\n+            } else if (reinitialize) {\n+                connectionQueryServices.init(url, info);\n+                reinitialize = false;\n+            }\n+            return connectionQueryServices;\n+        }\n+    }\n+\n+    @BeforeClass\n+    public static synchronized void doSetup() throws Exception {\n+        Map<String, String> props = Maps.newConcurrentMap();\n+        props.put(BaseTest.DRIVER_CLASS_NAME_ATTRIB,\n+            PhoenixUpgradeCountingDriver.class.getName());\n+        setUpTestDriver(new ReadOnlyProps(props.entrySet().iterator()));\n+    }\n+\n+    @Test\n+    public void testUpgradeOnlyHappensOnce() throws Exception {\n+        ConnectionQueryServices services = DriverManager.getConnection(getUrl())\n+            .unwrap(PhoenixConnection.class).getQueryServices();\n+        assertTrue(services instanceof PhoenixUpgradeCountingServices);\n+        reinitialize = true;\n+        systemTableVersion = MetaDataProtocol.MIN_SYSTEM_TABLE_TIMESTAMP;\n+        DriverManager.getConnection(getUrl());\n+        try (Admin admin = services.getAdmin()) {\n+            String taskSplitPolicy = admin\n+                .getDescriptor(TableName.valueOf(\n+                    PhoenixDatabaseMetaData.SYSTEM_TASK_NAME))\n+                .getRegionSplitPolicyClassName();\n+            assertEquals(DisabledRegionSplitPolicy.class.getName(),\n+                taskSplitPolicy);\n+        }", "originalCommit": "09a5b2b6f20d7d6d430d2b9859c7bf55df5fa0c7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1486aa4b2bf990d1d4dfb7ecceb550eee2727999", "chunk": "diff --git a/phoenix-core/src/it/java/org/apache/phoenix/end2end/DisableSplitForTaskTableIT.java b/phoenix-core/src/it/java/org/apache/phoenix/end2end/DisableSplitForTaskTableIT.java\ndeleted file mode 100644\nindex ce32764b5..000000000\n--- a/phoenix-core/src/it/java/org/apache/phoenix/end2end/DisableSplitForTaskTableIT.java\n+++ /dev/null\n\n@@ -1,134 +0,0 @@\n-/*\n- * Licensed to the Apache Software Foundation (ASF) under one\n- * or more contributor license agreements.  See the NOTICE file\n- * distributed with this work for additional information\n- * regarding copyright ownership.  The ASF licenses this file\n- * to you under the Apache License, Version 2.0 (the\n- * \"License\"); you may not use this file except in compliance\n- * with the License.  You may obtain a copy of the License at\n- *\n- * http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing, software\n- * distributed under the License is distributed on an \"AS IS\" BASIS,\n- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n- * See the License for the specific language governing permissions and\n- * limitations under the License.\n- */\n-\n-package org.apache.phoenix.end2end;\n-\n-import org.apache.hadoop.hbase.TableName;\n-import org.apache.hadoop.hbase.client.Admin;\n-import org.apache.hadoop.hbase.regionserver.DisabledRegionSplitPolicy;\n-import org.apache.phoenix.coprocessor.MetaDataProtocol;\n-import org.apache.phoenix.jdbc.PhoenixConnection;\n-import org.apache.phoenix.jdbc.PhoenixDatabaseMetaData;\n-import org.apache.phoenix.jdbc.PhoenixEmbeddedDriver;\n-import org.apache.phoenix.jdbc.PhoenixTestDriver;\n-import org.apache.phoenix.query.BaseTest;\n-import org.apache.phoenix.query.ConnectionQueryServices;\n-import org.apache.phoenix.query.ConnectionQueryServicesImpl;\n-import org.apache.phoenix.query.QueryServices;\n-import org.apache.phoenix.query.QueryServicesTestImpl;\n-import org.apache.phoenix.thirdparty.com.google.common.collect.Maps;\n-import org.apache.phoenix.util.ReadOnlyProps;\n-import org.junit.BeforeClass;\n-import org.junit.Test;\n-\n-import java.sql.DriverManager;\n-import java.sql.SQLException;\n-import java.util.Map;\n-import java.util.Properties;\n-\n-import static org.junit.Assert.assertEquals;\n-import static org.junit.Assert.assertTrue;\n-\n-public class DisableSplitForTaskTableIT extends BaseTest {\n-\n-    private static boolean reinitialize;\n-    private static long systemTableVersion = MetaDataProtocol.getPriorVersion();\n-\n-    private static class PhoenixUpgradeCountingServices\n-            extends ConnectionQueryServicesImpl {\n-\n-        public PhoenixUpgradeCountingServices(\n-                QueryServices services,\n-                PhoenixEmbeddedDriver.ConnectionInfo connectionInfo,\n-                Properties info) {\n-            super(services, connectionInfo, info);\n-        }\n-\n-        @Override\n-        protected void setUpgradeRequired() {\n-            super.setUpgradeRequired();\n-        }\n-\n-        @Override\n-        protected long getSystemTableVersion() {\n-            return systemTableVersion;\n-        }\n-\n-        @Override\n-        protected boolean isInitialized() {\n-            return !reinitialize && super.isInitialized();\n-        }\n-    }\n-\n-    public static class PhoenixUpgradeCountingDriver\n-            extends PhoenixTestDriver {\n-        private ConnectionQueryServices connectionQueryServices;\n-        private final ReadOnlyProps overrideProps;\n-\n-        public PhoenixUpgradeCountingDriver(ReadOnlyProps props) {\n-            overrideProps = props;\n-        }\n-\n-        @Override\n-        public boolean acceptsURL(String url) {\n-            return true;\n-        }\n-\n-        @Override\n-        public synchronized ConnectionQueryServices getConnectionQueryServices(\n-                String url, Properties info) throws SQLException {\n-            if (connectionQueryServices == null) {\n-                connectionQueryServices =\n-                    new PhoenixUpgradeCountingServices(\n-                        new QueryServicesTestImpl(getDefaultProps(),\n-                            overrideProps), ConnectionInfo.create(url), info);\n-                connectionQueryServices.init(url, info);\n-            } else if (reinitialize) {\n-                connectionQueryServices.init(url, info);\n-                reinitialize = false;\n-            }\n-            return connectionQueryServices;\n-        }\n-    }\n-\n-    @BeforeClass\n-    public static synchronized void doSetup() throws Exception {\n-        Map<String, String> props = Maps.newConcurrentMap();\n-        props.put(BaseTest.DRIVER_CLASS_NAME_ATTRIB,\n-            PhoenixUpgradeCountingDriver.class.getName());\n-        setUpTestDriver(new ReadOnlyProps(props.entrySet().iterator()));\n-    }\n-\n-    @Test\n-    public void testUpgradeOnlyHappensOnce() throws Exception {\n-        ConnectionQueryServices services = DriverManager.getConnection(getUrl())\n-            .unwrap(PhoenixConnection.class).getQueryServices();\n-        assertTrue(services instanceof PhoenixUpgradeCountingServices);\n-        reinitialize = true;\n-        systemTableVersion = MetaDataProtocol.MIN_SYSTEM_TABLE_TIMESTAMP;\n-        DriverManager.getConnection(getUrl());\n-        try (Admin admin = services.getAdmin()) {\n-            String taskSplitPolicy = admin\n-                .getDescriptor(TableName.valueOf(\n-                    PhoenixDatabaseMetaData.SYSTEM_TASK_NAME))\n-                .getRegionSplitPolicyClassName();\n-            assertEquals(DisabledRegionSplitPolicy.class.getName(),\n-                taskSplitPolicy);\n-        }\n-    }\n-}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg3NDEwOQ==", "url": "https://github.com/apache/phoenix/pull/923#discussion_r505874109", "bodyText": "Since this method actually also replaces the split policy, we should rename it to indicate that.", "author": "ChinmaySKulkarni", "createdAt": "2020-10-15T21:35:12Z", "path": "phoenix-core/src/main/java/org/apache/phoenix/query/ConnectionQueryServicesImpl.java", "diffHunk": "@@ -1451,7 +1454,35 @@ private TableDescriptor ensureTableCreated(byte[] physicalTableName, PTableType\n         }\n         return null; // will never make it here\n     }\n-    \n+\n+    private boolean isSplitPolicyUpdatedForTaskTable(", "originalCommit": "09a5b2b6f20d7d6d430d2b9859c7bf55df5fa0c7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1486aa4b2bf990d1d4dfb7ecceb550eee2727999", "chunk": "diff --git a/phoenix-core/src/main/java/org/apache/phoenix/query/ConnectionQueryServicesImpl.java b/phoenix-core/src/main/java/org/apache/phoenix/query/ConnectionQueryServicesImpl.java\nindex f10c41bf3..070c3a253 100644\n--- a/phoenix-core/src/main/java/org/apache/phoenix/query/ConnectionQueryServicesImpl.java\n+++ b/phoenix-core/src/main/java/org/apache/phoenix/query/ConnectionQueryServicesImpl.java\n\n@@ -1455,28 +1453,34 @@ public class ConnectionQueryServicesImpl extends DelegateQueryServices implement\n         return null; // will never make it here\n     }\n \n-    private boolean isSplitPolicyUpdatedForTaskTable(\n+    /**\n+     * If given TableDescriptorBuilder belongs to SYSTEM.TASK and if the table\n+     * still does not have split policy setup as SystemTaskSplitPolicy, set\n+     * it up and return true, else return false. This method is expected\n+     * to return true only if it updated split policy (which should happen\n+     * once during initial upgrade).\n+     *\n+     * @param tdBuilder table descriptor builder\n+     * @return return true if split policy of SYSTEM.TASK is updated to\n+     *     SystemTaskSplitPolicy.\n+     */\n+    @VisibleForTesting\n+    public boolean confirmIfSplitPolicyUpdatedForTaskTable(\n             final TableDescriptorBuilder tdBuilder) {\n         boolean isTaskTable = false;\n-        String taskTable = PhoenixDatabaseMetaData.SYSTEM_TASK_NAME;\n-        if (tdBuilder.build().getTableName().getNameAsString()\n-                .equals(taskTable)) {\n+        TableName sysTaskTable = SchemaUtil\n+            .getPhysicalTableName(PhoenixDatabaseMetaData.SYSTEM_TASK_NAME,\n+                props);\n+        if (tdBuilder.build().getTableName().equals(sysTaskTable)) {\n             isTaskTable = true;\n-        } else {\n-            taskTable = taskTable.replace(QueryConstants.NAME_SEPARATOR,\n-              QueryConstants.NAMESPACE_SEPARATOR);\n-            if (tdBuilder.build().getTableName().getNameAsString()\n-                    .equals(taskTable)) {\n-                isTaskTable = true;\n-            }\n         }\n         if (isTaskTable) {\n             String splitPolicyClassName = tdBuilder.build()\n                 .getRegionSplitPolicyClassName();\n-            if (!DisabledRegionSplitPolicy.class.getName()\n+            if (!SystemTaskSplitPolicy.class.getName()\n                     .equals(splitPolicyClassName)) {\n                 tdBuilder.setRegionSplitPolicyClassName(\n-                    DisabledRegionSplitPolicy.class.getName());\n+                    SystemTaskSplitPolicy.class.getName());\n                 return true;\n             }\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg3NDI0MA==", "url": "https://github.com/apache/phoenix/pull/923#discussion_r505874240", "bodyText": "Can we add a new unit test for this method?", "author": "ChinmaySKulkarni", "createdAt": "2020-10-15T21:35:23Z", "path": "phoenix-core/src/main/java/org/apache/phoenix/query/ConnectionQueryServicesImpl.java", "diffHunk": "@@ -1451,7 +1454,35 @@ private TableDescriptor ensureTableCreated(byte[] physicalTableName, PTableType\n         }\n         return null; // will never make it here\n     }\n-    \n+\n+    private boolean isSplitPolicyUpdatedForTaskTable(\n+            final TableDescriptorBuilder tdBuilder) {", "originalCommit": "09a5b2b6f20d7d6d430d2b9859c7bf55df5fa0c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMzMTU5Ng==", "url": "https://github.com/apache/phoenix/pull/923#discussion_r506331596", "bodyText": "Done", "author": "virajjasani", "createdAt": "2020-10-16T11:46:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg3NDI0MA=="}], "type": "inlineReview", "revised_code": {"commit": "1486aa4b2bf990d1d4dfb7ecceb550eee2727999", "chunk": "diff --git a/phoenix-core/src/main/java/org/apache/phoenix/query/ConnectionQueryServicesImpl.java b/phoenix-core/src/main/java/org/apache/phoenix/query/ConnectionQueryServicesImpl.java\nindex f10c41bf3..070c3a253 100644\n--- a/phoenix-core/src/main/java/org/apache/phoenix/query/ConnectionQueryServicesImpl.java\n+++ b/phoenix-core/src/main/java/org/apache/phoenix/query/ConnectionQueryServicesImpl.java\n\n@@ -1455,28 +1453,34 @@ public class ConnectionQueryServicesImpl extends DelegateQueryServices implement\n         return null; // will never make it here\n     }\n \n-    private boolean isSplitPolicyUpdatedForTaskTable(\n+    /**\n+     * If given TableDescriptorBuilder belongs to SYSTEM.TASK and if the table\n+     * still does not have split policy setup as SystemTaskSplitPolicy, set\n+     * it up and return true, else return false. This method is expected\n+     * to return true only if it updated split policy (which should happen\n+     * once during initial upgrade).\n+     *\n+     * @param tdBuilder table descriptor builder\n+     * @return return true if split policy of SYSTEM.TASK is updated to\n+     *     SystemTaskSplitPolicy.\n+     */\n+    @VisibleForTesting\n+    public boolean confirmIfSplitPolicyUpdatedForTaskTable(\n             final TableDescriptorBuilder tdBuilder) {\n         boolean isTaskTable = false;\n-        String taskTable = PhoenixDatabaseMetaData.SYSTEM_TASK_NAME;\n-        if (tdBuilder.build().getTableName().getNameAsString()\n-                .equals(taskTable)) {\n+        TableName sysTaskTable = SchemaUtil\n+            .getPhysicalTableName(PhoenixDatabaseMetaData.SYSTEM_TASK_NAME,\n+                props);\n+        if (tdBuilder.build().getTableName().equals(sysTaskTable)) {\n             isTaskTable = true;\n-        } else {\n-            taskTable = taskTable.replace(QueryConstants.NAME_SEPARATOR,\n-              QueryConstants.NAMESPACE_SEPARATOR);\n-            if (tdBuilder.build().getTableName().getNameAsString()\n-                    .equals(taskTable)) {\n-                isTaskTable = true;\n-            }\n         }\n         if (isTaskTable) {\n             String splitPolicyClassName = tdBuilder.build()\n                 .getRegionSplitPolicyClassName();\n-            if (!DisabledRegionSplitPolicy.class.getName()\n+            if (!SystemTaskSplitPolicy.class.getName()\n                     .equals(splitPolicyClassName)) {\n                 tdBuilder.setRegionSplitPolicyClassName(\n-                    DisabledRegionSplitPolicy.class.getName());\n+                    SystemTaskSplitPolicy.class.getName());\n                 return true;\n             }\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg3NDk2NQ==", "url": "https://github.com/apache/phoenix/pull/923#discussion_r505874965", "bodyText": "Same question here, can we not use namespace mapping property to ensure we are looking for the correct name '.' vs ':'?", "author": "ChinmaySKulkarni", "createdAt": "2020-10-15T21:36:19Z", "path": "phoenix-core/src/main/java/org/apache/phoenix/query/ConnectionQueryServicesImpl.java", "diffHunk": "@@ -4006,6 +4037,33 @@ private PhoenixConnection upgradeSystemTask(PhoenixConnection metaConnection)\n                         \"ALTER TABLE \" + taskTableFullName + \" SET \" + TTL + \"=\" + TASK_TABLE_TTL);\n                 clearCache();\n             }\n+            // If SYSTEM.TASK does not have disabled regions split policy,\n+            // set it up here while upgrading it\n+            try (Admin admin = metaConnection.getQueryServices().getAdmin()) {\n+                String tableNameStr = PhoenixDatabaseMetaData.SYSTEM_TASK_NAME;\n+                TableName tableName;\n+                TableDescriptor td;\n+                try {\n+                    tableName = TableName.valueOf(tableNameStr);\n+                    td = admin.getDescriptor(tableName);\n+                } catch (org.apache.hadoop.hbase.TableNotFoundException tnfe) {", "originalCommit": "09a5b2b6f20d7d6d430d2b9859c7bf55df5fa0c7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1486aa4b2bf990d1d4dfb7ecceb550eee2727999", "chunk": "diff --git a/phoenix-core/src/main/java/org/apache/phoenix/query/ConnectionQueryServicesImpl.java b/phoenix-core/src/main/java/org/apache/phoenix/query/ConnectionQueryServicesImpl.java\nindex f10c41bf3..070c3a253 100644\n--- a/phoenix-core/src/main/java/org/apache/phoenix/query/ConnectionQueryServicesImpl.java\n+++ b/phoenix-core/src/main/java/org/apache/phoenix/query/ConnectionQueryServicesImpl.java\n\n@@ -4040,22 +4044,14 @@ public class ConnectionQueryServicesImpl extends DelegateQueryServices implement\n             // If SYSTEM.TASK does not have disabled regions split policy,\n             // set it up here while upgrading it\n             try (Admin admin = metaConnection.getQueryServices().getAdmin()) {\n-                String tableNameStr = PhoenixDatabaseMetaData.SYSTEM_TASK_NAME;\n-                TableName tableName;\n                 TableDescriptor td;\n-                try {\n-                    tableName = TableName.valueOf(tableNameStr);\n-                    td = admin.getDescriptor(tableName);\n-                } catch (org.apache.hadoop.hbase.TableNotFoundException tnfe) {\n-                    tableNameStr = tableNameStr.replace(\n-                        QueryConstants.NAME_SEPARATOR,\n-                        QueryConstants.NAMESPACE_SEPARATOR);\n-                    tableName = TableName.valueOf(tableNameStr);\n-                    td = admin.getDescriptor(tableName);\n-                }\n+                TableName tableName = SchemaUtil.getPhysicalTableName(\n+                    PhoenixDatabaseMetaData.SYSTEM_TASK_NAME, props);\n+                td = admin.getDescriptor(tableName);\n                 TableDescriptorBuilder tableDescriptorBuilder =\n                     TableDescriptorBuilder.newBuilder(td);\n-                if (isSplitPolicyUpdatedForTaskTable(tableDescriptorBuilder)) {\n+                if (confirmIfSplitPolicyUpdatedForTaskTable(\n+                        tableDescriptorBuilder)) {\n                     admin.modifyTable(tableDescriptorBuilder.build());\n                     pollForUpdatedTableDescriptor(admin,\n                         tableDescriptorBuilder.build(), tableName.getName());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg3NTcxMA==", "url": "https://github.com/apache/phoenix/pull/923#discussion_r505875710", "bodyText": "Do we have any specific variant of SQLException to handle any exceptions thrown during the upgrade process?", "author": "ChinmaySKulkarni", "createdAt": "2020-10-15T21:37:18Z", "path": "phoenix-core/src/main/java/org/apache/phoenix/query/ConnectionQueryServicesImpl.java", "diffHunk": "@@ -4006,6 +4037,33 @@ private PhoenixConnection upgradeSystemTask(PhoenixConnection metaConnection)\n                         \"ALTER TABLE \" + taskTableFullName + \" SET \" + TTL + \"=\" + TASK_TABLE_TTL);\n                 clearCache();\n             }\n+            // If SYSTEM.TASK does not have disabled regions split policy,\n+            // set it up here while upgrading it\n+            try (Admin admin = metaConnection.getQueryServices().getAdmin()) {\n+                String tableNameStr = PhoenixDatabaseMetaData.SYSTEM_TASK_NAME;\n+                TableName tableName;\n+                TableDescriptor td;\n+                try {\n+                    tableName = TableName.valueOf(tableNameStr);\n+                    td = admin.getDescriptor(tableName);\n+                } catch (org.apache.hadoop.hbase.TableNotFoundException tnfe) {\n+                    tableNameStr = tableNameStr.replace(\n+                        QueryConstants.NAME_SEPARATOR,\n+                        QueryConstants.NAMESPACE_SEPARATOR);\n+                    tableName = TableName.valueOf(tableNameStr);\n+                    td = admin.getDescriptor(tableName);\n+                }\n+                TableDescriptorBuilder tableDescriptorBuilder =\n+                    TableDescriptorBuilder.newBuilder(td);\n+                if (isSplitPolicyUpdatedForTaskTable(tableDescriptorBuilder)) {\n+                    admin.modifyTable(tableDescriptorBuilder.build());\n+                    pollForUpdatedTableDescriptor(admin,\n+                        tableDescriptorBuilder.build(), tableName.getName());\n+                }\n+            } catch (InterruptedException | TimeoutException ite) {\n+                throw new SQLException(PhoenixDatabaseMetaData.SYSTEM_TASK_NAME", "originalCommit": "09a5b2b6f20d7d6d430d2b9859c7bf55df5fa0c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjE2OTY1MQ==", "url": "https://github.com/apache/phoenix/pull/923#discussion_r506169651", "bodyText": "I could find UpgradeInProgressException, UpgradeNotRequiredException and UpgradeRequiredException. Perhaps they don't fit well here? Thought?", "author": "virajjasani", "createdAt": "2020-10-16T08:30:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg3NTcxMA=="}], "type": "inlineReview", "revised_code": {"commit": "1486aa4b2bf990d1d4dfb7ecceb550eee2727999", "chunk": "diff --git a/phoenix-core/src/main/java/org/apache/phoenix/query/ConnectionQueryServicesImpl.java b/phoenix-core/src/main/java/org/apache/phoenix/query/ConnectionQueryServicesImpl.java\nindex f10c41bf3..070c3a253 100644\n--- a/phoenix-core/src/main/java/org/apache/phoenix/query/ConnectionQueryServicesImpl.java\n+++ b/phoenix-core/src/main/java/org/apache/phoenix/query/ConnectionQueryServicesImpl.java\n\n@@ -4040,22 +4044,14 @@ public class ConnectionQueryServicesImpl extends DelegateQueryServices implement\n             // If SYSTEM.TASK does not have disabled regions split policy,\n             // set it up here while upgrading it\n             try (Admin admin = metaConnection.getQueryServices().getAdmin()) {\n-                String tableNameStr = PhoenixDatabaseMetaData.SYSTEM_TASK_NAME;\n-                TableName tableName;\n                 TableDescriptor td;\n-                try {\n-                    tableName = TableName.valueOf(tableNameStr);\n-                    td = admin.getDescriptor(tableName);\n-                } catch (org.apache.hadoop.hbase.TableNotFoundException tnfe) {\n-                    tableNameStr = tableNameStr.replace(\n-                        QueryConstants.NAME_SEPARATOR,\n-                        QueryConstants.NAMESPACE_SEPARATOR);\n-                    tableName = TableName.valueOf(tableNameStr);\n-                    td = admin.getDescriptor(tableName);\n-                }\n+                TableName tableName = SchemaUtil.getPhysicalTableName(\n+                    PhoenixDatabaseMetaData.SYSTEM_TASK_NAME, props);\n+                td = admin.getDescriptor(tableName);\n                 TableDescriptorBuilder tableDescriptorBuilder =\n                     TableDescriptorBuilder.newBuilder(td);\n-                if (isSplitPolicyUpdatedForTaskTable(tableDescriptorBuilder)) {\n+                if (confirmIfSplitPolicyUpdatedForTaskTable(\n+                        tableDescriptorBuilder)) {\n                     admin.modifyTable(tableDescriptorBuilder.build());\n                     pollForUpdatedTableDescriptor(admin,\n                         tableDescriptorBuilder.build(), tableName.getName());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg4NTg1Nw==", "url": "https://github.com/apache/phoenix/pull/923#discussion_r505885857", "bodyText": "Can't we use the actual namespace mapping property to get the exact expected name i.e. SYSTEM.TASK vs SYSTEM:TASK instead of trying both variations?", "author": "ChinmaySKulkarni", "createdAt": "2020-10-15T21:52:10Z", "path": "phoenix-core/src/main/java/org/apache/phoenix/query/ConnectionQueryServicesImpl.java", "diffHunk": "@@ -1451,7 +1454,35 @@ private TableDescriptor ensureTableCreated(byte[] physicalTableName, PTableType\n         }\n         return null; // will never make it here\n     }\n-    \n+\n+    private boolean isSplitPolicyUpdatedForTaskTable(\n+            final TableDescriptorBuilder tdBuilder) {\n+        boolean isTaskTable = false;\n+        String taskTable = PhoenixDatabaseMetaData.SYSTEM_TASK_NAME;\n+        if (tdBuilder.build().getTableName().getNameAsString()\n+                .equals(taskTable)) {\n+            isTaskTable = true;\n+        } else {", "originalCommit": "09a5b2b6f20d7d6d430d2b9859c7bf55df5fa0c7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1486aa4b2bf990d1d4dfb7ecceb550eee2727999", "chunk": "diff --git a/phoenix-core/src/main/java/org/apache/phoenix/query/ConnectionQueryServicesImpl.java b/phoenix-core/src/main/java/org/apache/phoenix/query/ConnectionQueryServicesImpl.java\nindex f10c41bf3..070c3a253 100644\n--- a/phoenix-core/src/main/java/org/apache/phoenix/query/ConnectionQueryServicesImpl.java\n+++ b/phoenix-core/src/main/java/org/apache/phoenix/query/ConnectionQueryServicesImpl.java\n\n@@ -1455,28 +1453,34 @@ public class ConnectionQueryServicesImpl extends DelegateQueryServices implement\n         return null; // will never make it here\n     }\n \n-    private boolean isSplitPolicyUpdatedForTaskTable(\n+    /**\n+     * If given TableDescriptorBuilder belongs to SYSTEM.TASK and if the table\n+     * still does not have split policy setup as SystemTaskSplitPolicy, set\n+     * it up and return true, else return false. This method is expected\n+     * to return true only if it updated split policy (which should happen\n+     * once during initial upgrade).\n+     *\n+     * @param tdBuilder table descriptor builder\n+     * @return return true if split policy of SYSTEM.TASK is updated to\n+     *     SystemTaskSplitPolicy.\n+     */\n+    @VisibleForTesting\n+    public boolean confirmIfSplitPolicyUpdatedForTaskTable(\n             final TableDescriptorBuilder tdBuilder) {\n         boolean isTaskTable = false;\n-        String taskTable = PhoenixDatabaseMetaData.SYSTEM_TASK_NAME;\n-        if (tdBuilder.build().getTableName().getNameAsString()\n-                .equals(taskTable)) {\n+        TableName sysTaskTable = SchemaUtil\n+            .getPhysicalTableName(PhoenixDatabaseMetaData.SYSTEM_TASK_NAME,\n+                props);\n+        if (tdBuilder.build().getTableName().equals(sysTaskTable)) {\n             isTaskTable = true;\n-        } else {\n-            taskTable = taskTable.replace(QueryConstants.NAME_SEPARATOR,\n-              QueryConstants.NAMESPACE_SEPARATOR);\n-            if (tdBuilder.build().getTableName().getNameAsString()\n-                    .equals(taskTable)) {\n-                isTaskTable = true;\n-            }\n         }\n         if (isTaskTable) {\n             String splitPolicyClassName = tdBuilder.build()\n                 .getRegionSplitPolicyClassName();\n-            if (!DisabledRegionSplitPolicy.class.getName()\n+            if (!SystemTaskSplitPolicy.class.getName()\n                     .equals(splitPolicyClassName)) {\n                 tdBuilder.setRegionSplitPolicyClassName(\n-                    DisabledRegionSplitPolicy.class.getName());\n+                    SystemTaskSplitPolicy.class.getName());\n                 return true;\n             }\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg4ODAwNw==", "url": "https://github.com/apache/phoenix/pull/923#discussion_r505888007", "bodyText": "All table creations go through this method so instead of polluting this with SYSTEM.TASK specific stuff, I think we should divide the problem into 2 parts:\n\n\nFresh clusters and <4.15 clusters -> Change the DDL for SYSTEM.TASK (CQSI.CREATE_TASK_METADATA) itself so this would work directly i.e. add\nHTableDescriptor.SPLIT_POLICY + \"='\" + SystemTaskSplitPolicy.class.getName() + \"',\\n\"\nand introduce a new class SystemTaskSplitPolicy which is equivalent to DisabledRegionSplitPolicy for now, but can be easily changed in the future if required without unloading and reloading the coproc.\n\n\nUpgrade path for 4.15 clusters -> We would go through upgradeSystemTask() and here we could load the correct split policy. That way, we don't need the change inside ensureTableCreated() and it is much cleaner. One corner case here (highly unlikely, but still possible) is if a cluster already has SYSTEM.TASK split. In that case, we might want to throw an exception or maybe merge regions of SYSTEM.TASK", "author": "ChinmaySKulkarni", "createdAt": "2020-10-15T21:57:33Z", "path": "phoenix-core/src/main/java/org/apache/phoenix/query/ConnectionQueryServicesImpl.java", "diffHunk": "@@ -1336,6 +1337,8 @@ private TableDescriptor ensureTableCreated(byte[] physicalTableName, PTableType\n                         PBoolean.INSTANCE.toObject(newDesc.build().getValue(MetaDataUtil.IS_LOCAL_INDEX_TABLE_PROP_BYTES)))) {\n                     newDesc.setRegionSplitPolicyClassName(IndexRegionSplitPolicy.class.getName());\n                 }\n+                // disable split policy for SYSTEM.TASK\n+                isSplitPolicyUpdatedForTaskTable(newDesc);", "originalCommit": "09a5b2b6f20d7d6d430d2b9859c7bf55df5fa0c7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1486aa4b2bf990d1d4dfb7ecceb550eee2727999", "chunk": "diff --git a/phoenix-core/src/main/java/org/apache/phoenix/query/ConnectionQueryServicesImpl.java b/phoenix-core/src/main/java/org/apache/phoenix/query/ConnectionQueryServicesImpl.java\nindex f10c41bf3..070c3a253 100644\n--- a/phoenix-core/src/main/java/org/apache/phoenix/query/ConnectionQueryServicesImpl.java\n+++ b/phoenix-core/src/main/java/org/apache/phoenix/query/ConnectionQueryServicesImpl.java\n\n@@ -1337,8 +1337,6 @@ public class ConnectionQueryServicesImpl extends DelegateQueryServices implement\n                         PBoolean.INSTANCE.toObject(newDesc.build().getValue(MetaDataUtil.IS_LOCAL_INDEX_TABLE_PROP_BYTES)))) {\n                     newDesc.setRegionSplitPolicyClassName(IndexRegionSplitPolicy.class.getName());\n                 }\n-                // disable split policy for SYSTEM.TASK\n-                isSplitPolicyUpdatedForTaskTable(newDesc);\n                 try {\n                     if (splits == null) {\n                         admin.createTable(newDesc.build());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg4ODkyNA==", "url": "https://github.com/apache/phoenix/pull/923#discussion_r505888924", "bodyText": "Is it possible to add a test case inside BackwardsCompatibilityIT to make sure that the upgrade path changes work and SYSTEM.TASK comes up with the expected split policy?", "author": "ChinmaySKulkarni", "createdAt": "2020-10-15T21:59:56Z", "path": "phoenix-core/src/main/java/org/apache/phoenix/query/ConnectionQueryServicesImpl.java", "diffHunk": "@@ -4006,6 +4037,33 @@ private PhoenixConnection upgradeSystemTask(PhoenixConnection metaConnection)\n                         \"ALTER TABLE \" + taskTableFullName + \" SET \" + TTL + \"=\" + TASK_TABLE_TTL);\n                 clearCache();\n             }\n+            // If SYSTEM.TASK does not have disabled regions split policy,\n+            // set it up here while upgrading it\n+            try (Admin admin = metaConnection.getQueryServices().getAdmin()) {", "originalCommit": "09a5b2b6f20d7d6d430d2b9859c7bf55df5fa0c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMzMjUzNg==", "url": "https://github.com/apache/phoenix/pull/923#discussion_r506332536", "bodyText": "Added a test on BackwardsCompatibilityIT. Tested on 4.x with compatible client versions: 4.14.3 and 4.15.0.\nFor one, split policy was set by DDL statement at server and for another, upgrade path was followed to ensure split policy is updated. Hence, without upgrade path code, the test fails for 4.15.0 client.", "author": "virajjasani", "createdAt": "2020-10-16T11:47:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg4ODkyNA=="}], "type": "inlineReview", "revised_code": {"commit": "1486aa4b2bf990d1d4dfb7ecceb550eee2727999", "chunk": "diff --git a/phoenix-core/src/main/java/org/apache/phoenix/query/ConnectionQueryServicesImpl.java b/phoenix-core/src/main/java/org/apache/phoenix/query/ConnectionQueryServicesImpl.java\nindex f10c41bf3..070c3a253 100644\n--- a/phoenix-core/src/main/java/org/apache/phoenix/query/ConnectionQueryServicesImpl.java\n+++ b/phoenix-core/src/main/java/org/apache/phoenix/query/ConnectionQueryServicesImpl.java\n\n@@ -4040,22 +4044,14 @@ public class ConnectionQueryServicesImpl extends DelegateQueryServices implement\n             // If SYSTEM.TASK does not have disabled regions split policy,\n             // set it up here while upgrading it\n             try (Admin admin = metaConnection.getQueryServices().getAdmin()) {\n-                String tableNameStr = PhoenixDatabaseMetaData.SYSTEM_TASK_NAME;\n-                TableName tableName;\n                 TableDescriptor td;\n-                try {\n-                    tableName = TableName.valueOf(tableNameStr);\n-                    td = admin.getDescriptor(tableName);\n-                } catch (org.apache.hadoop.hbase.TableNotFoundException tnfe) {\n-                    tableNameStr = tableNameStr.replace(\n-                        QueryConstants.NAME_SEPARATOR,\n-                        QueryConstants.NAMESPACE_SEPARATOR);\n-                    tableName = TableName.valueOf(tableNameStr);\n-                    td = admin.getDescriptor(tableName);\n-                }\n+                TableName tableName = SchemaUtil.getPhysicalTableName(\n+                    PhoenixDatabaseMetaData.SYSTEM_TASK_NAME, props);\n+                td = admin.getDescriptor(tableName);\n                 TableDescriptorBuilder tableDescriptorBuilder =\n                     TableDescriptorBuilder.newBuilder(td);\n-                if (isSplitPolicyUpdatedForTaskTable(tableDescriptorBuilder)) {\n+                if (confirmIfSplitPolicyUpdatedForTaskTable(\n+                        tableDescriptorBuilder)) {\n                     admin.modifyTable(tableDescriptorBuilder.build());\n                     pollForUpdatedTableDescriptor(admin,\n                         tableDescriptorBuilder.build(), tableName.getName());\n"}}, {"oid": "1486aa4b2bf990d1d4dfb7ecceb550eee2727999", "url": "https://github.com/apache/phoenix/commit/1486aa4b2bf990d1d4dfb7ecceb550eee2727999", "message": "incorporated review", "committedDate": "2020-10-16T15:03:23Z", "type": "forcePushed"}, {"oid": "deb315e9c941b15bc1bcd6e063fb0e1ab2bbd2f4", "url": "https://github.com/apache/phoenix/commit/deb315e9c941b15bc1bcd6e063fb0e1ab2bbd2f4", "message": "PHOENIX-6125 : Disable region split for SYSTEM.TASK", "committedDate": "2020-10-18T11:29:16Z", "type": "forcePushed"}, {"oid": "5058c3a5c2ec09ea227a6144a753fef239cee8a7", "url": "https://github.com/apache/phoenix/commit/5058c3a5c2ec09ea227a6144a753fef239cee8a7", "message": "PHOENIX-6125 : Disable region split for SYSTEM.TASK", "committedDate": "2020-10-18T11:38:33Z", "type": "forcePushed"}, {"oid": "fb62ed0fc4c8d0d03e32f971483cbe51f6bfca28", "url": "https://github.com/apache/phoenix/commit/fb62ed0fc4c8d0d03e32f971483cbe51f6bfca28", "message": "PHOENIX-6125 : Disable region split for SYSTEM.TASK", "committedDate": "2020-10-18T11:43:37Z", "type": "forcePushed"}, {"oid": "9069426f2a899960f14f24386d46b7759e2064d9", "url": "https://github.com/apache/phoenix/commit/9069426f2a899960f14f24386d46b7759e2064d9", "message": "PHOENIX-6125 : Disable region split for SYSTEM.TASK", "committedDate": "2020-10-19T13:27:14Z", "type": "commit"}, {"oid": "9069426f2a899960f14f24386d46b7759e2064d9", "url": "https://github.com/apache/phoenix/commit/9069426f2a899960f14f24386d46b7759e2064d9", "message": "PHOENIX-6125 : Disable region split for SYSTEM.TASK", "committedDate": "2020-10-19T13:27:14Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzgzMzU5NQ==", "url": "https://github.com/apache/phoenix/pull/923#discussion_r507833595", "bodyText": "These changes are specific only to whitespace issues that precommit build reported.", "author": "virajjasani", "createdAt": "2020-10-19T15:12:49Z", "path": "phoenix-core/src/it/java/org/apache/phoenix/end2end/SystemTablesUpgradeIT.java", "diffHunk": "@@ -25,61 +25,68 @@\n import java.util.Map;\n import java.util.Properties;\n \n+import org.apache.hadoop.hbase.TableName;\n+import org.apache.hadoop.hbase.client.Admin;\n import org.apache.phoenix.coprocessor.MetaDataProtocol;\n import org.apache.phoenix.jdbc.PhoenixConnection;\n+import org.apache.phoenix.jdbc.PhoenixDatabaseMetaData;\n import org.apache.phoenix.jdbc.PhoenixEmbeddedDriver.ConnectionInfo;\n import org.apache.phoenix.jdbc.PhoenixTestDriver;\n import org.apache.phoenix.query.BaseTest;\n import org.apache.phoenix.query.ConnectionQueryServices;\n import org.apache.phoenix.query.ConnectionQueryServicesImpl;\n import org.apache.phoenix.query.QueryServices;\n import org.apache.phoenix.query.QueryServicesTestImpl;\n+import org.apache.phoenix.schema.SystemTaskSplitPolicy;\n import org.apache.phoenix.util.ReadOnlyProps;\n import org.junit.BeforeClass;\n import org.junit.Test;\n \n import org.apache.phoenix.thirdparty.com.google.common.collect.Maps;\n \n-public class SystemCatalogUpgradeIT extends BaseTest {\n+/**\n+ * Tests for upgrades of System tables.\n+ */\n+public class SystemTablesUpgradeIT extends BaseTest {\n     private static boolean reinitialize;\n     private static int countUpgradeAttempts;\n     private static long systemTableVersion = MetaDataProtocol.getPriorVersion();\n-    \n+\n     private static class PhoenixUpgradeCountingServices extends ConnectionQueryServicesImpl {\n         public PhoenixUpgradeCountingServices(QueryServices services, ConnectionInfo connectionInfo, Properties info) {\n             super(services, connectionInfo, info);\n         }\n-        \n+\n         @Override\n         protected void setUpgradeRequired() {\n             super.setUpgradeRequired();\n             countUpgradeAttempts++;\n         }\n-        \n+", "originalCommit": "9069426f2a899960f14f24386d46b7759e2064d9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}