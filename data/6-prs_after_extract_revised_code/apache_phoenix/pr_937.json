{"pr_number": 937, "pr_title": "PHOENIX-6198 Add option to IndexTool to specify the source table for scan", "pr_createdAt": "2020-10-23T17:14:53Z", "pr_url": "https://github.com/apache/phoenix/pull/937", "timeline": [{"oid": "ba2f5a01b834e5e0a2100be5ce57a5938132e345", "url": "https://github.com/apache/phoenix/commit/ba2f5a01b834e5e0a2100be5ce57a5938132e345", "message": "PHOENIX-6198 Add option to IndexTool to specify the source table for scan", "committedDate": "2020-10-23T17:07:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTAzMTU1Nw==", "url": "https://github.com/apache/phoenix/pull/937#discussion_r511031557", "bodyText": "nit: We have a similar enum in the IndexScrutinyTool. Can we re use it?", "author": "gokceni", "createdAt": "2020-10-23T17:25:55Z", "path": "phoenix-core/src/main/java/org/apache/phoenix/mapreduce/index/IndexTool.java", "diffHunk": "@@ -192,6 +191,14 @@ public static IndexDisableLoggingType fromValue(byte[] value) {\n         }\n     }\n \n+    /**\n+     * Which table to use as the source table\n+     */\n+    public enum SourceTable {", "originalCommit": "ba2f5a01b834e5e0a2100be5ce57a5938132e345", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA4OTc2MQ==", "url": "https://github.com/apache/phoenix/pull/937#discussion_r511089761", "bodyText": "It has a BOTH option which is not supported that is why I didn't want to use it.", "author": "tkhurana", "createdAt": "2020-10-23T19:07:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTAzMTU1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA5NDA2Ng==", "url": "https://github.com/apache/phoenix/pull/937#discussion_r511094066", "bodyText": "I agree with Gokcen, does not hurt to use it. In the future, we may want to use both. Would be a good extension.", "author": "swaroopak", "createdAt": "2020-10-23T19:13:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTAzMTU1Nw=="}], "type": "inlineReview", "revised_code": {"commit": "9d77d0121c67e27ec84420fe2a829f2ddcee5de0", "chunk": "diff --git a/phoenix-core/src/main/java/org/apache/phoenix/mapreduce/index/IndexTool.java b/phoenix-core/src/main/java/org/apache/phoenix/mapreduce/index/IndexTool.java\nindex 908cb41de..c574ea5ac 100644\n--- a/phoenix-core/src/main/java/org/apache/phoenix/mapreduce/index/IndexTool.java\n+++ b/phoenix-core/src/main/java/org/apache/phoenix/mapreduce/index/IndexTool.java\n\n@@ -191,14 +192,6 @@ public class IndexTool extends Configured implements Tool {\n         }\n     }\n \n-    /**\n-     * Which table to use as the source table\n-     */\n-    public enum SourceTable {\n-        DATA_TABLE_SOURCE,\n-        INDEX_TABLE_SOURCE;\n-    }\n-\n     private static final Logger LOGGER = LoggerFactory.getLogger(IndexTool.class);\n \n     private String schemaName;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTAzMzAxNg==", "url": "https://github.com/apache/phoenix/pull/937#discussion_r511033016", "bodyText": "I think stating this is clearer: This option is applicable only when -v ONLY or -v BEFORE is provided.", "author": "gokceni", "createdAt": "2020-10-23T17:28:48Z", "path": "phoenix-core/src/main/java/org/apache/phoenix/mapreduce/index/IndexTool.java", "diffHunk": "@@ -285,6 +293,11 @@ public static IndexDisableLoggingType fromValue(byte[] value) {\n         , \"Disable logging of failed verification rows for BEFORE, \" +\n         \"AFTER, or BOTH verify jobs\");\n \n+    private static final Option USE_INDEX_TABLE_AS_SOURCE_OPTION =\n+        new Option(\"fi\", \"from-index\", false,\n+            \"To verify every row in the index table has a corresponding row in the data table. \" +\n+                \"Only supported for global indexes. This option is applicable to BEFORE and ONLY type verification jobs\");", "originalCommit": "ba2f5a01b834e5e0a2100be5ce57a5938132e345", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9d77d0121c67e27ec84420fe2a829f2ddcee5de0", "chunk": "diff --git a/phoenix-core/src/main/java/org/apache/phoenix/mapreduce/index/IndexTool.java b/phoenix-core/src/main/java/org/apache/phoenix/mapreduce/index/IndexTool.java\nindex 908cb41de..c574ea5ac 100644\n--- a/phoenix-core/src/main/java/org/apache/phoenix/mapreduce/index/IndexTool.java\n+++ b/phoenix-core/src/main/java/org/apache/phoenix/mapreduce/index/IndexTool.java\n\n@@ -295,8 +288,9 @@ public class IndexTool extends Configured implements Tool {\n \n     private static final Option USE_INDEX_TABLE_AS_SOURCE_OPTION =\n         new Option(\"fi\", \"from-index\", false,\n-            \"To verify every row in the index table has a corresponding row in the data table. \" +\n-                \"Only supported for global indexes. This option is applicable to BEFORE and ONLY type verification jobs\");\n+            \"To verify every row in the index table has a corresponding row in the data table. \"\n+                + \"Only supported for global indexes. If this option is used with -v AFTER, these \"\n+                + \"extra rows will be identified but not repaired.\");\n \n     public static final String INDEX_JOB_NAME_TEMPLATE = \"PHOENIX_%s.%s_INDX_%s\";\n \n"}}, {"oid": "9d77d0121c67e27ec84420fe2a829f2ddcee5de0", "url": "https://github.com/apache/phoenix/commit/9d77d0121c67e27ec84420fe2a829f2ddcee5de0", "message": "Addressed feedback for PHOENIX-6198\n\nExtended the `-from-index` option to support -vBOTH, -vAFTER and -vNONE.\nAdded the disclaimer for -vAFTER. Also, using the source table enum from\nIndexScrutinyTool.", "committedDate": "2020-10-29T07:39:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDU5NDYyMQ==", "url": "https://github.com/apache/phoenix/pull/937#discussion_r514594621", "bodyText": "IndexScrutinyTool.SourceTable.DATA_TABLE_SOURCE.name() the default value?", "author": "priyankporwal", "createdAt": "2020-10-29T22:05:02Z", "path": "phoenix-core/src/main/java/org/apache/phoenix/mapreduce/util/PhoenixConfigurationUtil.java", "diffHunk": "@@ -660,6 +663,19 @@ public static String getIndexToolIndexTableName(Configuration configuration) {\n         return configuration.get(INDEX_TOOL_INDEX_TABLE_NAME);\n     }\n \n+    public static void setIndexToolSourceTable(Configuration configuration,\n+            IndexScrutinyTool.SourceTable sourceTable) {\n+        Preconditions.checkNotNull(configuration);\n+        Preconditions.checkNotNull(sourceTable);\n+        configuration.set(INDEX_TOOL_SOURCE_TABLE, sourceTable.name());\n+    }\n+\n+    public static IndexScrutinyTool.SourceTable getIndexToolSourceTable(Configuration configuration) {\n+        Preconditions.checkNotNull(configuration);\n+        return IndexScrutinyTool.SourceTable.valueOf(configuration.get(INDEX_TOOL_SOURCE_TABLE,\n+            IndexScrutinyTool.SourceTable.DATA_TABLE_SOURCE.name()));", "originalCommit": "9d77d0121c67e27ec84420fe2a829f2ddcee5de0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDU5OTY4Nw==", "url": "https://github.com/apache/phoenix/pull/937#discussion_r514599687", "bodyText": "By default, we are going to use the data table as the source which is what the current behavior is. We have to return a string from which the appropriate enum is constructed. I am not sure what is the question here.", "author": "tkhurana", "createdAt": "2020-10-29T22:17:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDU5NDYyMQ=="}], "type": "inlineReview", "revised_code": null}]}