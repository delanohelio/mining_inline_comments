{"pr_number": 1959, "pr_title": "GH-1958: fix resource closing in federated service SilentIteration", "pr_createdAt": "2020-03-02T14:23:44Z", "pr_url": "https://github.com/eclipse/rdf4j/pull/1959", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjQ1MTEwMg==", "url": "https://github.com/eclipse/rdf4j/pull/1959#discussion_r386451102", "bodyText": "Should maybe this also fail silently?", "author": "hmottestad", "createdAt": "2020-03-02T15:12:35Z", "path": "core/repository/sparql/src/main/java/org/eclipse/rdf4j/repository/sparql/federation/SilentIteration.java", "diffHunk": "@@ -34,9 +39,20 @@ protected BindingSet getNextElement() throws QueryEvaluationException {\n \t\t\t\treturn iter.next();\n \t\t} catch (Exception e) {\n \t\t\t// suppress\n+\t\t\tif (logger.isTraceEnabled()) {\n+\t\t\t\tlogger.trace(\"Suppressed error in SILENT SERVICE: \" + e.getMessage(), e);\n+\t\t\t}\n \t\t}\n \n \t\treturn null;\n \t}\n \n+\t@Override\n+\tprotected void handleClose() throws QueryEvaluationException {\n+\t\ttry {\n+\t\t\tIterations.closeCloseable(iter);\n+\t\t} finally {\n+\t\t\tsuper.handleClose();\n+\t\t}", "originalCommit": "ab2dca0db55eb8dcd1c80c53c7a6b041c66eeb3f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "783bc4253347637d57ccd6eed9b9a842f6b0729a", "chunk": "diff --git a/core/repository/sparql/src/main/java/org/eclipse/rdf4j/repository/sparql/federation/SilentIteration.java b/core/repository/sparql/src/main/java/org/eclipse/rdf4j/repository/sparql/federation/SilentIteration.java\nindex 8d6f2829c0..b199f98685 100644\n--- a/core/repository/sparql/src/main/java/org/eclipse/rdf4j/repository/sparql/federation/SilentIteration.java\n+++ b/core/repository/sparql/src/main/java/org/eclipse/rdf4j/repository/sparql/federation/SilentIteration.java\n\n@@ -7,52 +7,24 @@\n  *******************************************************************************/\n package org.eclipse.rdf4j.repository.sparql.federation;\n \n+import org.eclipse.rdf4j.common.annotation.InternalUseOnly;\n import org.eclipse.rdf4j.common.iteration.CloseableIteration;\n-import org.eclipse.rdf4j.common.iteration.Iterations;\n-import org.eclipse.rdf4j.common.iteration.LookAheadIteration;\n import org.eclipse.rdf4j.query.BindingSet;\n import org.eclipse.rdf4j.query.QueryEvaluationException;\n-import org.slf4j.Logger;\n-import org.slf4j.LoggerFactory;\n \n /**\n  * Wrap an inner iteration and suppress exceptions silently\n  * \n  * @author Andreas Schwarte\n+ * @deprecated Use {@link org.eclipse.rdf4j.common.iteration.SilentIteration} instead.\n  */\n-public class SilentIteration extends LookAheadIteration<BindingSet, QueryEvaluationException> {\n-\n-\tprivate static final Logger logger = LoggerFactory.getLogger(SilentIteration.class);\n-\n-\tprotected CloseableIteration<BindingSet, QueryEvaluationException> iter;\n+@Deprecated\n+@InternalUseOnly\n+public class SilentIteration\n+\t\textends org.eclipse.rdf4j.common.iteration.SilentIteration<BindingSet, QueryEvaluationException> {\n \n \tpublic SilentIteration(CloseableIteration<BindingSet, QueryEvaluationException> iter) {\n-\t\tsuper();\n-\t\tthis.iter = iter;\n+\t\tsuper(iter);\n \t}\n \n-\t@Override\n-\tprotected BindingSet getNextElement() throws QueryEvaluationException {\n-\n-\t\ttry {\n-\t\t\tif (iter.hasNext())\n-\t\t\t\treturn iter.next();\n-\t\t} catch (Exception e) {\n-\t\t\t// suppress\n-\t\t\tif (logger.isTraceEnabled()) {\n-\t\t\t\tlogger.trace(\"Suppressed error in SILENT SERVICE: \" + e.getMessage(), e);\n-\t\t\t}\n-\t\t}\n-\n-\t\treturn null;\n-\t}\n-\n-\t@Override\n-\tprotected void handleClose() throws QueryEvaluationException {\n-\t\ttry {\n-\t\t\tIterations.closeCloseable(iter);\n-\t\t} finally {\n-\t\t\tsuper.handleClose();\n-\t\t}\n-\t}\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjQ1MjAzOQ==", "url": "https://github.com/eclipse/rdf4j/pull/1959#discussion_r386452039", "bodyText": "I know it's not required by our styleguide, but I do prefer using { } for if/else/while.", "author": "hmottestad", "createdAt": "2020-03-02T15:14:04Z", "path": "core/repository/sparql/src/main/java/org/eclipse/rdf4j/repository/sparql/federation/SilentIteration.java", "diffHunk": "@@ -34,9 +39,20 @@ protected BindingSet getNextElement() throws QueryEvaluationException {\n \t\t\t\treturn iter.next();", "originalCommit": "ab2dca0db55eb8dcd1c80c53c7a6b041c66eeb3f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjY3NjQzNg==", "url": "https://github.com/eclipse/rdf4j/pull/1959#discussion_r386676436", "bodyText": "Agreed. Actually it is a convention for the RDF4J project, it's just not explicitly enforced by the formatter because in Eclipse, this option is not part of the formatting rules (so I can't make it part of the maven formatter plugin, which uses Eclipse formatter under the hood).\nBtw if you're using Eclipse, you can configure it to automatically add braces on save, by going to 'Preferences' -> 'Editor' -> 'Save Actions'. Enable 'Additional actions', click 'Configure...' and in the 'Code Style' dialog enable the option 'Use blocks in if/while/for/do statements'.\nOr if you prefer you can use an Eclipse clean up profile to do the same thing.", "author": "jeenbroekstra", "createdAt": "2020-03-02T21:59:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjQ1MjAzOQ=="}], "type": "inlineReview", "revised_code": {"commit": "783bc4253347637d57ccd6eed9b9a842f6b0729a", "chunk": "diff --git a/core/repository/sparql/src/main/java/org/eclipse/rdf4j/repository/sparql/federation/SilentIteration.java b/core/repository/sparql/src/main/java/org/eclipse/rdf4j/repository/sparql/federation/SilentIteration.java\nindex 8d6f2829c0..b199f98685 100644\n--- a/core/repository/sparql/src/main/java/org/eclipse/rdf4j/repository/sparql/federation/SilentIteration.java\n+++ b/core/repository/sparql/src/main/java/org/eclipse/rdf4j/repository/sparql/federation/SilentIteration.java\n\n@@ -7,52 +7,24 @@\n  *******************************************************************************/\n package org.eclipse.rdf4j.repository.sparql.federation;\n \n+import org.eclipse.rdf4j.common.annotation.InternalUseOnly;\n import org.eclipse.rdf4j.common.iteration.CloseableIteration;\n-import org.eclipse.rdf4j.common.iteration.Iterations;\n-import org.eclipse.rdf4j.common.iteration.LookAheadIteration;\n import org.eclipse.rdf4j.query.BindingSet;\n import org.eclipse.rdf4j.query.QueryEvaluationException;\n-import org.slf4j.Logger;\n-import org.slf4j.LoggerFactory;\n \n /**\n  * Wrap an inner iteration and suppress exceptions silently\n  * \n  * @author Andreas Schwarte\n+ * @deprecated Use {@link org.eclipse.rdf4j.common.iteration.SilentIteration} instead.\n  */\n-public class SilentIteration extends LookAheadIteration<BindingSet, QueryEvaluationException> {\n-\n-\tprivate static final Logger logger = LoggerFactory.getLogger(SilentIteration.class);\n-\n-\tprotected CloseableIteration<BindingSet, QueryEvaluationException> iter;\n+@Deprecated\n+@InternalUseOnly\n+public class SilentIteration\n+\t\textends org.eclipse.rdf4j.common.iteration.SilentIteration<BindingSet, QueryEvaluationException> {\n \n \tpublic SilentIteration(CloseableIteration<BindingSet, QueryEvaluationException> iter) {\n-\t\tsuper();\n-\t\tthis.iter = iter;\n+\t\tsuper(iter);\n \t}\n \n-\t@Override\n-\tprotected BindingSet getNextElement() throws QueryEvaluationException {\n-\n-\t\ttry {\n-\t\t\tif (iter.hasNext())\n-\t\t\t\treturn iter.next();\n-\t\t} catch (Exception e) {\n-\t\t\t// suppress\n-\t\t\tif (logger.isTraceEnabled()) {\n-\t\t\t\tlogger.trace(\"Suppressed error in SILENT SERVICE: \" + e.getMessage(), e);\n-\t\t\t}\n-\t\t}\n-\n-\t\treturn null;\n-\t}\n-\n-\t@Override\n-\tprotected void handleClose() throws QueryEvaluationException {\n-\t\ttry {\n-\t\t\tIterations.closeCloseable(iter);\n-\t\t} finally {\n-\t\t\tsuper.handleClose();\n-\t\t}\n-\t}\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjY5MzgwOQ==", "url": "https://github.com/eclipse/rdf4j/pull/1959#discussion_r386693809", "bodyText": "I only just noticed this after pushing an editorial fix, but apparently we have two SilentIteration classes:\n\norg.eclipse.rdf4j.repository.sparql.federation.SilentIteration\norg.eclipse.rdf4j.query.algebra.evaluation.iterator.SilentIteration\n\nThey look identical (barring the fixes you just did) - do we need both or can we get rid of the federated one?", "author": "jeenbroekstra", "createdAt": "2020-03-02T22:37:46Z", "path": "core/repository/sparql/src/main/java/org/eclipse/rdf4j/repository/sparql/federation/SilentIteration.java", "diffHunk": "@@ -19,6 +22,8 @@\n  */\n public class SilentIteration extends LookAheadIteration<BindingSet, QueryEvaluationException> {", "originalCommit": "e883abf2ec940f678aecac226728b5d3141da2d8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjcwMDE3MQ==", "url": "https://github.com/eclipse/rdf4j/pull/1959#discussion_r386700171", "bodyText": "Ah - to answer my own question, this is probably a deliberate copy to avoid a cyclic dependency.\nLet's apply the fix to both copies in this PR. I'll look into a better solution so that we don't have to maintain separate copies separately.", "author": "jeenbroekstra", "createdAt": "2020-03-02T22:52:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjY5MzgwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjcxMTkwNQ==", "url": "https://github.com/eclipse/rdf4j/pull/1959#discussion_r386711905", "bodyText": "Looking a bit further, it seems the copy in evaluation.iterator is not actually used anywhere. Let's mark it deprecated, so we can decide to remove it in a later major release.", "author": "jeenbroekstra", "createdAt": "2020-03-02T23:24:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjY5MzgwOQ=="}], "type": "inlineReview", "revised_code": {"commit": "783bc4253347637d57ccd6eed9b9a842f6b0729a", "chunk": "diff --git a/core/repository/sparql/src/main/java/org/eclipse/rdf4j/repository/sparql/federation/SilentIteration.java b/core/repository/sparql/src/main/java/org/eclipse/rdf4j/repository/sparql/federation/SilentIteration.java\nindex 8d6f2829c0..b199f98685 100644\n--- a/core/repository/sparql/src/main/java/org/eclipse/rdf4j/repository/sparql/federation/SilentIteration.java\n+++ b/core/repository/sparql/src/main/java/org/eclipse/rdf4j/repository/sparql/federation/SilentIteration.java\n\n@@ -7,52 +7,24 @@\n  *******************************************************************************/\n package org.eclipse.rdf4j.repository.sparql.federation;\n \n+import org.eclipse.rdf4j.common.annotation.InternalUseOnly;\n import org.eclipse.rdf4j.common.iteration.CloseableIteration;\n-import org.eclipse.rdf4j.common.iteration.Iterations;\n-import org.eclipse.rdf4j.common.iteration.LookAheadIteration;\n import org.eclipse.rdf4j.query.BindingSet;\n import org.eclipse.rdf4j.query.QueryEvaluationException;\n-import org.slf4j.Logger;\n-import org.slf4j.LoggerFactory;\n \n /**\n  * Wrap an inner iteration and suppress exceptions silently\n  * \n  * @author Andreas Schwarte\n+ * @deprecated Use {@link org.eclipse.rdf4j.common.iteration.SilentIteration} instead.\n  */\n-public class SilentIteration extends LookAheadIteration<BindingSet, QueryEvaluationException> {\n-\n-\tprivate static final Logger logger = LoggerFactory.getLogger(SilentIteration.class);\n-\n-\tprotected CloseableIteration<BindingSet, QueryEvaluationException> iter;\n+@Deprecated\n+@InternalUseOnly\n+public class SilentIteration\n+\t\textends org.eclipse.rdf4j.common.iteration.SilentIteration<BindingSet, QueryEvaluationException> {\n \n \tpublic SilentIteration(CloseableIteration<BindingSet, QueryEvaluationException> iter) {\n-\t\tsuper();\n-\t\tthis.iter = iter;\n+\t\tsuper(iter);\n \t}\n \n-\t@Override\n-\tprotected BindingSet getNextElement() throws QueryEvaluationException {\n-\n-\t\ttry {\n-\t\t\tif (iter.hasNext())\n-\t\t\t\treturn iter.next();\n-\t\t} catch (Exception e) {\n-\t\t\t// suppress\n-\t\t\tif (logger.isTraceEnabled()) {\n-\t\t\t\tlogger.trace(\"Suppressed error in SILENT SERVICE: \" + e.getMessage(), e);\n-\t\t\t}\n-\t\t}\n-\n-\t\treturn null;\n-\t}\n-\n-\t@Override\n-\tprotected void handleClose() throws QueryEvaluationException {\n-\t\ttry {\n-\t\t\tIterations.closeCloseable(iter);\n-\t\t} finally {\n-\t\t\tsuper.handleClose();\n-\t\t}\n-\t}\n }\n"}}, {"oid": "783bc4253347637d57ccd6eed9b9a842f6b0729a", "url": "https://github.com/eclipse/rdf4j/commit/783bc4253347637d57ccd6eed9b9a842f6b0729a", "message": "GH-1958: fix resource closing in federated service SilentIteration\n\nThe SilenetIteration failed to close the inner iteration, thus resulting\nin resource leaks (e.g. pending connections).\n\nWithout this fix the attached unit tests takes 20s before forcefully\nclosing the connection. Now it correctly terminates immediately after\ntest execution.\n\nNote that additionally a TRACE logger has been introduced to give users\nthe chance to observe errors.\n\nAdditional changes:\n\n* add braces\n* apply fixes to both copies of SilentIteration\n* cleaned up different SilentIteration impls", "committedDate": "2020-03-03T07:36:09Z", "type": "commit"}, {"oid": "783bc4253347637d57ccd6eed9b9a842f6b0729a", "url": "https://github.com/eclipse/rdf4j/commit/783bc4253347637d57ccd6eed9b9a842f6b0729a", "message": "GH-1958: fix resource closing in federated service SilentIteration\n\nThe SilenetIteration failed to close the inner iteration, thus resulting\nin resource leaks (e.g. pending connections).\n\nWithout this fix the attached unit tests takes 20s before forcefully\nclosing the connection. Now it correctly terminates immediately after\ntest execution.\n\nNote that additionally a TRACE logger has been introduced to give users\nthe chance to observe errors.\n\nAdditional changes:\n\n* add braces\n* apply fixes to both copies of SilentIteration\n* cleaned up different SilentIteration impls", "committedDate": "2020-03-03T07:36:09Z", "type": "forcePushed"}]}