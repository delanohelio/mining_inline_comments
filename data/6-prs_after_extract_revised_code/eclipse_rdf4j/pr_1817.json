{"pr_number": 1817, "pr_title": "GH-1816: improve (external) SERVICE evaluation in FedX engine", "pr_createdAt": "2020-01-06T20:14:46Z", "pr_url": "https://github.com/eclipse/rdf4j/pull/1817", "timeline": [{"oid": "da583d4583ba785ba61142693cbec0bb6d00d31d", "url": "https://github.com/eclipse/rdf4j/commit/da583d4583ba785ba61142693cbec0bb6d00d31d", "message": "GH-1816: improve (external) SERVICE evaluation in FedX engine\n\nThis change improves and fixes the evaluation of (external) SERVICE\nclauses in FedX.\n\nBefore this change there have been issues with blocking behavior and and\nhanging queries, when SERVICE queries were evaluated as bound joins. As\nthis was not the default, it was not yet discovered. The reason was that\nHTTP slots in the background tuple results were not processed in a\nsuitable order.\n\nAs of this change we slightly adopted the evaluation logics: now we\nbasically \"touch\" the background tuple result, thus process it in order.\n\nAlso the Bound Join evaluation is now activated by default.\n\nMoreover, a slight follow up of #1802 is added: the boundJoinBlockSize\nis no longer hard-coded in the RepositoryFederatedService, but now uses\nthe value from the field.", "committedDate": "2020-01-06T20:18:55Z", "type": "forcePushed"}, {"oid": "6757189b34676819e0c07f9bd721e6eac0497e81", "url": "https://github.com/eclipse/rdf4j/commit/6757189b34676819e0c07f9bd721e6eac0497e81", "message": "GH-1816: always evaluate query in FedX if it contains SERVICE\n\nIf a query contains a SERVICE clause, it is now always evaluated in the\nFedX engine (even if the federation onyl has a single member)", "committedDate": "2020-01-06T21:24:35Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzYzNzI3OA==", "url": "https://github.com/eclipse/rdf4j/pull/1817#discussion_r363637278", "bodyText": "This is nitpicky but we have a style agreement to always use curly braces for if-then-else clauses, even if they're single line.", "author": "jeenbroekstra", "createdAt": "2020-01-07T08:29:54Z", "path": "tools/federation/src/main/java/org/eclipse/rdf4j/federated/evaluation/FederationEvalStrategy.java", "diffHunk": "@@ -516,8 +519,23 @@ protected void optimizeJoinOrder(TupleExpr query, QueryInfo queryInfo, GenericIn\n \tpublic CloseableIteration<BindingSet, QueryEvaluationException> evaluateService(FedXService service,\n \t\t\tfinal List<BindingSet> bindings) throws QueryEvaluationException {\n \n-\t\treturn new ServiceJoinIterator(new CollectionIteration<>(bindings),\n-\t\t\t\tservice.getService(), EmptyBindingSet.getInstance(), this);\n+\t\tVar serviceRef = service.getService().getServiceRef();\n+\t\tString serviceUri;\n+\t\tif (serviceRef.hasValue())\n+\t\t\tserviceUri = serviceRef.getValue().stringValue();", "originalCommit": "6757189b34676819e0c07f9bd721e6eac0497e81", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzY5NjQyNA==", "url": "https://github.com/eclipse/rdf4j/pull/1817#discussion_r363696424", "bodyText": "I fully agree, must have missed this. Will amend the change and add the brackets. Thanks", "author": "aschwarte10", "createdAt": "2020-01-07T11:00:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzYzNzI3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzY5OTAwMg==", "url": "https://github.com/eclipse/rdf4j/pull/1817#discussion_r363699002", "bodyText": "Added this to the first commit. No other changes added", "author": "aschwarte10", "createdAt": "2020-01-07T11:07:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzYzNzI3OA=="}], "type": "inlineReview", "revised_code": {"commit": "460b837cb236672f6cf38b7d6af17e65feb3ced5", "chunk": "diff --git a/tools/federation/src/main/java/org/eclipse/rdf4j/federated/evaluation/FederationEvalStrategy.java b/tools/federation/src/main/java/org/eclipse/rdf4j/federated/evaluation/FederationEvalStrategy.java\nindex 503a1f9d7d..de902c5bc6 100644\n--- a/tools/federation/src/main/java/org/eclipse/rdf4j/federated/evaluation/FederationEvalStrategy.java\n+++ b/tools/federation/src/main/java/org/eclipse/rdf4j/federated/evaluation/FederationEvalStrategy.java\n\n@@ -521,9 +521,9 @@ public abstract class FederationEvalStrategy extends StrictEvaluationStrategy {\n \n \t\tVar serviceRef = service.getService().getServiceRef();\n \t\tString serviceUri;\n-\t\tif (serviceRef.hasValue())\n+\t\tif (serviceRef.hasValue()) {\n \t\t\tserviceUri = serviceRef.getValue().stringValue();\n-\t\telse {\n+\t\t} else {\n \t\t\treturn new ServiceJoinIterator(new CollectionIteration<>(bindings),\n \t\t\t\t\tservice.getService(), EmptyBindingSet.getInstance(), this);\n \t\t}\n"}}, {"oid": "460b837cb236672f6cf38b7d6af17e65feb3ced5", "url": "https://github.com/eclipse/rdf4j/commit/460b837cb236672f6cf38b7d6af17e65feb3ced5", "message": "GH-1816: improve (external) SERVICE evaluation in FedX engine\n\nThis change improves and fixes the evaluation of (external) SERVICE\nclauses in FedX.\n\nBefore this change there have been issues with blocking behavior and and\nhanging queries, when SERVICE queries were evaluated as bound joins. As\nthis was not the default, it was not yet discovered. The reason was that\nHTTP slots in the background tuple results were not processed in a\nsuitable order.\n\nAs of this change we slightly adopted the evaluation logics: now we\nbasically consume the background tuple result and keep it in memory for\nupcoming operators, thus process it in order.\n\nAlso the Bound Join evaluation is now activated by default.\n\nMoreover, a slight follow up of #1802 is added: the boundJoinBlockSize\nis no longer hard-coded in the RepositoryFederatedService, but now uses\nthe value from the field.", "committedDate": "2020-01-07T11:06:13Z", "type": "commit"}, {"oid": "a115bbb58dd6a2d641d855daa8ed354b135b43c3", "url": "https://github.com/eclipse/rdf4j/commit/a115bbb58dd6a2d641d855daa8ed354b135b43c3", "message": "GH-1816: always evaluate query in FedX if it contains SERVICE\n\nIf a query contains a SERVICE clause, it is now always evaluated in the\nFedX engine (even if the federation onyl has a single member)", "committedDate": "2020-01-07T11:06:14Z", "type": "commit"}, {"oid": "a115bbb58dd6a2d641d855daa8ed354b135b43c3", "url": "https://github.com/eclipse/rdf4j/commit/a115bbb58dd6a2d641d855daa8ed354b135b43c3", "message": "GH-1816: always evaluate query in FedX if it contains SERVICE\n\nIf a query contains a SERVICE clause, it is now always evaluated in the\nFedX engine (even if the federation onyl has a single member)", "committedDate": "2020-01-07T11:06:14Z", "type": "forcePushed"}]}