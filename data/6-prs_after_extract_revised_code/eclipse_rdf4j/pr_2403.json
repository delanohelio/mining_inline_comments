{"pr_number": 2403, "pr_title": "GH-2187 keep parent reference in querymodelnode consistent", "pr_createdAt": "2020-07-29T09:24:01Z", "pr_url": "https://github.com/eclipse/rdf4j/pull/2403", "timeline": [{"oid": "7f0604cdcdf66a25ab1540c7378c1cd145048374", "url": "https://github.com/eclipse/rdf4j/commit/7f0604cdcdf66a25ab1540c7378c1cd145048374", "message": "good point to debug\n\nSigned-off-by: Ha\u030avard Ottestad <hmottestad@gmail.com>", "committedDate": "2020-07-29T09:27:08Z", "type": "forcePushed"}, {"oid": "cf0aaa360518fb23fa492d49c6a50eef1f985800", "url": "https://github.com/eclipse/rdf4j/commit/cf0aaa360518fb23fa492d49c6a50eef1f985800", "message": "good point to debug\n\nSigned-off-by: Ha\u030avard Ottestad <hmottestad@gmail.com>", "committedDate": "2021-04-13T05:21:02Z", "type": "forcePushed"}, {"oid": "1dec6eaaa25376481dd79632924a2e27644ef0c8", "url": "https://github.com/eclipse/rdf4j/commit/1dec6eaaa25376481dd79632924a2e27644ef0c8", "message": "GH-2187 code cleanup and turn temp test into proper test", "committedDate": "2021-04-15T00:43:47Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNDU2MTg2MQ==", "url": "https://github.com/eclipse/rdf4j/pull/2403#discussion_r614561861", "bodyText": "I would have been ok with you deleting this test, but it's nice of you to turn it into a functional test.", "author": "hmottestad", "createdAt": "2021-04-16T05:05:07Z", "path": "core/sail/memory/src/test/java/org/eclipse/rdf4j/sail/memory/QueryPlanRetrievalTest.java", "diffHunk": "@@ -873,4 +873,38 @@ public void testDotTimed() {\n \n \t}\n \n+\t@Test\n+\tpublic void testArbitraryLengthPath() {", "originalCommit": "1dec6eaaa25376481dd79632924a2e27644ef0c8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNDU2ODYyNw==", "url": "https://github.com/eclipse/rdf4j/pull/2403#discussion_r614568627", "bodyText": "It's still a useful test to have in place, making sure that the expected explanation is actually produced.", "author": "jeenbroekstra", "createdAt": "2021-04-16T05:27:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNDU2MTg2MQ=="}], "type": "inlineReview", "revised_code": {"commit": "76861e03c149c1f1416e6dba382e3ffd49555a48", "chunk": "diff --git a/core/sail/memory/src/test/java/org/eclipse/rdf4j/sail/memory/QueryPlanRetrievalTest.java b/core/sail/memory/src/test/java/org/eclipse/rdf4j/sail/memory/QueryPlanRetrievalTest.java\nindex 3cb6ebe313..291f514d1f 100644\n--- a/core/sail/memory/src/test/java/org/eclipse/rdf4j/sail/memory/QueryPlanRetrievalTest.java\n+++ b/core/sail/memory/src/test/java/org/eclipse/rdf4j/sail/memory/QueryPlanRetrievalTest.java\n\n@@ -874,26 +874,7 @@ public class QueryPlanRetrievalTest {\n \t}\n \n \t@Test\n-\tpublic void testArbitraryLengthPath() {\n-\n-\t\tString expected = \"Projection\\n\"\n-\t\t\t\t+ \"\u2560\u2550\u2550ProjectionElemList\\n\"\n-\t\t\t\t+ \"\u2551     ProjectionElem \\\"a\\\"\\n\"\n-\t\t\t\t+ \"\u2551     ProjectionElem \\\"b\\\"\\n\"\n-\t\t\t\t+ \"\u2551     ProjectionElem \\\"c\\\"\\n\"\n-\t\t\t\t+ \"\u2551     ProjectionElem \\\"d\\\"\\n\"\n-\t\t\t\t+ \"\u255a\u2550\u2550Join (JoinIterator)\\n\"\n-\t\t\t\t+ \"   \u251c\u2500\u2500StatementPattern (costEstimate=6, resultSizeEstimate=12)\\n\"\n-\t\t\t\t+ \"   \u2502     Var (name=a)\\n\"\n-\t\t\t\t+ \"   \u2502     Var (name=b)\\n\"\n-\t\t\t\t+ \"   \u2502     Var (name=c)\\n\"\n-\t\t\t\t+ \"   \u2514\u2500\u2500ArbitraryLengthPath (costEstimate=5, resultSizeEstimate=24)\\n\"\n-\t\t\t\t+ \"         Var (name=c)\\n\"\n-\t\t\t\t+ \"         StatementPattern (resultSizeEstimate=0)\\n\"\n-\t\t\t\t+ \"            Var (name=c)\\n\"\n-\t\t\t\t+ \"            Var (name=_const_f804988f_uri, value=http://a, anonymous)\\n\"\n-\t\t\t\t+ \"            Var (name=d)\\n\"\n-\t\t\t\t+ \"         Var (name=d)\\n\";\n+\tpublic void temp() {\n \t\tSailRepository sailRepository = new SailRepository(new MemoryStore());\n \t\taddData(sailRepository);\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNDU2MjYxOQ==", "url": "https://github.com/eclipse/rdf4j/pull/2403#discussion_r614562619", "bodyText": "What was the reason you added this? Did you see any cycles in query plan?", "author": "hmottestad", "createdAt": "2021-04-16T05:07:36Z", "path": "core/queryalgebra/model/src/main/java/org/eclipse/rdf4j/query/algebra/helpers/QueryModelTreeToGenericPlanNode.java", "diffHunk": "@@ -35,10 +37,11 @@ public GenericPlanNode getGenericPlanNode() {\n \t\treturn top;\n \t}\n \n-\t// node.getParentNode() is not reliable because nodes are reused and parent is not maintained! This is why we use a\n-\t// queue to maintain the effective parent stack.\n \t@Override\n \tprotected void meetNode(QueryModelNode node) {\n+\t\tassert !visited.containsKey(node);\n+\t\tvisited.put(node, node);", "originalCommit": "1dec6eaaa25376481dd79632924a2e27644ef0c8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNDU2NTIyNg==", "url": "https://github.com/eclipse/rdf4j/pull/2403#discussion_r614565226", "bodyText": "This is something you added, I think. I assumed it was necessary, but was this part of the throwaway test code as well?", "author": "jeenbroekstra", "createdAt": "2021-04-16T05:16:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNDU2MjYxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNDU2NTM2Nw==", "url": "https://github.com/eclipse/rdf4j/pull/2403#discussion_r614565367", "bodyText": "Yeah. It was.", "author": "hmottestad", "createdAt": "2021-04-16T05:16:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNDU2MjYxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNDU2NTk5Mg==", "url": "https://github.com/eclipse/rdf4j/pull/2403#discussion_r614565992", "bodyText": "I intended for you to just revert my commits when you had figured out how to test the issue properly and how to fix it.", "author": "hmottestad", "createdAt": "2021-04-16T05:18:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNDU2MjYxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNDU2Njk2MA==", "url": "https://github.com/eclipse/rdf4j/pull/2403#discussion_r614566960", "bodyText": "I'll take it out. See, this is why I don't like throwaway code. It has a nast habit of sticking around.", "author": "jeenbroekstra", "createdAt": "2021-04-16T05:22:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNDU2MjYxOQ=="}], "type": "inlineReview", "revised_code": {"commit": "76861e03c149c1f1416e6dba382e3ffd49555a48", "chunk": "diff --git a/core/queryalgebra/model/src/main/java/org/eclipse/rdf4j/query/algebra/helpers/QueryModelTreeToGenericPlanNode.java b/core/queryalgebra/model/src/main/java/org/eclipse/rdf4j/query/algebra/helpers/QueryModelTreeToGenericPlanNode.java\nindex 32a3e28d43..0f7288070e 100644\n--- a/core/queryalgebra/model/src/main/java/org/eclipse/rdf4j/query/algebra/helpers/QueryModelTreeToGenericPlanNode.java\n+++ b/core/queryalgebra/model/src/main/java/org/eclipse/rdf4j/query/algebra/helpers/QueryModelTreeToGenericPlanNode.java\n\n@@ -37,6 +38,8 @@ public class QueryModelTreeToGenericPlanNode extends AbstractQueryModelVisitor<R\n \t\treturn top;\n \t}\n \n+\t// node.getParentNode() is not reliable because nodes are reused and parent is not maintained! This is why we use a\n+\t// queue to maintain the effective parent stack.\n \t@Override\n \tprotected void meetNode(QueryModelNode node) {\n \t\tassert !visited.containsKey(node);\n"}}, {"oid": "76861e03c149c1f1416e6dba382e3ffd49555a48", "url": "https://github.com/eclipse/rdf4j/commit/76861e03c149c1f1416e6dba382e3ffd49555a48", "message": "GH-2187 added temporary test code for parent issue\n\nSigned-off-by: Ha\u030avard Ottestad <hmottestad@gmail.com>", "committedDate": "2021-04-16T05:30:01Z", "type": "commit"}, {"oid": "5bf2cb1676cebca008a2eb3ff8efaf3ce40af3b8", "url": "https://github.com/eclipse/rdf4j/commit/5bf2cb1676cebca008a2eb3ff8efaf3ce40af3b8", "message": "GH-2187 fix uncloned reuse of variables in algebra evaluation", "committedDate": "2021-04-16T05:30:01Z", "type": "commit"}, {"oid": "d43ed4bfe1bfb192c8ecfb49d5989af2e3b718f0", "url": "https://github.com/eclipse/rdf4j/commit/d43ed4bfe1bfb192c8ecfb49d5989af2e3b718f0", "message": "GH-2187 clone vars when creating new statement pattern\n\n- this makes sure parent node references do not become inconsistent", "committedDate": "2021-04-16T05:30:02Z", "type": "commit"}, {"oid": "10d95d0953e72b4dfd8dfdebdec626196670dc28", "url": "https://github.com/eclipse/rdf4j/commit/10d95d0953e72b4dfd8dfdebdec626196670dc28", "message": "GH-2187 make sure parent references are consistent at end of optimization", "committedDate": "2021-04-16T05:30:02Z", "type": "commit"}, {"oid": "c5013e84fd4485c131a4f821fdb97ff7c14916a4", "url": "https://github.com/eclipse/rdf4j/commit/c5013e84fd4485c131a4f821fdb97ff7c14916a4", "message": "GH-2187 basic tree consistency tests for all standard optimizers", "committedDate": "2021-04-16T05:30:02Z", "type": "commit"}, {"oid": "c5013e84fd4485c131a4f821fdb97ff7c14916a4", "url": "https://github.com/eclipse/rdf4j/commit/c5013e84fd4485c131a4f821fdb97ff7c14916a4", "message": "GH-2187 basic tree consistency tests for all standard optimizers", "committedDate": "2021-04-16T05:30:02Z", "type": "forcePushed"}]}