{"pr_number": 3680, "pr_title": "Export link to this process the first time you export", "pr_createdAt": "2020-05-22T08:57:00Z", "pr_url": "https://github.com/kitodo/kitodo-production/pull/3680", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDIyNjE3MQ==", "url": "https://github.com/kitodo/kitodo-production/pull/3680#discussion_r430226171", "bodyText": "A save to DB is missing here (and above in ExportDms).\nPlease adjust ExportMetsIT to test reload from DB.", "author": "Kathrin-Huber", "createdAt": "2020-05-26T08:00:05Z", "path": "Kitodo/src/main/java/org/kitodo/export/ExportMets.java", "diffHunk": "@@ -63,12 +63,15 @@\n     public void startExport(Process process) throws IOException, DAOException {\n         User user = ServiceManager.getUserService().getAuthenticatedUser();\n         URI userHome = ServiceManager.getUserService().getHomeDirectory(user);\n+        boolean exported = process.isExported();\n+        process.setExported(true);\n         boolean exportSucessfull = startExport(process, userHome);\n         if (exportSucessfull) {\n-            process.setExported(true);\n-        }\n-        if (Objects.nonNull(process.getParent())) {\n-            startExport(process.getParent());\n+            if (Objects.nonNull(process.getParent())) {\n+                startExport(process.getParent());\n+            }\n+        } else {\n+            process.setExported(exported);", "originalCommit": "628461e92e6e22c84773df1ff3d5e1e5d0ca94c6", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8310eea51dd1365f951695a8a48f9b1c7a68bf87", "chunk": "diff --git a/Kitodo/src/main/java/org/kitodo/export/ExportMets.java b/Kitodo/src/main/java/org/kitodo/export/ExportMets.java\nindex d31e7cce7..8d0220a41 100644\n--- a/Kitodo/src/main/java/org/kitodo/export/ExportMets.java\n+++ b/Kitodo/src/main/java/org/kitodo/export/ExportMets.java\n\n@@ -60,18 +61,14 @@ public class ExportMets {\n      * @param process\n      *            Process object\n      */\n-    public void startExport(Process process) throws IOException, DAOException {\n+    public void startExport(Process process) throws DAOException, DataException, IOException {\n         User user = ServiceManager.getUserService().getAuthenticatedUser();\n         URI userHome = ServiceManager.getUserService().getHomeDirectory(user);\n-        boolean exported = process.isExported();\n-        process.setExported(true);\n         boolean exportSucessfull = startExport(process, userHome);\n         if (exportSucessfull) {\n             if (Objects.nonNull(process.getParent())) {\n                 startExport(process.getParent());\n             }\n-        } else {\n-            process.setExported(exported);\n         }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQ5ODc0Ng==", "url": "https://github.com/kitodo/kitodo-production/pull/3680#discussion_r436498746", "bodyText": "You are just removing Asserts here?\nAre they not working? Or should they be negated?\nBoth Asserts seems to be valid.", "author": "Kathrin-Huber", "createdAt": "2020-06-08T07:17:57Z", "path": "Kitodo/src/test/java/org/kitodo/production/exporter/download/ExportMetsIT.java", "diffHunk": "@@ -100,7 +100,6 @@ public void exportMetsTest() throws Exception {\n             fileService.createDirectory(ConfigCore.getUriParameter(ParameterCore.DIR_USERS), userDirectory);\n         }\n \n-        Assert.assertFalse(\"exportedFlag of process should be false\", process.isExported());", "originalCommit": "5ddb192bc4f3107b4cd84e48c371e0299bafc670", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjUzOTM5Mg==", "url": "https://github.com/kitodo/kitodo-production/pull/3680#discussion_r436539392", "bodyText": "They don't work anymore because I changed it, and I think it should be like this: The exported flag should only be set when exported to DMS, but not if an export to the home directory is carried out. The flag should not be set when exporting to the home directory, isn\u2019t it? That's why I removed the tests for it, too.", "author": "matthias-ronge", "createdAt": "2020-06-08T08:39:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQ5ODc0Ng=="}], "type": "inlineReview", "revised_code": {"commit": "f279cc75c977aafb67e8554eb0bdedea2341b12b", "chunk": "diff --git a/Kitodo/src/test/java/org/kitodo/production/exporter/download/ExportMetsIT.java b/Kitodo/src/test/java/org/kitodo/production/exporter/download/ExportMetsIT.java\nindex 59967265f..ee268e867 100644\n--- a/Kitodo/src/test/java/org/kitodo/production/exporter/download/ExportMetsIT.java\n+++ b/Kitodo/src/test/java/org/kitodo/production/exporter/download/ExportMetsIT.java\n\n@@ -100,6 +100,7 @@ public class ExportMetsIT {\n             fileService.createDirectory(ConfigCore.getUriParameter(ParameterCore.DIR_USERS), userDirectory);\n         }\n \n+        Assert.assertFalse(\"exportedFlag of process should be false\", process.isExported());\n         exportMets.startExport(process);\n         List<String> strings = Files.readAllLines(Paths.get(ConfigCore.getParameter(ParameterCore.DIR_USERS) + userDirectory\n                 + \"/\" + Helper.getNormalizedTitle(process.getTitle()) + \"_mets.xml\"));\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjUwNDk1OA==", "url": "https://github.com/kitodo/kitodo-production/pull/3680#discussion_r436504958", "bodyText": "Is there a reason to save the process, when the process flagis not changed again? I think this save is only neccessary when export failed and exportflag changed back. It is indeed only neccessary if the flag ACTUALLY changed. This also counts for first save. So if the process is already exported, no save is needed at all", "author": "Kathrin-Huber", "createdAt": "2020-06-08T07:32:07Z", "path": "Kitodo/src/main/java/org/kitodo/export/ExportDms.java", "diffHunk": "@@ -69,14 +70,19 @@ public ExportDms(boolean exportImages) {\n      *            Process object\n      */\n     @Override\n-    public void startExport(Process process) throws IOException, DAOException {\n+    public void startExport(Process process) throws DAOException, DataException, IOException {\n+        boolean exported = process.isExported();\n+        process.setExported(true);\n+        ServiceManager.getProcessService().save(process);\n         boolean exportSucessfull = startExport(process, (URI) null);\n         if (exportSucessfull) {\n-            process.setExported(true);\n-        }\n-        if (Objects.nonNull(process.getParent())) {\n-            startExport(process.getParent());\n+            if (Objects.nonNull(process.getParent())) {\n+                startExport(process.getParent());\n+            }\n+        } else {\n+            process.setExported(exported);\n         }\n+        ServiceManager.getProcessService().save(process);", "originalCommit": "5ddb192bc4f3107b4cd84e48c371e0299bafc670", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f279cc75c977aafb67e8554eb0bdedea2341b12b", "chunk": "diff --git a/Kitodo/src/main/java/org/kitodo/export/ExportDms.java b/Kitodo/src/main/java/org/kitodo/export/ExportDms.java\nindex 20827e1f5..f87ee2287 100644\n--- a/Kitodo/src/main/java/org/kitodo/export/ExportDms.java\n+++ b/Kitodo/src/main/java/org/kitodo/export/ExportDms.java\n\n@@ -70,10 +68,9 @@ public class ExportDms extends ExportMets {\n      *            Process object\n      */\n     @Override\n-    public void startExport(Process process) throws DAOException, DataException, IOException {\n+    public void startExport(Process process) throws IOException, DAOException {\n         boolean exported = process.isExported();\n         process.setExported(true);\n-        ServiceManager.getProcessService().save(process);\n         boolean exportSucessfull = startExport(process, (URI) null);\n         if (exportSucessfull) {\n             if (Objects.nonNull(process.getParent())) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjUwNTM1Nw==", "url": "https://github.com/kitodo/kitodo-production/pull/3680#discussion_r436505357", "bodyText": "DAOException and IOExceotion are never thrown in this method. So if you are already changing the signatur, remove not needed exceptions.", "author": "Kathrin-Huber", "createdAt": "2020-06-08T07:33:00Z", "path": "Kitodo/src/main/java/org/kitodo/export/ExportDms.java", "diffHunk": "@@ -69,14 +70,19 @@ public ExportDms(boolean exportImages) {\n      *            Process object\n      */\n     @Override\n-    public void startExport(Process process) throws IOException, DAOException {\n+    public void startExport(Process process) throws DAOException, DataException, IOException {", "originalCommit": "5ddb192bc4f3107b4cd84e48c371e0299bafc670", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f279cc75c977aafb67e8554eb0bdedea2341b12b", "chunk": "diff --git a/Kitodo/src/main/java/org/kitodo/export/ExportDms.java b/Kitodo/src/main/java/org/kitodo/export/ExportDms.java\nindex 20827e1f5..f87ee2287 100644\n--- a/Kitodo/src/main/java/org/kitodo/export/ExportDms.java\n+++ b/Kitodo/src/main/java/org/kitodo/export/ExportDms.java\n\n@@ -70,10 +68,9 @@ public class ExportDms extends ExportMets {\n      *            Process object\n      */\n     @Override\n-    public void startExport(Process process) throws DAOException, DataException, IOException {\n+    public void startExport(Process process) throws IOException, DAOException {\n         boolean exported = process.isExported();\n         process.setExported(true);\n-        ServiceManager.getProcessService().save(process);\n         boolean exportSucessfull = startExport(process, (URI) null);\n         if (exportSucessfull) {\n             if (Objects.nonNull(process.getParent())) {\n"}}, {"oid": "f279cc75c977aafb67e8554eb0bdedea2341b12b", "url": "https://github.com/kitodo/kitodo-production/commit/f279cc75c977aafb67e8554eb0bdedea2341b12b", "message": "Export link to this process the first time you export\n\nFixes #3623, fixes #3625, fixes #3633", "committedDate": "2020-06-09T08:16:26Z", "type": "commit"}, {"oid": "8310eea51dd1365f951695a8a48f9b1c7a68bf87", "url": "https://github.com/kitodo/kitodo-production/commit/8310eea51dd1365f951695a8a48f9b1c7a68bf87", "message": "Save process status in export; don\u2019t set 'exported' on METS-only write", "committedDate": "2020-06-09T08:16:26Z", "type": "commit"}, {"oid": "6be263e51ef65408c84eedaf194eb37f83d3b420", "url": "https://github.com/kitodo/kitodo-production/commit/6be263e51ef65408c84eedaf194eb37f83d3b420", "message": "Catch the exception", "committedDate": "2020-06-09T08:16:26Z", "type": "commit"}, {"oid": "3c63563131b5135d00f5a65928eaf9c391cbb260", "url": "https://github.com/kitodo/kitodo-production/commit/3c63563131b5135d00f5a65928eaf9c391cbb260", "message": "Update ExportMetsIT.java", "committedDate": "2020-06-09T08:16:26Z", "type": "commit"}, {"oid": "a732846ddf68a72c48eb3497bff04de64cc0719f", "url": "https://github.com/kitodo/kitodo-production/commit/a732846ddf68a72c48eb3497bff04de64cc0719f", "message": "Only save the export status if there is an actual change", "committedDate": "2020-06-09T08:16:26Z", "type": "commit"}, {"oid": "24e96ff2c0282f87380f524fae6fddef2e332060", "url": "https://github.com/kitodo/kitodo-production/commit/24e96ff2c0282f87380f524fae6fddef2e332060", "message": "Not declare exceptions that only the superclass throws", "committedDate": "2020-06-09T08:16:26Z", "type": "commit"}, {"oid": "34fc98c87522e635e56d7da3083bc2b02c816d5c", "url": "https://github.com/kitodo/kitodo-production/commit/34fc98c87522e635e56d7da3083bc2b02c816d5c", "message": "Remove catching exceptions that are not thrown", "committedDate": "2020-06-09T08:48:08Z", "type": "commit"}, {"oid": "34fc98c87522e635e56d7da3083bc2b02c816d5c", "url": "https://github.com/kitodo/kitodo-production/commit/34fc98c87522e635e56d7da3083bc2b02c816d5c", "message": "Remove catching exceptions that are not thrown", "committedDate": "2020-06-09T08:48:08Z", "type": "forcePushed"}]}