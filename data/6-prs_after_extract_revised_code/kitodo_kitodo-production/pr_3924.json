{"pr_number": 3924, "pr_title": "Automatically assign media units to the effective root element", "pr_createdAt": "2020-08-11T15:35:19Z", "pr_url": "https://github.com/kitodo/kitodo-production/pull/3924", "timeline": [{"oid": "0101a9dc268bd04bc1cfb0e8205db4c6196f77d4", "url": "https://github.com/kitodo/kitodo-production/commit/0101a9dc268bd04bc1cfb0e8205db4c6196f77d4", "message": "Automatically assign media units to the effective root element", "committedDate": "2020-08-11T15:40:56Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTI5ODQ5MQ==", "url": "https://github.com/kitodo/kitodo-production/pull/3924#discussion_r471298491", "bodyText": "Please give a more descriptive name", "author": "Kathrin-Huber", "createdAt": "2020-08-17T07:42:16Z", "path": "Kitodo-API/src/main/java/org/kitodo/api/dataformat/View.java", "diffHunk": "@@ -20,6 +20,20 @@\n  * {@code MediaUnit} as a whole.\n  */\n public class View {\n+\n+    /**\n+     * Creates a new view with a media unit.\n+     * \n+     * @param mediaUnit\n+     *            media unit to set in the view\n+     * @return a new view with a media unit\n+     */\n+    public static View of(MediaUnit mediaUnit) {", "originalCommit": "0101a9dc268bd04bc1cfb0e8205db4c6196f77d4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQ1MDM0Ng==", "url": "https://github.com/kitodo/kitodo-production/pull/3924#discussion_r471450346", "bodyText": "This is a common pattern, as you find it in Optional<T> Optional.of(T value), Pair<L, R> Pair.of(L left, R right), Stream<T> Stream.of(T t) or LocalDate.of(int year, int month, int dayOfMonth). If you don\u2019t like it, please suggest a better one.", "author": "matthias-ronge", "createdAt": "2020-08-17T12:40:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTI5ODQ5MQ=="}], "type": "inlineReview", "revised_code": {"commit": "7fe9476c1e2fe33a67ca819400045a3d99b4d717", "chunk": "diff --git a/Kitodo-API/src/main/java/org/kitodo/api/dataformat/View.java b/Kitodo-API/src/main/java/org/kitodo/api/dataformat/View.java\nindex cfb8a74d7..65880acfe 100644\n--- a/Kitodo-API/src/main/java/org/kitodo/api/dataformat/View.java\n+++ b/Kitodo-API/src/main/java/org/kitodo/api/dataformat/View.java\n\n@@ -20,20 +20,6 @@ import java.util.Objects;\n  * {@code MediaUnit} as a whole.\n  */\n public class View {\n-\n-    /**\n-     * Creates a new view with a media unit.\n-     * \n-     * @param mediaUnit\n-     *            media unit to set in the view\n-     * @return a new view with a media unit\n-     */\n-    public static View of(MediaUnit mediaUnit) {\n-        View view = new View();\n-        view.setMediaUnit(mediaUnit);\n-        return view;\n-    }\n-\n     /**\n      * Media unit in view.\n      */\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTI5ODgwNw==", "url": "https://github.com/kitodo/kitodo-production/pull/3924#discussion_r471298807", "bodyText": "why \"automatically\" ? Please remove this prefix", "author": "Kathrin-Huber", "createdAt": "2020-08-17T07:43:00Z", "path": "Kitodo/src/main/java/org/kitodo/production/services/file/FileService.java", "diffHunk": "@@ -1017,18 +1018,34 @@ public void searchForMedia(Process process, Workpiece workpiece) throws InvalidI\n         }\n         List<String> canonicals = getCanonicalFileNamePartsAndSanitizeAbsoluteURIs(workpiece, subfolders,\n             process.getProcessBaseUri());\n-        addNewURIsToExistingMediaUnits(mediaToAdd, workpiece.getAllMediaUnitsSorted(), canonicals);\n+        addNewURIsToExistingMediaUnits(mediaToAdd, workpiece.getAllMediaUnitsFilteredByTypePageAndSorted(), canonicals);\n         mediaToAdd.keySet().removeAll(canonicals);\n         addNewMediaToWorkpiece(canonicals, mediaToAdd, workpiece);\n         renumberMediaUnits(workpiece, true);\n         if (ConfigCore.getBooleanParameter(ParameterCore.WITH_AUTOMATIC_PAGINATION)) {\n             repaginateMediaUnits(workpiece);\n         }\n+        if (Workpiece.treeStream(workpiece.getRootElement())\n+                .allMatch(includedStructuralElement -> includedStructuralElement.getViews().isEmpty())) {\n+            automaticallyAssignMediaUnitsToEffectiveRootRecursive(workpiece, workpiece.getRootElement());\n+        }\n         if (logger.isTraceEnabled()) {\n             logger.trace(\"Searching for media took {} ms\", TimeUnit.NANOSECONDS.toMillis(System.nanoTime() - begin));\n         }\n     }\n \n+    private void automaticallyAssignMediaUnitsToEffectiveRootRecursive(Workpiece workpiece,", "originalCommit": "0101a9dc268bd04bc1cfb0e8205db4c6196f77d4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQ1MTM5OQ==", "url": "https://github.com/kitodo/kitodo-production/pull/3924#discussion_r471451399", "bodyText": "Automatically, because you no longer have to manually assign it to the included structural element using drag and drop.", "author": "matthias-ronge", "createdAt": "2020-08-17T12:42:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTI5ODgwNw=="}], "type": "inlineReview", "revised_code": {"commit": "7fe9476c1e2fe33a67ca819400045a3d99b4d717", "chunk": "diff --git a/Kitodo/src/main/java/org/kitodo/production/services/file/FileService.java b/Kitodo/src/main/java/org/kitodo/production/services/file/FileService.java\nindex 9dc65a9ca..79e9cbd01 100644\n--- a/Kitodo/src/main/java/org/kitodo/production/services/file/FileService.java\n+++ b/Kitodo/src/main/java/org/kitodo/production/services/file/FileService.java\n\n@@ -1025,27 +1024,11 @@ public class FileService {\n         if (ConfigCore.getBooleanParameter(ParameterCore.WITH_AUTOMATIC_PAGINATION)) {\n             repaginateMediaUnits(workpiece);\n         }\n-        if (Workpiece.treeStream(workpiece.getRootElement())\n-                .allMatch(includedStructuralElement -> includedStructuralElement.getViews().isEmpty())) {\n-            automaticallyAssignMediaUnitsToEffectiveRootRecursive(workpiece, workpiece.getRootElement());\n-        }\n         if (logger.isTraceEnabled()) {\n             logger.trace(\"Searching for media took {} ms\", TimeUnit.NANOSECONDS.toMillis(System.nanoTime() - begin));\n         }\n     }\n \n-    private void automaticallyAssignMediaUnitsToEffectiveRootRecursive(Workpiece workpiece,\n-            IncludedStructuralElement includedStructuralElement) {\n-\n-        if (Objects.nonNull(includedStructuralElement.getType())) {\n-            Workpiece.treeStream(workpiece.getMediaUnit()).filter(mediaUnit -> !mediaUnit.getMediaFiles().isEmpty())\n-                    .map(View::of).forEachOrdered(includedStructuralElement.getViews()::add);\n-        } else if (includedStructuralElement.getChildren().size() == 1) {\n-            automaticallyAssignMediaUnitsToEffectiveRootRecursive(workpiece,\n-                includedStructuralElement.getChildren().get(0));\n-        }\n-    }\n-\n     /**\n      * Parses the canonical part of the filename from the URIs of the media\n      * units. Because we need to do this to be able to parse correctly, old\n"}}, {"oid": "b329b2e7e4701054d63db5f9482929da2b95120c", "url": "https://github.com/kitodo/kitodo-production/commit/b329b2e7e4701054d63db5f9482929da2b95120c", "message": "Automatically assign media units to the effective root element", "committedDate": "2020-08-18T14:48:19Z", "type": "forcePushed"}, {"oid": "7fe9476c1e2fe33a67ca819400045a3d99b4d717", "url": "https://github.com/kitodo/kitodo-production/commit/7fe9476c1e2fe33a67ca819400045a3d99b4d717", "message": "Deduplicate method treeStream() into class Workpiece", "committedDate": "2020-08-19T15:13:46Z", "type": "commit"}, {"oid": "9c77e4b16fb3ccda680641e3031cddf1ab008e31", "url": "https://github.com/kitodo/kitodo-production/commit/9c77e4b16fb3ccda680641e3031cddf1ab008e31", "message": "Deduplicate method treeStream() into class Workpiece", "committedDate": "2020-08-19T15:13:46Z", "type": "commit"}, {"oid": "503e93faf575cb76c7b69e043a905e676933b6f7", "url": "https://github.com/kitodo/kitodo-production/commit/503e93faf575cb76c7b69e043a905e676933b6f7", "message": "Automatically assign media units to the effective root element", "committedDate": "2020-08-19T15:24:29Z", "type": "forcePushed"}, {"oid": "d759ddc2e5f21c303013cdcd59831131ed434f58", "url": "https://github.com/kitodo/kitodo-production/commit/d759ddc2e5f21c303013cdcd59831131ed434f58", "message": "Automatically assign media units to the effective root element", "committedDate": "2020-08-20T14:55:44Z", "type": "commit"}, {"oid": "d759ddc2e5f21c303013cdcd59831131ed434f58", "url": "https://github.com/kitodo/kitodo-production/commit/d759ddc2e5f21c303013cdcd59831131ed434f58", "message": "Automatically assign media units to the effective root element", "committedDate": "2020-08-20T14:55:44Z", "type": "forcePushed"}]}