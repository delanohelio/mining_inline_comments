{"pr_number": 26395, "pr_title": "Enable language and runtime tests which disable with JDK 11 migration", "pr_createdAt": "2020-10-17T09:31:59Z", "pr_url": "https://github.com/ballerina-platform/ballerina-lang/pull/26395", "timeline": [{"oid": "e9b4534a61bdd906132bba0b84d6945d8019e7d9", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/e9b4534a61bdd906132bba0b84d6945d8019e7d9", "message": "Enable language and runtime tests which disable with JDK 11 migration", "committedDate": "2020-10-17T10:09:50Z", "type": "forcePushed"}, {"oid": "048b0c39717c08d9f91e3e6a048a2d007de07f92", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/048b0c39717c08d9f91e3e6a048a2d007de07f92", "message": "Enable language and runtime tests which disable with JDK 11 migration", "committedDate": "2020-10-17T19:13:08Z", "type": "commit"}, {"oid": "048b0c39717c08d9f91e3e6a048a2d007de07f92", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/048b0c39717c08d9f91e3e6a048a2d007de07f92", "message": "Enable language and runtime tests which disable with JDK 11 migration", "committedDate": "2020-10-17T19:13:08Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzUxNTA5Mg==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26395#discussion_r507515092", "bodyText": "This way we're creating two maps, first the mutable one and then the immutable one.\nInstead, shall we use https://github.com/ballerina-platform/ballerina-lang/blob/master/bvm/ballerina-runtime/src/main/java/org/ballerinalang/jvm/values/MapValueImpl.java#L101?\nWe can use https://github.com/ballerina-platform/ballerina-lang/blob/master/bvm/ballerina-runtime/src/main/java/org/ballerinalang/jvm/values/ReadOnlyUtils.java#L72 to get the immutable type and then pass the detail as a KeyValueEntry https://github.com/ballerina-platform/ballerina-lang/blob/master/bvm/ballerina-runtime/src/main/java/org/ballerinalang/jvm/values/MappingInitialValueEntry.java#L39.", "author": "MaryamZi", "createdAt": "2020-10-19T07:01:07Z", "path": "bvm/ballerina-runtime/src/main/java/org/ballerinalang/jvm/api/BErrorCreator.java", "diffHunk": "@@ -60,7 +62,12 @@ public static BError createError(BString message, BString details) {\n         if (details != null) {\n             detailMap.put(ERROR_MESSAGE_FIELD, details);\n         }\n-        return new ErrorValue(message, detailMap);\n+        return new ErrorValue(message, readonlyCloneDetailMap(detailMap));", "originalCommit": "048b0c39717c08d9f91e3e6a048a2d007de07f92", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzUxNjU0MA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26395#discussion_r507516540", "bodyText": "The other helper methods here should also be updated, right? They don't seem to be making the error detail immutable?\nIMO, we should also check on the possibility of making org.ballerinalang.jvm.types.BTypes#typeErrorDetail itself be immutable (i.e., setting the readonly flag). @rdhananjaya, WDYT?", "author": "MaryamZi", "createdAt": "2020-10-19T07:04:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzUxNTA5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzY3MTk4Mw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26395#discussion_r507671983", "bodyText": "Agreed org.ballerinalang.jvm.types.BTypes#typeErrorDetail should also be the readonly varient.", "author": "rdhananjaya", "createdAt": "2020-10-19T11:28:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzUxNTA5Mg=="}], "type": "inlineReview", "revised_code": {"commit": "2f25baac5042bdd050954de0cb2bdf3d1b830ff7", "chunk": "diff --git a/bvm/ballerina-runtime/src/main/java/org/ballerinalang/jvm/api/BErrorCreator.java b/bvm/ballerina-runtime/src/main/java/org/ballerinalang/jvm/api/BErrorCreator.java\nindex 7b1e98ce9ce..72d587b2ac9 100644\n--- a/bvm/ballerina-runtime/src/main/java/org/ballerinalang/jvm/api/BErrorCreator.java\n+++ b/bvm/ballerina-runtime/src/main/java/org/ballerinalang/jvm/api/BErrorCreator.java\n\n@@ -58,16 +57,12 @@ public class BErrorCreator {\n      * @return new error.\n      */\n     public static BError createError(BString message, BString details) {\n-        MapValueImpl<BString, Object> detailMap = new MapValueImpl<>(BTypes.typeErrorDetail);\n+        MappingInitialValueEntry[] initialValues = new MappingInitialValueEntry[1];\n         if (details != null) {\n-            detailMap.put(ERROR_MESSAGE_FIELD, details);\n+            initialValues[0] = new MappingInitialValueEntry.KeyValueEntry(ERROR_MESSAGE_FIELD, details);\n         }\n-        return new ErrorValue(message, readonlyCloneDetailMap(detailMap));\n-    }\n-\n-    @SuppressWarnings(\"unchecked\")\n-    private static MapValueImpl<BString, Object> readonlyCloneDetailMap(MapValueImpl<BString, Object> detailMap) {\n-        return (MapValueImpl<BString, Object>) detailMap.frozenCopy(new HashMap<>());\n+        MapValueImpl<BString, Object> detailMap = new MapValueImpl(BTypes.typeErrorDetail, initialValues);\n+        return new ErrorValue(message, detailMap);\n     }\n \n     /**\n"}}, {"oid": "2f25baac5042bdd050954de0cb2bdf3d1b830ff7", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/2f25baac5042bdd050954de0cb2bdf3d1b830ff7", "message": "Fix review suggestions", "committedDate": "2020-10-20T04:16:56Z", "type": "commit"}, {"oid": "4b6a51db1216138afe29668674471af5b8d2bf20", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/4b6a51db1216138afe29668674471af5b8d2bf20", "message": "Merge branch 'master' of https://github.com/ballerina-platform/ballerina-lang into issue-26082\n\n\u0001 Conflicts:\n\u0001\tbvm/ballerina-runtime/src/main/java/io/ballerina/runtime/api/ErrorCreator.java\n\u0001\tbvm/ballerina-runtime/src/main/java/org/ballerinalang/jvm/types/BTypes.java", "committedDate": "2020-10-20T04:37:25Z", "type": "commit"}, {"oid": "7a4de85b01edefc66ac1057b0a7d3cd16325bc43", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/7a4de85b01edefc66ac1057b0a7d3cd16325bc43", "message": "Resolve conflicts", "committedDate": "2020-10-20T04:44:24Z", "type": "commit"}, {"oid": "b3d8284aa3a891d04c52f4aa1d98d34c219f110a", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/b3d8284aa3a891d04c52f4aa1d98d34c219f110a", "message": "Merge branch 'master' of https://github.com/ballerina-platform/ballerina-lang into issue-26082\n\n\u0001 Conflicts:\n\u0001\ttests/jballerina-unit-test/src/test/resources/testng.xml", "committedDate": "2020-10-21T08:12:24Z", "type": "commit"}, {"oid": "92f88f1cd2d3495418fd13aa11902941b225ada1", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/92f88f1cd2d3495418fd13aa11902941b225ada1", "message": "Merge branch 'master' of https://github.com/ballerina-platform/ballerina-lang into issue-26082", "committedDate": "2020-10-21T17:01:16Z", "type": "commit"}, {"oid": "361a3e8cafcda2e81e201e6543f5d00fcf615539", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/361a3e8cafcda2e81e201e6543f5d00fcf615539", "message": "Merge branch 'master' of https://github.com/ballerina-platform/ballerina-lang into issue-26082", "committedDate": "2020-10-23T04:56:51Z", "type": "commit"}, {"oid": "4ea87909cedf22d2b5d75e7e5dd3b79de83ffb68", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/4ea87909cedf22d2b5d75e7e5dd3b79de83ffb68", "message": "Set `TYPE_ERROR_DETAIL` as mutable", "committedDate": "2020-10-23T08:08:38Z", "type": "commit"}, {"oid": "245946ee69d6ed964d293e3381cc604b0d7d854e", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/245946ee69d6ed964d293e3381cc604b0d7d854e", "message": "Enable `BirVariableOptimizationTest` and `LangLibValueTest` tests", "committedDate": "2020-10-23T15:11:31Z", "type": "commit"}, {"oid": "da5722bdafb5179a12ca9ab5e90add24ae588176", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/da5722bdafb5179a12ca9ab5e90add24ae588176", "message": "Resolve conflicts", "committedDate": "2020-10-23T15:12:23Z", "type": "commit"}, {"oid": "da5722bdafb5179a12ca9ab5e90add24ae588176", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/da5722bdafb5179a12ca9ab5e90add24ae588176", "message": "Resolve conflicts", "committedDate": "2020-10-23T15:12:23Z", "type": "forcePushed"}, {"oid": "39beae4f34af27691182a54c8510173e3d40c7d6", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/39beae4f34af27691182a54c8510173e3d40c7d6", "message": "Enable `JavaVarargsTest` and `RefTypeTests` tests", "committedDate": "2020-10-26T19:32:55Z", "type": "commit"}, {"oid": "d3ec03efdcbd2542705b8309c6140871128fa567", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/d3ec03efdcbd2542705b8309c6140871128fa567", "message": "Enable `VariableReturnTypeTest` and `FinalAccessTest` tests", "committedDate": "2020-10-27T17:00:42Z", "type": "forcePushed"}, {"oid": "48ecf0f05527d6b39a1a45541b45439e96a2d2bf", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/48ecf0f05527d6b39a1a45541b45439e96a2d2bf", "message": "Enable `VariableReturnTypeTest` and `FunctionSignatureInBaloTest` tests", "committedDate": "2020-10-27T17:04:10Z", "type": "commit"}, {"oid": "48ecf0f05527d6b39a1a45541b45439e96a2d2bf", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/48ecf0f05527d6b39a1a45541b45439e96a2d2bf", "message": "Enable `VariableReturnTypeTest` and `FunctionSignatureInBaloTest` tests", "committedDate": "2020-10-27T17:04:10Z", "type": "forcePushed"}, {"oid": "72ec22d3487b386b85856f6a11134726d7714555", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/72ec22d3487b386b85856f6a11134726d7714555", "message": "Enable `ObjectInBaloTest` tests", "committedDate": "2020-10-29T13:44:02Z", "type": "commit"}, {"oid": "a50358d17a7f107772da4b322c12e4501157062f", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/a50358d17a7f107772da4b322c12e4501157062f", "message": "Fix review suggestions", "committedDate": "2020-10-29T13:44:47Z", "type": "forcePushed"}, {"oid": "fafd350c73843ea02410a1888ed8aef12f9edeb6", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/fafd350c73843ea02410a1888ed8aef12f9edeb6", "message": "Fix review suggestions", "committedDate": "2020-10-29T15:15:48Z", "type": "commit"}, {"oid": "fafd350c73843ea02410a1888ed8aef12f9edeb6", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/fafd350c73843ea02410a1888ed8aef12f9edeb6", "message": "Fix review suggestions", "committedDate": "2020-10-29T15:15:48Z", "type": "forcePushed"}]}