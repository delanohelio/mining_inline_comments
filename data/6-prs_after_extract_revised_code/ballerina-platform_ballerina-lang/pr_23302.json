{"pr_number": 23302, "pr_title": "Implement `table<T> & readonly` and fix several issues with `xml<T> & readonly` ", "pr_createdAt": "2020-05-16T03:14:19Z", "pr_url": "https://github.com/ballerina-platform/ballerina-lang/pull/23302", "timeline": [{"oid": "17f764309e7ac0121ce0ac5942451551f34aae8b", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/17f764309e7ac0121ce0ac5942451551f34aae8b", "message": "Separate out XML attr. setting on creation vs subsequent upate", "committedDate": "2020-05-15T10:33:07Z", "type": "commit"}, {"oid": "761cfee34e674f3c5436ab42a85a0b195bedc99b", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/761cfee34e674f3c5436ab42a85a0b195bedc99b", "message": "Fix attribute map not being created as immutable for immutable elements", "committedDate": "2020-05-15T18:25:53Z", "type": "commit"}, {"oid": "6466a29d6057327a56d1f4b4922d8685aa263f2c", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/6466a29d6057327a56d1f4b4922d8685aa263f2c", "message": "Fix immutability of XML elements with children and add tests", "committedDate": "2020-05-16T02:57:20Z", "type": "commit"}, {"oid": "f181dc7455a7dd49c0e98b41ac54353d725f76bb", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/f181dc7455a7dd49c0e98b41ac54353d725f76bb", "message": "Merge master", "committedDate": "2020-05-17T14:13:15Z", "type": "commit"}, {"oid": "63b6e938d45499c87146b1ed281a6740f9a7f496", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/63b6e938d45499c87146b1ed281a6740f9a7f496", "message": "Implement readonly intersection type for the table type", "committedDate": "2020-05-19T04:20:23Z", "type": "commit"}, {"oid": "79cede70b3b8bafda1ca303da90d42c348e4408e", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/79cede70b3b8bafda1ca303da90d42c348e4408e", "message": "Add tests for readonly table types", "committedDate": "2020-05-19T13:46:27Z", "type": "commit"}, {"oid": "f0a5761b4a745773f29058fadd83a46b1716ec78", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/f0a5761b4a745773f29058fadd83a46b1716ec78", "message": "Add readonly type to type reader", "committedDate": "2020-05-19T13:50:32Z", "type": "commit"}, {"oid": "e4860373eccac0b5361597ba569682fbc4b6fc0e", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/e4860373eccac0b5361597ba569682fbc4b6fc0e", "message": "Fix selectively immutable type check for tables", "committedDate": "2020-05-19T14:40:31Z", "type": "commit"}, {"oid": "2ec6bf8bddc6a84014e2b36b525a323b6a372e93", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/2ec6bf8bddc6a84014e2b36b525a323b6a372e93", "message": "Resolve conflicts and merge master", "committedDate": "2020-05-25T08:43:38Z", "type": "commit"}, {"oid": "2ec6bf8bddc6a84014e2b36b525a323b6a372e93", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/2ec6bf8bddc6a84014e2b36b525a323b6a372e93", "message": "Resolve conflicts and merge master", "committedDate": "2020-05-25T08:43:38Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTYwOTg0OQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/23302#discussion_r431609849", "bodyText": "I think due to line L279 - L281 we don't need a null check on defaultNsUri", "author": "KRVPerera", "createdAt": "2020-05-28T06:32:28Z", "path": "bvm/ballerina-runtime/src/main/java/org/ballerinalang/jvm/XMLFactory.java", "diffHunk": "@@ -284,13 +286,9 @@ public static XMLValue createXMLElement(XMLQName startTagName, String defaultNsU\n \n         if (nsUri == null) {\n             return new XMLItem(new QName(defaultNsUri, startTagName.getLocalName(), prefix), readonly);\n-        } else {\n-            XMLItem xmlItem = new XMLItem(new QName(nsUri, startTagName.getLocalName(), prefix), readonly);\n-            if (defaultNsUri != null && !defaultNsUri.isEmpty()) {\n-                xmlItem.setAttribute(XMLConstants.XMLNS_ATTRIBUTE, null, null, defaultNsUri);\n-            }\n-            return xmlItem;\n         }\n+        return createXMLItemWithDefaultNSAttribute(new QName(nsUri, startTagName.getLocalName(), prefix), readonly,\n+                                                   defaultNsUri);", "originalCommit": "2ec6bf8bddc6a84014e2b36b525a323b6a372e93", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjAyMzAwMw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/23302#discussion_r432023003", "bodyText": "Yeah will change and check.", "author": "MaryamZi", "createdAt": "2020-05-28T18:02:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTYwOTg0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjk1MjAzMg==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/23302#discussion_r432952032", "bodyText": "Updated with 8e8807b.", "author": "MaryamZi", "createdAt": "2020-05-31T14:20:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTYwOTg0OQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTYyMjc0Nw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/23302#discussion_r431622747", "bodyText": "Shouldn't this code be\nif (Symbols.isFlagOn(resultType.flags, Flags.READONLY)) {\n   markChildrenAsImmutable(bLangXMLElementLiteral);\n}", "author": "KRVPerera", "createdAt": "2020-05-28T07:03:18Z", "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/TypeChecker.java", "diffHunk": "@@ -3443,6 +3443,12 @@ public void visit(BLangXMLElementLiteral bLangXMLElementLiteral) {\n \n         resultType = checkXmlSubTypeLiteralCompatibility(bLangXMLElementLiteral.pos, symTable.xmlElementType,\n                                                          this.expType);\n+\n+        if (!Symbols.isFlagOn(resultType.flags, Flags.READONLY)) {", "originalCommit": "2ec6bf8bddc6a84014e2b36b525a323b6a372e93", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjAyMzk5MQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/23302#discussion_r432023991", "bodyText": "Would it make a difference? And I think the common case would be the current check evaluating to true (i.e., mutable result type).", "author": "MaryamZi", "createdAt": "2020-05-28T18:04:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTYyMjc0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM0MDU2OA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/23302#discussion_r432340568", "bodyText": "My opinion is that if lines are separated here, we lose the actual logic we need. Logic is not obvious anymore. Because these two lines are separated someone may put some lines in between in future and decide to return. At that time for some elements, we won't be calling markChildrenAsImmutable.", "author": "KRVPerera", "createdAt": "2020-05-29T08:41:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTYyMjc0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjk1MjEyOQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/23302#discussion_r432952129", "bodyText": "I've updated the logic with 8e8807b since this is a single invocation. But regarding adding lines in between, IMO the logic here is quite straightforward and it is reasonable to expect whoever doing the change to understand the area they are changing when doing the changes.  :) Especially given that we've adopted a similar approach with a significant number of functions.", "author": "MaryamZi", "createdAt": "2020-05-31T14:21:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTYyMjc0Nw=="}], "type": "inlineReview", "revised_code": {"commit": "8e8807bc9cbf4b351105d1f7e5ed107fb6121aaf", "chunk": "diff --git a/compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/TypeChecker.java b/compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/TypeChecker.java\nindex 254cc725ab1..6d10883699a 100644\n--- a/compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/TypeChecker.java\n+++ b/compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/TypeChecker.java\n\n@@ -3444,11 +3445,9 @@ public class TypeChecker extends BLangNodeVisitor {\n         resultType = checkXmlSubTypeLiteralCompatibility(bLangXMLElementLiteral.pos, symTable.xmlElementType,\n                                                          this.expType);\n \n-        if (!Symbols.isFlagOn(resultType.flags, Flags.READONLY)) {\n-            return;\n+        if (Symbols.isFlagOn(resultType.flags, Flags.READONLY)) {\n+            markChildrenAsImmutable(bLangXMLElementLiteral);\n         }\n-\n-        markChildrenAsImmutable(bLangXMLElementLiteral);\n     }\n \n     private boolean isXmlNamespaceAttribute(BLangXMLAttribute attribute) {\n"}}, {"oid": "cddd16074941d5d89fe8f120f8bcc5ad51fcf846", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/cddd16074941d5d89fe8f120f8bcc5ad51fcf846", "message": "Merge master", "committedDate": "2020-05-31T12:04:53Z", "type": "commit"}, {"oid": "8e8807bc9cbf4b351105d1f7e5ed107fb6121aaf", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/8e8807bc9cbf4b351105d1f7e5ed107fb6121aaf", "message": "Address review suggestions", "committedDate": "2020-05-31T14:12:19Z", "type": "commit"}]}