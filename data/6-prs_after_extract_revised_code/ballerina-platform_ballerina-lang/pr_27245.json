{"pr_number": 27245, "pr_title": "Desugar transaction & retry without lambda wrapping", "pr_createdAt": "2020-11-29T18:30:39Z", "pr_url": "https://github.com/ballerina-platform/ballerina-lang/pull/27245", "timeline": [{"oid": "ae1306957114998077a0e76683be94856aaf0d49", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/ae1306957114998077a0e76683be94856aaf0d49", "message": "Desugar trx to statement expr", "committedDate": "2020-11-04T10:46:12Z", "type": "commit"}, {"oid": "40c2278c9559e7bfc377d640502afb2ae742d1d2", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/40c2278c9559e7bfc377d640502afb2ae742d1d2", "message": "Add rollback stmt to onfail", "committedDate": "2020-11-04T11:58:53Z", "type": "commit"}, {"oid": "58bd7b9cd32a3c56e2dd74c31c61ead87d3e680a", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/58bd7b9cd32a3c56e2dd74c31c61ead87d3e680a", "message": "Temperoraly disable retry trx desugar", "committedDate": "2020-11-04T12:01:24Z", "type": "commit"}, {"oid": "312af553cb8bda0a8f645e42295f54b274e6ae46", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/312af553cb8bda0a8f645e42295f54b274e6ae46", "message": "Invoke cleanup within onfail", "committedDate": "2020-11-04T13:42:49Z", "type": "commit"}, {"oid": "f9c77892516a5a20498dc1d65a3697eace6f6f98", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/f9c77892516a5a20498dc1d65a3697eace6f6f98", "message": "Rollback trx during a panic", "committedDate": "2020-11-04T17:05:23Z", "type": "commit"}, {"oid": "883b8c56feb705ab6beb5ce98c523504d2778061", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/883b8c56feb705ab6beb5ce98c523504d2778061", "message": "Add fail statement to nested trx to jump", "committedDate": "2020-11-06T05:44:33Z", "type": "commit"}, {"oid": "7a0e4f836988e7602072b6c2d2634bf3996d0496", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/7a0e4f836988e7602072b6c2d2634bf3996d0496", "message": "Desugar rollback stmnt to a fail", "committedDate": "2020-11-10T08:51:49Z", "type": "commit"}, {"oid": "73e43e09101011dd694a452d8c2264d703821cec", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/73e43e09101011dd694a452d8c2264d703821cec", "message": "rewrite retry desugar without manager", "committedDate": "2020-11-13T11:57:30Z", "type": "commit"}, {"oid": "6dc09612facf73e082da7188d8c25854ea6dda68", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/6dc09612facf73e082da7188d8c25854ea6dda68", "message": "Add retry manager to retry desugar", "committedDate": "2020-11-16T12:39:08Z", "type": "commit"}, {"oid": "07307b33de11b6bc6eaf3cf0adbcdcf29e3f156f", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/07307b33de11b6bc6eaf3cf0adbcdcf29e3f156f", "message": "Add support to force jump from retry", "committedDate": "2020-11-17T17:53:25Z", "type": "commit"}, {"oid": "6fc02d37b026e1a01328c82697f497bfa1594fb7", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/6fc02d37b026e1a01328c82697f497bfa1594fb7", "message": "Add brake statement during nested onfail", "committedDate": "2020-11-17T19:37:07Z", "type": "commit"}, {"oid": "44427216c3fba9d71736d42bcbd87c9578353be5", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/44427216c3fba9d71736d42bcbd87c9578353be5", "message": "Improve retry tests with on fail", "committedDate": "2020-11-19T09:13:37Z", "type": "commit"}, {"oid": "d8b0652abf5462ae67ccfeb4b781aac42f9e8360", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/d8b0652abf5462ae67ccfeb4b781aac42f9e8360", "message": "Support returning error after max retry", "committedDate": "2020-11-19T09:14:20Z", "type": "commit"}, {"oid": "43f8914fe6b2c90060ffaa766cec227c392e16dc", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/43f8914fe6b2c90060ffaa766cec227c392e16dc", "message": "Add comments for retry desugaring", "committedDate": "2020-11-19T14:04:52Z", "type": "commit"}, {"oid": "cefbe0ca807d3a8288e1525727b3054d60e90d99", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/cefbe0ca807d3a8288e1525727b3054d60e90d99", "message": "Move var to scope without resetting in loop", "committedDate": "2020-11-19T16:08:56Z", "type": "commit"}, {"oid": "a2408f04f6f3d9a90d513359799126344bd22cb3", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/a2408f04f6f3d9a90d513359799126344bd22cb3", "message": "Add nested retry with less onfail success test", "committedDate": "2020-11-19T16:29:37Z", "type": "commit"}, {"oid": "b2a704b8dfc886a6ad2827599f637875ad54f6e6", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/b2a704b8dfc886a6ad2827599f637875ad54f6e6", "message": "Add nested retry with less onfail success test", "committedDate": "2020-11-19T16:30:04Z", "type": "commit"}, {"oid": "77ac9e9a31a1e25fe2b63941c06c2a78c1c13227", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/77ac9e9a31a1e25fe2b63941c06c2a78c1c13227", "message": "Introduce should panic check to internal onfail", "committedDate": "2020-11-22T09:16:02Z", "type": "commit"}, {"oid": "1643f2ebb64c8ead4f24338bcb289abc1aede5b6", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/1643f2ebb64c8ead4f24338bcb289abc1aede5b6", "message": "Add manual rollback test", "committedDate": "2020-11-22T18:10:02Z", "type": "commit"}, {"oid": "fd7bb5071edc8d3acbfc58f39a6b3da58aeb9f36", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/fd7bb5071edc8d3acbfc58f39a6b3da58aeb9f36", "message": "Add retry transaction support", "committedDate": "2020-11-22T18:10:49Z", "type": "commit"}, {"oid": "3c5870dc1efba0edc5d6b63f2ece28404174b3c7", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/3c5870dc1efba0edc5d6b63f2ece28404174b3c7", "message": "Add error return from trx test", "committedDate": "2020-11-23T08:30:15Z", "type": "commit"}, {"oid": "60b46841df6bb7c1ba3a37d7f5b0f2bab3663e2c", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/60b46841df6bb7c1ba3a37d7f5b0f2bab3663e2c", "message": "Temp disable to verify test scenarios wrt spec", "committedDate": "2020-11-23T11:26:50Z", "type": "commit"}, {"oid": "6729cfa4bc28bba2bcb3d4a5072edc15f8abe609", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/6729cfa4bc28bba2bcb3d4a5072edc15f8abe609", "message": "Assert panic in bal code", "committedDate": "2020-11-23T11:28:20Z", "type": "commit"}, {"oid": "175f272b572d605328722ee1522ca2b82cc3a137", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/175f272b572d605328722ee1522ca2b82cc3a137", "message": "Add tests for asserting returns after rollback", "committedDate": "2020-11-23T11:29:05Z", "type": "commit"}, {"oid": "eeabe1ebbd1decd338c942c0e8c2d6970bf4f1c0", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/eeabe1ebbd1decd338c942c0e8c2d6970bf4f1c0", "message": "Support returns after rollback during failure", "committedDate": "2020-11-23T11:30:09Z", "type": "commit"}, {"oid": "04a2b0d5e4abe92849839182d9159c6b8de6c157", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/04a2b0d5e4abe92849839182d9159c6b8de6c157", "message": "Add desugaring steps as comments", "committedDate": "2020-11-23T12:30:13Z", "type": "commit"}, {"oid": "349d085d17b13f426fd2e2168d316ef3f6cd5161", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/349d085d17b13f426fd2e2168d316ef3f6cd5161", "message": "Fix test failure", "committedDate": "2020-11-23T12:30:30Z", "type": "commit"}, {"oid": "972ed74817a8a99c7e40ee302bacd8a3363c2dfe", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/972ed74817a8a99c7e40ee302bacd8a3363c2dfe", "message": "Merge branch 'master' of https://github.com/ballerina-platform/ballerina-lang\n\n\u0001 Conflicts:\n\u0001\tcompiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/desugar/Desugar.java\n\u0001\tcompiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/desugar/TransactionDesugar.java\n\u0001\ttests/jballerina-unit-test/src/test/java/org/ballerinalang/test/statements/transaction/NestedRetryTransactionStmtsTest.java\n\u0001\ttests/jballerina-unit-test/src/test/java/org/ballerinalang/test/statements/transaction/NestedTransactionTest.java\n\u0001\ttests/jballerina-unit-test/src/test/java/org/ballerinalang/test/statements/transaction/RetryTransactionBlockStmtOutcomesTest.java\n\u0001\ttests/jballerina-unit-test/src/test/java/org/ballerinalang/test/statements/transaction/TransactionStmtTest.java\n\u0001\ttests/jballerina-unit-test/src/test/resources/test-src/statements/transaction/nested_retry_transaction_stmts.bal\n\u0001\ttests/jballerina-unit-test/src/test/resources/test-src/statements/transaction/nested_transaction_test.bal\n\u0001\ttests/jballerina-unit-test/src/test/resources/test-src/statements/transaction/transaction_stmt.bal", "committedDate": "2020-11-23T12:56:52Z", "type": "commit"}, {"oid": "dee38e312c3958b90564ca927378ea478d42fd8a", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/dee38e312c3958b90564ca927378ea478d42fd8a", "message": "Sync with upstream", "committedDate": "2020-11-23T15:59:04Z", "type": "commit"}, {"oid": "bd30dfeb470a80477c1ecdd7549ae40647ccd9e7", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/bd30dfeb470a80477c1ecdd7549ae40647ccd9e7", "message": "Merge branch 'master' of https://github.com/ballerina-platform/ballerina-lang", "committedDate": "2020-11-23T15:59:43Z", "type": "commit"}, {"oid": "15c60f2a56600f64aaa8e47bb06d982abc446c55", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/15c60f2a56600f64aaa8e47bb06d982abc446c55", "message": "Merge branch 'master' of https://github.com/ballerina-platform/ballerina-lang", "committedDate": "2020-11-23T18:08:53Z", "type": "commit"}, {"oid": "c8c595b7caa83690ab643c48acd2532fc5f00ec1", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/c8c595b7caa83690ab643c48acd2532fc5f00ec1", "message": "Merge branch 'master' of https://github.com/ballerina-platform/ballerina-lang", "committedDate": "2020-11-24T15:25:21Z", "type": "commit"}, {"oid": "9a985ac01f514698f1145cd269e9868df1705c27", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/9a985ac01f514698f1145cd269e9868df1705c27", "message": "Merge branch 'master' of https://github.com/ballerina-platform/ballerina-lang", "committedDate": "2020-11-28T08:09:11Z", "type": "commit"}, {"oid": "8c583abf2961646f22dbbe9e44313424e4cf5830", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/8c583abf2961646f22dbbe9e44313424e4cf5830", "message": "Reset on-fail clause when visits end", "committedDate": "2020-11-29T12:57:18Z", "type": "commit"}, {"oid": "1251adf2961f1c1914838177139b16eeddc70f6d", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/1251adf2961f1c1914838177139b16eeddc70f6d", "message": "Merge branch 'master' of https://github.com/ballerina-platform/ballerina-lang", "committedDate": "2020-11-29T13:05:58Z", "type": "commit"}, {"oid": "b8066d60dbaad505360bf73a43950d3f7f7b6c75", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/b8066d60dbaad505360bf73a43950d3f7f7b6c75", "message": "Remove commented code", "committedDate": "2020-11-29T14:03:40Z", "type": "commit"}, {"oid": "18673384199f9193943767aabdfe1dd497b63276", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/18673384199f9193943767aabdfe1dd497b63276", "message": "Add multi level retry fail tests", "committedDate": "2020-11-30T16:46:38Z", "type": "commit"}, {"oid": "c29e3a6cfb7b7357b11ffbf4348a102ac241401d", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/c29e3a6cfb7b7357b11ffbf4348a102ac241401d", "message": "Merge branch 'master' of https://github.com/ballerina-platform/ballerina-lang into retry", "committedDate": "2020-11-30T16:53:20Z", "type": "commit"}, {"oid": "c4fe241b5fe08fb6119e91d55c510d93777cbbf7", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/c4fe241b5fe08fb6119e91d55c510d93777cbbf7", "message": "Merge branches 'on-fail-impl' and 'retry' of https://github.com/pcnfernando/ballerina-lang into retry", "committedDate": "2020-11-30T16:58:09Z", "type": "commit"}, {"oid": "73b0ca1f60117d33774a06c1aa142bd0481a7185", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/73b0ca1f60117d33774a06c1aa142bd0481a7185", "message": "Enable multi level retry fail tests", "committedDate": "2020-11-30T17:18:42Z", "type": "commit"}, {"oid": "8055cf613e3c3789f16602ef0b9a37773bdeb7fb", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/8055cf613e3c3789f16602ef0b9a37773bdeb7fb", "message": "Return error from internal trx onfail", "committedDate": "2020-12-01T17:45:20Z", "type": "commit"}, {"oid": "4c2feae3fbfb1e600105944a0eb576bd3cb1809f", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/4c2feae3fbfb1e600105944a0eb576bd3cb1809f", "message": "Check strand in trx mode before rollback", "committedDate": "2020-12-02T12:13:50Z", "type": "commit"}, {"oid": "9d47f11dced6d42c040bb6f7c13d2d4abe8b1e10", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/9d47f11dced6d42c040bb6f7c13d2d4abe8b1e10", "message": "Add trx mode check to trx internal on fail", "committedDate": "2020-12-02T12:16:15Z", "type": "commit"}, {"oid": "944a89b342400d6fac837b476fa00265856028f5", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/944a89b342400d6fac837b476fa00265856028f5", "message": "Improve trx code analyzing for if statements", "committedDate": "2020-12-02T18:49:15Z", "type": "commit"}, {"oid": "df092fb4ab0da4145f7d46febe48a53ac34c1764", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/df092fb4ab0da4145f7d46febe48a53ac34c1764", "message": "Improve trx code analyzing for else if", "committedDate": "2020-12-03T17:49:06Z", "type": "commit"}, {"oid": "652df45784d80f23a638ce0d9ede27f7698e3bc2", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/652df45784d80f23a638ce0d9ede27f7698e3bc2", "message": "Merge branch 'master' of https://github.com/ballerina-platform/ballerina-lang into retry", "committedDate": "2020-12-03T17:49:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTkxNTMyOQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27245#discussion_r535915329", "bodyText": "add more comments with desugaring", "author": "pcnfernando", "createdAt": "2020-12-04T08:19:48Z", "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/desugar/Desugar.java", "diffHunk": "@@ -3757,28 +3996,203 @@ public void visit(BLangUnLockStmt unLockStmt) {\n         result = unLockStmt;\n     }\n \n+\n+    private BLangOnFailClause createTrxInternalOnFail(Location pos, BLangSimpleVarRef shouldPanicRef) {\n+        BLangOnFailClause trxOnFailClause = (BLangOnFailClause) TreeBuilder.createOnFailClauseNode();\n+        trxOnFailClause.pos = pos;\n+        trxOnFailClause.body = ASTBuilderUtil.createBlockStmt(pos);\n+        trxOnFailClause.body.scope = new Scope(env.scope.owner);\n+        trxOnFailClause.isInternal = true;\n+\n+        BVarSymbol trxOnFailErrorSym = new BVarSymbol(0, names.fromString(\"$trxError$\"),\n+                env.scope.owner.pkgID, symTable.errorType, env.scope.owner, pos, VIRTUAL);\n+        BLangSimpleVariable trxOnFailError = ASTBuilderUtil.createVariable(pos,\n+                \"$trxError$\", symTable.errorType, null, trxOnFailErrorSym);\n+        trxOnFailClause.variableDefinitionNode = ASTBuilderUtil.createVariableDef(pos,\n+                trxOnFailError);\n+        trxOnFailClause.body.scope.define(trxOnFailErrorSym.name, trxOnFailErrorSym);\n+        transactionDesugar.createRollbackIfFailed(pos, trxOnFailClause.body, trxOnFailErrorSym, trxBlockId);\n+\n+        BLangGroupExpr shouldNotPanic = new BLangGroupExpr();\n+        shouldNotPanic.type = symTable.booleanType;\n+        shouldNotPanic.expression = createNotBinaryExpression(pos, shouldPanicRef);\n+\n+        BLangSimpleVarRef caughtError =  ASTBuilderUtil.createVariableRef(pos, trxOnFailErrorSym);\n+\n+        BLangBlockStmt failBlock = ASTBuilderUtil.createBlockStmt(pos);\n+\n+        BLangPanic panicNode = (BLangPanic) TreeBuilder.createPanicNode();\n+        panicNode.pos = pos;\n+        panicNode.expr = caughtError;\n+\n+        BLangIf exitIf = ASTBuilderUtil.createIfElseStmt(pos, shouldNotPanic, failBlock, panicNode);\n+        trxOnFailClause.body.stmts.add(exitIf);\n+\n+        BLangFail failStmt = (BLangFail) TreeBuilder.createFailNode();\n+        failStmt.pos = pos;\n+        failStmt.expr = caughtError;\n+        failBlock.stmts.add(failStmt);\n+        trxOnFailClause.bodyContainsFail = true;\n+\n+        return trxOnFailClause;\n+    }\n+\n     @Override\n     public void visit(BLangTransaction transactionNode) {\n-        BLangOnFailClause currentOnFailClause = this.onFailClause;\n-        BLangSimpleVariableDef currentOnFailCallDef = this.onFailCallFuncDef;\n-        analyzeOnFailClause(transactionNode.onFailClause, transactionNode.transactionBody);\n-        BLangStatementExpression transactionStmtExpr = transactionDesugar.rewrite(transactionNode, env,\n-                onFailClause != null);\n-        result = createExpressionStatement(transactionNode.pos, transactionStmtExpr,\n-                transactionNode.statementBlockReturns, env);\n-        swapAndResetEnclosingOnFail(currentOnFailClause, currentOnFailCallDef);\n+        if (transactionNode.onFailClause != null) {", "originalCommit": "944a89b342400d6fac837b476fa00265856028f5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "508c1f1cdf4b67ff777dd560fe091676c2531b69", "chunk": "diff --git a/compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/desugar/Desugar.java b/compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/desugar/Desugar.java\nindex da27c20f74c..c83f8334ed6 100644\n--- a/compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/desugar/Desugar.java\n+++ b/compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/desugar/Desugar.java\n\n@@ -4004,6 +3996,8 @@ public class Desugar extends BLangNodeVisitor {\n         trxOnFailClause.body.scope = new Scope(env.scope.owner);\n         trxOnFailClause.isInternal = true;\n \n+        // on fail error $trxError$ {\n+        // }\n         BVarSymbol trxOnFailErrorSym = new BVarSymbol(0, names.fromString(\"$trxError$\"),\n                 env.scope.owner.pkgID, symTable.errorType, env.scope.owner, pos, VIRTUAL);\n         BLangSimpleVariable trxOnFailError = ASTBuilderUtil.createVariable(pos,\n"}}, {"oid": "508c1f1cdf4b67ff777dd560fe091676c2531b69", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/508c1f1cdf4b67ff777dd560fe091676c2531b69", "message": "Add desugaring steps as comments", "committedDate": "2020-12-04T16:05:03Z", "type": "commit"}, {"oid": "5b211243a3e4af8829d9df2a5db8b30768fbf248", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/5b211243a3e4af8829d9df2a5db8b30768fbf248", "message": "Merge branch 'master' of https://github.com/ballerina-platform/ballerina-lang into retry", "committedDate": "2020-12-04T16:07:40Z", "type": "commit"}]}