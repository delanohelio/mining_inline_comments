{"pr_number": 20846, "pr_title": "Migrate codegen to use BString", "pr_createdAt": "2020-02-03T11:59:29Z", "pr_url": "https://github.com/ballerina-platform/ballerina-lang/pull/20846", "timeline": [{"oid": "9edf016ba085daf80d5458ad8cbed442007e7237", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/9edf016ba085daf80d5458ad8cbed442007e7237", "message": "Migrate codegen to use BString", "committedDate": "2020-02-03T11:51:41Z", "type": "commit"}, {"oid": "c3554a9df097291aa61f11764efec14872597cff", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/c3554a9df097291aa61f11764efec14872597cff", "message": "Merge branch 'master' of https://github.com/ballerina-platform/ballerina-lang into bstring", "committedDate": "2020-02-03T17:50:02Z", "type": "commit"}, {"oid": "24d973ca8794154e21b7002a97a4cdb066a6e035", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/24d973ca8794154e21b7002a97a4cdb066a6e035", "message": "Merge branch 'master' of https://github.com/ballerina-platform/ballerina-lang into bstring", "committedDate": "2020-02-05T04:35:07Z", "type": "commit"}, {"oid": "1eb3809bf0d198b16d748b66e06e15dbecfd41ee", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/1eb3809bf0d198b16d748b66e06e15dbecfd41ee", "message": "Fix StringUtils compilation", "committedDate": "2020-02-05T07:23:38Z", "type": "commit"}, {"oid": "a28418ef44e9fa44a3444eae3b2f1b2ba8f30ad2", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/a28418ef44e9fa44a3444eae3b2f1b2ba8f30ad2", "message": "Fix checkstyle", "committedDate": "2020-02-05T08:41:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTcwNTQ4OA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20846#discussion_r375705488", "bodyText": "We assert the length because that is the main difference from the old String. If we assert by value both old and new cases pass. Shall we return the length and assert?", "author": "riyafa", "createdAt": "2020-02-06T08:52:03Z", "path": "tests/jballerina-unit-test/src/test/java/org/ballerinalang/test/types/string/StringValueBasicsTest.java", "diffHunk": "@@ -69,6 +70,13 @@ public void testError() {\n         Assert.assertEquals(((BInteger) returns[0]).intValue(), 5);\n     }\n \n+    @Test\n+    public void testArrayStore() {\n+        BValue[] returns = BRunUtil.invoke(result, \"testArrayStore\");\n+        Assert.assertEquals(returns[0].getClass(), BValueArray.class);\n+        Assert.assertEquals(((BValueArray) returns[0]).getStringArray()[0], \"h\ud83d\ude00llo\");", "originalCommit": "a28418ef44e9fa44a3444eae3b2f1b2ba8f30ad2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "26e71e6860d93dc8e12a74a2377d135bae0c274c", "chunk": "diff --git a/tests/jballerina-unit-test/src/test/java/org/ballerinalang/test/types/string/StringValueBasicsTest.java b/tests/jballerina-unit-test/src/test/java/org/ballerinalang/test/types/string/StringValueBasicsTest.java\nindex 23b94c7dd3f..4b89651ca3b 100644\n--- a/tests/jballerina-unit-test/src/test/java/org/ballerinalang/test/types/string/StringValueBasicsTest.java\n+++ b/tests/jballerina-unit-test/src/test/java/org/ballerinalang/test/types/string/StringValueBasicsTest.java\n\n@@ -73,8 +73,8 @@ public class StringValueBasicsTest {\n     @Test\n     public void testArrayStore() {\n         BValue[] returns = BRunUtil.invoke(result, \"testArrayStore\");\n-        Assert.assertEquals(returns[0].getClass(), BValueArray.class);\n-        Assert.assertEquals(((BValueArray) returns[0]).getStringArray()[0], \"h\ud83d\ude00llo\");\n+        Assert.assertEquals(returns[0].getClass(), BInteger.class);\n+        Assert.assertEquals(((BInteger) returns[0]).intValue(), 10);\n     }\n \n     @AfterClass\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTcxMjgwOA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20846#discussion_r375712808", "bodyText": "fromString is used to convert java string to ballerina. do we need a way to convert BString to BString?", "author": "manuranga", "createdAt": "2020-02-06T09:07:44Z", "path": "bvm/ballerina-runtime/src/main/java/org/ballerinalang/jvm/StringUtils.java", "diffHunk": "@@ -133,4 +133,8 @@ public static StringValue fromString(String s) {\n         return new NonBmpStringValue(s, highSurrogatesArr);\n     }\n \n+    public static BString fromString(BString s) {", "originalCommit": "a28418ef44e9fa44a3444eae3b2f1b2ba8f30ad2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "26e71e6860d93dc8e12a74a2377d135bae0c274c", "chunk": "diff --git a/bvm/ballerina-runtime/src/main/java/org/ballerinalang/jvm/StringUtils.java b/bvm/ballerina-runtime/src/main/java/org/ballerinalang/jvm/StringUtils.java\nindex e5f44d3cf93..ef866c944e8 100644\n--- a/bvm/ballerina-runtime/src/main/java/org/ballerinalang/jvm/StringUtils.java\n+++ b/bvm/ballerina-runtime/src/main/java/org/ballerinalang/jvm/StringUtils.java\n\n@@ -132,9 +132,4 @@ public class StringUtils {\n         }\n         return new NonBmpStringValue(s, highSurrogatesArr);\n     }\n-\n-    public static BString fromString(BString s) {\n-        return fromString(s.getValue());\n-    }\n-\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTcxMzg3Nw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20846#discussion_r375713877", "bodyText": "extra paran", "author": "manuranga", "createdAt": "2020-02-06T09:10:01Z", "path": "bvm/ballerina-runtime/src/main/java/org/ballerinalang/jvm/values/BmpStringValue.java", "diffHunk": "@@ -46,9 +48,9 @@ public int length() {\n      }\n \n      @Override\n-     public StringValue concat(StringValue str) {\n+     public BString concat(BString str) {\n          if (str instanceof BmpStringValue) {\n-             return new BmpStringValue(this.value + ((BmpStringValue) str).value);\n+             return new BmpStringValue((this.value + ((BmpStringValue) str).value));", "originalCommit": "a28418ef44e9fa44a3444eae3b2f1b2ba8f30ad2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "26e71e6860d93dc8e12a74a2377d135bae0c274c", "chunk": "diff --git a/bvm/ballerina-runtime/src/main/java/org/ballerinalang/jvm/values/BmpStringValue.java b/bvm/ballerina-runtime/src/main/java/org/ballerinalang/jvm/values/BmpStringValue.java\nindex e7bf78dc08a..d8d9fc1d8ea 100644\n--- a/bvm/ballerina-runtime/src/main/java/org/ballerinalang/jvm/values/BmpStringValue.java\n+++ b/bvm/ballerina-runtime/src/main/java/org/ballerinalang/jvm/values/BmpStringValue.java\n\n@@ -50,7 +50,7 @@ public class BmpStringValue implements StringValue {\n      @Override\n      public BString concat(BString str) {\n          if (str instanceof BmpStringValue) {\n-             return new BmpStringValue((this.value + ((BmpStringValue) str).value));\n+             return new BmpStringValue(this.value + ((BmpStringValue) str).value);\n          } else {\n              throw new RuntimeException(\"not impl yet\");\n          }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTcxNDY0NQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20846#discussion_r375714645", "bodyText": "need the long name ?", "author": "manuranga", "createdAt": "2020-02-06T09:11:38Z", "path": "tests/jballerina-unit-test/src/test/java/org/ballerinalang/test/javainterop/RefTypeTests.java", "diffHunk": "@@ -388,7 +387,7 @@ public static HandleValue getHandle() {\n         return new HandleValue(m);\n     }\n \n-    public static StringValue useHandle(HandleValue h) {\n+    public static org.ballerinalang.jvm.values.api.BString useHandle(HandleValue h) {", "originalCommit": "a28418ef44e9fa44a3444eae3b2f1b2ba8f30ad2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTcyMDk0Nw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20846#discussion_r375720947", "bodyText": "yes. org.ballerinalang.model.values.BString also imported here for assertions.", "author": "vinok88", "createdAt": "2020-02-06T09:24:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTcxNDY0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjI1NzMxMQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20846#discussion_r376257311", "bodyText": "got it.", "author": "manuranga", "createdAt": "2020-02-07T08:03:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTcxNDY0NQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "26e71e6860d93dc8e12a74a2377d135bae0c274c", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/26e71e6860d93dc8e12a74a2377d135bae0c274c", "message": "Support BString for array load", "committedDate": "2020-02-07T05:09:44Z", "type": "commit"}, {"oid": "c535e7d328dd16e3dbac1f713084f7ea6b0fdb3d", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/c535e7d328dd16e3dbac1f713084f7ea6b0fdb3d", "message": "Fix checkstyle", "committedDate": "2020-02-07T06:11:52Z", "type": "commit"}]}