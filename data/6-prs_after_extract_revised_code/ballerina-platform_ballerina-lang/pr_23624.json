{"pr_number": 23624, "pr_title": "Merge codegen with compile phases", "pr_createdAt": "2020-05-30T21:32:55Z", "pr_url": "https://github.com/ballerina-platform/ballerina-lang/pull/23624", "timeline": [{"oid": "aa83e6c5ac75db8a6113fbfa6f43293225e397bb", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/aa83e6c5ac75db8a6113fbfa6f43293225e397bb", "message": "Move NativeDependencyResolver lookup key to API class", "committedDate": "2020-05-30T20:56:11Z", "type": "commit"}, {"oid": "6863ecf66cf286e0974293d503607eb672d4b9a1", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/6863ecf66cf286e0974293d503607eb672d4b9a1", "message": "Add jar file binary writer class", "committedDate": "2020-05-30T20:56:53Z", "type": "commit"}, {"oid": "988c83ff47f7fdf8569192ef08d959a3e734b7de", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/988c83ff47f7fdf8569192ef08d959a3e734b7de", "message": "Refactor JarFile class as CompiledJarFile", "committedDate": "2020-05-30T20:57:43Z", "type": "commit"}, {"oid": "5711050461efad0cd5c611385773d57d6fa1d92f", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/5711050461efad0cd5c611385773d57d6fa1d92f", "message": "Remove unused lib-creator-milestone gradle module", "committedDate": "2020-05-30T20:58:54Z", "type": "commit"}, {"oid": "48ce58bf70617428e61888bd9e51dd5ffc7fa7b5", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/48ce58bf70617428e61888bd9e51dd5ffc7fa7b5", "message": "Remove BackendDriver as it is not used anymore", "committedDate": "2020-05-30T20:59:47Z", "type": "commit"}, {"oid": "1e30354feadb35ae6a45e91c6683d6a29a01ccaf", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/1e30354feadb35ae6a45e91c6683d6a29a01ccaf", "message": "Remove JarFile class as it replaced by CompiledJarFile", "committedDate": "2020-05-30T21:01:33Z", "type": "commit"}, {"oid": "2342c28d7ba69aff73198a17ea0b6d3c0084b96a", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/2342c28d7ba69aff73198a17ea0b6d3c0084b96a", "message": "Add new compiler options needed for codegen phase", "committedDate": "2020-05-30T21:13:31Z", "type": "commit"}, {"oid": "a13431b3e96bc60d8d75b554a8135e5a5e95b213", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/a13431b3e96bc60d8d75b554a8135e5a5e95b213", "message": "Store compiled module jar content in-memory in symbol", "committedDate": "2020-05-30T21:14:10Z", "type": "commit"}, {"oid": "7b009fd741e0fab05dcf1854dd96f4e14f5e60d0", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/7b009fd741e0fab05dcf1854dd96f4e14f5e60d0", "message": "Use JarFileWriter to write balo jars", "committedDate": "2020-05-30T21:14:25Z", "type": "commit"}, {"oid": "dff3e349fb16034eef3760a2ff294305f8f3faec", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/dff3e349fb16034eef3760a2ff294305f8f3faec", "message": "Refactor codegen to run as a compilation phase\n\nThis change will make codegen class to generate the bytecode and\nstore it in the symbol for each package that is being called. The\nCompilerDriver will call CodeGenerator now as the last phase in\ncompilation.", "committedDate": "2020-05-30T21:15:55Z", "type": "commit"}, {"oid": "0bca762b6321b54825175ce6a694c3647e16ed47", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/0bca762b6321b54825175ce6a694c3647e16ed47", "message": "Add codegen as the last compilation phase", "committedDate": "2020-05-30T21:18:15Z", "type": "commit"}, {"oid": "e3692ee3da2b421bbc689d59cc3beba9d8ea062d", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/e3692ee3da2b421bbc689d59cc3beba9d8ea062d", "message": "Refactor JvmPackageGen to work with codegen changes\n\nThis commit also has the fix to interop validation for non-entry\nmodules.", "committedDate": "2020-05-30T21:19:30Z", "type": "commit"}, {"oid": "fcf70120dd19e66e4a3cd32aaafccf2f194df375", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/fcf70120dd19e66e4a3cd32aaafccf2f194df375", "message": "Code refactor with correct allignment", "committedDate": "2020-05-30T21:21:10Z", "type": "commit"}, {"oid": "81a81f2b49fcd7e57e492052d2d4353e29b1d716", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/81a81f2b49fcd7e57e492052d2d4353e29b1d716", "message": "Exclude BPackageSymbol in spotbugs", "committedDate": "2020-05-30T21:22:35Z", "type": "commit"}, {"oid": "2389132494b9f7936bb5f7443ef7abeb4fba5b2b", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/2389132494b9f7936bb5f7443ef7abeb4fba5b2b", "message": "Use JarFileWriter to write thin jars to target path", "committedDate": "2020-05-30T21:23:30Z", "type": "commit"}, {"oid": "437f5088e9d7459309007f4fd0212165cdf504bb", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/437f5088e9d7459309007f4fd0212165cdf504bb", "message": "Add codegen related complier options", "committedDate": "2020-05-30T21:24:35Z", "type": "commit"}, {"oid": "403335b019c8bb53cfe7892f2cc8c607001cf993", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/403335b019c8bb53cfe7892f2cc8c607001cf993", "message": "Add jackson core module to dependency resolving issue", "committedDate": "2020-05-30T21:26:12Z", "type": "commit"}, {"oid": "08aec62b51621fe426332b679807916892b74346", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/08aec62b51621fe426332b679807916892b74346", "message": "Add packerina gradle dependency to test utils", "committedDate": "2020-05-30T21:27:11Z", "type": "commit"}, {"oid": "56bcce5019a50d5165b5510d2b51b3ad8e715ff7", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/56bcce5019a50d5165b5510d2b51b3ad8e715ff7", "message": "Update compileOnJballerina method with codegen changes\n\nThe new JarFileWriter class is used to write the thin jars now.\nAlso, this commit has some code cleaup of the whole BCompileUtil\nclass.", "committedDate": "2020-05-30T21:27:27Z", "type": "commit"}, {"oid": "f3d4bc21dbfce64cced6aed12c3bc5fed1f83fbd", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/f3d4bc21dbfce64cced6aed12c3bc5fed1f83fbd", "message": "Clean cache directory for balo test", "committedDate": "2020-05-30T21:29:43Z", "type": "commit"}, {"oid": "a263cb7b90a94da9f1782a3bd678d602e0a537b3", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/a263cb7b90a94da9f1782a3bd678d602e0a537b3", "message": "Remove unwanted path check", "committedDate": "2020-05-30T21:30:06Z", "type": "commit"}, {"oid": "cc056cdf0e7e869ebd22f8553c33f20c46c2978e", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/cc056cdf0e7e869ebd22f8553c33f20c46c2978e", "message": "Remove unused import", "committedDate": "2020-05-31T09:37:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA0NjEzNw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/23624#discussion_r433046137", "bodyText": "Shall we rename to baloGen or baloGenerated and remove is prefix to be consistent with other boolean variable names\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private boolean isBaloGen;\n          \n          \n            \n                private boolean baloGen;", "author": "riyafa", "createdAt": "2020-06-01T05:22:15Z", "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/bir/codegen/CodeGenerator.java", "diffHunk": "@@ -52,18 +63,31 @@\n public class CodeGenerator {\n \n     private static final CompilerContext.Key<CodeGenerator> CODE_GEN = new CompilerContext.Key<>();\n-\n     private SymbolTable symbolTable;\n-\n-    private Map<String, BIRNode.BIRPackage> compiledPkgCache = new HashMap<>();\n-\n-    private JvmPackageGen jvmPackageGen;\n-\n-    private CodeGenerator(CompilerContext context) {\n-\n-        context.put(CODE_GEN, this);\n-        symbolTable = SymbolTable.getInstance(context);\n-        jvmPackageGen = JvmPackageGen.getInstance(context);\n+    private PackageCache packageCache;\n+    private BLangDiagnosticLogHelper dlog;\n+    private BIREmitter birEmitter;\n+    private boolean isBaloGen;", "originalCommit": "cc056cdf0e7e869ebd22f8553c33f20c46c2978e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE0NzAyNQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/23624#discussion_r433147025", "bodyText": "ack", "author": "Kishanthan", "createdAt": "2020-06-01T10:02:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA0NjEzNw=="}], "type": "inlineReview", "revised_code": {"commit": "35af21b5874add9c7a8e52b71a5e4d9eec72c47a", "chunk": "diff --git a/compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/bir/codegen/CodeGenerator.java b/compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/bir/codegen/CodeGenerator.java\nindex a8c6d2490f7..c176ff0e204 100644\n--- a/compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/bir/codegen/CodeGenerator.java\n+++ b/compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/bir/codegen/CodeGenerator.java\n\n@@ -67,7 +67,7 @@ public class CodeGenerator {\n     private PackageCache packageCache;\n     private BLangDiagnosticLogHelper dlog;\n     private BIREmitter birEmitter;\n-    private boolean isBaloGen;\n+    private boolean baloGen;\n     private CompilerContext compilerContext;\n     private boolean skipTests;\n     private boolean dumbBIR;\n"}}, {"oid": "35af21b5874add9c7a8e52b71a5e4d9eec72c47a", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/35af21b5874add9c7a8e52b71a5e4d9eec72c47a", "message": "Use consistent naming for baloGen flag", "committedDate": "2020-06-01T10:02:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzY0NTA2Nw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/23624#discussion_r433645067", "bodyText": "Why we need these changes in this test?", "author": "warunalakshitha", "createdAt": "2020-06-02T06:22:04Z", "path": "tests/jballerina-unit-test/src/test/java/org/ballerinalang/test/balo/imports/ImportsTests.java", "diffHunk": "@@ -43,42 +39,21 @@\n \n     private static final String USER_HOME = \"user.home\";\n     private String previousUserHome;\n-    private Path tempBir;\n     private Path imports;\n-    private Path homeBirCache;\n-    private Path birDir;\n-    private List<Path> birFiles;\n \n     @BeforeClass(description = \"Build the necessary modules.\")\n     public void setup() throws IOException {\n         Path tempDir = Files.createTempDirectory(\"temp-bal-home\");\n-\n-        tempBir = Paths.get(System.getProperty(\"user.dir\"), \"build\", \"test-bir-temp\");\n-\n         imports = Paths.get(\"test-src\", \"balo\", \"imports\");\n-\n-        homeBirCache = tempDir.resolve(Paths.get(\".ballerina\", \"bir_cache\" + \"-\" +\n-                RepoUtils.getBallerinaVersion()));\n-\n         previousUserHome = System.getProperty(USER_HOME);\n         System.setProperty(USER_HOME, tempDir.toString());\n-\n-        // Delete all existing bir files.\n-        BFileUtil.deleteAll(tempBir, \"testModule.bir\");\n     }\n \n     @Test(description = \"Get the version from the source file.\")\n-    public void testVersionSupportImportFromSourceFile() throws IOException {\n+    public void testVersionSupportImportFromSourceFile() {\n         BaloCreator.cleanCacheDirectories();\n         BaloCreator.createAndSetupBalo(imports.resolve(Paths.get(\"test_module1\", \"test_module\")).toString(),\n                 \"testOrg\", \"testModule\", \"1.1.0\");\n-        birFiles = Files.find(tempBir, Integer.MAX_VALUE, (path, attribute) ->\n-                path.toString().contains(\"testModule.bir\")\n-                        && !path.toString().contains(\"imports\")).collect(Collectors.toList());\n-        birDir = Files.createDirectories(homeBirCache.resolve(Paths.get(\"testOrg\", \"testModule\", \"1.1.0\")));\n-        BFileUtil.copy(birFiles.get(0), birDir.resolve(Paths.get(\"testModule.bir\")));", "originalCommit": "35af21b5874add9c7a8e52b71a5e4d9eec72c47a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzY1NjcwNQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/23624#discussion_r433656705", "bodyText": "Because, in test, we don't write bir binaries anymore, with the new jBallerina java rewrite. So the above lines were not needed.", "author": "Kishanthan", "createdAt": "2020-06-02T06:51:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzY0NTA2Nw=="}], "type": "inlineReview", "revised_code": null}]}