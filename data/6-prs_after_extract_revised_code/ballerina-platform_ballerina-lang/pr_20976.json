{"pr_number": 20976, "pr_title": "Add chain invocation support for 'create variable' code action", "pr_createdAt": "2020-02-11T08:22:16Z", "pr_url": "https://github.com/ballerina-platform/ballerina-lang/pull/20976", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzUwMjU3Nw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20976#discussion_r377502577", "bodyText": "Shall we update the logic to handle(ignore) characters inside string literals?", "author": "NipunaRanasinghe", "createdAt": "2020-02-11T08:51:43Z", "path": "language-server/modules/langserver-core/src/main/java/org/ballerinalang/langserver/codeaction/providers/VariableAssignmentCodeAction.java", "diffHunk": "@@ -223,16 +223,44 @@ private static String getDiagnosedContent(Diagnostic diagnostic, LSContext conte\n     }\n \n     private static Position offsetInvocation(String diagnosedContent, Position position) {\n+//        Need to capture the correct function invocation position in chain & nested invocations\n+//        eg. General Invocations: lorry.get_color()\n+//            Chain invocations: lorry.get_color().print(10),\n+//            Package Prefixes: http:lorry.get_color()\n+//            Action invocations: http:lorry->action()\n+//            Nested invocations: crypto:hashMd5(str.toBytes())\n+//            Field accesses: http:lorry.get_color\n+        String content = diagnosedContent;\n+        int pendingLParenthesis = 0;\n+        boolean loop = true;\n+        int count = 0;\n+        while (loop) {\n+            if (content.length() == 2) {\n+                break;\n+            }\n+            char tailChar = content.charAt(content.length() - 1);\n+            char tailPrevChar = content.charAt(content.length() - 2);\n+            if (pendingLParenthesis <= 0) {\n+                if (tailChar == '.' || tailChar == ':') {\n+                    count++;\n+                    break;\n+                } else if ((tailPrevChar == '-' && tailChar == '>')) {\n+                    count += 2;\n+                    break;\n+                }\n+            }\n+            if (tailChar == '(') {\n+                pendingLParenthesis--;\n+            } else if (tailChar == ')') {\n+                pendingLParenthesis++;\n+            }\n+            content = content.substring(0, content.length() - 1);\n+            count++;\n+        }\n+", "originalCommit": "c6f87b672a18e46163c654225ccbe53d98f4b611", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzUwNzExMQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20976#discussion_r377507111", "bodyText": "Yes \ud83d\udc4d , Need to ignore chars inside strings for the calculation.", "author": "rasika", "createdAt": "2020-02-11T09:01:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzUwMjU3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzUxMTExOQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20976#discussion_r377511119", "bodyText": "@rasika Maybe it'd be better to have a test case including string literals, if possible", "author": "NipunaRanasinghe", "createdAt": "2020-02-11T09:10:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzUwMjU3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzU4MjI3NQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20976#discussion_r377582275", "bodyText": "Yes, added a test case as well.", "author": "rasika", "createdAt": "2020-02-11T11:37:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzUwMjU3Nw=="}], "type": "inlineReview", "revised_code": {"commit": "7eeda180e1bb12898eab144e09783d8db6533470", "chunk": "diff --git a/language-server/modules/langserver-core/src/main/java/org/ballerinalang/langserver/codeaction/providers/VariableAssignmentCodeAction.java b/language-server/modules/langserver-core/src/main/java/org/ballerinalang/langserver/codeaction/providers/VariableAssignmentCodeAction.java\nindex f7e63e4a845..06bcd63b17d 100644\n--- a/language-server/modules/langserver-core/src/main/java/org/ballerinalang/langserver/codeaction/providers/VariableAssignmentCodeAction.java\n+++ b/language-server/modules/langserver-core/src/main/java/org/ballerinalang/langserver/codeaction/providers/VariableAssignmentCodeAction.java\n\n@@ -230,31 +230,44 @@ public class VariableAssignmentCodeAction extends AbstractCodeActionProvider {\n //            Action invocations: http:lorry->action()\n //            Nested invocations: crypto:hashMd5(str.toBytes())\n //            Field accesses: http:lorry.get_color\n+//            String Params: lorry.get_color(\"test.invoke(\\\"\")\n         String content = diagnosedContent;\n         int pendingLParenthesis = 0;\n         boolean loop = true;\n+        boolean insideString = false;\n         int count = 0;\n+        int pointer = content.length();\n         while (loop) {\n-            if (content.length() == 2) {\n+            pointer--;\n+            if (pointer == 2) {\n                 break;\n             }\n-            char tailChar = content.charAt(content.length() - 1);\n-            char tailPrevChar = content.charAt(content.length() - 2);\n-            if (pendingLParenthesis <= 0) {\n-                if (tailChar == '.' || tailChar == ':') {\n-                    count++;\n-                    break;\n-                } else if ((tailPrevChar == '-' && tailChar == '>')) {\n-                    count += 2;\n-                    break;\n-                }\n+            // Check for stop-conditions\n+            char tailChar = content.charAt(pointer);\n+            char tailPrevChar = content.charAt(pointer - 1);\n+            if (tailChar == '\"' && tailPrevChar != '\\\\') {\n+                insideString = !insideString;\n             }\n-            if (tailChar == '(') {\n-                pendingLParenthesis--;\n-            } else if (tailChar == ')') {\n-                pendingLParenthesis++;\n+            if (!insideString) {\n+                if (pendingLParenthesis <= 0) {\n+                    if (tailChar == '.' || tailChar == ':') {\n+                        // Break on field-access or package-prefix\n+                        count++;\n+                        break;\n+                    } else if ((tailPrevChar == '-' && tailChar == '>')) {\n+                        // Break on arrow-function invocations\n+                        count += 2;\n+                        break;\n+                    }\n+                }\n+                // Remove chars Right-to-Left\n+                if (tailChar == '(') {\n+                    pendingLParenthesis--;\n+                } else if (tailChar == ')') {\n+                    pendingLParenthesis++;\n+                }\n             }\n-            content = content.substring(0, content.length() - 1);\n+            content = content.substring(0, pointer);\n             count++;\n         }\n \n"}}, {"oid": "7eeda180e1bb12898eab144e09783d8db6533470", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/7eeda180e1bb12898eab144e09783d8db6533470", "message": "Add chain invocation support for 'create variable' code action\n\nSigned-off-by: Rasika <info.rasika@gmail.com>", "committedDate": "2020-02-11T11:03:04Z", "type": "forcePushed"}, {"oid": "98def71c9b4598333ff1d6f7ad63e22fd705eaaa", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/98def71c9b4598333ff1d6f7ad63e22fd705eaaa", "message": "Add chain invocation support for 'create variable' code action\n\nSigned-off-by: Rasika <info.rasika@gmail.com>", "committedDate": "2020-02-11T11:30:20Z", "type": "commit"}, {"oid": "98def71c9b4598333ff1d6f7ad63e22fd705eaaa", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/98def71c9b4598333ff1d6f7ad63e22fd705eaaa", "message": "Add chain invocation support for 'create variable' code action\n\nSigned-off-by: Rasika <info.rasika@gmail.com>", "committedDate": "2020-02-11T11:30:20Z", "type": "forcePushed"}]}