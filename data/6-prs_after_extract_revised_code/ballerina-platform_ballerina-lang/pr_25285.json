{"pr_number": 25285, "pr_title": "Add BIR spec test", "pr_createdAt": "2020-08-14T10:13:35Z", "pr_url": "https://github.com/ballerina-platform/ballerina-lang/pull/25285", "timeline": [{"oid": "12b7c76ecee866b3b0341560a3592022972bd8e1", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/12b7c76ecee866b3b0341560a3592022972bd8e1", "message": "Add simple BIR spec test to read bir binary and validate", "committedDate": "2020-08-14T10:10:08Z", "type": "commit"}, {"oid": "ec075d28b4477a867fe7763f5bd822914d1b7e6f", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/ec075d28b4477a867fe7763f5bd822914d1b7e6f", "message": "Add eof line", "committedDate": "2020-08-14T10:14:48Z", "type": "forcePushed"}, {"oid": "4053cee3c3ee6f5cbe4aabbfec16a99c79deb48b", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/4053cee3c3ee6f5cbe4aabbfec16a99c79deb48b", "message": "Add eof line", "committedDate": "2020-08-14T10:16:15Z", "type": "commit"}, {"oid": "4053cee3c3ee6f5cbe4aabbfec16a99c79deb48b", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/4053cee3c3ee6f5cbe4aabbfec16a99c79deb48b", "message": "Add eof line", "committedDate": "2020-08-14T10:16:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDU3MTMwNA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25285#discussion_r470571304", "bodyText": "There seems to be lots of work in validating a very simple bir? Can't we simplify this. I mean some assert function that would validate the expected and the current would be useful.", "author": "riyafa", "createdAt": "2020-08-14T11:35:21Z", "path": "docs/bir-spec/src/test/java/org/ballerinalang/birspec/BIRSpecTest.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.ballerinalang.birspec;\n+\n+import io.kaitai.struct.ByteBufferKaitaiStream;\n+import org.ballerinalang.build.kaitai.Bir;\n+import org.ballerinalang.test.util.BCompileUtil;\n+import org.ballerinalang.test.util.CompileResult;\n+import org.testng.Assert;\n+import org.testng.annotations.Test;\n+import org.wso2.ballerinalang.compiler.bir.model.BIRNode;\n+import org.wso2.ballerinalang.compiler.semantics.model.symbols.BPackageSymbol;\n+import org.wso2.ballerinalang.compiler.tree.BLangPackage;\n+import org.wso2.ballerinalang.programfile.CompiledBinaryFile.BIRPackageFile;\n+\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * Test cases to verify BIR binary against the spec.\n+ */\n+public class BIRSpecTest {\n+\n+    @Test(description = \"A simple test to verify BIR binary of a ballerina source with an empty method\")\n+    public void basicTest() {", "originalCommit": "4053cee3c3ee6f5cbe4aabbfec16a99c79deb48b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDU3NTcxMQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25285#discussion_r470575711", "bodyText": "Then the expected and the current would be more obvious. I think they are hidden in some complex code at the present", "author": "riyafa", "createdAt": "2020-08-14T11:45:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDU3MTMwNA=="}], "type": "inlineReview", "revised_code": {"commit": "f969eb158fd1f1856981775bc5a2e8f610423e33", "chunk": "diff --git a/docs/bir-spec/src/test/java/org/ballerinalang/birspec/BIRSpecTest.java b/docs/bir-spec/src/test/java/org/ballerinalang/birspec/BIRSpecTest.java\nindex 00bf912c7af..2715213ecf7 100644\n--- a/docs/bir-spec/src/test/java/org/ballerinalang/birspec/BIRSpecTest.java\n+++ b/docs/bir-spec/src/test/java/org/ballerinalang/birspec/BIRSpecTest.java\n\n@@ -17,55 +17,20 @@\n  */\n package org.ballerinalang.birspec;\n \n-import io.kaitai.struct.ByteBufferKaitaiStream;\n-import org.ballerinalang.build.kaitai.Bir;\n-import org.ballerinalang.test.util.BCompileUtil;\n-import org.ballerinalang.test.util.CompileResult;\n-import org.testng.Assert;\n import org.testng.annotations.Test;\n-import org.wso2.ballerinalang.compiler.bir.model.BIRNode;\n-import org.wso2.ballerinalang.compiler.semantics.model.symbols.BPackageSymbol;\n-import org.wso2.ballerinalang.compiler.tree.BLangPackage;\n-import org.wso2.ballerinalang.programfile.CompiledBinaryFile.BIRPackageFile;\n-\n-import java.util.Map;\n-import java.util.stream.Collectors;\n \n /**\n  * Test cases to verify BIR binary against the spec.\n  */\n public class BIRSpecTest {\n \n-    @Test(description = \"A simple test to verify BIR binary of a ballerina source with an empty method\")\n-    public void basicTest() {\n-\n-        CompileResult result = BCompileUtil.compileAndGetBIR(\"test-src/basic/function.bal\");\n-        Assert.assertEquals(result.getErrorCount(), 0);\n-\n-        BPackageSymbol packageSymbol = ((BLangPackage) result.getAST()).symbol;\n-        BIRPackageFile birPackageFile = packageSymbol.birPackageFile;\n-        Assert.assertNotNull(birPackageFile);\n-\n-        byte[] birBinaryContent = birPackageFile.pkgBirBinaryContent;\n-        Assert.assertNotNull(birBinaryContent);\n-\n-        BIRNode.BIRPackage originalBir = packageSymbol.bir;\n-        Bir kaitaiBir = new Bir(new ByteBufferKaitaiStream(birBinaryContent));\n-\n-        Bir.ConstantPoolSet birConstantPool = kaitaiBir.constantPool();\n-        Bir.Module birModule = kaitaiBir.module();\n-\n-        Assert.assertTrue(birConstantPool.constantPoolCount() > 0);\n-        Assert.assertEquals(birModule.functionCount(), originalBir.functions.size());\n-\n-        Map<String, BIRNode.BIRFunction> collect = originalBir.functions.stream()\n-                .collect(Collectors.toMap(func -> func.name.value, func -> func));\n+    @Test(description = \"Test to verify BIR with functions\")\n+    public void functionNameTest() {\n+        BIRTestUtils.assertFunctions(\"basic/function.bal\");\n+    }\n \n-        for (Bir.Function func : birModule.functions()) {\n-            Bir.ConstantPoolEntry constantPoolEntry = birConstantPool.constantPoolEntries().get(func.nameCpIndex());\n-            Assert.assertTrue(constantPoolEntry.cpInfo() instanceof Bir.StringCpInfo);\n-            Bir.StringCpInfo functionNameCPInfo = (Bir.StringCpInfo) constantPoolEntry.cpInfo();\n-            Assert.assertTrue(collect.containsKey(functionNameCPInfo.value()));\n-        }\n+    @Test(description = \"Test to verify BIR with constant values\")\n+    public void constantValueTest() {\n+        BIRTestUtils.assertConstants(\"basic/constant.bal\");\n     }\n }\n"}}, {"oid": "f85b443fdf68e97f82552e3e647f68835c92ca2a", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/f85b443fdf68e97f82552e3e647f68835c92ca2a", "message": "Update BIR spec file with constants & typedef structures", "committedDate": "2020-08-20T17:19:36Z", "type": "commit"}, {"oid": "be80f23eae8ec88704c9b1381ec3335124266076", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/be80f23eae8ec88704c9b1381ec3335124266076", "message": "Add utility class to help with testing BIR model", "committedDate": "2020-08-20T17:20:57Z", "type": "commit"}, {"oid": "f969eb158fd1f1856981775bc5a2e8f610423e33", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/f969eb158fd1f1856981775bc5a2e8f610423e33", "message": "Add constant values BIR test case", "committedDate": "2020-08-20T17:23:26Z", "type": "commit"}, {"oid": "f969eb158fd1f1856981775bc5a2e8f610423e33", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/f969eb158fd1f1856981775bc5a2e8f610423e33", "message": "Add constant values BIR test case", "committedDate": "2020-08-20T17:23:26Z", "type": "forcePushed"}, {"oid": "d6b207c3a72a200a94e70632ad685fc1eb39ad72", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/d6b207c3a72a200a94e70632ad685fc1eb39ad72", "message": "Update BIR spec with map constant info", "committedDate": "2020-08-21T04:21:50Z", "type": "commit"}, {"oid": "64a6ee4856df8669ef6539d6b24d67da7ead25c5", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/64a6ee4856df8669ef6539d6b24d67da7ead25c5", "message": "Rafactor BIR test utility class and update", "committedDate": "2020-08-21T04:36:44Z", "type": "commit"}, {"oid": "0c21bae6a507c1f8913f39f5b27d0746b670ce83", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/0c21bae6a507c1f8913f39f5b27d0746b670ce83", "message": "Refactor test directory structure", "committedDate": "2020-08-21T04:37:38Z", "type": "commit"}, {"oid": "121c6716618580858d0331ddcefbf9c3f3897a69", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/121c6716618580858d0331ddcefbf9c3f3897a69", "message": "Update BIR spec with typedefs info", "committedDate": "2020-08-24T05:39:14Z", "type": "commit"}, {"oid": "4f406475fcd0382683ac91ac93d8a028a620eff0", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/4f406475fcd0382683ac91ac93d8a028a620eff0", "message": "Update functions test with more cases", "committedDate": "2020-08-24T05:40:12Z", "type": "commit"}, {"oid": "445fcda24c3c36c295d3cf24768e2af35483afdb", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/445fcda24c3c36c295d3cf24768e2af35483afdb", "message": "Add BIR type def tests", "committedDate": "2020-08-24T05:40:33Z", "type": "commit"}, {"oid": "2a6db11c96c95c9fb1a5e9506c35cb50b64e1b97", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/2a6db11c96c95c9fb1a5e9506c35cb50b64e1b97", "message": "Use type instead of direct access of typetag", "committedDate": "2020-08-24T05:51:14Z", "type": "commit"}, {"oid": "d72b65a461f86e82afd1375a123b94b56a4422d9", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/d72b65a461f86e82afd1375a123b94b56a4422d9", "message": "Update BIR tests with more cases", "committedDate": "2020-08-24T06:58:15Z", "type": "forcePushed"}, {"oid": "fd5f4110dd9c00bc1a6f774cd0e97d202eed647f", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/fd5f4110dd9c00bc1a6f774cd0e97d202eed647f", "message": "Update BIR tests with more cases", "committedDate": "2020-08-24T06:58:58Z", "type": "commit"}, {"oid": "fd5f4110dd9c00bc1a6f774cd0e97d202eed647f", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/fd5f4110dd9c00bc1a6f774cd0e97d202eed647f", "message": "Update BIR tests with more cases", "committedDate": "2020-08-24T06:58:58Z", "type": "forcePushed"}]}