{"pr_number": 23896, "pr_title": "Fix webSocket test errrors", "pr_createdAt": "2020-06-10T16:48:07Z", "pr_url": "https://github.com/ballerina-platform/ballerina-lang/pull/23896", "timeline": [{"oid": "7fdba396c33eab9d5734eb265c36e27892f7fefc", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/7fdba396c33eab9d5734eb265c36e27892f7fefc", "message": "Merge branch 'http-mod' of https://github.com/chamil321/ballerina into grpc_error", "committedDate": "2020-06-10T03:30:38Z", "type": "commit"}, {"oid": "9bbee377da34cd56b4989a2981d82bfb8e24ea74", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/9bbee377da34cd56b4989a2981d82bfb8e24ea74", "message": "Fix webSocket test errors", "committedDate": "2020-06-10T14:39:36Z", "type": "commit"}, {"oid": "a79186ca882841d5cb09ff6fb690afee2cd73867", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/a79186ca882841d5cb09ff6fb690afee2cd73867", "message": "Remove printStream", "committedDate": "2020-06-10T16:43:52Z", "type": "commit"}, {"oid": "5671532b7ff8346307914ac251e082bfe502a3c9", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/5671532b7ff8346307914ac251e082bfe502a3c9", "message": "Merge branch '23283-add-distinct-type' of https://github.com/ballerina-platform/ballerina-lang into grpc_error", "committedDate": "2020-06-11T06:06:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU1Njg3Mw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/23896#discussion_r438556873", "bodyText": "Did you check this with lang team? Why do we need the typeId?", "author": "chamil321", "createdAt": "2020-06-11T05:52:05Z", "path": "bvm/ballerina-runtime/src/main/java/org/ballerinalang/jvm/BallerinaErrors.java", "diffHunk": "@@ -121,7 +121,7 @@ public static ErrorValue createDistinctError(String typeIdName, BPackage typeIdP\n         return error;\n     }\n \n-    private static void setTypeId(String typeIdName, BPackage typeIdPkg, ErrorValue error) {\n+    public static void setTypeId(String typeIdName, BPackage typeIdPkg, ErrorValue error) {", "originalCommit": "a79186ca882841d5cb09ff6fb690afee2cd73867", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODcwNDk1OQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/23896#discussion_r438704959", "bodyText": "No, I didn't check with them.\nWebSocketException class extends Errorvalue. It returns ErrorValue without setting typeId. Therefore, I had to set the typeId in the module.", "author": "kalaiyarasiganeshalingam", "createdAt": "2020-06-11T10:59:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU1Njg3Mw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU3NDQxMQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/23896#discussion_r438574411", "bodyText": "Unless we trap this error in Ballerina and convert to a error value, I don't think we need to do this here.", "author": "rdhananjaya", "createdAt": "2020-06-11T06:43:32Z", "path": "stdlib/http/src/main/java/org/ballerinalang/net/http/websocket/WebSocketUtil.java", "diffHunk": "@@ -575,6 +576,28 @@ public static void countDownForHandshake(ObjectValue webSocketClient) {\n         }\n     }\n \n+    public static WebSocketException getWebSocketException(String msg, Throwable error, String errorCode,\n+                                                           ErrorValue cause) {\n+        WebSocketException exception;\n+        String message = errorCode.substring(2) + \": \" + msg;\n+        if (!msg.isEmpty()) {\n+            exception = new WebSocketException(message);\n+        } else if (error != null) {\n+            exception = new WebSocketException(error);\n+        } else {\n+            exception = new WebSocketException(message, cause);\n+        }\n+        BallerinaErrors.setTypeId(errorCode, WebSocketConstants.PROTOCOL_HTTP_PKG_ID, exception);\n+        return exception;\n+    }\n+\n+    public static void setNotifyFailure(String msg, NonBlockingCallback callback) {\n+        WebSocketException exception = new WebSocketException(msg);\n+        BallerinaErrors.setTypeId(WebSocketConstants.ErrorCode.WsInvalidHandshakeError.toString(),", "originalCommit": "a79186ca882841d5cb09ff6fb690afee2cd73867", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODc1MjY0MQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/23896#discussion_r438752641", "bodyText": "Had a discussion with @kalaiyarasiganeshalingam and it turned out this exception is mapped to Ballerina distinct error defined here https://github.com/ballerina-platform/ballerina-lang/pull/23896/files#diff-0dc26ba9e7a9ac8f581ee802d2a2338dR21\nHence this change is needed.", "author": "rdhananjaya", "createdAt": "2020-06-11T12:41:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU3NDQxMQ=="}], "type": "inlineReview", "revised_code": {"commit": "5ab9f00960e4839d18cff8de0417472e5d6371ee", "chunk": "diff --git a/stdlib/http/src/main/java/org/ballerinalang/net/http/websocket/WebSocketUtil.java b/stdlib/http/src/main/java/org/ballerinalang/net/http/websocket/WebSocketUtil.java\nindex 268c1be5c1b..818dc9a0f6f 100644\n--- a/stdlib/http/src/main/java/org/ballerinalang/net/http/websocket/WebSocketUtil.java\n+++ b/stdlib/http/src/main/java/org/ballerinalang/net/http/websocket/WebSocketUtil.java\n\n@@ -576,26 +575,24 @@ public class WebSocketUtil {\n         }\n     }\n \n-    public static WebSocketException getWebSocketException(String msg, Throwable error, String errorCode,\n+    public static WebSocketException getWebSocketException(String msg, Throwable throwable, String errorCode,\n                                                            ErrorValue cause) {\n         WebSocketException exception;\n         String message = errorCode.substring(2) + \": \" + msg;\n-        if (!msg.isEmpty()) {\n-            exception = new WebSocketException(message);\n-        } else if (error != null) {\n-            exception = new WebSocketException(error);\n-        } else {\n+        if (throwable != null) {\n+            exception = new WebSocketException(throwable);\n+        } else if (cause != null) {\n             exception = new WebSocketException(message, cause);\n+        } else {\n+            exception = new WebSocketException(message);\n         }\n         BallerinaErrors.setTypeId(errorCode, WebSocketConstants.PROTOCOL_HTTP_PKG_ID, exception);\n         return exception;\n     }\n \n     public static void setNotifyFailure(String msg, NonBlockingCallback callback) {\n-        WebSocketException exception = new WebSocketException(msg);\n-        BallerinaErrors.setTypeId(WebSocketConstants.ErrorCode.WsInvalidHandshakeError.toString(),\n-                WebSocketConstants.PROTOCOL_HTTP_PKG_ID, exception);\n-        callback.notifyFailure(exception);\n+        callback.notifyFailure(getWebSocketException(msg, null,\n+                WebSocketConstants.ErrorCode.WsInvalidHandshakeError.errorCode(), null));\n     }\n \n     private WebSocketUtil() {\n"}}, {"oid": "5ab9f00960e4839d18cff8de0417472e5d6371ee", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/5ab9f00960e4839d18cff8de0417472e5d6371ee", "message": "Improve the implementation", "committedDate": "2020-06-11T14:19:17Z", "type": "commit"}]}