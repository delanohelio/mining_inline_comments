{"pr_number": 21320, "pr_title": "Fix Compilation error when function has a function typed param with only rest params", "pr_createdAt": "2020-02-27T08:14:05Z", "pr_url": "https://github.com/ballerina-platform/ballerina-lang/pull/21320", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA3NDAzNg==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21320#discussion_r385074036", "bodyText": "We normally don't mention the issue number on fixes. Shall we remove the issue number?", "author": "irshadnilam", "createdAt": "2020-02-27T11:40:19Z", "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/parser/BLangPackageBuilder.java", "diffHunk": "@@ -574,6 +574,9 @@ void addFunctionType(DiagnosticPos pos, Set<Whitespace> ws, boolean paramsAvail,\n         if (paramsAvail) {\n             functionTypeNode.addWS(commaWsStack.pop());\n             functionTypeNode.params.addAll(this.varListStack.pop());\n+        } else if (restParamAvail) {\n+            // VarListStack pops when function typed param has only rest params, Fix for: 20919", "originalCommit": "d64fd3e833536be164bdf00a5a60dd21e7e08125", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA4ODMwMg==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21320#discussion_r385088302", "bodyText": "+1", "author": "dulvinw", "createdAt": "2020-02-27T12:12:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA3NDAzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ5NjE3Ng==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21320#discussion_r385496176", "bodyText": "Okay. Thanks!", "author": "dulajdilshan", "createdAt": "2020-02-28T03:53:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA3NDAzNg=="}], "type": "inlineReview", "revised_code": {"commit": "5635a38ec1173c52a27e57dd54222f1f2cf07f35", "chunk": "diff --git a/compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/parser/BLangPackageBuilder.java b/compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/parser/BLangPackageBuilder.java\nindex a34093a06c3..3974b243c5f 100644\n--- a/compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/parser/BLangPackageBuilder.java\n+++ b/compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/parser/BLangPackageBuilder.java\n\n@@ -575,7 +575,7 @@ public class BLangPackageBuilder {\n             functionTypeNode.addWS(commaWsStack.pop());\n             functionTypeNode.params.addAll(this.varListStack.pop());\n         } else if (restParamAvail) {\n-            // VarListStack pops when function typed param has only rest params, Fix for: 20919\n+            // VarListStack pops when function typed param has only rest params\n             this.varListStack.pop();\n         }\n \n"}}, {"oid": "5635a38ec1173c52a27e57dd54222f1f2cf07f35", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/5635a38ec1173c52a27e57dd54222f1f2cf07f35", "message": "Fix some code practices issues", "committedDate": "2020-02-28T09:51:29Z", "type": "forcePushed"}, {"oid": "90529b291b355958c1040103b5ab3799ffb333ac", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/90529b291b355958c1040103b5ab3799ffb333ac", "message": "Fix some code practices issues", "committedDate": "2020-02-28T09:54:26Z", "type": "forcePushed"}, {"oid": "92c564970f91e9ffea457f6e43cae43953344e6b", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/92c564970f91e9ffea457f6e43cae43953344e6b", "message": "Resolve param issue when function typed params with rest params are used", "committedDate": "2020-02-28T11:14:13Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjMzNzAyNA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21320#discussion_r386337024", "bodyText": "Do we need this comment? Shall we maybe improve it to indicate popping out the empty list added to the var list stack if no non-rest params are available?", "author": "MaryamZi", "createdAt": "2020-03-02T11:24:22Z", "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/parser/BLangPackageBuilder.java", "diffHunk": "@@ -574,6 +574,9 @@ void addFunctionType(DiagnosticPos pos, Set<Whitespace> ws, boolean paramsAvail,\n         if (paramsAvail) {\n             functionTypeNode.addWS(commaWsStack.pop());\n             functionTypeNode.params.addAll(this.varListStack.pop());\n+        } else if (restParamAvail) {\n+            // VarListStack pops when function typed param has only rest params", "originalCommit": "92c564970f91e9ffea457f6e43cae43953344e6b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjgxNTk5Mw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21320#discussion_r386815993", "bodyText": "Thanks. Resolved", "author": "dulajdilshan", "createdAt": "2020-03-03T06:09:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjMzNzAyNA=="}], "type": "inlineReview", "revised_code": {"commit": "cd1ba9cf87786fa5dba9eaefbd57c2eba8693021", "chunk": "diff --git a/compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/parser/BLangPackageBuilder.java b/compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/parser/BLangPackageBuilder.java\nindex 3974b243c5f..620f247c8da 100644\n--- a/compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/parser/BLangPackageBuilder.java\n+++ b/compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/parser/BLangPackageBuilder.java\n\n@@ -575,7 +575,7 @@ public class BLangPackageBuilder {\n             functionTypeNode.addWS(commaWsStack.pop());\n             functionTypeNode.params.addAll(this.varListStack.pop());\n         } else if (restParamAvail) {\n-            // VarListStack pops when function typed param has only rest params\n+            // VarListStack pops out the empty list added to the var list stack if no non-rest params are available\n             this.varListStack.pop();\n         }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjMzODAwNA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21320#discussion_r386338004", "bodyText": "Since recently, we've been trying to write the tests more in Ballerina. For example, \n  \n    \n      ballerina-lang/tests/jballerina-unit-test/src/test/resources/test-src/expressions/mappingconstructor/spread_op_field.bal\n    \n    \n         Line 31\n      in\n      133d901\n    \n    \n    \n    \n\n        \n          \n           public function testMapRefAsSpreadOp() { \n        \n    \n  \n\n.\nShall we try and do the same for the newly added tests?", "author": "MaryamZi", "createdAt": "2020-03-02T11:26:32Z", "path": "tests/jballerina-unit-test/src/test/java/org/ballerinalang/test/functions/FunctionSignatureTest.java", "diffHunk": "@@ -444,4 +444,30 @@ public static ArrayValue mockedNativeFuncWithOptionalParams(long a, double b, St\n         tuple.add(4, (Object) e);\n         return tuple;\n     }\n+\n+    @Test(description = \"Test1: function signature which has a function typed param with only rest param\")", "originalCommit": "92c564970f91e9ffea457f6e43cae43953344e6b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjkxMjI5Nw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21320#discussion_r386912297", "bodyText": "Thanks. Changes are done", "author": "dulajdilshan", "createdAt": "2020-03-03T10:01:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjMzODAwNA=="}], "type": "inlineReview", "revised_code": {"commit": "cd1ba9cf87786fa5dba9eaefbd57c2eba8693021", "chunk": "diff --git a/tests/jballerina-unit-test/src/test/java/org/ballerinalang/test/functions/FunctionSignatureTest.java b/tests/jballerina-unit-test/src/test/java/org/ballerinalang/test/functions/FunctionSignatureTest.java\nindex e5c02ba98a7..f2dc15e73d7 100644\n--- a/tests/jballerina-unit-test/src/test/java/org/ballerinalang/test/functions/FunctionSignatureTest.java\n+++ b/tests/jballerina-unit-test/src/test/java/org/ballerinalang/test/functions/FunctionSignatureTest.java\n\n@@ -447,27 +447,11 @@ public class FunctionSignatureTest {\n \n     @Test(description = \"Test1: function signature which has a function typed param with only rest param\")\n     public void testFunctionWithFunctionTypedParamWithOnlyRestParam1() {\n-        BValue[] returns = BRunUtil.invoke(result,\n-                \"testFunctionOfFunctionTypedParamWithRest1\");\n-\n-        Assert.assertEquals(returns.length, 2);\n-        Assert.assertSame(returns[0].getClass(), BInteger.class);\n-        Assert.assertSame(returns[1].getClass(), BInteger.class);\n-\n-        Assert.assertEquals(((BInteger) returns[0]).intValue(), 4);\n-        Assert.assertEquals(((BInteger) returns[0]).intValue(), 4);\n+        BRunUtil.invoke(result, \"testFunctionOfFunctionTypedParamWithRest1\");\n     }\n \n     @Test(description = \"Test2: function signature which has a function typed param with only rest param\")\n     public void testFunctionWithFunctionTypedParamWithOnlyRestParam2() {\n-        BValue[] returns = BRunUtil.invoke(result,\n-                \"testFunctionOfFunctionTypedParamWithRest2\");\n-\n-        Assert.assertEquals(returns.length, 2);\n-        Assert.assertSame(returns[0].getClass(), BInteger.class);\n-        Assert.assertSame(returns[1].getClass(), BInteger.class);\n-\n-        Assert.assertEquals(((BInteger) returns[0]).intValue(), 10);\n-        Assert.assertEquals(((BInteger) returns[0]).intValue(), 10);\n+        BRunUtil.invoke(result, \"testFunctionOfFunctionTypedParamWithRest2\");\n     }\n }\n"}}, {"oid": "cd1ba9cf87786fa5dba9eaefbd57c2eba8693021", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/cd1ba9cf87786fa5dba9eaefbd57c2eba8693021", "message": "Resolve param issue when function typed params with rest params are used", "committedDate": "2020-03-03T10:35:19Z", "type": "commit"}, {"oid": "cd1ba9cf87786fa5dba9eaefbd57c2eba8693021", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/cd1ba9cf87786fa5dba9eaefbd57c2eba8693021", "message": "Resolve param issue when function typed params with rest params are used", "committedDate": "2020-03-03T10:35:19Z", "type": "forcePushed"}]}