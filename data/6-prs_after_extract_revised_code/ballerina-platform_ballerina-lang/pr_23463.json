{"pr_number": 23463, "pr_title": "Add Maven resolving support to the Bindgen tool", "pr_createdAt": "2020-05-25T06:02:33Z", "pr_url": "https://github.com/ballerina-platform/ballerina-lang/pull/23463", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc2ODM2Mw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/23463#discussion_r429768363", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private Path sourceRootPath = Paths.get(System.getProperty(\"user.dir\"));\n          \n          \n            \n                private Path sourceRootPath = Paths.get(System.getProperty(USER_DIR));\n          \n      \n    \n    \n  \n\nCan we use USER_DIR from BindgenConstants?", "author": "pramodya1994", "createdAt": "2020-05-25T07:14:44Z", "path": "misc/ballerina-bindgen/src/main/java/org/ballerinalang/bindgen/command/BindgenCommand.java", "diffHunk": "@@ -38,6 +42,8 @@\n \n     private static final PrintStream outStream = System.out;\n     private static final PrintStream outError = System.err;\n+    private Path sourceRootPath = Paths.get(System.getProperty(\"user.dir\"));", "originalCommit": "17af64743789ef4b425025c5b7c3e624e5cac496", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc5MjU2Mg==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/23463#discussion_r429792562", "bodyText": "Yes, fixed.", "author": "IrushiL", "createdAt": "2020-05-25T08:06:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc2ODM2Mw=="}], "type": "inlineReview", "revised_code": {"commit": "44a31bfe333b458856944aa842c68c16000d5fb6", "chunk": "diff --git a/misc/ballerina-bindgen/src/main/java/org/ballerinalang/bindgen/command/BindgenCommand.java b/misc/ballerina-bindgen/src/main/java/org/ballerinalang/bindgen/command/BindgenCommand.java\nindex 59444a1de80..b5042cb9adc 100644\n--- a/misc/ballerina-bindgen/src/main/java/org/ballerinalang/bindgen/command/BindgenCommand.java\n+++ b/misc/ballerina-bindgen/src/main/java/org/ballerinalang/bindgen/command/BindgenCommand.java\n\n@@ -42,8 +43,7 @@ public class BindgenCommand implements BLauncherCmd {\n \n     private static final PrintStream outStream = System.out;\n     private static final PrintStream outError = System.err;\n-    private Path sourceRootPath = Paths.get(System.getProperty(\"user.dir\"));\n-    private Path targetOutputPath = sourceRootPath;\n+    private Path targetOutputPath = Paths.get(System.getProperty(USER_DIR));\n \n     @CommandLine.Option(names = {\"-h\", \"--help\"}, hidden = true)\n     private boolean helpFlag;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc2OTEwNg==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/23463#discussion_r429769106", "bodyText": "Is there a possibility to use one variable for targetOutputPath and sourceRootPath?", "author": "pramodya1994", "createdAt": "2020-05-25T07:16:36Z", "path": "misc/ballerina-bindgen/src/main/java/org/ballerinalang/bindgen/command/BindgenCommand.java", "diffHunk": "@@ -38,6 +42,8 @@\n \n     private static final PrintStream outStream = System.out;\n     private static final PrintStream outError = System.err;\n+    private Path sourceRootPath = Paths.get(System.getProperty(\"user.dir\"));\n+    private Path targetOutputPath = sourceRootPath;", "originalCommit": "17af64743789ef4b425025c5b7c3e624e5cac496", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc5MjQxOQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/23463#discussion_r429792419", "bodyText": "Done.", "author": "IrushiL", "createdAt": "2020-05-25T08:06:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc2OTEwNg=="}], "type": "inlineReview", "revised_code": {"commit": "44a31bfe333b458856944aa842c68c16000d5fb6", "chunk": "diff --git a/misc/ballerina-bindgen/src/main/java/org/ballerinalang/bindgen/command/BindgenCommand.java b/misc/ballerina-bindgen/src/main/java/org/ballerinalang/bindgen/command/BindgenCommand.java\nindex 59444a1de80..b5042cb9adc 100644\n--- a/misc/ballerina-bindgen/src/main/java/org/ballerinalang/bindgen/command/BindgenCommand.java\n+++ b/misc/ballerina-bindgen/src/main/java/org/ballerinalang/bindgen/command/BindgenCommand.java\n\n@@ -42,8 +43,7 @@ public class BindgenCommand implements BLauncherCmd {\n \n     private static final PrintStream outStream = System.out;\n     private static final PrintStream outError = System.err;\n-    private Path sourceRootPath = Paths.get(System.getProperty(\"user.dir\"));\n-    private Path targetOutputPath = sourceRootPath;\n+    private Path targetOutputPath = Paths.get(System.getProperty(USER_DIR));\n \n     @CommandLine.Option(names = {\"-h\", \"--help\"}, hidden = true)\n     private boolean helpFlag;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc3MDYzOQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/23463#discussion_r429770639", "bodyText": "Shall we throw UnsupportedOperationException in setParentCmdParser(...) in line number 164?", "author": "pramodya1994", "createdAt": "2020-05-25T07:20:27Z", "path": "misc/ballerina-bindgen/src/main/java/org/ballerinalang/bindgen/command/BindgenCommand.java", "diffHunk": "@@ -87,6 +114,20 @@ public void execute() {\n             bindingsGenerator.setDependentJars(dependencyList);\n         }\n \n+        String splitColonRegex = \"\\\\s*:\\\\s*\";\n+        if (this.mavenDependency != null) {\n+            String[] mvnDependency = this.mavenDependency.split(splitColonRegex);\n+            if (mvnDependency.length != 3) {\n+                outError.println(\"\\nError in the maven dependency provided.\\n\");\n+                outStream.println(BINDGEN_CMD);\n+                outStream.println(\"\\nUse 'ballerina bindgen --help' for more information on the command.\");\n+                return;\n+            }\n+            bindingsGenerator.setMvnGroupId(mvnDependency[0]);\n+            bindingsGenerator.setMvnArtifactId(mvnDependency[1]);\n+            bindingsGenerator.setMvnVersion(mvnDependency[2]);\n+        }\n+", "originalCommit": "17af64743789ef4b425025c5b7c3e624e5cac496", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc5MjMyMQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/23463#discussion_r429792321", "bodyText": "All the other commands seem to be following this norm. I think we can keep this as it is.", "author": "IrushiL", "createdAt": "2020-05-25T08:05:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc3MDYzOQ=="}], "type": "inlineReview", "revised_code": {"commit": "910e5b55be0dc06a019963a6b010b1533ac8776b", "chunk": "diff --git a/misc/ballerina-bindgen/src/main/java/org/ballerinalang/bindgen/command/BindgenCommand.java b/misc/ballerina-bindgen/src/main/java/org/ballerinalang/bindgen/command/BindgenCommand.java\nindex 59444a1de80..acbe111738e 100644\n--- a/misc/ballerina-bindgen/src/main/java/org/ballerinalang/bindgen/command/BindgenCommand.java\n+++ b/misc/ballerina-bindgen/src/main/java/org/ballerinalang/bindgen/command/BindgenCommand.java\n\n@@ -114,20 +100,6 @@ public class BindgenCommand implements BLauncherCmd {\n             bindingsGenerator.setDependentJars(dependencyList);\n         }\n \n-        String splitColonRegex = \"\\\\s*:\\\\s*\";\n-        if (this.mavenDependency != null) {\n-            String[] mvnDependency = this.mavenDependency.split(splitColonRegex);\n-            if (mvnDependency.length != 3) {\n-                outError.println(\"\\nError in the maven dependency provided.\\n\");\n-                outStream.println(BINDGEN_CMD);\n-                outStream.println(\"\\nUse 'ballerina bindgen --help' for more information on the command.\");\n-                return;\n-            }\n-            bindingsGenerator.setMvnGroupId(mvnDependency[0]);\n-            bindingsGenerator.setMvnArtifactId(mvnDependency[1]);\n-            bindingsGenerator.setMvnVersion(mvnDependency[2]);\n-        }\n-\n         bindingsGenerator.setClassNames(this.classNames);\n         try {\n             bindingsGenerator.generateJavaBindings();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc3MDY1OA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/23463#discussion_r429770658", "bodyText": "@IrushiL There has to be a space before colon. Usually these should be detected by check style validations.", "author": "keizer619", "createdAt": "2020-05-25T07:20:30Z", "path": "misc/ballerina-bindgen/src/main/java/org/ballerinalang/bindgen/command/BindingsGenerator.java", "diffHunk": "@@ -79,6 +88,27 @@\n     private static Map<String, String> failedClassGens = new HashMap<>();\n \n     void generateJavaBindings() throws BindgenException {\n+        if (projectRoot != null) {\n+            Manifest manifest = TomlParserUtils.getManifest(projectRoot);\n+            if (manifest != null) {\n+                List<Library> platformLibraries = manifest.getPlatform().getLibraries();\n+                if (platformLibraries != null) {\n+                    for (Library library: platformLibraries) {", "originalCommit": "17af64743789ef4b425025c5b7c3e624e5cac496", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc5MDcwMQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/23463#discussion_r429790701", "bodyText": "Fixed it.", "author": "IrushiL", "createdAt": "2020-05-25T08:02:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc3MDY1OA=="}], "type": "inlineReview", "revised_code": {"commit": "44a31bfe333b458856944aa842c68c16000d5fb6", "chunk": "diff --git a/misc/ballerina-bindgen/src/main/java/org/ballerinalang/bindgen/command/BindingsGenerator.java b/misc/ballerina-bindgen/src/main/java/org/ballerinalang/bindgen/command/BindingsGenerator.java\nindex b3dc66d645b..be3a1c76aa8 100644\n--- a/misc/ballerina-bindgen/src/main/java/org/ballerinalang/bindgen/command/BindingsGenerator.java\n+++ b/misc/ballerina-bindgen/src/main/java/org/ballerinalang/bindgen/command/BindingsGenerator.java\n\n@@ -88,25 +88,13 @@ public class BindingsGenerator {\n     private static Map<String, String> failedClassGens = new HashMap<>();\n \n     void generateJavaBindings() throws BindgenException {\n-        if (projectRoot != null) {\n-            Manifest manifest = TomlParserUtils.getManifest(projectRoot);\n-            if (manifest != null) {\n-                List<Library> platformLibraries = manifest.getPlatform().getLibraries();\n-                if (platformLibraries != null) {\n-                    for (Library library: platformLibraries) {\n-                        if (library.path != null) {\n-                            classPaths.add(Paths.get(projectRoot.toString(), library.path).toString());\n-                        } else if (library.groupId != null && library.artifactId != null && library.version != null) {\n-                            mavenResolver(library.groupId, library.artifactId, library.version, projectRoot);\n-                        }\n-                    }\n-                }\n-            }\n-        }\n+        // Resolve existing platform.libraries specified in the Ballerina.toml\n+        resolvePlatformLibraries();\n \n-        // Resolve the maven dependency and update the Ballerina.toml file\n+        // Resolve the maven dependency received through the tool and update the Ballerina.toml file\n+        // with the direct and transitive platform.libraries\n         if ((mvnGroupId != null) && (mvnArtifactId != null) && (mvnVersion != null)) {\n-            mavenResolver(mvnGroupId, mvnArtifactId, mvnVersion, projectRoot);\n+            mavenResolver(mvnGroupId, mvnArtifactId, mvnVersion, projectRoot, true);\n         }\n \n         ClassLoader classLoader = setClassLoader();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc3Mzk4MQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/23463#discussion_r429773981", "bodyText": "Isn't it better to move this logic to a separate method? So we can reduce the complexity of the generateJavaBindings method.", "author": "pramodya1994", "createdAt": "2020-05-25T07:27:45Z", "path": "misc/ballerina-bindgen/src/main/java/org/ballerinalang/bindgen/command/BindingsGenerator.java", "diffHunk": "@@ -79,6 +88,27 @@\n     private static Map<String, String> failedClassGens = new HashMap<>();\n \n     void generateJavaBindings() throws BindgenException {\n+        if (projectRoot != null) {\n+            Manifest manifest = TomlParserUtils.getManifest(projectRoot);\n+            if (manifest != null) {\n+                List<Library> platformLibraries = manifest.getPlatform().getLibraries();\n+                if (platformLibraries != null) {\n+                    for (Library library: platformLibraries) {\n+                        if (library.path != null) {\n+                            classPaths.add(Paths.get(projectRoot.toString(), library.path).toString());\n+                        } else if (library.groupId != null && library.artifactId != null && library.version != null) {\n+                            mavenResolver(library.groupId, library.artifactId, library.version, projectRoot);\n+                        }\n+                    }\n+                }\n+            }\n+        }", "originalCommit": "17af64743789ef4b425025c5b7c3e624e5cac496", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc5MDU4Mg==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/23463#discussion_r429790582", "bodyText": "Done", "author": "IrushiL", "createdAt": "2020-05-25T08:02:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc3Mzk4MQ=="}], "type": "inlineReview", "revised_code": {"commit": "44a31bfe333b458856944aa842c68c16000d5fb6", "chunk": "diff --git a/misc/ballerina-bindgen/src/main/java/org/ballerinalang/bindgen/command/BindingsGenerator.java b/misc/ballerina-bindgen/src/main/java/org/ballerinalang/bindgen/command/BindingsGenerator.java\nindex b3dc66d645b..be3a1c76aa8 100644\n--- a/misc/ballerina-bindgen/src/main/java/org/ballerinalang/bindgen/command/BindingsGenerator.java\n+++ b/misc/ballerina-bindgen/src/main/java/org/ballerinalang/bindgen/command/BindingsGenerator.java\n\n@@ -88,25 +88,13 @@ public class BindingsGenerator {\n     private static Map<String, String> failedClassGens = new HashMap<>();\n \n     void generateJavaBindings() throws BindgenException {\n-        if (projectRoot != null) {\n-            Manifest manifest = TomlParserUtils.getManifest(projectRoot);\n-            if (manifest != null) {\n-                List<Library> platformLibraries = manifest.getPlatform().getLibraries();\n-                if (platformLibraries != null) {\n-                    for (Library library: platformLibraries) {\n-                        if (library.path != null) {\n-                            classPaths.add(Paths.get(projectRoot.toString(), library.path).toString());\n-                        } else if (library.groupId != null && library.artifactId != null && library.version != null) {\n-                            mavenResolver(library.groupId, library.artifactId, library.version, projectRoot);\n-                        }\n-                    }\n-                }\n-            }\n-        }\n+        // Resolve existing platform.libraries specified in the Ballerina.toml\n+        resolvePlatformLibraries();\n \n-        // Resolve the maven dependency and update the Ballerina.toml file\n+        // Resolve the maven dependency received through the tool and update the Ballerina.toml file\n+        // with the direct and transitive platform.libraries\n         if ((mvnGroupId != null) && (mvnArtifactId != null) && (mvnVersion != null)) {\n-            mavenResolver(mvnGroupId, mvnArtifactId, mvnVersion, projectRoot);\n+            mavenResolver(mvnGroupId, mvnArtifactId, mvnVersion, projectRoot, true);\n         }\n \n         ClassLoader classLoader = setClassLoader();\n"}}, {"oid": "44a31bfe333b458856944aa842c68c16000d5fb6", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/44a31bfe333b458856944aa842c68c16000d5fb6", "message": "Improve the maven resolving userbility", "committedDate": "2020-05-26T06:45:15Z", "type": "forcePushed"}, {"oid": "910e5b55be0dc06a019963a6b010b1533ac8776b", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/910e5b55be0dc06a019963a6b010b1533ac8776b", "message": "Identify a Ballerina project", "committedDate": "2020-05-26T06:55:02Z", "type": "commit"}, {"oid": "04997cdc1dbe1a3baf3e6ed0a15baa8a8ffb2aa1", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/04997cdc1dbe1a3baf3e6ed0a15baa8a8ffb2aa1", "message": "Read platform libraries from Ballerina.toml", "committedDate": "2020-05-26T06:55:02Z", "type": "commit"}, {"oid": "913458b68c6e1b6f5716bccff736704d25702a41", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/913458b68c6e1b6f5716bccff736704d25702a41", "message": "Improve failed classpath additions error message", "committedDate": "2020-05-26T06:55:02Z", "type": "commit"}, {"oid": "c3bb2803a86e2f7f64ededebd167ddc2b4ca7cfa", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/c3bb2803a86e2f7f64ededebd167ddc2b4ca7cfa", "message": "Add maven support to the command", "committedDate": "2020-05-26T06:55:02Z", "type": "commit"}, {"oid": "6ed90f8dabb17a65ebff77de995bd1c5a2281ff7", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/6ed90f8dabb17a65ebff77de995bd1c5a2281ff7", "message": "Update the bindgen help file", "committedDate": "2020-05-26T06:55:02Z", "type": "commit"}, {"oid": "63cb831d190cca9bd7126c320d9118c126195adb", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/63cb831d190cca9bd7126c320d9118c126195adb", "message": "Add maven support for non Ballerina projects", "committedDate": "2020-05-26T06:55:02Z", "type": "commit"}, {"oid": "22c96b73f87c63409212d6c612a544b1f61ce8f5", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/22c96b73f87c63409212d6c612a544b1f61ce8f5", "message": "Add the maven resolver dependency", "committedDate": "2020-05-26T06:55:02Z", "type": "commit"}, {"oid": "7e9035091a0edd1b5547baa6e7201a97b10c4471", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/7e9035091a0edd1b5547baa6e7201a97b10c4471", "message": "Fix the project identification for exact project path", "committedDate": "2020-05-26T06:55:02Z", "type": "commit"}, {"oid": "70c29f0adfc98d0f85a80c4766f4b9ca76b1ab88", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/70c29f0adfc98d0f85a80c4766f4b9ca76b1ab88", "message": "Improve and add updating of Ballerina.toml component", "committedDate": "2020-05-26T06:55:02Z", "type": "commit"}, {"oid": "84da582e1bbdef82aab9994e5a61115ef5d7a979", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/84da582e1bbdef82aab9994e5a61115ef5d7a979", "message": "Fix checkstyle issues", "committedDate": "2020-05-26T06:55:02Z", "type": "commit"}, {"oid": "3bbcaa981673c30657006810956c05ffded8c87b", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/3bbcaa981673c30657006810956c05ffded8c87b", "message": "Fix review comments", "committedDate": "2020-05-26T06:55:02Z", "type": "commit"}, {"oid": "6d61ad5e258fa34b69953409593593041419c701", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/6d61ad5e258fa34b69953409593593041419c701", "message": "Update the Ballerina reserved words", "committedDate": "2020-05-26T06:55:02Z", "type": "commit"}, {"oid": "eba3c50f308f2b589d12b67484eaf9b12d7dda8b", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/eba3c50f308f2b589d12b67484eaf9b12d7dda8b", "message": "Improve the failed classpath addition error", "committedDate": "2020-05-26T06:55:03Z", "type": "commit"}, {"oid": "e63ecb8db6e9202519ddce3b0f90a2c2e1e2f0d1", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/e63ecb8db6e9202519ddce3b0f90a2c2e1e2f0d1", "message": "Address review suggestions", "committedDate": "2020-05-26T06:55:03Z", "type": "commit"}, {"oid": "60dcfc33ce2c5097c230e1fdb9eea96250bcddc6", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/60dcfc33ce2c5097c230e1fdb9eea96250bcddc6", "message": "Improve the maven resolving userbility", "committedDate": "2020-05-26T06:55:03Z", "type": "commit"}, {"oid": "60dcfc33ce2c5097c230e1fdb9eea96250bcddc6", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/60dcfc33ce2c5097c230e1fdb9eea96250bcddc6", "message": "Improve the maven resolving userbility", "committedDate": "2020-05-26T06:55:03Z", "type": "forcePushed"}, {"oid": "eeb75de913637b4083b729514cf2f501bd2556c5", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/eeb75de913637b4083b729514cf2f501bd2556c5", "message": "Add test cases for maven resolving integration", "committedDate": "2020-05-26T13:36:38Z", "type": "commit"}, {"oid": "ee647f44bac8b1299f10efcec3dbf96fcd28ff73", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/ee647f44bac8b1299f10efcec3dbf96fcd28ff73", "message": "Change the maven repo name to platform-libs", "committedDate": "2020-05-26T13:38:22Z", "type": "commit"}, {"oid": "c9ce787b4ecb066d1a498f2fa1f1347a3a853a99", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/c9ce787b4ecb066d1a498f2fa1f1347a3a853a99", "message": "Fix checkstyle issue", "committedDate": "2020-05-26T14:00:08Z", "type": "commit"}]}