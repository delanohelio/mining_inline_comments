{"pr_number": 276, "pr_title": "ShardedIntegrityChecksSparkJob RDD Union Removal", "pr_createdAt": "2020-04-03T16:31:27Z", "pr_url": "https://github.com/osmlab/atlas-checks/pull/276", "timeline": [{"oid": "985cf8a9c0b62c16258b1e9059a621491a7b6d63", "url": "https://github.com/osmlab/atlas-checks/commit/985cf8a9c0b62c16258b1e9059a621491a7b6d63", "message": "no union", "committedDate": "2020-04-02T22:58:23Z", "type": "commit"}, {"oid": "f9ea1d0aa2841b0eec7a7231c2efd3a02fbef90b", "url": "https://github.com/osmlab/atlas-checks/commit/f9ea1d0aa2841b0eec7a7231c2efd3a02fbef90b", "message": "update doc", "committedDate": "2020-04-03T16:30:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzI5MzYwMg==", "url": "https://github.com/osmlab/atlas-checks/pull/276#discussion_r403293602", "bodyText": "What is callSite.short ?", "author": "danielduhh", "createdAt": "2020-04-03T20:07:27Z", "path": "src/main/java/org/openstreetmap/atlas/checks/distributed/ShardedIntegrityChecksSparkJob.java", "diffHunk": "@@ -219,46 +204,27 @@ public void start(final CommandMap commandMap)\n                             .collect(Collectors.toList());\n \n                     // Set spark UI job title\n-                    this.getContext().setJobGroup(\"0\",\n-                            String.format(\"Running checks on %s\",\n-                                    tasksForCountry.get(0).getCountry()));\n-                    // Run each task in spark, producing UniqueCheckFlagContainers\n-                    final JavaPairRDD<String, UniqueCheckFlagContainer> rdd = this.getContext()\n-                            .parallelize(tasksForCountry, tasksForCountry.size())\n+                    this.getContext().setLocalProperty(\"callSite.short\", String", "originalCommit": "f9ea1d0aa2841b0eec7a7231c2efd3a02fbef90b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzI5NjM4OA==", "url": "https://github.com/osmlab/atlas-checks/pull/276#discussion_r403296388", "bodyText": "It is a special property that the Spark UI picks up for labeling.\nhttps://stackoverflow.com/questions/41903342/how-to-change-job-stage-description-in-web-ui", "author": "Bentleysb", "createdAt": "2020-04-03T20:11:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzI5MzYwMg=="}], "type": "inlineReview", "revised_code": null}, {"oid": "e33cb5e74744d07750ba7dda74b348eebc8b7ae2", "url": "https://github.com/osmlab/atlas-checks/commit/e33cb5e74744d07750ba7dda74b348eebc8b7ae2", "message": "Merge branch 'dev' into dev-shardedChecksNoUnion", "committedDate": "2020-04-07T01:55:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk5MDk3MA==", "url": "https://github.com/osmlab/atlas-checks/pull/276#discussion_r404990970", "bodyText": "What are we combining here, if not by country?", "author": "seancoulter", "createdAt": "2020-04-07T17:35:55Z", "path": "src/main/java/org/openstreetmap/atlas/checks/distributed/ShardedIntegrityChecksSparkJob.java", "diffHunk": "@@ -219,46 +204,27 @@ public void start(final CommandMap commandMap)\n                             .collect(Collectors.toList());\n \n                     // Set spark UI job title\n-                    this.getContext().setJobGroup(\"0\",\n-                            String.format(\"Running checks on %s\",\n-                                    tasksForCountry.get(0).getCountry()));\n-                    // Run each task in spark, producing UniqueCheckFlagContainers\n-                    final JavaPairRDD<String, UniqueCheckFlagContainer> rdd = this.getContext()\n-                            .parallelize(tasksForCountry, tasksForCountry.size())\n+                    this.getContext().setLocalProperty(\"callSite.short\", String\n+                            .format(\"Running checks on %s\", tasksForCountry.get(0).getCountry()));\n+\n+                    this.getContext().parallelize(tasksForCountry, tasksForCountry.size())\n                             .mapToPair(produceFlags(input, output, this.configurationMap(),\n                                     fileHelper, shardingBroadcast, distanceToLoadShards,\n-                                    (Boolean) commandMap.get(MULTI_ATLAS)));\n-                    // Save the RDD\n-                    rdd.persist(storageLevel);\n-                    // Use a fast spark action to overcome spark lazy elocution. This is necessary\n-                    // to get the UI title to appear in the right spot.\n-                    rdd.count();\n-                    // Add the RDDs to the list\n-                    countryRdds.add(rdd);\n+                                    (Boolean) commandMap.get(MULTI_ATLAS)))\n+                            .reduceByKey(UniqueCheckFlagContainer::combine)", "originalCommit": "e33cb5e74744d07750ba7dda74b348eebc8b7ae2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk5ODUwOA==", "url": "https://github.com/osmlab/atlas-checks/pull/276#discussion_r404998508", "bodyText": "It is by country, but there is only ever one country. This is just because the country code is passed through the streaming interface by using a pair RDD. The country code needs to be passed to processFlags via the RDD due to sparks lazy execution.", "author": "Bentleysb", "createdAt": "2020-04-07T17:48:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk5MDk3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTAzMTc4NQ==", "url": "https://github.com/osmlab/atlas-checks/pull/276#discussion_r405031785", "bodyText": "Ah that makes sense. Thanks", "author": "seancoulter", "createdAt": "2020-04-07T18:42:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk5MDk3MA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "f00323326a052e08e92ccc44cbc98f4adba1ab5c", "url": "https://github.com/osmlab/atlas-checks/commit/f00323326a052e08e92ccc44cbc98f4adba1ab5c", "message": "Merge branch 'dev' into dev-shardedChecksNoUnion", "committedDate": "2020-04-07T18:43:00Z", "type": "commit"}, {"oid": "62948d4805ae72d885c4ec670655a1453a67817e", "url": "https://github.com/osmlab/atlas-checks/commit/62948d4805ae72d885c4ec670655a1453a67817e", "message": "Merge branch 'dev' into dev-shardedChecksNoUnion", "committedDate": "2020-04-07T20:53:14Z", "type": "commit"}]}