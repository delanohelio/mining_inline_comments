{"pr_number": 1277, "pr_title": "Update SCM to notify listeners if fresh copy of capability is received", "pr_createdAt": "2020-02-17T16:20:40Z", "pr_url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1277", "timeline": [{"oid": "96fd89522baae44d64b541909d603dc397b1797c", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/96fd89522baae44d64b541909d603dc397b1797c", "message": "Notify listeners when fresh copy of capability is received", "committedDate": "2020-02-17T16:13:59Z", "type": "commit"}, {"oid": "fc779d67ae1400bfa04d30bcd7faaec6361628ba", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/fc779d67ae1400bfa04d30bcd7faaec6361628ba", "message": "Add more SCM unit tests", "committedDate": "2020-02-17T16:21:43Z", "type": "commit"}, {"oid": "43aa6dbcb5ad817fe5f494655c5badd4ab9e9d11", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/43aa6dbcb5ad817fe5f494655c5badd4ab9e9d11", "message": "Fix an issue in SCM unit tests", "committedDate": "2020-02-17T16:37:04Z", "type": "commit"}, {"oid": "f6a10d835cb5253a9af1f8f54b21ee9a85a081fa", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/f6a10d835cb5253a9af1f8f54b21ee9a85a081fa", "message": "Reformat code in setCapability() method", "committedDate": "2020-02-17T16:47:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTM1OTkyMA==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1277#discussion_r381359920", "bodyText": "It doesn't appear that you usually use tabs to align these param comments (e.g. above retrieveCapability()). I think this should be consistent. There really should be a project style guide where the correct style for this stuff can be noted.", "author": "joeljfischer", "createdAt": "2020-02-19T15:31:06Z", "path": "base/src/main/java/com/smartdevicelink/proxy/SystemCapabilityManager.java", "diffHunk": "@@ -335,11 +335,11 @@ public void onReceived(RPCMessage message) {\n \t * Sets a capability in the cached map. This should only be done when an RPC is received and contains updates to the capability\n \t * that is being cached in the SystemCapabilityManager.\n \t * @param systemCapabilityType the system capability type that will be set\n-\t * @param capability the value of the capability that will be set\n+\t * @param capability           the value of the capability that will be set", "originalCommit": "f6a10d835cb5253a9af1f8f54b21ee9a85a081fa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTUyNDYyNw==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1277#discussion_r381524627", "bodyText": "Yes, you are right, we don't usually do that. I used Android Studio Reformatter tool to reformat this method. It looks like the tool adds spaces to align the params. I will remove that for consistency.", "author": "bilal-alsharifi", "createdAt": "2020-02-19T20:26:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTM1OTkyMA=="}], "type": "inlineReview", "revised_code": {"commit": "9ec33af2d4c5eef78ea1c6c4b3defaf801af6815", "chunk": "diff --git a/base/src/main/java/com/smartdevicelink/proxy/SystemCapabilityManager.java b/base/src/main/java/com/smartdevicelink/proxy/SystemCapabilityManager.java\nindex 5ff022373..345a8da6e 100644\n--- a/base/src/main/java/com/smartdevicelink/proxy/SystemCapabilityManager.java\n+++ b/base/src/main/java/com/smartdevicelink/proxy/SystemCapabilityManager.java\n\n@@ -335,7 +335,7 @@ public class SystemCapabilityManager {\n \t * Sets a capability in the cached map. This should only be done when an RPC is received and contains updates to the capability\n \t * that is being cached in the SystemCapabilityManager.\n \t * @param systemCapabilityType the system capability type that will be set\n-\t * @param capability           the value of the capability that will be set\n+\t * @param capability the value of the capability that will be set\n \t */\n \tpublic synchronized void setCapability(SystemCapabilityType systemCapabilityType, Object capability) {\n \t\tcachedSystemCapabilities.put(systemCapabilityType, capability);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTM2MDEwNQ==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1277#discussion_r381360105", "bodyText": "I think that currently iOS always calls with a cached value even if the value is null. This may be a point to be aligned.", "author": "joeljfischer", "createdAt": "2020-02-19T15:36:28Z", "path": "base/src/main/java/com/smartdevicelink/proxy/SystemCapabilityManager.java", "diffHunk": "@@ -450,16 +450,17 @@ private boolean isSubscribedToSystemCapability(SystemCapabilityType systemCapabi\n \t */\n \tprivate Object getCapabilityPrivate(final SystemCapabilityType systemCapabilityType, final OnSystemCapabilityListener scListener, final Boolean subscribe, final boolean forceUpdate) {\n \t\tObject cachedCapability = cachedSystemCapabilities.get(systemCapabilityType);\n-\t\tOnSystemCapabilityListener listener = scListener;\n \n-\t\tif (!forceUpdate && cachedCapability != null && listener != null) {\n-\t\t\tlistener.onCapabilityRetrieved(cachedCapability);\n-\t\t\tlistener = null;\n+\t\tboolean shouldUpdateSystemCapabilitySubscription = (subscribe != null) && (subscribe != isSubscribedToSystemCapability(systemCapabilityType)) && supportsSubscriptions();\n+\t\tboolean shouldSendGetCapabilityRequest = forceUpdate || (cachedCapability == null) || shouldUpdateSystemCapabilitySubscription;\n+\t\tboolean shouldCallListenerWithCachedValue = (cachedCapability != null) && (scListener != null) && !shouldSendGetCapabilityRequest;", "originalCommit": "f6a10d835cb5253a9af1f8f54b21ee9a85a081fa", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTM2ODUwNQ==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1277#discussion_r381368505", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\t\t\t// If the listener is not included in the onSystemCapabilityListeners map, then notify it\n          \n          \n            \n            \t\t\t\t\t// If the listener is not included in the onSystemCapabilityListeners map (if it's used from getSystemCapability with a force update), then notify it", "author": "joeljfischer", "createdAt": "2020-02-19T15:59:36Z", "path": "base/src/main/java/com/smartdevicelink/proxy/SystemCapabilityManager.java", "diffHunk": "@@ -549,18 +550,27 @@ private void retrieveCapability(final SystemCapabilityType systemCapabilityType,\n \t\t}\n \t\tfinal GetSystemCapability request = new GetSystemCapability();\n \t\trequest.setSystemCapabilityType(systemCapabilityType);\n-\t\trequest.setSubscribe((subscribe != null) ? subscribe : isSubscribedToSystemCapability(systemCapabilityType)); // If subscribe is null, then don't change the current subscription status\n+\t\t// If subscribe is null, then don't change the current subscription status\n+\t\tfinal boolean shouldSubscribe = ((subscribe != null) ? subscribe : isSubscribedToSystemCapability(systemCapabilityType)) && supportsSubscriptions();\n+\t\trequest.setSubscribe(shouldSubscribe);\n \t\trequest.setOnRPCResponseListener(new OnRPCResponseListener() {\n \t\t\t@Override\n \t\t\tpublic void onResponse(int correlationId, RPCResponse response) {\n \t\t\t\tif (response.getSuccess()) {\n \t\t\t\t\tObject retrievedCapability = ((GetSystemCapabilityResponse) response).getSystemCapability().getCapabilityForType(systemCapabilityType);\n-\t\t\t\t\tcachedSystemCapabilities.put(systemCapabilityType, retrievedCapability);\n+\t\t\t\t\tsetCapability(systemCapabilityType, retrievedCapability);\n+\t\t\t\t\t// If the listener is not included in the onSystemCapabilityListeners map, then notify it", "originalCommit": "f6a10d835cb5253a9af1f8f54b21ee9a85a081fa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjExOTQxNA==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1277#discussion_r382119414", "bodyText": "Forcing an update is not the only case that triggers this logic. If forceUpdate=false, and the cap is not cashed, when we call GetCapablity(), this logic will be triggered. But you are right the comment is a little vague. I will update the comment.", "author": "bilal-alsharifi", "createdAt": "2020-02-20T16:38:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTM2ODUwNQ=="}], "type": "inlineReview", "revised_code": {"commit": "9ec33af2d4c5eef78ea1c6c4b3defaf801af6815", "chunk": "diff --git a/base/src/main/java/com/smartdevicelink/proxy/SystemCapabilityManager.java b/base/src/main/java/com/smartdevicelink/proxy/SystemCapabilityManager.java\nindex 5ff022373..345a8da6e 100644\n--- a/base/src/main/java/com/smartdevicelink/proxy/SystemCapabilityManager.java\n+++ b/base/src/main/java/com/smartdevicelink/proxy/SystemCapabilityManager.java\n\n@@ -563,7 +563,7 @@ public class SystemCapabilityManager {\n \t\t\t\t\tif (scListener != null) {\n \t\t\t\t\t\tsynchronized (LISTENER_LOCK) {\n \t\t\t\t\t\t\tCopyOnWriteArrayList<OnSystemCapabilityListener> notifiedListeners = onSystemCapabilityListeners.get(systemCapabilityType);\n-\t\t\t\t\t\t\tboolean listenerAlreadyNotified = notifiedListeners != null && notifiedListeners.contains(scListener);\n+\t\t\t\t\t\t\tboolean listenerAlreadyNotified = (notifiedListeners != null) && notifiedListeners.contains(scListener);\n \t\t\t\t\t\t\tif (!listenerAlreadyNotified) {\n \t\t\t\t\t\t\t\tscListener.onCapabilityRetrieved(retrievedCapability);\n \t\t\t\t\t\t\t}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTM3MDEyMA==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1277#discussion_r381370120", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\t\t\t\t\tboolean listenerAlreadyNotified = notifiedListeners != null && notifiedListeners.contains(scListener);\n          \n          \n            \n            \t\t\t\t\t\t\tboolean listenerAlreadyNotified = (notifiedListeners != null) && notifiedListeners.contains(scListener);", "author": "joeljfischer", "createdAt": "2020-02-19T16:01:46Z", "path": "base/src/main/java/com/smartdevicelink/proxy/SystemCapabilityManager.java", "diffHunk": "@@ -549,18 +550,27 @@ private void retrieveCapability(final SystemCapabilityType systemCapabilityType,\n \t\t}\n \t\tfinal GetSystemCapability request = new GetSystemCapability();\n \t\trequest.setSystemCapabilityType(systemCapabilityType);\n-\t\trequest.setSubscribe((subscribe != null) ? subscribe : isSubscribedToSystemCapability(systemCapabilityType)); // If subscribe is null, then don't change the current subscription status\n+\t\t// If subscribe is null, then don't change the current subscription status\n+\t\tfinal boolean shouldSubscribe = ((subscribe != null) ? subscribe : isSubscribedToSystemCapability(systemCapabilityType)) && supportsSubscriptions();\n+\t\trequest.setSubscribe(shouldSubscribe);\n \t\trequest.setOnRPCResponseListener(new OnRPCResponseListener() {\n \t\t\t@Override\n \t\t\tpublic void onResponse(int correlationId, RPCResponse response) {\n \t\t\t\tif (response.getSuccess()) {\n \t\t\t\t\tObject retrievedCapability = ((GetSystemCapabilityResponse) response).getSystemCapability().getCapabilityForType(systemCapabilityType);\n-\t\t\t\t\tcachedSystemCapabilities.put(systemCapabilityType, retrievedCapability);\n+\t\t\t\t\tsetCapability(systemCapabilityType, retrievedCapability);\n+\t\t\t\t\t// If the listener is not included in the onSystemCapabilityListeners map, then notify it\n \t\t\t\t\tif (scListener != null) {\n-\t\t\t\t\t\tscListener.onCapabilityRetrieved(retrievedCapability);\n+\t\t\t\t\t\tsynchronized (LISTENER_LOCK) {\n+\t\t\t\t\t\t\tCopyOnWriteArrayList<OnSystemCapabilityListener> notifiedListeners = onSystemCapabilityListeners.get(systemCapabilityType);\n+\t\t\t\t\t\t\tboolean listenerAlreadyNotified = notifiedListeners != null && notifiedListeners.contains(scListener);", "originalCommit": "f6a10d835cb5253a9af1f8f54b21ee9a85a081fa", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9ec33af2d4c5eef78ea1c6c4b3defaf801af6815", "chunk": "diff --git a/base/src/main/java/com/smartdevicelink/proxy/SystemCapabilityManager.java b/base/src/main/java/com/smartdevicelink/proxy/SystemCapabilityManager.java\nindex 5ff022373..345a8da6e 100644\n--- a/base/src/main/java/com/smartdevicelink/proxy/SystemCapabilityManager.java\n+++ b/base/src/main/java/com/smartdevicelink/proxy/SystemCapabilityManager.java\n\n@@ -563,7 +563,7 @@ public class SystemCapabilityManager {\n \t\t\t\t\tif (scListener != null) {\n \t\t\t\t\t\tsynchronized (LISTENER_LOCK) {\n \t\t\t\t\t\t\tCopyOnWriteArrayList<OnSystemCapabilityListener> notifiedListeners = onSystemCapabilityListeners.get(systemCapabilityType);\n-\t\t\t\t\t\t\tboolean listenerAlreadyNotified = notifiedListeners != null && notifiedListeners.contains(scListener);\n+\t\t\t\t\t\t\tboolean listenerAlreadyNotified = (notifiedListeners != null) && notifiedListeners.contains(scListener);\n \t\t\t\t\t\t\tif (!listenerAlreadyNotified) {\n \t\t\t\t\t\t\t\tscListener.onCapabilityRetrieved(retrievedCapability);\n \t\t\t\t\t\t\t}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTM4MTI4OA==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1277#discussion_r381381288", "bodyText": "Based on the change to retrieveCapability() I believe this should not send subscribe=true, right?\nfinal boolean shouldSubscribe = ((subscribe != null) ? subscribe : isSubscribedToSystemCapability(systemCapabilityType)) && supportsSubscriptions();\nrequest.setSubscribe(shouldSubscribe);", "author": "joeljfischer", "createdAt": "2020-02-19T16:17:00Z", "path": "android/sdl_android/src/androidTest/java/com/smartdevicelink/test/proxy/SystemCapabilityManagerTests.java", "diffHunk": "@@ -490,6 +490,94 @@ public void testAddOnSystemCapabilityListenerWithSubscriptionsNotSupportedAndCap\n \t\tverify(internalInterface, times(1)).sendRPC(any(GetSystemCapability.class));\n \t}\n \n+\tpublic void testAddOnSystemCapabilityListenerThenGetCapability() {\n+\t\tSdlMsgVersion sdlMsgVersion = new SdlMsgVersion(5, 0); // This version doesn't support capability subscriptions\n+\t\tsdlMsgVersion.setPatchVersion(0);\n+\t\tISdl internalInterface = mock(ISdl.class);\n+\t\twhen(internalInterface.getSdlMsgVersion()).thenReturn(sdlMsgVersion);\n+\t\tSystemCapabilityManager scm = new SystemCapabilityManager(internalInterface);\n+\t\tscm.setCapability(SystemCapabilityType.VIDEO_STREAMING, videoStreamingCapability);\n+\n+\n+\t\t// Add listener1\n+\t\t// When the first listener is added, GetSystemCapability request should go out with subscribe=true", "originalCommit": "f6a10d835cb5253a9af1f8f54b21ee9a85a081fa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTU2NzA3MA==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1277#discussion_r381567070", "bodyText": "Ah, you are right, the test actually asserts that subscribe=false as you mentioned. The comment is wrong. I will update it.", "author": "bilal-alsharifi", "createdAt": "2020-02-19T21:53:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTM4MTI4OA=="}], "type": "inlineReview", "revised_code": {"commit": "5fa55cf180a3a2e444770dbf4818d6a01d53913c", "chunk": "diff --git a/android/sdl_android/src/androidTest/java/com/smartdevicelink/test/proxy/SystemCapabilityManagerTests.java b/android/sdl_android/src/androidTest/java/com/smartdevicelink/test/proxy/SystemCapabilityManagerTests.java\nindex f1339f270..8625acddd 100644\n--- a/android/sdl_android/src/androidTest/java/com/smartdevicelink/test/proxy/SystemCapabilityManagerTests.java\n+++ b/android/sdl_android/src/androidTest/java/com/smartdevicelink/test/proxy/SystemCapabilityManagerTests.java\n\n@@ -500,7 +500,7 @@ public class SystemCapabilityManagerTests extends AndroidTestCase2 {\n \n \n \t\t// Add listener1\n-\t\t// When the first listener is added, GetSystemCapability request should go out with subscribe=true\n+\t\t// When the first listener is added, GetSystemCapability request should go out with subscribe=false\n \t\tOnSystemCapabilityListener onSystemCapabilityListener1 = mock(OnSystemCapabilityListener.class);\n \t\tdoAnswer(createOnSendGetSystemCapabilityAnswer(true, false)).when(internalInterface).sendRPC(any(GetSystemCapability.class));\n \t\tscm.addOnSystemCapabilityListener(SystemCapabilityType.VIDEO_STREAMING, onSystemCapabilityListener1);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTM4NzIxNg==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1277#discussion_r381387216", "bodyText": "Currently, iOS calls the listener with a cached value of nil. This may be a point of alignment needed.\nWhy does it not call with the cached value if we are sending a GetCapability request? Should the && before !shouldSendGetCapabilityRequest be an ||?", "author": "joeljfischer", "createdAt": "2020-02-19T16:25:22Z", "path": "base/src/main/java/com/smartdevicelink/proxy/SystemCapabilityManager.java", "diffHunk": "@@ -450,16 +450,17 @@ private boolean isSubscribedToSystemCapability(SystemCapabilityType systemCapabi\n \t */\n \tprivate Object getCapabilityPrivate(final SystemCapabilityType systemCapabilityType, final OnSystemCapabilityListener scListener, final Boolean subscribe, final boolean forceUpdate) {\n \t\tObject cachedCapability = cachedSystemCapabilities.get(systemCapabilityType);\n-\t\tOnSystemCapabilityListener listener = scListener;\n \n-\t\tif (!forceUpdate && cachedCapability != null && listener != null) {\n-\t\t\tlistener.onCapabilityRetrieved(cachedCapability);\n-\t\t\tlistener = null;\n+\t\tboolean shouldUpdateSystemCapabilitySubscription = (subscribe != null) && (subscribe != isSubscribedToSystemCapability(systemCapabilityType)) && supportsSubscriptions();\n+\t\tboolean shouldSendGetCapabilityRequest = forceUpdate || (cachedCapability == null) || shouldUpdateSystemCapabilitySubscription;\n+\t\tboolean shouldCallListenerWithCachedValue = (cachedCapability != null) && (scListener != null) && !shouldSendGetCapabilityRequest;", "originalCommit": "f6a10d835cb5253a9af1f8f54b21ee9a85a081fa", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTM5MDYyNg==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1277#discussion_r381390626", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\tfinal boolean shouldSubscribe = ((subscribe != null) ? subscribe : isSubscribedToSystemCapability(systemCapabilityType)) && supportsSubscriptions();\n          \n          \n            \n            \t\tfinal boolean shouldSubscribe = ((subscribe != null) ? subscribe : (isSubscribedToSystemCapability(systemCapabilityType)) && supportsSubscriptions());\n          \n      \n    \n    \n  \n\nI think the name of this is a bit misleading, because if it's false, it shouldUnsubscribe(). I almost think you need an enum with values subscribe, unsubscribe, and keepCurrentState. Or at least the documentation needs to be improved here.\nI also need clarification on a point here. If subscribe is false and we are currently subscribed, and we support subscriptions, then shouldSubscribe will be true, right? And that's the opposite of what we want, since we want to unsubscribe?", "author": "joeljfischer", "createdAt": "2020-02-19T16:30:15Z", "path": "base/src/main/java/com/smartdevicelink/proxy/SystemCapabilityManager.java", "diffHunk": "@@ -549,18 +550,27 @@ private void retrieveCapability(final SystemCapabilityType systemCapabilityType,\n \t\t}\n \t\tfinal GetSystemCapability request = new GetSystemCapability();\n \t\trequest.setSystemCapabilityType(systemCapabilityType);\n-\t\trequest.setSubscribe((subscribe != null) ? subscribe : isSubscribedToSystemCapability(systemCapabilityType)); // If subscribe is null, then don't change the current subscription status\n+\t\t// If subscribe is null, then don't change the current subscription status\n+\t\tfinal boolean shouldSubscribe = ((subscribe != null) ? subscribe : isSubscribedToSystemCapability(systemCapabilityType)) && supportsSubscriptions();", "originalCommit": "f6a10d835cb5253a9af1f8f54b21ee9a85a081fa", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9ec33af2d4c5eef78ea1c6c4b3defaf801af6815", "chunk": "diff --git a/base/src/main/java/com/smartdevicelink/proxy/SystemCapabilityManager.java b/base/src/main/java/com/smartdevicelink/proxy/SystemCapabilityManager.java\nindex 5ff022373..345a8da6e 100644\n--- a/base/src/main/java/com/smartdevicelink/proxy/SystemCapabilityManager.java\n+++ b/base/src/main/java/com/smartdevicelink/proxy/SystemCapabilityManager.java\n\n@@ -563,7 +563,7 @@ public class SystemCapabilityManager {\n \t\t\t\t\tif (scListener != null) {\n \t\t\t\t\t\tsynchronized (LISTENER_LOCK) {\n \t\t\t\t\t\t\tCopyOnWriteArrayList<OnSystemCapabilityListener> notifiedListeners = onSystemCapabilityListeners.get(systemCapabilityType);\n-\t\t\t\t\t\t\tboolean listenerAlreadyNotified = notifiedListeners != null && notifiedListeners.contains(scListener);\n+\t\t\t\t\t\t\tboolean listenerAlreadyNotified = (notifiedListeners != null) && notifiedListeners.contains(scListener);\n \t\t\t\t\t\t\tif (!listenerAlreadyNotified) {\n \t\t\t\t\t\t\t\tscListener.onCapabilityRetrieved(retrievedCapability);\n \t\t\t\t\t\t\t}\n"}}, {"oid": "9ec33af2d4c5eef78ea1c6c4b3defaf801af6815", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/9ec33af2d4c5eef78ea1c6c4b3defaf801af6815", "message": "Update formatting in SCM", "committedDate": "2020-02-19T20:32:52Z", "type": "commit"}, {"oid": "b239e724604fceb93581aa4bae1bb35bf83880c4", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/b239e724604fceb93581aa4bae1bb35bf83880c4", "message": "Update comments in retrieveCapability()", "committedDate": "2020-02-19T21:44:32Z", "type": "commit"}, {"oid": "5fa55cf180a3a2e444770dbf4818d6a01d53913c", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/5fa55cf180a3a2e444770dbf4818d6a01d53913c", "message": "Update comments in SystemCapabilityManagerTests", "committedDate": "2020-02-19T21:54:14Z", "type": "commit"}, {"oid": "adfd59364bbeaea67c1e6990e4e13549cc33b7d9", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/adfd59364bbeaea67c1e6990e4e13549cc33b7d9", "message": "Update comments in SCM", "committedDate": "2020-02-20T16:43:47Z", "type": "commit"}, {"oid": "49d20093f838fcc119e1210668281baf33e0d621", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/49d20093f838fcc119e1210668281baf33e0d621", "message": "Prevent sending GetSystemCapability for DISPLAYS", "committedDate": "2020-02-20T19:34:59Z", "type": "commit"}, {"oid": "079d9197e733a3a27dde2ed4543c1f51b5f4e2b7", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/079d9197e733a3a27dde2ed4543c1f51b5f4e2b7", "message": "Add more unit tests for DISPLAYS capability", "committedDate": "2020-02-20T19:36:34Z", "type": "commit"}, {"oid": "11189a63e71bddae0d7fea388b0e98db47e5ec2d", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/11189a63e71bddae0d7fea388b0e98db47e5ec2d", "message": "Update comments in SystemCapabilityManagerTests", "committedDate": "2020-02-20T19:38:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjYwNTcyNQ==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1277#discussion_r382605725", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t- if subscribe is true and the HU supports subscriptions, then shouldSubscribe = true\n          \n          \n            \n            \t\t- if subscribe is true, then shouldSubscribe = true\n          \n      \n    \n    \n  \n\nThis doesn't appear to be true, it's if subscribe == true, then shouldSubscribe = true.", "author": "joeljfischer", "createdAt": "2020-02-21T14:20:54Z", "path": "base/src/main/java/com/smartdevicelink/proxy/SystemCapabilityManager.java", "diffHunk": "@@ -550,7 +551,13 @@ private void retrieveCapability(final SystemCapabilityType systemCapabilityType,\n \t\t}\n \t\tfinal GetSystemCapability request = new GetSystemCapability();\n \t\trequest.setSystemCapabilityType(systemCapabilityType);\n-\t\t// If subscribe is null, then don't change the current subscription status\n+\n+\t\t/*\n+\t\tThe subscription flag in the request should be set based on multiple variables:\n+\t\t- if subscribe is null (no change), shouldSubscribe = current subscription status\n+\t\t- if subscribe is false, then shouldSubscribe = false\n+\t\t- if subscribe is true and the HU supports subscriptions, then shouldSubscribe = true", "originalCommit": "11189a63e71bddae0d7fea388b0e98db47e5ec2d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjY4NTM5Mw==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1277#discussion_r382685393", "bodyText": "But if the HU doesn't support subscriptions, shouldSubscribe will be false right? even if subscribe = true? because we are doing && supportsSubscriptions()", "author": "bilal-alsharifi", "createdAt": "2020-02-21T16:40:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjYwNTcyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjY4OTIwNQ==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1277#discussion_r382689205", "bodyText": "Based on the current code, I don't think that's true.\nif (subscribe != null) {\n    return subscribe;\n} else {\n    return isSubscribedToSystemCapability(systemCapabilityType)) && supportsSubscriptions();\n}\nSo if subscribe == true, then it will always return true.", "author": "joeljfischer", "createdAt": "2020-02-21T16:47:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjYwNTcyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjcwNTk2Nw==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1277#discussion_r382705967", "bodyText": "It is actually confusing. I will simplify the condition a bit.", "author": "bilal-alsharifi", "createdAt": "2020-02-21T17:20:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjYwNTcyNQ=="}], "type": "inlineReview", "revised_code": {"commit": "df73517365f5e3ec8123f1dcb9859054d1f8a967", "chunk": "diff --git a/base/src/main/java/com/smartdevicelink/proxy/SystemCapabilityManager.java b/base/src/main/java/com/smartdevicelink/proxy/SystemCapabilityManager.java\nindex 63ad1e9f5..98032a1fe 100644\n--- a/base/src/main/java/com/smartdevicelink/proxy/SystemCapabilityManager.java\n+++ b/base/src/main/java/com/smartdevicelink/proxy/SystemCapabilityManager.java\n\n@@ -554,7 +554,7 @@ public class SystemCapabilityManager {\n \n \t\t/*\n \t\tThe subscription flag in the request should be set based on multiple variables:\n-\t\t- if subscribe is null (no change), shouldSubscribe = current subscription status\n+\t\t- if subscribe is null (no change), shouldSubscribe = current subscription status, or false if the HU does not support subscriptions\n \t\t- if subscribe is false, then shouldSubscribe = false\n \t\t- if subscribe is true and the HU supports subscriptions, then shouldSubscribe = true\n \t\t*/\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjYwNTk0Ng==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1277#discussion_r382605946", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t- if subscribe is null (no change), shouldSubscribe = current subscription status\n          \n          \n            \n            \t\t- if subscribe is null (no change), shouldSubscribe = current subscription status, or false if the HU does not support subscriptions", "author": "joeljfischer", "createdAt": "2020-02-21T14:21:21Z", "path": "base/src/main/java/com/smartdevicelink/proxy/SystemCapabilityManager.java", "diffHunk": "@@ -550,7 +551,13 @@ private void retrieveCapability(final SystemCapabilityType systemCapabilityType,\n \t\t}\n \t\tfinal GetSystemCapability request = new GetSystemCapability();\n \t\trequest.setSystemCapabilityType(systemCapabilityType);\n-\t\t// If subscribe is null, then don't change the current subscription status\n+\n+\t\t/*\n+\t\tThe subscription flag in the request should be set based on multiple variables:\n+\t\t- if subscribe is null (no change), shouldSubscribe = current subscription status", "originalCommit": "11189a63e71bddae0d7fea388b0e98db47e5ec2d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "df73517365f5e3ec8123f1dcb9859054d1f8a967", "chunk": "diff --git a/base/src/main/java/com/smartdevicelink/proxy/SystemCapabilityManager.java b/base/src/main/java/com/smartdevicelink/proxy/SystemCapabilityManager.java\nindex 63ad1e9f5..98032a1fe 100644\n--- a/base/src/main/java/com/smartdevicelink/proxy/SystemCapabilityManager.java\n+++ b/base/src/main/java/com/smartdevicelink/proxy/SystemCapabilityManager.java\n\n@@ -554,7 +554,7 @@ public class SystemCapabilityManager {\n \n \t\t/*\n \t\tThe subscription flag in the request should be set based on multiple variables:\n-\t\t- if subscribe is null (no change), shouldSubscribe = current subscription status\n+\t\t- if subscribe is null (no change), shouldSubscribe = current subscription status, or false if the HU does not support subscriptions\n \t\t- if subscribe is false, then shouldSubscribe = false\n \t\t- if subscribe is true and the HU supports subscriptions, then shouldSubscribe = true\n \t\t*/\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjY3NDAxNg==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1277#discussion_r382674016", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \tpublic void testAddOnSystemCapabilityListenerThenGetCapability() {\n          \n          \n            \n            \tpublic void testAddOnSystemCapabilityListenerThenGetCapabilityWhenSubscriptionsAreNotSupported() {\n          \n      \n    \n    \n  \n\nYou may also want to consider underscores to define conditions, like:\ntestAddOnSystemCapabilityListener_thenGetCapability_whenSubscriptionsAreNotSupported()", "author": "joeljfischer", "createdAt": "2020-02-21T16:19:56Z", "path": "android/sdl_android/src/androidTest/java/com/smartdevicelink/test/proxy/SystemCapabilityManagerTests.java", "diffHunk": "@@ -490,6 +490,129 @@ public void testAddOnSystemCapabilityListenerWithSubscriptionsNotSupportedAndCap\n \t\tverify(internalInterface, times(1)).sendRPC(any(GetSystemCapability.class));\n \t}\n \n+\tpublic void testAddOnSystemCapabilityListenerThenGetCapability() {", "originalCommit": "11189a63e71bddae0d7fea388b0e98db47e5ec2d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjY4MjYxMg==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1277#discussion_r382682612", "bodyText": "The use of underscores in java is not very common. Except for naming const variables. I prefer the first suggested name as it complies more with Java naming conventions.", "author": "bilal-alsharifi", "createdAt": "2020-02-21T16:35:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjY3NDAxNg=="}], "type": "inlineReview", "revised_code": {"commit": "029db4ec08e179c44fa169713e6076878358f8a0", "chunk": "diff --git a/android/sdl_android/src/androidTest/java/com/smartdevicelink/test/proxy/SystemCapabilityManagerTests.java b/android/sdl_android/src/androidTest/java/com/smartdevicelink/test/proxy/SystemCapabilityManagerTests.java\nindex 513b48dc5..13815b8d0 100644\n--- a/android/sdl_android/src/androidTest/java/com/smartdevicelink/test/proxy/SystemCapabilityManagerTests.java\n+++ b/android/sdl_android/src/androidTest/java/com/smartdevicelink/test/proxy/SystemCapabilityManagerTests.java\n\n@@ -490,7 +490,7 @@ public class SystemCapabilityManagerTests extends AndroidTestCase2 {\n \t\tverify(internalInterface, times(1)).sendRPC(any(GetSystemCapability.class));\n \t}\n \n-\tpublic void testAddOnSystemCapabilityListenerThenGetCapability() {\n+\tpublic void testAddOnSystemCapabilityListenerThenGetCapabilityWhenSubscriptionsAreNotSupported() {\n \t\tSdlMsgVersion sdlMsgVersion = new SdlMsgVersion(5, 0); // This version doesn't support capability subscriptions\n \t\tsdlMsgVersion.setPatchVersion(0);\n \t\tISdl internalInterface = mock(ISdl.class);\n"}}, {"oid": "029db4ec08e179c44fa169713e6076878358f8a0", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/029db4ec08e179c44fa169713e6076878358f8a0", "message": "Update android/sdl_android/src/androidTest/java/com/smartdevicelink/test/proxy/SystemCapabilityManagerTests.java\n\nCo-Authored-By: Joel Fischer <joeljfischer@gmail.com>", "committedDate": "2020-02-21T16:35:13Z", "type": "commit"}, {"oid": "df73517365f5e3ec8123f1dcb9859054d1f8a967", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/df73517365f5e3ec8123f1dcb9859054d1f8a967", "message": "Update base/src/main/java/com/smartdevicelink/proxy/SystemCapabilityManager.java\n\nCo-Authored-By: Joel Fischer <joeljfischer@gmail.com>", "committedDate": "2020-02-21T16:36:33Z", "type": "commit"}, {"oid": "b1edc68edee81e1c718381f4c25a788ab915bff8", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/b1edc68edee81e1c718381f4c25a788ab915bff8", "message": "Simplify ternary condition in SCM", "committedDate": "2020-02-21T17:20:55Z", "type": "commit"}]}