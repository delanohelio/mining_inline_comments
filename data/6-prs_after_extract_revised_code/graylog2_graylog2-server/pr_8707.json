{"pr_number": 8707, "pr_title": "Migrate dashboard and stream roles to grants", "pr_createdAt": "2020-08-05T17:20:29Z", "pr_url": "https://github.com/Graylog2/graylog2-server/pull/8707", "timeline": [{"oid": "888e61d5e6d0b69fd3a0d4b62107c166a94b6551", "url": "https://github.com/Graylog2/graylog2-server/commit/888e61d5e6d0b69fd3a0d4b62107c166a94b6551", "message": "Migrate streams and dashboards roles to grants\n\nThis migrates the currently UI configurable roles\nfor dashboards and streams into grants.\n\nIf the permissions of a role are empty after the migration, it gets removed\ncompletely.\n\nIf entities has permissions other than read and edit, we don't migrate\nit, so we don't end up having permissions on two different places for a\nsingle entity.", "committedDate": "2020-08-10T15:35:09Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQ1MTU0Nw==", "url": "https://github.com/Graylog2/graylog2-server/pull/8707#discussion_r470451547", "bodyText": "We can join the declaration and assignment of these two.", "author": "bernd", "createdAt": "2020-08-14T07:15:47Z", "path": "graylog2-server/src/main/java/org/graylog2/system/stats/ClusterStatsService.java", "diffHunk": "@@ -115,10 +114,8 @@ public MongoStats mongoStats() {\n     public LdapStats ldapStats() {\n         int numberOfRoles = 0;\n         LdapSettings ldapSettings = null;\n-        try {\n-            numberOfRoles = roleService.loadAll().size();\n-            ldapSettings = ldapSettingsService.load();\n-        } catch (NotFoundException ignored) {}\n+        numberOfRoles = roleService.loadAll().size();\n+        ldapSettings = ldapSettingsService.load();", "originalCommit": "888e61d5e6d0b69fd3a0d4b62107c166a94b6551", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "58f5fc9482bbc34dbb91387dc8c3fcb55f0cb150", "chunk": "diff --git a/graylog2-server/src/main/java/org/graylog2/system/stats/ClusterStatsService.java b/graylog2-server/src/main/java/org/graylog2/system/stats/ClusterStatsService.java\nindex 30763c9d88..ccc4f5d471 100644\n--- a/graylog2-server/src/main/java/org/graylog2/system/stats/ClusterStatsService.java\n+++ b/graylog2-server/src/main/java/org/graylog2/system/stats/ClusterStatsService.java\n\n@@ -112,10 +112,8 @@ public class ClusterStatsService {\n     }\n \n     public LdapStats ldapStats() {\n-        int numberOfRoles = 0;\n-        LdapSettings ldapSettings = null;\n-        numberOfRoles = roleService.loadAll().size();\n-        ldapSettings = ldapSettingsService.load();\n+        int numberOfRoles = roleService.loadAll().size();\n+        LdapSettings ldapSettings = ldapSettingsService.load();\n         if (ldapSettings == null) {\n             return LdapStats.create(false,\n                                     false,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDUyMzU0Mg==", "url": "https://github.com/Graylog2/graylog2-server/pull/8707#discussion_r470523542", "bodyText": "Not really an issue, more like a FYI: you can reduce the setup and save some lines when using JUnit 5 tests with the new extensions:\ndiff --git graylog2-server/src/test/java/org/graylog2/migrations/V20200803120800_MigrateRolesToGrantsTest.java graylog2-server/src/test/java/org/graylog2/migrations/V20200803120800_MigrateRolesToGrantsTest.java\nindex 20bfb6ee20..fca0388ac0 100644\n--- graylog2-server/src/test/java/org/graylog2/migrations/V20200803120800_MigrateRolesToGrantsTest.java\n+++ graylog2-server/src/test/java/org/graylog2/migrations/V20200803120800_MigrateRolesToGrantsTest.java\n@@ -16,7 +16,6 @@\n  */\n package org.graylog2.migrations;\n \n-import com.fasterxml.jackson.databind.ObjectMapper;\n import com.google.common.collect.ImmutableSet;\n import com.google.common.collect.Iterables;\n import com.google.common.collect.Sets;\n@@ -31,8 +30,11 @@ import org.graylog.security.Capability;\n import org.graylog.security.DBGrantService;\n import org.graylog.security.GrantDTO;\n import org.graylog.security.permissions.GRNPermission;\n+import org.graylog.testing.GRNExtension;\n+import org.graylog.testing.mongodb.MongoDBExtension;\n import org.graylog.testing.mongodb.MongoDBFixtures;\n-import org.graylog.testing.mongodb.MongoDBInstance;\n+import org.graylog.testing.mongodb.MongoDBTestService;\n+import org.graylog.testing.mongodb.MongoJackExtension;\n import org.graylog2.Configuration;\n import org.graylog2.bindings.providers.MongoJackObjectMapperProvider;\n import org.graylog2.database.MongoConnection;\n@@ -40,7 +42,6 @@ import org.graylog2.database.NotFoundException;\n import org.graylog2.database.PersistedServiceImpl;\n import org.graylog2.plugin.database.ValidationException;\n import org.graylog2.plugin.database.users.User;\n-import org.graylog2.shared.bindings.providers.ObjectMapperProvider;\n import org.graylog2.shared.security.Permissions;\n import org.graylog2.shared.security.RestPermissions;\n import org.graylog2.shared.users.Role;\n@@ -49,12 +50,11 @@ import org.graylog2.users.RoleService;\n import org.graylog2.users.RoleServiceImpl;\n import org.graylog2.users.UserImpl;\n import org.graylog2.users.UserServiceImplTest;\n-import org.junit.Before;\n-import org.junit.Rule;\n-import org.junit.Test;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n import org.mockito.Mock;\n-import org.mockito.junit.MockitoJUnit;\n-import org.mockito.junit.MockitoRule;\n+import org.mockito.junit.jupiter.MockitoExtension;\n \n import javax.annotation.Nullable;\n import javax.validation.Validator;\n@@ -70,34 +70,32 @@ import static org.assertj.core.api.Assertions.assertThatThrownBy;\n import static org.mockito.ArgumentMatchers.any;\n import static org.mockito.Mockito.when;\n \n+@ExtendWith(MongoDBExtension.class)\n+@ExtendWith(MongoJackExtension.class)\n+@ExtendWith(MockitoExtension.class)\n+@ExtendWith(GRNExtension.class)\n+@MongoDBFixtures(\"V20200803120800_MigrateRolesToGrantsTest.json\")\n public class V20200803120800_MigrateRolesToGrantsTest {\n     private V20200803120800_MigrateRolesToGrants migration;\n     private RoleService roleService;\n     private DBGrantService dbGrantService;\n-    private ObjectMapper objectMapper;\n-\n-    @Rule\n-    public final MockitoRule mockitoRule = MockitoJUnit.rule();\n-\n-    @Rule\n-    public final MongoDBInstance mongodb = MongoDBInstance.createForClass();\n \n     @Mock\n     private Permissions permissions;\n-\n     @Mock\n     private Validator validator;\n+\n     private GRNRegistry grnRegistry;\n     private UserService userService;\n \n-    @Before\n-    public void setUp() {\n-        objectMapper = new ObjectMapperProvider().get();\n-        final MongoJackObjectMapperProvider mongoJackObjectMapperProvider = new MongoJackObjectMapperProvider(objectMapper);\n+    @BeforeEach\n+    public void setUp(MongoDBTestService mongodb,\n+                      MongoJackObjectMapperProvider mongoJackObjectMapperProvider,\n+                      GRNRegistry grnRegistry) {\n         when(permissions.readerBasePermissions()).thenReturn(ImmutableSet.of());\n         when(validator.validate(any())).thenReturn(ImmutableSet.of());\n \n-        grnRegistry = GRNRegistry.createWithBuiltinTypes();\n+        this.grnRegistry = grnRegistry;\n \n         roleService = new RoleServiceImpl(mongodb.mongoConnection(), mongoJackObjectMapperProvider, permissions, validator);\n \n@@ -108,7 +106,6 @@ public class V20200803120800_MigrateRolesToGrantsTest {\n     }\n \n     @Test\n-    @MongoDBFixtures(\"V20200803120800_MigrateRolesToGrantsTest.json\")\n     public void migrateSimpleRole() throws NotFoundException {\n \n         final User testuser1 = userService.load(\"testuser1\");\n@@ -141,7 +138,6 @@ public class V20200803120800_MigrateRolesToGrantsTest {\n     }\n \n     @Test\n-    @MongoDBFixtures(\"V20200803120800_MigrateRolesToGrantsTest.json\")\n     public void nonMigratableRole() throws NotFoundException {\n \n         final User testuser3 = userService.load(\"testuser3\");\n@@ -161,7 +157,6 @@ public class V20200803120800_MigrateRolesToGrantsTest {\n     }\n \n     @Test\n-    @MongoDBFixtures(\"V20200803120800_MigrateRolesToGrantsTest.json\")\n     public void partlyMigratableRole() throws NotFoundException {\n \n         final User testuser4 = userService.load(\"testuser3\");", "author": "bernd", "createdAt": "2020-08-14T09:44:43Z", "path": "graylog2-server/src/test/java/org/graylog2/migrations/V20200803120800_MigrateRolesToGrantsTest.java", "diffHunk": "@@ -0,0 +1,309 @@\n+/**\n+ * This file is part of Graylog.\n+ *\n+ * Graylog is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * Graylog is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public License\n+ * along with Graylog.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+package org.graylog2.migrations;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.google.common.collect.ImmutableSet;\n+import com.google.common.collect.Iterables;\n+import com.google.common.collect.Sets;\n+import com.mongodb.BasicDBObject;\n+import com.mongodb.BasicDBObjectBuilder;\n+import com.mongodb.DBObject;\n+import org.apache.shiro.authz.Permission;\n+import org.apache.shiro.authz.permission.WildcardPermission;\n+import org.bson.types.ObjectId;\n+import org.graylog.grn.GRNRegistry;\n+import org.graylog.security.Capability;\n+import org.graylog.security.DBGrantService;\n+import org.graylog.security.GrantDTO;\n+import org.graylog.security.permissions.GRNPermission;\n+import org.graylog.testing.mongodb.MongoDBFixtures;\n+import org.graylog.testing.mongodb.MongoDBInstance;\n+import org.graylog2.Configuration;\n+import org.graylog2.bindings.providers.MongoJackObjectMapperProvider;\n+import org.graylog2.database.MongoConnection;\n+import org.graylog2.database.NotFoundException;\n+import org.graylog2.database.PersistedServiceImpl;\n+import org.graylog2.plugin.database.ValidationException;\n+import org.graylog2.plugin.database.users.User;\n+import org.graylog2.shared.bindings.providers.ObjectMapperProvider;\n+import org.graylog2.shared.security.Permissions;\n+import org.graylog2.shared.security.RestPermissions;\n+import org.graylog2.shared.users.Role;\n+import org.graylog2.shared.users.UserService;\n+import org.graylog2.users.RoleService;\n+import org.graylog2.users.RoleServiceImpl;\n+import org.graylog2.users.UserImpl;\n+import org.graylog2.users.UserServiceImplTest;\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.mockito.Mock;\n+import org.mockito.junit.MockitoJUnit;\n+import org.mockito.junit.MockitoRule;\n+\n+import javax.annotation.Nullable;\n+import javax.validation.Validator;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.Set;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.assertThatThrownBy;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.Mockito.when;\n+\n+public class V20200803120800_MigrateRolesToGrantsTest {", "originalCommit": "888e61d5e6d0b69fd3a0d4b62107c166a94b6551", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA3MDYwNQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/8707#discussion_r472070605", "bodyText": "cool! thanks", "author": "mpfz0r", "createdAt": "2020-08-18T10:15:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDUyMzU0Mg=="}], "type": "inlineReview", "revised_code": {"commit": "58f5fc9482bbc34dbb91387dc8c3fcb55f0cb150", "chunk": "diff --git a/graylog2-server/src/test/java/org/graylog2/migrations/V20200803120800_MigrateRolesToGrantsTest.java b/graylog2-server/src/test/java/org/graylog2/migrations/V20200803120800_MigrateRolesToGrantsTest.java\nindex 20bfb6ee20..405248de1f 100644\n--- a/graylog2-server/src/test/java/org/graylog2/migrations/V20200803120800_MigrateRolesToGrantsTest.java\n+++ b/graylog2-server/src/test/java/org/graylog2/migrations/V20200803120800_MigrateRolesToGrantsTest.java\n\n@@ -16,7 +16,6 @@\n  */\n package org.graylog2.migrations;\n \n-import com.fasterxml.jackson.databind.ObjectMapper;\n import com.google.common.collect.ImmutableSet;\n import com.google.common.collect.Iterables;\n import com.google.common.collect.Sets;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDU3OTY5NA==", "url": "https://github.com/Graylog2/graylog2-server/pull/8707#discussion_r470579694", "bodyText": "Since we have a String now, I think we should check that the userName is not null and not empty.", "author": "bernd", "createdAt": "2020-08-14T11:55:44Z", "path": "graylog2-server/src/main/java/org/graylog/security/DBGrantService.java", "diffHunk": "@@ -89,10 +89,8 @@ public DBGrantService(MongoConnection mongoConnection,\n                 DBQuery.in(GrantDTO.FIELD_GRANTEE, grantees))).toArray();\n     }\n \n-    public GrantDTO create(GrantDTO grantDTO, @Nullable User currentUser) {\n+    public GrantDTO create(GrantDTO grantDTO, String userName) {\n         final ZonedDateTime now = ZonedDateTime.now(ZoneOffset.UTC);\n-        final String userName = requireNonNull(currentUser, \"currentUser cannot be null\").getName();", "originalCommit": "888e61d5e6d0b69fd3a0d4b62107c166a94b6551", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "58f5fc9482bbc34dbb91387dc8c3fcb55f0cb150", "chunk": "diff --git a/graylog2-server/src/main/java/org/graylog/security/DBGrantService.java b/graylog2-server/src/main/java/org/graylog/security/DBGrantService.java\nindex 7cad9c510f..89c4c38089 100644\n--- a/graylog2-server/src/main/java/org/graylog/security/DBGrantService.java\n+++ b/graylog2-server/src/main/java/org/graylog/security/DBGrantService.java\n\n@@ -83,6 +90,18 @@ public class DBGrantService extends PaginatedDbService<GrantDTO> {\n         )).collect(ImmutableSet.toImmutableSet());\n     }\n \n+    public ImmutableSet<GrantDTO> getForGrantee(GRN grantee) {\n+        return streamQuery(DBQuery.is(GrantDTO.FIELD_GRANTEE, grantee))\n+                .collect(ImmutableSet.toImmutableSet());\n+    }\n+\n+    public ImmutableSet<GrantDTO> getForGranteeWithCapability(GRN grantee, Capability capability) {\n+        return streamQuery(DBQuery.and(\n+                DBQuery.is(GrantDTO.FIELD_GRANTEE, grantee),\n+                DBQuery.is(GrantDTO.FIELD_CAPABILITY, capability)\n+        )).collect(ImmutableSet.toImmutableSet());\n+    }\n+\n     public List<GrantDTO> getForTargetAndGrantees(GRN target, Set<GRN> grantees) {\n         return db.find(DBQuery.and(\n                 DBQuery.is(GrantDTO.FIELD_TARGET, target),\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDU4MDAwNg==", "url": "https://github.com/Graylog2/graylog2-server/pull/8707#discussion_r470580006", "bodyText": "How about adding a test for this? \ud83d\ude42", "author": "bernd", "createdAt": "2020-08-14T11:56:29Z", "path": "graylog2-server/src/main/java/org/graylog/security/DBGrantService.java", "diffHunk": "@@ -89,10 +89,8 @@ public DBGrantService(MongoConnection mongoConnection,\n                 DBQuery.in(GrantDTO.FIELD_GRANTEE, grantees))).toArray();\n     }\n \n-    public GrantDTO create(GrantDTO grantDTO, @Nullable User currentUser) {\n+    public GrantDTO create(GrantDTO grantDTO, String userName) {", "originalCommit": "888e61d5e6d0b69fd3a0d4b62107c166a94b6551", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "58f5fc9482bbc34dbb91387dc8c3fcb55f0cb150", "chunk": "diff --git a/graylog2-server/src/main/java/org/graylog/security/DBGrantService.java b/graylog2-server/src/main/java/org/graylog/security/DBGrantService.java\nindex 7cad9c510f..89c4c38089 100644\n--- a/graylog2-server/src/main/java/org/graylog/security/DBGrantService.java\n+++ b/graylog2-server/src/main/java/org/graylog/security/DBGrantService.java\n\n@@ -83,6 +90,18 @@ public class DBGrantService extends PaginatedDbService<GrantDTO> {\n         )).collect(ImmutableSet.toImmutableSet());\n     }\n \n+    public ImmutableSet<GrantDTO> getForGrantee(GRN grantee) {\n+        return streamQuery(DBQuery.is(GrantDTO.FIELD_GRANTEE, grantee))\n+                .collect(ImmutableSet.toImmutableSet());\n+    }\n+\n+    public ImmutableSet<GrantDTO> getForGranteeWithCapability(GRN grantee, Capability capability) {\n+        return streamQuery(DBQuery.and(\n+                DBQuery.is(GrantDTO.FIELD_GRANTEE, grantee),\n+                DBQuery.is(GrantDTO.FIELD_CAPABILITY, capability)\n+        )).collect(ImmutableSet.toImmutableSet());\n+    }\n+\n     public List<GrantDTO> getForTargetAndGrantees(GRN target, Set<GRN> grantees) {\n         return db.find(DBQuery.and(\n                 DBQuery.is(GrantDTO.FIELD_TARGET, target),\n"}}, {"oid": "58f5fc9482bbc34dbb91387dc8c3fcb55f0cb150", "url": "https://github.com/Graylog2/graylog2-server/commit/58f5fc9482bbc34dbb91387dc8c3fcb55f0cb150", "message": "Apply review comments", "committedDate": "2020-08-18T10:44:55Z", "type": "forcePushed"}, {"oid": "38f2a88646e847c551713d9c2b3c8b432b4a0f8f", "url": "https://github.com/Graylog2/graylog2-server/commit/38f2a88646e847c551713d9c2b3c8b432b4a0f8f", "message": "Remove unneeded NotFoundException from RoleService.loadAll()", "committedDate": "2020-08-21T12:25:46Z", "type": "commit"}, {"oid": "966456d8d6aa422b250c079e103dc2edb7798a6e", "url": "https://github.com/Graylog2/graylog2-server/commit/966456d8d6aa422b250c079e103dc2edb7798a6e", "message": "Migrate streams and dashboards roles to grants\n\nThis migrates the currently UI configurable roles\nfor dashboards and streams into grants.\n\nIf the permissions of a role are empty after the migration, it gets removed\ncompletely.\n\nIf entities has permissions other than read and edit, we don't migrate\nit, so we don't end up having permissions on two different places for a\nsingle entity.", "committedDate": "2020-08-21T12:25:46Z", "type": "commit"}, {"oid": "14277d9fe61cfb932fed8d4f879391ec7493ae7a", "url": "https://github.com/Graylog2/graylog2-server/commit/14277d9fe61cfb932fed8d4f879391ec7493ae7a", "message": "Apply review comments", "committedDate": "2020-08-21T12:25:47Z", "type": "commit"}, {"oid": "14277d9fe61cfb932fed8d4f879391ec7493ae7a", "url": "https://github.com/Graylog2/graylog2-server/commit/14277d9fe61cfb932fed8d4f879391ec7493ae7a", "message": "Apply review comments", "committedDate": "2020-08-21T12:25:47Z", "type": "forcePushed"}]}