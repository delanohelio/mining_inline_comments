{"pr_number": 8372, "pr_title": "Provision ES storage implementation based on configured ES version.", "pr_createdAt": "2020-06-18T11:51:00Z", "pr_url": "https://github.com/Graylog2/graylog2-server/pull/8372", "timeline": [{"oid": "cfdad76c66161d170aeb9c5514858fc72799007b", "url": "https://github.com/Graylog2/graylog2-server/commit/cfdad76c66161d170aeb9c5514858fc72799007b", "message": "Renaming module, binding backends with version.", "committedDate": "2020-06-22T07:39:07Z", "type": "forcePushed"}, {"oid": "e182aba25002fc6a429007c4d558e6d50316f96e", "url": "https://github.com/Graylog2/graylog2-server/commit/e182aba25002fc6a429007c4d558e6d50316f96e", "message": "Pre-Binding export backend in a version-aware manner.", "committedDate": "2020-06-22T12:37:51Z", "type": "forcePushed"}, {"oid": "526c51be017a44c4651ab21d617c4eb8f6314d13", "url": "https://github.com/Graylog2/graylog2-server/commit/526c51be017a44c4651ab21d617c4eb8f6314d13", "message": "Using version specific providers to inject implementations based on config setting.", "committedDate": "2020-06-23T10:04:49Z", "type": "commit"}, {"oid": "3d56136b727e5eb190d398af297ec3eae84d64bb", "url": "https://github.com/Graylog2/graylog2-server/commit/3d56136b727e5eb190d398af297ec3eae84d64bb", "message": "Renaming class, injecting providers in Map instead of instances.", "committedDate": "2020-06-23T10:04:51Z", "type": "commit"}, {"oid": "70029f8677ead20278d5e684ded69a8558057f47", "url": "https://github.com/Graylog2/graylog2-server/commit/70029f8677ead20278d5e684ded69a8558057f47", "message": "Renaming module, binding backends with version.", "committedDate": "2020-06-23T10:05:12Z", "type": "commit"}, {"oid": "8da61ec17511ad47cf2e57da027dce06c32dce0d", "url": "https://github.com/Graylog2/graylog2-server/commit/8da61ec17511ad47cf2e57da027dce06c32dce0d", "message": "Pre-Binding export backend in a version-aware manner.", "committedDate": "2020-06-23T10:05:13Z", "type": "commit"}, {"oid": "8da61ec17511ad47cf2e57da027dce06c32dce0d", "url": "https://github.com/Graylog2/graylog2-server/commit/8da61ec17511ad47cf2e57da027dce06c32dce0d", "message": "Pre-Binding export backend in a version-aware manner.", "committedDate": "2020-06-23T10:05:13Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDEzOTExMQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/8372#discussion_r444139111", "bodyText": "I would suggest renaming this to SUPPORTED_ES_VERSION. This would especially simplify understanding other classes where this constant is referenced.", "author": "alex-konn", "createdAt": "2020-06-23T10:59:25Z", "path": "graylog-storage-elasticsearch6/src/main/java/org/graylog/storage/elasticsearch6/Elasticsearch6Plugin.java", "diffHunk": "@@ -4,10 +4,13 @@\n import org.graylog2.plugin.Plugin;\n import org.graylog2.plugin.PluginMetaData;\n import org.graylog2.plugin.PluginModule;\n+import org.graylog2.plugin.Version;\n \n import java.util.Collection;\n \n public class Elasticsearch6Plugin implements Plugin {\n+    public static final Version SUPPORTED_VERSION = Version.from(6, 0, 0);", "originalCommit": "8da61ec17511ad47cf2e57da027dce06c32dce0d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDI5MDM4MA==", "url": "https://github.com/Graylog2/graylog2-server/pull/8372#discussion_r444290380", "bodyText": "\u2714\ufe0f", "author": "dennisoelkers", "createdAt": "2020-06-23T14:56:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDEzOTExMQ=="}], "type": "inlineReview", "revised_code": {"commit": "b3b0e3eeca126c8345b59a528013ee19cbd8e5d2", "chunk": "diff --git a/graylog-storage-elasticsearch6/src/main/java/org/graylog/storage/elasticsearch6/Elasticsearch6Plugin.java b/graylog-storage-elasticsearch6/src/main/java/org/graylog/storage/elasticsearch6/Elasticsearch6Plugin.java\nindex e06cbe4594..49b5bb30fc 100644\n--- a/graylog-storage-elasticsearch6/src/main/java/org/graylog/storage/elasticsearch6/Elasticsearch6Plugin.java\n+++ b/graylog-storage-elasticsearch6/src/main/java/org/graylog/storage/elasticsearch6/Elasticsearch6Plugin.java\n\n@@ -9,7 +9,7 @@ import org.graylog2.plugin.Version;\n import java.util.Collection;\n \n public class Elasticsearch6Plugin implements Plugin {\n-    public static final Version SUPPORTED_VERSION = Version.from(6, 0, 0);\n+    public static final Version SUPPORTED_ES_VERSION = Version.from(6, 0, 0);\n \n     @Override\n     public PluginMetaData metadata() {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDE0Mjk2MQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/8372#discussion_r444142961", "bodyText": "Wouldn't it be enough to use bindForVersion(SUPPORTED_VERSION, ExportBackend.class); directly here instead of adding two additional private methods?", "author": "alex-konn", "createdAt": "2020-06-23T11:07:43Z", "path": "graylog-storage-elasticsearch6/src/main/java/org/graylog/storage/elasticsearch6/ViewsESBackendModule.java", "diffHunk": "@@ -97,8 +97,20 @@ protected void configure() {\n         registerPivotBucketHandler(Time.NAME, ESTimeHandler.class);\n         registerPivotBucketHandler(DateRangeBucket.NAME, ESDateRangeHandler.class);\n \n-        bind(ExportBackend.class).to(ElasticsearchExportBackend.class);\n-        bind(RequestStrategy.class).to(org.graylog.storage.elasticsearch6.views.export.Scroll.class);\n+        bindExportBackend().to(ElasticsearchExportBackend.class);", "originalCommit": "8da61ec17511ad47cf2e57da027dce06c32dce0d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDI1MzgwNA==", "url": "https://github.com/Graylog2/graylog2-server/pull/8372#discussion_r444253804", "bodyText": "Sure, I did that before, I just consider this to be clearer regarding its intention.", "author": "dennisoelkers", "createdAt": "2020-06-23T14:09:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDE0Mjk2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDI4MDAyMA==", "url": "https://github.com/Graylog2/graylog2-server/pull/8372#discussion_r444280020", "bodyText": "Yeah, I understand. Keeping the configure method tidy and easy to read is important.\nI guess the only thing that really confused me was that that one of these two methods was in the base class ViewsModule. I would personally get rid of at least that one and move the call to bindForVersion into ViewsESBackendModule, but this is nothing that would keep me from merging this PR. :D", "author": "alex-konn", "createdAt": "2020-06-23T14:43:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDE0Mjk2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDI5MDIxNw==", "url": "https://github.com/Graylog2/graylog2-server/pull/8372#discussion_r444290217", "bodyText": "registerQueryBackend(Version, String, ...) is supposed to be reused in future storage modules, that's why it is in ViewsModule.", "author": "dennisoelkers", "createdAt": "2020-06-23T14:56:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDE0Mjk2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDc5NDE0NQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/8372#discussion_r444794145", "bodyText": "Alright, then let's leave it as it is.", "author": "alex-konn", "createdAt": "2020-06-24T10:20:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDE0Mjk2MQ=="}], "type": "inlineReview", "revised_code": {"commit": "b3b0e3eeca126c8345b59a528013ee19cbd8e5d2", "chunk": "diff --git a/graylog-storage-elasticsearch6/src/main/java/org/graylog/storage/elasticsearch6/ViewsESBackendModule.java b/graylog-storage-elasticsearch6/src/main/java/org/graylog/storage/elasticsearch6/ViewsESBackendModule.java\nindex cfd933e1f2..109f1cfa8a 100644\n--- a/graylog-storage-elasticsearch6/src/main/java/org/graylog/storage/elasticsearch6/ViewsESBackendModule.java\n+++ b/graylog-storage-elasticsearch6/src/main/java/org/graylog/storage/elasticsearch6/ViewsESBackendModule.java\n\n@@ -106,11 +106,11 @@ public class ViewsESBackendModule extends ViewsModule {\n     }\n \n     private LinkedBindingBuilder<ExportBackend> bindExportBackend() {\n-        return bindExportBackend(SUPPORTED_VERSION);\n+        return bindExportBackend(SUPPORTED_ES_VERSION);\n     }\n \n     private void registerQueryBackend() {\n-        registerQueryBackend(SUPPORTED_VERSION, ElasticsearchQueryString.NAME, ElasticsearchBackend.class);\n+        registerQueryBackend(SUPPORTED_ES_VERSION, ElasticsearchQueryString.NAME, ElasticsearchBackend.class);\n     }\n \n     private MapBinder<String, ESPivotBucketSpecHandler<? extends BucketSpec, ? extends Aggregation>> pivotBucketHandlerBinder() {\n"}}, {"oid": "b3b0e3eeca126c8345b59a528013ee19cbd8e5d2", "url": "https://github.com/Graylog2/graylog2-server/commit/b3b0e3eeca126c8345b59a528013ee19cbd8e5d2", "message": "Renaming constant.", "committedDate": "2020-06-23T14:54:58Z", "type": "commit"}]}