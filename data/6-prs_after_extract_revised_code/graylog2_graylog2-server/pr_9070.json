{"pr_number": 9070, "pr_title": "Migrate user permissions into grants", "pr_createdAt": "2020-10-02T18:49:43Z", "pr_url": "https://github.com/Graylog2/graylog2-server/pull/9070", "timeline": [{"oid": "df0633ab96a830a0722a69dd9ccbd899b6b1ef98", "url": "https://github.com/Graylog2/graylog2-server/commit/df0633ab96a830a0722a69dd9ccbd899b6b1ef98", "message": "Migrate user permissions to grants\n\nFixes #8919", "committedDate": "2020-10-02T16:47:20Z", "type": "commit"}, {"oid": "b058d934c209dd376d8cd8820ee2ef5be4dfa079", "url": "https://github.com/Graylog2/graylog2-server/commit/b058d934c209dd376d8cd8820ee2ef5be4dfa079", "message": "Clean up file structure and deduplicate code", "committedDate": "2020-10-02T18:47:40Z", "type": "commit"}, {"oid": "d8ae1de176d4d9abf9c7ed5be679cc9150e18013", "url": "https://github.com/Graylog2/graylog2-server/commit/d8ae1de176d4d9abf9c7ed5be679cc9150e18013", "message": "Also migrate saved searches and event definition permissions", "committedDate": "2020-10-05T08:52:03Z", "type": "commit"}, {"oid": "7786572b29385422a5a0d87f6846d7b85f3d541b", "url": "https://github.com/Graylog2/graylog2-server/commit/7786572b29385422a5a0d87f6846d7b85f3d541b", "message": "add license", "committedDate": "2020-10-05T09:04:50Z", "type": "commit"}, {"oid": "6e4d011c1b6124f1daac9d3e7a6205c98c6ec768", "url": "https://github.com/Graylog2/graylog2-server/commit/6e4d011c1b6124f1daac9d3e7a6205c98c6ec768", "message": "improve comment", "committedDate": "2020-10-05T09:08:47Z", "type": "commit"}, {"oid": "58a8c877c6d423ea6167163a2f9e23069b3222b1", "url": "https://github.com/Graylog2/graylog2-server/commit/58a8c877c6d423ea6167163a2f9e23069b3222b1", "message": "Don't fail on already existing grants", "committedDate": "2020-10-07T15:30:17Z", "type": "commit"}, {"oid": "478cc10192fb6d3dbc9c400addc24b2bd37900b8", "url": "https://github.com/Graylog2/graylog2-server/commit/478cc10192fb6d3dbc9c400addc24b2bd37900b8", "message": "Handle grants update with different capabilies\n\nChange DBGrantService.ensure() to allow updating grants\nto a higher capability, but not to a lower one.\n\nThis is used by migrations that could try to create\ndifferent grants for the same target.\nAfter all migrations are run, we will end up with the grant that\nhas the most powerful capability.", "committedDate": "2020-10-08T10:11:54Z", "type": "commit"}, {"oid": "a9d0977b75c98869c38b4bb1562e41ad37fa5b71", "url": "https://github.com/Graylog2/graylog2-server/commit/a9d0977b75c98869c38b4bb1562e41ad37fa5b71", "message": "don't user assert", "committedDate": "2020-10-08T10:28:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTc5NTg2Ng==", "url": "https://github.com/Graylog2/graylog2-server/pull/9070#discussion_r501795866", "bodyText": "I am not sure if using the #ordinal method of the enum will bite us at one point in the future. The value will change if the enums are reordered at some point. (e.g. someone wants them to be sorted alphabetically and refactors the order) How about adding an explicit priority value to each enum instead?", "author": "bernd", "createdAt": "2020-10-08T15:05:45Z", "path": "graylog2-server/src/main/java/org/graylog/security/DBGrantService.java", "diffHunk": "@@ -136,6 +141,27 @@ public GrantDTO create(GRN grantee, Capability capability, GRN target, String cr\n         return create(GrantDTO.of(grantee, capability, target), creatorUsername);\n     }\n \n+    /**\n+     * Ensure that a grant with the requested or a higher capability exists.\n+     * @return the created, updated or existing grant\n+     */\n+    public GrantDTO ensure(GRN grantee, Capability capability, GRN target, String creatorUsername) {\n+        final List<GrantDTO> existingGrants = getForTargetAndGrantee(target, grantee);\n+        if (existingGrants.isEmpty()) {\n+            return create(grantee, capability, target, creatorUsername);\n+        }\n+        // This should never happen\n+        Preconditions.checkState(existingGrants.size() == 1);\n+\n+        final GrantDTO grantDTO = existingGrants.get(0);\n+        // Only upgrade capabilities: VIEW < MANAGE < OWNER\n+        if (capability.ordinal() > grantDTO.capability().ordinal()) {", "originalCommit": "a9d0977b75c98869c38b4bb1562e41ad37fa5b71", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTg3OTI2Mg==", "url": "https://github.com/Graylog2/graylog2-server/pull/9070#discussion_r501879262", "bodyText": "fair enough. \ud83d\udc4d", "author": "mpfz0r", "createdAt": "2020-10-08T17:10:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTc5NTg2Ng=="}], "type": "inlineReview", "revised_code": {"commit": "10a2dcf18a56d7cfd5d3e232ea2d96aa3415c7c5", "chunk": "diff --git a/graylog2-server/src/main/java/org/graylog/security/DBGrantService.java b/graylog2-server/src/main/java/org/graylog/security/DBGrantService.java\nindex 00af609da6..69ef3b523d 100644\n--- a/graylog2-server/src/main/java/org/graylog/security/DBGrantService.java\n+++ b/graylog2-server/src/main/java/org/graylog/security/DBGrantService.java\n\n@@ -155,7 +155,7 @@ public class DBGrantService extends PaginatedDbService<GrantDTO> {\n \n         final GrantDTO grantDTO = existingGrants.get(0);\n         // Only upgrade capabilities: VIEW < MANAGE < OWNER\n-        if (capability.ordinal() > grantDTO.capability().ordinal()) {\n+        if (capability.priority() > grantDTO.capability().priority()) {\n             final GrantDTO grantUpdate = grantDTO.toBuilder().capability(capability).build();\n             return save(grantUpdate);\n         }\n"}}, {"oid": "10a2dcf18a56d7cfd5d3e232ea2d96aa3415c7c5", "url": "https://github.com/Graylog2/graylog2-server/commit/10a2dcf18a56d7cfd5d3e232ea2d96aa3415c7c5", "message": "Use explicit capability priority instead of ordinal", "committedDate": "2020-10-08T17:09:01Z", "type": "commit"}, {"oid": "5687e36d67e684daf1a796f5b20bd575688abd43", "url": "https://github.com/Graylog2/graylog2-server/commit/5687e36d67e684daf1a796f5b20bd575688abd43", "message": "Merge remote-tracking branch 'origin/feature/permissions' into migrate-user-permissions-to-grants", "committedDate": "2020-10-09T09:16:15Z", "type": "commit"}]}