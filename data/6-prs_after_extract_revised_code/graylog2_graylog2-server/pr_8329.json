{"pr_number": 8329, "pr_title": "Removing legacy Aggregation API.", "pr_createdAt": "2020-06-11T15:00:58Z", "pr_url": "https://github.com/Graylog2/graylog2-server/pull/8329", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTI5MjI0Ng==", "url": "https://github.com/Graylog2/graylog2-server/pull/8329#discussion_r439292246", "bodyText": "The public method createTermsBuilder and the constant AGG_TERMS can be deleted too.", "author": "alex-konn", "createdAt": "2020-06-12T08:49:46Z", "path": "graylog-storage-elasticsearch6/src/main/java/org/graylog/storage/elasticsearch6/SearchesAdapterES6.java", "diffHunk": "@@ -61,12 +45,9 @@\n \n public class SearchesAdapterES6 implements SearchesAdapter {", "originalCommit": "14adecf7bff900e01312030e584f2943a8c002c9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTQ0ODE3NA==", "url": "https://github.com/Graylog2/graylog2-server/pull/8329#discussion_r439448174", "bodyText": "\u2714\ufe0f", "author": "dennisoelkers", "createdAt": "2020-06-12T14:19:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTI5MjI0Ng=="}], "type": "inlineReview", "revised_code": {"commit": "8dd981354293a38cdfd1f3cac5ded01cc1c716c1", "chunk": "diff --git a/graylog-storage-elasticsearch6/src/main/java/org/graylog/storage/elasticsearch6/SearchesAdapterES6.java b/graylog-storage-elasticsearch6/src/main/java/org/graylog/storage/elasticsearch6/SearchesAdapterES6.java\nindex ff53af80f8..3e9cafb64c 100644\n--- a/graylog-storage-elasticsearch6/src/main/java/org/graylog/storage/elasticsearch6/SearchesAdapterES6.java\n+++ b/graylog-storage-elasticsearch6/src/main/java/org/graylog/storage/elasticsearch6/SearchesAdapterES6.java\n\n@@ -45,9 +58,12 @@ import static org.elasticsearch.index.query.QueryBuilders.queryStringQuery;\n \n public class SearchesAdapterES6 implements SearchesAdapter {\n     public static final String AGG_CARDINALITY = \"gl2_field_cardinality\";\n+    public static final String AGG_HISTOGRAM = \"gl2_histogram\";\n     public static final String AGG_EXTENDED_STATS = \"gl2_extended_stats\";\n     public static final String AGG_FILTER = \"gl2_filter\";\n+    public final static String AGG_STATS = \"gl2_stats\";\n     public final static String AGG_TERMS = \"gl2_terms\";\n+    public final static String AGG_TERMS_STATS = \"gl2_termsstats\";\n     public static final String AGG_VALUE_COUNT = \"gl2_value_count\";\n \n     // This is the \"WORD SEPARATOR MIDDLE DOT\" unicode character. It's used to join and split the term values in a\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTMwNDUwOQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/8329#discussion_r439304509", "bodyText": "The constant STACKED_TERMS_AGG_SEPARATOR, and the enums TermsStatsOrder, and DateHistogramInterval can be deleted too.", "author": "alex-konn", "createdAt": "2020-06-12T09:14:20Z", "path": "graylog2-server/src/main/java/org/graylog2/indexer/searches/Searches.java", "diffHunk": "@@ -196,57 +191,6 @@ public SearchResult search(SearchesConfig config) {\n         return result;\n     }\n \n-    public TermsResult terms(String field, List<String> stackedFields, int size, String query, String filter, TimeRange range, Sorting.Direction sorting) {", "originalCommit": "14adecf7bff900e01312030e584f2943a8c002c9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTQ0ODIwMw==", "url": "https://github.com/Graylog2/graylog2-server/pull/8329#discussion_r439448203", "bodyText": "\u2714\ufe0f", "author": "dennisoelkers", "createdAt": "2020-06-12T14:20:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTMwNDUwOQ=="}], "type": "inlineReview", "revised_code": {"commit": "8dd981354293a38cdfd1f3cac5ded01cc1c716c1", "chunk": "diff --git a/graylog2-server/src/main/java/org/graylog2/indexer/searches/Searches.java b/graylog2-server/src/main/java/org/graylog2/indexer/searches/Searches.java\nindex 93e3885f9e..270e8c60e1 100644\n--- a/graylog2-server/src/main/java/org/graylog2/indexer/searches/Searches.java\n+++ b/graylog2-server/src/main/java/org/graylog2/indexer/searches/Searches.java\n\n@@ -191,6 +195,41 @@ public class Searches {\n         return result;\n     }\n \n+    public TermsResult terms(String field, List<String> stackedFields, int size, String query, String filter, TimeRange range, Sorting.Direction sorting) {\n+        final Set<String> affectedIndices = determineAffectedIndices(range, filter);\n+        TermsResult result = searchesAdapter.terms(query, filter, range, affectedIndices, field, stackedFields, size, sorting);\n+        recordEsMetrics(result.tookMs(), range);\n+        return result;\n+    }\n+\n+    public TermsResult terms(String field, int size, String query, String filter, TimeRange range, Sorting.Direction sorting) {\n+        return terms(field, Collections.emptyList(), size, query, filter, range, sorting);\n+    }\n+\n+    public TermsResult terms(String field, int size, String query, String filter, TimeRange range) {\n+        return terms(field, size, query, filter, range, Sorting.Direction.DESC);\n+    }\n+\n+    public TermsResult terms(String field, int size, String query, TimeRange range) {\n+        return terms(field, size, query, null, range, Sorting.Direction.DESC);\n+    }\n+\n+    public TermsStatsResult termsStats(String keyField, String valueField, TermsStatsOrder order, int size, String query, String filter, TimeRange range) {\n+        if (size == 0) {\n+            size = 50;\n+        }\n+\n+        final Set<String> affectedIndices = determineAffectedIndices(range, filter);\n+\n+        final TermsStatsResult result = searchesAdapter.termsStats(query, filter, range, affectedIndices, keyField, valueField, order, size);\n+        recordEsMetrics(result.tookMs(), range);\n+        return result;\n+    }\n+\n+    public TermsStatsResult termsStats(String keyField, String valueField, TermsStatsOrder order, int size, String query, TimeRange range) {\n+        return termsStats(keyField, valueField, order, size, query, null, range);\n+    }\n+\n     public FieldStatsResult fieldStats(String field, String query, TimeRange range) {\n         return fieldStats(field, query, null, range);\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTMwNjY0NQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/8329#discussion_r439306645", "bodyText": "The protected method splitStackedFields can be deleted too.", "author": "alex-konn", "createdAt": "2020-06-12T09:18:44Z", "path": "graylog2-server/src/main/java/org/graylog2/rest/resources/search/SearchResource.java", "diffHunk": "@@ -79,13 +70,6 @@ public SearchResource(Searches searches,\n         this.decoratorProcessor = decoratorProcessor;\n     }\n ", "originalCommit": "14adecf7bff900e01312030e584f2943a8c002c9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTQ0ODIzMA==", "url": "https://github.com/Graylog2/graylog2-server/pull/8329#discussion_r439448230", "bodyText": "\u2714\ufe0f", "author": "dennisoelkers", "createdAt": "2020-06-12T14:20:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTMwNjY0NQ=="}], "type": "inlineReview", "revised_code": {"commit": "8dd981354293a38cdfd1f3cac5ded01cc1c716c1", "chunk": "diff --git a/graylog2-server/src/main/java/org/graylog2/rest/resources/search/SearchResource.java b/graylog2-server/src/main/java/org/graylog2/rest/resources/search/SearchResource.java\nindex a64fecb625..31e79c5872 100644\n--- a/graylog2-server/src/main/java/org/graylog2/rest/resources/search/SearchResource.java\n+++ b/graylog2-server/src/main/java/org/graylog2/rest/resources/search/SearchResource.java\n\n@@ -70,6 +79,13 @@ public abstract class SearchResource extends RestResource {\n         this.decoratorProcessor = decoratorProcessor;\n     }\n \n+    protected void validateInterval(String interval) {\n+        if (!SearchUtils.validateInterval(interval)) {\n+            LOG.warn(\"Invalid interval type <{}>. Returning HTTP 400.\", interval);\n+            throw new BadRequestException(\"Invalid interval type: \" + interval + \"\\\"\");\n+        }\n+    }\n+\n     protected List<String> parseFields(String fields) {\n         if (isNullOrEmpty(fields)) {\n             LOG.warn(\"Missing fields parameter. Returning HTTP 400\");\n"}}, {"oid": "8dd981354293a38cdfd1f3cac5ded01cc1c716c1", "url": "https://github.com/Graylog2/graylog2-server/commit/8dd981354293a38cdfd1f3cac5ded01cc1c716c1", "message": "Removing `/terms-histogram` API endpoint.", "committedDate": "2020-06-12T14:22:25Z", "type": "commit"}, {"oid": "a5b06956906a23beca6933d4d3e06b53e88e6da6", "url": "https://github.com/Graylog2/graylog2-server/commit/a5b06956906a23beca6933d4d3e06b53e88e6da6", "message": "Removing `/histogram` API endpoint.", "committedDate": "2020-06-12T14:22:25Z", "type": "commit"}, {"oid": "ab70b52205ee8ffa9669f399de9ff77bafdd224d", "url": "https://github.com/Graylog2/graylog2-server/commit/ab70b52205ee8ffa9669f399de9ff77bafdd224d", "message": "Removing `/fieldhistogram` API endpoint.", "committedDate": "2020-06-12T14:22:25Z", "type": "commit"}, {"oid": "be1f9ee567f8d870a1346eda3945a4e3edd3fdba", "url": "https://github.com/Graylog2/graylog2-server/commit/be1f9ee567f8d870a1346eda3945a4e3edd3fdba", "message": "Removing `/stats` API endpoint.", "committedDate": "2020-06-12T14:22:25Z", "type": "commit"}, {"oid": "7aa3e99192735d59454760d3dd9603966c6b420b", "url": "https://github.com/Graylog2/graylog2-server/commit/7aa3e99192735d59454760d3dd9603966c6b420b", "message": "Removing `/termsstats` API endpoint.", "committedDate": "2020-06-12T14:22:25Z", "type": "commit"}, {"oid": "bef1889a2196ade55ea5f4b8ca5cfe890069c899", "url": "https://github.com/Graylog2/graylog2-server/commit/bef1889a2196ade55ea5f4b8ca5cfe890069c899", "message": "Cleaning up unused methods/classes/fields.", "committedDate": "2020-06-12T14:22:25Z", "type": "commit"}, {"oid": "316748a7efa61feca3e8f08e4e91bedb759cf45a", "url": "https://github.com/Graylog2/graylog2-server/commit/316748a7efa61feca3e8f08e4e91bedb759cf45a", "message": "Removing `/sources` API endpoint.", "committedDate": "2020-06-12T14:22:25Z", "type": "commit"}, {"oid": "6d5537886b3a18eeaee62ce3ae6782ebb65a8343", "url": "https://github.com/Graylog2/graylog2-server/commit/6d5537886b3a18eeaee62ce3ae6782ebb65a8343", "message": "Removing `/terms` API endpoint.", "committedDate": "2020-06-12T14:22:25Z", "type": "commit"}, {"oid": "cad2c3b100c3c4f785f49b124c1f5a30a7d6bd5a", "url": "https://github.com/Graylog2/graylog2-server/commit/cad2c3b100c3c4f785f49b124c1f5a30a7d6bd5a", "message": "Removing orphaned result class.", "committedDate": "2020-06-12T14:22:25Z", "type": "commit"}, {"oid": "15945ce08b5ef2092319712001bb50c5425e650f", "url": "https://github.com/Graylog2/graylog2-server/commit/15945ce08b5ef2092319712001bb50c5425e650f", "message": "Removing obsolete methods/enums/fields, fixing array allocation.", "committedDate": "2020-06-12T14:22:26Z", "type": "commit"}, {"oid": "15945ce08b5ef2092319712001bb50c5425e650f", "url": "https://github.com/Graylog2/graylog2-server/commit/15945ce08b5ef2092319712001bb50c5425e650f", "message": "Removing obsolete methods/enums/fields, fixing array allocation.", "committedDate": "2020-06-12T14:22:26Z", "type": "forcePushed"}]}