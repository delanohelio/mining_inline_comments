{"pr_number": 7206, "pr_title": "Add mapping of stream ids in view content packs", "pr_createdAt": "2020-01-16T12:28:05Z", "pr_url": "https://github.com/Graylog2/graylog2-server/pull/7206", "timeline": [{"oid": "d3bba440220cf927fb0687c03f75806cc5758cf4", "url": "https://github.com/Graylog2/graylog2-server/commit/d3bba440220cf927fb0687c03f75806cc5758cf4", "message": "Add mapping of stream ids in view content packs\n\nPrior this change, when creating a content pack containing\nviews with streams the stream was collected as an dependency\ninto the content pack but the StreamEntity got a new id.\nThis id needs to be used in all references of the stream.\nTherefore also in the ViewEntity where a streamid is persisted.\nAlso when installing this content pack the installed\nstream has a new ID yet again and the view needs to know\nthis as well.\n\nThis change adds this mapping to the Widget and WidgetEntit\nfor the DashboardWidget.\nFor the search types there are now Entities so we can easily\nmap the streams during creation and installation of the\ncontent pack.\nFor the query we needed to add a generic Builder access\nfor the Filter so we could change the Stream id for\na StreamFilter and rebuild the Filter refered in the\nQueryEntity and Query.", "committedDate": "2020-01-16T10:28:55Z", "type": "commit"}, {"oid": "5b9770ed39276877e3348a5b7b08e72748fefdca", "url": "https://github.com/Graylog2/graylog2-server/commit/5b9770ed39276877e3348a5b7b08e72748fefdca", "message": "Add Test for stream mapping", "committedDate": "2020-01-16T12:23:58Z", "type": "commit"}, {"oid": "bf78d28a418e85f24cc2344c8ebafd2e3ddcccbe", "url": "https://github.com/Graylog2/graylog2-server/commit/bf78d28a418e85f24cc2344c8ebafd2e3ddcccbe", "message": "Add missing licenses headers", "committedDate": "2020-01-16T12:30:03Z", "type": "commit"}, {"oid": "a3447fbd55e057b8559a50e1fa0eb202bb41f0a1", "url": "https://github.com/Graylog2/graylog2-server/commit/a3447fbd55e057b8559a50e1fa0eb202bb41f0a1", "message": "Small improvement found be @alexkonn", "committedDate": "2020-01-17T08:21:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTA1OTI3OA==", "url": "https://github.com/Graylog2/graylog2-server/pull/7206#discussion_r369059278", "bodyText": "why not .equals(StreamFilter.NAME)?", "author": "mpfz0r", "createdAt": "2020-01-21T15:13:15Z", "path": "graylog2-server/src/main/java/org/graylog/plugins/views/search/Query.java", "diffHunk": "@@ -242,4 +247,36 @@ public Query build() {\n             return autoBuild();\n         }\n     }\n+\n+    // This code assumes that we only add streams via gui shallow.\n+    private Filter shallowMappedFilter(EntityDescriptorIds entityDescriptorIds) {\n+        return Optional.ofNullable(filter())\n+                .map(optFilter -> {\n+                    Set<Filter> newFilters = optFilter.filters().stream()\n+                            .map(filter -> {\n+                                if (filter.type().matches(StreamFilter.NAME)) {", "originalCommit": "a3447fbd55e057b8559a50e1fa0eb202bb41f0a1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e689df44c3f7b284af433a642773ed8c957c403f", "chunk": "diff --git a/graylog2-server/src/main/java/org/graylog/plugins/views/search/Query.java b/graylog2-server/src/main/java/org/graylog/plugins/views/search/Query.java\nindex 3346b5d48c..22db687f46 100644\n--- a/graylog2-server/src/main/java/org/graylog/plugins/views/search/Query.java\n+++ b/graylog2-server/src/main/java/org/graylog/plugins/views/search/Query.java\n\n@@ -248,13 +248,14 @@ public abstract class Query implements ContentPackable<QueryEntity> {\n         }\n     }\n \n-    // This code assumes that we only add streams via gui shallow.\n+    // TODO: This code assumes that we only use shallow filters for streams.\n+    //       If this ever changes, we need to implement a mapper that can handle filter trees.\n     private Filter shallowMappedFilter(EntityDescriptorIds entityDescriptorIds) {\n         return Optional.ofNullable(filter())\n                 .map(optFilter -> {\n                     Set<Filter> newFilters = optFilter.filters().stream()\n                             .map(filter -> {\n-                                if (filter.type().matches(StreamFilter.NAME)) {\n+                                if (filter.type().equals(StreamFilter.NAME)) {\n                                     final StreamFilter streamFilter = (StreamFilter) filter;\n                                     final String streamId = entityDescriptorIds.\n                                             getOrThrow(streamFilter.streamId(), ModelTypes.STREAM_V1);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTIxODMwNA==", "url": "https://github.com/Graylog2/graylog2-server/pull/7206#discussion_r369218304", "bodyText": "This isn't used", "author": "mpfz0r", "createdAt": "2020-01-21T20:10:14Z", "path": "graylog2-server/src/test/java/org/graylog2/contentpacks/facades/ViewFacadeTest.java", "diffHunk": "@@ -62,15 +70,18 @@\n import org.graylog2.plugin.cluster.ClusterConfigService;\n import org.graylog2.plugin.indexer.searches.timeranges.KeywordRange;\n import org.graylog2.shared.bindings.providers.ObjectMapperProvider;\n+import org.graylog2.streams.StreamImpl;\n import org.joda.time.DateTime;\n import org.joda.time.DateTimeZone;\n import org.junit.Before;\n import org.junit.ClassRule;\n import org.junit.Rule;\n import org.junit.Test;\n \n+import javax.swing.text.html.Option;", "originalCommit": "a3447fbd55e057b8559a50e1fa0eb202bb41f0a1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e689df44c3f7b284af433a642773ed8c957c403f", "chunk": "diff --git a/graylog2-server/src/test/java/org/graylog2/contentpacks/facades/ViewFacadeTest.java b/graylog2-server/src/test/java/org/graylog2/contentpacks/facades/ViewFacadeTest.java\nindex 077e33de3a..bfd075fd96 100644\n--- a/graylog2-server/src/test/java/org/graylog2/contentpacks/facades/ViewFacadeTest.java\n+++ b/graylog2-server/src/test/java/org/graylog2/contentpacks/facades/ViewFacadeTest.java\n\n@@ -78,14 +78,12 @@ import org.junit.ClassRule;\n import org.junit.Rule;\n import org.junit.Test;\n \n-import javax.swing.text.html.Option;\n import javax.ws.rs.NotFoundException;\n import java.util.Collections;\n import java.util.HashMap;\n import java.util.Map;\n import java.util.Optional;\n import java.util.Set;\n-import java.util.stream.Collectors;\n \n import static com.lordofthejars.nosqlunit.mongodb.InMemoryMongoDb.InMemoryMongoRuleBuilder.newInMemoryMongoDbRule;\n import static org.assertj.core.api.Assertions.assertThat;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTQzMzU5OQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/7206#discussion_r369433599", "bodyText": "I'd make this a TODO:\nSuggestion:\n// TODO This code assumes that we only use shallow filters for streams. If this ever changes, we need to implement a mapper that can handle filter trees.", "author": "mpfz0r", "createdAt": "2020-01-22T08:54:35Z", "path": "graylog2-server/src/main/java/org/graylog/plugins/views/search/Query.java", "diffHunk": "@@ -242,4 +247,36 @@ public Query build() {\n             return autoBuild();\n         }\n     }\n+\n+    // This code assumes that we only add streams via gui shallow.", "originalCommit": "a3447fbd55e057b8559a50e1fa0eb202bb41f0a1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e689df44c3f7b284af433a642773ed8c957c403f", "chunk": "diff --git a/graylog2-server/src/main/java/org/graylog/plugins/views/search/Query.java b/graylog2-server/src/main/java/org/graylog/plugins/views/search/Query.java\nindex 3346b5d48c..22db687f46 100644\n--- a/graylog2-server/src/main/java/org/graylog/plugins/views/search/Query.java\n+++ b/graylog2-server/src/main/java/org/graylog/plugins/views/search/Query.java\n\n@@ -248,13 +248,14 @@ public abstract class Query implements ContentPackable<QueryEntity> {\n         }\n     }\n \n-    // This code assumes that we only add streams via gui shallow.\n+    // TODO: This code assumes that we only use shallow filters for streams.\n+    //       If this ever changes, we need to implement a mapper that can handle filter trees.\n     private Filter shallowMappedFilter(EntityDescriptorIds entityDescriptorIds) {\n         return Optional.ofNullable(filter())\n                 .map(optFilter -> {\n                     Set<Filter> newFilters = optFilter.filters().stream()\n                             .map(filter -> {\n-                                if (filter.type().matches(StreamFilter.NAME)) {\n+                                if (filter.type().equals(StreamFilter.NAME)) {\n                                     final StreamFilter streamFilter = (StreamFilter) filter;\n                                     final String streamId = entityDescriptorIds.\n                                             getOrThrow(streamFilter.streamId(), ModelTypes.STREAM_V1);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTQzMzc3Nw==", "url": "https://github.com/Graylog2/graylog2-server/pull/7206#discussion_r369433777", "bodyText": "Same as above", "author": "mpfz0r", "createdAt": "2020-01-22T08:54:58Z", "path": "graylog2-server/src/main/java/org/graylog2/contentpacks/model/entities/QueryEntity.java", "diffHunk": "@@ -0,0 +1,168 @@\n+/**\n+ * This file is part of Graylog.\n+ *\n+ * Graylog is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * Graylog is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public License\n+ * along with Graylog.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+package org.graylog2.contentpacks.model.entities;\n+\n+import com.fasterxml.jackson.annotation.JsonAutoDetect;\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonIgnore;\n+import com.fasterxml.jackson.annotation.JsonInclude;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.databind.annotation.JsonDeserialize;\n+import com.fasterxml.jackson.databind.annotation.JsonPOJOBuilder;\n+import com.google.auto.value.AutoValue;\n+import com.google.common.collect.ImmutableSet;\n+import com.google.common.graph.Traverser;\n+import org.graylog.plugins.views.search.Filter;\n+import org.graylog.plugins.views.search.GlobalOverride;\n+import org.graylog.plugins.views.search.Query;\n+import org.graylog.plugins.views.search.engine.BackendQuery;\n+import org.graylog.plugins.views.search.filter.StreamFilter;\n+import org.graylog2.contentpacks.NativeEntityConverter;\n+import org.graylog2.contentpacks.exceptions.ContentPackException;\n+import org.graylog2.contentpacks.model.ModelTypes;\n+import org.graylog2.contentpacks.model.entities.references.ValueReference;\n+import org.graylog2.plugin.indexer.searches.timeranges.TimeRange;\n+import org.graylog2.plugin.streams.Stream;\n+\n+import javax.annotation.Nonnull;\n+import javax.annotation.Nullable;\n+import java.util.Collections;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.StreamSupport;\n+\n+import static com.google.common.base.MoreObjects.firstNonNull;\n+import static com.google.common.collect.ImmutableSortedSet.of;\n+import static java.util.stream.Collectors.toSet;\n+\n+@AutoValue\n+@JsonAutoDetect\n+@JsonInclude(JsonInclude.Include.NON_NULL)\n+@JsonDeserialize(builder = QueryEntity.Builder.class)\n+public abstract class QueryEntity implements NativeEntityConverter<Query> {\n+\n+    @JsonProperty\n+    public abstract String id();\n+\n+    @JsonProperty\n+    public abstract TimeRange timerange();\n+\n+    @Nullable\n+    @JsonProperty\n+    public abstract Filter filter();\n+\n+    @Nonnull\n+    @JsonProperty\n+    public abstract BackendQuery query();\n+\n+    @JsonIgnore\n+    public abstract Optional<GlobalOverride> globalOverride();\n+\n+    @Nonnull\n+    @JsonProperty(\"search_types\")\n+    public abstract ImmutableSet<SearchTypeEntity> searchTypes();\n+\n+    public Set<String> usedStreamIds() {\n+        return Optional.ofNullable(filter())\n+                .map(optFilter -> {\n+                    @SuppressWarnings(\"UnstableApiUsage\") final Traverser<Filter> filterTraverser = Traverser.forTree(filter -> firstNonNull(filter.filters(), Collections.emptySet()));\n+                    return StreamSupport.stream(filterTraverser.breadthFirst(optFilter).spliterator(), false)\n+                            .filter(filter -> filter instanceof StreamFilter)\n+                            .map(streamFilter -> ((StreamFilter) streamFilter).streamId())\n+                            .filter(Objects::nonNull)\n+                            .collect(toSet());\n+                })\n+                .orElse(Collections.emptySet());\n+    }\n+\n+    public abstract Builder toBuilder();\n+\n+    public static Builder builder() {\n+        return Builder.createWithDefaults();\n+    }\n+\n+    @AutoValue.Builder\n+    @JsonPOJOBuilder(withPrefix = \"\")\n+    public abstract static class Builder {\n+        @JsonProperty\n+        public abstract Builder id(String id);\n+\n+        @JsonProperty\n+        public abstract Builder timerange(TimeRange timerange);\n+\n+        @JsonProperty\n+        public abstract Builder filter(Filter filter);\n+\n+        @JsonProperty\n+        public abstract Builder query(BackendQuery query);\n+\n+        public abstract Builder globalOverride(@Nullable GlobalOverride globalOverride);\n+\n+        @JsonProperty(\"search_types\")\n+        public abstract Builder searchTypes(@Nullable Set<SearchTypeEntity> searchTypes);\n+\n+        abstract QueryEntity autoBuild();\n+\n+        @JsonCreator\n+        static Builder createWithDefaults() {\n+            return new AutoValue_QueryEntity.Builder().searchTypes(of());\n+        }\n+\n+        public QueryEntity build() {\n+            return autoBuild();\n+        }\n+    }\n+\n+    // This code assumes that we only add streams via gui shallow.", "originalCommit": "a3447fbd55e057b8559a50e1fa0eb202bb41f0a1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e689df44c3f7b284af433a642773ed8c957c403f", "chunk": "diff --git a/graylog2-server/src/main/java/org/graylog2/contentpacks/model/entities/QueryEntity.java b/graylog2-server/src/main/java/org/graylog2/contentpacks/model/entities/QueryEntity.java\nindex 44b50618b1..8ce517aacc 100644\n--- a/graylog2-server/src/main/java/org/graylog2/contentpacks/model/entities/QueryEntity.java\n+++ b/graylog2-server/src/main/java/org/graylog2/contentpacks/model/entities/QueryEntity.java\n\n@@ -130,7 +130,8 @@ public abstract class QueryEntity implements NativeEntityConverter<Query> {\n         }\n     }\n \n-    // This code assumes that we only add streams via gui shallow.\n+    // TODO: This code assumes that we only use shallow filters for streams.\n+    //       If this ever changes, we need to implement a mapper that can handle filter trees.\n     private Filter shallowMappedFilter(Map<EntityDescriptor, Object> nativeEntities) {\n        return Optional.ofNullable(filter())\n                .map(optFilter -> {\n"}}, {"oid": "e689df44c3f7b284af433a642773ed8c957c403f", "url": "https://github.com/Graylog2/graylog2-server/commit/e689df44c3f7b284af433a642773ed8c957c403f", "message": "Fix annotations from @mpfz0r", "committedDate": "2020-01-22T09:17:53Z", "type": "commit"}]}