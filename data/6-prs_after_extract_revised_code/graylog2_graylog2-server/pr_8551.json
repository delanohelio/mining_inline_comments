{"pr_number": 8551, "pr_title": "Adding ES7 adapter for reopened indices migration.", "pr_createdAt": "2020-07-15T12:35:06Z", "pr_url": "https://github.com/Graylog2/graylog2-server/pull/8551", "timeline": [{"oid": "11219f74547425a0eab1813007b9e6a0a4210052", "url": "https://github.com/Graylog2/graylog2-server/commit/11219f74547425a0eab1813007b9e6a0a4210052", "message": "Adding ES7 adapter for migration.", "committedDate": "2020-07-16T08:36:04Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY5NzA1Nw==", "url": "https://github.com/Graylog2/graylog2-server/pull/8551#discussion_r455697057", "bodyText": "I think it would make sense to reuse ClusterStateApi here. ClusterStateApi#request is the exact same and I find the risk of unexpectedly breaking the migration low enough, because that stuff does so little besides calling the API. That shouldn't really change within the scope of the ES7 driver.", "author": "alex-konn", "createdAt": "2020-07-16T10:48:18Z", "path": "graylog-storage-elasticsearch7/src/main/java/org/graylog/storage/elasticsearch7/migrations/V20170607164210_MigrateReopenedIndicesToAliasesClusterStateES7.java", "diffHunk": "@@ -0,0 +1,35 @@\n+package org.graylog.storage.elasticsearch7.migrations;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.client.Request;\n+import org.graylog.storage.elasticsearch7.PlainJsonApi;\n+import org.graylog2.migrations.V20170607164210_MigrateReopenedIndicesToAliases;\n+\n+import javax.inject.Inject;\n+import java.util.Collection;\n+\n+public class V20170607164210_MigrateReopenedIndicesToAliasesClusterStateES7 implements V20170607164210_MigrateReopenedIndicesToAliases.ClusterState {\n+    private final PlainJsonApi plainJsonApi;\n+\n+    @Inject\n+    public V20170607164210_MigrateReopenedIndicesToAliasesClusterStateES7(PlainJsonApi plainJsonApi) {\n+        this.plainJsonApi = plainJsonApi;\n+    }\n+\n+    @Override\n+    public JsonNode getForIndices(Collection<String> indices) {\n+        return plainJsonApi.perform(request(indices),\n+                \"Couldn't read cluster state for reopened indices \" + indices);\n+    }\n+\n+    private Request request(Collection<String> indices) {\n+        final StringBuilder apiEndpoint = new StringBuilder(\"/_cluster/state/metadata\");", "originalCommit": "0d6fd3f12dd64b77218086b16e05ea53b28cbd94", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "4bd6022df188018fb217eb4bce8fa0481e200731", "url": "https://github.com/Graylog2/graylog2-server/commit/4bd6022df188018fb217eb4bce8fa0481e200731", "message": "Adding ES7 adapter for migration.", "committedDate": "2020-07-16T12:17:59Z", "type": "commit"}, {"oid": "200232d2bc8aaaf05272d076a46684e26579e372", "url": "https://github.com/Graylog2/graylog2-server/commit/200232d2bc8aaaf05272d076a46684e26579e372", "message": "Allow v7 for migration.", "committedDate": "2020-07-16T12:18:01Z", "type": "commit"}, {"oid": "200232d2bc8aaaf05272d076a46684e26579e372", "url": "https://github.com/Graylog2/graylog2-server/commit/200232d2bc8aaaf05272d076a46684e26579e372", "message": "Allow v7 for migration.", "committedDate": "2020-07-16T12:18:01Z", "type": "forcePushed"}]}