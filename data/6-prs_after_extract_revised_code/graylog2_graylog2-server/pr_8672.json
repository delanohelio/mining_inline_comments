{"pr_number": 8672, "pr_title": "Enable Search After for ES7 exports by adding a field alias for gl2_message_id in event indices", "pr_createdAt": "2020-07-31T15:47:38Z", "pr_url": "https://github.com/Graylog2/graylog2-server/pull/8672", "timeline": [{"oid": "bd3bfd6ff9f96cb6f07dbbfc6f574313c4aee0a6", "url": "https://github.com/Graylog2/graylog2-server/commit/bd3bfd6ff9f96cb6f07dbbfc6f574313c4aee0a6", "message": "Remove tie breaker workarounds for ES7 SearchAfter", "committedDate": "2020-08-03T08:07:12Z", "type": "commit"}, {"oid": "902176f14c5727867fcd67df22bca0b0c9d76e8b", "url": "https://github.com/Graylog2/graylog2-server/commit/902176f14c5727867fcd67df22bca0b0c9d76e8b", "message": "Use SearchAfter for ES7 export", "committedDate": "2020-08-03T08:07:12Z", "type": "commit"}, {"oid": "a0dfe76e2156af97127653981def701451eb704a", "url": "https://github.com/Graylog2/graylog2-server/commit/a0dfe76e2156af97127653981def701451eb704a", "message": "Remove ES7 export scrolling", "committedDate": "2020-08-03T08:07:12Z", "type": "commit"}, {"oid": "d2e05fe69ce74e6a79e62d9fe1729e20a9964e7d", "url": "https://github.com/Graylog2/graylog2-server/commit/d2e05fe69ce74e6a79e62d9fe1729e20a9964e7d", "message": "Added new migration for adding the field alias\n\n- Created migration class with basic functionality\n- Created tests for basic functionality", "committedDate": "2020-08-03T08:07:12Z", "type": "commit"}, {"oid": "5dd0bf86d6f996dc795c77d78a3c8a0d99d94666", "url": "https://github.com/Graylog2/graylog2-server/commit/5dd0bf86d6f996dc795c77d78a3c8a0d99d94666", "message": "Implement Elasticsearch adapter for new migration\n\nOnly an ES7 adapter was added. Since field aliases were introduced for 6.4, adding in ES6 support would be too complicated to be worth it.\n\n- Created ES7 adapter for new migration\n- Created integration test for new adapter\n- Allow accessing the RestHighLevelClient from ElasticsearchInstanceES7", "committedDate": "2020-08-03T08:07:12Z", "type": "commit"}, {"oid": "aa34654ea1f83571ed107c6075d095098224d6bb", "url": "https://github.com/Graylog2/graylog2-server/commit/aa34654ea1f83571ed107c6075d095098224d6bb", "message": "Skip migration for ES versions < 7\n\nSince field aliases were only introduced for 6.4, we will only use them for version 7 and above. Otherwise we would have to differentiate between different minor versions for 6, which would make things considerably more complicated.", "committedDate": "2020-08-03T08:07:12Z", "type": "commit"}, {"oid": "799c602220c90c87254c59f2ba807947f1a63592", "url": "https://github.com/Graylog2/graylog2-server/commit/799c602220c90c87254c59f2ba807947f1a63592", "message": "Wire up Guice bindings for migration\n\nAlso added an ES6 implementation for the adapter. It should never be called and will throw an exception otherwise. This makes sure that:\n - We don't accidentally add field aliases for ES versions < 6.4 where they are not supported\n - The migration doesn't mark itself as completed without actually adding field aliases.\n\n When a customer runs Graylog 4.0 on ES6, field aliases will not be added, but the migration will try again on subsequent server restarts. So if they upgrade to ES7 at a later point and restart the server, the migration will run and add the field aliases.", "committedDate": "2020-08-03T08:07:12Z", "type": "commit"}, {"oid": "6ece5af5191438cd3151c3018d7be5c9de4afef0", "url": "https://github.com/Graylog2/graylog2-server/commit/6ece5af5191438cd3151c3018d7be5c9de4afef0", "message": "Added field alias to EventsIndexMapping7", "committedDate": "2020-08-03T08:07:12Z", "type": "commit"}, {"oid": "974d55c3983dc7115739bad138cf03d34e84d406", "url": "https://github.com/Graylog2/graylog2-server/commit/974d55c3983dc7115739bad138cf03d34e84d406", "message": "Use test client instead of IndicesAdapterES7\n\n...for creating test indices in V20200730000000_AddGl2MessageIdFieldAliasForEventsES7IT", "committedDate": "2020-08-03T08:07:12Z", "type": "commit"}, {"oid": "974d55c3983dc7115739bad138cf03d34e84d406", "url": "https://github.com/Graylog2/graylog2-server/commit/974d55c3983dc7115739bad138cf03d34e84d406", "message": "Use test client instead of IndicesAdapterES7\n\n...for creating test indices in V20200730000000_AddGl2MessageIdFieldAliasForEventsES7IT", "committedDate": "2020-08-03T08:07:12Z", "type": "forcePushed"}, {"oid": "2ac5cddf1e3984bd3a912c37844d90af8adf28a1", "url": "https://github.com/Graylog2/graylog2-server/commit/2ac5cddf1e3984bd3a912c37844d90af8adf28a1", "message": "Fix formatting in VersionAwareStorageModule", "committedDate": "2020-08-03T14:39:57Z", "type": "commit"}, {"oid": "15b06413ed092ef28f2964894aa3dfb117bb392d", "url": "https://github.com/Graylog2/graylog2-server/commit/15b06413ed092ef28f2964894aa3dfb117bb392d", "message": "Remove completed marker, if present after ES downgrade\n\nIn case a customer goes back to pre-7 Elasticsearch version after the migration has been run, we remove the completed marker. This makes sure that the migration would run again once the customer goes back to a version >= 7.\nAlso added an integration test to make sure that adding the field aliases is idempotent.", "committedDate": "2020-08-03T15:12:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTA4MDc5OA==", "url": "https://github.com/Graylog2/graylog2-server/pull/8672#discussion_r465080798", "bodyText": "Please do not use wildcard imports.", "author": "dennisoelkers", "createdAt": "2020-08-04T14:12:57Z", "path": "graylog2-server/src/main/java/org/graylog2/storage/VersionAwareStorageModule.java", "diffHunk": "@@ -31,18 +31,7 @@\n import org.graylog2.indexer.messages.MessagesAdapter;\n import org.graylog2.indexer.searches.SearchesAdapter;\n import org.graylog2.migrations.V20170607164210_MigrateReopenedIndicesToAliases;\n-import org.graylog2.storage.providers.ClusterAdapterProvider;\n-import org.graylog2.storage.providers.CountsAdapterProvider;\n-import org.graylog2.storage.providers.ElasticsearchBackendProvider;\n-import org.graylog2.storage.providers.IndexFieldTypePollerAdapterProvider;\n-import org.graylog2.storage.providers.IndexToolsAdapterProvider;\n-import org.graylog2.storage.providers.IndicesAdapterProvider;\n-import org.graylog2.storage.providers.MessagesAdapterProvider;\n-import org.graylog2.storage.providers.MoreSearchAdapterProvider;\n-import org.graylog2.storage.providers.NodeAdapterProvider;\n-import org.graylog2.storage.providers.SearchesAdapterProvider;\n-import org.graylog2.storage.providers.V20170607164210_MigrateReopenedIndicesToAliasesClusterStateAdapterProvider;\n-import org.graylog2.storage.providers.V20200730000000_AddGl2MessageIdFieldAliasForEventsElasticsearchAdapterProvider;\n+import org.graylog2.storage.providers.*;", "originalCommit": "15b06413ed092ef28f2964894aa3dfb117bb392d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8327e0e6d959a5eaf77f031fe6e0556656e876b5", "chunk": "diff --git a/graylog2-server/src/main/java/org/graylog2/storage/VersionAwareStorageModule.java b/graylog2-server/src/main/java/org/graylog2/storage/VersionAwareStorageModule.java\nindex ae591d0891..c25f0f6ac5 100644\n--- a/graylog2-server/src/main/java/org/graylog2/storage/VersionAwareStorageModule.java\n+++ b/graylog2-server/src/main/java/org/graylog2/storage/VersionAwareStorageModule.java\n\n@@ -31,7 +31,19 @@ import org.graylog2.indexer.indices.IndicesAdapter;\n import org.graylog2.indexer.messages.MessagesAdapter;\n import org.graylog2.indexer.searches.SearchesAdapter;\n import org.graylog2.migrations.V20170607164210_MigrateReopenedIndicesToAliases;\n-import org.graylog2.storage.providers.*;\n+import org.graylog2.storage.providers.ClusterAdapterProvider;\n+import org.graylog2.storage.providers.CountsAdapterProvider;\n+import org.graylog2.storage.providers.ElasticsearchBackendProvider;\n+import org.graylog2.storage.providers.IndexFieldTypePollerAdapterProvider;\n+import org.graylog2.storage.providers.IndexToolsAdapterProvider;\n+import org.graylog2.storage.providers.IndicesAdapterProvider;\n+import org.graylog2.storage.providers.MessagesAdapterProvider;\n+import org.graylog2.storage.providers.MoreSearchAdapterProvider;\n+import org.graylog2.storage.providers.NodeAdapterProvider;\n+import org.graylog2.storage.providers.SearchesAdapterProvider;\n+import org.graylog2.storage.providers.V20170607164210_MigrateReopenedIndicesToAliasesClusterStateAdapterProvider;\n+import org.graylog2.storage.providers.V20200730000000_AddGl2MessageIdFieldAliasForEventsElasticsearchAdapterProvider;\n+\n \n public class VersionAwareStorageModule extends AbstractModule {\n     @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTA4MDkxOQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/8672#discussion_r465080919", "bodyText": "Please do not use wildcard imports.", "author": "dennisoelkers", "createdAt": "2020-08-04T14:13:06Z", "path": "graylog2-server/src/test/java/org/graylog/plugins/views/migrations/V20200730000000_AddGl2MessageIdFieldAliasForEventsTest.java", "diffHunk": "@@ -27,10 +27,7 @@\n \n import static org.assertj.core.api.Assertions.assertThat;\n import static org.mockito.ArgumentMatchers.any;\n-import static org.mockito.Mockito.mock;\n-import static org.mockito.Mockito.never;\n-import static org.mockito.Mockito.verify;\n-import static org.mockito.Mockito.when;\n+import static org.mockito.Mockito.*;", "originalCommit": "15b06413ed092ef28f2964894aa3dfb117bb392d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8327e0e6d959a5eaf77f031fe6e0556656e876b5", "chunk": "diff --git a/graylog2-server/src/test/java/org/graylog/plugins/views/migrations/V20200730000000_AddGl2MessageIdFieldAliasForEventsTest.java b/graylog2-server/src/test/java/org/graylog/plugins/views/migrations/V20200730000000_AddGl2MessageIdFieldAliasForEventsTest.java\nindex 73626a37b0..30e2289fc4 100644\n--- a/graylog2-server/src/test/java/org/graylog/plugins/views/migrations/V20200730000000_AddGl2MessageIdFieldAliasForEventsTest.java\n+++ b/graylog2-server/src/test/java/org/graylog/plugins/views/migrations/V20200730000000_AddGl2MessageIdFieldAliasForEventsTest.java\n\n@@ -27,7 +27,10 @@ import org.mockito.ArgumentCaptor;\n \n import static org.assertj.core.api.Assertions.assertThat;\n import static org.mockito.ArgumentMatchers.any;\n-import static org.mockito.Mockito.*;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.never;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n import static org.mockito.internal.verification.VerificationModeFactory.times;\n \n class V20200730000000_AddGl2MessageIdFieldAliasForEventsTest {\n"}}, {"oid": "8327e0e6d959a5eaf77f031fe6e0556656e876b5", "url": "https://github.com/Graylog2/graylog2-server/commit/8327e0e6d959a5eaf77f031fe6e0556656e876b5", "message": "Fixed accidentally introduced star imports", "committedDate": "2020-08-04T14:22:55Z", "type": "commit"}]}