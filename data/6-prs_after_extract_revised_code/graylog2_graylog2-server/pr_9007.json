{"pr_number": 9007, "pr_title": "Add authentication services infrastructure", "pr_createdAt": "2020-09-21T17:03:37Z", "pr_url": "https://github.com/Graylog2/graylog2-server/pull/9007", "timeline": [{"oid": "ef649d8aa03b443f4d9e209f4b59aee69cd848fd", "url": "https://github.com/Graylog2/graylog2-server/commit/ef649d8aa03b443f4d9e209f4b59aee69cd848fd", "message": "Start identity provider authenticating realm", "committedDate": "2020-09-04T06:59:10Z", "type": "commit"}, {"oid": "df7a45b43d93f532935c8412b8385161e931475b", "url": "https://github.com/Graylog2/graylog2-server/commit/df7a45b43d93f532935c8412b8385161e931475b", "message": "Start a MongoDB identity provider", "committedDate": "2020-09-04T08:33:28Z", "type": "commit"}, {"oid": "fa78501171ed12ab58b0a5a36756617a81e57abe", "url": "https://github.com/Graylog2/graylog2-server/commit/fa78501171ed12ab58b0a5a36756617a81e57abe", "message": "Remove unused fields", "committedDate": "2020-09-04T08:36:31Z", "type": "commit"}, {"oid": "2617e3cf2db334ac6bedca0e6af9a97f7028c0b1", "url": "https://github.com/Graylog2/graylog2-server/commit/2617e3cf2db334ac6bedca0e6af9a97f7028c0b1", "message": "Add global identity provider config", "committedDate": "2020-09-04T09:00:27Z", "type": "commit"}, {"oid": "1d41fbe8161195e6ec0d9704f750982330d2afef", "url": "https://github.com/Graylog2/graylog2-server/commit/1d41fbe8161195e6ec0d9704f750982330d2afef", "message": "Start user profile and profile provisioner", "committedDate": "2020-09-04T10:53:01Z", "type": "commit"}, {"oid": "5f58b1d870a8435c68eb3f097a6e491ace61b316", "url": "https://github.com/Graylog2/graylog2-server/commit/5f58b1d870a8435c68eb3f097a6e491ace61b316", "message": "Better realm name", "committedDate": "2020-09-04T11:30:44Z", "type": "commit"}, {"oid": "d57993c55581619719639839bf6ade434e5187a8", "url": "https://github.com/Graylog2/graylog2-server/commit/d57993c55581619719639839bf6ade434e5187a8", "message": "Add comment", "committedDate": "2020-09-04T12:35:36Z", "type": "commit"}, {"oid": "a658bd06b4ce46489a745cbe3537757777b9a465", "url": "https://github.com/Graylog2/graylog2-server/commit/a658bd06b4ce46489a745cbe3537757777b9a465", "message": "Merge branch 'feature/permissions' into feature/idp", "committedDate": "2020-09-10T14:40:29Z", "type": "commit"}, {"oid": "4605a8b211f73bbd58663d357aa91baa9813ad3d", "url": "https://github.com/Graylog2/graylog2-server/commit/4605a8b211f73bbd58663d357aa91baa9813ad3d", "message": "Rename identity provider to authentication service", "committedDate": "2020-09-10T15:54:02Z", "type": "commit"}, {"oid": "a36e42b383f301d60b03749ed4f3647768c31549", "url": "https://github.com/Graylog2/graylog2-server/commit/a36e42b383f301d60b03749ed4f3647768c31549", "message": "Rename some fields", "committedDate": "2020-09-15T15:37:26Z", "type": "commit"}, {"oid": "7f0a97e219d6f997075755ebc94a7714d583029a", "url": "https://github.com/Graylog2/graylog2-server/commit/7f0a97e219d6f997075755ebc94a7714d583029a", "message": "Add AuthServiceBackend#backendType()", "committedDate": "2020-09-15T16:10:28Z", "type": "commit"}, {"oid": "3ce54ed35635d8006b658331645d1142e32a059b", "url": "https://github.com/Graylog2/graylog2-server/commit/3ce54ed35635d8006b658331645d1142e32a059b", "message": "Rename UserProfileProvisioner to ProvisionerService and add actions", "committedDate": "2020-09-15T16:33:57Z", "type": "commit"}, {"oid": "b8175906f451ffb8990e721cccc912d552f366a3", "url": "https://github.com/Graylog2/graylog2-server/commit/b8175906f451ffb8990e721cccc912d552f366a3", "message": "Add ProvisionException", "committedDate": "2020-09-15T16:40:02Z", "type": "commit"}, {"oid": "f834da8e334d350ad6afc50a640b161d9bce5201", "url": "https://github.com/Graylog2/graylog2-server/commit/f834da8e334d350ad6afc50a640b161d9bce5201", "message": "Add constant for default session timeout", "committedDate": "2020-09-16T17:02:27Z", "type": "commit"}, {"oid": "68a264147ee577ea764743bd713b30b786b9502b", "url": "https://github.com/Graylog2/graylog2-server/commit/68a264147ee577ea764743bd713b30b786b9502b", "message": "Add auth_service_id and auth_service_uid to User and UserService", "committedDate": "2020-09-16T17:03:51Z", "type": "commit"}, {"oid": "c28e4e63b6d442d683c2642dff4cffead0b52df8", "url": "https://github.com/Graylog2/graylog2-server/commit/c28e4e63b6d442d683c2642dff4cffead0b52df8", "message": "Provision a new user for external auth services", "committedDate": "2020-09-16T17:05:33Z", "type": "commit"}, {"oid": "f8621aa04a97eca9c7e55f463db87bcbd505da6b", "url": "https://github.com/Graylog2/graylog2-server/commit/f8621aa04a97eca9c7e55f463db87bcbd505da6b", "message": "Merge remote-tracking branch 'origin/feature/permissions' into feature/idp", "committedDate": "2020-09-16T17:06:26Z", "type": "commit"}, {"oid": "30978e45cdc7d57b81222721cb076ff9861cb0c4", "url": "https://github.com/Graylog2/graylog2-server/commit/30978e45cdc7d57b81222721cb076ff9861cb0c4", "message": "Use a map binder and factories for provisioner actions", "committedDate": "2020-09-17T08:41:42Z", "type": "commit"}, {"oid": "7d1990a310fb519fc245948fa8ffb417d55f8f3c", "url": "https://github.com/Graylog2/graylog2-server/commit/7d1990a310fb519fc245948fa8ffb417d55f8f3c", "message": "Adjust ProvisionerService#newDetails()", "committedDate": "2020-09-17T09:48:21Z", "type": "commit"}, {"oid": "6f7b55eba41dbd43d9180fc9d156c6599e7a937d", "url": "https://github.com/Graylog2/graylog2-server/commit/6f7b55eba41dbd43d9180fc9d156c6599e7a937d", "message": "Set placeholder password for new users", "committedDate": "2020-09-17T09:56:46Z", "type": "commit"}, {"oid": "8d87fe14a87340d841a18825d040752ee981ad19", "url": "https://github.com/Graylog2/graylog2-server/commit/8d87fe14a87340d841a18825d040752ee981ad19", "message": "Introduce EncryptedValue and related classes\n\nThis class contains an encrypted value and its salt. I can be used when\nsensitive data must be stored in the database.\n\nIt comes with a custom JSON serializer and deserializer. They serialize\nand deserialize the value in different ways depending on the context.\nWhen storing/reading the value in/from MongoDB, the literal content\n(encrypted value and salt) are read/written.\nIn all other contexts, the serialized JSON only contains an indicator if\nthe value is set or not. When parsing the JSON, only a \"set_value\" field\nis allowed to set a new value.\n\nThe deserializer automatically creates an encrypted value and salt from\nthe given new plain text value.", "committedDate": "2020-09-18T12:10:03Z", "type": "commit"}, {"oid": "f90ac2212342701fc457e7619402dd4e46511b9f", "url": "https://github.com/Graylog2/graylog2-server/commit/f90ac2212342701fc457e7619402dd4e46511b9f", "message": "Add UserService#loadAllForAuthServiceBackend", "committedDate": "2020-09-18T14:49:45Z", "type": "commit"}, {"oid": "38bbeb3f92c60def3de7cb0567f0cd287a172878", "url": "https://github.com/Graylog2/graylog2-server/commit/38bbeb3f92c60def3de7cb0567f0cd287a172878", "message": "Extend GlobalAuthServiceConfig for updates", "committedDate": "2020-09-18T14:50:15Z", "type": "commit"}, {"oid": "31eafdb54fe6011e65a932367401b627ba6e0cd9", "url": "https://github.com/Graylog2/graylog2-server/commit/31eafdb54fe6011e65a932367401b627ba6e0cd9", "message": "Add ValidationFailureException and corresponding mapper", "committedDate": "2020-09-18T15:32:05Z", "type": "commit"}, {"oid": "309cf310a1b08cfa458b0d92c5c1fa6cb5ac534d", "url": "https://github.com/Graylog2/graylog2-server/commit/309cf310a1b08cfa458b0d92c5c1fa6cb5ac534d", "message": "Implement auth backends and configurations", "committedDate": "2020-09-18T16:34:17Z", "type": "commit"}, {"oid": "8edb6e6be43d1715f4979e504287971576018432", "url": "https://github.com/Graylog2/graylog2-server/commit/8edb6e6be43d1715f4979e504287971576018432", "message": "Extract TrustManagerProvider into its own file so it can be reused", "committedDate": "2020-09-18T17:59:36Z", "type": "commit"}, {"oid": "9ffed8343c68b359ffcacdd5fe04de0eadc331d2", "url": "https://github.com/Graylog2/graylog2-server/commit/9ffed8343c68b359ffcacdd5fe04de0eadc331d2", "message": "Fix setting auth service attributes on User", "committedDate": "2020-09-19T00:40:03Z", "type": "commit"}, {"oid": "bd410aae1e3ce6f5794a4e040b52e172ee8ccd22", "url": "https://github.com/Graylog2/graylog2-server/commit/bd410aae1e3ce6f5794a4e040b52e172ee8ccd22", "message": "Add missing attribute to builder", "committedDate": "2020-09-19T00:40:30Z", "type": "commit"}, {"oid": "a58c37f47b6b1e60de35b44e0bd2fff977cfc3f3", "url": "https://github.com/Graylog2/graylog2-server/commit/a58c37f47b6b1e60de35b44e0bd2fff977cfc3f3", "message": "Fix user provisioning\n\nWe need to set an encrypted password value when creating a user.", "committedDate": "2020-09-19T00:43:51Z", "type": "commit"}, {"oid": "aaefbc99e2b5fe454fadf339cd832249506d6b0e", "url": "https://github.com/Graylog2/graylog2-server/commit/aaefbc99e2b5fe454fadf339cd832249506d6b0e", "message": "Include backend type in realm string in returned SimpleAccount", "committedDate": "2020-09-19T00:44:21Z", "type": "commit"}, {"oid": "fe2d5c46ed71ce7f60e72caf169107e7e471b564", "url": "https://github.com/Graylog2/graylog2-server/commit/fe2d5c46ed71ce7f60e72caf169107e7e471b564", "message": "Add missing user attributes to UserOverviewDTO", "committedDate": "2020-09-19T00:45:05Z", "type": "commit"}, {"oid": "84f6e243b811fdaebcb6fbedccf0852e19db7ced", "url": "https://github.com/Graylog2/graylog2-server/commit/84f6e243b811fdaebcb6fbedccf0852e19db7ced", "message": "Fall back to default backend if active backend doesn't work", "committedDate": "2020-09-19T01:00:26Z", "type": "commit"}, {"oid": "6143b50c536a50163506b9add92cad27ca809746", "url": "https://github.com/Graylog2/graylog2-server/commit/6143b50c536a50163506b9add92cad27ca809746", "message": "Remove unused variable", "committedDate": "2020-09-19T01:01:13Z", "type": "commit"}, {"oid": "3bcb34c2a7ba8126196d79f041d2852a2cbc4d54", "url": "https://github.com/Graylog2/graylog2-server/commit/3bcb34c2a7ba8126196d79f041d2852a2cbc4d54", "message": "Return null instead of a 404 if there is no active backend", "committedDate": "2020-09-21T10:34:34Z", "type": "commit"}, {"oid": "6b616206ff31a87d0b6d4419926cb617f1e52f24", "url": "https://github.com/Graylog2/graylog2-server/commit/6b616206ff31a87d0b6d4419926cb617f1e52f24", "message": "Add LdapEntry#getNonBlank and add some more tests", "committedDate": "2020-09-21T11:09:55Z", "type": "commit"}, {"oid": "793602aa8425987f2c1e667ffba9d4bbd6fd9245", "url": "https://github.com/Graylog2/graylog2-server/commit/793602aa8425987f2c1e667ffba9d4bbd6fd9245", "message": "Encrypt user password before passing it on to authentication services\n\nThis ensures that we don't expose it by accident (e.g. logging it)\nAll consumers need to decrypt it before they can use it.", "committedDate": "2020-09-21T12:33:55Z", "type": "commit"}, {"oid": "1430eaf16b060de93ba90f278e75a66d6455dd99", "url": "https://github.com/Graylog2/graylog2-server/commit/1430eaf16b060de93ba90f278e75a66d6455dd99", "message": "Reduce log level for some log statements", "committedDate": "2020-09-21T12:36:41Z", "type": "commit"}, {"oid": "54abf997dbfc289c6a88a66fab822abedcdb37d2", "url": "https://github.com/Graylog2/graylog2-server/commit/54abf997dbfc289c6a88a66fab822abedcdb37d2", "message": "Add auth service backend test code", "committedDate": "2020-09-21T15:54:54Z", "type": "commit"}, {"oid": "c3f9991e01b1b0df1878470b2b48a2f2d3e6da94", "url": "https://github.com/Graylog2/graylog2-server/commit/c3f9991e01b1b0df1878470b2b48a2f2d3e6da94", "message": "Add LDAP authentication service", "committedDate": "2020-09-21T16:06:23Z", "type": "commit"}, {"oid": "b81f8f74136c2dbaf2e38b072870c4ba0cbd6338", "url": "https://github.com/Graylog2/graylog2-server/commit/b81f8f74136c2dbaf2e38b072870c4ba0cbd6338", "message": "Don't run authentication services for the \"root_username\" user", "committedDate": "2020-09-21T16:54:08Z", "type": "commit"}, {"oid": "2c45a280a31522511fa020e7f814e0b9de8742c0", "url": "https://github.com/Graylog2/graylog2-server/commit/2c45a280a31522511fa020e7f814e0b9de8742c0", "message": "Use an explicit authenticating realm order instead of the dynamic one\n\nAlso disable binding of the legacy LDAP and MongoDB realm.s", "committedDate": "2020-09-21T16:56:19Z", "type": "commit"}, {"oid": "e59f11aa3544246c35a3fd64666d8c855e3881e0", "url": "https://github.com/Graylog2/graylog2-server/commit/e59f11aa3544246c35a3fd64666d8c855e3881e0", "message": "Merge branch 'feature/permissions' into feature/idp", "committedDate": "2020-09-21T16:59:09Z", "type": "commit"}, {"oid": "de9dd869f0b6d01fbde7968b7767876aeac9e82f", "url": "https://github.com/Graylog2/graylog2-server/commit/de9dd869f0b6d01fbde7968b7767876aeac9e82f", "message": "Fail login if provisioning fails", "committedDate": "2020-09-21T17:31:36Z", "type": "commit"}, {"oid": "cf55b222103f0054a41a2d8f3da74f7e2bf6cbf2", "url": "https://github.com/Graylog2/graylog2-server/commit/cf55b222103f0054a41a2d8f3da74f7e2bf6cbf2", "message": "Add TestPasswordSecretModule for guice injections in testing", "committedDate": "2020-09-21T17:37:32Z", "type": "commit"}, {"oid": "579545f40602081c83358b5a9ec850cf8a309b6a", "url": "https://github.com/Graylog2/graylog2-server/commit/579545f40602081c83358b5a9ec850cf8a309b6a", "message": "Add missing audit annotations to resources", "committedDate": "2020-09-21T17:45:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU5MzAxNg==", "url": "https://github.com/Graylog2/graylog2-server/pull/9007#discussion_r492593016", "bodyText": "My thoughts to this:\n\nLDAP server logs to graylog\nLDAP server is \"broken\"\nYou want to look at the problem but you can't log in to graylog since LDAP is \"broken\"\nA fallback user with reader rights (so other than admin) would be helpful", "author": "kmerz", "createdAt": "2020-09-22T09:23:04Z", "path": "graylog2-server/src/main/java/org/graylog/security/authservice/AuthServiceAuthenticator.java", "diffHunk": "@@ -0,0 +1,84 @@\n+/**\n+ * This file is part of Graylog.\n+ *\n+ * Graylog is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * Graylog is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public License\n+ * along with Graylog.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+package org.graylog.security.authservice;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import javax.inject.Inject;\n+import java.util.Optional;\n+\n+public class AuthServiceAuthenticator {\n+    private static final Logger LOG = LoggerFactory.getLogger(AuthServiceAuthenticator.class);\n+\n+    private final GlobalAuthServiceConfig authServiceConfig;\n+    private final ProvisionerService provisionerService;\n+\n+    @Inject\n+    public AuthServiceAuthenticator(GlobalAuthServiceConfig authServiceConfig,\n+                                    ProvisionerService provisionerService) {\n+        this.authServiceConfig = authServiceConfig;\n+        this.provisionerService = provisionerService;\n+    }\n+\n+    /**\n+     * Tries to authenticate the username with the given password and returns the authenticated username if successful.\n+     *\n+     * @param authCredentials the authentication credentials\n+     * @return the authenticated username\n+     */\n+    public AuthServiceResult authenticate(AuthServiceCredentials authCredentials) {\n+        final Optional<AuthServiceBackend> activeBackend = authServiceConfig.getActiveBackend();\n+\n+        if (activeBackend.isPresent()) {\n+            final AuthServiceResult result = authenticate(authCredentials, activeBackend.get());\n+            if (result.isSuccess()) {\n+                return result;\n+            }\n+            // TODO: Do we want the fallback to the default backend here? Maybe it should be configurable?", "originalCommit": "579545f40602081c83358b5a9ec850cf8a309b6a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjgwODM3Mw==", "url": "https://github.com/Graylog2/graylog2-server/pull/9007#discussion_r492808373", "bodyText": "@kmerz One fallback user that is always there (at least at the moment) is the root user account. People can also still add users to MongoDB as fallback admin accounts if the external provider breaks.\nThis comment was more about if we always want the fallback to the MongoDB backend or are there reasons to not do that. To make you use case work, we need the fallback. (and it's also that way at the moment)", "author": "bernd", "createdAt": "2020-09-22T15:02:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU5MzAxNg=="}], "type": "inlineReview", "revised_code": null}, {"oid": "772c7cc84bca5077090fd5513217756805609f10", "url": "https://github.com/Graylog2/graylog2-server/commit/772c7cc84bca5077090fd5513217756805609f10", "message": "Add /system/authentication/services/active-backend/users endpoint", "committedDate": "2020-09-23T17:49:01Z", "type": "commit"}]}