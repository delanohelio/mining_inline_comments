{"pr_number": 9790, "pr_title": "Add HTML emails compatibility for alerts notifications", "pr_createdAt": "2020-12-13T15:05:26Z", "pr_url": "https://github.com/Graylog2/graylog2-server/pull/9790", "timeline": [{"oid": "1507fc14e23380fe6f07ada0d949df8fe9c9499f", "url": "https://github.com/Graylog2/graylog2-server/commit/1507fc14e23380fe6f07ada0d949df8fe9c9499f", "message": "Add HTML emails compatibility for alerts notifications", "committedDate": "2020-12-13T15:57:41Z", "type": "commit"}, {"oid": "1507fc14e23380fe6f07ada0d949df8fe9c9499f", "url": "https://github.com/Graylog2/graylog2-server/commit/1507fc14e23380fe6f07ada0d949df8fe9c9499f", "message": "Add HTML emails compatibility for alerts notifications", "committedDate": "2020-12-13T15:57:41Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTgxMjc4MQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/9790#discussion_r551812781", "bodyText": "We need to make sure that older content packs (without this field) are still installable.\nI suggest you initialize the htmlBodyTemplate in the Builder.create()\nhttps://github.com/Graylog2/graylog2-server/pull/9790/files#diff-455b0c407c9c4eac48cf30ae314d1e2222e29fb27954534f291d6a84b3facf87L70\n.htmlBodyTemplate(ValueReference.of(\"\"))", "author": "mpfz0r", "createdAt": "2021-01-05T09:28:23Z", "path": "graylog2-server/src/main/java/org/graylog/events/contentpack/entities/EmailEventNotificationConfigEntity.java", "diffHunk": "@@ -50,6 +51,9 @@\n     @JsonProperty(FIELD_BODY_TEMPLATE)\n     public abstract ValueReference bodyTemplate();\n \n+    @JsonProperty(FIELD_HTML_BODY_TEMPLATE)\n+    public abstract ValueReference htmlBodyTemplate();", "originalCommit": "1507fc14e23380fe6f07ada0d949df8fe9c9499f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTgxNDYwNg==", "url": "https://github.com/Graylog2/graylog2-server/pull/9790#discussion_r551814606", "bodyText": "This should be an empty String by default. We don't want to automatically upgrade existing notifications to HTML.", "author": "mpfz0r", "createdAt": "2021-01-05T09:31:46Z", "path": "graylog2-server/src/main/java/org/graylog/events/notifications/types/EmailEventNotificationConfig.java", "diffHunk": "@@ -134,7 +166,8 @@ public static Builder create() {\n                     .subject(DEFAULT_SUBJECT)\n                     .emailRecipients(ImmutableSet.of())\n                     .userRecipients(ImmutableSet.of())\n-                    .bodyTemplate(DEFAULT_BODY_TEMPLATE);\n+                    .bodyTemplate(DEFAULT_BODY_TEMPLATE)\n+                    .htmlBodyTemplate(DEFAULT_HTML_BODY_TEMPLATE);", "originalCommit": "1507fc14e23380fe6f07ada0d949df8fe9c9499f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTgxNDgwMA==", "url": "https://github.com/Graylog2/graylog2-server/pull/9790#discussion_r551814800", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                .htmlBodyTemplate(DEFAULT_HTML_BODY_TEMPLATE);\n          \n          \n            \n                                .htmlBodyTemplate(\"\");", "author": "mpfz0r", "createdAt": "2021-01-05T09:32:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTgxNDYwNg=="}], "type": "inlineReview", "revised_code": {"commit": "cd59eddfa5b9e0e152fb5f717e121d880c39e344", "chunk": "diff --git a/graylog2-server/src/main/java/org/graylog/events/notifications/types/EmailEventNotificationConfig.java b/graylog2-server/src/main/java/org/graylog/events/notifications/types/EmailEventNotificationConfig.java\nindex d09feecfa6..3e713ab3e3 100644\n--- a/graylog2-server/src/main/java/org/graylog/events/notifications/types/EmailEventNotificationConfig.java\n+++ b/graylog2-server/src/main/java/org/graylog/events/notifications/types/EmailEventNotificationConfig.java\n\n@@ -167,7 +138,7 @@ public abstract class EmailEventNotificationConfig implements EventNotificationC\n                     .emailRecipients(ImmutableSet.of())\n                     .userRecipients(ImmutableSet.of())\n                     .bodyTemplate(DEFAULT_BODY_TEMPLATE)\n-                    .htmlBodyTemplate(DEFAULT_HTML_BODY_TEMPLATE);\n+                    .htmlBodyTemplate(\"\");\n         }\n \n         @JsonProperty(FIELD_SENDER)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTgxNjA3OQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/9790#discussion_r551816079", "bodyText": "I think we should respect that user's wish and not fill in the default body if that is left empty.\n(see next comment on how I would handle this)", "author": "mpfz0r", "createdAt": "2021-01-05T09:34:31Z", "path": "graylog2-server/src/main/java/org/graylog/events/notifications/types/EmailSender.java", "diffHunk": "@@ -104,6 +103,21 @@ private String buildBody(EmailEventNotificationConfig config, Map<String, Object\n         return this.templateEngine.transform(template, model);\n     }\n \n+    @VisibleForTesting\n+    private String buildHtmlBody(EmailEventNotificationConfig config, Map<String, Object> model) {\n+        final String template;\n+        if (isNullOrEmpty(config.htmlBodyTemplate())) {", "originalCommit": "1507fc14e23380fe6f07ada0d949df8fe9c9499f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "cd59eddfa5b9e0e152fb5f717e121d880c39e344", "chunk": "diff --git a/graylog2-server/src/main/java/org/graylog/events/notifications/types/EmailSender.java b/graylog2-server/src/main/java/org/graylog/events/notifications/types/EmailSender.java\nindex 1ab0614def..b3357019c9 100644\n--- a/graylog2-server/src/main/java/org/graylog/events/notifications/types/EmailSender.java\n+++ b/graylog2-server/src/main/java/org/graylog/events/notifications/types/EmailSender.java\n\n@@ -105,13 +105,7 @@ public class EmailSender {\n \n     @VisibleForTesting\n     private String buildHtmlBody(EmailEventNotificationConfig config, Map<String, Object> model) {\n-        final String template;\n-        if (isNullOrEmpty(config.htmlBodyTemplate())) {\n-            template = formatHtmlBody(EmailEventNotificationConfig.DEFAULT_HTML_BODY_TEMPLATE);\n-        } else {\n-            template = formatHtmlBody(config.htmlBodyTemplate());\n-        }\n-        return this.templateEngine.transform(template, model);\n+        return this.templateEngine.transform(config.htmlBodyTemplate(), model);\n     }\n \n     private String formatHtmlBody(String bodyContent) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTgxNjQxOA==", "url": "https://github.com/Graylog2/graylog2-server/pull/9790#discussion_r551816418", "bodyText": "How about we keep using SimpleEmail if the html body is empty?", "author": "mpfz0r", "createdAt": "2021-01-05T09:35:07Z", "path": "graylog2-server/src/main/java/org/graylog/events/notifications/types/EmailSender.java", "diffHunk": "@@ -115,7 +129,7 @@ private void sendEmail(EmailEventNotificationConfig config, String emailAddress,\n             throw new TransportConfigurationException(\"Email transport is not enabled in server configuration file!\");\n         }\n \n-        final Email email = new SimpleEmail();\n+        final HtmlEmail email = new HtmlEmail();", "originalCommit": "1507fc14e23380fe6f07ada0d949df8fe9c9499f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a3d20f6daa1acfdb10dc8aaf58d0c71d54feb51c", "chunk": "diff --git a/graylog2-server/src/main/java/org/graylog/events/notifications/types/EmailSender.java b/graylog2-server/src/main/java/org/graylog/events/notifications/types/EmailSender.java\nindex 1ab0614def..d8aeb5c564 100644\n--- a/graylog2-server/src/main/java/org/graylog/events/notifications/types/EmailSender.java\n+++ b/graylog2-server/src/main/java/org/graylog/events/notifications/types/EmailSender.java\n\n@@ -129,7 +125,7 @@ public class EmailSender {\n             throw new TransportConfigurationException(\"Email transport is not enabled in server configuration file!\");\n         }\n \n-        final HtmlEmail email = new HtmlEmail();\n+        final Email email = createEmailWithBody(config, model);\n         email.setCharset(EmailConstants.UTF_8);\n \n         if (isNullOrEmpty(emailConfig.getHostname())) {\n"}}, {"oid": "cd59eddfa5b9e0e152fb5f717e121d880c39e344", "url": "https://github.com/Graylog2/graylog2-server/commit/cd59eddfa5b9e0e152fb5f717e121d880c39e344", "message": "Default html body as empty string", "committedDate": "2021-01-05T10:59:53Z", "type": "commit"}, {"oid": "a3d20f6daa1acfdb10dc8aaf58d0c71d54feb51c", "url": "https://github.com/Graylog2/graylog2-server/commit/a3d20f6daa1acfdb10dc8aaf58d0c71d54feb51c", "message": "Send only HtmlEmail when needed", "committedDate": "2021-01-05T10:59:53Z", "type": "commit"}, {"oid": "3b4bff27b56998bb508246cae25f33f5ba7cdc4b", "url": "https://github.com/Graylog2/graylog2-server/commit/3b4bff27b56998bb508246cae25f33f5ba7cdc4b", "message": "Restore default html body for new notifications", "committedDate": "2021-01-05T13:35:59Z", "type": "commit"}]}