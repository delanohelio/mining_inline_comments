{"pr_number": 8682, "pr_title": "Making LDAP TLS/SSL tests faster and more reliable.", "pr_createdAt": "2020-08-03T14:11:20Z", "pr_url": "https://github.com/Graylog2/graylog2-server/pull/8682", "timeline": [{"oid": "11c2fc17f095f6c223652bf9b9e126987d545ac6", "url": "https://github.com/Graylog2/graylog2-server/commit/11c2fc17f095f6c223652bf9b9e126987d545ac6", "message": "Making LDAP TLS/SSL tests faster and more reliable.\n\nThis change is doing two things for the LDAP authenticator SSL/TLS tests:\n\n1.) Making them more reliable\n  Before this change, running the complete test class worked, but\n  running individual tests could result in test failures. This is related\n  to different exception classes being thrown, depending on if a\n  connection was attempted before or not. The real root cause for this is\n  unknown. The exceptions are thrown in two different places:\n    - When writing the initial packet (`InvalidConnectionException`), or\n    - When parsing the response (`LdapProtocolErrorException`)\n\n  As I was unable to find out the underlying cause, the assertions for\n  failed connections were relaxed. Instead of checking for the exact\n  exception class, we are now checking if an exception was thrown at all.\n  Together with the positive cases (connection works -> no exception is\n  thrown), this should still provide a reliable test coverage.\n\n2.) Making them faster\n  Before this change, the container was started/stopped for each test\n  (method). This change is now starting the container once for the\n  complete class, reducing runtime significantly (on my machine from 14.895s\n  down to 1.114s).", "committedDate": "2020-08-03T14:09:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDQ2NjI0OQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/8682#discussion_r464466249", "bodyText": "How about doing this as a try-with-resource?\nThat ensures cleanup even if we hit an exception\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    final LdapNetworkConnection connection = ldapConnector.connect(request);\n          \n          \n            \n                    assertThat(connection.isAuthenticated()).isTrue();\n          \n          \n            \n                    assertThat(connection.isConnected()).isTrue();\n          \n          \n            \n                    assertThat(connection.isSecured()).isTrue();\n          \n          \n            \n            \n          \n          \n            \n                    connection.close();\n          \n          \n            \n                    try (final LdapNetworkConnection connection = ldapConnector.connect(request)) {\n          \n          \n            \n                        assertThat(connection.isAuthenticated()).isTrue();\n          \n          \n            \n                        assertThat(connection.isConnected()).isTrue();\n          \n          \n            \n                        assertThat(connection.isSecured()).isTrue();\n          \n          \n            \n                    }", "author": "mpfz0r", "createdAt": "2020-08-03T14:54:10Z", "path": "graylog2-server/src/test/java/org/graylog2/security/ldap/LdapConnectorSSLTLSIT.java", "diffHunk": "@@ -194,11 +188,17 @@ private LdapTestConfigRequest createRequest(URI uri, boolean startTls, boolean t\n         );\n     }\n \n-    private void assertConnectionSuccess(LdapTestConfigRequest request) throws KeyStoreException, LdapException, NoSuchAlgorithmException {\n+    private void assertConnectionFailure(LdapTestConfigRequest request) {\n+        Assertions.assertThatThrownBy(() -> ldapConnector.connect(request)).isNotNull();\n+    }\n+\n+    private void assertConnectionSuccess(LdapTestConfigRequest request) throws KeyStoreException, LdapException, NoSuchAlgorithmException, IOException {\n         final LdapNetworkConnection connection = ldapConnector.connect(request);\n         assertThat(connection.isAuthenticated()).isTrue();\n         assertThat(connection.isConnected()).isTrue();\n         assertThat(connection.isSecured()).isTrue();\n+\n+        connection.close();", "originalCommit": "11c2fc17f095f6c223652bf9b9e126987d545ac6", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f2899be486adcbabd96e08d4db766ca5e8bead59", "chunk": "diff --git a/graylog2-server/src/test/java/org/graylog2/security/ldap/LdapConnectorSSLTLSIT.java b/graylog2-server/src/test/java/org/graylog2/security/ldap/LdapConnectorSSLTLSIT.java\nindex 9de2818d80..92147863a4 100644\n--- a/graylog2-server/src/test/java/org/graylog2/security/ldap/LdapConnectorSSLTLSIT.java\n+++ b/graylog2-server/src/test/java/org/graylog2/security/ldap/LdapConnectorSSLTLSIT.java\n\n@@ -193,12 +193,11 @@ public class LdapConnectorSSLTLSIT {\n     }\n \n     private void assertConnectionSuccess(LdapTestConfigRequest request) throws KeyStoreException, LdapException, NoSuchAlgorithmException, IOException {\n-        final LdapNetworkConnection connection = ldapConnector.connect(request);\n-        assertThat(connection.isAuthenticated()).isTrue();\n-        assertThat(connection.isConnected()).isTrue();\n-        assertThat(connection.isSecured()).isTrue();\n-\n-        connection.close();\n+        try (final LdapNetworkConnection connection = ldapConnector.connect(request)) {\n+            assertThat(connection.isAuthenticated()).isTrue();\n+            assertThat(connection.isConnected()).isTrue();\n+            assertThat(connection.isSecured()).isTrue();\n+        }\n     }\n \n     private void mockTrustManagerWithSystemKeystore() throws KeyStoreException, NoSuchAlgorithmException {\n"}}, {"oid": "f2899be486adcbabd96e08d4db766ca5e8bead59", "url": "https://github.com/Graylog2/graylog2-server/commit/f2899be486adcbabd96e08d4db766ca5e8bead59", "message": "Using try-with-resource for connection handling.\n\nCo-authored-by: Marco Pfatschbacher <marco@graylog.com>", "committedDate": "2020-08-04T08:00:09Z", "type": "commit"}]}