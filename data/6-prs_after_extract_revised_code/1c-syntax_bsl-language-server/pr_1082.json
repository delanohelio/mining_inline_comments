{"pr_number": 1082, "pr_title": "WIP:\u0423\u0441\u043a\u043e\u0440\u0435\u043d\u0438\u0435 InvalidCharacterInFileDiagnostic", "pr_createdAt": "2020-04-16T19:39:54Z", "pr_url": "https://github.com/1c-syntax/bsl-language-server/pull/1082", "timeline": [{"oid": "0dc1f3a85b9b8f9611318c381c617633b254faf7", "url": "https://github.com/1c-syntax/bsl-language-server/commit/0dc1f3a85b9b8f9611318c381c617633b254faf7", "message": "\u043f\u0440\u0430\u0432\u0438\u043b\u043e \u0443\u0441\u043a\u043e\u0440\u0435\u043d\u043e\n\n\u0440\u0435\u0441\u0443\u0440\u0441\u044b \u0432\u044b\u043d\u0435\u0441\u0435\u043d\u044b \u0432 \u043f\u043e\u043b\u044f \u043a\u043b\u0430\u0441\u0441\u0430\n\u0443\u0431\u0440\u0430\u043d \u0434\u0432\u043e\u0439\u043d\u043e\u0439 \u043f\u0440\u043e\u0433\u043e\u043d \u043f\u043e \u0441\u043f\u0438\u0441\u043a\u0443 \u0442\u043e\u043a\u0435\u043d\u043e\u0432\n\u0443\u0441\u043b\u043e\u0432\u0438\u044f \u0444\u0438\u043b\u044c\u0442\u0440\u0430 \u043e\u043f\u0442\u0438\u043c\u0438\u0437\u0438\u0440\u043e\u0432\u0430\u043d\u044b", "committedDate": "2020-04-16T19:35:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgwOTI1OA==", "url": "https://github.com/1c-syntax/bsl-language-server/pull/1082#discussion_r409809258", "bodyText": "LINE_COMMENT \u0432 HIDDEN  \u043a\u0430\u043d\u0430\u043b\u0435", "author": "asosnoviy", "createdAt": "2020-04-16T19:50:24Z", "path": "src/main/java/com/github/_1c_syntax/bsl/languageserver/diagnostics/InvalidCharacterInFileDiagnostic.java", "diffHunk": "@@ -69,31 +71,36 @@\n       \"])\",\n     Pattern.CASE_INSENSITIVE | Pattern.UNICODE_CASE);\n \n+  private final String diagnosticMessageDash;\n+  private final String diagnosticMessageSpace;\n+\n   public InvalidCharacterInFileDiagnostic(DiagnosticInfo info) {\n     super(info);\n+    diagnosticMessageDash = info.getResourceString(\"diagnosticMessageDash\");\n+    diagnosticMessageSpace = info.getResourceString(\"diagnosticMessageSpace\");\n   }\n \n   @Override\n   public ParseTree visitFile(BSLParser.FileContext ctx) {\n-    documentContext\n-      .getTokens()\n-      .stream()\n-      .filter((Token token) -> ILLEGAL_DASH_PATTERN.matcher(token.getText()).find())\n-      .forEach(token ->\n-        diagnosticStorage.addDiagnostic(\n-          token,\n-          info.getResourceString(\"diagnosticMessageDash\"))\n-      );\n \n     documentContext\n       .getTokens()\n       .stream()\n-      .filter((Token token) -> ILLEGAL_SPACE_PATTERN.matcher(token.getText()).find())\n+      .filter((Token token) -> token.getChannel() == Lexer.HIDDEN || token.getType() == BSLLexer.STRING\n+          || token.getType() == BSLLexer.LINE_COMMENT)", "originalCommit": "0dc1f3a85b9b8f9611318c381c617633b254faf7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDA5ODU1OQ==", "url": "https://github.com/1c-syntax/bsl-language-server/pull/1082#discussion_r410098559", "bodyText": "\u0430\u0433\u0430, \u043f\u0440\u043e\u043f\u0443\u0441\u0442\u0438\u043b. \u0438\u0441\u043f\u0440\u0430\u0432\u0438\u043b", "author": "artbear", "createdAt": "2020-04-17T09:17:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgwOTI1OA=="}], "type": "inlineReview", "revised_code": {"commit": "05d0d9872ca11749ede8e3c7c964573bcf6d8c68", "chunk": "diff --git a/src/main/java/com/github/_1c_syntax/bsl/languageserver/diagnostics/InvalidCharacterInFileDiagnostic.java b/src/main/java/com/github/_1c_syntax/bsl/languageserver/diagnostics/InvalidCharacterInFileDiagnostic.java\nindex a0e68601c..e6f4b64e5 100644\n--- a/src/main/java/com/github/_1c_syntax/bsl/languageserver/diagnostics/InvalidCharacterInFileDiagnostic.java\n+++ b/src/main/java/com/github/_1c_syntax/bsl/languageserver/diagnostics/InvalidCharacterInFileDiagnostic.java\n\n@@ -86,8 +86,7 @@ public class InvalidCharacterInFileDiagnostic extends AbstractVisitorDiagnostic\n     documentContext\n       .getTokens()\n       .stream()\n-      .filter((Token token) -> token.getChannel() == Lexer.HIDDEN || token.getType() == BSLLexer.STRING\n-          || token.getType() == BSLLexer.LINE_COMMENT)\n+      .filter((Token token) -> token.getChannel() == Lexer.HIDDEN || token.getType() == BSLLexer.STRING)\n       .forEach(token ->\n         {\n           var text = token.getText();\n"}}, {"oid": "05d0d9872ca11749ede8e3c7c964573bcf6d8c68", "url": "https://github.com/1c-syntax/bsl-language-server/commit/05d0d9872ca11749ede8e3c7c964573bcf6d8c68", "message": "\u0443\u0434\u0430\u043b\u0435\u043d\u0430 \u043d\u0435\u043d\u0443\u0436\u043d\u0430\u044f \u043f\u0440\u043e\u0432\u0435\u0440\u043a\u0430 \u043a\u043e\u043c\u043c\u0435\u043d\u0442\u0430\u0440\u0438\u0435\u0432", "committedDate": "2020-04-17T09:16:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDExNDMzMA==", "url": "https://github.com/1c-syntax/bsl-language-server/pull/1082#discussion_r410114330", "bodyText": "STRING \u043d\u0435 \u043e\u0434\u0438\u043d\u043e\u043a", "author": "asosnoviy", "createdAt": "2020-04-17T09:46:04Z", "path": "src/main/java/com/github/_1c_syntax/bsl/languageserver/diagnostics/InvalidCharacterInFileDiagnostic.java", "diffHunk": "@@ -69,31 +71,35 @@\n       \"])\",\n     Pattern.CASE_INSENSITIVE | Pattern.UNICODE_CASE);\n \n+  private final String diagnosticMessageDash;\n+  private final String diagnosticMessageSpace;\n+\n   public InvalidCharacterInFileDiagnostic(DiagnosticInfo info) {\n     super(info);\n+    diagnosticMessageDash = info.getResourceString(\"diagnosticMessageDash\");\n+    diagnosticMessageSpace = info.getResourceString(\"diagnosticMessageSpace\");\n   }\n \n   @Override\n   public ParseTree visitFile(BSLParser.FileContext ctx) {\n-    documentContext\n-      .getTokens()\n-      .stream()\n-      .filter((Token token) -> ILLEGAL_DASH_PATTERN.matcher(token.getText()).find())\n-      .forEach(token ->\n-        diagnosticStorage.addDiagnostic(\n-          token,\n-          info.getResourceString(\"diagnosticMessageDash\"))\n-      );\n \n     documentContext\n       .getTokens()\n       .stream()\n-      .filter((Token token) -> ILLEGAL_SPACE_PATTERN.matcher(token.getText()).find())\n+      .filter((Token token) -> token.getChannel() == Lexer.HIDDEN || token.getType() == BSLLexer.STRING)", "originalCommit": "05d0d9872ca11749ede8e3c7c964573bcf6d8c68", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDE5MjY3Ng==", "url": "https://github.com/1c-syntax/bsl-language-server/pull/1082#discussion_r410192676", "bodyText": "\u0436\u0435\u0441\u0442\u044c. \u043f\u043e\u0441\u043c\u043e\u0442\u0440\u044e", "author": "artbear", "createdAt": "2020-04-17T12:35:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDExNDMzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDczMjA3NA==", "url": "https://github.com/1c-syntax/bsl-language-server/pull/1082#discussion_r410732074", "bodyText": "\u041c\u043d\u043e\u0433\u043e\u0441\u0442\u0440\u043e\u0447\u043d\u0430\u044f \u0441\u0442\u0440\u043e\u043a\u0430 \u0432\u0441\u0435 \u0435\u0449\u0435 \u043d\u0435 \u043e\u0442\u0440\u0430\u0431\u0430\u0442\u044b\u0432\u0430\u0435\u0442\u0441\u044f?", "author": "asosnoviy", "createdAt": "2020-04-18T18:20:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDExNDMzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDczNzQ2Nw==", "url": "https://github.com/1c-syntax/bsl-language-server/pull/1082#discussion_r410737467", "bodyText": "\u0441\u0434\u0435\u043b\u0430\u043d\u043e. \u043c\u0443\u043b\u044c\u0442\u0438-\u0441\u0442\u0440\u043e\u043a\u0438 \u0442\u0430\u043a\u0436\u0435 \u0443\u0447\u0438\u0442\u044b\u0432\u0430\u044e\u0442\u0441\u044f.", "author": "artbear", "createdAt": "2020-04-18T19:03:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDExNDMzMA=="}], "type": "inlineReview", "revised_code": {"commit": "becd88b7484f30469a05570b1ad26fde55386d9a", "chunk": "diff --git a/src/main/java/com/github/_1c_syntax/bsl/languageserver/diagnostics/InvalidCharacterInFileDiagnostic.java b/src/main/java/com/github/_1c_syntax/bsl/languageserver/diagnostics/InvalidCharacterInFileDiagnostic.java\nindex e6f4b64e5..ad0490e69 100644\n--- a/src/main/java/com/github/_1c_syntax/bsl/languageserver/diagnostics/InvalidCharacterInFileDiagnostic.java\n+++ b/src/main/java/com/github/_1c_syntax/bsl/languageserver/diagnostics/InvalidCharacterInFileDiagnostic.java\n\n@@ -56,20 +56,23 @@ import java.util.regex.Pattern;\n \n public class InvalidCharacterInFileDiagnostic extends AbstractVisitorDiagnostic implements QuickFixProvider {\n \n-  private static final Pattern ILLEGAL_DASH_PATTERN = Pattern.compile(\"([\" +\n+  public static final String SPACE_REGEX = \"(?:\" +\n+    \"\\\\u00A0\" + // 160\n+    \")\";\n+\n+  private static final Pattern ILLEGAL_PATTERN = Pattern.compile(\"(?:[\" +\n       \"\\\\u00AD\" + // 173\n       \"\\\\u2012\" + // 8210\n       \"\\\\u2013\" + // 8211\n       \"\\\\u2014\" + // 8212\n       \"\\\\u2015\" + // 8213\n       \"\\\\u2212\" + // 8722\n-      \"])\",\n-    Pattern.CASE_INSENSITIVE | Pattern.UNICODE_CASE);\n+      \"])\" +\n+      \"|\" + SPACE_REGEX,\n+    Pattern.UNICODE_CASE);\n \n-  private static final Pattern ILLEGAL_SPACE_PATTERN = Pattern.compile(\"([\" +\n-      \"\\\\u00A0\" + // 160\n-      \"])\",\n-    Pattern.CASE_INSENSITIVE | Pattern.UNICODE_CASE);\n+  private static final Pattern ILLEGAL_SPACE_PATTERN = Pattern.compile(SPACE_REGEX,\n+    Pattern.UNICODE_CASE);\n \n   private final String diagnosticMessageDash;\n   private final String diagnosticMessageSpace;\n"}}, {"oid": "a979374fa0660a1f4ef71364b5a46229b0811d6e", "url": "https://github.com/1c-syntax/bsl-language-server/commit/a979374fa0660a1f4ef71364b5a46229b0811d6e", "message": "Merge branch 'develop' into InvalidCharacterInFileDiagnostic-fix", "committedDate": "2020-04-18T12:34:53Z", "type": "commit"}, {"oid": "becd88b7484f30469a05570b1ad26fde55386d9a", "url": "https://github.com/1c-syntax/bsl-language-server/commit/becd88b7484f30469a05570b1ad26fde55386d9a", "message": "\u0423\u0441\u043a\u043e\u0440\u0435\u043d\u0438\u0435 - \u0412\u043c\u0435\u0441\u0442\u043e 2\u0445 \u0432\u0430\u043b\u0438\u0434\u0430\u0446\u0438\u0439 \u0432\u044b\u043f\u043e\u043b\u043d\u044f\u044e \u043e\u0434\u043d\u0443 \u043e\u0431\u0449\u0443\u044e \u0432\u0430\u043b\u0438\u0434\u0430\u0446\u0438\u044e", "committedDate": "2020-04-18T16:58:40Z", "type": "commit"}, {"oid": "28eaa364f9a7650f758543c19b0ff2474b34c211", "url": "https://github.com/1c-syntax/bsl-language-server/commit/28eaa364f9a7650f758543c19b0ff2474b34c211", "message": "\u0443\u0447\u0435\u0442 \u043c\u0443\u043b\u044c\u0442\u0438\u0441\u0442\u0440\u043e\u0447\u043d\u044b\u0445 \u0441\u0442\u0440\u043e\u043a", "committedDate": "2020-04-18T19:03:01Z", "type": "commit"}]}