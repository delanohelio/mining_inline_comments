{"pr_number": 506, "pr_title": "[Offline sync] Allow user to specify connection type for sync", "pr_createdAt": "2020-06-29T08:55:21Z", "pr_url": "https://github.com/google/ground-android/pull/506", "timeline": [{"oid": "8907061db997d7ef4b5448b83ff147338a51a506", "url": "https://github.com/google/ground-android/commit/8907061db997d7ef4b5448b83ff147338a51a506", "message": "Add shared pref filename and mode to Config.java", "committedDate": "2020-06-29T07:47:00Z", "type": "commit"}, {"oid": "e61286cd454cdeeec5e2005c95a910bc778b744a", "url": "https://github.com/google/ground-android/commit/e61286cd454cdeeec5e2005c95a910bc778b744a", "message": "Use the same config in SettingsFragment\n\n - This makes all shared prefs stored via SettingsFragment accessible through LocalValueStore across the application.", "committedDate": "2020-06-29T07:49:12Z", "type": "commit"}, {"oid": "f8209b4e8e12e9372b46a6fd5938ee0a0637fed5", "url": "https://github.com/google/ground-android/commit/f8209b4e8e12e9372b46a6fd5938ee0a0637fed5", "message": "Add getter for the network constraint in LocalValueStore", "committedDate": "2020-06-29T07:50:05Z", "type": "commit"}, {"oid": "d1fee618898090158e3099584bdf4803e61fe7b1", "url": "https://github.com/google/ground-android/commit/d1fee618898090158e3099584bdf4803e61fe7b1", "message": "Create BaseWorkManager and add template for requests/constraints", "committedDate": "2020-06-29T08:43:45Z", "type": "commit"}, {"oid": "18e8d179ecea3e4761ed9389bfb2d44f47b593b8", "url": "https://github.com/google/ground-android/commit/18e8d179ecea3e4761ed9389bfb2d44f47b593b8", "message": "Refactor child WorkManager classes\n\n - Simplify by removing duplicate code\n - If no custom config is needed, then use base template. Otherwise, override appropriate methods", "committedDate": "2020-06-29T08:46:48Z", "type": "commit"}, {"oid": "ab4ff14bd8c4ed1324dc7e2a92780862ec081f81", "url": "https://github.com/google/ground-android/commit/ab4ff14bd8c4ed1324dc7e2a92780862ec081f81", "message": "Remove obsolete toast message", "committedDate": "2020-06-29T08:53:42Z", "type": "commit"}, {"oid": "880c2a9c4aebb076f4d26b8b7313a79979a61770", "url": "https://github.com/google/ground-android/commit/880c2a9c4aebb076f4d26b8b7313a79979a61770", "message": "Fix typo", "committedDate": "2020-06-29T09:02:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njg5ODQ4Ng==", "url": "https://github.com/google/ground-android/pull/506#discussion_r446898486", "bodyText": "We might want to change this to shouldUploadMediaOverUnmeteredConnectionOnly. Whilst most Wi-Fi connections are unmetered some are not (hotspot tethering, airport Wi-Fi), also with 5G there are some mobile connections which are unmetered.\nMy point being: we're presumably trying to avoid the user being charged for data rather than simply letting them choose a specific network protocol.", "author": "dturner", "createdAt": "2020-06-29T11:29:21Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/local/LocalValueStore.java", "diffHunk": "@@ -46,17 +47,19 @@ public String getLastActiveProjectId() {\n \n   /** Set the id of the last project successfully activated by the user. */\n   public void setLastActiveProjectId(@NonNull String id) {\n-    preferences\n-      .edit()\n-      .putString(ACTIVE_PROJECT_ID_KEY, id)\n-      .apply();\n+    preferences.edit().putString(ACTIVE_PROJECT_ID_KEY, id).apply();\n   }\n \n   /** Removes the last active project id in the local value store. */\n   public void clearLastActiveProjectId() {\n-    preferences\n-      .edit()\n-      .remove(ACTIVE_PROJECT_ID_KEY)\n-      .apply();\n+    preferences.edit().remove(ACTIVE_PROJECT_ID_KEY).apply();\n+  }\n+\n+  public boolean shouldUploadMediaOverWifiOnly() {", "originalCommit": "880c2a9c4aebb076f4d26b8b7313a79979a61770", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk4MTc3OQ==", "url": "https://github.com/google/ground-android/pull/506#discussion_r446981779", "bodyText": "Thanks for pointing that out. So does that mean I should update the label in the settings as well?", "author": "shobhitagarwal1612", "createdAt": "2020-06-29T13:43:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njg5ODQ4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzAzNzQ3Nw==", "url": "https://github.com/google/ground-android/pull/506#discussion_r447037477", "bodyText": "Good catch, @dturner. Google Photos and other apps still prompt the user to \"Wait for Wi-Fi\" rather than \"Wait for Unmetered connection\". The latter is harder to explain to beginner users - @sergeydolgov1 do you think we should use \"Wi-Fi\" as a proxy for \"Unmetered Network\" in the UIs, even though it's not really 100% correct?", "author": "gino-m", "createdAt": "2020-06-29T14:59:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njg5ODQ4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTM5MDY4Ng==", "url": "https://github.com/google/ground-android/pull/506#discussion_r449390686", "bodyText": "@gino-m Suggest that we use \"Wi-Fi\" as a proxy for Unmetered Network as Wi-Fi is usually the way people use the Internet free of charge. Also, FYI -- this is Android developer documentation, they also use \"Wi-Fi\" terminology: https://developer.android.com/training/basics/network-ops/managing", "author": "sergeydolgov1", "createdAt": "2020-07-03T06:00:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njg5ODQ4Ng=="}], "type": "inlineReview", "revised_code": {"commit": "c59ecc908c0ac6157642c10d31c29d1cb7a0be72", "chunk": "diff --git a/gnd/src/main/java/com/google/android/gnd/persistence/local/LocalValueStore.java b/gnd/src/main/java/com/google/android/gnd/persistence/local/LocalValueStore.java\nindex c05f3284..0cbbe8b2 100644\n--- a/gnd/src/main/java/com/google/android/gnd/persistence/local/LocalValueStore.java\n+++ b/gnd/src/main/java/com/google/android/gnd/persistence/local/LocalValueStore.java\n\n@@ -55,11 +55,11 @@ public class LocalValueStore {\n     preferences.edit().remove(ACTIVE_PROJECT_ID_KEY).apply();\n   }\n \n-  public boolean shouldUploadMediaOverWifiOnly() {\n+  public boolean shouldUploadMediaOverUnmeteredConnectionOnly() {\n     return preferences.getBoolean(Keys.UPLOAD_MEDIA, false);\n   }\n \n-  public boolean shouldDownloadOfflineAreasOverWifiOnly() {\n+  public boolean shouldDownloadOfflineAreasOverUnmeteredConnectionOnly() {\n     return preferences.getBoolean(Keys.OFFLINE_AREAS, false);\n   }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njg5ODU3NA==", "url": "https://github.com/google/ground-android/pull/506#discussion_r446898574", "bodyText": "As comment above", "author": "dturner", "createdAt": "2020-06-29T11:29:31Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/local/LocalValueStore.java", "diffHunk": "@@ -46,17 +47,19 @@ public String getLastActiveProjectId() {\n \n   /** Set the id of the last project successfully activated by the user. */\n   public void setLastActiveProjectId(@NonNull String id) {\n-    preferences\n-      .edit()\n-      .putString(ACTIVE_PROJECT_ID_KEY, id)\n-      .apply();\n+    preferences.edit().putString(ACTIVE_PROJECT_ID_KEY, id).apply();\n   }\n \n   /** Removes the last active project id in the local value store. */\n   public void clearLastActiveProjectId() {\n-    preferences\n-      .edit()\n-      .remove(ACTIVE_PROJECT_ID_KEY)\n-      .apply();\n+    preferences.edit().remove(ACTIVE_PROJECT_ID_KEY).apply();\n+  }\n+\n+  public boolean shouldUploadMediaOverWifiOnly() {\n+    return preferences.getBoolean(Keys.UPLOAD_MEDIA, false);\n+  }\n+\n+  public boolean shouldDownloadOfflineAreasOverWifiOnly() {", "originalCommit": "880c2a9c4aebb076f4d26b8b7313a79979a61770", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c59ecc908c0ac6157642c10d31c29d1cb7a0be72", "chunk": "diff --git a/gnd/src/main/java/com/google/android/gnd/persistence/local/LocalValueStore.java b/gnd/src/main/java/com/google/android/gnd/persistence/local/LocalValueStore.java\nindex c05f3284..0cbbe8b2 100644\n--- a/gnd/src/main/java/com/google/android/gnd/persistence/local/LocalValueStore.java\n+++ b/gnd/src/main/java/com/google/android/gnd/persistence/local/LocalValueStore.java\n\n@@ -55,11 +55,11 @@ public class LocalValueStore {\n     preferences.edit().remove(ACTIVE_PROJECT_ID_KEY).apply();\n   }\n \n-  public boolean shouldUploadMediaOverWifiOnly() {\n+  public boolean shouldUploadMediaOverUnmeteredConnectionOnly() {\n     return preferences.getBoolean(Keys.UPLOAD_MEDIA, false);\n   }\n \n-  public boolean shouldDownloadOfflineAreasOverWifiOnly() {\n+  public boolean shouldDownloadOfflineAreasOverUnmeteredConnectionOnly() {\n     return preferences.getBoolean(Keys.OFFLINE_AREAS, false);\n   }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njg5ODg5OQ==", "url": "https://github.com/google/ground-android/pull/506#discussion_r446898899", "bodyText": "Out of interest, what caused this to become public?", "author": "dturner", "createdAt": "2020-06-29T11:30:05Z", "path": "gnd/src/main/java/com/google/android/gnd/GndApplicationModule.java", "diffHunk": "@@ -45,8 +45,7 @@\n import javax.inject.Singleton;\n \n @Module(includes = {AndroidSupportInjectionModule.class, ViewModelModule.class})\n-abstract class GndApplicationModule {\n-  private static final String SHARED_PREFERENCES_NAME = \"shared_prefs\";\n+public abstract class GndApplicationModule {", "originalCommit": "880c2a9c4aebb076f4d26b8b7313a79979a61770", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk4MzA1Mw==", "url": "https://github.com/google/ground-android/pull/506#discussion_r446983053", "bodyText": "At first, I reused the same variable SHARED_PREFERENCES_NAME in the SettingsFragment, but then moved it Config.java. So this can be reverted back now. Nice catch!", "author": "shobhitagarwal1612", "createdAt": "2020-06-29T13:45:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njg5ODg5OQ=="}], "type": "inlineReview", "revised_code": {"commit": "d5eea20685f4c0c3f3d576a3f17b5f8ba43ac7b0", "chunk": "diff --git a/gnd/src/main/java/com/google/android/gnd/GndApplicationModule.java b/gnd/src/main/java/com/google/android/gnd/GndApplicationModule.java\nindex e5121560..e836340c 100644\n--- a/gnd/src/main/java/com/google/android/gnd/GndApplicationModule.java\n+++ b/gnd/src/main/java/com/google/android/gnd/GndApplicationModule.java\n\n@@ -45,7 +45,7 @@ import dagger.android.support.AndroidSupportInjectionModule;\n import javax.inject.Singleton;\n \n @Module(includes = {AndroidSupportInjectionModule.class, ViewModelModule.class})\n-public abstract class GndApplicationModule {\n+abstract class GndApplicationModule {\n \n   /** Causes Dagger Android to generate a sub-component for the MainActivity. */\n   @ActivityScoped\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjkwNDI2NA==", "url": "https://github.com/google/ground-android/pull/506#discussion_r446904264", "bodyText": "Any reason for picking LINEAR backoff? I thought the generally accepted best practice was to use EXPONENTIAL", "author": "dturner", "createdAt": "2020-06-29T11:40:12Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/sync/BaseWorkManager.java", "diffHunk": "@@ -0,0 +1,79 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.persistence.sync;\n+\n+import androidx.annotation.Nullable;\n+import androidx.work.BackoffPolicy;\n+import androidx.work.Constraints;\n+import androidx.work.Data;\n+import androidx.work.NetworkType;\n+import androidx.work.OneTimeWorkRequest;\n+import androidx.work.OneTimeWorkRequest.Builder;\n+import androidx.work.WorkManager;\n+import androidx.work.WorkRequest;\n+import java.util.concurrent.TimeUnit;\n+import javax.inject.Provider;\n+\n+public abstract class BaseWorkManager {\n+\n+  /** Number of milliseconds to wait before retrying failed sync tasks. */\n+  private static final long SYNC_BACKOFF_MILLIS = WorkRequest.MIN_BACKOFF_MILLIS;\n+\n+  /** Any working network connection is required for this work. */\n+  private static final NetworkType DEFAULT_NETWORK_TYPE = NetworkType.CONNECTED;\n+\n+  /**\n+   * WorkManager is injected via {@code Provider} rather than directly to ensure the {@code\n+   * Application} has a change to initialize it before {@code WorkManager.getInstance()} is called.\n+   */\n+  private final Provider<WorkManager> workManagerProvider;\n+\n+  public BaseWorkManager(Provider<WorkManager> workManagerProvider) {\n+    this.workManagerProvider = workManagerProvider;\n+  }\n+\n+  protected WorkManager getWorkManager() {\n+    return workManagerProvider.get().getInstance();\n+  }\n+\n+  protected Constraints getWorkerConstraints() {\n+    return new Constraints.Builder().setRequiredNetworkType(preferredNetworkType()).build();\n+  }\n+\n+  /**\n+   * Override this method if the worker requires a stable internet connection for large file\n+   * upload/download. By default, the worker just needs access to internet connection.\n+   */\n+  protected NetworkType preferredNetworkType() {\n+    return DEFAULT_NETWORK_TYPE;\n+  }\n+\n+  abstract Class<? extends BaseWorker> getWorkerClass();\n+\n+  protected OneTimeWorkRequest buildWorkerRequest(@Nullable Data inputData) {\n+    Builder builder =\n+        new Builder(getWorkerClass())\n+            .setConstraints(getWorkerConstraints())\n+            .setBackoffCriteria(BackoffPolicy.LINEAR, SYNC_BACKOFF_MILLIS, TimeUnit.MILLISECONDS);", "originalCommit": "880c2a9c4aebb076f4d26b8b7313a79979a61770", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk4NTcwNQ==", "url": "https://github.com/google/ground-android/pull/506#discussion_r446985705", "bodyText": "This is the current backoff criteria being used in DataSyncWorkManager. I just pulled it out and moved to BaseWorkerManager so we can apply a common template to all of our *WorkManager and move boiler-plate code to this base class.\nBut I do agree EXPONENTIAL seems to be the best practice. @gino-m Could you please provide some background why it LINEAR was set as the default choice?", "author": "shobhitagarwal1612", "createdAt": "2020-06-29T13:49:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjkwNDI2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzAzOTg5OQ==", "url": "https://github.com/google/ground-android/pull/506#discussion_r447039899", "bodyText": "I don't remember for certain, but it might have been an attempt to compensate for the fact that gRPC can take awhile to wake up after a connection becomes available.\nHow does backoff interact with the required network type? i.e. is the worker expected to start ASAP after the required network is available, regardless of backoff?", "author": "gino-m", "createdAt": "2020-06-29T15:02:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjkwNDI2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQ3OTIxMw==", "url": "https://github.com/google/ground-android/pull/506#discussion_r447479213", "bodyText": "It will check for the constraint only after the required amount of time has passed based of last backoff delay. Only then it will start.", "author": "shobhitagarwal1612", "createdAt": "2020-06-30T07:46:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjkwNDI2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzczNTUxNw==", "url": "https://github.com/google/ground-android/pull/506#discussion_r447735517", "bodyText": "Is there no way to wake up the worker as soon as the connection becomes available? (@dturner?).  If not, perhaps LINEAR is a safer bet? As it's currently defined, retries will only occur at 10 sec, then 100 sec, and 1000 sec?", "author": "gino-m", "createdAt": "2020-06-30T14:38:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjkwNDI2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODczODk2OA==", "url": "https://github.com/google/ground-android/pull/506#discussion_r448738968", "bodyText": "Reverted back to LINEAR", "author": "shobhitagarwal1612", "createdAt": "2020-07-02T04:16:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjkwNDI2NA=="}], "type": "inlineReview", "revised_code": {"commit": "c86e9c476e2eac5aeb7c9e5a88e378f8ac094104", "chunk": "diff --git a/gnd/src/main/java/com/google/android/gnd/persistence/sync/BaseWorkManager.java b/gnd/src/main/java/com/google/android/gnd/persistence/sync/BaseWorkManager.java\nindex d2c4dc4d..4aca5f86 100644\n--- a/gnd/src/main/java/com/google/android/gnd/persistence/sync/BaseWorkManager.java\n+++ b/gnd/src/main/java/com/google/android/gnd/persistence/sync/BaseWorkManager.java\n\n@@ -28,10 +28,22 @@ import androidx.work.WorkRequest;\n import java.util.concurrent.TimeUnit;\n import javax.inject.Provider;\n \n+/**\n+ * Base class for creating a work manager for scheduling background tasks.\n+ *\n+ * <p>By default, the only constraint is availability of any type of internet connection as it is\n+ * assumed that all background tasks need at-least some sort of connectivity.\n+ *\n+ * <p>In case of when the required criteria is not met, the next attempt uses EXPONENTIAL backoff\n+ * policy with a backoff delay of 10 seconds.\n+ */\n public abstract class BaseWorkManager {\n \n+  /** Backoff time should increase exponentially. */\n+  private static final BackoffPolicy BACKOFF_POLICY = BackoffPolicy.EXPONENTIAL;\n+\n   /** Number of milliseconds to wait before retrying failed sync tasks. */\n-  private static final long SYNC_BACKOFF_MILLIS = WorkRequest.MIN_BACKOFF_MILLIS;\n+  private static final long BACKOFF_DELAY_MILLIS = WorkRequest.MIN_BACKOFF_MILLIS;\n \n   /** Any working network connection is required for this work. */\n   private static final NetworkType DEFAULT_NETWORK_TYPE = NetworkType.CONNECTED;\n"}}, {"oid": "c59ecc908c0ac6157642c10d31c29d1cb7a0be72", "url": "https://github.com/google/ground-android/commit/c59ecc908c0ac6157642c10d31c29d1cb7a0be72", "message": "Use unmetered instead of WiFi", "committedDate": "2020-06-29T13:44:19Z", "type": "commit"}, {"oid": "d5eea20685f4c0c3f3d576a3f17b5f8ba43ac7b0", "url": "https://github.com/google/ground-android/commit/d5eea20685f4c0c3f3d576a3f17b5f8ba43ac7b0", "message": "Reduce visibility of GndApplicationModule", "committedDate": "2020-06-29T13:45:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA0MDg2MQ==", "url": "https://github.com/google/ground-android/pull/506#discussion_r447040861", "bodyText": "Please add class JavaDoc with quick summary of what this base class provides.", "author": "gino-m", "createdAt": "2020-06-29T15:03:59Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/sync/BaseWorkManager.java", "diffHunk": "@@ -0,0 +1,79 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.persistence.sync;\n+\n+import androidx.annotation.Nullable;\n+import androidx.work.BackoffPolicy;\n+import androidx.work.Constraints;\n+import androidx.work.Data;\n+import androidx.work.NetworkType;\n+import androidx.work.OneTimeWorkRequest;\n+import androidx.work.OneTimeWorkRequest.Builder;\n+import androidx.work.WorkManager;\n+import androidx.work.WorkRequest;\n+import java.util.concurrent.TimeUnit;\n+import javax.inject.Provider;\n+\n+public abstract class BaseWorkManager {", "originalCommit": "d5eea20685f4c0c3f3d576a3f17b5f8ba43ac7b0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c86e9c476e2eac5aeb7c9e5a88e378f8ac094104", "chunk": "diff --git a/gnd/src/main/java/com/google/android/gnd/persistence/sync/BaseWorkManager.java b/gnd/src/main/java/com/google/android/gnd/persistence/sync/BaseWorkManager.java\nindex d2c4dc4d..4aca5f86 100644\n--- a/gnd/src/main/java/com/google/android/gnd/persistence/sync/BaseWorkManager.java\n+++ b/gnd/src/main/java/com/google/android/gnd/persistence/sync/BaseWorkManager.java\n\n@@ -28,10 +28,22 @@ import androidx.work.WorkRequest;\n import java.util.concurrent.TimeUnit;\n import javax.inject.Provider;\n \n+/**\n+ * Base class for creating a work manager for scheduling background tasks.\n+ *\n+ * <p>By default, the only constraint is availability of any type of internet connection as it is\n+ * assumed that all background tasks need at-least some sort of connectivity.\n+ *\n+ * <p>In case of when the required criteria is not met, the next attempt uses EXPONENTIAL backoff\n+ * policy with a backoff delay of 10 seconds.\n+ */\n public abstract class BaseWorkManager {\n \n+  /** Backoff time should increase exponentially. */\n+  private static final BackoffPolicy BACKOFF_POLICY = BackoffPolicy.EXPONENTIAL;\n+\n   /** Number of milliseconds to wait before retrying failed sync tasks. */\n-  private static final long SYNC_BACKOFF_MILLIS = WorkRequest.MIN_BACKOFF_MILLIS;\n+  private static final long BACKOFF_DELAY_MILLIS = WorkRequest.MIN_BACKOFF_MILLIS;\n \n   /** Any working network connection is required for this work. */\n   private static final NetworkType DEFAULT_NETWORK_TYPE = NetworkType.CONNECTED;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA0MzY0NQ==", "url": "https://github.com/google/ground-android/pull/506#discussion_r447043645", "bodyText": "Consider adding a noargs override of buildWorkerRquest() instead of passing null here with JavaDoc explaining the default behavior with noargs.", "author": "gino-m", "createdAt": "2020-06-29T15:07:44Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/sync/TileDownloadWorkManager.java", "diffHunk": "@@ -16,47 +16,48 @@\n \n package com.google.android.gnd.persistence.sync;\n \n-import androidx.work.Constraints;\n import androidx.work.NetworkType;\n import androidx.work.OneTimeWorkRequest;\n import androidx.work.WorkManager;\n+import com.google.android.gnd.persistence.local.LocalValueStore;\n import io.reactivex.Completable;\n import javax.inject.Inject;\n import javax.inject.Provider;\n \n /** Enqueues file download work to be done in the background. */\n-public class TileDownloadWorkManager {\n-  private static final Constraints CONSTRAINTS =\n-      new Constraints.Builder().setRequiredNetworkType(NetworkType.CONNECTED).build();\n+public class TileDownloadWorkManager extends BaseWorkManager {\n \n-  private final Provider<WorkManager> workManagerProvider;\n+  private final LocalValueStore localValueStore;\n \n   @Inject\n-  public TileDownloadWorkManager(Provider<WorkManager> workManagerProvider) {\n-    this.workManagerProvider = workManagerProvider;\n+  public TileDownloadWorkManager(\n+      Provider<WorkManager> workManagerProvider, LocalValueStore localValueStore) {\n+    super(workManagerProvider);\n+    this.localValueStore = localValueStore;\n+  }\n+\n+  @Override\n+  Class<TileDownloadWorker> getWorkerClass() {\n+    return TileDownloadWorker.class;\n+  }\n+\n+  @Override\n+  protected NetworkType preferredNetworkType() {\n+    return localValueStore.shouldDownloadOfflineAreasOverUnmeteredConnectionOnly()\n+        ? NetworkType.UNMETERED\n+        : NetworkType.CONNECTED;\n   }\n \n   /**\n    * Enqueues a worker that downloads files when a network connection is available, returning a\n-   * completeable upon enqueueing.\n+   * completable upon enqueueing.\n    */\n   public Completable enqueueTileDownloadWorker() {\n     return Completable.fromRunnable(this::enqueueTileDownloadWorkerInternal);\n   }\n \n   private void enqueueTileDownloadWorkerInternal() {\n-    OneTimeWorkRequest request = buildWorkerRequest();\n-\n+    OneTimeWorkRequest request = buildWorkerRequest(null);", "originalCommit": "d5eea20685f4c0c3f3d576a3f17b5f8ba43ac7b0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d05cf07783025de9c8f126f5695cba0b33a5bc3d", "chunk": "diff --git a/gnd/src/main/java/com/google/android/gnd/persistence/sync/TileDownloadWorkManager.java b/gnd/src/main/java/com/google/android/gnd/persistence/sync/TileDownloadWorkManager.java\nindex 0c271b02..7a097d0e 100644\n--- a/gnd/src/main/java/com/google/android/gnd/persistence/sync/TileDownloadWorkManager.java\n+++ b/gnd/src/main/java/com/google/android/gnd/persistence/sync/TileDownloadWorkManager.java\n\n@@ -17,7 +17,6 @@\n package com.google.android.gnd.persistence.sync;\n \n import androidx.work.NetworkType;\n-import androidx.work.OneTimeWorkRequest;\n import androidx.work.WorkManager;\n import com.google.android.gnd.persistence.local.LocalValueStore;\n import io.reactivex.Completable;\n"}}, {"oid": "c86e9c476e2eac5aeb7c9e5a88e378f8ac094104", "url": "https://github.com/google/ground-android/commit/c86e9c476e2eac5aeb7c9e5a88e378f8ac094104", "message": "Add javadoc comments and switch backoff policy to exponential", "committedDate": "2020-06-30T07:47:05Z", "type": "commit"}, {"oid": "d05cf07783025de9c8f126f5695cba0b33a5bc3d", "url": "https://github.com/google/ground-android/commit/d05cf07783025de9c8f126f5695cba0b33a5bc3d", "message": "Create no-arg override of buildWorkerRequest()  and comments", "committedDate": "2020-06-30T08:08:37Z", "type": "commit"}, {"oid": "c4342b677f01d380914062e58b4fa787dc0965f4", "url": "https://github.com/google/ground-android/commit/c4342b677f01d380914062e58b4fa787dc0965f4", "message": "Merge branch 'master' into issue-408", "committedDate": "2020-06-30T14:33:32Z", "type": "commit"}, {"oid": "cb8689879c4cd5262284fb4a4bbcfdc02cab8092", "url": "https://github.com/google/ground-android/commit/cb8689879c4cd5262284fb4a4bbcfdc02cab8092", "message": "Fix typos", "committedDate": "2020-06-30T14:35:43Z", "type": "commit"}, {"oid": "f582a492b6c5905c01cf527b9ce449f1aadc8889", "url": "https://github.com/google/ground-android/commit/f582a492b6c5905c01cf527b9ce449f1aadc8889", "message": "Revert back to LINEAR policy and add a TODO", "committedDate": "2020-06-30T14:52:05Z", "type": "commit"}, {"oid": "1b543afbc915cf34767ec1f2757250cfcb4c5478", "url": "https://github.com/google/ground-android/commit/1b543afbc915cf34767ec1f2757250cfcb4c5478", "message": "Fix styling issues", "committedDate": "2020-06-30T18:21:28Z", "type": "commit"}, {"oid": "fae6a95d170c6e5739a2ecfe4e303c2fc1c073fd", "url": "https://github.com/google/ground-android/commit/fae6a95d170c6e5739a2ecfe4e303c2fc1c073fd", "message": "Merge branch 'master' into issue-408", "committedDate": "2020-06-30T18:22:00Z", "type": "commit"}, {"oid": "17bf90cb80559365c52b20d2d6683ed1d3f21753", "url": "https://github.com/google/ground-android/commit/17bf90cb80559365c52b20d2d6683ed1d3f21753", "message": "Merge branch 'master' into issue-408", "committedDate": "2020-07-01T03:48:37Z", "type": "commit"}, {"oid": "7e937796218ce7854aa75ab6c4e6ac2b686eea33", "url": "https://github.com/google/ground-android/commit/7e937796218ce7854aa75ab6c4e6ac2b686eea33", "message": "Remove unused import", "committedDate": "2020-07-01T09:01:17Z", "type": "commit"}, {"oid": "db18fd4caec1199d0f4b9eb736be8834d018fda5", "url": "https://github.com/google/ground-android/commit/db18fd4caec1199d0f4b9eb736be8834d018fda5", "message": "Merge branch 'master' into issue-408", "committedDate": "2020-07-02T04:15:31Z", "type": "commit"}]}