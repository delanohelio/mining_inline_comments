{"pr_number": 566, "pr_title": "Geocoding Fixes", "pr_createdAt": "2020-08-18T21:53:14Z", "pr_url": "https://github.com/google/ground-android/pull/566", "timeline": [{"oid": "ad0ab46896fcffe02d20058d74bff2c8551b4bd6", "url": "https://github.com/google/ground-android/commit/ad0ab46896fcffe02d20058d74bff2c8551b4bd6", "message": "Add a name field to Offline Areas\n\nSince we need to render human readable names for offline areas, well, offline, we'll extend the model to persist a name. For now, the name will be automatically derived using geocoding, but we may allow users to specify custom area names in the future.", "committedDate": "2020-08-18T21:12:08Z", "type": "commit"}, {"oid": "6ac9ad416e2fedf6b391ee8fa5f7414aadf25bc2", "url": "https://github.com/google/ground-android/commit/6ac9ad416e2fedf6b391ee8fa5f7414aadf25bc2", "message": "Refactor handling of area name geocoding to persist names offline\n\nThis change does a couple of significant things:\n\n- Moves geocoding out of the view model and into the offline area repository in order to persist a reverse geocoded name offline\n- Changes the signature of the geocoder's area name function to work on bounds--necessary because of the prior point, since now we need to reverse geocode and entity while constructing an area.\n- Updates the offline area view model and list adapter to work directly on immutable lists of areas, resolving a duplicate key issue.\n\nIn general the implementation is simpler and now we persist names offline.", "committedDate": "2020-08-18T21:34:49Z", "type": "commit"}, {"oid": "01364f6946e4fd4aafe24bf44be903617ead4eea", "url": "https://github.com/google/ground-android/commit/01364f6946e4fd4aafe24bf44be903617ead4eea", "message": "Update the geocoder to save country+locality names\n\nUntil we have a firmer decision around what address components we should use to name areas, we'll use a simple combination of country + locality, falling back to country only if the locality is not found.", "committedDate": "2020-08-18T21:49:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzEwMDgyNw==", "url": "https://github.com/google/ground-android/pull/566#discussion_r473100827", "bodyText": "Since geocodingManager.getOfflineAreaName(bounds) is an async operation, should it be modeled as a Single<>? If not, the UI might block while waiting for addAreaAndEnqueue() to finish. It might look something like:\nreturn geocodingManager.getOfflineAreaName(bounds)\n    .map(areaName => OfflineArea.newBuilder()....setName(areaName).build())   \n    .flatMapCompletable(this::enqueueTileDownloads);", "author": "gino-m", "createdAt": "2020-08-19T15:05:42Z", "path": "gnd/src/main/java/com/google/android/gnd/repository/OfflineAreaRepository.java", "diffHunk": "@@ -140,11 +144,11 @@ private Completable enqueueTileDownloads(OfflineArea area) {\n \n   public Completable addAreaAndEnqueue(LatLngBounds bounds) {\n     OfflineArea offlineArea =\n-        // TODO: Geocode\n         OfflineArea.newBuilder()\n             .setBounds(bounds)\n             .setId(uuidGenerator.generateUuid())\n             .setState(State.PENDING)\n+            .setName(geocodingManager.getOfflineAreaName(bounds))", "originalCommit": "01364f6946e4fd4aafe24bf44be903617ead4eea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE0NDQ3Nw==", "url": "https://github.com/google/ground-android/pull/566#discussion_r473144477", "bodyText": "Good point! The geocoder docs recommend calling it on a separate thread as well. I'll make the change.", "author": "scolsen", "createdAt": "2020-08-19T16:08:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzEwMDgyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE2MzAyNQ==", "url": "https://github.com/google/ground-android/pull/566#discussion_r473163025", "bodyText": "done! 582b803", "author": "scolsen", "createdAt": "2020-08-19T16:30:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzEwMDgyNw=="}], "type": "inlineReview", "revised_code": {"commit": "582b8039617f77ab406366da735801c199ffa80f", "chunk": "diff --git a/gnd/src/main/java/com/google/android/gnd/repository/OfflineAreaRepository.java b/gnd/src/main/java/com/google/android/gnd/repository/OfflineAreaRepository.java\nindex b88d4e5b..209f54e7 100644\n--- a/gnd/src/main/java/com/google/android/gnd/repository/OfflineAreaRepository.java\n+++ b/gnd/src/main/java/com/google/android/gnd/repository/OfflineAreaRepository.java\n\n@@ -143,15 +143,17 @@ public class OfflineAreaRepository {\n   }\n \n   public Completable addAreaAndEnqueue(LatLngBounds bounds) {\n-    OfflineArea offlineArea =\n-        OfflineArea.newBuilder()\n-            .setBounds(bounds)\n-            .setId(uuidGenerator.generateUuid())\n-            .setState(State.PENDING)\n-            .setName(geocodingManager.getOfflineAreaName(bounds))\n-            .build();\n-\n-    return enqueueTileDownloads(offlineArea);\n+    return geocodingManager\n+        .getOfflineAreaName(bounds)\n+        .map(\n+            name ->\n+                OfflineArea.newBuilder()\n+                    .setBounds(bounds)\n+                    .setId(uuidGenerator.generateUuid())\n+                    .setState(State.PENDING)\n+                    .setName(name)\n+                    .build())\n+        .flatMapCompletable(this::enqueueTileDownloads);\n   }\n \n   public Flowable<ImmutableList<OfflineArea>> getOfflineAreasOnceAndStream() {\n"}}, {"oid": "03f1fdb54f3affe13168b0e3fa8a6c231b0deff0", "url": "https://github.com/google/ground-android/commit/03f1fdb54f3affe13168b0e3fa8a6c231b0deff0", "message": "Remove unused import in OfflineAreaListAdapter", "committedDate": "2020-08-19T16:27:00Z", "type": "commit"}, {"oid": "582b8039617f77ab406366da735801c199ffa80f", "url": "https://github.com/google/ground-android/commit/582b8039617f77ab406366da735801c199ffa80f", "message": "Model reverse geocoding area names as Singles\n\nThe Geocoder's getFromLocation call blocks, so we should run it on the IO thread instead of the UI thread to avoid blocking the UI. In line with the rest of the code base, we use RX java to wrpa the computation and run it on the IO scheduler.", "committedDate": "2020-08-19T16:29:20Z", "type": "commit"}, {"oid": "0bdfe113bb7b2a53c76f305d1d3c03bea61b1d2e", "url": "https://github.com/google/ground-android/commit/0bdfe113bb7b2a53c76f305d1d3c03bea61b1d2e", "message": "Update local data store tests according to Offline Area model changes", "committedDate": "2020-08-19T20:00:41Z", "type": "commit"}, {"oid": "e71f478931229922b14d24efb43badc9e45984dc", "url": "https://github.com/google/ground-android/commit/e71f478931229922b14d24efb43badc9e45984dc", "message": "Merge branch 'master' into geocoding-fixes", "committedDate": "2020-08-19T20:48:03Z", "type": "commit"}]}