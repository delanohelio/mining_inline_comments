{"pr_number": 591, "pr_title": "[Code cleanup] Refactor HomeScreenViewModel", "pr_createdAt": "2020-10-16T06:39:30Z", "pr_url": "https://github.com/google/ground-android/pull/591", "timeline": [{"oid": "f8ca2f2f7358b27f46ade30ad57a19f62690715d", "url": "https://github.com/google/ground-android/commit/f8ca2f2f7358b27f46ade30ad57a19f62690715d", "message": "Remove TODO", "committedDate": "2020-10-16T06:48:38Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzI5MTMyOQ==", "url": "https://github.com/google/ground-android/pull/591#discussion_r507291329", "bodyText": "A more specific error message would be helpful here, but broader question - why would we ever call this with Optional.empty() in the first place?", "author": "gino-m", "createdAt": "2020-10-19T00:42:43Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/home/HomeScreenFragment.java", "diffHunk": "@@ -121,6 +123,15 @@ public void onCreate(@Nullable Bundle savedInstanceState) {\n     projectSelectorViewModel = getViewModel(ProjectSelectorViewModel.class);\n   }\n \n+  private void onFeatureAdded(Optional<Feature> feature) {\n+    feature.ifPresentOrElse(\n+        viewModel::onAddFeature,\n+        () -> {\n+          // TODO: Show an error message to the user.\n+          Timber.e(\"Couldn't add feature.\");", "originalCommit": "f8ca2f2f7358b27f46ade30ad57a19f62690715d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzQzMTU3Mg==", "url": "https://github.com/google/ground-android/pull/591#discussion_r507431572", "bodyText": "I agree that this is non-conventional. Ideally, we should return success state with result or error state with error message. I'll fix that. Thanks!", "author": "shobhitagarwal1612", "createdAt": "2020-10-19T04:08:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzI5MTMyOQ=="}], "type": "inlineReview", "revised_code": {"commit": "474cc65d43b3efddebac5f2fce7ead1b4ebcb11f", "chunk": "diff --git a/gnd/src/main/java/com/google/android/gnd/ui/home/HomeScreenFragment.java b/gnd/src/main/java/com/google/android/gnd/ui/home/HomeScreenFragment.java\nindex 6ef820a9..752113c2 100644\n--- a/gnd/src/main/java/com/google/android/gnd/ui/home/HomeScreenFragment.java\n+++ b/gnd/src/main/java/com/google/android/gnd/ui/home/HomeScreenFragment.java\n\n@@ -123,28 +123,40 @@ public class HomeScreenFragment extends AbstractFragment\n     projectSelectorViewModel = getViewModel(ProjectSelectorViewModel.class);\n   }\n \n-  private void onFeatureAdded(Optional<Feature> feature) {\n-    feature.ifPresentOrElse(\n-        viewModel::onAddFeature,\n-        () -> {\n-          // TODO: Show an error message to the user.\n-          Timber.e(\"Couldn't add feature.\");\n-        });\n-  }\n-\n-  private void onFeatureUpdated(Boolean result) {\n-    if (result) {\n-      Toast.makeText(getContext(), \"Done\", Toast.LENGTH_SHORT).show();\n-      mapContainerFragment.setDefaultMode();\n-    } else {\n-      Timber.e(\"Failed to update feature\");\n+  private void onFeatureAdded(Loadable<Feature> loadable) {\n+    Timber.d(\"Adding feature: %s\", loadable.getState());\n+    switch (loadable.getState()) {\n+      case LOADED:\n+        loadable.value().ifPresent(viewModel::onAddFeature);\n+        break;\n+      case ERROR:\n+        Toast.makeText(getContext(), \"Error while adding feature\", Toast.LENGTH_SHORT).show();\n+        break;\n     }\n   }\n \n-  private void onFeatureDeleted(Boolean result) {\n-    if (result) {\n-      // TODO: Re-position map to default location after successful deletion.\n-      hideBottomSheet();\n+  private void onFeatureUpdated(Loadable<Feature> loadable) {\n+    Timber.d(\"Updating feature: %s\", loadable.getState());\n+    switch (loadable.getState()) {\n+      case LOADED:\n+        mapContainerFragment.setDefaultMode();\n+        break;\n+      case ERROR:\n+        Toast.makeText(getContext(), \"Error while updating feature\", Toast.LENGTH_SHORT).show();\n+        break;\n+    }\n+  }\n+\n+  private void onFeatureDeleted(Loadable<Feature> loadable) {\n+    Timber.d(\"Deleting feature: %s\", loadable.getState());\n+    switch (loadable.getState()) {\n+      case LOADED:\n+        // TODO: Re-position map to default location after successful deletion.\n+        hideBottomSheet();\n+        break;\n+      case ERROR:\n+        Toast.makeText(getContext(), \"Error while deleting feature\", Toast.LENGTH_SHORT).show();\n+        break;\n     }\n   }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzI5MTU1MA==", "url": "https://github.com/google/ground-android/pull/591#discussion_r507291550", "bodyText": "Same question here.", "author": "gino-m", "createdAt": "2020-10-19T00:42:56Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/home/HomeScreenViewModel.java", "diffHunk": "@@ -50,46 +47,41 @@\n   /** The state and value of the currently active project (loading, loaded, etc.). */\n   private final LiveData<Loadable<Project>> activeProject;\n \n-  private final PublishSubject<Feature> addFeatureClicks;\n   // TODO: Move into MapContainersViewModel\n   private final MutableLiveData<Event<Point>> addFeatureDialogRequests;\n   // TODO: Move into FeatureDetailsViewModel.\n   private final MutableLiveData<Action> openDrawerRequests;\n   private final MutableLiveData<BottomSheetState> bottomSheetState;\n \n+  private final FlowableProcessor<Feature> addFeatureClicks = PublishProcessor.create();\n+  private final FlowableProcessor<Feature> updateFeatureRequests = PublishProcessor.create();\n   private final FlowableProcessor<Feature> deleteFeatureRequests = PublishProcessor.create();\n-  private final LiveData<Boolean> deleteFeature;\n \n-  private final FlowableProcessor<Feature> updateFeatureRequests = PublishProcessor.create();\n+  private final LiveData<Optional<Feature>> addFeature;", "originalCommit": "f8ca2f2f7358b27f46ade30ad57a19f62690715d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "7e5981c21068992ecd07a25be1de089db87de02e", "chunk": "diff --git a/gnd/src/main/java/com/google/android/gnd/ui/home/HomeScreenViewModel.java b/gnd/src/main/java/com/google/android/gnd/ui/home/HomeScreenViewModel.java\nindex ac9752b7..78d4d6a9 100644\n--- a/gnd/src/main/java/com/google/android/gnd/ui/home/HomeScreenViewModel.java\n+++ b/gnd/src/main/java/com/google/android/gnd/ui/home/HomeScreenViewModel.java\n\n@@ -65,7 +66,8 @@ public class HomeScreenViewModel extends AbstractViewModel {\n   HomeScreenViewModel(\n       ProjectRepository projectRepository,\n       FeatureRepository featureRepository,\n-      Navigator navigator) {\n+      Navigator navigator,\n+      Schedulers schedulers) {\n     this.projectRepository = projectRepository;\n     this.addFeatureDialogRequests = new MutableLiveData<>();\n     this.openDrawerRequests = new MutableLiveData<>();\n"}}, {"oid": "7e5981c21068992ecd07a25be1de089db87de02e", "url": "https://github.com/google/ground-android/commit/7e5981c21068992ecd07a25be1de089db87de02e", "message": "Replace disposeOnClear with LiveData for add feature requests", "committedDate": "2020-10-19T05:03:37Z", "type": "commit"}, {"oid": "2f91b9b8a9afd40d7368b20a8c0fe6569a7dc962", "url": "https://github.com/google/ground-android/commit/2f91b9b8a9afd40d7368b20a8c0fe6569a7dc962", "message": "Remove schedulers dependency", "committedDate": "2020-10-19T05:03:37Z", "type": "commit"}, {"oid": "1819f8084efe80a1f732243f00debf23f9265f4f", "url": "https://github.com/google/ground-android/commit/1819f8084efe80a1f732243f00debf23f9265f4f", "message": "Remove TODO", "committedDate": "2020-10-19T05:03:37Z", "type": "commit"}, {"oid": "d364bf3b5f71ce09a5e66a633b766d0e151dd56f", "url": "https://github.com/google/ground-android/commit/d364bf3b5f71ce09a5e66a633b766d0e151dd56f", "message": "Log errors to timber", "committedDate": "2020-10-19T05:47:47Z", "type": "commit"}, {"oid": "6e23338ca01b3ec2d2b8d413fee1829828f43de1", "url": "https://github.com/google/ground-android/commit/6e23338ca01b3ec2d2b8d413fee1829828f43de1", "message": "Return Flowable instead of Completable from FeatureRepository\n\n * This allows us to update the UI according to current state", "committedDate": "2020-10-19T05:49:26Z", "type": "commit"}, {"oid": "93f878cd43d3ab35bb7038ac42d8ca866bdb429f", "url": "https://github.com/google/ground-android/commit/93f878cd43d3ab35bb7038ac42d8ca866bdb429f", "message": "Simplify HomeScreenViewModel", "committedDate": "2020-10-19T05:50:20Z", "type": "commit"}, {"oid": "474cc65d43b3efddebac5f2fce7ead1b4ebcb11f", "url": "https://github.com/google/ground-android/commit/474cc65d43b3efddebac5f2fce7ead1b4ebcb11f", "message": "Update View and show error message to the user", "committedDate": "2020-10-19T05:50:59Z", "type": "commit"}, {"oid": "a6316ee2bae746d95fed442fdf26c4f9df7221a6", "url": "https://github.com/google/ground-android/commit/a6316ee2bae746d95fed442fdf26c4f9df7221a6", "message": "Add method doc for apply and enqueue", "committedDate": "2020-10-19T06:01:27Z", "type": "commit"}, {"oid": "672417a01365f5dc620f4e40e302e77a3a10aa17", "url": "https://github.com/google/ground-android/commit/672417a01365f5dc620f4e40e302e77a3a10aa17", "message": "Add test class", "committedDate": "2020-10-19T06:23:30Z", "type": "commit"}, {"oid": "743c48d233b444dc87109df2fb47d49ba144d3d5", "url": "https://github.com/google/ground-android/commit/743c48d233b444dc87109df2fb47d49ba144d3d5", "message": "Add mockito-core gradle dependency", "committedDate": "2020-10-19T07:18:42Z", "type": "commit"}, {"oid": "113bca3a110bfb62216ac1b1450d7c6d797c2d2c", "url": "https://github.com/google/ground-android/commit/113bca3a110bfb62216ac1b1450d7c6d797c2d2c", "message": "Reorder lines in Loadable and ValueOrError", "committedDate": "2020-10-19T08:17:07Z", "type": "commit"}, {"oid": "a9ce1d525f451c822f57a80f94da80b9c48cb965", "url": "https://github.com/google/ground-android/commit/a9ce1d525f451c822f57a80f94da80b9c48cb965", "message": "Override comparators for Loadable and ValueOrError\n\n * This is needed for comparing output of tests", "committedDate": "2020-10-19T08:18:37Z", "type": "commit"}, {"oid": "f2858d69f6017da46bc84badcb5c37d89e0b34ef", "url": "https://github.com/google/ground-android/commit/f2858d69f6017da46bc84badcb5c37d89e0b34ef", "message": "Add tests", "committedDate": "2020-10-19T09:32:23Z", "type": "commit"}, {"oid": "f2858d69f6017da46bc84badcb5c37d89e0b34ef", "url": "https://github.com/google/ground-android/commit/f2858d69f6017da46bc84badcb5c37d89e0b34ef", "message": "Add tests", "committedDate": "2020-10-19T09:32:23Z", "type": "forcePushed"}, {"oid": "266cd5dd970ed82f9a6d49a4d5ba951c5205477f", "url": "https://github.com/google/ground-android/commit/266cd5dd970ed82f9a6d49a4d5ba951c5205477f", "message": "Add handler for default cases", "committedDate": "2020-10-19T09:39:34Z", "type": "commit"}, {"oid": "82a09e2aa3b8095bd5badffd41bf2e401041cf2f", "url": "https://github.com/google/ground-android/commit/82a09e2aa3b8095bd5badffd41bf2e401041cf2f", "message": "Merge branch 'master' into cleanup2", "committedDate": "2020-10-19T20:28:58Z", "type": "commit"}, {"oid": "cb45ae340735dd7d849cbdc5605f0e535b6ba6ee", "url": "https://github.com/google/ground-android/commit/cb45ae340735dd7d849cbdc5605f0e535b6ba6ee", "message": "Remove unused InstantTaskExecutorRule", "committedDate": "2020-10-19T20:34:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDEzODcxMQ==", "url": "https://github.com/google/ground-android/pull/591#discussion_r514138711", "bodyText": "I've experimented with pushing the Flowable<Loadable<>> down in the stack like this in the past, and while it simplifies usage, it also complicates the semantics of the internal API; these methods no longer simply do work and then either complete or return an error, but rather they stream status. This is slightly harder for clients of these methods to understand, and is really only introduced here because of how the UI streams emit state. It also is questionable whether this simplifies the code, since the transformation to a Flowable still has to happen somewhere.\nCan we wrap the state higher up in the stack instead, as close to the subscription as possible?\nAlso note that Loadable is modeled around the action of something being loaded from the database, not creating, updating, and deleting.", "author": "gino-m", "createdAt": "2020-10-29T10:02:33Z", "path": "gnd/src/main/java/com/google/android/gnd/repository/FeatureRepository.java", "diffHunk": "@@ -127,21 +127,33 @@ private FeatureMutation fromFeature(Feature feature, Type type) {\n   }\n \n   // TODO(#80): Update UI to provide FeatureMutations instead of Features here.\n-  public Completable createFeature(Feature feature) {\n-    return applyAndEnqueue(fromFeature(feature, Type.CREATE));\n+  public Flowable<Loadable<Feature>> createFeature(Feature feature) {", "originalCommit": "cb45ae340735dd7d849cbdc5605f0e535b6ba6ee", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5e5b2897363b992ddebe92013332309714950006", "chunk": "diff --git a/gnd/src/main/java/com/google/android/gnd/repository/FeatureRepository.java b/gnd/src/main/java/com/google/android/gnd/repository/FeatureRepository.java\nindex 7c1d45b3..cb05fcf3 100644\n--- a/gnd/src/main/java/com/google/android/gnd/repository/FeatureRepository.java\n+++ b/gnd/src/main/java/com/google/android/gnd/repository/FeatureRepository.java\n\n@@ -127,15 +127,15 @@ public class FeatureRepository {\n   }\n \n   // TODO(#80): Update UI to provide FeatureMutations instead of Features here.\n-  public Flowable<Loadable<Feature>> createFeature(Feature feature) {\n+  public Completable createFeature(Feature feature) {\n     return applyAndEnqueue(feature, Type.CREATE);\n   }\n \n-  public Flowable<Loadable<Feature>> updateFeature(Feature feature) {\n+  public Completable updateFeature(Feature feature) {\n     return applyAndEnqueue(feature, Type.UPDATE);\n   }\n \n-  public Flowable<Loadable<Feature>> deleteFeature(Feature feature) {\n+  public Completable deleteFeature(Feature feature) {\n     return applyAndEnqueue(feature, Type.DELETE);\n   }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDEzOTE3Mw==", "url": "https://github.com/google/ground-android/pull/591#discussion_r514139173", "bodyText": "This is a transformation method that will return a new instance. It's assumed that the error in the Loadable will be handled somewhere, so printing the error to the log here will result in duplicate outputs in the log.", "author": "gino-m", "createdAt": "2020-10-29T10:03:20Z", "path": "gnd/src/main/java/com/google/android/gnd/rx/Loadable.java", "diffHunk": "@@ -58,17 +52,10 @@ private Loadable(LoadState state, @Nullable T data, Throwable error) {\n   }\n \n   public static <T> Loadable<T> error(Throwable t) {\n+    Timber.e(t);", "originalCommit": "cb45ae340735dd7d849cbdc5605f0e535b6ba6ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDI3NDI2MQ==", "url": "https://github.com/google/ground-android/pull/591#discussion_r514274261", "bodyText": "Done", "author": "shobhitagarwal1612", "createdAt": "2020-10-29T13:51:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDEzOTE3Mw=="}], "type": "inlineReview", "revised_code": {"commit": "afcbe614e70ce87dcfdba4984cf3e23358963025", "chunk": "diff --git a/gnd/src/main/java/com/google/android/gnd/rx/Loadable.java b/gnd/src/main/java/com/google/android/gnd/rx/Loadable.java\nindex b0cac3e1..6c045e21 100644\n--- a/gnd/src/main/java/com/google/android/gnd/rx/Loadable.java\n+++ b/gnd/src/main/java/com/google/android/gnd/rx/Loadable.java\n\n@@ -52,7 +51,6 @@ public class Loadable<T> extends ValueOrError<T> {\n   }\n \n   public static <T> Loadable<T> error(Throwable t) {\n-    Timber.e(t);\n     return new Loadable<>(LoadState.ERROR, null, t);\n   }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDEzOTcyNg==", "url": "https://github.com/google/ground-android/pull/591#discussion_r514139726", "bodyText": "In the future, please reorder method in a separate PR if possible, since mixing actual changes with reorders makes it hard to tell what was changed vs moved.", "author": "gino-m", "createdAt": "2020-10-29T10:04:12Z", "path": "gnd/src/main/java/com/google/android/gnd/rx/Loadable.java", "diffHunk": "@@ -98,6 +85,15 @@ public boolean isLoaded() {\n         .startWith(Loadable.loading());\n   }\n \n+  public LoadState getState() {\n+    return state;\n+  }\n+\n+  public boolean isLoaded() {\n+    return state == LoadState.LOADED;\n+  }", "originalCommit": "cb45ae340735dd7d849cbdc5605f0e535b6ba6ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDI3MzI3Mw==", "url": "https://github.com/google/ground-android/pull/591#discussion_r514273273", "bodyText": "Sure", "author": "shobhitagarwal1612", "createdAt": "2020-10-29T13:50:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDEzOTcyNg=="}], "type": "inlineReview", "revised_code": {"commit": "b0c3febd5ae1ce7a917bfb6d1930cb2b3e843d66", "chunk": "diff --git a/gnd/src/main/java/com/google/android/gnd/rx/Loadable.java b/gnd/src/main/java/com/google/android/gnd/rx/Loadable.java\nindex b0cac3e1..9f8923ee 100644\n--- a/gnd/src/main/java/com/google/android/gnd/rx/Loadable.java\n+++ b/gnd/src/main/java/com/google/android/gnd/rx/Loadable.java\n\n@@ -85,15 +98,6 @@ public class Loadable<T> extends ValueOrError<T> {\n         .startWith(Loadable.loading());\n   }\n \n-  public LoadState getState() {\n-    return state;\n-  }\n-\n-  public boolean isLoaded() {\n-    return state == LoadState.LOADED;\n-  }\n-\n-  @NonNull\n   @Override\n   public String toString() {\n     if (state == LoadState.LOADED || state == LoadState.ERROR) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDE0MDYyOA==", "url": "https://github.com/google/ground-android/pull/591#discussion_r514140628", "bodyText": "What are equals() and hasCode() ever used? If not, please remove.", "author": "gino-m", "createdAt": "2020-10-29T10:05:37Z", "path": "gnd/src/main/java/com/google/android/gnd/rx/Loadable.java", "diffHunk": "@@ -106,4 +102,29 @@ public String toString() {\n       return state.toString();\n     }\n   }\n+\n+  @Override\n+  public boolean equals(Object o) {\n+    if (this == o) {\n+      return true;\n+    }\n+    if (!(o instanceof Loadable)) {\n+      return false;\n+    }\n+    Loadable<?> loadable = (Loadable<?>) o;\n+    return getState() == loadable.getState();\n+  }\n+\n+  @Override\n+  public int hashCode() {\n+    return Objects.hash(getState());\n+  }", "originalCommit": "cb45ae340735dd7d849cbdc5605f0e535b6ba6ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDI3Mjk2Ng==", "url": "https://github.com/google/ground-android/pull/591#discussion_r514272966", "bodyText": "These are used in the unit tests", "author": "shobhitagarwal1612", "createdAt": "2020-10-29T13:50:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDE0MDYyOA=="}], "type": "inlineReview", "revised_code": {"commit": "b0c3febd5ae1ce7a917bfb6d1930cb2b3e843d66", "chunk": "diff --git a/gnd/src/main/java/com/google/android/gnd/rx/Loadable.java b/gnd/src/main/java/com/google/android/gnd/rx/Loadable.java\nindex b0cac3e1..9f8923ee 100644\n--- a/gnd/src/main/java/com/google/android/gnd/rx/Loadable.java\n+++ b/gnd/src/main/java/com/google/android/gnd/rx/Loadable.java\n\n@@ -102,29 +106,4 @@ public class Loadable<T> extends ValueOrError<T> {\n       return state.toString();\n     }\n   }\n-\n-  @Override\n-  public boolean equals(Object o) {\n-    if (this == o) {\n-      return true;\n-    }\n-    if (!(o instanceof Loadable)) {\n-      return false;\n-    }\n-    Loadable<?> loadable = (Loadable<?>) o;\n-    return getState() == loadable.getState();\n-  }\n-\n-  @Override\n-  public int hashCode() {\n-    return Objects.hash(getState());\n-  }\n-\n-  public enum LoadState {\n-    NOT_LOADED,\n-    LOADING,\n-    LOADED,\n-    NOT_FOUND,\n-    ERROR\n-  }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDE0MDcwMg==", "url": "https://github.com/google/ground-android/pull/591#discussion_r514140702", "bodyText": "What are equals() and hasCode() ever used? If not, please remove.", "author": "gino-m", "createdAt": "2020-10-29T10:05:44Z", "path": "gnd/src/main/java/com/google/android/gnd/rx/ValueOrError.java", "diffHunk": "@@ -72,4 +62,38 @@ public String toString() {\n   public static <T> Observable<T> ignoreErrors(Observable<ValueOrError<T>> observable) {\n     return observable.filter(voe -> voe.value().isPresent()).map(voe -> voe.value().get());\n   }\n+\n+  public Optional<T> value() {\n+    return Optional.ofNullable(value);\n+  }\n+\n+  public Optional<Throwable> error() {\n+    if (error != null) {\n+      Timber.e(error);\n+    }\n+    return Optional.ofNullable(error);\n+  }\n+\n+  @NonNull\n+  @Override\n+  public String toString() {\n+    return error().map(t -> \"Error: \" + t).orElse(\"Value: \" + value);\n+  }\n+\n+  @Override\n+  public boolean equals(Object o) {\n+    if (this == o) {\n+      return true;\n+    }\n+    if (!(o instanceof ValueOrError)) {\n+      return false;\n+    }\n+    ValueOrError<?> that = (ValueOrError<?>) o;\n+    return Objects.equals(value, that.value) && Objects.equals(error, that.error);\n+  }\n+\n+  @Override\n+  public int hashCode() {\n+    return Objects.hash(value, error);\n+  }", "originalCommit": "cb45ae340735dd7d849cbdc5605f0e535b6ba6ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDI3MzA3NA==", "url": "https://github.com/google/ground-android/pull/591#discussion_r514273074", "bodyText": "Same as above, used in unit test", "author": "shobhitagarwal1612", "createdAt": "2020-10-29T13:50:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDE0MDcwMg=="}], "type": "inlineReview", "revised_code": {"commit": "b0c3febd5ae1ce7a917bfb6d1930cb2b3e843d66", "chunk": "diff --git a/gnd/src/main/java/com/google/android/gnd/rx/ValueOrError.java b/gnd/src/main/java/com/google/android/gnd/rx/ValueOrError.java\nindex 4700d8ef..1d2f9f20 100644\n--- a/gnd/src/main/java/com/google/android/gnd/rx/ValueOrError.java\n+++ b/gnd/src/main/java/com/google/android/gnd/rx/ValueOrError.java\n\n@@ -62,38 +72,4 @@ public class ValueOrError<T> {\n   public static <T> Observable<T> ignoreErrors(Observable<ValueOrError<T>> observable) {\n     return observable.filter(voe -> voe.value().isPresent()).map(voe -> voe.value().get());\n   }\n-\n-  public Optional<T> value() {\n-    return Optional.ofNullable(value);\n-  }\n-\n-  public Optional<Throwable> error() {\n-    if (error != null) {\n-      Timber.e(error);\n-    }\n-    return Optional.ofNullable(error);\n-  }\n-\n-  @NonNull\n-  @Override\n-  public String toString() {\n-    return error().map(t -> \"Error: \" + t).orElse(\"Value: \" + value);\n-  }\n-\n-  @Override\n-  public boolean equals(Object o) {\n-    if (this == o) {\n-      return true;\n-    }\n-    if (!(o instanceof ValueOrError)) {\n-      return false;\n-    }\n-    ValueOrError<?> that = (ValueOrError<?>) o;\n-    return Objects.equals(value, that.value) && Objects.equals(error, that.error);\n-  }\n-\n-  @Override\n-  public int hashCode() {\n-    return Objects.hash(value, error);\n-  }\n }\n"}}, {"oid": "a6d8b4cbe0ff56c337b09b42bbbab05d401f11a7", "url": "https://github.com/google/ground-android/commit/a6d8b4cbe0ff56c337b09b42bbbab05d401f11a7", "message": "Merge branch 'master' into cleanup2", "committedDate": "2020-10-29T13:51:10Z", "type": "commit"}, {"oid": "afcbe614e70ce87dcfdba4984cf3e23358963025", "url": "https://github.com/google/ground-android/commit/afcbe614e70ce87dcfdba4984cf3e23358963025", "message": "Remove timber call", "committedDate": "2020-10-29T13:51:51Z", "type": "commit"}, {"oid": "2167258b210a01cacfd66a614c0e419e734598c7", "url": "https://github.com/google/ground-android/commit/2167258b210a01cacfd66a614c0e419e734598c7", "message": "Merge branch 'master' into cleanup2\n\n# Conflicts:\n#\tgnd/src/main/java/com/google/android/gnd/ui/home/HomeScreenViewModel.java", "committedDate": "2020-11-01T08:48:11Z", "type": "commit"}, {"oid": "42676c27da166670bec81a0a46c00e2ada1d0111", "url": "https://github.com/google/ground-android/commit/42676c27da166670bec81a0a46c00e2ada1d0111", "message": "Add helper method to convert Completable to Single<Boolean>", "committedDate": "2020-11-01T17:01:04Z", "type": "commit"}, {"oid": "5e5b2897363b992ddebe92013332309714950006", "url": "https://github.com/google/ground-android/commit/5e5b2897363b992ddebe92013332309714950006", "message": "Revert FeatureRepository to return Completable", "committedDate": "2020-11-01T17:01:49Z", "type": "commit"}, {"oid": "6c219b3aed75f73100c1ec9234a47615477b63e9", "url": "https://github.com/google/ground-android/commit/6c219b3aed75f73100c1ec9234a47615477b63e9", "message": "Refactor HomeScreen\n\n * Remove loadable for state and use a separate LiveData for emitting errors\n * Move navigator for addNewObservation to fragment", "committedDate": "2020-11-01T17:05:14Z", "type": "commit"}, {"oid": "06a7b04877b8b345c0eb8964b77881fefe15d071", "url": "https://github.com/google/ground-android/commit/06a7b04877b8b345c0eb8964b77881fefe15d071", "message": "Update unit tests", "committedDate": "2020-11-01T17:10:09Z", "type": "commit"}, {"oid": "b0c3febd5ae1ce7a917bfb6d1930cb2b3e843d66", "url": "https://github.com/google/ground-android/commit/b0c3febd5ae1ce7a917bfb6d1930cb2b3e843d66", "message": "Revert changes to Loadable & ValueOrError", "committedDate": "2020-11-01T17:12:40Z", "type": "commit"}, {"oid": "22e38338fb2cda43e9cd64f74ffed87f63fda8d0", "url": "https://github.com/google/ground-android/commit/22e38338fb2cda43e9cd64f74ffed87f63fda8d0", "message": "Pass along throwable instead of parsing error message", "committedDate": "2020-11-01T17:17:55Z", "type": "commit"}, {"oid": "520aded3695cb8b08564063afa93d949eb26571a", "url": "https://github.com/google/ground-android/commit/520aded3695cb8b08564063afa93d949eb26571a", "message": "Remove javadoc (causes checkstyle error)", "committedDate": "2020-11-01T17:23:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTY2NDMyNA==", "url": "https://github.com/google/ground-android/pull/591#discussion_r515664324", "bodyText": "This method is actually doing a lot more than just converting the Completable to a Single; it's returning whether the Single completed successfully, and is causing a side effect on the provided Consumer. I'd suggest a few improvements to make this clearer:\n\nGive the method a more explicit name, like toBooleanSingle() to indicate this is doing something special.\nCall the callback param for when it's actually invoked (onError).\nIf this is every called with null exceptionConsumer (I didn't see it on a quick scan), create a separate override of this method without the Consumer (i.e. toBooleanSingle(Completable) and toBooleanSingle(Completable, onErro).\nAdd minimal Javadoc explaining these semantics (esp. since the method is public.", "author": "gino-m", "createdAt": "2020-11-01T19:54:16Z", "path": "gnd/src/main/java/com/google/android/gnd/rx/RxCompletable.java", "diffHunk": "@@ -45,4 +49,17 @@ public static Completable completeOrError(\n           }\n         });\n   }\n+\n+  public static Single<Boolean> toSingle(", "originalCommit": "520aded3695cb8b08564063afa93d949eb26571a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "4335b5cf52dc81a50ce5d32a83b605a5d913f83b", "chunk": "diff --git a/gnd/src/main/java/com/google/android/gnd/rx/RxCompletable.java b/gnd/src/main/java/com/google/android/gnd/rx/RxCompletable.java\nindex 6ea6f0f3..69db87aa 100644\n--- a/gnd/src/main/java/com/google/android/gnd/rx/RxCompletable.java\n+++ b/gnd/src/main/java/com/google/android/gnd/rx/RxCompletable.java\n\n@@ -50,15 +50,24 @@ public abstract class RxCompletable {\n         });\n   }\n \n-  public static Single<Boolean> toSingle(\n-      @NonNull Completable completable, @Nullable Consumer<? super Throwable> exceptionConsumer) {\n+  /**\n+   * Receives a {@link Completable} and returns a {@link Single} that emits <code>true</code> if the\n+   * <code>Completable</code> completes successfully, <code>false</code> otherwise. In case any\n+   * error occurs, the exception is logged to {@link Timber}.\n+   */\n+  public static Single<Boolean> toBooleanSingle(@NonNull Completable completable) {\n+    return toBooleanSingle(completable, null);\n+  }\n+\n+  /**\n+   * Receives a {@link Completable} and returns a {@link Single} that emits <code>true</code> if the\n+   * <code>Completable</code> completes successfully, <code>false</code> otherwise. In case any\n+   * error occurs, the exception is consumed by the argument {@param exceptionConsumer}.\n+   */\n+  public static Single<Boolean> toBooleanSingle(\n+      @NonNull Completable completable, Consumer<? super Throwable> exceptionConsumer) {\n     return completable\n-        .doOnError(\n-            throwable -> {\n-              if (exceptionConsumer != null) {\n-                exceptionConsumer.accept(throwable);\n-              }\n-            })\n+        .doOnError(exceptionConsumer::accept)\n         .toSingleDefault(true)\n         .onErrorReturnItem(false);\n   }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTY2NDU5Mw==", "url": "https://github.com/google/ground-android/pull/591#discussion_r515664593", "bodyText": "This Javadoc isn't needed since the code is self-explanatory, and the method is internal/private.", "author": "gino-m", "createdAt": "2020-11-01T19:56:30Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/home/HomeScreenFragment.java", "diffHunk": "@@ -121,22 +124,37 @@ public void onCreate(@Nullable Bundle savedInstanceState) {\n     projectSelectorViewModel = getViewModel(ProjectSelectorViewModel.class);\n   }\n \n+  private void onFeatureAdded(Feature feature) {\n+    feature.getLayer().getForm().ifPresent(formId -> addNewObservation(feature));\n+  }\n+\n+  private void addNewObservation(Feature feature) {\n+    String projectId = feature.getProject().getId();\n+    String featureId = feature.getId();\n+    String formId = feature.getLayer().getForm().get().getId();\n+    navigator.addObservation(projectId, featureId, formId);\n+  }\n+\n+  /** This is only possible after updating the location of the feature. So, reset the UI. */\n   private void onFeatureUpdated(Boolean result) {\n     if (result) {\n-      Toast.makeText(getContext(), \"Done\", Toast.LENGTH_SHORT).show();\n       mapContainerFragment.setDefaultMode();\n-    } else {\n-      Timber.e(\"Failed to update feature\");\n     }\n   }\n \n+  /** Hide the bottom sheet as deleting a feature also removes child observations. */", "originalCommit": "520aded3695cb8b08564063afa93d949eb26571a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5fbea2cdb17f8adacf87bd0c93dafc501a2d4f63", "chunk": "diff --git a/gnd/src/main/java/com/google/android/gnd/ui/home/HomeScreenFragment.java b/gnd/src/main/java/com/google/android/gnd/ui/home/HomeScreenFragment.java\nindex 4caad56c..4a7c80c2 100644\n--- a/gnd/src/main/java/com/google/android/gnd/ui/home/HomeScreenFragment.java\n+++ b/gnd/src/main/java/com/google/android/gnd/ui/home/HomeScreenFragment.java\n\n@@ -152,7 +152,9 @@ public class HomeScreenFragment extends AbstractFragment\n \n   /** Generic handler to display error messages to the user. */\n   private void onError(Throwable throwable) {\n-    Toast.makeText(getContext(), \"Error: \" + throwable.getMessage(), Toast.LENGTH_SHORT).show();\n+    Timber.e(throwable);\n+    // Don't display the exact error message as it might not be user-readable.\n+    Toast.makeText(getContext(), R.string.error_occurred, Toast.LENGTH_SHORT).show();\n   }\n \n   @Nullable\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTY2NDczMQ==", "url": "https://github.com/google/ground-android/pull/591#discussion_r515664731", "bodyText": "I would avoid showing the specific exception message to the user, since a) we don't have control over what is show, and b) we'll probably need to whole stack track to diagnose the problem anyway. Also, better to have a fixed message that can be translated if necessary.", "author": "gino-m", "createdAt": "2020-11-01T19:57:49Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/home/HomeScreenFragment.java", "diffHunk": "@@ -121,22 +124,37 @@ public void onCreate(@Nullable Bundle savedInstanceState) {\n     projectSelectorViewModel = getViewModel(ProjectSelectorViewModel.class);\n   }\n \n+  private void onFeatureAdded(Feature feature) {\n+    feature.getLayer().getForm().ifPresent(formId -> addNewObservation(feature));\n+  }\n+\n+  private void addNewObservation(Feature feature) {\n+    String projectId = feature.getProject().getId();\n+    String featureId = feature.getId();\n+    String formId = feature.getLayer().getForm().get().getId();\n+    navigator.addObservation(projectId, featureId, formId);\n+  }\n+\n+  /** This is only possible after updating the location of the feature. So, reset the UI. */\n   private void onFeatureUpdated(Boolean result) {\n     if (result) {\n-      Toast.makeText(getContext(), \"Done\", Toast.LENGTH_SHORT).show();\n       mapContainerFragment.setDefaultMode();\n-    } else {\n-      Timber.e(\"Failed to update feature\");\n     }\n   }\n \n+  /** Hide the bottom sheet as deleting a feature also removes child observations. */\n   private void onFeatureDeleted(Boolean result) {\n     if (result) {\n       // TODO: Re-position map to default location after successful deletion.\n       hideBottomSheet();\n     }\n   }\n \n+  /** Generic handler to display error messages to the user. */\n+  private void onError(Throwable throwable) {\n+    Toast.makeText(getContext(), \"Error: \" + throwable.getMessage(), Toast.LENGTH_SHORT).show();", "originalCommit": "520aded3695cb8b08564063afa93d949eb26571a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5fbea2cdb17f8adacf87bd0c93dafc501a2d4f63", "chunk": "diff --git a/gnd/src/main/java/com/google/android/gnd/ui/home/HomeScreenFragment.java b/gnd/src/main/java/com/google/android/gnd/ui/home/HomeScreenFragment.java\nindex 4caad56c..4a7c80c2 100644\n--- a/gnd/src/main/java/com/google/android/gnd/ui/home/HomeScreenFragment.java\n+++ b/gnd/src/main/java/com/google/android/gnd/ui/home/HomeScreenFragment.java\n\n@@ -152,7 +152,9 @@ public class HomeScreenFragment extends AbstractFragment\n \n   /** Generic handler to display error messages to the user. */\n   private void onError(Throwable throwable) {\n-    Toast.makeText(getContext(), \"Error: \" + throwable.getMessage(), Toast.LENGTH_SHORT).show();\n+    Timber.e(throwable);\n+    // Don't display the exact error message as it might not be user-readable.\n+    Toast.makeText(getContext(), R.string.error_occurred, Toast.LENGTH_SHORT).show();\n   }\n \n   @Nullable\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTY2NDgwMQ==", "url": "https://github.com/google/ground-android/pull/591#discussion_r515664801", "bodyText": "Can we add a suffix to the names of these LiveData so that it's clearer when emit values? Also, we've been following the convention that streams that can emit more than one value are named in plural (e.g.  addFeatureResults).", "author": "gino-m", "createdAt": "2020-11-01T19:58:42Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/home/HomeScreenViewModel.java", "diffHunk": "@@ -53,74 +52,63 @@\n   /** The state and value of the currently active project (loading, loaded, etc.). */\n   private final LiveData<Loadable<Project>> activeProject;\n \n-  private final PublishSubject<Feature> addFeatureClicks;\n   // TODO: Move into MapContainersViewModel\n   private final MutableLiveData<Event<Point>> addFeatureDialogRequests;\n   // TODO: Move into FeatureDetailsViewModel.\n   private final MutableLiveData<Action> openDrawerRequests;\n   private final MutableLiveData<BottomSheetState> bottomSheetState;\n \n+  private final FlowableProcessor<Feature> addFeatureClicks = PublishProcessor.create();\n+  private final FlowableProcessor<Feature> updateFeatureRequests = PublishProcessor.create();\n   private final FlowableProcessor<Feature> deleteFeatureRequests = PublishProcessor.create();\n-  private final LiveData<Boolean> deleteFeature;\n \n-  private final FlowableProcessor<Feature> updateFeatureRequests = PublishProcessor.create();\n+  private final LiveData<Feature> addFeature;", "originalCommit": "520aded3695cb8b08564063afa93d949eb26571a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjQ1NDg0NA==", "url": "https://github.com/google/ground-android/pull/591#discussion_r516454844", "bodyText": "That makes it much more readable as well. Thanks!!!", "author": "shobhitagarwal1612", "createdAt": "2020-11-03T06:52:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTY2NDgwMQ=="}], "type": "inlineReview", "revised_code": {"commit": "fd48dbc5f4de61201c5fafcd728dddb90f27e783", "chunk": "diff --git a/gnd/src/main/java/com/google/android/gnd/ui/home/HomeScreenViewModel.java b/gnd/src/main/java/com/google/android/gnd/ui/home/HomeScreenViewModel.java\nindex 52968cd0..50dd5eef 100644\n--- a/gnd/src/main/java/com/google/android/gnd/ui/home/HomeScreenViewModel.java\n+++ b/gnd/src/main/java/com/google/android/gnd/ui/home/HomeScreenViewModel.java\n\n@@ -62,11 +62,10 @@ public class HomeScreenViewModel extends AbstractViewModel {\n   private final FlowableProcessor<Feature> updateFeatureRequests = PublishProcessor.create();\n   private final FlowableProcessor<Feature> deleteFeatureRequests = PublishProcessor.create();\n \n-  private final LiveData<Feature> addFeature;\n-  private final LiveData<Boolean> updateFeature;\n-  private final LiveData<Boolean> deleteFeature;\n-\n-  private final MutableLiveData<Throwable> error = new MutableLiveData<>();\n+  private final LiveData<Feature> addFeatureResults;\n+  private final LiveData<Boolean> updateFeatureResults;\n+  private final LiveData<Boolean> deleteFeatureResults;\n+  private final MutableLiveData<Throwable> errors = new MutableLiveData<>();\n   private final MutableLiveData<Integer> addFeatureButtonVisibility = new MutableLiveData<>(GONE);\n \n   @Inject\n"}}, {"oid": "73f9fd2fa267e73670292f4c78d49fb27e8f32f7", "url": "https://github.com/google/ground-android/commit/73f9fd2fa267e73670292f4c78d49fb27e8f32f7", "message": "Merge branch 'master' into cleanup2", "committedDate": "2020-11-03T06:47:17Z", "type": "commit"}, {"oid": "5fbea2cdb17f8adacf87bd0c93dafc501a2d4f63", "url": "https://github.com/google/ground-android/commit/5fbea2cdb17f8adacf87bd0c93dafc501a2d4f63", "message": "Log exception to timber and show static error message", "committedDate": "2020-11-03T06:51:03Z", "type": "commit"}, {"oid": "fd48dbc5f4de61201c5fafcd728dddb90f27e783", "url": "https://github.com/google/ground-android/commit/fd48dbc5f4de61201c5fafcd728dddb90f27e783", "message": "Improve variable names to follow the convention", "committedDate": "2020-11-03T06:56:18Z", "type": "commit"}, {"oid": "4335b5cf52dc81a50ce5d32a83b605a5d913f83b", "url": "https://github.com/google/ground-android/commit/4335b5cf52dc81a50ce5d32a83b605a5d913f83b", "message": "Rename toSingle to toBooleanSingle, override it for nullable consumers and add javadoc", "committedDate": "2020-11-03T07:20:17Z", "type": "commit"}, {"oid": "f63ab61d874356abaf923ee3d67ba3f3f184759a", "url": "https://github.com/google/ground-android/commit/f63ab61d874356abaf923ee3d67ba3f3f184759a", "message": "Merge branch 'master' into cleanup2", "committedDate": "2020-11-03T15:47:01Z", "type": "commit"}]}