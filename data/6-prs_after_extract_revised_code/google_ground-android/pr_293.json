{"pr_number": 293, "pr_title": "[Auth] Save audit details with features and observations", "pr_createdAt": "2020-01-05T21:26:33Z", "pr_url": "https://github.com/google/ground-android/pull/293", "timeline": [{"oid": "adc43a838b5da1294143c169d3c9a9d6674bc32e", "url": "https://github.com/google/ground-android/commit/adc43a838b5da1294143c169d3c9a9d6674bc32e", "message": "Add user id and timestamp to observation mutations", "committedDate": "2020-01-04T03:26:04Z", "type": "commit"}, {"oid": "3c8334e229681bc5647d3ad9cfcaed07ceda9094", "url": "https://github.com/google/ground-android/commit/3c8334e229681bc5647d3ad9cfcaed07ceda9094", "message": "Make user auth impl independent", "committedDate": "2020-01-05T00:08:47Z", "type": "commit"}, {"oid": "1ddfbba0dbec66fa5b418b8ce90a6592c50ca772", "url": "https://github.com/google/ground-android/commit/1ddfbba0dbec66fa5b418b8ce90a6592c50ca772", "message": "Move User to model package", "committedDate": "2020-01-05T00:10:18Z", "type": "commit"}, {"oid": "c7340083af6b3e17f57c06db20d840ba9a4918a6", "url": "https://github.com/google/ground-android/commit/c7340083af6b3e17f57c06db20d840ba9a4918a6", "message": "Convert User to AutoValue", "committedDate": "2020-01-05T00:16:47Z", "type": "commit"}, {"oid": "e9c513d71e249d3675a9f3a5235cb2ceca817d4b", "url": "https://github.com/google/ground-android/commit/e9c513d71e249d3675a9f3a5235cb2ceca817d4b", "message": "Rename timestamp to setClientTimestamp for consistency", "committedDate": "2020-01-05T00:42:22Z", "type": "commit"}, {"oid": "793f72267f07512b77c0a73d8ea8c8db4a329791", "url": "https://github.com/google/ground-android/commit/793f72267f07512b77c0a73d8ea8c8db4a329791", "message": "[Broken WIP] Introduce AuditInfo across persistence and model", "committedDate": "2020-01-06T04:39:26Z", "type": "commit"}, {"oid": "fdc2f3b4ea28226fe3a15baf16c2c94e3c5e6eea", "url": "https://github.com/google/ground-android/commit/fdc2f3b4ea28226fe3a15baf16c2c94e3c5e6eea", "message": "Store user with new features", "committedDate": "2020-01-07T03:07:06Z", "type": "commit"}, {"oid": "e08d7dbae8f74abf3dbfa48390faf8523348378d", "url": "https://github.com/google/ground-android/commit/e08d7dbae8f74abf3dbfa48390faf8523348378d", "message": "Tweak comments", "committedDate": "2020-01-07T04:02:42Z", "type": "commit"}, {"oid": "0a451f82c51a1b7c85b07edd163808faf2244ef7", "url": "https://github.com/google/ground-android/commit/0a451f82c51a1b7c85b07edd163808faf2244ef7", "message": "Fix typos", "committedDate": "2020-01-07T04:03:27Z", "type": "commit"}, {"oid": "cd6770dedba02be844c808faaf8c6d536250e54d", "url": "https://github.com/google/ground-android/commit/cd6770dedba02be844c808faaf8c6d536250e54d", "message": "Refactor audit info in local db and apply to feature mutations", "committedDate": "2020-01-07T04:12:30Z", "type": "commit"}, {"oid": "d0388f6fca1fb4f5ccf4e9b9d0fca647fcdb9b18", "url": "https://github.com/google/ground-android/commit/d0388f6fca1fb4f5ccf4e9b9d0fca647fcdb9b18", "message": "Merge branch 'master' into save-user", "committedDate": "2020-01-07T04:16:28Z", "type": "commit"}, {"oid": "0619f835e414a3e767c78a7e495c88b7ee94eebf", "url": "https://github.com/google/ground-android/commit/0619f835e414a3e767c78a7e495c88b7ee94eebf", "message": "Expose loadUser method in local data store", "committedDate": "2020-01-08T03:14:21Z", "type": "commit"}, {"oid": "cb95071dbba366acd2b1950451e4c849f0205cc7", "url": "https://github.com/google/ground-android/commit/cb95071dbba366acd2b1950451e4c849f0205cc7", "message": "Write creation user and time to remote", "committedDate": "2020-01-08T03:14:21Z", "type": "commit"}, {"oid": "001704150882576a016b676e3e39106c21397685", "url": "https://github.com/google/ground-android/commit/001704150882576a016b676e3e39106c21397685", "message": "Refactor audit info doc creation, write lastModified to features", "committedDate": "2020-01-08T03:26:10Z", "type": "commit"}, {"oid": "6b32ab2e131e80223e369ac55b5f03540be630b5", "url": "https://github.com/google/ground-android/commit/6b32ab2e131e80223e369ac55b5f03540be630b5", "message": "Add created and lastModified audit info to remote observations", "committedDate": "2020-01-08T03:46:49Z", "type": "commit"}, {"oid": "d224531f422f16eb0202f2a0fd313695cd54d2cf", "url": "https://github.com/google/ground-android/commit/d224531f422f16eb0202f2a0fd313695cd54d2cf", "message": "Merge branch 'master' of https://github.com/google/ground-android into save-user\n\n# Conflicts:\n#\tgnd/src/main/java/com/google/android/gnd/ui/home/HomeScreenViewModel.java", "committedDate": "2020-01-08T03:50:34Z", "type": "commit"}, {"oid": "33bee2e1d9b9ea86636ca0c1fb64e310e7550448", "url": "https://github.com/google/ground-android/commit/33bee2e1d9b9ea86636ca0c1fb64e310e7550448", "message": "Fix typos", "committedDate": "2020-01-08T03:51:52Z", "type": "commit"}, {"oid": "8acaa4ccfb7f8a18435e291c57a3692cc8dea8d9", "url": "https://github.com/google/ground-android/commit/8acaa4ccfb7f8a18435e291c57a3692cc8dea8d9", "message": "Fix typos", "committedDate": "2020-01-08T03:58:51Z", "type": "commit"}, {"oid": "6f789c3725b856f74a354bc8cbc43834b7540261", "url": "https://github.com/google/ground-android/commit/6f789c3725b856f74a354bc8cbc43834b7540261", "message": "Clean up applyMutations logic", "committedDate": "2020-01-08T04:07:09Z", "type": "commit"}, {"oid": "74204dd33beb6608715a25247f9ac8d6ce0ce82f", "url": "https://github.com/google/ground-android/commit/74204dd33beb6608715a25247f9ac8d6ce0ce82f", "message": "Fix typo", "committedDate": "2020-01-08T04:07:35Z", "type": "commit"}, {"oid": "e88c538bebc77526c1a8ee619c9da7bbdad39a5e", "url": "https://github.com/google/ground-android/commit/e88c538bebc77526c1a8ee619c9da7bbdad39a5e", "message": "Eliminate ANONYMOUS user constant", "committedDate": "2020-01-08T04:14:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDIyMTY1Nw==", "url": "https://github.com/google/ground-android/pull/293#discussion_r364221657", "bodyText": "This can be removed now. Not being used anywhere.", "author": "shobhitagarwal1612", "createdAt": "2020-01-08T13:09:20Z", "path": "gnd/src/main/java/com/google/android/gnd/model/User.java", "diffHunk": "@@ -0,0 +1,36 @@\n+package com.google.android.gnd.model;\n+\n+import com.google.auto.value.AutoValue;\n+\n+/** Represents a single application user. */\n+@AutoValue\n+public abstract class User {\n+\n+  // TODO: Replace this workaround with Optional<User> or UNKNOWN.\n+  public static final User ANONYMOUS =\n+      User.builder().setId(\"\").setEmail(\"\").setDisplayName(\"\").build();", "originalCommit": "e88c538bebc77526c1a8ee619c9da7bbdad39a5e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDMxOTE5Mw==", "url": "https://github.com/google/ground-android/pull/293#discussion_r364319193", "bodyText": "Weird, I thought I removed this. Amending my last commit to include its removal.", "author": "gino-m", "createdAt": "2020-01-08T16:22:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDIyMTY1Nw=="}], "type": "inlineReview", "revised_code": {"commit": "ddd677cb4258a0ff44b14897aec93f7a4482b7f5", "chunk": "diff --git a/gnd/src/main/java/com/google/android/gnd/model/User.java b/gnd/src/main/java/com/google/android/gnd/model/User.java\nindex 38febdda..a287782a 100644\n--- a/gnd/src/main/java/com/google/android/gnd/model/User.java\n+++ b/gnd/src/main/java/com/google/android/gnd/model/User.java\n\n@@ -6,10 +6,6 @@ import com.google.auto.value.AutoValue;\n @AutoValue\n public abstract class User {\n \n-  // TODO: Replace this workaround with Optional<User> or UNKNOWN.\n-  public static final User ANONYMOUS =\n-      User.builder().setId(\"\").setEmail(\"\").setDisplayName(\"\").build();\n-\n   public abstract String getId();\n \n   public abstract String getEmail();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDIyMzQ1MQ==", "url": "https://github.com/google/ground-android/pull/293#discussion_r364223451", "bodyText": "Please use Long instead of primitive type long for consistency.", "author": "shobhitagarwal1612", "createdAt": "2020-01-08T13:13:58Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/local/room/AuditInfoEntity.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.persistence.local.room;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+import androidx.room.Embedded;\n+import com.google.android.gnd.model.AuditInfo;\n+import com.google.auto.value.AutoValue;\n+import com.google.auto.value.AutoValue.CopyAnnotations;\n+import java.util.Date;\n+import java8.util.Optional;\n+\n+/** User details and timestamp for creation or modification of a model object. */\n+@AutoValue\n+public abstract class AuditInfoEntity {\n+\n+  /**\n+   * Returns the user initiating the related action. This can never be null, since users must always\n+   * be logged in to make changes.\n+   */\n+  @CopyAnnotations\n+  @Embedded(prefix = \"user_\")\n+  @NonNull\n+  public abstract UserDetails getUser();\n+\n+  /** Returns the time at which the user action was initiated, according to the user's device. */\n+  @CopyAnnotations\n+  public abstract long getClientTimeMillis();\n+\n+  /**\n+   * Returns the time at which the server received the requested change according to the server's\n+   * internal clock, or null if the updated server time was not yet received.\n+   */\n+  @CopyAnnotations\n+  @Nullable\n+  public abstract Long getServerTimeMillis();\n+\n+  /** Converts a model object into a local db entity. */\n+  public static AuditInfoEntity fromObject(AuditInfo o) {\n+    return AuditInfoEntity.builder()\n+        .setUser(UserDetails.fromUser(o.getUser()))\n+        .setClientTimeMillis(o.getClientTimeMillis().getTime())\n+        .setServerTimeMillis(o.getServerTimeMillis().map(Date::getTime).orElse(null))\n+        .build();\n+  }\n+\n+  public static AuditInfo toObject(AuditInfoEntity e) {\n+    return AuditInfo.builder()\n+        .setUser(UserDetails.toUser(e.getUser()))\n+        .setClientTimeMillis(new Date(e.getClientTimeMillis()))\n+        .setServerTimeMillis(Optional.ofNullable(e.getServerTimeMillis()).map(Date::new))\n+        .build();\n+  }\n+\n+  // Generated by AutoValue plugin:\n+\n+  @NonNull\n+  public static AuditInfoEntity create(\n+      @NonNull UserDetails user, long clientTimeMillis, @Nullable Long serverTimeMillis) {\n+    return builder()\n+        .setUser(user)\n+        .setClientTimeMillis(clientTimeMillis)\n+        .setServerTimeMillis(serverTimeMillis)\n+        .build();\n+  }\n+\n+  public static Builder builder() {\n+    return new AutoValue_AuditInfoEntity.Builder();\n+  }\n+\n+  @AutoValue.Builder\n+  public abstract static class Builder {\n+\n+    public abstract Builder setUser(UserDetails newUser);\n+\n+    public abstract Builder setClientTimeMillis(@NonNull long newClientTimeMillis);", "originalCommit": "e88c538bebc77526c1a8ee619c9da7bbdad39a5e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDMyOTExNw==", "url": "https://github.com/google/ground-android/pull/293#discussion_r364329117", "bodyText": "We generally use long for non-nulls, so wasn't sure which convention to be consistent with :). In doubt, pushed a commit to switch to Long.", "author": "gino-m", "createdAt": "2020-01-08T16:39:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDIyMzQ1MQ=="}], "type": "inlineReview", "revised_code": {"commit": "419ea65d1ed116cc61baf84355259bdb0f953e31", "chunk": "diff --git a/gnd/src/main/java/com/google/android/gnd/persistence/local/room/AuditInfoEntity.java b/gnd/src/main/java/com/google/android/gnd/persistence/local/room/AuditInfoEntity.java\nindex f9afa901..da4ef6f5 100644\n--- a/gnd/src/main/java/com/google/android/gnd/persistence/local/room/AuditInfoEntity.java\n+++ b/gnd/src/main/java/com/google/android/gnd/persistence/local/room/AuditInfoEntity.java\n\n@@ -40,7 +40,8 @@ public abstract class AuditInfoEntity {\n \n   /** Returns the time at which the user action was initiated, according to the user's device. */\n   @CopyAnnotations\n-  public abstract long getClientTimeMillis();\n+  @NonNull\n+  public abstract Long getClientTimeMillis();\n \n   /**\n    * Returns the time at which the server received the requested change according to the server's\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDI0ODE1MA==", "url": "https://github.com/google/ground-android/pull/293#discussion_r364248150", "bodyText": "Would this trigger even when the user is found, since it is within doOnComplete?", "author": "shobhitagarwal1612", "createdAt": "2020-01-08T14:08:48Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/local/room/RoomLocalDataStore.java", "diffHunk": "@@ -298,22 +299,68 @@ public Completable mergeObservation(Observation observation) {\n     ObservationEntity observationEntity = ObservationEntity.fromObservation(observation);\n     return observationMutationDao\n         .findByObservationId(observation.getId())\n-        .map(observationEntity::applyMutations)\n-        .flatMapCompletable(observationDao::insertOrUpdate)\n+        .flatMapCompletable(mutations -> mergeObservation(observationEntity, mutations));\n+  }\n+\n+  private Completable mergeObservation(\n+      ObservationEntity observation, List<ObservationMutationEntity> mutations) {\n+    if (mutations.isEmpty()) {\n+      return Completable.complete();\n+    }\n+    ObservationMutationEntity lastMutation = mutations.get(mutations.size() - 1);\n+    return loadUser(lastMutation.getUserId())\n+        .map(user -> applyMutations(observation, mutations, user))\n+        .flatMapCompletable(obs -> observationDao.insertOrUpdate(obs).subscribeOn(Schedulers.io()));\n+  }\n+\n+  private ObservationEntity applyMutations(\n+      ObservationEntity observation, List<ObservationMutationEntity> mutations, User user) {\n+    ObservationMutationEntity lastMutation = mutations.get(mutations.size() - 1);\n+    long clientTimestamp = lastMutation.getClientTimestamp();\n+    Log.v(TAG, \"Merging observation \" + this + \" with mutations \" + mutations);\n+    ObservationEntity.Builder builder = observation.toBuilder();\n+    // Merge changes to responses.\n+    for (ObservationMutationEntity mutation : mutations) {\n+      builder.applyMutation(mutation);\n+    }\n+    // Update modified user and time.\n+    AuditInfoEntity lastModified =\n+        AuditInfoEntity.builder()\n+            .setUser(UserDetails.fromUser(user))\n+            .setClientTimeMillis(clientTimestamp)\n+            .build();\n+    builder.setLastModified(lastModified);\n+    Log.v(TAG, \"Merged observation \" + builder.build());\n+    return builder.build();\n+  }\n+\n+  @Override\n+  public Single<User> loadUser(String id) {\n+    return userDao\n+        .findById(id)\n+        .doOnComplete(() -> Log.e(TAG, \"User missing local db: \" + id))", "originalCommit": "e88c538bebc77526c1a8ee619c9da7bbdad39a5e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDMyMzQ2MA==", "url": "https://github.com/google/ground-android/pull/293#discussion_r364323460", "bodyText": "You have an impeccable eye for detail! It should have been doOnError Fixed.\nAdded some follow-up TODOs in the description of #15.", "author": "gino-m", "createdAt": "2020-01-08T16:29:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDI0ODE1MA=="}], "type": "inlineReview", "revised_code": {"commit": "14efdf78a6586f0ade796d424b11d31aa55f3dd2", "chunk": "diff --git a/gnd/src/main/java/com/google/android/gnd/persistence/local/room/RoomLocalDataStore.java b/gnd/src/main/java/com/google/android/gnd/persistence/local/room/RoomLocalDataStore.java\nindex b4d7926a..0e0c1893 100644\n--- a/gnd/src/main/java/com/google/android/gnd/persistence/local/room/RoomLocalDataStore.java\n+++ b/gnd/src/main/java/com/google/android/gnd/persistence/local/room/RoomLocalDataStore.java\n\n@@ -338,7 +338,7 @@ public class RoomLocalDataStore implements LocalDataStore {\n   public Single<User> loadUser(String id) {\n     return userDao\n         .findById(id)\n-        .doOnComplete(() -> Log.e(TAG, \"User missing local db: \" + id))\n+        .doOnError(e -> Log.e(TAG, \"Error loading user from local db: \" + id, e))\n         // Fail with NoSuchElementException if not found.\n         .toSingle()\n         .map(UserEntity::toUser)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDI1NDg4Ng==", "url": "https://github.com/google/ground-android/pull/293#discussion_r364254886", "bodyText": "Instead of passing userId, can we pass User object instead? The reason is so that we don't have to load User again from the id in RoomLocalDataStore\nSee usages of loadUser in RoomLocalDataStore", "author": "shobhitagarwal1612", "createdAt": "2020-01-08T14:23:01Z", "path": "gnd/src/main/java/com/google/android/gnd/model/Mutation.java", "diffHunk": "@@ -86,7 +91,9 @@ public String toString() {\n \n     public abstract T setProjectId(String newProjectId);\n \n-    public abstract T setUserId(String newUserId);\n+    public abstract T setUserId(@Nullable String newUserId);", "originalCommit": "e88c538bebc77526c1a8ee619c9da7bbdad39a5e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDI1OTgyNA==", "url": "https://github.com/google/ground-android/pull/293#discussion_r364259824", "bodyText": "But that would require adding *MutationEntityRelations to fetch User when loading from local db.", "author": "shobhitagarwal1612", "createdAt": "2020-01-08T14:33:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDI1NDg4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDMyNzEyMA==", "url": "https://github.com/google/ground-android/pull/293#discussion_r364327120", "bodyText": "That would push the loading of the User to the time of loading Mutations, which at DB level would mean either loading each User individually, or doing a join to fetch them together. Loading them individually isn't a big deal since they're small, there will be few of them (max 2?) and the db is practically in memory. If we go that route, I think doing a query to fill them in the persistence later is more discoverable than using MutationEntityRelations.\nFiled #301 to revisit this.", "author": "gino-m", "createdAt": "2020-01-08T16:35:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDI1NDg4Ng=="}], "type": "inlineReview", "revised_code": null}, {"oid": "ddd677cb4258a0ff44b14897aec93f7a4482b7f5", "url": "https://github.com/google/ground-android/commit/ddd677cb4258a0ff44b14897aec93f7a4482b7f5", "message": "Eliminate ANONYMOUS user constant", "committedDate": "2020-01-08T16:21:39Z", "type": "commit"}, {"oid": "14efdf78a6586f0ade796d424b11d31aa55f3dd2", "url": "https://github.com/google/ground-android/commit/14efdf78a6586f0ade796d424b11d31aa55f3dd2", "message": "Log errors when loading user from local", "committedDate": "2020-01-08T16:29:25Z", "type": "commit"}, {"oid": "419ea65d1ed116cc61baf84355259bdb0f953e31", "url": "https://github.com/google/ground-android/commit/419ea65d1ed116cc61baf84355259bdb0f953e31", "message": "Use Long for consistency", "committedDate": "2020-01-08T16:39:44Z", "type": "commit"}, {"oid": "9e6bb3406eb6d64fae064257f8e7c58b9feb920d", "url": "https://github.com/google/ground-android/commit/9e6bb3406eb6d64fae064257f8e7c58b9feb920d", "message": "Add missing copyright", "committedDate": "2020-01-08T16:41:30Z", "type": "commit"}, {"oid": "fc814c9f203f2992536774471e68081c5459a510", "url": "https://github.com/google/ground-android/commit/fc814c9f203f2992536774471e68081c5459a510", "message": "Reorder imports", "committedDate": "2020-01-08T16:41:51Z", "type": "commit"}, {"oid": "74be1c8e646a6fc906eb6fc720c7ac39248259ba", "url": "https://github.com/google/ground-android/commit/74be1c8e646a6fc906eb6fc720c7ac39248259ba", "message": "Fix PMD warnings", "committedDate": "2020-01-08T16:46:48Z", "type": "commit"}, {"oid": "568d2460c6f6bb2de7cd356a2d230cbb9aba1d9c", "url": "https://github.com/google/ground-android/commit/568d2460c6f6bb2de7cd356a2d230cbb9aba1d9c", "message": "Fix broken tests", "committedDate": "2020-01-08T19:39:11Z", "type": "commit"}, {"oid": "045643e7279eeb15f8e05bc8a05a70cd844b2fc9", "url": "https://github.com/google/ground-android/commit/045643e7279eeb15f8e05bc8a05a70cd844b2fc9", "message": "Merge branch 'master' into save-user", "committedDate": "2020-01-09T02:04:31Z", "type": "commit"}]}