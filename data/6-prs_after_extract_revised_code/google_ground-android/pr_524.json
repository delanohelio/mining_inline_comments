{"pr_number": 524, "pr_title": "Refactor ObservationRepository", "pr_createdAt": "2020-07-06T06:38:56Z", "pr_url": "https://github.com/google/ground-android/pull/524", "timeline": [{"oid": "500a2b51ee5cdd2578c5edced057136057a1c1c9", "url": "https://github.com/google/ground-android/commit/500a2b51ee5cdd2578c5edced057136057a1c1c9", "message": "Replace log -> timber", "committedDate": "2020-07-06T05:46:59Z", "type": "commit"}, {"oid": "c5619a91501624758471e1583162538df2da7a32", "url": "https://github.com/google/ground-android/commit/c5619a91501624758471e1583162538df2da7a32", "message": "Add method to add observation mutation in ObservationRepository", "committedDate": "2020-07-06T06:28:50Z", "type": "commit"}, {"oid": "7069b638f84d9aa3121177e4dc1748bcfb61140a", "url": "https://github.com/google/ground-android/commit/7069b638f84d9aa3121177e4dc1748bcfb61140a", "message": "Remove annotation Singleton\n\nWe are not initializing anything except injecting a bunch of more dependencies. So, maintaining a singleton doesn't provide any benefits and it's better to free memory.", "committedDate": "2020-07-06T06:30:56Z", "type": "commit"}, {"oid": "cda60a1eee89dc8446bb8bdc1b5013fd24ae1912", "url": "https://github.com/google/ground-android/commit/cda60a1eee89dc8446bb8bdc1b5013fd24ae1912", "message": "Simplify EditObservationViewModel", "committedDate": "2020-07-06T06:32:32Z", "type": "commit"}, {"oid": "b58b5aba771579bec909844ab9c0c420fa2ba201", "url": "https://github.com/google/ground-android/commit/b58b5aba771579bec909844ab9c0c420fa2ba201", "message": "Merge branch 'master' into cleanup2", "committedDate": "2020-07-06T06:43:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDE0ODY4Mw==", "url": "https://github.com/google/ground-android/pull/524#discussion_r450148683", "bodyText": "Just an observation, the viewmodel's saveProgressVisibility property could be refactored to isSaving and the visibility logic could then be handled in the layout XML using databinding e.g. android:visibility=\"@{viewmodel.isSaving ? View.VISIBLE : View.GONE}\"", "author": "dturner", "createdAt": "2020-07-06T11:07:47Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/editobservation/EditObservationViewModel.java", "diffHunk": "@@ -303,21 +293,13 @@ private void onObservationLoaded(Observation observation) {\n   }\n \n   private Single<Event<SaveResult>> save() {\n-    savingProgressVisibility.setValue(View.VISIBLE);\n-    ObservationMutation observationMutation =\n-        ObservationMutation.builder()\n-            .setType(isNew ? ObservationMutation.Type.CREATE : ObservationMutation.Type.UPDATE)\n-            .setProjectId(originalObservation.getProject().getId())\n-            .setFeatureId(originalObservation.getFeature().getId())\n-            .setLayerId(originalObservation.getFeature().getLayer().getId())\n-            .setObservationId(originalObservation.getId())\n-            .setFormId(originalObservation.getForm().getId())\n-            .setResponseDeltas(getResponseDeltas())\n-            .setClientTimestamp(new Date())\n-            .setUserId(authManager.getCurrentUser().getId())\n-            .build();\n+    if (originalObservation == null) {\n+      return Single.error(new IllegalStateException(\"Observation is null\"));\n+    }\n+\n     return observationRepository\n-        .applyAndEnqueue(observationMutation)\n+        .addObservationMutation(originalObservation, getResponseDeltas(), isNew)\n+        .doOnSubscribe(disposable -> savingProgressVisibility.setValue(View.VISIBLE))", "originalCommit": "b58b5aba771579bec909844ab9c0c420fa2ba201", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDE1Njg3Nw==", "url": "https://github.com/google/ground-android/pull/524#discussion_r450156877", "bodyText": "Thanks for the comment! We are already using databinding for toggling the visibility. The only difference is, currently the binded object is an integer type whose value is equal to one of the visibility values. And in this scenario, we would use a boolean type instead with the suggested refactor. Any particular reason for using boolean over integer type?", "author": "shobhitagarwal1612", "createdAt": "2020-07-06T11:26:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDE0ODY4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDE2NDE5Mg==", "url": "https://github.com/google/ground-android/pull/524#discussion_r450164192", "bodyText": "Yeah, it's really only a minor thing. The reason for using boolean over integer is that it represents the 2 saving states: \"saving\" and \"not saving\".\nCurrently the savingProgressVisibility integer maps to the 3 possible visibility states: visible, invisible and gone. We don't seem to use \"invisible\" so refactoring to isSaving.setValue(true) makes the code (albeit only slightly) more readable.", "author": "dturner", "createdAt": "2020-07-06T11:42:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDE0ODY4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDE2NTc3OA==", "url": "https://github.com/google/ground-android/pull/524#discussion_r450165778", "bodyText": "I did the refactor on ObservationListViewModel - see what you think :) https://github.com/shobhitagarwal1612/ground-android/pull/1/files", "author": "dturner", "createdAt": "2020-07-06T11:45:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDE0ODY4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDE2ODA0Nw==", "url": "https://github.com/google/ground-android/pull/524#discussion_r450168047", "bodyText": "I like this better. Thanks for the suggestion!\nWould you like to open a PR with the proposed changes? If not, then I'd be more than happy to do it on your behalf. \ud83d\ude04", "author": "shobhitagarwal1612", "createdAt": "2020-07-06T11:50:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDE0ODY4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDE5OTE0Nw==", "url": "https://github.com/google/ground-android/pull/524#discussion_r450199147", "bodyText": "I'm happy to do it. Will do shortly.", "author": "dturner", "createdAt": "2020-07-06T12:52:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDE0ODY4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDI2MDIyMQ==", "url": "https://github.com/google/ground-android/pull/524#discussion_r450260221", "bodyText": "#529", "author": "dturner", "createdAt": "2020-07-06T14:28:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDE0ODY4Mw=="}], "type": "inlineReview", "revised_code": null}]}