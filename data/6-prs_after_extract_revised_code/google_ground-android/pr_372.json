{"pr_number": 372, "pr_title": "[Map] Use custom Ground marker for point features", "pr_createdAt": "2020-02-18T04:04:43Z", "pr_url": "https://github.com/google/ground-android/pull/372", "timeline": [{"oid": "c61e03de3e623c2494f393f9fe336ce45d99ab1c", "url": "https://github.com/google/ground-android/commit/c61e03de3e623c2494f393f9fe336ce45d99ab1c", "message": "Build marker bitmap out of vector components", "committedDate": "2020-02-18T04:00:43Z", "type": "commit"}, {"oid": "e653d1a548e41dba4076ddf09f9881ce3f7dce4f", "url": "https://github.com/google/ground-android/commit/e653d1a548e41dba4076ddf09f9881ce3f7dce4f", "message": "Replace commented out code with TODO", "committedDate": "2020-02-18T04:08:28Z", "type": "commit"}, {"oid": "5b9ad1af89ae5e3e68e916c2606abb198c926f69", "url": "https://github.com/google/ground-android/commit/5b9ad1af89ae5e3e68e916c2606abb198c926f69", "message": "Merge branch 'master' into new-map-marker", "committedDate": "2020-02-18T17:58:20Z", "type": "commit"}, {"oid": "f4d1540b6c6d003af80c7c911223fd20724ce328", "url": "https://github.com/google/ground-android/commit/f4d1540b6c6d003af80c7c911223fd20724ce328", "message": "Fix path of includes in base checkstyle config", "committedDate": "2020-02-18T18:56:52Z", "type": "commit"}, {"oid": "5584ccdc8b7949ac5a6f83eaf4701f034f167c5f", "url": "https://github.com/google/ground-android/commit/5584ccdc8b7949ac5a6f83eaf4701f034f167c5f", "message": "Fix header and rearrange ic_marker_fill", "committedDate": "2020-02-19T10:37:48Z", "type": "commit"}, {"oid": "d5d2778d59aa786c78242ba9d46a2cea80b62ee3", "url": "https://github.com/google/ground-android/commit/d5d2778d59aa786c78242ba9d46a2cea80b62ee3", "message": "Fix header and rearrange ic_marker_outline", "committedDate": "2020-02-19T10:38:40Z", "type": "commit"}, {"oid": "bc51f47580dd65fd1995b4d86ee47805fab0d0af", "url": "https://github.com/google/ground-android/commit/bc51f47580dd65fd1995b4d86ee47805fab0d0af", "message": "Fix header and rearrange ic_marker_overlay", "committedDate": "2020-02-19T10:39:13Z", "type": "commit"}, {"oid": "954d88cbf6be49130cb85b9ccbbcb88f9aa42747", "url": "https://github.com/google/ground-android/commit/954d88cbf6be49130cb85b9ccbbcb88f9aa42747", "message": "Fix checkstyle header template path", "committedDate": "2020-02-19T10:39:51Z", "type": "commit"}, {"oid": "f5cb855ad0b9809ac83b181892f7f613bb23a162", "url": "https://github.com/google/ground-android/commit/f5cb855ad0b9809ac83b181892f7f613bb23a162", "message": "Fix checkstyle header template path", "committedDate": "2020-02-19T10:40:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTIzNDk1Mw==", "url": "https://github.com/google/ground-android/pull/372#discussion_r381234953", "bodyText": "In addition, let's log an error as well to keep track of such events.", "author": "shobhitagarwal1612", "createdAt": "2020-02-19T11:30:24Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/MapIcon.java", "diffHunk": "@@ -17,80 +17,54 @@\n package com.google.android.gnd.ui;\n \n import android.content.Context;\n-import android.content.res.Resources;\n import android.graphics.Bitmap;\n+import android.graphics.Canvas;\n import android.graphics.Color;\n-import android.graphics.drawable.BitmapDrawable;\n-import android.util.Log;\n-import androidx.annotation.DrawableRes;\n-import androidx.annotation.NonNull;\n+import android.graphics.PorterDuff;\n+import android.graphics.drawable.Drawable;\n import androidx.annotation.Nullable;\n-import androidx.core.content.ContextCompat;\n+import androidx.appcompat.content.res.AppCompatResources;\n import com.google.android.gms.maps.model.BitmapDescriptor;\n import com.google.android.gms.maps.model.BitmapDescriptorFactory;\n import com.google.android.gnd.R;\n-import com.google.android.gnd.ui.util.ViewUtil;\n \n // TODO: Move to common, rename Marker.\n public class MapIcon {\n-  private static final String TAG = MapIcon.class.getSimpleName();\n   private final Context context;\n-  private BitmapDrawable drawable;\n-  private int color;\n+  private final int color;\n \n-  public MapIcon(Context context, @Nullable String iconId, @Nullable String color) {\n+  public MapIcon(Context context, @Nullable String colorHexCode) {\n     this.context = context;\n-    this.color = getIconColor(context, color);\n-    int resourceId = getResourceId(context, iconId);\n-    this.drawable = (BitmapDrawable) ContextCompat.getDrawable(context, resourceId);\n+    this.color = getIconColor(context, colorHexCode);\n   }\n \n-  private static int getIconColor(Context context, String color) {\n-    try {\n-      return Color.parseColor(color);\n-    } catch (Exception e) {\n-      return context.getResources().getColor(R.color.colorMapAccent);\n-    }\n+  public BitmapDescriptor getBitmap() {\n+    Drawable outline = AppCompatResources.getDrawable(context, R.drawable.ic_marker_outline);\n+    Drawable fill = AppCompatResources.getDrawable(context, R.drawable.ic_marker_fill);\n+    Drawable overlay = AppCompatResources.getDrawable(context, R.drawable.ic_marker_overlay);\n+    // TODO: Define scale in resources.\n+    // TODO: Adjust size based on zoom level and selection state.\n+    float scale = 1.8f;\n+    int width = (int) (outline.getIntrinsicWidth() * scale);\n+    int height = (int) (outline.getIntrinsicHeight() * scale);\n+    Bitmap bitmap = Bitmap.createBitmap(width, height, Bitmap.Config.ARGB_8888);\n+    Canvas canvas = new Canvas(bitmap);\n+    outline.setBounds(0, 0, width, height);\n+    outline.draw(canvas);\n+    fill.setColorFilter(color, PorterDuff.Mode.SRC_ATOP);\n+    fill.setBounds(0, 0, width, height);\n+    fill.draw(canvas);\n+    overlay.setBounds(0, 0, width, height);\n+    overlay.draw(canvas);\n+    // TODO: Cache rendered bitmaps.\n+    return BitmapDescriptorFactory.fromBitmap(bitmap);\n   }\n \n-  @NonNull\n-  public static @DrawableRes int getResourceId(Context context, @Nullable String iconId) {\n-    if (iconId == null) {\n-      return R.drawable.ic_default_map_marker;\n-    }\n+  private static int getIconColor(Context context, String colorHexCode) {\n     try {\n-      String resourceName = \"ic_marker_\" + iconId.replace(\"-\", \"_\");\n-      int resourceId =\n-          context.getResources().getIdentifier(resourceName, \"drawable\", context.getPackageName());\n-      if (resourceId > 0) {\n-        return resourceId;\n-      }\n-    } catch (Resources.NotFoundException e) {\n-      Log.w(TAG, e);\n+      return Color.parseColor(colorHexCode);\n+    } catch (IllegalArgumentException e) {\n+      return context.getResources().getColor(R.color.colorMapAccent);", "originalCommit": "f5cb855ad0b9809ac83b181892f7f613bb23a162", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTMzNzI3MQ==", "url": "https://github.com/google/ground-android/pull/372#discussion_r381337271", "bodyText": "Good idea! In the process I've done a little more cleanup that I'd probably never get back to otherwise: 50049aa", "author": "gino-m", "createdAt": "2020-02-19T14:46:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTIzNDk1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzExNDQ1Ng==", "url": "https://github.com/google/ground-android/pull/372#discussion_r383114456", "bodyText": "Thanks!", "author": "shobhitagarwal1612", "createdAt": "2020-02-24T07:37:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTIzNDk1Mw=="}], "type": "inlineReview", "revised_code": {"commit": "50049aaea418d44ff6c3fb78d584947b4acb2174", "chunk": "diff --git a/gnd/src/main/java/com/google/android/gnd/ui/MapIcon.java b/gnd/src/main/java/com/google/android/gnd/ui/MarkerIconFactory.java\nsimilarity index 78%\nrename from gnd/src/main/java/com/google/android/gnd/ui/MapIcon.java\nrename to gnd/src/main/java/com/google/android/gnd/ui/MarkerIconFactory.java\nindex 1722b3c6..dab5ccba 100644\n--- a/gnd/src/main/java/com/google/android/gnd/ui/MapIcon.java\n+++ b/gnd/src/main/java/com/google/android/gnd/ui/MarkerIconFactory.java\n\n@@ -19,26 +19,25 @@ package com.google.android.gnd.ui;\n import android.content.Context;\n import android.graphics.Bitmap;\n import android.graphics.Canvas;\n-import android.graphics.Color;\n import android.graphics.PorterDuff;\n import android.graphics.drawable.Drawable;\n-import androidx.annotation.Nullable;\n import androidx.appcompat.content.res.AppCompatResources;\n import com.google.android.gms.maps.model.BitmapDescriptor;\n import com.google.android.gms.maps.model.BitmapDescriptorFactory;\n import com.google.android.gnd.R;\n+import javax.inject.Inject;\n+import javax.inject.Singleton;\n \n-// TODO: Move to common, rename Marker.\n-public class MapIcon {\n+@Singleton\n+public class MarkerIconFactory {\n   private final Context context;\n-  private final int color;\n \n-  public MapIcon(Context context, @Nullable String colorHexCode) {\n+  @Inject\n+  public MarkerIconFactory(Context context) {\n     this.context = context;\n-    this.color = getIconColor(context, colorHexCode);\n   }\n \n-  public BitmapDescriptor getBitmap() {\n+  public BitmapDescriptor getMarkerIcon(int color) {\n     Drawable outline = AppCompatResources.getDrawable(context, R.drawable.ic_marker_outline);\n     Drawable fill = AppCompatResources.getDrawable(context, R.drawable.ic_marker_fill);\n     Drawable overlay = AppCompatResources.getDrawable(context, R.drawable.ic_marker_overlay);\n"}}, {"oid": "50049aaea418d44ff6c3fb78d584947b4acb2174", "url": "https://github.com/google/ground-android/commit/50049aaea418d44ff6c3fb78d584947b4acb2174", "message": "Turn MapIcon into MapMarkerFactory and inject", "committedDate": "2020-02-19T14:46:02Z", "type": "commit"}, {"oid": "954eadba425adcfac0948ea17f5e95fd06c213e9", "url": "https://github.com/google/ground-android/commit/954eadba425adcfac0948ea17f5e95fd06c213e9", "message": "Merge branch 'master' into new-map-marker", "committedDate": "2020-02-19T14:46:45Z", "type": "commit"}, {"oid": "c64382627b337ebf0547065b61287803e377ae55", "url": "https://github.com/google/ground-android/commit/c64382627b337ebf0547065b61287803e377ae55", "message": "Enable legacy support vector drawables", "committedDate": "2020-02-19T14:54:02Z", "type": "commit"}, {"oid": "be7c7c5e853217baa86726fc31272dd32ce52e93", "url": "https://github.com/google/ground-android/commit/be7c7c5e853217baa86726fc31272dd32ce52e93", "message": "Merge branch 'master' into new-map-marker", "committedDate": "2020-02-24T07:39:02Z", "type": "commit"}, {"oid": "503ba81f1231e2dde2eef9cc25cb94aad9f5f22e", "url": "https://github.com/google/ground-android/commit/503ba81f1231e2dde2eef9cc25cb94aad9f5f22e", "message": "Use srcCompat for vector images", "committedDate": "2020-02-24T16:27:02Z", "type": "commit"}]}