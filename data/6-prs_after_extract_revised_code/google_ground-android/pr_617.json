{"pr_number": 617, "pr_title": "Adding NullAway plugin for checking null handling", "pr_createdAt": "2020-11-03T23:33:15Z", "pr_url": "https://github.com/google/ground-android/pull/617", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI0NTg0NQ==", "url": "https://github.com/google/ground-android/pull/617#discussion_r517245845", "bodyText": "Can we use Guava's checkNotNull instead? It can be statically imported from Preconditions.", "author": "gino-m", "createdAt": "2020-11-04T10:32:09Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/editobservation/EditObservationFragment.java", "diffHunk": "@@ -211,7 +209,13 @@ private void observeMultipleChoiceClicks(MultipleChoiceFieldViewModel viewModel)\n \n   private void onShowDialog(\n       Field field, Optional<Response> currentResponse, Consumer<Optional<Response>> consumer) {\n-    Cardinality cardinality = field.getMultipleChoice().getCardinality();\n+\n+    MultipleChoice multipleChoice = field.getMultipleChoice();\n+    if (multipleChoice == null){", "originalCommit": "5826b57ba4169a7c6ac5a6365f9f05072ef7240e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODY5NjIyNg==", "url": "https://github.com/google/ground-android/pull/617#discussion_r518696226", "bodyText": "Great suggestion. Replaced if (x == null){ throw NPE(message); } with Preconditions.checkNotNull(x, message) here and throughout.", "author": "dturner", "createdAt": "2020-11-06T11:37:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI0NTg0NQ=="}], "type": "inlineReview", "revised_code": {"commit": "07bdfe9d2afb31bd16cd9af49bb6677c5e872fb6", "chunk": "diff --git a/gnd/src/main/java/com/google/android/gnd/ui/editobservation/EditObservationFragment.java b/gnd/src/main/java/com/google/android/gnd/ui/editobservation/EditObservationFragment.java\nindex a31b543f..619bf209 100644\n--- a/gnd/src/main/java/com/google/android/gnd/ui/editobservation/EditObservationFragment.java\n+++ b/gnd/src/main/java/com/google/android/gnd/ui/editobservation/EditObservationFragment.java\n\n@@ -211,10 +212,8 @@ public class EditObservationFragment extends AbstractFragment implements BackPre\n       Field field, Optional<Response> currentResponse, Consumer<Optional<Response>> consumer) {\n \n     MultipleChoice multipleChoice = field.getMultipleChoice();\n-    if (multipleChoice == null){\n-      throw new NullPointerException(\n-          \"Field must have a non-null MultipleChoice\");\n-    }\n+    Preconditions.checkNotNull(multipleChoice,\n+        \"Field must have a non-null MultipleChoice\");\n     Cardinality cardinality = multipleChoice.getCardinality();\n     switch (cardinality) {\n       case SELECT_MULTIPLE:\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI0NjUyMg==", "url": "https://github.com/google/ground-android/pull/617#discussion_r517246522", "bodyText": "Alternatively:\nreturn Optional.fromNullable(originalObservation).map(o -> o.getResponses().getResponse(fieldId));", "author": "gino-m", "createdAt": "2020-11-04T10:33:17Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/editobservation/EditObservationViewModel.java", "diffHunk": "@@ -149,7 +150,11 @@ void initialize(EditObservationFragmentArgs args) {\n \n   Optional<Response> getSavedOrOriginalResponse(String fieldId) {\n     if (responses.isEmpty()) {\n-      return originalObservation.getResponses().getResponse(fieldId);\n+      if (originalObservation == null){", "originalCommit": "5826b57ba4169a7c6ac5a6365f9f05072ef7240e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODcwNjkyOA==", "url": "https://github.com/google/ground-android/pull/617#discussion_r518706928", "bodyText": "I don't think this works because when originalObservation is null an Optional<Observation> would be returned rather than the required Optional<Response>.", "author": "dturner", "createdAt": "2020-11-06T11:59:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI0NjUyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODcyMzQzNw==", "url": "https://github.com/google/ground-android/pull/617#discussion_r518723437", "bodyText": "Out of curiosity, have you tried and it doesn't compile? When originalObservation is null, Optional.fromNullable(originalObservation) will be Optional.empty(). I think the generic closure is inferred from the type returned by the lambda in map().", "author": "gino-m", "createdAt": "2020-11-06T12:35:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI0NjUyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODc2MzIwNA==", "url": "https://github.com/google/ground-android/pull/617#discussion_r518763204", "bodyText": "I tried it and it doesn't compile.", "author": "dturner", "createdAt": "2020-11-06T13:50:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI0NjUyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODc3MDc3Ng==", "url": "https://github.com/google/ground-android/pull/617#discussion_r518770776", "bodyText": "Ok, thanks for checking!", "author": "gino-m", "createdAt": "2020-11-06T14:03:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI0NjUyMg=="}], "type": "inlineReview", "revised_code": {"commit": "4266bc0de17bbeb526fb088d47942fd61fecf4cb", "chunk": "diff --git a/gnd/src/main/java/com/google/android/gnd/ui/editobservation/EditObservationViewModel.java b/gnd/src/main/java/com/google/android/gnd/ui/editobservation/EditObservationViewModel.java\nindex 4cfaf456..8949aacd 100644\n--- a/gnd/src/main/java/com/google/android/gnd/ui/editobservation/EditObservationViewModel.java\n+++ b/gnd/src/main/java/com/google/android/gnd/ui/editobservation/EditObservationViewModel.java\n\n@@ -150,7 +138,7 @@ public class EditObservationViewModel extends AbstractViewModel {\n \n   Optional<Response> getSavedOrOriginalResponse(String fieldId) {\n     if (responses.isEmpty()) {\n-      if (originalObservation == null){\n+      if (originalObservation == null) {\n         return Optional.empty();\n       } else {\n         return originalObservation.getResponses().getResponse(fieldId);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI0Njg1OQ==", "url": "https://github.com/google/ground-android/pull/617#discussion_r517246859", "bodyText": "Please run formatter to harmonize formatting.", "author": "gino-m", "createdAt": "2020-11-04T10:33:53Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/editobservation/MultipleChoiceFieldLayout.java", "diffHunk": "@@ -53,6 +58,9 @@ protected void onFinishInflate() {\n         .setOnClickListener(\n             v -> {\n               if (editText.isFocused()) {\n+                if (showDialogListener == null){", "originalCommit": "5826b57ba4169a7c6ac5a6365f9f05072ef7240e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "18ecd64317e2ba9cc6a8a41cef05416ebf88c120", "chunk": "diff --git a/gnd/src/main/java/com/google/android/gnd/ui/editobservation/MultipleChoiceFieldLayout.java b/gnd/src/main/java/com/google/android/gnd/ui/editobservation/MultipleChoiceFieldLayout.java\nindex 1b3b2469..a620b95b 100644\n--- a/gnd/src/main/java/com/google/android/gnd/ui/editobservation/MultipleChoiceFieldLayout.java\n+++ b/gnd/src/main/java/com/google/android/gnd/ui/editobservation/MultipleChoiceFieldLayout.java\n\n@@ -58,9 +56,8 @@ public class MultipleChoiceFieldLayout extends FrameLayout {\n         .setOnClickListener(\n             v -> {\n               if (editText.isFocused()) {\n-                if (showDialogListener == null){\n-                  throw new NullPointerException(\"showDialogListener must be not be null\");\n-                }\n+                Preconditions.checkNotNull(showDialogListener,\n+                    \"showDialogListener must be not be null\");\n                 showDialogListener.run();\n               } else {\n                 editText.requestFocus();\n"}}, {"oid": "07bdfe9d2afb31bd16cd9af49bb6677c5e872fb6", "url": "https://github.com/google/ground-android/commit/07bdfe9d2afb31bd16cd9af49bb6677c5e872fb6", "message": "Replace null checks with Preconditions.checkNotNull", "committedDate": "2020-11-06T11:39:15Z", "type": "forcePushed"}, {"oid": "18ecd64317e2ba9cc6a8a41cef05416ebf88c120", "url": "https://github.com/google/ground-android/commit/18ecd64317e2ba9cc6a8a41cef05416ebf88c120", "message": "Disable all ErrorProne checks except NullAway. Add comments", "committedDate": "2020-11-06T12:34:32Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODcyNDQ4Nw==", "url": "https://github.com/google/ground-android/pull/617#discussion_r518724487", "bodyText": "Can we static import Preconditions throughout to make these more inline friendly and reduce line-wrapping?", "author": "gino-m", "createdAt": "2020-11-06T12:37:10Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/local/room/RoomLocalDataStore.java", "diffHunk": "@@ -141,7 +143,8 @@ private Completable insertOrUpdateField(String formId, Element.Type elementType,\n             Observable.just(field)\n                 .filter(__ -> field.getMultipleChoice() != null)\n                 .flatMapCompletable(\n-                    __ -> insertOrUpdateMultipleChoice(field.getId(), field.getMultipleChoice())))\n+                    __ -> insertOrUpdateMultipleChoice(field.getId(),\n+                        Preconditions.checkNotNull(field.getMultipleChoice()))))", "originalCommit": "18ecd64317e2ba9cc6a8a41cef05416ebf88c120", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODcyNTU5Ng==", "url": "https://github.com/google/ground-android/pull/617#discussion_r518725596", "bodyText": "Ah right, sorry I get what you mean now. I'll update throughout.", "author": "dturner", "createdAt": "2020-11-06T12:39:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODcyNDQ4Nw=="}], "type": "inlineReview", "revised_code": {"commit": "b744cbe0445cee44d8b64cdd3ce9536e38652d30", "chunk": "diff --git a/gnd/src/main/java/com/google/android/gnd/persistence/local/room/RoomLocalDataStore.java b/gnd/src/main/java/com/google/android/gnd/persistence/local/room/RoomLocalDataStore.java\nindex a2d9b9be..6fbf5256 100644\n--- a/gnd/src/main/java/com/google/android/gnd/persistence/local/room/RoomLocalDataStore.java\n+++ b/gnd/src/main/java/com/google/android/gnd/persistence/local/room/RoomLocalDataStore.java\n\n@@ -136,6 +136,7 @@ public class RoomLocalDataStore implements LocalDataStore {\n         .subscribeOn(schedulers.io());\n   }\n \n+  @SuppressWarnings(\"NullAway\")\n   private Completable insertOrUpdateField(String formId, Element.Type elementType, Field field) {\n     return fieldDao\n         .insertOrUpdate(FieldEntity.fromField(formId, elementType, field))\n"}}, {"oid": "b744cbe0445cee44d8b64cdd3ce9536e38652d30", "url": "https://github.com/google/ground-android/commit/b744cbe0445cee44d8b64cdd3ce9536e38652d30", "message": "Adding NullAway plugin for checking null handling", "committedDate": "2020-11-12T19:57:30Z", "type": "commit"}, {"oid": "ecf6cebf406fec87ae82ccd1631c62363c8b3140", "url": "https://github.com/google/ground-android/commit/ecf6cebf406fec87ae82ccd1631c62363c8b3140", "message": "Replace null checks with Preconditions.checkNotNull", "committedDate": "2020-11-12T19:59:11Z", "type": "commit"}, {"oid": "e7b92b0411b4e9d3d8ea0b76b37fe51ec26c2d83", "url": "https://github.com/google/ground-android/commit/e7b92b0411b4e9d3d8ea0b76b37fe51ec26c2d83", "message": "Fix formatting and add checkNotNull", "committedDate": "2020-11-12T19:59:13Z", "type": "commit"}, {"oid": "643c14815ca20ea64690be14910d83c314b0c865", "url": "https://github.com/google/ground-android/commit/643c14815ca20ea64690be14910d83c314b0c865", "message": "Disable all ErrorProne checks except NullAway. Add comments", "committedDate": "2020-11-12T19:59:13Z", "type": "commit"}, {"oid": "5cb9dbbf17cfc1483ce14e8a964a90cba0823f46", "url": "https://github.com/google/ground-android/commit/5cb9dbbf17cfc1483ce14e8a964a90cba0823f46", "message": "Attempting to fix javac NPE during cloud build", "committedDate": "2020-11-12T19:59:13Z", "type": "commit"}, {"oid": "53bfbd29bccd5bcdf8f8ebc87271019b9be4982f", "url": "https://github.com/google/ground-android/commit/53bfbd29bccd5bcdf8f8ebc87271019b9be4982f", "message": "Statically import Preconditions.checkNotNull", "committedDate": "2020-11-12T19:59:54Z", "type": "commit"}, {"oid": "c84bfc4f754d6cbcbba18a910ce7547f39a1f46b", "url": "https://github.com/google/ground-android/commit/c84bfc4f754d6cbcbba18a910ce7547f39a1f46b", "message": "Add java version step to cloud config", "committedDate": "2020-11-12T19:59:55Z", "type": "commit"}, {"oid": "016b408c7b50ed7c3fdfa9f9658eee4c2eacc38e", "url": "https://github.com/google/ground-android/commit/016b408c7b50ed7c3fdfa9f9658eee4c2eacc38e", "message": "Moving config", "committedDate": "2020-11-12T19:59:55Z", "type": "commit"}, {"oid": "e4ebee8e26ba78d8857f232babebad183faae346", "url": "https://github.com/google/ground-android/commit/e4ebee8e26ba78d8857f232babebad183faae346", "message": "Fix indentation", "committedDate": "2020-11-12T19:59:55Z", "type": "commit"}, {"oid": "04181c919e0163b2b3216f2b1327b432555e3914", "url": "https://github.com/google/ground-android/commit/04181c919e0163b2b3216f2b1327b432555e3914", "message": "Switch to openjdk in cloud build", "committedDate": "2020-11-12T20:01:24Z", "type": "commit"}, {"oid": "3548a4e39c9825af4ca025ccdcb6d16b6d0b9880", "url": "https://github.com/google/ground-android/commit/3548a4e39c9825af4ca025ccdcb6d16b6d0b9880", "message": "Trying openjdk:8u272-slim", "committedDate": "2020-11-12T20:02:09Z", "type": "commit"}, {"oid": "d4de554e1b3c33caae5907ce45305299131901b4", "url": "https://github.com/google/ground-android/commit/d4de554e1b3c33caae5907ce45305299131901b4", "message": "Use Shobhit's image in cloud build", "committedDate": "2020-11-12T20:02:10Z", "type": "commit"}, {"oid": "4266bc0de17bbeb526fb088d47942fd61fecf4cb", "url": "https://github.com/google/ground-android/commit/4266bc0de17bbeb526fb088d47942fd61fecf4cb", "message": "Fix checkstyle issues", "committedDate": "2020-11-12T20:02:10Z", "type": "commit"}, {"oid": "4266bc0de17bbeb526fb088d47942fd61fecf4cb", "url": "https://github.com/google/ground-android/commit/4266bc0de17bbeb526fb088d47942fd61fecf4cb", "message": "Fix checkstyle issues", "committedDate": "2020-11-12T20:02:10Z", "type": "forcePushed"}, {"oid": "c6bb6965043413230c5238baf1b96ef0418ba995", "url": "https://github.com/google/ground-android/commit/c6bb6965043413230c5238baf1b96ef0418ba995", "message": "Revert changes to cloud build config", "committedDate": "2020-11-12T20:06:45Z", "type": "commit"}, {"oid": "cdb1f01e20cf48a8cd9dbc8f79580436bcbac1ab", "url": "https://github.com/google/ground-android/commit/cdb1f01e20cf48a8cd9dbc8f79580436bcbac1ab", "message": "Fix NullAway error", "committedDate": "2020-11-12T20:32:56Z", "type": "commit"}, {"oid": "d7f05185b00b4120ca057dce1a41bbcde7b7b691", "url": "https://github.com/google/ground-android/commit/d7f05185b00b4120ca057dce1a41bbcde7b7b691", "message": "Fix broken unit tests", "committedDate": "2020-11-12T21:15:19Z", "type": "commit"}, {"oid": "9998dccff6f4d86da86a0ee2d071e5e375eaa3c3", "url": "https://github.com/google/ground-android/commit/9998dccff6f4d86da86a0ee2d071e5e375eaa3c3", "message": "Fix PMD errors", "committedDate": "2020-11-12T21:36:44Z", "type": "commit"}, {"oid": "3a4cbecdca72a9c7cd74f6c5b78138f390df632b", "url": "https://github.com/google/ground-android/commit/3a4cbecdca72a9c7cd74f6c5b78138f390df632b", "message": "Fix (another) failing unit test", "committedDate": "2020-11-12T21:56:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjY2NTc5Mg==", "url": "https://github.com/google/ground-android/pull/617#discussion_r522665792", "bodyText": "We can always use an empty immutable list ImmutableList.of() instead of null. Why @Nullable?", "author": "shobhitagarwal1612", "createdAt": "2020-11-13T05:35:29Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/local/room/RoomLocalDataStore.java", "diffHunk": "@@ -337,11 +340,12 @@ public Completable updateMutations(ImmutableList<Mutation> mutations) {\n   }\n \n   @Override\n-  public Completable finalizePendingMutations(ImmutableList<Mutation> mutations) {\n+  public Completable finalizePendingMutations(@Nullable ImmutableList<Mutation> mutations) {", "originalCommit": "3a4cbecdca72a9c7cd74f6c5b78138f390df632b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjk5MTQzNg==", "url": "https://github.com/google/ground-android/pull/617#discussion_r522991436", "bodyText": "Good idea. I've added a null check inside LocalMutationSyncWorker::processMutations and removed the @Nullable annotation.", "author": "dturner", "createdAt": "2020-11-13T14:39:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjY2NTc5Mg=="}], "type": "inlineReview", "revised_code": null}, {"oid": "631c6d61b484b243cb7e6bbe8ced4c51e7f8ed5b", "url": "https://github.com/google/ground-android/commit/631c6d61b484b243cb7e6bbe8ced4c51e7f8ed5b", "message": "Revert cloud image changes. Address Shobhit's feedback", "committedDate": "2020-11-13T14:37:49Z", "type": "commit"}, {"oid": "b156628706407d50d63ee3b04d95cc0aa1ee2237", "url": "https://github.com/google/ground-android/commit/b156628706407d50d63ee3b04d95cc0aa1ee2237", "message": "Fix checkstyle", "committedDate": "2020-11-16T15:32:08Z", "type": "commit"}, {"oid": "0a14c2b28c352bd19c8aa58aeb6d0aaf384331fd", "url": "https://github.com/google/ground-android/commit/0a14c2b28c352bd19c8aa58aeb6d0aaf384331fd", "message": "Remove unused import", "committedDate": "2020-11-16T16:37:40Z", "type": "commit"}]}