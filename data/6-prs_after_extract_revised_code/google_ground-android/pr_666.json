{"pr_number": 666, "pr_title": "[Feature] Fixes new point can't be added", "pr_createdAt": "2020-12-23T05:23:17Z", "pr_url": "https://github.com/google/ground-android/pull/666", "timeline": [{"oid": "3477afd7f36ee481fdce80a24b96670082efaa84", "url": "https://github.com/google/ground-android/commit/3477afd7f36ee481fdce80a24b96670082efaa84", "message": "Fix new point can't be added bug\n\n - Replace Subject with interface\n - Remove extra Rx call to invoke dialog\n - Remove duplicate null check for project\n - Reuse parameter \"point\" instead of injecting\n - Restrict AddFeatureDialogFragment to only return layer and create feature object in VM", "committedDate": "2020-12-23T05:18:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Nzk4NjA4Mw==", "url": "https://github.com/google/ground-android/pull/666#discussion_r547986083", "bodyText": "@NonNull is the default now, so these annotations can be removed.", "author": "gino-m", "createdAt": "2020-12-23T14:31:04Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/home/AddFeatureDialogFragment.java", "diffHunk": "@@ -21,107 +21,74 @@\n \n import android.app.Dialog;\n import android.os.Bundle;\n+import androidx.annotation.NonNull;\n import androidx.annotation.Nullable;\n import androidx.appcompat.app.AlertDialog;\n import androidx.fragment.app.FragmentManager;\n import com.google.android.gnd.R;\n-import com.google.android.gnd.model.AuditInfo;\n import com.google.android.gnd.model.Project;\n-import com.google.android.gnd.model.feature.Feature;\n-import com.google.android.gnd.model.feature.Point;\n import com.google.android.gnd.model.layer.Layer;\n-import com.google.android.gnd.persistence.uuid.OfflineUuidGenerator;\n-import com.google.android.gnd.rx.Loadable;\n-import com.google.android.gnd.system.auth.AuthenticationManager;\n import com.google.android.gnd.ui.common.AbstractDialogFragment;\n-import com.google.android.gnd.ui.home.mapcontainer.MapContainerViewModel;\n-import com.google.android.gnd.ui.map.CameraPosition;\n import com.google.common.collect.ImmutableList;\n import dagger.hilt.android.AndroidEntryPoint;\n-import io.reactivex.Maybe;\n-import io.reactivex.subjects.MaybeSubject;\n import java8.util.Objects;\n import javax.inject.Inject;\n+import timber.log.Timber;\n \n @AndroidEntryPoint\n public class AddFeatureDialogFragment extends AbstractDialogFragment {\n+\n   private static final String TAG = AddFeatureDialogFragment.class.getSimpleName();\n-  private final OfflineUuidGenerator uuidGenerator;\n-  private final AuthenticationManager authManager;\n \n-  private final MaybeSubject<Feature> addFeatureRequestSubject = MaybeSubject.create();\n-  private HomeScreenViewModel homeScreenViewModel;\n-  private MapContainerViewModel mapContainerViewModel;\n+  @Nullable private Project project;\n+  @Nullable private LayerSelectedListener listener;\n \n   @Inject\n-  public AddFeatureDialogFragment(\n-      OfflineUuidGenerator uuidGenerator, AuthenticationManager authManager) {\n-    this.uuidGenerator = uuidGenerator;\n-    this.authManager = authManager;\n-  }\n-\n-  @Override\n-  public void onCreate(@Nullable Bundle savedInstanceState) {\n-    super.onCreate(savedInstanceState);\n-    // TODO: Move into new AddFeatureDialogViewModel?\n-    this.homeScreenViewModel = getViewModel(HomeScreenViewModel.class);\n-    this.mapContainerViewModel = getViewModel(MapContainerViewModel.class);\n-  }\n+  public AddFeatureDialogFragment() {}\n \n-  public Maybe<Feature> show(FragmentManager fragmentManager) {\n+  public void show(\n+      @NonNull Project project,", "originalCommit": "3477afd7f36ee481fdce80a24b96670082efaa84", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "7a8d2030ca732fd3155b244bc3c331accff707ee", "chunk": "diff --git a/gnd/src/main/java/com/google/android/gnd/ui/home/AddFeatureDialogFragment.java b/gnd/src/main/java/com/google/android/gnd/ui/home/AddFeatureDialogFragment.java\nindex 08d0da29..ce261679 100644\n--- a/gnd/src/main/java/com/google/android/gnd/ui/home/AddFeatureDialogFragment.java\n+++ b/gnd/src/main/java/com/google/android/gnd/ui/home/AddFeatureDialogFragment.java\n\n@@ -21,7 +21,6 @@ import static java8.util.stream.StreamSupport.stream;\n \n import android.app.Dialog;\n import android.os.Bundle;\n-import androidx.annotation.NonNull;\n import androidx.annotation.Nullable;\n import androidx.appcompat.app.AlertDialog;\n import androidx.fragment.app.FragmentManager;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Nzk4NjM2Nw==", "url": "https://github.com/google/ground-android/pull/666#discussion_r547986367", "bodyText": "Same here.", "author": "gino-m", "createdAt": "2020-12-23T14:31:39Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/home/AddFeatureDialogFragment.java", "diffHunk": "@@ -21,107 +21,74 @@\n \n import android.app.Dialog;\n import android.os.Bundle;\n+import androidx.annotation.NonNull;\n import androidx.annotation.Nullable;\n import androidx.appcompat.app.AlertDialog;\n import androidx.fragment.app.FragmentManager;\n import com.google.android.gnd.R;\n-import com.google.android.gnd.model.AuditInfo;\n import com.google.android.gnd.model.Project;\n-import com.google.android.gnd.model.feature.Feature;\n-import com.google.android.gnd.model.feature.Point;\n import com.google.android.gnd.model.layer.Layer;\n-import com.google.android.gnd.persistence.uuid.OfflineUuidGenerator;\n-import com.google.android.gnd.rx.Loadable;\n-import com.google.android.gnd.system.auth.AuthenticationManager;\n import com.google.android.gnd.ui.common.AbstractDialogFragment;\n-import com.google.android.gnd.ui.home.mapcontainer.MapContainerViewModel;\n-import com.google.android.gnd.ui.map.CameraPosition;\n import com.google.common.collect.ImmutableList;\n import dagger.hilt.android.AndroidEntryPoint;\n-import io.reactivex.Maybe;\n-import io.reactivex.subjects.MaybeSubject;\n import java8.util.Objects;\n import javax.inject.Inject;\n+import timber.log.Timber;\n \n @AndroidEntryPoint\n public class AddFeatureDialogFragment extends AbstractDialogFragment {\n+\n   private static final String TAG = AddFeatureDialogFragment.class.getSimpleName();\n-  private final OfflineUuidGenerator uuidGenerator;\n-  private final AuthenticationManager authManager;\n \n-  private final MaybeSubject<Feature> addFeatureRequestSubject = MaybeSubject.create();\n-  private HomeScreenViewModel homeScreenViewModel;\n-  private MapContainerViewModel mapContainerViewModel;\n+  @Nullable private Project project;\n+  @Nullable private LayerSelectedListener listener;\n \n   @Inject\n-  public AddFeatureDialogFragment(\n-      OfflineUuidGenerator uuidGenerator, AuthenticationManager authManager) {\n-    this.uuidGenerator = uuidGenerator;\n-    this.authManager = authManager;\n-  }\n-\n-  @Override\n-  public void onCreate(@Nullable Bundle savedInstanceState) {\n-    super.onCreate(savedInstanceState);\n-    // TODO: Move into new AddFeatureDialogViewModel?\n-    this.homeScreenViewModel = getViewModel(HomeScreenViewModel.class);\n-    this.mapContainerViewModel = getViewModel(MapContainerViewModel.class);\n-  }\n+  public AddFeatureDialogFragment() {}\n \n-  public Maybe<Feature> show(FragmentManager fragmentManager) {\n+  public void show(\n+      @NonNull Project project,\n+      @NonNull FragmentManager fragmentManager,\n+      @NonNull LayerSelectedListener listener) {\n+    this.project = project;\n+    this.listener = listener;\n     show(fragmentManager, TAG);\n-    return addFeatureRequestSubject;\n   }\n \n+  @NonNull", "originalCommit": "3477afd7f36ee481fdce80a24b96670082efaa84", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "7a8d2030ca732fd3155b244bc3c331accff707ee", "chunk": "diff --git a/gnd/src/main/java/com/google/android/gnd/ui/home/AddFeatureDialogFragment.java b/gnd/src/main/java/com/google/android/gnd/ui/home/AddFeatureDialogFragment.java\nindex 08d0da29..ce261679 100644\n--- a/gnd/src/main/java/com/google/android/gnd/ui/home/AddFeatureDialogFragment.java\n+++ b/gnd/src/main/java/com/google/android/gnd/ui/home/AddFeatureDialogFragment.java\n\n@@ -21,7 +21,6 @@ import static java8.util.stream.StreamSupport.stream;\n \n import android.app.Dialog;\n import android.os.Bundle;\n-import androidx.annotation.NonNull;\n import androidx.annotation.Nullable;\n import androidx.appcompat.app.AlertDialog;\n import androidx.fragment.app.FragmentManager;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Nzk5MDEwMQ==", "url": "https://github.com/google/ground-android/pull/666#discussion_r547990101", "bodyText": "Instantiating a new features, assigning UUID and AuditInfo sounds like a job for the FeatureRepository. Can we move this there? (newFeature?)", "author": "gino-m", "createdAt": "2020-12-23T14:40:09Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/home/HomeScreenViewModel.java", "diffHunk": "@@ -148,6 +159,20 @@ public void addFeature(Feature feature) {\n     addFeatureClicks.onNext(feature);\n   }\n \n+  public void addFeature(Project project, Layer layer, Point point) {\n+    AuditInfo auditInfo = AuditInfo.now(authManager.getCurrentUser());\n+    Feature feature =\n+        Feature.newBuilder()\n+            .setId(uuidGenerator.generateUuid())\n+            .setProject(project)\n+            .setLayer(layer)\n+            .setPoint(point)\n+            .setCreated(auditInfo)\n+            .setLastModified(auditInfo)\n+            .build();", "originalCommit": "3477afd7f36ee481fdce80a24b96670082efaa84", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5bf90c07e6408445a4ec4f15b12633ab0b6c7f29", "chunk": "diff --git a/gnd/src/main/java/com/google/android/gnd/ui/home/HomeScreenViewModel.java b/gnd/src/main/java/com/google/android/gnd/ui/home/HomeScreenViewModel.java\nindex 92d84e1f..e6a587fe 100644\n--- a/gnd/src/main/java/com/google/android/gnd/ui/home/HomeScreenViewModel.java\n+++ b/gnd/src/main/java/com/google/android/gnd/ui/home/HomeScreenViewModel.java\n\n@@ -155,22 +148,8 @@ public class HomeScreenViewModel extends AbstractViewModel {\n     return errors;\n   }\n \n-  public void addFeature(Feature feature) {\n-    addFeatureClicks.onNext(feature);\n-  }\n-\n   public void addFeature(Project project, Layer layer, Point point) {\n-    AuditInfo auditInfo = AuditInfo.now(authManager.getCurrentUser());\n-    Feature feature =\n-        Feature.newBuilder()\n-            .setId(uuidGenerator.generateUuid())\n-            .setProject(project)\n-            .setLayer(layer)\n-            .setPoint(point)\n-            .setCreated(auditInfo)\n-            .setLastModified(auditInfo)\n-            .build();\n-    addFeatureClicks.onNext(feature);\n+    addFeatureClicks.onNext(featureRepository.newFeature(project, layer, point));\n   }\n \n   public void updateFeature(Feature feature) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODAwOTI0Ng==", "url": "https://github.com/google/ground-android/pull/666#discussion_r548009246", "bodyText": "The listener reference should be removed to prevent memory leaks when the dialog is closed to prevent memory leaks. @dturner Please cmiiw.", "author": "gino-m", "createdAt": "2020-12-23T15:20:33Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/home/AddFeatureDialogFragment.java", "diffHunk": "@@ -21,107 +21,74 @@\n \n import android.app.Dialog;\n import android.os.Bundle;\n+import androidx.annotation.NonNull;\n import androidx.annotation.Nullable;\n import androidx.appcompat.app.AlertDialog;\n import androidx.fragment.app.FragmentManager;\n import com.google.android.gnd.R;\n-import com.google.android.gnd.model.AuditInfo;\n import com.google.android.gnd.model.Project;\n-import com.google.android.gnd.model.feature.Feature;\n-import com.google.android.gnd.model.feature.Point;\n import com.google.android.gnd.model.layer.Layer;\n-import com.google.android.gnd.persistence.uuid.OfflineUuidGenerator;\n-import com.google.android.gnd.rx.Loadable;\n-import com.google.android.gnd.system.auth.AuthenticationManager;\n import com.google.android.gnd.ui.common.AbstractDialogFragment;\n-import com.google.android.gnd.ui.home.mapcontainer.MapContainerViewModel;\n-import com.google.android.gnd.ui.map.CameraPosition;\n import com.google.common.collect.ImmutableList;\n import dagger.hilt.android.AndroidEntryPoint;\n-import io.reactivex.Maybe;\n-import io.reactivex.subjects.MaybeSubject;\n import java8.util.Objects;\n import javax.inject.Inject;\n+import timber.log.Timber;\n \n @AndroidEntryPoint\n public class AddFeatureDialogFragment extends AbstractDialogFragment {\n+\n   private static final String TAG = AddFeatureDialogFragment.class.getSimpleName();\n-  private final OfflineUuidGenerator uuidGenerator;\n-  private final AuthenticationManager authManager;\n \n-  private final MaybeSubject<Feature> addFeatureRequestSubject = MaybeSubject.create();\n-  private HomeScreenViewModel homeScreenViewModel;\n-  private MapContainerViewModel mapContainerViewModel;\n+  @Nullable private Project project;\n+  @Nullable private LayerSelectedListener listener;\n \n   @Inject\n-  public AddFeatureDialogFragment(\n-      OfflineUuidGenerator uuidGenerator, AuthenticationManager authManager) {\n-    this.uuidGenerator = uuidGenerator;\n-    this.authManager = authManager;\n-  }\n-\n-  @Override\n-  public void onCreate(@Nullable Bundle savedInstanceState) {\n-    super.onCreate(savedInstanceState);\n-    // TODO: Move into new AddFeatureDialogViewModel?\n-    this.homeScreenViewModel = getViewModel(HomeScreenViewModel.class);\n-    this.mapContainerViewModel = getViewModel(MapContainerViewModel.class);\n-  }\n+  public AddFeatureDialogFragment() {}\n \n-  public Maybe<Feature> show(FragmentManager fragmentManager) {\n+  public void show(\n+      @NonNull Project project,\n+      @NonNull FragmentManager fragmentManager,\n+      @NonNull LayerSelectedListener listener) {\n+    this.project = project;\n+    this.listener = listener;", "originalCommit": "3477afd7f36ee481fdce80a24b96670082efaa84", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODM4MzYzMA==", "url": "https://github.com/google/ground-android/pull/666#discussion_r548383630", "bodyText": "Removed the reference on destroy.", "author": "shobhitagarwal1612", "createdAt": "2020-12-24T05:04:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODAwOTI0Ng=="}], "type": "inlineReview", "revised_code": {"commit": "7a8d2030ca732fd3155b244bc3c331accff707ee", "chunk": "diff --git a/gnd/src/main/java/com/google/android/gnd/ui/home/AddFeatureDialogFragment.java b/gnd/src/main/java/com/google/android/gnd/ui/home/AddFeatureDialogFragment.java\nindex 08d0da29..ce261679 100644\n--- a/gnd/src/main/java/com/google/android/gnd/ui/home/AddFeatureDialogFragment.java\n+++ b/gnd/src/main/java/com/google/android/gnd/ui/home/AddFeatureDialogFragment.java\n\n@@ -21,7 +21,6 @@ import static java8.util.stream.StreamSupport.stream;\n \n import android.app.Dialog;\n import android.os.Bundle;\n-import androidx.annotation.NonNull;\n import androidx.annotation.Nullable;\n import androidx.appcompat.app.AlertDialog;\n import androidx.fragment.app.FragmentManager;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODAwOTU5MQ==", "url": "https://github.com/google/ground-android/pull/666#discussion_r548009591", "bodyText": "Instead of defining a custom functional interface, you should be able to use Consumer<Layer>.", "author": "gino-m", "createdAt": "2020-12-23T15:21:15Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/home/AddFeatureDialogFragment.java", "diffHunk": "@@ -21,107 +21,74 @@\n \n import android.app.Dialog;\n import android.os.Bundle;\n+import androidx.annotation.NonNull;\n import androidx.annotation.Nullable;\n import androidx.appcompat.app.AlertDialog;\n import androidx.fragment.app.FragmentManager;\n import com.google.android.gnd.R;\n-import com.google.android.gnd.model.AuditInfo;\n import com.google.android.gnd.model.Project;\n-import com.google.android.gnd.model.feature.Feature;\n-import com.google.android.gnd.model.feature.Point;\n import com.google.android.gnd.model.layer.Layer;\n-import com.google.android.gnd.persistence.uuid.OfflineUuidGenerator;\n-import com.google.android.gnd.rx.Loadable;\n-import com.google.android.gnd.system.auth.AuthenticationManager;\n import com.google.android.gnd.ui.common.AbstractDialogFragment;\n-import com.google.android.gnd.ui.home.mapcontainer.MapContainerViewModel;\n-import com.google.android.gnd.ui.map.CameraPosition;\n import com.google.common.collect.ImmutableList;\n import dagger.hilt.android.AndroidEntryPoint;\n-import io.reactivex.Maybe;\n-import io.reactivex.subjects.MaybeSubject;\n import java8.util.Objects;\n import javax.inject.Inject;\n+import timber.log.Timber;\n \n @AndroidEntryPoint\n public class AddFeatureDialogFragment extends AbstractDialogFragment {\n+\n   private static final String TAG = AddFeatureDialogFragment.class.getSimpleName();\n-  private final OfflineUuidGenerator uuidGenerator;\n-  private final AuthenticationManager authManager;\n \n-  private final MaybeSubject<Feature> addFeatureRequestSubject = MaybeSubject.create();\n-  private HomeScreenViewModel homeScreenViewModel;\n-  private MapContainerViewModel mapContainerViewModel;\n+  @Nullable private Project project;\n+  @Nullable private LayerSelectedListener listener;\n \n   @Inject\n-  public AddFeatureDialogFragment(\n-      OfflineUuidGenerator uuidGenerator, AuthenticationManager authManager) {\n-    this.uuidGenerator = uuidGenerator;\n-    this.authManager = authManager;\n-  }\n-\n-  @Override\n-  public void onCreate(@Nullable Bundle savedInstanceState) {\n-    super.onCreate(savedInstanceState);\n-    // TODO: Move into new AddFeatureDialogViewModel?\n-    this.homeScreenViewModel = getViewModel(HomeScreenViewModel.class);\n-    this.mapContainerViewModel = getViewModel(MapContainerViewModel.class);\n-  }\n+  public AddFeatureDialogFragment() {}\n \n-  public Maybe<Feature> show(FragmentManager fragmentManager) {\n+  public void show(\n+      @NonNull Project project,\n+      @NonNull FragmentManager fragmentManager,\n+      @NonNull LayerSelectedListener listener) {", "originalCommit": "3477afd7f36ee481fdce80a24b96670082efaa84", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "7a8d2030ca732fd3155b244bc3c331accff707ee", "chunk": "diff --git a/gnd/src/main/java/com/google/android/gnd/ui/home/AddFeatureDialogFragment.java b/gnd/src/main/java/com/google/android/gnd/ui/home/AddFeatureDialogFragment.java\nindex 08d0da29..ce261679 100644\n--- a/gnd/src/main/java/com/google/android/gnd/ui/home/AddFeatureDialogFragment.java\n+++ b/gnd/src/main/java/com/google/android/gnd/ui/home/AddFeatureDialogFragment.java\n\n@@ -21,7 +21,6 @@ import static java8.util.stream.StreamSupport.stream;\n \n import android.app.Dialog;\n import android.os.Bundle;\n-import androidx.annotation.NonNull;\n import androidx.annotation.Nullable;\n import androidx.appcompat.app.AlertDialog;\n import androidx.fragment.app.FragmentManager;\n"}}, {"oid": "fadb8d3774e710e59d7ad39a8eadd3b2920c7179", "url": "https://github.com/google/ground-android/commit/fadb8d3774e710e59d7ad39a8eadd3b2920c7179", "message": "Merge branch 'master' into issue#661", "committedDate": "2020-12-23T19:02:20Z", "type": "commit"}, {"oid": "7a8d2030ca732fd3155b244bc3c331accff707ee", "url": "https://github.com/google/ground-android/commit/7a8d2030ca732fd3155b244bc3c331accff707ee", "message": "Remove @NonNull as it is the default", "committedDate": "2020-12-24T04:34:00Z", "type": "commit"}, {"oid": "5bf90c07e6408445a4ec4f15b12633ab0b6c7f29", "url": "https://github.com/google/ground-android/commit/5bf90c07e6408445a4ec4f15b12633ab0b6c7f29", "message": "Move instantiating features to FeatureRepository", "committedDate": "2020-12-24T04:48:16Z", "type": "commit"}, {"oid": "eeb8967e5643372d6c1f9c7c129bb5d77ea783cc", "url": "https://github.com/google/ground-android/commit/eeb8967e5643372d6c1f9c7c129bb5d77ea783cc", "message": "Use Consumer<Layer> and remove references on destroy", "committedDate": "2020-12-24T05:04:10Z", "type": "commit"}, {"oid": "b9378982ce94559723548cd5844974ce70f2cc2a", "url": "https://github.com/google/ground-android/commit/b9378982ce94559723548cd5844974ce70f2cc2a", "message": "Pass layers instead of project and check nullability", "committedDate": "2020-12-24T17:42:16Z", "type": "commit"}, {"oid": "f885df34c51a7957d8d00349c8c2238c592e6003", "url": "https://github.com/google/ground-android/commit/f885df34c51a7957d8d00349c8c2238c592e6003", "message": "Fix tests", "committedDate": "2020-12-24T18:22:12Z", "type": "commit"}, {"oid": "e53f63e3583df8755eb6033dcb26001c35b19956", "url": "https://github.com/google/ground-android/commit/e53f63e3583df8755eb6033dcb26001c35b19956", "message": "Merge branch 'master' into issue#661", "committedDate": "2020-12-26T17:34:19Z", "type": "commit"}]}