{"pr_number": 5975, "pr_title": "Alert API: Bulk Change Confidence or Risk - Fixes 5845", "pr_createdAt": "2020-05-12T02:31:56Z", "pr_url": "https://github.com/zaproxy/zaproxy/pull/5975", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzU5NjcwNw==", "url": "https://github.com/zaproxy/zaproxy/pull/5975#discussion_r423596707", "bodyText": "I'd suggest collect them first to ensure all IDs are valid before starting processing the alerts (while missing alert will also lead to partial updates it's one less thing).\nThis can also be extracted, something like:\nupdateAlerts(alert -> alert.setConfidence(confidenceId));\nand let updateAlerts extract/loop the IDs and get/process the alerts.", "author": "thc202", "createdAt": "2020-05-12T09:32:30Z", "path": "zap/src/main/java/org/zaproxy/zap/extension/alert/AlertAPI.java", "diffHunk": "@@ -402,6 +392,34 @@ public ApiResponse handleApiAction(String name, JSONObject params) throws ApiExc\n             newAlert.setWascId(wascId);\n             extension.alertFound(newAlert, msg.getHistoryRef());\n             return new ApiResponseElement(name, Integer.toString(newAlert.getAlertId()));\n+        }  else if (ACTION_UPDATE_ALERTS_CONFIDENCE.equals(name)) {\n+            String alertIds = ApiUtils.getNonEmptyStringParam(params, PARAM_ALERT_IDS);\n+            int confidenceId = getConfidenceId(params);\n+\n+            StringTokenizer tokenizer = new StringTokenizer(alertIds, \",\");\n+            while (tokenizer.hasMoreTokens()) {", "originalCommit": "7d7d42cc995bd1639e00218894b31d85ea68dfa2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzYwMDk5Ng==", "url": "https://github.com/zaproxy/zaproxy/pull/5975#discussion_r423600996", "bodyText": "For the second one, how would the signature/definition of the method look?", "author": "kingthorin", "createdAt": "2020-05-12T09:39:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzU5NjcwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzYwNTU0NQ==", "url": "https://github.com/zaproxy/zaproxy/pull/5975#discussion_r423605545", "bodyText": "Right, left out the params... should be like:\nvoid updateAlerts(JSONObject params, Consumer<Alert> consumer)", "author": "thc202", "createdAt": "2020-05-12T09:46:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzU5NjcwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzYwNjE0NQ==", "url": "https://github.com/zaproxy/zaproxy/pull/5975#discussion_r423606145", "bodyText": "TY!", "author": "kingthorin", "createdAt": "2020-05-12T09:47:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzU5NjcwNw=="}], "type": "inlineReview", "revised_code": {"commit": "6d10291bb737a495285dac1a8bc3cb52f874960c", "chunk": "diff --git a/zap/src/main/java/org/zaproxy/zap/extension/alert/AlertAPI.java b/zap/src/main/java/org/zaproxy/zap/extension/alert/AlertAPI.java\nindex 33bcf4728..5b013c7e6 100644\n--- a/zap/src/main/java/org/zaproxy/zap/extension/alert/AlertAPI.java\n+++ b/zap/src/main/java/org/zaproxy/zap/extension/alert/AlertAPI.java\n\n@@ -392,7 +386,7 @@ public class AlertAPI extends ApiImplementor {\n             newAlert.setWascId(wascId);\n             extension.alertFound(newAlert, msg.getHistoryRef());\n             return new ApiResponseElement(name, Integer.toString(newAlert.getAlertId()));\n-        }  else if (ACTION_UPDATE_ALERTS_CONFIDENCE.equals(name)) {\n+        } else if (ACTION_UPDATE_ALERTS_CONFIDENCE.equals(name)) {\n             String alertIds = ApiUtils.getNonEmptyStringParam(params, PARAM_ALERT_IDS);\n             int confidenceId = getConfidenceId(params);\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzU5NzIwOA==", "url": "https://github.com/zaproxy/zaproxy/pull/5975#discussion_r423597208", "bodyText": "Double semicolon.", "author": "thc202", "createdAt": "2020-05-12T09:33:10Z", "path": "zap/src/main/java/org/zaproxy/zap/extension/alert/AlertAPI.java", "diffHunk": "@@ -336,19 +342,7 @@ public ApiResponse handleApiAction(String name, JSONObject params) throws ApiExc\n             int cweId = getParam(params, PARAM_CWEID, 0);\n             int wascId = getParam(params, PARAM_WASCID, 0);\n \n-            RecordAlert recAlert;\n-            try {\n-                recAlert = Model.getSingleton().getDb().getTableAlert().read(alertId);\n-            } catch (DatabaseException e) {\n-                logger.error(e.getMessage(), e);\n-                throw new ApiException(ApiException.Type.INTERNAL_ERROR, e);\n-            }\n-\n-            if (recAlert == null) {\n-                throw new ApiException(ApiException.Type.DOES_NOT_EXIST, PARAM_ALERT_ID);\n-            }\n-\n-            Alert updatedAlert = new Alert(recAlert);\n+            Alert updatedAlert = getAlertFromDb(alertId, PARAM_ALERT_ID);;", "originalCommit": "7d7d42cc995bd1639e00218894b31d85ea68dfa2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6d10291bb737a495285dac1a8bc3cb52f874960c", "chunk": "diff --git a/zap/src/main/java/org/zaproxy/zap/extension/alert/AlertAPI.java b/zap/src/main/java/org/zaproxy/zap/extension/alert/AlertAPI.java\nindex 33bcf4728..5b013c7e6 100644\n--- a/zap/src/main/java/org/zaproxy/zap/extension/alert/AlertAPI.java\n+++ b/zap/src/main/java/org/zaproxy/zap/extension/alert/AlertAPI.java\n\n@@ -342,7 +335,8 @@ public class AlertAPI extends ApiImplementor {\n             int cweId = getParam(params, PARAM_CWEID, 0);\n             int wascId = getParam(params, PARAM_WASCID, 0);\n \n-            Alert updatedAlert = getAlertFromDb(alertId, PARAM_ALERT_ID);;\n+            Alert updatedAlert = getAlertFromDb(alertId, PARAM_ALERT_ID);\n+            ;\n             updatedAlert.setName(alertName);\n             updatedAlert.setRisk(riskId);\n             updatedAlert.setConfidence(confidenceId);\n"}}, {"oid": "6d10291bb737a495285dac1a8bc3cb52f874960c", "url": "https://github.com/zaproxy/zaproxy/commit/6d10291bb737a495285dac1a8bc3cb52f874960c", "message": "Alert API: Bulk Change Confidence or Risk - Fixes 5845\n\nAdded API actions to bulk update Confidence or Risk based on a CSV\nstring of alert IDs. Extracted some code to convenience methods which\nalso lead to minor modification of code within deleteAlert and addAlert\nprocessing.\n\nSigned-off-by: kingthorin <kingthorin@users.noreply.github.com>", "committedDate": "2020-05-12T09:33:48Z", "type": "forcePushed"}, {"oid": "eba5745f0092c7625380de649766225b3476e7b8", "url": "https://github.com/zaproxy/zaproxy/commit/eba5745f0092c7625380de649766225b3476e7b8", "message": "Alert API: Bulk Change Confidence or Risk - Fixes 5845\n\nAdded API actions to bulk update Confidence or Risk based on a CSV\nstring of alert IDs. Extracted some code to convenience methods which\nalso lead to minor modification of code within deleteAlert and addAlert\nprocessing.\n\nSigned-off-by: kingthorin <kingthorin@users.noreply.github.com>", "committedDate": "2020-05-12T10:18:47Z", "type": "forcePushed"}, {"oid": "a5ddf40520ff031ea595f0e86266f894c8db0f65", "url": "https://github.com/zaproxy/zaproxy/commit/a5ddf40520ff031ea595f0e86266f894c8db0f65", "message": "Alert API: Bulk Change Confidence or Risk - Fixes 5845\n\nAdded API actions to bulk update Confidence or Risk based on a CSV\nstring of alert IDs. Extracted some code to convenience methods which\nalso lead to minor modification of code within deleteAlert and addAlert\nprocessing.\n\nSigned-off-by: kingthorin <kingthorin@users.noreply.github.com>", "committedDate": "2020-05-12T10:32:34Z", "type": "forcePushed"}, {"oid": "5a844cde47a95e125f2a24f021a2917b0f986a46", "url": "https://github.com/zaproxy/zaproxy/commit/5a844cde47a95e125f2a24f021a2917b0f986a46", "message": "Alert API: Bulk Change Confidence or Risk - Fixes 5845\n\nAdded API actions to bulk update Confidence or Risk based on a CSV\nstring of alert IDs. Extracted some code to convenience methods which\nalso lead to minor modification of code within deleteAlert and addAlert\nprocessing.\n\nSigned-off-by: kingthorin <kingthorin@users.noreply.github.com>", "committedDate": "2020-05-12T10:38:24Z", "type": "forcePushed"}, {"oid": "2b93fcfd4631fa75d0411b5d23d3e769b444249d", "url": "https://github.com/zaproxy/zaproxy/commit/2b93fcfd4631fa75d0411b5d23d3e769b444249d", "message": "Alert API: Bulk Change Confidence or Risk - Fixes 5845\n\nAdded API actions to bulk update Confidence or Risk based on a CSV\nstring of alert IDs. Extracted some code to convenience methods which\nalso lead to minor modification of code within deleteAlert and addAlert\nprocessing.\n\nSigned-off-by: kingthorin <kingthorin@users.noreply.github.com>", "committedDate": "2020-05-12T10:44:36Z", "type": "commit"}, {"oid": "2b93fcfd4631fa75d0411b5d23d3e769b444249d", "url": "https://github.com/zaproxy/zaproxy/commit/2b93fcfd4631fa75d0411b5d23d3e769b444249d", "message": "Alert API: Bulk Change Confidence or Risk - Fixes 5845\n\nAdded API actions to bulk update Confidence or Risk based on a CSV\nstring of alert IDs. Extracted some code to convenience methods which\nalso lead to minor modification of code within deleteAlert and addAlert\nprocessing.\n\nSigned-off-by: kingthorin <kingthorin@users.noreply.github.com>", "committedDate": "2020-05-12T10:44:36Z", "type": "forcePushed"}]}