{"pr_number": 529, "pr_title": "Generate source jars on demand for internal dependencies", "pr_createdAt": "2020-05-12T14:17:06Z", "pr_url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/529", "timeline": [{"oid": "adbf13fda924adfdbde0c0baa30a5b7b2c2323bd", "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/adbf13fda924adfdbde0c0baa30a5b7b2c2323bd", "message": "Generate source jars for internal dependencies on demand", "committedDate": "2020-05-12T14:15:19Z", "type": "commit"}, {"oid": "91a41ac7239ce68389e0ef6b48d4d27b9e41d01d", "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/91a41ac7239ce68389e0ef6b48d4d27b9e41d01d", "message": "Support libraries.json", "committedDate": "2020-05-18T12:50:49Z", "type": "commit"}, {"oid": "91a41ac7239ce68389e0ef6b48d4d27b9e41d01d", "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/91a41ac7239ce68389e0ef6b48d4d27b9e41d01d", "message": "Support libraries.json", "committedDate": "2020-05-18T12:50:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTg1Mjc2Ng==", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/529#discussion_r431852766", "bodyText": "Should this be logged?\nDoes it make sense for the callers of ensureInitialized to continue if this fails?", "author": "Duhemm", "createdAt": "2020-05-28T13:54:07Z", "path": "src/com/twitter/intellij/pants/bsp/JarMappings.java", "diffHunk": "@@ -0,0 +1,126 @@\n+// Copyright 2020 Pants project contributors (see CONTRIBUTORS.md).\n+// Licensed under the Apache License, Version 2.0 (see LICENSE).\n+\n+package com.twitter.intellij.pants.bsp;\n+\n+import com.google.gson.Gson;\n+import com.google.gson.reflect.TypeToken;\n+import com.intellij.openapi.components.ServiceManager;\n+import com.intellij.openapi.project.Project;\n+import com.intellij.openapi.vfs.LocalFileSystem;\n+import com.intellij.openapi.vfs.VirtualFile;\n+import com.intellij.openapi.vfs.VirtualFileManager;\n+import com.intellij.openapi.vfs.newvfs.BulkFileListener;\n+import com.intellij.openapi.vfs.newvfs.events.VFileContentChangeEvent;\n+import com.intellij.openapi.vfs.newvfs.events.VFileEvent;\n+import org.jetbrains.annotations.NotNull;\n+\n+import java.lang.reflect.Type;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+\n+public class JarMappings {\n+  private static final String SOURCES_JAR_SUFFIX = \"-sources.jar\";\n+\n+  public static JarMappings getInstance(Project project) {\n+    return ServiceManager.getService(project, JarMappings.class);\n+  }\n+\n+  public JarMappings(Project project) {\n+    this.project = project;\n+\n+    project.getMessageBus().connect().subscribe(VirtualFileManager.VFS_CHANGES, new BulkFileListener() {\n+      @Override\n+      public void after(@NotNull List<? extends VFileEvent> events) {\n+        events.forEach(event -> {\n+          if (event instanceof VFileContentChangeEvent &&\n+              event.getFile() != null &&\n+              event.getFile().equals(librariesFile())) {\n+            librariesFileIsUpToDate = false;\n+          }\n+        });\n+      }\n+    });\n+  }\n+\n+  private final Project project;\n+\n+  private Map<String, String> libraryJarToLibrarySourceJar = new HashMap<>();\n+  private boolean librariesFileIsUpToDate = false;\n+\n+  private synchronized void ensureInitialized() {\n+    try {\n+      if (!librariesFileIsUpToDate) {\n+        VirtualFile file = librariesFile();\n+        String content = new String(file.contentsToByteArray());\n+        Type mapType = new TypeToken<Map<String, String>>() {}.getType();\n+        libraryJarToLibrarySourceJar = new Gson().fromJson(content, mapType);\n+        librariesFileIsUpToDate = true;\n+      }\n+    }\n+    catch (Exception e) {\n+      librariesFileIsUpToDate = false;", "originalCommit": "91a41ac7239ce68389e0ef6b48d4d27b9e41d01d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzY4NjIyNg==", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/529#discussion_r433686226", "bodyText": "I mostly expect it to fail when file is not there (could be also on bad json though), then we will end up with empty map or the previous version which should be fine to proceed. This will make sure we will just retry on the next call. But logging would be helpful in case of debugging. I added logging.", "author": "lukaszwawrzyk", "createdAt": "2020-06-02T07:51:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTg1Mjc2Ng=="}], "type": "inlineReview", "revised_code": {"commit": "e6cefa980ea492ff46247c78af83a79649ddb4c4", "chunk": "diff --git a/src/com/twitter/intellij/pants/bsp/JarMappings.java b/src/com/twitter/intellij/pants/bsp/JarMappings.java\nindex 17d3917..c04c84f 100644\n--- a/src/com/twitter/intellij/pants/bsp/JarMappings.java\n+++ b/src/com/twitter/intellij/pants/bsp/JarMappings.java\n\n@@ -6,6 +6,7 @@ package com.twitter.intellij.pants.bsp;\n import com.google.gson.Gson;\n import com.google.gson.reflect.TypeToken;\n import com.intellij.openapi.components.ServiceManager;\n+import com.intellij.openapi.diagnostic.Logger;\n import com.intellij.openapi.project.Project;\n import com.intellij.openapi.vfs.LocalFileSystem;\n import com.intellij.openapi.vfs.VirtualFile;\n"}}, {"oid": "e6cefa980ea492ff46247c78af83a79649ddb4c4", "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/e6cefa980ea492ff46247c78af83a79649ddb4c4", "message": "Tweak error handling", "committedDate": "2020-06-02T07:51:34Z", "type": "commit"}]}