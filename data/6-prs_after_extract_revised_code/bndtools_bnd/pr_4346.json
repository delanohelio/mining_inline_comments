{"pr_number": 4346, "pr_title": "[launcher] The launcher will now be registered as soon as possible", "pr_createdAt": "2020-10-09T09:01:28Z", "pr_url": "https://github.com/bndtools/bnd/pull/4346", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjY5MDIxNA==", "url": "https://github.com/bndtools/bnd/pull/4346#discussion_r512690214", "bodyText": "This should not be an instance variable. You should not reuse the Hashtable across service calls. Create a new Hashtable and populated it at each place you make a service call.", "author": "bjhargrave", "createdAt": "2020-10-27T13:28:09Z", "path": "biz.aQute.launcher/src/aQute/launcher/Launcher.java", "diffHunk": "@@ -121,6 +122,9 @@\n \tprivate boolean\t\t\t\t\t\t\trestart\t\t\t\t\t= false;\n \tprivate boolean\t\t\t\t\t\t\tframeworkInited\t\t\t= false;\n \n+\tprivate ServiceRegistration<?>\t\t\tlauncherServiceRegistraion;\n+\tprivate Hashtable<String, Object>\t\tlauncherServiceProperties;", "originalCommit": "e865fb5b6ecaf75dd73890c0fe80ba87b334f81f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzIxOTI4OA==", "url": "https://github.com/bndtools/bnd/pull/4346#discussion_r513219288", "bodyText": "@bjhargrave I'll change it, but I'm unsure for the reason for it. I know that there had been issues in the past, because of service props that contained certain kinds of lists. besides this, we use this pattern in felix and equinox for years and it works like a charm. Can you elaborate some more?", "author": "juergen-albert", "createdAt": "2020-10-28T07:05:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjY5MDIxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzQyNTUyMQ==", "url": "https://github.com/bndtools/bnd/pull/4346#discussion_r513425521", "bodyText": "It is not clear in the registerService method who owns the Dictionary after the call. So the safest course is to assume the Dictionary cannot be reused and is owned by the framework. I recall that Tom Watson encountered some code where they reused the Dictionary and encountered side effects (probably because of mutated values such as collections). So we should always be safe and not reuse the Dictionary and any values.", "author": "bjhargrave", "createdAt": "2020-10-28T13:05:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjY5MDIxNA=="}], "type": "inlineReview", "revised_code": {"commit": "a1f8c72fa513735bfe37de04d2ca2525373d1fb8", "chunk": "diff --git a/biz.aQute.launcher/src/aQute/launcher/Launcher.java b/biz.aQute.launcher/src/aQute/launcher/Launcher.java\nindex ebf7a0acb..24353468b 100644\n--- a/biz.aQute.launcher/src/aQute/launcher/Launcher.java\n+++ b/biz.aQute.launcher/src/aQute/launcher/Launcher.java\n\n@@ -123,7 +124,6 @@ public class Launcher implements ServiceListener, FrameworkListener {\n \tprivate boolean\t\t\t\t\t\t\tframeworkInited\t\t\t= false;\n \n \tprivate ServiceRegistration<?>\t\t\tlauncherServiceRegistraion;\n-\tprivate Hashtable<String, Object>\t\tlauncherServiceProperties;\n \n \tenum EmbeddedActivatorPhase {\n \n"}}, {"oid": "a1f8c72fa513735bfe37de04d2ca2525373d1fb8", "url": "https://github.com/bndtools/bnd/commit/a1f8c72fa513735bfe37de04d2ca2525373d1fb8", "message": "[launcher] The launcher will now be registered as soon as possible\n\nSigned-off-by: Juergen Albert <j.albert@data-in-motion.biz>", "committedDate": "2020-10-28T07:14:04Z", "type": "commit"}, {"oid": "a1f8c72fa513735bfe37de04d2ca2525373d1fb8", "url": "https://github.com/bndtools/bnd/commit/a1f8c72fa513735bfe37de04d2ca2525373d1fb8", "message": "[launcher] The launcher will now be registered as soon as possible\n\nSigned-off-by: Juergen Albert <j.albert@data-in-motion.biz>", "committedDate": "2020-10-28T07:14:04Z", "type": "forcePushed"}]}