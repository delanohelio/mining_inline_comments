{"pr_number": 4384, "pr_title": "Fix an order-dependent flaky test", "pr_createdAt": "2020-12-02T06:21:23Z", "pr_url": "https://github.com/alibaba/nacos/pull/4384", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDYwNjMwMA==", "url": "https://github.com/alibaba/nacos/pull/4384#discussion_r534606300", "bodyText": "I think solve this problem by add @BeforeClass method. And register subType in @BeforeClass method will be better.", "author": "KomachiSion", "createdAt": "2020-12-03T01:50:46Z", "path": "api/src/test/java/com/alibaba/nacos/api/naming/pojo/healthcheck/HealthCheckerFactoryTest.java", "diffHunk": "@@ -48,6 +48,7 @@ public void testDeserialize() {\n     \n     @Test\n     public void testDeserializeExtend() {\n+        HealthCheckerFactory.registerSubType(TestChecker.class, TestChecker.TYPE);", "originalCommit": "869a197467747b6cc49aab713e8df9bb6af4dfa6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDYwNzU0MQ==", "url": "https://github.com/alibaba/nacos/pull/4384#discussion_r534607541", "bodyText": "Sounds good. Will update soon.", "author": "luoos", "createdAt": "2020-12-03T01:54:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDYwNjMwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDYxMTU4OA==", "url": "https://github.com/alibaba/nacos/pull/4384#discussion_r534611588", "bodyText": "Done", "author": "luoos", "createdAt": "2020-12-03T02:04:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDYwNjMwMA=="}], "type": "inlineReview", "revised_code": {"commit": "b57e6c708faf8b7dc7399e6188c7c2aa75ee6702", "chunk": "diff --git a/api/src/test/java/com/alibaba/nacos/api/naming/pojo/healthcheck/HealthCheckerFactoryTest.java b/api/src/test/java/com/alibaba/nacos/api/naming/pojo/healthcheck/HealthCheckerFactoryTest.java\nindex e8133a2e1..f7b3abbd6 100644\n--- a/api/src/test/java/com/alibaba/nacos/api/naming/pojo/healthcheck/HealthCheckerFactoryTest.java\n+++ b/api/src/test/java/com/alibaba/nacos/api/naming/pojo/healthcheck/HealthCheckerFactoryTest.java\n\n@@ -48,7 +53,6 @@ public class HealthCheckerFactoryTest {\n     \n     @Test\n     public void testDeserializeExtend() {\n-        HealthCheckerFactory.registerSubType(TestChecker.class, TestChecker.TYPE);\n         String tcpString = \"{\\\"type\\\":\\\"TEST\\\",\\\"testValue\\\":null}\";\n         AbstractHealthChecker actual = HealthCheckerFactory.deserialize(tcpString);\n         assertEquals(TestChecker.class, actual.getClass());\n"}}, {"oid": "b57e6c708faf8b7dc7399e6188c7c2aa75ee6702", "url": "https://github.com/alibaba/nacos/commit/b57e6c708faf8b7dc7399e6188c7c2aa75ee6702", "message": "Fix an order-dependent flaky test\n\n[Problem]\ntestSerializeExtend add an item to a static mapper,\nand testDeserializeExtend read that item from that static mapper.\nSo if testDeserializeExtend runs before testSerializeExtend,\ntestDeserializeExtend will fail.\n\n@Ignore testSerializeExtend can stably reproduce this issue.\n\n[Solution]\nAdd that item to the static mapper in @BeforeClass method\n(Even though using static variables in unit tests is a bad practice)", "committedDate": "2020-12-03T02:01:41Z", "type": "commit"}]}