{"pr_number": 3654, "pr_title": "[ISSUE#3315]Nacos client support https", "pr_createdAt": "2020-08-20T11:01:02Z", "pr_url": "https://github.com/alibaba/nacos/pull/3654", "timeline": [{"oid": "2391453a181a29307d0f2023021d6b2b0d5e7a86", "url": "https://github.com/alibaba/nacos/commit/2391453a181a29307d0f2023021d6b2b0d5e7a86", "message": "[ISSUE #3315] nacos client support https\n* common module add tls related classes\n* JdkHttpClientRequest support https\n* unified IpUtils", "committedDate": "2020-08-18T09:10:14Z", "type": "commit"}, {"oid": "a837c70dbff78f76f6d38ce1911711b1c90638ed", "url": "https://github.com/alibaba/nacos/commit/a837c70dbff78f76f6d38ce1911711b1c90638ed", "message": "[ISSUE #3315] nacos client support https\n* common module add tls related classes\n* JdkHttpClientRequest support https\n* unified IpUtils", "committedDate": "2020-08-20T08:25:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzg5MTMwNg==", "url": "https://github.com/alibaba/nacos/pull/3654#discussion_r473891306", "bodyText": "Why SuppressWarnings checkstyle:WhitespaceAround?", "author": "KomachiSion", "createdAt": "2020-08-20T11:11:08Z", "path": "common/src/main/java/com/alibaba/nacos/common/tls/SelfTrustManager.java", "diffHunk": "@@ -0,0 +1,112 @@\n+/*\n+ * Copyright 1999-2018 Alibaba Group Holding Ltd.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.alibaba.nacos.common.tls;\n+\n+import com.alibaba.nacos.common.utils.IoUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import javax.net.ssl.SSLException;\n+import javax.net.ssl.TrustManager;\n+import javax.net.ssl.TrustManagerFactory;\n+import javax.net.ssl.X509TrustManager;\n+import java.io.FileInputStream;\n+import java.io.InputStream;\n+import java.security.KeyStore;\n+import java.security.cert.Certificate;\n+import java.security.cert.CertificateException;\n+import java.security.cert.CertificateFactory;\n+import java.security.cert.X509Certificate;\n+import java.util.Collection;\n+\n+/**\n+ * A TrustManager tool returns the specified TrustManager.\n+ *\n+ * @author wangwei\n+ */\n+public final class SelfTrustManager {\n+    \n+    private static final Logger LOGGER = LoggerFactory.getLogger(SelfTrustManager.class);\n+    \n+    @SuppressWarnings(\"checkstyle:WhitespaceAround\")", "originalCommit": "a837c70dbff78f76f6d38ce1911711b1c90638ed", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDAzOTgyMA==", "url": "https://github.com/alibaba/nacos/pull/3654#discussion_r474039820", "bodyText": "\u7b2c60\u884c\u90a3\u4e24\u4e2a}}\u62a5\u7684\u8fd9\u4e2acheckstyle\u9519\u8bef\uff0c\u4f46\u662f \u683c\u5f0f\u5316\u5de5\u5177\u5c31\u81ea\u52a8\u683c\u5f0f\u5316\u6210\u8fd9\u6837", "author": "wangweizZZ", "createdAt": "2020-08-20T14:46:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzg5MTMwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDM1NDE0Ng==", "url": "https://github.com/alibaba/nacos/pull/3654#discussion_r474354146", "bodyText": "\u611f\u89c9\u53ef\u80fd\u662fcheckstyle\u7684bug \u5b98\u65b9\u6587\u6863\u8bf4\u4e0d\u4f1a\u628a\u53cc\u62ec\u5f27\u8ba4\u4e3a\u662f\u975e\u6cd5\u7684\u3002\nhttps://checkstyle.sourceforge.io/config_whitespace.html#WhitespaceAround\n\u6216\u8005\u662f\u6211\u4eec\u8fd9\u79cd\u5199\u6cd5\u4e0d\u5c5e\u4e8e\u53cc\u62ec\u5f27\u521d\u59cb\u5316\u5668\u3002", "author": "KomachiSion", "createdAt": "2020-08-21T01:14:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzg5MTMwNg=="}], "type": "inlineReview", "revised_code": null}, {"oid": "78a9f6226d0cdc56ca5d9938a11d91f9f410ad3c", "url": "https://github.com/alibaba/nacos/commit/78a9f6226d0cdc56ca5d9938a11d91f9f410ad3c", "message": "[ISSUE #3315] nacos client support https", "committedDate": "2020-08-20T16:18:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDM1MzQyNA==", "url": "https://github.com/alibaba/nacos/pull/3654#discussion_r474353424", "bodyText": "\u8fd9\u91cc\u7684\u903b\u8f91\u662f\u4e0d\u662f\u53ef\u4ee5\u72ec\u7acb\u4e3a\u4e00\u4e2a\u51fd\u6570\uff0c\u770b\u8d77\u6765\u76f8\u5bf9\u7b80\u6d01\u70b9\u3002", "author": "Maijh97", "createdAt": "2020-08-21T01:12:10Z", "path": "common/src/main/java/com/alibaba/nacos/common/http/AbstractHttpClientFactory.java", "diffHunk": "@@ -34,7 +46,28 @@\n     @Override\n     public final NacosRestTemplate createNacosRestTemplate() {\n         HttpClientConfig httpClientConfig = buildHttpClientConfig();\n-        return new NacosRestTemplate(assignLogger(), new JdkHttpClientRequest(httpClientConfig));\n+        final JdkHttpClientRequest clientRequest = new JdkHttpClientRequest(httpClientConfig);\n+        \n+        if (TlsSystemConfig.tlsEnable) {\n+            // enable ssl\n+            clientRequest.setSSLContext(loadSSLContext());\n+            final HostnameVerifier hv = HttpsURLConnection.getDefaultHostnameVerifier();\n+            final SelfHostnameVerifier selfHostnameVerifier = new SelfHostnameVerifier(hv);\n+            clientRequest.replaceSSLHostnameVerifier(selfHostnameVerifier);\n+            \n+            try {\n+                TlsFileWatcher.getInstance().addFileChangeListener(new TlsFileWatcher.FileChangeListener() {\n+                    @Override\n+                    public void onChanged(String filePath) {\n+                        clientRequest.setSSLContext(loadSSLContext());\n+                    }\n+                }, TlsSystemConfig.tlsClientTrustCertPath, TlsSystemConfig.tlsClientKeyPath);\n+            } catch (IOException e) {\n+                assignLogger().error(\"add tls file listener fail\", e);\n+            }\n+        }\n+        ", "originalCommit": "78a9f6226d0cdc56ca5d9938a11d91f9f410ad3c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTA1OTczOQ==", "url": "https://github.com/alibaba/nacos/pull/3654#discussion_r475059739", "bodyText": "\u662f\u6307tlsFileWatcher\u8fd9\u4e00\u6bb5\u5417\uff1faddSSLContextChangeListener(FileChangeListener  Listener)?\n\u72ec\u7acb\u6210\u4e00\u4e2a\u51fd\u6570\uff0c\u8fd9\u6837\u81f3\u5c11\u5bf9\u4f7f\u7528AbstractHttpClientFactory.java \u7c7b\u7684\u5f00\u53d1\u8005\u6765\u8bf4\u5c4f\u853d\u4e00\u4e9btlsClientTrustCertPath\u8fd9\u6837\u7684\u7ec6\u8282\u3002\u662f\u597d\u70b9\uff0c\u6211\u6539\u4e0b\u3002", "author": "wangweizZZ", "createdAt": "2020-08-22T07:42:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDM1MzQyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTA2MDUzNg==", "url": "https://github.com/alibaba/nacos/pull/3654#discussion_r475060536", "bodyText": "\u4ece51\u884c\u5f00\u59cb\u523068\u884c\uff0c\u611f\u89c9\u8fd9\u91cc\u53ef\u4ee5\u72ec\u7acb\u4e3a\u4e00\u4e2a\u51fd\u6570\u3002", "author": "Maijh97", "createdAt": "2020-08-22T07:53:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDM1MzQyNA=="}], "type": "inlineReview", "revised_code": {"commit": "85ffddebe4c74bee76de36bd0ec82505e648d427", "chunk": "diff --git a/common/src/main/java/com/alibaba/nacos/common/http/AbstractHttpClientFactory.java b/common/src/main/java/com/alibaba/nacos/common/http/AbstractHttpClientFactory.java\nindex 76061d28e..5d7c908dd 100644\n--- a/common/src/main/java/com/alibaba/nacos/common/http/AbstractHttpClientFactory.java\n+++ b/common/src/main/java/com/alibaba/nacos/common/http/AbstractHttpClientFactory.java\n\n@@ -48,24 +48,19 @@ public abstract class AbstractHttpClientFactory implements HttpClientFactory {\n         HttpClientConfig httpClientConfig = buildHttpClientConfig();\n         final JdkHttpClientRequest clientRequest = new JdkHttpClientRequest(httpClientConfig);\n         \n-        if (TlsSystemConfig.tlsEnable) {\n-            // enable ssl\n-            clientRequest.setSSLContext(loadSSLContext());\n-            final HostnameVerifier hv = HttpsURLConnection.getDefaultHostnameVerifier();\n-            final SelfHostnameVerifier selfHostnameVerifier = new SelfHostnameVerifier(hv);\n-            clientRequest.replaceSSLHostnameVerifier(selfHostnameVerifier);\n-            \n-            try {\n-                TlsFileWatcher.getInstance().addFileChangeListener(new TlsFileWatcher.FileChangeListener() {\n-                    @Override\n-                    public void onChanged(String filePath) {\n-                        clientRequest.setSSLContext(loadSSLContext());\n-                    }\n-                }, TlsSystemConfig.tlsClientTrustCertPath, TlsSystemConfig.tlsClientKeyPath);\n-            } catch (IOException e) {\n-                assignLogger().error(\"add tls file listener fail\", e);\n+        // enable ssl\n+        initTls(new BiConsumer<SSLContext, HostnameVerifier>() {\n+            @Override\n+            public void accept(SSLContext sslContext, HostnameVerifier hostnameVerifier) {\n+                clientRequest.setSSLContext(loadSSLContext());\n+                clientRequest.replaceSSLHostnameVerifier(hostnameVerifier);\n             }\n-        }\n+        }, new TlsFileWatcher.FileChangeListener() {\n+            @Override\n+            public void onChanged(String filePath) {\n+                clientRequest.setSSLContext(loadSSLContext());\n+            }\n+        });\n         \n         return new NacosRestTemplate(assignLogger(), clientRequest);\n     }\n"}}, {"oid": "85ffddebe4c74bee76de36bd0ec82505e648d427", "url": "https://github.com/alibaba/nacos/commit/85ffddebe4c74bee76de36bd0ec82505e648d427", "message": "Merge remote-tracking branch 'alibaba/develop' into feature_https", "committedDate": "2020-08-24T08:34:39Z", "type": "commit"}, {"oid": "9b654e4bb6a0bd02179805389089915f3085bf96", "url": "https://github.com/alibaba/nacos/commit/9b654e4bb6a0bd02179805389089915f3085bf96", "message": "format code", "committedDate": "2020-08-24T08:39:34Z", "type": "commit"}, {"oid": "9b654e4bb6a0bd02179805389089915f3085bf96", "url": "https://github.com/alibaba/nacos/commit/9b654e4bb6a0bd02179805389089915f3085bf96", "message": "format code", "committedDate": "2020-08-24T08:39:34Z", "type": "forcePushed"}]}