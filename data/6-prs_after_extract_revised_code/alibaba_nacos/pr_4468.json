{"pr_number": 4468, "pr_title": "[ISSUE-#4467] Fix snowflake id problem", "pr_createdAt": "2020-12-12T14:45:35Z", "pr_url": "https://github.com/alibaba/nacos/pull/4468", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjA2NDc4NA==", "url": "https://github.com/alibaba/nacos/pull/4468#discussion_r542064784", "bodyText": "Bad implementation I think. If oldInstance exist, only use instance id of old instance, can't change instanceId.\nThe original implementation also has some problem", "author": "KomachiSion", "createdAt": "2020-12-14T02:07:39Z", "path": "naming/src/main/java/com/alibaba/nacos/naming/core/ServiceManager.java", "diffHunk": "@@ -811,7 +811,15 @@ public Instance getInstance(String namespaceId, String serviceName, String clust\n             if (UtilsAndCommons.UPDATE_INSTANCE_ACTION_REMOVE.equals(action)) {\n                 instanceMap.remove(instance.getDatumKey());\n             } else {\n-                instance.setInstanceId(instance.generateInstanceId(currentInstanceIds));\n+                String instanceIdGenerator = instance.getInstanceIdGenerator();\n+                if (Constants.SNOWFLAKE_INSTANCE_ID_GENERATOR.equalsIgnoreCase(instanceIdGenerator)) {\n+                    Instance oldInstance = instanceMap.get(instance.getDatumKey());\n+                    if (oldInstance != null && oldInstance.isSnowflakeId()) {\n+                        instance.setInstanceId(oldInstance.getInstanceId());\n+                    } else {\n+                        instance.setInstanceId(generateSnowflakeInstanceId(currentInstanceIds));\n+                    }\n+                }", "originalCommit": "241e9ea5acf1be6ebf4206d3a3cc9ec19f84103a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjA2ODQyOA==", "url": "https://github.com/alibaba/nacos/pull/4468#discussion_r542068428", "bodyText": "Some situation.\n1. old instance didn't use snowflake generator, new instance use snowflake generator. New instance id should be snowflake Id.\n\n2.old instance use snowflake generator, new instance isn't use  snowflake generator. New instance id shouldn't remains old instance Id. \n\n3.old instance and new instance all use snowflake generator, new instance should remains old instance Id.", "author": "horizonzy", "createdAt": "2020-12-14T02:21:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjA2NDc4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjMxNTAzNw==", "url": "https://github.com/alibaba/nacos/pull/4468#discussion_r542315037", "bodyText": "Must deregister instance and register again.\n\n\nSame as the first\n\n\nyes it is.", "author": "KomachiSion", "createdAt": "2020-12-14T11:32:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjA2NDc4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjMxNTk2OQ==", "url": "https://github.com/alibaba/nacos/pull/4468#discussion_r542315969", "bodyText": "Instance id is a binder like ip and port (so default id generate from ip and port), If user want to change, they must deregister the older and register new. Can't update it directly.", "author": "KomachiSion", "createdAt": "2020-12-14T11:34:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjA2NDc4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjQ2MTk4Mg==", "url": "https://github.com/alibaba/nacos/pull/4468#discussion_r542461982", "bodyText": "Instance id is a binder like ip and port (so default id generate from ip and port), If user want to change, they must deregister the older and register new. Can't update it directly.\n\nagree", "author": "horizonzy", "createdAt": "2020-12-14T15:14:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjA2NDc4NA=="}], "type": "inlineReview", "revised_code": {"commit": "8335d9e3edb5d9b728e4e77e632277157bc09137", "chunk": "diff --git a/naming/src/main/java/com/alibaba/nacos/naming/core/ServiceManager.java b/naming/src/main/java/com/alibaba/nacos/naming/core/ServiceManager.java\nindex ec69f0236..53747feb5 100644\n--- a/naming/src/main/java/com/alibaba/nacos/naming/core/ServiceManager.java\n+++ b/naming/src/main/java/com/alibaba/nacos/naming/core/ServiceManager.java\n\n@@ -811,14 +811,11 @@ public class ServiceManager implements RecordListener<Service> {\n             if (UtilsAndCommons.UPDATE_INSTANCE_ACTION_REMOVE.equals(action)) {\n                 instanceMap.remove(instance.getDatumKey());\n             } else {\n-                String instanceIdGenerator = instance.getInstanceIdGenerator();\n-                if (Constants.SNOWFLAKE_INSTANCE_ID_GENERATOR.equalsIgnoreCase(instanceIdGenerator)) {\n-                    Instance oldInstance = instanceMap.get(instance.getDatumKey());\n-                    if (oldInstance != null && oldInstance.isSnowflakeId()) {\n-                        instance.setInstanceId(oldInstance.getInstanceId());\n-                    } else {\n-                        instance.setInstanceId(generateSnowflakeInstanceId(currentInstanceIds));\n-                    }\n+                Instance oldInstance = instanceMap.get(instance.getDatumKey());\n+                if (oldInstance != null) {\n+                    instance.setInstanceId(oldInstance.getInstanceId());\n+                } else {\n+                    instance.setInstanceId(instance.generateInstanceId(currentInstanceIds));\n                 }\n                 instanceMap.put(instance.getDatumKey(), instance);\n             }\n"}}, {"oid": "8335d9e3edb5d9b728e4e77e632277157bc09137", "url": "https://github.com/alibaba/nacos/commit/8335d9e3edb5d9b728e4e77e632277157bc09137", "message": "fix snowflake id problem", "committedDate": "2020-12-14T15:48:32Z", "type": "commit"}, {"oid": "8335d9e3edb5d9b728e4e77e632277157bc09137", "url": "https://github.com/alibaba/nacos/commit/8335d9e3edb5d9b728e4e77e632277157bc09137", "message": "fix snowflake id problem", "committedDate": "2020-12-14T15:48:32Z", "type": "forcePushed"}, {"oid": "97336186716b818842fe700c30802760ed9aac90", "url": "https://github.com/alibaba/nacos/commit/97336186716b818842fe700c30802760ed9aac90", "message": "revert code format", "committedDate": "2020-12-14T15:51:43Z", "type": "commit"}]}