{"pr_number": 3913, "pr_title": "[ISSUE #3909] add domain's judgement", "pr_createdAt": "2020-09-25T05:45:16Z", "pr_url": "https://github.com/alibaba/nacos/pull/3913", "timeline": [{"oid": "00bb7bd9319d7d22c5b8c2268e3c2f73e1cf0646", "url": "https://github.com/alibaba/nacos/commit/00bb7bd9319d7d22c5b8c2268e3c2f73e1cf0646", "message": "add domain's judgement", "committedDate": "2020-09-25T05:44:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUyODY4OA==", "url": "https://github.com/alibaba/nacos/pull/3913#discussion_r495528688", "bodyText": "There is no port, just set ip or domain.\nSee isIP", "author": "KomachiSion", "createdAt": "2020-09-27T04:54:36Z", "path": "sys/src/main/java/com/alibaba/nacos/sys/utils/InetUtils.java", "diffHunk": "@@ -219,6 +219,26 @@ public static boolean isIP(String str) {\n         return matcher.matches();\n     }\n     \n+    /**\n+     * juege str is right domain.\n+     *\n+     * @param str nacosIp\n+     * @return nacosIp is domain\n+     */\n+    public static boolean isDomain(String str) {\n+        try {\n+            String[] split = str.split(\":\");", "originalCommit": "00bb7bd9319d7d22c5b8c2268e3c2f73e1cf0646", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUzMzI2OQ==", "url": "https://github.com/alibaba/nacos/pull/3913#discussion_r495533269", "bodyText": "yes", "author": "horizonzy", "createdAt": "2020-09-27T05:58:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUyODY4OA=="}], "type": "inlineReview", "revised_code": {"commit": "c9f5f7101a03f291bb8e777fa5364d44a1a3de49", "chunk": "diff --git a/sys/src/main/java/com/alibaba/nacos/sys/utils/InetUtils.java b/sys/src/main/java/com/alibaba/nacos/sys/utils/InetUtils.java\nindex 2b32b49a2..e5738c24c 100644\n--- a/sys/src/main/java/com/alibaba/nacos/sys/utils/InetUtils.java\n+++ b/sys/src/main/java/com/alibaba/nacos/sys/utils/InetUtils.java\n\n@@ -226,17 +227,8 @@ public class InetUtils {\n      * @return nacosIp is domain\n      */\n     public static boolean isDomain(String str) {\n-        try {\n-            String[] split = str.split(\":\");\n-            if (split.length != 2) {\n-                return false;\n-            }\n-            Integer.parseInt(split[1]);\n-            InetAddress address = InetAddress.getByName(split[0]);\n-            return address.isReachable(100);\n-        } catch (Exception e) {\n-            return false;\n-        }\n+        InetSocketAddress address = new InetSocketAddress(str, 0);\n+        return !address.isUnresolved();\n     }\n     \n     /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUyOTA1Nw==", "url": "https://github.com/alibaba/nacos/pull/3913#discussion_r495529057", "bodyText": "Is this too strict to judge?\nthis method need the input must can be parse to IP and can reach.\nBut we just need check the input string is a domain pattern", "author": "KomachiSion", "createdAt": "2020-09-27T05:00:17Z", "path": "sys/src/main/java/com/alibaba/nacos/sys/utils/InetUtils.java", "diffHunk": "@@ -219,6 +219,26 @@ public static boolean isIP(String str) {\n         return matcher.matches();\n     }\n     \n+    /**\n+     * juege str is right domain.\n+     *\n+     * @param str nacosIp\n+     * @return nacosIp is domain\n+     */\n+    public static boolean isDomain(String str) {\n+        try {\n+            String[] split = str.split(\":\");\n+            if (split.length != 2) {\n+                return false;\n+            }\n+            Integer.parseInt(split[1]);\n+            InetAddress address = InetAddress.getByName(split[0]);\n+            return address.isReachable(100);", "originalCommit": "00bb7bd9319d7d22c5b8c2268e3c2f73e1cf0646", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUzMzI4OQ==", "url": "https://github.com/alibaba/nacos/pull/3913#discussion_r495533289", "bodyText": "yes, just check the domain can resolve", "author": "horizonzy", "createdAt": "2020-09-27T05:59:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUyOTA1Nw=="}], "type": "inlineReview", "revised_code": {"commit": "c9f5f7101a03f291bb8e777fa5364d44a1a3de49", "chunk": "diff --git a/sys/src/main/java/com/alibaba/nacos/sys/utils/InetUtils.java b/sys/src/main/java/com/alibaba/nacos/sys/utils/InetUtils.java\nindex 2b32b49a2..e5738c24c 100644\n--- a/sys/src/main/java/com/alibaba/nacos/sys/utils/InetUtils.java\n+++ b/sys/src/main/java/com/alibaba/nacos/sys/utils/InetUtils.java\n\n@@ -226,17 +227,8 @@ public class InetUtils {\n      * @return nacosIp is domain\n      */\n     public static boolean isDomain(String str) {\n-        try {\n-            String[] split = str.split(\":\");\n-            if (split.length != 2) {\n-                return false;\n-            }\n-            Integer.parseInt(split[1]);\n-            InetAddress address = InetAddress.getByName(split[0]);\n-            return address.isReachable(100);\n-        } catch (Exception e) {\n-            return false;\n-        }\n+        InetSocketAddress address = new InetSocketAddress(str, 0);\n+        return !address.isUnresolved();\n     }\n     \n     /**\n"}}, {"oid": "c9f5f7101a03f291bb8e777fa5364d44a1a3de49", "url": "https://github.com/alibaba/nacos/commit/c9f5f7101a03f291bb8e777fa5364d44a1a3de49", "message": "modify domain's judgement, can resolve = true", "committedDate": "2020-09-27T05:58:06Z", "type": "commit"}, {"oid": "2a9745f87d994421cb1a758ff3f834e48ecb6bf1", "url": "https://github.com/alibaba/nacos/commit/2a9745f87d994421cb1a758ff3f834e48ecb6bf1", "message": "remove judgement in 'if' code block", "committedDate": "2020-09-27T07:05:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTY2ODM1Ng==", "url": "https://github.com/alibaba/nacos/pull/3913#discussion_r495668356", "bodyText": "illegalIp => illegalIP", "author": "chuntaojun", "createdAt": "2020-09-28T03:12:21Z", "path": "sys/src/main/java/com/alibaba/nacos/sys/utils/InetUtils.java", "diffHunk": "@@ -87,7 +88,8 @@ public void run() {\n                     nacosIp = ApplicationUtils.getProperty(IP_ADDRESS);\n                 }\n                 \n-                if (!StringUtils.isBlank(nacosIp) && !isIP(nacosIp)) {\n+                boolean illegalIp = !StringUtils.isBlank(nacosIp) && !(isIP(nacosIp) || isDomain(nacosIp));", "originalCommit": "2a9745f87d994421cb1a758ff3f834e48ecb6bf1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6545584c5d9538bd7523430f9bb5bc0fc2b46945", "chunk": "diff --git a/sys/src/main/java/com/alibaba/nacos/sys/utils/InetUtils.java b/sys/src/main/java/com/alibaba/nacos/sys/utils/InetUtils.java\nindex b461e8293..577ef35c3 100644\n--- a/sys/src/main/java/com/alibaba/nacos/sys/utils/InetUtils.java\n+++ b/sys/src/main/java/com/alibaba/nacos/sys/utils/InetUtils.java\n\n@@ -83,56 +83,56 @@ public class InetUtils {\n         Runnable ipAutoRefresh = new Runnable() {\n             @Override\n             public void run() {\n-                String nacosIp = System.getProperty(NACOS_SERVER_IP);\n-                if (StringUtils.isBlank(nacosIp)) {\n-                    nacosIp = ApplicationUtils.getProperty(IP_ADDRESS);\n+                String nacosIP = System.getProperty(NACOS_SERVER_IP);\n+                if (StringUtils.isBlank(nacosIP)) {\n+                    nacosIP = ApplicationUtils.getProperty(IP_ADDRESS);\n                 }\n                 \n-                boolean illegalIp = !StringUtils.isBlank(nacosIp) && !(isIP(nacosIp) || isDomain(nacosIp));\n-                if (illegalIp) {\n-                    throw new RuntimeException(\"nacos address \" + nacosIp + \" is not ip\");\n+                boolean illegalIP = !StringUtils.isBlank(nacosIP) && !(isIP(nacosIP) || isDomain(nacosIP));\n+                if (illegalIP) {\n+                    throw new RuntimeException(\"nacos address \" + nacosIP + \" is not ip\");\n                 }\n-                String tmpSelfIp = nacosIp;\n-                if (StringUtils.isBlank(tmpSelfIp)) {\n-                    preferHostnameOverIp = Boolean.getBoolean(SYSTEM_PREFER_HOSTNAME_OVER_IP);\n+                String tmpSelfIP = nacosIP;\n+                if (StringUtils.isBlank(tmpSelfIP)) {\n+                    preferHostnameOverIP = Boolean.getBoolean(SYSTEM_PREFER_HOSTNAME_OVER_IP);\n                     \n-                    if (!preferHostnameOverIp) {\n-                        preferHostnameOverIp = Boolean\n+                    if (!preferHostnameOverIP) {\n+                        preferHostnameOverIP = Boolean\n                                 .parseBoolean(ApplicationUtils.getProperty(PREFER_HOSTNAME_OVER_IP));\n                     }\n                     \n-                    if (preferHostnameOverIp) {\n+                    if (preferHostnameOverIP) {\n                         InetAddress inetAddress;\n                         try {\n                             inetAddress = InetAddress.getLocalHost();\n                             if (inetAddress.getHostName().equals(inetAddress.getCanonicalHostName())) {\n-                                tmpSelfIp = inetAddress.getHostName();\n+                                tmpSelfIP = inetAddress.getHostName();\n                             } else {\n-                                tmpSelfIp = inetAddress.getCanonicalHostName();\n+                                tmpSelfIP = inetAddress.getCanonicalHostName();\n                             }\n                         } catch (UnknownHostException ignore) {\n                             LOG.warn(\"Unable to retrieve localhost\");\n                         }\n                     } else {\n-                        tmpSelfIp = Objects.requireNonNull(findFirstNonLoopbackAddress()).getHostAddress();\n+                        tmpSelfIP = Objects.requireNonNull(findFirstNonLoopbackAddress()).getHostAddress();\n                     }\n                 }\n                 \n-                if (!Objects.equals(selfIp, tmpSelfIp) && Objects.nonNull(selfIp)) {\n+                if (!Objects.equals(selfIP, tmpSelfIP) && Objects.nonNull(selfIP)) {\n                     IPChangeEvent event = new IPChangeEvent();\n-                    event.setOldIp(selfIp);\n-                    event.setNewIp(tmpSelfIp);\n+                    event.setOldIP(selfIP);\n+                    event.setNewIP(tmpSelfIP);\n                     NotifyCenter.publishEvent(event);\n                 }\n-                selfIp = tmpSelfIp;\n+                selfIP = tmpSelfIP;\n             }\n         };\n         \n         ipAutoRefresh.run();\n     }\n     \n-    public static String getSelfIp() {\n-        return selfIp;\n+    public static String getSelfIP() {\n+        return selfIP;\n     }\n     \n     /**\n"}}, {"oid": "6545584c5d9538bd7523430f9bb5bc0fc2b46945", "url": "https://github.com/alibaba/nacos/commit/6545584c5d9538bd7523430f9bb5bc0fc2b46945", "message": "replace Ip to IP in InetUtils", "committedDate": "2020-09-28T04:34:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzI0NjgxNA==", "url": "https://github.com/alibaba/nacos/pull/3913#discussion_r497246814", "bodyText": "A Warn log can be output here to indicate that the domain name is not reachable", "author": "chuntaojun", "createdAt": "2020-09-30T05:12:09Z", "path": "sys/src/main/java/com/alibaba/nacos/sys/utils/InetUtils.java", "diffHunk": "@@ -219,35 +221,46 @@ public static boolean isIP(String str) {\n         return matcher.matches();\n     }\n     \n+    /**\n+     * juege str is right domain.\n+     *\n+     * @param str nacosIP\n+     * @return nacosIP is domain\n+     */\n+    public static boolean isDomain(String str) {\n+        InetSocketAddress address = new InetSocketAddress(str, 0);\n+        return !address.isUnresolved();", "originalCommit": "6545584c5d9538bd7523430f9bb5bc0fc2b46945", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzMyNTMyOQ==", "url": "https://github.com/alibaba/nacos/pull/3913#discussion_r497325329", "bodyText": "solve it", "author": "horizonzy", "createdAt": "2020-09-30T08:16:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzI0NjgxNA=="}], "type": "inlineReview", "revised_code": {"commit": "bd775d5722913ed65d1a4788f647f101e08323a4", "chunk": "diff --git a/sys/src/main/java/com/alibaba/nacos/sys/utils/InetUtils.java b/sys/src/main/java/com/alibaba/nacos/sys/utils/InetUtils.java\nindex 577ef35c3..239a45b80 100644\n--- a/sys/src/main/java/com/alibaba/nacos/sys/utils/InetUtils.java\n+++ b/sys/src/main/java/com/alibaba/nacos/sys/utils/InetUtils.java\n\n@@ -229,7 +229,11 @@ public class InetUtils {\n      */\n     public static boolean isDomain(String str) {\n         InetSocketAddress address = new InetSocketAddress(str, 0);\n-        return !address.isUnresolved();\n+        boolean isResolved = !address.isUnresolved();\n+        if (isResolved) {\n+            LOG.warn(\"the domain: '\" + str + \"' can not be resolved\");\n+        }\n+        return isResolved;\n     }\n     \n     /**\n"}}, {"oid": "bd775d5722913ed65d1a4788f647f101e08323a4", "url": "https://github.com/alibaba/nacos/commit/bd775d5722913ed65d1a4788f647f101e08323a4", "message": "log warn info when domain can not be resolved", "committedDate": "2020-09-30T08:23:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzM0MDg1Mw==", "url": "https://github.com/alibaba/nacos/pull/3913#discussion_r497340853", "bodyText": "isResolved => unResolved", "author": "chuntaojun", "createdAt": "2020-09-30T08:40:49Z", "path": "sys/src/main/java/com/alibaba/nacos/sys/utils/InetUtils.java", "diffHunk": "@@ -219,35 +221,50 @@ public static boolean isIP(String str) {\n         return matcher.matches();\n     }\n     \n+    /**\n+     * juege str is right domain.\n+     *\n+     * @param str nacosIP\n+     * @return nacosIP is domain\n+     */\n+    public static boolean isDomain(String str) {\n+        InetSocketAddress address = new InetSocketAddress(str, 0);\n+        boolean isResolved = !address.isUnresolved();", "originalCommit": "bd775d5722913ed65d1a4788f647f101e08323a4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "16b8eca3a38fbfd29b9b3a9a05bdbb51dc865841", "chunk": "diff --git a/sys/src/main/java/com/alibaba/nacos/sys/utils/InetUtils.java b/sys/src/main/java/com/alibaba/nacos/sys/utils/InetUtils.java\nindex 239a45b80..65771d8cf 100644\n--- a/sys/src/main/java/com/alibaba/nacos/sys/utils/InetUtils.java\n+++ b/sys/src/main/java/com/alibaba/nacos/sys/utils/InetUtils.java\n\n@@ -229,11 +229,11 @@ public class InetUtils {\n      */\n     public static boolean isDomain(String str) {\n         InetSocketAddress address = new InetSocketAddress(str, 0);\n-        boolean isResolved = !address.isUnresolved();\n-        if (isResolved) {\n+        boolean unResolved = address.isUnresolved();\n+        if (unResolved) {\n             LOG.warn(\"the domain: '\" + str + \"' can not be resolved\");\n         }\n-        return isResolved;\n+        return !unResolved;\n     }\n     \n     /**\n"}}, {"oid": "16b8eca3a38fbfd29b9b3a9a05bdbb51dc865841", "url": "https://github.com/alibaba/nacos/commit/16b8eca3a38fbfd29b9b3a9a05bdbb51dc865841", "message": "fix vaiable name", "committedDate": "2020-09-30T09:58:00Z", "type": "commit"}]}