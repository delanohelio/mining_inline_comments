{"pr_number": 2403, "pr_title": "fix checksum bug #2401", "pr_createdAt": "2020-03-03T07:54:17Z", "pr_url": "https://github.com/alibaba/nacos/pull/2403", "timeline": [{"oid": "b76c040826b168cab73a9cebe77ff4c134df4e3f", "url": "https://github.com/alibaba/nacos/commit/b76c040826b168cab73a9cebe77ff4c134df4e3f", "message": "fix checksum bug", "committedDate": "2020-03-03T07:41:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njg0OTc2MQ==", "url": "https://github.com/alibaba/nacos/pull/2403#discussion_r386849761", "bodyText": "Can ThreadLocal be used to avoid lock contention", "author": "chuntaojun", "createdAt": "2020-03-03T07:59:44Z", "path": "naming/src/main/java/com/alibaba/nacos/naming/core/Instances.java", "diffHunk": "@@ -84,8 +86,10 @@ private String recalculateChecksum() {\n         }\n \n         if (MESSAGE_DIGEST != null) {\n-            checksum =\n-                new BigInteger(1, MESSAGE_DIGEST.digest((sb.toString()).getBytes(Charset.forName(\"UTF-8\")))).toString(16);\n+            synchronized (LOCK) {", "originalCommit": "b76c040826b168cab73a9cebe77ff4c134df4e3f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njg1MDM0OQ==", "url": "https://github.com/alibaba/nacos/pull/2403#discussion_r386850349", "bodyText": "okay", "author": "lkxiaolou", "createdAt": "2020-03-03T08:01:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njg0OTc2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njg1OTU1Ng==", "url": "https://github.com/alibaba/nacos/pull/2403#discussion_r386859556", "bodyText": "Can ThreadLocal be used to avoid lock contention\n\ndone", "author": "lkxiaolou", "createdAt": "2020-03-03T08:24:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njg0OTc2MQ=="}], "type": "inlineReview", "revised_code": {"commit": "c7ca2c1df4de414bfa3d09dd9e15b008662e1de9", "chunk": "diff --git a/naming/src/main/java/com/alibaba/nacos/naming/core/Instances.java b/naming/src/main/java/com/alibaba/nacos/naming/core/Instances.java\nindex ec1500155..61ccc1d6d 100644\n--- a/naming/src/main/java/com/alibaba/nacos/naming/core/Instances.java\n+++ b/naming/src/main/java/com/alibaba/nacos/naming/core/Instances.java\n\n@@ -85,11 +84,10 @@ public class Instances implements Record {\n             sb.append(\",\");\n         }\n \n-        if (MESSAGE_DIGEST != null) {\n-            synchronized (LOCK) {\n-                checksum =\n-                        new BigInteger(1, MESSAGE_DIGEST.digest((sb.toString()).getBytes(Charset.forName(\"UTF-8\")))).toString(16);\n-            }\n+        if (MESSAGE_DIGEST_LOCAL.get() != null) {\n+            checksum = new BigInteger(1,\n+                    MESSAGE_DIGEST_LOCAL.get().digest((sb.toString()).getBytes(Charset.forName(\"UTF-8\"))))\n+                    .toString(16);\n         } else {\n             checksum = RandomStringUtils.randomAscii(32);\n         }\n"}}, {"oid": "c7ca2c1df4de414bfa3d09dd9e15b008662e1de9", "url": "https://github.com/alibaba/nacos/commit/c7ca2c1df4de414bfa3d09dd9e15b008662e1de9", "message": "\u6539\u4e3athreadLocal\u5b9e\u73b0", "committedDate": "2020-03-03T08:22:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjkxODgxNw==", "url": "https://github.com/alibaba/nacos/pull/2403#discussion_r386918817", "bodyText": "Here, you can consider holding the MessageDigest with a local variable to avoid getting again later", "author": "chuntaojun", "createdAt": "2020-03-03T10:13:51Z", "path": "naming/src/main/java/com/alibaba/nacos/naming/core/Instances.java", "diffHunk": "@@ -83,9 +84,10 @@ private String recalculateChecksum() {\n             sb.append(\",\");\n         }\n \n-        if (MESSAGE_DIGEST != null) {\n-            checksum =\n-                new BigInteger(1, MESSAGE_DIGEST.digest((sb.toString()).getBytes(Charset.forName(\"UTF-8\")))).toString(16);\n+        if (MESSAGE_DIGEST_LOCAL.get() != null) {", "originalCommit": "c7ca2c1df4de414bfa3d09dd9e15b008662e1de9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjkzODIxNA==", "url": "https://github.com/alibaba/nacos/pull/2403#discussion_r386938214", "bodyText": "Here, you can consider holding the MessageDigest with a local variable to avoid getting again later\n\ndone", "author": "lkxiaolou", "createdAt": "2020-03-03T10:48:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjkxODgxNw=="}], "type": "inlineReview", "revised_code": {"commit": "e70787b25b74e1eda2b0cb50a179b5942c1b6b35", "chunk": "diff --git a/naming/src/main/java/com/alibaba/nacos/naming/core/Instances.java b/naming/src/main/java/com/alibaba/nacos/naming/core/Instances.java\nindex 61ccc1d6d..837dfbae3 100644\n--- a/naming/src/main/java/com/alibaba/nacos/naming/core/Instances.java\n+++ b/naming/src/main/java/com/alibaba/nacos/naming/core/Instances.java\n\n@@ -84,10 +84,10 @@ public class Instances implements Record {\n             sb.append(\",\");\n         }\n \n-        if (MESSAGE_DIGEST_LOCAL.get() != null) {\n+        MessageDigest messageDigest = MESSAGE_DIGEST_LOCAL.get();\n+        if (messageDigest != null) {\n             checksum = new BigInteger(1,\n-                    MESSAGE_DIGEST_LOCAL.get().digest((sb.toString()).getBytes(Charset.forName(\"UTF-8\"))))\n-                    .toString(16);\n+                    messageDigest.digest((sb.toString()).getBytes(Charset.forName(\"UTF-8\")))).toString(16);\n         } else {\n             checksum = RandomStringUtils.randomAscii(32);\n         }\n"}}, {"oid": "e70787b25b74e1eda2b0cb50a179b5942c1b6b35", "url": "https://github.com/alibaba/nacos/commit/e70787b25b74e1eda2b0cb50a179b5942c1b6b35", "message": "commit", "committedDate": "2020-03-03T10:47:13Z", "type": "commit"}, {"oid": "83c098b8caba3855a1f4eb1fecd8b463e2877d23", "url": "https://github.com/alibaba/nacos/commit/83c098b8caba3855a1f4eb1fecd8b463e2877d23", "message": "\u7edf\u4e00md5\u8ba1\u7b97", "committedDate": "2020-03-14T09:54:06Z", "type": "commit"}]}