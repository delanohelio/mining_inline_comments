{"pr_number": 4244, "pr_title": "[ISSUE #4225]  Replace http client in HttpHealthCheckProcessor", "pr_createdAt": "2020-11-17T07:12:43Z", "pr_url": "https://github.com/alibaba/nacos/pull/4244", "timeline": [{"oid": "003e1a97ccc59d10cee012cf021a24f724c67175", "url": "https://github.com/alibaba/nacos/commit/003e1a97ccc59d10cee012cf021a24f724c67175", "message": "for #42255\uff0c Replace http client in HttpHealthCheckProcessor.", "committedDate": "2020-11-16T02:50:58Z", "type": "commit"}, {"oid": "893d36a16c5a74830499e12243015b8f328f4764", "url": "https://github.com/alibaba/nacos/commit/893d36a16c5a74830499e12243015b8f328f4764", "message": "Restore the old version number.", "committedDate": "2020-11-17T07:05:05Z", "type": "commit"}, {"oid": "1fdd9a03c80d6f5168ad6b18be3dafae525762bb", "url": "https://github.com/alibaba/nacos/commit/1fdd9a03c80d6f5168ad6b18be3dafae525762bb", "message": "Merge branch 'develop' into develop-issue#4225\n\n# Conflicts:\n#\tcommon/src/main/java/com/alibaba/nacos/common/http/AbstractHttpClientFactory.java", "committedDate": "2020-11-17T07:14:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDkzNTI1NA==", "url": "https://github.com/alibaba/nacos/pull/4244#discussion_r524935254", "bodyText": "use getIoReactorConfig directly, no need to use attribute.", "author": "KomachiSion", "createdAt": "2020-11-17T07:33:01Z", "path": "common/src/main/java/com/alibaba/nacos/common/http/AbstractHttpClientFactory.java", "diffHunk": "@@ -70,20 +71,28 @@ public void onChanged(String filePath) {\n     public NacosAsyncRestTemplate createNacosAsyncRestTemplate() {\n         final HttpClientConfig originalRequestConfig = buildHttpClientConfig();\n         final RequestConfig requestConfig = getRequestConfig();\n+        final IOReactorConfig ioReactorConfig = getIoReactorConfig();\n         return new NacosAsyncRestTemplate(assignLogger(), new DefaultAsyncHttpClientRequest(\n                 HttpAsyncClients.custom()\n                         .addInterceptorLast(new RequestContent(true))\n+                        .setDefaultIOReactorConfig(ioReactorConfig)", "originalCommit": "1fdd9a03c80d6f5168ad6b18be3dafae525762bb", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ce4f1a5a1bd4704bc4424fe82bd0517e0eb57988", "chunk": "diff --git a/common/src/main/java/com/alibaba/nacos/common/http/AbstractHttpClientFactory.java b/common/src/main/java/com/alibaba/nacos/common/http/AbstractHttpClientFactory.java\nindex 8ef7eede0..368c602a5 100644\n--- a/common/src/main/java/com/alibaba/nacos/common/http/AbstractHttpClientFactory.java\n+++ b/common/src/main/java/com/alibaba/nacos/common/http/AbstractHttpClientFactory.java\n\n@@ -70,13 +70,11 @@ public abstract class AbstractHttpClientFactory implements HttpClientFactory {\n     @Override\n     public NacosAsyncRestTemplate createNacosAsyncRestTemplate() {\n         final HttpClientConfig originalRequestConfig = buildHttpClientConfig();\n-        final RequestConfig requestConfig = getRequestConfig();\n-        final IOReactorConfig ioReactorConfig = getIoReactorConfig();\n         return new NacosAsyncRestTemplate(assignLogger(), new DefaultAsyncHttpClientRequest(\n                 HttpAsyncClients.custom()\n                         .addInterceptorLast(new RequestContent(true))\n-                        .setDefaultIOReactorConfig(ioReactorConfig)\n-                        .setDefaultRequestConfig(requestConfig)\n+                        .setDefaultIOReactorConfig(getIoReactorConfig())\n+                        .setDefaultRequestConfig(getRequestConfig())\n                         .setMaxConnTotal(originalRequestConfig.getMaxConnTotal())\n                         .setMaxConnPerRoute(originalRequestConfig.getMaxConnPerRoute())\n                         .setUserAgent(originalRequestConfig.getUserAgent()).build()));\n"}}, {"oid": "ce4f1a5a1bd4704bc4424fe82bd0517e0eb57988", "url": "https://github.com/alibaba/nacos/commit/ce4f1a5a1bd4704bc4424fe82bd0517e0eb57988", "message": "Removes temporary attributes from a method.", "committedDate": "2020-11-17T07:42:52Z", "type": "commit"}, {"oid": "622b63430a4461ed3fefc9dcadecde66dd37e0c3", "url": "https://github.com/alibaba/nacos/commit/622b63430a4461ed3fefc9dcadecde66dd37e0c3", "message": "fix Code style.", "committedDate": "2020-11-17T09:03:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTAxOTc1NQ==", "url": "https://github.com/alibaba/nacos/pull/4244#discussion_r525019755", "bodyText": "\u53ef\u4ee5\u5305\u88c5\u5728http\u6a21\u5757\u5185\u90e8\uff0cHttpUtils.isTimeoutException()", "author": "chuntaojun", "createdAt": "2020-11-17T09:48:44Z", "path": "naming/src/main/java/com/alibaba/nacos/naming/healthcheck/HttpHealthCheckProcessor.java", "diffHunk": "@@ -180,18 +153,17 @@ public Integer onCompleted(Response response) throws Exception {\n                         switchDomain.getHttpHealthParams());\n             }\n             \n-            return httpCode;\n         }\n         \n         @Override\n-        public void onThrowable(Throwable t) {\n+        public void onError(Throwable t) {\n             ip.setCheckRt(System.currentTimeMillis() - startTime);\n             \n             Throwable cause = t;\n             int maxStackDepth = 50;\n             for (int deepth = 0; deepth < maxStackDepth && cause != null; deepth++) {\n                 if (cause instanceof SocketTimeoutException || cause instanceof ConnectTimeoutException", "originalCommit": "622b63430a4461ed3fefc9dcadecde66dd37e0c3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "03dc338bf4b8d470dcf06d9e3ed8c82fcfaf60b5", "chunk": "diff --git a/naming/src/main/java/com/alibaba/nacos/naming/healthcheck/HttpHealthCheckProcessor.java b/naming/src/main/java/com/alibaba/nacos/naming/healthcheck/HttpHealthCheckProcessor.java\nindex 4997d59a6..fd7fdaf3e 100644\n--- a/naming/src/main/java/com/alibaba/nacos/naming/healthcheck/HttpHealthCheckProcessor.java\n+++ b/naming/src/main/java/com/alibaba/nacos/naming/healthcheck/HttpHealthCheckProcessor.java\n\n@@ -162,9 +160,7 @@ public class HttpHealthCheckProcessor implements HealthCheckProcessor {\n             Throwable cause = t;\n             int maxStackDepth = 50;\n             for (int deepth = 0; deepth < maxStackDepth && cause != null; deepth++) {\n-                if (cause instanceof SocketTimeoutException || cause instanceof ConnectTimeoutException\n-                        || cause instanceof org.apache.http.conn.ConnectTimeoutException\n-                        || cause instanceof TimeoutException || cause.getCause() instanceof TimeoutException) {\n+                if (HttpUtils.isTimeoutException(t)) {\n                     \n                     healthCheckCommon.checkFail(ip, task, \"http:timeout:\" + cause.getMessage());\n                     healthCheckCommon.reEvaluateCheckRT(task.getCheckRtNormalized() * 2, task,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTMwODMwNA==", "url": "https://github.com/alibaba/nacos/pull/4244#discussion_r525308304", "bodyText": "\u8fd9\u91cc\u7684\u53c2\u6570\u5e94\u5f53\u540e\u9762\u53ef\u4ee5\u5bf9\u5916\u53ef\u914d\u7f6e\u5316\u7684\uff0c\u800c\u4e0d\u662f\u5199\u6b7b\u7684", "author": "chuntaojun", "createdAt": "2020-11-17T16:37:57Z", "path": "naming/src/main/java/com/alibaba/nacos/naming/misc/HttpClientManager.java", "diffHunk": "@@ -146,4 +163,27 @@ protected Logger assignLogger() {\n             return SRV_LOG;\n         }\n     }\n+    \n+    private static class ProcessorHttpClientFactory extends AbstractHttpClientFactory {", "originalCommit": "622b63430a4461ed3fefc9dcadecde66dd37e0c3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "03dc338bf4b8d470dcf06d9e3ed8c82fcfaf60b5", "chunk": "diff --git a/naming/src/main/java/com/alibaba/nacos/naming/misc/HttpClientManager.java b/naming/src/main/java/com/alibaba/nacos/naming/misc/HttpClientManager.java\nindex 8253f520c..795d6650d 100644\n--- a/naming/src/main/java/com/alibaba/nacos/naming/misc/HttpClientManager.java\n+++ b/naming/src/main/java/com/alibaba/nacos/naming/misc/HttpClientManager.java\n\n@@ -148,16 +147,14 @@ public class HttpClientManager {\n     }\n     \n     private static class ApacheSyncHttpClientFactory extends AbstractApacheHttpClientFactory {\n-    \n+        \n         @Override\n         protected HttpClientConfig buildHttpClientConfig() {\n-            return HttpClientConfig.builder()\n-                    .setConnectionTimeToLive(500, TimeUnit.MILLISECONDS)\n+            return HttpClientConfig.builder().setConnectionTimeToLive(500, TimeUnit.MILLISECONDS)\n                     .setMaxConnTotal(Runtime.getRuntime().availableProcessors() * 2)\n-                    .setMaxConnPerRoute(Runtime.getRuntime().availableProcessors())\n-                    .setMaxRedirects(0).build();\n+                    .setMaxConnPerRoute(Runtime.getRuntime().availableProcessors()).setMaxRedirects(0).build();\n         }\n-    \n+        \n         @Override\n         protected Logger assignLogger() {\n             return SRV_LOG;\n"}}, {"oid": "03dc338bf4b8d470dcf06d9e3ed8c82fcfaf60b5", "url": "https://github.com/alibaba/nacos/commit/03dc338bf4b8d470dcf06d9e3ed8c82fcfaf60b5", "message": "Use the EnvUtil.getProperty() method to get the HTTP parameter, leaving it customizable.", "committedDate": "2020-11-18T08:23:20Z", "type": "commit"}, {"oid": "bc8f87bcb62ce6470be69b260840668671b21e7c", "url": "https://github.com/alibaba/nacos/commit/bc8f87bcb62ce6470be69b260840668671b21e7c", "message": "Fix error symbol.", "committedDate": "2020-11-18T08:28:56Z", "type": "commit"}, {"oid": "9dfc61cfa14aeccf47488efecc860ae2004563a9", "url": "https://github.com/alibaba/nacos/commit/9dfc61cfa14aeccf47488efecc860ae2004563a9", "message": "Remove excess package import.", "committedDate": "2020-11-18T08:34:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjA2MjY3MQ==", "url": "https://github.com/alibaba/nacos/pull/4244#discussion_r526062671", "bodyText": "Static final variable get from properties? Static final means that it's a constants. Should not be configed.", "author": "KomachiSion", "createdAt": "2020-11-18T12:52:38Z", "path": "naming/src/main/java/com/alibaba/nacos/naming/misc/HttpClientManager.java", "diffHunk": "@@ -131,16 +147,58 @@ protected Logger assignLogger() {\n     }\n     \n     private static class ApacheSyncHttpClientFactory extends AbstractApacheHttpClientFactory {\n-    \n+        \n         @Override\n         protected HttpClientConfig buildHttpClientConfig() {\n-            return HttpClientConfig.builder()\n-                    .setConnectionTimeToLive(500, TimeUnit.MILLISECONDS)\n+            return HttpClientConfig.builder().setConnectionTimeToLive(500, TimeUnit.MILLISECONDS)\n                     .setMaxConnTotal(Runtime.getRuntime().availableProcessors() * 2)\n-                    .setMaxConnPerRoute(Runtime.getRuntime().availableProcessors())\n-                    .setMaxRedirects(0).build();\n+                    .setMaxConnPerRoute(Runtime.getRuntime().availableProcessors()).setMaxRedirects(0).build();\n+        }\n+        \n+        @Override\n+        protected Logger assignLogger() {\n+            return SRV_LOG;\n         }\n+    }\n     \n+    private static class ProcessorHttpClientFactory extends AbstractHttpClientFactory {\n+        \n+        private static final int CONNECTION_REQUEST_TIMEOUT = EnvUtil", "originalCommit": "9dfc61cfa14aeccf47488efecc860ae2004563a9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2b585c9e91e6bce64709e7923715e3c2078a4161", "chunk": "diff --git a/naming/src/main/java/com/alibaba/nacos/naming/misc/HttpClientManager.java b/naming/src/main/java/com/alibaba/nacos/naming/misc/HttpClientManager.java\nindex 795d6650d..4173d0012 100644\n--- a/naming/src/main/java/com/alibaba/nacos/naming/misc/HttpClientManager.java\n+++ b/naming/src/main/java/com/alibaba/nacos/naming/misc/HttpClientManager.java\n\n@@ -163,42 +161,14 @@ public class HttpClientManager {\n     \n     private static class ProcessorHttpClientFactory extends AbstractHttpClientFactory {\n         \n-        private static final int CONNECTION_REQUEST_TIMEOUT = EnvUtil\n-                .getProperty(Constants.NAMING_PERSISTENT_HEALTH_CHECK_HTTP_CONNECTION_REQUEST_TIMEOUT, Integer.class,\n-                        500);\n-        \n-        private static final int READ_TIME_OUT_MILLIS = EnvUtil\n-                .getProperty(Constants.NAMING_PERSISTENT_HEALTH_CHECK_HTTP_READ_TIMEOUT_MS, Integer.class, 500);\n-        \n-        private static final int CON_TIME_OUT_MILLIS = EnvUtil\n-                .getProperty(Constants.NAMING_PERSISTENT_HEALTH_CHECK_HTTP_CON_TIMEOUT_MS, Integer.class, 500);\n-        \n-        private static final int IO_THREAD_COUNT = EnvUtil\n-                .getProperty(Constants.NAMING_PERSISTENT_HEALTH_CHECK_HTTP_IO_THREAD_COUNT, Integer.class, 1);\n-        \n-        private static final int MAX_REDIRECTS = EnvUtil\n-                .getProperty(Constants.NAMING_PERSISTENT_HEALTH_CHECK_HTTP_MAX_REDIRECTS, Integer.class, 0);\n-        \n-        private static final int MAX_CONN_TOTAL = EnvUtil\n-                .getProperty(Constants.NAMING_PERSISTENT_HEALTH_CHECK_HTTP_MAX_CONN_TOTAL, Integer.class, -1);\n-        \n-        private static final int MAX_CONN_PER_ROUTE = EnvUtil\n-                .getProperty(Constants.NAMING_PERSISTENT_HEALTH_CHECK_HTTP_MAX_CONN_PER_ROUTE, Integer.class, -1);\n-        \n         @Override\n         protected HttpClientConfig buildHttpClientConfig() {\n-            return HttpClientConfig.builder()\n-                    .setConnectionRequestTimeout(CONNECTION_REQUEST_TIMEOUT)\n-                    .setReadTimeOutMillis(READ_TIME_OUT_MILLIS)\n-                    .setConTimeOutMillis(CON_TIME_OUT_MILLIS)\n-                    .setIoThreadCount(IO_THREAD_COUNT)\n-                    .setMaxRedirects(MAX_REDIRECTS)\n-                    .setMaxConnTotal(MAX_CONN_TOTAL)\n-                    .setMaxConnPerRoute(MAX_CONN_PER_ROUTE)\n-                    .setContentCompressionEnabled(false)\n-                    .setUserAgent(\"VIPServer\").build();\n+            return HttpClientConfig.builder().setConnectionRequestTimeout(500).setReadTimeOutMillis(500)\n+                    .setConTimeOutMillis(500).setIoThreadCount(1).setContentCompressionEnabled(false).setMaxRedirects(0)\n+                    .setMaxConnTotal(-1).setMaxConnPerRoute(-1).setUserAgent(\"VIPServer\").build();\n         }\n         \n+        \n         @Override\n         protected Logger assignLogger() {\n             return SRV_LOG;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjA2Mjk5Mg==", "url": "https://github.com/alibaba/nacos/pull/4244#discussion_r526062992", "bodyText": "Naming Constants should not be in parent module.", "author": "KomachiSion", "createdAt": "2020-11-18T12:53:10Z", "path": "sys/src/main/java/com/alibaba/nacos/sys/env/Constants.java", "diffHunk": "@@ -63,4 +63,33 @@\n     String NACOS_SERVER_HEADER = \"Nacos-Server\";\n     \n     String REQUEST_PATH_SEPARATOR = \"-->\";\n+    \n+    /**\n+     * ============ naming persistent health check http env.\n+     */\n+    String NAMING_PERSISTENT = \"nacos.naming.persistent\";", "originalCommit": "9dfc61cfa14aeccf47488efecc860ae2004563a9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2b585c9e91e6bce64709e7923715e3c2078a4161", "chunk": "diff --git a/sys/src/main/java/com/alibaba/nacos/sys/env/Constants.java b/sys/src/main/java/com/alibaba/nacos/sys/env/Constants.java\nindex fa31bdc50..20addac2c 100644\n--- a/sys/src/main/java/com/alibaba/nacos/sys/env/Constants.java\n+++ b/sys/src/main/java/com/alibaba/nacos/sys/env/Constants.java\n\n@@ -63,33 +63,4 @@ public interface Constants {\n     String NACOS_SERVER_HEADER = \"Nacos-Server\";\n     \n     String REQUEST_PATH_SEPARATOR = \"-->\";\n-    \n-    /**\n-     * ============ naming persistent health check http env.\n-     */\n-    String NAMING_PERSISTENT = \"nacos.naming.persistent\";\n-    \n-    String NAMING_PERSISTENT_HEALTH_CHECK_HTTP = NAMING_PERSISTENT + \".\" + \"health_check.http\";\n-    \n-    String NAMING_PERSISTENT_HEALTH_CHECK_HTTP_CONNECTION_REQUEST_TIMEOUT =\n-            NAMING_PERSISTENT_HEALTH_CHECK_HTTP + \".\" + \"connection_request_timeout\";\n-    \n-    String NAMING_PERSISTENT_HEALTH_CHECK_HTTP_READ_TIMEOUT_MS =\n-            NAMING_PERSISTENT_HEALTH_CHECK_HTTP + \".\" + \"read_timeout_ms\";\n-    \n-    String NAMING_PERSISTENT_HEALTH_CHECK_HTTP_CON_TIMEOUT_MS =\n-            NAMING_PERSISTENT_HEALTH_CHECK_HTTP + \".\" + \"con_timeout_ms\";\n-    \n-    String NAMING_PERSISTENT_HEALTH_CHECK_HTTP_IO_THREAD_COUNT =\n-            NAMING_PERSISTENT_HEALTH_CHECK_HTTP + \".\" + \"io_thread_count\";\n-    \n-    String NAMING_PERSISTENT_HEALTH_CHECK_HTTP_MAX_REDIRECTS =\n-            NAMING_PERSISTENT_HEALTH_CHECK_HTTP + \".\" + \"max_redirects\";\n-    \n-    String NAMING_PERSISTENT_HEALTH_CHECK_HTTP_MAX_CONN_TOTAL =\n-            NAMING_PERSISTENT_HEALTH_CHECK_HTTP + \".\" + \"max_conn_total\";\n-    \n-    String NAMING_PERSISTENT_HEALTH_CHECK_HTTP_MAX_CONN_PER_ROUTE =\n-            NAMING_PERSISTENT_HEALTH_CHECK_HTTP + \".\" + \"max_conn_per_route\";\n-    \n }\n"}}, {"oid": "2b585c9e91e6bce64709e7923715e3c2078a4161", "url": "https://github.com/alibaba/nacos/commit/2b585c9e91e6bce64709e7923715e3c2078a4161", "message": "Rollback the code about the custom HTTP parameter.", "committedDate": "2020-11-18T13:31:00Z", "type": "commit"}, {"oid": "fae443b0a9c4fa8c23bda656537366f1a68e8bf8", "url": "https://github.com/alibaba/nacos/commit/fae443b0a9c4fa8c23bda656537366f1a68e8bf8", "message": "fix Code style.", "committedDate": "2020-11-18T13:31:34Z", "type": "commit"}]}