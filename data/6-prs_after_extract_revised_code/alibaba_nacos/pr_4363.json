{"pr_number": 4363, "pr_title": "Add the function of automatically clearing empty services", "pr_createdAt": "2020-11-29T14:25:13Z", "pr_url": "https://github.com/alibaba/nacos/pull/4363", "timeline": [{"oid": "c69667d0b0a681fd53121b3a306124875d46e5d8", "url": "https://github.com/alibaba/nacos/commit/c69667d0b0a681fd53121b3a306124875d46e5d8", "message": "Add the function of automatically clearing empty services", "committedDate": "2020-11-29T14:23:30Z", "type": "commit"}, {"oid": "ac9b04bfa58118e08fb060afd7a5008dc674a9ab", "url": "https://github.com/alibaba/nacos/commit/ac9b04bfa58118e08fb060afd7a5008dc674a9ab", "message": "Fix checkstyle issue", "committedDate": "2020-11-29T15:03:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjMwNjA4Mg==", "url": "https://github.com/alibaba/nacos/pull/4363#discussion_r532306082", "bodyText": "Whether judge isEmpty first will be better?", "author": "KomachiSion", "createdAt": "2020-11-30T01:40:34Z", "path": "naming/src/main/java/com/alibaba/nacos/naming/core/v2/cleaner/EmptyServiceAutoCleanerV2.java", "diffHunk": "@@ -25,13 +38,48 @@\n     \n     private static final String EMPTY_SERVICE = \"emptyService\";\n     \n+    private final ClientServiceIndexesManager clientServiceIndexesManager;\n+    \n+    public EmptyServiceAutoCleanerV2(ClientServiceIndexesManager clientServiceIndexesManager) {\n+        this.clientServiceIndexesManager = clientServiceIndexesManager;\n+        // TODO get internal from config\n+        GlobalExecutor.scheduleExpiredClientCleaner(this, TimeUnit.SECONDS.toMillis(30), TimeUnit.SECONDS.toMillis(20),\n+                TimeUnit.MILLISECONDS);\n+        \n+    }\n+    \n     @Override\n     public String getType() {\n         return EMPTY_SERVICE;\n     }\n     \n     @Override\n     public void doClean() {\n+        ServiceManager serviceManager = ServiceManager.getInstance();\n+        // Parallel flow opening threshold\n+        int parallelSize = 100;\n+        \n+        for (String each : serviceManager.getAllNamespaces()) {\n+            Set<Service> services = serviceManager.getSingletons(each);\n+            Stream<Service> stream = services.size() > parallelSize ? services.parallelStream() : services.stream();\n+            stream.forEach(this::cleanEmptyService);\n+        }\n+    }\n+    \n+    private void cleanEmptyService(Service service) {\n+        Loggers.SRV_LOG.warn(\"namespace : {}, [{}] services are automatically cleaned\", service.getNamespace(),\n+                service.getGroupedServiceName());\n+        Collection<String> registeredService = clientServiceIndexesManager.getAllClientsRegisteredService(service);\n+        if (isTimeExpired(service) && registeredService.isEmpty()) {", "originalCommit": "ac9b04bfa58118e08fb060afd7a5008dc674a9ab", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a5a389ae2e8d65da7dffd16e2ee818569f892dc8", "chunk": "diff --git a/naming/src/main/java/com/alibaba/nacos/naming/core/v2/cleaner/EmptyServiceAutoCleanerV2.java b/naming/src/main/java/com/alibaba/nacos/naming/core/v2/cleaner/EmptyServiceAutoCleanerV2.java\nindex 61761485c..b67359b8d 100644\n--- a/naming/src/main/java/com/alibaba/nacos/naming/core/v2/cleaner/EmptyServiceAutoCleanerV2.java\n+++ b/naming/src/main/java/com/alibaba/nacos/naming/core/v2/cleaner/EmptyServiceAutoCleanerV2.java\n\n@@ -73,7 +73,7 @@ public class EmptyServiceAutoCleanerV2 extends AbstractNamingCleaner {\n         if (isTimeExpired(service) && registeredService.isEmpty()) {\n             clientServiceIndexesManager.removePublisherIndexesByEmptyService(service);\n             ServiceManager.getInstance().removeSingleton(service);\n-            NotifyCenter.publishEvent(new ServiceEvent.ServiceRemovedEvent(service));\n+            NotifyCenter.publishEvent(new MetadataEvent.ServiceMetadataEvent(service, true));\n         }\n     }\n     \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjMwNjg4MA==", "url": "https://github.com/alibaba/nacos/pull/4363#discussion_r532306880", "bodyText": "I think this event is not useful.\nIt can be replaced by ServiceMetadataEvent(service, true)", "author": "KomachiSion", "createdAt": "2020-11-30T01:44:56Z", "path": "naming/src/main/java/com/alibaba/nacos/naming/core/v2/event/service/ServiceEvent.java", "diffHunk": "@@ -56,4 +56,16 @@ public ServiceChangedEvent(Service service, boolean incrementRevision) {\n             }\n         }\n     }\n+    \n+    /**\n+     * Service data changed event.\n+     */\n+    public static class ServiceRemovedEvent extends ServiceEvent {", "originalCommit": "ac9b04bfa58118e08fb060afd7a5008dc674a9ab", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a5a389ae2e8d65da7dffd16e2ee818569f892dc8", "chunk": "diff --git a/naming/src/main/java/com/alibaba/nacos/naming/core/v2/event/service/ServiceEvent.java b/naming/src/main/java/com/alibaba/nacos/naming/core/v2/event/service/ServiceEvent.java\nindex 7d7e6f806..1323f9b48 100644\n--- a/naming/src/main/java/com/alibaba/nacos/naming/core/v2/event/service/ServiceEvent.java\n+++ b/naming/src/main/java/com/alibaba/nacos/naming/core/v2/event/service/ServiceEvent.java\n\n@@ -57,15 +57,4 @@ public class ServiceEvent extends SlowEvent {\n         }\n     }\n     \n-    /**\n-     * Service data changed event.\n-     */\n-    public static class ServiceRemovedEvent extends ServiceEvent {\n-        \n-        private static final long serialVersionUID = 2123694271992630822L;\n-        \n-        public ServiceRemovedEvent(Service service) {\n-            super(service);\n-        }\n-    }\n }\n"}}, {"oid": "a5a389ae2e8d65da7dffd16e2ee818569f892dc8", "url": "https://github.com/alibaba/nacos/commit/a5a389ae2e8d65da7dffd16e2ee818569f892dc8", "message": "Delete the remove event of the service", "committedDate": "2020-11-30T06:48:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjM4NjIxMQ==", "url": "https://github.com/alibaba/nacos/pull/4363#discussion_r532386211", "bodyText": "An invalid blank?", "author": "KomachiSion", "createdAt": "2020-11-30T07:14:13Z", "path": "naming/src/main/java/com/alibaba/nacos/naming/core/v2/metadata/NamingMetadataManager.java", "diffHunk": "@@ -166,7 +166,7 @@ public void onEvent(Event event) {\n             handleInstanceMetadataEvent((MetadataEvent.InstanceMetadataEvent) event);\n         } else if (event instanceof MetadataEvent.ServiceMetadataEvent) {\n             handleServiceMetadataEvent((MetadataEvent.ServiceMetadataEvent) event);\n-        } else {\n+        }  else {", "originalCommit": "a5a389ae2e8d65da7dffd16e2ee818569f892dc8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "4508982b07b3581349d1addde55b080676a91b9a", "chunk": "diff --git a/naming/src/main/java/com/alibaba/nacos/naming/core/v2/metadata/NamingMetadataManager.java b/naming/src/main/java/com/alibaba/nacos/naming/core/v2/metadata/NamingMetadataManager.java\nindex 39a2bcadf..f52775b93 100644\n--- a/naming/src/main/java/com/alibaba/nacos/naming/core/v2/metadata/NamingMetadataManager.java\n+++ b/naming/src/main/java/com/alibaba/nacos/naming/core/v2/metadata/NamingMetadataManager.java\n\n@@ -166,7 +166,7 @@ public class NamingMetadataManager extends SmartSubscriber {\n             handleInstanceMetadataEvent((MetadataEvent.InstanceMetadataEvent) event);\n         } else if (event instanceof MetadataEvent.ServiceMetadataEvent) {\n             handleServiceMetadataEvent((MetadataEvent.ServiceMetadataEvent) event);\n-        }  else {\n+        } else {\n             handleClientDisconnectEvent((ClientEvent.ClientDisconnectEvent) event);\n         }\n     }\n"}}, {"oid": "4508982b07b3581349d1addde55b080676a91b9a", "url": "https://github.com/alibaba/nacos/commit/4508982b07b3581349d1addde55b080676a91b9a", "message": "Fix checkstyle issue", "committedDate": "2020-11-30T07:18:21Z", "type": "commit"}]}