{"pr_number": 3763, "pr_title": "[ISSUE#3192] naming module replace http client", "pr_createdAt": "2020-09-05T08:54:49Z", "pr_url": "https://github.com/alibaba/nacos/pull/3763", "timeline": [{"oid": "c78d86bfe016668f5ae70f9822b14b5cdcdc8332", "url": "https://github.com/alibaba/nacos/commit/c78d86bfe016668f5ae70f9822b14b5cdcdc8332", "message": "naming module replace http client", "committedDate": "2020-08-23T09:03:20Z", "type": "commit"}, {"oid": "0bb3bfcc9767ee201c75c931ac77f6fbb15581e9", "url": "https://github.com/alibaba/nacos/commit/0bb3bfcc9767ee201c75c931ac77f6fbb15581e9", "message": "refactor: naming module replace http client.", "committedDate": "2020-08-25T12:10:32Z", "type": "commit"}, {"oid": "3e3f9f2671c882041160bcb4a6651fa017dbb18c", "url": "https://github.com/alibaba/nacos/commit/3e3f9f2671c882041160bcb4a6651fa017dbb18c", "message": "Merge branch 'develop' into develop-issue#3192", "committedDate": "2020-08-26T05:02:50Z", "type": "commit"}, {"oid": "00df691a779abaf7eadca398e9269479c821d18a", "url": "https://github.com/alibaba/nacos/commit/00df691a779abaf7eadca398e9269479c821d18a", "message": "refactor: naming module replace http client.", "committedDate": "2020-08-27T05:06:37Z", "type": "commit"}, {"oid": "f079254e7233e9c8486651110644ffedfb4850e4", "url": "https://github.com/alibaba/nacos/commit/f079254e7233e9c8486651110644ffedfb4850e4", "message": "refactor: Add apache http client Factory.", "committedDate": "2020-08-28T11:52:39Z", "type": "commit"}, {"oid": "3eefe3e1c324d36bc8ec00cd697ad4f34768e61c", "url": "https://github.com/alibaba/nacos/commit/3eefe3e1c324d36bc8ec00cd697ad4f34768e61c", "message": "Merge branch 'develop' into develop-issue#3192\n\n# Conflicts:\n#\tcommon/src/main/java/com/alibaba/nacos/common/http/AbstractHttpClientFactory.java\n#\tcommon/src/main/java/com/alibaba/nacos/common/http/BaseHttpMethod.java\n#\tnaming/src/main/java/com/alibaba/nacos/naming/misc/NamingProxy.java", "committedDate": "2020-09-01T06:04:48Z", "type": "commit"}, {"oid": "48dd543114a6be999441f81ff7658ea250aa66a1", "url": "https://github.com/alibaba/nacos/commit/48dd543114a6be999441f81ff7658ea250aa66a1", "message": "refactor: naming module replace http client.", "committedDate": "2020-09-02T09:24:10Z", "type": "commit"}, {"oid": "799582fc21bf833fc6648e84eff934ecc47df2ff", "url": "https://github.com/alibaba/nacos/commit/799582fc21bf833fc6648e84eff934ecc47df2ff", "message": "fix code style", "committedDate": "2020-09-02T15:21:04Z", "type": "commit"}, {"oid": "2994fa50b11d8169acb87965f640878abec64405", "url": "https://github.com/alibaba/nacos/commit/2994fa50b11d8169acb87965f640878abec64405", "message": "refactor: Add http client config", "committedDate": "2020-09-02T15:53:55Z", "type": "commit"}, {"oid": "23b486f1120f909045a0f29db04cf7846a613e93", "url": "https://github.com/alibaba/nacos/commit/23b486f1120f909045a0f29db04cf7846a613e93", "message": "refactor: naming module HttpClientManager change", "committedDate": "2020-09-04T06:54:28Z", "type": "commit"}, {"oid": "353572194404e43e7cb8b9016ca8b01da38fabc3", "url": "https://github.com/alibaba/nacos/commit/353572194404e43e7cb8b9016ca8b01da38fabc3", "message": "Merge branch 'develop' into develop-issue#3192\n\n# Conflicts:\n#\tnaming/src/main/java/com/alibaba/nacos/naming/consistency/persistent/raft/RaftCore.java", "committedDate": "2020-09-04T07:00:35Z", "type": "commit"}, {"oid": "92152fef6bac447a3b7b77e94f3ba025917ddba5", "url": "https://github.com/alibaba/nacos/commit/92152fef6bac447a3b7b77e94f3ba025917ddba5", "message": "refactor: naming module HttpClientManager change", "committedDate": "2020-09-05T08:48:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDE2MTAwMQ==", "url": "https://github.com/alibaba/nacos/pull/3763#discussion_r484161001", "bodyText": "In this part, I suggest that you refactor like following:\nif (!result.ok()) {\n    Loggers.RAFT.warn(...);\n    return;\n}\n\nthe other codes do not changed except remove `return 0`", "author": "KomachiSion", "createdAt": "2020-09-07T03:05:10Z", "path": "naming/src/main/java/com/alibaba/nacos/naming/consistency/persistent/raft/RaftCore.java", "diffHunk": "@@ -287,21 +294,28 @@ public void signalDelete(final String key) throws Exception {\n             \n             for (final String server : peers.allServersWithoutMySelf()) {\n                 String url = buildUrl(server, API_ON_DEL);\n-                HttpClient.asyncHttpDeleteLarge(url, null, json.toString(), new AsyncCompletionHandler<Integer>() {\n+                asyncRestTemplate.delete(url, Header.EMPTY, json.toString(), String.class, new Callback<String>() {\n                     @Override\n-                    public Integer onCompleted(Response response) throws Exception {\n-                        if (response.getStatusCode() != HttpURLConnection.HTTP_OK) {\n+                    public void onReceive(RestResult<String> result) {\n+                        if (result.ok()) {", "originalCommit": "92152fef6bac447a3b7b77e94f3ba025917ddba5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f820f5def7949509c0a34b8f9540f08f19e54b3a", "chunk": "diff --git a/naming/src/main/java/com/alibaba/nacos/naming/consistency/persistent/raft/RaftCore.java b/naming/src/main/java/com/alibaba/nacos/naming/consistency/persistent/raft/RaftCore.java\nindex b54e60870..9ab014b6e 100644\n--- a/naming/src/main/java/com/alibaba/nacos/naming/consistency/persistent/raft/RaftCore.java\n+++ b/naming/src/main/java/com/alibaba/nacos/naming/consistency/persistent/raft/RaftCore.java\n\n@@ -294,28 +290,29 @@ public class RaftCore {\n             \n             for (final String server : peers.allServersWithoutMySelf()) {\n                 String url = buildUrl(server, API_ON_DEL);\n-                asyncRestTemplate.delete(url, Header.EMPTY, json.toString(), String.class, new Callback<String>() {\n+                HttpClient.asyncHttpDeleteLarge(url, null, json.toString(), new Callback<String>() {\n                     @Override\n                     public void onReceive(RestResult<String> result) {\n-                        if (result.ok()) {\n-                            RaftPeer local = peers.local();\n-                            \n-                            local.resetLeaderDue();\n-                        } else {\n+                        if (!result.ok()) {\n                             Loggers.RAFT\n                                     .warn(\"[RAFT] failed to delete data from peer, datumId={}, peer={}, http code={}\",\n                                             key, server, result.getCode());\n+                            return;\n                         }\n+    \n+                        RaftPeer local = peers.local();\n+    \n+                        local.resetLeaderDue();\n                     }\n-                    \n+    \n                     @Override\n                     public void onError(Throwable throwable) {\n                         Loggers.RAFT.error(\"[RAFT] failed to delete data from peer\", throwable);\n                     }\n-                    \n+    \n                     @Override\n                     public void onCancel() {\n-                    \n+        \n                     }\n                 });\n             }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDE2MTIzNg==", "url": "https://github.com/alibaba/nacos/pull/3763#discussion_r484161236", "bodyText": "Same suggest as above. Otherwise others code do not change in fact, but the author changed.", "author": "KomachiSion", "createdAt": "2020-09-07T03:06:17Z", "path": "naming/src/main/java/com/alibaba/nacos/naming/consistency/persistent/raft/RaftCore.java", "diffHunk": "@@ -458,22 +472,29 @@ private void sendVote() {\n             for (final String server : peers.allServersWithoutMySelf()) {\n                 final String url = buildUrl(server, API_VOTE);\n                 try {\n-                    HttpClient.asyncHttpPost(url, null, params, new AsyncCompletionHandler<Integer>() {\n+                    asyncRestTemplate.postForm(url, Header.EMPTY, params, String.class, new Callback<String>() {\n                         @Override\n-                        public Integer onCompleted(Response response) throws Exception {\n-                            if (response.getStatusCode() != HttpURLConnection.HTTP_OK) {\n-                                Loggers.RAFT\n-                                        .error(\"NACOS-RAFT vote failed: {}, url: {}\", response.getResponseBody(), url);\n-                                return 1;\n+                        public void onReceive(RestResult<String> result) {\n+                            if (result.ok()) {", "originalCommit": "92152fef6bac447a3b7b77e94f3ba025917ddba5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f820f5def7949509c0a34b8f9540f08f19e54b3a", "chunk": "diff --git a/naming/src/main/java/com/alibaba/nacos/naming/consistency/persistent/raft/RaftCore.java b/naming/src/main/java/com/alibaba/nacos/naming/consistency/persistent/raft/RaftCore.java\nindex b54e60870..9ab014b6e 100644\n--- a/naming/src/main/java/com/alibaba/nacos/naming/consistency/persistent/raft/RaftCore.java\n+++ b/naming/src/main/java/com/alibaba/nacos/naming/consistency/persistent/raft/RaftCore.java\n\n@@ -472,29 +469,31 @@ public class RaftCore {\n             for (final String server : peers.allServersWithoutMySelf()) {\n                 final String url = buildUrl(server, API_VOTE);\n                 try {\n-                    asyncRestTemplate.postForm(url, Header.EMPTY, params, String.class, new Callback<String>() {\n+                    HttpClient.asyncHttpPost(url, null, params, new Callback<String>() {\n                         @Override\n                         public void onReceive(RestResult<String> result) {\n-                            if (result.ok()) {\n-                                \n-                                RaftPeer peer = JacksonUtils.toObj(result.getData(), RaftPeer.class);\n-                                \n-                                Loggers.RAFT.info(\"received approve from peer: {}\", JacksonUtils.toJson(peer));\n-                                \n-                                peers.decideLeader(peer);\n-                            } else {\n-                                Loggers.RAFT.error(\"NACOS-RAFT vote failed: {}, url: {}\", result.getMessage(), url);\n+                            if (!result.ok()) {\n+                                Loggers.RAFT\n+                                        .error(\"NACOS-RAFT vote failed: {}, url: {}\", result.getCode(), url);\n+                                return;\n                             }\n+    \n+                            RaftPeer peer = JacksonUtils.toObj(result.getData(), RaftPeer.class);\n+    \n+                            Loggers.RAFT.info(\"received approve from peer: {}\", JacksonUtils.toJson(peer));\n+    \n+                            peers.decideLeader(peer);\n+    \n                         }\n-                        \n+    \n                         @Override\n                         public void onError(Throwable throwable) {\n                             Loggers.RAFT.error(\"error while sending vote to server: {}\", server, throwable);\n                         }\n-                        \n+    \n                         @Override\n                         public void onCancel() {\n-                        \n+        \n                         }\n                     });\n                 } catch (Exception e) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDE2MTI5NQ==", "url": "https://github.com/alibaba/nacos/pull/3763#discussion_r484161295", "bodyText": "Same suggest as above.", "author": "KomachiSion", "createdAt": "2020-09-07T03:06:39Z", "path": "naming/src/main/java/com/alibaba/nacos/naming/consistency/persistent/raft/RaftCore.java", "diffHunk": "@@ -605,29 +626,35 @@ private void sendBeat() throws IOException, InterruptedException {\n                     if (Loggers.RAFT.isDebugEnabled()) {\n                         Loggers.RAFT.debug(\"send beat to server \" + server);\n                     }\n-                    HttpClient.asyncHttpPostLarge(url, null, compressedBytes, new AsyncCompletionHandler<Integer>() {\n-                        @Override\n-                        public Integer onCompleted(Response response) throws Exception {\n-                            if (response.getStatusCode() != HttpURLConnection.HTTP_OK) {\n-                                Loggers.RAFT.error(\"NACOS-RAFT beat failed: {}, peer: {}\", response.getResponseBody(),\n-                                        server);\n-                                MetricsMonitor.getLeaderSendBeatFailedException().increment();\n-                                return 1;\n-                            }\n-                            \n-                            peers.update(JacksonUtils.toObj(response.getResponseBody(), RaftPeer.class));\n-                            if (Loggers.RAFT.isDebugEnabled()) {\n-                                Loggers.RAFT.debug(\"receive beat response from: {}\", url);\n-                            }\n-                            return 0;\n-                        }\n-                        \n-                        @Override\n-                        public void onThrowable(Throwable t) {\n-                            Loggers.RAFT.error(\"NACOS-RAFT error while sending heart-beat to peer: {} {}\", server, t);\n-                            MetricsMonitor.getLeaderSendBeatFailedException().increment();\n-                        }\n-                    });\n+                    asyncRestTemplate.post(url, Header.newInstance(), Query.EMPTY, compressedBytes, String.class,\n+                            new Callback<String>() {\n+                                @Override\n+                                public void onReceive(RestResult<String> result) {\n+                                    if (result.ok()) {", "originalCommit": "92152fef6bac447a3b7b77e94f3ba025917ddba5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f820f5def7949509c0a34b8f9540f08f19e54b3a", "chunk": "diff --git a/naming/src/main/java/com/alibaba/nacos/naming/consistency/persistent/raft/RaftCore.java b/naming/src/main/java/com/alibaba/nacos/naming/consistency/persistent/raft/RaftCore.java\nindex b54e60870..9ab014b6e 100644\n--- a/naming/src/main/java/com/alibaba/nacos/naming/consistency/persistent/raft/RaftCore.java\n+++ b/naming/src/main/java/com/alibaba/nacos/naming/consistency/persistent/raft/RaftCore.java\n\n@@ -626,35 +625,33 @@ public class RaftCore {\n                     if (Loggers.RAFT.isDebugEnabled()) {\n                         Loggers.RAFT.debug(\"send beat to server \" + server);\n                     }\n-                    asyncRestTemplate.post(url, Header.newInstance(), Query.EMPTY, compressedBytes, String.class,\n-                            new Callback<String>() {\n-                                @Override\n-                                public void onReceive(RestResult<String> result) {\n-                                    if (result.ok()) {\n-                                        peers.update(JacksonUtils.toObj(result.getData(), RaftPeer.class));\n-                                        if (Loggers.RAFT.isDebugEnabled()) {\n-                                            Loggers.RAFT.debug(\"receive beat response from: {}\", url);\n-                                        }\n-                                    } else {\n-                                        Loggers.RAFT.error(\"NACOS-RAFT beat failed: {}, peer: {}\", result.getMessage(),\n-                                                server);\n-                                        MetricsMonitor.getLeaderSendBeatFailedException().increment();\n-                                    }\n-                                }\n-                                \n-                                @Override\n-                                public void onError(Throwable throwable) {\n-                                    Loggers.RAFT\n-                                            .error(\"NACOS-RAFT error while sending heart-beat to peer: {} {}\", server,\n-                                                    throwable);\n-                                    MetricsMonitor.getLeaderSendBeatFailedException().increment();\n-                                }\n-                                \n-                                @Override\n-                                public void onCancel() {\n-                                \n-                                }\n-                            });\n+                    HttpClient.asyncHttpPostLarge(url, null, compressedBytes, new Callback<String>() {\n+                        @Override\n+                        public void onReceive(RestResult<String> result) {\n+                            if (!result.ok()) {\n+                                Loggers.RAFT.error(\"NACOS-RAFT beat failed: {}, peer: {}\", result.getCode(),\n+                                        server);\n+                                MetricsMonitor.getLeaderSendBeatFailedException().increment();\n+                                return;\n+                            }\n+    \n+                            peers.update(JacksonUtils.toObj(result.getData(), RaftPeer.class));\n+                            if (Loggers.RAFT.isDebugEnabled()) {\n+                                Loggers.RAFT.debug(\"receive beat response from: {}\", url);\n+                            }\n+                        }\n+    \n+                        @Override\n+                        public void onError(Throwable throwable) {\n+                            Loggers.RAFT.error(\"NACOS-RAFT error while sending heart-beat to peer: {} {}\", server, throwable);\n+                            MetricsMonitor.getLeaderSendBeatFailedException().increment();\n+                        }\n+    \n+                        @Override\n+                        public void onCancel() {\n+        \n+                        }\n+                    });\n                 } catch (Exception e) {\n                     Loggers.RAFT.error(\"error while sending heart-beat to peer: {} {}\", server, e);\n                     MetricsMonitor.getLeaderSendBeatFailedException().increment();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDE2MTMxNQ==", "url": "https://github.com/alibaba/nacos/pull/3763#discussion_r484161315", "bodyText": "Same suggest as above.", "author": "KomachiSion", "createdAt": "2020-09-07T03:06:47Z", "path": "naming/src/main/java/com/alibaba/nacos/naming/consistency/persistent/raft/RaftCore.java", "diffHunk": "@@ -745,88 +772,103 @@ public RaftPeer receivedBeat(JsonNode beat) throws Exception {\n                             processedCount, beatDatums.size(), datums.size());\n                     \n                     // update datum entry\n-                    String url = buildUrl(remote.ip, API_GET) + \"?keys=\" + URLEncoder.encode(keys, \"UTF-8\");\n-                    HttpClient.asyncHttpGet(url, null, null, new AsyncCompletionHandler<Integer>() {\n-                        @Override\n-                        public Integer onCompleted(Response response) throws Exception {\n-                            if (response.getStatusCode() != HttpURLConnection.HTTP_OK) {\n-                                return 1;\n-                            }\n-                            \n-                            List<JsonNode> datumList = JacksonUtils\n-                                    .toObj(response.getResponseBody(), new TypeReference<List<JsonNode>>() {\n-                                    });\n-                            \n-                            for (JsonNode datumJson : datumList) {\n-                                Datum newDatum = null;\n-                                OPERATE_LOCK.lock();\n-                                try {\n-                                    \n-                                    Datum oldDatum = getDatum(datumJson.get(\"key\").asText());\n-                                    \n-                                    if (oldDatum != null && datumJson.get(\"timestamp\").asLong() <= oldDatum.timestamp\n-                                            .get()) {\n-                                        Loggers.RAFT\n-                                                .info(\"[NACOS-RAFT] timestamp is smaller than that of mine, key: {}, remote: {}, local: {}\",\n-                                                        datumJson.get(\"key\").asText(),\n-                                                        datumJson.get(\"timestamp\").asLong(), oldDatum.timestamp);\n-                                        continue;\n+                    String url = buildUrl(remote.ip, API_GET);\n+                    asyncRestTemplate.get(url, Header.EMPTY, Query.newInstance().addParam(\"keys\", keys), String.class,\n+                            new Callback<String>() {\n+                                @Override\n+                                public void onReceive(RestResult<String> result) {\n+                                    if (result.ok()) {", "originalCommit": "92152fef6bac447a3b7b77e94f3ba025917ddba5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f820f5def7949509c0a34b8f9540f08f19e54b3a", "chunk": "diff --git a/naming/src/main/java/com/alibaba/nacos/naming/consistency/persistent/raft/RaftCore.java b/naming/src/main/java/com/alibaba/nacos/naming/consistency/persistent/raft/RaftCore.java\nindex b54e60870..9ab014b6e 100644\n--- a/naming/src/main/java/com/alibaba/nacos/naming/consistency/persistent/raft/RaftCore.java\n+++ b/naming/src/main/java/com/alibaba/nacos/naming/consistency/persistent/raft/RaftCore.java\n\n@@ -772,103 +769,103 @@ public class RaftCore {\n                             processedCount, beatDatums.size(), datums.size());\n                     \n                     // update datum entry\n-                    String url = buildUrl(remote.ip, API_GET);\n-                    asyncRestTemplate.get(url, Header.EMPTY, Query.newInstance().addParam(\"keys\", keys), String.class,\n-                            new Callback<String>() {\n-                                @Override\n-                                public void onReceive(RestResult<String> result) {\n-                                    if (result.ok()) {\n-                                        List<JsonNode> datumList = JacksonUtils\n-                                                .toObj(result.getData(), new TypeReference<List<JsonNode>>() {\n-                                                });\n-                                        for (JsonNode datumJson : datumList) {\n-                                            Datum newDatum = null;\n-                                            OPERATE_LOCK.lock();\n-                                            try {\n-                                                Datum oldDatum = getDatum(datumJson.get(\"key\").asText());\n-                                                \n-                                                if (oldDatum != null\n-                                                        && datumJson.get(\"timestamp\").asLong() <= oldDatum.timestamp\n-                                                        .get()) {\n-                                                    Loggers.RAFT\n-                                                            .info(\"[NACOS-RAFT] timestamp is smaller than that of mine, \"\n-                                                                            + \"key: {}, remote: {}, local: {}\",\n-                                                                    datumJson.get(\"key\").asText(),\n-                                                                    datumJson.get(\"timestamp\").asLong(),\n-                                                                    oldDatum.timestamp);\n-                                                    continue;\n-                                                }\n-                                                \n-                                                if (KeyBuilder.matchServiceMetaKey(datumJson.get(\"key\").asText())) {\n-                                                    Datum<Service> serviceDatum = new Datum<>();\n-                                                    serviceDatum.key = datumJson.get(\"key\").asText();\n-                                                    serviceDatum.timestamp.set(datumJson.get(\"timestamp\").asLong());\n-                                                    serviceDatum.value = JacksonUtils\n-                                                            .toObj(datumJson.get(\"value\").toString(), Service.class);\n-                                                    newDatum = serviceDatum;\n-                                                }\n-                                                \n-                                                if (KeyBuilder.matchInstanceListKey(datumJson.get(\"key\").asText())) {\n-                                                    Datum<Instances> instancesDatum = new Datum<>();\n-                                                    instancesDatum.key = datumJson.get(\"key\").asText();\n-                                                    instancesDatum.timestamp.set(datumJson.get(\"timestamp\").asLong());\n-                                                    instancesDatum.value = JacksonUtils\n-                                                            .toObj(datumJson.get(\"value\").toString(), Instances.class);\n-                                                    newDatum = instancesDatum;\n-                                                }\n-                                                \n-                                                if (newDatum == null || newDatum.value == null) {\n-                                                    Loggers.RAFT.error(\"receive null datum: {}\", datumJson);\n-                                                    continue;\n-                                                }\n-                                                \n-                                                raftStore.write(newDatum);\n-                                                \n-                                                datums.put(newDatum.key, newDatum);\n-                                                notifier.addTask(newDatum.key, DataOperation.CHANGE);\n-                                                \n-                                                local.resetLeaderDue();\n-                                                \n-                                                if (local.term.get() + 100 > remote.term.get()) {\n-                                                    getLeader().term.set(remote.term.get());\n-                                                    local.term.set(getLeader().term.get());\n-                                                } else {\n-                                                    local.term.addAndGet(100);\n-                                                }\n-                                                \n-                                                raftStore.updateTerm(local.term.get());\n-                                                \n-                                                Loggers.RAFT\n-                                                        .info(\"data updated, key: {}, timestamp: {}, from {}, local term: {}\",\n-                                                                newDatum.key, newDatum.timestamp,\n-                                                                JacksonUtils.toJson(remote), local.term);\n-                                                \n-                                            } catch (Throwable e) {\n-                                                Loggers.RAFT\n-                                                        .error(\"[RAFT-BEAT] failed to sync datum from leader, datum: {}\",\n-                                                                newDatum, e);\n-                                            } finally {\n-                                                OPERATE_LOCK.unlock();\n-                                            }\n-                                        }\n-                                        try {\n-                                            TimeUnit.MILLISECONDS.sleep(200);\n-                                        } catch (InterruptedException e) {\n-                                            Loggers.RAFT.error(\"[RAFT-BEAT] Interrupted error \", e);\n-                                        }\n+                    String url = buildUrl(remote.ip, API_GET) + \"?keys=\" + URLEncoder.encode(keys, \"UTF-8\");\n+                    HttpClient.asyncHttpGet(url, null, null, new Callback<String>() {\n+                        @Override\n+                        public void onReceive(RestResult<String> result) {\n+                            if (!result.ok()) {\n+                                return;\n+                            }\n+    \n+                            List<JsonNode> datumList = JacksonUtils\n+                                    .toObj(result.getData(), new TypeReference<List<JsonNode>>() {\n+                                    });\n+    \n+                            for (JsonNode datumJson : datumList) {\n+                                Datum newDatum = null;\n+                                OPERATE_LOCK.lock();\n+                                try {\n+            \n+                                    Datum oldDatum = getDatum(datumJson.get(\"key\").asText());\n+            \n+                                    if (oldDatum != null && datumJson.get(\"timestamp\").asLong() <= oldDatum.timestamp\n+                                            .get()) {\n+                                        Loggers.RAFT\n+                                                .info(\"[NACOS-RAFT] timestamp is smaller than that of mine, key: {}, remote: {}, local: {}\",\n+                                                        datumJson.get(\"key\").asText(),\n+                                                        datumJson.get(\"timestamp\").asLong(), oldDatum.timestamp);\n+                                        continue;\n                                     }\n+            \n+                                    if (KeyBuilder.matchServiceMetaKey(datumJson.get(\"key\").asText())) {\n+                                        Datum<Service> serviceDatum = new Datum<>();\n+                                        serviceDatum.key = datumJson.get(\"key\").asText();\n+                                        serviceDatum.timestamp.set(datumJson.get(\"timestamp\").asLong());\n+                                        serviceDatum.value = JacksonUtils\n+                                                .toObj(datumJson.get(\"value\").toString(), Service.class);\n+                                        newDatum = serviceDatum;\n+                                    }\n+            \n+                                    if (KeyBuilder.matchInstanceListKey(datumJson.get(\"key\").asText())) {\n+                                        Datum<Instances> instancesDatum = new Datum<>();\n+                                        instancesDatum.key = datumJson.get(\"key\").asText();\n+                                        instancesDatum.timestamp.set(datumJson.get(\"timestamp\").asLong());\n+                                        instancesDatum.value = JacksonUtils\n+                                                .toObj(datumJson.get(\"value\").toString(), Instances.class);\n+                                        newDatum = instancesDatum;\n+                                    }\n+            \n+                                    if (newDatum == null || newDatum.value == null) {\n+                                        Loggers.RAFT.error(\"receive null datum: {}\", datumJson);\n+                                        continue;\n+                                    }\n+            \n+                                    raftStore.write(newDatum);\n+            \n+                                    datums.put(newDatum.key, newDatum);\n+                                    notifier.addTask(newDatum.key, DataOperation.CHANGE);\n+            \n+                                    local.resetLeaderDue();\n+            \n+                                    if (local.term.get() + 100 > remote.term.get()) {\n+                                        getLeader().term.set(remote.term.get());\n+                                        local.term.set(getLeader().term.get());\n+                                    } else {\n+                                        local.term.addAndGet(100);\n+                                    }\n+            \n+                                    raftStore.updateTerm(local.term.get());\n+            \n+                                    Loggers.RAFT.info(\"data updated, key: {}, timestamp: {}, from {}, local term: {}\",\n+                                            newDatum.key, newDatum.timestamp, JacksonUtils.toJson(remote), local.term);\n+            \n+                                } catch (Throwable e) {\n+                                    Loggers.RAFT\n+                                            .error(\"[RAFT-BEAT] failed to sync datum from leader, datum: {}\", newDatum,\n+                                                    e);\n+                                } finally {\n+                                    OPERATE_LOCK.unlock();\n                                 }\n-                                \n-                                @Override\n-                                public void onError(Throwable throwable) {\n-                                    Loggers.RAFT.error(\"[RAFT-BEAT] failed to sync datum from leader\", throwable);\n-                                }\n-                                \n-                                @Override\n-                                public void onCancel() {\n-                                \n-                                }\n-                            });\n+                            }\n+                            try {\n+                                TimeUnit.MILLISECONDS.sleep(200);\n+                            } catch (InterruptedException e) {\n+                                Loggers.RAFT.error(\"[RAFT-BEAT] Interrupted error \", e);\n+                            }\n+                            return;\n+                        }\n+    \n+                        @Override\n+                        public void onError(Throwable throwable) {\n+                            Loggers.RAFT.error(\"[RAFT-BEAT] failed to sync datum from leader\", throwable);\n+                        }\n+    \n+                        @Override\n+                        public void onCancel() {\n+        \n+                        }\n+                        \n+                    });\n                     \n                     batch.clear();\n                     \n"}}, {"oid": "f820f5def7949509c0a34b8f9540f08f19e54b3a", "url": "https://github.com/alibaba/nacos/commit/f820f5def7949509c0a34b8f9540f08f19e54b3a", "message": "refactor: naming module replace http client.", "committedDate": "2020-09-08T05:02:30Z", "type": "commit"}, {"oid": "427599eef8750ae5a541def297fc8ebaaf9b58b4", "url": "https://github.com/alibaba/nacos/commit/427599eef8750ae5a541def297fc8ebaaf9b58b4", "message": "fix code style", "committedDate": "2020-09-08T05:06:07Z", "type": "commit"}, {"oid": "7c3e36ba41f074b9c757f4bb6e9af9987fcd5f77", "url": "https://github.com/alibaba/nacos/commit/7c3e36ba41f074b9c757f4bb6e9af9987fcd5f77", "message": "refactor: fix JDK http client Use error problem.", "committedDate": "2020-09-08T08:02:53Z", "type": "commit"}, {"oid": "fd13ba2dc977c2f3592ee500904ac7c488754b2a", "url": "https://github.com/alibaba/nacos/commit/fd13ba2dc977c2f3592ee500904ac7c488754b2a", "message": "refactor: Query And Header entity init Add non-empty judgment", "committedDate": "2020-09-08T09:36:10Z", "type": "commit"}, {"oid": "0d139a0f8807a2089710ae4e7535ede4eda030f6", "url": "https://github.com/alibaba/nacos/commit/0d139a0f8807a2089710ae4e7535ede4eda030f6", "message": "Enhance the asynchronous http delete request method to support body passing parameters.", "committedDate": "2020-09-08T14:22:23Z", "type": "commit"}, {"oid": "aa9a3be2baa3d6bc2b8839852acc85728caeddec", "url": "https://github.com/alibaba/nacos/commit/aa9a3be2baa3d6bc2b8839852acc85728caeddec", "message": "refactor: apache http client set MaxConnTotal and maxConnPerRoute.", "committedDate": "2020-09-14T14:42:28Z", "type": "commit"}]}