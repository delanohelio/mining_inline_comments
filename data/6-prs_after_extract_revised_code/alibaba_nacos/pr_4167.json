{"pr_number": 4167, "pr_title": "[ISSUE-#4166] Optimize notifyCenter code", "pr_createdAt": "2020-11-07T13:36:03Z", "pr_url": "https://github.com/alibaba/nacos/pull/4167", "timeline": [{"oid": "b054879b2e6f802be4ac3faef483f6afd153120f", "url": "https://github.com/alibaba/nacos/commit/b054879b2e6f802be4ac3faef483f6afd153120f", "message": "enhance notify center code quality", "committedDate": "2020-11-07T13:13:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTUwOTQ4NA==", "url": "https://github.com/alibaba/nacos/pull/4167#discussion_r519509484", "bodyText": "I think the old implementation is better for readablilty", "author": "KomachiSion", "createdAt": "2020-11-09T01:26:11Z", "path": "common/src/main/java/com/alibaba/nacos/common/notify/NotifyCenter.java", "diffHunk": "@@ -250,13 +250,12 @@ private static void addSubscriber(final Subscriber consumer, Class<? extends Eve\n     private static boolean removeSubscriber(final Subscriber consumer, Class<? extends Event> subscribeType) {\n         \n         final String topic = ClassUtils.getCanonicalName(subscribeType);\n-        if (INSTANCE.publisherMap.containsKey(topic)) {\n-            EventPublisher publisher = INSTANCE.publisherMap.get(topic);\n-            publisher.removeSubscriber(consumer);\n-            return true;\n+        EventPublisher eventPublisher = INSTANCE.publisherMap.get(topic);", "originalCommit": "b054879b2e6f802be4ac3faef483f6afd153120f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTUyMTEzNQ==", "url": "https://github.com/alibaba/nacos/pull/4167#discussion_r519521135", "bodyText": "I think containsKey() and get() is duplicated. get() can cover containsKey(); Maybe should judge eventPublish != null?", "author": "horizonzy", "createdAt": "2020-11-09T02:26:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTUwOTQ4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTUzMTQzNA==", "url": "https://github.com/alibaba/nacos/pull/4167#discussion_r519531434", "bodyText": "OK", "author": "KomachiSion", "createdAt": "2020-11-09T03:14:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTUwOTQ4NA=="}], "type": "inlineReview", "revised_code": {"commit": "57a5b5df2f9fc9865541866168ec78025aaf96f4", "chunk": "diff --git a/common/src/main/java/com/alibaba/nacos/common/notify/NotifyCenter.java b/common/src/main/java/com/alibaba/nacos/common/notify/NotifyCenter.java\nindex 479a9d41d..41b03d0cc 100644\n--- a/common/src/main/java/com/alibaba/nacos/common/notify/NotifyCenter.java\n+++ b/common/src/main/java/com/alibaba/nacos/common/notify/NotifyCenter.java\n\n@@ -251,11 +251,11 @@ public class NotifyCenter {\n         \n         final String topic = ClassUtils.getCanonicalName(subscribeType);\n         EventPublisher eventPublisher = INSTANCE.publisherMap.get(topic);\n-        if (eventPublisher == null) {\n-            return false;\n+        if (eventPublisher != null) {\n+            eventPublisher.removeSubscriber(consumer);\n+            return true;\n         }\n-        eventPublisher.removeSubscriber(consumer);\n-        return true;\n+        return false;\n     }\n     \n     /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTUwOTYxNg==", "url": "https://github.com/alibaba/nacos/pull/4167#discussion_r519509616", "bodyText": "Same as above", "author": "KomachiSion", "createdAt": "2020-11-09T01:26:54Z", "path": "common/src/main/java/com/alibaba/nacos/common/notify/NotifyCenter.java", "diffHunk": "@@ -281,18 +280,19 @@ public static boolean publishEvent(final Event event) {\n      * @param event     event instance.\n      */\n     private static boolean publishEvent(final Class<? extends Event> eventType, final Event event) {\n-        final String topic = ClassUtils.getCanonicalName(eventType);\n         if (ClassUtils.isAssignableFrom(SlowEvent.class, eventType)) {\n             return INSTANCE.sharePublisher.publish(event);\n         }\n         \n-        if (INSTANCE.publisherMap.containsKey(topic)) {\n-            EventPublisher publisher = INSTANCE.publisherMap.get(topic);\n-            return publisher.publish(event);\n+        final String topic = ClassUtils.getCanonicalName(eventType);\n+        \n+        EventPublisher publisher = INSTANCE.publisherMap.get(topic);\n+        if (publisher == null) {", "originalCommit": "b054879b2e6f802be4ac3faef483f6afd153120f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "57a5b5df2f9fc9865541866168ec78025aaf96f4", "chunk": "diff --git a/common/src/main/java/com/alibaba/nacos/common/notify/NotifyCenter.java b/common/src/main/java/com/alibaba/nacos/common/notify/NotifyCenter.java\nindex 479a9d41d..41b03d0cc 100644\n--- a/common/src/main/java/com/alibaba/nacos/common/notify/NotifyCenter.java\n+++ b/common/src/main/java/com/alibaba/nacos/common/notify/NotifyCenter.java\n\n@@ -287,12 +287,11 @@ public class NotifyCenter {\n         final String topic = ClassUtils.getCanonicalName(eventType);\n         \n         EventPublisher publisher = INSTANCE.publisherMap.get(topic);\n-        if (publisher == null) {\n-            LOGGER.warn(\"There are no [{}] publishers for this event, please register\", topic);\n-            return false;\n+        if (publisher != null) {\n+            return publisher.publish(event);\n         }\n-        \n-        return publisher.publish(event);\n+        LOGGER.warn(\"There are no [{}] publishers for this event, please register\", topic);\n+        return false;\n     }\n     \n     /**\n"}}, {"oid": "57a5b5df2f9fc9865541866168ec78025aaf96f4", "url": "https://github.com/alibaba/nacos/commit/57a5b5df2f9fc9865541866168ec78025aaf96f4", "message": "reverse the judge logic", "committedDate": "2020-11-09T02:39:25Z", "type": "commit"}]}