{"pr_number": 3523, "pr_title": "[ISSUE #3192] replace nacos-config module http client", "pr_createdAt": "2020-08-05T02:34:21Z", "pr_url": "https://github.com/alibaba/nacos/pull/3523", "timeline": [{"oid": "906e0843b25671cb59e5a1a6e6efab2d1f94381a", "url": "https://github.com/alibaba/nacos/commit/906e0843b25671cb59e5a1a6e6efab2d1f94381a", "message": "nacos-config module replace http client", "committedDate": "2020-07-27T06:09:35Z", "type": "commit"}, {"oid": "935c0bc504fa49412a5bd2ddaa4c1a1c2c5ee019", "url": "https://github.com/alibaba/nacos/commit/935c0bc504fa49412a5bd2ddaa4c1a1c2c5ee019", "message": "Merge branch 'develop' into refactor_replace_config_http_client", "committedDate": "2020-07-31T06:37:05Z", "type": "commit"}, {"oid": "10472593f961ada3d4206b46a3cbe1fb9224dba9", "url": "https://github.com/alibaba/nacos/commit/10472593f961ada3d4206b46a3cbe1fb9224dba9", "message": "replace http client", "committedDate": "2020-08-04T05:43:37Z", "type": "commit"}, {"oid": "590aad837204d7e25d43f36f62d3e172ce455c8b", "url": "https://github.com/alibaba/nacos/commit/590aad837204d7e25d43f36f62d3e172ce455c8b", "message": "Merge branch 'develop' into refactor_replace_config_http_client", "committedDate": "2020-08-04T05:47:12Z", "type": "commit"}, {"oid": "bebb371102fec6dd120fdba1ee5b0b47cc4d1ee3", "url": "https://github.com/alibaba/nacos/commit/bebb371102fec6dd120fdba1ee5b0b47cc4d1ee3", "message": "Remove redundant package import", "committedDate": "2020-08-05T04:31:01Z", "type": "commit"}, {"oid": "c1b20b5a3b78acfa729e46c04ac1a88251b2a52e", "url": "https://github.com/alibaba/nacos/commit/c1b20b5a3b78acfa729e46c04ac1a88251b2a52e", "message": "add license", "committedDate": "2020-08-05T04:38:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA5MjMyMw==", "url": "https://github.com/alibaba/nacos/pull/3523#discussion_r466092323", "bodyText": "Can unified json utils to Jackson util?", "author": "KomachiSion", "createdAt": "2020-08-06T01:27:53Z", "path": "config/src/main/java/com/alibaba/nacos/config/server/service/ConfigSubService.java", "diffHunk": "@@ -178,19 +178,16 @@ public SampleResult call() throws Exception {\n                 }\n                 \n                 String urlAll = getUrl(ip, url) + \"?\" + paramUrl;\n-                com.alibaba.nacos.config.server.service.notify.NotifyService.HttpResult result = NotifyService\n+                RestResult<String> result = NotifyService\n                         .invokeURL(urlAll, null, Constants.ENCODE);\n                 \n                 // Http code 200\n-                if (result.code == HttpURLConnection.HTTP_OK) {\n-                    String json = result.content;\n-                    SampleResult resultObj = JSONUtils.deserializeObject(json, new TypeReference<SampleResult>() {\n+                if (result.ok()) {\n+                    return JSONUtils.deserializeObject(result.getData(), new TypeReference<SampleResult>() {", "originalCommit": "c1b20b5a3b78acfa729e46c04ac1a88251b2a52e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA5ODU2Nw==", "url": "https://github.com/alibaba/nacos/pull/3523#discussion_r466098567", "bodyText": "Ok, I will modify", "author": "Maijh97", "createdAt": "2020-08-06T01:50:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA5MjMyMw=="}], "type": "inlineReview", "revised_code": {"commit": "c521d0659fec610d1d38936d69f7ab0917d40ead", "chunk": "diff --git a/config/src/main/java/com/alibaba/nacos/config/server/service/ConfigSubService.java b/config/src/main/java/com/alibaba/nacos/config/server/service/ConfigSubService.java\nindex 2c5f74ca2..157f373a5 100644\n--- a/config/src/main/java/com/alibaba/nacos/config/server/service/ConfigSubService.java\n+++ b/config/src/main/java/com/alibaba/nacos/config/server/service/ConfigSubService.java\n\n@@ -183,8 +182,7 @@ public class ConfigSubService {\n                 \n                 // Http code 200\n                 if (result.ok()) {\n-                    return JSONUtils.deserializeObject(result.getData(), new TypeReference<SampleResult>() {\n-                    });\n+                    return JacksonUtils.toObj(result.getData(), SampleResult.class);\n                 } else {\n                     \n                     LogUtil.DEFAULT_LOG.info(\"Can not get clientInfo from {} with {}\", ip, result.getData());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA5NDQ3NQ==", "url": "https://github.com/alibaba/nacos/pull/3523#discussion_r466094475", "bodyText": "Should we modified this restTemplate.get method, if any error when execute get, call the callback.onError in the restTemplate.get rather than throw exception?", "author": "KomachiSion", "createdAt": "2020-08-06T01:35:23Z", "path": "config/src/main/java/com/alibaba/nacos/config/server/service/notify/AsyncNotifyService.java", "diffHunk": "@@ -138,52 +132,52 @@ private void executeAsyncInvoke() {\n                         // get delay time and set fail count to the task\n                         asyncTaskExecute(task);\n                     } else {\n-                        HttpGet request = new HttpGet(task.url);\n-                        request.setHeader(NotifyService.NOTIFY_HEADER_LAST_MODIFIED,\n-                                String.valueOf(task.getLastModified()));\n-                        request.setHeader(NotifyService.NOTIFY_HEADER_OP_HANDLE_IP, InetUtils.getSelfIp());\n+                        Header header = Header.newInstance();\n+                        header.addParam(NotifyService.NOTIFY_HEADER_LAST_MODIFIED, String.valueOf(task.getLastModified()));\n+                        header.addParam(NotifyService.NOTIFY_HEADER_OP_HANDLE_IP, InetUtils.getSelfIp());\n                         if (task.isBeta) {\n-                            request.setHeader(\"isBeta\", \"true\");\n+                            header.addParam(\"isBeta\", \"true\");\n+                        }\n+                        AsyncNotifyCallBack asyncNotifyCallBack = new AsyncNotifyCallBack(task);\n+                        try {\n+                            restTemplate.get(task.url, header, Query.EMPTY, String.class, asyncNotifyCallBack);", "originalCommit": "c1b20b5a3b78acfa729e46c04ac1a88251b2a52e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA5ODc3OQ==", "url": "https://github.com/alibaba/nacos/pull/3523#discussion_r466098779", "bodyText": "Ok, very good advice", "author": "Maijh97", "createdAt": "2020-08-06T01:51:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA5NDQ3NQ=="}], "type": "inlineReview", "revised_code": {"commit": "c521d0659fec610d1d38936d69f7ab0917d40ead", "chunk": "diff --git a/config/src/main/java/com/alibaba/nacos/config/server/service/notify/AsyncNotifyService.java b/config/src/main/java/com/alibaba/nacos/config/server/service/notify/AsyncNotifyService.java\nindex 7a275c81e..f38774bf5 100644\n--- a/config/src/main/java/com/alibaba/nacos/config/server/service/notify/AsyncNotifyService.java\n+++ b/config/src/main/java/com/alibaba/nacos/config/server/service/notify/AsyncNotifyService.java\n\n@@ -138,12 +138,7 @@ public class AsyncNotifyService {\n                         if (task.isBeta) {\n                             header.addParam(\"isBeta\", \"true\");\n                         }\n-                        AsyncNotifyCallBack asyncNotifyCallBack = new AsyncNotifyCallBack(task);\n-                        try {\n-                            restTemplate.get(task.url, header, Query.EMPTY, String.class, asyncNotifyCallBack);\n-                        } catch (Exception e) {\n-                            asyncNotifyCallBack.onError(e);\n-                        }\n+                        restTemplate.get(task.url, header, Query.EMPTY, String.class, new AsyncNotifyCallBack(task));\n                     }\n                 }\n             }\n"}}, {"oid": "c521d0659fec610d1d38936d69f7ab0917d40ead", "url": "https://github.com/alibaba/nacos/commit/c521d0659fec610d1d38936d69f7ab0917d40ead", "message": "Delete JOSNUtils and use JacksonUtils instead; modify NacosAsyncRestTemplate exception handling.", "committedDate": "2020-08-06T02:17:25Z", "type": "commit"}]}