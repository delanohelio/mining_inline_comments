{"pr_number": 1246, "pr_title": "Backwards compatibility", "pr_createdAt": "2020-11-05T13:04:55Z", "pr_url": "https://github.com/cdapio/hydrator-plugins/pull/1246", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI4NzEyMQ==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1246#discussion_r518287121", "bodyText": "we shouldnt do it. the exception should be logged. Please take a look at other places where we handle this case in the codebase", "author": "CuriousVini", "createdAt": "2020-11-05T18:55:14Z", "path": "database-plugins/src/main/java/io/cdap/plugin/DBRecord.java", "diffHunk": "@@ -99,7 +101,18 @@ public StructuredRecord getRecord() {\n    */\n   public void readFields(ResultSet resultSet) throws SQLException {\n     ResultSetMetaData metadata = resultSet.getMetaData();\n-    List<Schema.Field> originalSchema = DBUtils.getOriginalSchema(resultSet);\n+    String outputSchemaString = conf.get(DBUtils.OVERRIDE_SCHEMA, null);\n+    Schema outputSchema = null;\n+\n+    if (!Strings.isNullOrEmpty(outputSchemaString)) {\n+      try {\n+        outputSchema = Schema.parseJson(outputSchemaString);\n+      } catch (IOException e) {\n+        e.printStackTrace();", "originalCommit": "48f286f552bb9c6d638d416c8bed8ff72150dfbf", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6f7708e09423dc28243776565f557832d270d40c", "chunk": "diff --git a/database-plugins/src/main/java/io/cdap/plugin/DBRecord.java b/database-plugins/src/main/java/io/cdap/plugin/DBRecord.java\nindex 865df6f8..35873238 100644\n--- a/database-plugins/src/main/java/io/cdap/plugin/DBRecord.java\n+++ b/database-plugins/src/main/java/io/cdap/plugin/DBRecord.java\n\n@@ -108,7 +108,7 @@ public class DBRecord implements Writable, DBWritable, Configurable {\n       try {\n         outputSchema = Schema.parseJson(outputSchemaString);\n       } catch (IOException e) {\n-        e.printStackTrace();\n+        throw new IllegalArgumentException(String.format(\"Unable to parse schema string '%s'.\", outputSchemaString), e);\n       }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI4Nzk0Nw==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1246#discussion_r518287947", "bodyText": "these changes are not needed. please revert them", "author": "CuriousVini", "createdAt": "2020-11-05T18:56:42Z", "path": "database-plugins/src/main/java/io/cdap/plugin/db/batch/source/DBSource.java", "diffHunk": "@@ -318,20 +319,20 @@ private Connection getConnection() throws SQLException {\n     @Nullable\n     @Name(PATTERN_TO_REPLACE)\n     @Description(\"The pattern to replace in the field name in the table, it is typically used with the \" +\n-                   \"Replace With config. If Replace With is not set, the pattern will be removed in the field name.\")\n+      \"Replace With config. If Replace With is not set, the pattern will be removed in the field name.\")", "originalCommit": "48f286f552bb9c6d638d416c8bed8ff72150dfbf", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6f7708e09423dc28243776565f557832d270d40c", "chunk": "diff --git a/database-plugins/src/main/java/io/cdap/plugin/db/batch/source/DBSource.java b/database-plugins/src/main/java/io/cdap/plugin/db/batch/source/DBSource.java\nindex 8f23adf3..e706d6c5 100644\n--- a/database-plugins/src/main/java/io/cdap/plugin/db/batch/source/DBSource.java\n+++ b/database-plugins/src/main/java/io/cdap/plugin/db/batch/source/DBSource.java\n\n@@ -319,20 +319,20 @@ public class DBSource extends ReferenceBatchSource<LongWritable, DBRecord, Struc\n     @Nullable\n     @Name(PATTERN_TO_REPLACE)\n     @Description(\"The pattern to replace in the field name in the table, it is typically used with the \" +\n-      \"Replace With config. If Replace With is not set, the pattern will be removed in the field name.\")\n+                   \"Replace With config. If Replace With is not set, the pattern will be removed in the field name.\")\n     String patternToReplace;\n \n     @Nullable\n     @Name(REPLACE_WITH)\n     @Description(\"The string that will be replaced in the field name in the table, it must be used with the \" +\n-      \"Pattern To Replace config.\")\n+                   \"Pattern To Replace config.\")\n     String replaceWith;\n \n     @Nullable\n     @Name(FETCH_SIZE)\n     @Macro\n     @Description(\"The number of rows to fetch at a time per split. Larger fetch size can result in faster import, \" +\n-      \"with the tradeoff of higher memory usage.\")\n+                  \"with the tradeoff of higher memory usage.\")\n     Integer fetchSize;\n \n     @Nullable\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI4ODMxMA==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1246#discussion_r518288310", "bodyText": "these changes are not needed . Please revert them", "author": "CuriousVini", "createdAt": "2020-11-05T18:57:22Z", "path": "database-plugins/src/main/java/io/cdap/plugin/DBRecord.java", "diffHunk": "@@ -283,7 +312,7 @@ private void writeToDB(PreparedStatement stmt, Schema.Field field, int fieldInde\n         break;\n       default:\n         throw new SQLException(String.format(\"Column %s with value %s has an unsupported datatype %s\",\n-          field.getName(), fieldValue, fieldType));\n+                                             field.getName(), fieldValue, fieldType));", "originalCommit": "48f286f552bb9c6d638d416c8bed8ff72150dfbf", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6f7708e09423dc28243776565f557832d270d40c", "chunk": "diff --git a/database-plugins/src/main/java/io/cdap/plugin/DBRecord.java b/database-plugins/src/main/java/io/cdap/plugin/DBRecord.java\nindex 865df6f8..35873238 100644\n--- a/database-plugins/src/main/java/io/cdap/plugin/DBRecord.java\n+++ b/database-plugins/src/main/java/io/cdap/plugin/DBRecord.java\n\n@@ -312,7 +305,7 @@ public class DBRecord implements Writable, DBWritable, Configurable {\n         break;\n       default:\n         throw new SQLException(String.format(\"Column %s with value %s has an unsupported datatype %s\",\n-                                             field.getName(), fieldValue, fieldType));\n+          field.getName(), fieldValue, fieldType));\n     }\n   }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI5NTI1NA==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1246#discussion_r518295254", "bodyText": "not needed. Please remove.", "author": "CuriousVini", "createdAt": "2020-11-05T19:09:30Z", "path": "database-plugins/src/main/java/io/cdap/plugin/DBUtils.java", "diffHunk": "@@ -232,13 +246,23 @@ private static Schema getSchema(String typeName, int sqlType, int precision, int\n         break;\n \n       case Types.NUMERIC:\n-      case Types.DECIMAL:\n+        //variation", "originalCommit": "48f286f552bb9c6d638d416c8bed8ff72150dfbf", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6f7708e09423dc28243776565f557832d270d40c", "chunk": "diff --git a/database-plugins/src/main/java/io/cdap/plugin/DBUtils.java b/database-plugins/src/main/java/io/cdap/plugin/DBUtils.java\nindex 490d73f9..44b6b1bc 100644\n--- a/database-plugins/src/main/java/io/cdap/plugin/DBUtils.java\n+++ b/database-plugins/src/main/java/io/cdap/plugin/DBUtils.java\n\n@@ -246,22 +247,15 @@ public final class DBUtils {\n         break;\n \n       case Types.NUMERIC:\n-        //variation\n-        // if there are no digits after the point, use integer types\n-        type = scale != 0 ? Schema.Type.DOUBLE :\n-          // with 10 digits we can represent 2^32 and LONG is required\n-          precision > 9 ? Schema.Type.LONG : Schema.Type.INT;\n-        break;\n       case Types.DECIMAL:\n-        if (handleDecimalAsDouble) {\n-          //variation\n+        if (handleAsDecimal) {\n+          return Schema.decimalOf(precision, scale);\n+        } else {\n           // if there are no digits after the point, use integer types\n           type = scale != 0 ? Schema.Type.DOUBLE :\n             // with 10 digits we can represent 2^32 and LONG is required\n             precision > 9 ? Schema.Type.LONG : Schema.Type.INT;\n           break;\n-        } else {\n-          return Schema.decimalOf(precision, scale);\n         }\n       case Types.DOUBLE:\n         type = Schema.Type.DOUBLE;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI5NTYzMQ==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1246#discussion_r518295631", "bodyText": "This does not cover all cases. The schema type changes depending on precision and scale values:\ntype = scale != 0 ? Schema.Type.DOUBLE :\n          // with 10 digits we can represent 2^32 and LONG is required\n          precision > 9 ? Schema.Type.LONG : Schema.Type.INT;", "author": "CuriousVini", "createdAt": "2020-11-05T19:10:07Z", "path": "database-plugins/src/main/java/io/cdap/plugin/DBRecord.java", "diffHunk": "@@ -124,23 +137,39 @@ public void readFields(ResultSet resultSet) throws SQLException {\n       int sqlType = metadata.getColumnType(i + 1);\n       int sqlPrecision = metadata.getPrecision(i + 1);\n       int sqlScale = metadata.getScale(i + 1);\n+      // handles backwards compatibility\n+      boolean handleDecimalAsDouble = false;\n+      if (sqlType == Types.DECIMAL && outputSchema != null) {\n+        Schema outputFieldSchema = field.getSchema();\n+        if (outputFieldSchema != null) {\n+          outputFieldSchema = outputFieldSchema.isNullable() ? outputFieldSchema.getNonNullable() : outputFieldSchema;\n+          handleDecimalAsDouble = outputFieldSchema.getType() == Schema.Type.DOUBLE;", "originalCommit": "48f286f552bb9c6d638d416c8bed8ff72150dfbf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTg2MTg2Ng==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1246#discussion_r519861866", "bodyText": "@CuriousVini fixed", "author": "vjosadika", "createdAt": "2020-11-09T14:39:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI5NTYzMQ=="}], "type": "inlineReview", "revised_code": {"commit": "6f7708e09423dc28243776565f557832d270d40c", "chunk": "diff --git a/database-plugins/src/main/java/io/cdap/plugin/DBRecord.java b/database-plugins/src/main/java/io/cdap/plugin/DBRecord.java\nindex 865df6f8..35873238 100644\n--- a/database-plugins/src/main/java/io/cdap/plugin/DBRecord.java\n+++ b/database-plugins/src/main/java/io/cdap/plugin/DBRecord.java\n\n@@ -137,29 +137,22 @@ public class DBRecord implements Writable, DBWritable, Configurable {\n       int sqlType = metadata.getColumnType(i + 1);\n       int sqlPrecision = metadata.getPrecision(i + 1);\n       int sqlScale = metadata.getScale(i + 1);\n-      // handles backwards compatibility\n-      boolean handleDecimalAsDouble = false;\n-      if (sqlType == Types.DECIMAL && outputSchema != null) {\n-        Schema outputFieldSchema = field.getSchema();\n-        if (outputFieldSchema != null) {\n-          outputFieldSchema = outputFieldSchema.isNullable() ? outputFieldSchema.getNonNullable() : outputFieldSchema;\n-          handleDecimalAsDouble = outputFieldSchema.getType() == Schema.Type.DOUBLE;\n-        }\n-      }\n+\n+      Schema outputFieldSchema = field.getSchema();\n+      outputFieldSchema = outputFieldSchema.isNullable() ? outputFieldSchema.getNonNullable() : outputFieldSchema;\n       setField(resultSet, recordBuilder, field, sqlType, sqlPrecision, sqlScale, nameMap.getOrDefault(field.getName(),\n                                                                                                       field.getName()),\n-               handleDecimalAsDouble);\n+               outputFieldSchema);\n     }\n-\n     record = recordBuilder.build();\n   }\n \n   private void setField(ResultSet resultSet, StructuredRecord.Builder recordBuilder, Schema.Field field, int sqlType,\n-                        int sqlPrecision, int sqlScale, String originalName, boolean handleDecimalAsDouble)\n+                        int sqlPrecision, int sqlScale, String originalName, Schema outputFieldSchema)\n     throws SQLException {\n     // original name has to be used to get result from result set\n     Object o = DBUtils.transformValue(sqlType, sqlPrecision, sqlScale, resultSet, originalName,\n-                                      handleDecimalAsDouble);\n+                                      outputFieldSchema);\n     if (o instanceof Date) {\n       recordBuilder.setDate(field.getName(), ((Date) o).toLocalDate());\n     } else if (o instanceof Time) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTU5OTIwNw==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1246#discussion_r521599207", "bodyText": "not needed", "author": "CuriousVini", "createdAt": "2020-11-11T19:49:02Z", "path": "database-plugins/src/test/java/io/cdap/plugin/db/batch/source/DBSourceTestRun.java", "diffHunk": "@@ -351,8 +416,8 @@ public void testNonExistentDBTable() throws Exception {\n       .addConnection(sourceBadName.getName(), sink.getName())\n       .build();\n     ApplicationId appId = NamespaceId.DEFAULT.app(\"dbSourceNonExistingTest\");\n-    assertDeploymentFailure(appId, etlConfig, \"ETL Application with DB Source should have failed because of a \" +\n-      \"non-existent source table.\");\n+    assertDeploymentFailure(appId, etlConfig, \"ETL Application with DB Source should have failed because \"\n+      + \"of a \" + \"non-existent source table.\");", "originalCommit": "84efa6168f9c775b744acd7e10a3bbf111a51b2f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6f7708e09423dc28243776565f557832d270d40c", "chunk": "diff --git a/database-plugins/src/test/java/io/cdap/plugin/db/batch/source/DBSourceTestRun.java b/database-plugins/src/test/java/io/cdap/plugin/db/batch/source/DBSourceTestRun.java\nindex e8abac1f..e5f73a79 100644\n--- a/database-plugins/src/test/java/io/cdap/plugin/db/batch/source/DBSourceTestRun.java\n+++ b/database-plugins/src/test/java/io/cdap/plugin/db/batch/source/DBSourceTestRun.java\n\n@@ -416,8 +430,8 @@ public class DBSourceTestRun extends DatabasePluginTestBase {\n       .addConnection(sourceBadName.getName(), sink.getName())\n       .build();\n     ApplicationId appId = NamespaceId.DEFAULT.app(\"dbSourceNonExistingTest\");\n-    assertDeploymentFailure(appId, etlConfig, \"ETL Application with DB Source should have failed because \"\n-      + \"of a \" + \"non-existent source table.\");\n+    assertDeploymentFailure(appId, etlConfig, \"ETL Application with DB Source should have failed because of a \" +\n+      \"non-existent source table.\");\n \n     // Bad connection\n     String badConnection = String.format(\"jdbc:hsqldb:hsql://localhost/%sWRONG\", getDatabase());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTU5OTI5MQ==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1246#discussion_r521599291", "bodyText": "Is this unintended?", "author": "CuriousVini", "createdAt": "2020-11-11T19:49:13Z", "path": "database-plugins/src/test/java/io/cdap/plugin/db/batch/source/DBSourceTestRun.java", "diffHunk": "@@ -374,7 +439,7 @@ public void testNonExistentDBTable() throws Exception {\n       .addStage(sink)\n       .addConnection(sourceBadConn.getName(), sink.getName())\n       .build();\n-    assertDeploymentFailure(appId, etlConfig, \"ETL Application with DB Source should have failed because of a \" +\n-      \"non-existent source database.\");\n+    assertDeploymentFailure(appId, etlConfig, \"ETL Application with DB Source should have failed because \"\n+      + \"of a \" + \"non-existent source database.\");", "originalCommit": "84efa6168f9c775b744acd7e10a3bbf111a51b2f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6f7708e09423dc28243776565f557832d270d40c", "chunk": "diff --git a/database-plugins/src/test/java/io/cdap/plugin/db/batch/source/DBSourceTestRun.java b/database-plugins/src/test/java/io/cdap/plugin/db/batch/source/DBSourceTestRun.java\nindex e8abac1f..e5f73a79 100644\n--- a/database-plugins/src/test/java/io/cdap/plugin/db/batch/source/DBSourceTestRun.java\n+++ b/database-plugins/src/test/java/io/cdap/plugin/db/batch/source/DBSourceTestRun.java\n\n@@ -439,7 +453,7 @@ public class DBSourceTestRun extends DatabasePluginTestBase {\n       .addStage(sink)\n       .addConnection(sourceBadConn.getName(), sink.getName())\n       .build();\n-    assertDeploymentFailure(appId, etlConfig, \"ETL Application with DB Source should have failed because \"\n-      + \"of a \" + \"non-existent source database.\");\n+    assertDeploymentFailure(appId, etlConfig, \"ETL Application with DB Source should have failed because of a \" +\n+      \"non-existent source database.\");\n   }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTU5OTQxNA==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1246#discussion_r521599414", "bodyText": "same here. unintended?", "author": "CuriousVini", "createdAt": "2020-11-11T19:49:25Z", "path": "database-plugins/src/test/java/io/cdap/plugin/db/batch/source/DBSourceTestRun.java", "diffHunk": "@@ -298,7 +362,8 @@ public void testUserNamePasswordCombinations() throws Exception {\n     // as source\n     Map<String, String> noUser = new HashMap<>(baseSourceProps);\n     noUser.put(DBConfig.PASSWORD, \"password\");\n-    database = new ETLStage(\"databaseSource\", new ETLPlugin(\"Database\", BatchSource.PLUGIN_TYPE, noUser, null));\n+    database = new ETLStage(\"databaseSource\", new ETLPlugin(\"Database\", BatchSource.PLUGIN_TYPE, noUser,", "originalCommit": "84efa6168f9c775b744acd7e10a3bbf111a51b2f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6f7708e09423dc28243776565f557832d270d40c", "chunk": "diff --git a/database-plugins/src/test/java/io/cdap/plugin/db/batch/source/DBSourceTestRun.java b/database-plugins/src/test/java/io/cdap/plugin/db/batch/source/DBSourceTestRun.java\nindex e8abac1f..e5f73a79 100644\n--- a/database-plugins/src/test/java/io/cdap/plugin/db/batch/source/DBSourceTestRun.java\n+++ b/database-plugins/src/test/java/io/cdap/plugin/db/batch/source/DBSourceTestRun.java\n\n@@ -362,8 +377,7 @@ public class DBSourceTestRun extends DatabasePluginTestBase {\n     // as source\n     Map<String, String> noUser = new HashMap<>(baseSourceProps);\n     noUser.put(DBConfig.PASSWORD, \"password\");\n-    database = new ETLStage(\"databaseSource\", new ETLPlugin(\"Database\", BatchSource.PLUGIN_TYPE, noUser,\n-                                                            null));\n+    database = new ETLStage(\"databaseSource\", new ETLPlugin(\"Database\", BatchSource.PLUGIN_TYPE, noUser, null));\n     etlConfig = ETLBatchConfig.builder()\n       .addStage(database)\n       .addStage(table)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg0NjEyOQ==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1246#discussion_r521846129", "bodyText": "Mark Schema outputSchema as nullable", "author": "CuriousVini", "createdAt": "2020-11-12T05:21:06Z", "path": "database-plugins/src/main/java/io/cdap/plugin/DBUtils.java", "diffHunk": "@@ -149,21 +149,21 @@ public static DriverCleanup ensureJDBCDriverIsAvailable(Class<? extends Driver>\n    * Given the result set, get the metadata of the result set and return\n    * list of {@link io.cdap.cdap.api.data.schema.Schema.Field},\n    * where name of the field is same as column name and type of the field is obtained using\n-   * {@link DBUtils#getSchema(String, int, int, int, String)}\n+   * {@link DBUtils#getSchema(String, int, int, int, String, boolean)}\n    *\n    * @param resultSet result set of executed query\n    * @return list of schema fields\n    * @throws SQLException\n    */\n-  public static List<Schema.Field> getOriginalSchema(ResultSet resultSet) throws SQLException {\n-    return getSchemaFields(resultSet, null, null);\n+  public static List<Schema.Field> getOriginalSchema(ResultSet resultSet, Schema outputSchema) throws SQLException {", "originalCommit": "84efa6168f9c775b744acd7e10a3bbf111a51b2f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg0NjIxNQ==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1246#discussion_r521846215", "bodyText": "Javadoc should be updated and should have same params as number of params in the method", "author": "CuriousVini", "createdAt": "2020-11-12T05:21:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg0NjEyOQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg0NjI2Mg==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1246#discussion_r521846262", "bodyText": "Mark outpuschema as nullable", "author": "CuriousVini", "createdAt": "2020-11-12T05:21:35Z", "path": "database-plugins/src/main/java/io/cdap/plugin/DBUtils.java", "diffHunk": "@@ -172,7 +172,8 @@ public static DriverCleanup ensureJDBCDriverIsAvailable(Class<? extends Driver>\n    * @throws SQLException\n    */\n   public static List<Schema.Field> getSchemaFields(ResultSet resultSet, @Nullable String patternToReplace,\n-                                                   @Nullable String replaceWith) throws SQLException {\n+                                                   @Nullable String replaceWith, Schema outputSchema)", "originalCommit": "84efa6168f9c775b744acd7e10a3bbf111a51b2f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6f7708e09423dc28243776565f557832d270d40c", "chunk": "diff --git a/database-plugins/src/main/java/io/cdap/plugin/DBUtils.java b/database-plugins/src/main/java/io/cdap/plugin/DBUtils.java\nindex 64570b80..44b6b1bc 100644\n--- a/database-plugins/src/main/java/io/cdap/plugin/DBUtils.java\n+++ b/database-plugins/src/main/java/io/cdap/plugin/DBUtils.java\n\n@@ -172,7 +172,7 @@ public final class DBUtils {\n    * @throws SQLException\n    */\n   public static List<Schema.Field> getSchemaFields(ResultSet resultSet, @Nullable String patternToReplace,\n-                                                   @Nullable String replaceWith, Schema outputSchema)\n+                                                   @Nullable String replaceWith, @Nullable Schema outputSchema)\n     throws SQLException {\n     List<Schema.Field> schemaFields = Lists.newArrayList();\n     ResultSetMetaData metadata = resultSet.getMetaData();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg0NjcwOA==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1246#discussion_r521846708", "bodyText": "What is the difference between numeric and decimal type? Does this change need to be applied to numeric too?", "author": "CuriousVini", "createdAt": "2020-11-12T05:22:53Z", "path": "database-plugins/src/main/java/io/cdap/plugin/DBUtils.java", "diffHunk": "@@ -232,13 +247,21 @@ private static Schema getSchema(String typeName, int sqlType, int precision, int\n         break;\n \n       case Types.NUMERIC:", "originalCommit": "84efa6168f9c775b744acd7e10a3bbf111a51b2f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6f7708e09423dc28243776565f557832d270d40c", "chunk": "diff --git a/database-plugins/src/main/java/io/cdap/plugin/DBUtils.java b/database-plugins/src/main/java/io/cdap/plugin/DBUtils.java\nindex 64570b80..44b6b1bc 100644\n--- a/database-plugins/src/main/java/io/cdap/plugin/DBUtils.java\n+++ b/database-plugins/src/main/java/io/cdap/plugin/DBUtils.java\n\n@@ -247,11 +247,6 @@ public final class DBUtils {\n         break;\n \n       case Types.NUMERIC:\n-        // if there are no digits after the point, use integer types\n-        type = scale != 0 ? Schema.Type.DOUBLE :\n-          // with 10 digits we can represent 2^32 and LONG is required\n-          precision > 9 ? Schema.Type.LONG : Schema.Type.INT;\n-        break;\n       case Types.DECIMAL:\n         if (handleAsDecimal) {\n           return Schema.decimalOf(precision, scale);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg0NzMwMw==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1246#discussion_r521847303", "bodyText": "should not have duplicate code. Please refactor it.", "author": "CuriousVini", "createdAt": "2020-11-12T05:24:41Z", "path": "database-plugins/src/main/java/io/cdap/plugin/DBUtils.java", "diffHunk": "@@ -232,13 +247,21 @@ private static Schema getSchema(String typeName, int sqlType, int precision, int\n         break;\n \n       case Types.NUMERIC:\n-      case Types.DECIMAL:\n         // if there are no digits after the point, use integer types\n         type = scale != 0 ? Schema.Type.DOUBLE :\n           // with 10 digits we can represent 2^32 and LONG is required\n           precision > 9 ? Schema.Type.LONG : Schema.Type.INT;\n         break;\n-\n+      case Types.DECIMAL:\n+        if (handleAsDecimal) {\n+          return Schema.decimalOf(precision, scale);\n+        } else {\n+          // if there are no digits after the point, use integer types\n+          type = scale != 0 ? Schema.Type.DOUBLE :", "originalCommit": "84efa6168f9c775b744acd7e10a3bbf111a51b2f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6f7708e09423dc28243776565f557832d270d40c", "chunk": "diff --git a/database-plugins/src/main/java/io/cdap/plugin/DBUtils.java b/database-plugins/src/main/java/io/cdap/plugin/DBUtils.java\nindex 64570b80..44b6b1bc 100644\n--- a/database-plugins/src/main/java/io/cdap/plugin/DBUtils.java\n+++ b/database-plugins/src/main/java/io/cdap/plugin/DBUtils.java\n\n@@ -247,11 +247,6 @@ public final class DBUtils {\n         break;\n \n       case Types.NUMERIC:\n-        // if there are no digits after the point, use integer types\n-        type = scale != 0 ? Schema.Type.DOUBLE :\n-          // with 10 digits we can represent 2^32 and LONG is required\n-          precision > 9 ? Schema.Type.LONG : Schema.Type.INT;\n-        break;\n       case Types.DECIMAL:\n         if (handleAsDecimal) {\n           return Schema.decimalOf(precision, scale);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg0ODczMA==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1246#discussion_r521848730", "bodyText": "shouldnt duplicate the logic. Please refactor it.", "author": "CuriousVini", "createdAt": "2020-11-12T05:29:07Z", "path": "database-plugins/src/main/java/io/cdap/plugin/DBUtils.java", "diffHunk": "@@ -293,6 +316,23 @@ public static Object transformValue(int sqlType, int precision, int scale,\n           } else {\n             return decimal.intValue();\n           }\n+        }\n+        case Types.DECIMAL: {\n+          if (handleAsDecimal) {\n+            return original;\n+          } else {\n+            BigDecimal decimal = (BigDecimal) original;\n+            if (scale != 0) {", "originalCommit": "84efa6168f9c775b744acd7e10a3bbf111a51b2f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6f7708e09423dc28243776565f557832d270d40c", "chunk": "diff --git a/database-plugins/src/main/java/io/cdap/plugin/DBUtils.java b/database-plugins/src/main/java/io/cdap/plugin/DBUtils.java\nindex 64570b80..44b6b1bc 100644\n--- a/database-plugins/src/main/java/io/cdap/plugin/DBUtils.java\n+++ b/database-plugins/src/main/java/io/cdap/plugin/DBUtils.java\n\n@@ -305,21 +300,10 @@ public final class DBUtils {\n         case Types.SMALLINT:\n         case Types.TINYINT:\n           return ((Number) original).intValue();\n-        case Types.NUMERIC: {\n-          BigDecimal decimal = (BigDecimal) original;\n-          if (scale != 0) {\n-            // if there are digits after the point, use double types\n-            return decimal.doubleValue();\n-          } else if (precision > 9) {\n-            // with 10 digits we can represent 2^32 and LONG is required\n-            return decimal.longValue();\n-          } else {\n-            return decimal.intValue();\n-          }\n-        }\n+        case Types.NUMERIC:\n         case Types.DECIMAL: {\n-          if (handleAsDecimal) {\n-            return original;\n+          if (Schema.LogicalType.DECIMAL == outputFieldSchema.getLogicalType()) {\n+              return original;\n           } else {\n             BigDecimal decimal = (BigDecimal) original;\n             if (scale != 0) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg0OTMxNA==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1246#discussion_r521849314", "bodyText": "There is no need for handleAsDecimal  variable in this method. We can just pass Schema.Field field to the method and get the type of field to derive if decimal type needs to be handled.", "author": "CuriousVini", "createdAt": "2020-11-12T05:31:09Z", "path": "database-plugins/src/main/java/io/cdap/plugin/DBRecord.java", "diffHunk": "@@ -124,23 +137,37 @@ public void readFields(ResultSet resultSet) throws SQLException {\n       int sqlType = metadata.getColumnType(i + 1);\n       int sqlPrecision = metadata.getPrecision(i + 1);\n       int sqlScale = metadata.getScale(i + 1);\n+      // handles backwards compatibility\n+      boolean handleAsDecimal = false;\n+      Schema outputFieldSchema = field.getSchema();\n+      outputFieldSchema = outputFieldSchema.isNullable() ? outputFieldSchema.getNonNullable() : outputFieldSchema;\n+      if (sqlType == Types.DECIMAL && (outputSchema == null ||\n+        outputFieldSchema.getLogicalType() == Schema.LogicalType.DECIMAL)) {\n+        handleAsDecimal = true;\n+      }\n       setField(resultSet, recordBuilder, field, sqlType, sqlPrecision, sqlScale, nameMap.getOrDefault(field.getName(),\n-                                                                                                      field.getName()));\n+                                                                                                      field.getName()),\n+               handleAsDecimal);\n     }\n     record = recordBuilder.build();\n   }\n \n   private void setField(ResultSet resultSet, StructuredRecord.Builder recordBuilder, Schema.Field field, int sqlType,\n-                        int sqlPrecision, int sqlScale, String originalName) throws SQLException {\n+                        int sqlPrecision, int sqlScale, String originalName, boolean handleAsDecimal)\n+    throws SQLException {\n     // original name has to be used to get result from result set\n-    Object o = DBUtils.transformValue(sqlType, sqlPrecision, sqlScale, resultSet, originalName);\n+    Object o = DBUtils.transformValue(sqlType, sqlPrecision, sqlScale, resultSet, originalName,\n+                                      handleAsDecimal);", "originalCommit": "84efa6168f9c775b744acd7e10a3bbf111a51b2f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6f7708e09423dc28243776565f557832d270d40c", "chunk": "diff --git a/database-plugins/src/main/java/io/cdap/plugin/DBRecord.java b/database-plugins/src/main/java/io/cdap/plugin/DBRecord.java\nindex a61bc628..35873238 100644\n--- a/database-plugins/src/main/java/io/cdap/plugin/DBRecord.java\n+++ b/database-plugins/src/main/java/io/cdap/plugin/DBRecord.java\n\n@@ -137,27 +137,22 @@ public class DBRecord implements Writable, DBWritable, Configurable {\n       int sqlType = metadata.getColumnType(i + 1);\n       int sqlPrecision = metadata.getPrecision(i + 1);\n       int sqlScale = metadata.getScale(i + 1);\n-      // handles backwards compatibility\n-      boolean handleAsDecimal = false;\n+\n       Schema outputFieldSchema = field.getSchema();\n       outputFieldSchema = outputFieldSchema.isNullable() ? outputFieldSchema.getNonNullable() : outputFieldSchema;\n-      if (sqlType == Types.DECIMAL && (outputSchema == null ||\n-        outputFieldSchema.getLogicalType() == Schema.LogicalType.DECIMAL)) {\n-        handleAsDecimal = true;\n-      }\n       setField(resultSet, recordBuilder, field, sqlType, sqlPrecision, sqlScale, nameMap.getOrDefault(field.getName(),\n                                                                                                       field.getName()),\n-               handleAsDecimal);\n+               outputFieldSchema);\n     }\n     record = recordBuilder.build();\n   }\n \n   private void setField(ResultSet resultSet, StructuredRecord.Builder recordBuilder, Schema.Field field, int sqlType,\n-                        int sqlPrecision, int sqlScale, String originalName, boolean handleAsDecimal)\n+                        int sqlPrecision, int sqlScale, String originalName, Schema outputFieldSchema)\n     throws SQLException {\n     // original name has to be used to get result from result set\n     Object o = DBUtils.transformValue(sqlType, sqlPrecision, sqlScale, resultSet, originalName,\n-                                      handleAsDecimal);\n+                                      outputFieldSchema);\n     if (o instanceof Date) {\n       recordBuilder.setDate(field.getName(), ((Date) o).toLocalDate());\n     } else if (o instanceof Time) {\n"}}, {"oid": "6f7708e09423dc28243776565f557832d270d40c", "url": "https://github.com/cdapio/hydrator-plugins/commit/6f7708e09423dc28243776565f557832d270d40c", "message": "Backwards compatibility", "committedDate": "2020-11-17T18:33:29Z", "type": "commit"}, {"oid": "6f7708e09423dc28243776565f557832d270d40c", "url": "https://github.com/cdapio/hydrator-plugins/commit/6f7708e09423dc28243776565f557832d270d40c", "message": "Backwards compatibility", "committedDate": "2020-11-17T18:33:29Z", "type": "forcePushed"}]}