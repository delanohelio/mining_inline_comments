{"pr_number": 1034, "pr_title": "(PLUGIN-114) Added COUNTDISTINCT function to count the distinct value\u2026", "pr_createdAt": "2020-03-07T19:19:21Z", "pr_url": "https://github.com/cdapio/hydrator-plugins/pull/1034", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTc5ODE3NQ==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1034#discussion_r389798175", "bodyText": "this will only work for some field types. Those types should be validated at configure time, and again at prepare time if it couldn't be checked at configure time due to macros. More specifically, this will not \"work\" except on ints, longs, strings, floats, and doubles. And for floats and doubles, it doesn't really make much sense.\nIf it needs to work for other types, it is quite a bit more complex.", "author": "albertshau", "createdAt": "2020-03-09T16:15:00Z", "path": "core-plugins/src/main/java/io/cdap/plugin/batch/aggregator/function/CountDistinct.java", "diffHunk": "@@ -0,0 +1,55 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.plugin.batch.aggregator.function;\n+\n+import io.cdap.cdap.api.data.format.StructuredRecord;\n+import io.cdap.cdap.api.data.schema.Schema;\n+\n+import java.util.HashSet;\n+import java.util.Set;\n+\n+/**\n+ * Count distinct values of a specific column\n+ */\n+public class CountDistinct implements AggregateFunction<Integer> {\n+  private final String fieldName;\n+  private Set<Object> collectSet;", "originalCommit": "ea1a6691b112b8d0c20a0f0d956945be4b8c0bbc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA4NzU5OQ==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1034#discussion_r390087599", "bodyText": "@albertshau can you explain why we'd need to validate specific types? most of the use cases I can think of would be satisfied with strings, ints, longs, floats and doubles. Perhaps booleans in addition. But I'm unable to follow why it wouldn't work for others, and by others you mean the other types in the Schema object, right?", "author": "bdmogal", "createdAt": "2020-03-10T04:18:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTc5ODE3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDcyODAzMw==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1034#discussion_r390728033", "bodyText": "fixed", "author": "bdmogal", "createdAt": "2020-03-11T03:30:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTc5ODE3NQ=="}], "type": "inlineReview", "revised_code": {"commit": "d0df39679a70b9486e8b1fb710fc54fb17a249f1", "chunk": "diff --git a/core-plugins/src/main/java/io/cdap/plugin/batch/aggregator/function/CountDistinct.java b/core-plugins/src/main/java/io/cdap/plugin/batch/aggregator/function/CountDistinct.java\nindex 49c45691..1433ba4f 100644\n--- a/core-plugins/src/main/java/io/cdap/plugin/batch/aggregator/function/CountDistinct.java\n+++ b/core-plugins/src/main/java/io/cdap/plugin/batch/aggregator/function/CountDistinct.java\n\n@@ -27,15 +27,16 @@ import java.util.Set;\n  */\n public class CountDistinct implements AggregateFunction<Integer> {\n   private final String fieldName;\n-  private Set<Object> collectSet;\n+  private final Set<Object> collectSet;\n \n   public CountDistinct(String fieldName) {\n     this.fieldName = fieldName;\n+    this.collectSet = new HashSet<>();\n   }\n \n   @Override\n   public void beginFunction() {\n-    collectSet = new HashSet<>();\n+    collectSet.clear();\n   }\n \n   @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTc5OTM0OA==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1034#discussion_r389799348", "bodyText": "a little better to have the Set as final and create it in the constructor, and clear it here.", "author": "albertshau", "createdAt": "2020-03-09T16:16:42Z", "path": "core-plugins/src/main/java/io/cdap/plugin/batch/aggregator/function/CountDistinct.java", "diffHunk": "@@ -0,0 +1,55 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.plugin.batch.aggregator.function;\n+\n+import io.cdap.cdap.api.data.format.StructuredRecord;\n+import io.cdap.cdap.api.data.schema.Schema;\n+\n+import java.util.HashSet;\n+import java.util.Set;\n+\n+/**\n+ * Count distinct values of a specific column\n+ */\n+public class CountDistinct implements AggregateFunction<Integer> {\n+  private final String fieldName;\n+  private Set<Object> collectSet;\n+\n+  public CountDistinct(String fieldName) {\n+    this.fieldName = fieldName;\n+  }\n+\n+  @Override\n+  public void beginFunction() {\n+    collectSet = new HashSet<>();", "originalCommit": "ea1a6691b112b8d0c20a0f0d956945be4b8c0bbc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA4Nzg4MQ==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1034#discussion_r390087881", "bodyText": "fixed", "author": "bdmogal", "createdAt": "2020-03-10T04:19:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTc5OTM0OA=="}], "type": "inlineReview", "revised_code": {"commit": "d0df39679a70b9486e8b1fb710fc54fb17a249f1", "chunk": "diff --git a/core-plugins/src/main/java/io/cdap/plugin/batch/aggregator/function/CountDistinct.java b/core-plugins/src/main/java/io/cdap/plugin/batch/aggregator/function/CountDistinct.java\nindex 49c45691..1433ba4f 100644\n--- a/core-plugins/src/main/java/io/cdap/plugin/batch/aggregator/function/CountDistinct.java\n+++ b/core-plugins/src/main/java/io/cdap/plugin/batch/aggregator/function/CountDistinct.java\n\n@@ -27,15 +27,16 @@ import java.util.Set;\n  */\n public class CountDistinct implements AggregateFunction<Integer> {\n   private final String fieldName;\n-  private Set<Object> collectSet;\n+  private final Set<Object> collectSet;\n \n   public CountDistinct(String fieldName) {\n     this.fieldName = fieldName;\n+    this.collectSet = new HashSet<>();\n   }\n \n   @Override\n   public void beginFunction() {\n-    collectSet = new HashSet<>();\n+    collectSet.clear();\n   }\n \n   @Override\n"}}, {"oid": "d0df39679a70b9486e8b1fb710fc54fb17a249f1", "url": "https://github.com/cdapio/hydrator-plugins/commit/d0df39679a70b9486e8b1fb710fc54fb17a249f1", "message": "Address comments.", "committedDate": "2020-03-11T03:21:58Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMxNzgxNw==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1034#discussion_r391317817", "bodyText": "is it possible for this to be false at this point? seems like it wouldn't be.", "author": "albertshau", "createdAt": "2020-03-11T23:00:35Z", "path": "core-plugins/src/main/java/io/cdap/plugin/batch/aggregator/GroupByAggregator.java", "diffHunk": "@@ -131,9 +131,29 @@ public void validate(Schema inputSchema, List<String> groupByFields,\n                                            functionInfo.getName(), functionInfo.getField()), null)\n           .withConfigElement(\"aggregates\", collectorFieldName);\n       }\n-    }\n \n+      // TODO: CDAP-16401 - Push down validation to individual aggregate functions\n+      if (GroupByConfig.Function.COUNTDISTINCT == functionInfo.getFunction()) {\n+        if (!conf.containsMacro(\"aggregates\")) {", "originalCommit": "d0df39679a70b9486e8b1fb710fc54fb17a249f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMzMDY3NQ==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1034#discussion_r391330675", "bodyText": "ah! the macro check for aggregates is kind of in the weeds so I missed it. Removed it.", "author": "bdmogal", "createdAt": "2020-03-11T23:42:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMxNzgxNw=="}], "type": "inlineReview", "revised_code": {"commit": "251bcd7c2613f49df5f116c8aa71f6ae8aba2a92", "chunk": "diff --git a/core-plugins/src/main/java/io/cdap/plugin/batch/aggregator/GroupByAggregator.java b/core-plugins/src/main/java/io/cdap/plugin/batch/aggregator/GroupByAggregator.java\nindex db38db83..ac6b5e25 100644\n--- a/core-plugins/src/main/java/io/cdap/plugin/batch/aggregator/GroupByAggregator.java\n+++ b/core-plugins/src/main/java/io/cdap/plugin/batch/aggregator/GroupByAggregator.java\n\n@@ -134,9 +134,7 @@ public class GroupByAggregator extends RecordAggregator {\n \n       // TODO: CDAP-16401 - Push down validation to individual aggregate functions\n       if (GroupByConfig.Function.COUNTDISTINCT == functionInfo.getFunction()) {\n-        if (!conf.containsMacro(\"aggregates\")) {\n-          validateCountDistinct(inputField, collector, collectorFieldName);\n-        }\n+        validateCountDistinct(inputField, collector, collectorFieldName);\n       }\n     }\n   }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMxODQwMQ==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1034#discussion_r391318401", "bodyText": "does it really make sense to allow float and double? It could potentially go out of memory easily, with 0.000001 different than 0.00000001, etc.\nIn Java when you check equality of floats and doubles most IDEs will flag it as a warning.", "author": "albertshau", "createdAt": "2020-03-11T23:02:11Z", "path": "core-plugins/src/main/java/io/cdap/plugin/batch/aggregator/GroupByAggregator.java", "diffHunk": "@@ -131,9 +131,29 @@ public void validate(Schema inputSchema, List<String> groupByFields,\n                                            functionInfo.getName(), functionInfo.getField()), null)\n           .withConfigElement(\"aggregates\", collectorFieldName);\n       }\n-    }\n \n+      // TODO: CDAP-16401 - Push down validation to individual aggregate functions\n+      if (GroupByConfig.Function.COUNTDISTINCT == functionInfo.getFunction()) {\n+        if (!conf.containsMacro(\"aggregates\")) {\n+          validateCountDistinct(inputField, collector, collectorFieldName);\n+        }\n+      }\n+    }\n+  }\n \n+  private void validateCountDistinct(Schema.Field inputField, FailureCollector collector, String validationFieldName) {\n+    if (inputField != null) {\n+      Schema.Type type = inputField.getSchema().isNullable() ?\n+        inputField.getSchema().getNonNullable().getType() :\n+        inputField.getSchema().getType();\n+      if (type != Schema.Type.STRING && type != Schema.Type.INT && type != Schema.Type.LONG &&\n+        type != Schema.Type.FLOAT && type != Schema.Type.DOUBLE && type != Schema.Type.BOOLEAN) {", "originalCommit": "d0df39679a70b9486e8b1fb710fc54fb17a249f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMxOTc4OQ==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1034#discussion_r391319789", "bodyText": "though i guess the same could be set for CollectSet. We probably need a way to collect warnings and failures, with this falling under the warning category.", "author": "albertshau", "createdAt": "2020-03-11T23:06:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMxODQwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMzMzI3Mw==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1034#discussion_r391333273", "bodyText": "Reported an improvement. https://issues.cask.co/browse/CDAP-16418. However, at this point, I don't think we need to absorb the risk of an OOM. I've removed support for FLOAT and DOUBLE right now. Can add it if someone brings up a use case explicitly.", "author": "bdmogal", "createdAt": "2020-03-11T23:51:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMxODQwMQ=="}], "type": "inlineReview", "revised_code": {"commit": "251bcd7c2613f49df5f116c8aa71f6ae8aba2a92", "chunk": "diff --git a/core-plugins/src/main/java/io/cdap/plugin/batch/aggregator/GroupByAggregator.java b/core-plugins/src/main/java/io/cdap/plugin/batch/aggregator/GroupByAggregator.java\nindex db38db83..ac6b5e25 100644\n--- a/core-plugins/src/main/java/io/cdap/plugin/batch/aggregator/GroupByAggregator.java\n+++ b/core-plugins/src/main/java/io/cdap/plugin/batch/aggregator/GroupByAggregator.java\n\n@@ -134,9 +134,7 @@ public class GroupByAggregator extends RecordAggregator {\n \n       // TODO: CDAP-16401 - Push down validation to individual aggregate functions\n       if (GroupByConfig.Function.COUNTDISTINCT == functionInfo.getFunction()) {\n-        if (!conf.containsMacro(\"aggregates\")) {\n-          validateCountDistinct(inputField, collector, collectorFieldName);\n-        }\n+        validateCountDistinct(inputField, collector, collectorFieldName);\n       }\n     }\n   }\n"}}, {"oid": "251bcd7c2613f49df5f116c8aa71f6ae8aba2a92", "url": "https://github.com/cdapio/hydrator-plugins/commit/251bcd7c2613f49df5f116c8aa71f6ae8aba2a92", "message": "removed unnecessary condition", "committedDate": "2020-03-11T23:40:27Z", "type": "forcePushed"}, {"oid": "40da3e37a5eee1ddfdffa781ac59f9e9742dde13", "url": "https://github.com/cdapio/hydrator-plugins/commit/40da3e37a5eee1ddfdffa781ac59f9e9742dde13", "message": "(PLUGIN-114) Added COUNTDISTINCT function to count the distinct values in a column", "committedDate": "2020-03-11T23:56:52Z", "type": "commit"}, {"oid": "40da3e37a5eee1ddfdffa781ac59f9e9742dde13", "url": "https://github.com/cdapio/hydrator-plugins/commit/40da3e37a5eee1ddfdffa781ac59f9e9742dde13", "message": "(PLUGIN-114) Added COUNTDISTINCT function to count the distinct values in a column", "committedDate": "2020-03-11T23:56:52Z", "type": "forcePushed"}]}