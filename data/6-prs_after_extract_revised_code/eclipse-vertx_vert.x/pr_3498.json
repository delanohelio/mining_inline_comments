{"pr_number": 3498, "pr_title": "HTTP client improvements", "pr_createdAt": "2020-07-14T13:54:33Z", "pr_url": "https://github.com/eclipse-vertx/vert.x/pull/3498", "timeline": [{"oid": "be669a5a7559b354ae20c55297ca98e407aa0297", "url": "https://github.com/eclipse-vertx/vert.x/commit/be669a5a7559b354ae20c55297ca98e407aa0297", "message": "HttpClient does not create anymore lazy HTTP requests", "committedDate": "2020-07-14T13:58:13Z", "type": "forcePushed"}, {"oid": "b4933d95352350dfc9116f395272c1f0f787c3ee", "url": "https://github.com/eclipse-vertx/vert.x/commit/b4933d95352350dfc9116f395272c1f0f787c3ee", "message": "Decouple HTTP client internal from API request/response", "committedDate": "2020-07-17T08:21:36Z", "type": "forcePushed"}, {"oid": "996811152e3eafa8cdde3383f36ea70ef08757ba", "url": "https://github.com/eclipse-vertx/vert.x/commit/996811152e3eafa8cdde3383f36ea70ef08757ba", "message": "Decouple HTTP client internal from API request/response", "committedDate": "2020-07-17T09:48:13Z", "type": "forcePushed"}, {"oid": "2be077ab4772087657fd5f171be30fc6c601452e", "url": "https://github.com/eclipse-vertx/vert.x/commit/2be077ab4772087657fd5f171be30fc6c601452e", "message": "Some cleanup and improvements", "committedDate": "2020-07-17T11:46:26Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQzNzg1OQ==", "url": "https://github.com/eclipse-vertx/vert.x/pull/3498#discussion_r456437859", "bodyText": "2020 \ud83d\ude09", "author": "jponge", "createdAt": "2020-07-17T13:21:45Z", "path": "src/main/java/io/vertx/core/http/impl/HttpClientPush.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/*\n+ * Copyright (c) 2011-2019 Contributors to the Eclipse Foundation", "originalCommit": "36dbbb8d7b882c208e50940ecb7edd730f5f5bfc", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b36c7a489edaa8506babb898828b9708be3db995", "chunk": "diff --git a/src/main/java/io/vertx/core/http/impl/HttpClientPush.java b/src/main/java/io/vertx/core/http/impl/HttpClientPush.java\ndeleted file mode 100644\nindex 673a9e1f6..000000000\n--- a/src/main/java/io/vertx/core/http/impl/HttpClientPush.java\n+++ /dev/null\n\n@@ -1,80 +0,0 @@\n-/*\n- * Copyright (c) 2011-2019 Contributors to the Eclipse Foundation\n- *\n- * This program and the accompanying materials are made available under the\n- * terms of the Eclipse Public License 2.0 which is available at\n- * http://www.eclipse.org/legal/epl-2.0, or the Apache License, Version 2.0\n- * which is available at https://www.apache.org/licenses/LICENSE-2.0.\n- *\n- * SPDX-License-Identifier: EPL-2.0 OR Apache-2.0\n- */\n-package io.vertx.core.http.impl;\n-\n-import io.netty.handler.codec.http2.Http2Headers;\n-import io.vertx.core.MultiMap;\n-import io.vertx.core.http.HttpMethod;\n-import io.vertx.core.http.impl.headers.Http2HeadersAdaptor;\n-import io.vertx.core.net.SocketAddress;\n-import io.vertx.core.spi.observability.HttpRequest;\n-\n-/**\n- * @author <a href=\"mailto:julien@julienviet.com\">Julien Viet</a>\n- */\n-public class HttpClientPush implements HttpRequest {\n-\n-  final int port;\n-  final String uri;\n-  final HttpMethod method;\n-  final String host;\n-  final HttpClientStream stream;\n-  final MultiMap headers;\n-\n-  public HttpClientPush(Http2Headers headers, HttpClientStream stream) {\n-\n-    String rawMethod = headers.method().toString();\n-    String authority = headers.authority() != null ? headers.authority().toString() : null;\n-    MultiMap headersMap = new Http2HeadersAdaptor(headers);\n-    int pos = authority.indexOf(':');\n-    if (pos == -1) {\n-      this.host = authority;\n-      this.port = 80;\n-    } else {\n-      this.host = authority.substring(0, pos);\n-      this.port = Integer.parseInt(authority.substring(pos + 1));\n-    }\n-    this.method = HttpMethod.valueOf(rawMethod);\n-    this.uri = headers.path().toString();\n-    this.stream = stream;\n-    this.headers = headersMap;\n-  }\n-\n-  @Override\n-  public int id() {\n-    return stream.id();\n-  }\n-\n-  @Override\n-  public MultiMap headers() {\n-    return headers;\n-  }\n-\n-  @Override\n-  public String absoluteURI() {\n-    return null;\n-  }\n-\n-  @Override\n-  public SocketAddress remoteAddress() {\n-    return stream.connection().remoteAddress();\n-  }\n-\n-  @Override\n-  public String uri() {\n-    return uri;\n-  }\n-\n-  @Override\n-  public HttpMethod method() {\n-    return method;\n-  }\n-}\n"}}, {"oid": "b36c7a489edaa8506babb898828b9708be3db995", "url": "https://github.com/eclipse-vertx/vert.x/commit/b36c7a489edaa8506babb898828b9708be3db995", "message": "HttpClient does not create anymore lazy HTTP requests", "committedDate": "2020-07-18T07:45:43Z", "type": "commit"}, {"oid": "1eb45a93a354902c1a131380f00cb9f4e0b8e5dd", "url": "https://github.com/eclipse-vertx/vert.x/commit/1eb45a93a354902c1a131380f00cb9f4e0b8e5dd", "message": "Decouple HTTP client internal from API request/response", "committedDate": "2020-07-18T07:45:43Z", "type": "commit"}, {"oid": "79727b4308b17c184fe82d0087ea5f8d696f3d13", "url": "https://github.com/eclipse-vertx/vert.x/commit/79727b4308b17c184fe82d0087ea5f8d696f3d13", "message": "Some cleanup and improvements", "committedDate": "2020-07-18T07:45:43Z", "type": "commit"}, {"oid": "3aa1b40a025dfc44c818a0c59fc62ab401f8438a", "url": "https://github.com/eclipse-vertx/vert.x/commit/3aa1b40a025dfc44c818a0c59fc62ab401f8438a", "message": "Minor cleanup", "committedDate": "2020-07-18T07:45:43Z", "type": "commit"}, {"oid": "969b6bbf5e48a242847d08b88c8121204323c6f1", "url": "https://github.com/eclipse-vertx/vert.x/commit/969b6bbf5e48a242847d08b88c8121204323c6f1", "message": "Use context for request timeout", "committedDate": "2020-07-18T07:45:43Z", "type": "commit"}, {"oid": "4b1b44c96b5d9af615b0babbc3f3496403d392e6", "url": "https://github.com/eclipse-vertx/vert.x/commit/4b1b44c96b5d9af615b0babbc3f3496403d392e6", "message": "Update copyright date", "committedDate": "2020-07-18T07:45:43Z", "type": "commit"}, {"oid": "39593df11aabbdb08ebfbeb208a586c00e006eb2", "url": "https://github.com/eclipse-vertx/vert.x/commit/39593df11aabbdb08ebfbeb208a586c00e006eb2", "message": "Improvement", "committedDate": "2020-07-18T15:27:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzE1NzIwNw==", "url": "https://github.com/eclipse-vertx/vert.x/pull/3498#discussion_r457157207", "bodyText": "Update or remove?", "author": "tsegismont", "createdAt": "2020-07-20T08:08:21Z", "path": "src/test/java/io/vertx/core/spi/tracing/HttpTracerTestBase.java", "diffHunk": "@@ -156,8 +160,8 @@ public Object sendRequest(Context context, Object request, String operation, BiC\n       public void receiveResponse(Context context, Object response, Object payload, Throwable failure, TagExtractor tagExtractor) {\n         assertSame(val, context.getLocal(key));\n         assertTrue(context.removeLocal(key));\n-        assertNotNull(response);\n-        assertTrue(response instanceof HttpClientResponse);\n+//        assertNotNull(response);", "originalCommit": "005c7cade9b17bd971b2b061e5b2d67b21af5919", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "47d29071fb04c83e94198a467ba09885a3b37ff5", "chunk": "diff --git a/src/test/java/io/vertx/core/spi/tracing/HttpTracerTestBase.java b/src/test/java/io/vertx/core/spi/tracing/HttpTracerTestBase.java\nindex adb65d7b1..3cd79b529 100644\n--- a/src/test/java/io/vertx/core/spi/tracing/HttpTracerTestBase.java\n+++ b/src/test/java/io/vertx/core/spi/tracing/HttpTracerTestBase.java\n\n@@ -154,14 +156,16 @@ public abstract class HttpTracerTestBase extends HttpTestBase {\n         assertSame(val, context.getLocal(key));\n         assertTrue(seq.compareAndSet(0, 1));\n         headers.accept(\"header-key\",\"header-value\");\n+        assertNotNull(request);\n+        assertTrue(request instanceof HttpRequest);\n         return request;\n       }\n       @Override\n       public void receiveResponse(Context context, Object response, Object payload, Throwable failure, TagExtractor tagExtractor) {\n         assertSame(val, context.getLocal(key));\n         assertTrue(context.removeLocal(key));\n-//        assertNotNull(response);\n-//        assertTrue(response instanceof HttpClientResponse);\n+        assertNotNull(response);\n+        assertTrue(response instanceof HttpResponse);\n         assertNull(failure);\n         assertTrue(seq.compareAndSet(1, 2));\n       }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzE2MzM3Mg==", "url": "https://github.com/eclipse-vertx/vert.x/pull/3498#discussion_r457163372", "bodyText": "todo, fail ?", "author": "tsegismont", "createdAt": "2020-07-20T08:16:40Z", "path": "src/main/java/io/vertx/core/http/impl/VertxHttp2Stream.java", "diffHunk": "@@ -210,10 +212,20 @@ final void writeData(ByteBuf chunk, boolean end, Handler<AsyncResult<Void>> hand\n     }\n   }\n \n-  void doWriteData(ByteBuf chunk, boolean end, Handler<AsyncResult<Void>> handler) {\n-    bytesWritten += chunk.readableBytes();\n-    FutureListener<Void> promise = handler == null ? null : context.promise(handler);\n-    conn.handler.writeData(stream, chunk, end, promise);\n+  void doWriteData(ByteBuf buf, boolean end, Handler<AsyncResult<Void>> handler) {\n+    ByteBuf chunk;\n+    if (buf == null && end) {\n+      chunk = Unpooled.EMPTY_BUFFER;\n+    } else {\n+      chunk = buf;\n+    }\n+    if (chunk != null) {\n+      bytesWritten += chunk.readableBytes();\n+      FutureListener<Void> promise = handler == null ? null : context.promise(handler);\n+      conn.handler.writeData(stream, chunk, end, promise);\n+    } else {\n+      // todo ??????????", "originalCommit": "005c7cade9b17bd971b2b061e5b2d67b21af5919", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e01b6945677937ad22c09d1a6bd813ba845f8c2d", "chunk": "diff --git a/src/main/java/io/vertx/core/http/impl/VertxHttp2Stream.java b/src/main/java/io/vertx/core/http/impl/VertxHttp2Stream.java\nindex e23747e3c..7257d2eac 100644\n--- a/src/main/java/io/vertx/core/http/impl/VertxHttp2Stream.java\n+++ b/src/main/java/io/vertx/core/http/impl/VertxHttp2Stream.java\n\n@@ -219,13 +219,9 @@ abstract class VertxHttp2Stream<C extends Http2ConnectionBase> {\n     } else {\n       chunk = buf;\n     }\n-    if (chunk != null) {\n-      bytesWritten += chunk.readableBytes();\n-      FutureListener<Void> promise = handler == null ? null : context.promise(handler);\n-      conn.handler.writeData(stream, chunk, end, promise);\n-    } else {\n-      // todo ??????????\n-    }\n+    bytesWritten += chunk.readableBytes();\n+    FutureListener<Void> promise = handler == null ? null : context.promise(handler);\n+    conn.handler.writeData(stream, chunk, end, promise);\n   }\n \n   final void writeReset(long code) {\n"}}, {"oid": "cc829a2d8a13dcb81108c279113e28218f2456dc", "url": "https://github.com/eclipse-vertx/vert.x/commit/cc829a2d8a13dcb81108c279113e28218f2456dc", "message": "HttpClient redirect handler should return RequestOptions instead of an HttpClientRequest", "committedDate": "2020-07-20T13:56:50Z", "type": "commit"}, {"oid": "7fff420e6ba054cf3aada16b563d1553b2718cc4", "url": "https://github.com/eclipse-vertx/vert.x/commit/7fff420e6ba054cf3aada16b563d1553b2718cc4", "message": "Rework HTTP client setimout", "committedDate": "2020-07-20T14:40:26Z", "type": "commit"}, {"oid": "7fff420e6ba054cf3aada16b563d1553b2718cc4", "url": "https://github.com/eclipse-vertx/vert.x/commit/7fff420e6ba054cf3aada16b563d1553b2718cc4", "message": "Rework HTTP client setimout", "committedDate": "2020-07-20T14:40:26Z", "type": "forcePushed"}, {"oid": "e01b6945677937ad22c09d1a6bd813ba845f8c2d", "url": "https://github.com/eclipse-vertx/vert.x/commit/e01b6945677937ad22c09d1a6bd813ba845f8c2d", "message": "Make sure we don't write a null buffer when the stream is not ended", "committedDate": "2020-07-21T06:47:20Z", "type": "commit"}, {"oid": "237576cdf955bf25b76967554070ba47d7813be2", "url": "https://github.com/eclipse-vertx/vert.x/commit/237576cdf955bf25b76967554070ba47d7813be2", "message": "Fix incorrect test", "committedDate": "2020-07-21T07:09:35Z", "type": "commit"}, {"oid": "0d4ba8b834d5fdd798a403e53cf13a74f3a98931", "url": "https://github.com/eclipse-vertx/vert.x/commit/0d4ba8b834d5fdd798a403e53cf13a74f3a98931", "message": "HTTP/2 connection handler should be set after the handler has been added to the pipeline as we might need to use it before the settings frame has been read", "committedDate": "2020-07-21T07:33:10Z", "type": "commit"}, {"oid": "47d29071fb04c83e94198a467ba09885a3b37ff5", "url": "https://github.com/eclipse-vertx/vert.x/commit/47d29071fb04c83e94198a467ba09885a3b37ff5", "message": "HttpTracerTestBase should use now the correct types for client request/response", "committedDate": "2020-07-21T07:37:26Z", "type": "commit"}, {"oid": "cc8547d443d801242b30f8287a9411210f0a45f3", "url": "https://github.com/eclipse-vertx/vert.x/commit/cc8547d443d801242b30f8287a9411210f0a45f3", "message": "Make timeout fields private", "committedDate": "2020-07-21T07:45:17Z", "type": "commit"}]}