{"pr_number": 1091, "pr_title": "Makes HTTP request method mandatory", "pr_createdAt": "2020-02-23T00:01:05Z", "pr_url": "https://github.com/openzipkin/brave/pull/1091", "timeline": [{"oid": "d49072222eb1ef7590e30f4d313dcf66c63cba92", "url": "https://github.com/openzipkin/brave/commit/d49072222eb1ef7590e30f4d313dcf66c63cba92", "message": "Makes HTTP request method mandatory\n\nWhile all other properties can be absent or invalid, this makes the HTTP\nmethod mandatory. This will help when we create a path to the request\nfrom the response, as it allows chaining to the method without a null\ncheck.\n\nNote: while it seems path would also always be available even recently,\nit has been found missing due to a [request availablility bug](https://github.com/reactor/reactor-netty/pull/998). Eventhough we've seen method incorrectly set in the past,\nwe've never seen it missing.\n\nFixes #1089", "committedDate": "2020-02-22T23:56:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjk1OTAwNg==", "url": "https://github.com/openzipkin/brave/pull/1091#discussion_r382959006", "bodyText": "Agree that HTTP spec doesn't actually require a path (OPTIONS commonly has * which I don't know if we call a path, CONNECT has only authority). So nullable seems fine.\nBut not so sympathetic with the availability bug issue - seems like bad http library as opposed to bad instrumentation, not sure if that specifically should fall into our defensive requirements.", "author": "anuraaga", "createdAt": "2020-02-23T02:51:35Z", "path": "instrumentation/http/src/main/java/brave/http/HttpAdapter.java", "diffHunk": "@@ -19,7 +19,7 @@\n /** @deprecated Since 5.10, use {@link HttpRequest} and {@link HttpResponse} */\n @Deprecated public abstract class HttpAdapter<Req, Resp> {\n   /** @see HttpRequest#method() */\n-  @Nullable public abstract String method(Req request);\n+  public abstract String method(Req request);\n \n   /** @see HttpRequest#path() */\n   @Nullable public String path(Req request) {", "originalCommit": "d49072222eb1ef7590e30f4d313dcf66c63cba92", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjk2MDUwNg==", "url": "https://github.com/openzipkin/brave/pull/1091#discussion_r382960506", "bodyText": "This was one example of path missing, something from last week, not the only time.\nI think it is wise to be cautious as instrumentation should do no harm. Users can't always control versions of things and for example, even in armeria there are availability checks to prevent a known class of bugs. I don't expect you to agree with me but I disagree that we should just trust path will exist and anything that causes it not to be should crash requests.", "author": "codefromthecrypt", "createdAt": "2020-02-23T03:28:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjk1OTAwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjk2MDk1OA==", "url": "https://github.com/openzipkin/brave/pull/1091#discussion_r382960958", "bodyText": "I reworded the javadoc towards the method rationale without suggesting that's the only reason why. The other reasons could be in the class of parse failures, or availability drift outside our control, but IMHO shouldn't cause requests to crash. hope the words balance!", "author": "codefromthecrypt", "createdAt": "2020-02-23T03:39:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjk1OTAwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjk2MDk4Mg==", "url": "https://github.com/openzipkin/brave/pull/1091#discussion_r382960982", "bodyText": "concretely, if we \"fixed path\" now, we'd definitely blow up former versions of instrumentation, causing revlock.", "author": "codefromthecrypt", "createdAt": "2020-02-23T03:40:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjk1OTAwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjk2MTMzNg==", "url": "https://github.com/openzipkin/brave/pull/1091#discussion_r382961336", "bodyText": "PS I'd be fine with forcing path to be present on the methods relevant in a major release. We'd just know this would invalidate third party stuff and they'd get revlocked to the old one, causing the old version to need patches in worst case. Not signing up for that work personally, but agree in a green field or known break scenario stricter rules could apply.", "author": "codefromthecrypt", "createdAt": "2020-02-23T03:48:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjk1OTAwNg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjk1OTA2OQ==", "url": "https://github.com/openzipkin/brave/pull/1091#discussion_r382959069", "bodyText": "Think we can remove this null check (it's the one I most wanted to remove since it's the span name :) ).\nBut if you think we need it I guess we are missing @Nullable on the protected spanName method.", "author": "anuraaga", "createdAt": "2020-02-23T02:53:20Z", "path": "instrumentation/http/src/main/java/brave/http/HttpRequestParser.java", "diffHunk": "@@ -62,8 +62,7 @@\n     @Override public void parse(HttpRequest req, TraceContext context, SpanCustomizer span) {\n       String name = spanName(req, context);\n       if (name != null) span.name(name);", "originalCommit": "d49072222eb1ef7590e30f4d313dcf66c63cba92", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjk2MDU2MA==", "url": "https://github.com/openzipkin/brave/pull/1091#discussion_r382960560", "bodyText": "I can fix the lack of nullable", "author": "codefromthecrypt", "createdAt": "2020-02-23T03:30:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjk1OTA2OQ=="}], "type": "inlineReview", "revised_code": {"commit": "590a7d2f9277705062049e66c5c9c135a7d48cd1", "chunk": "diff --git a/instrumentation/http/src/main/java/brave/http/HttpRequestParser.java b/instrumentation/http/src/main/java/brave/http/HttpRequestParser.java\nindex 9d0a9f990..c07d9d82e 100644\n--- a/instrumentation/http/src/main/java/brave/http/HttpRequestParser.java\n+++ b/instrumentation/http/src/main/java/brave/http/HttpRequestParser.java\n\n@@ -67,8 +67,11 @@ public interface HttpRequestParser {\n       if (path != null) span.tag(\"http.path\", path);\n     }\n \n-    /** Returns the span name of the request. Defaults to the http method. */\n-    protected String spanName(HttpRequest req, TraceContext context) {\n+    /**\n+     * Returns the span name of the request or null if the data needed is unavailable. Defaults to\n+     * the http method.\n+     */\n+    @Nullable protected String spanName(HttpRequest req, TraceContext context) {\n       return req.method();\n     }\n   }\n"}}, {"oid": "590a7d2f9277705062049e66c5c9c135a7d48cd1", "url": "https://github.com/openzipkin/brave/commit/590a7d2f9277705062049e66c5c9c135a7d48cd1", "message": "missing nullable", "committedDate": "2020-02-23T03:32:26Z", "type": "commit"}, {"oid": "27077303d93b008bf231556289a8e384f12a6826", "url": "https://github.com/openzipkin/brave/commit/27077303d93b008bf231556289a8e384f12a6826", "message": "reword", "committedDate": "2020-02-23T03:38:04Z", "type": "commit"}, {"oid": "65647e6fc3af9ad5fa2dcfc979f186748f38ca05", "url": "https://github.com/openzipkin/brave/commit/65647e6fc3af9ad5fa2dcfc979f186748f38ca05", "message": "rationale", "committedDate": "2020-02-23T04:14:35Z", "type": "commit"}]}