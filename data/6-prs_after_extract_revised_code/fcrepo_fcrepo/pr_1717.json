{"pr_number": 1717, "pr_title": "Adds support for order_by and order search parameters.", "pr_createdAt": "2020-07-08T19:47:38Z", "pr_url": "https://github.com/fcrepo/fcrepo/pull/1717", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjI1NzkzMQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1717#discussion_r452257931", "bodyText": "Minor: Can you bring the closing ) to follow directly after orderBy?", "author": "awoods", "createdAt": "2020-07-09T14:26:03Z", "path": "fcrepo-http-api/src/main/java/org/fcrepo/http/api/FedoraSearch.java", "diffHunk": "@@ -82,7 +82,10 @@ public FedoraSearch() {\n     public Response doSearch(@QueryParam(value = \"condition\") final List<String> conditions,\n                              @QueryParam(value = \"fields\") final String fields,\n                              @DefaultValue(\"100\") @QueryParam(\"max_results\") final int maxResults,\n-                             @DefaultValue(\"0\") @QueryParam(\"offset\") final int offset) {\n+                             @DefaultValue(\"0\") @QueryParam(\"offset\") final int offset,\n+                             @DefaultValue(\"asc\") @QueryParam(\"order\") final String order,\n+                             @DefaultValue(\"fedora_id\") @QueryParam(\"order_by\") final String orderBy\n+    ) {", "originalCommit": "8c28f4154bdf5dbf6efa627cff09726ca766579e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d77ef584f0e357ef753ebdd90d78b39cce428c6d", "chunk": "diff --git a/fcrepo-http-api/src/main/java/org/fcrepo/http/api/FedoraSearch.java b/fcrepo-http-api/src/main/java/org/fcrepo/http/api/FedoraSearch.java\nindex de86bbc34e..e1a974ac8a 100644\n--- a/fcrepo-http-api/src/main/java/org/fcrepo/http/api/FedoraSearch.java\n+++ b/fcrepo-http-api/src/main/java/org/fcrepo/http/api/FedoraSearch.java\n\n@@ -84,8 +84,7 @@ public class FedoraSearch extends FedoraBaseResource {\n                              @DefaultValue(\"100\") @QueryParam(\"max_results\") final int maxResults,\n                              @DefaultValue(\"0\") @QueryParam(\"offset\") final int offset,\n                              @DefaultValue(\"asc\") @QueryParam(\"order\") final String order,\n-                             @DefaultValue(\"fedora_id\") @QueryParam(\"order_by\") final String orderBy\n-    ) {\n+                             @DefaultValue(\"fedora_id\") @QueryParam(\"order_by\") final String orderBy) {\n \n         try {\n             final var conditionList = new ArrayList<Condition>();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjI2NTU2MA==", "url": "https://github.com/fcrepo/fcrepo/pull/1717#discussion_r452265560", "bodyText": "There are two valid values for the order field: asc and desc.\nWhat is the purpose of listing all of the potential fields? ...likely should be removed.", "author": "awoods", "createdAt": "2020-07-09T14:36:41Z", "path": "fcrepo-http-api/src/main/java/org/fcrepo/http/api/FedoraSearch.java", "diffHunk": "@@ -105,7 +108,21 @@ public Response doSearch(@QueryParam(value = \"condition\") final List<String> con\n                 }\n             }\n \n-            final var params = new SearchParameters(parsedFields, conditionList, maxResults, offset);\n+            final Condition.Field orderByField;\n+            try {\n+                orderByField = Condition.Field.fromString(orderBy);\n+            } catch (final Exception e) {\n+                throw new InvalidQueryException(\"The order_by field must contain a valid value such as \" +\n+                        StringUtils.join(Condition.Field.values()));\n+            }\n+\n+            if (!(order.equalsIgnoreCase(\"asc\") || order.equalsIgnoreCase(\"desc\"))) {\n+                throw new InvalidQueryException(\"The order field is invalid:  valid values are \\\"asc\\\" and \\\"desc\\\"\" +\n+                        StringUtils.join(Condition.Field.values()));", "originalCommit": "8c28f4154bdf5dbf6efa627cff09726ca766579e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d77ef584f0e357ef753ebdd90d78b39cce428c6d", "chunk": "diff --git a/fcrepo-http-api/src/main/java/org/fcrepo/http/api/FedoraSearch.java b/fcrepo-http-api/src/main/java/org/fcrepo/http/api/FedoraSearch.java\nindex de86bbc34e..e1a974ac8a 100644\n--- a/fcrepo-http-api/src/main/java/org/fcrepo/http/api/FedoraSearch.java\n+++ b/fcrepo-http-api/src/main/java/org/fcrepo/http/api/FedoraSearch.java\n\n@@ -117,8 +116,7 @@ public class FedoraSearch extends FedoraBaseResource {\n             }\n \n             if (!(order.equalsIgnoreCase(\"asc\") || order.equalsIgnoreCase(\"desc\"))) {\n-                throw new InvalidQueryException(\"The order field is invalid:  valid values are \\\"asc\\\" and \\\"desc\\\"\" +\n-                        StringUtils.join(Condition.Field.values()));\n+                throw new InvalidQueryException(\"The order field is invalid:  valid values are \\\"asc\\\" and \\\"desc\\\"\");\n             }\n \n             final var params = new SearchParameters(parsedFields, conditionList, maxResults, offset, orderByField,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjI2NzAxMg==", "url": "https://github.com/fcrepo/fcrepo/pull/1717#discussion_r452267012", "bodyText": "Likely want to add a separator, such as:\nStringUtils.join(Condition.Field.values(), \", \"));", "author": "awoods", "createdAt": "2020-07-09T14:38:41Z", "path": "fcrepo-http-api/src/main/java/org/fcrepo/http/api/FedoraSearch.java", "diffHunk": "@@ -105,7 +108,21 @@ public Response doSearch(@QueryParam(value = \"condition\") final List<String> con\n                 }\n             }\n \n-            final var params = new SearchParameters(parsedFields, conditionList, maxResults, offset);\n+            final Condition.Field orderByField;\n+            try {\n+                orderByField = Condition.Field.fromString(orderBy);\n+            } catch (final Exception e) {\n+                throw new InvalidQueryException(\"The order_by field must contain a valid value such as \" +\n+                        StringUtils.join(Condition.Field.values()));", "originalCommit": "8c28f4154bdf5dbf6efa627cff09726ca766579e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d77ef584f0e357ef753ebdd90d78b39cce428c6d", "chunk": "diff --git a/fcrepo-http-api/src/main/java/org/fcrepo/http/api/FedoraSearch.java b/fcrepo-http-api/src/main/java/org/fcrepo/http/api/FedoraSearch.java\nindex de86bbc34e..e1a974ac8a 100644\n--- a/fcrepo-http-api/src/main/java/org/fcrepo/http/api/FedoraSearch.java\n+++ b/fcrepo-http-api/src/main/java/org/fcrepo/http/api/FedoraSearch.java\n\n@@ -117,8 +116,7 @@ public class FedoraSearch extends FedoraBaseResource {\n             }\n \n             if (!(order.equalsIgnoreCase(\"asc\") || order.equalsIgnoreCase(\"desc\"))) {\n-                throw new InvalidQueryException(\"The order field is invalid:  valid values are \\\"asc\\\" and \\\"desc\\\"\" +\n-                        StringUtils.join(Condition.Field.values()));\n+                throw new InvalidQueryException(\"The order field is invalid:  valid values are \\\"asc\\\" and \\\"desc\\\"\");\n             }\n \n             final var params = new SearchParameters(parsedFields, conditionList, maxResults, offset, orderByField,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjI3MDM0OA==", "url": "https://github.com/fcrepo/fcrepo/pull/1717#discussion_r452270348", "bodyText": "Since this test is named to be testing the \"default\" ordering, I would suggest removing the order_by and order query parameters... and rely on the defaults.\nA new, separate test could be useful to test desc order.", "author": "awoods", "createdAt": "2020-07-09T14:43:09Z", "path": "fcrepo-http-api/src/test/java/org/fcrepo/integration/http/api/FedoraSearchIT.java", "diffHunk": "@@ -435,6 +435,52 @@ public void testMalformedCondition() throws Exception {\n         }\n     }\n \n+    @Test\n+    public void testDefaultOrdering() throws Exception {\n+        final var prefix = getRandomUniqueId();\n+        final var resources = createResources(prefix, 3);\n+        final var condition = FEDORA_ID + \"=\" + prefix + \"*\";\n+        final String searchUrl = getSearchEndpoint() + \"condition=\" + encode(condition) +\n+                \"&order_by=fedora_id&order=asc\";", "originalCommit": "8c28f4154bdf5dbf6efa627cff09726ca766579e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d77ef584f0e357ef753ebdd90d78b39cce428c6d", "chunk": "diff --git a/fcrepo-http-api/src/test/java/org/fcrepo/integration/http/api/FedoraSearchIT.java b/fcrepo-http-api/src/test/java/org/fcrepo/integration/http/api/FedoraSearchIT.java\nindex 7d6b26d205..a2752e9689 100644\n--- a/fcrepo-http-api/src/test/java/org/fcrepo/integration/http/api/FedoraSearchIT.java\n+++ b/fcrepo-http-api/src/test/java/org/fcrepo/integration/http/api/FedoraSearchIT.java\n\n@@ -440,8 +441,23 @@ public class FedoraSearchIT extends AbstractResourceIT {\n         final var prefix = getRandomUniqueId();\n         final var resources = createResources(prefix, 3);\n         final var condition = FEDORA_ID + \"=\" + prefix + \"*\";\n-        final String searchUrl = getSearchEndpoint() + \"condition=\" + encode(condition) +\n-                \"&order_by=fedora_id&order=asc\";\n+        final String searchUrl = getSearchEndpoint() + \"condition=\" + encode(condition);\n+        try (final CloseableHttpResponse response = execute(new HttpGet(searchUrl))) {\n+            assertEquals(OK.getStatusCode(), getStatus(response));\n+            final ObjectMapper objectMapper = new ObjectMapper();\n+            final SearchResult result = objectMapper.readValue(response.getEntity().getContent(), SearchResult.class);\n+            assertEquals(resources, result.getItems().stream()\n+                    .map(x -> x.get(\"fedora_id\")).collect(Collectors.toList()));\n+        }\n+    }\n+\n+    @Test\n+    public void testDescOrdering() throws Exception {\n+        final var prefix = getRandomUniqueId();\n+        final var resources = createResources(prefix, 3);\n+        Collections.reverse(resources);\n+        final var condition = FEDORA_ID + \"=\" + prefix + \"*\";\n+        final String searchUrl = getSearchEndpoint() + \"condition=\" + encode(condition) + \"&order=desc\";\n         try (final CloseableHttpResponse response = execute(new HttpGet(searchUrl))) {\n             assertEquals(OK.getStatusCode(), getStatus(response));\n             final ObjectMapper objectMapper = new ObjectMapper();\n"}}, {"oid": "31fcbd3b5206c94cbdde29ecb839f0ace0cca760", "url": "https://github.com/fcrepo/fcrepo/commit/31fcbd3b5206c94cbdde29ecb839f0ace0cca760", "message": "Adds support for order_by and order search parameters.\nResolves: https://jira.lyrasis.org/browse/FCREPO-3343", "committedDate": "2020-07-12T05:49:01Z", "type": "commit"}, {"oid": "d77ef584f0e357ef753ebdd90d78b39cce428c6d", "url": "https://github.com/fcrepo/fcrepo/commit/d77ef584f0e357ef753ebdd90d78b39cce428c6d", "message": "Addresses PR feedback.", "committedDate": "2020-07-12T05:49:01Z", "type": "commit"}, {"oid": "d77ef584f0e357ef753ebdd90d78b39cce428c6d", "url": "https://github.com/fcrepo/fcrepo/commit/d77ef584f0e357ef753ebdd90d78b39cce428c6d", "message": "Addresses PR feedback.", "committedDate": "2020-07-12T05:49:01Z", "type": "forcePushed"}, {"oid": "9fb2b5f5a9765496a19792d960a61f31ff173894", "url": "https://github.com/fcrepo/fcrepo/commit/9fb2b5f5a9765496a19792d960a61f31ff173894", "message": "As delimiter to join statement.", "committedDate": "2020-07-13T18:08:48Z", "type": "commit"}]}