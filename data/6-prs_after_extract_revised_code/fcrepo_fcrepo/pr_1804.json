{"pr_number": 1804, "pr_title": "Stream containment and membership via paged DB queries", "pr_createdAt": "2020-11-16T23:33:49Z", "pr_url": "https://github.com/fcrepo/fcrepo/pull/1804", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTE3NTc3Mw==", "url": "https://github.com/fcrepo/fcrepo/pull/1804#discussion_r525175773", "bodyText": "I think you might want a ConcurrentLinkedQueue here instead: https://www.baeldung.com/java-queue-linkedblocking-concurrentlinked\nIncidentally, I think your original implementation of the parallelized reindex code would have worked if you'd backed the executor service with a LinkedBlockingQueue. I'm sorry I didn't think of it at the time. :(", "author": "pwinckles", "createdAt": "2020-11-17T14:00:27Z", "path": "fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/ContainmentIndexImpl.java", "diffHunk": "@@ -696,4 +712,38 @@ private Timestamp formatInstant(final Instant instant) {\n         timestamp.setNanos(0);\n         return timestamp;\n     }\n+\n+    /**\n+     * Private class to back a stream with a paged DB query.\n+     *\n+     * If this needs to be run in parallel we will have to override trySplit() and determine a good method to split on.\n+     */\n+    private class ContainmentIterator extends Spliterators.AbstractSpliterator<String> {\n+        final Queue<String> children = new LinkedBlockingQueue<>();", "originalCommit": "70d6044537f433e507ba524546a6a49596350e99", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6d32988f319cb28e9e15d631167aef50add48024", "chunk": "diff --git a/fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/ContainmentIndexImpl.java b/fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/ContainmentIndexImpl.java\nindex 30bf41bb4f..a4ac0c08a2 100644\n--- a/fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/ContainmentIndexImpl.java\n+++ b/fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/ContainmentIndexImpl.java\n\n@@ -719,8 +716,8 @@ public class ContainmentIndexImpl implements ContainmentIndex {\n      * If this needs to be run in parallel we will have to override trySplit() and determine a good method to split on.\n      */\n     private class ContainmentIterator extends Spliterators.AbstractSpliterator<String> {\n-        final Queue<String> children = new LinkedBlockingQueue<>();\n-        final AtomicInteger numOffsets = new AtomicInteger(0);\n+        final Queue<String> children = new ConcurrentLinkedQueue<>();\n+        int numOffsets = 0;\n         final String queryToUse;\n         final MapSqlParameterSource parameterSource;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTE3Njk1OQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1804#discussion_r525176959", "bodyText": "Is there a reason to not set the containsLimit parameter here too?\nI see, because there's no reason to set it every time. Perhaps set it in the constructor then?", "author": "pwinckles", "createdAt": "2020-11-17T14:02:06Z", "path": "fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/ContainmentIndexImpl.java", "diffHunk": "@@ -696,4 +712,38 @@ private Timestamp formatInstant(final Instant instant) {\n         timestamp.setNanos(0);\n         return timestamp;\n     }\n+\n+    /**\n+     * Private class to back a stream with a paged DB query.\n+     *\n+     * If this needs to be run in parallel we will have to override trySplit() and determine a good method to split on.\n+     */\n+    private class ContainmentIterator extends Spliterators.AbstractSpliterator<String> {\n+        final Queue<String> children = new LinkedBlockingQueue<>();\n+        final AtomicInteger numOffsets = new AtomicInteger(0);\n+        final String queryToUse;\n+        final MapSqlParameterSource parameterSource;\n+\n+        public ContainmentIterator(final String query, final MapSqlParameterSource parameters) {\n+            super(Long.MAX_VALUE, Spliterator.ORDERED);\n+            queryToUse = query;\n+            parameterSource = parameters;\n+        }\n+\n+        @Override\n+        public boolean tryAdvance(final Consumer<? super String> action) {\n+            try {\n+                action.accept(children.remove());\n+            } catch (final NoSuchElementException e) {\n+                parameterSource.addValue(\"offSet\", numOffsets.getAndIncrement() * containsLimit);", "originalCommit": "70d6044537f433e507ba524546a6a49596350e99", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTIxNTg0NQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1804#discussion_r525215845", "bodyText": "I was setting it in the calling method where I set all of the other parameters (ie. parent, startTime, child). I can move it into this method if that makes it clearer. But yes, LIMIT is a constant and we just advance the OFFSET parameter.", "author": "whikloj", "createdAt": "2020-11-17T14:53:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTE3Njk1OQ=="}], "type": "inlineReview", "revised_code": {"commit": "6d32988f319cb28e9e15d631167aef50add48024", "chunk": "diff --git a/fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/ContainmentIndexImpl.java b/fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/ContainmentIndexImpl.java\nindex 30bf41bb4f..a4ac0c08a2 100644\n--- a/fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/ContainmentIndexImpl.java\n+++ b/fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/ContainmentIndexImpl.java\n\n@@ -719,8 +716,8 @@ public class ContainmentIndexImpl implements ContainmentIndex {\n      * If this needs to be run in parallel we will have to override trySplit() and determine a good method to split on.\n      */\n     private class ContainmentIterator extends Spliterators.AbstractSpliterator<String> {\n-        final Queue<String> children = new LinkedBlockingQueue<>();\n-        final AtomicInteger numOffsets = new AtomicInteger(0);\n+        final Queue<String> children = new ConcurrentLinkedQueue<>();\n+        int numOffsets = 0;\n         final String queryToUse;\n         final MapSqlParameterSource parameterSource;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTE4Mzk5NQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1804#discussion_r525183995", "bodyText": "Out of curiosity, does the ordering ever matter? I ask because this implementation is trying to be thread-safe, but I'm not sure if it is entirely. Is it possible that tryAdvance could be called concurrently? If so, then this code will have a race to load the next page. Assuming there are sufficient items remaining, the competing threads will correctly load different pages, but the order they are added to the queue will be non-deterministic.\nAll that to say, I'm not sure if this implementation needs to be thread-safe. I do not believe that we have any code that uses parallel streaming features.", "author": "pwinckles", "createdAt": "2020-11-17T14:11:51Z", "path": "fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/ContainmentIndexImpl.java", "diffHunk": "@@ -696,4 +712,38 @@ private Timestamp formatInstant(final Instant instant) {\n         timestamp.setNanos(0);\n         return timestamp;\n     }\n+\n+    /**\n+     * Private class to back a stream with a paged DB query.\n+     *\n+     * If this needs to be run in parallel we will have to override trySplit() and determine a good method to split on.\n+     */\n+    private class ContainmentIterator extends Spliterators.AbstractSpliterator<String> {\n+        final Queue<String> children = new LinkedBlockingQueue<>();\n+        final AtomicInteger numOffsets = new AtomicInteger(0);\n+        final String queryToUse;\n+        final MapSqlParameterSource parameterSource;\n+\n+        public ContainmentIterator(final String query, final MapSqlParameterSource parameters) {\n+            super(Long.MAX_VALUE, Spliterator.ORDERED);\n+            queryToUse = query;\n+            parameterSource = parameters;\n+        }\n+\n+        @Override\n+        public boolean tryAdvance(final Consumer<? super String> action) {\n+            try {\n+                action.accept(children.remove());\n+            } catch (final NoSuchElementException e) {\n+                parameterSource.addValue(\"offSet\", numOffsets.getAndIncrement() * containsLimit);\n+                children.addAll(jdbcTemplate.queryForList(queryToUse, parameterSource, String.class));", "originalCommit": "70d6044537f433e507ba524546a6a49596350e99", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTIxNDg0NQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1804#discussion_r525214845", "bodyText": "My understanding, which is new, is that to allow your stream to be operated on in parallel you override the trySplit method which handles splitting the stream up into chunks for individual threads.\nIn this case, no we don't operate on it in parallel ever. At least not right now so order is not really important except in that we need the query to generate the same order so our OFFSET and LIMIT work properly.", "author": "whikloj", "createdAt": "2020-11-17T14:51:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTE4Mzk5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTIyODg1Ng==", "url": "https://github.com/fcrepo/fcrepo/pull/1804#discussion_r525228856", "bodyText": "In that case, do we need to use AtomicInteger?", "author": "pwinckles", "createdAt": "2020-11-17T15:08:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTE4Mzk5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI1ODA2Nw==", "url": "https://github.com/fcrepo/fcrepo/pull/1804#discussion_r525258067", "bodyText": "Ohhhhhhhhhh. No, I needed that when I had this class just embedded in the StreamSupport.generate. I can change that to an int", "author": "whikloj", "createdAt": "2020-11-17T15:35:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTE4Mzk5NQ=="}], "type": "inlineReview", "revised_code": {"commit": "6d32988f319cb28e9e15d631167aef50add48024", "chunk": "diff --git a/fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/ContainmentIndexImpl.java b/fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/ContainmentIndexImpl.java\nindex 30bf41bb4f..a4ac0c08a2 100644\n--- a/fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/ContainmentIndexImpl.java\n+++ b/fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/ContainmentIndexImpl.java\n\n@@ -719,8 +716,8 @@ public class ContainmentIndexImpl implements ContainmentIndex {\n      * If this needs to be run in parallel we will have to override trySplit() and determine a good method to split on.\n      */\n     private class ContainmentIterator extends Spliterators.AbstractSpliterator<String> {\n-        final Queue<String> children = new LinkedBlockingQueue<>();\n-        final AtomicInteger numOffsets = new AtomicInteger(0);\n+        final Queue<String> children = new ConcurrentLinkedQueue<>();\n+        int numOffsets = 0;\n         final String queryToUse;\n         final MapSqlParameterSource parameterSource;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTE4NDk1OQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1804#discussion_r525184959", "bodyText": "Is this just for testing purposes? If so, it could probably be package-private and optionally annotated with @VisibleForTesting", "author": "pwinckles", "createdAt": "2020-11-17T14:13:13Z", "path": "fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/ContainmentIndexImpl.java", "diffHunk": "@@ -393,50 +406,56 @@ private NamedParameterJdbcTemplate getNamedParameterJdbcTemplate() {\n         return new NamedParameterJdbcTemplate(getDataSource());\n     }\n \n+    public void setContainsLimit(final int limit) {", "originalCommit": "70d6044537f433e507ba524546a6a49596350e99", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6d32988f319cb28e9e15d631167aef50add48024", "chunk": "diff --git a/fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/ContainmentIndexImpl.java b/fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/ContainmentIndexImpl.java\nindex 30bf41bb4f..a4ac0c08a2 100644\n--- a/fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/ContainmentIndexImpl.java\n+++ b/fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/ContainmentIndexImpl.java\n\n@@ -406,7 +405,7 @@ public class ContainmentIndexImpl implements ContainmentIndex {\n         return new NamedParameterJdbcTemplate(getDataSource());\n     }\n \n-    public void setContainsLimit(final int limit) {\n+    void setContainsLimit(final int limit) {\n         containsLimit = limit;\n     }\n \n"}}, {"oid": "6d32988f319cb28e9e15d631167aef50add48024", "url": "https://github.com/fcrepo/fcrepo/commit/6d32988f319cb28e9e15d631167aef50add48024", "message": "Update membershipmanager", "committedDate": "2020-11-19T15:12:34Z", "type": "forcePushed"}, {"oid": "284a992e79af1436e5fb4ee9cde653d94eac43d3", "url": "https://github.com/fcrepo/fcrepo/commit/284a992e79af1436e5fb4ee9cde653d94eac43d3", "message": "Implement splititerator backed by paged query.", "committedDate": "2020-11-19T18:46:30Z", "type": "commit"}, {"oid": "3ddf6a58c2b96ef942499235652dc88f471d938d", "url": "https://github.com/fcrepo/fcrepo/commit/3ddf6a58c2b96ef942499235652dc88f471d938d", "message": "Page membership results", "committedDate": "2020-11-19T18:46:30Z", "type": "commit"}, {"oid": "4277bf3901208c02dc6c4c467b396c80c9b25723", "url": "https://github.com/fcrepo/fcrepo/commit/4277bf3901208c02dc6c4c467b396c80c9b25723", "message": "Code review", "committedDate": "2020-11-19T18:46:30Z", "type": "commit"}, {"oid": "374c302ea8500594fbe382ff6899d9fd4c2dca41", "url": "https://github.com/fcrepo/fcrepo/commit/374c302ea8500594fbe382ff6899d9fd4c2dca41", "message": "Update membershipmanager", "committedDate": "2020-11-19T18:46:30Z", "type": "commit"}, {"oid": "374c302ea8500594fbe382ff6899d9fd4c2dca41", "url": "https://github.com/fcrepo/fcrepo/commit/374c302ea8500594fbe382ff6899d9fd4c2dca41", "message": "Update membershipmanager", "committedDate": "2020-11-19T18:46:30Z", "type": "forcePushed"}]}