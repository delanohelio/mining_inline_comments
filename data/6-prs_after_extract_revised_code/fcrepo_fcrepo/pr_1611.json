{"pr_number": 1611, "pr_title": "Ensures that POSTs without explicit Content-Type headers use turtle b\u2026", "pr_createdAt": "2020-01-27T19:48:11Z", "pr_url": "https://github.com/fcrepo/fcrepo/pull/1611", "timeline": [{"oid": "7701db8c259ddce467325b6c5b87856e57b84daf", "url": "https://github.com/fcrepo/fcrepo/commit/7701db8c259ddce467325b6c5b87856e57b84daf", "message": "Ensures that POSTs without explicit Content-Type headers use turtle by default.\nResolves:  https://jira.lyrasis.org/browse/FCREPO-3188", "committedDate": "2020-01-27T19:33:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQ1NDczOA==", "url": "https://github.com/fcrepo/fcrepo/pull/1611#discussion_r371454738", "bodyText": "Should probably have this on two lines rather than going to three, or one line per parameter.", "author": "bbpennel", "createdAt": "2020-01-27T20:04:36Z", "path": "fcrepo-http-api/src/main/java/org/fcrepo/http/api/FedoraLdp.java", "diffHunk": "@@ -436,15 +441,17 @@ public Response createOrReplaceObjectRdf(\n                         .toString(),\n                     model);\n             } else {\n-                createResourceService.perform(transaction.getId(), getUserPrincipal(), fedoraId, null, false, links,\n+                fedoraId = createResourceService.perform(transaction.getId(), getUserPrincipal(), fedoraId, null,", "originalCommit": "7701db8c259ddce467325b6c5b87856e57b84daf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQ2NTM4MA==", "url": "https://github.com/fcrepo/fcrepo/pull/1611#discussion_r371465380", "bodyText": "will fix", "author": "dbernstein", "createdAt": "2020-01-27T20:28:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQ1NDczOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQ5MzI1Mw==", "url": "https://github.com/fcrepo/fcrepo/pull/1611#discussion_r371493253", "bodyText": "This is fixed.", "author": "dbernstein", "createdAt": "2020-01-27T21:30:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQ1NDczOA=="}], "type": "inlineReview", "revised_code": {"commit": "8704f56a036d507df91b1762afd7ab00d7a90d19", "chunk": "diff --git a/fcrepo-http-api/src/main/java/org/fcrepo/http/api/FedoraLdp.java b/fcrepo-http-api/src/main/java/org/fcrepo/http/api/FedoraLdp.java\nindex deb85731f5..ea92b34c23 100644\n--- a/fcrepo-http-api/src/main/java/org/fcrepo/http/api/FedoraLdp.java\n+++ b/fcrepo-http-api/src/main/java/org/fcrepo/http/api/FedoraLdp.java\n\n@@ -451,7 +451,7 @@ public class FedoraLdp extends ContentExposingResource {\n         // TODO: How to generate a response.\n         LOGGER.debug(\"Finished creating resource with path: {}\", externalPath());\n         transaction.commit();\n-        return createUpdateResponse(getResourceHead(fedoraId), created);\n+        return createUpdateResponse(getFedoraResource(fedoraId), created);\n \n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQ1NTYyNA==", "url": "https://github.com/fcrepo/fcrepo/pull/1611#discussion_r371455624", "bodyText": "While this is important, I think this is only the default content type for rdf sources. For non-rdf sources it should be application/octet-stream I would think?", "author": "bbpennel", "createdAt": "2020-01-27T20:06:35Z", "path": "fcrepo-http-api/src/main/java/org/fcrepo/http/api/FedoraLdp.java", "diffHunk": "@@ -135,6 +136,7 @@\n     private static final String WANT_DIGEST = \"Want-Digest\";\n \n     private static final String DIGEST = \"Digest\";\n+    public static final MediaType DEFAULT_CONTENT_TYPE = RDFMediaType.TURTLE_TYPE;", "originalCommit": "7701db8c259ddce467325b6c5b87856e57b84daf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQ2NTQ2NQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1611#discussion_r371465465", "bodyText": "will fix.", "author": "dbernstein", "createdAt": "2020-01-27T20:28:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQ1NTYyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQ5MzMyOQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1611#discussion_r371493329", "bodyText": "done", "author": "dbernstein", "createdAt": "2020-01-27T21:31:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQ1NTYyNA=="}], "type": "inlineReview", "revised_code": {"commit": "dd53fb1f3dd7baf85b8cd7f7c0bb066c64725f5e", "chunk": "diff --git a/fcrepo-http-api/src/main/java/org/fcrepo/http/api/FedoraLdp.java b/fcrepo-http-api/src/main/java/org/fcrepo/http/api/FedoraLdp.java\nindex deb85731f5..7af1698494 100644\n--- a/fcrepo-http-api/src/main/java/org/fcrepo/http/api/FedoraLdp.java\n+++ b/fcrepo-http-api/src/main/java/org/fcrepo/http/api/FedoraLdp.java\n\n@@ -136,7 +138,9 @@ public class FedoraLdp extends ContentExposingResource {\n     private static final String WANT_DIGEST = \"Want-Digest\";\n \n     private static final String DIGEST = \"Digest\";\n-    public static final MediaType DEFAULT_CONTENT_TYPE = RDFMediaType.TURTLE_TYPE;\n+\n+    private static final MediaType DEFAULT_RDF_CONTENT_TYPE = TURTLE_TYPE;\n+    private static final MediaType DEFAULT_NON_RDF_CONTENT_TYPE = APPLICATION_OCTET_STREAM_TYPE;\n \n     @PathParam(\"path\") protected String externalPath;\n \n"}}, {"oid": "1b5dadeb50c6dd337c7310e4d248565e45102523", "url": "https://github.com/fcrepo/fcrepo/commit/1b5dadeb50c6dd337c7310e4d248565e45102523", "message": "Uses getResourceHead() instead of resourceFactory.", "committedDate": "2020-01-27T20:10:17Z", "type": "commit"}, {"oid": "8704f56a036d507df91b1762afd7ab00d7a90d19", "url": "https://github.com/fcrepo/fcrepo/commit/8704f56a036d507df91b1762afd7ab00d7a90d19", "message": "Rename  FedoraBaseResource.getResourceHead() to FedoraBaseResource.getFedoraResource()", "committedDate": "2020-01-27T20:19:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQ2MjcwMA==", "url": "https://github.com/fcrepo/fcrepo/pull/1611#discussion_r371462700", "bodyText": "I see you ran into this commit order issue too. I'll just add that it should be commitIfShortLived so that it won't end a multi-transaction commit prematurely. That holds true for all the commit in this class actually.", "author": "bbpennel", "createdAt": "2020-01-27T20:22:26Z", "path": "fcrepo-http-api/src/main/java/org/fcrepo/http/api/FedoraLdp.java", "diffHunk": "@@ -548,41 +555,39 @@ public Response createObject(@HeaderParam(CONTENT_DISPOSITION) final ContentDisp\n             return status(METHOD_NOT_ALLOWED).build();\n         }\n \n+        final var contentType = requestContentType != null ? requestContentType : DEFAULT_CONTENT_TYPE;\n         // If request is an external binary, verify link header before proceeding\n         final ExternalContent extContent = extContentHandlerFactory.createFromLinks(links);\n-\n-        final String contentType = extContent == null ? requestContentType.toString() : extContent.getContentType();\n+        final String contentTypeStr = extContent == null ? contentType.toString() : extContent.getContentType();\n \n         final String interactionModel = checkInteractionModel(links);\n \n         final String fedoraId = identifierConverter().toInternalId(identifierConverter().toDomain(externalPath()));\n-\n         final String newFedoraId;\n-        if (isBinary(interactionModel, requestContentType.toString(), requestContentType != null,\n+\n+        if (isBinary(interactionModel, contentType.toString(), requestContentType != null,\n                 extContent != null)) {\n             final Collection<String> checksums = parseDigestHeader(digest);\n             final String originalFileName = contentDisposition != null ? contentDisposition.getFileName() : \"\";\n-            newFedoraId = createResourceService.perform(transaction.getId(), getUserPrincipal(), fedoraId, slug, true,\n-                    contentType, originalFileName, contentDisposition.getSize(), links, checksums, requestBodyStream,\n-                    extContent);\n+            newFedoraId = createResourceService.perform(transaction.getId(), getUserPrincipal(), fedoraId, slug,\n+                    true, contentTypeStr,\n+                    originalFileName, contentDisposition.getSize(), links, checksums, requestBodyStream, extContent);\n         } else {\n             final Model model = httpRdfService.bodyToInternalModel(externalPath(), requestBodyStream,\n-                    requestContentType, identifierConverter());\n-            newFedoraId = createResourceService.perform(transaction.getId(), getUserPrincipal(), fedoraId, slug, true,\n-                    links, model);\n+                    contentType, identifierConverter());\n+            newFedoraId = createResourceService.perform(transaction.getId(), getUserPrincipal(), fedoraId, slug,\n+                    true, links,\n+                    model);\n         }\n-        // TODO: How to generate a response.\n-        LOGGER.debug(\"Finished creating resource with path: {}\", externalPath());\n \n-        final FedoraResource resource;\n+        LOGGER.debug(\"Finished creating resource: {}\", newFedoraId);\n+        transaction.commit();", "originalCommit": "8704f56a036d507df91b1762afd7ab00d7a90d19", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQ2NTMzOA==", "url": "https://github.com/fcrepo/fcrepo/pull/1611#discussion_r371465338", "bodyText": "will fix.", "author": "dbernstein", "createdAt": "2020-01-27T20:28:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQ2MjcwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQ5MzM3OA==", "url": "https://github.com/fcrepo/fcrepo/pull/1611#discussion_r371493378", "bodyText": "done.", "author": "dbernstein", "createdAt": "2020-01-27T21:31:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQ2MjcwMA=="}], "type": "inlineReview", "revised_code": {"commit": "dd53fb1f3dd7baf85b8cd7f7c0bb066c64725f5e", "chunk": "diff --git a/fcrepo-http-api/src/main/java/org/fcrepo/http/api/FedoraLdp.java b/fcrepo-http-api/src/main/java/org/fcrepo/http/api/FedoraLdp.java\nindex ea92b34c23..7af1698494 100644\n--- a/fcrepo-http-api/src/main/java/org/fcrepo/http/api/FedoraLdp.java\n+++ b/fcrepo-http-api/src/main/java/org/fcrepo/http/api/FedoraLdp.java\n\n@@ -555,33 +569,49 @@ public class FedoraLdp extends ContentExposingResource {\n             return status(METHOD_NOT_ALLOWED).build();\n         }\n \n-        final var contentType = requestContentType != null ? requestContentType : DEFAULT_CONTENT_TYPE;\n         // If request is an external binary, verify link header before proceeding\n         final ExternalContent extContent = extContentHandlerFactory.createFromLinks(links);\n-        final String contentTypeStr = extContent == null ? contentType.toString() : extContent.getContentType();\n \n         final String interactionModel = checkInteractionModel(links);\n \n         final String fedoraId = identifierConverter().toInternalId(identifierConverter().toDomain(externalPath()));\n         final String newFedoraId;\n-\n-        if (isBinary(interactionModel, contentType.toString(), requestContentType != null,\n-                extContent != null)) {\n+        final var defaultContentType = requestContentType != null ?\n+                                            requestContentType : DEFAULT_RDF_CONTENT_TYPE;\n+        if (isBinary(interactionModel,\n+                     defaultContentType.toString(),\n+                     requestBodyStream != null,\n+                     extContent != null)) {\n             final Collection<String> checksums = parseDigestHeader(digest);\n             final String originalFileName = contentDisposition != null ? contentDisposition.getFileName() : \"\";\n-            newFedoraId = createResourceService.perform(transaction.getId(), getUserPrincipal(), fedoraId, slug,\n-                    true, contentTypeStr,\n-                    originalFileName, contentDisposition.getSize(), links, checksums, requestBodyStream, extContent);\n+            final var binaryType = requestContentType != null ? requestContentType : DEFAULT_NON_RDF_CONTENT_TYPE;\n+            final var contentType = extContent == null ? binaryType.toString() : extContent.getContentType();\n+\n+            newFedoraId = createResourceService.perform(transaction.getId(),\n+                                                        getUserPrincipal(),\n+                                                        fedoraId,\n+                                                        slug,\n+                                                        true,\n+                                                        contentType,\n+                                                        originalFileName,\n+                                                        contentDisposition.getSize(),\n+                                                        links,\n+                                                        checksums,\n+                                                        requestBodyStream,\n+                                                        extContent);\n         } else {\n             final Model model = httpRdfService.bodyToInternalModel(externalPath(), requestBodyStream,\n-                    contentType, identifierConverter());\n-            newFedoraId = createResourceService.perform(transaction.getId(), getUserPrincipal(), fedoraId, slug,\n-                    true, links,\n-                    model);\n+                    defaultContentType, identifierConverter());\n+            newFedoraId = createResourceService.perform(transaction.getId(),\n+                                                        getUserPrincipal(),\n+                                                        fedoraId, slug,\n+                                                        true,\n+                                                        links,\n+                                                        model);\n         }\n \n         LOGGER.debug(\"Finished creating resource: {}\", newFedoraId);\n-        transaction.commit();\n+        transaction.commitIfShortLived();\n         try {\n             return createUpdateResponse(getFedoraResource(newFedoraId), true);\n         } catch (PathNotFoundException e) {\n"}}, {"oid": "dd53fb1f3dd7baf85b8cd7f7c0bb066c64725f5e", "url": "https://github.com/fcrepo/fcrepo/commit/dd53fb1f3dd7baf85b8cd7f7c0bb066c64725f5e", "message": "Addresses PR feedback.", "committedDate": "2020-01-27T21:27:42Z", "type": "commit"}, {"oid": "dd53fb1f3dd7baf85b8cd7f7c0bb066c64725f5e", "url": "https://github.com/fcrepo/fcrepo/commit/dd53fb1f3dd7baf85b8cd7f7c0bb066c64725f5e", "message": "Addresses PR feedback.", "committedDate": "2020-01-27T21:27:42Z", "type": "forcePushed"}]}