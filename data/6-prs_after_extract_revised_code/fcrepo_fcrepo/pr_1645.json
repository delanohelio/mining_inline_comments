{"pr_number": 1645, "pr_title": "First pass at containment index", "pr_createdAt": "2020-03-11T16:03:34Z", "pr_url": "https://github.com/fcrepo/fcrepo/pull/1645", "timeline": [{"oid": "2af40f54c185e13c23e4b27f909e7fba4056a362", "url": "https://github.com/fcrepo/fcrepo/commit/2af40f54c185e13c23e4b27f909e7fba4056a362", "message": "First pass at containment index", "committedDate": "2020-03-11T15:59:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTA5MzUyNg==", "url": "https://github.com/fcrepo/fcrepo/pull/1645#discussion_r391093526", "bodyText": "These updates should probably be made within a transaction.", "author": "pwinckles", "createdAt": "2020-03-11T16:18:29Z", "path": "fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/ContainmentIndexImpl.java", "diffHunk": "@@ -239,6 +274,30 @@ public void removeContainedBy(final Transaction tx, final FedoraResource parent,\n         }\n     }\n \n+    @Override\n+    public void commitTransaction(final Transaction tx) {\n+        if (tx != null) {\n+            final String txId = tx.getId();\n+            final NamedParameterJdbcTemplate jdbcTemplate = getNamedParameterJdbcTemplate();\n+            final MapSqlParameterSource parameterSource = new MapSqlParameterSource();\n+            parameterSource.addValue(\"transactionId\", txId);\n+            jdbcTemplate.update(COMMIT_ADD_RECORDS, parameterSource);\n+            jdbcTemplate.update(COMMIT_DELETE_RECORDS, parameterSource);\n+            jdbcTemplate.update(COMMIT_CLEANUP, parameterSource);", "originalCommit": "2af40f54c185e13c23e4b27f909e7fba4056a362", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8644a84b48fa4c5b3e75c484f651c36f0da2e3ea", "chunk": "diff --git a/fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/ContainmentIndexImpl.java b/fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/ContainmentIndexImpl.java\nindex 6bb7f3d1ee..646f927d6d 100644\n--- a/fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/ContainmentIndexImpl.java\n+++ b/fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/ContainmentIndexImpl.java\n\n@@ -275,12 +288,13 @@ public class ContainmentIndexImpl implements ContainmentIndex {\n     }\n \n     @Override\n+    @Transactional\n     public void commitTransaction(final Transaction tx) {\n         if (tx != null) {\n             final String txId = tx.getId();\n-            final NamedParameterJdbcTemplate jdbcTemplate = getNamedParameterJdbcTemplate();\n             final MapSqlParameterSource parameterSource = new MapSqlParameterSource();\n             parameterSource.addValue(\"transactionId\", txId);\n+\n             jdbcTemplate.update(COMMIT_ADD_RECORDS, parameterSource);\n             jdbcTemplate.update(COMMIT_DELETE_RECORDS, parameterSource);\n             jdbcTemplate.update(COMMIT_CLEANUP, parameterSource);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTA5Nzg4Nw==", "url": "https://github.com/fcrepo/fcrepo/pull/1645#discussion_r391097887", "bodyText": "JdbcTemplates are thread safe. This class really should only ever have a single instance: https://docs.spring.io/spring/docs/current/spring-framework-reference/data-access.html#jdbc-JdbcTemplate-idioms", "author": "pwinckles", "createdAt": "2020-03-11T16:24:45Z", "path": "fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/ContainmentIndexImpl.java", "diffHunk": "@@ -87,48 +118,80 @@\n     private static final String DELETE_CHILD = \"DELETE FROM \" + RESOURCES_TABLE +\n             \" WHERE \" + FEDORA_ID_COLUMN + \" = :child AND \" + PARENT_COLUMN + \" = :parent\";\n \n-    private static final String INSERT_CHILD_IN_TRANSACTION = \"INSERT INTO \" +\n-            TRANSACTION_OPERATIONS_TABLE +\n-            \" (parent, fedoraId, transactionId, operation) VALUES (:parent, :child, :transactionId, 'add')\";\n+    private static final String INSERT_CHILD_IN_TRANSACTION = \"INSERT INTO \" + TRANSACTION_OPERATIONS_TABLE +\n+            \" ( \" + PARENT_COLUMN + \", \" + FEDORA_ID_COLUMN + \", \" + TRANSACTION_ID_COLUMN + \", \" + OPERATION_COLUMN +\n+            \" ) VALUES (:parent, :child, :transactionId, 'add')\";\n+\n+    private static final String UNDO_INSERT_CHILD_IN_TRANSACTION = \"DELETE FROM \" + TRANSACTION_OPERATIONS_TABLE +\n+            \" WHERE \" + PARENT_COLUMN + \" = :parent AND \" + FEDORA_ID_COLUMN + \" = :child AND \" + TRANSACTION_ID_COLUMN\n+            + \" = :transactionId AND \" + OPERATION_COLUMN + \" = 'add'\";\n \n-    private static final String UNDO_INSERT_CHILD_IN_TRANSACTION = \"DELETE FROM \" +\n-            TRANSACTION_OPERATIONS_TABLE +\n-            \" WHERE parent = :parent AND fedoraId = :child AND transactionId = :transactionId AND operation = 'add'\";\n+    private static final String DELETE_CHILD_IN_TRANSACTION = \"INSERT INTO \" + TRANSACTION_OPERATIONS_TABLE +\n+            \" ( \" + PARENT_COLUMN + \", \" + FEDORA_ID_COLUMN + \", \" + TRANSACTION_ID_COLUMN + \", \" + OPERATION_COLUMN +\n+            \" ) VALUES (:parent, :child, :transactionId, 'delete')\";\n \n-    private static final String DELETE_CHILD_IN_TRANSACTION = \"INSERT INTO \" +\n-            TRANSACTION_OPERATIONS_TABLE +\n-            \" (parent, fedoraId, transactionId, operation) VALUES (:parent, :child, :transactionId, 'delete')\";\n+    private static final String UNDO_DELETE_CHILD_IN_TRANSACTION = \"DELETE FROM \" + TRANSACTION_OPERATIONS_TABLE +\n+            \" WHERE \" + PARENT_COLUMN + \" = :parent AND \" + FEDORA_ID_COLUMN + \" = :child AND \" + TRANSACTION_ID_COLUMN\n+            + \" = :transactionId AND \" + OPERATION_COLUMN + \" = 'delete'\";\n \n-    private final String IS_CHILD_IN_TRANSACTION = \"SELECT TRUE FROM \" + TRANSACTION_OPERATIONS_TABLE +\n+    private static final String IS_CHILD_ADDED_IN_TRANSACTION = \"SELECT TRUE FROM \" + TRANSACTION_OPERATIONS_TABLE +\n             \" WHERE \" + FEDORA_ID_COLUMN + \" = :child AND \" + PARENT_COLUMN + \" = :parent\" +\n             \" AND \" + TRANSACTION_ID_COLUMN + \" = :transactionId AND \" + OPERATION_COLUMN + \" = 'add'\";\n \n-    /**\n-     * check if a table with the given name exists\n-     */\n-    private boolean tableIsMissing(final String tableName) throws SQLException {\n-        final DatabaseMetaData dbMeta = conn.getMetaData();\n-        final ResultSet tables = dbMeta.getTables(null, null, tableName, new String[]{\"TABLE\"});\n-        while (tables.next()) {\n-            if (tables.getString(\"TABLE_NAME\").equals(tableName)) {\n-                return false;\n-            }\n-        }\n-        return true;\n-    }\n+    private static final String IS_CHILD_DELETED_IN_TRANSACTION = \"SELECT TRUE FROM \" + TRANSACTION_OPERATIONS_TABLE +\n+            \" WHERE \" + FEDORA_ID_COLUMN + \" = :child AND \" + PARENT_COLUMN + \" = :parent\" +\n+            \" AND \" + TRANSACTION_ID_COLUMN + \" = :transactionId AND \" + OPERATION_COLUMN + \" = 'delete'\";\n+\n+    private static final String ROLLBACK_TRANSACTION = \"DELETE FROM \" + TRANSACTION_OPERATIONS_TABLE + \" WHERE \" +\n+            \" transactionId = :transactionId\";\n+\n+    private static final String COMMIT_ADD_RECORDS = \"INSERT INTO \" + RESOURCES_TABLE + \" ( \" + FEDORA_ID_COLUMN + \", \"\n+            + PARENT_COLUMN + \" ) SELECT \" + FEDORA_ID_COLUMN + \", \" + PARENT_COLUMN + \" FROM \" +\n+            TRANSACTION_OPERATIONS_TABLE + \" WHERE \" + TRANSACTION_ID_COLUMN + \" = :transactionId AND \" +\n+            OPERATION_COLUMN + \" = 'add'\";\n+\n+    private static final String COMMIT_DELETE_RECORDS = \"DELETE FROM \" + RESOURCES_TABLE + \" WHERE EXISTS(\" +\n+            \" SELECT 1 FROM \" + TRANSACTION_OPERATIONS_TABLE + \" WHERE \" + RESOURCES_TABLE + \".\" + FEDORA_ID_COLUMN +\n+            \" = \" + TRANSACTION_OPERATIONS_TABLE + \".\" + FEDORA_ID_COLUMN + \" AND \" + RESOURCES_TABLE + \".\" +\n+            PARENT_COLUMN + \" = \" + TRANSACTION_OPERATIONS_TABLE + \".\" + PARENT_COLUMN + \" AND \" +\n+            TRANSACTION_OPERATIONS_TABLE + \".\" + TRANSACTION_ID_COLUMN + \" = :transactionId AND \" +\n+            TRANSACTION_OPERATIONS_TABLE + \".\" + OPERATION_COLUMN + \" = 'delete')\";\n+\n+    private static final String COMMIT_CLEANUP = \"DELETE FROM \" + TRANSACTION_OPERATIONS_TABLE + \" WHERE \" +\n+            TRANSACTION_ID_COLUMN + \" = :transactionId\";\n \n     /**\n      * Connect to the database\n      */\n     @PostConstruct\n-    private void setup() throws SQLException {\n-        conn = dataSource.getConnection();\n+    private void setup() {\n+        final NamedParameterJdbcTemplate jdbcTemplate = getNamedParameterJdbcTemplate();", "originalCommit": "2af40f54c185e13c23e4b27f909e7fba4056a362", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8644a84b48fa4c5b3e75c484f651c36f0da2e3ea", "chunk": "diff --git a/fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/ContainmentIndexImpl.java b/fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/ContainmentIndexImpl.java\nindex 6bb7f3d1ee..646f927d6d 100644\n--- a/fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/ContainmentIndexImpl.java\n+++ b/fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/ContainmentIndexImpl.java\n\n@@ -160,12 +160,23 @@ public class ContainmentIndexImpl implements ContainmentIndex {\n     private static final String COMMIT_CLEANUP = \"DELETE FROM \" + TRANSACTION_OPERATIONS_TABLE + \" WHERE \" +\n             TRANSACTION_ID_COLUMN + \" = :transactionId\";\n \n+    private static final String RESOURCE_EXISTS = \"SELECT \" + FEDORA_ID_COLUMN + \" FROM \" + RESOURCES_TABLE +\n+            \" WHERE \" + FEDORA_ID_COLUMN + \" = :child\";\n+\n+    private static final String RESOURCE_EXISTS_ADDITIONS = \"SELECT \" + FEDORA_ID_COLUMN + \" FROM \"\n+            + TRANSACTION_OPERATIONS_TABLE + \" WHERE \" + FEDORA_ID_COLUMN + \" = :child AND \" + TRANSACTION_ID_COLUMN\n+            + \" = :transactionId AND \" + OPERATION_COLUMN + \" = 'add'\";\n+\n+    private static final String RESOURCE_EXISTS_DELETIONS = \"SELECT \" + FEDORA_ID_COLUMN + \" FROM \"\n+            + TRANSACTION_OPERATIONS_TABLE + \" WHERE \" + FEDORA_ID_COLUMN + \" = :child AND \" + TRANSACTION_ID_COLUMN\n+            + \" = :transactionId AND \" + OPERATION_COLUMN + \" = 'delete'\";\n+\n     /**\n      * Connect to the database\n      */\n     @PostConstruct\n     private void setup() {\n-        final NamedParameterJdbcTemplate jdbcTemplate = getNamedParameterJdbcTemplate();\n+        jdbcTemplate = getNamedParameterJdbcTemplate();\n         final MapSqlParameterSource parameterSource = new MapSqlParameterSource();\n         // create the tables that don't already exist\n         try {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTA5OTI0MA==", "url": "https://github.com/fcrepo/fcrepo/pull/1645#discussion_r391099240", "bodyText": "Couldn't there be other reasons a BadSqlGrammerException is thrown that don't indicate the table already exists? Does the table already exists exception have an error code? This may also vary between db implementations. Can you use a CREATE ... IF NOT EXISTS construct?", "author": "pwinckles", "createdAt": "2020-03-11T16:26:42Z", "path": "fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/ContainmentIndexImpl.java", "diffHunk": "@@ -87,48 +118,80 @@\n     private static final String DELETE_CHILD = \"DELETE FROM \" + RESOURCES_TABLE +\n             \" WHERE \" + FEDORA_ID_COLUMN + \" = :child AND \" + PARENT_COLUMN + \" = :parent\";\n \n-    private static final String INSERT_CHILD_IN_TRANSACTION = \"INSERT INTO \" +\n-            TRANSACTION_OPERATIONS_TABLE +\n-            \" (parent, fedoraId, transactionId, operation) VALUES (:parent, :child, :transactionId, 'add')\";\n+    private static final String INSERT_CHILD_IN_TRANSACTION = \"INSERT INTO \" + TRANSACTION_OPERATIONS_TABLE +\n+            \" ( \" + PARENT_COLUMN + \", \" + FEDORA_ID_COLUMN + \", \" + TRANSACTION_ID_COLUMN + \", \" + OPERATION_COLUMN +\n+            \" ) VALUES (:parent, :child, :transactionId, 'add')\";\n+\n+    private static final String UNDO_INSERT_CHILD_IN_TRANSACTION = \"DELETE FROM \" + TRANSACTION_OPERATIONS_TABLE +\n+            \" WHERE \" + PARENT_COLUMN + \" = :parent AND \" + FEDORA_ID_COLUMN + \" = :child AND \" + TRANSACTION_ID_COLUMN\n+            + \" = :transactionId AND \" + OPERATION_COLUMN + \" = 'add'\";\n \n-    private static final String UNDO_INSERT_CHILD_IN_TRANSACTION = \"DELETE FROM \" +\n-            TRANSACTION_OPERATIONS_TABLE +\n-            \" WHERE parent = :parent AND fedoraId = :child AND transactionId = :transactionId AND operation = 'add'\";\n+    private static final String DELETE_CHILD_IN_TRANSACTION = \"INSERT INTO \" + TRANSACTION_OPERATIONS_TABLE +\n+            \" ( \" + PARENT_COLUMN + \", \" + FEDORA_ID_COLUMN + \", \" + TRANSACTION_ID_COLUMN + \", \" + OPERATION_COLUMN +\n+            \" ) VALUES (:parent, :child, :transactionId, 'delete')\";\n \n-    private static final String DELETE_CHILD_IN_TRANSACTION = \"INSERT INTO \" +\n-            TRANSACTION_OPERATIONS_TABLE +\n-            \" (parent, fedoraId, transactionId, operation) VALUES (:parent, :child, :transactionId, 'delete')\";\n+    private static final String UNDO_DELETE_CHILD_IN_TRANSACTION = \"DELETE FROM \" + TRANSACTION_OPERATIONS_TABLE +\n+            \" WHERE \" + PARENT_COLUMN + \" = :parent AND \" + FEDORA_ID_COLUMN + \" = :child AND \" + TRANSACTION_ID_COLUMN\n+            + \" = :transactionId AND \" + OPERATION_COLUMN + \" = 'delete'\";\n \n-    private final String IS_CHILD_IN_TRANSACTION = \"SELECT TRUE FROM \" + TRANSACTION_OPERATIONS_TABLE +\n+    private static final String IS_CHILD_ADDED_IN_TRANSACTION = \"SELECT TRUE FROM \" + TRANSACTION_OPERATIONS_TABLE +\n             \" WHERE \" + FEDORA_ID_COLUMN + \" = :child AND \" + PARENT_COLUMN + \" = :parent\" +\n             \" AND \" + TRANSACTION_ID_COLUMN + \" = :transactionId AND \" + OPERATION_COLUMN + \" = 'add'\";\n \n-    /**\n-     * check if a table with the given name exists\n-     */\n-    private boolean tableIsMissing(final String tableName) throws SQLException {\n-        final DatabaseMetaData dbMeta = conn.getMetaData();\n-        final ResultSet tables = dbMeta.getTables(null, null, tableName, new String[]{\"TABLE\"});\n-        while (tables.next()) {\n-            if (tables.getString(\"TABLE_NAME\").equals(tableName)) {\n-                return false;\n-            }\n-        }\n-        return true;\n-    }\n+    private static final String IS_CHILD_DELETED_IN_TRANSACTION = \"SELECT TRUE FROM \" + TRANSACTION_OPERATIONS_TABLE +\n+            \" WHERE \" + FEDORA_ID_COLUMN + \" = :child AND \" + PARENT_COLUMN + \" = :parent\" +\n+            \" AND \" + TRANSACTION_ID_COLUMN + \" = :transactionId AND \" + OPERATION_COLUMN + \" = 'delete'\";\n+\n+    private static final String ROLLBACK_TRANSACTION = \"DELETE FROM \" + TRANSACTION_OPERATIONS_TABLE + \" WHERE \" +\n+            \" transactionId = :transactionId\";\n+\n+    private static final String COMMIT_ADD_RECORDS = \"INSERT INTO \" + RESOURCES_TABLE + \" ( \" + FEDORA_ID_COLUMN + \", \"\n+            + PARENT_COLUMN + \" ) SELECT \" + FEDORA_ID_COLUMN + \", \" + PARENT_COLUMN + \" FROM \" +\n+            TRANSACTION_OPERATIONS_TABLE + \" WHERE \" + TRANSACTION_ID_COLUMN + \" = :transactionId AND \" +\n+            OPERATION_COLUMN + \" = 'add'\";\n+\n+    private static final String COMMIT_DELETE_RECORDS = \"DELETE FROM \" + RESOURCES_TABLE + \" WHERE EXISTS(\" +\n+            \" SELECT 1 FROM \" + TRANSACTION_OPERATIONS_TABLE + \" WHERE \" + RESOURCES_TABLE + \".\" + FEDORA_ID_COLUMN +\n+            \" = \" + TRANSACTION_OPERATIONS_TABLE + \".\" + FEDORA_ID_COLUMN + \" AND \" + RESOURCES_TABLE + \".\" +\n+            PARENT_COLUMN + \" = \" + TRANSACTION_OPERATIONS_TABLE + \".\" + PARENT_COLUMN + \" AND \" +\n+            TRANSACTION_OPERATIONS_TABLE + \".\" + TRANSACTION_ID_COLUMN + \" = :transactionId AND \" +\n+            TRANSACTION_OPERATIONS_TABLE + \".\" + OPERATION_COLUMN + \" = 'delete')\";\n+\n+    private static final String COMMIT_CLEANUP = \"DELETE FROM \" + TRANSACTION_OPERATIONS_TABLE + \" WHERE \" +\n+            TRANSACTION_ID_COLUMN + \" = :transactionId\";\n \n     /**\n      * Connect to the database\n      */\n     @PostConstruct\n-    private void setup() throws SQLException {\n-        conn = dataSource.getConnection();\n+    private void setup() {\n+        final NamedParameterJdbcTemplate jdbcTemplate = getNamedParameterJdbcTemplate();\n+        final MapSqlParameterSource parameterSource = new MapSqlParameterSource();\n         // create the tables that don't already exist\n-        if (tableIsMissing(RESOURCES_TABLE)) {\n-            conn.createStatement().execute(RESOURCES_TABLE_DDL);\n+        try {\n+            jdbcTemplate.update(RESOURCES_TABLE_DDL, parameterSource);\n+        } catch (BadSqlGrammarException e) {", "originalCommit": "2af40f54c185e13c23e4b27f909e7fba4056a362", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTY3OTkwMQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1645#discussion_r391679901", "bodyText": "So there is a wrapped exception, but it is from the database layer which in the test case is h2. If you wire a postgresql or mysql I imagine it will be different.\nI can certainly add the h2 exceptions here and once we start wiring in more robust database engines we can extend the catch?", "author": "whikloj", "createdAt": "2020-03-12T14:57:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTA5OTI0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTY4NzY3Nw==", "url": "https://github.com/fcrepo/fcrepo/pull/1645#discussion_r391687677", "bodyText": "Alternatively I can re-add the isTableMissing function?", "author": "whikloj", "createdAt": "2020-03-12T15:08:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTA5OTI0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTczODc2Mg==", "url": "https://github.com/fcrepo/fcrepo/pull/1645#discussion_r391738762", "bodyText": "CREATE TABLE IF NOT EXISTS seems most straightforward from my perspective.  Then there won't be any \"happy\" exceptions to explicitly ignore.", "author": "birkland", "createdAt": "2020-03-12T16:25:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTA5OTI0MA=="}], "type": "inlineReview", "revised_code": {"commit": "8644a84b48fa4c5b3e75c484f651c36f0da2e3ea", "chunk": "diff --git a/fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/ContainmentIndexImpl.java b/fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/ContainmentIndexImpl.java\nindex 6bb7f3d1ee..646f927d6d 100644\n--- a/fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/ContainmentIndexImpl.java\n+++ b/fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/ContainmentIndexImpl.java\n\n@@ -160,12 +160,23 @@ public class ContainmentIndexImpl implements ContainmentIndex {\n     private static final String COMMIT_CLEANUP = \"DELETE FROM \" + TRANSACTION_OPERATIONS_TABLE + \" WHERE \" +\n             TRANSACTION_ID_COLUMN + \" = :transactionId\";\n \n+    private static final String RESOURCE_EXISTS = \"SELECT \" + FEDORA_ID_COLUMN + \" FROM \" + RESOURCES_TABLE +\n+            \" WHERE \" + FEDORA_ID_COLUMN + \" = :child\";\n+\n+    private static final String RESOURCE_EXISTS_ADDITIONS = \"SELECT \" + FEDORA_ID_COLUMN + \" FROM \"\n+            + TRANSACTION_OPERATIONS_TABLE + \" WHERE \" + FEDORA_ID_COLUMN + \" = :child AND \" + TRANSACTION_ID_COLUMN\n+            + \" = :transactionId AND \" + OPERATION_COLUMN + \" = 'add'\";\n+\n+    private static final String RESOURCE_EXISTS_DELETIONS = \"SELECT \" + FEDORA_ID_COLUMN + \" FROM \"\n+            + TRANSACTION_OPERATIONS_TABLE + \" WHERE \" + FEDORA_ID_COLUMN + \" = :child AND \" + TRANSACTION_ID_COLUMN\n+            + \" = :transactionId AND \" + OPERATION_COLUMN + \" = 'delete'\";\n+\n     /**\n      * Connect to the database\n      */\n     @PostConstruct\n     private void setup() {\n-        final NamedParameterJdbcTemplate jdbcTemplate = getNamedParameterJdbcTemplate();\n+        jdbcTemplate = getNamedParameterJdbcTemplate();\n         final MapSqlParameterSource parameterSource = new MapSqlParameterSource();\n         // create the tables that don't already exist\n         try {\n"}}, {"oid": "8644a84b48fa4c5b3e75c484f651c36f0da2e3ea", "url": "https://github.com/fcrepo/fcrepo/commit/8644a84b48fa4c5b3e75c484f651c36f0da2e3ea", "message": "More changes and some code review", "committedDate": "2020-03-12T15:49:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTczOTA5NA==", "url": "https://github.com/fcrepo/fcrepo/pull/1645#discussion_r391739094", "bodyText": "Is Spring's TransactionManager already enabled?\nhttps://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/transaction/annotation/EnableTransactionManagement.html", "author": "pwinckles", "createdAt": "2020-03-12T16:25:37Z", "path": "fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/ContainmentIndexImpl.java", "diffHunk": "@@ -275,12 +288,13 @@ public void removeContainedBy(final Transaction tx, final FedoraResource parent,\n     }\n \n     @Override\n+    @Transactional", "originalCommit": "8644a84b48fa4c5b3e75c484f651c36f0da2e3ea", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3bea5d24cabb148e963e3d29f0084735a78fb5d9", "chunk": "diff --git a/fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/ContainmentIndexImpl.java b/fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/ContainmentIndexImpl.java\nindex 646f927d6d..967a7fea16 100644\n--- a/fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/ContainmentIndexImpl.java\n+++ b/fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/ContainmentIndexImpl.java\n\n@@ -288,16 +279,23 @@ public class ContainmentIndexImpl implements ContainmentIndex {\n     }\n \n     @Override\n-    @Transactional\n     public void commitTransaction(final Transaction tx) {\n         if (tx != null) {\n             final String txId = tx.getId();\n             final MapSqlParameterSource parameterSource = new MapSqlParameterSource();\n             parameterSource.addValue(\"transactionId\", txId);\n-\n-            jdbcTemplate.update(COMMIT_ADD_RECORDS, parameterSource);\n-            jdbcTemplate.update(COMMIT_DELETE_RECORDS, parameterSource);\n-            jdbcTemplate.update(COMMIT_CLEANUP, parameterSource);\n+            final DefaultTransactionDefinition paramTransactionDefinition = new DefaultTransactionDefinition();\n+            final TransactionStatus status = platformTransactionManager.getTransaction(paramTransactionDefinition);\n+            try {\n+                jdbcTemplate.update(COMMIT_ADD_RECORDS, parameterSource);\n+                jdbcTemplate.update(COMMIT_DELETE_RECORDS, parameterSource);\n+                jdbcTemplate.update(COMMIT_CLEANUP, parameterSource);\n+                platformTransactionManager.commit(status);\n+            } catch (Exception e) {\n+                platformTransactionManager.rollback(status);\n+                LOGGER.warn(\"Unable to commit containment index transaction: {}\", e.getMessage());\n+                throw new RepositoryRuntimeException(\"Unable to commit containment index transaction\", e);\n+            }\n         }\n     }\n \n"}}, {"oid": "3bea5d24cabb148e963e3d29f0084735a78fb5d9", "url": "https://github.com/fcrepo/fcrepo/commit/3bea5d24cabb148e963e3d29f0084735a78fb5d9", "message": "Use transactionManager and adjust tests", "committedDate": "2020-03-12T19:28:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTk3NDYwMA==", "url": "https://github.com/fcrepo/fcrepo/pull/1645#discussion_r391974600", "bodyText": "There are multiple places throughout this class where literals are used (\"child\", \"parent\", transactionId). Should probably use the static constants defined at the top of the class.", "author": "awoods", "createdAt": "2020-03-13T00:39:31Z", "path": "fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/ContainmentIndexImpl.java", "diffHunk": "@@ -144,91 +209,65 @@ private NamedParameterJdbcTemplate getNamedParameterJdbcTemplate() {\n      * @return A stream of contained identifiers\n      */\n     private Stream<String> getChildren(final String fedoraId, final String transactionId) {\n-        final NamedParameterJdbcTemplate jdbcTemplate = getNamedParameterJdbcTemplate();\n         final MapSqlParameterSource parameterSource = new MapSqlParameterSource();\n         parameterSource.addValue(\"parent\", fedoraId);\n \n-        final Stream.Builder<String> children = Stream.builder();\n+        final List<String> children;\n         if (transactionId != null) {\n             // we are in a transaction\n             parameterSource.addValue(\"transactionId\", transactionId);\n             final String currentChildrenQuery = SELECT_CHILDREN +\n                     \" UNION \" + SELECT_ADDED_CHILDREN +\n                     \" EXCEPT \" + SELECT_DELETED_CHILDREN;\n-            for (final String child : jdbcTemplate.queryForList(currentChildrenQuery, parameterSource, String.class)) {\n-                children.add(child);\n-            }\n+            children = jdbcTemplate.queryForList(currentChildrenQuery, parameterSource, String.class);\n         } else {\n             // not in a transaction\n-            for (final String child : jdbcTemplate.queryForList(SELECT_CHILDREN, parameterSource, String.class)) {\n-                children.add(child);\n-            }\n+            children = jdbcTemplate.queryForList(SELECT_CHILDREN, parameterSource, String.class);\n         }\n-        return children.build();\n+        return children.stream();\n     }\n \n-    /**\n-     * Close the database connection\n-     */\n-    @PreDestroy\n-    private void cleanup() {\n-        try {\n-            conn.close();\n-        } catch (SQLException e) {\n-            e.printStackTrace();\n-        }\n-    }\n-\n-    /**\n-     * Return a stream of fedora identifiers contained by the specified fedora resource.\n-     *\n-     * @param tx The transaction.  If no transaction, null is okay.\n-     * @param fedoraResource The containing fedora resource\n-     * @return A stream of contained identifiers\n-     */\n     @Override\n     public Stream<String> getContainedBy(final Transaction tx, final FedoraResource fedoraResource) {\n         final String txId = (tx != null) ? tx.getId() : null;\n         return getChildren(fedoraResource.getId(), txId);\n     }\n \n-    /**\n-     * Add a contained by relation between the child resource and its parent.\n-     *\n-     * @param tx The transaction.  If no transaction, null is okay.\n-     * @param parent The containing fedora resource\n-     * @param child The contained fedora resource\n-     */\n+    @Override\n     public void addContainedBy(final Transaction tx, final FedoraResource parent, final FedoraResource child) {\n-        final String txId = (tx != null) ? tx.getId() : null;\n-        final NamedParameterJdbcTemplate jdbcTemplate = getNamedParameterJdbcTemplate();\n+        final String txID = tx != null ? tx.getId() : null;\n+        addContainedBy(txID, parent.getId(), child.getId());\n+    }\n+\n+    @Override\n+    public void addContainedBy(final String txID, final String parentID, final String childID) {\n         final MapSqlParameterSource parameterSource = new MapSqlParameterSource();\n-        parameterSource.addValue(\"parent\", parent.getId());\n-        parameterSource.addValue(\"child\", child.getId());\n-        if (txId != null) {\n-            parameterSource.addValue(\"transactionId\", txId);\n-            jdbcTemplate.update(INSERT_CHILD_IN_TRANSACTION, parameterSource);\n+        parameterSource.addValue(\"parent\", parentID);", "originalCommit": "3bea5d24cabb148e963e3d29f0084735a78fb5d9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjIyNjEwNA==", "url": "https://github.com/fcrepo/fcrepo/pull/1645#discussion_r392226104", "bodyText": "So technically the child here matches to the :child part of the SQL statement in.\n\"SELECT * FROM \" + RESOURCES_TABLE + \" WHERE \" + FEDORA_ID_COLUMN + \" = :child\"\n\nSo we don't want to use the constants, but perhaps using a more descriptive name to differentiate between columns and arguments?", "author": "whikloj", "createdAt": "2020-03-13T13:27:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTk3NDYwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA3NDgwNg==", "url": "https://github.com/fcrepo/fcrepo/pull/1645#discussion_r393074806", "bodyText": "To clarify, the above was a question. I'm not going to mess around with all the various SQL statements unless its required.", "author": "whikloj", "createdAt": "2020-03-16T14:39:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTk3NDYwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzI5MDIwNg==", "url": "https://github.com/fcrepo/fcrepo/pull/1645#discussion_r393290206", "bodyText": "I was not thinking of the SQL statements, but rather the String literals used in calls to parameterSource.addValue(). It seems more maintainable if \"parent\", \"child\" and \"transactionId\" were replaced by constants.\nSearching for \"parameterSource.addValue(\" shows 12 instances.", "author": "awoods", "createdAt": "2020-03-16T20:25:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTk3NDYwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk3NTA0NA==", "url": "https://github.com/fcrepo/fcrepo/pull/1645#discussion_r393975044", "bodyText": "To recap the Slack discussion, the replacing of literals with constants would work for the literals parent and transactionId due to them (fortuitously) being the same as the constants, however child would have to remain as a literal or be modified or have a new constant defined.\nI'm not against this work, but I also don't see it as valuable and would prefer to push it off for now.", "author": "whikloj", "createdAt": "2020-03-17T21:15:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTk3NDYwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAzMzgyOQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1645#discussion_r394033829", "bodyText": "Punting here is fine.", "author": "awoods", "createdAt": "2020-03-17T23:46:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTk3NDYwMA=="}], "type": "inlineReview", "revised_code": null}]}