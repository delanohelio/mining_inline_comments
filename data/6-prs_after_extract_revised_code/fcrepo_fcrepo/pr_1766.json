{"pr_number": 1766, "pr_title": "add more metrics", "pr_createdAt": "2020-10-06T18:30:11Z", "pr_url": "https://github.com/fcrepo/fcrepo/pull/1766", "timeline": [{"oid": "8e76801f05dc4cdd2854b6933b3d065a192f2399", "url": "https://github.com/fcrepo/fcrepo/commit/8e76801f05dc4cdd2854b6933b3d065a192f2399", "message": "add more metrics", "committedDate": "2020-10-06T18:27:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDUyNDgwNQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1766#discussion_r500524805", "bodyText": "Why did this (and other examples) need to change from @Inject to @Autowired?", "author": "awoods", "createdAt": "2020-10-06T18:53:22Z", "path": "fcrepo-auth-webac/src/main/java/org/fcrepo/auth/webac/WebACAuthorizingRealm.java", "diffHunk": "@@ -87,7 +89,8 @@\n     @Inject\n     private ResourceFactory resourceFactory;\n \n-    @Inject\n+    @Autowired", "originalCommit": "8e76801f05dc4cdd2854b6933b3d065a192f2399", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDUyNTc1NQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1766#discussion_r500525755", "bodyText": "It seems like Spring does not like resolving the @Qualifier for @Inject, at least in some circumstances.", "author": "pwinckles", "createdAt": "2020-10-06T18:55:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDUyNDgwNQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDUyODExNQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1766#discussion_r500528115", "bodyText": "typo: This timer should likely be: getContainerIdByPathTimer", "author": "awoods", "createdAt": "2020-10-06T18:58:58Z", "path": "fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/ContainmentIndexMetrics.java", "diffHunk": "@@ -0,0 +1,157 @@\n+/*\n+ * Licensed to DuraSpace under one or more contributor license agreements.\n+ * See the NOTICE file distributed with this work for additional information\n+ * regarding copyright ownership.\n+ *\n+ * DuraSpace licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except in\n+ * compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.fcrepo.kernel.impl;\n+\n+import io.micrometer.core.instrument.Metrics;\n+import io.micrometer.core.instrument.Timer;\n+import org.fcrepo.common.metrics.MetricsHelper;\n+import org.fcrepo.kernel.api.ContainmentIndex;\n+import org.fcrepo.kernel.api.identifiers.FedoraId;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.stereotype.Component;\n+\n+import java.util.stream.Stream;\n+\n+/**\n+ * ContainmentIndex wrapper for adding metrics\n+ *\n+ * @author pwinckles\n+ */\n+@Component(\"containmentIndex\")\n+public class ContainmentIndexMetrics implements ContainmentIndex {\n+\n+    private static final String METRIC_NAME = \"fcrepo.db\";\n+    private static final String DB = \"db\";\n+    private static final String CONTAINMENT = \"containment\";\n+    private static final String OPERATION = \"operation\";\n+\n+    private static final Timer getContainsTimer = Metrics.timer(METRIC_NAME,\n+            DB, CONTAINMENT, OPERATION, \"getContains\");\n+    private static final Timer getContainsDeletedTimer = Metrics.timer(METRIC_NAME,\n+            DB, CONTAINMENT, OPERATION, \"getContainsDeleted\");\n+    private static final Timer getContainsByTimer = Metrics.timer(METRIC_NAME,\n+            DB, CONTAINMENT, OPERATION, \"getContainsBy\");\n+    private static final Timer removeContainedByTimer = Metrics.timer(METRIC_NAME,\n+            DB, CONTAINMENT, OPERATION, \"removeContainedBy\");\n+    private static final Timer removeResourceTimer = Metrics.timer(METRIC_NAME,\n+            DB, CONTAINMENT, OPERATION, \"removeResource\");\n+    private static final Timer purgeResourceTimer = Metrics.timer(METRIC_NAME,\n+            DB, CONTAINMENT, OPERATION, \"purgeResource\");\n+    private static final Timer addContainedByTimer = Metrics.timer(METRIC_NAME,\n+            DB, CONTAINMENT, OPERATION, \"addContainedBy\");\n+    private static final Timer commitTransactionTimer = Metrics.timer(METRIC_NAME,\n+            DB, CONTAINMENT, OPERATION, \"commitTransaction\");\n+    private static final Timer rollbackTransactionTimer = Metrics.timer(METRIC_NAME,\n+            DB, CONTAINMENT, OPERATION, \"rollbackTransaction\");\n+    private static final Timer resourceExistsTimer = Metrics.timer(METRIC_NAME,\n+            DB, CONTAINMENT, OPERATION, \"resourceExists\");\n+    private static final Timer getContainerIdByPathTimer = Metrics.timer(METRIC_NAME,\n+            DB, CONTAINMENT, OPERATION, \"getContainerIdByPath\");\n+    private static final Timer resetTimer = Metrics.timer(METRIC_NAME,\n+            DB, CONTAINMENT, OPERATION, \"reset\");\n+\n+    @Autowired\n+    @Qualifier(\"containmentIndexImpl\")\n+    private ContainmentIndex containmentIndexImpl;\n+\n+    @Override\n+    public Stream<String> getContains(final String txId, final FedoraId fedoraId) {\n+        return MetricsHelper.time(getContainsTimer, () -> {\n+            return containmentIndexImpl.getContains(txId, fedoraId);\n+        });\n+    }\n+\n+    @Override\n+    public Stream<String> getContainsDeleted(final String txId, final FedoraId fedoraId) {\n+        return MetricsHelper.time(getContainsDeletedTimer, () -> {\n+            return containmentIndexImpl.getContainsDeleted(txId, fedoraId);\n+        });\n+    }\n+\n+    @Override\n+    public String getContainedBy(final String txID, final FedoraId resource) {\n+        return MetricsHelper.time(getContainsByTimer, () -> {\n+            return containmentIndexImpl.getContainedBy(txID, resource);\n+        });\n+    }\n+\n+    @Override\n+    public void removeContainedBy(final String txID, final FedoraId parent, final FedoraId child) {\n+        removeContainedByTimer.record(() -> {\n+            containmentIndexImpl.removeContainedBy(txID, parent, child);\n+        });\n+    }\n+\n+    @Override\n+    public void removeResource(final String txID, final FedoraId resource) {\n+        removeResourceTimer.record(() -> {\n+            containmentIndexImpl.removeResource(txID, resource);\n+        });\n+    }\n+\n+    @Override\n+    public void purgeResource(final String txID, final FedoraId resource) {\n+        purgeResourceTimer.record(() -> {\n+            containmentIndexImpl.purgeResource(txID, resource);\n+        });\n+    }\n+\n+    @Override\n+    public void addContainedBy(final String txID, final FedoraId parent, final FedoraId child) {\n+        addContainedByTimer.record(() -> {\n+            containmentIndexImpl.addContainedBy(txID, parent, child);\n+        });\n+    }\n+\n+    @Override\n+    public void commitTransaction(final String txId) {\n+        commitTransactionTimer.record(() -> {\n+            containmentIndexImpl.commitTransaction(txId);\n+        });\n+    }\n+\n+    @Override\n+    public void rollbackTransaction(final String txId) {\n+        rollbackTransactionTimer.record(() -> {\n+            containmentIndexImpl.rollbackTransaction(txId);\n+        });\n+    }\n+\n+    @Override\n+    public boolean resourceExists(final String txID, final FedoraId fedoraID) {\n+        return MetricsHelper.time(resourceExistsTimer, () -> {\n+            return containmentIndexImpl.resourceExists(txID, fedoraID);\n+        });\n+    }\n+\n+    @Override\n+    public FedoraId getContainerIdByPath(final String txID, final FedoraId fedoraId) {\n+        return MetricsHelper.time(getContainsByTimer, () -> {", "originalCommit": "8e76801f05dc4cdd2854b6933b3d065a192f2399", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "64dbc164a1c812314edc005005c604ae50222a2f", "chunk": "diff --git a/fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/ContainmentIndexMetrics.java b/fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/ContainmentIndexMetrics.java\nindex 036fe90f74..84250cb70d 100644\n--- a/fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/ContainmentIndexMetrics.java\n+++ b/fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/ContainmentIndexMetrics.java\n\n@@ -143,7 +143,7 @@ public class ContainmentIndexMetrics implements ContainmentIndex {\n \n     @Override\n     public FedoraId getContainerIdByPath(final String txID, final FedoraId fedoraId) {\n-        return MetricsHelper.time(getContainsByTimer, () -> {\n+        return MetricsHelper.time(getContainerIdByPathTimer, () -> {\n             return containmentIndexImpl.getContainerIdByPath(txID, fedoraId);\n         });\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDUyOTczMQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1766#discussion_r500529731", "bodyText": "typo: \"oclf\"", "author": "awoods", "createdAt": "2020-10-06T19:01:48Z", "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/AbstractPersister.java", "diffHunk": "@@ -56,14 +56,14 @@\n      * to determine which operations the persister knows how to handle.\n      */\n     private final ResourceOperationType resourceOperationType;\n-    protected final FedoraToOcflObjectIndex index;\n+    protected final FedoraToOcflObjectIndex oclfIndex;", "originalCommit": "8e76801f05dc4cdd2854b6933b3d065a192f2399", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "64dbc164a1c812314edc005005c604ae50222a2f", "chunk": "diff --git a/fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/AbstractPersister.java b/fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/AbstractPersister.java\nindex 57a6278bef..7f2e0d0903 100644\n--- a/fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/AbstractPersister.java\n+++ b/fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/AbstractPersister.java\n\n@@ -56,14 +56,14 @@ abstract class AbstractPersister implements Persister {\n      * to determine which operations the persister knows how to handle.\n      */\n     private final ResourceOperationType resourceOperationType;\n-    protected final FedoraToOcflObjectIndex oclfIndex;\n+    protected final FedoraToOcflObjectIndex ocflIndex;\n \n     protected AbstractPersister(final Class<? extends ResourceOperation> resourceOperationClass,\n                       final ResourceOperationType resourceOperationType,\n-                      final FedoraToOcflObjectIndex oclfIndex) {\n+                      final FedoraToOcflObjectIndex ocflIndex) {\n         this.resourceOperationClass = resourceOperationClass;\n         this.resourceOperationType = resourceOperationType;\n-        this.oclfIndex = oclfIndex;\n+        this.ocflIndex = ocflIndex;\n     }\n \n     @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDUzMDE3Nw==", "url": "https://github.com/fcrepo/fcrepo/pull/1766#discussion_r500530177", "bodyText": "typo", "author": "awoods", "createdAt": "2020-10-06T19:02:42Z", "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/CreateNonRdfSourcePersister.java", "diffHunk": "@@ -53,6 +53,6 @@ public void persist(final OcflPersistentStorageSession session, final ResourceOp\n         final String ocflId = mapToOcflId(session.getId(), rootObjectId);\n         final OcflObjectSession ocflObjectSession = session.findOrCreateSession(ocflId);\n         persistNonRDFSource(operation, ocflObjectSession, rootObjectId.asBaseId());\n-        index.addMapping(session.getId(), resourceId.asResourceId(), rootObjectId.asBaseId(), ocflId);\n+        oclfIndex.addMapping(session.getId(), resourceId.asResourceId(), rootObjectId.asBaseId(), ocflId);", "originalCommit": "8e76801f05dc4cdd2854b6933b3d065a192f2399", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "64dbc164a1c812314edc005005c604ae50222a2f", "chunk": "diff --git a/fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/CreateNonRdfSourcePersister.java b/fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/CreateNonRdfSourcePersister.java\nindex 4cd59bbfaf..3304517c88 100644\n--- a/fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/CreateNonRdfSourcePersister.java\n+++ b/fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/CreateNonRdfSourcePersister.java\n\n@@ -53,6 +53,6 @@ class CreateNonRdfSourcePersister extends AbstractNonRdfSourcePersister {\n         final String ocflId = mapToOcflId(session.getId(), rootObjectId);\n         final OcflObjectSession ocflObjectSession = session.findOrCreateSession(ocflId);\n         persistNonRDFSource(operation, ocflObjectSession, rootObjectId.asBaseId());\n-        oclfIndex.addMapping(session.getId(), resourceId.asResourceId(), rootObjectId.asBaseId(), ocflId);\n+        ocflIndex.addMapping(session.getId(), resourceId.asResourceId(), rootObjectId.asBaseId(), ocflId);\n     }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDUzMDI3MQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1766#discussion_r500530271", "bodyText": "typo", "author": "awoods", "createdAt": "2020-10-06T19:02:53Z", "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/CreateRdfSourcePersister.java", "diffHunk": "@@ -73,6 +73,6 @@ public void persist(final OcflPersistentStorageSession session, final ResourceOp\n         final String ocflObjectId = mapToOcflId(session.getId(), rootObjectId);\n         final OcflObjectSession ocflObjectSession = session.findOrCreateSession(ocflObjectId);\n         persistRDF(ocflObjectSession, operation, rootObjectId.asBaseId());\n-        index.addMapping(session.getId(), resourceId.asResourceId(), rootObjectId.asBaseId(), ocflObjectId);\n+        oclfIndex.addMapping(session.getId(), resourceId.asResourceId(), rootObjectId.asBaseId(), ocflObjectId);", "originalCommit": "8e76801f05dc4cdd2854b6933b3d065a192f2399", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "64dbc164a1c812314edc005005c604ae50222a2f", "chunk": "diff --git a/fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/CreateRdfSourcePersister.java b/fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/CreateRdfSourcePersister.java\nindex e268b6be05..1c5d55f331 100644\n--- a/fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/CreateRdfSourcePersister.java\n+++ b/fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/CreateRdfSourcePersister.java\n\n@@ -73,6 +73,6 @@ class CreateRdfSourcePersister extends AbstractRdfSourcePersister {\n         final String ocflObjectId = mapToOcflId(session.getId(), rootObjectId);\n         final OcflObjectSession ocflObjectSession = session.findOrCreateSession(ocflObjectId);\n         persistRDF(ocflObjectSession, operation, rootObjectId.asBaseId());\n-        oclfIndex.addMapping(session.getId(), resourceId.asResourceId(), rootObjectId.asBaseId(), ocflObjectId);\n+        ocflIndex.addMapping(session.getId(), resourceId.asResourceId(), rootObjectId.asBaseId(), ocflObjectId);\n     }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDUzMDM3Mg==", "url": "https://github.com/fcrepo/fcrepo/pull/1766#discussion_r500530372", "bodyText": "typo", "author": "awoods", "createdAt": "2020-10-06T19:03:05Z", "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/DeleteResourcePersister.java", "diffHunk": "@@ -62,7 +62,7 @@ public void persist(final OcflPersistentStorageSession session, final ResourceOp\n         }\n \n         if (!objectSession.containsResource(resourceId.getResourceId())) {\n-            index.removeMapping(session.getId(), resourceId);\n+            oclfIndex.removeMapping(session.getId(), resourceId);", "originalCommit": "8e76801f05dc4cdd2854b6933b3d065a192f2399", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "64dbc164a1c812314edc005005c604ae50222a2f", "chunk": "diff --git a/fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/DeleteResourcePersister.java b/fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/DeleteResourcePersister.java\nindex 4b0856fc82..ea75a8106c 100644\n--- a/fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/DeleteResourcePersister.java\n+++ b/fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/DeleteResourcePersister.java\n\n@@ -62,7 +62,7 @@ class DeleteResourcePersister extends AbstractPersister {\n         }\n \n         if (!objectSession.containsResource(resourceId.getResourceId())) {\n-            oclfIndex.removeMapping(session.getId(), resourceId);\n+            ocflIndex.removeMapping(session.getId(), resourceId);\n         }\n     }\n \n"}}, {"oid": "64dbc164a1c812314edc005005c604ae50222a2f", "url": "https://github.com/fcrepo/fcrepo/commit/64dbc164a1c812314edc005005c604ae50222a2f", "message": "fixed typos", "committedDate": "2020-10-06T19:17:52Z", "type": "commit"}]}