{"pr_number": 1657, "pr_title": "fix concurrency bugs", "pr_createdAt": "2020-04-07T16:16:49Z", "pr_url": "https://github.com/fcrepo/fcrepo/pull/1657", "timeline": [{"oid": "009b45b14569f36fdab05c8cdc2f4b401fc8ada7", "url": "https://github.com/fcrepo/fcrepo/commit/009b45b14569f36fdab05c8cdc2f4b401fc8ada7", "message": "fix concurrency bugs", "committedDate": "2020-04-07T16:15:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA4OTk4MQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1657#discussion_r405089981", "bodyText": "Is this line needed as it is repeated inside the synchronized (this) { block? I feel like it was just an oversight?", "author": "whikloj", "createdAt": "2020-04-07T20:25:21Z", "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/OCFLPersistentSessionManager.java", "diffHunk": "@@ -61,23 +61,20 @@ public PersistentStorageSession getSession(final String sessionId) {\n             throw new IllegalArgumentException(\"session id must be non-null\");\n         }\n \n-        final PersistentStorageSession session = sessionMap.get(sessionId);\n-\n-        if (session != null) {\n-            return session;\n-        }\n-\n-        final PersistentStorageSession newSession = new OCFLPersistentStorageSession(sessionId,\n+        return sessionMap.computeIfAbsent(sessionId, key -> new OCFLPersistentStorageSession(\n+                key,\n                 fedoraOcflIndex,\n-                objectSessionFactory);\n-        sessionMap.put(sessionId, newSession);\n-        return newSession;\n+                objectSessionFactory));\n     }\n \n     @Override\n     public PersistentStorageSession getReadOnlySession() {\n         if (this.readOnlySession == null) {", "originalCommit": "009b45b14569f36fdab05c8cdc2f4b401fc8ada7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTQ3NTIzNw==", "url": "https://github.com/fcrepo/fcrepo/pull/1657#discussion_r405475237", "bodyText": "No synchronization is required.\nhttps://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/concurrent/ConcurrentHashMap.html#computeIfAbsent(K,java.util.function.Function)\n\nThe entire method invocation is performed atomically, so the function is applied at most once per key. Some attempted update operations on this map by other threads may be blocked while computation is in progress, so the computation should be short and simple, and must not attempt to update any other mappings of this map.", "author": "pwinckles", "createdAt": "2020-04-08T12:09:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA4OTk4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTQ3NzAzMw==", "url": "https://github.com/fcrepo/fcrepo/pull/1657#discussion_r405477033", "bodyText": "Whoops, I got confused about which line you were referring to and thought you meant L64.", "author": "pwinckles", "createdAt": "2020-04-08T12:13:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA4OTk4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTQ3ODQ0Nw==", "url": "https://github.com/fcrepo/fcrepo/pull/1657#discussion_r405478447", "bodyText": "Do you mean L72?\nIf so, then yes, both conditionals are needed. https://en.wikipedia.org/wiki/Double-checked_locking", "author": "pwinckles", "createdAt": "2020-04-08T12:15:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA4OTk4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTUyMDcwNA==", "url": "https://github.com/fcrepo/fcrepo/pull/1657#discussion_r405520704", "bodyText": "Ah okay, thanks for the explanation.", "author": "whikloj", "createdAt": "2020-04-08T13:23:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA4OTk4MQ=="}], "type": "inlineReview", "revised_code": {"commit": "2d98e4d6a6d7913333e3177632b764127f3b1969", "chunk": "diff --git a/fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/OCFLPersistentSessionManager.java b/fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/OCFLPersistentSessionManager.java\nindex 933bdb7cce..1bc1caaff6 100644\n--- a/fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/OCFLPersistentSessionManager.java\n+++ b/fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/OCFLPersistentSessionManager.java\n\n@@ -69,13 +69,18 @@ public class OCFLPersistentSessionManager implements PersistentStorageSessionMan\n \n     @Override\n     public PersistentStorageSession getReadOnlySession() {\n-        if (this.readOnlySession == null) {\n+        var localSession = this.readOnlySession;\n+\n+        if (localSession == null) {\n             synchronized (this) {\n-                if (this.readOnlySession == null) {\n+                localSession = this.readOnlySession;\n+                if (localSession == null) {\n                     this.readOnlySession = new OCFLPersistentStorageSession(fedoraOcflIndex, objectSessionFactory);\n+                    localSession = this.readOnlySession;\n                 }\n             }\n         }\n-        return this.readOnlySession;\n+\n+        return localSession;\n     }\n }\n"}}, {"oid": "2d98e4d6a6d7913333e3177632b764127f3b1969", "url": "https://github.com/fcrepo/fcrepo/commit/2d98e4d6a6d7913333e3177632b764127f3b1969", "message": "fixed double-checked locking for java", "committedDate": "2020-04-08T14:35:17Z", "type": "commit"}]}