{"pr_number": 1740, "pr_title": "Run ITests against all DBs", "pr_createdAt": "2020-08-10T15:21:00Z", "pr_url": "https://github.com/fcrepo/fcrepo/pull/1740", "timeline": [{"oid": "53281a27b91d096dbb0636b7a27b5d2b1dbe0550", "url": "https://github.com/fcrepo/fcrepo/commit/53281a27b91d096dbb0636b7a27b5d2b1dbe0550", "message": "Run ITests against all DBs", "committedDate": "2020-08-10T15:16:27Z", "type": "commit"}, {"oid": "5595c296cfea496e31642c9dfaef3661b45b00a1", "url": "https://github.com/fcrepo/fcrepo/commit/5595c296cfea496e31642c9dfaef3661b45b00a1", "message": "corrected property names", "committedDate": "2020-08-10T15:37:02Z", "type": "commit"}, {"oid": "2b0e88122a9ad9752448142d1e4ac904d45f5fa1", "url": "https://github.com/fcrepo/fcrepo/commit/2b0e88122a9ad9752448142d1e4ac904d45f5fa1", "message": "fixed property names again", "committedDate": "2020-08-10T15:46:40Z", "type": "commit"}, {"oid": "a1c17ad3d90f27a7c5a6643fe9ce975b7a2ce2c9", "url": "https://github.com/fcrepo/fcrepo/commit/a1c17ad3d90f27a7c5a6643fe9ce975b7a2ce2c9", "message": "bump postgres version", "committedDate": "2020-08-10T15:56:00Z", "type": "commit"}, {"oid": "18f52f8a1fd45199b979573df40e55eda68a01ac", "url": "https://github.com/fcrepo/fcrepo/commit/18f52f8a1fd45199b979573df40e55eda68a01ac", "message": "try postgres on xenial", "committedDate": "2020-08-10T16:03:48Z", "type": "commit"}, {"oid": "49e3fa9cdb92f8df0156ed2808407766843887a4", "url": "https://github.com/fcrepo/fcrepo/commit/49e3fa9cdb92f8df0156ed2808407766843887a4", "message": "yet another postgres attempt", "committedDate": "2020-08-10T16:18:35Z", "type": "commit"}, {"oid": "5a26457b369b82cddab80048e9b9f7bd7bd35b1b", "url": "https://github.com/fcrepo/fcrepo/commit/5a26457b369b82cddab80048e9b9f7bd7bd35b1b", "message": "yet another postgres attempt 2", "committedDate": "2020-08-10T19:21:00Z", "type": "commit"}, {"oid": "f928370bf8c7519f40f3dd9361fffd2cb3d72f0a", "url": "https://github.com/fcrepo/fcrepo/commit/f928370bf8c7519f40f3dd9361fffd2cb3d72f0a", "message": "yet another postgres attempt 3", "committedDate": "2020-08-10T19:27:15Z", "type": "commit"}, {"oid": "f01c9d0c8224c836c1f49795e206b1ce00eeb4c6", "url": "https://github.com/fcrepo/fcrepo/commit/f01c9d0c8224c836c1f49795e206b1ce00eeb4c6", "message": "travis cleanup", "committedDate": "2020-08-10T19:44:40Z", "type": "commit"}, {"oid": "e1e1231bb1ec0798fd0fd50ee2822d4289f10e77", "url": "https://github.com/fcrepo/fcrepo/commit/e1e1231bb1ec0798fd0fd50ee2822d4289f10e77", "message": "fix travis logic", "committedDate": "2020-08-10T19:50:51Z", "type": "commit"}, {"oid": "0ad698bfab4edcf9098283a6afd52f4a538e981e", "url": "https://github.com/fcrepo/fcrepo/commit/0ad698bfab4edcf9098283a6afd52f4a538e981e", "message": "attempt to fix some concurrency issues in itests", "committedDate": "2020-08-10T20:29:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODYyNjU5Ng==", "url": "https://github.com/fcrepo/fcrepo/pull/1740#discussion_r468626596", "bodyText": "If i'm understanding correctly, this change basically increases wiggle room allowed between the expected timestamp and the real timestamp up to the minutes range? Sort of wondering if it can tell apart the 4 mementos created in that test since they are separated by 1 second each, but it seems like that already would have been an issue since it seems like it was trimming off the seconds from the timestamp.\nI'm actually kind of surprised this test is passing since the logs for it are cranking out a lot of grizzly Method Not Allowed errors. But I can't really remember where versioning support stands in fedora 6 at the moment anyway.", "author": "bbpennel", "createdAt": "2020-08-11T14:30:13Z", "path": "fcrepo-http-api/src/test/java/org/fcrepo/integration/http/api/FedoraVersioningIT.java", "diffHunk": "@@ -853,8 +853,8 @@ private void assertMementoLink(final Link expected, final Link actual) {\n \n             final var expectedUri = expected.getUri().toString();\n             final var actualUri = actual.getUri().toString();\n-            assertEquals(expectedUri.substring(0, expectedUri.length() - 2),\n-                    actualUri.substring(0, actualUri.length() - 2));\n+            assertEquals(expectedUri.substring(0, expectedUri.length() - 3),", "originalCommit": "0ad698bfab4edcf9098283a6afd52f4a538e981e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODYzNDI5NQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1740#discussion_r468634295", "bodyText": "Yes, it increased the wiggle room. It's not as good as it could be if the waits were longer, but I personally don't think it's worth inserting longer waits into the tests.\nThe comparison behavior works like this:\n\nIs the timestamp exactly what we expected?\n\nIf yes, we're done -- PASS\nIf no, continue\n\n\nAre the Instants within 5 seconds of each other?\n\nIf yes, continue\nIf no, we're done -- FAIL\n\n\nAre the first parts of the memento strings the same (this is the part I just modified)?\n\nIf yes, we're done -- PASS\nIf no, we're done -- FAIL\n\n\n\nSo, in the ideal case, the strings will match exactly. But, if they don't match, it checks to see that they're at least close and that they're formatted correctly.", "author": "pwinckles", "createdAt": "2020-08-11T14:40:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODYyNjU5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODY0OTcyNg==", "url": "https://github.com/fcrepo/fcrepo/pull/1740#discussion_r468649726", "bodyText": "Thanks for the explanation, I hadn't followed it all the way through. That seems moderately safe, although there's obviously still some chance of false positive, but that seems outside the scope of this PR.", "author": "bbpennel", "createdAt": "2020-08-11T15:01:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODYyNjU5Ng=="}], "type": "inlineReview", "revised_code": {"commit": "f1a5a16015fcb3dc7d5c61d2ca3acf12e36f63fd", "chunk": "diff --git a/fcrepo-http-api/src/test/java/org/fcrepo/integration/http/api/FedoraVersioningIT.java b/fcrepo-http-api/src/test/java/org/fcrepo/integration/http/api/FedoraVersioningIT.java\nindex 4247514a68..de7d72e65e 100644\n--- a/fcrepo-http-api/src/test/java/org/fcrepo/integration/http/api/FedoraVersioningIT.java\n+++ b/fcrepo-http-api/src/test/java/org/fcrepo/integration/http/api/FedoraVersioningIT.java\n\n@@ -849,10 +853,13 @@ public class FedoraVersioningIT extends AbstractResourceIT {\n \n     private void assertMementoLink(final Link expected, final Link actual) {\n         if (!expected.equals(actual)) {\n+            // Ensures the timestamps are close to each other\n             assertDuration(expected.getParams().get(\"datetime\"), actual.getParams().get(\"datetime\"));\n \n             final var expectedUri = expected.getUri().toString();\n             final var actualUri = actual.getUri().toString();\n+            // Reduces the granularity of the timestamp strings to ensure their formatting is the same, even if they're\n+            // a few seconds apart.\n             assertEquals(expectedUri.substring(0, expectedUri.length() - 3),\n                     actualUri.substring(0, actualUri.length() - 3));\n         }\n"}}, {"oid": "551c8e6b5c72e0a2f4aa89bd565eaf757f111e7e", "url": "https://github.com/fcrepo/fcrepo/commit/551c8e6b5c72e0a2f4aa89bd565eaf757f111e7e", "message": "remove duplicate slash", "committedDate": "2020-08-11T14:41:56Z", "type": "commit"}, {"oid": "07b2d27049ca22756a64388b181956f32db27ed1", "url": "https://github.com/fcrepo/fcrepo/commit/07b2d27049ca22756a64388b181956f32db27ed1", "message": "try to fix mysql deadlock", "committedDate": "2020-08-12T12:58:12Z", "type": "commit"}, {"oid": "0ad140c70e621ab08851865b3b3192f0aa87cf60", "url": "https://github.com/fcrepo/fcrepo/commit/0ad140c70e621ab08851865b3b3192f0aa87cf60", "message": "baseline DB and OCFL repo between ITests", "committedDate": "2020-08-12T18:58:24Z", "type": "commit"}, {"oid": "472f76d3beb7e78c88f74b7915c7bf07da141837", "url": "https://github.com/fcrepo/fcrepo/commit/472f76d3beb7e78c88f74b7915c7bf07da141837", "message": "try to fix windows directory creation problem", "committedDate": "2020-08-12T20:04:11Z", "type": "commit"}, {"oid": "90b47324680b24c792f0b80e90ddb97ff33ed391", "url": "https://github.com/fcrepo/fcrepo/commit/90b47324680b24c792f0b80e90ddb97ff33ed391", "message": "increasing wait for queued file deletions", "committedDate": "2020-08-12T20:20:40Z", "type": "commit"}, {"oid": "038e3ec23c16afe42d899e06b9f369ac8892dfab", "url": "https://github.com/fcrepo/fcrepo/commit/038e3ec23c16afe42d899e06b9f369ac8892dfab", "message": "do not baseline on windows", "committedDate": "2020-08-12T20:41:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDI5NDk4MQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1740#discussion_r474294981", "bodyText": "We can likely delete this class, since the only use in the fcrepo-auth-webac module is actually referencing the copy of this class found in fcrepo-http-api.\nhttps://github.com/fcrepo4/fcrepo4/pull/1740/files#diff-cd44216a669bfca1b37f93a8ab06cf01R77", "author": "awoods", "createdAt": "2020-08-20T21:56:45Z", "path": "fcrepo-auth-webac/src/test/java/org/fcrepo/integration/auth/webac/LinuxTestIsolationExecutionListener.java", "diffHunk": "@@ -0,0 +1,52 @@\n+/*\n+ * Licensed to DuraSpace under one or more contributor license agreements.\n+ * See the NOTICE file distributed with this work for additional information\n+ * regarding copyright ownership.\n+ *\n+ * DuraSpace licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except in\n+ * compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.fcrepo.integration.auth.webac;\n+\n+import edu.wisc.library.ocfl.api.MutableOcflRepository;\n+import org.apache.commons.lang3.SystemUtils;\n+import org.fcrepo.http.commons.test.util.ContainerWrapper;\n+import org.fcrepo.persistence.ocfl.RepositoryInitializer;\n+import org.springframework.test.context.TestContext;\n+import org.springframework.test.context.support.AbstractTestExecutionListener;\n+\n+/**\n+ * Listener that baselines the DB and OCFL repo between every test.\n+ * It does not baseline on Windows due to difficulties associated with deleting and immediately recreating directories.\n+ *\n+ * @author pwinckles\n+ */\n+public class LinuxTestIsolationExecutionListener extends AbstractTestExecutionListener {", "originalCommit": "038e3ec23c16afe42d899e06b9f369ac8892dfab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDcxOTc3Mg==", "url": "https://github.com/fcrepo/fcrepo/pull/1740#discussion_r474719772", "bodyText": "Ah, I didn't realize that fcrepo-http-api was building a test jar.", "author": "pwinckles", "createdAt": "2020-08-21T14:06:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDI5NDk4MQ=="}], "type": "inlineReview", "revised_code": {"commit": "f1a5a16015fcb3dc7d5c61d2ca3acf12e36f63fd", "chunk": "diff --git a/fcrepo-auth-webac/src/test/java/org/fcrepo/integration/auth/webac/LinuxTestIsolationExecutionListener.java b/fcrepo-auth-webac/src/test/java/org/fcrepo/integration/auth/webac/LinuxTestIsolationExecutionListener.java\ndeleted file mode 100644\nindex 31b79d28da..0000000000\n--- a/fcrepo-auth-webac/src/test/java/org/fcrepo/integration/auth/webac/LinuxTestIsolationExecutionListener.java\n+++ /dev/null\n\n@@ -1,52 +0,0 @@\n-/*\n- * Licensed to DuraSpace under one or more contributor license agreements.\n- * See the NOTICE file distributed with this work for additional information\n- * regarding copyright ownership.\n- *\n- * DuraSpace licenses this file to you under the Apache License,\n- * Version 2.0 (the \"License\"); you may not use this file except in\n- * compliance with the License.  You may obtain a copy of the License at\n- *\n- *     http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing, software\n- * distributed under the License is distributed on an \"AS IS\" BASIS,\n- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n- * See the License for the specific language governing permissions and\n- * limitations under the License.\n- */\n-package org.fcrepo.integration.auth.webac;\n-\n-import edu.wisc.library.ocfl.api.MutableOcflRepository;\n-import org.apache.commons.lang3.SystemUtils;\n-import org.fcrepo.http.commons.test.util.ContainerWrapper;\n-import org.fcrepo.persistence.ocfl.RepositoryInitializer;\n-import org.springframework.test.context.TestContext;\n-import org.springframework.test.context.support.AbstractTestExecutionListener;\n-\n-/**\n- * Listener that baselines the DB and OCFL repo between every test.\n- * It does not baseline on Windows due to difficulties associated with deleting and immediately recreating directories.\n- *\n- * @author pwinckles\n- */\n-public class LinuxTestIsolationExecutionListener extends AbstractTestExecutionListener {\n-\n-    @Override\n-    public void beforeTestMethod(final TestContext testContext) {\n-        if (!SystemUtils.IS_OS_WINDOWS) {\n-            final var ocflRepo = getBean(testContext, MutableOcflRepository.class);\n-            final var initializer = getBean(testContext, RepositoryInitializer.class);\n-\n-            ocflRepo.listObjectIds().forEach(ocflRepo::purgeObject);\n-            initializer.initialize();\n-        }\n-    }\n-\n-    private <T> T getBean(final TestContext testContext, final Class<T> clazz) {\n-        final var containerWrapper = testContext.getApplicationContext()\n-                .getBean(ContainerWrapper.class);\n-        return containerWrapper.getSpringAppContext().getBean(clazz);\n-    }\n-\n-}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDI5ODU4NQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1740#discussion_r474298585", "bodyText": "A comment here explaining the magic number (3) would be helpful to our future selves.", "author": "awoods", "createdAt": "2020-08-20T22:05:46Z", "path": "fcrepo-http-api/src/test/java/org/fcrepo/integration/http/api/FedoraVersioningIT.java", "diffHunk": "@@ -853,8 +857,8 @@ private void assertMementoLink(final Link expected, final Link actual) {\n \n             final var expectedUri = expected.getUri().toString();\n             final var actualUri = actual.getUri().toString();\n-            assertEquals(expectedUri.substring(0, expectedUri.length() - 2),\n-                    actualUri.substring(0, actualUri.length() - 2));\n+            assertEquals(expectedUri.substring(0, expectedUri.length() - 3),", "originalCommit": "038e3ec23c16afe42d899e06b9f369ac8892dfab", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f1a5a16015fcb3dc7d5c61d2ca3acf12e36f63fd", "chunk": "diff --git a/fcrepo-http-api/src/test/java/org/fcrepo/integration/http/api/FedoraVersioningIT.java b/fcrepo-http-api/src/test/java/org/fcrepo/integration/http/api/FedoraVersioningIT.java\nindex d306967b32..de7d72e65e 100644\n--- a/fcrepo-http-api/src/test/java/org/fcrepo/integration/http/api/FedoraVersioningIT.java\n+++ b/fcrepo-http-api/src/test/java/org/fcrepo/integration/http/api/FedoraVersioningIT.java\n\n@@ -853,10 +853,13 @@ public class FedoraVersioningIT extends AbstractResourceIT {\n \n     private void assertMementoLink(final Link expected, final Link actual) {\n         if (!expected.equals(actual)) {\n+            // Ensures the timestamps are close to each other\n             assertDuration(expected.getParams().get(\"datetime\"), actual.getParams().get(\"datetime\"));\n \n             final var expectedUri = expected.getUri().toString();\n             final var actualUri = actual.getUri().toString();\n+            // Reduces the granularity of the timestamp strings to ensure their formatting is the same, even if they're\n+            // a few seconds apart.\n             assertEquals(expectedUri.substring(0, expectedUri.length() - 3),\n                     actualUri.substring(0, actualUri.length() - 3));\n         }\n"}}, {"oid": "f1a5a16015fcb3dc7d5c61d2ca3acf12e36f63fd", "url": "https://github.com/fcrepo/fcrepo/commit/f1a5a16015fcb3dc7d5c61d2ca3acf12e36f63fd", "message": "pr fixes", "committedDate": "2020-08-21T14:10:53Z", "type": "commit"}]}