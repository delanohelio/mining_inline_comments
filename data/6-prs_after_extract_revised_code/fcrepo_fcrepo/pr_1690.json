{"pr_number": 1690, "pr_title": "FCREPO-3201 - Transmission fixity when staging to OCFL object", "pr_createdAt": "2020-06-05T13:07:28Z", "pr_url": "https://github.com/fcrepo/fcrepo/pull/1690", "timeline": [{"oid": "e173582d8f2cfcfaf1d7cc66daf78b7c1e780b65", "url": "https://github.com/fcrepo/fcrepo/commit/e173582d8f2cfcfaf1d7cc66daf78b7c1e780b65", "message": "During a commit, a digest is read from the header file for binaries and provided to the OCFL client for transmission fixity purposes, if there is an appropriate digest available", "committedDate": "2020-06-05T12:54:19Z", "type": "commit"}, {"oid": "fac107a55f3664f510065295b8cf932db9a74036", "url": "https://github.com/fcrepo/fcrepo/commit/fac107a55f3664f510065295b8cf932db9a74036", "message": "Use updateObject to create new objects when versioning enabled", "committedDate": "2020-06-05T17:27:07Z", "type": "commit"}, {"oid": "53ff5125f1f6e32cfcffb5ca3beb83389e3d8800", "url": "https://github.com/fcrepo/fcrepo/commit/53ff5125f1f6e32cfcffb5ca3beb83389e3d8800", "message": "Register digests for files modified in a session after write, use those for transmission fixity instead of retrieving from sidecar files", "committedDate": "2020-06-05T17:57:55Z", "type": "commit"}, {"oid": "604328fa45e26d1c478547f9f0bcdf4d232656c8", "url": "https://github.com/fcrepo/fcrepo/commit/604328fa45e26d1c478547f9f0bcdf4d232656c8", "message": "Normalize separators in subpaths during registration", "committedDate": "2020-06-05T19:16:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI3MzUyNQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1690#discussion_r436273525", "bodyText": "I believe this can remain private.", "author": "awoods", "createdAt": "2020-06-06T14:34:59Z", "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/OCFLPersistentStorageUtils.java", "diffHunk": "@@ -81,7 +82,7 @@ private OCFLPersistentStorageUtils() {\n      * The directory within an OCFL Object's content directory that contains\n      * information managed by Fedora.\n      */\n-    private static final String INTERNAL_FEDORA_DIRECTORY = \".fcrepo\";\n+    public static final String INTERNAL_FEDORA_DIRECTORY = \".fcrepo\";", "originalCommit": "604328fa45e26d1c478547f9f0bcdf4d232656c8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI4MDg4MA==", "url": "https://github.com/fcrepo/fcrepo/pull/1690#discussion_r436280880", "bodyText": "Ah, I needed it public for an earlier version, but not the final one. Should be fixed now", "author": "bbpennel", "createdAt": "2020-06-06T16:18:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI3MzUyNQ=="}], "type": "inlineReview", "revised_code": {"commit": "5764c998a29ef13f82b051180b4c3ae6b4b79613", "chunk": "diff --git a/fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/OCFLPersistentStorageUtils.java b/fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/OCFLPersistentStorageUtils.java\nindex 8e4685c6d4..8eebadcaf2 100644\n--- a/fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/OCFLPersistentStorageUtils.java\n+++ b/fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/OCFLPersistentStorageUtils.java\n\n@@ -82,7 +82,7 @@ public class OCFLPersistentStorageUtils {\n      * The directory within an OCFL Object's content directory that contains\n      * information managed by Fedora.\n      */\n-    public static final String INTERNAL_FEDORA_DIRECTORY = \".fcrepo\";\n+    private static final String INTERNAL_FEDORA_DIRECTORY = \".fcrepo\";\n     /**\n      * The default RDF on disk format\n      * TODO Make this value configurable\n"}}, {"oid": "5764c998a29ef13f82b051180b4c3ae6b4b79613", "url": "https://github.com/fcrepo/fcrepo/commit/5764c998a29ef13f82b051180b4c3ae6b4b79613", "message": "Switch back to private", "committedDate": "2020-06-06T16:18:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjY4NjU5Mg==", "url": "https://github.com/fcrepo/fcrepo/pull/1690#discussion_r436686592", "bodyText": "No need to change, but this can now be constructed using List.of().", "author": "pwinckles", "createdAt": "2020-06-08T13:12:55Z", "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/AbstractNonRdfSourcePersister.java", "diffHunk": "@@ -88,12 +88,13 @@ protected void persistNonRDFSource(final ResourceOperation operation,\n         if (forExternalBinary(nonRdfSourceOperation)) {\n             outcome = null;\n         } else {\n+            final var transmissionDigestAlg = objectSession.getObjectDigestAlgorithm();\n             final var providedDigests = nonRdfSourceOperation.getContentDigests();\n             // Wrap binary stream in digest computing wrapper, requesting\n             final var multiDigestWrapper = new MultiDigestInputStreamWrapper(\n                     nonRdfSourceOperation.getContentStream(),\n                     providedDigests,\n-                    Arrays.asList(objectSession.getObjectDigestAlgorithm()));\n+                    Arrays.asList(transmissionDigestAlg));", "originalCommit": "5764c998a29ef13f82b051180b4c3ae6b4b79613", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg0ODM3Mg==", "url": "https://github.com/fcrepo/fcrepo/pull/1690#discussion_r436848372", "bodyText": "Sure, I'll swap it", "author": "bbpennel", "createdAt": "2020-06-08T16:47:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjY4NjU5Mg=="}], "type": "inlineReview", "revised_code": {"commit": "e13c49a9cccec2e4da42ba38ebf015271e846a59", "chunk": "diff --git a/fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/AbstractNonRdfSourcePersister.java b/fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/AbstractNonRdfSourcePersister.java\nindex a736f215f4..8d7e9ab7c7 100644\n--- a/fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/AbstractNonRdfSourcePersister.java\n+++ b/fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/AbstractNonRdfSourcePersister.java\n\n@@ -90,11 +90,12 @@ abstract class AbstractNonRdfSourcePersister extends AbstractPersister {\n         } else {\n             final var transmissionDigestAlg = objectSession.getObjectDigestAlgorithm();\n             final var providedDigests = nonRdfSourceOperation.getContentDigests();\n+\n             // Wrap binary stream in digest computing wrapper, requesting\n             final var multiDigestWrapper = new MultiDigestInputStreamWrapper(\n                     nonRdfSourceOperation.getContentStream(),\n                     providedDigests,\n-                    Arrays.asList(transmissionDigestAlg));\n+                    List.of(transmissionDigestAlg));\n             final var contentStream = multiDigestWrapper.getInputStream();\n \n             outcome = (FileWriteOutcome) objectSession.write(subpath, contentStream);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjY5MzQyNw==", "url": "https://github.com/fcrepo/fcrepo/pull/1690#discussion_r436693427", "bodyText": "I don't think you need to walk the staged files, unless you want to. You should just be able to add the entire staging directory, and then iterate over your map of digests, calling addFileFixity for each.", "author": "pwinckles", "createdAt": "2020-06-08T13:20:17Z", "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/DefaultOCFLObjectSession.java", "diffHunk": "@@ -449,6 +457,53 @@ private String commitUpdates(final CommitOption commitOption) {\n         }\n     }\n \n+    private Consumer<OcflObjectUpdater> constructCommitUpdater(final boolean updatingObject) {\n+        final DIGEST_ALGORITHM fcrepoDigestAlg = getObjectDigestAlgorithm();\n+        final DigestAlgorithm ocflDigestAlg = translateFedoraDigestToOcfl(fcrepoDigestAlg);\n+        final OcflOption[] ocflOptions;\n+        if (updatingObject) {\n+            ocflOptions = new OcflOption[] { MOVE_SOURCE, OVERWRITE };\n+        } else {\n+            ocflOptions = new OcflOption[] { MOVE_SOURCE };\n+        }\n+\n+\n+        return updater -> {\n+            if (updatingObject) {\n+                deletePaths.forEach(updater::removeFile);\n+            }\n+            if (isStagingEmpty()) {\n+                return;\n+            }\n+\n+            try {\n+                Files.walk(stagingPath)", "originalCommit": "5764c998a29ef13f82b051180b4c3ae6b4b79613", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg0ODY3NQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1690#discussion_r436848675", "bodyText": "Good catch, I was still in the mindset of needing to walk files, but there's really no need at this point. I've switched to your suggestion", "author": "bbpennel", "createdAt": "2020-06-08T16:47:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjY5MzQyNw=="}], "type": "inlineReview", "revised_code": {"commit": "e13c49a9cccec2e4da42ba38ebf015271e846a59", "chunk": "diff --git a/fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/DefaultOCFLObjectSession.java b/fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/DefaultOCFLObjectSession.java\nindex 1acb6254ce..6f6ad4045e 100644\n--- a/fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/DefaultOCFLObjectSession.java\n+++ b/fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/DefaultOCFLObjectSession.java\n\n@@ -476,31 +477,17 @@ public class DefaultOCFLObjectSession implements OCFLObjectSession {\n                 return;\n             }\n \n-            try {\n-                Files.walk(stagingPath)\n-                    .filter(Files::isRegularFile)\n-                    .forEach(filePath -> {\n-                        // relativize the path\n-                        final var relativePath = stagingPath.relativize(filePath);\n-                        final var subpath = FileUtil.pathToStringStandardSeparator(relativePath);\n-\n-                        // add path\n-                        updater.addPath(filePath, subpath, ocflOptions);\n-\n-                        // find digest value for it, and add fixity if present\n-                        final var digest = subpathToDigest.get(subpath);\n-                        if (digest != null) {\n-                            try {\n-                                updater.addFileFixity(subpath, ocflDigestAlg, digest);\n-                            } catch (final FixityCheckException e) {\n-                                throw new PersistentStorageRuntimeException(\"Transmission of file \" + filePath\n-                                        + \" failed due to fixity check failure: \" + e.getMessage());\n-                            }\n-                        }\n-                    });\n-            } catch (final IOException e) {\n-                log.error(\"Failed to read staging path {}\", stagingPath, e);\n-            }\n+            updater.addPath(stagingPath, ocflOptions);\n+\n+            subpathToDigest.forEach((subpath, digest) -> {\n+                final String normalizedPath = FileUtil.pathToStringStandardSeparator(Paths.get(subpath));\n+                try {\n+                    updater.addFileFixity(normalizedPath, ocflDigestAlg, digest);\n+                } catch (final FixityCheckException e) {\n+                    throw new PersistentStorageRuntimeException(\"Transmission of file \" + subpath\n+                            + \" failed due to fixity check failure: \" + e.getMessage());\n+                }\n+            });\n         };\n     }\n \n"}}, {"oid": "e13c49a9cccec2e4da42ba38ebf015271e846a59", "url": "https://github.com/fcrepo/fcrepo/commit/e13c49a9cccec2e4da42ba38ebf015271e846a59", "message": "Refactor adding of files during commit to add the staging path directly and then register digests from map", "committedDate": "2020-06-08T16:46:47Z", "type": "commit"}, {"oid": "8aac9a9757e4850834572b15eeb09b89afc74e8b", "url": "https://github.com/fcrepo/fcrepo/commit/8aac9a9757e4850834572b15eeb09b89afc74e8b", "message": "Merge branch 'master' into fcrepo-3201-ocfl-transmission", "committedDate": "2020-06-08T19:30:26Z", "type": "commit"}, {"oid": "acac81e482d38b084e11842d4455a5eec1908486", "url": "https://github.com/fcrepo/fcrepo/commit/acac81e482d38b084e11842d4455a5eec1908486", "message": "Encode subpath when registering digests", "committedDate": "2020-06-08T21:13:52Z", "type": "commit"}]}