{"pr_number": 1441, "pr_title": "Redirect to callback URL during error scenarios according to the response type", "pr_createdAt": "2020-09-10T15:06:19Z", "pr_url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1441", "timeline": [{"oid": "b179af1d4fb8d5a6c79c03332d85f40c1697288f", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/b179af1d4fb8d5a6c79c03332d85f40c1697288f", "message": "fix redirect during error scenarios accoridng to the response type", "committedDate": "2020-09-10T15:00:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ2NDAxMw==", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1441#discussion_r486464013", "bodyText": "Shouldn't this be the other way in the master?\nie. by default we should not allow additional params in the error URL as it violates the spec", "author": "mefarazath", "createdAt": "2020-09-10T16:08:28Z", "path": "components/org.wso2.carbon.identity.oauth.endpoint/src/main/java/org/wso2/carbon/identity/oauth/endpoint/util/EndpointUtil.java", "diffHunk": "@@ -966,13 +957,53 @@ private static String retrieveStateForErrorURL(OAuth2Parameters oAuth2Parameters\n         return state;\n     }\n \n+    /**\n+     * Return updated redirect URL.\n+     *\n+     * @param request       HttpServletRequest\n+     * @param redirectUri   Redirect Uri\n+     * @param errorCode     Error Code\n+     * @param errorMessage  Message of the error\n+     * @param state         State from the request\n+     * @param appName       Application Name\n+     * @return Updated Redirect URL\n+     */\n+    private static String getUpdatedRedirectURL(HttpServletRequest request, String redirectUri, String errorCode,\n+                                                String errorMessage, String state, String appName) {\n+\n+        String updatedRedirectUri = redirectUri;\n+        try {\n+            OAuthProblemException ex = OAuthProblemException.error(errorCode).description(errorMessage);\n+            if (OAuth2Util.isImplicitResponseType(request.getParameter(OAuthConstants.OAuth20Params.RESPONSE_TYPE))\n+                    || OAuth2Util.isHybridResponseType(request.getParameter(OAuthConstants.OAuth20Params.\n+                    RESPONSE_TYPE))) {\n+                updatedRedirectUri = OAuthASResponse.errorResponse(HttpServletResponse.SC_FOUND)\n+                        .error(ex).location(redirectUri).setState(state).setParam(OAuth.OAUTH_ACCESS_TOKEN, null)\n+                        .buildQueryMessage().getLocationUri();\n+            } else {\n+                updatedRedirectUri = OAuthASResponse.errorResponse(HttpServletResponse.SC_FOUND)\n+                        .error(ex).location(redirectUri).setState(state).buildQueryMessage().getLocationUri();\n+            }\n+\n+        } catch (OAuthSystemException e) {\n+            log.error(\"Server error occurred while building error redirect url for application: \" + appName, e);\n+        }\n+        return updatedRedirectUri;\n+    }\n+\n     /**\n      * Method to retrieve the <AllowAdditionalParamsFromErrorUrl> config from the OAuth Configuration.\n      * @return Retrieved config (true or false)\n      */\n     private static boolean isAllowAdditionalParamsFromErrorUrlEnabled() {\n \n-        return Boolean.parseBoolean(IdentityUtil.getProperty(ALLOW_ADDITIONAL_PARAMS_FROM_ERROR_URL));\n+        String isAllowAdditionalParamsEnabled = IdentityUtil.getProperty(ALLOW_ADDITIONAL_PARAMS_FROM_ERROR_URL);\n+\n+        if (StringUtils.isNotBlank(isAllowAdditionalParamsEnabled)) {", "originalCommit": "b179af1d4fb8d5a6c79c03332d85f40c1697288f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjUwNjg3Mg==", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1441#discussion_r486506872", "bodyText": "Made isAllowAdditionalParamsEnabled be false by default. Thank you for pointing that out.", "author": "kasundharmadasa", "createdAt": "2020-09-10T17:17:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ2NDAxMw=="}], "type": "inlineReview", "revised_code": {"commit": "7c4c36d7512ccc58a34dd12dca9efc851fd4dc97", "chunk": "diff --git a/components/org.wso2.carbon.identity.oauth.endpoint/src/main/java/org/wso2/carbon/identity/oauth/endpoint/util/EndpointUtil.java b/components/org.wso2.carbon.identity.oauth.endpoint/src/main/java/org/wso2/carbon/identity/oauth/endpoint/util/EndpointUtil.java\nindex 0143dc718..c7717617f 100644\n--- a/components/org.wso2.carbon.identity.oauth.endpoint/src/main/java/org/wso2/carbon/identity/oauth/endpoint/util/EndpointUtil.java\n+++ b/components/org.wso2.carbon.identity.oauth.endpoint/src/main/java/org/wso2/carbon/identity/oauth/endpoint/util/EndpointUtil.java\n\n@@ -997,13 +997,7 @@ public class EndpointUtil {\n      */\n     private static boolean isAllowAdditionalParamsFromErrorUrlEnabled() {\n \n-        String isAllowAdditionalParamsEnabled = IdentityUtil.getProperty(ALLOW_ADDITIONAL_PARAMS_FROM_ERROR_URL);\n-\n-        if (StringUtils.isNotBlank(isAllowAdditionalParamsEnabled)) {\n-            return Boolean.parseBoolean(isAllowAdditionalParamsEnabled);\n-        } else {\n-            return true;\n-        }\n+        return Boolean.parseBoolean(IdentityUtil.getProperty(ALLOW_ADDITIONAL_PARAMS_FROM_ERROR_URL));\n     }\n \n     /**\n"}}, {"oid": "7c4c36d7512ccc58a34dd12dca9efc851fd4dc97", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/7c4c36d7512ccc58a34dd12dca9efc851fd4dc97", "message": "make AllowAdditionalParamsFromErrorUrl cofig to false by default", "committedDate": "2020-09-10T17:12:52Z", "type": "commit"}]}