{"pr_number": 1380, "pr_title": "Fix JWT token validation at introspection", "pr_createdAt": "2020-05-15T22:08:13Z", "pr_url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1380", "timeline": [{"oid": "fd3a52abcf3a0ae6f50e0238cc72146286961374", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/fd3a52abcf3a0ae6f50e0238cc72146286961374", "message": "Fix JWT token validation at introspection", "committedDate": "2020-05-15T22:06:36Z", "type": "commit"}, {"oid": "201acce27c9b11a2c09edacdaaea5e9367bae1fa", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/201acce27c9b11a2c09edacdaaea5e9367bae1fa", "message": "Fix formatting", "committedDate": "2020-05-15T22:57:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjEyODQzMw==", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1380#discussion_r426128433", "bodyText": "Lets add a debug log with the exception", "author": "janakamarasena", "createdAt": "2020-05-16T07:29:49Z", "path": "components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth2/util/OAuth2Util.java", "diffHunk": "@@ -2822,6 +2823,25 @@ public static Certificate getX509CertOfOAuthApp(String clientId,\n         }\n     }\n \n+    /**\n+     * Return true if the token identifier is a parsable JWT.\n+     *\n+     * @param tokenIdentifier String JWT token identifier.\n+     * @return true for a JWT token.\n+     */\n+    public static boolean isParsableJWT(String tokenIdentifier) {\n+\n+        if (StringUtils.isEmpty(tokenIdentifier)) {\n+            return false;\n+        }\n+        try {\n+            JWTParser.parse(tokenIdentifier);\n+            return true;\n+        } catch (ParseException e) {\n+            return false;", "originalCommit": "201acce27c9b11a2c09edacdaaea5e9367bae1fa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjE3ODYwMw==", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1380#discussion_r426178603", "bodyText": "Fixed in 8b47032", "author": "tharindu-bandara", "createdAt": "2020-05-16T18:27:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjEyODQzMw=="}], "type": "inlineReview", "revised_code": {"commit": "1b45f0d9e7b8cd9c2aeedb370194448c09747715", "chunk": "diff --git a/components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth2/util/OAuth2Util.java b/components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth2/util/OAuth2Util.java\nindex eed3b88ec..aa89ba6d1 100644\n--- a/components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth2/util/OAuth2Util.java\n+++ b/components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth2/util/OAuth2Util.java\n\n@@ -2838,6 +2838,9 @@ public class OAuth2Util {\n             JWTParser.parse(tokenIdentifier);\n             return true;\n         } catch (ParseException e) {\n+            if (log.isDebugEnabled()) {\n+                log.debug(\"Provided token identifier is not a parsable JWT\", e);\n+            }\n             return false;\n         }\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjM2MDAzNw==", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1380#discussion_r426360037", "bodyText": "OAuth2JWTTokenValidator is extending DefaultOAuth2TokenValidator. this can cause a problem, right?", "author": "madurangasiriwardena", "createdAt": "2020-05-18T04:09:43Z", "path": "components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth2/validators/TokenValidationHandler.java", "diffHunk": "@@ -230,11 +233,16 @@ public OAuth2IntrospectionResponseDTO buildIntrospectionResponse(OAuth2TokenVali\n         // To hold the applicable validators list from all the available validators. This list will be prioritized if we\n         // have a token_type_hint.\n         List<OAuth2TokenValidator> applicableValidators = new ArrayList<>();\n+        boolean isJWTTokenValidation = isJWTTokenValidation(oAuth2Token.getIdentifier());\n \n         // If we have a token type hint, we have to prioritize our list.\n         if (oAuth2Token.getTokenType() != null) {\n             if (tokenValidators.get(oAuth2Token.getTokenType()) != null) {\n-                applicableValidators.add(tokenValidators.get(oAuth2Token.getTokenType()));\n+                // Ignore bearer token validators if the token is JWT.\n+                if (!(isJWTTokenValidation && tokenValidators.get(oAuth2Token.getTokenType()) instanceof", "originalCommit": "8b470323deb3712aede396c84307e8c6c5d305e9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjU0NjMxMw==", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1380#discussion_r426546313", "bodyText": "Fixed in 1b45f0d", "author": "tharindu-bandara", "createdAt": "2020-05-18T11:06:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjM2MDAzNw=="}], "type": "inlineReview", "revised_code": {"commit": "1b45f0d9e7b8cd9c2aeedb370194448c09747715", "chunk": "diff --git a/components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth2/validators/TokenValidationHandler.java b/components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth2/validators/TokenValidationHandler.java\nindex 1796d6c66..ccb59256a 100644\n--- a/components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth2/validators/TokenValidationHandler.java\n+++ b/components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth2/validators/TokenValidationHandler.java\n\n@@ -239,8 +240,7 @@ public class TokenValidationHandler {\n         if (oAuth2Token.getTokenType() != null) {\n             if (tokenValidators.get(oAuth2Token.getTokenType()) != null) {\n                 // Ignore bearer token validators if the token is JWT.\n-                if (!(isJWTTokenValidation && tokenValidators.get(oAuth2Token.getTokenType()) instanceof\n-                        DefaultOAuth2TokenValidator)) {\n+                if (!isSkipValidatorForJWT(tokenValidators.get(oAuth2Token.getTokenType()), isJWTTokenValidation)) {\n                     applicableValidators.add(tokenValidators.get(oAuth2Token.getTokenType()));\n                 }\n             }\n"}}, {"oid": "1b45f0d9e7b8cd9c2aeedb370194448c09747715", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/1b45f0d9e7b8cd9c2aeedb370194448c09747715", "message": "Fix review comments", "committedDate": "2020-05-18T11:03:17Z", "type": "commit"}, {"oid": "1b45f0d9e7b8cd9c2aeedb370194448c09747715", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/1b45f0d9e7b8cd9c2aeedb370194448c09747715", "message": "Fix review comments", "committedDate": "2020-05-18T11:03:17Z", "type": "forcePushed"}, {"oid": "fe9d02263accb17cf4d32959ff8d7316ef553c26", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/fe9d02263accb17cf4d32959ff8d7316ef553c26", "message": "Fix formatting", "committedDate": "2020-05-18T11:06:09Z", "type": "commit"}]}