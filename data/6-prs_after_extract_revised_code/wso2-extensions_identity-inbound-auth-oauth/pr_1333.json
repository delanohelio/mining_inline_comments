{"pr_number": 1333, "pr_title": "Fix Device-Flow client validation", "pr_createdAt": "2020-02-26T10:06:10Z", "pr_url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1333", "timeline": [{"oid": "8e39aff4cdc0c05dc1356ae8dd43d8fba4a9f77c", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/8e39aff4cdc0c05dc1356ae8dd43d8fba4a9f77c", "message": "fix client id validation", "committedDate": "2020-02-25T16:26:40Z", "type": "commit"}, {"oid": "7886b87d785245344b0fdcff8e645afae31b2b46", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/7886b87d785245344b0fdcff8e645afae31b2b46", "message": "fix device flow authentication", "committedDate": "2020-02-26T09:41:02Z", "type": "commit"}, {"oid": "1913de05486b099be8b45cd1d383ada010c32352", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/1913de05486b099be8b45cd1d383ada010c32352", "message": "Merge branch 'fix-device-flow'", "committedDate": "2020-02-26T09:55:21Z", "type": "commit"}, {"oid": "61ba490ab24d766ae83845de9a9aa25dce1b0954", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/61ba490ab24d766ae83845de9a9aa25dce1b0954", "message": "fix device-flow tests", "committedDate": "2020-02-27T14:16:08Z", "type": "commit"}, {"oid": "8f21db926a40017c3a4ac16fbda9f16ec036fa60", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/8f21db926a40017c3a4ac16fbda9f16ec036fa60", "message": "Merge branch 'master' of https://github.com/wso2-extensions/identity-inbound-auth-oauth", "committedDate": "2020-02-27T14:19:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTIzMDEzOA==", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1333#discussion_r385230138", "bodyText": "Missing fullstop", "author": "pamodaaw", "createdAt": "2020-02-27T16:41:01Z", "path": "components/org.wso2.carbon.identity.oauth.endpoint/src/main/java/org/wso2/carbon/identity/oauth/endpoint/device/DeviceEndpoint.java", "diffHunk": "@@ -57,44 +66,81 @@ public void setDeviceAuthService(DeviceAuthService deviceAuthService) {\n     @Path(\"/\")\n     @Consumes(\"application/x-www-form-urlencoded\")\n     @Produces(\"application/json\")\n-    public Response authorize(@Context HttpServletRequest request, @Context HttpServletResponse response)\n-            throws IdentityOAuth2Exception {\n-\n-        String clientId = request.getParameter(Constants.CLIENT_ID);\n-        JSONObject errorResponse = new JSONObject();\n-        if (StringUtils.isBlank(clientId)) {\n-            errorResponse.put(Constants.ERROR, DeviceErrorCodes.INVALID_REQUEST)\n-                    .put(Constants.ERROR_DESCRIPTION, \"Request missing required parameters\");\n-            Response.ResponseBuilder respBuilder = Response.status(HttpServletResponse.SC_BAD_REQUEST);\n-            return respBuilder.entity(errorResponse.toString()).build();\n-        }\n-        if (!validateClientId(clientId)) {\n-            errorResponse.put(Constants.ERROR, DeviceErrorCodes.UNAUTHORIZED_CLIENT)\n-                    .put(Constants.ERROR_DESCRIPTION, \"No registered client with the client id.\");\n-            Response.ResponseBuilder respBuilder = Response.status(HttpServletResponse.SC_UNAUTHORIZED);\n-            return respBuilder.entity(errorResponse.toString()).build();\n+    public Response authorize(@Context HttpServletRequest request, MultivaluedMap<String, String> paramMap,\n+                              @Context HttpServletResponse response)\n+            throws IdentityOAuth2Exception, OAuthSystemException {\n+\n+        OAuthClientAuthnContext oAuthClientAuthnContext =  validateClient(request);\n+\n+        if (!oAuthClientAuthnContext.isAuthenticated()) {\n+            return handleErrorResponse(oAuthClientAuthnContext);\n         }\n+\n         String userCode = GenerateKeys.getKey(Constants.KEY_LENGTH);\n         String deviceCode = UUID.randomUUID().toString();\n         String scopes = request.getParameter(Constants.SCOPE);\n-        String redirectionUri = IdentityUtil.getServerURL(\"/authenticationendpoint/device.do\", false, false);\n+        String redirectionUri = IdentityUtil.getServerURL(\"/authenticationendpoint/device.do\",\n+                false, false);\n         String redirectionUriComplete = redirectionUri + \"?user_code=\" + userCode;\n-        deviceAuthService.generateDeviceResponse(deviceCode, userCode, clientId, scopes);\n+        deviceAuthService.generateDeviceResponse(deviceCode, userCode, oAuthClientAuthnContext.getClientId(), scopes);\n         return buildResponseObject(deviceCode, userCode, redirectionUri, redirectionUriComplete);\n     }\n \n-    /**\n-     * This method uses to validate the client is exist or not.\n-     *\n-     * @param clientId Consumer key of the client.\n-     * @return Client is exist or not.\n-     * @throws IdentityOAuth2Exception\n-     */\n-    private boolean validateClientId(String clientId) throws IdentityOAuth2Exception {\n+    private Response handleErrorResponse(OAuthClientAuthnContext oAuthClientAuthnContext) throws OAuthSystemException {\n+\n+        if (OAuth2ErrorCodes.INVALID_CLIENT.equals(oAuthClientAuthnContext.getErrorMessage())) {\n+            return handleBasicAuthFailure(oAuthClientAuthnContext.getErrorCode(),\n+                    oAuthClientAuthnContext.getErrorMessage());\n+        } else if (OAuth2ErrorCodes.SERVER_ERROR.equals(oAuthClientAuthnContext.getErrorMessage())) {\n \n-        return deviceAuthService.validateClientInfo(clientId);\n+            return handleServerError();\n+        } else {\n+            // Otherwise send back HTTP 400 Status Code", "originalCommit": "8f21db926a40017c3a4ac16fbda9f16ec036fa60", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "42aa78048126ab78394969ffdf5537f8d33ef305", "chunk": "diff --git a/components/org.wso2.carbon.identity.oauth.endpoint/src/main/java/org/wso2/carbon/identity/oauth/endpoint/device/DeviceEndpoint.java b/components/org.wso2.carbon.identity.oauth.endpoint/src/main/java/org/wso2/carbon/identity/oauth/endpoint/device/DeviceEndpoint.java\nindex aa9dbc755..f1479b4e7 100644\n--- a/components/org.wso2.carbon.identity.oauth.endpoint/src/main/java/org/wso2/carbon/identity/oauth/endpoint/device/DeviceEndpoint.java\n+++ b/components/org.wso2.carbon.identity.oauth.endpoint/src/main/java/org/wso2/carbon/identity/oauth/endpoint/device/DeviceEndpoint.java\n\n@@ -70,7 +70,7 @@ public class DeviceEndpoint {\n                               @Context HttpServletResponse response)\n             throws IdentityOAuth2Exception, OAuthSystemException {\n \n-        OAuthClientAuthnContext oAuthClientAuthnContext =  validateClient(request);\n+        OAuthClientAuthnContext oAuthClientAuthnContext =  getValidationObject(request);\n \n         if (!oAuthClientAuthnContext.isAuthenticated()) {\n             return handleErrorResponse(oAuthClientAuthnContext);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTIzMDMyNg==", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1333#discussion_r385230326", "bodyText": "keep a new line", "author": "pamodaaw", "createdAt": "2020-02-27T16:41:18Z", "path": "components/org.wso2.carbon.identity.oauth.endpoint/src/main/java/org/wso2/carbon/identity/oauth/endpoint/device/DeviceEndpoint.java", "diffHunk": "@@ -57,44 +66,81 @@ public void setDeviceAuthService(DeviceAuthService deviceAuthService) {\n     @Path(\"/\")\n     @Consumes(\"application/x-www-form-urlencoded\")\n     @Produces(\"application/json\")\n-    public Response authorize(@Context HttpServletRequest request, @Context HttpServletResponse response)\n-            throws IdentityOAuth2Exception {\n-\n-        String clientId = request.getParameter(Constants.CLIENT_ID);\n-        JSONObject errorResponse = new JSONObject();\n-        if (StringUtils.isBlank(clientId)) {\n-            errorResponse.put(Constants.ERROR, DeviceErrorCodes.INVALID_REQUEST)\n-                    .put(Constants.ERROR_DESCRIPTION, \"Request missing required parameters\");\n-            Response.ResponseBuilder respBuilder = Response.status(HttpServletResponse.SC_BAD_REQUEST);\n-            return respBuilder.entity(errorResponse.toString()).build();\n-        }\n-        if (!validateClientId(clientId)) {\n-            errorResponse.put(Constants.ERROR, DeviceErrorCodes.UNAUTHORIZED_CLIENT)\n-                    .put(Constants.ERROR_DESCRIPTION, \"No registered client with the client id.\");\n-            Response.ResponseBuilder respBuilder = Response.status(HttpServletResponse.SC_UNAUTHORIZED);\n-            return respBuilder.entity(errorResponse.toString()).build();\n+    public Response authorize(@Context HttpServletRequest request, MultivaluedMap<String, String> paramMap,\n+                              @Context HttpServletResponse response)\n+            throws IdentityOAuth2Exception, OAuthSystemException {\n+\n+        OAuthClientAuthnContext oAuthClientAuthnContext =  validateClient(request);\n+\n+        if (!oAuthClientAuthnContext.isAuthenticated()) {\n+            return handleErrorResponse(oAuthClientAuthnContext);\n         }\n+\n         String userCode = GenerateKeys.getKey(Constants.KEY_LENGTH);\n         String deviceCode = UUID.randomUUID().toString();\n         String scopes = request.getParameter(Constants.SCOPE);\n-        String redirectionUri = IdentityUtil.getServerURL(\"/authenticationendpoint/device.do\", false, false);\n+        String redirectionUri = IdentityUtil.getServerURL(\"/authenticationendpoint/device.do\",\n+                false, false);\n         String redirectionUriComplete = redirectionUri + \"?user_code=\" + userCode;\n-        deviceAuthService.generateDeviceResponse(deviceCode, userCode, clientId, scopes);\n+        deviceAuthService.generateDeviceResponse(deviceCode, userCode, oAuthClientAuthnContext.getClientId(), scopes);\n         return buildResponseObject(deviceCode, userCode, redirectionUri, redirectionUriComplete);\n     }\n \n-    /**\n-     * This method uses to validate the client is exist or not.\n-     *\n-     * @param clientId Consumer key of the client.\n-     * @return Client is exist or not.\n-     * @throws IdentityOAuth2Exception\n-     */\n-    private boolean validateClientId(String clientId) throws IdentityOAuth2Exception {\n+    private Response handleErrorResponse(OAuthClientAuthnContext oAuthClientAuthnContext) throws OAuthSystemException {\n+\n+        if (OAuth2ErrorCodes.INVALID_CLIENT.equals(oAuthClientAuthnContext.getErrorMessage())) {\n+            return handleBasicAuthFailure(oAuthClientAuthnContext.getErrorCode(),\n+                    oAuthClientAuthnContext.getErrorMessage());\n+        } else if (OAuth2ErrorCodes.SERVER_ERROR.equals(oAuthClientAuthnContext.getErrorMessage())) {\n \n-        return deviceAuthService.validateClientInfo(clientId);\n+            return handleServerError();\n+        } else {\n+            // Otherwise send back HTTP 400 Status Code\n+            OAuthResponse response = OAuthASResponse\n+                    .errorResponse(HttpServletResponse.SC_BAD_REQUEST)\n+                    .setError(oAuthClientAuthnContext.getErrorCode())\n+                    .setErrorDescription(oAuthClientAuthnContext.getErrorMessage())\n+                    .buildJSONMessage();\n+            Response.ResponseBuilder respBuilder = Response.status(response.getResponseStatus());\n+            return respBuilder.entity(response.getBody()).build();\n+        }\n     }\n \n+    private OAuthClientAuthnContext validateClient(HttpServletRequest request) throws OAuthSystemException {\n+\n+        OAuthClientAuthnContext oAuthClientAuthnContext;\n+        Object oauthClientAuthnContextObj = request.getAttribute(OAuthConstants.CLIENT_AUTHN_CONTEXT);\n+        if (oauthClientAuthnContextObj instanceof OAuthClientAuthnContext) {\n+            oAuthClientAuthnContext = (OAuthClientAuthnContext) oauthClientAuthnContextObj;\n+        } else {\n+            oAuthClientAuthnContext = new OAuthClientAuthnContext();\n+            oAuthClientAuthnContext.setAuthenticated(false);\n+            oAuthClientAuthnContext.setErrorMessage(\"Client Authentication Failed\");\n+            oAuthClientAuthnContext.setErrorCode(OAuthError.TokenResponse.INVALID_REQUEST);\n+        }\n+        return oAuthClientAuthnContext;\n+    }\n+\n+    private Response handleServerError() throws OAuthSystemException {\n+\n+        OAuthResponse response = OAuthASResponse.errorResponse(HttpServletResponse.SC_INTERNAL_SERVER_ERROR).\n+                setError(OAuth2ErrorCodes.SERVER_ERROR).setErrorDescription(\"Internal Server Error.\")\n+                .buildJSONMessage();\n+\n+        return Response.status(response.getResponseStatus()).header(OAuthConstants.HTTP_RESP_HEADER_AUTHENTICATE,\n+                EndpointUtil.getRealmInfo()).entity(response.getBody()).build();\n+\n+    }\n+\n+    private Response handleBasicAuthFailure(String errorCode, String errorMessage) throws OAuthSystemException {\n+\n+        OAuthResponse response = OAuthASResponse.errorResponse(HttpServletResponse.SC_UNAUTHORIZED)\n+                .setError(OAuth2ErrorCodes.INVALID_CLIENT)\n+                .setErrorDescription(\"Client Authentication failed.\").buildJSONMessage();\n+        return Response.status(response.getResponseStatus())\n+                .header(OAuthConstants.HTTP_RESP_HEADER_AUTHENTICATE, EndpointUtil.getRealmInfo())\n+                .entity(response.getBody()).build();\n+    }", "originalCommit": "8f21db926a40017c3a4ac16fbda9f16ec036fa60", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "42aa78048126ab78394969ffdf5537f8d33ef305", "chunk": "diff --git a/components/org.wso2.carbon.identity.oauth.endpoint/src/main/java/org/wso2/carbon/identity/oauth/endpoint/device/DeviceEndpoint.java b/components/org.wso2.carbon.identity.oauth.endpoint/src/main/java/org/wso2/carbon/identity/oauth/endpoint/device/DeviceEndpoint.java\nindex aa9dbc755..f1479b4e7 100644\n--- a/components/org.wso2.carbon.identity.oauth.endpoint/src/main/java/org/wso2/carbon/identity/oauth/endpoint/device/DeviceEndpoint.java\n+++ b/components/org.wso2.carbon.identity.oauth.endpoint/src/main/java/org/wso2/carbon/identity/oauth/endpoint/device/DeviceEndpoint.java\n\n@@ -70,7 +70,7 @@ public class DeviceEndpoint {\n                               @Context HttpServletResponse response)\n             throws IdentityOAuth2Exception, OAuthSystemException {\n \n-        OAuthClientAuthnContext oAuthClientAuthnContext =  validateClient(request);\n+        OAuthClientAuthnContext oAuthClientAuthnContext =  getValidationObject(request);\n \n         if (!oAuthClientAuthnContext.isAuthenticated()) {\n             return handleErrorResponse(oAuthClientAuthnContext);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTIzMzM1NQ==", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1333#discussion_r385233355", "bodyText": "Remove unnecessary new line", "author": "pamodaaw", "createdAt": "2020-02-27T16:46:09Z", "path": "components/org.wso2.carbon.identity.oauth.endpoint/src/main/java/org/wso2/carbon/identity/oauth/endpoint/device/DeviceEndpoint.java", "diffHunk": "@@ -57,44 +66,81 @@ public void setDeviceAuthService(DeviceAuthService deviceAuthService) {\n     @Path(\"/\")\n     @Consumes(\"application/x-www-form-urlencoded\")\n     @Produces(\"application/json\")\n-    public Response authorize(@Context HttpServletRequest request, @Context HttpServletResponse response)\n-            throws IdentityOAuth2Exception {\n-\n-        String clientId = request.getParameter(Constants.CLIENT_ID);\n-        JSONObject errorResponse = new JSONObject();\n-        if (StringUtils.isBlank(clientId)) {\n-            errorResponse.put(Constants.ERROR, DeviceErrorCodes.INVALID_REQUEST)\n-                    .put(Constants.ERROR_DESCRIPTION, \"Request missing required parameters\");\n-            Response.ResponseBuilder respBuilder = Response.status(HttpServletResponse.SC_BAD_REQUEST);\n-            return respBuilder.entity(errorResponse.toString()).build();\n-        }\n-        if (!validateClientId(clientId)) {\n-            errorResponse.put(Constants.ERROR, DeviceErrorCodes.UNAUTHORIZED_CLIENT)\n-                    .put(Constants.ERROR_DESCRIPTION, \"No registered client with the client id.\");\n-            Response.ResponseBuilder respBuilder = Response.status(HttpServletResponse.SC_UNAUTHORIZED);\n-            return respBuilder.entity(errorResponse.toString()).build();\n+    public Response authorize(@Context HttpServletRequest request, MultivaluedMap<String, String> paramMap,\n+                              @Context HttpServletResponse response)\n+            throws IdentityOAuth2Exception, OAuthSystemException {\n+\n+        OAuthClientAuthnContext oAuthClientAuthnContext =  validateClient(request);\n+\n+        if (!oAuthClientAuthnContext.isAuthenticated()) {\n+            return handleErrorResponse(oAuthClientAuthnContext);\n         }\n+\n         String userCode = GenerateKeys.getKey(Constants.KEY_LENGTH);\n         String deviceCode = UUID.randomUUID().toString();\n         String scopes = request.getParameter(Constants.SCOPE);\n-        String redirectionUri = IdentityUtil.getServerURL(\"/authenticationendpoint/device.do\", false, false);\n+        String redirectionUri = IdentityUtil.getServerURL(\"/authenticationendpoint/device.do\",\n+                false, false);\n         String redirectionUriComplete = redirectionUri + \"?user_code=\" + userCode;\n-        deviceAuthService.generateDeviceResponse(deviceCode, userCode, clientId, scopes);\n+        deviceAuthService.generateDeviceResponse(deviceCode, userCode, oAuthClientAuthnContext.getClientId(), scopes);\n         return buildResponseObject(deviceCode, userCode, redirectionUri, redirectionUriComplete);\n     }\n \n-    /**\n-     * This method uses to validate the client is exist or not.\n-     *\n-     * @param clientId Consumer key of the client.\n-     * @return Client is exist or not.\n-     * @throws IdentityOAuth2Exception\n-     */\n-    private boolean validateClientId(String clientId) throws IdentityOAuth2Exception {\n+    private Response handleErrorResponse(OAuthClientAuthnContext oAuthClientAuthnContext) throws OAuthSystemException {\n+\n+        if (OAuth2ErrorCodes.INVALID_CLIENT.equals(oAuthClientAuthnContext.getErrorMessage())) {\n+            return handleBasicAuthFailure(oAuthClientAuthnContext.getErrorCode(),\n+                    oAuthClientAuthnContext.getErrorMessage());\n+        } else if (OAuth2ErrorCodes.SERVER_ERROR.equals(oAuthClientAuthnContext.getErrorMessage())) {\n \n-        return deviceAuthService.validateClientInfo(clientId);\n+            return handleServerError();\n+        } else {\n+            // Otherwise send back HTTP 400 Status Code\n+            OAuthResponse response = OAuthASResponse\n+                    .errorResponse(HttpServletResponse.SC_BAD_REQUEST)\n+                    .setError(oAuthClientAuthnContext.getErrorCode())\n+                    .setErrorDescription(oAuthClientAuthnContext.getErrorMessage())\n+                    .buildJSONMessage();\n+            Response.ResponseBuilder respBuilder = Response.status(response.getResponseStatus());\n+            return respBuilder.entity(response.getBody()).build();\n+        }\n     }\n \n+    private OAuthClientAuthnContext validateClient(HttpServletRequest request) throws OAuthSystemException {\n+\n+        OAuthClientAuthnContext oAuthClientAuthnContext;\n+        Object oauthClientAuthnContextObj = request.getAttribute(OAuthConstants.CLIENT_AUTHN_CONTEXT);\n+        if (oauthClientAuthnContextObj instanceof OAuthClientAuthnContext) {\n+            oAuthClientAuthnContext = (OAuthClientAuthnContext) oauthClientAuthnContextObj;\n+        } else {\n+            oAuthClientAuthnContext = new OAuthClientAuthnContext();\n+            oAuthClientAuthnContext.setAuthenticated(false);\n+            oAuthClientAuthnContext.setErrorMessage(\"Client Authentication Failed\");\n+            oAuthClientAuthnContext.setErrorCode(OAuthError.TokenResponse.INVALID_REQUEST);\n+        }\n+        return oAuthClientAuthnContext;\n+    }\n+\n+    private Response handleServerError() throws OAuthSystemException {\n+\n+        OAuthResponse response = OAuthASResponse.errorResponse(HttpServletResponse.SC_INTERNAL_SERVER_ERROR).\n+                setError(OAuth2ErrorCodes.SERVER_ERROR).setErrorDescription(\"Internal Server Error.\")\n+                .buildJSONMessage();\n+\n+        return Response.status(response.getResponseStatus()).header(OAuthConstants.HTTP_RESP_HEADER_AUTHENTICATE,\n+                EndpointUtil.getRealmInfo()).entity(response.getBody()).build();\n+", "originalCommit": "8f21db926a40017c3a4ac16fbda9f16ec036fa60", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "42aa78048126ab78394969ffdf5537f8d33ef305", "chunk": "diff --git a/components/org.wso2.carbon.identity.oauth.endpoint/src/main/java/org/wso2/carbon/identity/oauth/endpoint/device/DeviceEndpoint.java b/components/org.wso2.carbon.identity.oauth.endpoint/src/main/java/org/wso2/carbon/identity/oauth/endpoint/device/DeviceEndpoint.java\nindex aa9dbc755..f1479b4e7 100644\n--- a/components/org.wso2.carbon.identity.oauth.endpoint/src/main/java/org/wso2/carbon/identity/oauth/endpoint/device/DeviceEndpoint.java\n+++ b/components/org.wso2.carbon.identity.oauth.endpoint/src/main/java/org/wso2/carbon/identity/oauth/endpoint/device/DeviceEndpoint.java\n\n@@ -70,7 +70,7 @@ public class DeviceEndpoint {\n                               @Context HttpServletResponse response)\n             throws IdentityOAuth2Exception, OAuthSystemException {\n \n-        OAuthClientAuthnContext oAuthClientAuthnContext =  validateClient(request);\n+        OAuthClientAuthnContext oAuthClientAuthnContext =  getValidationObject(request);\n \n         if (!oAuthClientAuthnContext.isAuthenticated()) {\n             return handleErrorResponse(oAuthClientAuthnContext);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTIzMzg3Mw==", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1333#discussion_r385233873", "bodyText": "Keep a new line after the method declaration", "author": "pamodaaw", "createdAt": "2020-02-27T16:46:55Z", "path": "components/org.wso2.carbon.identity.oauth.endpoint/src/test/java/org/wso2/carbon/identity/oauth/endpoint/device/DeviceEndpointTest.java", "diffHunk": "@@ -113,11 +124,16 @@ public void testStringValueInSeconds(long value) throws Exception {\n \n     @DataProvider(name = \"dataValues\")\n     public Object[][] dataValues() {\n+        MultivaluedMap<String, String> mapWithClientId = new MultivaluedHashMap<>();", "originalCommit": "8f21db926a40017c3a4ac16fbda9f16ec036fa60", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "42aa78048126ab78394969ffdf5537f8d33ef305", "chunk": "diff --git a/components/org.wso2.carbon.identity.oauth.endpoint/src/test/java/org/wso2/carbon/identity/oauth/endpoint/device/DeviceEndpointTest.java b/components/org.wso2.carbon.identity.oauth.endpoint/src/test/java/org/wso2/carbon/identity/oauth/endpoint/device/DeviceEndpointTest.java\nindex 604dcc714..ba0120978 100644\n--- a/components/org.wso2.carbon.identity.oauth.endpoint/src/test/java/org/wso2/carbon/identity/oauth/endpoint/device/DeviceEndpointTest.java\n+++ b/components/org.wso2.carbon.identity.oauth.endpoint/src/test/java/org/wso2/carbon/identity/oauth/endpoint/device/DeviceEndpointTest.java\n\n@@ -124,6 +124,7 @@ public class DeviceEndpointTest extends TestOAuthEndpointBase {\n \n     @DataProvider(name = \"dataValues\")\n     public Object[][] dataValues() {\n+\n         MultivaluedMap<String, String> mapWithClientId = new MultivaluedHashMap<>();\n         List<String> clientId = new ArrayList<>();\n         clientId.add(CLIENT_ID_VALUE);\n"}}, {"oid": "42aa78048126ab78394969ffdf5537f8d33ef305", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/42aa78048126ab78394969ffdf5537f8d33ef305", "message": "fix minor issues", "committedDate": "2020-02-27T16:52:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTk2ODc2Mw==", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1333#discussion_r479968763", "bodyText": "Is invalid request the appropriate error code here?", "author": "mefarazath", "createdAt": "2020-08-31T08:12:46Z", "path": "components/org.wso2.carbon.identity.oauth.endpoint/src/main/java/org/wso2/carbon/identity/oauth/endpoint/device/DeviceEndpoint.java", "diffHunk": "@@ -57,42 +66,79 @@ public void setDeviceAuthService(DeviceAuthService deviceAuthService) {\n     @Path(\"/\")\n     @Consumes(\"application/x-www-form-urlencoded\")\n     @Produces(\"application/json\")\n-    public Response authorize(@Context HttpServletRequest request, @Context HttpServletResponse response)\n-            throws IdentityOAuth2Exception {\n-\n-        String clientId = request.getParameter(Constants.CLIENT_ID);\n-        JSONObject errorResponse = new JSONObject();\n-        if (StringUtils.isBlank(clientId)) {\n-            errorResponse.put(Constants.ERROR, DeviceErrorCodes.INVALID_REQUEST)\n-                    .put(Constants.ERROR_DESCRIPTION, \"Request missing required parameters\");\n-            Response.ResponseBuilder respBuilder = Response.status(HttpServletResponse.SC_BAD_REQUEST);\n-            return respBuilder.entity(errorResponse.toString()).build();\n-        }\n-        if (!validateClientId(clientId)) {\n-            errorResponse.put(Constants.ERROR, DeviceErrorCodes.UNAUTHORIZED_CLIENT)\n-                    .put(Constants.ERROR_DESCRIPTION, \"No registered client with the client id.\");\n-            Response.ResponseBuilder respBuilder = Response.status(HttpServletResponse.SC_UNAUTHORIZED);\n-            return respBuilder.entity(errorResponse.toString()).build();\n+    public Response authorize(@Context HttpServletRequest request, MultivaluedMap<String, String> paramMap,\n+                              @Context HttpServletResponse response)\n+            throws IdentityOAuth2Exception, OAuthSystemException {\n+\n+        OAuthClientAuthnContext oAuthClientAuthnContext =  getValidationObject(request);\n+\n+        if (!oAuthClientAuthnContext.isAuthenticated()) {\n+            return handleErrorResponse(oAuthClientAuthnContext);\n         }\n+\n         String userCode = GenerateKeys.getKey(Constants.KEY_LENGTH);\n         String deviceCode = UUID.randomUUID().toString();\n         String scopes = request.getParameter(Constants.SCOPE);\n-        String redirectionUri = IdentityUtil.getServerURL(\"/authenticationendpoint/device.do\", false, false);\n+        String redirectionUri = IdentityUtil.getServerURL(\"/authenticationendpoint/device.do\",\n+                false, false);\n         String redirectionUriComplete = redirectionUri + \"?user_code=\" + userCode;\n-        deviceAuthService.generateDeviceResponse(deviceCode, userCode, clientId, scopes);\n+        deviceAuthService.generateDeviceResponse(deviceCode, userCode, oAuthClientAuthnContext.getClientId(), scopes);\n         return buildResponseObject(deviceCode, userCode, redirectionUri, redirectionUriComplete);\n     }\n \n-    /**\n-     * This method uses to validate the client is exist or not.\n-     *\n-     * @param clientId Consumer key of the client.\n-     * @return Client is exist or not.\n-     * @throws IdentityOAuth2Exception\n-     */\n-    private boolean validateClientId(String clientId) throws IdentityOAuth2Exception {\n+    private Response handleErrorResponse(OAuthClientAuthnContext oAuthClientAuthnContext) throws OAuthSystemException {\n+\n+        if (OAuth2ErrorCodes.INVALID_CLIENT.equals(oAuthClientAuthnContext.getErrorMessage())) {\n+            return handleBasicAuthFailure(oAuthClientAuthnContext.getErrorCode(),\n+                    oAuthClientAuthnContext.getErrorMessage());\n+        } else if (OAuth2ErrorCodes.SERVER_ERROR.equals(oAuthClientAuthnContext.getErrorMessage())) {\n+\n+            return handleServerError();\n+        } else {\n+            // Otherwise send back HTTP 400 Status Code.\n+            OAuthResponse response = OAuthASResponse\n+                    .errorResponse(HttpServletResponse.SC_BAD_REQUEST)\n+                    .setError(oAuthClientAuthnContext.getErrorCode())\n+                    .setErrorDescription(oAuthClientAuthnContext.getErrorMessage())\n+                    .buildJSONMessage();\n+            Response.ResponseBuilder respBuilder = Response.status(response.getResponseStatus());\n+            return respBuilder.entity(response.getBody()).build();\n+        }\n+    }\n+\n+    private OAuthClientAuthnContext getValidationObject(HttpServletRequest request) throws OAuthSystemException {\n+\n+        OAuthClientAuthnContext oAuthClientAuthnContext;\n+        Object oauthClientAuthnContextObj = request.getAttribute(OAuthConstants.CLIENT_AUTHN_CONTEXT);\n+        if (oauthClientAuthnContextObj instanceof OAuthClientAuthnContext) {\n+            oAuthClientAuthnContext = (OAuthClientAuthnContext) oauthClientAuthnContextObj;\n+        } else {\n+            oAuthClientAuthnContext = new OAuthClientAuthnContext();\n+            oAuthClientAuthnContext.setAuthenticated(false);\n+            oAuthClientAuthnContext.setErrorMessage(\"Client Authentication Failed\");\n+            oAuthClientAuthnContext.setErrorCode(OAuthError.TokenResponse.INVALID_REQUEST);", "originalCommit": "42aa78048126ab78394969ffdf5537f8d33ef305", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}