{"pr_number": 1501, "pr_title": "Fix the issue with token revocation when account disabling/locking", "pr_createdAt": "2020-11-12T10:31:57Z", "pr_url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1501", "timeline": [{"oid": "18231206c0e620627c3f97f53dd3edd8a2f050bd", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/18231206c0e620627c3f97f53dd3edd8a2f050bd", "message": "Fix the issue with token revocation when account diabling/locking", "committedDate": "2020-11-12T10:30:55Z", "type": "commit"}, {"oid": "ee3988c20e4b901381ba76fdff28d1f26dabc1ff", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/ee3988c20e4b901381ba76fdff28d1f26dabc1ff", "message": "Resolve conflicts", "committedDate": "2020-11-12T10:38:32Z", "type": "commit"}, {"oid": "dadaefc96e77c0794409c2c1e710c30f60280f46", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/dadaefc96e77c0794409c2c1e710c30f60280f46", "message": "Merge remote-tracking branch 'piraveena/issue10101' into issue10101\n\n# Conflicts:\n#\tcomponents/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/internal/OAuthServiceComponent.java", "committedDate": "2020-11-12T10:40:30Z", "type": "commit"}, {"oid": "59ec3da2b0e6f34cefc4861aabf86d8c942543d3", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/59ec3da2b0e6f34cefc4861aabf86d8c942543d3", "message": "Refactor", "committedDate": "2020-11-12T11:42:55Z", "type": "commit"}, {"oid": "a156d1c769148e1d7a739b97ec08ab1b2d0e1445", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/a156d1c769148e1d7a739b97ec08ab1b2d0e1445", "message": "Move common methods in EventListner and EventHandler to OAuthUtil", "committedDate": "2020-11-12T13:29:28Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjExODQwMQ==", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1501#discussion_r522118401", "bodyText": "we have to check both POST_SET_USER_CLAIMS and POST_SET_USER_CLAIM events", "author": "IsuraD", "createdAt": "2020-11-12T13:49:52Z", "path": "components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/listener/IdentityOauthEventHandler.java", "diffHunk": "@@ -0,0 +1,117 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.wso2.carbon.identity.oauth.listener;\n+\n+import org.apache.commons.logging.Log;\n+import org.apache.commons.logging.LogFactory;\n+import org.wso2.carbon.identity.base.IdentityRuntimeException;\n+import org.wso2.carbon.identity.core.bean.context.MessageContext;\n+import org.wso2.carbon.identity.core.handler.InitConfig;\n+import org.wso2.carbon.identity.core.util.IdentityCoreConstants;\n+import org.wso2.carbon.identity.core.util.IdentityUtil;\n+import org.wso2.carbon.identity.event.IdentityEventConstants;\n+import org.wso2.carbon.identity.event.IdentityEventException;\n+import org.wso2.carbon.identity.event.event.Event;\n+import org.wso2.carbon.identity.event.handler.AbstractEventHandler;\n+import org.wso2.carbon.identity.oauth.OAuthUtil;\n+import org.wso2.carbon.user.core.UserCoreConstants;\n+import org.wso2.carbon.user.core.UserStoreException;\n+import org.wso2.carbon.user.core.UserStoreManager;\n+\n+/**\n+ * This is an event handler listening for some of the core user management operations.\n+ */\n+public class IdentityOauthEventHandler extends AbstractEventHandler {\n+\n+    private static final Log log = LogFactory.getLog(IdentityOauthEventHandler.class);\n+\n+    public String getName() {\n+\n+        return \"identityOauthEventHandler\";\n+    }\n+\n+    public String getFriendlyName() {\n+\n+        return \"Identity Oauth Event Handler\";\n+    }\n+\n+    @Override\n+    public void init(InitConfig configuration) throws IdentityRuntimeException {\n+\n+        super.init(configuration);\n+    }\n+\n+    @Override\n+    public int getPriority(MessageContext messageContext) {\n+\n+        int priority = super.getPriority(messageContext);\n+        if (priority == -1) {\n+            priority = 51;\n+        }\n+        return priority;\n+    }\n+\n+\n+    @Override\n+    public void handleEvent(Event event) throws IdentityEventException {\n+\n+        if (IdentityEventConstants.Event.POST_SET_USER_CLAIMS.equals(event.getEventName())) {", "originalCommit": "a156d1c769148e1d7a739b97ec08ab1b2d0e1445", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjEyODIzOQ==", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1501#discussion_r522128239", "bodyText": "accountlockhandler is listening only to POST_SET_USER_CLAIMS and setting the lock/disable claims https://github.com/wso2-extensions/identity-event-handler-account-lock/blob/master/components/org.wso2.carbon.identity.handler.event.account.lock/src/main/java/org/wso2/carbon/identity/handler/event/account/lock/AccountLockHandler.java#L188.", "author": "piraveena", "createdAt": "2020-11-12T14:03:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjExODQwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjEzOTk2NA==", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1501#discussion_r522139964", "bodyText": "Since IdentityOauthEventHandler.java  is listening to POST_SET_USER_CLAIM event , moved it also to IdentityOauthEventListener.java  as suggested", "author": "piraveena", "createdAt": "2020-11-12T14:19:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjExODQwMQ=="}], "type": "inlineReview", "revised_code": {"commit": "648fa45148b9a49e463760d61a1821b1ffd782e9", "chunk": "diff --git a/components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/listener/IdentityOauthEventHandler.java b/components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/listener/IdentityOauthEventHandler.java\nindex 6d9d4dbc2..b933c8b72 100644\n--- a/components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/listener/IdentityOauthEventHandler.java\n+++ b/components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/listener/IdentityOauthEventHandler.java\n\n@@ -71,7 +71,8 @@ public class IdentityOauthEventHandler extends AbstractEventHandler {\n     @Override\n     public void handleEvent(Event event) throws IdentityEventException {\n \n-        if (IdentityEventConstants.Event.POST_SET_USER_CLAIMS.equals(event.getEventName())) {\n+        if (IdentityEventConstants.Event.POST_SET_USER_CLAIMS.equals(event.getEventName()) ||\n+                IdentityEventConstants.Event.POST_SET_USER_CLAIM.equals(event.getEventName())) {\n             String username = (String) event.getEventProperties().get(IdentityEventConstants.EventProperty.USER_NAME);\n             UserStoreManager userStoreManager =\n                     (UserStoreManager) event.getEventProperties()\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjExOTQ5OA==", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1501#discussion_r522119498", "bodyText": "Isn't this happening in IdentityOauthEventHandler?", "author": "IsuraD", "createdAt": "2020-11-12T13:51:28Z", "path": "components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/listener/IdentityOathEventListener.java", "diffHunk": "@@ -140,9 +130,7 @@ public boolean doPostSetUserClaimValues(String userName, Map<String, String> cla\n         if (!isEnable()) {\n             return true;\n         }\n-        return revokeTokensOfLockedUser(userName, userStoreManager) &&\n-                revokeTokensOfDisabledUser(userName, userStoreManager)\n-                && removeUserClaimsFromCache(userName, userStoreManager);\n+        return OAuthUtil.removeUserClaimsFromCache(userName, userStoreManager);", "originalCommit": "a156d1c769148e1d7a739b97ec08ab1b2d0e1445", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjEyOTc0Mw==", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1501#discussion_r522129743", "bodyText": "fixed it. moved it to IdentityOauthEventHandler", "author": "piraveena", "createdAt": "2020-11-12T14:05:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjExOTQ5OA=="}], "type": "inlineReview", "revised_code": {"commit": "a9fd24f000582a162ddc72e5798ea48b0b1d1988", "chunk": "diff --git a/components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/listener/IdentityOathEventListener.java b/components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/listener/IdentityOathEventListener.java\nindex b12dd1362..4152486ea 100644\n--- a/components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/listener/IdentityOathEventListener.java\n+++ b/components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/listener/IdentityOathEventListener.java\n\n@@ -130,7 +130,7 @@ public class IdentityOathEventListener extends AbstractIdentityUserOperationEven\n         if (!isEnable()) {\n             return true;\n         }\n-        return OAuthUtil.removeUserClaimsFromCache(userName, userStoreManager);\n+        return true;\n     }\n \n     @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjExOTU1Nw==", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1501#discussion_r522119557", "bodyText": "Isn't this happening in IdentityOauthEventHandler?", "author": "IsuraD", "createdAt": "2020-11-12T13:51:34Z", "path": "components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/listener/IdentityOathEventListener.java", "diffHunk": "@@ -130,7 +120,7 @@ public boolean doPostSetUserClaimValue(String userName, UserStoreManager userSto\n         }\n         return revokeTokensOfLockedUser(userName, userStoreManager) &&\n                 revokeTokensOfDisabledUser(userName, userStoreManager)\n-                && removeUserClaimsFromCache(userName, userStoreManager);\n+                && OAuthUtil.removeUserClaimsFromCache(userName, userStoreManager);", "originalCommit": "a156d1c769148e1d7a739b97ec08ab1b2d0e1445", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjEzMTEzMQ==", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1501#discussion_r522131131", "bodyText": "moved it to IdentityOauthEventHandler", "author": "piraveena", "createdAt": "2020-11-12T14:07:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjExOTU1Nw=="}], "type": "inlineReview", "revised_code": {"commit": "648fa45148b9a49e463760d61a1821b1ffd782e9", "chunk": "diff --git a/components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/listener/IdentityOathEventListener.java b/components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/listener/IdentityOathEventListener.java\nindex b12dd1362..7e776b303 100644\n--- a/components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/listener/IdentityOathEventListener.java\n+++ b/components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/listener/IdentityOathEventListener.java\n\n@@ -118,9 +118,7 @@ public class IdentityOathEventListener extends AbstractIdentityUserOperationEven\n         if (!isEnable()) {\n             return true;\n         }\n-        return revokeTokensOfLockedUser(userName, userStoreManager) &&\n-                revokeTokensOfDisabledUser(userName, userStoreManager)\n-                && OAuthUtil.removeUserClaimsFromCache(userName, userStoreManager);\n+        return true;\n     }\n \n     @Override\n"}}, {"oid": "a9fd24f000582a162ddc72e5798ea48b0b1d1988", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/a9fd24f000582a162ddc72e5798ea48b0b1d1988", "message": "Move common methods in EventListner and EventHandler to OAuthUtil", "committedDate": "2020-11-12T14:04:21Z", "type": "forcePushed"}, {"oid": "648fa45148b9a49e463760d61a1821b1ffd782e9", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/648fa45148b9a49e463760d61a1821b1ffd782e9", "message": "Move common methods in EventListner and EventHandler to OAuthUtil", "committedDate": "2020-11-12T14:11:01Z", "type": "commit"}, {"oid": "648fa45148b9a49e463760d61a1821b1ffd782e9", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/648fa45148b9a49e463760d61a1821b1ffd782e9", "message": "Move common methods in EventListner and EventHandler to OAuthUtil", "committedDate": "2020-11-12T14:11:01Z", "type": "forcePushed"}]}