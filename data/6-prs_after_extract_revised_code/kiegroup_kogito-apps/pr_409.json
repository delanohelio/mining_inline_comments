{"pr_number": 409, "pr_title": "KOGITO-3156 fix integration tests broken for Quarkus", "pr_createdAt": "2020-08-21T14:28:44Z", "pr_url": "https://github.com/kiegroup/kogito-apps/pull/409", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM2MzUyNQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/409#discussion_r475363525", "bodyText": "Is this part of the fix? It seems unrelated.", "author": "Sgitario", "createdAt": "2020-08-24T06:13:51Z", "path": "integration-tests/integration-tests-common/src/main/java/org/kie/kogito/testcontainers/JobServiceContainer.java", "diffHunk": "@@ -36,11 +36,13 @@\n     public static final String IMAGE = \"container.image.\" + NAME;\n     private static final Logger LOGGER = LoggerFactory.getLogger(JobServiceContainer.class);\n \n-    public JobServiceContainer() {\n+    @Override\n+    public void start() {\n         addExposedPort(PORT);\n         withLogConsumer(new Slf4jLogConsumer(LOGGER));\n         waitingFor(Wait.forLogMessage(\".*Listening on:.*\", 1));\n         setDockerImageName(getImageName());\n+        super.start();", "originalCommit": "3b4a165411d266fe838f27d6f87d18d5fd5ea524", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY0NzY1NA==", "url": "https://github.com/kiegroup/kogito-apps/pull/409#discussion_r476647654", "bodyText": "rolled back since it didn't work.", "author": "tiagodolphine", "createdAt": "2020-08-25T18:18:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM2MzUyNQ=="}], "type": "inlineReview", "revised_code": {"commit": "f8910608c91b41a7257a2f13eb0dcbd41454eec2", "chunk": "diff --git a/integration-tests/integration-tests-common/src/main/java/org/kie/kogito/testcontainers/JobServiceContainer.java b/integration-tests/integration-tests-common/src/main/java/org/kie/kogito/testcontainers/JobServiceContainer.java\nindex 4e17a244..cb2aa34a 100644\n--- a/integration-tests/integration-tests-common/src/main/java/org/kie/kogito/testcontainers/JobServiceContainer.java\n+++ b/integration-tests/integration-tests-common/src/main/java/org/kie/kogito/testcontainers/JobServiceContainer.java\n\n@@ -36,13 +36,11 @@ public class JobServiceContainer extends GenericContainer<JobServiceContainer> i\n     public static final String IMAGE = \"container.image.\" + NAME;\n     private static final Logger LOGGER = LoggerFactory.getLogger(JobServiceContainer.class);\n \n-    @Override\n-    public void start() {\n+    public JobServiceContainer() {\n         addExposedPort(PORT);\n         withLogConsumer(new Slf4jLogConsumer(LOGGER));\n         waitingFor(Wait.forLogMessage(\".*Listening on:.*\", 1));\n         setDockerImageName(getImageName());\n-        super.start();\n     }\n \n     @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM2NDE0Mw==", "url": "https://github.com/kiegroup/kogito-apps/pull/409#discussion_r475364143", "bodyText": "What about we want to integrate jobs service with data index or infinispan? I think we should think a value here where we can still configure all the containers accordingly.\nAlso, we can do this once we need it.", "author": "Sgitario", "createdAt": "2020-08-24T06:15:27Z", "path": "integration-tests/integration-tests-quarkus/src/test/java/org/kie/kogito/resources/KogitoServiceRandomPortQuarkusTestResource.java", "diffHunk": "@@ -25,6 +25,13 @@ public KogitoServiceRandomPortQuarkusTestResource() {\n         super(new KogitoServiceRandomPortTestResource());\n     }\n \n+    @Override\n+    public int order() {\n+        //Guarantee it will be executed before other test resources that depends on this to set the\n+        //Testcontainers.exposeHostPorts(httpPort), see KogitoServiceRandomPortTestResource.start()\n+        return Integer.MIN_VALUE;", "originalCommit": "3b4a165411d266fe838f27d6f87d18d5fd5ea524", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTUzODg5NQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/409#discussion_r475538895", "bodyText": "yeah, we could have some way to control the order the test resources are initialized, for now, the only restriction we have when setting the Testcontainers.exposeHostPorts it should be done before the container starts.", "author": "tiagodolphine", "createdAt": "2020-08-24T11:39:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM2NDE0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY0Nzc0NQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/409#discussion_r476647745", "bodyText": "rolled back since it didn't work.", "author": "tiagodolphine", "createdAt": "2020-08-25T18:18:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM2NDE0Mw=="}], "type": "inlineReview", "revised_code": {"commit": "f8910608c91b41a7257a2f13eb0dcbd41454eec2", "chunk": "diff --git a/integration-tests/integration-tests-quarkus/src/test/java/org/kie/kogito/resources/KogitoServiceRandomPortQuarkusTestResource.java b/integration-tests/integration-tests-quarkus/src/test/java/org/kie/kogito/resources/KogitoServiceRandomPortQuarkusTestResource.java\nindex 632c0b71..dc139031 100644\n--- a/integration-tests/integration-tests-quarkus/src/test/java/org/kie/kogito/resources/KogitoServiceRandomPortQuarkusTestResource.java\n+++ b/integration-tests/integration-tests-quarkus/src/test/java/org/kie/kogito/resources/KogitoServiceRandomPortQuarkusTestResource.java\n\n@@ -25,13 +25,6 @@ public class KogitoServiceRandomPortQuarkusTestResource extends ConditionalQuark\n         super(new KogitoServiceRandomPortTestResource());\n     }\n \n-    @Override\n-    public int order() {\n-        //Guarantee it will be executed before other test resources that depends on this to set the\n-        //Testcontainers.exposeHostPorts(httpPort), see KogitoServiceRandomPortTestResource.start()\n-        return Integer.MIN_VALUE;\n-    }\n-\n     @Override\n     protected String getKogitoProperty() {\n         return QUARKUS_SERVICE_HTTP_PORT;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjM5ODY0MQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/409#discussion_r476398641", "bodyText": "If we want to prevent super.start() execution, what about a comment here to mention the reason?", "author": "danielezonca", "createdAt": "2020-08-25T12:10:14Z", "path": "integration-tests/integration-tests-common/src/main/java/org/kie/kogito/it/KogitoServiceRandomPortTestResource.java", "diffHunk": "@@ -32,17 +32,25 @@ public String getResourceName() {\n         return NAME;\n     }\n \n-    @Override\n-    public void start() {\n+    public KogitoServiceRandomPortTestResource() {\n+        initialize();\n+    }\n+\n+    //The port should be set and Testcontainers.exposeHostPorts should be called before the this.start() method, in\n+    // this way the container is able to resolve hostname for the host (running the test) otherwise it won't work.\n+    private void initialize() {\n         httpPort = SocketUtils.findAvailablePort();\n-        //Container should have access the host port where the test is running\n-        //It should be called be fore the container is instantiated\n         Testcontainers.exposeHostPorts(httpPort);\n         //the hostname for the container to access the host is \"host.testcontainers.internal\"\n         //https://www.testcontainers.org/features/networking/#exposing-host-ports-to-the-container\n         System.setProperty(KOGITO_SERVICE_URL, \"http://host.testcontainers.internal:\" + httpPort);\n     }\n \n+    @Override\n+    public void start() {\n+", "originalCommit": "ba3c4360e1c0b0d86ceb8f3f4c88b1fa436f6303", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY0NzAzNg==", "url": "https://github.com/kiegroup/kogito-apps/pull/409#discussion_r476647036", "bodyText": "the start() needs to be implemented because it is from the interface TestResource, basically, there is no super.start(), I moved the initialization of the port to the constructor inserted of the start() method.", "author": "tiagodolphine", "createdAt": "2020-08-25T18:17:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjM5ODY0MQ=="}], "type": "inlineReview", "revised_code": {"commit": "63b74dda197f3c72d086c8a9a0e8e0d6f6252d62", "chunk": "diff --git a/integration-tests/integration-tests-common/src/main/java/org/kie/kogito/it/KogitoServiceRandomPortTestResource.java b/integration-tests/integration-tests-common/src/main/java/org/kie/kogito/it/KogitoServiceRandomPortTestResource.java\nindex 0dcd66d5..ddab4d62 100644\n--- a/integration-tests/integration-tests-common/src/main/java/org/kie/kogito/it/KogitoServiceRandomPortTestResource.java\n+++ b/integration-tests/integration-tests-common/src/main/java/org/kie/kogito/it/KogitoServiceRandomPortTestResource.java\n\n@@ -32,25 +32,17 @@ public class KogitoServiceRandomPortTestResource implements TestResource {\n         return NAME;\n     }\n \n-    public KogitoServiceRandomPortTestResource() {\n-        initialize();\n-    }\n-\n-    //The port should be set and Testcontainers.exposeHostPorts should be called before the this.start() method, in\n-    // this way the container is able to resolve hostname for the host (running the test) otherwise it won't work.\n-    private void initialize() {\n+    @Override\n+    public void start() {\n         httpPort = SocketUtils.findAvailablePort();\n+        //Container should have access the host port where the test is running\n+        //It should be called be fore the container is instantiated\n         Testcontainers.exposeHostPorts(httpPort);\n         //the hostname for the container to access the host is \"host.testcontainers.internal\"\n         //https://www.testcontainers.org/features/networking/#exposing-host-ports-to-the-container\n         System.setProperty(KOGITO_SERVICE_URL, \"http://host.testcontainers.internal:\" + httpPort);\n     }\n \n-    @Override\n-    public void start() {\n-\n-    }\n-\n     @Override\n     public void stop() {\n \n"}}, {"oid": "63b74dda197f3c72d086c8a9a0e8e0d6f6252d62", "url": "https://github.com/kiegroup/kogito-apps/commit/63b74dda197f3c72d086c8a9a0e8e0d6f6252d62", "message": "KOGITO-3156 fix integration tests broken for Quarkus", "committedDate": "2020-08-25T13:56:11Z", "type": "commit"}, {"oid": "f8910608c91b41a7257a2f13eb0dcbd41454eec2", "url": "https://github.com/kiegroup/kogito-apps/commit/f8910608c91b41a7257a2f13eb0dcbd41454eec2", "message": "Fix the  Testcontainers.exposeHostPorts(httpPort) call, to be in the constructor instead start() in this way the Container is resolving properly the hostname", "committedDate": "2020-08-25T13:56:12Z", "type": "commit"}, {"oid": "869edde1fd848c35f27b591e4037e863932339a8", "url": "https://github.com/kiegroup/kogito-apps/commit/869edde1fd848c35f27b591e4037e863932339a8", "message": "Copy process resources into src/main/resources on quarkus integration-tests", "committedDate": "2020-08-25T18:12:49Z", "type": "commit"}, {"oid": "869edde1fd848c35f27b591e4037e863932339a8", "url": "https://github.com/kiegroup/kogito-apps/commit/869edde1fd848c35f27b591e4037e863932339a8", "message": "Copy process resources into src/main/resources on quarkus integration-tests", "committedDate": "2020-08-25T18:12:49Z", "type": "forcePushed"}]}