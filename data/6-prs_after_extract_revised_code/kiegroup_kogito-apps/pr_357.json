{"pr_number": 357, "pr_title": "FAI-240: Model definition endpoint - trusty-service", "pr_createdAt": "2020-07-31T14:03:41Z", "pr_url": "https://github.com/kiegroup/kogito-apps/pull/357", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzY3NjcxOQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/357#discussion_r463676719", "bodyText": "I think it could be protected or even private so we can avoid unexpected usages :)", "author": "danielezonca", "createdAt": "2020-07-31T15:25:00Z", "path": "trusty/trusty-service/src/main/java/org/kie/kogito/trusty/service/messaging/ModelEventConsumer.java", "diffHunk": "@@ -0,0 +1,86 @@\n+/*\n+ *  Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *        http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+\n+package org.kie.kogito.trusty.service.messaging;\n+\n+import java.util.Optional;\n+import java.util.concurrent.CompletionStage;\n+\n+import javax.enterprise.context.ApplicationScoped;\n+import javax.inject.Inject;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import io.cloudevents.v1.AttributesImpl;\n+import io.cloudevents.v1.CloudEventImpl;\n+import org.eclipse.microprofile.reactive.messaging.Incoming;\n+import org.eclipse.microprofile.reactive.messaging.Message;\n+import org.kie.kogito.decision.DecisionModelType;\n+import org.kie.kogito.tracing.decision.event.model.ModelEvent;\n+import org.kie.kogito.trusty.service.ITrustyService;\n+\n+@ApplicationScoped\n+public class ModelEventConsumer extends BaseEventConsumer<ModelEvent> {\n+\n+    private static final TypeReference<CloudEventImpl<ModelEvent>> CLOUD_EVENT_TYPE_REF = new TypeReference<>() {\n+    };\n+\n+    public ModelEventConsumer() {", "originalCommit": "35104de4cc2f7203fc2b3bad70a5f46b0780c098", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzgzODAyOQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/357#discussion_r463838029", "bodyText": "Done.", "author": "manstis", "createdAt": "2020-07-31T21:01:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzY3NjcxOQ=="}], "type": "inlineReview", "revised_code": {"commit": "35eedeb6cc57dc087dc002aab33fe4017d4b617c", "chunk": "diff --git a/trusty/trusty-service/src/main/java/org/kie/kogito/trusty/service/messaging/ModelEventConsumer.java b/trusty/trusty-service/src/main/java/org/kie/kogito/trusty/service/messaging/ModelEventConsumer.java\nindex 81aad4ba..446bbcb9 100644\n--- a/trusty/trusty-service/src/main/java/org/kie/kogito/trusty/service/messaging/ModelEventConsumer.java\n+++ b/trusty/trusty-service/src/main/java/org/kie/kogito/trusty/service/messaging/ModelEventConsumer.java\n\n@@ -28,37 +28,47 @@ import io.cloudevents.v1.CloudEventImpl;\n import org.eclipse.microprofile.reactive.messaging.Incoming;\n import org.eclipse.microprofile.reactive.messaging.Message;\n import org.kie.kogito.decision.DecisionModelType;\n+import org.kie.kogito.tracing.decision.event.CloudEventUtils;\n import org.kie.kogito.tracing.decision.event.model.ModelEvent;\n import org.kie.kogito.trusty.service.ITrustyService;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n \n @ApplicationScoped\n-public class ModelEventConsumer extends BaseEventConsumer<ModelEvent> {\n+public class ModelEventConsumer {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(ModelEventConsumer.class);\n \n     private static final TypeReference<CloudEventImpl<ModelEvent>> CLOUD_EVENT_TYPE_REF = new TypeReference<>() {\n     };\n \n-    public ModelEventConsumer() {\n-        //CDI proxy\n-    }\n+    private final ITrustyService service;\n \n     @Inject\n     public ModelEventConsumer(final ITrustyService service) {\n-        super(service);\n+        this.service = service;\n     }\n \n-    @Override\n     @Incoming(\"kogito-tracing-model\")\n     public CompletionStage<Void> handleMessage(final Message<String> message) {\n-        return super.handleMessage(message);\n+        try {\n+            decodeCloudEvent(message.getPayload()).ifPresent(this::handleCloudEvent);\n+        } catch (Exception e) {\n+            LOG.error(\"Something unexpected happened during the processing of a ModelEvent. The event is discarded.\", e);\n+        }\n+        return message.ack();\n     }\n \n-    @Override\n-    protected TypeReference<CloudEventImpl<ModelEvent>> getCloudEventType() {\n-        return CLOUD_EVENT_TYPE_REF;\n+    private Optional<CloudEventImpl<ModelEvent>> decodeCloudEvent(final String payload) {\n+        try {\n+            return Optional.of(CloudEventUtils.decode(payload, CLOUD_EVENT_TYPE_REF));\n+        } catch (IllegalStateException e) {\n+            LOG.error(String.format(\"Can't decode message to CloudEvent: %s\", payload), e);\n+            return Optional.empty();\n+        }\n     }\n \n-    @Override\n-    protected void handleCloudEvent(final CloudEventImpl<ModelEvent> cloudEvent) {\n+    private void handleCloudEvent(final CloudEventImpl<ModelEvent> cloudEvent) {\n         final AttributesImpl attributes = cloudEvent.getAttributes();\n         final Optional<ModelEvent> optData = cloudEvent.getData();\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzY3NzAzNw==", "url": "https://github.com/kiegroup/kogito-apps/pull/357#discussion_r463677037", "bodyText": "Same as above", "author": "danielezonca", "createdAt": "2020-07-31T15:25:31Z", "path": "trusty/trusty-service/src/main/java/org/kie/kogito/trusty/service/messaging/TraceEventConsumer.java", "diffHunk": "@@ -27,49 +27,38 @@\n import io.cloudevents.v1.CloudEventImpl;\n import org.eclipse.microprofile.reactive.messaging.Incoming;\n import org.eclipse.microprofile.reactive.messaging.Message;\n-import org.kie.kogito.tracing.decision.event.CloudEventUtils;\n import org.kie.kogito.tracing.decision.event.trace.TraceEvent;\n import org.kie.kogito.tracing.decision.event.trace.TraceEventType;\n import org.kie.kogito.trusty.service.ITrustyService;\n-import org.slf4j.Logger;\n-import org.slf4j.LoggerFactory;\n \n @ApplicationScoped\n-public class TraceEventConsumer {\n-\n-    private static final Logger LOG = LoggerFactory.getLogger(TraceEventConsumer.class);\n+public class TraceEventConsumer extends BaseEventConsumer<TraceEvent> {\n \n     private static final TypeReference<CloudEventImpl<TraceEvent>> CLOUD_EVENT_TYPE_REF = new TypeReference<>() {\n     };\n \n-    private final ITrustyService service;\n+    public TraceEventConsumer() {", "originalCommit": "35104de4cc2f7203fc2b3bad70a5f46b0780c098", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzgzODEzMA==", "url": "https://github.com/kiegroup/kogito-apps/pull/357#discussion_r463838130", "bodyText": "Done.", "author": "manstis", "createdAt": "2020-07-31T21:01:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzY3NzAzNw=="}], "type": "inlineReview", "revised_code": {"commit": "35eedeb6cc57dc087dc002aab33fe4017d4b617c", "chunk": "diff --git a/trusty/trusty-service/src/main/java/org/kie/kogito/trusty/service/messaging/TraceEventConsumer.java b/trusty/trusty-service/src/main/java/org/kie/kogito/trusty/service/messaging/TraceEventConsumer.java\nindex 1ceeedb3..cbcc50a5 100644\n--- a/trusty/trusty-service/src/main/java/org/kie/kogito/trusty/service/messaging/TraceEventConsumer.java\n+++ b/trusty/trusty-service/src/main/java/org/kie/kogito/trusty/service/messaging/TraceEventConsumer.java\n\n@@ -27,38 +27,49 @@ import io.cloudevents.v1.AttributesImpl;\n import io.cloudevents.v1.CloudEventImpl;\n import org.eclipse.microprofile.reactive.messaging.Incoming;\n import org.eclipse.microprofile.reactive.messaging.Message;\n+import org.kie.kogito.tracing.decision.event.CloudEventUtils;\n import org.kie.kogito.tracing.decision.event.trace.TraceEvent;\n import org.kie.kogito.tracing.decision.event.trace.TraceEventType;\n import org.kie.kogito.trusty.service.ITrustyService;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n \n @ApplicationScoped\n-public class TraceEventConsumer extends BaseEventConsumer<TraceEvent> {\n+public class TraceEventConsumer {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(TraceEventConsumer.class);\n \n     private static final TypeReference<CloudEventImpl<TraceEvent>> CLOUD_EVENT_TYPE_REF = new TypeReference<>() {\n     };\n \n-    public TraceEventConsumer() {\n-        //CDI proxy\n-    }\n+    private final ITrustyService service;\n \n     @Inject\n     public TraceEventConsumer(ITrustyService service) {\n-        super(service);\n+        this.service = service;\n     }\n \n-    @Override\n     @Incoming(\"kogito-tracing\")\n     public CompletionStage<Void> handleMessage(Message<String> message) {\n-        return super.handleMessage(message);\n+        try {\n+            decodeCloudEvent(message.getPayload()).ifPresent(this::handleCloudEvent);\n+        }\n+        catch(Exception e){\n+            LOG.error(\"Something unexpected happened during the processing of a TraceEvent. The event is discarded.\", e);\n+        }\n+        return message.ack();\n     }\n \n-    @Override\n-    protected TypeReference<CloudEventImpl<TraceEvent>> getCloudEventType() {\n-        return CLOUD_EVENT_TYPE_REF;\n+    private Optional<CloudEventImpl<TraceEvent>> decodeCloudEvent(String payload) {\n+        try {\n+            return Optional.of(CloudEventUtils.decode(payload, CLOUD_EVENT_TYPE_REF));\n+        } catch (IllegalStateException e) {\n+            LOG.error(String.format(\"Can't decode message to CloudEvent: %s\", payload), e);\n+            return Optional.empty();\n+        }\n     }\n \n-    @Override\n-    protected void handleCloudEvent(CloudEventImpl<TraceEvent> cloudEvent) {\n+    private void handleCloudEvent(CloudEventImpl<TraceEvent> cloudEvent) {\n         AttributesImpl attributes = cloudEvent.getAttributes();\n         Optional<TraceEvent> optData = cloudEvent.getData();\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg0MDg5MA==", "url": "https://github.com/kiegroup/kogito-apps/pull/357#discussion_r463840890", "bodyText": "Simple enough; but I put it in a separate class to (1) be consistent, (2) in case it becomes more complex later.", "author": "manstis", "createdAt": "2020-07-31T21:05:06Z", "path": "trusty/trusty-service/src/main/java/org/kie/kogito/trusty/service/messaging/ModelEventConverter.java", "diffHunk": "@@ -0,0 +1,29 @@\n+/*\n+ *  Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *        http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+\n+package org.kie.kogito.trusty.service.messaging;\n+\n+import org.kie.kogito.tracing.decision.event.model.ModelEvent;\n+\n+public class ModelEventConverter {\n+\n+    public static String toModel(final ModelEvent event) {\n+        return event.getDefinition();", "originalCommit": "41bedc71d93b73516cb627f7b8ace9ebc6faa3d8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "35eedeb6cc57dc087dc002aab33fe4017d4b617c", "url": "https://github.com/kiegroup/kogito-apps/commit/35eedeb6cc57dc087dc002aab33fe4017d4b617c", "message": "FAI-240: Model definition endpoint - trusty-service", "committedDate": "2020-08-03T20:08:20Z", "type": "commit"}, {"oid": "0073dfa06b7c537c7eb0e5e448b8c6c2bf6d8328", "url": "https://github.com/kiegroup/kogito-apps/commit/0073dfa06b7c537c7eb0e5e448b8c6c2bf6d8328", "message": "Refactor to common BaseEventConsumer class..", "committedDate": "2020-08-03T20:08:20Z", "type": "commit"}, {"oid": "76f314e6f60c44746463a8b6c980a30aaeb2de32", "url": "https://github.com/kiegroup/kogito-apps/commit/76f314e6f60c44746463a8b6c980a30aaeb2de32", "message": "Make zero parameter constructors private following peer review.", "committedDate": "2020-08-03T20:08:20Z", "type": "commit"}, {"oid": "c0fd8b569eae297f5cb66f72f1d5534baa071cdd", "url": "https://github.com/kiegroup/kogito-apps/commit/c0fd8b569eae297f5cb66f72f1d5534baa071cdd", "message": "Increase test coverage", "committedDate": "2020-08-03T20:08:21Z", "type": "commit"}, {"oid": "c0fd8b569eae297f5cb66f72f1d5534baa071cdd", "url": "https://github.com/kiegroup/kogito-apps/commit/c0fd8b569eae297f5cb66f72f1d5534baa071cdd", "message": "Increase test coverage", "committedDate": "2020-08-03T20:08:21Z", "type": "forcePushed"}]}