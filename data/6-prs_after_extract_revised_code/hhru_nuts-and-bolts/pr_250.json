{"pr_number": 250, "pr_title": "HH-112089 do not start kafka consumer if found unused properties", "pr_createdAt": "2020-07-02T11:54:07Z", "pr_url": "https://github.com/hhru/nuts-and-bolts/pull/250", "timeline": [{"oid": "1f3321e99e2b0039374bbb31661fc61230b14296", "url": "https://github.com/hhru/nuts-and-bolts/commit/1f3321e99e2b0039374bbb31661fc61230b14296", "message": "HH-112089 do not start kafka consumer if found unused properties", "committedDate": "2020-07-02T11:50:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk1MzMwMQ==", "url": "https://github.com/hhru/nuts-and-bolts/pull/250#discussion_r448953301", "bodyText": "String::cast \u0442\u0443\u0442 \u0441\u0440\u0430\u0431\u043e\u0442\u0430\u0435\u0442?", "author": "bokshitsky", "createdAt": "2020-07-02T12:06:37Z", "path": "nab-kafka/src/main/java/ru/hh/nab/kafka/util/ConfigProvider.java", "diffHunk": "@@ -90,9 +94,26 @@ private void checkConfig(FileSettings nabConsumerSettings, FileSettings allConsu\n   }\n \n   private Map<String, Object> getTopicOverriddenConsumerProperties(String topicName) {\n+    findAnyMatchedKey(String.format(\n+        TOPIC_CONSUMER_INVALID_CONFIG_REGEXP_TEMPLATE, kafkaClusterName, topicName))\n+        .ifPresent(key -> {\n+          throw new IllegalArgumentException(\n+              String.format(\"Unused property found: '%s'\", key)\n+          );\n+        });\n     return getConfigAsMap(String.format(TOPIC_CONSUMER_CONFIG_TEMPLATE, kafkaClusterName, topicName));\n   }\n \n+  private Optional<String> findAnyMatchedKey(String pattern) {\n+    Pattern compiledPattern = Pattern.compile(pattern);\n+    return fileSettings.getProperties().keySet()\n+        .stream()\n+        .filter(String.class::isInstance)\n+        .map(key -> (String) key)", "originalCommit": "1f3321e99e2b0039374bbb31661fc61230b14296", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk1MzkwMw==", "url": "https://github.com/hhru/nuts-and-bolts/pull/250#discussion_r448953903", "bodyText": "\u0441\u0440\u0430\u0431\u043e\u0442\u0430\u0435\u0442, \u043d\u043e \u0442\u0430\u043c \u0432\u043d\u0443\u0442\u0440\u0438 \u043e\u043f\u044f\u0442\u044c \u0431\u0443\u0434\u0435\u0442 isInstance. \u0437\u0430\u0448\u043a\u0432\u0430\u0440\u043d\u043e \u043f\u043e\u043b\u0443\u0447\u0430\u0435\u0442\u0441\u044f", "author": "alexeydubinin", "createdAt": "2020-07-02T12:07:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk1MzMwMQ=="}], "type": "inlineReview", "revised_code": {"commit": "adea320f03d9c7a4cc6d596165c189a95d8e4500", "chunk": "diff --git a/nab-kafka/src/main/java/ru/hh/nab/kafka/util/ConfigProvider.java b/nab-kafka/src/main/java/ru/hh/nab/kafka/util/ConfigProvider.java\nindex 1cea1211..f3588035 100644\n--- a/nab-kafka/src/main/java/ru/hh/nab/kafka/util/ConfigProvider.java\n+++ b/nab-kafka/src/main/java/ru/hh/nab/kafka/util/ConfigProvider.java\n\n@@ -87,6 +88,18 @@ public class ConfigProvider {\n           String.format(\"'%s' should not be larger then '%s'\", BACKOFF_MAX_INTERVAL_NAME, MAX_POLL_INTERVAL_MS_CONFIG)\n       );\n     }\n+    checkNames(allConsumerSettings);\n+  }\n+\n+  void checkNames(FileSettings allConsumerSettings) {\n+    Set<String> supportedNames = ConsumerConfig.configNames();\n+    allConsumerSettings.getProperties().keySet().forEach(key -> {\n+      if (!supportedNames.contains(key)) {\n+        throw new IllegalArgumentException(\n+            String.format(\"Unsupported kafka consumer property found: '%s'\", key)\n+        );\n+      }\n+    });\n   }\n \n   private Map<String, Object> getDefaultConsumerProperties() {\n"}}, {"oid": "adea320f03d9c7a4cc6d596165c189a95d8e4500", "url": "https://github.com/hhru/nuts-and-bolts/commit/adea320f03d9c7a4cc6d596165c189a95d8e4500", "message": "HH-112089 do not start kafka consumer if found unsupported properties", "committedDate": "2020-07-02T12:48:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk3Nzk3Ng==", "url": "https://github.com/hhru/nuts-and-bolts/pull/250#discussion_r448977976", "bodyText": "checkNames \u043c\u043e\u0436\u043d\u043e \u043f\u0440\u0438\u0432\u0430\u0442\u043d\u044b\u043c \u0441\u0434\u0435\u043b\u0430\u0442\u044c", "author": "bokshitsky", "createdAt": "2020-07-02T12:51:53Z", "path": "nab-kafka/src/main/java/ru/hh/nab/kafka/util/ConfigProvider.java", "diffHunk": "@@ -83,16 +88,45 @@ private void checkConfig(FileSettings nabConsumerSettings, FileSettings allConsu\n           String.format(\"'%s' should not be larger then '%s'\", BACKOFF_MAX_INTERVAL_NAME, MAX_POLL_INTERVAL_MS_CONFIG)\n       );\n     }\n+    checkNames(allConsumerSettings);\n+  }\n+\n+  void checkNames(FileSettings allConsumerSettings) {", "originalCommit": "adea320f03d9c7a4cc6d596165c189a95d8e4500", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk3ODczMA==", "url": "https://github.com/hhru/nuts-and-bolts/pull/250#discussion_r448978730", "bodyText": "\u0432 defense \u0441\u043b\u0443\u0436\u0438\u043b \u0447\u0442\u043e\u043b\u0438, \u043e\u043a)", "author": "alexeydubinin", "createdAt": "2020-07-02T12:53:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk3Nzk3Ng=="}], "type": "inlineReview", "revised_code": {"commit": "ecc29c059011fabc1a3d0d94ce1822b6ea6fff85", "chunk": "diff --git a/nab-kafka/src/main/java/ru/hh/nab/kafka/util/ConfigProvider.java b/nab-kafka/src/main/java/ru/hh/nab/kafka/util/ConfigProvider.java\nindex f3588035..c1b3001b 100644\n--- a/nab-kafka/src/main/java/ru/hh/nab/kafka/util/ConfigProvider.java\n+++ b/nab-kafka/src/main/java/ru/hh/nab/kafka/util/ConfigProvider.java\n\n@@ -91,15 +95,20 @@ public class ConfigProvider {\n     checkNames(allConsumerSettings);\n   }\n \n-  void checkNames(FileSettings allConsumerSettings) {\n+  private static void checkNames(FileSettings allConsumerSettings) {\n     Set<String> supportedNames = ConsumerConfig.configNames();\n-    allConsumerSettings.getProperties().keySet().forEach(key -> {\n-      if (!supportedNames.contains(key)) {\n-        throw new IllegalArgumentException(\n-            String.format(\"Unsupported kafka consumer property found: '%s'\", key)\n-        );\n-      }\n-    });\n+    List<String> invalidNames = allConsumerSettings.getProperties().keySet()\n+        .stream()\n+        .filter(NAB_SETTING_PREDICATE.negate())\n+        .filter(key -> !supportedNames.contains(key))\n+        .map(String::valueOf)\n+        .collect(Collectors.toList());\n+\n+    if (!invalidNames.isEmpty()) {\n+      throw new IllegalArgumentException(\n+          String.format(\"Unsupported kafka consumer properties found: '%s'\", String.join(\", \", invalidNames))\n+      );\n+    }\n   }\n \n   private Map<String, Object> getDefaultConsumerProperties() {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk3ODM3NA==", "url": "https://github.com/hhru/nuts-and-bolts/pull/250#discussion_r448978374", "bodyText": "\u0414\u0443\u043c\u0430\u044e, \u043b\u0443\u0447\u0448\u0435 \u0430\u0433\u0440\u0435\u0433\u0438\u0440\u043e\u0432\u0430\u0442\u044c \u0432\u0441\u0435 \u043a\u043b\u044e\u0447\u0438 \u043d\u0435\u043a\u043e\u0440\u0440\u0435\u043a\u0442\u043d\u044b\u0435 \u0438 \u0432 \u043e\u0448\u0438\u0431\u043a\u0435 \u0438\u0445 \u0431\u0440\u043e\u0441\u0438\u0442\u044c, \u0447\u0435\u0440\u0435\u0437 \u0437\u0430\u043f\u044f\u0442\u0443\u044e", "author": "bokshitsky", "createdAt": "2020-07-02T12:52:26Z", "path": "nab-kafka/src/main/java/ru/hh/nab/kafka/util/ConfigProvider.java", "diffHunk": "@@ -83,16 +88,45 @@ private void checkConfig(FileSettings nabConsumerSettings, FileSettings allConsu\n           String.format(\"'%s' should not be larger then '%s'\", BACKOFF_MAX_INTERVAL_NAME, MAX_POLL_INTERVAL_MS_CONFIG)\n       );\n     }\n+    checkNames(allConsumerSettings);\n+  }\n+\n+  void checkNames(FileSettings allConsumerSettings) {\n+    Set<String> supportedNames = ConsumerConfig.configNames();\n+    allConsumerSettings.getProperties().keySet().forEach(key -> {\n+      if (!supportedNames.contains(key)) {", "originalCommit": "adea320f03d9c7a4cc6d596165c189a95d8e4500", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk4MDIzOQ==", "url": "https://github.com/hhru/nuts-and-bolts/pull/250#discussion_r448980239", "bodyText": "\u043e\u043a", "author": "alexeydubinin", "createdAt": "2020-07-02T12:55:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk3ODM3NA=="}], "type": "inlineReview", "revised_code": {"commit": "ecc29c059011fabc1a3d0d94ce1822b6ea6fff85", "chunk": "diff --git a/nab-kafka/src/main/java/ru/hh/nab/kafka/util/ConfigProvider.java b/nab-kafka/src/main/java/ru/hh/nab/kafka/util/ConfigProvider.java\nindex f3588035..c1b3001b 100644\n--- a/nab-kafka/src/main/java/ru/hh/nab/kafka/util/ConfigProvider.java\n+++ b/nab-kafka/src/main/java/ru/hh/nab/kafka/util/ConfigProvider.java\n\n@@ -91,15 +95,20 @@ public class ConfigProvider {\n     checkNames(allConsumerSettings);\n   }\n \n-  void checkNames(FileSettings allConsumerSettings) {\n+  private static void checkNames(FileSettings allConsumerSettings) {\n     Set<String> supportedNames = ConsumerConfig.configNames();\n-    allConsumerSettings.getProperties().keySet().forEach(key -> {\n-      if (!supportedNames.contains(key)) {\n-        throw new IllegalArgumentException(\n-            String.format(\"Unsupported kafka consumer property found: '%s'\", key)\n-        );\n-      }\n-    });\n+    List<String> invalidNames = allConsumerSettings.getProperties().keySet()\n+        .stream()\n+        .filter(NAB_SETTING_PREDICATE.negate())\n+        .filter(key -> !supportedNames.contains(key))\n+        .map(String::valueOf)\n+        .collect(Collectors.toList());\n+\n+    if (!invalidNames.isEmpty()) {\n+      throw new IllegalArgumentException(\n+          String.format(\"Unsupported kafka consumer properties found: '%s'\", String.join(\", \", invalidNames))\n+      );\n+    }\n   }\n \n   private Map<String, Object> getDefaultConsumerProperties() {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk4NTIwNg==", "url": "https://github.com/hhru/nuts-and-bolts/pull/250#discussion_r448985206", "bodyText": "\u0430 \u0442\u0435\u0441\u0442\u044b \u0441\u0432\u0435\u0440\u0445\u0443 \u0432\u043e\u043e\u0431\u0449\u0435 \u0440\u0430\u0431\u043e\u0442\u0430\u044e\u0442?", "author": "SCREEN88", "createdAt": "2020-07-02T13:03:11Z", "path": "nab-kafka/src/test/java/ru/hh/nab/kafka/util/ConfigProviderTest.java", "diffHunk": "@@ -70,6 +71,40 @@ public void shouldReturnOverriddenConsumerSettingForSpecificTopic() {\n     assertEquals(defaultValue, result.get(testKey));\n   }\n \n+  @Test\n+  public void shouldFailOnUnusedOverriddenConsumerSettingForSpecificTopic() {", "originalCommit": "adea320f03d9c7a4cc6d596165c189a95d8e4500", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk4NTczNQ==", "url": "https://github.com/hhru/nuts-and-bolts/pull/250#discussion_r448985735", "bodyText": "\u0440\u0430\u0431\u043e\u0442\u0430\u044e\u0442", "author": "alexeydubinin", "createdAt": "2020-07-02T13:04:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk4NTIwNg=="}], "type": "inlineReview", "revised_code": {"commit": "ecc29c059011fabc1a3d0d94ce1822b6ea6fff85", "chunk": "diff --git a/nab-kafka/src/test/java/ru/hh/nab/kafka/util/ConfigProviderTest.java b/nab-kafka/src/test/java/ru/hh/nab/kafka/util/ConfigProviderTest.java\nindex 4f845936..4c37c8bc 100644\n--- a/nab-kafka/src/test/java/ru/hh/nab/kafka/util/ConfigProviderTest.java\n+++ b/nab-kafka/src/test/java/ru/hh/nab/kafka/util/ConfigProviderTest.java\n\n@@ -92,17 +92,18 @@ public class ConfigProviderTest {\n \n   @Test\n   public void shouldFailOnUnsupportedConsumerSetting() {\n-    String testKey = \"invalidKey\";\n     String defaultValue = \"value\";\n     String topicName = \"topic\";\n     FileSettings fileSettings = createFileSettings(Map.of(\n-        generateSettingKey(DEFAULT_CONSUMER_CONFIG_TEMPLATE, testKey), defaultValue\n+        generateSettingKey(DEFAULT_CONSUMER_CONFIG_TEMPLATE, \"key1\"), defaultValue,\n+        generateSettingKey(DEFAULT_CONSUMER_CONFIG_TEMPLATE, \"key2\"), defaultValue,\n+        generateSettingKey(DEFAULT_CONSUMER_CONFIG_TEMPLATE, \"key3\"), defaultValue\n     ));\n \n     ConfigProvider configProvider = createConfigProvider(fileSettings);\n \n     var exception = assertThrows(IllegalArgumentException.class, () -> configProvider.getNabConsumerSettings(topicName));\n-    assertEquals(\"Unsupported kafka consumer property found: 'invalidKey'\", exception.getMessage());\n+    assertEquals(\"Unsupported kafka consumer properties found: 'key1, key2, key3'\", exception.getMessage());\n   }\n \n   @Test\n"}}, {"oid": "ecc29c059011fabc1a3d0d94ce1822b6ea6fff85", "url": "https://github.com/hhru/nuts-and-bolts/commit/ecc29c059011fabc1a3d0d94ce1822b6ea6fff85", "message": "HH-112089 notify about several invalid keys at once", "committedDate": "2020-07-02T13:31:22Z", "type": "commit"}]}