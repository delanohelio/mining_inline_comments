{"pr_number": 276, "pr_title": "HH-110735. Rewind to last acked offset if current was not acked", "pr_createdAt": "2020-11-12T15:01:35Z", "pr_url": "https://github.com/hhru/nuts-and-bolts/pull/276", "timeline": [{"oid": "6cf3ffeea8a2374ad4b1969729ec8e825f644c0b", "url": "https://github.com/hhru/nuts-and-bolts/commit/6cf3ffeea8a2374ad4b1969729ec8e825f644c0b", "message": "HH-110735. Rewind to last acked offset if current was not acked", "committedDate": "2020-11-16T06:54:13Z", "type": "commit"}, {"oid": "6cf3ffeea8a2374ad4b1969729ec8e825f644c0b", "url": "https://github.com/hhru/nuts-and-bolts/commit/6cf3ffeea8a2374ad4b1969729ec8e825f644c0b", "message": "HH-110735. Rewind to last acked offset if current was not acked", "committedDate": "2020-11-16T06:54:13Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzkzNzYwNA==", "url": "https://github.com/hhru/nuts-and-bolts/pull/276#discussion_r523937604", "bodyText": "getCurrentBatch() \u0432\u044b\u0437\u044b\u0432\u0430\u0435\u0442\u0441\u044f \u0432\u0442\u043e\u0440\u043e\u0439 \u0440\u0430\u0437, \u0442\u0443\u0442 \u0432\u044b\u0448\u0435 currentBatch", "author": "bokshitsky", "createdAt": "2020-11-16T07:23:02Z", "path": "nab-kafka/src/main/java/ru/hh/nab/kafka/consumer/KafkaConsumer.java", "diffHunk": "@@ -63,5 +67,31 @@ public void onMessagesBatch(List<ConsumerRecord<String, T>> messages, Consumer<?\n     currentBatch.set(sortedBatch);\n     Ack<T> ack = new KafkaInternalTopicAck<>(this, consumer);\n     consumeStrategy.onMessagesBatch(sortedBatch, ack);\n+    if (!ack.isAcknowledge()) {\n+      rewindToLastAckedOffset(consumer);\n+    }\n+  }\n+\n+  public void rewindToLastAckedOffset(Consumer<?, ?> consumer) {\n+    List<ConsumerRecord<String, T>> currentBatch = getCurrentBatch();\n+    if (!currentBatch.isEmpty()) {\n+      LinkedHashMap<TopicPartition, OffsetAndMetadata> offsetsToSeek = currentBatch.stream().collect(toMap(\n+          record -> new TopicPartition(record.topic(), record.partition()),\n+          record -> new OffsetAndMetadata(record.offset()),\n+          (offset1, offset2) -> offset1,\n+          LinkedHashMap::new\n+      ));\n+\n+      Optional.ofNullable(getLastAckedBatchRecord()).ifPresent(lastAckedBatchRecord -> {\n+        for (ConsumerRecord<String, T> record : getCurrentBatch()) {", "originalCommit": "6cf3ffeea8a2374ad4b1969729ec8e825f644c0b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzk0Mzc0NQ==", "url": "https://github.com/hhru/nuts-and-bolts/pull/276#discussion_r523943745", "bodyText": "\u0418\u0441\u043f\u0440\u0430\u0432\u0438\u043b", "author": "nicholasgribanov", "createdAt": "2020-11-16T07:39:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzkzNzYwNA=="}], "type": "inlineReview", "revised_code": {"commit": "3c0b93e3ca9d84c4c2e7485b7caadcab69bf18ef", "chunk": "diff --git a/nab-kafka/src/main/java/ru/hh/nab/kafka/consumer/KafkaConsumer.java b/nab-kafka/src/main/java/ru/hh/nab/kafka/consumer/KafkaConsumer.java\nindex 412c77e8..9230e1f8 100644\n--- a/nab-kafka/src/main/java/ru/hh/nab/kafka/consumer/KafkaConsumer.java\n+++ b/nab-kafka/src/main/java/ru/hh/nab/kafka/consumer/KafkaConsumer.java\n\n@@ -83,7 +83,7 @@ public class KafkaConsumer<T> {\n       ));\n \n       Optional.ofNullable(getLastAckedBatchRecord()).ifPresent(lastAckedBatchRecord -> {\n-        for (ConsumerRecord<String, T> record : getCurrentBatch()) {\n+        for (ConsumerRecord<String, T> record : currentBatch) {\n           offsetsToSeek.put(new TopicPartition(record.topic(), record.partition()), new OffsetAndMetadata(record.offset() + 1));\n           if (record == lastAckedBatchRecord) {\n             break;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzkzOTEzOA==", "url": "https://github.com/hhru/nuts-and-bolts/pull/276#discussion_r523939138", "bodyText": "\u0418\u043d\u0438\u0446\u0438\u0430\u043b\u0438\u0437\u0438\u0440\u043e\u0432\u0430\u0442\u044c \u0431\u044b \u0432 false \u044f\u0432\u043d\u043e \u0442\u0443\u0442 / \u0432 \u043a\u043e\u043d\u0441\u0442\u0440\u0443\u043a\u0442\u043e\u0440\u0435", "author": "bokshitsky", "createdAt": "2020-11-16T07:27:03Z", "path": "nab-kafka/src/main/java/ru/hh/nab/kafka/consumer/KafkaInternalTopicAck.java", "diffHunk": "@@ -15,6 +15,7 @@\n   private final KafkaConsumer<T> kafkaConsumer;\n   private final Consumer<?, ?> consumer;\n   private Integer lastCommittedIndex = null;\n+  private boolean isAcknowledge;", "originalCommit": "6cf3ffeea8a2374ad4b1969729ec8e825f644c0b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzk0MzgwOQ==", "url": "https://github.com/hhru/nuts-and-bolts/pull/276#discussion_r523943809", "bodyText": "\u0434\u043e\u0431\u0430\u0432\u0438\u043b", "author": "nicholasgribanov", "createdAt": "2020-11-16T07:39:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzkzOTEzOA=="}], "type": "inlineReview", "revised_code": {"commit": "3c0b93e3ca9d84c4c2e7485b7caadcab69bf18ef", "chunk": "diff --git a/nab-kafka/src/main/java/ru/hh/nab/kafka/consumer/KafkaInternalTopicAck.java b/nab-kafka/src/main/java/ru/hh/nab/kafka/consumer/KafkaInternalTopicAck.java\nindex a3a5b49c..e727d99e 100644\n--- a/nab-kafka/src/main/java/ru/hh/nab/kafka/consumer/KafkaInternalTopicAck.java\n+++ b/nab-kafka/src/main/java/ru/hh/nab/kafka/consumer/KafkaInternalTopicAck.java\n\n@@ -15,7 +15,7 @@ public class KafkaInternalTopicAck<T> implements Ack<T> {\n   private final KafkaConsumer<T> kafkaConsumer;\n   private final Consumer<?, ?> consumer;\n   private Integer lastCommittedIndex = null;\n-  private boolean isAcknowledge;\n+  private boolean isAcknowledge = false;\n \n   public KafkaInternalTopicAck(KafkaConsumer<T> kafkaConsumer,\n                                Consumer<?, ?> consumer) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzk0MTMyMQ==", "url": "https://github.com/hhru/nuts-and-bolts/pull/276#discussion_r523941321", "bodyText": "\u0434\u0443\u043c\u0430\u044e, \u0447\u0442\u043e \u043a\u043e\u0433\u0434\u0430 \u043c\u044b \u044f\u0432\u043d\u043e \u0434\u0435\u043b\u0430\u0435\u043c seek (\u0441\u0434\u0432\u0438\u0433\u0430\u0435\u043c \u043b\u043e\u043a\u0430\u043b\u044c\u043d\u044b\u0439 \u0443\u043a\u0430\u0437\u0430\u0442\u0435\u043b\u044c \u0432 \u043f\u0430\u043c\u044f\u0442\u0438 \u043a\u043e\u043d\u0441\u0443\u043c\u0435\u0440\u0430 \u043d\u0430 \u043a\u043e\u043d\u043a\u0440\u0435\u0442\u043d\u0443\u044e \u0437\u0430\u043f\u0438\u0441\u044c) \u043d\u0430\u0434\u043e \u0442\u043e\u0436\u0435 \u043d\u0435 \u0432\u043e\u0437\u0432\u0440\u0430\u0449\u0430\u0442\u044c \u043e\u0431\u0440\u0430\u0442\u043d\u043e.\n\u0423 \u043d\u0435\u0433\u043e \u0435\u0441\u0442\u044c \u043d\u0435\u0441\u043a\u043e\u043b\u044c\u043a\u043e \u043f\u0440\u0438\u043c\u0435\u043d\u0435\u043d\u0438\u0439:\n\n\u043a\u043e\u0433\u0434\u0430 \u043c\u044b \u0445\u043e\u0442\u0438\u043c \u043a\u043e\u043c\u043c\u0438\u0442\u0438\u0442\u044c \u043e\u0444\u0444\u0441\u0435\u0442 \u043d\u0435 \u043d\u0430 \u043a\u0430\u0436\u0434\u044b\u0439 \u0431\u0430\u0442\u0447, \u0430, \u043d\u0430\u043f\u0440\u0438\u043c\u0435\u0440, \u043f\u043e \u0432\u0440\u0435\u043c\u0435\u043d\u0438\n\u043a\u043e\u0433\u0434\u0430 \u043c\u044b \u0445\u043e\u0442\u0438\u043c \u043e\u043f\u0442\u0438\u043c\u0438\u0437\u0438\u0440\u043e\u0432\u0430\u0442\u044c \u043e\u043f\u0442\u0438\u043c\u0438\u0437\u0438\u0440\u043e\u0432\u0430\u0442\u044c \u0434\u0443\u0431\u043b\u0438 \u0438 at_least_once \u0441\u0435\u043c\u0430\u043d\u0442\u0438\u043a\u0443 -  \u0434\u0435\u043b\u0430\u0435\u043c seek \u043f\u043e\u0441\u043b\u0435 \u043e\u0431\u0440\u0430\u0431\u043e\u0442\u043a\u0438 \u043a\u0430\u0436\u0434\u043e\u0433\u043e \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u044f \u0432 \u0431\u0430\u0442\u0447\u0435 (\u0434\u0435\u0448\u0435\u0432\u043e) \u0432 \u043a\u043e\u043d\u0446\u0435 \u0431\u0430\u0442\u0447\u0430 \u0434\u0435\u043b\u0430\u0435\u043c \u0433\u043b\u043e\u0431\u0430\u043b\u044c\u043d\u044b\u0439 ack.\n\n\u041f\u043b\u044e\u0441, \u043d\u0430\u043c \u0441\u043a\u043e\u0440\u043e \u043e\u043d \u043f\u043e\u043d\u0430\u0434\u043e\u0431\u0438\u0442\u0441\u044f, \u043a\u043e\u0433\u0434\u0430 \u0431\u0443\u0434\u0435\u043c \u0443\u0447\u0438\u0442\u044c nab-kafka \u0432\u044b\u0447\u0438\u0442\u044b\u0432\u0430\u0442\u044c \u0432\u0441\u0435 \u043f\u0430\u0440\u0442\u0438\u0446\u0438\u0438 \u0442\u043e\u043f\u0438\u043a\u0430, \u0431\u0435\u0437 \u0431\u0430\u043b\u0430\u043d\u0441\u0438\u0440\u043e\u0432\u043a\u0438", "author": "bokshitsky", "createdAt": "2020-11-16T07:32:57Z", "path": "nab-kafka/src/main/java/ru/hh/nab/kafka/consumer/KafkaInternalTopicAck.java", "diffHunk": "@@ -50,10 +51,16 @@ public void acknowledge(ConsumerRecord<String, T> processedMessage) {\n     ));\n     consumer.commitSync(offsetsToCommit);\n     seek(processedMessage);\n+    isAcknowledge = true;\n   }\n \n   @Override\n   public void seek(ConsumerRecord<String, T> processedMessage) {", "originalCommit": "6cf3ffeea8a2374ad4b1969729ec8e825f644c0b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "dfa5c612eef8f4ede0df0f955708c71da96613ad", "chunk": "diff --git a/nab-kafka/src/main/java/ru/hh/nab/kafka/consumer/KafkaInternalTopicAck.java b/nab-kafka/src/main/java/ru/hh/nab/kafka/consumer/KafkaInternalTopicAck.java\nindex a3a5b49c..6b1fc85c 100644\n--- a/nab-kafka/src/main/java/ru/hh/nab/kafka/consumer/KafkaInternalTopicAck.java\n+++ b/nab-kafka/src/main/java/ru/hh/nab/kafka/consumer/KafkaInternalTopicAck.java\n\n@@ -51,16 +50,10 @@ public class KafkaInternalTopicAck<T> implements Ack<T> {\n     ));\n     consumer.commitSync(offsetsToCommit);\n     seek(processedMessage);\n-    isAcknowledge = true;\n   }\n \n   @Override\n   public void seek(ConsumerRecord<String, T> processedMessage) {\n     kafkaConsumer.setLastAckedBatchRecord(processedMessage);\n   }\n-\n-  @Override\n-  public boolean isAcknowledge() {\n-    return isAcknowledge;\n-  }\n }\n"}}, {"oid": "3c0b93e3ca9d84c4c2e7485b7caadcab69bf18ef", "url": "https://github.com/hhru/nuts-and-bolts/commit/3c0b93e3ca9d84c4c2e7485b7caadcab69bf18ef", "message": "delete duplicate calling method and add initialize default value", "committedDate": "2020-11-16T07:38:50Z", "type": "commit"}, {"oid": "dfa5c612eef8f4ede0df0f955708c71da96613ad", "url": "https://github.com/hhru/nuts-and-bolts/commit/dfa5c612eef8f4ede0df0f955708c71da96613ad", "message": "remove isAcknowledge flag", "committedDate": "2020-11-16T08:41:18Z", "type": "commit"}]}