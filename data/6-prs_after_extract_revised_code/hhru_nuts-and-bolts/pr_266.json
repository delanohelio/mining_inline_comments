{"pr_number": 266, "pr_title": "HH-117799 add new parameters in consul registration", "pr_createdAt": "2020-10-13T15:09:39Z", "pr_url": "https://github.com/hhru/nuts-and-bolts/pull/266", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDAzOTQ0NA==", "url": "https://github.com/hhru/nuts-and-bolts/pull/266#discussion_r504039444", "bodyText": "\u043d\u0435 \u043d\u0430\u0434\u043e \u0442\u0430\u043a\u043e\u0439 \u043c\u0435\u0442\u043e\u0434. \u0435\u0441\u043b\u0438 \u0447\u0435\u0433\u043e-\u0442\u043e \u0432 \u0444\u0430\u0439\u043b\u0438\u043a\u0435 \u043d\u0435\u0442 - \u043d\u0430\u0434\u043e \u0432\u0430\u043b\u0438\u0442\u044c\u0441\u044f", "author": "dzharikhin", "createdAt": "2020-10-13T15:19:35Z", "path": "nab-common/src/main/java/ru/hh/nab/common/properties/FileSettings.java", "diffHunk": "@@ -18,6 +19,10 @@ public String getString(String key) {\n     return properties.getProperty(key);\n   }\n \n+  public String getString(String key, String defaultValue) {", "originalCommit": "6055085695e305ab528e9c22a36ede8567170694", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDA0MTE1Ng==", "url": "https://github.com/hhru/nuts-and-bolts/pull/266#discussion_r504041156", "bodyText": "\u0430 \u043f\u043e\u0442\u043e\u043c \u0432\u0435\u0437\u0434\u0435 requireNonNullElse", "author": "heruv1m", "createdAt": "2020-10-13T15:21:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDAzOTQ0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDA0MjQ0NQ==", "url": "https://github.com/hhru/nuts-and-bolts/pull/266#discussion_r504042445", "bodyText": "\u041d\u0435 \u0432\u0438\u0436\u0443 \u0447\u0435\u043c \u043f\u043b\u043e\u0445\u043e. \u0412 \u043c\u043e\u0435\u043c \u043a\u0435\u0439\u0441\u0435 \u0442\u043e\u0447\u043d\u043e \u0443\u0441\u0442\u0430\u0440\u0438\u0432\u0430\u044e\u0442 \u0434\u0435\u0444\u043e\u043b\u0442\u043d\u044b\u0435 \u043f\u0430\u0440\u0430\u043c\u0435\u0442\u0440\u044b, \u0434\u0443\u043c\u0430\u044e \u0434\u0440\u0443\u0433\u0438\u043c \u0442\u043e\u0436\u0435 \u043f\u0440\u0438\u0433\u043e\u0434\u0438\u0442\u0441\u044f", "author": "heruv1m", "createdAt": "2020-10-13T15:23:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDAzOTQ0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDA3Mzg2NA==", "url": "https://github.com/hhru/nuts-and-bolts/pull/266#discussion_r504073864", "bodyText": "\u0441\u0443\u0442\u044c - \u0441\u0434\u0435\u043b\u0430\u0442\u044c \u0442\u0430\u043a, \u0447\u0442\u043e\u0431\u044b \u0443 \u043a\u0440\u0438\u0442\u0438\u0447\u043d\u044b\u0445 \u043f\u0430\u0440\u0430\u043c\u0435\u0442\u0440\u043e\u0432 \u0434\u0435\u0444\u043e\u043b\u0442\u043e\u0432 \u043d\u0435 \u0431\u044b\u043b\u043e\n\u043f\u043e\u0441\u043a\u043e\u043b\u044c\u043a\u0443 \u043c\u044b \u043d\u0435 \u043c\u043e\u0436\u0435\u043c \u0437\u043d\u0430\u0442\u044c \u0437\u0430\u0440\u0430\u043d\u0435\u0435 \u0433\u0434\u0435 \u043a\u0440\u0438\u0442\u0438\u0447\u043d\u043e - \u043b\u0443\u0447\u0448\u0435 \u043e\u0442 \u044d\u0442\u043e\u0433\u043e \u0437\u0430\u0449\u0438\u0449\u0430\u0442\u044c\u0441\u044f", "author": "dzharikhin", "createdAt": "2020-10-13T16:02:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDAzOTQ0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDA3NTA4Mw==", "url": "https://github.com/hhru/nuts-and-bolts/pull/266#discussion_r504075083", "bodyText": "\u043c\u043e\u0436\u043d\u043e \u0441\u043a\u043b\u0435\u043f\u0430\u0442\u044c \u0441\u0435\u0431\u0435 \u043a\u0430\u043a\u0443\u044e-\u0442\u043e \u043d\u0435\u043f\u0443\u0431\u043b\u0438\u0447\u043d\u0443\u044e \u043e\u0431\u0435\u0440\u0442\u043a\u0443 \u0438 \u0441\u0434\u0435\u043b\u0430\u0442\u044c \u0432 \u043d\u0435\u0439", "author": "dzharikhin", "createdAt": "2020-10-13T16:04:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDAzOTQ0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUzNjg4Mw==", "url": "https://github.com/hhru/nuts-and-bolts/pull/266#discussion_r504536883", "bodyText": "\u042f \u043d\u0435 \u0441\u043e\u0433\u043b\u0430\u0441\u0435\u043d \u0432\u0441\u0435 \u0440\u0430\u0432\u043d\u043e. \u0421\u043b\u043e\u043c\u0430\u0442\u044c \u043c\u043e\u0436\u043d\u043e \u0447\u0442\u043e \u0443\u0433\u043e\u0434\u043d\u043e. \u0415\u0441\u0442\u044c \u043c\u0435\u0442\u043e\u0434 \u0431\u0435\u0437 \u0434\u0435\u0444\u043e\u043b\u0442\u0430. \u0415\u0441\u0442\u044c \u0441 \u0434\u0435\u0444\u043e\u043b\u0442\u043e\u043c. \u0427\u0435\u043c \u0445\u0443\u0436\u0435 \u043c\u0435\u0442\u043e\u0434 \u0434\u043b\u044f \u0438\u043d\u0442\u0430 \u0441 \u0434\u0435\u0444\u043e\u043b\u0442\u043e\u043c?", "author": "heruv1m", "createdAt": "2020-10-14T09:32:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDAzOTQ0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU0MDQ4Nw==", "url": "https://github.com/hhru/nuts-and-bolts/pull/266#discussion_r504540487", "bodyText": "@pvorlov \u0430 \u0442\u044b \u043a\u0430\u043a \u0434\u0443\u043c\u0430\u0435\u0448\u044c?", "author": "heruv1m", "createdAt": "2020-10-14T09:37:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDAzOTQ0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU2NDM4OQ==", "url": "https://github.com/hhru/nuts-and-bolts/pull/266#discussion_r504564389", "bodyText": "\u042f \u0441\u043a\u043e\u0440\u0435\u0435 \u0437\u0430 \u0442\u043e \u0447\u0442\u043e \u0431 \u0434\u043e\u0431\u0430\u0432\u0438\u0442\u044c. \u041a\u0440\u0438\u0442\u0438\u0447\u043d\u044b\u0435 \u043f\u0430\u0440\u0430\u043c\u0435\u0442\u0440\u044b \u043c\u043e\u0433\u0443\u0442 \u0431\u044b\u0442\u044c \u0438 long \u0438 int. \u041d\u043e \u0434\u043b\u044f \u043d\u0438\u0445 \u043c\u044b \u0434\u0435\u0444\u043e\u043b\u0442\u044b \u043d\u0430\u043f\u0438\u0441\u0430\u043b\u0438. \u041a\u043e\u043c\u0443 \u043d\u0430\u0434\u043e \u0434\u0435\u0444\u043e\u043b\u0442 \u0442\u0430\u043c \u0433\u0434\u0435 \u043a\u0440\u0438\u0442\u0438\u0447\u043d\u043e \u043e\u043d \u0441\u043c\u043e\u0436\u0435\u0442 \u0438 \u0431\u0435\u0437 \u044d\u0442\u043e\u0433\u043e \u043c\u0435\u0442\u043e\u0434\u0430 \u0441\u0434\u0435\u043b\u0430\u0442\u044c \u0447\u0435\u0440\u0435\u0437 Optional.\n\u041a\u043b\u0430\u0441\u0441 \u043f\u0440\u043e\u0441\u0442\u043e \u043b\u0430\u043a\u043e\u043d\u0438\u0447\u043d\u0435\u0435 \u0441\u043c\u043e\u0442\u0440\u0435\u0442\u044c\u0441\u044f \u0431\u0443\u0434\u0435\u0442, \u0432 \u043e\u0434\u043d\u043e\u043c \u0441\u0442\u0438\u043b\u0435.", "author": "pvorlov", "createdAt": "2020-10-14T10:17:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDAzOTQ0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU2NzY3NQ==", "url": "https://github.com/hhru/nuts-and-bolts/pull/266#discussion_r504567675", "bodyText": "\u043a\u0440\u0438\u0442\u0438\u0447\u043d\u044b\u0435 \u043f\u0430\u0440\u0430\u043c\u0435\u0442\u0440\u044b - \u043d\u0435 \u043f\u043e \u0442\u0438\u043f\u0443\n\u044d\u0442\u043e \u043a\u043e\u0433\u0434\u0430 \u0442\u044b \u0432 \u043d\u0430\u0441\u0442\u0440\u043e\u0439\u043a\u0430\u0445 \u043d\u0435 \u0443\u043a\u0430\u0437\u044b\u0432\u0430\u0435\u0448\u044c \u043d\u0430\u043f\u0440\u0438\u043c\u0435\u0440 \u0438\u043c\u044f \u0441\u0435\u0440\u0432\u0438\u0441\u0430. \u043e\u043d\u043e \u0434\u043e\u043b\u0436\u043d\u043e \u0431\u044b\u0442\u044c, \u0431\u0435\u0437 \u043d\u0435\u0433\u043e \u0434\u043e\u043b\u0436\u043d\u043e \u043f\u0430\u0434\u0430\u0442\u044c", "author": "dzharikhin", "createdAt": "2020-10-14T10:23:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDAzOTQ0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU2OTA5Ng==", "url": "https://github.com/hhru/nuts-and-bolts/pull/266#discussion_r504569096", "bodyText": "\u041d\u0443 \u0438 \u043f\u0443\u0441\u0442\u044c \u043f\u0430\u0434\u0430\u0435\u0442! \u0422\u0435\u0431\u044f \u0436 \u043d\u0438\u043a\u0442\u043e \u043d\u0435 \u0437\u0430\u0432\u0441\u0442\u0430\u0432\u043b\u044f\u0435\u0442 \u044d\u0442\u043e\u0442 \u043c\u0435\u0442\u043e\u0434 \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u044c. \u0421\u0442\u0430\u0440\u044b\u0439 getString \u043e\u0441\u0442\u0430\u0451\u0442\u0441\u044f. \u0413\u0434\u0435 \u0434\u043e\u043b\u0436\u043d\u043e \u043f\u0430\u0434\u0430\u0442\u044c - \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u0443\u0435\u043c \u0435\u0433\u043e.", "author": "pvorlov", "createdAt": "2020-10-14T10:26:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDAzOTQ0NA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDA0MjM5Mw==", "url": "https://github.com/hhru/nuts-and-bolts/pull/266#discussion_r504042393", "bodyText": "3 \u043c\u043e\u0436\u0435\u0442 \u0442\u043e\u0436\u0435 \u0432 \u043f\u0430\u0440\u0430\u043c\u0435\u0442\u0440\u044b? \u0432\u044b\u0433\u043b\u044f\u0434\u0438\u0442, \u0447\u0442\u043e \u044d\u0442\u043e \u0442\u0430\u043a\u0430\u044f \u0448\u0442\u0443\u043a\u0430 - \u043d\u0430\u0441\u043a\u043e\u043b\u044c\u043a\u043e \u0443\u043c\u0435\u043d\u044c\u0448\u0430\u0442\u044c \u0432\u0435\u0441 \u0441\u0435\u0440\u0432\u0438\u0441\u0430 \u043c\u043e\u0436\u0435\u0442 \u0431\u044b\u0442\u044c \u0447\u0443\u0432\u0441\u0442\u0432\u0438\u0442\u0435\u043b\u044c\u043d\u043e", "author": "dzharikhin", "createdAt": "2020-10-13T15:23:15Z", "path": "nab-starter/src/main/java/ru/hh/nab/starter/ConsulService.java", "diffHunk": "@@ -23,38 +25,57 @@\n   private static final Logger LOGGER = LoggerFactory.getLogger(ConsulService.class);\n \n   private static final String LOG_LEVEL_OVERRIDE_EXTENSION_TAG = \"log_level_override_extension_enabled\";\n+  private static final int DEFAULT_WEIGHT = 100;\n \n   private final AgentClient agentClient;\n+  private final KeyValueClient kvClient;\n   private final Registration service;\n   private final String id;\n   private final boolean enabled;\n \n-  public ConsulService(AgentClient agentClient, FileSettings fileSettings, String datacenter, String host, AppMetadata appMetadata,\n-                       @Nullable LogLevelOverrideExtension logLevelOverrideExtension) {\n+  public ConsulService(AgentClient agentClient, KeyValueClient kvClient,\n+                              FileSettings fileSettings, String datacenter, String hostName, AppMetadata appMetadata,\n+                              @Nullable LogLevelOverrideExtension logLevelOverrideExtension) {\n     this.agentClient = agentClient;\n+    this.kvClient = kvClient;\n+\n     var applicationPort = fileSettings.getInteger(\"jetty.port\");\n     var applicationHost = Optional.ofNullable(fileSettings.getString(\"consul.check.host\"))\n-      .orElse(\"127.0.0.1\");\n-    var id = fileSettings.getString(\"serviceName\") + \"-\" + datacenter + \"-\" + host + \"-\" + applicationPort;\n+        .orElse(\"127.0.0.1\");\n+    var id = fileSettings.getString(\"serviceName\") + \"-\" + datacenter + \"-\" + hostName + \"-\" + applicationPort;\n     var tags = new ArrayList<>(fileSettings.getStringList(\"consul.tags\"));\n     if (logLevelOverrideExtension != null) {\n       tags.add(LOG_LEVEL_OVERRIDE_EXTENSION_TAG);\n     }\n \n-    ImmutableRegCheck regCheck = ImmutableRegCheck.builder()\n-            .http(\"http://\" + applicationHost + \":\" + applicationPort + \"/status\")\n-            .interval(requireNonNullElse(fileSettings.getString(\"consul.check.interval\"), \"5s\"))\n-            .timeout(requireNonNullElse(fileSettings.getString(\"consul.check.timeout\"), \"5s\"))\n-            .build();\n+    Registration.RegCheck regCheck = ImmutableRegCheck.builder()\n+        .http(\"http://\" + applicationHost + \":\" + applicationPort + \"/status\")\n+        .interval(fileSettings.getString(\"consul.check.interval\", \"5s\"))\n+        .timeout(fileSettings.getString(\"consul.check.timeout\", \"5s\"))\n+        .deregisterCriticalServiceAfter(fileSettings.getString(\"consul.deregisterCritical.timeout\", \"10m\"))\n+        .successBeforePassing(fileSettings.getInteger(\"consul.check.successCount\", 2))\n+        .failuresBeforeCritical(fileSettings.getInteger(\"consul.check.failCount\", 2))\n+        .build();\n+    Optional<String> weight = getWeight(hostName);\n+    int weightForService;\n+    if (weight.isPresent()) {\n+      weightForService = weight.map(Integer::parseInt).get();\n+    } else {\n+      LOGGER.warn(\"No weight present for node:{}\", hostName);\n+      weightForService = DEFAULT_WEIGHT;\n+    }\n+\n+    ServiceWeights serviceWeights = ImmutableServiceWeights.builder().passing(weightForService).warning(weightForService / 3).build();", "originalCommit": "6055085695e305ab528e9c22a36ede8567170694", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDA1MTA4NQ==", "url": "https://github.com/hhru/nuts-and-bolts/pull/266#discussion_r504051085", "bodyText": "\u0432\u043e\u043e\u0431\u0449\u0435 \u0441\u043e\u043c\u043d\u0438\u0442\u0435\u043b\u044c\u043d\u043e\u0435. \u0423 \u043d\u0430\u0441 \u0441\u0435\u0439\u0447\u0430\u0441 \u0432\u043e\u043e\u0431\u0449\u0435 \u043d\u0435 \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u0443\u044e\u0442\u0441\u044f \u0441\u0435\u0440\u0432\u0438\u0441\u044b, \u0435\u0441\u043b\u0438 \u0443 \u043d\u0438\u0445 \u0441\u0442\u0430\u0442\u0443\u0441 \u043e\u0442\u043b\u0438\u0447\u043d\u044b\u0439 \u043e\u0442 passing.\n\u041d\u0443 \u0434\u0430\u0432\u0430\u0439 \u043f\u0435\u0440\u0435\u0437\u0430\u043b\u043e\u0436\u0443\u0441\u044c. \u0425\u0443\u0436\u0435 \u043d\u0435 \u0431\u0443\u0434\u0435\u0442", "author": "heruv1m", "createdAt": "2020-10-13T15:32:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDA0MjM5Mw=="}], "type": "inlineReview", "revised_code": {"commit": "64f5e30440fb013219216a2843ad98e100aa3a60", "chunk": "diff --git a/nab-starter/src/main/java/ru/hh/nab/starter/ConsulService.java b/nab-starter/src/main/java/ru/hh/nab/starter/ConsulService.java\nindex 425c084e..1026e581 100644\n--- a/nab-starter/src/main/java/ru/hh/nab/starter/ConsulService.java\n+++ b/nab-starter/src/main/java/ru/hh/nab/starter/ConsulService.java\n\n@@ -58,10 +58,10 @@ public class ConsulService {\n         .build();\n     Optional<String> weight = getWeight(hostName);\n     int weightForService;\n-    if (weight.isPresent()) {\n+    if(weight.isPresent()){\n       weightForService = weight.map(Integer::parseInt).get();\n-    } else {\n-      LOGGER.warn(\"No weight present for node:{}\", hostName);\n+    }else {\n+      LOGGER.warn(\"No weight for node:{}\", hostName);\n       weightForService = DEFAULT_WEIGHT;\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDA0MjkwMg==", "url": "https://github.com/hhru/nuts-and-bolts/pull/266#discussion_r504042902", "bodyText": "\u0442\u0430\u043c \u0449\u0430\u0441 \u043f\u043e \u0434\u0435\u0444\u043e\u043b\u0442\u0443 1 \u0436\u0435?\n\u043c\u043e\u0436\u0435\u0442 \u0441\u0434\u0435\u043b\u0430\u0442\u044c \u0431\u0435\u0437 \u0434\u0435\u0444\u043e\u043b\u0442\u043d\u043e\u0433\u043e \u0432\u0435\u0441\u0430? \u043d\u0443 \u0442\u0438\u043f\u0430 \u043f\u0440\u043e\u0441\u0442\u043e \u043d\u0435 \u0440\u0435\u0433\u0430\u0435\u043c \u0432\u0435\u0441, \u0435\u0441\u043b\u0438 \u0435\u0433\u043e \u043d\u0435\u0442?", "author": "dzharikhin", "createdAt": "2020-10-13T15:23:53Z", "path": "nab-starter/src/main/java/ru/hh/nab/starter/ConsulService.java", "diffHunk": "@@ -23,38 +25,57 @@\n   private static final Logger LOGGER = LoggerFactory.getLogger(ConsulService.class);\n \n   private static final String LOG_LEVEL_OVERRIDE_EXTENSION_TAG = \"log_level_override_extension_enabled\";\n+  private static final int DEFAULT_WEIGHT = 100;\n \n   private final AgentClient agentClient;\n+  private final KeyValueClient kvClient;\n   private final Registration service;\n   private final String id;\n   private final boolean enabled;\n \n-  public ConsulService(AgentClient agentClient, FileSettings fileSettings, String datacenter, String host, AppMetadata appMetadata,\n-                       @Nullable LogLevelOverrideExtension logLevelOverrideExtension) {\n+  public ConsulService(AgentClient agentClient, KeyValueClient kvClient,\n+                              FileSettings fileSettings, String datacenter, String hostName, AppMetadata appMetadata,\n+                              @Nullable LogLevelOverrideExtension logLevelOverrideExtension) {\n     this.agentClient = agentClient;\n+    this.kvClient = kvClient;\n+\n     var applicationPort = fileSettings.getInteger(\"jetty.port\");\n     var applicationHost = Optional.ofNullable(fileSettings.getString(\"consul.check.host\"))\n-      .orElse(\"127.0.0.1\");\n-    var id = fileSettings.getString(\"serviceName\") + \"-\" + datacenter + \"-\" + host + \"-\" + applicationPort;\n+        .orElse(\"127.0.0.1\");\n+    var id = fileSettings.getString(\"serviceName\") + \"-\" + datacenter + \"-\" + hostName + \"-\" + applicationPort;\n     var tags = new ArrayList<>(fileSettings.getStringList(\"consul.tags\"));\n     if (logLevelOverrideExtension != null) {\n       tags.add(LOG_LEVEL_OVERRIDE_EXTENSION_TAG);\n     }\n \n-    ImmutableRegCheck regCheck = ImmutableRegCheck.builder()\n-            .http(\"http://\" + applicationHost + \":\" + applicationPort + \"/status\")\n-            .interval(requireNonNullElse(fileSettings.getString(\"consul.check.interval\"), \"5s\"))\n-            .timeout(requireNonNullElse(fileSettings.getString(\"consul.check.timeout\"), \"5s\"))\n-            .build();\n+    Registration.RegCheck regCheck = ImmutableRegCheck.builder()\n+        .http(\"http://\" + applicationHost + \":\" + applicationPort + \"/status\")\n+        .interval(fileSettings.getString(\"consul.check.interval\", \"5s\"))\n+        .timeout(fileSettings.getString(\"consul.check.timeout\", \"5s\"))\n+        .deregisterCriticalServiceAfter(fileSettings.getString(\"consul.deregisterCritical.timeout\", \"10m\"))\n+        .successBeforePassing(fileSettings.getInteger(\"consul.check.successCount\", 2))\n+        .failuresBeforeCritical(fileSettings.getInteger(\"consul.check.failCount\", 2))\n+        .build();\n+    Optional<String> weight = getWeight(hostName);\n+    int weightForService;\n+    if (weight.isPresent()) {\n+      weightForService = weight.map(Integer::parseInt).get();\n+    } else {\n+      LOGGER.warn(\"No weight present for node:{}\", hostName);\n+      weightForService = DEFAULT_WEIGHT;", "originalCommit": "6055085695e305ab528e9c22a36ede8567170694", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUzNjIwNw==", "url": "https://github.com/hhru/nuts-and-bolts/pull/266#discussion_r504536207", "bodyText": "\u043f\u043e \u0434\u0435\u0444\u043e\u043b\u0442\u0443 \u0443 \u043a\u043e\u043d\u0441\u0443\u043b\u0430 \u0441\u043e\u0442\u043a\u0430, \u0434\u0430.\n\u0421\u0430\u0448\u0430 \u0441\u043a\u0430\u0437\u0430\u043b \u043d\u0430\u0448\u0438\u043c \u043f\u043e \u0434\u0435\u0444\u043e\u0442\u043b\u0443 \u043f\u043e\u0441\u0442\u0430\u0432\u0438\u0442\u044c \u0441\u043e\u0442\u043a\u0443.", "author": "heruv1m", "createdAt": "2020-10-14T09:30:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDA0MjkwMg=="}], "type": "inlineReview", "revised_code": {"commit": "64f5e30440fb013219216a2843ad98e100aa3a60", "chunk": "diff --git a/nab-starter/src/main/java/ru/hh/nab/starter/ConsulService.java b/nab-starter/src/main/java/ru/hh/nab/starter/ConsulService.java\nindex 425c084e..1026e581 100644\n--- a/nab-starter/src/main/java/ru/hh/nab/starter/ConsulService.java\n+++ b/nab-starter/src/main/java/ru/hh/nab/starter/ConsulService.java\n\n@@ -58,10 +58,10 @@ public class ConsulService {\n         .build();\n     Optional<String> weight = getWeight(hostName);\n     int weightForService;\n-    if (weight.isPresent()) {\n+    if(weight.isPresent()){\n       weightForService = weight.map(Integer::parseInt).get();\n-    } else {\n-      LOGGER.warn(\"No weight present for node:{}\", hostName);\n+    }else {\n+      LOGGER.warn(\"No weight for node:{}\", hostName);\n       weightForService = DEFAULT_WEIGHT;\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDA0NTcxNw==", "url": "https://github.com/hhru/nuts-and-bolts/pull/266#discussion_r504045717", "bodyText": "\u041a\u0430\u043a-\u0442\u043e \u0441\u0442\u0440\u0430\u043d\u043d\u043e \u043e\u0442\u0441\u0442\u0443\u043f\u044b \u0440\u0430\u0437\u044a\u0435\u0445\u0430\u043b\u0438\u0441\u044c", "author": "pvorlov", "createdAt": "2020-10-13T15:27:16Z", "path": "nab-starter/src/main/java/ru/hh/nab/starter/ConsulService.java", "diffHunk": "@@ -23,38 +25,57 @@\n   private static final Logger LOGGER = LoggerFactory.getLogger(ConsulService.class);\n \n   private static final String LOG_LEVEL_OVERRIDE_EXTENSION_TAG = \"log_level_override_extension_enabled\";\n+  private static final int DEFAULT_WEIGHT = 100;\n \n   private final AgentClient agentClient;\n+  private final KeyValueClient kvClient;\n   private final Registration service;\n   private final String id;\n   private final boolean enabled;\n \n-  public ConsulService(AgentClient agentClient, FileSettings fileSettings, String datacenter, String host, AppMetadata appMetadata,\n-                       @Nullable LogLevelOverrideExtension logLevelOverrideExtension) {\n+  public ConsulService(AgentClient agentClient, KeyValueClient kvClient,\n+                              FileSettings fileSettings, String datacenter, String hostName, AppMetadata appMetadata,", "originalCommit": "6055085695e305ab528e9c22a36ede8567170694", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUzNzAyNw==", "url": "https://github.com/hhru/nuts-and-bolts/pull/266#discussion_r504537027", "bodyText": "\u043f\u043e\u043f\u0440\u0430\u0432\u043b\u044e", "author": "heruv1m", "createdAt": "2020-10-14T09:32:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDA0NTcxNw=="}], "type": "inlineReview", "revised_code": {"commit": "64f5e30440fb013219216a2843ad98e100aa3a60", "chunk": "diff --git a/nab-starter/src/main/java/ru/hh/nab/starter/ConsulService.java b/nab-starter/src/main/java/ru/hh/nab/starter/ConsulService.java\nindex 425c084e..1026e581 100644\n--- a/nab-starter/src/main/java/ru/hh/nab/starter/ConsulService.java\n+++ b/nab-starter/src/main/java/ru/hh/nab/starter/ConsulService.java\n\n@@ -58,10 +58,10 @@ public class ConsulService {\n         .build();\n     Optional<String> weight = getWeight(hostName);\n     int weightForService;\n-    if (weight.isPresent()) {\n+    if(weight.isPresent()){\n       weightForService = weight.map(Integer::parseInt).get();\n-    } else {\n-      LOGGER.warn(\"No weight present for node:{}\", hostName);\n+    }else {\n+      LOGGER.warn(\"No weight for node:{}\", hostName);\n       weightForService = DEFAULT_WEIGHT;\n     }\n \n"}}, {"oid": "64f5e30440fb013219216a2843ad98e100aa3a60", "url": "https://github.com/hhru/nuts-and-bolts/commit/64f5e30440fb013219216a2843ad98e100aa3a60", "message": "HH-117799 add new parameters in consul registration", "committedDate": "2020-10-15T12:44:34Z", "type": "commit"}, {"oid": "95894878f3e63c9f2fe7a003beebf9bb4a1451a9", "url": "https://github.com/hhru/nuts-and-bolts/commit/95894878f3e63c9f2fe7a003beebf9bb4a1451a9", "message": "HH-117799 add new parameters in consul registration", "committedDate": "2020-10-15T12:44:34Z", "type": "commit"}, {"oid": "b1bd9a9ab2b58f1387d7677c1511623ac5ba4ce2", "url": "https://github.com/hhru/nuts-and-bolts/commit/b1bd9a9ab2b58f1387d7677c1511623ac5ba4ce2", "message": "HH-117799 add new parameters in consul registration", "committedDate": "2020-10-15T12:44:34Z", "type": "commit"}, {"oid": "94c7953dd0c919323e1d82035f2f28e25a3e1249", "url": "https://github.com/hhru/nuts-and-bolts/commit/94c7953dd0c919323e1d82035f2f28e25a3e1249", "message": "HH-117799 add tests", "committedDate": "2020-10-15T12:44:34Z", "type": "commit"}, {"oid": "80db3234239e572600b9e051ab0e2c3a92183543", "url": "https://github.com/hhru/nuts-and-bolts/commit/80db3234239e572600b9e051ab0e2c3a92183543", "message": "HH-117799 add new parameters in consul registration", "committedDate": "2020-10-15T12:44:34Z", "type": "commit"}, {"oid": "304fbf05125b89433037c111bc929bb10c3a8ea4", "url": "https://github.com/hhru/nuts-and-bolts/commit/304fbf05125b89433037c111bc929bb10c3a8ea4", "message": "HH-117799 up consul version", "committedDate": "2020-10-15T12:44:34Z", "type": "commit"}, {"oid": "304fbf05125b89433037c111bc929bb10c3a8ea4", "url": "https://github.com/hhru/nuts-and-bolts/commit/304fbf05125b89433037c111bc929bb10c3a8ea4", "message": "HH-117799 up consul version", "committedDate": "2020-10-15T12:44:34Z", "type": "forcePushed"}, {"oid": "78b31f97328745aa8854696d8bd3f13a0d4e63c5", "url": "https://github.com/hhru/nuts-and-bolts/commit/78b31f97328745aa8854696d8bd3f13a0d4e63c5", "message": "HH-117799 up consul version", "committedDate": "2020-10-15T13:51:42Z", "type": "commit"}]}