{"pr_number": 592, "pr_title": "fix(core): Fix micrometer integration by using spectator-reg-micrometer library", "pr_createdAt": "2020-04-06T13:31:00Z", "pr_url": "https://github.com/spinnaker/kork/pull/592", "timeline": [{"oid": "665fd2ba9a4a7ec70fbccdacfa73cbe1ae9b67fc", "url": "https://github.com/spinnaker/kork/commit/665fd2ba9a4a7ec70fbccdacfa73cbe1ae9b67fc", "message": "fix(core): Fix micrometer integration by using spectator-reg-micrometer library\nfeature(web): MetricInterceptor to publish equal set of tags; MetricInterceptor now supports publishing query parameters to metrics (extracted from Kayenta)", "committedDate": "2020-04-06T13:13:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDA5NzY0NA==", "url": "https://github.com/spinnaker/kork/pull/592#discussion_r404097644", "bodyText": "We are exporting our metrics to Prometheus and requirement is that all meters with the same name must have the same set of tag keys. I've used default behavior for this kind of metrics from spring mvc metrics filter. If you guys think this is not backward compatible I could probably make it customizable via property. What do you think?", "author": "Aloren", "createdAt": "2020-04-06T13:39:27Z", "path": "kork-web/src/main/java/com/netflix/spinnaker/kork/web/interceptors/MetricsInterceptor.java", "diffHunk": "@@ -111,13 +127,24 @@ public void afterCompletion(\n       for (String pathVariable : pathVariablesToTag) {\n         if (variables.containsKey(pathVariable)) {\n           id = id.withTag(pathVariable, variables.get(pathVariable).toString());\n+        } else {\n+          id = id.withTag(pathVariable, \"None\");\n+        }\n+      }\n+\n+      for (String queryParamName : queryParamsToTag) {\n+        String parameter = request.getParameter(queryParamName);\n+        if (parameter != null) {\n+          id = id.withTag(queryParamName, parameter);\n+        } else {\n+          id = id.withTag(queryParamName, \"None\");\n         }\n       }\n \n       if (ex != null) {\n         id = id.withTag(\"success\", \"false\").withTag(\"cause\", ex.getClass().getSimpleName());\n       } else {\n-        id = id.withTag(\"success\", \"true\");\n+        id = id.withTag(\"success\", \"true\").withTag(\"cause\", \"None\");", "originalCommit": "665fd2ba9a4a7ec70fbccdacfa73cbe1ae9b67fc", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "09d6c9cf9ee3e32b11b2f9d03252f233a6fc53d5", "url": "https://github.com/spinnaker/kork/commit/09d6c9cf9ee3e32b11b2f9d03252f233a6fc53d5", "message": "Merge branch 'master' into fix/micrometer-integration", "committedDate": "2020-04-09T12:51:15Z", "type": "commit"}, {"oid": "17aacdf5fb21781534a19c11a8c6485922296353", "url": "https://github.com/spinnaker/kork/commit/17aacdf5fb21781534a19c11a8c6485922296353", "message": "Merge branch 'master' into fix/micrometer-integration", "committedDate": "2020-04-15T02:43:45Z", "type": "commit"}, {"oid": "eb5feb9e2f46d17fd758d5e9de8c57b7d5cabf16", "url": "https://github.com/spinnaker/kork/commit/eb5feb9e2f46d17fd758d5e9de8c57b7d5cabf16", "message": "Merge branch 'master' into fix/micrometer-integration", "committedDate": "2020-04-16T04:13:23Z", "type": "commit"}, {"oid": "5b5fc8b7e664ea5bddf982dd917dcb8c875fe7f4", "url": "https://github.com/spinnaker/kork/commit/5b5fc8b7e664ea5bddf982dd917dcb8c875fe7f4", "message": "Merge branch 'master' into fix/micrometer-integration", "committedDate": "2020-04-21T05:17:11Z", "type": "commit"}, {"oid": "6b281ab00b8d550b35a5d5ece0d00116217a587c", "url": "https://github.com/spinnaker/kork/commit/6b281ab00b8d550b35a5d5ece0d00116217a587c", "message": "fix(core): Fix micrometer integration by using spectator-reg-micrometer library\nfeature(web): MetricInterceptor to publish equal set of tags; MetricInterceptor now supports publishing query parameters to metrics (extracted from Kayenta)", "committedDate": "2020-04-21T09:15:23Z", "type": "commit"}, {"oid": "b5f20d94030d816daab9c134632f8095a83bd5eb", "url": "https://github.com/spinnaker/kork/commit/b5f20d94030d816daab9c134632f8095a83bd5eb", "message": "Merge branch 'fix/micrometer-integration' of https://github.com/Aloren/kork into fix/micrometer-integration", "committedDate": "2020-04-21T09:19:09Z", "type": "commit"}, {"oid": "d89b031ea87b9678d76b294003af538de14cc11e", "url": "https://github.com/spinnaker/kork/commit/d89b031ea87b9678d76b294003af538de14cc11e", "message": "fix spectator-reg-micrometer scope", "committedDate": "2020-04-21T09:22:31Z", "type": "commit"}, {"oid": "8daa5b682b35e4e08fb466c470f0ca9488ef24a0", "url": "https://github.com/spinnaker/kork/commit/8daa5b682b35e4e08fb466c470f0ca9488ef24a0", "message": "Merge branch 'master' into fix/micrometer-integration", "committedDate": "2020-04-21T09:24:35Z", "type": "commit"}]}