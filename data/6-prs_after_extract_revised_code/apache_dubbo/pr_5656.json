{"pr_number": 5656, "pr_title": "[DUBBO-4288]: simple workaround to make shutdown hook work again when DubboBootstrap is not used", "pr_createdAt": "2020-01-15T11:21:17Z", "pr_url": "https://github.com/apache/dubbo/pull/5656", "timeline": [{"oid": "74130187a7cc7366c51219a47affe2cd2acc4a09", "url": "https://github.com/apache/dubbo/commit/74130187a7cc7366c51219a47affe2cd2acc4a09", "message": "issue4288: simple workaround to make shutdown hook work again when DubboBootstrap is not used", "committedDate": "2020-01-15T11:18:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Njg0NzQwNQ==", "url": "https://github.com/apache/dubbo/pull/5656#discussion_r366847405", "bodyText": "If DubboBootstrap is enabled, will it also register the DubboShutdownHook and repeatedly call these destroy operations?", "author": "CodingSinger", "createdAt": "2020-01-15T12:23:00Z", "path": "dubbo-config/dubbo-config-api/src/main/java/org/apache/dubbo/config/DubboShutdownHook.java", "diffHunk": "@@ -91,6 +92,11 @@ public void register() {\n             DubboShutdownHook dubboShutdownHook = getDubboShutdownHook();\n             Runtime.getRuntime().addShutdownHook(dubboShutdownHook);\n             dispatch(new DubboShutdownHookRegisteredEvent(dubboShutdownHook));\n+            ShutdownHookCallbacks.INSTANCE.addCallback(() -> {", "originalCommit": "74130187a7cc7366c51219a47affe2cd2acc4a09", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzIzMDA0NQ==", "url": "https://github.com/apache/dubbo/pull/5656#discussion_r367230045", "bodyText": "will not, but I've change the implement already.", "author": "beiwei30", "createdAt": "2020-01-16T04:52:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Njg0NzQwNQ=="}], "type": "inlineReview", "revised_code": {"commit": "22aca75bed4c6d155a60eb74899c05156e197447", "chunk": "diff --git a/dubbo-config/dubbo-config-api/src/main/java/org/apache/dubbo/config/DubboShutdownHook.java b/dubbo-config/dubbo-config-api/src/main/java/org/apache/dubbo/config/DubboShutdownHook.java\nindex dd272c166..36ac2fedd 100644\n--- a/dubbo-config/dubbo-config-api/src/main/java/org/apache/dubbo/config/DubboShutdownHook.java\n+++ b/dubbo-config/dubbo-config-api/src/main/java/org/apache/dubbo/config/DubboShutdownHook.java\n\n@@ -92,11 +92,6 @@ public class DubboShutdownHook extends Thread {\n             DubboShutdownHook dubboShutdownHook = getDubboShutdownHook();\n             Runtime.getRuntime().addShutdownHook(dubboShutdownHook);\n             dispatch(new DubboShutdownHookRegisteredEvent(dubboShutdownHook));\n-            ShutdownHookCallbacks.INSTANCE.addCallback(() -> {\n-                // backward compatibility: make sure shutdown logic takes effect when DubboBootstrap is not used.\n-                AbstractRegistryFactory.destroyAll();\n-                this.destroyProtocols();\n-            });\n         }\n     }\n \n"}}, {"oid": "22aca75bed4c6d155a60eb74899c05156e197447", "url": "https://github.com/apache/dubbo/commit/22aca75bed4c6d155a60eb74899c05156e197447", "message": "introduce destroyAll() method", "committedDate": "2020-01-16T02:25:56Z", "type": "commit"}, {"oid": "81cf28b3b200b25199af103352e2836097025f77", "url": "https://github.com/apache/dubbo/commit/81cf28b3b200b25199af103352e2836097025f77", "message": "make ReferenceConfig and ServiceConfig do not depend on DubboBootstrap any longer", "committedDate": "2020-01-16T04:37:38Z", "type": "commit"}, {"oid": "81481a1e5a0a39e818136124dade46b30f0fbb68", "url": "https://github.com/apache/dubbo/commit/81481a1e5a0a39e818136124dade46b30f0fbb68", "message": "cannot remove DubboBootstrap for now, need to revisit it in the next release", "committedDate": "2020-01-16T07:06:17Z", "type": "commit"}, {"oid": "bbdd108b19319a882333389a32290b5bda7de557", "url": "https://github.com/apache/dubbo/commit/bbdd108b19319a882333389a32290b5bda7de557", "message": "no need to create default monitor for now", "committedDate": "2020-01-16T07:08:54Z", "type": "commit"}, {"oid": "21c0ae20a7039b89d4b8fdd06afa688e9e4f8a33", "url": "https://github.com/apache/dubbo/commit/21c0ae20a7039b89d4b8fdd06afa688e9e4f8a33", "message": "Merge branch 'master' into issue4288", "committedDate": "2020-01-17T06:20:11Z", "type": "commit"}]}