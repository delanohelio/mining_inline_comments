{"pr_number": 3457, "pr_title": "[risk=no][RW-4678]Followup: don't spam logs and make proper float comparisons", "pr_createdAt": "2020-04-22T22:59:02Z", "pr_url": "https://github.com/all-of-us/workbench/pull/3457", "timeline": [{"oid": "38a77cafd87e0532f89b7f7c5d1b5139168f9096", "url": "https://github.com/all-of-us/workbench/commit/38a77cafd87e0532f89b7f7c5d1b5139168f9096", "message": "only log anomalies withinCostTolerance", "committedDate": "2020-04-22T22:39:51Z", "type": "commit"}, {"oid": "440a34c9de7a1c005ff0a56ead985087329a7fc7", "url": "https://github.com/all-of-us/workbench/commit/440a34c9de7a1c005ff0a56ead985087329a7fc7", "message": "lint", "committedDate": "2020-04-22T22:49:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzc3MTg1OA==", "url": "https://github.com/all-of-us/workbench/pull/3457#discussion_r413771858", "bodyText": "Please check if there's a library function for this. As excited as I am to see actual math for the first time in 2020, we shouldn't be doing it this way. If we keep this, we probably need to make a constant out of the tolerance.\nAdditionally, why are we using doubles instead of a Currency class?", "author": "jaycarlton", "createdAt": "2020-04-23T12:26:48Z", "path": "api/src/main/java/org/pmiops/workbench/billing/FreeTierBillingService.java", "diffHunk": "@@ -151,6 +151,12 @@ private void sendAlertsForCostThresholds(\n         });\n   }\n \n+  // are these two cost values approximately equal?\n+  // used to determine whether we should log anomalies\n+  private boolean withinCostTolerance(double currentCost, double previousCost) {", "originalCommit": "440a34c9de7a1c005ff0a56ead985087329a7fc7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzg1OTE2MA==", "url": "https://github.com/all-of-us/workbench/pull/3457#discussion_r413859160", "bodyText": "good call re: library function.  I'll update.\nre: Currency.  When implemented, that seemed like overkill for our application since we're not doing anything complex and we don't require financial-level precision.  I'm open to the change if we think it's justified.", "author": "jmthibault79", "createdAt": "2020-04-23T14:45:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzc3MTg1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzg4MzM2Ng==", "url": "https://github.com/all-of-us/workbench/pull/3457#discussion_r413883366", "bodyText": "Ultimately we retrieve these values from BigQuery as doubles, so we'll never have the integer-like precision we'd really want in a Currency.", "author": "jmthibault79", "createdAt": "2020-04-23T15:12:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzc3MTg1OA=="}], "type": "inlineReview", "revised_code": {"commit": "d520d0c749740f4c50eae8dd959af149c9682c04", "chunk": "diff --git a/api/src/main/java/org/pmiops/workbench/billing/FreeTierBillingService.java b/api/src/main/java/org/pmiops/workbench/billing/FreeTierBillingService.java\nindex f984914a2..029c473c2 100644\n--- a/api/src/main/java/org/pmiops/workbench/billing/FreeTierBillingService.java\n+++ b/api/src/main/java/org/pmiops/workbench/billing/FreeTierBillingService.java\n\n@@ -151,12 +164,6 @@ public class FreeTierBillingService {\n         });\n   }\n \n-  // are these two cost values approximately equal?\n-  // used to determine whether we should log anomalies\n-  private boolean withinCostTolerance(double currentCost, double previousCost) {\n-    return Math.abs(currentCost - previousCost) < 0.000001;\n-  }\n-\n   /**\n    * Has this user passed a cost threshold between this check and the previous run?\n    *\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzc3MjUxOA==", "url": "https://github.com/all-of-us/workbench/pull/3457#discussion_r413772518", "bodyText": "Let's see if we can add an audit entry for this, since it's more user-oriented than system- or application-oriented.", "author": "jaycarlton", "createdAt": "2020-04-23T12:27:50Z", "path": "api/src/main/java/org/pmiops/workbench/billing/FreeTierBillingService.java", "diffHunk": "@@ -170,7 +176,10 @@ private void maybeAlertOnCostThresholds(\n \n     // this shouldn't happen, but it did (RW-4678)\n     // alert if it happens again\n-    if (currentCost < previousCost) {\n+    if (currentCost < previousCost\n+        &&\n+        // was logging many false positives\n+        !withinCostTolerance(currentCost, previousCost)) {", "originalCommit": "440a34c9de7a1c005ff0a56ead985087329a7fc7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzgxNzQ5OA==", "url": "https://github.com/all-of-us/workbench/pull/3457#discussion_r413817498", "bodyText": "The purpose of this log is to alert us to bugs in our system, rather than reflecting an actual user condition.  Does that change your judgment of audit vs log?", "author": "jmthibault79", "createdAt": "2020-04-23T13:58:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzc3MjUxOA=="}], "type": "inlineReview", "revised_code": {"commit": "d520d0c749740f4c50eae8dd959af149c9682c04", "chunk": "diff --git a/api/src/main/java/org/pmiops/workbench/billing/FreeTierBillingService.java b/api/src/main/java/org/pmiops/workbench/billing/FreeTierBillingService.java\nindex f984914a2..029c473c2 100644\n--- a/api/src/main/java/org/pmiops/workbench/billing/FreeTierBillingService.java\n+++ b/api/src/main/java/org/pmiops/workbench/billing/FreeTierBillingService.java\n\n@@ -176,10 +183,7 @@ public class FreeTierBillingService {\n \n     // this shouldn't happen, but it did (RW-4678)\n     // alert if it happens again\n-    if (currentCost < previousCost\n-        &&\n-        // was logging many false positives\n-        !withinCostTolerance(currentCost, previousCost)) {\n+    if (compareCosts(currentCost, previousCost) < 0) {\n       String msg =\n           String.format(\n               \"User %s (%s) has %f in total free tier spending in BigQuery, \"\n"}}, {"oid": "d520d0c749740f4c50eae8dd959af149c9682c04", "url": "https://github.com/all-of-us/workbench/commit/d520d0c749740f4c50eae8dd959af149c9682c04", "message": "proper double math", "committedDate": "2020-04-23T15:11:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzg5MjUyMg==", "url": "https://github.com/all-of-us/workbench/pull/3457#discussion_r413892522", "bodyText": "I wrote a little utility class for this so you don't have to remember the convention. org.pmiops.workbench.utils.Comparables\nIf you wanted to use it here, you'd need to have a little Comparable class wrapping the fuzzyCompare method. Assuming the convention is the same. I think you'd have make a comparable FuzzyCost class to wrap Double or something though, so not a huge win.", "author": "jaycarlton", "createdAt": "2020-04-23T15:23:43Z", "path": "api/src/main/java/org/pmiops/workbench/billing/FreeTierBillingService.java", "diffHunk": "@@ -123,8 +128,16 @@ public void checkFreeTierBillingUsage() {\n     sendAlertsForCostThresholds(usersToThresholdCheck, previousUserCosts, userCosts);\n   }\n \n+  private int compareCosts(final double a, final double b) {", "originalCommit": "d520d0c749740f4c50eae8dd959af149c9682c04", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzkxMjMyNw==", "url": "https://github.com/all-of-us/workbench/pull/3457#discussion_r413912327", "bodyText": "There's probably a way to figure this out based on use cases. I know from geometry angle and linear tolerance are different too. This is probably OK.", "author": "jaycarlton", "createdAt": "2020-04-23T15:48:10Z", "path": "api/src/main/java/org/pmiops/workbench/billing/FreeTierBillingService.java", "diffHunk": "@@ -46,6 +47,10 @@\n \n   private static final Logger logger = Logger.getLogger(FreeTierBillingService.class.getName());\n \n+  // somewhat arbitrary\n+  private static final double COST_COMPARISON_TOLERANCE = 0.0001;\n+  private static final double COST_FRACTION_TOLERANCE = 0.0001;", "originalCommit": "d520d0c749740f4c50eae8dd959af149c9682c04", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "dbb76ee49ce1646aa02ae94a5230766120421bb1", "chunk": "diff --git a/api/src/main/java/org/pmiops/workbench/billing/FreeTierBillingService.java b/api/src/main/java/org/pmiops/workbench/billing/FreeTierBillingService.java\nindex 029c473c2..37146d8f3 100644\n--- a/api/src/main/java/org/pmiops/workbench/billing/FreeTierBillingService.java\n+++ b/api/src/main/java/org/pmiops/workbench/billing/FreeTierBillingService.java\n\n@@ -47,9 +47,9 @@ public class FreeTierBillingService {\n \n   private static final Logger logger = Logger.getLogger(FreeTierBillingService.class.getName());\n \n-  // somewhat arbitrary\n-  private static final double COST_COMPARISON_TOLERANCE = 0.0001;\n-  private static final double COST_FRACTION_TOLERANCE = 0.0001;\n+  // somewhat arbitrary - 1 per million\n+  private static final double COST_COMPARISON_TOLERANCE = 0.000001;\n+  private static final double COST_FRACTION_TOLERANCE = 0.000001;\n \n   @Autowired\n   public FreeTierBillingService(\n"}}, {"oid": "dbb76ee49ce1646aa02ae94a5230766120421bb1", "url": "https://github.com/all-of-us/workbench/commit/dbb76ee49ce1646aa02ae94a5230766120421bb1", "message": "Decrease tolerance to catch one-cent changes", "committedDate": "2020-04-23T16:49:36Z", "type": "commit"}, {"oid": "d8ab071aca51ffb294c3d6d8abd7e1b34015274d", "url": "https://github.com/all-of-us/workbench/commit/d8ab071aca51ffb294c3d6d8abd7e1b34015274d", "message": "tighter tolerances exposed a bad test", "committedDate": "2020-04-23T16:55:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzk3MzE4OA==", "url": "https://github.com/all-of-us/workbench/pull/3457#discussion_r413973188", "bodyText": "copypaste.  this test uses different thresholds.", "author": "jmthibault79", "createdAt": "2020-04-23T17:08:49Z", "path": "api/src/test/java/org/pmiops/workbench/billing/FreeTierBillingServiceTest.java", "diffHunk": "@@ -241,7 +241,7 @@ public void checkFreeTierBillingUsage_altDollarThresholds() throws MessagingExce\n         .alertUserFreeTierDollarThreshold(\n             eq(user), eq(threshold), eq(costOverThreshold), eq(remaining));\n \n-    // check that we do not alert twice for the 75% threshold\n+    // check that we do not alert twice for the 65% threshold", "originalCommit": "d8ab071aca51ffb294c3d6d8abd7e1b34015274d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzk3Mzc5MQ==", "url": "https://github.com/all-of-us/workbench/pull/3457#discussion_r413973791", "bodyText": "this was wrong!  but close enough due to loose tolerance.  No longer.", "author": "jmthibault79", "createdAt": "2020-04-23T17:09:41Z", "path": "api/src/test/java/org/pmiops/workbench/billing/FreeTierBillingServiceTest.java", "diffHunk": "@@ -555,14 +555,14 @@ public void getUserCachedFreeTierUsage() {\n     createWorkspace(user1, \"another project\");\n \n     final Map<String, Double> costs =\n-        ImmutableMap.of(SINGLE_WORKSPACE_TEST_PROJECT, 1000.0, \"another project\", 100.0);\n+        ImmutableMap.of(SINGLE_WORKSPACE_TEST_PROJECT, 1000.0, \"another project\", 200.0);\n     doReturn(mockBQTableResult(costs)).when(bigQueryService).executeQuery(any());\n \n     // we have not yet cached the new workspace costs\n     assertWithinBillingTolerance(freeTierBillingService.getCachedFreeTierUsage(user1), 100.01);\n \n     freeTierBillingService.checkFreeTierBillingUsage();\n-    final double expectedTotalCachedFreeTierUsage = 1000.0 + 100.01;", "originalCommit": "d8ab071aca51ffb294c3d6d8abd7e1b34015274d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}