{"pr_number": 3123, "pr_title": "[RW-4386][risk=low] Set correct billing status after updating a workspace's billing account", "pr_createdAt": "2020-02-12T21:38:33Z", "pr_url": "https://github.com/all-of-us/workbench/pull/3123", "timeline": [{"oid": "90e2351daa1332cb4f3ab09176f730e479baf051", "url": "https://github.com/all-of-us/workbench/commit/90e2351daa1332cb4f3ab09176f730e479baf051", "message": "add failing tests", "committedDate": "2020-02-07T16:52:52Z", "type": "commit"}, {"oid": "b5d32ab38adfd7eaeec75b1879ab81917f4a99af", "url": "https://github.com/all-of-us/workbench/commit/b5d32ab38adfd7eaeec75b1879ab81917f4a99af", "message": "passing tests", "committedDate": "2020-02-12T20:01:10Z", "type": "commit"}, {"oid": "6eb9d57ccd2e849ca0d2f683c976bbbb0102cd40", "url": "https://github.com/all-of-us/workbench/commit/6eb9d57ccd2e849ca0d2f683c976bbbb0102cd40", "message": "remove log", "committedDate": "2020-02-12T21:40:18Z", "type": "commit"}, {"oid": "5d622c644f43d09cb42db5b87d7c5bc8cf44fba8", "url": "https://github.com/all-of-us/workbench/commit/5d622c644f43d09cb42db5b87d7c5bc8cf44fba8", "message": "spotless", "committedDate": "2020-02-12T21:40:49Z", "type": "commit"}, {"oid": "f23c930c55bf6ddf3cdd5cecdb39399a274e0d4c", "url": "https://github.com/all-of-us/workbench/commit/f23c930c55bf6ddf3cdd5cecdb39399a274e0d4c", "message": "Merge branch 'master' of github.com:all-of-us/workbench into songe/RW-4386", "committedDate": "2020-02-12T22:02:52Z", "type": "commit"}, {"oid": "a97f1c6b8aef54a489aa24b948f99a0eb971ccf0", "url": "https://github.com/all-of-us/workbench/commit/a97f1c6b8aef54a489aa24b948f99a0eb971ccf0", "message": "show user a specific error message. recheck banner state on workspace reload", "committedDate": "2020-02-12T23:47:45Z", "type": "commit"}, {"oid": "62e15ba794c79d2061e68b922b1e0d5a6b3a7142", "url": "https://github.com/all-of-us/workbench/commit/62e15ba794c79d2061e68b922b1e0d5a6b3a7142", "message": "exception handling", "committedDate": "2020-02-12T23:48:17Z", "type": "commit"}, {"oid": "d8270a75f9a48dbdd193f85c5e45bc17523d06d5", "url": "https://github.com/all-of-us/workbench/commit/d8270a75f9a48dbdd193f85c5e45bc17523d06d5", "message": "spotless", "committedDate": "2020-02-12T23:50:02Z", "type": "commit"}, {"oid": "62af3a13a979a5cd570824f094532795f751fe4d", "url": "https://github.com/all-of-us/workbench/commit/62af3a13a979a5cd570824f094532795f751fe4d", "message": "fix tests", "committedDate": "2020-02-13T17:12:32Z", "type": "commit"}, {"oid": "f300030f9fe7c9ac1f7e9b1a988fcb23a3566959", "url": "https://github.com/all-of-us/workbench/commit/f300030f9fe7c9ac1f7e9b1a988fcb23a3566959", "message": "lint", "committedDate": "2020-02-13T17:18:44Z", "type": "commit"}, {"oid": "9955cf854708837dfc38a3f3e87b164bf699fba8", "url": "https://github.com/all-of-us/workbench/commit/9955cf854708837dfc38a3f3e87b164bf699fba8", "message": "spotless", "committedDate": "2020-02-13T17:28:20Z", "type": "commit"}, {"oid": "7669c17b0a5f8ac39381a7bf4458de254a4f2ca8", "url": "https://github.com/all-of-us/workbench/commit/7669c17b0a5f8ac39381a7bf4458de254a4f2ca8", "message": "fix bq test", "committedDate": "2020-02-13T17:40:14Z", "type": "commit"}, {"oid": "775a6b7f12308fb15688c1fccb3b786497656473", "url": "https://github.com/all-of-us/workbench/commit/775a6b7f12308fb15688c1fccb3b786497656473", "message": "comment", "committedDate": "2020-02-13T18:10:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTAzNzI5OA==", "url": "https://github.com/all-of-us/workbench/pull/3123#discussion_r379037298", "bodyText": "[nit] May be marginally more readable to replace orElse(false) with isPresent()", "author": "gjuggler", "createdAt": "2020-02-13T18:22:42Z", "path": "api/src/main/java/org/pmiops/workbench/workspaces/WorkspaceServiceImpl.java", "diffHunk": "@@ -694,6 +698,16 @@ public void updateWorkspaceBillingAccount(DbWorkspace workspace, String newBilli\n       cloudbilling = serviceAccountCloudbillingProvider.get();\n     } else {\n       cloudbilling = endUserCloudbillingProvider.get();\n+      try {\n+        if (!Optional.ofNullable(", "originalCommit": "775a6b7f12308fb15688c1fccb3b786497656473", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE2MjQ0Ng==", "url": "https://github.com/all-of-us/workbench/pull/3123#discussion_r379162446", "bodyText": "That's actually a different statement since isPresent() would return true if isOpen is set to false.\nBut probably not a good sign if that's not clear so I refactored it a little bit by pulling out a variable.", "author": "ericsong", "createdAt": "2020-02-13T22:47:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTAzNzI5OA=="}], "type": "inlineReview", "revised_code": {"commit": "e6b9c0647243ef729bc61ac62319a5168d2ae5e4", "chunk": "diff --git a/api/src/main/java/org/pmiops/workbench/workspaces/WorkspaceServiceImpl.java b/api/src/main/java/org/pmiops/workbench/workspaces/WorkspaceServiceImpl.java\nindex cf435d0ba..bae3fd5e5 100644\n--- a/api/src/main/java/org/pmiops/workbench/workspaces/WorkspaceServiceImpl.java\n+++ b/api/src/main/java/org/pmiops/workbench/workspaces/WorkspaceServiceImpl.java\n\n@@ -699,9 +699,11 @@ public class WorkspaceServiceImpl implements WorkspaceService, GaugeDataCollecto\n     } else {\n       cloudbilling = endUserCloudbillingProvider.get();\n       try {\n-        if (!Optional.ofNullable(\n-                cloudbilling.billingAccounts().get(newBillingAccountName).execute().getOpen())\n-            .orElse(false)) {\n+        Optional<Boolean> isOpenMaybe =\n+            Optional.ofNullable(\n+                cloudbilling.billingAccounts().get(newBillingAccountName).execute().getOpen());\n+        boolean isOpen = isOpenMaybe.orElse(false);\n+        if (!isOpen) {\n           throw new BadRequestException(\n               \"Provided billing account is closed. Please provide an open account.\");\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTA0MDIwNQ==", "url": "https://github.com/all-of-us/workbench/pull/3123#discussion_r379040205", "bodyText": "I'm just sad for whoever (at Google?) decided that \"Cloudbilling\" shouldn't have a capital \"B\"... \ud83d\ude44", "author": "gjuggler", "createdAt": "2020-02-13T18:28:08Z", "path": "api/src/test/java/org/pmiops/workbench/workspaces/WorkspacesControllerTest.java", "diffHunk": "@@ -246,6 +247,9 @@\n   @Autowired\n   private Provider<Cloudbilling> serviceAccountCloudbillingProvider;\n \n+  private static Cloudbilling endUserCloudbilling;", "originalCommit": "775a6b7f12308fb15688c1fccb3b786497656473", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTA3Nzg5MA==", "url": "https://github.com/all-of-us/workbench/pull/3123#discussion_r379077890", "bodyText": "[opt] I tend to try to avoid abbreviations for var names in Java, though they're prevalent enough in our codebase I wouldn't block on this.", "author": "gjuggler", "createdAt": "2020-02-13T19:40:19Z", "path": "api/src/test/java/org/pmiops/workbench/workspaces/WorkspacesControllerTest.java", "diffHunk": "@@ -787,22 +793,156 @@ public void testUpdateWorkspace() throws Exception {\n   }\n \n   @Test\n-  public void testUpdateWorkspace_freeTierBilling() throws Exception {\n+  public void testUpdateWorkspace_freeTierBilling_usesCorrectProvider() throws Exception {\n     Workspace ws = createWorkspace();\n     ws = workspacesController.createWorkspace(ws).getBody();\n \n-    verify(endUserCloudbillingProvider.get()).projects();\n-    verifyZeroInteractions(serviceAccountCloudbillingProvider.get());\n+    // Creating the workspace with a user provided billing account\n+    endUserCloudbilling = TestMockFactory.createMockedCloudbilling();\n+    serviceAccountCloudbilling = TestMockFactory.createMockedCloudbilling();\n \n     UpdateWorkspaceRequest request = new UpdateWorkspaceRequest();\n     ws.setBillingAccountName(workbenchConfig.billing.freeTierBillingAccountName());\n     request.setWorkspace(ws);\n     workspacesController.updateWorkspace(ws.getNamespace(), ws.getId(), request);\n \n-    verifyNoMoreInteractions(endUserCloudbillingProvider.get());\n+    verifyZeroInteractions(endUserCloudbillingProvider.get());\n     verify(serviceAccountCloudbillingProvider.get()).projects();\n   }\n \n+  @Test\n+  public void testUpdateWorkspace_freeTierBilling_noCreditsRemaining() throws Exception {\n+    Workspace ws = createWorkspace();", "originalCommit": "775a6b7f12308fb15688c1fccb3b786497656473", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e6b9c0647243ef729bc61ac62319a5168d2ae5e4", "chunk": "diff --git a/api/src/test/java/org/pmiops/workbench/workspaces/WorkspacesControllerTest.java b/api/src/test/java/org/pmiops/workbench/workspaces/WorkspacesControllerTest.java\nindex 3e8d7f035..3ebbb967b 100644\n--- a/api/src/test/java/org/pmiops/workbench/workspaces/WorkspacesControllerTest.java\n+++ b/api/src/test/java/org/pmiops/workbench/workspaces/WorkspacesControllerTest.java\n\n@@ -794,17 +794,17 @@ public class WorkspacesControllerTest {\n \n   @Test\n   public void testUpdateWorkspace_freeTierBilling_usesCorrectProvider() throws Exception {\n-    Workspace ws = createWorkspace();\n-    ws = workspacesController.createWorkspace(ws).getBody();\n+    Workspace workspace = createWorkspace();\n+    workspace = workspacesController.createWorkspace(workspace).getBody();\n \n     // Creating the workspace with a user provided billing account\n     endUserCloudbilling = TestMockFactory.createMockedCloudbilling();\n     serviceAccountCloudbilling = TestMockFactory.createMockedCloudbilling();\n \n     UpdateWorkspaceRequest request = new UpdateWorkspaceRequest();\n-    ws.setBillingAccountName(workbenchConfig.billing.freeTierBillingAccountName());\n-    request.setWorkspace(ws);\n-    workspacesController.updateWorkspace(ws.getNamespace(), ws.getId(), request);\n+    workspace.setBillingAccountName(workbenchConfig.billing.freeTierBillingAccountName());\n+    request.setWorkspace(workspace);\n+    workspacesController.updateWorkspace(workspace.getNamespace(), workspace.getId(), request);\n \n     verifyZeroInteractions(endUserCloudbillingProvider.get());\n     verify(serviceAccountCloudbillingProvider.get()).projects();\n"}}, {"oid": "e6b9c0647243ef729bc61ac62319a5168d2ae5e4", "url": "https://github.com/all-of-us/workbench/commit/e6b9c0647243ef729bc61ac62319a5168d2ae5e4", "message": "spotless", "committedDate": "2020-02-13T22:51:51Z", "type": "commit"}]}