{"pr_number": 3751, "pr_title": "[RW-5060][RISK=LOW]  DataSetController - reduce number of args passed to dataSetService#saveDataSet", "pr_createdAt": "2020-07-07T17:14:55Z", "pr_url": "https://github.com/all-of-us/workbench/pull/3751", "timeline": [{"oid": "46b6190f6caea619d91b6f159bdbb886c7cd0a39", "url": "https://github.com/all-of-us/workbench/commit/46b6190f6caea619d91b6f159bdbb886c7cd0a39", "message": "Reduce arguments for DataSetService save", "committedDate": "2020-07-07T17:11:35Z", "type": "commit"}, {"oid": "c8a1d7e4f4e9c1f784e8d68409f0767be8a8ca02", "url": "https://github.com/all-of-us/workbench/commit/c8a1d7e4f4e9c1f784e8d68409f0767be8a8ca02", "message": "Fix Api test : Add null or Empty check for data set version\n;", "committedDate": "2020-07-07T17:35:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA0MDY4Ng==", "url": "https://github.com/all-of-us/workbench/pull/3751#discussion_r451040686", "bodyText": "I had to delete this otherwise DataSetMapper was using this method for the method  DbDataset dataSetRequestToDb(DataSetRequest dataSetRequest);\nand then starting throwing exception (for each attribute)  \"lastModifiedTIME\" not found did you mean null", "author": "NehaBroad", "createdAt": "2020-07-07T17:50:01Z", "path": "api/src/main/java/org/pmiops/workbench/db/model/DbDataset.java", "diffHunk": "@@ -277,101 +260,4 @@ public int hashCode() {\n   public String toString() {\n     return ToStringBuilder.reflectionToString(this);\n   }\n-\n-  public static DbDataset.Builder builder() {", "originalCommit": "c8a1d7e4f4e9c1f784e8d68409f0767be8a8ca02", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "257852fbb5b29e194b4aef682894975640ab6c12", "url": "https://github.com/all-of-us/workbench/commit/257852fbb5b29e194b4aef682894975640ab6c12", "message": "Resol ve conflict", "committedDate": "2020-07-07T18:30:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA2ODUxMw==", "url": "https://github.com/all-of-us/workbench/pull/3751#discussion_r451068513", "bodyText": "I think you need to revert this block and leave the code the way it was for purposes of how the rename has to work. This will be a breaking change to the rename dataset.", "author": "freemabd", "createdAt": "2020-07-07T18:40:50Z", "path": "api/src/main/java/org/pmiops/workbench/api/DataSetController.java", "diffHunk": "@@ -437,34 +416,27 @@ private void formatTimestampValues(List<DataSetPreviewValueList> valuePreviewLis\n     if (Strings.isNullOrEmpty(request.getEtag())) {\n       throw new BadRequestException(\"missing required update field 'etag'\");\n     }\n+    final Timestamp now = new Timestamp(clock.instant().toEpochMilli());\n     DbWorkspace workspace =\n         workspaceService.getWorkspaceEnforceAccessLevelAndSetCdrVersion(\n             workspaceNamespace, workspaceId, WorkspaceAccessLevel.WRITER);\n-\n+    request.setWorkspaceId(workspace.getWorkspaceId());\n     DbDataset dbDataSet = dataSetService.getDbDataSet(workspace, dataSetId).get();\n \n     int version = Etags.toVersion(request.getEtag());\n     if (dbDataSet.getVersion() != version) {\n       throw new ConflictException(\"Attempted to modify outdated data set version\");\n     }\n-    Timestamp now = new Timestamp(clock.instant().toEpochMilli());\n-    dbDataSet.setName(request.getName());\n-    dbDataSet.setDescription(request.getDescription());\n-    dbDataSet.setLastModifiedTime(now);\n-    if (request.getDomainValuePairs() != null) {\n-      dbDataSet.setIncludesAllParticipants(request.getIncludesAllParticipants());\n-      dbDataSet.setCohortIds(request.getCohortIds());\n-      dbDataSet.setConceptSetIds(request.getConceptSetIds());\n-      dbDataSet.setPrePackagedConceptSetEnum(request.getPrePackagedConceptSet());\n-      dbDataSet.setValues(\n-          request.getDomainValuePairs().stream()\n-              .map(this::getDataSetValuesFromDomainValueSet)\n-              .collect(Collectors.toList()));\n-    }\n+    DbDataset dbMappingConvert = dataSetMapper.dataSetRequestToDb(request);\n+    dbMappingConvert.setDataSetId(dbDataSet.getDataSetId());\n+    dbMappingConvert.setInvalid(false);\n+    dbMappingConvert.setCreatorId(dbDataSet.getCreatorId());\n+    dbMappingConvert.setCreationTime(dbDataSet.getCreationTime());\n+    dbMappingConvert.setLastModifiedTime(now);", "originalCommit": "257852fbb5b29e194b4aef682894975640ab6c12", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA3NjY3NA==", "url": "https://github.com/all-of-us/workbench/pull/3751#discussion_r451076674", "bodyText": "We need to add a test case for the dataset rename that would have caught this type of code change. Don't have to do it in this PR.", "author": "freemabd", "createdAt": "2020-07-07T18:56:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA2ODUxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA4NDkwNg==", "url": "https://github.com/all-of-us/workbench/pull/3751#discussion_r451084906", "bodyText": "Is this because rename just going to send the name and id and not the cohort/Concept Ids ? If yes should i add a comment /TODO to remove this once we will introduce a new endpoint?", "author": "NehaBroad", "createdAt": "2020-07-07T19:12:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA2ODUxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTEwMDMzNg==", "url": "https://github.com/all-of-us/workbench/pull/3751#discussion_r451100336", "bodyText": "Correct. And this was the fix... so we didn't need a new endpoint.", "author": "freemabd", "createdAt": "2020-07-07T19:42:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA2ODUxMw=="}], "type": "inlineReview", "revised_code": {"commit": "4cbb3419841ab19598ea993f0dc15448a8397f3a", "chunk": "diff --git a/api/src/main/java/org/pmiops/workbench/api/DataSetController.java b/api/src/main/java/org/pmiops/workbench/api/DataSetController.java\nindex cd217fd92..930e4b774 100644\n--- a/api/src/main/java/org/pmiops/workbench/api/DataSetController.java\n+++ b/api/src/main/java/org/pmiops/workbench/api/DataSetController.java\n\n@@ -427,13 +427,12 @@ public class DataSetController implements DataSetApiDelegate {\n     if (dbDataSet.getVersion() != version) {\n       throw new ConflictException(\"Attempted to modify outdated data set version\");\n     }\n-    DbDataset dbMappingConvert = dataSetMapper.dataSetRequestToDb(request);\n-    dbMappingConvert.setDataSetId(dbDataSet.getDataSetId());\n-    dbMappingConvert.setInvalid(false);\n+    DbDataset dbMappingConvert = dataSetMapper.dataSetRequestToDb(request, dbDataSet);\n     dbMappingConvert.setCreatorId(dbDataSet.getCreatorId());\n     dbMappingConvert.setCreationTime(dbDataSet.getCreationTime());\n+    dbMappingConvert.setInvalid(false);\n+    dbMappingConvert.setDataSetId(dbDataSet.getDataSetId());\n     dbMappingConvert.setLastModifiedTime(now);\n-\n     dataSetService.saveDataSet(dbMappingConvert);\n \n     return ResponseEntity.ok(dataSetMapper.dbModelToClient(dbMappingConvert));\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA3MDA5Mg==", "url": "https://github.com/all-of-us/workbench/pull/3751#discussion_r451070092", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              @Mapping(target = \"version\", source = \"etag\")\n          \n          \n            \n              @Mapping(target = \"version\", source = \"etag\", qualifiedByName = \"etagToCdrVersion\")", "author": "freemabd", "createdAt": "2020-07-07T18:43:49Z", "path": "api/src/main/java/org/pmiops/workbench/dataset/DataSetMapper.java", "diffHunk": "@@ -37,17 +42,47 @@\n   @Named(\"dbModelToClientLight\")\n   DataSet dbModelToClientLight(DbDataset dbDataset);\n \n+  @Mapping(target = \"dataSetId\", ignore = true)\n+  @Mapping(target = \"version\", source = \"etag\")", "originalCommit": "257852fbb5b29e194b4aef682894975640ab6c12", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "4cbb3419841ab19598ea993f0dc15448a8397f3a", "chunk": "diff --git a/api/src/main/java/org/pmiops/workbench/dataset/DataSetMapper.java b/api/src/main/java/org/pmiops/workbench/dataset/DataSetMapper.java\nindex 395ba0df0..182762350 100644\n--- a/api/src/main/java/org/pmiops/workbench/dataset/DataSetMapper.java\n+++ b/api/src/main/java/org/pmiops/workbench/dataset/DataSetMapper.java\n\n@@ -43,14 +46,18 @@ public interface DataSetMapper {\n   DataSet dbModelToClientLight(DbDataset dbDataset);\n \n   @Mapping(target = \"dataSetId\", ignore = true)\n-  @Mapping(target = \"version\", source = \"etag\")\n+  @Mapping(\n+      target = \"version\",\n+      source = \"etag\",\n+      qualifiedByName = \"etagToCdrVersion\",\n+      nullValueCheckStrategy = NullValueCheckStrategy.ALWAYS)\n   @Mapping(target = \"creatorId\", ignore = true)\n   @Mapping(target = \"creationTime\", ignore = true)\n   @Mapping(target = \"invalid\", ignore = true)\n   @Mapping(target = \"lastModifiedTime\", ignore = true)\n   @Mapping(target = \"prePackagedConceptSetEnum\", ignore = true)\n   @Mapping(target = \"values\", source = \"domainValuePairs\")\n-  DbDataset dataSetRequestToDb(DataSetRequest dataSetRequest);\n+  DbDataset dataSetRequestToDb(DataSetRequest dataSetRequest, @Context DbDataset dbDataSet);\n \n   @Mapping(target = \"id\", source = \"dataSetId\")\n   @Mapping(target = \"conceptSets\", source = \"conceptSetIds\")\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA3MDkyOA==", "url": "https://github.com/all-of-us/workbench/pull/3751#discussion_r451070928", "bodyText": "Remove this and use qualifiedByName above. This method exists in CommonMappers.", "author": "freemabd", "createdAt": "2020-07-07T18:45:21Z", "path": "api/src/main/java/org/pmiops/workbench/dataset/DataSetMapper.java", "diffHunk": "@@ -37,17 +42,47 @@\n   @Named(\"dbModelToClientLight\")\n   DataSet dbModelToClientLight(DbDataset dbDataset);\n \n+  @Mapping(target = \"dataSetId\", ignore = true)\n+  @Mapping(target = \"version\", source = \"etag\")\n+  @Mapping(target = \"creatorId\", ignore = true)\n+  @Mapping(target = \"creationTime\", ignore = true)\n+  @Mapping(target = \"invalid\", ignore = true)\n+  @Mapping(target = \"lastModifiedTime\", ignore = true)\n+  @Mapping(target = \"prePackagedConceptSetEnum\", ignore = true)\n+  @Mapping(target = \"values\", source = \"domainValuePairs\")\n+  DbDataset dataSetRequestToDb(DataSetRequest dataSetRequest);\n+\n   @Mapping(target = \"id\", source = \"dataSetId\")\n   @Mapping(target = \"conceptSets\", source = \"conceptSetIds\")\n   @Mapping(target = \"cohorts\", source = \"cohortIds\")\n   @Mapping(target = \"domainValuePairs\", source = \"values\")\n   @Mapping(target = \"etag\", source = \"version\", qualifiedByName = \"cdrVersionToEtag\")\n   DataSet dbModelToClient(DbDataset dbDataset);\n \n+  default int etagToVersion(String eTag) {\n+    return Strings.isNullOrEmpty(eTag) ? 1 : Etags.toVersion(eTag);\n+  }\n+", "originalCommit": "257852fbb5b29e194b4aef682894975640ab6c12", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzcyMTM3NA==", "url": "https://github.com/all-of-us/workbench/pull/3751#discussion_r453721374", "bodyText": "Done", "author": "NehaBroad", "createdAt": "2020-07-13T15:10:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA3MDkyOA=="}], "type": "inlineReview", "revised_code": {"commit": "4cbb3419841ab19598ea993f0dc15448a8397f3a", "chunk": "diff --git a/api/src/main/java/org/pmiops/workbench/dataset/DataSetMapper.java b/api/src/main/java/org/pmiops/workbench/dataset/DataSetMapper.java\nindex 395ba0df0..182762350 100644\n--- a/api/src/main/java/org/pmiops/workbench/dataset/DataSetMapper.java\n+++ b/api/src/main/java/org/pmiops/workbench/dataset/DataSetMapper.java\n\n@@ -43,14 +46,18 @@ public interface DataSetMapper {\n   DataSet dbModelToClientLight(DbDataset dbDataset);\n \n   @Mapping(target = \"dataSetId\", ignore = true)\n-  @Mapping(target = \"version\", source = \"etag\")\n+  @Mapping(\n+      target = \"version\",\n+      source = \"etag\",\n+      qualifiedByName = \"etagToCdrVersion\",\n+      nullValueCheckStrategy = NullValueCheckStrategy.ALWAYS)\n   @Mapping(target = \"creatorId\", ignore = true)\n   @Mapping(target = \"creationTime\", ignore = true)\n   @Mapping(target = \"invalid\", ignore = true)\n   @Mapping(target = \"lastModifiedTime\", ignore = true)\n   @Mapping(target = \"prePackagedConceptSetEnum\", ignore = true)\n   @Mapping(target = \"values\", source = \"domainValuePairs\")\n-  DbDataset dataSetRequestToDb(DataSetRequest dataSetRequest);\n+  DbDataset dataSetRequestToDb(DataSetRequest dataSetRequest, @Context DbDataset dbDataSet);\n \n   @Mapping(target = \"id\", source = \"dataSetId\")\n   @Mapping(target = \"conceptSets\", source = \"conceptSetIds\")\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA3NTMwNQ==", "url": "https://github.com/all-of-us/workbench/pull/3751#discussion_r451075305", "bodyText": "Can we add a test case for this in DataSetMapperTest?", "author": "freemabd", "createdAt": "2020-07-07T18:53:55Z", "path": "api/src/main/java/org/pmiops/workbench/dataset/DataSetMapper.java", "diffHunk": "@@ -37,17 +42,47 @@\n   @Named(\"dbModelToClientLight\")\n   DataSet dbModelToClientLight(DbDataset dbDataset);\n \n+  @Mapping(target = \"dataSetId\", ignore = true)\n+  @Mapping(target = \"version\", source = \"etag\")\n+  @Mapping(target = \"creatorId\", ignore = true)\n+  @Mapping(target = \"creationTime\", ignore = true)\n+  @Mapping(target = \"invalid\", ignore = true)\n+  @Mapping(target = \"lastModifiedTime\", ignore = true)\n+  @Mapping(target = \"prePackagedConceptSetEnum\", ignore = true)\n+  @Mapping(target = \"values\", source = \"domainValuePairs\")\n+  DbDataset dataSetRequestToDb(DataSetRequest dataSetRequest);", "originalCommit": "257852fbb5b29e194b4aef682894975640ab6c12", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzcyMTQ1Mw==", "url": "https://github.com/all-of-us/workbench/pull/3751#discussion_r453721453", "bodyText": "Done", "author": "NehaBroad", "createdAt": "2020-07-13T15:10:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA3NTMwNQ=="}], "type": "inlineReview", "revised_code": {"commit": "4cbb3419841ab19598ea993f0dc15448a8397f3a", "chunk": "diff --git a/api/src/main/java/org/pmiops/workbench/dataset/DataSetMapper.java b/api/src/main/java/org/pmiops/workbench/dataset/DataSetMapper.java\nindex 395ba0df0..182762350 100644\n--- a/api/src/main/java/org/pmiops/workbench/dataset/DataSetMapper.java\n+++ b/api/src/main/java/org/pmiops/workbench/dataset/DataSetMapper.java\n\n@@ -43,14 +46,18 @@ public interface DataSetMapper {\n   DataSet dbModelToClientLight(DbDataset dbDataset);\n \n   @Mapping(target = \"dataSetId\", ignore = true)\n-  @Mapping(target = \"version\", source = \"etag\")\n+  @Mapping(\n+      target = \"version\",\n+      source = \"etag\",\n+      qualifiedByName = \"etagToCdrVersion\",\n+      nullValueCheckStrategy = NullValueCheckStrategy.ALWAYS)\n   @Mapping(target = \"creatorId\", ignore = true)\n   @Mapping(target = \"creationTime\", ignore = true)\n   @Mapping(target = \"invalid\", ignore = true)\n   @Mapping(target = \"lastModifiedTime\", ignore = true)\n   @Mapping(target = \"prePackagedConceptSetEnum\", ignore = true)\n   @Mapping(target = \"values\", source = \"domainValuePairs\")\n-  DbDataset dataSetRequestToDb(DataSetRequest dataSetRequest);\n+  DbDataset dataSetRequestToDb(DataSetRequest dataSetRequest, @Context DbDataset dbDataSet);\n \n   @Mapping(target = \"id\", source = \"dataSetId\")\n   @Mapping(target = \"conceptSets\", source = \"conceptSetIds\")\n"}}, {"oid": "4cbb3419841ab19598ea993f0dc15448a8397f3a", "url": "https://github.com/all-of-us/workbench/commit/4cbb3419841ab19598ea993f0dc15448a8397f3a", "message": "Fix rename issue", "committedDate": "2020-07-13T04:16:26Z", "type": "commit"}, {"oid": "21f4b29f8c88efedaf7e12ff87629eed7e7ab2cc", "url": "https://github.com/all-of-us/workbench/commit/21f4b29f8c88efedaf7e12ff87629eed7e7ab2cc", "message": "Add Test", "committedDate": "2020-07-13T04:48:22Z", "type": "commit"}, {"oid": "87962573d2988c99faa15476fc5655d6feeb297c", "url": "https://github.com/all-of-us/workbench/commit/87962573d2988c99faa15476fc5655d6feeb297c", "message": "Add Pre Packaged Concept Set", "committedDate": "2020-07-13T05:02:12Z", "type": "commit"}, {"oid": "f31fadde4b5d713f97e1085dbfa31c62bcc300f7", "url": "https://github.com/all-of-us/workbench/commit/f31fadde4b5d713f97e1085dbfa31c62bcc300f7", "message": "Method name change", "committedDate": "2020-07-13T05:09:36Z", "type": "commit"}, {"oid": "ed5ab785452b0920656d8d72f8a5c5b92c627943", "url": "https://github.com/all-of-us/workbench/commit/ed5ab785452b0920656d8d72f8a5c5b92c627943", "message": "Fix test", "committedDate": "2020-07-13T05:10:55Z", "type": "commit"}, {"oid": "d7611348c21e7ee53dbe06ab81d4fdbcea735b0f", "url": "https://github.com/all-of-us/workbench/commit/d7611348c21e7ee53dbe06ab81d4fdbcea735b0f", "message": "Fix test failure: cohort list", "committedDate": "2020-07-13T05:23:14Z", "type": "commit"}, {"oid": "024095d89b68f69b00488b112b8c98b8002b1fe5", "url": "https://github.com/all-of-us/workbench/commit/024095d89b68f69b00488b112b8c98b8002b1fe5", "message": "Removevduplicate line", "committedDate": "2020-07-13T05:25:22Z", "type": "commit"}, {"oid": "0f025f59c33d1037b0f629a6c0ecd821f6807034", "url": "https://github.com/all-of-us/workbench/commit/0f025f59c33d1037b0f629a6c0ecd821f6807034", "message": "Correct variable", "committedDate": "2020-07-13T05:47:05Z", "type": "commit"}, {"oid": "15f646e3cc95b13883ec8ecd3636fd0ffa73f344", "url": "https://github.com/all-of-us/workbench/commit/15f646e3cc95b13883ec8ecd3636fd0ffa73f344", "message": "extra line", "committedDate": "2020-07-13T13:39:37Z", "type": "commit"}, {"oid": "eb11de1a0b17af16bb936659f42770569ba90f0e", "url": "https://github.com/all-of-us/workbench/commit/eb11de1a0b17af16bb936659f42770569ba90f0e", "message": "Spotless", "committedDate": "2020-07-13T13:59:23Z", "type": "commit"}]}