{"pr_number": 4244, "pr_title": "[RW-5408][risk=low] UpdateRuntime API", "pr_createdAt": "2020-11-03T17:58:29Z", "pr_url": "https://github.com/all-of-us/workbench/pull/4244", "timeline": [{"oid": "c88671134eab638866fb9838509c8ff331993264", "url": "https://github.com/all-of-us/workbench/commit/c88671134eab638866fb9838509c8ff331993264", "message": "WIP - adding update runtime", "committedDate": "2020-11-03T16:39:07Z", "type": "commit"}, {"oid": "1ad21eaea25e5108ed6050ffa4b1f2e52f4348ae", "url": "https://github.com/all-of-us/workbench/commit/1ad21eaea25e5108ed6050ffa4b1f2e52f4348ae", "message": "merge master", "committedDate": "2020-11-03T16:48:52Z", "type": "commit"}, {"oid": "d01f6f7a5f9b68b17dcc7e959eeff2636d547f44", "url": "https://github.com/all-of-us/workbench/commit/d01f6f7a5f9b68b17dcc7e959eeff2636d547f44", "message": "add test", "committedDate": "2020-11-03T17:55:40Z", "type": "commit"}, {"oid": "0c9b9dcd9d621ae765bda4e782d1a506f91bf5eb", "url": "https://github.com/all-of-us/workbench/commit/0c9b9dcd9d621ae765bda4e782d1a506f91bf5eb", "message": "spotless", "committedDate": "2020-11-03T17:56:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk0MTQ1Ng==", "url": "https://github.com/all-of-us/workbench/pull/4244#discussion_r516941456", "bodyText": "opt: generally I think it's more readable to put the primary param first, followed by any optional / nullable / less-important params", "author": "calbach", "createdAt": "2020-11-03T20:37:57Z", "path": "api/src/main/java/org/pmiops/workbench/notebooks/LeonardoNotebooksClientImpl.java", "diffHunk": "@@ -131,26 +133,34 @@ private LeonardoCreateRuntimeRequest buildCreateRuntimeRequest(\n             .welderRegistry(WelderRegistryEnum.DOCKERHUB)\n             .customEnvironmentVariables(customEnvironmentVariables);\n \n+    request.setRuntimeConfig(buildRuntimeConfig(clusterOverride, runtime));\n+\n+    return request;\n+  }\n+\n+  private Object buildRuntimeConfig(@Nullable ClusterConfig clusterOverride, Runtime runtime) {", "originalCommit": "0c9b9dcd9d621ae765bda4e782d1a506f91bf5eb", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c78f1def0dcbf04bf7d300c13777fefe2813cbef", "chunk": "diff --git a/api/src/main/java/org/pmiops/workbench/notebooks/LeonardoNotebooksClientImpl.java b/api/src/main/java/org/pmiops/workbench/notebooks/LeonardoNotebooksClientImpl.java\nindex d63601fc7..7ae5e25ab 100644\n--- a/api/src/main/java/org/pmiops/workbench/notebooks/LeonardoNotebooksClientImpl.java\n+++ b/api/src/main/java/org/pmiops/workbench/notebooks/LeonardoNotebooksClientImpl.java\n\n@@ -133,12 +132,12 @@ public class LeonardoNotebooksClientImpl implements LeonardoNotebooksClient {\n             .welderRegistry(WelderRegistryEnum.DOCKERHUB)\n             .customEnvironmentVariables(customEnvironmentVariables);\n \n-    request.setRuntimeConfig(buildRuntimeConfig(clusterOverride, runtime));\n+    request.setRuntimeConfig(buildRuntimeConfig(runtime, clusterOverride));\n \n     return request;\n   }\n \n-  private Object buildRuntimeConfig(@Nullable ClusterConfig clusterOverride, Runtime runtime) {\n+  private Object buildRuntimeConfig(Runtime runtime, @Nullable ClusterConfig clusterOverride) {\n     WorkbenchConfig config = workbenchConfigProvider.get();\n \n     Object runtimeConfig;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk0MjA4OQ==", "url": "https://github.com/all-of-us/workbench/pull/4244#discussion_r516942089", "bodyText": "nit: Do you need the request here? Should the param just be the Runtime object?", "author": "calbach", "createdAt": "2020-11-03T20:39:16Z", "path": "api/src/main/java/org/pmiops/workbench/notebooks/LeonardoNotebooksClientImpl.java", "diffHunk": "@@ -184,6 +194,24 @@ public void createRuntime(Runtime runtime, String workspaceFirecloudName) {\n         });\n   }\n \n+  @Override\n+  public void updateRuntime(String workspaceNamespace, UpdateRuntimeRequest updateRuntimeRequest) {", "originalCommit": "0c9b9dcd9d621ae765bda4e782d1a506f91bf5eb", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c78f1def0dcbf04bf7d300c13777fefe2813cbef", "chunk": "diff --git a/api/src/main/java/org/pmiops/workbench/notebooks/LeonardoNotebooksClientImpl.java b/api/src/main/java/org/pmiops/workbench/notebooks/LeonardoNotebooksClientImpl.java\nindex d63601fc7..7ae5e25ab 100644\n--- a/api/src/main/java/org/pmiops/workbench/notebooks/LeonardoNotebooksClientImpl.java\n+++ b/api/src/main/java/org/pmiops/workbench/notebooks/LeonardoNotebooksClientImpl.java\n\n@@ -195,19 +194,21 @@ public class LeonardoNotebooksClientImpl implements LeonardoNotebooksClient {\n   }\n \n   @Override\n-  public void updateRuntime(String workspaceNamespace, UpdateRuntimeRequest updateRuntimeRequest) {\n+  public void updateRuntime(Runtime runtime) {\n+    //TODO: Apply labels on updateRuntime, https://precisionmedicineinitiative.atlassian.net/browse/RW-5852\n+\n     leonardoRetryHandler.run(\n         (context) -> {\n           runtimesApiProvider\n               .get()\n               .updateRuntime(\n-                  updateRuntimeRequest.getRuntime().getGoogleProject(),\n-                  updateRuntimeRequest.getRuntime().getRuntimeName(),\n+                  runtime.getGoogleProject(),\n+                  runtime.getRuntimeName(),\n                   new LeonardoUpdateRuntimeRequest()\n                       .runtimeConfig(\n                           buildRuntimeConfig(\n-                              userProvider.get().getClusterConfigDefault(),\n-                              updateRuntimeRequest.getRuntime())));\n+                              runtime,\n+                              userProvider.get().getClusterConfigDefault())));\n           return null;\n         });\n   }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk0NDk2MA==", "url": "https://github.com/all-of-us/workbench/pull/4244#discussion_r516944960", "bodyText": "opt: could combine these into a singular xor statement", "author": "calbach", "createdAt": "2020-11-03T20:45:12Z", "path": "api/src/main/java/org/pmiops/workbench/api/RuntimeController.java", "diffHunk": "@@ -272,6 +273,36 @@ private Runtime getOverrideFromListRuntimes(String workspaceNamespace) {\n     return ResponseEntity.ok(new EmptyResponse());\n   }\n \n+  @Override\n+  public ResponseEntity<EmptyResponse> updateRuntime(\n+      String workspaceNamespace, UpdateRuntimeRequest runtimeRequest) {\n+    if (runtimeRequest == null || runtimeRequest.getRuntime() == null) {\n+      throw new BadRequestException(\"Runtime cannot be empty for an update request\");\n+    }\n+\n+    if (runtimeRequest.getRuntime().getGceConfig() == null", "originalCommit": "0c9b9dcd9d621ae765bda4e782d1a506f91bf5eb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQ2MDkzOA==", "url": "https://github.com/all-of-us/workbench/pull/4244#discussion_r517460938", "bodyText": "Going to leave them separate because I have different messages for some of the cases.", "author": "ericsong", "createdAt": "2020-11-04T16:14:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk0NDk2MA=="}], "type": "inlineReview", "revised_code": {"commit": "c78f1def0dcbf04bf7d300c13777fefe2813cbef", "chunk": "diff --git a/api/src/main/java/org/pmiops/workbench/api/RuntimeController.java b/api/src/main/java/org/pmiops/workbench/api/RuntimeController.java\nindex 51e49feaa..516ac002d 100644\n--- a/api/src/main/java/org/pmiops/workbench/api/RuntimeController.java\n+++ b/api/src/main/java/org/pmiops/workbench/api/RuntimeController.java\n\n@@ -298,7 +298,7 @@ public class RuntimeController implements RuntimeApiDelegate {\n     runtimeRequest.getRuntime().setGoogleProject(workspaceNamespace);\n     runtimeRequest.getRuntime().setRuntimeName(userProvider.get().getRuntimeName());\n \n-    leonardoNotebooksClient.updateRuntime(firecloudWorkspaceName, runtimeRequest);\n+    leonardoNotebooksClient.updateRuntime(runtimeRequest.getRuntime());\n \n     return ResponseEntity.accepted().build();\n   }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk0NjAzOQ==", "url": "https://github.com/all-of-us/workbench/pull/4244#discussion_r516946039", "bodyText": "Please add a TODO somewhere around here and/or file ticket as a follow-up for updating labels, Leo ticket is https://broadworkbench.atlassian.net/browse/IA-2149", "author": "calbach", "createdAt": "2020-11-03T20:47:31Z", "path": "api/src/main/java/org/pmiops/workbench/notebooks/LeonardoNotebooksClientImpl.java", "diffHunk": "@@ -184,6 +194,24 @@ public void createRuntime(Runtime runtime, String workspaceFirecloudName) {\n         });\n   }\n \n+  @Override\n+  public void updateRuntime(String workspaceNamespace, UpdateRuntimeRequest updateRuntimeRequest) {\n+    leonardoRetryHandler.run(\n+        (context) -> {\n+          runtimesApiProvider\n+              .get()\n+              .updateRuntime(\n+                  updateRuntimeRequest.getRuntime().getGoogleProject(),\n+                  updateRuntimeRequest.getRuntime().getRuntimeName(),\n+                  new LeonardoUpdateRuntimeRequest()", "originalCommit": "0c9b9dcd9d621ae765bda4e782d1a506f91bf5eb", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c78f1def0dcbf04bf7d300c13777fefe2813cbef", "chunk": "diff --git a/api/src/main/java/org/pmiops/workbench/notebooks/LeonardoNotebooksClientImpl.java b/api/src/main/java/org/pmiops/workbench/notebooks/LeonardoNotebooksClientImpl.java\nindex d63601fc7..7ae5e25ab 100644\n--- a/api/src/main/java/org/pmiops/workbench/notebooks/LeonardoNotebooksClientImpl.java\n+++ b/api/src/main/java/org/pmiops/workbench/notebooks/LeonardoNotebooksClientImpl.java\n\n@@ -195,19 +194,21 @@ public class LeonardoNotebooksClientImpl implements LeonardoNotebooksClient {\n   }\n \n   @Override\n-  public void updateRuntime(String workspaceNamespace, UpdateRuntimeRequest updateRuntimeRequest) {\n+  public void updateRuntime(Runtime runtime) {\n+    //TODO: Apply labels on updateRuntime, https://precisionmedicineinitiative.atlassian.net/browse/RW-5852\n+\n     leonardoRetryHandler.run(\n         (context) -> {\n           runtimesApiProvider\n               .get()\n               .updateRuntime(\n-                  updateRuntimeRequest.getRuntime().getGoogleProject(),\n-                  updateRuntimeRequest.getRuntime().getRuntimeName(),\n+                  runtime.getGoogleProject(),\n+                  runtime.getRuntimeName(),\n                   new LeonardoUpdateRuntimeRequest()\n                       .runtimeConfig(\n                           buildRuntimeConfig(\n-                              userProvider.get().getClusterConfigDefault(),\n-                              updateRuntimeRequest.getRuntime())));\n+                              runtime,\n+                              userProvider.get().getClusterConfigDefault())));\n           return null;\n         });\n   }\n"}}, {"oid": "c78f1def0dcbf04bf7d300c13777fefe2813cbef", "url": "https://github.com/all-of-us/workbench/commit/c78f1def0dcbf04bf7d300c13777fefe2813cbef", "message": "code review", "committedDate": "2020-11-04T16:24:02Z", "type": "commit"}, {"oid": "82997ebc4db5d9b21474bfd44d60bb4edb1b2522", "url": "https://github.com/all-of-us/workbench/commit/82997ebc4db5d9b21474bfd44d60bb4edb1b2522", "message": "add base case test", "committedDate": "2020-11-04T16:24:10Z", "type": "commit"}, {"oid": "71ad7a7e694827fa82f864c61ae682a5b0e6d24c", "url": "https://github.com/all-of-us/workbench/commit/71ad7a7e694827fa82f864c61ae682a5b0e6d24c", "message": "spotless", "committedDate": "2020-11-04T16:25:15Z", "type": "commit"}, {"oid": "81295f68e12cad008a45598e856bfb97ca1ca8b1", "url": "https://github.com/all-of-us/workbench/commit/81295f68e12cad008a45598e856bfb97ca1ca8b1", "message": "Merge branch 'master' of github.com:all-of-us/workbench into songe/RW-5408", "committedDate": "2020-11-05T16:24:25Z", "type": "commit"}]}