{"pr_number": 3914, "pr_title": "[RW-5324][risk=no] Move ConceptSetMapper into ConceptSetService", "pr_createdAt": "2020-08-25T15:41:05Z", "pr_url": "https://github.com/all-of-us/workbench/pull/3914", "timeline": [{"oid": "3883b28b969b0f1bc1816af30c49df270650e890", "url": "https://github.com/all-of-us/workbench/commit/3883b28b969b0f1bc1816af30c49df270650e890", "message": "RW-5324 moving conceptsetmapper to conceptsetservice", "committedDate": "2020-08-24T16:29:26Z", "type": "commit"}, {"oid": "3644519238f3d0a91a4dce5ab877115a21e8d862", "url": "https://github.com/all-of-us/workbench/commit/3644519238f3d0a91a4dce5ab877115a21e8d862", "message": "RW-5324 merging nehas PR", "committedDate": "2020-08-24T16:49:31Z", "type": "commit"}, {"oid": "859363c850f98bd2970deb3d381c3bd14d3fec3b", "url": "https://github.com/all-of-us/workbench/commit/859363c850f98bd2970deb3d381c3bd14d3fec3b", "message": "RW-5324 cleanup", "committedDate": "2020-08-25T00:20:16Z", "type": "commit"}, {"oid": "70dac7aae9cd4752360c77d95f167b2f52c510ef", "url": "https://github.com/all-of-us/workbench/commit/70dac7aae9cd4752360c77d95f167b2f52c510ef", "message": "RW-5324 cleanup", "committedDate": "2020-08-25T14:51:38Z", "type": "commit"}, {"oid": "0ed2b590bc28a87849573625ee2bb6dcd4745413", "url": "https://github.com/all-of-us/workbench/commit/0ed2b590bc28a87849573625ee2bb6dcd4745413", "message": "RW-5324 removed unused method", "committedDate": "2020-08-25T15:35:04Z", "type": "commit"}, {"oid": "00437c4739c916aa2cbe9dbba077611bbdddf69c", "url": "https://github.com/all-of-us/workbench/commit/00437c4739c916aa2cbe9dbba077611bbdddf69c", "message": "RW-5324 spotless", "committedDate": "2020-08-25T15:59:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY4NzI3Ng==", "url": "https://github.com/all-of-us/workbench/pull/3914#discussion_r476687276", "bodyText": "Since both at line 120 and here toHydratedConcept is being called after updateConeptSet, how about calling   toHydratedConcept inside an conceptSetService.updateConceptSet? Or should we make the service return  Hydrated ConceptSet where ever possible like update/create?", "author": "NehaBroad", "createdAt": "2020-08-25T19:29:50Z", "path": "api/src/main/java/org/pmiops/workbench/api/ConceptSetsController.java", "diffHunk": "@@ -221,18 +126,15 @@ private void addConceptsToSet(DbConceptSet dbConceptSet, List<Long> addedIds) {\n       String workspaceId,\n       Long conceptSetId,\n       UpdateConceptSetRequest request) {\n-    DbConceptSet dbConceptSet =\n-        getDbConceptSet(workspaceNamespace, workspaceId, conceptSetId, WorkspaceAccessLevel.WRITER);\n-    validateAndUpdateDbConceptSetConcept(dbConceptSet, request);\n-    Timestamp now = new Timestamp(clock.instant().toEpochMilli());\n-    dbConceptSet.setLastModifiedTime(now);\n-    try {\n-      dbConceptSet = conceptSetService.save(dbConceptSet);\n-      return ResponseEntity.ok(toHydratedConceptSet(dbConceptSet));\n-      // TODO: add recent resource entry for concept sets [RW-1129]\n-    } catch (OptimisticLockException e) {\n-      throw new ConflictException(\"Failed due to concurrent concept set modification\");\n-    }\n+    // Fail fast if request isn't valid\n+    validateUpdateConceptSetConcepts(request);\n+\n+    workspaceService.getWorkspaceEnforceAccessLevelAndSetCdrVersion(\n+        workspaceNamespace, workspaceId, WorkspaceAccessLevel.WRITER);\n+\n+    return ResponseEntity.ok(\n+        conceptSetService.toHydratedConcepts(", "originalCommit": "00437c4739c916aa2cbe9dbba077611bbdddf69c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzM3NTk5Mw==", "url": "https://github.com/all-of-us/workbench/pull/3914#discussion_r477375993", "bodyText": "Good idea. Making toHydratedConcept a private method in ConceptSetService.", "author": "freemabd", "createdAt": "2020-08-26T15:09:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY4NzI3Ng=="}], "type": "inlineReview", "revised_code": {"commit": "460d7edb5d0aa7987f1cdde4ed1bf73c2396848c", "chunk": "diff --git a/api/src/main/java/org/pmiops/workbench/api/ConceptSetsController.java b/api/src/main/java/org/pmiops/workbench/api/ConceptSetsController.java\nindex d94c6b5b3..37a337f9a 100644\n--- a/api/src/main/java/org/pmiops/workbench/api/ConceptSetsController.java\n+++ b/api/src/main/java/org/pmiops/workbench/api/ConceptSetsController.java\n\n@@ -132,9 +129,7 @@ public class ConceptSetsController implements ConceptSetsApiDelegate {\n     workspaceService.getWorkspaceEnforceAccessLevelAndSetCdrVersion(\n         workspaceNamespace, workspaceId, WorkspaceAccessLevel.WRITER);\n \n-    return ResponseEntity.ok(\n-        conceptSetService.toHydratedConcepts(\n-            conceptSetService.updateConceptSetConcepts(conceptSetId, request)));\n+    return ResponseEntity.ok(conceptSetService.updateConceptSetConcepts(conceptSetId, request));\n   }\n \n   @Override\n"}}, {"oid": "460d7edb5d0aa7987f1cdde4ed1bf73c2396848c", "url": "https://github.com/all-of-us/workbench/commit/460d7edb5d0aa7987f1cdde4ed1bf73c2396848c", "message": "RW-5324 making toHydrate internal service method", "committedDate": "2020-08-26T15:16:43Z", "type": "commit"}]}