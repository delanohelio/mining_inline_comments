{"pr_number": 3163, "pr_title": "[no ticket][risk=no] Unit test enhancements and small refactorings for new interceptor", "pr_createdAt": "2020-02-20T18:10:02Z", "pr_url": "https://github.com/all-of-us/workbench/pull/3163", "timeline": [{"oid": "97729ab2b521c98d6c139479e4fb9dc0b47ec0ee", "url": "https://github.com/all-of-us/workbench/commit/97729ab2b521c98d6c139479e4fb9dc0b47ec0ee", "message": "initial version", "committedDate": "2020-02-14T22:07:46Z", "type": "commit"}, {"oid": "65347e50bb3ea0bf3bbe77256c6f4bf936b49656", "url": "https://github.com/all-of-us/workbench/commit/65347e50bb3ea0bf3bbe77256c6f4bf936b49656", "message": "cleanup", "committedDate": "2020-02-14T22:49:56Z", "type": "commit"}, {"oid": "1fa08bf406e6b48fabbe97db08cdd13313915602", "url": "https://github.com/all-of-us/workbench/commit/1fa08bf406e6b48fabbe97db08cdd13313915602", "message": "merge", "committedDate": "2020-02-19T19:17:54Z", "type": "commit"}, {"oid": "9853ab6b91e6554db65d7e32e9c95cc3254ce0b3", "url": "https://github.com/all-of-us/workbench/commit/9853ab6b91e6554db65d7e32e9c95cc3254ce0b3", "message": "test class", "committedDate": "2020-02-20T16:24:25Z", "type": "commit"}, {"oid": "7965c86df618f4b63c79f7a55de72ac35c693d8e", "url": "https://github.com/all-of-us/workbench/commit/7965c86df618f4b63c79f7a55de72ac35c693d8e", "message": "fixup", "committedDate": "2020-02-20T16:51:37Z", "type": "commit"}, {"oid": "90a41098f39b07de915a08390bb5b1484991c7f5", "url": "https://github.com/all-of-us/workbench/commit/90a41098f39b07de915a08390bb5b1484991c7f5", "message": "merge", "committedDate": "2020-02-20T16:57:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjcyNTY2Mg==", "url": "https://github.com/all-of-us/workbench/pull/3163#discussion_r382725662", "bodyText": "questions is RequestTimeMetricInterceptor just a new rename for  ElapsedTimeDistributionInterceptor ? i cannot see it being removed as a file in this PR.", "author": "NehaBroad", "createdAt": "2020-02-21T18:03:30Z", "path": "api/src/main/java/org/pmiops/workbench/config/WebMvcConfig.java", "diffHunk": "@@ -9,7 +9,7 @@\n import org.pmiops.workbench.interceptors.CloudTaskInterceptor;\n import org.pmiops.workbench.interceptors.CorsInterceptor;\n import org.pmiops.workbench.interceptors.CronInterceptor;\n-import org.pmiops.workbench.interceptors.ElapsedTimeDistributionInterceptor;", "originalCommit": "90a41098f39b07de915a08390bb5b1484991c7f5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjcyOTY2Mg==", "url": "https://github.com/all-of-us/workbench/pull/3163#discussion_r382729662", "bodyText": "Good catch. Somehow I wound up adding instead of renaming.", "author": "jaycarlton", "createdAt": "2020-02-21T18:12:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjcyNTY2Mg=="}], "type": "inlineReview", "revised_code": null}, {"oid": "1a32f8e6cd75ed514834e4a91f23943447b99e05", "url": "https://github.com/all-of-us/workbench/commit/1a32f8e6cd75ed514834e4a91f23943447b99e05", "message": "merge master", "committedDate": "2020-02-21T18:11:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjc0OTIyNw==", "url": "https://github.com/all-of-us/workbench/pull/3163#discussion_r382749227", "bodyText": "Also it will be good to  add comments to explain whats happening in this method", "author": "NehaBroad", "createdAt": "2020-02-21T18:55:06Z", "path": "api/src/main/java/org/pmiops/workbench/interceptors/RequestTimeMetricInterceptor.java", "diffHunk": "@@ -0,0 +1,69 @@\n+package org.pmiops.workbench.interceptors;\n+\n+import com.google.api.client.http.HttpMethods;\n+import java.time.Clock;\n+import java.time.Duration;\n+import java.time.Instant;\n+import java.util.Optional;\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import org.pmiops.workbench.monitoring.LogsBasedMetricService;\n+import org.pmiops.workbench.monitoring.MeasurementBundle;\n+import org.pmiops.workbench.monitoring.labels.MetricLabel;\n+import org.pmiops.workbench.monitoring.views.DistributionMetric;\n+import org.springframework.stereotype.Service;\n+import org.springframework.web.method.HandlerMethod;\n+import org.springframework.web.servlet.ModelAndView;\n+import org.springframework.web.servlet.handler.HandlerInterceptorAdapter;\n+\n+@Service\n+public class RequestTimeMetricInterceptor extends HandlerInterceptorAdapter {\n+\n+  private final LogsBasedMetricService logsBasedMetricService;\n+  private Clock clock;\n+\n+  public RequestTimeMetricInterceptor(LogsBasedMetricService logsBasedMetricService, Clock clock) {\n+    this.logsBasedMetricService = logsBasedMetricService;\n+    this.clock = clock;\n+  }\n+\n+  @Override\n+  public boolean preHandle(\n+      HttpServletRequest request, HttpServletResponse response, Object handler) {\n+    if (shouldSkip(request, handler)) {\n+      return true;\n+    }\n+    request.setAttribute(RequestAttribute.START_INSTANT.toString(), clock.instant());\n+    return true;\n+  }\n+\n+  private boolean shouldSkip(HttpServletRequest request, Object handler) {\n+    return (request.getMethod().equals(HttpMethods.OPTIONS))\n+        || (!(handler instanceof HandlerMethod));\n+  }\n+\n+  @Override\n+  public void postHandle(\n+      HttpServletRequest request,", "originalCommit": "90a41098f39b07de915a08390bb5b1484991c7f5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5a4721349628675b1b8d76517abc8f7240d2c6ee", "chunk": "diff --git a/api/src/main/java/org/pmiops/workbench/interceptors/RequestTimeMetricInterceptor.java b/api/src/main/java/org/pmiops/workbench/interceptors/RequestTimeMetricInterceptor.java\nindex 32990b770..f17a47f92 100644\n--- a/api/src/main/java/org/pmiops/workbench/interceptors/RequestTimeMetricInterceptor.java\n+++ b/api/src/main/java/org/pmiops/workbench/interceptors/RequestTimeMetricInterceptor.java\n\n@@ -42,6 +42,14 @@ public class RequestTimeMetricInterceptor extends HandlerInterceptorAdapter {\n         || (!(handler instanceof HandlerMethod));\n   }\n \n+  /**\n+   * Compute the elapsed time since preHandle and record it to the API_METHOD_TIME logs-based\n+   * metric\n+   * @param request - request that was just handled\n+   * @param response - response (unused)\n+   * @param handler - handler object. Only interested in the HandlerMethod variety\n+   * @param modelAndView - not used\n+   */\n   @Override\n   public void postHandle(\n       HttpServletRequest request,\n"}}, {"oid": "67a91765f1003b9d4568bcd4e8a62142a8644bf6", "url": "https://github.com/all-of-us/workbench/commit/67a91765f1003b9d4568bcd4e8a62142a8644bf6", "message": "merge master", "committedDate": "2020-03-09T21:37:54Z", "type": "commit"}, {"oid": "5a4721349628675b1b8d76517abc8f7240d2c6ee", "url": "https://github.com/all-of-us/workbench/commit/5a4721349628675b1b8d76517abc8f7240d2c6ee", "message": "remove duplicated file and add comments", "committedDate": "2020-03-09T21:47:46Z", "type": "commit"}, {"oid": "c92c2ca1e743e458b0bf75f16e04d53e13591508", "url": "https://github.com/all-of-us/workbench/commit/c92c2ca1e743e458b0bf75f16e04d53e13591508", "message": "spelling", "committedDate": "2020-03-09T21:49:59Z", "type": "commit"}, {"oid": "0eaf1860e5ef736edaa36f70c0586220b7a78e9c", "url": "https://github.com/all-of-us/workbench/commit/0eaf1860e5ef736edaa36f70c0586220b7a78e9c", "message": "spotless", "committedDate": "2020-03-10T13:15:23Z", "type": "commit"}, {"oid": "9a29f3249202fb36d1ee211dd0c4ea74562a7418", "url": "https://github.com/all-of-us/workbench/commit/9a29f3249202fb36d1ee211dd0c4ea74562a7418", "message": "dummy change to re-trigger circle", "committedDate": "2020-03-10T13:30:53Z", "type": "commit"}, {"oid": "3e88a329e5e09d0b9b16a96e864bce9bef595450", "url": "https://github.com/all-of-us/workbench/commit/3e88a329e5e09d0b9b16a96e864bce9bef595450", "message": "merge", "committedDate": "2020-03-10T22:49:24Z", "type": "commit"}]}