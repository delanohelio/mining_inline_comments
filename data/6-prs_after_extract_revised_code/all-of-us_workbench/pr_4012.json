{"pr_number": 4012, "pr_title": "[RW-5407][risk=no] CreateRuntime: support optional user override of runtime config", "pr_createdAt": "2020-09-16T03:40:25Z", "pr_url": "https://github.com/all-of-us/workbench/pull/4012", "timeline": [{"oid": "0949d39117bdfa9893666d611307a4aa20e3d233", "url": "https://github.com/all-of-us/workbench/commit/0949d39117bdfa9893666d611307a4aa20e3d233", "message": "add new Runtime fields and mapping fields", "committedDate": "2020-09-14T19:37:56Z", "type": "commit"}, {"oid": "cda3099ac70eac455d109dd92f8e69dab1904491", "url": "https://github.com/all-of-us/workbench/commit/cda3099ac70eac455d109dd92f8e69dab1904491", "message": "spotless", "committedDate": "2020-09-14T19:38:38Z", "type": "commit"}, {"oid": "51a0225c88b02c102b0655aa298f9b99b5faf9cb", "url": "https://github.com/all-of-us/workbench/commit/51a0225c88b02c102b0655aa298f9b99b5faf9cb", "message": "add comment", "committedDate": "2020-09-14T19:43:19Z", "type": "commit"}, {"oid": "73d4f6692ccad94a2f14e5d761512c71744b9053", "url": "https://github.com/all-of-us/workbench/commit/73d4f6692ccad94a2f14e5d761512c71744b9053", "message": "refactor to use real LeonardoNotebooksClientImpl", "committedDate": "2020-09-15T16:18:04Z", "type": "commit"}, {"oid": "fc60ff23b54cf41d0debf27a34335e485513d385", "url": "https://github.com/all-of-us/workbench/commit/fc60ff23b54cf41d0debf27a34335e485513d385", "message": "LeonardoNotebooksClientTest - just for history, will remove", "committedDate": "2020-09-15T16:18:45Z", "type": "commit"}, {"oid": "409ecaee24d6befa34bc65602ffa41deb69323ea", "url": "https://github.com/all-of-us/workbench/commit/409ecaee24d6befa34bc65602ffa41deb69323ea", "message": "remove", "committedDate": "2020-09-15T16:19:03Z", "type": "commit"}, {"oid": "19983aa114695b96f05c361241409e6f6acde090", "url": "https://github.com/all-of-us/workbench/commit/19983aa114695b96f05c361241409e6f6acde090", "message": "Set label based on Runtime.ConfigurationType", "committedDate": "2020-09-15T17:57:01Z", "type": "commit"}, {"oid": "77f2d4e76c2ccad968b946b0b35d40c495ad62cc", "url": "https://github.com/all-of-us/workbench/commit/77f2d4e76c2ccad968b946b0b35d40c495ad62cc", "message": "merge master", "committedDate": "2020-09-16T03:11:36Z", "type": "commit"}, {"oid": "f36f4880f2b06bcd6142cd68b462d3c693bdaeba", "url": "https://github.com/all-of-us/workbench/commit/f36f4880f2b06bcd6142cd68b462d3c693bdaeba", "message": "handle null runtime case", "committedDate": "2020-09-16T03:28:43Z", "type": "commit"}, {"oid": "19244908389cb6e2c3803756e6e3ec0238c0be0e", "url": "https://github.com/all-of-us/workbench/commit/19244908389cb6e2c3803756e6e3ec0238c0be0e", "message": "only create shell runtime if null", "committedDate": "2020-09-16T03:33:53Z", "type": "commit"}, {"oid": "61e0b52ec2b33a5538ecd112ee4e3fcd93a27466", "url": "https://github.com/all-of-us/workbench/commit/61e0b52ec2b33a5538ecd112ee4e3fcd93a27466", "message": "add test case for null runtime case", "committedDate": "2020-09-16T03:39:33Z", "type": "commit"}, {"oid": "1485ee5cb16520af4e633150c092c40dcd8db318", "url": "https://github.com/all-of-us/workbench/commit/1485ee5cb16520af4e633150c092c40dcd8db318", "message": "send configurationType oer", "committedDate": "2020-09-16T15:40:36Z", "type": "commit"}, {"oid": "bcdbbadf2df1f0038dce23bea8d17219e066e593", "url": "https://github.com/all-of-us/workbench/commit/bcdbbadf2df1f0038dce23bea8d17219e066e593", "message": "spotless", "committedDate": "2020-09-16T15:41:14Z", "type": "commit"}, {"oid": "5a0f8e81c42ec3cc0d24054ccf885305aab3b1fb", "url": "https://github.com/all-of-us/workbench/commit/5a0f8e81c42ec3cc0d24054ccf885305aab3b1fb", "message": "test fix", "committedDate": "2020-09-16T16:30:28Z", "type": "commit"}, {"oid": "3fb5127336d28533428d77a1998da718b3149275", "url": "https://github.com/all-of-us/workbench/commit/3fb5127336d28533428d77a1998da718b3149275", "message": "yarn lint", "committedDate": "2020-09-16T17:33:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc4MzQ5OA==", "url": "https://github.com/all-of-us/workbench/pull/4012#discussion_r489783498", "bodyText": "Nice to have: can this endpoint accept the absence of a body Runtime payload? This would ensure that older UI clients don't break when this goes out.", "author": "calbach", "createdAt": "2020-09-16T22:13:24Z", "path": "api/src/main/java/org/pmiops/workbench/api/RuntimeController.java", "diffHunk": "@@ -180,14 +180,16 @@ private DbWorkspace lookupWorkspace(String workspaceNamespace) throws NotFoundEx\n   }\n \n   @Override\n-  public ResponseEntity<EmptyResponse> createRuntime(String workspaceNamespace) {\n+  public ResponseEntity<EmptyResponse> createRuntime(String workspaceNamespace, Runtime runtime) {", "originalCommit": "3fb5127336d28533428d77a1998da718b3149275", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "40f99adcf083704a85058393628c3f4d54c30e7c", "chunk": "diff --git a/api/src/main/java/org/pmiops/workbench/api/RuntimeController.java b/api/src/main/java/org/pmiops/workbench/api/RuntimeController.java\nindex d5d9a3f02..f66ad812d 100644\n--- a/api/src/main/java/org/pmiops/workbench/api/RuntimeController.java\n+++ b/api/src/main/java/org/pmiops/workbench/api/RuntimeController.java\n\n@@ -181,6 +181,10 @@ public class RuntimeController implements RuntimeApiDelegate {\n \n   @Override\n   public ResponseEntity<EmptyResponse> createRuntime(String workspaceNamespace, Runtime runtime) {\n+    if (runtime == null) {\n+      runtime = new Runtime();\n+    }\n+\n     String firecloudWorkspaceName = lookupWorkspace(workspaceNamespace).getFirecloudName();\n     workspaceService.enforceWorkspaceAccessLevelAndRegisteredAuthDomain(\n         workspaceNamespace, firecloudWorkspaceName, WorkspaceAccessLevel.WRITER);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc4NDEyMw==", "url": "https://github.com/all-of-us/workbench/pull/4012#discussion_r489784123", "bodyText": "There are more values in the enum. Maybe just map the enum string value directly here for now; or else have a separate enum/map here that converts these into value strings (this avoids unexpected breakages if we decide to rename any of these enum values)", "author": "calbach", "createdAt": "2020-09-16T22:15:19Z", "path": "api/src/main/java/org/pmiops/workbench/notebooks/LeonardoNotebooksClientImpl.java", "diffHunk": "@@ -97,39 +101,51 @@ private LeonardoCreateRuntimeRequest buildCreateRuntimeRequest(\n     nbExtensions.put(\n         \"aou-upload-policy-extension\", assetsBaseUrl + \"/aou-upload-policy-extension.js\");\n \n-    return new LeonardoCreateRuntimeRequest()\n-        .labels(ImmutableMap.of(RUNTIME_LABEL_AOU, \"true\", RUNTIME_LABEL_CREATED_BY, userEmail))\n-        .defaultClientId(config.server.oauthClientId)\n-        // Note: Filenames must be kept in sync with files in api/src/main/webapp/static.\n-        .jupyterUserScriptUri(assetsBaseUrl + \"/initialize_notebook_runtime.sh\")\n-        .jupyterStartUserScriptUri(assetsBaseUrl + \"/start_notebook_runtime.sh\")\n-        .userJupyterExtensionConfig(\n-            new LeonardoUserJupyterExtensionConfig().nbExtensions(nbExtensions))\n-        // Matches Terra UI's scopes, see RW-3531 for rationale.\n-        .addScopesItem(\"https://www.googleapis.com/auth/cloud-platform\")\n-        .addScopesItem(\"https://www.googleapis.com/auth/userinfo.email\")\n-        .addScopesItem(\"https://www.googleapis.com/auth/userinfo.profile\")\n-        .runtimeConfig(\n-            new LeonardoMachineConfig()\n-                .cloudService(CloudServiceEnum.DATAPROC)\n-                .masterDiskSize(\n-                    Optional.ofNullable(clusterOverride.masterDiskSize)\n-                        .orElse(config.firecloud.notebookRuntimeDefaultDiskSizeGb))\n-                .masterMachineType(\n-                    Optional.ofNullable(clusterOverride.machineType)\n-                        .orElse(config.firecloud.notebookRuntimeDefaultMachineType)))\n-        .toolDockerImage(workbenchConfigProvider.get().firecloud.jupyterDockerImage)\n-        .welderDockerImage(workbenchConfigProvider.get().firecloud.welderDockerImage)\n-        .customEnvironmentVariables(customEnvironmentVariables);\n+    LeonardoCreateRuntimeRequest request =\n+        new LeonardoCreateRuntimeRequest()\n+            .labels(\n+                ImmutableMap.of(\n+                    RUNTIME_LABEL_AOU,\n+                    \"true\",\n+                    RUNTIME_LABEL_CREATED_BY,\n+                    userEmail,\n+                    RUNTIME_LABEL_AOU_CONFIG,\n+                    RuntimeConfigurationType.USEROVERRIDE.equals(runtime.getConfigurationType())\n+                        ? \"user-override\"", "originalCommit": "3fb5127336d28533428d77a1998da718b3149275", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgyMjYxNw==", "url": "https://github.com/all-of-us/workbench/pull/4012#discussion_r489822617", "bodyText": "oh ok, I only saw \"default\" in the ticket so I thought we were collapsing the default/gce config into that.", "author": "ericsong", "createdAt": "2020-09-17T00:18:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc4NDEyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgyNDE1Mw==", "url": "https://github.com/all-of-us/workbench/pull/4012#discussion_r489824153", "bodyText": "Sorry that was written before we had two preset options", "author": "calbach", "createdAt": "2020-09-17T00:23:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc4NDEyMw=="}], "type": "inlineReview", "revised_code": {"commit": "40f99adcf083704a85058393628c3f4d54c30e7c", "chunk": "diff --git a/api/src/main/java/org/pmiops/workbench/notebooks/LeonardoNotebooksClientImpl.java b/api/src/main/java/org/pmiops/workbench/notebooks/LeonardoNotebooksClientImpl.java\nindex b2877c94e..63bdecd83 100644\n--- a/api/src/main/java/org/pmiops/workbench/notebooks/LeonardoNotebooksClientImpl.java\n+++ b/api/src/main/java/org/pmiops/workbench/notebooks/LeonardoNotebooksClientImpl.java\n\n@@ -101,18 +106,16 @@ public class LeonardoNotebooksClientImpl implements LeonardoNotebooksClient {\n     nbExtensions.put(\n         \"aou-upload-policy-extension\", assetsBaseUrl + \"/aou-upload-policy-extension.js\");\n \n-    LeonardoCreateRuntimeRequest request =\n-        new LeonardoCreateRuntimeRequest()\n-            .labels(\n-                ImmutableMap.of(\n-                    RUNTIME_LABEL_AOU,\n-                    \"true\",\n-                    RUNTIME_LABEL_CREATED_BY,\n-                    userEmail,\n-                    RUNTIME_LABEL_AOU_CONFIG,\n-                    RuntimeConfigurationType.USEROVERRIDE.equals(runtime.getConfigurationType())\n-                        ? \"user-override\"\n-                        : \"default\"))\n+    Map<String, String> runtimeLabels = new HashMap<>();\n+    runtimeLabels.put(RUNTIME_LABEL_AOU, \"true\");\n+    runtimeLabels.put(RUNTIME_LABEL_CREATED_BY, userEmail);\n+\n+    if (runtime.getConfigurationType() != null) {\n+      runtimeLabels.put(RUNTIME_LABEL_AOU_CONFIG, RUNTIME_CONFIGURATION_TYPE_ENUM_TO_STORAGE_MAP.get(runtime.getConfigurationType()));\n+    }\n+\n+    return new LeonardoCreateRuntimeRequest()\n+            .labels(runtimeLabels)\n             .defaultClientId(config.server.oauthClientId)\n             // Note: Filenames must be kept in sync with files in api/src/main/webapp/static.\n             .jupyterUserScriptUri(assetsBaseUrl + \"/initialize_notebook_runtime.sh\")\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc4NDc5MQ==", "url": "https://github.com/all-of-us/workbench/pull/4012#discussion_r489784791", "bodyText": "Sorry, this was not super clearly written in the ticket AC, but the main point of the ticket is to actually plumb through the values supplied by the client to create the runtime instance: machine type and disk size. That hasn't been done here. This should also only happen if the flag is enabled - otherwise we shouldn't expect to receive a runtime payload in the create request.", "author": "calbach", "createdAt": "2020-09-16T22:17:12Z", "path": "api/src/main/java/org/pmiops/workbench/notebooks/LeonardoNotebooksClientImpl.java", "diffHunk": "@@ -97,39 +101,51 @@ private LeonardoCreateRuntimeRequest buildCreateRuntimeRequest(\n     nbExtensions.put(\n         \"aou-upload-policy-extension\", assetsBaseUrl + \"/aou-upload-policy-extension.js\");\n \n-    return new LeonardoCreateRuntimeRequest()\n-        .labels(ImmutableMap.of(RUNTIME_LABEL_AOU, \"true\", RUNTIME_LABEL_CREATED_BY, userEmail))\n-        .defaultClientId(config.server.oauthClientId)\n-        // Note: Filenames must be kept in sync with files in api/src/main/webapp/static.\n-        .jupyterUserScriptUri(assetsBaseUrl + \"/initialize_notebook_runtime.sh\")\n-        .jupyterStartUserScriptUri(assetsBaseUrl + \"/start_notebook_runtime.sh\")\n-        .userJupyterExtensionConfig(\n-            new LeonardoUserJupyterExtensionConfig().nbExtensions(nbExtensions))\n-        // Matches Terra UI's scopes, see RW-3531 for rationale.\n-        .addScopesItem(\"https://www.googleapis.com/auth/cloud-platform\")\n-        .addScopesItem(\"https://www.googleapis.com/auth/userinfo.email\")\n-        .addScopesItem(\"https://www.googleapis.com/auth/userinfo.profile\")\n-        .runtimeConfig(\n-            new LeonardoMachineConfig()\n-                .cloudService(CloudServiceEnum.DATAPROC)\n-                .masterDiskSize(\n-                    Optional.ofNullable(clusterOverride.masterDiskSize)\n-                        .orElse(config.firecloud.notebookRuntimeDefaultDiskSizeGb))\n-                .masterMachineType(\n-                    Optional.ofNullable(clusterOverride.machineType)\n-                        .orElse(config.firecloud.notebookRuntimeDefaultMachineType)))\n-        .toolDockerImage(workbenchConfigProvider.get().firecloud.jupyterDockerImage)\n-        .welderDockerImage(workbenchConfigProvider.get().firecloud.welderDockerImage)\n-        .customEnvironmentVariables(customEnvironmentVariables);\n+    LeonardoCreateRuntimeRequest request =\n+        new LeonardoCreateRuntimeRequest()\n+            .labels(\n+                ImmutableMap.of(\n+                    RUNTIME_LABEL_AOU,\n+                    \"true\",\n+                    RUNTIME_LABEL_CREATED_BY,\n+                    userEmail,\n+                    RUNTIME_LABEL_AOU_CONFIG,\n+                    RuntimeConfigurationType.USEROVERRIDE.equals(runtime.getConfigurationType())\n+                        ? \"user-override\"\n+                        : \"default\"))\n+            .defaultClientId(config.server.oauthClientId)\n+            // Note: Filenames must be kept in sync with files in api/src/main/webapp/static.\n+            .jupyterUserScriptUri(assetsBaseUrl + \"/initialize_notebook_runtime.sh\")\n+            .jupyterStartUserScriptUri(assetsBaseUrl + \"/start_notebook_runtime.sh\")\n+            .userJupyterExtensionConfig(\n+                new LeonardoUserJupyterExtensionConfig().nbExtensions(nbExtensions))\n+            // Matches Terra UI's scopes, see RW-3531 for rationale.\n+            .addScopesItem(\"https://www.googleapis.com/auth/cloud-platform\")\n+            .addScopesItem(\"https://www.googleapis.com/auth/userinfo.email\")\n+            .addScopesItem(\"https://www.googleapis.com/auth/userinfo.profile\")\n+            .runtimeConfig(\n+                new LeonardoMachineConfig()\n+                    .cloudService(CloudServiceEnum.DATAPROC)\n+                    .masterDiskSize(\n+                        Optional.ofNullable(clusterOverride.masterDiskSize)\n+                            .orElse(config.firecloud.notebookRuntimeDefaultDiskSizeGb))", "originalCommit": "3fb5127336d28533428d77a1998da718b3149275", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgyMzA3Ng==", "url": "https://github.com/all-of-us/workbench/pull/4012#discussion_r489823076", "bodyText": "where am I getting the machine type and disk size from? Do we have the UI for that already?", "author": "ericsong", "createdAt": "2020-09-17T00:19:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc4NDc5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgyNDAyMw==", "url": "https://github.com/all-of-us/workbench/pull/4012#discussion_r489824023", "bodyText": "We don't have it yet: https://precisionmedicineinitiative.atlassian.net/browse/RW-5410", "author": "calbach", "createdAt": "2020-09-17T00:23:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc4NDc5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTg0NzI4NA==", "url": "https://github.com/all-of-us/workbench/pull/4012#discussion_r489847284", "bodyText": "should I just send over the firecloud config defaults for now then? The values we're currently using in the backend call.", "author": "ericsong", "createdAt": "2020-09-17T01:15:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc4NDc5MQ=="}], "type": "inlineReview", "revised_code": {"commit": "40f99adcf083704a85058393628c3f4d54c30e7c", "chunk": "diff --git a/api/src/main/java/org/pmiops/workbench/notebooks/LeonardoNotebooksClientImpl.java b/api/src/main/java/org/pmiops/workbench/notebooks/LeonardoNotebooksClientImpl.java\nindex b2877c94e..63bdecd83 100644\n--- a/api/src/main/java/org/pmiops/workbench/notebooks/LeonardoNotebooksClientImpl.java\n+++ b/api/src/main/java/org/pmiops/workbench/notebooks/LeonardoNotebooksClientImpl.java\n\n@@ -101,18 +106,16 @@ public class LeonardoNotebooksClientImpl implements LeonardoNotebooksClient {\n     nbExtensions.put(\n         \"aou-upload-policy-extension\", assetsBaseUrl + \"/aou-upload-policy-extension.js\");\n \n-    LeonardoCreateRuntimeRequest request =\n-        new LeonardoCreateRuntimeRequest()\n-            .labels(\n-                ImmutableMap.of(\n-                    RUNTIME_LABEL_AOU,\n-                    \"true\",\n-                    RUNTIME_LABEL_CREATED_BY,\n-                    userEmail,\n-                    RUNTIME_LABEL_AOU_CONFIG,\n-                    RuntimeConfigurationType.USEROVERRIDE.equals(runtime.getConfigurationType())\n-                        ? \"user-override\"\n-                        : \"default\"))\n+    Map<String, String> runtimeLabels = new HashMap<>();\n+    runtimeLabels.put(RUNTIME_LABEL_AOU, \"true\");\n+    runtimeLabels.put(RUNTIME_LABEL_CREATED_BY, userEmail);\n+\n+    if (runtime.getConfigurationType() != null) {\n+      runtimeLabels.put(RUNTIME_LABEL_AOU_CONFIG, RUNTIME_CONFIGURATION_TYPE_ENUM_TO_STORAGE_MAP.get(runtime.getConfigurationType()));\n+    }\n+\n+    return new LeonardoCreateRuntimeRequest()\n+            .labels(runtimeLabels)\n             .defaultClientId(config.server.oauthClientId)\n             // Note: Filenames must be kept in sync with files in api/src/main/webapp/static.\n             .jupyterUserScriptUri(assetsBaseUrl + \"/initialize_notebook_runtime.sh\")\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc4NTI5NA==", "url": "https://github.com/all-of-us/workbench/pull/4012#discussion_r489785294", "bodyText": "The client does not get to control this. We should continue to set this according to our own logic", "author": "calbach", "createdAt": "2020-09-16T22:18:35Z", "path": "api/src/main/java/org/pmiops/workbench/notebooks/LeonardoNotebooksClientImpl.java", "diffHunk": "@@ -143,10 +159,13 @@ public void createRuntime(\n     leonardoRetryHandler.run(\n         (context) -> {\n           runtimesApi.createRuntime(\n-              googleProject,\n-              runtimeName,\n+              runtime.getGoogleProject(),\n+              runtime.getRuntimeName(),", "originalCommit": "3fb5127336d28533428d77a1998da718b3149275", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgyMzczOQ==", "url": "https://github.com/all-of-us/workbench/pull/4012#discussion_r489823739", "bodyText": "It's a little hacky but the behavior is still the same because I override the client's values at the beginning of RuntimeController.createRuntime. I can move the overriding here.", "author": "ericsong", "createdAt": "2020-09-17T00:22:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc4NTI5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgyNDQ3MQ==", "url": "https://github.com/all-of-us/workbench/pull/4012#discussion_r489824471", "bodyText": "Ah, sorry - I missed that. This is fine", "author": "calbach", "createdAt": "2020-09-17T00:25:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc4NTI5NA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc4NTM4MQ==", "url": "https://github.com/all-of-us/workbench/pull/4012#discussion_r489785381", "bodyText": "If we're getting the project value here, we should also be rejecting requests where this does not matching the URL workspaceaNamespace. However, it may be cleaner just to ignore the value that's in the runtime payload.", "author": "calbach", "createdAt": "2020-09-16T22:18:50Z", "path": "api/src/main/java/org/pmiops/workbench/notebooks/LeonardoNotebooksClientImpl.java", "diffHunk": "@@ -143,10 +159,13 @@ public void createRuntime(\n     leonardoRetryHandler.run(\n         (context) -> {\n           runtimesApi.createRuntime(\n-              googleProject,\n-              runtimeName,\n+              runtime.getGoogleProject(),", "originalCommit": "3fb5127336d28533428d77a1998da718b3149275", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc4NTk3OQ==", "url": "https://github.com/all-of-us/workbench/pull/4012#discussion_r489785979", "bodyText": "This code still needs to function without the new feature flag enabled. In this current version, I don't think it will function either way.", "author": "calbach", "createdAt": "2020-09-16T22:20:33Z", "path": "api/src/main/java/org/pmiops/workbench/notebooks/LeonardoNotebooksClientImpl.java", "diffHunk": "@@ -143,10 +159,13 @@ public void createRuntime(\n     leonardoRetryHandler.run(\n         (context) -> {\n           runtimesApi.createRuntime(\n-              googleProject,\n-              runtimeName,\n+              runtime.getGoogleProject(),", "originalCommit": "3fb5127336d28533428d77a1998da718b3149275", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgyNDY0NA==", "url": "https://github.com/all-of-us/workbench/pull/4012#discussion_r489824644", "bodyText": "I can add switches for the feature flag but it does work as is. I updated the UI's API call to send over default-dataproc as the configuration type.", "author": "ericsong", "createdAt": "2020-09-17T00:25:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc4NTk3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgzMDMxNw==", "url": "https://github.com/all-of-us/workbench/pull/4012#discussion_r489830317", "bodyText": "ack - this is obsolete, this was also because I missed the logic in RuntimeController", "author": "calbach", "createdAt": "2020-09-17T00:47:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc4NTk3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTg1MTQwNw==", "url": "https://github.com/all-of-us/workbench/pull/4012#discussion_r489851407", "bodyText": "hm, in that case, is it OK to not feature flag this? We would be losing out on the ability to toggle it off if there's a bug but functionality wise, it should be the same if its on or off.", "author": "ericsong", "createdAt": "2020-09-17T01:22:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc4NTk3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDA0MjgzNw==", "url": "https://github.com/all-of-us/workbench/pull/4012#discussion_r490042837", "bodyText": "Yeah I suppose machine type and disk size could be hardcoded on the ui instead with this change. The feature flag could then just control whether to look at the clusteroverride", "author": "calbach", "createdAt": "2020-09-17T07:52:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc4NTk3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDM5ODI0Ng==", "url": "https://github.com/all-of-us/workbench/pull/4012#discussion_r490398246", "bodyText": "Or else, just fallback to the previous config value if the client does not supply a runtime config; should be required with the new flag though. I'm not sure which will be easier here.", "author": "calbach", "createdAt": "2020-09-17T16:29:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc4NTk3OQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc4ODA5Ng==", "url": "https://github.com/all-of-us/workbench/pull/4012#discussion_r489788096", "bodyText": "nit: perhaps this was changed for debugging, but definitely prefer how this was previously written - assigning to a variable only to immediately return it on the next line is a bit of a pet peeve of mine", "author": "calbach", "createdAt": "2020-09-16T22:26:15Z", "path": "api/src/main/java/org/pmiops/workbench/notebooks/LeonardoNotebooksClientImpl.java", "diffHunk": "@@ -97,39 +101,51 @@ private LeonardoCreateRuntimeRequest buildCreateRuntimeRequest(\n     nbExtensions.put(\n         \"aou-upload-policy-extension\", assetsBaseUrl + \"/aou-upload-policy-extension.js\");\n \n-    return new LeonardoCreateRuntimeRequest()\n-        .labels(ImmutableMap.of(RUNTIME_LABEL_AOU, \"true\", RUNTIME_LABEL_CREATED_BY, userEmail))\n-        .defaultClientId(config.server.oauthClientId)\n-        // Note: Filenames must be kept in sync with files in api/src/main/webapp/static.\n-        .jupyterUserScriptUri(assetsBaseUrl + \"/initialize_notebook_runtime.sh\")\n-        .jupyterStartUserScriptUri(assetsBaseUrl + \"/start_notebook_runtime.sh\")\n-        .userJupyterExtensionConfig(\n-            new LeonardoUserJupyterExtensionConfig().nbExtensions(nbExtensions))\n-        // Matches Terra UI's scopes, see RW-3531 for rationale.\n-        .addScopesItem(\"https://www.googleapis.com/auth/cloud-platform\")\n-        .addScopesItem(\"https://www.googleapis.com/auth/userinfo.email\")\n-        .addScopesItem(\"https://www.googleapis.com/auth/userinfo.profile\")\n-        .runtimeConfig(\n-            new LeonardoMachineConfig()\n-                .cloudService(CloudServiceEnum.DATAPROC)\n-                .masterDiskSize(\n-                    Optional.ofNullable(clusterOverride.masterDiskSize)\n-                        .orElse(config.firecloud.notebookRuntimeDefaultDiskSizeGb))\n-                .masterMachineType(\n-                    Optional.ofNullable(clusterOverride.machineType)\n-                        .orElse(config.firecloud.notebookRuntimeDefaultMachineType)))\n-        .toolDockerImage(workbenchConfigProvider.get().firecloud.jupyterDockerImage)\n-        .welderDockerImage(workbenchConfigProvider.get().firecloud.welderDockerImage)\n-        .customEnvironmentVariables(customEnvironmentVariables);\n+    LeonardoCreateRuntimeRequest request =\n+        new LeonardoCreateRuntimeRequest()\n+            .labels(\n+                ImmutableMap.of(\n+                    RUNTIME_LABEL_AOU,\n+                    \"true\",\n+                    RUNTIME_LABEL_CREATED_BY,\n+                    userEmail,\n+                    RUNTIME_LABEL_AOU_CONFIG,\n+                    RuntimeConfigurationType.USEROVERRIDE.equals(runtime.getConfigurationType())\n+                        ? \"user-override\"\n+                        : \"default\"))\n+            .defaultClientId(config.server.oauthClientId)\n+            // Note: Filenames must be kept in sync with files in api/src/main/webapp/static.\n+            .jupyterUserScriptUri(assetsBaseUrl + \"/initialize_notebook_runtime.sh\")\n+            .jupyterStartUserScriptUri(assetsBaseUrl + \"/start_notebook_runtime.sh\")\n+            .userJupyterExtensionConfig(\n+                new LeonardoUserJupyterExtensionConfig().nbExtensions(nbExtensions))\n+            // Matches Terra UI's scopes, see RW-3531 for rationale.\n+            .addScopesItem(\"https://www.googleapis.com/auth/cloud-platform\")\n+            .addScopesItem(\"https://www.googleapis.com/auth/userinfo.email\")\n+            .addScopesItem(\"https://www.googleapis.com/auth/userinfo.profile\")\n+            .runtimeConfig(\n+                new LeonardoMachineConfig()\n+                    .cloudService(CloudServiceEnum.DATAPROC)\n+                    .masterDiskSize(\n+                        Optional.ofNullable(clusterOverride.masterDiskSize)\n+                            .orElse(config.firecloud.notebookRuntimeDefaultDiskSizeGb))\n+                    .masterMachineType(\n+                        Optional.ofNullable(clusterOverride.machineType)\n+                            .orElse(config.firecloud.notebookRuntimeDefaultMachineType)))\n+            .toolDockerImage(workbenchConfigProvider.get().firecloud.jupyterDockerImage)\n+            .welderDockerImage(workbenchConfigProvider.get().firecloud.welderDockerImage)\n+            .customEnvironmentVariables(customEnvironmentVariables);\n+\n+    return request;", "originalCommit": "3fb5127336d28533428d77a1998da718b3149275", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "40f99adcf083704a85058393628c3f4d54c30e7c", "chunk": "diff --git a/api/src/main/java/org/pmiops/workbench/notebooks/LeonardoNotebooksClientImpl.java b/api/src/main/java/org/pmiops/workbench/notebooks/LeonardoNotebooksClientImpl.java\nindex b2877c94e..63bdecd83 100644\n--- a/api/src/main/java/org/pmiops/workbench/notebooks/LeonardoNotebooksClientImpl.java\n+++ b/api/src/main/java/org/pmiops/workbench/notebooks/LeonardoNotebooksClientImpl.java\n\n@@ -101,18 +106,16 @@ public class LeonardoNotebooksClientImpl implements LeonardoNotebooksClient {\n     nbExtensions.put(\n         \"aou-upload-policy-extension\", assetsBaseUrl + \"/aou-upload-policy-extension.js\");\n \n-    LeonardoCreateRuntimeRequest request =\n-        new LeonardoCreateRuntimeRequest()\n-            .labels(\n-                ImmutableMap.of(\n-                    RUNTIME_LABEL_AOU,\n-                    \"true\",\n-                    RUNTIME_LABEL_CREATED_BY,\n-                    userEmail,\n-                    RUNTIME_LABEL_AOU_CONFIG,\n-                    RuntimeConfigurationType.USEROVERRIDE.equals(runtime.getConfigurationType())\n-                        ? \"user-override\"\n-                        : \"default\"))\n+    Map<String, String> runtimeLabels = new HashMap<>();\n+    runtimeLabels.put(RUNTIME_LABEL_AOU, \"true\");\n+    runtimeLabels.put(RUNTIME_LABEL_CREATED_BY, userEmail);\n+\n+    if (runtime.getConfigurationType() != null) {\n+      runtimeLabels.put(RUNTIME_LABEL_AOU_CONFIG, RUNTIME_CONFIGURATION_TYPE_ENUM_TO_STORAGE_MAP.get(runtime.getConfigurationType()));\n+    }\n+\n+    return new LeonardoCreateRuntimeRequest()\n+            .labels(runtimeLabels)\n             .defaultClientId(config.server.oauthClientId)\n             // Note: Filenames must be kept in sync with files in api/src/main/webapp/static.\n             .jupyterUserScriptUri(assetsBaseUrl + \"/initialize_notebook_runtime.sh\")\n"}}, {"oid": "40f99adcf083704a85058393628c3f4d54c30e7c", "url": "https://github.com/all-of-us/workbench/commit/40f99adcf083704a85058393628c3f4d54c30e7c", "message": "new labels, handle null/empty case", "committedDate": "2020-09-17T19:23:04Z", "type": "commit"}, {"oid": "8b3fc77fb5ae22650bf507900a246d2eb972c3d9", "url": "https://github.com/all-of-us/workbench/commit/8b3fc77fb5ae22650bf507900a246d2eb972c3d9", "message": "spotless", "committedDate": "2020-09-17T19:24:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDU3NjEzNg==", "url": "https://github.com/all-of-us/workbench/pull/4012#discussion_r490576136", "bodyText": "Would be good to validate that the machine type and disk are actually getting plumbed in a test case", "author": "calbach", "createdAt": "2020-09-17T21:36:41Z", "path": "api/src/test/java/org/pmiops/workbench/api/RuntimeControllerTest.java", "diffHunk": "@@ -454,24 +480,95 @@ public void testDeleteRuntimesInProject_NullRuntimesList() {\n   }\n \n   @Test\n-  public void testCreateRuntime() {\n-    when(mockLeoNotebooksClient.getRuntime(BILLING_PROJECT_ID, getRuntimeName()))\n+  public void testCreateRuntime() throws ApiException {\n+    when(userRuntimesApi.getRuntime(BILLING_PROJECT_ID, getRuntimeName()))\n         .thenThrow(new NotFoundException());\n     stubGetWorkspace(WORKSPACE_NS, WORKSPACE_ID, \"test\");\n \n-    runtimeController.createRuntime(BILLING_PROJECT_ID);\n-    verify(mockLeoNotebooksClient)\n-        .createRuntime(eq(BILLING_PROJECT_ID), eq(getRuntimeName()), eq(WORKSPACE_ID));\n+    runtimeController.createRuntime(BILLING_PROJECT_ID, new Runtime());\n+    verify(userRuntimesApi).createRuntime(eq(BILLING_PROJECT_ID), eq(getRuntimeName()), any());\n   }\n \n   @Test\n-  public void testDeleteRuntime() {\n+  public void testCreateRuntime_nullRuntime() throws ApiException {\n+    when(userRuntimesApi.getRuntime(BILLING_PROJECT_ID, getRuntimeName()))\n+        .thenThrow(new NotFoundException());\n+    stubGetWorkspace(WORKSPACE_NS, WORKSPACE_ID, \"test\");\n+\n+    runtimeController.createRuntime(BILLING_PROJECT_ID, null);\n+    verify(userRuntimesApi).createRuntime(eq(BILLING_PROJECT_ID), eq(getRuntimeName()), any());\n+  }\n+\n+  @Test\n+  public void testCreateRuntime_emptyRuntime() throws ApiException {\n+    when(userRuntimesApi.getRuntime(BILLING_PROJECT_ID, getRuntimeName()))\n+        .thenThrow(new NotFoundException());\n+    stubGetWorkspace(WORKSPACE_NS, WORKSPACE_ID, \"test\");\n+\n+    runtimeController.createRuntime(BILLING_PROJECT_ID, new Runtime());\n+    verify(userRuntimesApi).createRuntime(eq(BILLING_PROJECT_ID), eq(getRuntimeName()), any());\n+  }\n+\n+  @Test\n+  public void testCreateRuntime_defaultLabel_dataproc() throws ApiException {\n+    when(userRuntimesApi.getRuntime(BILLING_PROJECT_ID, getRuntimeName()))\n+        .thenThrow(new NotFoundException());\n+    stubGetWorkspace(WORKSPACE_NS, WORKSPACE_ID, \"test\");\n+\n+    runtimeController.createRuntime(\n+        BILLING_PROJECT_ID,\n+        new Runtime().configurationType(RuntimeConfigurationType.DEFAULTDATAPROC));\n+    verify(userRuntimesApi)\n+        .createRuntime(\n+            eq(BILLING_PROJECT_ID), eq(getRuntimeName()), createRuntimeRequestCaptor.capture());\n+\n+    LeonardoCreateRuntimeRequest createRuntimeRequest = createRuntimeRequestCaptor.getValue();\n+    assertThat(((Map<String, String>) createRuntimeRequest.getLabels()).get(\"all-of-us-config\"))\n+        .isEqualTo(\"default-dataproc\");\n+  }\n+\n+  @Test\n+  public void testCreateRuntime_defaultLabel_gce() throws ApiException {\n+    when(userRuntimesApi.getRuntime(BILLING_PROJECT_ID, getRuntimeName()))\n+        .thenThrow(new NotFoundException());\n+    stubGetWorkspace(WORKSPACE_NS, WORKSPACE_ID, \"test\");\n+\n+    runtimeController.createRuntime(\n+        BILLING_PROJECT_ID, new Runtime().configurationType(RuntimeConfigurationType.DEFAULTGCE));\n+    verify(userRuntimesApi)\n+        .createRuntime(\n+            eq(BILLING_PROJECT_ID), eq(getRuntimeName()), createRuntimeRequestCaptor.capture());\n+\n+    LeonardoCreateRuntimeRequest createRuntimeRequest = createRuntimeRequestCaptor.getValue();\n+    assertThat(((Map<String, String>) createRuntimeRequest.getLabels()).get(\"all-of-us-config\"))\n+        .isEqualTo(\"default-gce\");\n+  }\n+\n+  @Test\n+  public void testCreateRuntime_overrideLabel() throws ApiException {\n+    when(userRuntimesApi.getRuntime(BILLING_PROJECT_ID, getRuntimeName()))\n+        .thenThrow(new NotFoundException());\n+    stubGetWorkspace(WORKSPACE_NS, WORKSPACE_ID, \"test\");\n+\n+    runtimeController.createRuntime(\n+        BILLING_PROJECT_ID, new Runtime().configurationType(RuntimeConfigurationType.USEROVERRIDE));\n+    verify(userRuntimesApi)\n+        .createRuntime(\n+            eq(BILLING_PROJECT_ID), eq(getRuntimeName()), createRuntimeRequestCaptor.capture());\n+\n+    LeonardoCreateRuntimeRequest createRuntimeRequest = createRuntimeRequestCaptor.getValue();\n+    assertThat(((Map<String, String>) createRuntimeRequest.getLabels()).get(\"all-of-us-config\"))", "originalCommit": "8b3fc77fb5ae22650bf507900a246d2eb972c3d9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "66095df7119aff74ae8b5fa08d9ed7872b9ec416", "chunk": "diff --git a/api/src/test/java/org/pmiops/workbench/api/RuntimeControllerTest.java b/api/src/test/java/org/pmiops/workbench/api/RuntimeControllerTest.java\nindex 96edc8179..463a44fcc 100644\n--- a/api/src/test/java/org/pmiops/workbench/api/RuntimeControllerTest.java\n+++ b/api/src/test/java/org/pmiops/workbench/api/RuntimeControllerTest.java\n\n@@ -480,13 +487,113 @@ public class RuntimeControllerTest {\n   }\n \n   @Test\n-  public void testCreateRuntime() throws ApiException {\n+  public void testCreateRuntime_customRuntimeEnabled_noRuntimes() throws ApiException {\n     when(userRuntimesApi.getRuntime(BILLING_PROJECT_ID, getRuntimeName()))\n         .thenThrow(new NotFoundException());\n     stubGetWorkspace(WORKSPACE_NS, WORKSPACE_ID, \"test\");\n+    config.featureFlags.enableCustomRuntimes = true;\n \n-    runtimeController.createRuntime(BILLING_PROJECT_ID, new Runtime());\n-    verify(userRuntimesApi).createRuntime(eq(BILLING_PROJECT_ID), eq(getRuntimeName()), any());\n+    assertThrows(\n+        BadRequestException.class,\n+        () -> runtimeController.createRuntime(BILLING_PROJECT_ID, new Runtime()));\n+  }\n+\n+  @Test\n+  public void testCreateRuntime_customRuntimeEnabled_twoRuntimes() throws ApiException {\n+    when(userRuntimesApi.getRuntime(BILLING_PROJECT_ID, getRuntimeName()))\n+        .thenThrow(new NotFoundException());\n+    stubGetWorkspace(WORKSPACE_NS, WORKSPACE_ID, \"test\");\n+    config.featureFlags.enableCustomRuntimes = true;\n+\n+    assertThrows(\n+        BadRequestException.class,\n+        () ->\n+            runtimeController.createRuntime(\n+                BILLING_PROJECT_ID,\n+                new Runtime()\n+                    .dataprocConfig(new DataprocConfig().masterMachineType(\"standard\"))\n+                    .gceConfig(new GceConfig().machineType(\"standard\"))));\n+  }\n+\n+  @Test\n+  public void testCreateRuntime_dataproc() throws ApiException {\n+    when(userRuntimesApi.getRuntime(BILLING_PROJECT_ID, getRuntimeName()))\n+        .thenThrow(new NotFoundException());\n+    stubGetWorkspace(WORKSPACE_NS, WORKSPACE_ID, \"test\");\n+    config.featureFlags.enableCustomRuntimes = true;\n+\n+    runtimeController.createRuntime(\n+        BILLING_PROJECT_ID,\n+        new Runtime()\n+            .dataprocConfig(\n+                new DataprocConfig()\n+                    .numberOfWorkers(5)\n+                    .workerMachineType(\"worker\")\n+                    .workerDiskSize(10)\n+                    .numberOfWorkerLocalSSDs(1)\n+                    .numberOfPreemptibleWorkers(3)\n+                    .masterDiskSize(100)\n+                    .masterMachineType(\"standard\")));\n+\n+    verify(userRuntimesApi)\n+        .createRuntime(\n+            eq(BILLING_PROJECT_ID), eq(getRuntimeName()), createRuntimeRequestCaptor.capture());\n+\n+    LeonardoCreateRuntimeRequest createRuntimeRequest = createRuntimeRequestCaptor.getValue();\n+\n+    Gson gson = new Gson();\n+    LeonardoMachineConfig createLeonardoMachineConfig =\n+        gson.fromJson(\n+            gson.toJson(createRuntimeRequest.getRuntimeConfig()), LeonardoMachineConfig.class);\n+\n+    assertThat(\n+            gson.fromJson(\n+                    gson.toJson(createRuntimeRequest.getRuntimeConfig()),\n+                    LeonardoRuntimeConfig.class)\n+                .getCloudService())\n+        .isEqualTo(LeonardoRuntimeConfig.CloudServiceEnum.DATAPROC);\n+    assertThat(createLeonardoMachineConfig.getNumberOfWorkers()).isEqualTo(5);\n+    assertThat(createLeonardoMachineConfig.getWorkerMachineType()).isEqualTo(\"worker\");\n+    assertThat(createLeonardoMachineConfig.getWorkerDiskSize()).isEqualTo(10);\n+    assertThat(createLeonardoMachineConfig.getNumberOfWorkerLocalSSDs()).isEqualTo(1);\n+    assertThat(createLeonardoMachineConfig.getNumberOfPreemptibleWorkers()).isEqualTo(3);\n+    assertThat(createLeonardoMachineConfig.getMasterDiskSize()).isEqualTo(100);\n+    assertThat(createLeonardoMachineConfig.getMasterMachineType()).isEqualTo(\"standard\");\n+  }\n+\n+  @Test\n+  public void testCreateRuntime_gce() throws ApiException {\n+    when(userRuntimesApi.getRuntime(BILLING_PROJECT_ID, getRuntimeName()))\n+        .thenThrow(new NotFoundException());\n+    stubGetWorkspace(WORKSPACE_NS, WORKSPACE_ID, \"test\");\n+    config.featureFlags.enableCustomRuntimes = true;\n+\n+    runtimeController.createRuntime(\n+        BILLING_PROJECT_ID,\n+        new Runtime()\n+            .gceConfig(new GceConfig().bootDiskSize(10).diskSize(50).machineType(\"standard\")));\n+\n+    verify(userRuntimesApi)\n+        .createRuntime(\n+            eq(BILLING_PROJECT_ID), eq(getRuntimeName()), createRuntimeRequestCaptor.capture());\n+\n+    LeonardoCreateRuntimeRequest createRuntimeRequest = createRuntimeRequestCaptor.getValue();\n+\n+    Gson gson = new Gson();\n+    LeonardoGceConfig createLeonardoGceConfig =\n+        gson.fromJson(\n+            gson.toJson(createRuntimeRequest.getRuntimeConfig()), LeonardoGceConfig.class);\n+\n+    assertThat(\n+            gson.fromJson(\n+                    gson.toJson(createRuntimeRequest.getRuntimeConfig()),\n+                    LeonardoRuntimeConfig.class)\n+                .getCloudService())\n+        .isEqualTo(LeonardoRuntimeConfig.CloudServiceEnum.GCE);\n+    assertThat(createLeonardoGceConfig.getBootDiskSize()).isEqualTo(10);\n+    assertThat(createLeonardoGceConfig.getDiskSize()).isEqualTo(50);\n+\n+    assertThat(createLeonardoGceConfig.getMachineType()).isEqualTo(\"standard\");\n   }\n \n   @Test\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDU3ODI1OA==", "url": "https://github.com/all-of-us/workbench/pull/4012#discussion_r490578258", "bodyText": "The machineType and masterDisk size are still not being passed through on L135-140. The logic should be as follows:\n\nIf Runtime is provided, prefer the masterMachineType and masterDiskSize from the client-specified values.\nElse if !enableCustomRuntimes && clusterOverride != null, prefer that (with current fallback logic for either type or disk)\nelse use the default from config.firecloud.*\n\nOptionally: require a runtime payload be provided if enableCustomRuntimes; potentially this mitigates the need for bullet (2) above", "author": "calbach", "createdAt": "2020-09-17T21:41:31Z", "path": "api/src/main/java/org/pmiops/workbench/notebooks/LeonardoNotebooksClientImpl.java", "diffHunk": "@@ -97,8 +107,18 @@ private LeonardoCreateRuntimeRequest buildCreateRuntimeRequest(\n     nbExtensions.put(\n         \"aou-upload-policy-extension\", assetsBaseUrl + \"/aou-upload-policy-extension.js\");\n \n+    Map<String, String> runtimeLabels = new HashMap<>();\n+    runtimeLabels.put(RUNTIME_LABEL_AOU, \"true\");\n+    runtimeLabels.put(RUNTIME_LABEL_CREATED_BY, userEmail);\n+\n+    if (runtime.getConfigurationType() != null) {\n+      runtimeLabels.put(\n+          RUNTIME_LABEL_AOU_CONFIG,\n+          RUNTIME_CONFIGURATION_TYPE_ENUM_TO_STORAGE_MAP.get(runtime.getConfigurationType()));\n+    }\n+\n     return new LeonardoCreateRuntimeRequest()\n-        .labels(ImmutableMap.of(RUNTIME_LABEL_AOU, \"true\", RUNTIME_LABEL_CREATED_BY, userEmail))\n+        .labels(runtimeLabels)", "originalCommit": "8b3fc77fb5ae22650bf507900a246d2eb972c3d9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTAzNTcxOA==", "url": "https://github.com/all-of-us/workbench/pull/4012#discussion_r491035718", "bodyText": "I thought we said that there isn't too much value in shuttling the default values from the API to the UI just for it to come back. Given that the upcoming UI work will be overwriting that bit of code anyways.\nI'll make the changes but I really don't think either version will block or hamper the upcoming tickets in the sprint, ones I cannot work on ATM until this merges.", "author": "ericsong", "createdAt": "2020-09-18T15:43:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDU3ODI1OA=="}], "type": "inlineReview", "revised_code": {"commit": "66095df7119aff74ae8b5fa08d9ed7872b9ec416", "chunk": "diff --git a/api/src/main/java/org/pmiops/workbench/notebooks/LeonardoNotebooksClientImpl.java b/api/src/main/java/org/pmiops/workbench/notebooks/LeonardoNotebooksClientImpl.java\nindex 4cda55d55..8ab69391a 100644\n--- a/api/src/main/java/org/pmiops/workbench/notebooks/LeonardoNotebooksClientImpl.java\n+++ b/api/src/main/java/org/pmiops/workbench/notebooks/LeonardoNotebooksClientImpl.java\n\n@@ -117,30 +122,51 @@ public class LeonardoNotebooksClientImpl implements LeonardoNotebooksClient {\n           RUNTIME_CONFIGURATION_TYPE_ENUM_TO_STORAGE_MAP.get(runtime.getConfigurationType()));\n     }\n \n-    return new LeonardoCreateRuntimeRequest()\n-        .labels(runtimeLabels)\n-        .defaultClientId(config.server.oauthClientId)\n-        // Note: Filenames must be kept in sync with files in api/src/main/webapp/static.\n-        .jupyterUserScriptUri(assetsBaseUrl + \"/initialize_notebook_runtime.sh\")\n-        .jupyterStartUserScriptUri(assetsBaseUrl + \"/start_notebook_runtime.sh\")\n-        .userJupyterExtensionConfig(\n-            new LeonardoUserJupyterExtensionConfig().nbExtensions(nbExtensions))\n-        // Matches Terra UI's scopes, see RW-3531 for rationale.\n-        .addScopesItem(\"https://www.googleapis.com/auth/cloud-platform\")\n-        .addScopesItem(\"https://www.googleapis.com/auth/userinfo.email\")\n-        .addScopesItem(\"https://www.googleapis.com/auth/userinfo.profile\")\n-        .runtimeConfig(\n-            new LeonardoMachineConfig()\n-                .cloudService(CloudServiceEnum.DATAPROC)\n-                .masterDiskSize(\n-                    Optional.ofNullable(clusterOverride.masterDiskSize)\n-                        .orElse(config.firecloud.notebookRuntimeDefaultDiskSizeGb))\n-                .masterMachineType(\n-                    Optional.ofNullable(clusterOverride.machineType)\n-                        .orElse(config.firecloud.notebookRuntimeDefaultMachineType)))\n-        .toolDockerImage(workbenchConfigProvider.get().firecloud.jupyterDockerImage)\n-        .welderDockerImage(workbenchConfigProvider.get().firecloud.welderDockerImage)\n-        .customEnvironmentVariables(customEnvironmentVariables);\n+    LeonardoCreateRuntimeRequest request =\n+        new LeonardoCreateRuntimeRequest()\n+            .labels(runtimeLabels)\n+            .defaultClientId(config.server.oauthClientId)\n+            // Note: Filenames must be kept in sync with files in api/src/main/webapp/static.\n+            .jupyterUserScriptUri(assetsBaseUrl + \"/initialize_notebook_runtime.sh\")\n+            .jupyterStartUserScriptUri(assetsBaseUrl + \"/start_notebook_runtime.sh\")\n+            .userJupyterExtensionConfig(\n+                new LeonardoUserJupyterExtensionConfig().nbExtensions(nbExtensions))\n+            // Matches Terra UI's scopes, see RW-3531 for rationale.\n+            .addScopesItem(\"https://www.googleapis.com/auth/cloud-platform\")\n+            .addScopesItem(\"https://www.googleapis.com/auth/userinfo.email\")\n+            .addScopesItem(\"https://www.googleapis.com/auth/userinfo.profile\")\n+            .toolDockerImage(workbenchConfigProvider.get().firecloud.jupyterDockerImage)\n+            .welderDockerImage(workbenchConfigProvider.get().firecloud.welderDockerImage)\n+            .customEnvironmentVariables(customEnvironmentVariables);\n+\n+    if (workbenchConfigProvider.get().featureFlags.enableCustomRuntimes) {\n+      if (runtime.getGceConfig() == null && runtime.getDataprocConfig() == null) {\n+        throw new ApiException(400, \"Either a GceConfig or DataprocConfig must be provided\");\n+      }\n+\n+      if (runtime.getGceConfig() != null && runtime.getDataprocConfig() != null) {\n+        throw new ApiException(400, \"Only one of GceConfig or DataprocConfig must be provided\");\n+      }\n+\n+      if (runtime.getGceConfig() != null) {\n+        request.setRuntimeConfig(leonardoMapper.toLeonardoGceConfig(runtime.getGceConfig()));\n+      } else {\n+        request.setRuntimeConfig(\n+            leonardoMapper.toLeonardoMachineConfig(runtime.getDataprocConfig()));\n+      }\n+    } else {\n+      request.setRuntimeConfig(\n+          new LeonardoMachineConfig()\n+              .cloudService(CloudServiceEnum.DATAPROC)\n+              .masterDiskSize(\n+                  Optional.ofNullable(clusterOverride.masterDiskSize)\n+                      .orElse(config.firecloud.notebookRuntimeDefaultDiskSizeGb))\n+              .masterMachineType(\n+                  Optional.ofNullable(clusterOverride.machineType)\n+                      .orElse(config.firecloud.notebookRuntimeDefaultMachineType)));\n+    }\n+\n+    return request;\n   }\n \n   @Override\n"}}, {"oid": "66095df7119aff74ae8b5fa08d9ed7872b9ec416", "url": "https://github.com/all-of-us/workbench/commit/66095df7119aff74ae8b5fa08d9ed7872b9ec416", "message": "respect custom runtime configs", "committedDate": "2020-09-18T18:36:25Z", "type": "commit"}, {"oid": "2122efd739a3a22c9596a2d21b2b0aa4214494f7", "url": "https://github.com/all-of-us/workbench/commit/2122efd739a3a22c9596a2d21b2b0aa4214494f7", "message": "comment", "committedDate": "2020-09-18T18:38:13Z", "type": "commit"}, {"oid": "35d5e85525995fcef671d8af8eaf43ebc80f96c1", "url": "https://github.com/all-of-us/workbench/commit/35d5e85525995fcef671d8af8eaf43ebc80f96c1", "message": "more comments", "committedDate": "2020-09-18T18:43:21Z", "type": "commit"}, {"oid": "34d03341f61b0b24b6edc33fc2c637818cfc223e", "url": "https://github.com/all-of-us/workbench/commit/34d03341f61b0b24b6edc33fc2c637818cfc223e", "message": "merge master", "committedDate": "2020-09-18T18:47:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTEzMTMxNw==", "url": "https://github.com/all-of-us/workbench/pull/4012#discussion_r491131317", "bodyText": "nit: BadRequestException", "author": "calbach", "createdAt": "2020-09-18T18:48:51Z", "path": "api/src/main/java/org/pmiops/workbench/notebooks/LeonardoNotebooksClientImpl.java", "diffHunk": "@@ -97,39 +112,72 @@ private LeonardoCreateRuntimeRequest buildCreateRuntimeRequest(\n     nbExtensions.put(\n         \"aou-upload-policy-extension\", assetsBaseUrl + \"/aou-upload-policy-extension.js\");\n \n-    return new LeonardoCreateRuntimeRequest()\n-        .labels(ImmutableMap.of(RUNTIME_LABEL_AOU, \"true\", RUNTIME_LABEL_CREATED_BY, userEmail))\n-        .defaultClientId(config.server.oauthClientId)\n-        // Note: Filenames must be kept in sync with files in api/src/main/webapp/static.\n-        .jupyterUserScriptUri(assetsBaseUrl + \"/initialize_notebook_runtime.sh\")\n-        .jupyterStartUserScriptUri(assetsBaseUrl + \"/start_notebook_runtime.sh\")\n-        .userJupyterExtensionConfig(\n-            new LeonardoUserJupyterExtensionConfig().nbExtensions(nbExtensions))\n-        // Matches Terra UI's scopes, see RW-3531 for rationale.\n-        .addScopesItem(\"https://www.googleapis.com/auth/cloud-platform\")\n-        .addScopesItem(\"https://www.googleapis.com/auth/userinfo.email\")\n-        .addScopesItem(\"https://www.googleapis.com/auth/userinfo.profile\")\n-        .runtimeConfig(\n-            new LeonardoMachineConfig()\n-                .cloudService(CloudServiceEnum.DATAPROC)\n-                .masterDiskSize(\n-                    Optional.ofNullable(clusterOverride.masterDiskSize)\n-                        .orElse(config.firecloud.notebookRuntimeDefaultDiskSizeGb))\n-                .masterMachineType(\n-                    Optional.ofNullable(clusterOverride.machineType)\n-                        .orElse(config.firecloud.notebookRuntimeDefaultMachineType)))\n-        .toolDockerImage(workbenchConfigProvider.get().firecloud.jupyterDockerImage)\n-        .welderDockerImage(workbenchConfigProvider.get().firecloud.welderDockerImage)\n-        .customEnvironmentVariables(customEnvironmentVariables);\n+    Map<String, String> runtimeLabels = new HashMap<>();\n+    runtimeLabels.put(RUNTIME_LABEL_AOU, \"true\");\n+    runtimeLabels.put(RUNTIME_LABEL_CREATED_BY, userEmail);\n+\n+    if (runtime.getConfigurationType() != null) {\n+      runtimeLabels.put(\n+          RUNTIME_LABEL_AOU_CONFIG,\n+          RUNTIME_CONFIGURATION_TYPE_ENUM_TO_STORAGE_MAP.get(runtime.getConfigurationType()));\n+    }\n+\n+    LeonardoCreateRuntimeRequest request =\n+        new LeonardoCreateRuntimeRequest()\n+            .labels(runtimeLabels)\n+            .defaultClientId(config.server.oauthClientId)\n+            // Note: Filenames must be kept in sync with files in api/src/main/webapp/static.\n+            .jupyterUserScriptUri(assetsBaseUrl + \"/initialize_notebook_runtime.sh\")\n+            .jupyterStartUserScriptUri(assetsBaseUrl + \"/start_notebook_runtime.sh\")\n+            .userJupyterExtensionConfig(\n+                new LeonardoUserJupyterExtensionConfig().nbExtensions(nbExtensions))\n+            // Matches Terra UI's scopes, see RW-3531 for rationale.\n+            .addScopesItem(\"https://www.googleapis.com/auth/cloud-platform\")\n+            .addScopesItem(\"https://www.googleapis.com/auth/userinfo.email\")\n+            .addScopesItem(\"https://www.googleapis.com/auth/userinfo.profile\")\n+            .toolDockerImage(workbenchConfigProvider.get().firecloud.jupyterDockerImage)\n+            .welderDockerImage(workbenchConfigProvider.get().firecloud.welderDockerImage)\n+            .customEnvironmentVariables(customEnvironmentVariables);\n+\n+    if (workbenchConfigProvider.get().featureFlags.enableCustomRuntimes) {\n+      if (runtime.getGceConfig() == null && runtime.getDataprocConfig() == null) {\n+        // There's probably a code smell here where I'm throwing an exception that we're only\n+        // expecting to handle as a response from Leo but this was the quickest path forward for now.\n+        throw new ApiException(400, \"Either a GceConfig or DataprocConfig must be provided\");", "originalCommit": "34d03341f61b0b24b6edc33fc2c637818cfc223e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTEzNTEyNQ==", "url": "https://github.com/all-of-us/workbench/pull/4012#discussion_r491135125", "bodyText": "Tried that first but it doesn't work because the LeoRetryHandler tries to cast it into an ApiException. I think the problem here is that LeoRetryHandler has the assumption that its basically just a shim for calls to Leo APIs but we've added enough logic here that we can throw our own exceptions.", "author": "ericsong", "createdAt": "2020-09-18T18:57:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTEzMTMxNw=="}], "type": "inlineReview", "revised_code": {"commit": "4b3a74cf3933d4f8cad371da32132f11c064b265", "chunk": "diff --git a/api/src/main/java/org/pmiops/workbench/notebooks/LeonardoNotebooksClientImpl.java b/api/src/main/java/org/pmiops/workbench/notebooks/LeonardoNotebooksClientImpl.java\nindex 57c69c8d0..e349c7f59 100644\n--- a/api/src/main/java/org/pmiops/workbench/notebooks/LeonardoNotebooksClientImpl.java\n+++ b/api/src/main/java/org/pmiops/workbench/notebooks/LeonardoNotebooksClientImpl.java\n\n@@ -140,16 +140,6 @@ public class LeonardoNotebooksClientImpl implements LeonardoNotebooksClient {\n             .customEnvironmentVariables(customEnvironmentVariables);\n \n     if (workbenchConfigProvider.get().featureFlags.enableCustomRuntimes) {\n-      if (runtime.getGceConfig() == null && runtime.getDataprocConfig() == null) {\n-        // There's probably a code smell here where I'm throwing an exception that we're only\n-        // expecting to handle as a response from Leo but this was the quickest path forward for now.\n-        throw new ApiException(400, \"Either a GceConfig or DataprocConfig must be provided\");\n-      }\n-\n-      if (runtime.getGceConfig() != null && runtime.getDataprocConfig() != null) {\n-        throw new ApiException(400, \"Only one of GceConfig or DataprocConfig must be provided\");\n-      }\n-\n       if (runtime.getGceConfig() != null) {\n         request.setRuntimeConfig(leonardoMapper.toLeonardoGceConfig(runtime.getGceConfig()));\n       } else {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTEzMTczNg==", "url": "https://github.com/all-of-us/workbench/pull/4012#discussion_r491131736", "bodyText": "opt: Ideally I would probably move this validation logic to the controller method. This could also wait for some of the dust to settle as well", "author": "calbach", "createdAt": "2020-09-18T18:49:42Z", "path": "api/src/main/java/org/pmiops/workbench/notebooks/LeonardoNotebooksClientImpl.java", "diffHunk": "@@ -97,39 +112,72 @@ private LeonardoCreateRuntimeRequest buildCreateRuntimeRequest(\n     nbExtensions.put(\n         \"aou-upload-policy-extension\", assetsBaseUrl + \"/aou-upload-policy-extension.js\");\n \n-    return new LeonardoCreateRuntimeRequest()\n-        .labels(ImmutableMap.of(RUNTIME_LABEL_AOU, \"true\", RUNTIME_LABEL_CREATED_BY, userEmail))\n-        .defaultClientId(config.server.oauthClientId)\n-        // Note: Filenames must be kept in sync with files in api/src/main/webapp/static.\n-        .jupyterUserScriptUri(assetsBaseUrl + \"/initialize_notebook_runtime.sh\")\n-        .jupyterStartUserScriptUri(assetsBaseUrl + \"/start_notebook_runtime.sh\")\n-        .userJupyterExtensionConfig(\n-            new LeonardoUserJupyterExtensionConfig().nbExtensions(nbExtensions))\n-        // Matches Terra UI's scopes, see RW-3531 for rationale.\n-        .addScopesItem(\"https://www.googleapis.com/auth/cloud-platform\")\n-        .addScopesItem(\"https://www.googleapis.com/auth/userinfo.email\")\n-        .addScopesItem(\"https://www.googleapis.com/auth/userinfo.profile\")\n-        .runtimeConfig(\n-            new LeonardoMachineConfig()\n-                .cloudService(CloudServiceEnum.DATAPROC)\n-                .masterDiskSize(\n-                    Optional.ofNullable(clusterOverride.masterDiskSize)\n-                        .orElse(config.firecloud.notebookRuntimeDefaultDiskSizeGb))\n-                .masterMachineType(\n-                    Optional.ofNullable(clusterOverride.machineType)\n-                        .orElse(config.firecloud.notebookRuntimeDefaultMachineType)))\n-        .toolDockerImage(workbenchConfigProvider.get().firecloud.jupyterDockerImage)\n-        .welderDockerImage(workbenchConfigProvider.get().firecloud.welderDockerImage)\n-        .customEnvironmentVariables(customEnvironmentVariables);\n+    Map<String, String> runtimeLabels = new HashMap<>();\n+    runtimeLabels.put(RUNTIME_LABEL_AOU, \"true\");\n+    runtimeLabels.put(RUNTIME_LABEL_CREATED_BY, userEmail);\n+\n+    if (runtime.getConfigurationType() != null) {\n+      runtimeLabels.put(\n+          RUNTIME_LABEL_AOU_CONFIG,\n+          RUNTIME_CONFIGURATION_TYPE_ENUM_TO_STORAGE_MAP.get(runtime.getConfigurationType()));\n+    }\n+\n+    LeonardoCreateRuntimeRequest request =\n+        new LeonardoCreateRuntimeRequest()\n+            .labels(runtimeLabels)\n+            .defaultClientId(config.server.oauthClientId)\n+            // Note: Filenames must be kept in sync with files in api/src/main/webapp/static.\n+            .jupyterUserScriptUri(assetsBaseUrl + \"/initialize_notebook_runtime.sh\")\n+            .jupyterStartUserScriptUri(assetsBaseUrl + \"/start_notebook_runtime.sh\")\n+            .userJupyterExtensionConfig(\n+                new LeonardoUserJupyterExtensionConfig().nbExtensions(nbExtensions))\n+            // Matches Terra UI's scopes, see RW-3531 for rationale.\n+            .addScopesItem(\"https://www.googleapis.com/auth/cloud-platform\")\n+            .addScopesItem(\"https://www.googleapis.com/auth/userinfo.email\")\n+            .addScopesItem(\"https://www.googleapis.com/auth/userinfo.profile\")\n+            .toolDockerImage(workbenchConfigProvider.get().firecloud.jupyterDockerImage)\n+            .welderDockerImage(workbenchConfigProvider.get().firecloud.welderDockerImage)\n+            .customEnvironmentVariables(customEnvironmentVariables);\n+\n+    if (workbenchConfigProvider.get().featureFlags.enableCustomRuntimes) {", "originalCommit": "34d03341f61b0b24b6edc33fc2c637818cfc223e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE0MDQwMw==", "url": "https://github.com/all-of-us/workbench/pull/4012#discussion_r491140403", "bodyText": "oh actually, that would fix the ApiException issue too. I'll do that.", "author": "ericsong", "createdAt": "2020-09-18T19:09:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTEzMTczNg=="}], "type": "inlineReview", "revised_code": {"commit": "4b3a74cf3933d4f8cad371da32132f11c064b265", "chunk": "diff --git a/api/src/main/java/org/pmiops/workbench/notebooks/LeonardoNotebooksClientImpl.java b/api/src/main/java/org/pmiops/workbench/notebooks/LeonardoNotebooksClientImpl.java\nindex 57c69c8d0..e349c7f59 100644\n--- a/api/src/main/java/org/pmiops/workbench/notebooks/LeonardoNotebooksClientImpl.java\n+++ b/api/src/main/java/org/pmiops/workbench/notebooks/LeonardoNotebooksClientImpl.java\n\n@@ -140,16 +140,6 @@ public class LeonardoNotebooksClientImpl implements LeonardoNotebooksClient {\n             .customEnvironmentVariables(customEnvironmentVariables);\n \n     if (workbenchConfigProvider.get().featureFlags.enableCustomRuntimes) {\n-      if (runtime.getGceConfig() == null && runtime.getDataprocConfig() == null) {\n-        // There's probably a code smell here where I'm throwing an exception that we're only\n-        // expecting to handle as a response from Leo but this was the quickest path forward for now.\n-        throw new ApiException(400, \"Either a GceConfig or DataprocConfig must be provided\");\n-      }\n-\n-      if (runtime.getGceConfig() != null && runtime.getDataprocConfig() != null) {\n-        throw new ApiException(400, \"Only one of GceConfig or DataprocConfig must be provided\");\n-      }\n-\n       if (runtime.getGceConfig() != null) {\n         request.setRuntimeConfig(leonardoMapper.toLeonardoGceConfig(runtime.getGceConfig()));\n       } else {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTEzMzA0NA==", "url": "https://github.com/all-of-us/workbench/pull/4012#discussion_r491133044", "bodyText": "Would @aftermapping + ignore be cleaner here?", "author": "calbach", "createdAt": "2020-09-18T18:52:43Z", "path": "api/src/main/java/org/pmiops/workbench/utils/mappers/LeonardoMapper.java", "diffHunk": "@@ -25,8 +25,23 @@\n \n   DataprocConfig toDataprocConfig(LeonardoMachineConfig leonardoMachineConfig);\n \n+  @Mapping(\n+      target = \"cloudService\",\n+      // I wanted to use constant/defaultValue here but MapStruct will only accept a static string,\n+      // not an Enum value. This is a problem because we have 3 definitions of `CloudServiceEnum`\n+      // and MapStruct doesn't know that this mapper should use the one from LeonardoMachineConfig\n+      // while the mapper for LeonardoGceConfig should use its own `CloudServiceEnum` class.\n+      // This `expression` field feels kind of hacky since I'm expressing code as a string but", "originalCommit": "34d03341f61b0b24b6edc33fc2c637818cfc223e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTEzNTk2NQ==", "url": "https://github.com/all-of-us/workbench/pull/4012#discussion_r491135965", "bodyText": "Hmm, I went with this because its more concise but I can switch over since it would allow for code inspection.", "author": "ericsong", "createdAt": "2020-09-18T18:59:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTEzMzA0NA=="}], "type": "inlineReview", "revised_code": {"commit": "4b3a74cf3933d4f8cad371da32132f11c064b265", "chunk": "diff --git a/api/src/main/java/org/pmiops/workbench/utils/mappers/LeonardoMapper.java b/api/src/main/java/org/pmiops/workbench/utils/mappers/LeonardoMapper.java\nindex 0e60abd24..b94571a5b 100644\n--- a/api/src/main/java/org/pmiops/workbench/utils/mappers/LeonardoMapper.java\n+++ b/api/src/main/java/org/pmiops/workbench/utils/mappers/LeonardoMapper.java\n\n@@ -25,23 +25,25 @@ public interface LeonardoMapper {\n \n   DataprocConfig toDataprocConfig(LeonardoMachineConfig leonardoMachineConfig);\n \n-  @Mapping(\n-      target = \"cloudService\",\n-      // I wanted to use constant/defaultValue here but MapStruct will only accept a static string,\n-      // not an Enum value. This is a problem because we have 3 definitions of `CloudServiceEnum`\n-      // and MapStruct doesn't know that this mapper should use the one from LeonardoMachineConfig\n-      // while the mapper for LeonardoGceConfig should use its own `CloudServiceEnum` class.\n-      // This `expression` field feels kind of hacky since I'm expressing code as a string but\n-      // it works since it lets me specify the more fully qualified class name.\n-      expression = \"java(LeonardoMachineConfig.CloudServiceEnum.DATAPROC)\")\n+  @Mapping(target = \"cloudService\", ignore = true)\n   @Mapping(target = \"properties\", ignore = true)\n   LeonardoMachineConfig toLeonardoMachineConfig(DataprocConfig dataprocConfig);\n \n+  @AfterMapping\n+  default void addCloudServiceEnum(@MappingTarget LeonardoMachineConfig leonardoMachineConfig) {\n+    leonardoMachineConfig.setCloudService(LeonardoMachineConfig.CloudServiceEnum.DATAPROC);\n+  }\n+\n   GceConfig toGceConfig(LeonardoGceConfig leonardoGceConfig);\n \n-  @Mapping(target = \"cloudService\", expression = \"java(LeonardoGceConfig.CloudServiceEnum.GCE)\")\n+  @Mapping(target = \"cloudService\", ignore = true)\n   LeonardoGceConfig toLeonardoGceConfig(GceConfig gceConfig);\n \n+  @AfterMapping\n+  default void addCloudServiceEnum(@MappingTarget LeonardoGceConfig leonardoGceConfig) {\n+    leonardoGceConfig.setCloudService(LeonardoGceConfig.CloudServiceEnum.GCE);\n+  }\n+\n   @Mapping(target = \"patchInProgress\", ignore = true)\n   LeonardoListRuntimeResponse toListRuntimeResponse(LeonardoGetRuntimeResponse runtime);\n \n"}}, {"oid": "4b3a74cf3933d4f8cad371da32132f11c064b265", "url": "https://github.com/all-of-us/workbench/commit/4b3a74cf3933d4f8cad371da32132f11c064b265", "message": "move argument checking to controller, use afterMapping over expression", "committedDate": "2020-09-18T19:15:05Z", "type": "commit"}, {"oid": "2343f96c831d2e79ff2411325009468f04cd6a44", "url": "https://github.com/all-of-us/workbench/commit/2343f96c831d2e79ff2411325009468f04cd6a44", "message": "fix tets import", "committedDate": "2020-09-18T19:18:36Z", "type": "commit"}]}