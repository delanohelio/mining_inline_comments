{"pr_number": 3493, "pr_title": "[RW-4839][RISK=NO] Change logic to 'excludeFromPublicDirectory' flag", "pr_createdAt": "2020-04-28T05:55:59Z", "pr_url": "https://github.com/all-of-us/workbench/pull/3493", "timeline": [{"oid": "c57c5eb587423a6d7aac5722198c92e25f811863", "url": "https://github.com/all-of-us/workbench/commit/c57c5eb587423a6d7aac5722198c92e25f811863", "message": "Set exclude flag forworkspace if creator is an operational user", "committedDate": "2020-04-28T05:50:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjM0NzM1NA==", "url": "https://github.com/all-of-us/workbench/pull/3493#discussion_r416347354", "bodyText": "Not related to this Story but i noticed this information was not being send as part of exportResearcher hence updated it as well", "author": "NehaBroad", "createdAt": "2020-04-28T05:57:08Z", "path": "api/src/main/java/org/pmiops/workbench/rdr/RdrExportServiceImpl.java", "diffHunk": "@@ -258,10 +258,11 @@ private RdrResearcher toRdrResearcher(DbUser dbUser) {\n                       ? verifiedInstitutionalAffiliation.getInstitutionalRoleOtherText()\n                       : roleEnum.toString();\n \n-              new ResearcherVerifiedInstitutionalAffiliation()\n-                  .institutionShortName(\n-                      verifiedInstitutionalAffiliation.getInstitution().getShortName())\n-                  .institutionalRole(role);\n+              researcher.setVerifiedInstitutionalAffiliation(", "originalCommit": "c57c5eb587423a6d7aac5722198c92e25f811863", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjUwMzg0Ng==", "url": "https://github.com/all-of-us/workbench/pull/3493#discussion_r416503846", "bodyText": "good catch, that seems important :)", "author": "gjuggler", "createdAt": "2020-04-28T10:26:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjM0NzM1NA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjUxMjA2MQ==", "url": "https://github.com/all-of-us/workbench/pull/3493#discussion_r416512061", "bodyText": "Please make this a file-level constant. Or, better yet, most of this method might be better placed within the institution service, e.g. institutionService.isOperationalUser(dbUser user). That would centralize the logic within the institution package, and I don't think it would require adding any new deps to the institution service.\nSlightly tangential thought: I'm concerned that we're at risk of putting load-bearing system weight on the shortName identifier, which can be changed by operational end-users via the Institution UI at any time. This is a pretty serious red flag, and we should think about ways to make sure far-flung business logic can't be impacted by someone deciding in an admin UI that \"AouOps\" should be capitalized differently, or have a space added, etc. etc.\nI filed https://precisionmedicineinitiative.atlassian.net/browse/RW-4844 to track \u2013\u00a0I'd suggest following up with Joel & Karthik to align on a solution for this.", "author": "gjuggler", "createdAt": "2020-04-28T10:41:17Z", "path": "api/src/main/java/org/pmiops/workbench/rdr/RdrExportServiceImpl.java", "diffHunk": "@@ -435,4 +436,25 @@ public void updateDbRdrExport(RdrEntity entity, List<Long> idList) {\n             .collect(Collectors.toList());\n     rdrExportDao.save(exportList);\n   }\n+\n+  /**\n+   * Set excludeFromPublicDirectory to true if the workspace creator is an operational user i.e has\n+   * Institution as All of Us Program operational Use\n+   *\n+   * @param creatorUser\n+   * @param rdrWorkspace\n+   */\n+  void setExcludeFromPublicDirectory(DbUser creatorUser, RdrWorkspace rdrWorkspace) {\n+    rdrWorkspace.setExcludeFromPublicDirectory(false);\n+    verifiedInstitutionalAffiliationDao\n+        .findFirstByUser(creatorUser)\n+        .ifPresent(\n+            verifiedInstitutionalAffiliation -> {\n+              rdrWorkspace.setExcludeFromPublicDirectory(\n+                  verifiedInstitutionalAffiliation\n+                      .getInstitution()\n+                      .getShortName()\n+                      .equals(\"AouOps\"));", "originalCommit": "c57c5eb587423a6d7aac5722198c92e25f811863", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "70c4010ca2cf0f8ad196b173318af950fb026eeb", "chunk": "diff --git a/api/src/main/java/org/pmiops/workbench/rdr/RdrExportServiceImpl.java b/api/src/main/java/org/pmiops/workbench/rdr/RdrExportServiceImpl.java\nindex 1b7b658ca..7793748d3 100644\n--- a/api/src/main/java/org/pmiops/workbench/rdr/RdrExportServiceImpl.java\n+++ b/api/src/main/java/org/pmiops/workbench/rdr/RdrExportServiceImpl.java\n\n@@ -451,10 +456,8 @@ public class RdrExportServiceImpl implements RdrExportService {\n         .ifPresent(\n             verifiedInstitutionalAffiliation -> {\n               rdrWorkspace.setExcludeFromPublicDirectory(\n-                  verifiedInstitutionalAffiliation\n-                      .getInstitution()\n-                      .getShortName()\n-                      .equals(\"AouOps\"));\n+                  institutionService.validateOperationalUser(\n+                      verifiedInstitutionalAffiliation.getInstitution()));\n             });\n   }\n }\n"}}, {"oid": "70c4010ca2cf0f8ad196b173318af950fb026eeb", "url": "https://github.com/all-of-us/workbench/commit/70c4010ca2cf0f8ad196b173318af950fb026eeb", "message": "PR Comments: Extract logic for Validating opoeration user in institution service", "committedDate": "2020-04-29T00:50:21Z", "type": "commit"}]}