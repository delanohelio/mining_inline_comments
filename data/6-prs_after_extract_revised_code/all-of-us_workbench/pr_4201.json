{"pr_number": 4201, "pr_title": "[risk=low] Update codegen for image changes and quality of life", "pr_createdAt": "2020-10-23T01:33:29Z", "pr_url": "https://github.com/all-of-us/workbench/pull/4201", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA1NTIwNQ==", "url": "https://github.com/all-of-us/workbench/pull/4201#discussion_r511055205", "bodyText": "i think we need a trailing slash here?", "author": "ericsong", "createdAt": "2020-10-23T18:09:40Z", "path": "api/src/main/java/org/pmiops/workbench/dataset/DataSetServiceImpl.java", "diffHunk": "@@ -847,7 +851,7 @@ private String getQualifiedColumnName(Domain currentDomain, String columnName) {\n             + \"\\n\"\n             + \"hl.plot.output_notebook()\\n\"\n             + \"bucket = os.environ['WORKSPACE_BUCKET']\\n\"\n-            + \"hl.import_vcf(f'{bucket}/\"\n+            + \"hl.import_vcf(f'{bucket}/cohort-extract\"", "originalCommit": "ee77bfd71b3d67ec08d887c5aa06e0c192df6a37", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE3MzU2OA==", "url": "https://github.com/all-of-us/workbench/pull/4201#discussion_r511173568", "bodyText": "Oops thanks, didn't get around to retesting the Hail flow after making this change. Done", "author": "calbach", "createdAt": "2020-10-23T21:58:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA1NTIwNQ=="}], "type": "inlineReview", "revised_code": {"commit": "07b5331b5b16db8854c3ad78cc7ac79331daa63b", "chunk": "diff --git a/api/src/main/java/org/pmiops/workbench/dataset/DataSetServiceImpl.java b/api/src/main/java/org/pmiops/workbench/dataset/DataSetServiceImpl.java\nindex df81f8f66..20dfebf11 100644\n--- a/api/src/main/java/org/pmiops/workbench/dataset/DataSetServiceImpl.java\n+++ b/api/src/main/java/org/pmiops/workbench/dataset/DataSetServiceImpl.java\n\n@@ -851,7 +851,7 @@ public class DataSetServiceImpl implements DataSetService, GaugeDataCollector {\n             + \"\\n\"\n             + \"hl.plot.output_notebook()\\n\"\n             + \"bucket = os.environ['WORKSPACE_BUCKET']\\n\"\n-            + \"hl.import_vcf(f'{bucket}/cohort-extract\"\n+            + \"hl.import_vcf(f'{bucket}/cohort-extract/\"\n             + cohortVcfFilename\n             + \"').write(f'{bucket}/\"\n             + cohortMatrixFilename\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA1NTkxOA==", "url": "https://github.com/all-of-us/workbench/pull/4201#discussion_r511055918", "bodyText": "we could switch this to synthetic_microarray_data which has the 100k samples", "author": "ericsong", "createdAt": "2020-10-23T18:11:01Z", "path": "api/src/main/java/org/pmiops/workbench/dataset/DataSetServiceImpl.java", "diffHunk": "@@ -740,41 +749,36 @@ private String getQualifiedColumnName(Domain currentDomain, String columnName) {\n             + \"    for person_id in person_ids:\\n\"\n             + \"        cohort_file.write(str(person_id) + '\\\\n')\\n\"\n             + \"    cohort_file.close()\\n\",\n-        \"%%bash\\n\\n\"\n-            + \"uuid=$(cat /proc/sys/kernel/random/uuid | sed s/-/_/g)\\n\"\n-            // TODO: Writing to the \"tmp\" dataset is a temporary workaround until an alternative,\n-            // RW-5735\n-            + \"EXPORT_TABLE=\\\"fc-aou-cdr-synth-test.tmp_shared_cohort_extract.${uuid}\\\"\\n\"\n-            + \"\\n\"\n-            + \"python3 /genomics/microarray/raw_array_cohort_extract.py \\\\\\n\"\n+        \"!python3 /usr/local/share/raw_array_cohort_extract.py \\\\\\n\"\n             + \"          --dataset fc-aou-cdr-synth-test.microarray_data \\\\\\n\"\n-            + \"          --fq_destination_table ${EXPORT_TABLE} \\\\\\n\"\n+            + \"          --fq_destination_table \"\n+            + cohortExtractTable\n+            + \" \\\\\\n\"\n             + \"          --query_project ${GOOGLE_PROJECT} \\\\\\n\"\n             // TODO: Replace hardcoded dataset reference: RW-5748\n-            + \"          --sample_mapping_table fc-aou-cdr-synth-test.microarray_data.sample_list \\\\\\n\"\n+            + \"          --fq_sample_mapping_table fc-aou-cdr-synth-test.microarray_data.sample_list \\\\\\n\"", "originalCommit": "ee77bfd71b3d67ec08d887c5aa06e0c192df6a37", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE3MzQwNQ==", "url": "https://github.com/all-of-us/workbench/pull/4201#discussion_r511173405", "bodyText": "done", "author": "calbach", "createdAt": "2020-10-23T21:58:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA1NTkxOA=="}], "type": "inlineReview", "revised_code": {"commit": "07b5331b5b16db8854c3ad78cc7ac79331daa63b", "chunk": "diff --git a/api/src/main/java/org/pmiops/workbench/dataset/DataSetServiceImpl.java b/api/src/main/java/org/pmiops/workbench/dataset/DataSetServiceImpl.java\nindex df81f8f66..20dfebf11 100644\n--- a/api/src/main/java/org/pmiops/workbench/dataset/DataSetServiceImpl.java\n+++ b/api/src/main/java/org/pmiops/workbench/dataset/DataSetServiceImpl.java\n\n@@ -750,13 +750,13 @@ public class DataSetServiceImpl implements DataSetService, GaugeDataCollector {\n             + \"        cohort_file.write(str(person_id) + '\\\\n')\\n\"\n             + \"    cohort_file.close()\\n\",\n         \"!python3 /usr/local/share/raw_array_cohort_extract.py \\\\\\n\"\n-            + \"          --dataset fc-aou-cdr-synth-test.microarray_data \\\\\\n\"\n+            + \"          --dataset fc-aou-cdr-synth-test.synthetic_microarray_data \\\\\\n\"\n             + \"          --fq_destination_table \"\n             + cohortExtractTable\n             + \" \\\\\\n\"\n             + \"          --query_project ${GOOGLE_PROJECT} \\\\\\n\"\n             // TODO: Replace hardcoded dataset reference: RW-5748\n-            + \"          --fq_sample_mapping_table fc-aou-cdr-synth-test.microarray_data.sample_list \\\\\\n\"\n+            + \"          --fq_sample_mapping_table fc-aou-cdr-synth-test.synthetic_microarray_data.sample_list \\\\\\n\"\n             + \"          --cohort_sample_names_file \"\n             + cohortSampleNamesFilename\n             + \" \\\\\\n\"\n"}}, {"oid": "07b5331b5b16db8854c3ad78cc7ac79331daa63b", "url": "https://github.com/all-of-us/workbench/commit/07b5331b5b16db8854c3ad78cc7ac79331daa63b", "message": "PR feedback, test fixes", "committedDate": "2020-10-23T22:07:02Z", "type": "forcePushed"}, {"oid": "31e3bd1db5d078c70a618ecaa3e2c50396d26a46", "url": "https://github.com/all-of-us/workbench/commit/31e3bd1db5d078c70a618ecaa3e2c50396d26a46", "message": "Image updates / QOL", "committedDate": "2020-10-23T22:08:35Z", "type": "commit"}, {"oid": "8b8fe9c5c408c5c2aa43226b54d444db2609ab66", "url": "https://github.com/all-of-us/workbench/commit/8b8fe9c5c408c5c2aa43226b54d444db2609ab66", "message": "PR feedback, test fixes", "committedDate": "2020-10-23T22:08:35Z", "type": "commit"}, {"oid": "8b8fe9c5c408c5c2aa43226b54d444db2609ab66", "url": "https://github.com/all-of-us/workbench/commit/8b8fe9c5c408c5c2aa43226b54d444db2609ab66", "message": "PR feedback, test fixes", "committedDate": "2020-10-23T22:08:35Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjE4NDY0NA==", "url": "https://github.com/all-of-us/workbench/pull/4201#discussion_r512184644", "bodyText": "presumably we will eventually make this a per env parameter?", "author": "als364", "createdAt": "2020-10-26T18:36:33Z", "path": "api/src/main/java/org/pmiops/workbench/dataset/DataSetServiceImpl.java", "diffHunk": "@@ -721,6 +726,10 @@ private String getQualifiedColumnName(Domain currentDomain, String columnName) {\n     final String cohortSampleNamesFilename = \"cohort_sample_names_\" + qualifier + \".txt\";\n     final String cohortSampleMapFilename = \"cohort_sample_map_\" + qualifier + \".csv\";\n     final String cohortVcfFilename = \"cohort_\" + qualifier + \".vcf\";\n+    // TODO(RW-5735): Writing to the \"tmp\" dataset is a temporary workaround.\n+    final String cohortExtractTable =\n+        \"fc-aou-cdr-synth-test.tmp_shared_cohort_extract.\"", "originalCommit": "8b8fe9c5c408c5c2aa43226b54d444db2609ab66", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjIzNTgwMA==", "url": "https://github.com/all-of-us/workbench/pull/4201#discussion_r512235800", "bodyText": "Per above comment, this line in particular is temporary. There's another ticket linked in the other TODO's here to plumb through env vars for read access to the CDR dataset as well.", "author": "calbach", "createdAt": "2020-10-26T20:06:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjE4NDY0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjIzNjMwMA==", "url": "https://github.com/all-of-us/workbench/pull/4201#discussion_r512236300", "bodyText": "gotcha, thank you", "author": "als364", "createdAt": "2020-10-26T20:07:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjE4NDY0NA=="}], "type": "inlineReview", "revised_code": null}]}