{"pr_number": 3698, "pr_title": "[risk=no] 404 instead of 500 for user not found", "pr_createdAt": "2020-06-22T18:22:08Z", "pr_url": "https://github.com/all-of-us/workbench/pull/3698", "timeline": [{"oid": "9283a709584681b93c8947ce5051bd84c3fd54ed", "url": "https://github.com/all-of-us/workbench/commit/9283a709584681b93c8947ce5051bd84c3fd54ed", "message": "Check for user not found", "committedDate": "2020-06-22T18:15:35Z", "type": "commit"}, {"oid": "064574f930f3f01acb4cac6f7833fd0f9a8430ed", "url": "https://github.com/all-of-us/workbench/commit/064574f930f3f01acb4cac6f7833fd0f9a8430ed", "message": "rv not necessary update", "committedDate": "2020-06-22T18:23:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzc2NzgwMg==", "url": "https://github.com/all-of-us/workbench/pull/3698#discussion_r443767802", "bodyText": "nit: Since you do this three times, I'd make a little helper method like getDbUser() so these methods are shorter.", "author": "jaycarlton", "createdAt": "2020-06-22T19:06:57Z", "path": "api/src/main/java/org/pmiops/workbench/api/ProfileController.java", "diffHunk": "@@ -598,7 +598,10 @@ private void checkUserCreationNonce(DbUser user, String nonce) {\n       UpdateContactEmailRequest updateContactEmailRequest) {\n     String username = updateContactEmailRequest.getUsername().toLowerCase();\n     com.google.api.services.directory.model.User googleUser = directoryService.getUser(username);\n-    DbUser user = userDao.findUserByUsername(username);\n+    DbUser user =", "originalCommit": "064574f930f3f01acb4cac6f7833fd0f9a8430ed", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "7a72eedbc8d3c82c97e84034bc8dddd01f127446", "chunk": "diff --git a/api/src/main/java/org/pmiops/workbench/api/ProfileController.java b/api/src/main/java/org/pmiops/workbench/api/ProfileController.java\nindex 6682f2f82..c5c8a9876 100644\n--- a/api/src/main/java/org/pmiops/workbench/api/ProfileController.java\n+++ b/api/src/main/java/org/pmiops/workbench/api/ProfileController.java\n\n@@ -598,10 +598,7 @@ public class ProfileController implements ProfileApiDelegate {\n       UpdateContactEmailRequest updateContactEmailRequest) {\n     String username = updateContactEmailRequest.getUsername().toLowerCase();\n     com.google.api.services.directory.model.User googleUser = directoryService.getUser(username);\n-    DbUser user =\n-        userService\n-            .getByUsername(username)\n-            .orElseThrow(() -> new NotFoundException(\"User '\" + username + \"' not found\"));\n+    DbUser user = userService.getByUsernameOrThrow(username);\n     checkUserCreationNonce(user, updateContactEmailRequest.getCreationNonce());\n     if (userHasEverLoggedIn(googleUser, user)) {\n       return ResponseEntity.status(HttpStatus.FORBIDDEN).build();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzc2ODkxNw==", "url": "https://github.com/all-of-us/workbench/pull/3698#discussion_r443768917", "bodyText": "super-nit, but we could centralize the not found error message function and exception function somewhere, like on the suer service, so it'd be .orElseThrow(() -> userNotFoundEx(username)) and all the messages would match.\nMaybe a job for an Exceptions utility class.", "author": "jaycarlton", "createdAt": "2020-06-22T19:09:19Z", "path": "api/src/main/java/org/pmiops/workbench/api/ProfileController.java", "diffHunk": "@@ -598,7 +598,10 @@ private void checkUserCreationNonce(DbUser user, String nonce) {\n       UpdateContactEmailRequest updateContactEmailRequest) {\n     String username = updateContactEmailRequest.getUsername().toLowerCase();\n     com.google.api.services.directory.model.User googleUser = directoryService.getUser(username);\n-    DbUser user = userDao.findUserByUsername(username);\n+    DbUser user =\n+        userService\n+            .getByUsername(username)\n+            .orElseThrow(() -> new NotFoundException(\"User '\" + username + \"' not found\"));", "originalCommit": "064574f930f3f01acb4cac6f7833fd0f9a8430ed", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "7a72eedbc8d3c82c97e84034bc8dddd01f127446", "chunk": "diff --git a/api/src/main/java/org/pmiops/workbench/api/ProfileController.java b/api/src/main/java/org/pmiops/workbench/api/ProfileController.java\nindex 6682f2f82..c5c8a9876 100644\n--- a/api/src/main/java/org/pmiops/workbench/api/ProfileController.java\n+++ b/api/src/main/java/org/pmiops/workbench/api/ProfileController.java\n\n@@ -598,10 +598,7 @@ public class ProfileController implements ProfileApiDelegate {\n       UpdateContactEmailRequest updateContactEmailRequest) {\n     String username = updateContactEmailRequest.getUsername().toLowerCase();\n     com.google.api.services.directory.model.User googleUser = directoryService.getUser(username);\n-    DbUser user =\n-        userService\n-            .getByUsername(username)\n-            .orElseThrow(() -> new NotFoundException(\"User '\" + username + \"' not found\"));\n+    DbUser user = userService.getByUsernameOrThrow(username);\n     checkUserCreationNonce(user, updateContactEmailRequest.getCreationNonce());\n     if (userHasEverLoggedIn(googleUser, user)) {\n       return ResponseEntity.status(HttpStatus.FORBIDDEN).build();\n"}}, {"oid": "7a72eedbc8d3c82c97e84034bc8dddd01f127446", "url": "https://github.com/all-of-us/workbench/commit/7a72eedbc8d3c82c97e84034bc8dddd01f127446", "message": "userService.getByUsernameOrThrow()", "committedDate": "2020-06-22T19:25:52Z", "type": "commit"}]}