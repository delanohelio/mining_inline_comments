{"pr_number": 3309, "pr_title": "[RW-4555][RISK= Moderate]  Enable Account Creation Captcha for Prod", "pr_createdAt": "2020-03-27T14:36:07Z", "pr_url": "https://github.com/all-of-us/workbench/pull/3309", "timeline": [{"oid": "fd85f5755b299cfa8ac1f092dc9752ca87ba4d44", "url": "https://github.com/all-of-us/workbench/commit/fd85f5755b299cfa8ac1f092dc9752ca87ba4d44", "message": "Enable Captcha and use google test keys for all env except stable and prod", "committedDate": "2020-03-27T14:31:50Z", "type": "commit"}, {"oid": "d412b96a3c2abfec1a5677c7046d1a5d4dadd327", "url": "https://github.com/all-of-us/workbench/commit/d412b96a3c2abfec1a5677c7046d1a5d4dadd327", "message": "spotless", "committedDate": "2020-03-27T14:52:37Z", "type": "commit"}, {"oid": "de693d21e800cf55b84296097d5f86930639f11c", "url": "https://github.com/all-of-us/workbench/commit/de693d21e800cf55b84296097d5f86930639f11c", "message": "enable Captcha Ui", "committedDate": "2020-03-27T15:39:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQxMTAyMQ==", "url": "https://github.com/all-of-us/workbench/pull/3309#discussion_r399411021", "bodyText": "I would rather drive this from a config value per environment, unless there's something I'm missing. This list approach seems brittle to me.", "author": "calbach", "createdAt": "2020-03-27T17:01:30Z", "path": "api/src/main/java/org/pmiops/workbench/captcha/CaptchaVerificationServiceImpl.java", "diffHunk": "@@ -17,7 +21,21 @@\n \n   final String urlPattern = \"https://%s/login\";\n \n-  final String localHostUrlPattern = \"http://%s:4200/login\";\n+  final List<String> nonTestCaptchaURLs =", "originalCommit": "de693d21e800cf55b84296097d5f86930639f11c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ0Mjg5Mw==", "url": "https://github.com/all-of-us/workbench/pull/3309#discussion_r399442893", "bodyText": "I was not sure if just checking google test key should be enough for test/staging/perf and local. Normally for captcha verification we would check site key + host matches the url (the way we are doing it for prod and staable). But again since i am checking url against the config entry i can just create a new entry to test if the environment is using testCaptcha", "author": "NehaBroad", "createdAt": "2020-03-27T17:54:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQxMTAyMQ=="}], "type": "inlineReview", "revised_code": {"commit": "42256d657c28a1bd3f9f3710059ffad211804001", "chunk": "diff --git a/api/src/main/java/org/pmiops/workbench/captcha/CaptchaVerificationServiceImpl.java b/api/src/main/java/org/pmiops/workbench/captcha/CaptchaVerificationServiceImpl.java\nindex d0175f4e5..07dadc8e9 100644\n--- a/api/src/main/java/org/pmiops/workbench/captcha/CaptchaVerificationServiceImpl.java\n+++ b/api/src/main/java/org/pmiops/workbench/captcha/CaptchaVerificationServiceImpl.java\n\n@@ -21,20 +21,6 @@ public class CaptchaVerificationServiceImpl implements CaptchaVerificationServic\n \n   final String urlPattern = \"https://%s/login\";\n \n-  final List<String> nonTestCaptchaURLs =\n-      new ArrayList<String>(\n-          Arrays.asList(\n-              \"https://workbench.researchallofus.org/login\",\n-              \"https://all-of-us-rw-stable.appspot.com/login\"));\n-\n-  final List<String> testCaptchaURLs =\n-      new ArrayList<String>(\n-          Arrays.asList(\n-              \"http://localhost:4200/login\",\n-              \"https://all-of-us-workbench-test.appspot.com\",\n-              \"https://all-of-us-rw-staging.appspot.com/login\",\n-              \"https://all-of-us-rw-perf.appspot.com/login\"));\n-\n   final String googleTestHost = \"testkey.google.com\";\n \n   private CloudStorageService cloudStorageService;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQxNDAwNg==", "url": "https://github.com/all-of-us/workbench/pull/3309#discussion_r399414006", "bodyText": "I would just add throws Exception to the unit test method definition throughout and remove these catches, I don't think the approach here offers any benefit over that", "author": "calbach", "createdAt": "2020-03-27T17:06:14Z", "path": "api/src/test/java/org/pmiops/workbench/captcha/CaptchaVerificationServiceTest.java", "diffHunk": "@@ -0,0 +1,104 @@\n+package org.pmiops.workbench.captcha;\n+\n+import static com.google.common.truth.Truth.assertThat;\n+\n+import java.io.IOException;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.mockito.Mockito;\n+import org.pmiops.workbench.api.BaseControllerTest;\n+import org.pmiops.workbench.captcha.api.CaptchaApi;\n+import org.pmiops.workbench.captcha.model.CaptchaVerificationResponse;\n+import org.pmiops.workbench.config.WorkbenchConfig;\n+import org.pmiops.workbench.google.CloudStorageService;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.boot.test.context.TestConfiguration;\n+import org.springframework.boot.test.mock.mockito.MockBean;\n+import org.springframework.context.annotation.Import;\n+\n+public class CaptchaVerificationServiceTest extends BaseControllerTest {\n+\n+  final String prodAllOfUsUrl = \"https://workbench.researchallofus.org/login\";\n+  final String testAllOfUsUrl = \"https://all-of-us-workbench-test.appspot.com\";\n+  final String responseToken = \"responseToken\";\n+\n+  @MockBean private CloudStorageService cloudStorageService;\n+  @MockBean private WorkbenchConfig configProvider;\n+  @MockBean private CaptchaApi captchaApiProvider;\n+\n+  @MockBean private WorkbenchConfig.AdminConfig adminConfig;\n+  @Autowired private CaptchaVerificationServiceImpl captchaVerificationService;\n+\n+  @TestConfiguration\n+  @Import({CaptchaVerificationServiceImpl.class, CaptchaApi.class})\n+  static class Configuration {}\n+\n+  @Before\n+  @Override\n+  public void setUp() throws IOException {\n+    super.setUp();\n+    Mockito.when(cloudStorageService.getCaptchaServerKey()).thenReturn(\"key\");\n+    mockCaptchaResponse(\"hostName\", true);\n+  }\n+\n+  private void mockCaptchaResponse(String hostName, boolean success) {\n+    CaptchaVerificationResponse response = new CaptchaVerificationResponse();\n+    response.setHostname(hostName);\n+    response.setSuccess(true);\n+    try {\n+      Mockito.when(captchaApiProvider.verify(\"key\", responseToken)).thenReturn(response);\n+    } catch (ApiException ex) {\n+\n+    }\n+  }\n+\n+  @Test\n+  public void testCreateAccount_invalidHostName() {\n+    try {\n+      // This should return false since the host name can either be google test hostname or one of\n+      // AllOfUs urls\n+      captchaVerificationService.mockLoginUrl(\"hostname\");\n+      boolean captchaSuccess = captchaVerificationService.verifyCaptcha(responseToken);\n+      assertThat(captchaSuccess).isFalse();\n+    } catch (ApiException e) {\n+      e.printStackTrace();\n+      assertThat(false);\n+    }\n+  }\n+\n+  /**\n+   * For any of the AllOfUs urls not using captcha test keys, the hostName should match exactly with\n+   * that send by google Captcha server\n+   */\n+  @Test\n+  public void testCreateAccount_nonCaptchaTestHosts() {\n+    try {\n+      mockCaptchaResponse(\"workbench.researchallofus.org\", true);\n+      captchaVerificationService.mockLoginUrl(prodAllOfUsUrl);\n+      boolean captchaSuccess = captchaVerificationService.verifyCaptcha(responseToken);\n+      assertThat(captchaSuccess).isTrue();\n+    } catch (ApiException e) {\n+      e.printStackTrace();\n+      assertThat(false);\n+    }\n+  }\n+\n+  @Test\n+  public void testCreateAccount_googleTestKey() {\n+    try {\n+      // AllOfUs prod url should not be using google test captcha keys\n+      mockCaptchaResponse(\"testkey.google.com\", true);\n+      captchaVerificationService.mockLoginUrl(prodAllOfUsUrl);\n+      boolean captchaSuccess = captchaVerificationService.verifyCaptcha(responseToken);\n+      assertThat(captchaSuccess).isFalse();\n+\n+      // AllOfUs test url should be using google test captcha keys\n+      captchaVerificationService.mockLoginUrl(testAllOfUsUrl);\n+      captchaSuccess = captchaVerificationService.verifyCaptcha(responseToken);\n+      assertThat(captchaSuccess).isTrue();\n+    } catch (ApiException e) {", "originalCommit": "de693d21e800cf55b84296097d5f86930639f11c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "42256d657c28a1bd3f9f3710059ffad211804001", "chunk": "diff --git a/api/src/test/java/org/pmiops/workbench/captcha/CaptchaVerificationServiceTest.java b/api/src/test/java/org/pmiops/workbench/captcha/CaptchaVerificationServiceTest.java\nindex 6fc3622d9..081e1a398 100644\n--- a/api/src/test/java/org/pmiops/workbench/captcha/CaptchaVerificationServiceTest.java\n+++ b/api/src/test/java/org/pmiops/workbench/captcha/CaptchaVerificationServiceTest.java\n\n@@ -39,6 +39,8 @@ public class CaptchaVerificationServiceTest extends BaseControllerTest {\n     super.setUp();\n     Mockito.when(cloudStorageService.getCaptchaServerKey()).thenReturn(\"key\");\n     mockCaptchaResponse(\"hostName\", true);\n+    captchaVerificationService.mockUseTestCaptcha(true);\n+\n   }\n \n   private void mockCaptchaResponse(String hostName, boolean success) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQxNDk0OQ==", "url": "https://github.com/all-of-us/workbench/pull/3309#discussion_r399414949", "bodyText": "again, I'd just add the throws", "author": "calbach", "createdAt": "2020-03-27T17:07:41Z", "path": "api/src/test/java/org/pmiops/workbench/captcha/CaptchaVerificationServiceTest.java", "diffHunk": "@@ -0,0 +1,104 @@\n+package org.pmiops.workbench.captcha;\n+\n+import static com.google.common.truth.Truth.assertThat;\n+\n+import java.io.IOException;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.mockito.Mockito;\n+import org.pmiops.workbench.api.BaseControllerTest;\n+import org.pmiops.workbench.captcha.api.CaptchaApi;\n+import org.pmiops.workbench.captcha.model.CaptchaVerificationResponse;\n+import org.pmiops.workbench.config.WorkbenchConfig;\n+import org.pmiops.workbench.google.CloudStorageService;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.boot.test.context.TestConfiguration;\n+import org.springframework.boot.test.mock.mockito.MockBean;\n+import org.springframework.context.annotation.Import;\n+\n+public class CaptchaVerificationServiceTest extends BaseControllerTest {\n+\n+  final String prodAllOfUsUrl = \"https://workbench.researchallofus.org/login\";\n+  final String testAllOfUsUrl = \"https://all-of-us-workbench-test.appspot.com\";\n+  final String responseToken = \"responseToken\";\n+\n+  @MockBean private CloudStorageService cloudStorageService;\n+  @MockBean private WorkbenchConfig configProvider;\n+  @MockBean private CaptchaApi captchaApiProvider;\n+\n+  @MockBean private WorkbenchConfig.AdminConfig adminConfig;\n+  @Autowired private CaptchaVerificationServiceImpl captchaVerificationService;\n+\n+  @TestConfiguration\n+  @Import({CaptchaVerificationServiceImpl.class, CaptchaApi.class})\n+  static class Configuration {}\n+\n+  @Before\n+  @Override\n+  public void setUp() throws IOException {\n+    super.setUp();\n+    Mockito.when(cloudStorageService.getCaptchaServerKey()).thenReturn(\"key\");\n+    mockCaptchaResponse(\"hostName\", true);\n+  }\n+\n+  private void mockCaptchaResponse(String hostName, boolean success) {\n+    CaptchaVerificationResponse response = new CaptchaVerificationResponse();\n+    response.setHostname(hostName);\n+    response.setSuccess(true);\n+    try {\n+      Mockito.when(captchaApiProvider.verify(\"key\", responseToken)).thenReturn(response);\n+    } catch (ApiException ex) {", "originalCommit": "de693d21e800cf55b84296097d5f86930639f11c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "42256d657c28a1bd3f9f3710059ffad211804001", "chunk": "diff --git a/api/src/test/java/org/pmiops/workbench/captcha/CaptchaVerificationServiceTest.java b/api/src/test/java/org/pmiops/workbench/captcha/CaptchaVerificationServiceTest.java\nindex 6fc3622d9..081e1a398 100644\n--- a/api/src/test/java/org/pmiops/workbench/captcha/CaptchaVerificationServiceTest.java\n+++ b/api/src/test/java/org/pmiops/workbench/captcha/CaptchaVerificationServiceTest.java\n\n@@ -39,6 +39,8 @@ public class CaptchaVerificationServiceTest extends BaseControllerTest {\n     super.setUp();\n     Mockito.when(cloudStorageService.getCaptchaServerKey()).thenReturn(\"key\");\n     mockCaptchaResponse(\"hostName\", true);\n+    captchaVerificationService.mockUseTestCaptcha(true);\n+\n   }\n \n   private void mockCaptchaResponse(String hostName, boolean success) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQxNzExMw==", "url": "https://github.com/all-of-us/workbench/pull/3309#discussion_r399417113", "bodyText": "Could you add some comments that indicate what the behavior is for a \"test captcha\"? Are these just two separate keys,  or does it just allow any captcha input to pass?", "author": "calbach", "createdAt": "2020-03-27T17:11:24Z", "path": "api/src/main/java/org/pmiops/workbench/captcha/CaptchaVerificationServiceImpl.java", "diffHunk": "@@ -17,7 +21,21 @@\n \n   final String urlPattern = \"https://%s/login\";\n \n-  final String localHostUrlPattern = \"http://%s:4200/login\";\n+  final List<String> nonTestCaptchaURLs =\n+      new ArrayList<String>(\n+          Arrays.asList(\n+              \"https://workbench.researchallofus.org/login\",\n+              \"https://all-of-us-rw-stable.appspot.com/login\"));\n+\n+  final List<String> testCaptchaURLs =\n+      new ArrayList<String>(\n+          Arrays.asList(\n+              \"http://localhost:4200/login\",\n+              \"https://all-of-us-workbench-test.appspot.com\",\n+              \"https://all-of-us-rw-staging.appspot.com/login\",\n+              \"https://all-of-us-rw-perf.appspot.com/login\"));\n+\n+  final String googleTestHost = \"testkey.google.com\";", "originalCommit": "de693d21e800cf55b84296097d5f86930639f11c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "42256d657c28a1bd3f9f3710059ffad211804001", "chunk": "diff --git a/api/src/main/java/org/pmiops/workbench/captcha/CaptchaVerificationServiceImpl.java b/api/src/main/java/org/pmiops/workbench/captcha/CaptchaVerificationServiceImpl.java\nindex d0175f4e5..07dadc8e9 100644\n--- a/api/src/main/java/org/pmiops/workbench/captcha/CaptchaVerificationServiceImpl.java\n+++ b/api/src/main/java/org/pmiops/workbench/captcha/CaptchaVerificationServiceImpl.java\n\n@@ -21,20 +21,6 @@ public class CaptchaVerificationServiceImpl implements CaptchaVerificationServic\n \n   final String urlPattern = \"https://%s/login\";\n \n-  final List<String> nonTestCaptchaURLs =\n-      new ArrayList<String>(\n-          Arrays.asList(\n-              \"https://workbench.researchallofus.org/login\",\n-              \"https://all-of-us-rw-stable.appspot.com/login\"));\n-\n-  final List<String> testCaptchaURLs =\n-      new ArrayList<String>(\n-          Arrays.asList(\n-              \"http://localhost:4200/login\",\n-              \"https://all-of-us-workbench-test.appspot.com\",\n-              \"https://all-of-us-rw-staging.appspot.com/login\",\n-              \"https://all-of-us-rw-perf.appspot.com/login\"));\n-\n   final String googleTestHost = \"testkey.google.com\";\n \n   private CloudStorageService cloudStorageService;\n"}}, {"oid": "42256d657c28a1bd3f9f3710059ffad211804001", "url": "https://github.com/all-of-us/workbench/commit/42256d657c28a1bd3f9f3710059ffad211804001", "message": "remove urls and use config properties", "committedDate": "2020-03-27T19:10:07Z", "type": "commit"}, {"oid": "0402790d4bfba16a3ae14fc824e130cad5ee4e3a", "url": "https://github.com/all-of-us/workbench/commit/0402790d4bfba16a3ae14fc824e130cad5ee4e3a", "message": "spotless and test fix", "committedDate": "2020-03-27T19:36:32Z", "type": "commit"}, {"oid": "9f354964cf032cb3a438419974211b40bdeb1e3e", "url": "https://github.com/all-of-us/workbench/commit/9f354964cf032cb3a438419974211b40bdeb1e3e", "message": "add comments", "committedDate": "2020-03-27T19:46:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUzNTI3NA==", "url": "https://github.com/all-of-us/workbench/pull/3309#discussion_r399535274", "bodyText": "This isn't a controller, not sure it should be extending BaseControllerTest", "author": "calbach", "createdAt": "2020-03-27T21:00:15Z", "path": "api/src/test/java/org/pmiops/workbench/captcha/CaptchaVerificationServiceTest.java", "diffHunk": "@@ -0,0 +1,97 @@\n+package org.pmiops.workbench.captcha;\n+\n+import static com.google.common.truth.Truth.assertThat;\n+\n+import java.io.IOException;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.mockito.Mockito;\n+import org.pmiops.workbench.api.BaseControllerTest;\n+import org.pmiops.workbench.captcha.api.CaptchaApi;\n+import org.pmiops.workbench.captcha.model.CaptchaVerificationResponse;\n+import org.pmiops.workbench.config.WorkbenchConfig;\n+import org.pmiops.workbench.google.CloudStorageService;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.boot.test.context.TestConfiguration;\n+import org.springframework.boot.test.mock.mockito.MockBean;\n+import org.springframework.context.annotation.Import;\n+\n+public class CaptchaVerificationServiceTest extends BaseControllerTest {", "originalCommit": "9f354964cf032cb3a438419974211b40bdeb1e3e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1794965c766d5ca0fc01bb8c081b5edf9fb3f3c1", "chunk": "diff --git a/api/src/test/java/org/pmiops/workbench/captcha/CaptchaVerificationServiceTest.java b/api/src/test/java/org/pmiops/workbench/captcha/CaptchaVerificationServiceTest.java\nindex a6a2b7eda..f603a7047 100644\n--- a/api/src/test/java/org/pmiops/workbench/captcha/CaptchaVerificationServiceTest.java\n+++ b/api/src/test/java/org/pmiops/workbench/captcha/CaptchaVerificationServiceTest.java\n\n@@ -5,44 +5,54 @@ import static com.google.common.truth.Truth.assertThat;\n import java.io.IOException;\n import org.junit.Before;\n import org.junit.Test;\n+import org.junit.runner.RunWith;\n import org.mockito.Mockito;\n-import org.pmiops.workbench.api.BaseControllerTest;\n import org.pmiops.workbench.captcha.api.CaptchaApi;\n import org.pmiops.workbench.captcha.model.CaptchaVerificationResponse;\n import org.pmiops.workbench.config.WorkbenchConfig;\n import org.pmiops.workbench.google.CloudStorageService;\n import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.config.ConfigurableBeanFactory;\n import org.springframework.boot.test.context.TestConfiguration;\n import org.springframework.boot.test.mock.mockito.MockBean;\n+import org.springframework.context.annotation.Bean;\n import org.springframework.context.annotation.Import;\n+import org.springframework.context.annotation.Scope;\n+import org.springframework.test.context.junit4.SpringRunner;\n \n-public class CaptchaVerificationServiceTest extends BaseControllerTest {\n+@RunWith(SpringRunner.class)\n+public class CaptchaVerificationServiceTest {\n \n   final String prodAllOfUsUrl = \"https://workbench.researchallofus.org/login\";\n   final String testAllOfUsUrl = \"https://all-of-us-workbench-test.appspot.com\";\n   final String responseToken = \"responseToken\";\n \n   @MockBean private CloudStorageService cloudStorageService;\n-  @MockBean private WorkbenchConfig configProvider;\n   @MockBean private CaptchaApi captchaApiProvider;\n \n-  @MockBean private WorkbenchConfig.AdminConfig adminConfig;\n   @Autowired private CaptchaVerificationServiceImpl captchaVerificationService;\n \n+  private static WorkbenchConfig config;\n+\n   @TestConfiguration\n   @Import({CaptchaVerificationServiceImpl.class, CaptchaApi.class})\n-  static class Configuration {}\n+  static class Configuration {\n+    @Bean\n+    @Scope(ConfigurableBeanFactory.SCOPE_PROTOTYPE)\n+    public WorkbenchConfig workbenchConfig() {\n+      return config;\n+    }\n+  }\n \n   @Before\n-  @Override\n   public void setUp() throws IOException {\n-    super.setUp();\n+    config = WorkbenchConfig.createEmptyConfig();\n+    config.admin.loginUrl = \"hostname\";\n     Mockito.when(cloudStorageService.getCaptchaServerKey()).thenReturn(\"key\");\n     try {\n       mockCaptchaResponse(\"hostName\", true);\n     } catch (ApiException ex) {\n       ex.printStackTrace();\n-      ;\n     }\n   }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUzNjQ4Ng==", "url": "https://github.com/all-of-us/workbench/pull/3309#discussion_r399536486", "bodyText": "This is not ideal, should just remove these and use the same approach that is used in this test case (define a static WorkbenchConfig, then provide a prorotype scoped bean of it): \n  \n    \n      workbench/api/src/test/java/org/pmiops/workbench/api/SumoLogicControllerTest.java\n    \n    \n         Line 42\n      in\n      6103697\n    \n    \n    \n    \n\n        \n          \n           private static WorkbenchConfig config; \n        \n    \n  \n\n\nIn the individual test cases, override the values directly on the static config with the config you want.", "author": "calbach", "createdAt": "2020-03-27T21:03:10Z", "path": "api/src/main/java/org/pmiops/workbench/captcha/CaptchaVerificationServiceImpl.java", "diffHunk": "@@ -36,6 +41,21 @@ public CaptchaVerificationServiceImpl(\n     this.captchaApiProvider = captchaApiProvider;\n   }\n \n+  @VisibleForTesting\n+  public void mockLoginUrl(String loginUrl) {", "originalCommit": "9f354964cf032cb3a438419974211b40bdeb1e3e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "053c937e925e1bf62b8229b57876598c4d6c645e", "chunk": "diff --git a/api/src/main/java/org/pmiops/workbench/captcha/CaptchaVerificationServiceImpl.java b/api/src/main/java/org/pmiops/workbench/captcha/CaptchaVerificationServiceImpl.java\nindex 31537eb03..93e4cd035 100644\n--- a/api/src/main/java/org/pmiops/workbench/captcha/CaptchaVerificationServiceImpl.java\n+++ b/api/src/main/java/org/pmiops/workbench/captcha/CaptchaVerificationServiceImpl.java\n\n@@ -41,20 +40,6 @@ public class CaptchaVerificationServiceImpl implements CaptchaVerificationServic\n     this.captchaApiProvider = captchaApiProvider;\n   }\n \n-  @VisibleForTesting\n-  public void mockLoginUrl(String loginUrl) {\n-    WorkbenchConfig.AdminConfig adminConfig = new WorkbenchConfig.AdminConfig();\n-    adminConfig.loginUrl = loginUrl;\n-    configProvider.get().admin = adminConfig;\n-  }\n-\n-  @VisibleForTesting\n-  public void mockUseTestCaptcha(boolean useTestCaptcha) {\n-    WorkbenchConfig.CaptchaConfig captchaConfig = new WorkbenchConfig.CaptchaConfig();\n-    captchaConfig.useTestCaptcha = useTestCaptcha;\n-\n-    configProvider.get().captcha = captchaConfig;\n-  }\n \n   /**\n    * Calls google api to verify Captcha Response by sending the captcha Server key associated with\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU0ODc2Mg==", "url": "https://github.com/all-of-us/workbench/pull/3309#discussion_r399548762", "bodyText": "Should you just compare this to config.server.uiBaseUrl, or at least - extract the host from there ?", "author": "calbach", "createdAt": "2020-03-27T21:34:24Z", "path": "api/src/main/java/org/pmiops/workbench/captcha/CaptchaVerificationServiceImpl.java", "diffHunk": "@@ -60,11 +80,17 @@ public boolean verifyCaptcha(String responseToken) throws ApiException {\n     }\n     String captchaHostname = response.getHostname();\n     String uiUrl = configProvider.get().admin.loginUrl;\n+    boolean usingTestCaptcha = configProvider.get().captcha.useTestCaptcha;\n+    boolean captchaHostNameMatchUI = false;\n \n-    // check if the UI URL has the host as send by Captcha Response\n-    boolean captchaHostNameMatchUI =\n-        String.format(urlPattern, captchaHostname).equals(uiUrl)\n-            || String.format(localHostUrlPattern, captchaHostname).equals(uiUrl);\n+    // Production/Stable should  not use google test Key and the domainName should match with the\n+    // one return from Captcha Response\n+    if (!usingTestCaptcha) {\n+      // check if the UI URL has the host as send by Captcha Response\n+      captchaHostNameMatchUI = String.format(urlPattern, captchaHostname).equals(uiUrl);\n+    } else {\n+      captchaHostNameMatchUI = captchaHostname.equals(googleTestHost);", "originalCommit": "9f354964cf032cb3a438419974211b40bdeb1e3e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU3NzM5MQ==", "url": "https://github.com/all-of-us/workbench/pull/3309#discussion_r399577391", "bodyText": "i was initially checking the config.loginUrl to be one of test/login/stable but since it was basically checking just the config variable to constants i was not sure if it was adding anything.", "author": "NehaBroad", "createdAt": "2020-03-27T23:10:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU0ODc2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU3ODY5MA==", "url": "https://github.com/all-of-us/workbench/pull/3309#discussion_r399578690", "bodyText": "https://github.com/all-of-us/workbench/blob/fd85f5755b299cfa8ac1f092dc9752ca87ba4d44/api/src/main/java/org/pmiops/workbench/captcha/CaptchaVerificationServiceImpl.java L100", "author": "NehaBroad", "createdAt": "2020-03-27T23:15:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU0ODc2Mg=="}], "type": "inlineReview", "revised_code": {"commit": "2644e457cc3dc108b7b476c3fba1b50a172dedea", "chunk": "diff --git a/api/src/main/java/org/pmiops/workbench/captcha/CaptchaVerificationServiceImpl.java b/api/src/main/java/org/pmiops/workbench/captcha/CaptchaVerificationServiceImpl.java\nindex 31537eb03..fc1b191ca 100644\n--- a/api/src/main/java/org/pmiops/workbench/captcha/CaptchaVerificationServiceImpl.java\n+++ b/api/src/main/java/org/pmiops/workbench/captcha/CaptchaVerificationServiceImpl.java\n\n@@ -89,7 +100,10 @@ public class CaptchaVerificationServiceImpl implements CaptchaVerificationServic\n       // check if the UI URL has the host as send by Captcha Response\n       captchaHostNameMatchUI = String.format(urlPattern, captchaHostname).equals(uiUrl);\n     } else {\n-      captchaHostNameMatchUI = captchaHostname.equals(googleTestHost);\n+      // If URL is using google test key hence the host return will always be testkey.google.com\n+      // hence check if the UI url in config matches one of AllOfUs urls(local/test/staging/perf)\n+      captchaHostNameMatchUI =\n+          captchaHostname.equals(googleTestHost) && testCaptchaURLs.contains(uiUrl);\n     }\n     if (!captchaHostNameMatchUI) {\n       log.log(\n"}}, {"oid": "1794965c766d5ca0fc01bb8c081b5edf9fb3f3c1", "url": "https://github.com/all-of-us/workbench/commit/1794965c766d5ca0fc01bb8c081b5edf9fb3f3c1", "message": "comments", "committedDate": "2020-03-29T15:11:38Z", "type": "commit"}, {"oid": "2644e457cc3dc108b7b476c3fba1b50a172dedea", "url": "https://github.com/all-of-us/workbench/commit/2644e457cc3dc108b7b476c3fba1b50a172dedea", "message": "Adding the test urls check again", "committedDate": "2020-03-30T02:46:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTkwMTE1Ng==", "url": "https://github.com/all-of-us/workbench/pull/3309#discussion_r399901156", "bodyText": "i have added the logic again for testing the urls that are using test google captha. Since the host from the captcha service will always be testkey.google.com, check if the ui url will be one of the environment using test captcha test/local/staging and perf. Let me know if this makes sense/ is there any other check that i can add.", "author": "NehaBroad", "createdAt": "2020-03-30T02:49:15Z", "path": "api/src/main/java/org/pmiops/workbench/captcha/CaptchaVerificationServiceImpl.java", "diffHunk": "@@ -60,11 +91,20 @@ public boolean verifyCaptcha(String responseToken) throws ApiException {\n     }\n     String captchaHostname = response.getHostname();\n     String uiUrl = configProvider.get().admin.loginUrl;\n+    boolean usingTestCaptcha = configProvider.get().captcha.useTestCaptcha;\n+    boolean captchaHostNameMatchUI = false;\n \n-    // check if the UI URL has the host as send by Captcha Response\n-    boolean captchaHostNameMatchUI =\n-        String.format(urlPattern, captchaHostname).equals(uiUrl)\n-            || String.format(localHostUrlPattern, captchaHostname).equals(uiUrl);\n+    // Production/Stable should  not use google test Key and the domainName should match with the\n+    // one return from Captcha Response\n+    if (!usingTestCaptcha) {\n+      // check if the UI URL has the host as send by Captcha Response\n+      captchaHostNameMatchUI = String.format(urlPattern, captchaHostname).equals(uiUrl);\n+    } else {\n+      // If URL is using google test key hence the host return will always be testkey.google.com\n+      // hence check if the UI url in config matches one of AllOfUs urls(local/test/staging/perf)\n+      captchaHostNameMatchUI =\n+          captchaHostname.equals(googleTestHost) && testCaptchaURLs.contains(uiUrl);", "originalCommit": "2644e457cc3dc108b7b476c3fba1b50a172dedea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTk2NTk1MA==", "url": "https://github.com/all-of-us/workbench/pull/3309#discussion_r399965950", "bodyText": "Sorry, I still don't understand why you need to hardcode a list of URLs here. Can you not use the combination of config.server.uiBaseUrl with usingTestCaptcha to make the determination?", "author": "calbach", "createdAt": "2020-03-30T07:01:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTkwMTE1Ng=="}], "type": "inlineReview", "revised_code": {"commit": "79da556dbd88f699102bb6397bd6f19179bab182", "chunk": "diff --git a/api/src/main/java/org/pmiops/workbench/captcha/CaptchaVerificationServiceImpl.java b/api/src/main/java/org/pmiops/workbench/captcha/CaptchaVerificationServiceImpl.java\nindex fc1b191ca..2ca26cb18 100644\n--- a/api/src/main/java/org/pmiops/workbench/captcha/CaptchaVerificationServiceImpl.java\n+++ b/api/src/main/java/org/pmiops/workbench/captcha/CaptchaVerificationServiceImpl.java\n\n@@ -100,10 +89,8 @@ public class CaptchaVerificationServiceImpl implements CaptchaVerificationServic\n       // check if the UI URL has the host as send by Captcha Response\n       captchaHostNameMatchUI = String.format(urlPattern, captchaHostname).equals(uiUrl);\n     } else {\n-      // If URL is using google test key hence the host return will always be testkey.google.com\n-      // hence check if the UI url in config matches one of AllOfUs urls(local/test/staging/perf)\n-      captchaHostNameMatchUI =\n-          captchaHostname.equals(googleTestHost) && testCaptchaURLs.contains(uiUrl);\n+      // Captcha returns host as testkey.google.com, if test keys are used\n+      captchaHostNameMatchUI = captchaHostname.equals(googleTestHost);\n     }\n     if (!captchaHostNameMatchUI) {\n       log.log(\n"}}, {"oid": "79da556dbd88f699102bb6397bd6f19179bab182", "url": "https://github.com/all-of-us/workbench/commit/79da556dbd88f699102bb6397bd6f19179bab182", "message": "Remove testUrls check", "committedDate": "2020-03-30T17:20:14Z", "type": "commit"}, {"oid": "053c937e925e1bf62b8229b57876598c4d6c645e", "url": "https://github.com/all-of-us/workbench/commit/053c937e925e1bf62b8229b57876598c4d6c645e", "message": "remove unused methods", "committedDate": "2020-03-30T17:23:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM3NzA0MA==", "url": "https://github.com/all-of-us/workbench/pull/3309#discussion_r400377040", "bodyText": "This catch should no longer be necessary", "author": "calbach", "createdAt": "2020-03-30T17:44:13Z", "path": "api/src/test/java/org/pmiops/workbench/captcha/CaptchaVerificationServiceTest.java", "diffHunk": "@@ -0,0 +1,98 @@\n+package org.pmiops.workbench.captcha;\n+\n+import static com.google.common.truth.Truth.assertThat;\n+\n+import java.io.IOException;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.Mockito;\n+import org.pmiops.workbench.captcha.api.CaptchaApi;\n+import org.pmiops.workbench.captcha.model.CaptchaVerificationResponse;\n+import org.pmiops.workbench.config.WorkbenchConfig;\n+import org.pmiops.workbench.google.CloudStorageService;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.config.ConfigurableBeanFactory;\n+import org.springframework.boot.test.context.TestConfiguration;\n+import org.springframework.boot.test.mock.mockito.MockBean;\n+import org.springframework.context.annotation.Bean;\n+import org.springframework.context.annotation.Import;\n+import org.springframework.context.annotation.Scope;\n+import org.springframework.test.context.junit4.SpringRunner;\n+\n+@RunWith(SpringRunner.class)\n+public class CaptchaVerificationServiceTest {\n+\n+  final String prodAllOfUsUrl = \"https://workbench.researchallofus.org/login\";\n+  final String testUrl = \"testkey.google.com\";\n+  final String responseToken = \"responseToken\";\n+\n+  @MockBean private CloudStorageService cloudStorageService;\n+  @MockBean private CaptchaApi captchaApiProvider;\n+\n+  @Autowired private CaptchaVerificationServiceImpl captchaVerificationService;\n+\n+  private static WorkbenchConfig config;\n+\n+  @TestConfiguration\n+  @Import({CaptchaVerificationServiceImpl.class, CaptchaApi.class})\n+  static class Configuration {\n+    @Bean\n+    @Scope(ConfigurableBeanFactory.SCOPE_PROTOTYPE)\n+    public WorkbenchConfig workbenchConfig() {\n+      return config;\n+    }\n+  }\n+\n+  @Before\n+  public void setUp() throws IOException {\n+    config = WorkbenchConfig.createEmptyConfig();\n+    config.admin.loginUrl = \"hostname\";\n+    Mockito.when(cloudStorageService.getCaptchaServerKey()).thenReturn(\"key\");\n+    try {\n+      mockCaptchaResponse(\"hostName\", true);\n+    } catch (ApiException ex) {", "originalCommit": "053c937e925e1bf62b8229b57876598c4d6c645e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "de2082c6fad0a5e49f46772c6ff37c81c4282681", "chunk": "diff --git a/api/src/test/java/org/pmiops/workbench/captcha/CaptchaVerificationServiceTest.java b/api/src/test/java/org/pmiops/workbench/captcha/CaptchaVerificationServiceTest.java\nindex a5f25a0a8..27c42c4f4 100644\n--- a/api/src/test/java/org/pmiops/workbench/captcha/CaptchaVerificationServiceTest.java\n+++ b/api/src/test/java/org/pmiops/workbench/captcha/CaptchaVerificationServiceTest.java\n\n@@ -45,15 +45,11 @@ public class CaptchaVerificationServiceTest {\n   }\n \n   @Before\n-  public void setUp() throws IOException {\n+  public void setUp() throws IOException, ApiException {\n     config = WorkbenchConfig.createEmptyConfig();\n     config.admin.loginUrl = \"hostname\";\n     Mockito.when(cloudStorageService.getCaptchaServerKey()).thenReturn(\"key\");\n-    try {\n-      mockCaptchaResponse(\"hostName\", true);\n-    } catch (ApiException ex) {\n-      ex.printStackTrace();\n-    }\n+    mockCaptchaResponse(\"hostName\", true);\n   }\n \n   private void mockCaptchaResponse(String hostName, boolean success) throws ApiException {\n"}}, {"oid": "de2082c6fad0a5e49f46772c6ff37c81c4282681", "url": "https://github.com/all-of-us/workbench/commit/de2082c6fad0a5e49f46772c6ff37c81c4282681", "message": "fix test", "committedDate": "2020-03-30T18:43:34Z", "type": "commit"}, {"oid": "09bcb1978186ef60b6c6eb6c5b0d1714192d37fb", "url": "https://github.com/all-of-us/workbench/commit/09bcb1978186ef60b6c6eb6c5b0d1714192d37fb", "message": "Add comments", "committedDate": "2020-03-30T18:49:09Z", "type": "commit"}, {"oid": "2f9636b398370220344bfb105abb581010527434", "url": "https://github.com/all-of-us/workbench/commit/2f9636b398370220344bfb105abb581010527434", "message": "spotless", "committedDate": "2020-03-30T19:51:48Z", "type": "commit"}]}