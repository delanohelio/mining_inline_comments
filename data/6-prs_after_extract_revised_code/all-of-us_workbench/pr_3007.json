{"pr_number": 3007, "pr_title": "[RW-4233][risk=no] adding PM and Surveys to concept search", "pr_createdAt": "2020-01-16T21:15:46Z", "pr_url": "https://github.com/all-of-us/workbench/pull/3007", "timeline": [{"oid": "0399bfd577b1bccbf467d8fa1ce880ecd4660e3d", "url": "https://github.com/all-of-us/workbench/commit/0399bfd577b1bccbf467d8fa1ce880ecd4660e3d", "message": "RW-4233 adding calls for PM.", "committedDate": "2020-01-07T18:14:44Z", "type": "commit"}, {"oid": "a6fa0928d89cdefaaf9df08e11e822b83890f091", "url": "https://github.com/all-of-us/workbench/commit/a6fa0928d89cdefaaf9df08e11e822b83890f091", "message": "fixing problems.", "committedDate": "2020-01-07T19:28:31Z", "type": "commit"}, {"oid": "775f107c9854a9277e3950785abc9a57e3edbedb", "url": "https://github.com/all-of-us/workbench/commit/775f107c9854a9277e3950785abc9a57e3edbedb", "message": "RW-4233 change sort on surveys.", "committedDate": "2020-01-07T20:16:19Z", "type": "commit"}, {"oid": "ed678fd67fd35870b2457681f9a88565e8b32885", "url": "https://github.com/all-of-us/workbench/commit/ed678fd67fd35870b2457681f9a88565e8b32885", "message": "RW-4233 adding check for source/standard when searching Surveys.", "committedDate": "2020-01-09T17:32:24Z", "type": "commit"}, {"oid": "5eac5610972d831df23f8c3c42e574994dc62b93", "url": "https://github.com/all-of-us/workbench/commit/5eac5610972d831df23f8c3c42e574994dc62b93", "message": "RW-4233 remove surveys filter", "committedDate": "2020-01-10T18:43:07Z", "type": "commit"}, {"oid": "a11e5064cdc9fad8bb1abaeb491089c53e3aad28", "url": "https://github.com/all-of-us/workbench/commit/a11e5064cdc9fad8bb1abaeb491089c53e3aad28", "message": "RW-4233 fixing queries for PM and Surveys.", "committedDate": "2020-01-10T20:16:27Z", "type": "commit"}, {"oid": "3b3af477626e12b8886f46534b3eac3d22834ee4", "url": "https://github.com/all-of-us/workbench/commit/3b3af477626e12b8886f46534b3eac3d22834ee4", "message": "RW-4233 adding tests.", "committedDate": "2020-01-13T15:12:22Z", "type": "commit"}, {"oid": "bfa95feceb68b2d4ef7ff44c5aa4f18737bed7cf", "url": "https://github.com/all-of-us/workbench/commit/bfa95feceb68b2d4ef7ff44c5aa4f18737bed7cf", "message": "RW-4233 show survey results in same table as other domains", "committedDate": "2020-01-13T19:08:03Z", "type": "commit"}, {"oid": "6b2baf89916f2df1a4967098e89fcb33faaabaf6", "url": "https://github.com/all-of-us/workbench/commit/6b2baf89916f2df1a4967098e89fcb33faaabaf6", "message": "Merge branch 'freemabd/RW-4233' of https://github.com/all-of-us/workbench into freemabd/RW-4233", "committedDate": "2020-01-13T19:08:24Z", "type": "commit"}, {"oid": "1fbe3d2e14f8fbe07ba63f5b7c198d7f88872065", "url": "https://github.com/all-of-us/workbench/commit/1fbe3d2e14f8fbe07ba63f5b7c198d7f88872065", "message": "RW-4233 fix count in title for PM and Surveys in add concepts modal", "committedDate": "2020-01-13T20:56:05Z", "type": "commit"}, {"oid": "c3f1bfc56aa92b387ab1489a62f350a825319a59", "url": "https://github.com/all-of-us/workbench/commit/c3f1bfc56aa92b387ab1489a62f350a825319a59", "message": "RW-4233 fix broken ui test", "committedDate": "2020-01-13T22:35:30Z", "type": "commit"}, {"oid": "58ef00806b7ded8d67c7c60057ed0f2fe1843b50", "url": "https://github.com/all-of-us/workbench/commit/58ef00806b7ded8d67c7c60057ed0f2fe1843b50", "message": "RW-4233 pass domain to concept table", "committedDate": "2020-01-14T15:51:48Z", "type": "commit"}, {"oid": "2227ccf145f423a25d8ea3a485f9596c9eedc0cb", "url": "https://github.com/all-of-us/workbench/commit/2227ccf145f423a25d8ea3a485f9596c9eedc0cb", "message": "RW-4233 fix concept table in detail view", "committedDate": "2020-01-14T15:54:12Z", "type": "commit"}, {"oid": "5d8599f7b5570a41c5aad2820f9c88b74b1678dd", "url": "https://github.com/all-of-us/workbench/commit/5d8599f7b5570a41c5aad2820f9c88b74b1678dd", "message": "RW-4233 show survey tab when clicking survey cards", "committedDate": "2020-01-14T20:57:56Z", "type": "commit"}, {"oid": "52bfe401f44247b32274956ea685b8928465262a", "url": "https://github.com/all-of-us/workbench/commit/52bfe401f44247b32274956ea685b8928465262a", "message": "RW-4233 trigger search when standard checkbox changed", "committedDate": "2020-01-16T15:27:06Z", "type": "commit"}, {"oid": "8140e9a717127a05773638b2e64b2844c4e225dd", "url": "https://github.com/all-of-us/workbench/commit/8140e9a717127a05773638b2e64b2844c4e225dd", "message": "RW-4233 adding calls for PM.", "committedDate": "2020-01-16T15:36:42Z", "type": "commit"}, {"oid": "08e9b2c8ca757f72b38288578f598a42ea866e9d", "url": "https://github.com/all-of-us/workbench/commit/08e9b2c8ca757f72b38288578f598a42ea866e9d", "message": "fixing problems.", "committedDate": "2020-01-16T15:36:42Z", "type": "commit"}, {"oid": "8d6f9270689470f2d688e92dec864d5091be3778", "url": "https://github.com/all-of-us/workbench/commit/8d6f9270689470f2d688e92dec864d5091be3778", "message": "RW-4233 change sort on surveys.", "committedDate": "2020-01-16T15:36:42Z", "type": "commit"}, {"oid": "2424312fd50a8dd1b876a09d4999af9ba73248de", "url": "https://github.com/all-of-us/workbench/commit/2424312fd50a8dd1b876a09d4999af9ba73248de", "message": "RW-4233 adding check for source/standard when searching Surveys.", "committedDate": "2020-01-16T15:36:42Z", "type": "commit"}, {"oid": "2c85a61dfee851ffb287da437f90fe21f3a99bae", "url": "https://github.com/all-of-us/workbench/commit/2c85a61dfee851ffb287da437f90fe21f3a99bae", "message": "RW-4233 remove surveys filter", "committedDate": "2020-01-16T15:36:42Z", "type": "commit"}, {"oid": "29633e0a8a4cb2b0c0254f22ab6595d2bffb062c", "url": "https://github.com/all-of-us/workbench/commit/29633e0a8a4cb2b0c0254f22ab6595d2bffb062c", "message": "RW-4233 fixing queries for PM and Surveys.", "committedDate": "2020-01-16T15:36:42Z", "type": "commit"}, {"oid": "973022cd551c81dcda2256e84a7281f7b2e6f35a", "url": "https://github.com/all-of-us/workbench/commit/973022cd551c81dcda2256e84a7281f7b2e6f35a", "message": "RW-4233 adding tests.", "committedDate": "2020-01-16T15:36:42Z", "type": "commit"}, {"oid": "ec9e9a2f317743d082faa5b885a8832e6028e0fd", "url": "https://github.com/all-of-us/workbench/commit/ec9e9a2f317743d082faa5b885a8832e6028e0fd", "message": "RW-4233 show survey results in same table as other domains", "committedDate": "2020-01-16T15:36:42Z", "type": "commit"}, {"oid": "0cce6e7590607db7afd226eef25c728d0d7a74b9", "url": "https://github.com/all-of-us/workbench/commit/0cce6e7590607db7afd226eef25c728d0d7a74b9", "message": "RW-4233 fix count in title for PM and Surveys in add concepts modal", "committedDate": "2020-01-16T15:36:42Z", "type": "commit"}, {"oid": "ef7892ad85cd513f935973df776587722d844f18", "url": "https://github.com/all-of-us/workbench/commit/ef7892ad85cd513f935973df776587722d844f18", "message": "RW-4233 fix broken ui test", "committedDate": "2020-01-16T15:36:42Z", "type": "commit"}, {"oid": "fc2122c20c1f512f0cb92a4c4942603b86d8681d", "url": "https://github.com/all-of-us/workbench/commit/fc2122c20c1f512f0cb92a4c4942603b86d8681d", "message": "RW-4233 pass domain to concept table", "committedDate": "2020-01-16T15:36:42Z", "type": "commit"}, {"oid": "73a6d0ebac3e78da5c82938e74c973c3c1eeb27a", "url": "https://github.com/all-of-us/workbench/commit/73a6d0ebac3e78da5c82938e74c973c3c1eeb27a", "message": "RW-4233 fix concept table in detail view", "committedDate": "2020-01-16T15:36:42Z", "type": "commit"}, {"oid": "c414d0bad9b7222a62f76ba7cde244d6fe7307b3", "url": "https://github.com/all-of-us/workbench/commit/c414d0bad9b7222a62f76ba7cde244d6fe7307b3", "message": "RW-4233 show survey tab when clicking survey cards", "committedDate": "2020-01-16T15:36:42Z", "type": "commit"}, {"oid": "5cf5db97256954f1c3de7f1862782c2894646bf0", "url": "https://github.com/all-of-us/workbench/commit/5cf5db97256954f1c3de7f1862782c2894646bf0", "message": "RW-4233 trigger search when standard checkbox changed", "committedDate": "2020-01-16T15:40:05Z", "type": "commit"}, {"oid": "27a8147527b3310fe7b0ff818fd52e7f1aa3b907", "url": "https://github.com/all-of-us/workbench/commit/27a8147527b3310fe7b0ff818fd52e7f1aa3b907", "message": "Merge branch 'freemabd/RW-4233' of https://github.com/all-of-us/workbench into freemabd/RW-4233\n\n\u0001 Conflicts:\n\u0001\tui/src/app/pages/data/concept/concept-homepage.tsx", "committedDate": "2020-01-16T15:43:16Z", "type": "commit"}, {"oid": "0f753628aae55bb2c4ee8e0af5a0bd46a00d4790", "url": "https://github.com/all-of-us/workbench/commit/0f753628aae55bb2c4ee8e0af5a0bd46a00d4790", "message": "RW-4233 code cleanup", "committedDate": "2020-01-16T19:17:44Z", "type": "commit"}, {"oid": "498bc7b98215309fa4771964dcb56d16e120ed1b", "url": "https://github.com/all-of-us/workbench/commit/498bc7b98215309fa4771964dcb56d16e120ed1b", "message": "RW-4233 fixing queries for PM.", "committedDate": "2020-01-16T20:19:11Z", "type": "commit"}, {"oid": "76aae25351caa93f7ecb8de31a3ed2dd4db37aae", "url": "https://github.com/all-of-us/workbench/commit/76aae25351caa93f7ecb8de31a3ed2dd4db37aae", "message": "Merge branch 'freemabd/RW-4233' of https://github.com/all-of-us/workbench into freemabd/RW-4233", "committedDate": "2020-01-16T20:19:32Z", "type": "commit"}, {"oid": "cda16421e0d478b29c4b16c6a78a72898c116c0d", "url": "https://github.com/all-of-us/workbench/commit/cda16421e0d478b29c4b16c6a78a72898c116c0d", "message": "RW-4233 fixing test cases.", "committedDate": "2020-01-16T20:51:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODAwNjEzNA==", "url": "https://github.com/all-of-us/workbench/pull/3007#discussion_r368006134", "bodyText": "Here we select concepts from DbConcept and above we get the concept counts from DbCriteria.  Is it possible to get these from the same source?", "author": "dolbeew", "createdAt": "2020-01-17T15:52:53Z", "path": "common-api/src/main/java/org/pmiops/workbench/cdr/dao/ConceptDao.java", "diffHunk": "@@ -42,5 +43,59 @@\n               + \"where (c.countValue > 0 or c.sourceCountValue > 0) \"\n               + \"and c.standardConcept IN (?1) \"\n               + \"and c.domainId in (?2)\")\n-  Page<DbConcept> findConcepts(List<String> conceptTypes, List<String> domainIds, Pageable page);\n+  Page<DbConcept> findConcepts(\n+      ImmutableList<String> conceptTypes, List<String> domainIds, Pageable page);\n+\n+  /**\n+   * Return standard or all concepts in each vocabulary for the specified domain matching the\n+   * specified expression, matching concept name, synonym, ID, or code.\n+   *\n+   * @param matchExp SQL MATCH expression to match concept name or synonym\n+   * @param conceptTypes can be 'S', 'C' or ''\n+   * @param domainIds domain IDs to use when filtering concepts\n+   * @param vocabularyId vocabulary id type to search\n+   * @param conceptClassId concept class id type to search\n+   * @return per-vocabulary concept counts\n+   */\n+  @Query(\n+      value =\n+          \"select distinct c from DbConcept c \"", "originalCommit": "cda16421e0d478b29c4b16c6a78a72898c116c0d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODAzMDUzMg==", "url": "https://github.com/all-of-us/workbench/pull/3007#discussion_r368030532", "bodyText": "It is, but we query from the db_criteria table for surveys. This allows us to get the questions in order, which we cannot do when querying from concept table.", "author": "freemabd", "createdAt": "2020-01-17T16:41:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODAwNjEzNA=="}], "type": "inlineReview", "revised_code": {"commit": "b76bb455e89cadc950320df924b75ba0c8e8a096", "chunk": "diff --git a/common-api/src/main/java/org/pmiops/workbench/cdr/dao/ConceptDao.java b/common-api/src/main/java/org/pmiops/workbench/cdr/dao/ConceptDao.java\nindex e601919b2..bf4d6670f 100644\n--- a/common-api/src/main/java/org/pmiops/workbench/cdr/dao/ConceptDao.java\n+++ b/common-api/src/main/java/org/pmiops/workbench/cdr/dao/ConceptDao.java\n\n@@ -44,7 +46,7 @@ public interface ConceptDao extends CrudRepository<DbConcept, Long> {\n               + \"and c.standardConcept IN (?1) \"\n               + \"and c.domainId in (?2)\")\n   Page<DbConcept> findConcepts(\n-      ImmutableList<String> conceptTypes, List<String> domainIds, Pageable page);\n+      ImmutableList<String> conceptTypes, ImmutableList<String> domainIds, Pageable page);\n \n   /**\n    * Return standard or all concepts in each vocabulary for the specified domain matching the\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODAxMjAwOA==", "url": "https://github.com/all-of-us/workbench/pull/3007#discussion_r368012008", "bodyText": "Do surveys have to use this structure or can it be modified to add properties (possibly survey name)? Not needed now, just asking for future reference.", "author": "dolbeew", "createdAt": "2020-01-17T16:03:52Z", "path": "api/src/main/java/org/pmiops/workbench/api/ConceptsController.java", "diffHunk": "@@ -195,12 +192,34 @@ private void addDomainCounts(SearchConceptsRequest request, ConceptListResponse\n               (request.getPageNumber() == null) ? 0 : request.getPageNumber());\n       if (concepts != null) {\n         response.setItems(\n-            concepts.getContent().stream().map(TO_CLIENT_CONCEPT).collect(Collectors.toList()));\n+            concepts.getContent().stream()\n+                .map(ConceptsController::toClientConcept)\n+                .collect(Collectors.toList()));\n       }\n     }\n \n     // TODO: consider doing these queries in parallel\n     addDomainCounts(request, response);\n     return ResponseEntity.ok(response);\n   }\n+\n+  public static Concept toClientConcept(DbConcept concept) {\n+    return new Concept()\n+        .conceptClassId(concept.getConceptClassId())\n+        .conceptCode(concept.getConceptCode())\n+        .conceptName(concept.getConceptName())\n+        .conceptId(concept.getConceptId())\n+        .countValue(concept.getCountValue())\n+        .domainId(concept.getDomainId())\n+        .prevalence(concept.getPrevalence())\n+        .standardConcept(ConceptService.STANDARD_CONCEPT_CODE.equals(concept.getStandardConcept()))\n+        .vocabularyId(concept.getVocabularyId())\n+        .conceptSynonyms(concept.getSynonyms());\n+  }\n+\n+  private SurveyQuestions toClientSurveyQuestions(DbCriteria dbCriteria) {\n+    return new SurveyQuestions()\n+        .conceptId(dbCriteria.getLongConceptId())\n+        .question(dbCriteria.getName());", "originalCommit": "cda16421e0d478b29c4b16c6a78a72898c116c0d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODAzMDc2NA==", "url": "https://github.com/all-of-us/workbench/pull/3007#discussion_r368030764", "bodyText": "Yes, we can definitely add survey name to this model", "author": "freemabd", "createdAt": "2020-01-17T16:42:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODAxMjAwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODAzMTUzNg==", "url": "https://github.com/all-of-us/workbench/pull/3007#discussion_r368031536", "bodyText": "Yes, survey name can definitely be added to the model.", "author": "freemabd", "createdAt": "2020-01-17T16:43:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODAxMjAwOA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "2c6e6c458f9393734452e440f5ebd230dbfa5544", "url": "https://github.com/all-of-us/workbench/commit/2c6e6c458f9393734452e440f5ebd230dbfa5544", "message": "RW-4233 fix surveys for non feature flagged view", "committedDate": "2020-01-17T18:00:34Z", "type": "commit"}, {"oid": "b76bb455e89cadc950320df924b75ba0c8e8a096", "url": "https://github.com/all-of-us/workbench/commit/b76bb455e89cadc950320df924b75ba0c8e8a096", "message": "RW-4233 removing unchecked warnings.", "committedDate": "2020-01-17T18:22:29Z", "type": "commit"}]}