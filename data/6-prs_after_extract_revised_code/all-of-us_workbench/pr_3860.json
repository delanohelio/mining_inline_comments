{"pr_number": 3860, "pr_title": "triallelic randomize", "pr_createdAt": "2020-08-05T21:14:08Z", "pr_url": "https://github.com/all-of-us/workbench/pull/3860", "timeline": [{"oid": "7d640d1a3a68081edd4cfc34159df2f2c662f8e0", "url": "https://github.com/all-of-us/workbench/commit/7d640d1a3a68081edd4cfc34159df2f2c662f8e0", "message": "triallelic randomize", "committedDate": "2020-08-05T21:08:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjAwOTQ5OA==", "url": "https://github.com/all-of-us/workbench/pull/3860#discussion_r466009498", "bodyText": "nit: I think it would read a little quicker if we specified that the size should be equal to 2. I was trying to figure this out earlier while I was reading.", "author": "ericsong", "createdAt": "2020-08-05T21:17:27Z", "path": "api/genomics/src/main/java/org/pmiops/workbench/genomics/RandomizeVcf.java", "diffHunk": "@@ -140,30 +140,49 @@ protected Genotype randomizeGenotype(VariantContext variantContext, Genotype gen\n      */\n     List<Allele> alleles = new ArrayList<>();\n     double genotypeTypeIndex = random.nextDouble();\n-    if (genotypeTypeIndex < .0145) {\n-      // double no-call\n-      return alleles;\n-    } else if (genotypeTypeIndex < .8095) {\n-      // homref\n-      alleles.add(variantContext.getReference());\n-      alleles.add(variantContext.getReference());\n-    } else if (genotypeTypeIndex < .8654) {\n-      // 0/1 het\n-      alleles.add(variantContext.getReference());\n-      alleles.add(variantContext.getAlternateAllele(0));\n-    } else if (genotypeTypeIndex < .9268) {\n-      // 1/0 het\n-      alleles.add(variantContext.getAlternateAllele(0));\n-      alleles.add(variantContext.getReference());\n-    } else if (genotypeTypeIndex < .9994\n-        || (genotypeTypeIndex >= .9994 && variantContext.getAlternateAlleles().size() == 1)) {\n-      // homvar\n-      alleles.add(variantContext.getAlternateAllele(0));\n-      alleles.add(variantContext.getAlternateAllele(0));\n+    if (variantContext.getAlternateAlleles().size() == 1) {\n+      if (genotypeTypeIndex < .0145) {\n+        // double no-call\n+        alleles.add(Allele.NO_CALL);\n+        alleles.add(Allele.NO_CALL);\n+        return alleles;\n+      } else if (genotypeTypeIndex < .8095) {\n+        // homref\n+        alleles.add(variantContext.getReference());\n+        alleles.add(variantContext.getReference());\n+      } else if (genotypeTypeIndex < .8654) {\n+        // 0/1 het\n+        alleles.add(variantContext.getReference());\n+        alleles.add(variantContext.getAlternateAllele(0));\n+      } else if (genotypeTypeIndex < .9268) {\n+        // 1/0 het\n+        alleles.add(variantContext.getAlternateAllele(0));\n+        alleles.add(variantContext.getReference());\n+      } else {\n+        // homvar\n+        alleles.add(variantContext.getAlternateAllele(0));\n+        alleles.add(variantContext.getAlternateAllele(0));\n+      }\n     } else {", "originalCommit": "7d640d1a3a68081edd4cfc34159df2f2c662f8e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjAwOTc1NA==", "url": "https://github.com/all-of-us/workbench/pull/3860#discussion_r466009754", "bodyText": "that makes sense, I'll flip it around!", "author": "als364", "createdAt": "2020-08-05T21:18:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjAwOTQ5OA=="}], "type": "inlineReview", "revised_code": {"commit": "d758528e6572a5075403efe824edf643222904af", "chunk": "diff --git a/api/genomics/src/main/java/org/pmiops/workbench/genomics/RandomizeVcf.java b/api/genomics/src/main/java/org/pmiops/workbench/genomics/RandomizeVcf.java\nindex 2cd083eea..153191078 100644\n--- a/api/genomics/src/main/java/org/pmiops/workbench/genomics/RandomizeVcf.java\n+++ b/api/genomics/src/main/java/org/pmiops/workbench/genomics/RandomizeVcf.java\n\n@@ -140,7 +140,27 @@ public class RandomizeVcf extends VariantWalker {\n      */\n     List<Allele> alleles = new ArrayList<>();\n     double genotypeTypeIndex = random.nextDouble();\n-    if (variantContext.getAlternateAlleles().size() == 1) {\n+    if (variantContext.getAlternateAlleles().size() == 2) {\n+      // sum of probabilities of bi-allelic no-call / homref\n+      if (genotypeTypeIndex < .8240) {\n+        // double no-call (or ref, if we're at a tri-allelic site, but we don't differentiate)\n+        alleles.add(Allele.NO_CALL);\n+        alleles.add(Allele.NO_CALL);\n+        return alleles;\n+      } else if (genotypeTypeIndex < .8654) {\n+        // 1/2 het\n+        alleles.add(variantContext.getAlternateAllele(0));\n+        alleles.add(variantContext.getAlternateAllele(1));\n+      } else if (genotypeTypeIndex < .9268) {\n+        // 2/1 het\n+        alleles.add(variantContext.getAlternateAllele(1));\n+        alleles.add(variantContext.getAlternateAllele(0));\n+      } else {\n+        // homvar, but the rarer alt\n+        alleles.add(variantContext.getAlternateAllele(1));\n+        alleles.add(variantContext.getAlternateAllele(1));\n+      }\n+    } else {\n       if (genotypeTypeIndex < .0145) {\n         // double no-call\n         alleles.add(Allele.NO_CALL);\n"}}, {"oid": "d758528e6572a5075403efe824edf643222904af", "url": "https://github.com/all-of-us/workbench/commit/d758528e6572a5075403efe824edf643222904af", "message": "phrasing", "committedDate": "2020-08-05T21:18:39Z", "type": "commit"}]}