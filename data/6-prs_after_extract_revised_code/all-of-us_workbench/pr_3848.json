{"pr_number": 3848, "pr_title": "[RW-5341][risk=low] Optionally include demographics in metrics export", "pr_createdAt": "2020-08-03T21:51:08Z", "pr_url": "https://github.com/all-of-us/workbench/pull/3848", "timeline": [{"oid": "0a5de14b47872f6e23fa18f6defae80d43681b2e", "url": "https://github.com/all-of-us/workbench/commit/0a5de14b47872f6e23fa18f6defae80d43681b2e", "message": "Optionally include demographics in metrics export", "committedDate": "2020-08-03T21:47:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA3ODUwNw==", "url": "https://github.com/all-of-us/workbench/pull/3848#discussion_r466078507", "bodyText": "nit: the rest of the multi value columns are separated with a newline as well", "author": "ericsong", "createdAt": "2020-08-06T00:35:15Z", "path": "api/tools/src/main/java/org/pmiops/workbench/tools/ExportWorkspaceData.java", "diffHunk": "@@ -269,6 +297,39 @@ private WorkspaceExportRow toWorkspaceExportRow(DbUser user) {\n             .map(dateFormat::format)\n             .orElse(\"\"));\n     row.setCreatorRegistrationState(user.getDataAccessLevelEnum().toString());\n+    row.setDegrees(\n+        Optional.ofNullable(user.getDegreesEnum()).orElse(ImmutableList.of()).stream()\n+            .map(Degree::toString)\n+            .collect(Collectors.joining(\",\")));", "originalCommit": "0a5de14b47872f6e23fa18f6defae80d43681b2e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjE2NzY3NA==", "url": "https://github.com/all-of-us/workbench/pull/3848#discussion_r466167674", "bodyText": "Thanks, missed that.", "author": "calbach", "createdAt": "2020-08-06T06:11:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA3ODUwNw=="}], "type": "inlineReview", "revised_code": {"commit": "1807fd9d8d9b163b981ebe599df43be1d338551f", "chunk": "diff --git a/api/tools/src/main/java/org/pmiops/workbench/tools/ExportWorkspaceData.java b/api/tools/src/main/java/org/pmiops/workbench/tools/ExportWorkspaceData.java\nindex e9df15cda..6caa4d366 100644\n--- a/api/tools/src/main/java/org/pmiops/workbench/tools/ExportWorkspaceData.java\n+++ b/api/tools/src/main/java/org/pmiops/workbench/tools/ExportWorkspaceData.java\n\n@@ -300,26 +300,26 @@ public class ExportWorkspaceData {\n     row.setDegrees(\n         Optional.ofNullable(user.getDegreesEnum()).orElse(ImmutableList.of()).stream()\n             .map(Degree::toString)\n-            .collect(Collectors.joining(\",\")));\n+            .collect(Collectors.joining(\",\\n\")));\n     DbDemographicSurvey demo = user.getDemographicSurvey();\n     if (includeDemographics && demo != null) {\n       row.setRace(\n           Optional.ofNullable(demo.getRaceEnum()).orElse(ImmutableList.of()).stream()\n               .map(Race::toString)\n-              .collect(Collectors.joining(\",\")));\n+              .collect(Collectors.joining(\",\\n\")));\n       row.setEthnicity(\n           Optional.ofNullable(demo.getEthnicityEnum()).map(Ethnicity::toString).orElse(\"\"));\n       row.setGenderIdentity(\n           Optional.ofNullable(demo.getGenderIdentityEnumList()).orElse(ImmutableList.of()).stream()\n               .map(GenderIdentity::toString)\n-              .collect(Collectors.joining(\",\")));\n+              .collect(Collectors.joining(\",\\n\")));\n       row.setIdentifyAsLgbtq(\n           Optional.ofNullable(demo.getIdentifiesAsLgbtq()).map(this::toYesNo).orElse(\"\"));\n       row.setLgbtqIdentity(Optional.ofNullable(demo.getLgbtqIdentity()).orElse(\"\"));\n       row.setSexAtBirth(\n           Optional.ofNullable(demo.getSexAtBirthEnum()).orElse(ImmutableList.of()).stream()\n               .map(SexAtBirth::toString)\n-              .collect(Collectors.joining(\",\")));\n+              .collect(Collectors.joining(\",\\n\")));\n       row.setYearOfBirth(\n           Optional.ofNullable(demo.getYear_of_birth())\n               .filter(i -> i > 0)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA3ODgyMQ==", "url": "https://github.com/all-of-us/workbench/pull/3848#discussion_r466078821", "bodyText": "nit: i think you can just move this object into the conditional and drop the null check", "author": "ericsong", "createdAt": "2020-08-06T00:36:22Z", "path": "api/tools/src/main/java/org/pmiops/workbench/tools/ExportWorkspaceData.java", "diffHunk": "@@ -269,6 +297,39 @@ private WorkspaceExportRow toWorkspaceExportRow(DbUser user) {\n             .map(dateFormat::format)\n             .orElse(\"\"));\n     row.setCreatorRegistrationState(user.getDataAccessLevelEnum().toString());\n+    row.setDegrees(\n+        Optional.ofNullable(user.getDegreesEnum()).orElse(ImmutableList.of()).stream()\n+            .map(Degree::toString)\n+            .collect(Collectors.joining(\",\")));\n+    DbDemographicSurvey demo = user.getDemographicSurvey();", "originalCommit": "0a5de14b47872f6e23fa18f6defae80d43681b2e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjE2NTMyNQ==", "url": "https://github.com/all-of-us/workbench/pull/3848#discussion_r466165325", "bodyText": "includeDemographics is driven by a flag - not null'ness of the demographics value. So this doesn't work - unless I'm misunderstanding the suggestion.", "author": "calbach", "createdAt": "2020-08-06T06:03:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA3ODgyMQ=="}], "type": "inlineReview", "revised_code": {"commit": "1807fd9d8d9b163b981ebe599df43be1d338551f", "chunk": "diff --git a/api/tools/src/main/java/org/pmiops/workbench/tools/ExportWorkspaceData.java b/api/tools/src/main/java/org/pmiops/workbench/tools/ExportWorkspaceData.java\nindex e9df15cda..6caa4d366 100644\n--- a/api/tools/src/main/java/org/pmiops/workbench/tools/ExportWorkspaceData.java\n+++ b/api/tools/src/main/java/org/pmiops/workbench/tools/ExportWorkspaceData.java\n\n@@ -300,26 +300,26 @@ public class ExportWorkspaceData {\n     row.setDegrees(\n         Optional.ofNullable(user.getDegreesEnum()).orElse(ImmutableList.of()).stream()\n             .map(Degree::toString)\n-            .collect(Collectors.joining(\",\")));\n+            .collect(Collectors.joining(\",\\n\")));\n     DbDemographicSurvey demo = user.getDemographicSurvey();\n     if (includeDemographics && demo != null) {\n       row.setRace(\n           Optional.ofNullable(demo.getRaceEnum()).orElse(ImmutableList.of()).stream()\n               .map(Race::toString)\n-              .collect(Collectors.joining(\",\")));\n+              .collect(Collectors.joining(\",\\n\")));\n       row.setEthnicity(\n           Optional.ofNullable(demo.getEthnicityEnum()).map(Ethnicity::toString).orElse(\"\"));\n       row.setGenderIdentity(\n           Optional.ofNullable(demo.getGenderIdentityEnumList()).orElse(ImmutableList.of()).stream()\n               .map(GenderIdentity::toString)\n-              .collect(Collectors.joining(\",\")));\n+              .collect(Collectors.joining(\",\\n\")));\n       row.setIdentifyAsLgbtq(\n           Optional.ofNullable(demo.getIdentifiesAsLgbtq()).map(this::toYesNo).orElse(\"\"));\n       row.setLgbtqIdentity(Optional.ofNullable(demo.getLgbtqIdentity()).orElse(\"\"));\n       row.setSexAtBirth(\n           Optional.ofNullable(demo.getSexAtBirthEnum()).orElse(ImmutableList.of()).stream()\n               .map(SexAtBirth::toString)\n-              .collect(Collectors.joining(\",\")));\n+              .collect(Collectors.joining(\",\\n\")));\n       row.setYearOfBirth(\n           Optional.ofNullable(demo.getYear_of_birth())\n               .filter(i -> i > 0)\n"}}, {"oid": "1807fd9d8d9b163b981ebe599df43be1d338551f", "url": "https://github.com/all-of-us/workbench/commit/1807fd9d8d9b163b981ebe599df43be1d338551f", "message": "newlines", "committedDate": "2020-08-06T06:10:02Z", "type": "commit"}]}