{"pr_number": 4373, "pr_title": "[RW-6021][risk=low] Pulling workspace free tier usage into reporting", "pr_createdAt": "2020-12-08T01:54:06Z", "pr_url": "https://github.com/all-of-us/workbench/pull/4373", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzk3Mzc5MQ==", "url": "https://github.com/all-of-us/workbench/pull/4373#discussion_r537973791", "bodyText": "I was using left outer join elsewhere, but this may be the same difference.", "author": "jaycarlton", "createdAt": "2020-12-08T01:57:57Z", "path": "api/src/main/java/org/pmiops/workbench/db/dao/WorkspaceDao.java", "diffHunk": "@@ -122,8 +122,10 @@ default void updateBillingStatus(long workspaceId, BillingStatus status) {\n           + \"  w.scientificApproach AS rpScientificApproach,\\n\"\n           + \"  w.socialBehavioral AS rpSocialBehavioral,\\n\"\n           + \"  w.timeRequested AS rpTimeRequested,\\n\"\n-          + \"  w.workspaceId\\n\"\n+          + \"  w.workspaceId,\\n\"\n+          + \"  ft.cost as freeTierBillingUsage\\n\"\n           + \"FROM DbWorkspace w\\n\"\n+          + \"LEFT JOIN w.freeTierUsage ft\\n\"", "originalCommit": "e47437d6e4c6a5f64084ffc3445c1e9c9602ab0a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2a1b57c002e36d04d8883992e5d54ff9969dddd1", "chunk": "diff --git a/api/src/main/java/org/pmiops/workbench/db/dao/WorkspaceDao.java b/api/src/main/java/org/pmiops/workbench/db/dao/WorkspaceDao.java\nindex 51fe150ff..7ad739da7 100644\n--- a/api/src/main/java/org/pmiops/workbench/db/dao/WorkspaceDao.java\n+++ b/api/src/main/java/org/pmiops/workbench/db/dao/WorkspaceDao.java\n\n@@ -86,46 +85,4 @@ public interface WorkspaceDao extends CrudRepository<DbWorkspace, Long> {\n \n     Long getWorkspaceCount();\n   }\n-\n-  @Query(\n-      \"SELECT\\n\"\n-          + \"  w.billingAccountType,\\n\"\n-          + \"  w.billingStatus,\\n\"\n-          + \"  w.cdrVersion.cdrVersionId AS cdrVersionId,\\n\"\n-          + \"  w.creationTime,\\n\"\n-          + \"  w.creator.userId AS creatorId,\\n\"\n-          + \"  w.disseminateResearchOther,\\n\"\n-          + \"  w.lastAccessedTime,\\n\"\n-          + \"  w.lastModifiedTime,\\n\"\n-          + \"  w.name,\\n\"\n-          + \"  w.needsResearchPurposeReviewPrompt AS needsRpReviewPrompt,\\n\"\n-          + \"  w.published,\\n\"\n-          + \"  w.additionalNotes AS rpAdditionalNotes,\\n\"\n-          + \"  w.ancestry AS rpAncestry,\\n\"\n-          + \"  w.anticipatedFindings AS rpAnticipatedFindings,\\n\"\n-          + \"  w.approved AS rpApproved,\\n\"\n-          + \"  w.commercialPurpose AS rpCommercialPurpose,\\n\"\n-          + \"  w.controlSet AS rpControlSet,\\n\"\n-          + \"  w.diseaseFocusedResearch AS rpDiseaseFocusedResearch,\\n\"\n-          + \"  w.diseaseOfFocus AS rpDiseaseOfFocus,\\n\"\n-          + \"  w.drugDevelopment AS rpDrugDevelopment,\\n\"\n-          + \"  w.educational AS rpEducational,\\n\"\n-          + \"  w.ethics AS rpEthics,\\n\"\n-          + \"  w.intendedStudy AS rpIntendedStudy,\\n\"\n-          + \"  w.methodsDevelopment AS rpMethodsDevelopment,\\n\"\n-          + \"  w.otherPopulationDetails AS rpOtherPopulationDetails,\\n\"\n-          + \"  w.otherPurpose AS rpOtherPurpose,\\n\"\n-          + \"  w.otherPurposeDetails AS rpOtherPurposeDetails,\\n\"\n-          + \"  w.populationHealth AS rpPopulationHealth,\\n\"\n-          + \"  w.reasonForAllOfUs AS rpReasonForAllOfUs,\\n\"\n-          + \"  w.reviewRequested AS rpReviewRequested,\\n\"\n-          + \"  w.scientificApproach AS rpScientificApproach,\\n\"\n-          + \"  w.socialBehavioral AS rpSocialBehavioral,\\n\"\n-          + \"  w.timeRequested AS rpTimeRequested,\\n\"\n-          + \"  w.workspaceId,\\n\"\n-          + \"  ft.cost as freeTierBillingUsage\\n\"\n-          + \"FROM DbWorkspace w\\n\"\n-          + \"LEFT JOIN w.freeTierUsage ft\\n\"\n-          + \"WHERE w.activeStatus = 0\")\n-  List<ProjectedReportingWorkspace> getReportingWorkspaces();\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzk3NDI4OQ==", "url": "https://github.com/all-of-us/workbench/pull/4373#discussion_r537974289", "bodyText": "These classes are deprecated in favor of direct queries and RowMappers, but go ahead and use them since you're outrunning me.", "author": "jaycarlton", "createdAt": "2020-12-08T01:59:19Z", "path": "api/src/main/java/org/pmiops/workbench/db/dao/projection/ProjectedReportingWorkspace.java", "diffHunk": "@@ -72,4 +72,6 @@\n   Timestamp getRpTimeRequested();\n \n   Long getWorkspaceId();\n+\n+  Double getFreeTierBillingUsage();", "originalCommit": "e47437d6e4c6a5f64084ffc3445c1e9c9602ab0a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2a1b57c002e36d04d8883992e5d54ff9969dddd1", "chunk": "diff --git a/api/src/main/java/org/pmiops/workbench/db/dao/projection/ProjectedReportingWorkspace.java b/api/src/main/java/org/pmiops/workbench/db/dao/projection/ProjectedReportingWorkspace.java\ndeleted file mode 100644\nindex 7ebbb8de5..000000000\n--- a/api/src/main/java/org/pmiops/workbench/db/dao/projection/ProjectedReportingWorkspace.java\n+++ /dev/null\n\n@@ -1,77 +0,0 @@\n-package org.pmiops.workbench.db.dao.projection;\n-\n-import java.sql.Timestamp;\n-import org.pmiops.workbench.model.BillingAccountType;\n-import org.pmiops.workbench.model.BillingStatus;\n-\n-public interface ProjectedReportingWorkspace {\n-  BillingAccountType getBillingAccountType();\n-\n-  BillingStatus getBillingStatus();\n-\n-  Long getCdrVersionId();\n-\n-  Timestamp getCreationTime();\n-\n-  Long getCreatorId();\n-\n-  String getDisseminateResearchOther();\n-\n-  Timestamp getLastAccessedTime();\n-\n-  Timestamp getLastModifiedTime();\n-\n-  String getName();\n-\n-  Short getNeedsRpReviewPrompt();\n-\n-  Boolean getPublished();\n-\n-  String getRpAdditionalNotes();\n-\n-  Boolean getRpAncestry();\n-\n-  String getRpAnticipatedFindings();\n-\n-  Boolean getRpApproved();\n-\n-  Boolean getRpCommercialPurpose();\n-\n-  Boolean getRpControlSet();\n-\n-  Boolean getRpDiseaseFocusedResearch();\n-\n-  String getRpDiseaseOfFocus();\n-\n-  Boolean getRpDrugDevelopment();\n-\n-  Boolean getRpEducational();\n-\n-  Boolean getRpEthics();\n-\n-  String getRpIntendedStudy();\n-\n-  Boolean getRpMethodsDevelopment();\n-\n-  String getRpOtherPopulationDetails();\n-\n-  Boolean getRpOtherPurpose();\n-\n-  String getRpOtherPurposeDetails();\n-\n-  Boolean getRpPopulationHealth();\n-\n-  String getRpReasonForAllOfUs();\n-\n-  Boolean getRpReviewRequested();\n-\n-  String getRpScientificApproach();\n-\n-  Boolean getRpSocialBehavioral();\n-\n-  Timestamp getRpTimeRequested();\n-\n-  Long getWorkspaceId();\n-\n-  Double getFreeTierBillingUsage();\n-}\n"}}, {"oid": "bdc4ea4f58ae3e3b248882b746559bee7169b722", "url": "https://github.com/all-of-us/workbench/commit/bdc4ea4f58ae3e3b248882b746559bee7169b722", "message": "Extract, type fix, test", "committedDate": "2020-12-09T00:49:36Z", "type": "forcePushed"}, {"oid": "2a1b57c002e36d04d8883992e5d54ff9969dddd1", "url": "https://github.com/all-of-us/workbench/commit/2a1b57c002e36d04d8883992e5d54ff9969dddd1", "message": "Try pulling free tier usage into reporting", "committedDate": "2021-01-06T01:20:35Z", "type": "commit"}, {"oid": "817ee723f3b615e6dfaca50552818242887c5791", "url": "https://github.com/all-of-us/workbench/commit/817ee723f3b615e6dfaca50552818242887c5791", "message": "Extract, type fix, test", "committedDate": "2021-01-06T01:21:18Z", "type": "commit"}, {"oid": "d48c8e719a20682d1f92f2916723140eb89ab621", "url": "https://github.com/all-of-us/workbench/commit/d48c8e719a20682d1f92f2916723140eb89ab621", "message": ":facepalm:", "committedDate": "2021-01-06T01:21:18Z", "type": "commit"}, {"oid": "63097f6ee1658a4c18f749e58deadf7d5144c49c", "url": "https://github.com/all-of-us/workbench/commit/63097f6ee1658a4c18f749e58deadf7d5144c49c", "message": "Test fixes", "committedDate": "2021-01-06T01:21:36Z", "type": "commit"}, {"oid": "bf4e97746dcb09fc637f62561dbc119f731a33bd", "url": "https://github.com/all-of-us/workbench/commit/bf4e97746dcb09fc637f62561dbc119f731a33bd", "message": "Switch to separate table", "committedDate": "2021-01-06T02:23:12Z", "type": "commit"}, {"oid": "bf4e97746dcb09fc637f62561dbc119f731a33bd", "url": "https://github.com/all-of-us/workbench/commit/bf4e97746dcb09fc637f62561dbc119f731a33bd", "message": "Switch to separate table", "committedDate": "2021-01-06T02:23:12Z", "type": "forcePushed"}, {"oid": "41adae004bcf11cb582f9355d8471414aa433f79", "url": "https://github.com/all-of-us/workbench/commit/41adae004bcf11cb582f9355d8471414aa433f79", "message": "More revets", "committedDate": "2021-01-06T02:24:33Z", "type": "commit"}, {"oid": "55b2b30a0adbeb6183e09d0d3daf98beed22eb00", "url": "https://github.com/all-of-us/workbench/commit/55b2b30a0adbeb6183e09d0d3daf98beed22eb00", "message": "in USD", "committedDate": "2021-01-07T00:24:02Z", "type": "commit"}, {"oid": "9b4c961dc2ea4c58896c44bc11f2d3a7c5972ca8", "url": "https://github.com/all-of-us/workbench/commit/9b4c961dc2ea4c58896c44bc11f2d3a7c5972ca8", "message": "Way more touchpoints", "committedDate": "2021-01-07T20:00:25Z", "type": "commit"}, {"oid": "55013bdd2b1159a14efd8bc8da2e29e4edc274f8", "url": "https://github.com/all-of-us/workbench/commit/55013bdd2b1159a14efd8bc8da2e29e4edc274f8", "message": "Test fix", "committedDate": "2021-01-07T20:32:55Z", "type": "commit"}]}