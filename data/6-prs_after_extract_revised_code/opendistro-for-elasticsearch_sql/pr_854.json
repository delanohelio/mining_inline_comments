{"pr_number": 854, "pr_title": "Add JDBC formatter in new SQL engine", "pr_createdAt": "2020-11-25T00:01:56Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/sql/pull/854", "timeline": [{"oid": "a4dae1fe140750697eda9b4d4dbb20ad05ce5c5d", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/a4dae1fe140750697eda9b4d4dbb20ad05ce5c5d", "message": "Add jdbc formatter", "committedDate": "2020-11-13T01:16:15Z", "type": "commit"}, {"oid": "04e905679bde9a04b6712987e51673559cb14413", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/04e905679bde9a04b6712987e51673559cb14413", "message": "Merge branch 'develop' into add-jdbc-formatter-in-new-engine", "committedDate": "2020-11-21T00:19:33Z", "type": "commit"}, {"oid": "3ff1a6a7f95c4e3baec51e7e8c2e720601023f98", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/3ff1a6a7f95c4e3baec51e7e8c2e720601023f98", "message": "Add error response format method", "committedDate": "2020-11-21T00:37:07Z", "type": "commit"}, {"oid": "a88a2ecee2ef4d15dfdeec3627965461d88b80a9", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/a88a2ecee2ef4d15dfdeec3627965461d88b80a9", "message": "Add java doc", "committedDate": "2020-11-23T18:46:34Z", "type": "commit"}, {"oid": "eb959a88462e8ed0bb8c642024f5c1c9b47b3c36", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/eb959a88462e8ed0bb8c642024f5c1c9b47b3c36", "message": "Convert type to lower case", "committedDate": "2020-11-23T19:03:51Z", "type": "commit"}, {"oid": "40502874c00b562683b1dada925376cf8c89d610", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/40502874c00b562683b1dada925376cf8c89d610", "message": "Enable branch coverage and pass jacoco", "committedDate": "2020-11-23T19:29:36Z", "type": "commit"}, {"oid": "a1c237b3983f3edf0e2ac69599d00efd44767125", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/a1c237b3983f3edf0e2ac69599d00efd44767125", "message": "Remove version for now", "committedDate": "2020-11-23T23:02:53Z", "type": "commit"}, {"oid": "dd41b79eababac86f2df75e83652a76997c24e3f", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/dd41b79eababac86f2df75e83652a76997c24e3f", "message": "Fix broken ITs", "committedDate": "2020-11-23T23:13:14Z", "type": "commit"}, {"oid": "f7670710caa1c7ccec8e34f13caebdc4ad161142", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/f7670710caa1c7ccec8e34f13caebdc4ad161142", "message": "Change error code to 503", "committedDate": "2020-11-24T18:54:11Z", "type": "commit"}, {"oid": "a090ace712d347c209bbe2263352dcd1f6f2acf6", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/a090ace712d347c209bbe2263352dcd1f6f2acf6", "message": "Add back legcy ITs", "committedDate": "2020-11-24T21:59:34Z", "type": "commit"}, {"oid": "f862215369df74c8d502488e0c5e2be2815a2c2f", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/f862215369df74c8d502488e0c5e2be2815a2c2f", "message": "Convert all legacy types", "committedDate": "2020-11-24T23:05:28Z", "type": "commit"}, {"oid": "dad8736d664aa5fc5cfc1a12875faca17c441d19", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/dad8736d664aa5fc5cfc1a12875faca17c441d19", "message": "Add IT", "committedDate": "2020-11-24T23:30:42Z", "type": "commit"}, {"oid": "11df761d4408cf0b490f3c2d61d4962c4c86cb8e", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/11df761d4408cf0b490f3c2d61d4962c4c86cb8e", "message": "Prepare PR", "committedDate": "2020-11-25T00:01:08Z", "type": "commit"}, {"oid": "b48a5443f131e40ce88d9550633bb2ee338ab864", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/b48a5443f131e40ce88d9550633bb2ee338ab864", "message": "Prepare PR", "committedDate": "2020-11-25T00:47:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDY0MjgwNw==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/854#discussion_r530642807", "bodyText": "How to handle the missing value?", "author": "penghuo", "createdAt": "2020-11-25T21:06:58Z", "path": "protocol/src/test/java/com/amazon/opendistroforelasticsearch/sql/protocol/response/format/JdbcResponseFormatterTest.java", "diffHunk": "@@ -0,0 +1,121 @@\n+/*\n+ *    Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *    Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *    You may not use this file except in compliance with the License.\n+ *    A copy of the License is located at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *    or in the \"license\" file accompanying this file. This file is distributed\n+ *    on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *    express or implied. See the License for the specific language governing\n+ *    permissions and limitations under the License.\n+ *\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.protocol.response.format;\n+\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprValueUtils.tupleValue;\n+import static com.amazon.opendistroforelasticsearch.sql.data.type.ExprCoreType.ARRAY;\n+import static com.amazon.opendistroforelasticsearch.sql.data.type.ExprCoreType.INTEGER;\n+import static com.amazon.opendistroforelasticsearch.sql.data.type.ExprCoreType.STRING;\n+import static com.amazon.opendistroforelasticsearch.sql.data.type.ExprCoreType.STRUCT;\n+import static com.amazon.opendistroforelasticsearch.sql.elasticsearch.data.type.ElasticsearchDataType.ES_TEXT;\n+import static com.amazon.opendistroforelasticsearch.sql.elasticsearch.data.type.ElasticsearchDataType.ES_TEXT_KEYWORD;\n+import static com.amazon.opendistroforelasticsearch.sql.executor.ExecutionEngine.Schema;\n+import static com.amazon.opendistroforelasticsearch.sql.executor.ExecutionEngine.Schema.Column;\n+import static com.amazon.opendistroforelasticsearch.sql.protocol.response.format.JsonResponseFormatter.Style.COMPACT;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+\n+import com.amazon.opendistroforelasticsearch.sql.common.antlr.SyntaxCheckException;\n+import com.amazon.opendistroforelasticsearch.sql.exception.SemanticCheckException;\n+import com.amazon.opendistroforelasticsearch.sql.protocol.response.QueryResult;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableMap;\n+import com.google.gson.JsonParser;\n+import org.junit.jupiter.api.Test;\n+\n+class JdbcResponseFormatterTest {\n+\n+  private final JdbcResponseFormatter formatter = new JdbcResponseFormatter(COMPACT);\n+\n+  @Test\n+  void format_response() {\n+    QueryResult response = new QueryResult(\n+        new Schema(ImmutableList.of(\n+            new Column(\"name\", \"name\", STRING),\n+            new Column(\"address1\", \"address1\", ES_TEXT),\n+            new Column(\"address2\", \"address2\", ES_TEXT_KEYWORD),\n+            new Column(\"location\", \"location\", STRUCT),\n+            new Column(\"employer\", \"employer\", ARRAY),\n+            new Column(\"age\", \"age\", INTEGER))),\n+        ImmutableList.of(\n+            tupleValue(ImmutableMap.of(\"name\", \"John\", \"age\", 20))));\n+\n+    assertJsonEquals(\n+        \"{\"\n+            + \"\\\"schema\\\":[\"\n+            + \"{\\\"name\\\":\\\"name\\\",\\\"alias\\\":\\\"name\\\",\\\"type\\\":\\\"keyword\\\"},\"\n+            + \"{\\\"name\\\":\\\"address1\\\",\\\"alias\\\":\\\"address1\\\",\\\"type\\\":\\\"text\\\"},\"\n+            + \"{\\\"name\\\":\\\"address2\\\",\\\"alias\\\":\\\"address2\\\",\\\"type\\\":\\\"text\\\"},\"\n+            + \"{\\\"name\\\":\\\"location\\\",\\\"alias\\\":\\\"location\\\",\\\"type\\\":\\\"object\\\"},\"\n+            + \"{\\\"name\\\":\\\"employer\\\",\\\"alias\\\":\\\"employer\\\",\\\"type\\\":\\\"nested\\\"},\"\n+            + \"{\\\"name\\\":\\\"age\\\",\\\"alias\\\":\\\"age\\\",\\\"type\\\":\\\"integer\\\"}\"\n+            + \"],\"\n+            + \"\\\"datarows\\\":[[\\\"John\\\",20]],\"", "originalCommit": "b48a5443f131e40ce88d9550633bb2ee338ab864", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDY3MDA2MQ==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/854#discussion_r530670061", "bodyText": "I missed other columns here. Will add and check other formatter's UT. Thanks!", "author": "dai-chen", "createdAt": "2020-11-25T22:16:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDY0MjgwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDcwNDI1Mw==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/854#discussion_r530704253", "bodyText": "Fixed this mismatch and added another case for missing and null value.", "author": "dai-chen", "createdAt": "2020-11-26T00:17:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDY0MjgwNw=="}], "type": "inlineReview", "revised_code": {"commit": "3d6fbd31980b399c0dc537b59146e6f2974969c7", "chunk": "diff --git a/protocol/src/test/java/com/amazon/opendistroforelasticsearch/sql/protocol/response/format/JdbcResponseFormatterTest.java b/protocol/src/test/java/com/amazon/opendistroforelasticsearch/sql/protocol/response/format/JdbcResponseFormatterTest.java\nindex f3bb697f..6d2946e0 100644\n--- a/protocol/src/test/java/com/amazon/opendistroforelasticsearch/sql/protocol/response/format/JdbcResponseFormatterTest.java\n+++ b/protocol/src/test/java/com/amazon/opendistroforelasticsearch/sql/protocol/response/format/JdbcResponseFormatterTest.java\n\n@@ -16,6 +16,9 @@\n \n package com.amazon.opendistroforelasticsearch.sql.protocol.response.format;\n \n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprValueUtils.LITERAL_MISSING;\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprValueUtils.LITERAL_NULL;\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprValueUtils.stringValue;\n import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprValueUtils.tupleValue;\n import static com.amazon.opendistroforelasticsearch.sql.data.type.ExprCoreType.ARRAY;\n import static com.amazon.opendistroforelasticsearch.sql.data.type.ExprCoreType.INTEGER;\n"}}, {"oid": "e05cd8f16fe54e01d67a1b200aea9de604630bd3", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/e05cd8f16fe54e01d67a1b200aea9de604630bd3", "message": "Merge branch 'develop' into add-jdbc-formatter-in-new-engine", "committedDate": "2020-11-25T22:34:17Z", "type": "commit"}, {"oid": "3d6fbd31980b399c0dc537b59146e6f2974969c7", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/3d6fbd31980b399c0dc537b59146e6f2974969c7", "message": "Address PR comment", "committedDate": "2020-11-26T00:13:12Z", "type": "commit"}, {"oid": "3e516d4ca78f4068d61cffb007ac4fffe5e560ab", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/3e516d4ca78f4068d61cffb007ac4fffe5e560ab", "message": "Merge branch 'develop' into add-jdbc-formatter-in-new-engine", "committedDate": "2020-11-26T01:25:58Z", "type": "commit"}, {"oid": "c403c0bbaba852398cfd27b5e573803dffc7b9c6", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/c403c0bbaba852398cfd27b5e573803dffc7b9c6", "message": "Remove valueMap", "committedDate": "2020-11-26T01:27:50Z", "type": "commit"}, {"oid": "f6e3ad388f6b1e1dc53179e47e1f51518e3e1532", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/f6e3ad388f6b1e1dc53179e47e1f51518e3e1532", "message": "Merge branch 'develop' into add-jdbc-formatter-in-new-engine", "committedDate": "2020-12-01T21:22:36Z", "type": "commit"}]}