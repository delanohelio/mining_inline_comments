{"pr_number": 913, "pr_title": "add fix to handle functions applied to literal ", "pr_createdAt": "2020-12-10T23:24:33Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/sql/pull/913", "timeline": [{"oid": "7f9af23a24b69e7c59a37803eb06d5336daf448c", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/7f9af23a24b69e7c59a37803eb06d5336daf448c", "message": "add functions with literal", "committedDate": "2020-12-10T22:24:13Z", "type": "commit"}, {"oid": "0260ffa4b77389e0fc165a06242a7c7aadb1c41e", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/0260ffa4b77389e0fc165a06242a7c7aadb1c41e", "message": "Merge branch 'develop' of https://github.com/rupal-bq/sql into sql-having-clause-issue", "committedDate": "2020-12-10T23:56:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEzNjU1Ng==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/913#discussion_r541136556", "bodyText": "I think we need to check this recursively, ex. ABS(ABS(age)). Could we merge isNonLiteral() to this method as base case for recursion?", "author": "dai-chen", "createdAt": "2020-12-11T18:15:25Z", "path": "sql/src/main/java/com/amazon/opendistroforelasticsearch/sql/sql/parser/AstAggregationBuilder.java", "diffHunk": "@@ -137,6 +139,15 @@ private boolean isNonLiteral(UnresolvedExpression expr) {\n     return !(expr instanceof Literal);\n   }\n \n+  private boolean isNonLiteralFunction(UnresolvedExpression expr) {\n+    if (expr instanceof Function) {\n+      List<? extends Node> children = expr.getChild();\n+      return children.stream()\n+              .allMatch(child -> isNonLiteral((UnresolvedExpression) child));", "originalCommit": "0260ffa4b77389e0fc165a06242a7c7aadb1c41e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTE1OTI4NQ==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/913#discussion_r541159285", "bodyText": "right, I will add.", "author": "rupal-bq", "createdAt": "2020-12-11T18:55:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEzNjU1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQ3NjQzNQ==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/913#discussion_r541476435", "bodyText": "added this change.", "author": "rupal-bq", "createdAt": "2020-12-12T02:09:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEzNjU1Ng=="}], "type": "inlineReview", "revised_code": {"commit": "41e9d7391abf1f2cdf8d38a4f6fe1a8b880a02b2", "chunk": "diff --git a/sql/src/main/java/com/amazon/opendistroforelasticsearch/sql/sql/parser/AstAggregationBuilder.java b/sql/src/main/java/com/amazon/opendistroforelasticsearch/sql/sql/parser/AstAggregationBuilder.java\nindex 77213002..235774f5 100644\n--- a/sql/src/main/java/com/amazon/opendistroforelasticsearch/sql/sql/parser/AstAggregationBuilder.java\n+++ b/sql/src/main/java/com/amazon/opendistroforelasticsearch/sql/sql/parser/AstAggregationBuilder.java\n\n@@ -140,10 +140,18 @@ public class AstAggregationBuilder extends OpenDistroSQLParserBaseVisitor<Unreso\n   }\n \n   private boolean isNonLiteralFunction(UnresolvedExpression expr) {\n+    // The base case for recursion\n+    if (expr instanceof Literal) {\n+      return false;\n+    }\n     if (expr instanceof Function) {\n       List<? extends Node> children = expr.getChild();\n-      return children.stream()\n-              .allMatch(child -> isNonLiteral((UnresolvedExpression) child));\n+      // The base case for functions without input. e.g. PI(), NOW(), etc.\n+      if (children.isEmpty()) {\n+        return false;\n+      }\n+      return children.stream().anyMatch(child ->\n+              isNonLiteralFunction((UnresolvedExpression) child));\n     }\n     return true;\n   }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTE0MDk4MA==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/913#discussion_r541140980", "bodyText": "Could you add some more test queries as comparison test for this issue in https://github.com/opendistro-for-elasticsearch/sql/tree/develop/integ-test/src/test/resources/correctness/bugfixes", "author": "dai-chen", "createdAt": "2020-12-11T18:23:25Z", "path": "integ-test/src/test/java/com/amazon/opendistroforelasticsearch/sql/sql/DateTimeFunctionIT.java", "diffHunk": "@@ -60,6 +60,15 @@ public void testDateInGroupBy() throws IOException{\n             rows(\"2018-08-11\"));\n   }\n \n+  @Test\n+  public void testDateWithHavingClauseOnly() throws IOException {", "originalCommit": "0260ffa4b77389e0fc165a06242a7c7aadb1c41e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTE1ODg0MQ==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/913#discussion_r541158841", "bodyText": "Sure, I will add queries without the date function.", "author": "rupal-bq", "createdAt": "2020-12-11T18:54:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTE0MDk4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQ3NjkwOQ==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/913#discussion_r541476909", "bodyText": "I added a few tests in comparison but while testing function without input PI() the results returned but another database was different (3.15 instead of 3.141592653589793) so I added manual IT for this.", "author": "rupal-bq", "createdAt": "2020-12-12T02:12:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTE0MDk4MA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "41e9d7391abf1f2cdf8d38a4f6fe1a8b880a02b2", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/41e9d7391abf1f2cdf8d38a4f6fe1a8b880a02b2", "message": "address PR comments", "committedDate": "2020-12-12T01:52:19Z", "type": "commit"}, {"oid": "b3b8282cbd9c5c90a409a68c5156604f1eac9e69", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/b3b8282cbd9c5c90a409a68c5156604f1eac9e69", "message": "remove unnecessary check. anyMatch returns false for empty list.", "committedDate": "2020-12-12T01:58:37Z", "type": "commit"}, {"oid": "5dace04d726b646cd9530b66c928be1c8e501754", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/5dace04d726b646cd9530b66c928be1c8e501754", "message": "remove isNonLiteral()", "committedDate": "2020-12-14T18:28:53Z", "type": "commit"}]}