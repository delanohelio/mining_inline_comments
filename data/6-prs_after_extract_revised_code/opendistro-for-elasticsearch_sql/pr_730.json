{"pr_number": 730, "pr_title": "Aggregation expression pushdown", "pr_createdAt": "2020-09-05T04:44:22Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/sql/pull/730", "timeline": [{"oid": "a3505c683be83e11f9a8647e491f0cfc5ff88377", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/a3505c683be83e11f9a8647e491f0cfc5ff88377", "message": "update", "committedDate": "2020-09-03T14:54:54Z", "type": "commit"}, {"oid": "fa36031139d28192d88bcf32c3c4cb0a10aa0c7a", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/fa36031139d28192d88bcf32c3c4cb0a10aa0c7a", "message": "update", "committedDate": "2020-09-03T14:55:08Z", "type": "commit"}, {"oid": "8b73ba01b9511daaabdc0296f76a3000fa96ca23", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/8b73ba01b9511daaabdc0296f76a3000fa96ca23", "message": "update", "committedDate": "2020-09-04T06:16:48Z", "type": "commit"}, {"oid": "6153132a380efc3b8a683c65e53ea87140a110cd", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/6153132a380efc3b8a683c65e53ea87140a110cd", "message": "update", "committedDate": "2020-09-05T01:06:29Z", "type": "commit"}, {"oid": "70352ac613569fe16eb16498cab1695d45092fdb", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/70352ac613569fe16eb16498cab1695d45092fdb", "message": "update", "committedDate": "2020-09-05T01:38:13Z", "type": "commit"}, {"oid": "d187b4dfbe1bd703c5b761ae3aab96bd650cfd37", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/d187b4dfbe1bd703c5b761ae3aab96bd650cfd37", "message": "update", "committedDate": "2020-09-05T04:36:13Z", "type": "commit"}, {"oid": "e6be0eb39a9772a8b155612b8cc88477141a7309", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/e6be0eb39a9772a8b155612b8cc88477141a7309", "message": "update", "committedDate": "2020-09-08T17:52:38Z", "type": "commit"}, {"oid": "cef95b50c70b7c1e88be90561c436053bc22278c", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/cef95b50c70b7c1e88be90561c436053bc22278c", "message": "update", "committedDate": "2020-09-08T21:16:22Z", "type": "commit"}, {"oid": "85eb68b2ce2839521cc85db8a677190f9438400a", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/85eb68b2ce2839521cc85db8a677190f9438400a", "message": "merge from develop", "committedDate": "2020-09-08T22:35:03Z", "type": "commit"}, {"oid": "7e89512a3a031e5201c70e20ff7ab2b73559f99d", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/7e89512a3a031e5201c70e20ff7ab2b73559f99d", "message": "support SQL use cases", "committedDate": "2020-09-09T21:59:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY4ODA5NA==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/730#discussion_r486688094", "bodyText": "np: same as AstBuilder.getTextInQuery() and can move to some parsing util class?", "author": "dai-chen", "createdAt": "2020-09-10T23:28:27Z", "path": "sql/src/main/java/com/amazon/opendistroforelasticsearch/sql/sql/parser/context/QuerySpecification.java", "diffHunk": "@@ -117,13 +125,22 @@ public Void visitGroupByElement(GroupByElementContext ctx) {\n \n     @Override\n     public Void visitAggregateFunctionCall(AggregateFunctionCallContext ctx) {\n-      aggregators.add((AggregateFunction) visitAstExpression(ctx));\n+      aggregators.add(AstDSL.alias(getTextInQuery(ctx), visitAstExpression(ctx)));\n       return super.visitAggregateFunctionCall(ctx);\n     }\n \n     private UnresolvedExpression visitAstExpression(ParseTree tree) {\n       return expressionBuilder.visit(tree);\n     }\n+\n+    /**\n+     * Get original text in query.\n+     */\n+    private String getTextInQuery(ParserRuleContext ctx) {\n+      Token start = ctx.getStart();\n+      Token stop = ctx.getStop();\n+      return queryString.substring(start.getStartIndex(), stop.getStopIndex() + 1);\n+    }", "originalCommit": "7e89512a3a031e5201c70e20ff7ab2b73559f99d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzE2Njk3NQ==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/730#discussion_r487166975", "bodyText": "done.", "author": "penghuo", "createdAt": "2020-09-11T16:48:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY4ODA5NA=="}], "type": "inlineReview", "revised_code": {"commit": "0e72b835e7ba855a9102d9cfca7fab82c207f53a", "chunk": "diff --git a/sql/src/main/java/com/amazon/opendistroforelasticsearch/sql/sql/parser/context/QuerySpecification.java b/sql/src/main/java/com/amazon/opendistroforelasticsearch/sql/sql/parser/context/QuerySpecification.java\nindex 72e4c199..2b803bfb 100644\n--- a/sql/src/main/java/com/amazon/opendistroforelasticsearch/sql/sql/parser/context/QuerySpecification.java\n+++ b/sql/src/main/java/com/amazon/opendistroforelasticsearch/sql/sql/parser/context/QuerySpecification.java\n\n@@ -125,22 +126,13 @@ public class QuerySpecification {\n \n     @Override\n     public Void visitAggregateFunctionCall(AggregateFunctionCallContext ctx) {\n-      aggregators.add(AstDSL.alias(getTextInQuery(ctx), visitAstExpression(ctx)));\n+      aggregators.add(AstDSL.alias(getTextInQuery(ctx, queryString), visitAstExpression(ctx)));\n       return super.visitAggregateFunctionCall(ctx);\n     }\n \n     private UnresolvedExpression visitAstExpression(ParseTree tree) {\n       return expressionBuilder.visit(tree);\n     }\n-\n-    /**\n-     * Get original text in query.\n-     */\n-    private String getTextInQuery(ParserRuleContext ctx) {\n-      Token start = ctx.getStart();\n-      Token stop = ctx.getStop();\n-      return queryString.substring(start.getStartIndex(), stop.getStopIndex() + 1);\n-    }\n   }\n \n }\n"}}, {"oid": "0e72b835e7ba855a9102d9cfca7fab82c207f53a", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/0e72b835e7ba855a9102d9cfca7fab82c207f53a", "message": "address comments", "committedDate": "2020-09-11T15:12:00Z", "type": "commit"}]}