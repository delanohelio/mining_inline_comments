{"pr_number": 335, "pr_title": "Sql test bench", "pr_createdAt": "2020-01-06T21:56:27Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/sql/pull/335", "timeline": [{"oid": "cea903fa6c3bf30b7ed4cad33e47be120de85197", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/cea903fa6c3bf30b7ed4cad33e47be120de85197", "message": "Initial commit with clean code from PoC branch", "committedDate": "2019-12-13T01:14:40Z", "type": "commit"}, {"oid": "a69def24b8f53152d78c9456536300b24c6ea11f", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/a69def24b8f53152d78c9456536300b24c6ea11f", "message": "Refactor code", "committedDate": "2019-12-16T19:54:25Z", "type": "commit"}, {"oid": "34d951ce64e70f874a60af69962c94600c7d3288", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/34d951ce64e70f874a60af69962c94600c7d3288", "message": "Fix float number parse issue", "committedDate": "2019-12-17T01:30:21Z", "type": "commit"}, {"oid": "68655bbca1d979b6d8e4535dae1101b213a66c27", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/68655bbca1d979b6d8e4535dae1101b213a66c27", "message": "Fix sqlite memory db issue", "committedDate": "2019-12-19T01:41:23Z", "type": "commit"}, {"oid": "e3f06033b88315a8b28f4855e1ed431992b8b967", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/e3f06033b88315a8b28f4855e1ed431992b8b967", "message": "Save reports", "committedDate": "2019-12-19T18:51:38Z", "type": "commit"}, {"oid": "239ce2dc520d57de16a467124deeed3cb68e027f", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/239ce2dc520d57de16a467124deeed3cb68e027f", "message": "Handle date type", "committedDate": "2019-12-26T23:06:14Z", "type": "commit"}, {"oid": "fba4a6cec617ffe1a1bb08d09204b26c370b0630", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/fba4a6cec617ffe1a1bb08d09204b26c370b0630", "message": "Load ecommerce test data", "committedDate": "2019-12-30T21:57:07Z", "type": "commit"}, {"oid": "fb487716ebdb1dc5ed0d69824dceaba41a7c693b", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/fb487716ebdb1dc5ed0d69824dceaba41a7c693b", "message": "Refactor comparison test class", "committedDate": "2019-12-30T23:03:27Z", "type": "commit"}, {"oid": "e9c7e0f1adb0a29cce2f6cba32bd26adbc59679d", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/e9c7e0f1adb0a29cce2f6cba32bd26adbc59679d", "message": "Support command line args from gradlew", "committedDate": "2019-12-31T21:57:53Z", "type": "commit"}, {"oid": "2fcb8a69bbb137087c3deae794f16b0a4e994dd8", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/2fcb8a69bbb137087c3deae794f16b0a4e994dd8", "message": "Support command line args from gradlew", "committedDate": "2019-12-31T22:26:56Z", "type": "commit"}, {"oid": "e6b5df5e30b2fcccd785976468a4c3d12b543b3d", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/e6b5df5e30b2fcccd785976468a4c3d12b543b3d", "message": "Close connection", "committedDate": "2019-12-31T23:38:35Z", "type": "commit"}, {"oid": "bcfb680e980636d42c033ddc9cd54f4b4e60ca15", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/bcfb680e980636d42c033ddc9cd54f4b4e60ca15", "message": "Use ES rest client only", "committedDate": "2020-01-01T00:31:09Z", "type": "commit"}, {"oid": "5fc017f7761db2bb5fba547e3e343001eb3b848c", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/5fc017f7761db2bb5fba547e3e343001eb3b848c", "message": "Rename es host url argument", "committedDate": "2020-01-01T00:58:54Z", "type": "commit"}, {"oid": "08b77715e6b7b750ab41dd99694413a7002b8bcb", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/08b77715e6b7b750ab41dd99694413a7002b8bcb", "message": "Refactor test set", "committedDate": "2020-01-02T19:49:07Z", "type": "commit"}, {"oid": "d1e2aace53664655e4d40f00faadf6036bc68548", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/d1e2aace53664655e4d40f00faadf6036bc68548", "message": "Print log to console", "committedDate": "2020-01-02T22:21:51Z", "type": "commit"}, {"oid": "19d4d9fdfe8aca9a98c455fba7748db36ed882f8", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/19d4d9fdfe8aca9a98c455fba7748db36ed882f8", "message": "Add unit test for es connection", "committedDate": "2020-01-03T00:04:19Z", "type": "commit"}, {"oid": "a8cd0c1d60745eaf35a1d7bc98a6963686e6102c", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/a8cd0c1d60745eaf35a1d7bc98a6963686e6102c", "message": "Add unit test for jdbc connection", "committedDate": "2020-01-03T01:34:42Z", "type": "commit"}, {"oid": "2f0d672daf340f507a54ccb858f4986837e5c371", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/2f0d672daf340f507a54ccb858f4986837e5c371", "message": "Fix connect issue", "committedDate": "2020-01-03T19:14:30Z", "type": "commit"}, {"oid": "15deeef2b7e178224febb55575b6629ead23a799", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/15deeef2b7e178224febb55575b6629ead23a799", "message": "Add more unit test", "committedDate": "2020-01-03T19:50:21Z", "type": "commit"}, {"oid": "c3d6d38bc116fdf30d9e104c532b60b6a30874a0", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/c3d6d38bc116fdf30d9e104c532b60b6a30874a0", "message": "Refactor DBResult and Row", "committedDate": "2020-01-03T22:00:19Z", "type": "commit"}, {"oid": "c8cc0350654d97d29a8eb8e414629fc1b0fd2305", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/c8cc0350654d97d29a8eb8e414629fc1b0fd2305", "message": "Fix unit tests", "committedDate": "2020-01-03T22:02:43Z", "type": "commit"}, {"oid": "b99deaeb588348eb2acaf15c7140cdb248dc4228", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/b99deaeb588348eb2acaf15c7140cdb248dc4228", "message": "Refactor", "committedDate": "2020-01-03T22:08:19Z", "type": "commit"}, {"oid": "dfd3befc13f96dde06c9c5e0859c8a432b25ab1f", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/dfd3befc13f96dde06c9c5e0859c8a432b25ab1f", "message": "Support command line args via gradle", "committedDate": "2020-01-04T00:42:05Z", "type": "commit"}, {"oid": "6d423795a629cc5146b471ce51ad72d2b5f62130", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/6d423795a629cc5146b471ce51ad72d2b5f62130", "message": "Retry different database if mismatch on first one", "committedDate": "2020-01-04T01:57:11Z", "type": "commit"}, {"oid": "088b44f9865696790a476fc46010e74382671f6c", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/088b44f9865696790a476fc46010e74382671f6c", "message": "Add more test data", "committedDate": "2020-01-04T02:18:22Z", "type": "commit"}, {"oid": "4b2d9f8ae9aeb3f5869efd14d3da22a2aa8eb19d", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/4b2d9f8ae9aeb3f5869efd14d3da22a2aa8eb19d", "message": "Merge branch 'master' into sql-test-bench", "committedDate": "2020-01-04T02:19:42Z", "type": "commit"}, {"oid": "1947a3aad26805f0f98566f6b3d5991bba7fe4e1", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/1947a3aad26805f0f98566f6b3d5991bba7fe4e1", "message": "Merge branch 'master' into sql-test-bench", "committedDate": "2020-01-06T17:56:57Z", "type": "commit"}, {"oid": "e4dabbd09bf4e4141d8f5c2eeb34debfcaccc5d7", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/e4dabbd09bf4e4141d8f5c2eeb34debfcaccc5d7", "message": "Add documentation", "committedDate": "2020-01-06T19:33:06Z", "type": "commit"}, {"oid": "f1fe0c2af8294a52e96efe87b185e283f20e26d2", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/f1fe0c2af8294a52e96efe87b185e283f20e26d2", "message": "Add documentation", "committedDate": "2020-01-06T19:36:19Z", "type": "commit"}, {"oid": "525cb3df334109b03ea51b12ff0b36b4ece743bc", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/525cb3df334109b03ea51b12ff0b36b4ece743bc", "message": "Add documentation", "committedDate": "2020-01-06T19:53:26Z", "type": "commit"}, {"oid": "01a579f316e9625b94e7ecc310a82a39bf6995e2", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/01a579f316e9625b94e7ecc310a82a39bf6995e2", "message": "Add documentation", "committedDate": "2020-01-06T19:59:57Z", "type": "commit"}, {"oid": "1eb33c8f42f29a5d470b69464700902a3f88824a", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/1eb33c8f42f29a5d470b69464700902a3f88824a", "message": "Add documentation", "committedDate": "2020-01-06T20:59:26Z", "type": "commit"}, {"oid": "ee18634339d647cbda0924b99a470ec70af7b1b9", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/ee18634339d647cbda0924b99a470ec70af7b1b9", "message": "Clean up old report files", "committedDate": "2020-01-06T21:50:26Z", "type": "commit"}, {"oid": "ff242beff5bcfee5171daaeeaff203db3460ad15", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/ff242beff5bcfee5171daaeeaff203db3460ad15", "message": "Add missing java doc", "committedDate": "2020-01-07T00:06:44Z", "type": "commit"}, {"oid": "3d2934f787894eff356c5c4ee1e9f7d71d091e9b", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/3d2934f787894eff356c5c4ee1e9f7d71d091e9b", "message": "Create report folder if not exist", "committedDate": "2020-01-07T00:34:50Z", "type": "commit"}, {"oid": "6b9642f3c68b0ad8fcb98788bd3ce6489610c73a", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/6b9642f3c68b0ad8fcb98788bd3ce6489610c73a", "message": "Upgrade our JDBC dependency to 1.3", "committedDate": "2020-01-07T00:52:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzg0OTYwOA==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/335#discussion_r363849608", "bodyText": "Is it possible to construct the report object and serialize the object to json. It may more clear to represent what is include in the report.", "author": "penghuo", "createdAt": "2020-01-07T17:00:46Z", "path": "src/test/java/com/amazon/opendistroforelasticsearch/sql/correctness/report/FailedTestCase.java", "diffHunk": "@@ -0,0 +1,91 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.correctness.report;\n+\n+import com.amazon.opendistroforelasticsearch.sql.correctness.runner.resultset.DBResult;\n+import com.amazon.opendistroforelasticsearch.sql.correctness.runner.resultset.Row;\n+import org.json.JSONArray;\n+import org.json.JSONObject;\n+\n+import java.util.Comparator;\n+import java.util.List;\n+import java.util.Objects;\n+\n+/**\n+ * Report for test case that fails due to inconsistent result set.\n+ */\n+public class FailedTestCase extends TestCaseReport {\n+\n+    /** Inconsistent result set for reporting */\n+    private final List<DBResult> results;\n+\n+    public FailedTestCase(String sql, List<DBResult> results) {\n+        super(false, sql);\n+        this.results = results;\n+        this.results.sort(Comparator.comparing(DBResult::getDatabaseName));\n+    }\n+\n+    @Override\n+    public JSONObject report() {", "originalCommit": "6b9642f3c68b0ad8fcb98788bd3ce6489610c73a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzk4MjYzOQ==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/335#discussion_r363982639", "bodyText": "Good point! Changed all report classes to generate JSON from object directly. And also use Lombok to simplify the code.", "author": "dai-chen", "createdAt": "2020-01-07T22:27:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzg0OTYwOA=="}], "type": "inlineReview", "revised_code": {"commit": "2feab8cf60d33f2c7c70fb2cfaec07b241273c3e", "chunk": "diff --git a/src/test/java/com/amazon/opendistroforelasticsearch/sql/correctness/report/FailedTestCase.java b/src/test/java/com/amazon/opendistroforelasticsearch/sql/correctness/report/FailedTestCase.java\nindex 5fbd5fc2..93a6dbae 100644\n--- a/src/test/java/com/amazon/opendistroforelasticsearch/sql/correctness/report/FailedTestCase.java\n+++ b/src/test/java/com/amazon/opendistroforelasticsearch/sql/correctness/report/FailedTestCase.java\n\n@@ -16,76 +16,30 @@\n package com.amazon.opendistroforelasticsearch.sql.correctness.report;\n \n import com.amazon.opendistroforelasticsearch.sql.correctness.runner.resultset.DBResult;\n-import com.amazon.opendistroforelasticsearch.sql.correctness.runner.resultset.Row;\n-import org.json.JSONArray;\n-import org.json.JSONObject;\n+import lombok.EqualsAndHashCode;\n+import lombok.Getter;\n+import lombok.ToString;\n \n import java.util.Comparator;\n import java.util.List;\n-import java.util.Objects;\n+\n+import static com.amazon.opendistroforelasticsearch.sql.correctness.report.TestCaseReport.TestResult.FAILURE;\n \n /**\n  * Report for test case that fails due to inconsistent result set.\n  */\n+@EqualsAndHashCode(callSuper = true)\n+@ToString(callSuper = true)\n+@Getter\n public class FailedTestCase extends TestCaseReport {\n \n-    /** Inconsistent result set for reporting */\n-    private final List<DBResult> results;\n-\n-    public FailedTestCase(String sql, List<DBResult> results) {\n-        super(false, sql);\n-        this.results = results;\n-        this.results.sort(Comparator.comparing(DBResult::getDatabaseName));\n-    }\n-\n-    @Override\n-    public JSONObject report() {\n-        JSONObject report = super.report();\n-        JSONArray resultSets = new JSONArray();\n-        report.put(\"resultSets\", resultSets);\n-\n-        for (DBResult result : results) {\n-            JSONObject json = new JSONObject();\n-            json.put(\"database\", result.getDatabaseName());\n-            resultSets.put(json);\n-\n-            JSONObject resultSet = new JSONObject();\n-            json.put(\"resultSet\", resultSet);\n+    /** Inconsistent result sets for reporting */\n+    private final List<DBResult> resultSets;\n \n-            resultSet.put(\"schema\", new JSONArray());\n-            result.getColumnNameAndTypes().forEach((name, type) -> {\n-                JSONObject nameAndType = new JSONObject();\n-                nameAndType.put(\"name\", name);\n-                nameAndType.put(\"type\", type);\n-                resultSet.getJSONArray(\"schema\").put(nameAndType);\n-            });\n-\n-            resultSet.put(\"dataRows\", new JSONArray());\n-            for (Row row : result.getDataRows()) {\n-                resultSet.getJSONArray(\"dataRows\").put(row.getValues());\n-            }\n-        }\n-        return report;\n-    }\n-\n-    @Override\n-    public boolean equals(Object o) {\n-        if (this == o) return true;\n-        if (o == null || getClass() != o.getClass()) return false;\n-        if (!super.equals(o)) return false;\n-        FailedTestCase that = (FailedTestCase) o;\n-        return results.equals(that.results);\n+    public FailedTestCase(int id, String sql, List<DBResult> resultSets) {\n+        super(id, sql, FAILURE);\n+        this.resultSets = resultSets;\n+        this.resultSets.sort(Comparator.comparing(DBResult::getDatabaseName));\n     }\n \n-    @Override\n-    public int hashCode() {\n-        return Objects.hash(super.hashCode(), results);\n-    }\n-\n-    @Override\n-    public String toString() {\n-        return \"FailedTestCase{\" +\n-            \"results=\" + results +\n-            '}';\n-    }\n }\n"}}, {"oid": "2feab8cf60d33f2c7c70fb2cfaec07b241273c3e", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/2feab8cf60d33f2c7c70fb2cfaec07b241273c3e", "message": "Generate JSON by serializing java bean and use Lombok", "committedDate": "2020-01-07T22:20:45Z", "type": "commit"}, {"oid": "d81b1654319b385cca384f5b093fd7691fea2eaa", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/d81b1654319b385cca384f5b093fd7691fea2eaa", "message": "Run doctest by default", "committedDate": "2020-01-07T22:50:55Z", "type": "commit"}]}