{"pr_number": 856, "pr_title": "Sort aggregation push down", "pr_createdAt": "2020-11-25T21:00:39Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/sql/pull/856", "timeline": [{"oid": "e09424903d653e61ec513c1d81cc7b9a94a98470", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/e09424903d653e61ec513c1d81cc7b9a94a98470", "message": "init", "committedDate": "2020-11-25T01:10:59Z", "type": "commit"}, {"oid": "c8163ae9b1ddd4554b702d334e38888c357e9826", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/c8163ae9b1ddd4554b702d334e38888c357e9826", "message": "update", "committedDate": "2020-11-25T05:46:42Z", "type": "commit"}, {"oid": "8f83d9bbd01a2a702cef2d3a86fbba7f2efbbc6c", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/8f83d9bbd01a2a702cef2d3a86fbba7f2efbbc6c", "message": "fix IT", "committedDate": "2020-11-25T15:31:30Z", "type": "commit"}, {"oid": "741653c8d4aed10a01a77583fc09c5ad555cdc93", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/741653c8d4aed10a01a77583fc09c5ad555cdc93", "message": "add doc", "committedDate": "2020-11-25T17:45:53Z", "type": "commit"}, {"oid": "f9562eeb6fd070dd989f93b265e991ac1ea99cf8", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/f9562eeb6fd070dd989f93b265e991ac1ea99cf8", "message": "update doc", "committedDate": "2020-11-25T18:14:59Z", "type": "commit"}, {"oid": "06fd9914ae2ab676147b7fc3cf136f9db23a128e", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/06fd9914ae2ab676147b7fc3cf136f9db23a128e", "message": "fix issue", "committedDate": "2020-11-25T18:22:03Z", "type": "commit"}, {"oid": "f72bb4831a94081c9ace8d7cd49076164d94eb1b", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/f72bb4831a94081c9ace8d7cd49076164d94eb1b", "message": "update", "committedDate": "2020-11-25T18:44:43Z", "type": "commit"}, {"oid": "0212f2fb27592120b0480f679c60fcdef8311a99", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/0212f2fb27592120b0480f679c60fcdef8311a99", "message": "change doc", "committedDate": "2020-11-25T19:16:39Z", "type": "commit"}, {"oid": "27e1487501de74c2f07d0a1793c1e49cea9d6d89", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/27e1487501de74c2f07d0a1793c1e49cea9d6d89", "message": "change doc", "committedDate": "2020-11-25T19:17:48Z", "type": "commit"}, {"oid": "4d00a0baacaaf17ecc09e45be1e51d0a64de94e7", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/4d00a0baacaaf17ecc09e45be1e51d0a64de94e7", "message": "update doc", "committedDate": "2020-11-25T19:19:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzEzMTIzOQ==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/856#discussion_r533131239", "bodyText": "Merge sort -- IndexAgg?", "author": "chloe-zh", "createdAt": "2020-12-01T07:49:09Z", "path": "elasticsearch/src/main/java/com/amazon/opendistroforelasticsearch/sql/elasticsearch/planner/logical/rule/MergeSortAndIndexAgg.java", "diffHunk": "@@ -0,0 +1,94 @@\n+/*\n+ *\n+ *    Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *    Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *    You may not use this file except in compliance with the License.\n+ *    A copy of the License is located at\n+ *\n+ *        http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *    or in the \"license\" file accompanying this file. This file is distributed\n+ *    on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *    express or implied. See the License for the specific language governing\n+ *    permissions and limitations under the License.\n+ *\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.elasticsearch.planner.logical.rule;\n+\n+import static com.amazon.opendistroforelasticsearch.sql.planner.optimizer.pattern.Patterns.source;\n+import static com.facebook.presto.matching.Pattern.typeOf;\n+\n+import com.amazon.opendistroforelasticsearch.sql.ast.tree.Sort;\n+import com.amazon.opendistroforelasticsearch.sql.elasticsearch.planner.logical.ElasticsearchLogicalIndexAgg;\n+import com.amazon.opendistroforelasticsearch.sql.expression.Expression;\n+import com.amazon.opendistroforelasticsearch.sql.expression.ReferenceExpression;\n+import com.amazon.opendistroforelasticsearch.sql.expression.aggregation.NamedAggregator;\n+import com.amazon.opendistroforelasticsearch.sql.planner.logical.LogicalPlan;\n+import com.amazon.opendistroforelasticsearch.sql.planner.logical.LogicalSort;\n+import com.amazon.opendistroforelasticsearch.sql.planner.optimizer.Rule;\n+import com.facebook.presto.matching.Capture;\n+import com.facebook.presto.matching.Captures;\n+import com.facebook.presto.matching.Pattern;\n+import java.util.Set;\n+import java.util.concurrent.atomic.AtomicReference;\n+import java.util.stream.Collectors;\n+import lombok.Getter;\n+import lombok.experimental.Accessors;\n+import org.apache.commons.lang3.tuple.Pair;\n+\n+/**\n+ * Merge Aggregation -- IndexAgg to IndexScanAggregation.\n+ */", "originalCommit": "4d00a0baacaaf17ecc09e45be1e51d0a64de94e7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQxMjM2MQ==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/856#discussion_r535412361", "bodyText": "Done.", "author": "penghuo", "createdAt": "2020-12-03T16:58:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzEzMTIzOQ=="}], "type": "inlineReview", "revised_code": {"commit": "709980023e73ac435aade9a018be846cecfd640f", "chunk": "diff --git a/elasticsearch/src/main/java/com/amazon/opendistroforelasticsearch/sql/elasticsearch/planner/logical/rule/MergeSortAndIndexAgg.java b/elasticsearch/src/main/java/com/amazon/opendistroforelasticsearch/sql/elasticsearch/planner/logical/rule/MergeSortAndIndexAgg.java\nindex 88c55fee..12984d55 100644\n--- a/elasticsearch/src/main/java/com/amazon/opendistroforelasticsearch/sql/elasticsearch/planner/logical/rule/MergeSortAndIndexAgg.java\n+++ b/elasticsearch/src/main/java/com/amazon/opendistroforelasticsearch/sql/elasticsearch/planner/logical/rule/MergeSortAndIndexAgg.java\n\n@@ -39,7 +39,7 @@ import lombok.experimental.Accessors;\n import org.apache.commons.lang3.tuple.Pair;\n \n /**\n- * Merge Aggregation -- IndexAgg to IndexScanAggregation.\n+ * Merge Sort -- IndexScanAggregation to IndexScanAggregation.\n  */\n public class MergeSortAndIndexAgg implements Rule<LogicalSort> {\n \n"}}, {"oid": "709980023e73ac435aade9a018be846cecfd640f", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/709980023e73ac435aade9a018be846cecfd640f", "message": "address comments", "committedDate": "2020-12-03T16:57:33Z", "type": "commit"}, {"oid": "07cbae42896f158ce0d729967abcf77d2f57255b", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/07cbae42896f158ce0d729967abcf77d2f57255b", "message": "merge from develop", "committedDate": "2020-12-03T17:02:49Z", "type": "commit"}, {"oid": "345daa1e88ec0dabab8df061ae915042cb323283", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/345daa1e88ec0dabab8df061ae915042cb323283", "message": "Merge branch 'develop' into sort-aggregation-push-down", "committedDate": "2020-12-04T00:34:18Z", "type": "commit"}]}