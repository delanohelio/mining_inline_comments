{"pr_number": 4896, "pr_title": "[PDS-126257] Setting Fire to the Rain: Killing the SharedExecutor", "pr_createdAt": "2020-07-10T17:58:13Z", "pr_url": "https://github.com/palantir/atlasdb/pull/4896", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQ5NTg0MQ==", "url": "https://github.com/palantir/atlasdb/pull/4896#discussion_r453495841", "bodyText": "Why unsafe?", "author": "sudiksha27", "createdAt": "2020-07-13T08:54:00Z", "path": "leader-election-impl/src/main/java/com/palantir/paxos/SingleLeaderLearnerNetworkClient.java", "diffHunk": "@@ -63,18 +64,23 @@ public SingleLeaderLearnerNetworkClient(\n     public void learn(long seq, PaxosValue value) {\n         // broadcast learned value\n         for (final PaxosLearner learner : remoteLearners) {\n-            executors.get(learner).execute(() -> {\n-                try {\n-                    learner.learn(seq, value);\n-                } catch (Throwable e) {\n-                    log.warn(\"Failed to teach learner the value {} at sequence {}\",\n-                            UnsafeArg.of(\"value\", Optional.ofNullable(value.data)\n-                                    .map(bytes -> BaseEncoding.base16().encode(bytes))\n-                                    .orElse(null)),\n-                            SafeArg.of(\"sequence\", seq),\n-                            e);\n-                }\n-            });\n+            try {\n+                executors.get(learner).execute(() -> {\n+                    try {\n+                        learner.learn(seq, value);\n+                    } catch (Throwable e) {\n+                        log.warn(\"Failed to teach learner the value {} at sequence {}, after attempting execution.\",\n+                                UnsafeArg.of(\"value\", base16EncodePaxosValue(value)),\n+                                SafeArg.of(\"sequence\", seq),\n+                                e);\n+                    }\n+                });\n+            } catch (RejectedExecutionException e) {\n+                log.warn(\"Failed to teach learner the value {} at sequence {}, because we could not execute the task.\",\n+                        UnsafeArg.of(\"value\", base16EncodePaxosValue(value)),\n+                        SafeArg.of(\"sequence\", seq),", "originalCommit": "cb0bbd4ef86e72e07825c33fbf89873f347e3ad9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzc1NzkwOQ==", "url": "https://github.com/palantir/atlasdb/pull/4896#discussion_r453757909", "bodyText": "I followed the other Learner usage. It's true that TimeLock's usage is safe (this value is null in leader election Paxos, and the value of the timestamp bound in timestamp Paxos), but would prefer not to require this offhand.", "author": "jeremyk-91", "createdAt": "2020-07-13T16:00:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQ5NTg0MQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQ5NjE5MQ==", "url": "https://github.com/palantir/atlasdb/pull/4896#discussion_r453496191", "bodyText": "When would this happen?", "author": "sudiksha27", "createdAt": "2020-07-13T08:54:32Z", "path": "leader-election-impl/src/main/java/com/palantir/paxos/SingleLeaderLearnerNetworkClient.java", "diffHunk": "@@ -63,18 +64,23 @@ public SingleLeaderLearnerNetworkClient(\n     public void learn(long seq, PaxosValue value) {\n         // broadcast learned value\n         for (final PaxosLearner learner : remoteLearners) {\n-            executors.get(learner).execute(() -> {\n-                try {\n-                    learner.learn(seq, value);\n-                } catch (Throwable e) {\n-                    log.warn(\"Failed to teach learner the value {} at sequence {}\",\n-                            UnsafeArg.of(\"value\", Optional.ofNullable(value.data)\n-                                    .map(bytes -> BaseEncoding.base16().encode(bytes))\n-                                    .orElse(null)),\n-                            SafeArg.of(\"sequence\", seq),\n-                            e);\n-                }\n-            });\n+            try {\n+                executors.get(learner).execute(() -> {\n+                    try {\n+                        learner.learn(seq, value);\n+                    } catch (Throwable e) {\n+                        log.warn(\"Failed to teach learner the value {} at sequence {}, after attempting execution.\",\n+                                UnsafeArg.of(\"value\", base16EncodePaxosValue(value)),\n+                                SafeArg.of(\"sequence\", seq),\n+                                e);\n+                    }\n+                });\n+            } catch (RejectedExecutionException e) {\n+                log.warn(\"Failed to teach learner the value {} at sequence {}, because we could not execute the task.\",", "originalCommit": "cb0bbd4ef86e72e07825c33fbf89873f347e3ad9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzc1NzIyOA==", "url": "https://github.com/palantir/atlasdb/pull/4896#discussion_r453757228", "bodyText": "As below: this happens if the executor has the max number of threads running (e.g. because the calls to that endpoint are slow). Abort policy is standard for executors.", "author": "jeremyk-91", "createdAt": "2020-07-13T15:59:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQ5NjE5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQxMzYyOQ==", "url": "https://github.com/palantir/atlasdb/pull/4896#discussion_r457413629", "bodyText": "as an aside, what are your thoughts on making the logging message the same across all instances of this particular exception (as far as this PR goes, at least). It would make analysing issues easier - you could just look for log lines with the same exact message.", "author": "Jolyon-S", "createdAt": "2020-07-20T14:02:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQ5NjE5MQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzUxMTUyMw==", "url": "https://github.com/palantir/atlasdb/pull/4896#discussion_r453511523", "bodyText": "How did we compute this?", "author": "sudiksha27", "createdAt": "2020-07-13T09:18:51Z", "path": "timelock-agent/src/main/java/com/palantir/atlasdb/timelock/paxos/TimeLockPaxosExecutors.java", "diffHunk": "@@ -27,7 +27,7 @@\n \n final class TimeLockPaxosExecutors {\n     @VisibleForTesting\n-    static final int MAXIMUM_POOL_SIZE = 100;\n+    static final int MAXIMUM_POOL_SIZE = 256;", "originalCommit": "cb0bbd4ef86e72e07825c33fbf89873f347e3ad9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzYyNDc2NQ==", "url": "https://github.com/palantir/atlasdb/pull/4896#discussion_r453624765", "bodyText": "We did some more digging into the metrics and we are changing the number to 384 after some discussion.", "author": "sudiksha27", "createdAt": "2020-07-13T12:49:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzUxMTUyMw=="}], "type": "inlineReview", "revised_code": {"commit": "8f4675e6c10ab2098198c1c69ea2d654b3d92441", "chunk": "diff --git a/timelock-agent/src/main/java/com/palantir/atlasdb/timelock/paxos/TimeLockPaxosExecutors.java b/timelock-agent/src/main/java/com/palantir/atlasdb/timelock/paxos/TimeLockPaxosExecutors.java\nindex cd6649ea91..9a53af25de 100644\n--- a/timelock-agent/src/main/java/com/palantir/atlasdb/timelock/paxos/TimeLockPaxosExecutors.java\n+++ b/timelock-agent/src/main/java/com/palantir/atlasdb/timelock/paxos/TimeLockPaxosExecutors.java\n\n@@ -27,7 +27,7 @@ import com.palantir.common.concurrent.PTExecutors;\n \n final class TimeLockPaxosExecutors {\n     @VisibleForTesting\n-    static final int MAXIMUM_POOL_SIZE = 256;\n+    static final int MAXIMUM_POOL_SIZE = 384;\n \n     private TimeLockPaxosExecutors() {\n         // no\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzU4NDkwMg==", "url": "https://github.com/palantir/atlasdb/pull/4896#discussion_r453584902", "bodyText": "When would this happen?", "author": "sudiksha27", "createdAt": "2020-07-13T11:31:53Z", "path": "timelock-impl/src/main/java/com/palantir/atlasdb/timelock/paxos/LearnCoalescingConsumer.java", "diffHunk": "@@ -38,35 +39,36 @@\n     private static final Logger log = LoggerFactory.getLogger(LearnCoalescingConsumer.class);\n     private static final PaxosResponse SUCCESSFUL_RESPONSE = new PaxosResponseImpl(true);\n \n-    private final BatchPaxosLearner localLearner;\n-    private final List<BatchPaxosLearner> remoteLearners;\n-    private final ExecutorService executor;\n+    private final WithDedicatedExecutor<BatchPaxosLearner> localLearner;\n+    private final List<WithDedicatedExecutor<BatchPaxosLearner>> remoteLearners;\n \n     LearnCoalescingConsumer(\n-            BatchPaxosLearner localLearner,\n-            List<BatchPaxosLearner> remoteLearners,\n-            ExecutorService executor) {\n+            WithDedicatedExecutor<BatchPaxosLearner> localLearner,\n+            List<WithDedicatedExecutor<BatchPaxosLearner>> remoteLearners) {\n         this.localLearner = localLearner;\n         this.remoteLearners = remoteLearners;\n-        this.executor = executor;\n     }\n \n     @Override\n     public Map<Map.Entry<Client, PaxosValue>, PaxosResponse> apply(Set<Map.Entry<Client, PaxosValue>> request) {\n         SetMultimap<Client, PaxosValue> requestAsMultimap = ImmutableSetMultimap.copyOf(request);\n \n-        for (BatchPaxosLearner remoteLearner : remoteLearners) {\n-            executor.execute(() -> {\n-                try {\n-                    remoteLearner.learn(requestAsMultimap);\n-                } catch (Throwable e) {\n-                    log.warn(\"Failed to teach learner.\", e);\n-                }\n-            });\n+        for (WithDedicatedExecutor<BatchPaxosLearner> remoteLearner : remoteLearners) {\n+            try {\n+                remoteLearner.executor().execute(() -> {\n+                    try {\n+                        remoteLearner.service().learn(requestAsMultimap);\n+                    } catch (Throwable e) {\n+                        log.warn(\"Failed to teach learner after scheduling the task.\", e);\n+                    }\n+                });\n+            } catch (RejectedExecutionException e) {\n+                log.warn(\"Failed to teach learner, because we could not schedule the task at all\", e);\n+            }", "originalCommit": "cb0bbd4ef86e72e07825c33fbf89873f347e3ad9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzc1NzEzNA==", "url": "https://github.com/palantir/atlasdb/pull/4896#discussion_r453757134", "bodyText": "This happens if the executor has the max number of threads running (e.g. because the calls to that endpoint are slow).", "author": "jeremyk-91", "createdAt": "2020-07-13T15:59:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzU4NDkwMg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTYyNzQ2MA==", "url": "https://github.com/palantir/atlasdb/pull/4896#discussion_r455627460", "bodyText": "nit: This doesn't feel necessary - is there a reason why you can't just pass in local and remote (mapping away the WithExecutor) into the constructor at the end?", "author": "Jolyon-S", "createdAt": "2020-07-16T08:49:06Z", "path": "timelock-agent/src/main/java/com/palantir/atlasdb/timelock/paxos/SingleLeaderNetworkClientFactories.java", "diffHunk": "@@ -75,17 +78,30 @@\n     @Override\n     public Factory<PaxosLearnerNetworkClient> learner() {\n         return client -> {\n-            List<PaxosLearner> remoteLearners = TimelockPaxosLearnerAdapters\n-                    .create(useCase(), remoteClients(), useBatchedEndpoints(), client);\n+            List<WithDedicatedExecutor<PaxosLearner>> remoteLearners = TimelockPaxosLearnerAdapters\n+                    .create(useCase(), remoteClients(), useBatchedEndpoints(), client)\n+                    .stream()\n+                    .map(withExecutor -> withExecutor.transformService(\n+                            remote -> metrics().instrument(PaxosLearner.class, remote, client)))\n+                    .collect(Collectors.toList());\n             PaxosLearner localLearner = components().learner(client);\n \n-            LocalAndRemotes<PaxosLearner> allLearners = LocalAndRemotes.of(localLearner, remoteLearners)\n-                    .enhanceRemotes(remote -> metrics().instrument(PaxosLearner.class, remote, client));\n+            LocalAndRemotes<PaxosLearner> allLearners = LocalAndRemotes.of(localLearner,\n+                    remoteLearners.stream().map(WithDedicatedExecutor::service).collect(Collectors.toList()));", "originalCommit": "779963b27bd3967a7e6454389d083744edcb33ed", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTg2NTQ3Mg==", "url": "https://github.com/palantir/atlasdb/pull/4896#discussion_r455865472", "bodyText": "Yep, no reason we couldn't - I guess this must have been more used previously. I've removed it.", "author": "jeremyk-91", "createdAt": "2020-07-16T15:16:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTYyNzQ2MA=="}], "type": "inlineReview", "revised_code": {"commit": "5994303ba329c1489d95e2a7c09baa2ea6f9c506", "chunk": "diff --git a/timelock-agent/src/main/java/com/palantir/atlasdb/timelock/paxos/SingleLeaderNetworkClientFactories.java b/timelock-agent/src/main/java/com/palantir/atlasdb/timelock/paxos/SingleLeaderNetworkClientFactories.java\nindex 04ec3aba98..e5faf6c096 100644\n--- a/timelock-agent/src/main/java/com/palantir/atlasdb/timelock/paxos/SingleLeaderNetworkClientFactories.java\n+++ b/timelock-agent/src/main/java/com/palantir/atlasdb/timelock/paxos/SingleLeaderNetworkClientFactories.java\n\n@@ -94,7 +94,7 @@ abstract class SingleLeaderNetworkClientFactories implements\n                             .mapKeys(WithDedicatedExecutor::service)\n                             .map(WithDedicatedExecutor::executor)\n                             .collectToMap())\n-                    .put(localLearner, MoreExecutors.newDirectExecutorService())\n+                    .put(localLearner, sharedExecutor())\n                     .build();\n \n             SingleLeaderLearnerNetworkClient uninstrumentedLearner = new SingleLeaderLearnerNetworkClient(\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTYyODAyMg==", "url": "https://github.com/palantir/atlasdb/pull/4896#discussion_r455628022", "bodyText": "Do we want a comment for this constant so we can understand how we got here in the future?", "author": "Jolyon-S", "createdAt": "2020-07-16T08:50:00Z", "path": "timelock-agent/src/main/java/com/palantir/atlasdb/timelock/paxos/TimeLockPaxosExecutors.java", "diffHunk": "@@ -27,7 +27,7 @@\n \n final class TimeLockPaxosExecutors {\n     @VisibleForTesting\n-    static final int MAXIMUM_POOL_SIZE = 100;\n+    static final int MAXIMUM_POOL_SIZE = 384;", "originalCommit": "779963b27bd3967a7e6454389d083744edcb33ed", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTc0Nzc2Mw==", "url": "https://github.com/palantir/atlasdb/pull/4896#discussion_r455747763", "bodyText": "Yep. This was basically derived from looking at the spikes on internal metrics platform, and was selected to permit most instances where a spike in shared executor tasks was serviced and the system recovered afterward (the idea being that the pool being full effectively acts as a QoS mechanism against the bad node).", "author": "jeremyk-91", "createdAt": "2020-07-16T12:27:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTYyODAyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTc0NzgwNw==", "url": "https://github.com/palantir/atlasdb/pull/4896#discussion_r455747807", "bodyText": "I'll add a comment.", "author": "jeremyk-91", "createdAt": "2020-07-16T12:27:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTYyODAyMg=="}], "type": "inlineReview", "revised_code": {"commit": "5994303ba329c1489d95e2a7c09baa2ea6f9c506", "chunk": "diff --git a/timelock-agent/src/main/java/com/palantir/atlasdb/timelock/paxos/TimeLockPaxosExecutors.java b/timelock-agent/src/main/java/com/palantir/atlasdb/timelock/paxos/TimeLockPaxosExecutors.java\nindex 9a53af25de..cd6649ea91 100644\n--- a/timelock-agent/src/main/java/com/palantir/atlasdb/timelock/paxos/TimeLockPaxosExecutors.java\n+++ b/timelock-agent/src/main/java/com/palantir/atlasdb/timelock/paxos/TimeLockPaxosExecutors.java\n\n@@ -27,7 +27,7 @@ import com.palantir.common.concurrent.PTExecutors;\n \n final class TimeLockPaxosExecutors {\n     @VisibleForTesting\n-    static final int MAXIMUM_POOL_SIZE = 384;\n+    static final int MAXIMUM_POOL_SIZE = 256;\n \n     private TimeLockPaxosExecutors() {\n         // no\n"}}, {"oid": "5994303ba329c1489d95e2a7c09baa2ea6f9c506", "url": "https://github.com/palantir/atlasdb/commit/5994303ba329c1489d95e2a7c09baa2ea6f9c506", "message": "fixes part 1", "committedDate": "2020-07-16T09:13:09Z", "type": "commit"}, {"oid": "1ca19cdeee4d6283e5a52eebb6819de50b6bbd7c", "url": "https://github.com/palantir/atlasdb/commit/1ca19cdeee4d6283e5a52eebb6819de50b6bbd7c", "message": "adapters", "committedDate": "2020-07-16T09:13:09Z", "type": "commit"}, {"oid": "317905123516dd88049d823a972d8265e0ecd3c9", "url": "https://github.com/palantir/atlasdb/commit/317905123516dd88049d823a972d8265e0ecd3c9", "message": "Kill sharedexecutor part 1", "committedDate": "2020-07-16T09:13:09Z", "type": "commit"}, {"oid": "684910e00a32b46e3f09af6427ae549e86b38a72", "url": "https://github.com/palantir/atlasdb/commit/684910e00a32b46e3f09af6427ae549e86b38a72", "message": "Out damned SharedExecutor", "committedDate": "2020-07-16T09:13:09Z", "type": "commit"}, {"oid": "ee50d8a3f100d7835492e45bfdfe8cf1ce098c10", "url": "https://github.com/palantir/atlasdb/commit/ee50d8a3f100d7835492e45bfdfe8cf1ce098c10", "message": "Burn things all down", "committedDate": "2020-07-16T09:13:10Z", "type": "commit"}, {"oid": "fa4e37bf41238df56d8252c2bf5aaacfbda35b9b", "url": "https://github.com/palantir/atlasdb/commit/fa4e37bf41238df56d8252c2bf5aaacfbda35b9b", "message": "more things", "committedDate": "2020-07-16T09:13:10Z", "type": "commit"}, {"oid": "bc7f12a86e4f83fab61b2530950ebd11b19bb068", "url": "https://github.com/palantir/atlasdb/commit/bc7f12a86e4f83fab61b2530950ebd11b19bb068", "message": "Hard block some tasks", "committedDate": "2020-07-16T09:13:10Z", "type": "commit"}, {"oid": "50031825758b34df0c9bfe5bf3ea06eb8861d4d0", "url": "https://github.com/palantir/atlasdb/commit/50031825758b34df0c9bfe5bf3ea06eb8861d4d0", "message": "Undo hyper-aggressive stress test", "committedDate": "2020-07-16T09:13:10Z", "type": "commit"}, {"oid": "5dae79d136c61b12e86fb32173337c1043d5b26b", "url": "https://github.com/palantir/atlasdb/commit/5dae79d136c61b12e86fb32173337c1043d5b26b", "message": "fixup", "committedDate": "2020-07-16T09:13:10Z", "type": "commit"}, {"oid": "8f4675e6c10ab2098198c1c69ea2d654b3d92441", "url": "https://github.com/palantir/atlasdb/commit/8f4675e6c10ab2098198c1c69ea2d654b3d92441", "message": "Increase threshold to 384", "committedDate": "2020-07-16T09:13:10Z", "type": "commit"}, {"oid": "775e9e2564aa7c4efa80c7bd55257439255d7c34", "url": "https://github.com/palantir/atlasdb/commit/775e9e2564aa7c4efa80c7bd55257439255d7c34", "message": "Add generated changelog entries", "committedDate": "2020-07-16T09:13:10Z", "type": "commit"}, {"oid": "aa0d43bf2becf66d0a44e35620a5220f13341db4", "url": "https://github.com/palantir/atlasdb/commit/aa0d43bf2becf66d0a44e35620a5220f13341db4", "message": "Fix bug with leader pinger", "committedDate": "2020-07-16T09:13:10Z", "type": "commit"}, {"oid": "aa0d43bf2becf66d0a44e35620a5220f13341db4", "url": "https://github.com/palantir/atlasdb/commit/aa0d43bf2becf66d0a44e35620a5220f13341db4", "message": "Fix bug with leader pinger", "committedDate": "2020-07-16T09:13:10Z", "type": "forcePushed"}, {"oid": "d6622f673a8e0b89509beb0d772637180d65cc86", "url": "https://github.com/palantir/atlasdb/commit/d6622f673a8e0b89509beb0d772637180d65cc86", "message": "Autorelease 0.237.1-rc1", "committedDate": "2020-07-16T09:14:54Z", "type": "commit"}, {"oid": "f3dc29a8d955f9fd491a406eaac984ad5fd94df4", "url": "https://github.com/palantir/atlasdb/commit/f3dc29a8d955f9fd491a406eaac984ad5fd94df4", "message": "CR feedback", "committedDate": "2020-07-16T15:21:25Z", "type": "commit"}, {"oid": "6abae6a0370eb3acb4478d3f505e77e334d10ac9", "url": "https://github.com/palantir/atlasdb/commit/6abae6a0370eb3acb4478d3f505e77e334d10ac9", "message": "New changelog", "committedDate": "2020-07-17T13:21:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjY0NzAwNQ==", "url": "https://github.com/palantir/atlasdb/pull/4896#discussion_r456647005", "bodyText": "Sorry I missed in this before, why not use WithDedicatedExecutor.convert(learners.all())?", "author": "sudiksha27", "createdAt": "2020-07-17T19:58:18Z", "path": "timelock-impl/src/main/java/com/palantir/atlasdb/timelock/paxos/AutobatchingPaxosLearnerNetworkClientFactory.java", "diffHunk": "@@ -52,20 +55,37 @@ private AutobatchingPaxosLearnerNetworkClientFactory(\n         this.getLearnedValuesSince = getLearnedValuesSince;\n     }\n \n-    public static AutobatchingPaxosLearnerNetworkClientFactory create(\n+    public static AutobatchingPaxosLearnerNetworkClientFactory createForTests(\n             LocalAndRemotes<BatchPaxosLearner> learners,\n-            ExecutorService executor,\n+            ExecutorService executorService,\n+            int quorumSize) {\n+        return create(\n+                learners.map(batchPaxosLearner -> WithDedicatedExecutor.of(batchPaxosLearner, executorService)),\n+                quorumSize);\n+    }\n+\n+    public static AutobatchingPaxosLearnerNetworkClientFactory create(\n+            LocalAndRemotes<WithDedicatedExecutor<BatchPaxosLearner>> learners,\n             int quorumSize) {\n         DisruptorAutobatcher<Map.Entry<Client, PaxosValue>, PaxosResponse> learn =\n-                Autobatchers.coalescing(new LearnCoalescingConsumer(learners.local(), learners.remotes(), executor))\n+                Autobatchers.coalescing(new LearnCoalescingConsumer(learners.local(), learners.remotes()))\n                         .safeLoggablePurpose(\"batch-paxos-learner.learn\")\n                         .build();\n \n+        Map<BatchPaxosLearner, ExecutorService> executors = KeyedStream.of(learners.all())\n+                .map(WithDedicatedExecutor::executor)\n+                .mapKeys(WithDedicatedExecutor::service)", "originalCommit": "6abae6a0370eb3acb4478d3f505e77e334d10ac9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzI2MDAwMw==", "url": "https://github.com/palantir/atlasdb/pull/4896#discussion_r457260003", "bodyText": "No worries: I forgot that was a thing", "author": "jeremyk-91", "createdAt": "2020-07-20T10:27:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjY0NzAwNQ=="}], "type": "inlineReview", "revised_code": {"commit": "9ea8c2ac6d50c636608d013394e4f4c633447bd6", "chunk": "diff --git a/timelock-impl/src/main/java/com/palantir/atlasdb/timelock/paxos/AutobatchingPaxosLearnerNetworkClientFactory.java b/timelock-impl/src/main/java/com/palantir/atlasdb/timelock/paxos/AutobatchingPaxosLearnerNetworkClientFactory.java\nindex 0a35a206aa..f89cd27248 100644\n--- a/timelock-impl/src/main/java/com/palantir/atlasdb/timelock/paxos/AutobatchingPaxosLearnerNetworkClientFactory.java\n+++ b/timelock-impl/src/main/java/com/palantir/atlasdb/timelock/paxos/AutobatchingPaxosLearnerNetworkClientFactory.java\n\n@@ -72,14 +73,8 @@ public class AutobatchingPaxosLearnerNetworkClientFactory implements Closeable {\n                         .safeLoggablePurpose(\"batch-paxos-learner.learn\")\n                         .build();\n \n-        Map<BatchPaxosLearner, ExecutorService> executors = KeyedStream.of(learners.all())\n-                .map(WithDedicatedExecutor::executor)\n-                .mapKeys(WithDedicatedExecutor::service)\n-                .collectToMap();\n-        List<BatchPaxosLearner> remotes = learners.all()\n-                .stream()\n-                .map(WithDedicatedExecutor::service)\n-                .collect(Collectors.toList());\n+        Map<BatchPaxosLearner, ExecutorService> executors = WithDedicatedExecutor.convert(learners.all());\n+        List<BatchPaxosLearner> remotes = ImmutableList.copyOf(executors.keySet());\n \n         DisruptorAutobatcher<WithSeq<Client>, PaxosResponses<PaxosContainer<Optional<PaxosValue>>>> learnedValues =\n                 Autobatchers.coalescing(\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjY0Nzc0NA==", "url": "https://github.com/palantir/atlasdb/pull/4896#discussion_r456647744", "bodyText": "Use copy of keyset from executors?", "author": "sudiksha27", "createdAt": "2020-07-17T19:59:58Z", "path": "timelock-impl/src/main/java/com/palantir/atlasdb/timelock/paxos/AutobatchingPaxosLearnerNetworkClientFactory.java", "diffHunk": "@@ -52,20 +55,37 @@ private AutobatchingPaxosLearnerNetworkClientFactory(\n         this.getLearnedValuesSince = getLearnedValuesSince;\n     }\n \n-    public static AutobatchingPaxosLearnerNetworkClientFactory create(\n+    public static AutobatchingPaxosLearnerNetworkClientFactory createForTests(\n             LocalAndRemotes<BatchPaxosLearner> learners,\n-            ExecutorService executor,\n+            ExecutorService executorService,\n+            int quorumSize) {\n+        return create(\n+                learners.map(batchPaxosLearner -> WithDedicatedExecutor.of(batchPaxosLearner, executorService)),\n+                quorumSize);\n+    }\n+\n+    public static AutobatchingPaxosLearnerNetworkClientFactory create(\n+            LocalAndRemotes<WithDedicatedExecutor<BatchPaxosLearner>> learners,\n             int quorumSize) {\n         DisruptorAutobatcher<Map.Entry<Client, PaxosValue>, PaxosResponse> learn =\n-                Autobatchers.coalescing(new LearnCoalescingConsumer(learners.local(), learners.remotes(), executor))\n+                Autobatchers.coalescing(new LearnCoalescingConsumer(learners.local(), learners.remotes()))\n                         .safeLoggablePurpose(\"batch-paxos-learner.learn\")\n                         .build();\n \n+        Map<BatchPaxosLearner, ExecutorService> executors = KeyedStream.of(learners.all())\n+                .map(WithDedicatedExecutor::executor)\n+                .mapKeys(WithDedicatedExecutor::service)\n+                .collectToMap();\n+        List<BatchPaxosLearner> remotes = learners.all()\n+                .stream()\n+                .map(WithDedicatedExecutor::service)\n+                .collect(Collectors.toList());\n+", "originalCommit": "6abae6a0370eb3acb4478d3f505e77e334d10ac9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzI2MDE2Ng==", "url": "https://github.com/palantir/atlasdb/pull/4896#discussion_r457260166", "bodyText": "Needs a list, but good point - I changed to ImmutableList.copyOf(executors.keySet())", "author": "jeremyk-91", "createdAt": "2020-07-20T10:28:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjY0Nzc0NA=="}], "type": "inlineReview", "revised_code": {"commit": "9ea8c2ac6d50c636608d013394e4f4c633447bd6", "chunk": "diff --git a/timelock-impl/src/main/java/com/palantir/atlasdb/timelock/paxos/AutobatchingPaxosLearnerNetworkClientFactory.java b/timelock-impl/src/main/java/com/palantir/atlasdb/timelock/paxos/AutobatchingPaxosLearnerNetworkClientFactory.java\nindex 0a35a206aa..f89cd27248 100644\n--- a/timelock-impl/src/main/java/com/palantir/atlasdb/timelock/paxos/AutobatchingPaxosLearnerNetworkClientFactory.java\n+++ b/timelock-impl/src/main/java/com/palantir/atlasdb/timelock/paxos/AutobatchingPaxosLearnerNetworkClientFactory.java\n\n@@ -72,14 +73,8 @@ public class AutobatchingPaxosLearnerNetworkClientFactory implements Closeable {\n                         .safeLoggablePurpose(\"batch-paxos-learner.learn\")\n                         .build();\n \n-        Map<BatchPaxosLearner, ExecutorService> executors = KeyedStream.of(learners.all())\n-                .map(WithDedicatedExecutor::executor)\n-                .mapKeys(WithDedicatedExecutor::service)\n-                .collectToMap();\n-        List<BatchPaxosLearner> remotes = learners.all()\n-                .stream()\n-                .map(WithDedicatedExecutor::service)\n-                .collect(Collectors.toList());\n+        Map<BatchPaxosLearner, ExecutorService> executors = WithDedicatedExecutor.convert(learners.all());\n+        List<BatchPaxosLearner> remotes = ImmutableList.copyOf(executors.keySet());\n \n         DisruptorAutobatcher<WithSeq<Client>, PaxosResponses<PaxosContainer<Optional<PaxosValue>>>> learnedValues =\n                 Autobatchers.coalescing(\n"}}, {"oid": "9ea8c2ac6d50c636608d013394e4f4c633447bd6", "url": "https://github.com/palantir/atlasdb/commit/9ea8c2ac6d50c636608d013394e4f4c633447bd6", "message": "CR comments", "committedDate": "2020-07-20T10:27:29Z", "type": "commit"}, {"oid": "07bed38e9685c37591811093a0c26e16d4a87459", "url": "https://github.com/palantir/atlasdb/commit/07bed38e9685c37591811093a0c26e16d4a87459", "message": "Autorelease 0.237.1-rc2", "committedDate": "2020-07-20T13:57:15Z", "type": "commit"}, {"oid": "ddd2d7440dacf29193b740cb4b7ba06214adcdeb", "url": "https://github.com/palantir/atlasdb/commit/ddd2d7440dacf29193b740cb4b7ba06214adcdeb", "message": "Add generated changelog entries", "committedDate": "2020-07-20T13:57:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQxNDQyOQ==", "url": "https://github.com/palantir/atlasdb/pull/4896#discussion_r457414429", "bodyText": "nit: while this follows the above, normal usage is e instead of ex, including in other places in this PR.", "author": "Jolyon-S", "createdAt": "2020-07-20T14:03:12Z", "path": "leader-election-impl/src/main/java/com/palantir/paxos/SingleLeaderPinger.java", "diffHunk": "@@ -72,15 +73,17 @@ public LeaderPingResult pingLeaderWithUuid(UUID uuid) {\n         MultiplexingCompletionService<LeaderPingerContext<PingableLeader>, Boolean> multiplexingCompletionService\n                 = MultiplexingCompletionService.create(leaderPingExecutors);\n \n-        multiplexingCompletionService.submit(leader, () -> leader.pinger().ping());\n-\n         try {\n+            multiplexingCompletionService.submit(leader, () -> leader.pinger().ping());\n             Future<Map.Entry<LeaderPingerContext<PingableLeader>, Boolean>> pingFuture = multiplexingCompletionService\n                     .poll(leaderPingResponseWait.toMillis(), TimeUnit.MILLISECONDS);\n             return getLeaderPingResult(uuid, pingFuture);\n         } catch (InterruptedException ex) {\n             Thread.currentThread().interrupt();\n             return LeaderPingResults.pingCallFailure(ex);\n+        } catch (RejectedExecutionException ex) {", "originalCommit": "ddd2d7440dacf29193b740cb4b7ba06214adcdeb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQzMzA1Mg==", "url": "https://github.com/palantir/atlasdb/pull/4896#discussion_r457433052", "bodyText": "Yeah, I just copied the above. I'll change both.", "author": "jeremyk-91", "createdAt": "2020-07-20T14:23:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQxNDQyOQ=="}], "type": "inlineReview", "revised_code": {"commit": "332ffa04c07707edbb12dafce7e882a8b1f5a89c", "chunk": "diff --git a/leader-election-impl/src/main/java/com/palantir/paxos/SingleLeaderPinger.java b/leader-election-impl/src/main/java/com/palantir/paxos/SingleLeaderPinger.java\nindex 5b73481ef8..5efc8f3f15 100644\n--- a/leader-election-impl/src/main/java/com/palantir/paxos/SingleLeaderPinger.java\n+++ b/leader-election-impl/src/main/java/com/palantir/paxos/SingleLeaderPinger.java\n\n@@ -78,12 +78,12 @@ public class SingleLeaderPinger implements LeaderPinger {\n             Future<Map.Entry<LeaderPingerContext<PingableLeader>, Boolean>> pingFuture = multiplexingCompletionService\n                     .poll(leaderPingResponseWait.toMillis(), TimeUnit.MILLISECONDS);\n             return getLeaderPingResult(uuid, pingFuture);\n-        } catch (InterruptedException ex) {\n+        } catch (InterruptedException e) {\n             Thread.currentThread().interrupt();\n-            return LeaderPingResults.pingCallFailure(ex);\n-        } catch (RejectedExecutionException ex) {\n-            log.warn(\"Could not ping the leader, because the executor used to talk to that node is overloaded\", ex);\n-            return LeaderPingResults.pingCallFailure(ex);\n+            return LeaderPingResults.pingCallFailure(e);\n+        } catch (RejectedExecutionException e) {\n+            log.warn(\"Could not ping the leader, because the executor used to talk to that node is overloaded\", e);\n+            return LeaderPingResults.pingCallFailure(e);\n         }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQyMTc0MA==", "url": "https://github.com/palantir/atlasdb/pull/4896#discussion_r457421740", "bodyText": "A quick search across Atlas shows this is the last SharedExecutor (at least by name). Presumably we're good to leave this one in?", "author": "Jolyon-S", "createdAt": "2020-07-20T14:10:47Z", "path": "timelock-agent/src/main/java/com/palantir/timelock/paxos/LockCreator.java", "diffHunk": "@@ -31,8 +31,7 @@\n     private final Supplier<TimeLockRuntimeConfiguration> runtime;\n     private final long blockingTimeoutMs;\n     private final Semaphore sharedThreadPool;\n-    private final ExecutorService sharedExecutor = PTExecutors\n-            .newCachedThreadPool(LockServiceImpl.class.getName());\n+    private final ExecutorService sharedExecutor = PTExecutors.newCachedThreadPool(LockServiceImpl.class.getName());", "originalCommit": "ddd2d7440dacf29193b740cb4b7ba06214adcdeb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQzMjgxMA==", "url": "https://github.com/palantir/atlasdb/pull/4896#discussion_r457432810", "bodyText": "Yes - this executor pertains to the reaper that collects unrefreshed tokens, and so is bounded by the number of clients.", "author": "jeremyk-91", "createdAt": "2020-07-20T14:23:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQyMTc0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQ0MDQ0Mg==", "url": "https://github.com/palantir/atlasdb/pull/4896#discussion_r457440442", "bodyText": "Just wanted to sanity check. Thanks!", "author": "Jolyon-S", "createdAt": "2020-07-20T14:30:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQyMTc0MA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "332ffa04c07707edbb12dafce7e882a8b1f5a89c", "url": "https://github.com/palantir/atlasdb/commit/332ffa04c07707edbb12dafce7e882a8b1f5a89c", "message": "ex -> e", "committedDate": "2020-07-21T11:08:46Z", "type": "commit"}]}