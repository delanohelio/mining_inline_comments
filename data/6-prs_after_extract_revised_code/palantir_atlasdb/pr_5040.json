{"pr_number": 5040, "pr_title": "LockWatchManager#isEnabled.", "pr_createdAt": "2020-10-16T11:41:38Z", "pr_url": "https://github.com/palantir/atlasdb/pull/5040", "timeline": [{"oid": "c8a6646bba618ad675aa70511d126f66e5203f88", "url": "https://github.com/palantir/atlasdb/commit/c8a6646bba618ad675aa70511d126f66e5203f88", "message": "LockWatchManager#isEnabled.", "committedDate": "2020-10-16T11:41:00Z", "type": "commit"}, {"oid": "d56dbe8ef4f9a7acce2d5730ceee415704aa2549", "url": "https://github.com/palantir/atlasdb/commit/d56dbe8ef4f9a7acce2d5730ceee415704aa2549", "message": "Add generated changelog entries", "committedDate": "2020-10-16T11:41:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMzNzkyMg==", "url": "https://github.com/palantir/atlasdb/pull/5040#discussion_r506337922", "bodyText": "This feels wrong - this should call down to LockWatchEventCacheImpl or NoOpLockWatchEventCache.", "author": "Jolyon-S", "createdAt": "2020-10-16T11:54:40Z", "path": "lock-api/src/main/java/com/palantir/lock/watch/LockWatchEventCache.java", "diffHunk": "@@ -21,6 +21,11 @@\n import java.util.Set;\n \n public interface LockWatchEventCache {\n+\n+    default boolean isEnabled() {\n+        return true;\n+    }", "originalCommit": "d56dbe8ef4f9a7acce2d5730ceee415704aa2549", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjM0MDg5OA==", "url": "https://github.com/palantir/atlasdb/pull/5040#discussion_r506340898", "bodyText": "Oh I see - you went with an approach entirely through the proxy. I'm not sure I like that really - surely the logic is 100x cleaner just by doing what you originally said, i.e. having LWECI return true and NOLWEC return false?", "author": "Jolyon-S", "createdAt": "2020-10-16T11:58:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMzNzkyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjM0ODU4OQ==", "url": "https://github.com/palantir/atlasdb/pull/5040#discussion_r506348589", "bodyText": "Discussed offline", "author": "jkozlowski", "createdAt": "2020-10-16T12:08:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMzNzkyMg=="}], "type": "inlineReview", "revised_code": {"commit": "8036d9362a044912509873586ac0564257631730", "chunk": "diff --git a/lock-api/src/main/java/com/palantir/lock/watch/LockWatchEventCache.java b/lock-api/src/main/java/com/palantir/lock/watch/LockWatchEventCache.java\nindex 8f46e22931..e3c76067c8 100644\n--- a/lock-api/src/main/java/com/palantir/lock/watch/LockWatchEventCache.java\n+++ b/lock-api/src/main/java/com/palantir/lock/watch/LockWatchEventCache.java\n\n@@ -22,9 +22,7 @@ import java.util.Set;\n \n public interface LockWatchEventCache {\n \n-    default boolean isEnabled() {\n-        return true;\n-    }\n+    boolean isEnabled();\n \n     /**\n      * Returns the last known lock watch version for the cache.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMzODc1NA==", "url": "https://github.com/palantir/atlasdb/pull/5040#discussion_r506338754", "bodyText": "do you mind expanding this test with hasMessage as there are a number of exceptions under that class (I know I am guilty of this too, but in an effort to make it clearer what we are testing, this should be done).", "author": "Jolyon-S", "createdAt": "2020-10-16T11:55:31Z", "path": "atlasdb-impl-shared/src/test/java/com/palantir/atlasdb/keyvalue/api/watch/ResilientLockWatchEventCacheTest.java", "diffHunk": "@@ -54,6 +56,21 @@ public void before() {\n         proxyCache = ResilientLockWatchEventCache.newProxyInstance(defaultCache, fallbackCache, metricsManager);\n     }\n \n+    @Test\n+    public void testCanDelegateIsEnabled() {\n+        assertThat(proxyCache.isEnabled()).isTrue();\n+\n+        RuntimeException runtimeException = new RuntimeException();\n+        when(defaultCache.getCommitUpdate(anyLong())).thenThrow(runtimeException);\n+        assertThatThrownBy(() -> proxyCache.getCommitUpdate(0L)).hasCause(runtimeException)\n+                .isExactlyInstanceOf(TransactionLockWatchFailedException.class);", "originalCommit": "d56dbe8ef4f9a7acce2d5730ceee415704aa2549", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjM4NzY1Mg==", "url": "https://github.com/palantir/atlasdb/pull/5040#discussion_r506387652", "bodyText": "Nope, ResilientLockWatchEventCache has just one from what I can see?", "author": "jkozlowski", "createdAt": "2020-10-16T12:59:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMzODc1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjM5MDE5MQ==", "url": "https://github.com/palantir/atlasdb/pull/5040#discussion_r506390191", "bodyText": "Ah yea, I see you're just throwing a generic exception instead of actually causing a legit exception inside LWECI.", "author": "Jolyon-S", "createdAt": "2020-10-16T13:03:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMzODc1NA=="}], "type": "inlineReview", "revised_code": {"commit": "8036d9362a044912509873586ac0564257631730", "chunk": "diff --git a/atlasdb-impl-shared/src/test/java/com/palantir/atlasdb/keyvalue/api/watch/ResilientLockWatchEventCacheTest.java b/atlasdb-impl-shared/src/test/java/com/palantir/atlasdb/keyvalue/api/watch/ResilientLockWatchEventCacheTest.java\nindex 0cc703489f..fca789cf33 100644\n--- a/atlasdb-impl-shared/src/test/java/com/palantir/atlasdb/keyvalue/api/watch/ResilientLockWatchEventCacheTest.java\n+++ b/atlasdb-impl-shared/src/test/java/com/palantir/atlasdb/keyvalue/api/watch/ResilientLockWatchEventCacheTest.java\n\n@@ -58,7 +58,11 @@ public final class ResilientLockWatchEventCacheTest {\n \n     @Test\n     public void testCanDelegateIsEnabled() {\n+        when(defaultCache.isEnabled()).thenReturn(true);\n+        when(fallbackCache.isEnabled()).thenReturn(false);\n+\n         assertThat(proxyCache.isEnabled()).isTrue();\n+        verify(defaultCache).isEnabled();\n \n         RuntimeException runtimeException = new RuntimeException();\n         when(defaultCache.getCommitUpdate(anyLong())).thenThrow(runtimeException);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMzOTc3Ng==", "url": "https://github.com/palantir/atlasdb/pull/5040#discussion_r506339776", "bodyText": "Why is this necessary? Also, if we're going to default to anything, wouldn't it be better to be false? I still think this should just be:\nboolean isEnabled;", "author": "Jolyon-S", "createdAt": "2020-10-16T11:56:40Z", "path": "atlasdb-api/src/main/java/com/palantir/atlasdb/keyvalue/api/watch/LockWatchManager.java", "diffHunk": "@@ -34,6 +34,10 @@\n \n     // These methods are hidden on purpose as they should not be generally available, only for brave souls!\n \n+    boolean isEnabled() {\n+        return true;\n+    }", "originalCommit": "d56dbe8ef4f9a7acce2d5730ceee415704aa2549", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjM0OTIyNQ==", "url": "https://github.com/palantir/atlasdb/pull/5040#discussion_r506349225", "bodyText": "I don\u2019t think it matters, I just went with this approach.", "author": "jkozlowski", "createdAt": "2020-10-16T12:08:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMzOTc3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjM4OTQzOA==", "url": "https://github.com/palantir/atlasdb/pull/5040#discussion_r506389438", "bodyText": "I still think we should not set this - I'd rather never, ever have to debug another bug like that auto-delegate, and while I know this is very different, it's just less error-prone to not set a default.", "author": "Jolyon-S", "createdAt": "2020-10-16T13:01:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMzOTc3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjM4OTc2Mg==", "url": "https://github.com/palantir/atlasdb/pull/5040#discussion_r506389762", "bodyText": "(I know you have a test for it, but still).", "author": "Jolyon-S", "createdAt": "2020-10-16T13:02:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMzOTc3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjM5MjI5MA==", "url": "https://github.com/palantir/atlasdb/pull/5040#discussion_r506392290", "bodyText": "Done", "author": "jkozlowski", "createdAt": "2020-10-16T13:05:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMzOTc3Ng=="}], "type": "inlineReview", "revised_code": {"commit": "7b53bd896b48b0be0e00537096e60578d45dd040", "chunk": "diff --git a/atlasdb-api/src/main/java/com/palantir/atlasdb/keyvalue/api/watch/LockWatchManager.java b/atlasdb-api/src/main/java/com/palantir/atlasdb/keyvalue/api/watch/LockWatchManager.java\nindex b656fa99c1..cfce6d9c37 100644\n--- a/atlasdb-api/src/main/java/com/palantir/atlasdb/keyvalue/api/watch/LockWatchManager.java\n+++ b/atlasdb-api/src/main/java/com/palantir/atlasdb/keyvalue/api/watch/LockWatchManager.java\n\n@@ -34,9 +34,7 @@ public abstract class LockWatchManager {\n \n     // These methods are hidden on purpose as they should not be generally available, only for brave souls!\n \n-    boolean isEnabled() {\n-        return true;\n-    }\n+    abstract boolean isEnabled();\n \n     /**\n      * Gets the {@link CommitUpdate} taking into account all changes to lock watch state since the start of the\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjM0MTQ2NA==", "url": "https://github.com/palantir/atlasdb/pull/5040#discussion_r506341464", "bodyText": "I don't really like this - I much prefer just implementing in LWECI and NOLWEC as I feel it is less error prone, and doing this kind of proxy-wrangling is abusing the whole point of it IMO.", "author": "Jolyon-S", "createdAt": "2020-10-16T11:58:43Z", "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/keyvalue/api/watch/ResilientLockWatchEventCache.java", "diffHunk": "@@ -34,6 +34,15 @@\n final class ResilientLockWatchEventCache extends AbstractInvocationHandler {\n \n     private static final Logger log = LoggerFactory.getLogger(ResilientLockWatchEventCache.class);\n+    private static final Method IS_ENABLED;\n+\n+    static {\n+        try {\n+            IS_ENABLED = LockWatchEventCache.class.getMethod(\"isEnabled\");\n+        } catch (NoSuchMethodException e) {\n+            throw new RuntimeException(\"Did someone rename this method?\", e);\n+        }\n+    }", "originalCommit": "d56dbe8ef4f9a7acce2d5730ceee415704aa2549", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjM0OTQ1OA==", "url": "https://github.com/palantir/atlasdb/pull/5040#discussion_r506349458", "bodyText": "Discussed offline", "author": "jkozlowski", "createdAt": "2020-10-16T12:09:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjM0MTQ2NA=="}], "type": "inlineReview", "revised_code": {"commit": "8036d9362a044912509873586ac0564257631730", "chunk": "diff --git a/atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/keyvalue/api/watch/ResilientLockWatchEventCache.java b/atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/keyvalue/api/watch/ResilientLockWatchEventCache.java\nindex 9eba8b3909..af5ab51d81 100644\n--- a/atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/keyvalue/api/watch/ResilientLockWatchEventCache.java\n+++ b/atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/keyvalue/api/watch/ResilientLockWatchEventCache.java\n\n@@ -34,15 +34,6 @@ import com.palantir.logsafe.exceptions.SafeRuntimeException;\n final class ResilientLockWatchEventCache extends AbstractInvocationHandler {\n \n     private static final Logger log = LoggerFactory.getLogger(ResilientLockWatchEventCache.class);\n-    private static final Method IS_ENABLED;\n-\n-    static {\n-        try {\n-            IS_ENABLED = LockWatchEventCache.class.getMethod(\"isEnabled\");\n-        } catch (NoSuchMethodException e) {\n-            throw new RuntimeException(\"Did someone rename this method?\", e);\n-        }\n-    }\n \n     static LockWatchEventCache newProxyInstance(\n             LockWatchEventCache defaultCache,\n"}}, {"oid": "8036d9362a044912509873586ac0564257631730", "url": "https://github.com/palantir/atlasdb/commit/8036d9362a044912509873586ac0564257631730", "message": "Revert proxy impl.", "committedDate": "2020-10-16T12:56:15Z", "type": "commit"}, {"oid": "5c139ffa23d096724dbcbff8b0ef6501cebf9f47", "url": "https://github.com/palantir/atlasdb/commit/5c139ffa23d096724dbcbff8b0ef6501cebf9f47", "message": "Fix changelog.", "committedDate": "2020-10-16T12:56:37Z", "type": "commit"}, {"oid": "7b53bd896b48b0be0e00537096e60578d45dd040", "url": "https://github.com/palantir/atlasdb/commit/7b53bd896b48b0be0e00537096e60578d45dd040", "message": "Fixup", "committedDate": "2020-10-16T13:05:23Z", "type": "commit"}]}