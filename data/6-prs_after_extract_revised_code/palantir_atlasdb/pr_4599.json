{"pr_number": 4599, "pr_title": "[PDS-105073] Support Specifying Service Name in Oracle Connection Config", "pr_createdAt": "2020-02-25T14:17:04Z", "pr_url": "https://github.com/palantir/atlasdb/pull/4599", "timeline": [{"oid": "05e975559be23b71f58b719d093f1bd94546387b", "url": "https://github.com/palantir/atlasdb/commit/05e975559be23b71f58b719d093f1bd94546387b", "message": "Allow specifying of a service name for Oracle config.", "committedDate": "2020-02-25T12:46:29Z", "type": "commit"}, {"oid": "eed40cf76ab79b5ebdc60dd60be7c59d7c350b1d", "url": "https://github.com/palantir/atlasdb/commit/eed40cf76ab79b5ebdc60dd60be7c59d7c350b1d", "message": "Update docs", "committedDate": "2020-02-25T12:47:56Z", "type": "commit"}, {"oid": "92f86bf2e3fde48dbff38180c357367df5ce9de5", "url": "https://github.com/palantir/atlasdb/commit/92f86bf2e3fde48dbff38180c357367df5ce9de5", "message": "Not expected because of ordering issue", "committedDate": "2020-02-25T14:12:29Z", "type": "commit"}, {"oid": "05ca128679498fdf6f6ec8ddd711282eddb6b42a", "url": "https://github.com/palantir/atlasdb/commit/05ca128679498fdf6f6ec8ddd711282eddb6b42a", "message": "Add generated changelog entries", "committedDate": "2020-02-25T14:12:29Z", "type": "commit"}, {"oid": "757f79d6bd390e31e2d1516c09da3c7ce0c73e61", "url": "https://github.com/palantir/atlasdb/commit/757f79d6bd390e31e2d1516c09da3c7ce0c73e61", "message": "CS", "committedDate": "2020-02-26T18:55:47Z", "type": "commit"}, {"oid": "40f0e74daeb1ac35e7c5272ac93adecf06bea0db", "url": "https://github.com/palantir/atlasdb/commit/40f0e74daeb1ac35e7c5272ac93adecf06bea0db", "message": "Merge branch 'jkong/105073' of github.com:palantir/atlasdb into jkong/105073", "committedDate": "2020-02-27T12:00:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjQwMDE3OQ==", "url": "https://github.com/palantir/atlasdb/pull/4599#discussion_r386400179", "bodyText": "don't think you can ever get into this case, but I imagine this is to just satisfy the type checker", "author": "felixdesouza", "createdAt": "2020-03-02T13:45:33Z", "path": "atlasdb-dbkvs-hikari/src/main/java/com/palantir/nexus/db/pool/config/OracleConnectionConfig.java", "diffHunk": "@@ -199,4 +207,16 @@ protected final void check() {\n                     \"a keystore password without enabling ConnectionProtocol.TCPS\");\n         }\n     }\n+\n+    private String getConnectionDataString() {\n+        if (getSid().isPresent()) {\n+            return \"SID=\" + getSid().get();\n+        }\n+\n+        if (getServiceName().isPresent()) {\n+            return \"SERVICE_NAME=\" + getServiceName().get();\n+        }\n+\n+        throw new IllegalArgumentException(\"Both the sid and service name are absent! One needs to be specified.\");", "originalCommit": "40f0e74daeb1ac35e7c5272ac93adecf06bea0db", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjYzMTk4MQ==", "url": "https://github.com/palantir/atlasdb/pull/4599#discussion_r386631981", "bodyText": "I think we do actually, checks happen after the computation of all attributes (docs)", "author": "jeremyk-91", "createdAt": "2020-03-02T20:28:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjQwMDE3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njk1NDg4OA==", "url": "https://github.com/palantir/atlasdb/pull/4599#discussion_r386954888", "bodyText": "of all the derived attributes no?", "author": "felixdesouza", "createdAt": "2020-03-03T11:20:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjQwMDE3OQ=="}], "type": "inlineReview", "revised_code": {"commit": "76e5338f02665345e5d423f53333c07dd3ae8964", "chunk": "diff --git a/atlasdb-dbkvs-hikari/src/main/java/com/palantir/nexus/db/pool/config/OracleConnectionConfig.java b/atlasdb-dbkvs-hikari/src/main/java/com/palantir/nexus/db/pool/config/OracleConnectionConfig.java\nindex 2174577efd..304a822242 100644\n--- a/atlasdb-dbkvs-hikari/src/main/java/com/palantir/nexus/db/pool/config/OracleConnectionConfig.java\n+++ b/atlasdb-dbkvs-hikari/src/main/java/com/palantir/nexus/db/pool/config/OracleConnectionConfig.java\n\n@@ -208,15 +209,26 @@ public abstract class OracleConnectionConfig extends ConnectionConfig {\n         }\n     }\n \n-    private String getConnectionDataString() {\n+    private String connectionDataString() {\n         if (getSid().isPresent()) {\n             return \"SID=\" + getSid().get();\n         }\n \n-        if (getServiceName().isPresent()) {\n-            return \"SERVICE_NAME=\" + getServiceName().get();\n+        if (serviceNameConfiguration().isPresent()) {\n+            return \"SERVICE_NAME=\" + serviceNameConfiguration().get().serviceName();\n         }\n \n-        throw new IllegalArgumentException(\"Both the sid and service name are absent! One needs to be specified.\");\n+        throw new SafeIllegalArgumentException(\"Both the sid and serviceNameConfiguration are absent.\"\n+                + \" One needs to be specified.\");\n+    }\n+\n+    static class Builder extends ImmutableOracleConnectionConfig.Builder {}\n+\n+    @Value.Immutable\n+    interface ServiceNameConfiguration {\n+        String serviceName();\n+        String namespaceOverride();\n+\n+        class Builder extends ImmutableServiceNameConfiguration.Builder {}\n     }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjQwNzk4OQ==", "url": "https://github.com/palantir/atlasdb/pull/4599#discussion_r386407989", "bodyText": "somewhat confused, if you've specified serviceName you can no longer specify sid meaning that you get screwed over here whenever you call namespace i.e. you go from having a namespace to not having a namespace. What are the implications of this in atlas?\nIf anything it feels like getConnectionDataString should return the service name if it is specified, otherwise it returns the sid and that sid is always provided OR that if you specify serviceName, then you need to specify namespace explicitly when migrating over.\nLet's chat about this face to face.", "author": "felixdesouza", "createdAt": "2020-03-02T14:00:11Z", "path": "atlasdb-dbkvs-hikari/src/main/java/com/palantir/nexus/db/pool/config/OracleConnectionConfig.java", "diffHunk": "@@ -48,22 +48,25 @@ public String getUrl() {\n         if (getServerDn().isPresent()) {\n             return String.format(\"jdbc:oracle:thin:@(DESCRIPTION=\"\n                             + \"(ADDRESS=(PROTOCOL=%s)(HOST=%s)(PORT=%s))\"\n-                            + \"(CONNECT_DATA=(SID=%s))\"\n+                            + \"(CONNECT_DATA=(%s))\"\n                             + \"(SECURITY=(SSL_SERVER_CERT_DN=\\\"%s\\\")))\",\n-                    getProtocol().getUrlString(), getHost(), getPort(), getSid(), getServerDn().get());\n+                    getProtocol().getUrlString(), getHost(), getPort(), getConnectionDataString(), getServerDn().get());\n         } else {\n             return String.format(\"jdbc:oracle:thin:@(DESCRIPTION=\"\n                             + \"(ADDRESS=(PROTOCOL=%s)(HOST=%s)(PORT=%s))\"\n-                            + \"(CONNECT_DATA=(SID=%s)))\",\n-                    getProtocol().getUrlString(), getHost(), getPort(), getSid());\n+                            + \"(CONNECT_DATA=(%s)))\",\n+                    getProtocol().getUrlString(), getHost(), getPort(), getConnectionDataString());\n         }\n     }\n \n     @Override\n     @Value.Derived\n     @JsonIgnore\n     public Optional<String> namespace() {\n-        return Optional.of(getSid());\n+        // If an SID is provided, maintain it - this is needed for legacy compatibility. But if a service name\n+        // is provided, that identifies the database and we don't want to enforce consistency checks with the\n+        // TimeLock client.\n+        return getSid();", "originalCommit": "40f0e74daeb1ac35e7c5272ac93adecf06bea0db", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjYzNjc5MQ==", "url": "https://github.com/palantir/atlasdb/pull/4599#discussion_r386636791", "bodyText": "In AtlasDB config, users can specify:\n\na KVS-level namespace K (equals keyspace in Cassandra, dbName in Postgres, sid in Oracle)\na timelock-level client T\na global namespace G\n\nAll of them are optional. The current rules are\nNon TimeLock users\n\nG is specified OR K is specified\nIf both are specified G == K\n\nTimeLock users\n\nG is specified OR (T and K are specified)\nIf both are specified, G == T\nIf both are specified, G == K\n\nThe interesting cases here are those where K is specified, since this change prevents you from specifying a value of K for this Oracle database.\nNo TimeLock\n\nIf G and K are both specified, then they must already be equal, and the behaviour of removing K is identical to the baseline.\nIf G is not specified, then K doesn't matter as the timestamp bound is stored in the database being referenced.\n\nTimeLock\n\nIf G and K are specified, they are necessarily equal, and no change is needed.\nIf T and K are specified while G is not, when migrating users must set the new value of G to be T (this is correct even if K was previously different from T), so that clients use the same namespace in TimeLock. Failure to do so will cause the service to not start.\n\nWe can discuss tomorrow. SID is always provided is not an option, as the deployment in question does not have that information as they do not operate the Oracle database in question. The second solution might be better if we decide it's needed, though it makes Oracle configs repetitive for TimeLock users.", "author": "jeremyk-91", "createdAt": "2020-03-02T20:38:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjQwNzk4OQ=="}], "type": "inlineReview", "revised_code": {"commit": "76e5338f02665345e5d423f53333c07dd3ae8964", "chunk": "diff --git a/atlasdb-dbkvs-hikari/src/main/java/com/palantir/nexus/db/pool/config/OracleConnectionConfig.java b/atlasdb-dbkvs-hikari/src/main/java/com/palantir/nexus/db/pool/config/OracleConnectionConfig.java\nindex 2174577efd..304a822242 100644\n--- a/atlasdb-dbkvs-hikari/src/main/java/com/palantir/nexus/db/pool/config/OracleConnectionConfig.java\n+++ b/atlasdb-dbkvs-hikari/src/main/java/com/palantir/nexus/db/pool/config/OracleConnectionConfig.java\n\n@@ -50,12 +51,12 @@ public abstract class OracleConnectionConfig extends ConnectionConfig {\n                             + \"(ADDRESS=(PROTOCOL=%s)(HOST=%s)(PORT=%s))\"\n                             + \"(CONNECT_DATA=(%s))\"\n                             + \"(SECURITY=(SSL_SERVER_CERT_DN=\\\"%s\\\")))\",\n-                    getProtocol().getUrlString(), getHost(), getPort(), getConnectionDataString(), getServerDn().get());\n+                    getProtocol().getUrlString(), getHost(), getPort(), connectionDataString(), getServerDn().get());\n         } else {\n             return String.format(\"jdbc:oracle:thin:@(DESCRIPTION=\"\n                             + \"(ADDRESS=(PROTOCOL=%s)(HOST=%s)(PORT=%s))\"\n                             + \"(CONNECT_DATA=(%s)))\",\n-                    getProtocol().getUrlString(), getHost(), getPort(), getConnectionDataString());\n+                    getProtocol().getUrlString(), getHost(), getPort(), connectionDataString());\n         }\n     }\n \n"}}, {"oid": "76e5338f02665345e5d423f53333c07dd3ae8964", "url": "https://github.com/palantir/atlasdb/commit/76e5338f02665345e5d423f53333c07dd3ae8964", "message": "PR comments", "committedDate": "2020-03-03T13:51:09Z", "type": "commit"}, {"oid": "f143d1da95d6b7f94d045488679ecc5c6506e8fe", "url": "https://github.com/palantir/atlasdb/commit/f143d1da95d6b7f94d045488679ecc5c6506e8fe", "message": "Docs", "committedDate": "2020-03-03T14:08:29Z", "type": "commit"}, {"oid": "b44b7ff9b5e3f2b85f728c603d37c35798def240", "url": "https://github.com/palantir/atlasdb/commit/b44b7ff9b5e3f2b85f728c603d37c35798def240", "message": "DbKVS test", "committedDate": "2020-03-03T14:08:36Z", "type": "commit"}, {"oid": "08b5327e407cb6c6d8bba653a5783224c140d2ed", "url": "https://github.com/palantir/atlasdb/commit/08b5327e407cb6c6d8bba653a5783224c140d2ed", "message": "Add generated changelog entries", "committedDate": "2020-03-03T14:08:36Z", "type": "commit"}]}