{"pr_number": 4923, "pr_title": "Bg gain leadership", "pr_createdAt": "2020-07-29T14:07:18Z", "pr_url": "https://github.com/palantir/atlasdb/pull/4923", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzAyMTkwOA==", "url": "https://github.com/palantir/atlasdb/pull/4923#discussion_r467021908", "bodyText": "I'd suggest we rate limit the log message to maybe once every 10 or 30 seconds - timelocks otherwise ping each other 10 times per second meaning it'll be really noisy!", "author": "jeremyk-91", "createdAt": "2020-08-07T12:55:06Z", "path": "leader-election-impl/src/main/java/com/palantir/leader/LeadershipEvents.java", "diffHunk": "@@ -88,6 +89,13 @@ void proposalFailure(PaxosRoundFailureException paxosException) {\n         leaderElectionServiceMetrics.proposalFailure().mark();\n     }\n \n+    public void leaderOnOlderTimeLockVersion(OrderableSlsVersion version) {\n+        // TODO(snanda): Kill log after few successful runs of blue-green deployment.\n+        leaderLog.info(\"We contacted the leader and it reported that it is on an older version of TimeLock - {}\",\n+                withContextArgs(SafeArg.of(\"version\", version)));\n+        leaderElectionServiceMetrics.leaderOnOlderTimeLockVersion().mark();", "originalCommit": "d081b65771e65b169575c37eb4d580599acc3132", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "28a519caf85a33e6a432b4c585727f5c778ae0a9", "chunk": "diff --git a/leader-election-impl/src/main/java/com/palantir/leader/LeadershipEvents.java b/leader-election-impl/src/main/java/com/palantir/leader/LeadershipEvents.java\nindex 03047cf3ef..ae4a945b95 100644\n--- a/leader-election-impl/src/main/java/com/palantir/leader/LeadershipEvents.java\n+++ b/leader-election-impl/src/main/java/com/palantir/leader/LeadershipEvents.java\n\n@@ -89,13 +88,6 @@ class LeadershipEvents {\n         leaderElectionServiceMetrics.proposalFailure().mark();\n     }\n \n-    public void leaderOnOlderTimeLockVersion(OrderableSlsVersion version) {\n-        // TODO(snanda): Kill log after few successful runs of blue-green deployment.\n-        leaderLog.info(\"We contacted the leader and it reported that it is on an older version of TimeLock - {}\",\n-                withContextArgs(SafeArg.of(\"version\", version)));\n-        leaderElectionServiceMetrics.leaderOnOlderTimeLockVersion().mark();\n-    }\n-\n     private Object[] withContextArgs(Object arg) {\n         if (contextArgs.length == 0) {\n             return new Object[] { arg };\n"}}, {"oid": "28a519caf85a33e6a432b4c585727f5c778ae0a9", "url": "https://github.com/palantir/atlasdb/commit/28a519caf85a33e6a432b4c585727f5c778ae0a9", "message": "Merge", "committedDate": "2020-08-10T17:54:09Z", "type": "commit"}, {"oid": "a193ed18efd35f66881e5cbfe5a1880885ca884b", "url": "https://github.com/palantir/atlasdb/commit/a193ed18efd35f66881e5cbfe5a1880885ca884b", "message": "Draft | Log when leader is on older version", "committedDate": "2020-08-10T17:54:09Z", "type": "commit"}, {"oid": "c9f76cbb90175cbcb4892b9129d4009a74596be0", "url": "https://github.com/palantir/atlasdb/commit/c9f76cbb90175cbcb4892b9129d4009a74596be0", "message": "Old version metric", "committedDate": "2020-08-10T17:54:09Z", "type": "commit"}, {"oid": "5498fab41d7d3d0956fcc1c72670a044fe441331", "url": "https://github.com/palantir/atlasdb/commit/5498fab41d7d3d0956fcc1c72670a044fe441331", "message": "Tests", "committedDate": "2020-08-10T17:54:09Z", "type": "commit"}, {"oid": "c03dd13dc2455802591e01b3fb5816dc24797904", "url": "https://github.com/palantir/atlasdb/commit/c03dd13dc2455802591e01b3fb5816dc24797904", "message": "Test", "committedDate": "2020-08-10T17:54:09Z", "type": "commit"}, {"oid": "f9b92ad7cb72bd446deedc9553a352632c605c9e", "url": "https://github.com/palantir/atlasdb/commit/f9b92ad7cb72bd446deedc9553a352632c605c9e", "message": "Fix", "committedDate": "2020-08-10T17:54:09Z", "type": "commit"}, {"oid": "fd6b87bd7e8082ae3d16082de546f2c024bee3ec", "url": "https://github.com/palantir/atlasdb/commit/fd6b87bd7e8082ae3d16082de546f2c024bee3ec", "message": "TimeLock dependency", "committedDate": "2020-08-10T17:54:09Z", "type": "commit"}, {"oid": "46ecc935e804c351a0615e19705fa57e5b309bd4", "url": "https://github.com/palantir/atlasdb/commit/46ecc935e804c351a0615e19705fa57e5b309bd4", "message": "Add generated changelog entries", "committedDate": "2020-08-10T17:54:09Z", "type": "commit"}, {"oid": "bb14b1ff38d5c0521d581521826d809eaa2a5ba7", "url": "https://github.com/palantir/atlasdb/commit/bb14b1ff38d5c0521d581521826d809eaa2a5ba7", "message": "Add generated changelog entries", "committedDate": "2020-08-10T17:54:09Z", "type": "commit"}, {"oid": "06922b0ccbdb03f91dd5ecc9efa8217e4a7a784b", "url": "https://github.com/palantir/atlasdb/commit/06922b0ccbdb03f91dd5ecc9efa8217e4a7a784b", "message": "Add generated changelog entries", "committedDate": "2020-08-10T17:54:09Z", "type": "commit"}, {"oid": "4b1288b051832d4bf3eb5a4062d07da1103275b9", "url": "https://github.com/palantir/atlasdb/commit/4b1288b051832d4bf3eb5a4062d07da1103275b9", "message": "Comment", "committedDate": "2020-08-10T17:54:09Z", "type": "commit"}, {"oid": "a268c5bf293c1c6a5df33db77fea157fa52dcda8", "url": "https://github.com/palantir/atlasdb/commit/a268c5bf293c1c6a5df33db77fea157fa52dcda8", "message": "Revert \"TimeLock dependency\"\n\nThis reverts commit 8c774fa48e11996c06d126dfaf90e6c9e0b7d4ec.", "committedDate": "2020-08-10T17:54:09Z", "type": "commit"}, {"oid": "b70239ca1e73564948061c557289caff61073774", "url": "https://github.com/palantir/atlasdb/commit/b70239ca1e73564948061c557289caff61073774", "message": "Rate limited logs", "committedDate": "2020-08-10T17:54:09Z", "type": "commit"}, {"oid": "b70239ca1e73564948061c557289caff61073774", "url": "https://github.com/palantir/atlasdb/commit/b70239ca1e73564948061c557289caff61073774", "message": "Rate limited logs", "committedDate": "2020-08-10T17:54:09Z", "type": "forcePushed"}, {"oid": "e027d9f78e84cf2dfd7f8afa6f73bb215a1037a7", "url": "https://github.com/palantir/atlasdb/commit/e027d9f78e84cf2dfd7f8afa6f73bb215a1037a7", "message": "Schema update", "committedDate": "2020-08-10T17:54:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODQ2NzI0Mg==", "url": "https://github.com/palantir/atlasdb/pull/4923#discussion_r468467242", "bodyText": "This is not required.", "author": "jeremyk-91", "createdAt": "2020-08-11T10:01:37Z", "path": "timelock-agent/src/main/java/com/palantir/timelock/paxos/TimeLockAgent.java", "diffHunk": "@@ -77,7 +77,7 @@\n @SuppressWarnings(\"checkstyle:FinalClass\") // This is mocked internally\n public class TimeLockAgent {\n     // Schema version from 2 onwards are on SQLite\n-    private static final Long SCHEMA_VERSION = 3L;\n+    private static final Long SCHEMA_VERSION = 4L;", "originalCommit": "e027d9f78e84cf2dfd7f8afa6f73bb215a1037a7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "474ac93884d76186dbf274548ce1e979c9fd0b60", "chunk": "diff --git a/timelock-agent/src/main/java/com/palantir/timelock/paxos/TimeLockAgent.java b/timelock-agent/src/main/java/com/palantir/timelock/paxos/TimeLockAgent.java\nindex 3e4bc2bc53..3f3fae4e2c 100644\n--- a/timelock-agent/src/main/java/com/palantir/timelock/paxos/TimeLockAgent.java\n+++ b/timelock-agent/src/main/java/com/palantir/timelock/paxos/TimeLockAgent.java\n\n@@ -77,7 +77,7 @@ import com.zaxxer.hikari.HikariDataSource;\n @SuppressWarnings(\"checkstyle:FinalClass\") // This is mocked internally\n public class TimeLockAgent {\n     // Schema version from 2 onwards are on SQLite\n-    private static final Long SCHEMA_VERSION = 4L;\n+    private static final Long SCHEMA_VERSION = 3L;\n \n     private final MetricsManager metricsManager;\n     private final TimeLockInstallConfiguration install;\n"}}, {"oid": "474ac93884d76186dbf274548ce1e979c9fd0b60", "url": "https://github.com/palantir/atlasdb/commit/474ac93884d76186dbf274548ce1e979c9fd0b60", "message": "Revert \"Schema update\"\n\nThis reverts commit e027d9f78e84cf2dfd7f8afa6f73bb215a1037a7.", "committedDate": "2020-08-11T10:44:20Z", "type": "commit"}]}