{"pr_number": 4955, "pr_title": "memoize ssl socket factory creation", "pr_createdAt": "2020-08-20T07:20:12Z", "pr_url": "https://github.com/palantir/atlasdb/pull/4955", "timeline": [{"oid": "bd1f5e15fd7381d64ebb767ce412f3851e9854aa", "url": "https://github.com/palantir/atlasdb/commit/bd1f5e15fd7381d64ebb767ce412f3851e9854aa", "message": "memoize ssl socket factory creation\n\neach ssl socket factory holds a presized 16k entry ssl session cache.\nAt present AtlasDB-proxy creates a new ssl socket factory per-host,\nper-namespace. These really should all be the same ssl socket factory,\nsince the ssl configuration is the same.\n\nWe now memoize these. The config point is not the right place to do\nthis, since internally we mutate the configs to add extra options in a\nfew places - can't work via config equality.", "committedDate": "2020-08-20T07:17:11Z", "type": "commit"}, {"oid": "35c91c133015b835afde6b33b86b68797c08350a", "url": "https://github.com/palantir/atlasdb/commit/35c91c133015b835afde6b33b86b68797c08350a", "message": "fix", "committedDate": "2020-08-20T07:20:51Z", "type": "commit"}, {"oid": "28b6cbc77243b3a7281f47ecf66549883f91be99", "url": "https://github.com/palantir/atlasdb/commit/28b6cbc77243b3a7281f47ecf66549883f91be99", "message": "Add generated changelog entries", "committedDate": "2020-08-20T07:20:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzgyNDkwNQ==", "url": "https://github.com/palantir/atlasdb/pull/4955#discussion_r473824905", "bodyText": "Nice. I checked that we retain a reference to the SSL socket factory if you're using a TM with Cassandra. So we do actually want to clear this out quickly once unreferenced", "author": "jeremyk-91", "createdAt": "2020-08-20T09:45:15Z", "path": "atlasdb-cassandra/src/main/java/com/palantir/atlasdb/keyvalue/cassandra/CassandraClientFactory.java", "diffHunk": "@@ -41,18 +39,24 @@\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n+import com.github.benmanes.caffeine.cache.Caffeine;\n+import com.github.benmanes.caffeine.cache.LoadingCache;\n import com.google.common.collect.Maps;\n import com.palantir.atlasdb.cassandra.CassandraCredentialsConfig;\n import com.palantir.atlasdb.cassandra.CassandraKeyValueServiceConfig;\n import com.palantir.atlasdb.util.AtlasDbMetrics;\n import com.palantir.atlasdb.util.MetricsManager;\n import com.palantir.common.exception.AtlasDbDependencyException;\n+import com.palantir.conjure.java.api.config.ssl.SslConfiguration;\n import com.palantir.conjure.java.config.ssl.SslSocketFactories;\n import com.palantir.logsafe.SafeArg;\n import com.palantir.logsafe.UnsafeArg;\n \n public class CassandraClientFactory extends BasePooledObjectFactory<CassandraClient> {\n     private static final Logger log = LoggerFactory.getLogger(CassandraClientFactory.class);\n+    private static final LoadingCache<SslConfiguration, SSLSocketFactory> sslSocketFactoryCache = Caffeine.newBuilder()\n+            .weakValues()", "originalCommit": "28b6cbc77243b3a7281f47ecf66549883f91be99", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}