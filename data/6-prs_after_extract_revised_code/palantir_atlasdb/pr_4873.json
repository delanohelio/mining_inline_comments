{"pr_number": 4873, "pr_title": "[PD$-110002] Part 7: Cassandra Client Pool", "pr_createdAt": "2020-06-29T17:16:39Z", "pr_url": "https://github.com/palantir/atlasdb/pull/4873", "timeline": [{"oid": "88eda476b8c619a0dfa580226a1861dbf8a71ff3", "url": "https://github.com/palantir/atlasdb/commit/88eda476b8c619a0dfa580226a1861dbf8a71ff3", "message": "Low hanging fruit CCPC", "committedDate": "2020-06-29T17:09:26Z", "type": "commit"}, {"oid": "eccdc61e254af2038ecc8932edb3e36a9f64d555", "url": "https://github.com/palantir/atlasdb/commit/eccdc61e254af2038ecc8932edb3e36a9f64d555", "message": "one more", "committedDate": "2020-06-29T17:12:40Z", "type": "commit"}, {"oid": "718c8b35f702015efe13394212e2cd11f7a01794", "url": "https://github.com/palantir/atlasdb/commit/718c8b35f702015efe13394212e2cd11f7a01794", "message": "Add generated changelog entries", "committedDate": "2020-06-29T17:12:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQ3ODQ0Mw==", "url": "https://github.com/palantir/atlasdb/pull/4873#discussion_r447478443", "bodyText": "I think this is a good change. Just wondering if we could basically keep all metrics in memory and then use your filtering infra to report outliers? but otherwise just report one set of metrics for all pools.", "author": "jkozlowski", "createdAt": "2020-06-30T07:45:09Z", "path": "atlasdb-cassandra/src/main/java/com/palantir/atlasdb/keyvalue/cassandra/CassandraClientPoolingContainer.java", "diffHunk": "@@ -309,14 +309,8 @@ private void registerMetrics(GenericObjectPool<CassandraClient> pool) {\n         registerPoolMetric(\"meanBorrowWaitTimeMillis\", pool::getMeanBorrowWaitTimeMillis);\n         registerPoolMetric(\"numIdle\", pool::getNumIdle);\n         registerPoolMetric(\"numActive\", pool::getNumActive);", "originalCommit": "718c8b35f702015efe13394212e2cd11f7a01794", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg1MjU0Nw==", "url": "https://github.com/palantir/atlasdb/pull/4873#discussion_r447852547", "bodyText": "Yep, we could. This was intended to be the 'pain free' or 'risk free' version of this PR, that's definitely something that we could do (just more complex)", "author": "jeremyk-91", "createdAt": "2020-06-30T17:20:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQ3ODQ0Mw=="}], "type": "inlineReview", "revised_code": {"commit": "47baaa84050f58cb553bf2f36d3e84ddd0eb399a", "chunk": "diff --git a/atlasdb-cassandra/src/main/java/com/palantir/atlasdb/keyvalue/cassandra/CassandraClientPoolingContainer.java b/atlasdb-cassandra/src/main/java/com/palantir/atlasdb/keyvalue/cassandra/CassandraClientPoolingContainer.java\nindex 196693c63c..41f9988bd7 100644\n--- a/atlasdb-cassandra/src/main/java/com/palantir/atlasdb/keyvalue/cassandra/CassandraClientPoolingContainer.java\n+++ b/atlasdb-cassandra/src/main/java/com/palantir/atlasdb/keyvalue/cassandra/CassandraClientPoolingContainer.java\n\n@@ -305,8 +305,6 @@ public class CassandraClientPoolingContainer implements PoolingContainer<Cassand\n \n     private void registerMetrics(GenericObjectPool<CassandraClient> pool) {\n         registerPoolMetric(\"meanActiveTimeMillis\", pool::getMeanActiveTimeMillis);\n-        registerPoolMetric(\"meanIdleTimeMillis\", pool::getMeanIdleTimeMillis);\n-        registerPoolMetric(\"meanBorrowWaitTimeMillis\", pool::getMeanBorrowWaitTimeMillis);\n         registerPoolMetric(\"numIdle\", pool::getNumIdle);\n         registerPoolMetric(\"numActive\", pool::getNumActive);\n         registerPoolMetric(\"created\", pool::getCreatedCount);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQ3OTE4OA==", "url": "https://github.com/palantir/atlasdb/pull/4873#discussion_r447479188", "bodyText": "I'm curious about this metric as well, I thought we don't wait at all, but waiting is done in the CassandraRetrier. So in effect this might be timing a memory operation of checking out a connection from the pool", "author": "jkozlowski", "createdAt": "2020-06-30T07:46:29Z", "path": "atlasdb-cassandra/src/main/java/com/palantir/atlasdb/keyvalue/cassandra/CassandraClientPoolingContainer.java", "diffHunk": "@@ -309,14 +309,8 @@ private void registerMetrics(GenericObjectPool<CassandraClient> pool) {\n         registerPoolMetric(\"meanBorrowWaitTimeMillis\", pool::getMeanBorrowWaitTimeMillis);", "originalCommit": "718c8b35f702015efe13394212e2cd11f7a01794", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg1NTgxMA==", "url": "https://github.com/palantir/atlasdb/pull/4873#discussion_r447855810", "bodyText": "Hmm. There are places where this does run into 40+ ms, though I'd be fine with removing it: not sure what this would be used for, and you only have one data point in a long while. So while I don't think it's a memory op it doesn't seem very valuable", "author": "jeremyk-91", "createdAt": "2020-06-30T17:25:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQ3OTE4OA=="}], "type": "inlineReview", "revised_code": {"commit": "47baaa84050f58cb553bf2f36d3e84ddd0eb399a", "chunk": "diff --git a/atlasdb-cassandra/src/main/java/com/palantir/atlasdb/keyvalue/cassandra/CassandraClientPoolingContainer.java b/atlasdb-cassandra/src/main/java/com/palantir/atlasdb/keyvalue/cassandra/CassandraClientPoolingContainer.java\nindex 196693c63c..41f9988bd7 100644\n--- a/atlasdb-cassandra/src/main/java/com/palantir/atlasdb/keyvalue/cassandra/CassandraClientPoolingContainer.java\n+++ b/atlasdb-cassandra/src/main/java/com/palantir/atlasdb/keyvalue/cassandra/CassandraClientPoolingContainer.java\n\n@@ -305,8 +305,6 @@ public class CassandraClientPoolingContainer implements PoolingContainer<Cassand\n \n     private void registerMetrics(GenericObjectPool<CassandraClient> pool) {\n         registerPoolMetric(\"meanActiveTimeMillis\", pool::getMeanActiveTimeMillis);\n-        registerPoolMetric(\"meanIdleTimeMillis\", pool::getMeanIdleTimeMillis);\n-        registerPoolMetric(\"meanBorrowWaitTimeMillis\", pool::getMeanBorrowWaitTimeMillis);\n         registerPoolMetric(\"numIdle\", pool::getNumIdle);\n         registerPoolMetric(\"numActive\", pool::getNumActive);\n         registerPoolMetric(\"created\", pool::getCreatedCount);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQ4Mzg1NA==", "url": "https://github.com/palantir/atlasdb/pull/4873#discussion_r447483854", "bodyText": "meanIdleTimeMillis is interesting: I guess it might tell you if your min connection pool size is too large, but I don't think anyone ever cares? Also the idle timeout is 10 minutes, so I'd vote for canning this one too, unless you can think of a purpose for it?", "author": "jkozlowski", "createdAt": "2020-06-30T07:53:47Z", "path": "atlasdb-cassandra/src/main/java/com/palantir/atlasdb/keyvalue/cassandra/CassandraClientPoolingContainer.java", "diffHunk": "@@ -309,14 +309,8 @@ private void registerMetrics(GenericObjectPool<CassandraClient> pool) {\n         registerPoolMetric(\"meanBorrowWaitTimeMillis\", pool::getMeanBorrowWaitTimeMillis);", "originalCommit": "718c8b35f702015efe13394212e2cd11f7a01794", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg1MzYxNw==", "url": "https://github.com/palantir/atlasdb/pull/4873#discussion_r447853617", "bodyText": "Yeah, didn't really have a purpose for this: the main one was just if it was very close to 10m that could be interesting, but agree that it's not particularly valuable. Let's kill it", "author": "jeremyk-91", "createdAt": "2020-06-30T17:21:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQ4Mzg1NA=="}], "type": "inlineReview", "revised_code": {"commit": "47baaa84050f58cb553bf2f36d3e84ddd0eb399a", "chunk": "diff --git a/atlasdb-cassandra/src/main/java/com/palantir/atlasdb/keyvalue/cassandra/CassandraClientPoolingContainer.java b/atlasdb-cassandra/src/main/java/com/palantir/atlasdb/keyvalue/cassandra/CassandraClientPoolingContainer.java\nindex 196693c63c..41f9988bd7 100644\n--- a/atlasdb-cassandra/src/main/java/com/palantir/atlasdb/keyvalue/cassandra/CassandraClientPoolingContainer.java\n+++ b/atlasdb-cassandra/src/main/java/com/palantir/atlasdb/keyvalue/cassandra/CassandraClientPoolingContainer.java\n\n@@ -305,8 +305,6 @@ public class CassandraClientPoolingContainer implements PoolingContainer<Cassand\n \n     private void registerMetrics(GenericObjectPool<CassandraClient> pool) {\n         registerPoolMetric(\"meanActiveTimeMillis\", pool::getMeanActiveTimeMillis);\n-        registerPoolMetric(\"meanIdleTimeMillis\", pool::getMeanIdleTimeMillis);\n-        registerPoolMetric(\"meanBorrowWaitTimeMillis\", pool::getMeanBorrowWaitTimeMillis);\n         registerPoolMetric(\"numIdle\", pool::getNumIdle);\n         registerPoolMetric(\"numActive\", pool::getNumActive);\n         registerPoolMetric(\"created\", pool::getCreatedCount);\n"}}, {"oid": "47baaa84050f58cb553bf2f36d3e84ddd0eb399a", "url": "https://github.com/palantir/atlasdb/commit/47baaa84050f58cb553bf2f36d3e84ddd0eb399a", "message": "Two more", "committedDate": "2020-06-30T17:25:45Z", "type": "commit"}, {"oid": "b444db333315fd98f55c54d99abb75837a06c7ed", "url": "https://github.com/palantir/atlasdb/commit/b444db333315fd98f55c54d99abb75837a06c7ed", "message": "why would we pick that one", "committedDate": "2020-06-30T18:13:17Z", "type": "commit"}]}