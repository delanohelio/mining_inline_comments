{"pr_number": 4894, "pr_title": "[LW] Test for lock watch updates that are too far behind", "pr_createdAt": "2020-07-09T13:36:27Z", "pr_url": "https://github.com/palantir/atlasdb/pull/4894", "timeline": [{"oid": "65f7e2745177983a34a0d42476f53f4e662a1b51", "url": "https://github.com/palantir/atlasdb/commit/65f7e2745177983a34a0d42476f53f4e662a1b51", "message": "add test for new case", "committedDate": "2020-07-09T13:30:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjIyMzAzMQ==", "url": "https://github.com/palantir/atlasdb/pull/4894#discussion_r452223031", "bodyText": "Already enforced elsewhere (i.e. must have a snapshot before processing successes), but this is just because we have to handle optionals everywhere.", "author": "Jolyon-S", "createdAt": "2020-07-09T13:37:15Z", "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/keyvalue/api/watch/LockWatchEventLog.java", "diffHunk": "@@ -120,6 +121,13 @@ private IdentifiedVersion getLatestVersionAndVerify(IdentifiedVersion endVersion\n \n     private void processSuccess(LockWatchStateUpdate.Success success) {\n         Preconditions.checkState(latestVersion.isPresent(), \"Must have a known version to process successful updates\");\n+        Optional<IdentifiedVersion> snapshotVersion = snapshot.getSnapshotVersion();\n+        Preconditions.checkState(snapshotVersion.isPresent(),\n+                \"Must have a snapshot before processing successful updates\");", "originalCommit": "65f7e2745177983a34a0d42476f53f4e662a1b51", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5607c7977b8d111cd87a3b748a84f6755aa21e82", "chunk": "diff --git a/atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/keyvalue/api/watch/LockWatchEventLog.java b/atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/keyvalue/api/watch/LockWatchEventLog.java\nindex 2ad05cf39c..00bbd8fe25 100644\n--- a/atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/keyvalue/api/watch/LockWatchEventLog.java\n+++ b/atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/keyvalue/api/watch/LockWatchEventLog.java\n\n@@ -126,7 +126,9 @@ final class LockWatchEventLog {\n                 \"Must have a snapshot before processing successful updates\");\n \n         if (success.lastKnownVersion() < snapshotVersion.get().version()) {\n-            throw new TransactionLockWatchFailedException(\"Cannot process events before the oldest event\");\n+            throw new TransactionLockWatchFailedException(\n+                    \"Cannot process events before the oldest event. The transaction should be retried, although this\"\n+                            + \" should only happen very rarely.\");\n         }\n \n         if (success.lastKnownVersion() > latestVersion.get().version()) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjIyMzE3MA==", "url": "https://github.com/palantir/atlasdb/pull/4894#discussion_r452223170", "bodyText": "Drive by fix.", "author": "Jolyon-S", "createdAt": "2020-07-09T13:37:25Z", "path": "atlasdb-impl-shared/src/test/java/com/palantir/atlasdb/keyvalue/api/watch/LockWatchEventCacheIntegrationTest.java", "diffHunk": "@@ -77,7 +78,7 @@\n             LockEvent.builder(ImmutableSet.of(DESCRIPTOR), LockToken.of(EVENT2_UUID)).build(7L);\n \n     private static final UUID LEADER = UUID.fromString(\"470c855e-f77b-44df-b56a-14d3df085dbc\");\n-    public static final LockWatchStateUpdate.Success SUCCESS_2 = LockWatchStateUpdate.success(LEADER, 7L,\n+    private static final LockWatchStateUpdate.Success SUCCESS_2 = LockWatchStateUpdate.success(LEADER, 7L,", "originalCommit": "65f7e2745177983a34a0d42476f53f4e662a1b51", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjI2OTI1NQ==", "url": "https://github.com/palantir/atlasdb/pull/4894#discussion_r452269255", "bodyText": "Checked that this should get retried both by atlasdb-proxy and atlasdb internally.", "author": "jkozlowski", "createdAt": "2020-07-09T14:41:41Z", "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/keyvalue/api/watch/LockWatchEventLog.java", "diffHunk": "@@ -120,6 +121,13 @@ private IdentifiedVersion getLatestVersionAndVerify(IdentifiedVersion endVersion\n \n     private void processSuccess(LockWatchStateUpdate.Success success) {\n         Preconditions.checkState(latestVersion.isPresent(), \"Must have a known version to process successful updates\");\n+        Optional<IdentifiedVersion> snapshotVersion = snapshot.getSnapshotVersion();\n+        Preconditions.checkState(snapshotVersion.isPresent(),\n+                \"Must have a snapshot before processing successful updates\");\n+\n+        if (success.lastKnownVersion() < snapshotVersion.get().version()) {\n+            throw new TransactionLockWatchFailedException(\"Cannot process events before the oldest event\");", "originalCommit": "65f7e2745177983a34a0d42476f53f4e662a1b51", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjI3MDMzNA==", "url": "https://github.com/palantir/atlasdb/pull/4894#discussion_r452270334", "bodyText": "You might wanna add a bit more around the \"this will be retried and should happen very rarely\".", "author": "jkozlowski", "createdAt": "2020-07-09T14:43:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjI2OTI1NQ=="}], "type": "inlineReview", "revised_code": {"commit": "5607c7977b8d111cd87a3b748a84f6755aa21e82", "chunk": "diff --git a/atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/keyvalue/api/watch/LockWatchEventLog.java b/atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/keyvalue/api/watch/LockWatchEventLog.java\nindex 2ad05cf39c..00bbd8fe25 100644\n--- a/atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/keyvalue/api/watch/LockWatchEventLog.java\n+++ b/atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/keyvalue/api/watch/LockWatchEventLog.java\n\n@@ -126,7 +126,9 @@ final class LockWatchEventLog {\n                 \"Must have a snapshot before processing successful updates\");\n \n         if (success.lastKnownVersion() < snapshotVersion.get().version()) {\n-            throw new TransactionLockWatchFailedException(\"Cannot process events before the oldest event\");\n+            throw new TransactionLockWatchFailedException(\n+                    \"Cannot process events before the oldest event. The transaction should be retried, although this\"\n+                            + \" should only happen very rarely.\");\n         }\n \n         if (success.lastKnownVersion() > latestVersion.get().version()) {\n"}}, {"oid": "5607c7977b8d111cd87a3b748a84f6755aa21e82", "url": "https://github.com/palantir/atlasdb/commit/5607c7977b8d111cd87a3b748a84f6755aa21e82", "message": "extend message", "committedDate": "2020-07-09T14:45:47Z", "type": "commit"}, {"oid": "356eab8f6274aa294c81e7faef7d21fc95d3fd0d", "url": "https://github.com/palantir/atlasdb/commit/356eab8f6274aa294c81e7faef7d21fc95d3fd0d", "message": "fix test", "committedDate": "2020-07-09T14:46:35Z", "type": "commit"}]}