{"pr_number": 4575, "pr_title": "[Conjure Java Runtime] Part 28: Modernisation and Recovery of Jepsen", "pr_createdAt": "2020-02-13T22:37:18Z", "pr_url": "https://github.com/palantir/atlasdb/pull/4575", "timeline": [{"oid": "b5059ed41e6692b19e1a3a46bb0cc1fd87aa4e09", "url": "https://github.com/palantir/atlasdb/commit/b5059ed41e6692b19e1a3a46bb0cc1fd87aa4e09", "message": "Use openjdk", "committedDate": "2020-02-13T22:16:05Z", "type": "commit"}, {"oid": "94a061fd723bcb0c7a416306cea58d45ee0960e3", "url": "https://github.com/palantir/atlasdb/commit/94a061fd723bcb0c7a416306cea58d45ee0960e3", "message": "Security", "committedDate": "2020-02-13T22:16:05Z", "type": "commit"}, {"oid": "41dc5465a4c636e15a384ef4ad68665b355e394c", "url": "https://github.com/palantir/atlasdb/commit/41dc5465a4c636e15a384ef4ad68665b355e394c", "message": "More stuff", "committedDate": "2020-02-13T22:16:05Z", "type": "commit"}, {"oid": "987daee087a3593f2b923e01cb0f31ff88bd54fd", "url": "https://github.com/palantir/atlasdb/commit/987daee087a3593f2b923e01cb0f31ff88bd54fd", "message": "Fix bad naming", "committedDate": "2020-02-13T22:31:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEwMTU2OQ==", "url": "https://github.com/palantir/atlasdb/pull/4575#discussion_r380101569", "bodyText": "Why don't we use UserAgent.Agent.DEFAULT_VERSION anymore?", "author": "Jolyon-S", "createdAt": "2020-02-17T10:31:13Z", "path": "atlasdb-jepsen-tests/src/main/java/com/palantir/atlasdb/http/TimelockUtils.java", "diffHunk": "@@ -43,21 +46,26 @@ private TimelockUtils() {\n     }\n \n     private static List<String> hostnamesToEndpointUris(List<String> hosts) {\n-        return Lists.transform(hosts, host -> String.format(\"https://%s:%d/%s\", host, PORT, NAMESPACE));\n+        return hosts.stream().map(host -> String.format(\"https://%s:%d\", host, PORT)).collect(Collectors.toList());\n     }\n \n     private static <T> T createFromUris(MetricsManager metricsManager, List<String> endpointUris, Class<T> type) {\n+        ServerListConfig serverListConfig = ImmutableServerListConfig.builder()\n+                .addAllServers(endpointUris)\n+                .sslConfiguration(SSL_CONFIGURATION)\n+                .build();\n+        // lock technically blocking, but OK to run with short timeout given the way the tests work.\n+        AuxiliaryRemotingParameters build = AuxiliaryRemotingParameters.builder()\n+                .shouldRetry(false)\n+                .shouldLimitPayload(false)\n+                .shouldSupportBlockingOperations(false)\n+                .userAgent(UserAgent.of(UserAgent.Agent.of(\"atlasdb-jepsen\", \"1.2.3\")))", "originalCommit": "987daee087a3593f2b923e01cb0f31ff88bd54fd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDE5MzYxMg==", "url": "https://github.com/palantir/atlasdb/pull/4575#discussion_r380193612", "bodyText": "I imagine it's slightly more identifiable, but can't think of another reason other than that \ud83e\udd37\u200d\u2642", "author": "felixdesouza", "createdAt": "2020-02-17T13:52:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEwMTU2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM5MzY4OQ==", "url": "https://github.com/palantir/atlasdb/pull/4575#discussion_r383393689", "bodyText": "Ah, that's fair, I forgot that existed - changed to that.", "author": "jeremyk-91", "createdAt": "2020-02-24T17:04:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEwMTU2OQ=="}], "type": "inlineReview", "revised_code": {"commit": "fc7552f3444ffedf2182a60ada34111b76a5cb6d", "chunk": "diff --git a/atlasdb-jepsen-tests/src/main/java/com/palantir/atlasdb/http/TimelockUtils.java b/atlasdb-jepsen-tests/src/main/java/com/palantir/atlasdb/http/TimelockUtils.java\nindex ab722085c6..20fb9ee9ec 100644\n--- a/atlasdb-jepsen-tests/src/main/java/com/palantir/atlasdb/http/TimelockUtils.java\n+++ b/atlasdb-jepsen-tests/src/main/java/com/palantir/atlasdb/http/TimelockUtils.java\n\n@@ -55,17 +55,17 @@ public final class TimelockUtils {\n                 .sslConfiguration(SSL_CONFIGURATION)\n                 .build();\n         // lock technically blocking, but OK to run with short timeout given the way the tests work.\n-        AuxiliaryRemotingParameters build = AuxiliaryRemotingParameters.builder()\n+        AuxiliaryRemotingParameters parameters = AuxiliaryRemotingParameters.builder()\n                 .shouldRetry(false)\n                 .shouldLimitPayload(false)\n                 .shouldSupportBlockingOperations(false)\n-                .userAgent(UserAgent.of(UserAgent.Agent.of(\"atlasdb-jepsen\", \"1.2.3\")))\n+                .userAgent(UserAgent.of(UserAgent.Agent.of(\"atlasdb-jepsen\", UserAgent.Agent.DEFAULT_VERSION)))\n                 .build();\n \n         return AtlasDbHttpClients.createProxyWithQuickFailoverForTesting(\n                 metricsManager,\n                 serverListConfig,\n                 type,\n-                build);\n+                parameters);\n     }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDE5NDA0Mw==", "url": "https://github.com/palantir/atlasdb/pull/4575#discussion_r380194043", "bodyText": "why is this okay? what happens if you make it the same as how it's used in prod?", "author": "felixdesouza", "createdAt": "2020-02-17T13:53:25Z", "path": "atlasdb-jepsen-tests/src/main/java/com/palantir/atlasdb/http/TimelockUtils.java", "diffHunk": "@@ -43,21 +46,26 @@ private TimelockUtils() {\n     }\n \n     private static List<String> hostnamesToEndpointUris(List<String> hosts) {\n-        return Lists.transform(hosts, host -> String.format(\"https://%s:%d/%s\", host, PORT, NAMESPACE));\n+        return hosts.stream().map(host -> String.format(\"https://%s:%d\", host, PORT)).collect(Collectors.toList());\n     }\n \n     private static <T> T createFromUris(MetricsManager metricsManager, List<String> endpointUris, Class<T> type) {\n+        ServerListConfig serverListConfig = ImmutableServerListConfig.builder()\n+                .addAllServers(endpointUris)\n+                .sslConfiguration(SSL_CONFIGURATION)\n+                .build();\n+        // lock technically blocking, but OK to run with short timeout given the way the tests work.", "originalCommit": "987daee087a3593f2b923e01cb0f31ff88bd54fd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM5NDI4Mw==", "url": "https://github.com/palantir/atlasdb/pull/4575#discussion_r383394283", "bodyText": "Is also fine, just that I'm not really a fan of duplicating that logic here, and it seems a bit unpleasant to expose internals of TransactionManagers to simulate that wrapping. Let me know what you think.", "author": "jeremyk-91", "createdAt": "2020-02-24T17:06:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDE5NDA0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzAwMTA4NQ==", "url": "https://github.com/palantir/atlasdb/pull/4575#discussion_r387001085", "bodyText": "I suppose I'm asking from a perspective of \"will jepsen say there's an illegal trace, when really it would never happen in prod\"?", "author": "felixdesouza", "createdAt": "2020-03-03T12:57:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDE5NDA0Mw=="}], "type": "inlineReview", "revised_code": {"commit": "fc7552f3444ffedf2182a60ada34111b76a5cb6d", "chunk": "diff --git a/atlasdb-jepsen-tests/src/main/java/com/palantir/atlasdb/http/TimelockUtils.java b/atlasdb-jepsen-tests/src/main/java/com/palantir/atlasdb/http/TimelockUtils.java\nindex ab722085c6..20fb9ee9ec 100644\n--- a/atlasdb-jepsen-tests/src/main/java/com/palantir/atlasdb/http/TimelockUtils.java\n+++ b/atlasdb-jepsen-tests/src/main/java/com/palantir/atlasdb/http/TimelockUtils.java\n\n@@ -55,17 +55,17 @@ public final class TimelockUtils {\n                 .sslConfiguration(SSL_CONFIGURATION)\n                 .build();\n         // lock technically blocking, but OK to run with short timeout given the way the tests work.\n-        AuxiliaryRemotingParameters build = AuxiliaryRemotingParameters.builder()\n+        AuxiliaryRemotingParameters parameters = AuxiliaryRemotingParameters.builder()\n                 .shouldRetry(false)\n                 .shouldLimitPayload(false)\n                 .shouldSupportBlockingOperations(false)\n-                .userAgent(UserAgent.of(UserAgent.Agent.of(\"atlasdb-jepsen\", \"1.2.3\")))\n+                .userAgent(UserAgent.of(UserAgent.Agent.of(\"atlasdb-jepsen\", UserAgent.Agent.DEFAULT_VERSION)))\n                 .build();\n \n         return AtlasDbHttpClients.createProxyWithQuickFailoverForTesting(\n                 metricsManager,\n                 serverListConfig,\n                 type,\n-                build);\n+                parameters);\n     }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDE5NDcxNQ==", "url": "https://github.com/palantir/atlasdb/pull/4575#discussion_r380194715", "bodyText": "nit: build -> parameters", "author": "felixdesouza", "createdAt": "2020-02-17T13:54:43Z", "path": "atlasdb-jepsen-tests/src/main/java/com/palantir/atlasdb/http/TimelockUtils.java", "diffHunk": "@@ -43,21 +46,26 @@ private TimelockUtils() {\n     }\n \n     private static List<String> hostnamesToEndpointUris(List<String> hosts) {\n-        return Lists.transform(hosts, host -> String.format(\"https://%s:%d/%s\", host, PORT, NAMESPACE));\n+        return hosts.stream().map(host -> String.format(\"https://%s:%d\", host, PORT)).collect(Collectors.toList());\n     }\n \n     private static <T> T createFromUris(MetricsManager metricsManager, List<String> endpointUris, Class<T> type) {\n+        ServerListConfig serverListConfig = ImmutableServerListConfig.builder()\n+                .addAllServers(endpointUris)\n+                .sslConfiguration(SSL_CONFIGURATION)\n+                .build();\n+        // lock technically blocking, but OK to run with short timeout given the way the tests work.\n+        AuxiliaryRemotingParameters build = AuxiliaryRemotingParameters.builder()", "originalCommit": "987daee087a3593f2b923e01cb0f31ff88bd54fd", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "fc7552f3444ffedf2182a60ada34111b76a5cb6d", "chunk": "diff --git a/atlasdb-jepsen-tests/src/main/java/com/palantir/atlasdb/http/TimelockUtils.java b/atlasdb-jepsen-tests/src/main/java/com/palantir/atlasdb/http/TimelockUtils.java\nindex ab722085c6..20fb9ee9ec 100644\n--- a/atlasdb-jepsen-tests/src/main/java/com/palantir/atlasdb/http/TimelockUtils.java\n+++ b/atlasdb-jepsen-tests/src/main/java/com/palantir/atlasdb/http/TimelockUtils.java\n\n@@ -55,17 +55,17 @@ public final class TimelockUtils {\n                 .sslConfiguration(SSL_CONFIGURATION)\n                 .build();\n         // lock technically blocking, but OK to run with short timeout given the way the tests work.\n-        AuxiliaryRemotingParameters build = AuxiliaryRemotingParameters.builder()\n+        AuxiliaryRemotingParameters parameters = AuxiliaryRemotingParameters.builder()\n                 .shouldRetry(false)\n                 .shouldLimitPayload(false)\n                 .shouldSupportBlockingOperations(false)\n-                .userAgent(UserAgent.of(UserAgent.Agent.of(\"atlasdb-jepsen\", \"1.2.3\")))\n+                .userAgent(UserAgent.of(UserAgent.Agent.of(\"atlasdb-jepsen\", UserAgent.Agent.DEFAULT_VERSION)))\n                 .build();\n \n         return AtlasDbHttpClients.createProxyWithQuickFailoverForTesting(\n                 metricsManager,\n                 serverListConfig,\n                 type,\n-                build);\n+                parameters);\n     }\n }\n"}}, {"oid": "fc7552f3444ffedf2182a60ada34111b76a5cb6d", "url": "https://github.com/palantir/atlasdb/commit/fc7552f3444ffedf2182a60ada34111b76a5cb6d", "message": "CR feedback", "committedDate": "2020-02-24T17:06:29Z", "type": "commit"}, {"oid": "9d9ed3a6eb655cc5bfb8c25e8d79b54059b480bd", "url": "https://github.com/palantir/atlasdb/commit/9d9ed3a6eb655cc5bfb8c25e8d79b54059b480bd", "message": "Give certs expiry dates probably long after AtlasDB stops being used.", "committedDate": "2020-02-24T17:22:38Z", "type": "commit"}, {"oid": "80c4d4964af0768660e49b349bf1b55d9b056de9", "url": "https://github.com/palantir/atlasdb/commit/80c4d4964af0768660e49b349bf1b55d9b056de9", "message": "Merge conflicts", "committedDate": "2020-02-24T17:37:01Z", "type": "commit"}, {"oid": "018016bfb1b1a3dfb03cf6cd4f32bc623526d4b8", "url": "https://github.com/palantir/atlasdb/commit/018016bfb1b1a3dfb03cf6cd4f32bc623526d4b8", "message": "Fix timestamp client", "committedDate": "2020-03-03T11:20:36Z", "type": "commit"}, {"oid": "8a600b6ff4b95d6967f716f61c21169e0ea26001", "url": "https://github.com/palantir/atlasdb/commit/8a600b6ff4b95d6967f716f61c21169e0ea26001", "message": "Make us assume stuff blocks", "committedDate": "2020-03-03T14:46:15Z", "type": "commit"}]}