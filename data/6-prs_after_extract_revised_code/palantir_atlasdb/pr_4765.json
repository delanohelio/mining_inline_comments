{"pr_number": 4765, "pr_title": "[PaxosStateLog] Migrator and unit tests", "pr_createdAt": "2020-05-12T16:56:11Z", "pr_url": "https://github.com/palantir/atlasdb/pull/4765", "timeline": [{"oid": "431e13c92f685057a13763a68da17e43f3999754", "url": "https://github.com/palantir/atlasdb/commit/431e13c92f685057a13763a68da17e43f3999754", "message": "First impl, needs tests", "committedDate": "2020-04-28T14:57:25Z", "type": "commit"}, {"oid": "7d572d5f345a796089bd96e74da375d8c6b6c23a", "url": "https://github.com/palantir/atlasdb/commit/7d572d5f345a796089bd96e74da375d8c6b6c23a", "message": "Wip", "committedDate": "2020-05-12T12:22:02Z", "type": "commit"}, {"oid": "0f6d72207367f9fcbc07e182d2cefceb5e83be19", "url": "https://github.com/palantir/atlasdb/commit/0f6d72207367f9fcbc07e182d2cefceb5e83be19", "message": "Merge with develop", "committedDate": "2020-05-12T13:22:34Z", "type": "commit"}, {"oid": "bba086ba6fa3a7f2c9cf699880e325bc817261c8", "url": "https://github.com/palantir/atlasdb/commit/bba086ba6fa3a7f2c9cf699880e325bc817261c8", "message": "Finish up", "committedDate": "2020-05-12T16:26:41Z", "type": "commit"}, {"oid": "494fb155d9589f34e982373c9d279e46d12401bc", "url": "https://github.com/palantir/atlasdb/commit/494fb155d9589f34e982373c9d279e46d12401bc", "message": "Remove unused code and fix checkstyle", "committedDate": "2020-05-12T16:36:10Z", "type": "commit"}, {"oid": "73902d110af21cf12241005aaa29ea785e649780", "url": "https://github.com/palantir/atlasdb/commit/73902d110af21cf12241005aaa29ea785e649780", "message": "Clear up name", "committedDate": "2020-05-12T16:39:28Z", "type": "commit"}, {"oid": "d43594469c3921f79c3aa8418a5c99b8ef34d3c8", "url": "https://github.com/palantir/atlasdb/commit/d43594469c3921f79c3aa8418a5c99b8ef34d3c8", "message": "Clean up tests", "committedDate": "2020-05-12T16:55:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkwMzM5MA==", "url": "https://github.com/palantir/atlasdb/pull/4765#discussion_r423903390", "bodyText": "Non-actionable: sigh. This was almost entirely agnostic of SQLite. Given we aren't going to be implementing another migration state any time soon though, I'd say leave it.", "author": "jeremyk-91", "createdAt": "2020-05-12T17:19:52Z", "path": "leader-election-impl/src/main/java/com/palantir/paxos/PaxosStateLogMigrator.java", "diffHunk": "@@ -0,0 +1,83 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.paxos;\n+\n+import java.util.stream.LongStream;\n+\n+import org.immutables.value.Value;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.palantir.common.persist.Persistable;\n+\n+public final class PaxosStateLogMigrator<V extends Persistable & Versionable> {\n+    @VisibleForTesting\n+    static final int BATCH_SIZE = 10_000;\n+\n+    private final PaxosStateLog<V> sourceLog;\n+    private final PaxosStateLog<V> destinationLog;\n+    private final Persistable.Hydrator<V> hydrator;\n+    private final SqlitePaxosStateLogMigrationState migrationState;", "originalCommit": "d43594469c3921f79c3aa8418a5c99b8ef34d3c8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "19eb9f9a50374a715738623b6160bec10b968e83", "chunk": "diff --git a/leader-election-impl/src/main/java/com/palantir/paxos/PaxosStateLogMigrator.java b/leader-election-impl/src/main/java/com/palantir/paxos/PaxosStateLogMigrator.java\nindex 530faf46bc..bf4933c593 100644\n--- a/leader-election-impl/src/main/java/com/palantir/paxos/PaxosStateLogMigrator.java\n+++ b/leader-election-impl/src/main/java/com/palantir/paxos/PaxosStateLogMigrator.java\n\n@@ -55,9 +55,15 @@ public final class PaxosStateLogMigrator<V extends Persistable & Versionable> {\n         if (migrationState.hasAlreadyMigrated()) {\n             return;\n         }\n+\n         destinationLog.truncate(destinationLog.getGreatestLogEntry());\n         long lowerBound = lowestSequenceToMigrate();\n         long upperBound = sourceLog.getGreatestLogEntry();\n+        if (upperBound == PaxosAcceptor.NO_LOG_ENTRY) {\n+            migrationState.finishMigration();\n+            return;\n+        }\n+        \n         try (PaxosStateLogBatchReader<V> reader = new PaxosStateLogBatchReader<>(sourceLog, hydrator, 100)) {\n             long numberOfBatches = (upperBound - lowerBound) / BATCH_SIZE + 1;\n             LongStream.iterate(lowerBound, x -> x + BATCH_SIZE)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkwNzU3Mg==", "url": "https://github.com/palantir/atlasdb/pull/4765#discussion_r423907572", "bodyText": "It's benign, but to avoid future confusion we should handle the edge case here: this method returns PaxosAcceptor.NO_LOG_ENTRY if there are zero entries in the source log, meaning that numberOfBatches = (-1 - 0) / BATCH_SIZE + 1 which by Java semantics is actually 1. Then there is a batch from zero to BATCH_SIZE entries that the reader will try and read.", "author": "jeremyk-91", "createdAt": "2020-05-12T17:26:45Z", "path": "leader-election-impl/src/main/java/com/palantir/paxos/PaxosStateLogMigrator.java", "diffHunk": "@@ -0,0 +1,83 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.paxos;\n+\n+import java.util.stream.LongStream;\n+\n+import org.immutables.value.Value;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.palantir.common.persist.Persistable;\n+\n+public final class PaxosStateLogMigrator<V extends Persistable & Versionable> {\n+    @VisibleForTesting\n+    static final int BATCH_SIZE = 10_000;\n+\n+    private final PaxosStateLog<V> sourceLog;\n+    private final PaxosStateLog<V> destinationLog;\n+    private final Persistable.Hydrator<V> hydrator;\n+    private final SqlitePaxosStateLogMigrationState migrationState;\n+\n+    private PaxosStateLogMigrator(PaxosStateLog<V> sourceLog,\n+            PaxosStateLog<V> destinationLog,\n+            Persistable.Hydrator<V> hydrator,\n+            SqlitePaxosStateLogMigrationState migrationState) {\n+        this.sourceLog = sourceLog;\n+        this.destinationLog = destinationLog;\n+        this.hydrator = hydrator;\n+        this.migrationState = migrationState;\n+    }\n+\n+    public static <V extends Persistable & Versionable> void migrate(MigrationContext<V> migrationContext) {\n+        PaxosStateLogMigrator<V> migrator = new PaxosStateLogMigrator<>(\n+                migrationContext.sourceLog(),\n+                migrationContext.destinationLog(),\n+                migrationContext.hydrator(),\n+                migrationContext.migrationState());\n+        migrator.runMigration();\n+    }\n+\n+    private void runMigration() {\n+        if (migrationState.hasAlreadyMigrated()) {\n+            return;\n+        }\n+        destinationLog.truncate(destinationLog.getGreatestLogEntry());\n+        long lowerBound = lowestSequenceToMigrate();\n+        long upperBound = sourceLog.getGreatestLogEntry();", "originalCommit": "d43594469c3921f79c3aa8418a5c99b8ef34d3c8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDMwODA2OA==", "url": "https://github.com/palantir/atlasdb/pull/4765#discussion_r424308068", "bodyText": "\ud83d\udc4d", "author": "gmaretic", "createdAt": "2020-05-13T09:40:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkwNzU3Mg=="}], "type": "inlineReview", "revised_code": {"commit": "19eb9f9a50374a715738623b6160bec10b968e83", "chunk": "diff --git a/leader-election-impl/src/main/java/com/palantir/paxos/PaxosStateLogMigrator.java b/leader-election-impl/src/main/java/com/palantir/paxos/PaxosStateLogMigrator.java\nindex 530faf46bc..bf4933c593 100644\n--- a/leader-election-impl/src/main/java/com/palantir/paxos/PaxosStateLogMigrator.java\n+++ b/leader-election-impl/src/main/java/com/palantir/paxos/PaxosStateLogMigrator.java\n\n@@ -55,9 +55,15 @@ public final class PaxosStateLogMigrator<V extends Persistable & Versionable> {\n         if (migrationState.hasAlreadyMigrated()) {\n             return;\n         }\n+\n         destinationLog.truncate(destinationLog.getGreatestLogEntry());\n         long lowerBound = lowestSequenceToMigrate();\n         long upperBound = sourceLog.getGreatestLogEntry();\n+        if (upperBound == PaxosAcceptor.NO_LOG_ENTRY) {\n+            migrationState.finishMigration();\n+            return;\n+        }\n+        \n         try (PaxosStateLogBatchReader<V> reader = new PaxosStateLogBatchReader<>(sourceLog, hydrator, 100)) {\n             long numberOfBatches = (upperBound - lowerBound) / BATCH_SIZE + 1;\n             LongStream.iterate(lowerBound, x -> x + BATCH_SIZE)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkwNzk4MA==", "url": "https://github.com/palantir/atlasdb/pull/4765#discussion_r423907980", "bodyText": "\ud83c\udf89", "author": "jeremyk-91", "createdAt": "2020-05-12T17:27:26Z", "path": "leader-election-impl/src/main/java/com/palantir/paxos/SqlitePaxosStateLog.java", "diffHunk": "@@ -97,7 +96,7 @@ public void truncate(long toDeleteInclusive) {\n         @SqlUpdate(\"CREATE TABLE IF NOT EXISTS paxosLog (\"\n                 + \"namespace TEXT,\"\n                 + \"useCase TEXT,\"\n-                + \"seq BIGINT, \"\n+                + \"seq BIGINT,\"", "originalCommit": "d43594469c3921f79c3aa8418a5c99b8ef34d3c8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkwOTUwOA==", "url": "https://github.com/palantir/atlasdb/pull/4765#discussion_r423909508", "bodyText": "nice!", "author": "jeremyk-91", "createdAt": "2020-05-12T17:29:46Z", "path": "leader-election-impl/src/test/java/com/palantir/paxos/PaxosStateLogMigratorTest.java", "diffHunk": "@@ -0,0 +1,167 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.paxos;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.ArgumentMatchers.anyLong;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+import static com.palantir.paxos.PaxosStateLogMigrator.BATCH_SIZE;\n+\n+import java.io.IOException;\n+import java.sql.Connection;\n+import java.util.List;\n+import java.util.function.Supplier;\n+import java.util.stream.Collectors;\n+import java.util.stream.LongStream;\n+\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.rules.TemporaryFolder;\n+\n+import com.palantir.common.base.Throwables;\n+\n+public class PaxosStateLogMigratorTest {\n+    private static final NamespaceAndUseCase NAMESPACE = ImmutableNamespaceAndUseCase.of(Client.of(\"client\"), \"tom\");\n+\n+    @Rule\n+    public TemporaryFolder tempFolder = new TemporaryFolder();\n+\n+    private PaxosStateLog<PaxosValue> source;\n+    private PaxosStateLog<PaxosValue> target;\n+    private SqlitePaxosStateLogMigrationState migrationState;\n+\n+    @Before\n+    public void setup() throws IOException {\n+        Supplier<Connection> sourceConnSupplier = SqliteConnections\n+                .createDefaultNamedSqliteDatabaseAtPath(tempFolder.newFolder(\"source\").toPath());\n+        Supplier<Connection> targetConnSupplier = SqliteConnections\n+                .createDefaultNamedSqliteDatabaseAtPath(tempFolder.newFolder(\"target\").toPath());\n+        source = SqlitePaxosStateLog.create(NAMESPACE, sourceConnSupplier);\n+        target = SqlitePaxosStateLog.create(NAMESPACE, targetConnSupplier);\n+        migrationState = SqlitePaxosStateLogMigrationState.create(NAMESPACE, targetConnSupplier);\n+    }\n+\n+    @Test\n+    public void emptyLogMigrationSuccessfullyMarksAsMigrated() {\n+        migrateFrom(source);\n+        assertThat(migrationState.hasAlreadyMigrated()).isTrue();\n+    }\n+\n+    @Test\n+    public void logMigrationSuccessfullyMigratesEntries() {\n+        long lowerBound = 10;\n+        long upperBound = 25;\n+        List<PaxosValue> valuesWritten = insertValuesWithinBounds(lowerBound, upperBound, source);\n+\n+        migrateFrom(source);\n+        assertThat(migrationState.hasAlreadyMigrated()).isTrue();\n+        assertThat(target.getLeastLogEntry()).isEqualTo(lowerBound);\n+        assertThat(target.getGreatestLogEntry()).isEqualTo(upperBound);\n+\n+        valuesWritten.forEach(value ->\n+                assertThat(PaxosValue.BYTES_HYDRATOR.hydrateFromBytes(readRoundUnchecked(value.seq))).isEqualTo(value));\n+    }\n+\n+    @Test\n+    public void migrationDeletesExistingState() {\n+        long lowerBound = 13;\n+        long upperBound = 35;\n+        List<PaxosValue> valuesWritten = insertValuesWithinBounds(lowerBound, upperBound, target);\n+\n+        migrateFrom(source);\n+        assertThat(migrationState.hasAlreadyMigrated()).isTrue();\n+        assertThat(target.getLeastLogEntry()).isEqualTo(PaxosAcceptor.NO_LOG_ENTRY);\n+        assertThat(target.getGreatestLogEntry()).isEqualTo(PaxosAcceptor.NO_LOG_ENTRY);\n+        valuesWritten.forEach(value -> assertThat(readRoundUnchecked(value.seq)).isNull());\n+    }\n+\n+    @Test\n+    public void doNotMigrateIfAlreadyMigrated() {\n+        migrationState.finishMigration();\n+\n+        long lowerBound = 1;\n+        long upperBound = 22;\n+        List<PaxosValue> valuesWritten = insertValuesWithinBounds(lowerBound, upperBound, source);\n+\n+        migrateFrom(source);\n+\n+        assertThat(migrationState.hasAlreadyMigrated()).isTrue();\n+        assertThat(target.getLeastLogEntry()).isEqualTo(PaxosAcceptor.NO_LOG_ENTRY);\n+        assertThat(target.getGreatestLogEntry()).isEqualTo(PaxosAcceptor.NO_LOG_ENTRY);\n+        valuesWritten.forEach(value -> assertThat(readRoundUnchecked(value.seq)).isNull());\n+    }\n+\n+    @Test\n+    public void logMigrationSuccessfullyMigratesManyEntriesIncludingSingleEntryInLastBatch() throws IOException {\n+        long lowerBound = 10;\n+        long upperBound = lowerBound + BATCH_SIZE * 10;\n+\n+        PaxosStateLog<PaxosValue> mockLog = mock(PaxosStateLog.class);\n+\n+        when(mockLog.getLeastLogEntry()).thenReturn(lowerBound);\n+        when(mockLog.getGreatestLogEntry()).thenReturn(upperBound);\n+        when(mockLog.readRound(anyLong())).thenAnswer(invocation -> {\n+            long sequence = (long) invocation.getArguments()[0];\n+            if (sequence > upperBound || sequence < lowerBound) {\n+                return null;\n+            }\n+            return valueForRound(sequence).persistToBytes();", "originalCommit": "d43594469c3921f79c3aa8418a5c99b8ef34d3c8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "19eb9f9a50374a715738623b6160bec10b968e83", "url": "https://github.com/palantir/atlasdb/commit/19eb9f9a50374a715738623b6160bec10b968e83", "message": "Exit early if nothing to migrate", "committedDate": "2020-05-13T09:53:46Z", "type": "commit"}, {"oid": "925eae45e2fb8f744a858ccf751478fc024233fc", "url": "https://github.com/palantir/atlasdb/commit/925eae45e2fb8f744a858ccf751478fc024233fc", "message": "Remove phantom spacing", "committedDate": "2020-05-13T10:44:39Z", "type": "commit"}]}