{"pr_number": 5084, "pr_title": "[PSL] Better Logging and Option to Skip Validation + Truncate for PSL Migration", "pr_createdAt": "2020-10-27T15:41:12Z", "pr_url": "https://github.com/palantir/atlasdb/pull/5084", "timeline": [{"oid": "79872258fa2b1545a8b55a23d9a8d9065766f966", "url": "https://github.com/palantir/atlasdb/commit/79872258fa2b1545a8b55a23d9a8d9065766f966", "message": "Commit", "committedDate": "2020-10-27T15:05:25Z", "type": "commit"}, {"oid": "dfa2b98904d3e0dd3a5ccf51ff51ac6fea47fd4d", "url": "https://github.com/palantir/atlasdb/commit/dfa2b98904d3e0dd3a5ccf51ff51ac6fea47fd4d", "message": "Merge with develop", "committedDate": "2020-10-27T15:07:52Z", "type": "commit"}, {"oid": "c3455cde555dd05440891d4b4b9eae82dff08c8d", "url": "https://github.com/palantir/atlasdb/commit/c3455cde555dd05440891d4b4b9eae82dff08c8d", "message": "Be more defensive", "committedDate": "2020-10-27T15:38:56Z", "type": "commit"}, {"oid": "09128e1cc7d4a93af8f09fe33b6a5ecf9c2e3bdb", "url": "https://github.com/palantir/atlasdb/commit/09128e1cc7d4a93af8f09fe33b6a5ecf9c2e3bdb", "message": "Luckily have tests", "committedDate": "2020-10-27T16:37:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjkxMzU4NQ==", "url": "https://github.com/palantir/atlasdb/pull/5084#discussion_r512913585", "bodyText": "wat", "author": "jeremyk-91", "createdAt": "2020-10-27T18:01:18Z", "path": "leader-election-impl/src/main/java/com/palantir/paxos/PaxosStateLogImpl.java", "diffHunk": "@@ -223,7 +224,7 @@ public void truncate(long toDeleteInclusive) {\n             for (File file : files) {\n                 long fileSeq = getSeqFromFilename(file);\n                 if (fileSeq <= toDeleteInclusive) {\n-                    if (file.delete()) {\n+                    if (!file.delete()) {\n                         log.warn(\"failed to delete log file {}\", file.getAbsolutePath());", "originalCommit": "09128e1cc7d4a93af8f09fe33b6a5ecf9c2e3bdb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjkxMzY3Mg==", "url": "https://github.com/palantir/atlasdb/pull/5084#discussion_r512913672", "bodyText": "good spot though!", "author": "jeremyk-91", "createdAt": "2020-10-27T18:01:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjkxMzU4NQ=="}], "type": "inlineReview", "revised_code": {"commit": "f3fabf2f607154f01161dccc07ba01837275cabc", "chunk": "diff --git a/leader-election-impl/src/main/java/com/palantir/paxos/PaxosStateLogImpl.java b/leader-election-impl/src/main/java/com/palantir/paxos/PaxosStateLogImpl.java\nindex 2971fb5ef0..5f35b71e52 100644\n--- a/leader-election-impl/src/main/java/com/palantir/paxos/PaxosStateLogImpl.java\n+++ b/leader-election-impl/src/main/java/com/palantir/paxos/PaxosStateLogImpl.java\n\n@@ -224,9 +224,7 @@ public class PaxosStateLogImpl<V extends Persistable & Versionable> implements P\n             for (File file : files) {\n                 long fileSeq = getSeqFromFilename(file);\n                 if (fileSeq <= toDeleteInclusive) {\n-                    if (!file.delete()) {\n-                        log.warn(\"failed to delete log file {}\", file.getAbsolutePath());\n-                    }\n+                    deleteLogFile(file);\n                 } else {\n                     break;\n                 }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjkxNDE4Mg==", "url": "https://github.com/palantir/atlasdb/pull/5084#discussion_r512914182", "bodyText": "nit: could we include, at least at Unsafe level, the directory involved?", "author": "jeremyk-91", "createdAt": "2020-10-27T18:02:09Z", "path": "leader-election-impl/src/main/java/com/palantir/paxos/PaxosStateLogImpl.java", "diffHunk": "@@ -235,10 +236,24 @@ public void truncate(long toDeleteInclusive) {\n         }\n     }\n \n+    @Override\n+    public void truncateAllRounds() {\n+        lock.writeLock().lock();\n+        try {\n+            File dir = new File(path);\n+            boolean success = getLogEntries(dir).stream().map(File::delete).reduce(true, (x, y) -> x && y);\n+            if (!success) {\n+                log.warn(\"failed to delete all log files.\");", "originalCommit": "09128e1cc7d4a93af8f09fe33b6a5ecf9c2e3bdb", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f3fabf2f607154f01161dccc07ba01837275cabc", "chunk": "diff --git a/leader-election-impl/src/main/java/com/palantir/paxos/PaxosStateLogImpl.java b/leader-election-impl/src/main/java/com/palantir/paxos/PaxosStateLogImpl.java\nindex 2971fb5ef0..5f35b71e52 100644\n--- a/leader-election-impl/src/main/java/com/palantir/paxos/PaxosStateLogImpl.java\n+++ b/leader-election-impl/src/main/java/com/palantir/paxos/PaxosStateLogImpl.java\n\n@@ -241,15 +239,18 @@ public class PaxosStateLogImpl<V extends Persistable & Versionable> implements P\n         lock.writeLock().lock();\n         try {\n             File dir = new File(path);\n-            boolean success = getLogEntries(dir).stream().map(File::delete).reduce(true, (x, y) -> x && y);\n-            if (!success) {\n-                log.warn(\"failed to delete all log files.\");\n-            }\n+            getLogEntries(dir).forEach(PaxosStateLogImpl::deleteLogFile);\n         } finally {\n             lock.writeLock().unlock();\n         }\n     }\n \n+    private static void deleteLogFile(File file) {\n+        if (!file.delete()) {\n+            log.warn(\"Failed to delete log file {}\", SafeArg.of(\"path\", file.getAbsolutePath()));\n+        }\n+    }\n+\n     private List<File> getLogEntries(File dir) {\n         File[] files = dir.listFiles();\n         if (files == null) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjkxNTc1MQ==", "url": "https://github.com/palantir/atlasdb/pull/5084#discussion_r512915751", "bodyText": "I realise this case is handled already above in getExtremeLogEntry, but we should clean it up.", "author": "jeremyk-91", "createdAt": "2020-10-27T18:04:10Z", "path": "leader-election-impl/src/main/java/com/palantir/paxos/PaxosStateLogImpl.java", "diffHunk": "@@ -235,10 +236,24 @@ public void truncate(long toDeleteInclusive) {\n         }\n     }\n \n+    @Override\n+    public void truncateAllRounds() {\n+        lock.writeLock().lock();\n+        try {\n+            File dir = new File(path);\n+            boolean success = getLogEntries(dir).stream().map(File::delete).reduce(true, (x, y) -> x && y);\n+            if (!success) {\n+                log.warn(\"failed to delete all log files.\");\n+            }\n+        } finally {\n+            lock.writeLock().unlock();\n+        }\n+    }\n+\n     private List<File> getLogEntries(File dir) {\n         File[] files = dir.listFiles();\n         if (files == null) {\n-            return null;\n+            return ImmutableList.of();", "originalCommit": "09128e1cc7d4a93af8f09fe33b6a5ecf9c2e3bdb", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f3fabf2f607154f01161dccc07ba01837275cabc", "chunk": "diff --git a/leader-election-impl/src/main/java/com/palantir/paxos/PaxosStateLogImpl.java b/leader-election-impl/src/main/java/com/palantir/paxos/PaxosStateLogImpl.java\nindex 2971fb5ef0..5f35b71e52 100644\n--- a/leader-election-impl/src/main/java/com/palantir/paxos/PaxosStateLogImpl.java\n+++ b/leader-election-impl/src/main/java/com/palantir/paxos/PaxosStateLogImpl.java\n\n@@ -241,15 +239,18 @@ public class PaxosStateLogImpl<V extends Persistable & Versionable> implements P\n         lock.writeLock().lock();\n         try {\n             File dir = new File(path);\n-            boolean success = getLogEntries(dir).stream().map(File::delete).reduce(true, (x, y) -> x && y);\n-            if (!success) {\n-                log.warn(\"failed to delete all log files.\");\n-            }\n+            getLogEntries(dir).forEach(PaxosStateLogImpl::deleteLogFile);\n         } finally {\n             lock.writeLock().unlock();\n         }\n     }\n \n+    private static void deleteLogFile(File file) {\n+        if (!file.delete()) {\n+            log.warn(\"Failed to delete log file {}\", SafeArg.of(\"path\", file.getAbsolutePath()));\n+        }\n+    }\n+\n     private List<File> getLogEntries(File dir) {\n         File[] files = dir.listFiles();\n         if (files == null) {\n"}}, {"oid": "f3fabf2f607154f01161dccc07ba01837275cabc", "url": "https://github.com/palantir/atlasdb/commit/f3fabf2f607154f01161dccc07ba01837275cabc", "message": "Add logging", "committedDate": "2020-10-28T10:02:48Z", "type": "commit"}, {"oid": "11898494c7400937799bfdc8ea636990fb7adb3c", "url": "https://github.com/palantir/atlasdb/commit/11898494c7400937799bfdc8ea636990fb7adb3c", "message": "Better yet logging", "committedDate": "2020-10-28T11:27:20Z", "type": "commit"}]}