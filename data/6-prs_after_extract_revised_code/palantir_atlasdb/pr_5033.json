{"pr_number": 5033, "pr_title": "Wire invalidator 2", "pr_createdAt": "2020-10-14T14:08:27Z", "pr_url": "https://github.com/palantir/atlasdb/pull/5033", "timeline": [{"oid": "263d5d2f955cf57f982b6e8dbe5d8acf904f08fb", "url": "https://github.com/palantir/atlasdb/commit/263d5d2f955cf57f982b6e8dbe5d8acf904f08fb", "message": "WIP", "committedDate": "2020-10-14T11:34:58Z", "type": "commit"}, {"oid": "2998a9be1e68a21653e75723433be43cf36f8396", "url": "https://github.com/palantir/atlasdb/commit/2998a9be1e68a21653e75723433be43cf36f8396", "message": "WIP", "committedDate": "2020-10-14T12:54:35Z", "type": "commit"}, {"oid": "f8c65e1bd934adae36c22a54ce8c98fa319b9098", "url": "https://github.com/palantir/atlasdb/commit/f8c65e1bd934adae36c22a54ce8c98fa319b9098", "message": "Test - WIP", "committedDate": "2020-10-14T13:30:07Z", "type": "commit"}, {"oid": "ab3483438a98e0aa4f9cf3bf561ca574933dbd7a", "url": "https://github.com/palantir/atlasdb/commit/ab3483438a98e0aa4f9cf3bf561ca574933dbd7a", "message": "Tests", "committedDate": "2020-10-14T14:02:38Z", "type": "commit"}, {"oid": "59253f22524b4907f5fffa2c5451c9c880aeeae8", "url": "https://github.com/palantir/atlasdb/commit/59253f22524b4907f5fffa2c5451c9c880aeeae8", "message": "Clean", "committedDate": "2020-10-14T14:19:43Z", "type": "commit"}, {"oid": "122e9385b4be2075b5f51962b52898290c181f8d", "url": "https://github.com/palantir/atlasdb/commit/122e9385b4be2075b5f51962b52898290c181f8d", "message": "Add generated changelog entries", "committedDate": "2020-10-14T14:19:43Z", "type": "commit"}, {"oid": "76e18f2051ce5782a69da373b38c32b071e7894e", "url": "https://github.com/palantir/atlasdb/commit/76e18f2051ce5782a69da373b38c32b071e7894e", "message": "Be private", "committedDate": "2020-10-14T14:57:37Z", "type": "commit"}, {"oid": "81b9fc86f1949608fc5af998278b3b5920e402b3", "url": "https://github.com/palantir/atlasdb/commit/81b9fc86f1949608fc5af998278b3b5920e402b3", "message": "Merge branch 'wire-invalidator-2' of github.com:palantir/atlasdb into wire-invalidator-2", "committedDate": "2020-10-14T14:58:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDc5OTA5OA==", "url": "https://github.com/palantir/atlasdb/pull/5033#discussion_r504799098", "bodyText": "I think it might be better if this one returns an invalidator that will throw an exception if invoked? This should only really happen in a DB-TimeLock, and if something is calling invalidation there that is a bug.", "author": "jeremyk-91", "createdAt": "2020-10-14T16:06:19Z", "path": "atlasdb-dbkvs/src/main/java/com/palantir/atlasdb/keyvalue/dbkvs/DbAtlasDbFactory.java", "diffHunk": "@@ -123,7 +125,39 @@ private static InDbTimestampBoundStore multiSeries(ConnectionManagerAwareDbKvs d\n     private static InDbTimestampBoundStore defaultTimestampBoundStore(ConnectionManagerAwareDbKvs dbkvs) {\n         return InDbTimestampBoundStore.create(\n                 dbkvs.getConnectionManager(),\n-                AtlasDbConstants.TIMESTAMP_TABLE,\n-                dbkvs.getTablePrefix());\n+                defaultTimestampTable(),\n+                defaultTablePrefix(dbkvs));\n+    }\n+\n+    @Override\n+    public TimestampStoreInvalidator createTimestampStoreInvalidator(KeyValueService rawKvs,\n+            Optional<DbTimestampCreationSetting> creationParameters) {\n+        ConnectionManagerAwareDbKvs dbkvs = (ConnectionManagerAwareDbKvs) rawKvs;\n+        return creationParameters.map(params -> DbTimestampCreationSettings.caseOf(params)\n+                // Do not create invalidator for multi series table\n+                .multipleSeries((table, series) -> defaultTimestampStoreInvalidator(dbkvs, creationParameters))", "originalCommit": "81b9fc86f1949608fc5af998278b3b5920e402b3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "0dcb21ef03f5f4e9fc20ed0741731d14f0572b54", "chunk": "diff --git a/atlasdb-dbkvs/src/main/java/com/palantir/atlasdb/keyvalue/dbkvs/DbAtlasDbFactory.java b/atlasdb-dbkvs/src/main/java/com/palantir/atlasdb/keyvalue/dbkvs/DbAtlasDbFactory.java\nindex c81cdd38cd..97e2e1aeb0 100644\n--- a/atlasdb-dbkvs/src/main/java/com/palantir/atlasdb/keyvalue/dbkvs/DbAtlasDbFactory.java\n+++ b/atlasdb-dbkvs/src/main/java/com/palantir/atlasdb/keyvalue/dbkvs/DbAtlasDbFactory.java\n\n@@ -134,17 +135,15 @@ public class DbAtlasDbFactory implements AtlasDbFactory {\n             Optional<DbTimestampCreationSetting> creationParameters) {\n         ConnectionManagerAwareDbKvs dbkvs = (ConnectionManagerAwareDbKvs) rawKvs;\n         return creationParameters.map(params -> DbTimestampCreationSettings.caseOf(params)\n-                // Do not create invalidator for multi series table\n-                .multipleSeries((table, series) -> defaultTimestampStoreInvalidator(dbkvs, creationParameters))\n-                .singleSeries(table -> timestampStoreInvalidator(dbkvs, table)))\n+                .singleSeries(table -> timestampStoreInvalidator(dbkvs, table))\n+                .otherwise(() -> {\n+                    throw new SafeIllegalStateException(\"Invalidator must only be called by embedded DB timeLock that \"\n+                            + \"does not support multi series timestamp store. This is unexpected, \"\n+                            + \"please contact support.\");\n+                }))\n                 .orElseGet(() -> timestampStoreInvalidator(dbkvs, Optional.empty()));\n     }\n \n-    private TimestampStoreInvalidator defaultTimestampStoreInvalidator(KeyValueService rawKvs,\n-            Optional<DbTimestampCreationSetting> creationParameters) {\n-        return AtlasDbFactory.super.createTimestampStoreInvalidator(rawKvs, creationParameters);\n-    }\n-\n     private TimestampStoreInvalidator timestampStoreInvalidator(ConnectionManagerAwareDbKvs dbKvs,\n             Optional<TableReference> tableReference) {\n         return tableReference\n"}}, {"oid": "0dcb21ef03f5f4e9fc20ed0741731d14f0572b54", "url": "https://github.com/palantir/atlasdb/commit/0dcb21ef03f5f4e9fc20ed0741731d14f0572b54", "message": "Address comments", "committedDate": "2020-10-14T18:39:08Z", "type": "commit"}, {"oid": "e6bf0adb0c2b8987cccec0f029c3579916e49068", "url": "https://github.com/palantir/atlasdb/commit/e6bf0adb0c2b8987cccec0f029c3579916e49068", "message": "Test modif", "committedDate": "2020-10-15T09:58:53Z", "type": "commit"}]}