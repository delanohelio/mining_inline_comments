{"pr_number": 4580, "pr_title": "[Timelock OOMs] Memoized supplier with timeout client", "pr_createdAt": "2020-02-17T15:52:56Z", "pr_url": "https://github.com/palantir/atlasdb/pull/4580", "timeline": [{"oid": "f0daa06a404e7f807dae3de9a4d363836db7a3fb", "url": "https://github.com/palantir/atlasdb/commit/f0daa06a404e7f807dae3de9a4d363836db7a3fb", "message": "Create a new client after 10 minutes for non-failover nodes.", "committedDate": "2020-02-17T14:48:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDI2MzA2OQ==", "url": "https://github.com/palantir/atlasdb/pull/4580#discussion_r380263069", "bodyText": "So I thought this was the first thing we tried and with 30 minutes expiration it was OOMing. Why is the 30 minutes fine on develop, but not fine here?", "author": "jkozlowski", "createdAt": "2020-02-17T16:01:56Z", "path": "atlasdb-config/src/main/java/com/palantir/atlasdb/http/AtlasDbHttpClients.java", "diffHunk": "@@ -41,7 +44,12 @@ private AtlasDbHttpClients() {\n             String uri,\n             Class<T> type,\n             AuxiliaryRemotingParameters parameters) {\n-        return ConjureJavaRuntimeTargetFactory.DEFAULT.createProxy(trustContext, uri, type, parameters).instance();\n+        return Suppliers.memoizeWithExpiration(", "originalCommit": "f0daa06a404e7f807dae3de9a4d363836db7a3fb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDI2NDUwMg==", "url": "https://github.com/palantir/atlasdb/pull/4580#discussion_r380264502", "bodyText": "Unclear, I'm chalking it down to me doing it wrong the first time and trying to get it to work with everything that exists already. I'm struggling to figure out an alternate hypothesis tbh.", "author": "felixdesouza", "createdAt": "2020-02-17T16:04:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDI2MzA2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDI2NjUxNA==", "url": "https://github.com/palantir/atlasdb/pull/4580#discussion_r380266514", "bodyText": "ok, so I would say we probably want to keep the 30 minute period here, in case your original PR just didn't do the wiring correctly. Then it's a representative test case", "author": "jkozlowski", "createdAt": "2020-02-17T16:08:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDI2MzA2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDI2NzAwNw==", "url": "https://github.com/palantir/atlasdb/pull/4580#discussion_r380267007", "bodyText": "cool", "author": "felixdesouza", "createdAt": "2020-02-17T16:09:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDI2MzA2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDI2NzE0Nw==", "url": "https://github.com/palantir/atlasdb/pull/4580#discussion_r380267147", "bodyText": "well no build is working because certs \ud83d\ude20", "author": "felixdesouza", "createdAt": "2020-02-17T16:10:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDI2MzA2OQ=="}], "type": "inlineReview", "revised_code": {"commit": "3d5f9a41aeb77ba8e9212453dc821b879ee6329b", "chunk": "diff --git a/atlasdb-config/src/main/java/com/palantir/atlasdb/http/AtlasDbHttpClients.java b/atlasdb-config/src/main/java/com/palantir/atlasdb/http/AtlasDbHttpClients.java\nindex 324d849a6e..bc47a1a5fa 100644\n--- a/atlasdb-config/src/main/java/com/palantir/atlasdb/http/AtlasDbHttpClients.java\n+++ b/atlasdb-config/src/main/java/com/palantir/atlasdb/http/AtlasDbHttpClients.java\n\n@@ -47,7 +47,7 @@ public final class AtlasDbHttpClients {\n         return Suppliers.memoizeWithExpiration(\n                 () -> ConjureJavaRuntimeTargetFactory.DEFAULT.createProxy(trustContext, uri, type, parameters)\n                         .instance(),\n-                Duration.ofMinutes(10).toMinutes(),\n+                Duration.ofMinutes(30).toMinutes(),\n                 TimeUnit.MINUTES).get();\n \n     }\n"}}, {"oid": "6dfb72c654a89498fd71d3ff4f866911e7bd1226", "url": "https://github.com/palantir/atlasdb/commit/6dfb72c654a89498fd71d3ff4f866911e7bd1226", "message": "Update certs again..", "committedDate": "2020-02-17T16:23:06Z", "type": "commit"}, {"oid": "3d5f9a41aeb77ba8e9212453dc821b879ee6329b", "url": "https://github.com/palantir/atlasdb/commit/3d5f9a41aeb77ba8e9212453dc821b879ee6329b", "message": "Bump to 30 minutes to get a representative test.", "committedDate": "2020-02-17T16:23:33Z", "type": "commit"}, {"oid": "764ae01849a63025c5b739dca829f0d7ac0ac91f", "url": "https://github.com/palantir/atlasdb/commit/764ae01849a63025c5b739dca829f0d7ac0ac91f", "message": "Changelog.", "committedDate": "2020-02-17T16:44:13Z", "type": "commit"}]}