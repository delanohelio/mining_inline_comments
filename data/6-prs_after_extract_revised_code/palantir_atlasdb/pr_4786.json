{"pr_number": 4786, "pr_title": "[PaxosStateLog] Reintroduce Migration and Verification with Locks", "pr_createdAt": "2020-05-18T13:54:07Z", "pr_url": "https://github.com/palantir/atlasdb/pull/4786", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjcwNTY3MA==", "url": "https://github.com/palantir/atlasdb/pull/4786#discussion_r426705670", "bodyText": "These don't happen simultaneously with the other instances in the other tests in this test class, so while this might be a bit sketchy it's ok", "author": "jeremyk-91", "createdAt": "2020-05-18T15:21:21Z", "path": "leader-election-impl/src/test/java/com/palantir/paxos/SqlitePaxosStateLogMigrationStateTest.java", "diffHunk": "@@ -99,8 +99,8 @@ public void finishingMigrationForOneNamespaceDoesNotSetFlagForOthers() {\n     public void finishingMigrationForOneUseCaseDoesNotSetFlagForOthers() {\n         migrationState.migrateToValidationState();\n \n-        SqlitePaxosStateLogMigrationState otherState = SqlitePaxosStateLogMigrationState\n-                .create(ImmutableNamespaceAndUseCase.of(Client.of(\"namespace\"), \"other\"), connSupplier);\n+        SqlitePaxosStateLogMigrationState otherState = new SqlitePaxosStateLogFactory().createMigrationState(\n+                ImmutableNamespaceAndUseCase.of(Client.of(\"namespace\"), \"other\"), connSupplier);", "originalCommit": "c6910cc5da96ea97b1efb1c884673671b66bd463", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bc344a43f99449e6eaa5f0c5f95db79fa45e215c", "chunk": "diff --git a/leader-election-impl/src/test/java/com/palantir/paxos/SqlitePaxosStateLogMigrationStateTest.java b/leader-election-impl/src/test/java/com/palantir/paxos/SqlitePaxosStateLogMigrationStateTest.java\nindex cc94cf6b8a..e6306c41dc 100644\n--- a/leader-election-impl/src/test/java/com/palantir/paxos/SqlitePaxosStateLogMigrationStateTest.java\n+++ b/leader-election-impl/src/test/java/com/palantir/paxos/SqlitePaxosStateLogMigrationStateTest.java\n\n@@ -99,8 +99,8 @@ public class SqlitePaxosStateLogMigrationStateTest {\n     public void finishingMigrationForOneUseCaseDoesNotSetFlagForOthers() {\n         migrationState.migrateToValidationState();\n \n-        SqlitePaxosStateLogMigrationState otherState = new SqlitePaxosStateLogFactory().createMigrationState(\n-                ImmutableNamespaceAndUseCase.of(Client.of(\"namespace\"), \"other\"), connSupplier);\n+        SqlitePaxosStateLogMigrationState otherState = SqlitePaxosStateLogMigrationState\n+                .create(ImmutableNamespaceAndUseCase.of(Client.of(\"namespace\"), \"other\"), connSupplier);\n         assertThat(otherState.hasMigratedFromInitialState()).isFalse();\n         otherState.migrateToValidationState();\n         assertThat(otherState.hasMigratedFromInitialState()).isTrue();\n"}}, {"oid": "bc344a43f99449e6eaa5f0c5f95db79fa45e215c", "url": "https://github.com/palantir/atlasdb/commit/bc344a43f99449e6eaa5f0c5f95db79fa45e215c", "message": "Revert \"Revert \"[PaxosStateLog] Wire up and Migrate To Verifying PSL (#4775)\" (#4782)\"\n\nThis reverts commit 89a0cd4b40f7f79074758dd1db94300eef53bd74.", "committedDate": "2020-05-18T15:51:06Z", "type": "commit"}, {"oid": "d2a08e92dc3597903dec75e389dae7082859eda6", "url": "https://github.com/palantir/atlasdb/commit/d2a08e92dc3597903dec75e389dae7082859eda6", "message": "Reintroduce migration for verification", "committedDate": "2020-05-18T15:51:06Z", "type": "commit"}, {"oid": "76cd9993271f0f65d10e23ab94951d6d28fc80b2", "url": "https://github.com/palantir/atlasdb/commit/76cd9993271f0f65d10e23ab94951d6d28fc80b2", "message": "Also lock for migration state", "committedDate": "2020-05-18T15:51:06Z", "type": "commit"}, {"oid": "e5d9a6d9a34cda455d6b46040859f06cf949ab01", "url": "https://github.com/palantir/atlasdb/commit/e5d9a6d9a34cda455d6b46040859f06cf949ab01", "message": "Add logging", "committedDate": "2020-05-18T16:04:42Z", "type": "commit"}, {"oid": "14aeb0114facc2d8cf238ac6b301fd7f0c3e5ad4", "url": "https://github.com/palantir/atlasdb/commit/14aeb0114facc2d8cf238ac6b301fd7f0c3e5ad4", "message": "Add generated changelog entries", "committedDate": "2020-05-18T16:04:42Z", "type": "commit"}, {"oid": "e5d9a6d9a34cda455d6b46040859f06cf949ab01", "url": "https://github.com/palantir/atlasdb/commit/e5d9a6d9a34cda455d6b46040859f06cf949ab01", "message": "Add logging", "committedDate": "2020-05-18T16:04:42Z", "type": "forcePushed"}]}