{"pr_number": 4656, "pr_title": "Reduce retained memory in delete executor work queue", "pr_createdAt": "2020-03-19T16:44:52Z", "pr_url": "https://github.com/palantir/atlasdb/pull/4656", "timeline": [{"oid": "8f94a78347927b0a01e6cf4881cdc85549ab4fa3", "url": "https://github.com/palantir/atlasdb/commit/8f94a78347927b0a01e6cf4881cdc85549ab4fa3", "message": "fix possible leak in deleteCells", "committedDate": "2020-03-19T16:39:57Z", "type": "commit"}, {"oid": "3e578efd676fd92703ff4f7cc1cab1fb24243f5e", "url": "https://github.com/palantir/atlasdb/commit/3e578efd676fd92703ff4f7cc1cab1fb24243f5e", "message": "style", "committedDate": "2020-03-19T16:40:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA5NDA0NQ==", "url": "https://github.com/palantir/atlasdb/pull/4656#discussion_r397094045", "bodyText": "We should have a comment here as to why this method is supposed to be static", "author": "sudiksha27", "createdAt": "2020-03-24T11:51:25Z", "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/transaction/impl/SnapshotTransaction.java", "diffHunk": "@@ -1928,7 +1928,7 @@ private boolean rollbackFailedTransactions(\n         return true;\n     }\n \n-    private void deleteCells(TableReference tableRef, Map<Cell, Long> keysToDelete) {\n+    private static void deleteCells(KeyValueService keyValueService, TableReference tableRef, Map<Cell, Long> keysToDelete) {", "originalCommit": "3e578efd676fd92703ff4f7cc1cab1fb24243f5e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6ac0ba028b44325d7660d61a3a9f215509cbe4a6", "chunk": "diff --git a/atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/transaction/impl/SnapshotTransaction.java b/atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/transaction/impl/SnapshotTransaction.java\nindex bff95325aa..1e47f3f0a7 100644\n--- a/atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/transaction/impl/SnapshotTransaction.java\n+++ b/atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/transaction/impl/SnapshotTransaction.java\n\n@@ -1928,7 +1928,15 @@ public class SnapshotTransaction extends AbstractTransaction implements Constrai\n         return true;\n     }\n \n-    private static void deleteCells(KeyValueService keyValueService, TableReference tableRef, Map<Cell, Long> keysToDelete) {\n+    /**\n+     * This method is made static so it loses reference to the SnapshotTransaction reference\n+     * when passed to deleteExecutor::execute in a lambda reducing its retained memory size.\n+     */\n+    private static void deleteCells(\n+            KeyValueService keyValueService,\n+            TableReference tableRef,\n+            Map<Cell, Long> keysToDelete\n+    ) {\n         try {\n             log.debug(\"For table: {} we are deleting values of an uncommitted transaction: {}\",\n                     LoggingArgs.tableRef(tableRef),\n"}}, {"oid": "6ac0ba028b44325d7660d61a3a9f215509cbe4a6", "url": "https://github.com/palantir/atlasdb/commit/6ac0ba028b44325d7660d61a3a9f215509cbe4a6", "message": "Add generated changelog entries", "committedDate": "2020-04-07T11:59:54Z", "type": "commit"}, {"oid": "3e3bd57163e74560f81cada7a59810439d0e443b", "url": "https://github.com/palantir/atlasdb/commit/3e3bd57163e74560f81cada7a59810439d0e443b", "message": "Add generated changelog entries", "committedDate": "2020-04-07T11:59:54Z", "type": "commit"}, {"oid": "a387b4c549c31f070cb3c73cd524c5f40e9a1d98", "url": "https://github.com/palantir/atlasdb/commit/a387b4c549c31f070cb3c73cd524c5f40e9a1d98", "message": "Add comment", "committedDate": "2020-04-07T11:59:54Z", "type": "commit"}, {"oid": "67baaa70cc46f52fa85381b8324da566400bcc62", "url": "https://github.com/palantir/atlasdb/commit/67baaa70cc46f52fa85381b8324da566400bcc62", "message": "Add generated changelog entries", "committedDate": "2020-04-07T11:59:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc3Mjk1Mg==", "url": "https://github.com/palantir/atlasdb/pull/4656#discussion_r404772952", "bodyText": "nit: bracketing\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        Map<Cell, Long> keysToDelete\n          \n          \n            \n                ) {\n          \n          \n            \n                        Map<Cell, Long> keysToDelete) {", "author": "jeremyk-91", "createdAt": "2020-04-07T12:35:32Z", "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/transaction/impl/SnapshotTransaction.java", "diffHunk": "@@ -1928,7 +1928,15 @@ private boolean rollbackFailedTransactions(\n         return true;\n     }\n \n-    private void deleteCells(TableReference tableRef, Map<Cell, Long> keysToDelete) {\n+    /**\n+     * This method is made static so it loses reference to the SnapshotTransaction reference\n+     * when passed to deleteExecutor::execute in a lambda reducing its retained memory size.\n+     */\n+    private static void deleteCells(\n+            KeyValueService keyValueService,\n+            TableReference tableRef,\n+            Map<Cell, Long> keysToDelete\n+    ) {", "originalCommit": "3e3bd57163e74560f81cada7a59810439d0e443b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5bd660937096dd2b4f4f5debd2bf1b582940d916", "chunk": "diff --git a/atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/transaction/impl/SnapshotTransaction.java b/atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/transaction/impl/SnapshotTransaction.java\nindex 1e47f3f0a7..899affbb39 100644\n--- a/atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/transaction/impl/SnapshotTransaction.java\n+++ b/atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/transaction/impl/SnapshotTransaction.java\n\n@@ -1935,8 +1935,7 @@ public class SnapshotTransaction extends AbstractTransaction implements Constrai\n     private static void deleteCells(\n             KeyValueService keyValueService,\n             TableReference tableRef,\n-            Map<Cell, Long> keysToDelete\n-    ) {\n+            Map<Cell, Long> keysToDelete) {\n         try {\n             log.debug(\"For table: {} we are deleting values of an uncommitted transaction: {}\",\n                     LoggingArgs.tableRef(tableRef),\n"}}, {"oid": "5bd660937096dd2b4f4f5debd2bf1b582940d916", "url": "https://github.com/palantir/atlasdb/commit/5bd660937096dd2b4f4f5debd2bf1b582940d916", "message": "Address comments", "committedDate": "2020-04-07T21:56:45Z", "type": "commit"}, {"oid": "0146334a9c66dbce05bbf3938268415dc06b7b73", "url": "https://github.com/palantir/atlasdb/commit/0146334a9c66dbce05bbf3938268415dc06b7b73", "message": "Merge branch 'os/delete-cells-possible-leak' of github.com:palantir/atlasdb into os/delete-cells-possible-leak", "committedDate": "2020-04-07T21:57:51Z", "type": "commit"}]}