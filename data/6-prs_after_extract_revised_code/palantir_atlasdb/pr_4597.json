{"pr_number": 4597, "pr_title": "[LW] Synchronise Issuing Start Timestamps with Lock Event Log", "pr_createdAt": "2020-02-25T11:43:15Z", "pr_url": "https://github.com/palantir/atlasdb/pull/4597", "timeline": [{"oid": "8740ab9b0eb8e8daf4d2d8152231738d07d4248e", "url": "https://github.com/palantir/atlasdb/commit/8740ab9b0eb8e8daf4d2d8152231738d07d4248e", "message": "Be better, one day at a time. Also fix nasty concurrency issue.", "committedDate": "2020-02-20T10:43:02Z", "type": "commit"}, {"oid": "2c3a9d273d2ff4ec589001af51cb408ed67b14fa", "url": "https://github.com/palantir/atlasdb/commit/2c3a9d273d2ff4ec589001af51cb408ed67b14fa", "message": "Rework lock watch updates and registration", "committedDate": "2020-02-21T16:58:50Z", "type": "commit"}, {"oid": "d311fef3558808de8fa7bf90975ff50d3b7115d7", "url": "https://github.com/palantir/atlasdb/commit/d311fef3558808de8fa7bf90975ff50d3b7115d7", "message": "Merge with develop", "committedDate": "2020-02-24T10:46:42Z", "type": "commit"}, {"oid": "121eada2e9528cbedc9c694d7067a0d8eea5421a", "url": "https://github.com/palantir/atlasdb/commit/121eada2e9528cbedc9c694d7067a0d8eea5421a", "message": "Do not filter unlocks for replayer", "committedDate": "2020-02-24T11:34:03Z", "type": "commit"}, {"oid": "413cc995a5ed5ff3de45629bf34f778e663e3be1", "url": "https://github.com/palantir/atlasdb/commit/413cc995a5ed5ff3de45629bf34f778e663e3be1", "message": "Add test for snapshot reflecting events logged during open locks calculation", "committedDate": "2020-02-24T11:44:02Z", "type": "commit"}, {"oid": "a12258917f0e78113097570b87fbcd5c3361e110", "url": "https://github.com/palantir/atlasdb/commit/a12258917f0e78113097570b87fbcd5c3361e110", "message": "Implement atomic start transactions + get last known version on timelock", "committedDate": "2020-02-24T14:25:02Z", "type": "commit"}, {"oid": "9e1266f1bf1d4029c383707fb30ef3b24c7f9712", "url": "https://github.com/palantir/atlasdb/commit/9e1266f1bf1d4029c383707fb30ef3b24c7f9712", "message": "Return snapshot for failure to compute exact lock watch state on start transaction", "committedDate": "2020-02-25T11:36:57Z", "type": "commit"}, {"oid": "cf6ebffcfcb11a927ec67a4c5a12c215bb1129f3", "url": "https://github.com/palantir/atlasdb/commit/cf6ebffcfcb11a927ec67a4c5a12c215bb1129f3", "message": "Undo method rename", "committedDate": "2020-02-25T11:39:24Z", "type": "commit"}, {"oid": "5a51389da548ef32cf664d037501b5c307e184be", "url": "https://github.com/palantir/atlasdb/commit/5a51389da548ef32cf664d037501b5c307e184be", "message": "Fix merge conflicts with develop", "committedDate": "2020-02-26T17:49:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjYwOTkyMA==", "url": "https://github.com/palantir/atlasdb/pull/4597#discussion_r386609920", "bodyText": "nit: space", "author": "jeremyk-91", "createdAt": "2020-03-02T19:44:03Z", "path": "timelock-impl/src/main/java/com/palantir/atlasdb/timelock/lock/watch/ValueAndVersion.java", "diffHunk": "@@ -0,0 +1,32 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.timelock.lock.watch;\n+\n+import org.immutables.value.Value;\n+\n+@Value.Immutable\n+@Value.Style(visibility = Value.Style.ImplementationVisibility.PACKAGE)\n+public interface ValueAndVersion<T> {\n+    @Value.Parameter\n+    long version();\n+    @Value.Parameter\n+    T value();\n+\n+    static <R> ValueAndVersion<R> of (long version, R result) {", "originalCommit": "5a51389da548ef32cf664d037501b5c307e184be", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "91916bd2650b2aadfbbff56d3a7c20b080c56b3a", "chunk": "diff --git a/timelock-impl/src/main/java/com/palantir/atlasdb/timelock/lock/watch/ValueAndVersion.java b/timelock-impl/src/main/java/com/palantir/atlasdb/timelock/lock/watch/ValueAndVersion.java\nindex a376b11cd2..8c6d46b14d 100644\n--- a/timelock-impl/src/main/java/com/palantir/atlasdb/timelock/lock/watch/ValueAndVersion.java\n+++ b/timelock-impl/src/main/java/com/palantir/atlasdb/timelock/lock/watch/ValueAndVersion.java\n\n@@ -26,7 +26,7 @@ public interface ValueAndVersion<T> {\n     @Value.Parameter\n     T value();\n \n-    static <R> ValueAndVersion<R> of (long version, R result) {\n+    static <R> ValueAndVersion<R> of(long version, R result) {\n         return ImmutableValueAndVersion.of(version, result);\n     }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjYxOTg4MQ==", "url": "https://github.com/palantir/atlasdb/pull/4597#discussion_r386619881", "bodyText": "maybe verbose, but would prefer ...WatchStateVersion perhaps given that this is on the super-interface  AsyncTimelockService", "author": "jeremyk-91", "createdAt": "2020-03-02T20:03:31Z", "path": "timelock-impl/src/main/java/com/palantir/atlasdb/timelock/lock/watch/LockWatchingService.java", "diffHunk": "@@ -27,7 +28,8 @@\n public interface LockWatchingService {\n     void startWatching(LockWatchRequest locksToWatch);\n     LockWatchStateUpdate getWatchStateUpdate(OptionalLong lastKnownVersion);\n-\n+    LockWatchStateUpdate getWatchStateUpdate(OptionalLong lastKnownVersion, long endVersion);\n+    <T> ValueAndVersion<T> runTaskAndAtomicallyReturnVersion(Supplier<T> task);", "originalCommit": "5a51389da548ef32cf664d037501b5c307e184be", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "91916bd2650b2aadfbbff56d3a7c20b080c56b3a", "chunk": "diff --git a/timelock-impl/src/main/java/com/palantir/atlasdb/timelock/lock/watch/LockWatchingService.java b/timelock-impl/src/main/java/com/palantir/atlasdb/timelock/lock/watch/LockWatchingService.java\nindex 660df71a81..d5c3c44cfd 100644\n--- a/timelock-impl/src/main/java/com/palantir/atlasdb/timelock/lock/watch/LockWatchingService.java\n+++ b/timelock-impl/src/main/java/com/palantir/atlasdb/timelock/lock/watch/LockWatchingService.java\n\n@@ -29,7 +29,7 @@ public interface LockWatchingService {\n     void startWatching(LockWatchRequest locksToWatch);\n     LockWatchStateUpdate getWatchStateUpdate(OptionalLong lastKnownVersion);\n     LockWatchStateUpdate getWatchStateUpdate(OptionalLong lastKnownVersion, long endVersion);\n-    <T> ValueAndVersion<T> runTaskAndAtomicallyReturnVersion(Supplier<T> task);\n+    <T> ValueAndVersion<T> runTaskAndAtomicallyReturnLockWatchVersion(Supplier<T> task);\n     void registerLock(Set<LockDescriptor> locksTakenOut, LockToken token);\n     void registerUnlock(Set<LockDescriptor> locksUnlocked);\n }\n"}}, {"oid": "9171c126ca2228d169db94db79dfd6e379aad149", "url": "https://github.com/palantir/atlasdb/commit/9171c126ca2228d169db94db79dfd6e379aad149", "message": "Fix merge conflicts", "committedDate": "2020-03-04T16:27:13Z", "type": "commit"}, {"oid": "91916bd2650b2aadfbbff56d3a7c20b080c56b3a", "url": "https://github.com/palantir/atlasdb/commit/91916bd2650b2aadfbbff56d3a7c20b080c56b3a", "message": "CR", "committedDate": "2020-03-04T16:34:06Z", "type": "commit"}]}