{"pr_number": 4949, "pr_title": "Relieve Flakes - Make Stress Test Run Slightly Longer", "pr_createdAt": "2020-08-14T17:24:34Z", "pr_url": "https://github.com/palantir/atlasdb/pull/4949", "timeline": [{"oid": "3549099ae23f78373575b2527824474334826927", "url": "https://github.com/palantir/atlasdb/commit/3549099ae23f78373575b2527824474334826927", "message": "relax threshold, while still clearly under num requests", "committedDate": "2020-08-14T17:07:19Z", "type": "commit"}, {"oid": "98009ba3f50395511862340d8f2ae6893f076a82", "url": "https://github.com/palantir/atlasdb/commit/98009ba3f50395511862340d8f2ae6893f076a82", "message": "fix", "committedDate": "2020-08-14T17:07:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTMyNzM1MQ==", "url": "https://github.com/palantir/atlasdb/pull/4949#discussion_r471327351", "bodyText": "Drive by comment here, but do we really need this if statement?", "author": "Jolyon-S", "createdAt": "2020-08-17T08:37:25Z", "path": "timelock-server/src/suiteTest/java/com/palantir/atlasdb/timelock/MultiNodePaxosTimeLockServerIntegrationTest.java", "diffHunk": "@@ -455,9 +455,7 @@ public void stressTestForPaxosEndpoints() {\n     }\n \n     private static void assertNumberOfThreadsReasonable(int startingThreads, int threadCount, boolean nonLeaderDown) {\n-        // TODO (jkong): Lower the amount over the threshold. This needs to be slightly higher for now because of the\n-        // current threading model in batch mode, where separate threads may be spun up on the autobatcher.\n-        int threadLimit = startingThreads + 800;\n+        int threadLimit = startingThreads + 1000;\n         if (nonLeaderDown) {\n             if (threadCount > threadLimit) {", "originalCommit": "98009ba3f50395511862340d8f2ae6893f076a82", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTM0MTM4MQ==", "url": "https://github.com/palantir/atlasdb/pull/4949#discussion_r471341381", "bodyText": "We do not. Look at line 463 \ud83d\ude05  This must have been an artifact of when I did some previous testing", "author": "jeremyk-91", "createdAt": "2020-08-17T09:02:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTMyNzM1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTM0MjE2MQ==", "url": "https://github.com/palantir/atlasdb/pull/4949#discussion_r471342161", "bodyText": "yep, that's what I was looking at ^^. I'm guessing this was for a breakpoint.", "author": "Jolyon-S", "createdAt": "2020-08-17T09:04:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTMyNzM1MQ=="}], "type": "inlineReview", "revised_code": {"commit": "1a912f67591f62f0482a4adb89c2a20580ff138f", "chunk": "diff --git a/timelock-server/src/suiteTest/java/com/palantir/atlasdb/timelock/MultiNodePaxosTimeLockServerIntegrationTest.java b/timelock-server/src/suiteTest/java/com/palantir/atlasdb/timelock/MultiNodePaxosTimeLockServerIntegrationTest.java\nindex d62ef5ce95..a422dce9d1 100644\n--- a/timelock-server/src/suiteTest/java/com/palantir/atlasdb/timelock/MultiNodePaxosTimeLockServerIntegrationTest.java\n+++ b/timelock-server/src/suiteTest/java/com/palantir/atlasdb/timelock/MultiNodePaxosTimeLockServerIntegrationTest.java\n\n@@ -457,9 +457,6 @@ public class MultiNodePaxosTimeLockServerIntegrationTest {\n     private static void assertNumberOfThreadsReasonable(int startingThreads, int threadCount, boolean nonLeaderDown) {\n         int threadLimit = startingThreads + 1000;\n         if (nonLeaderDown) {\n-            if (threadCount > threadLimit) {\n-                System.out.println(\"hello\");\n-            }\n             assertThat(threadCount)\n                     .as(\"should not additionally spin up too many threads after a non-leader failed\")\n                     .isLessThanOrEqualTo(threadLimit);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTMyOTY4MQ==", "url": "https://github.com/palantir/atlasdb/pull/4949#discussion_r471329681", "bodyText": "If I understand this test correctly:\n\nThis number (1_800) represents how long we are running for - the longer, the more accurate the test is (i.e. if we were to run for 100k and still never exceeded the thread limit we'd know it is unlikely to ever go over that amount).\nThe number that you increased below (+ 800 -> + 1000) is the tolerance - by increasing that you make the tests more tolerant of bad thread buildup, although only by a small amount.\n\nSo presumably the concern is that this PR relaxes the test a bit (to make it pass on Circle, sure, but even so). I'm happy with this as it is - 1) should help counteract 2) - but if you wanted to err on the side of caution, increasing 1) further would improve the test (at the cost of time, naturally).\nThoughts?", "author": "Jolyon-S", "createdAt": "2020-08-17T08:41:50Z", "path": "timelock-server/src/suiteTest/java/com/palantir/atlasdb/timelock/MultiNodePaxosTimeLockServerIntegrationTest.java", "diffHunk": "@@ -437,7 +437,7 @@ public void stressTestForPaxosEndpoints() {\n         int startingNumThreads = ManagementFactory.getThreadMXBean().getThreadCount();\n         boolean isNonLeaderTakenOut = false;\n         try {\n-            for (int i = 0; i < 1_500; i++) { // Needed as it takes a while for the thread buildup to occur\n+            for (int i = 0; i < 1_800; i++) { // Needed as it takes a while for the thread buildup to occur", "originalCommit": "98009ba3f50395511862340d8f2ae6893f076a82", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTM0NDg0Mg==", "url": "https://github.com/palantir/atlasdb/pull/4949#discussion_r471344842", "bodyText": "Yep, your understanding is correct. Here, 1_800 is the number of requests, and 1_000 is the number of threads over the amount at startup that are allowed.\nWe do expect (384 + 1) * 2 = 770 threads to be blocked on talking to the dying timelock node. However, there is probably enough variation in other threads that tolerating noise of 800 - 770 = 30 is insufficient (this includes any threads that may be spun up by the JVM or by our application code for whatever reason).\nWhat's important here is that we don't want the number of threads blocked to scale with the number of requests to the dead node. Thus, strictly speaking as a minimum bound you want the number of requests made whilst one node is unresponsive to be at least half of the number of spare threads allowed (the reason for half is because Dialogue spins up a thread as well). So in theory we should have at least 800 / 2 = 400 and now 1000 / 2 = 500 as a minimum, and once you add the offset from requests made before a node crashes we're looking at 900 and 1_100 as theoretical minimum bounds. We want more though to ensure that if 'noise' from other threads being shut down actually makes a negative contribution, the test still doesn't really have a chance of passing.", "author": "jeremyk-91", "createdAt": "2020-08-17T09:09:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTMyOTY4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTM1MDExNw==", "url": "https://github.com/palantir/atlasdb/pull/4949#discussion_r471350117", "bodyText": "What's important here is that we don't want the number of threads blocked to scale with the number of requests to the dead node.\n\nYes, that's the main thing, and my main original concern was that increasing the tolerance by 200 but increasing the requests by 300 may or may not be enough, but I think as you have reasoned out above, it is sufficient.\nLooks good to me then, merge away!", "author": "Jolyon-S", "createdAt": "2020-08-17T09:19:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTMyOTY4MQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "1a912f67591f62f0482a4adb89c2a20580ff138f", "url": "https://github.com/palantir/atlasdb/commit/1a912f67591f62f0482a4adb89c2a20580ff138f", "message": "No more hello", "committedDate": "2020-08-17T09:18:43Z", "type": "commit"}]}