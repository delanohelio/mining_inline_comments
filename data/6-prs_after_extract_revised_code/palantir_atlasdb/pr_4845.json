{"pr_number": 4845, "pr_title": "report feedback to timeLock", "pr_createdAt": "2020-06-17T17:27:40Z", "pr_url": "https://github.com/palantir/atlasdb/pull/4845", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjEwODQ5OQ==", "url": "https://github.com/palantir/atlasdb/pull/4845#discussion_r442108499", "bodyText": "This is fine, but we should look at using the new Dialogue services / AtlasDbDialogueServiceProvider.", "author": "jeremyk-91", "createdAt": "2020-06-18T09:53:35Z", "path": "atlasdb-config/src/main/java/com/palantir/atlasdb/factory/TransactionManagers.java", "diffHunk": "@@ -552,6 +551,48 @@ private TransactionManager serializableInternal(@Output List<AutoCloseable> clos\n         return transactionManager;\n     }\n \n+    private TimeLockFeedbackBackgroundTask getTimeLockFeedbackBackgroundTask(\n+            @Output List<AutoCloseable> closeables,\n+            AtlasDbConfig config,\n+            Refreshable<AtlasDbRuntimeConfig> runtimeConfig) {\n+        Supplier<List<TimeLockClientFeedbackService>> timeLockClientFeedbackServicesSupplier\n+                = getTimeLockClientFeedbackServices(config,\n+                runtimeConfig, userAgent());\n+        return initializeCloseable(\n+                () -> TimeLockFeedbackBackgroundTask.create(\n+                        globalTaggedMetricRegistry(),\n+                        () -> AtlasDbVersion.readVersion(),\n+                        serviceName(),\n+                        timeLockClientFeedbackServicesSupplier), closeables);\n+    }\n+\n+    @VisibleForTesting\n+    static Supplier<List<TimeLockClientFeedbackService>> getTimeLockClientFeedbackServices(AtlasDbConfig config,\n+            Refreshable<AtlasDbRuntimeConfig> runtimeConfig,\n+            UserAgent userAgent) {\n+        Refreshable<ServerListConfig> serverListConfigSupplier =\n+                getServerListConfigSupplierForTimeLock(config, runtimeConfig);\n+        return new CachedTransformingSupplier<>(\n+                serverListConfigSupplier,\n+                serverListConfig -> createProxiesForFeedbackService(userAgent, serverListConfig));\n+    }\n+\n+    private static List<TimeLockClientFeedbackService> createProxiesForFeedbackService(UserAgent userAgent,\n+            ServerListConfig serverListConfig) {\n+        return serverListConfig.servers().stream()\n+           .map(uri -> AtlasDbHttpClients.createProxy(\n+                   serverListConfig.trustContext(),\n+                   uri,\n+                   TimeLockClientFeedbackService.class,\n+                   AuxiliaryRemotingParameters.builder()\n+                           .shouldUseExtendedTimeout(true)\n+                           .shouldLimitPayload(true)\n+                           .shouldRetry(true)\n+                           .userAgent(userAgent)\n+                           .build()))", "originalCommit": "10295219cbd078ed1f72caf35e84c4e4aee064c2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b5cf6a67b0aae518f83c87cd15d119f6fc10520d", "chunk": "diff --git a/atlasdb-config/src/main/java/com/palantir/atlasdb/factory/TransactionManagers.java b/atlasdb-config/src/main/java/com/palantir/atlasdb/factory/TransactionManagers.java\nindex fbf71b3c5d..8d80856f43 100644\n--- a/atlasdb-config/src/main/java/com/palantir/atlasdb/factory/TransactionManagers.java\n+++ b/atlasdb-config/src/main/java/com/palantir/atlasdb/factory/TransactionManagers.java\n\n@@ -551,46 +549,46 @@ public abstract class TransactionManagers {\n         return transactionManager;\n     }\n \n-    private TimeLockFeedbackBackgroundTask getTimeLockFeedbackBackgroundTask(\n+    private Optional<TimeLockFeedbackBackgroundTask> getTimeLockFeedbackBackgroundTask(\n             @Output List<AutoCloseable> closeables,\n             AtlasDbConfig config,\n             Refreshable<AtlasDbRuntimeConfig> runtimeConfig) {\n-        Supplier<List<TimeLockClientFeedbackService>> timeLockClientFeedbackServicesSupplier\n-                = getTimeLockClientFeedbackServices(config,\n-                runtimeConfig, userAgent());\n-        return initializeCloseable(\n-                () -> TimeLockFeedbackBackgroundTask.create(\n-                        globalTaggedMetricRegistry(),\n-                        () -> AtlasDbVersion.readVersion(),\n-                        serviceName(),\n-                        timeLockClientFeedbackServicesSupplier), closeables);\n+        if (isUsingTimeLock(config, runtimeConfig.current())) {\n+            Refreshable<List<TimeLockClientFeedbackService>> refreshableTimeLockClientFeedbackServices\n+                    = getTimeLockClientFeedbackServices(config, runtimeConfig, userAgent());\n+            return Optional.of(initializeCloseable(\n+                    () -> TimeLockFeedbackBackgroundTask.create(\n+                            globalTaggedMetricRegistry(),\n+                            () -> AtlasDbVersion.readVersion(),\n+                            serviceName(),\n+                            refreshableTimeLockClientFeedbackServices), closeables));\n+        }\n+        return Optional.empty();\n     }\n \n     @VisibleForTesting\n-    static Supplier<List<TimeLockClientFeedbackService>> getTimeLockClientFeedbackServices(AtlasDbConfig config,\n+    static Refreshable<List<TimeLockClientFeedbackService>> getTimeLockClientFeedbackServices(AtlasDbConfig config,\n             Refreshable<AtlasDbRuntimeConfig> runtimeConfig,\n             UserAgent userAgent) {\n         Refreshable<ServerListConfig> serverListConfigSupplier =\n                 getServerListConfigSupplierForTimeLock(config, runtimeConfig);\n-        return new CachedTransformingSupplier<>(\n-                serverListConfigSupplier,\n-                serverListConfig -> createProxiesForFeedbackService(userAgent, serverListConfig));\n-    }\n+        DialogueClients.ReloadingFactory reloadingFactory = DialogueClients.create(\n+                Refreshable.only(ServicesConfigBlock.builder().build()));\n \n-    private static List<TimeLockClientFeedbackService> createProxiesForFeedbackService(UserAgent userAgent,\n-            ServerListConfig serverListConfig) {\n-        return serverListConfig.servers().stream()\n-           .map(uri -> AtlasDbHttpClients.createProxy(\n-                   serverListConfig.trustContext(),\n-                   uri,\n-                   TimeLockClientFeedbackService.class,\n-                   AuxiliaryRemotingParameters.builder()\n-                           .shouldUseExtendedTimeout(true)\n-                           .shouldLimitPayload(true)\n-                           .shouldRetry(true)\n-                           .userAgent(userAgent)\n-                           .build()))\n-           .collect(Collectors.toList());\n+        BroadcastDialogueClientFactory broadcastDialogueClientFactory = BroadcastDialogueClientFactory.create(\n+                reloadingFactory,\n+                serverListConfigSupplier,\n+                userAgent,\n+                AuxiliaryRemotingParameters\n+                        .builder()\n+                        .shouldRetry(true)\n+                        .userAgent(userAgent)\n+                        .shouldLimitPayload(true)\n+                        .build());\n+\n+        return broadcastDialogueClientFactory.getSingleNodeProxies(\n+                TimeLockClientFeedbackService.class,\n+                true);\n     }\n \n     abstract Optional<String> serviceIdentifierOverride();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjEwOTY1NQ==", "url": "https://github.com/palantir/atlasdb/pull/4845#discussion_r442109655", "bodyText": "nit: Should be a constant that's public: the server needs to read this eventually", "author": "jeremyk-91", "createdAt": "2020-06-18T09:55:31Z", "path": "lock-api/src/main/java/com/palantir/lock/client/metrics/TimeLockFeedbackBackgroundTask.java", "diffHunk": "@@ -69,16 +77,20 @@ public static TimeLockFeedbackBackgroundTask create(TaggedMetricRegistry taggedM\n     public void scheduleWithFixedDelay() {\n         executor.scheduleWithFixedDelay(() -> {\n             try {\n+                ConjureTimeLockClientFeedback feedbackReport = ConjureTimeLockClientFeedback\n+                        .builder()\n+                        .stats(ImmutableMap.of(\"conjureTimelockServiceBlocking.startTransactions\",", "originalCommit": "10295219cbd078ed1f72caf35e84c4e4aee064c2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b5cf6a67b0aae518f83c87cd15d119f6fc10520d", "chunk": "diff --git a/lock-api/src/main/java/com/palantir/lock/client/metrics/TimeLockFeedbackBackgroundTask.java b/lock-api/src/main/java/com/palantir/lock/client/metrics/TimeLockFeedbackBackgroundTask.java\nindex 881cc4c370..d988692fa0 100644\n--- a/lock-api/src/main/java/com/palantir/lock/client/metrics/TimeLockFeedbackBackgroundTask.java\n+++ b/lock-api/src/main/java/com/palantir/lock/client/metrics/TimeLockFeedbackBackgroundTask.java\n\n@@ -79,15 +82,15 @@ public final class TimeLockFeedbackBackgroundTask implements AutoCloseable {\n             try {\n                 ConjureTimeLockClientFeedback feedbackReport = ConjureTimeLockClientFeedback\n                         .builder()\n-                        .stats(ImmutableMap.of(\"conjureTimelockServiceBlocking.startTransactions\",\n-                                getEndpointStatsForStartTxn()))\n+                        .startTransaction(getEndpointStatsForStartTxn())\n+                        .leaderTime(getEndpointStatsForLeaderTime())\n                         .atlasVersion(versionSupplier.get())\n                         .nodeId(nodeId)\n                         .serviceName(serviceName)\n                         .build();\n                 timeLockClientFeedbackServices\n-                        .get()\n-                        .forEach(service -> service.reportFeedback(AUTH_HEADER, feedbackReport));\n+                        .current()\n+                        .forEach(service -> reportClientFeedbackToService(feedbackReport, service));\n                 log.info(\"The TimeLock client metrics for startTransaction endpoint aggregated \"\n                                 + \"over the last 1 minute - {}\",\n                         SafeArg.of(\"startTxnStats\", feedbackReport));\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjExMDcwNw==", "url": "https://github.com/palantir/atlasdb/pull/4845#discussion_r442110707", "bodyText": "I think we should be resilient to the first node in the cluster being unavailable.", "author": "jeremyk-91", "createdAt": "2020-06-18T09:57:17Z", "path": "lock-api/src/main/java/com/palantir/lock/client/metrics/TimeLockFeedbackBackgroundTask.java", "diffHunk": "@@ -69,16 +77,20 @@ public static TimeLockFeedbackBackgroundTask create(TaggedMetricRegistry taggedM\n     public void scheduleWithFixedDelay() {\n         executor.scheduleWithFixedDelay(() -> {\n             try {\n+                ConjureTimeLockClientFeedback feedbackReport = ConjureTimeLockClientFeedback\n+                        .builder()\n+                        .stats(ImmutableMap.of(\"conjureTimelockServiceBlocking.startTransactions\",\n+                                getEndpointStatsForStartTxn()))\n+                        .atlasVersion(versionSupplier.get())\n+                        .nodeId(nodeId)\n+                        .serviceName(serviceName)\n+                        .build();\n+                timeLockClientFeedbackServices\n+                        .get()\n+                        .forEach(service -> service.reportFeedback(AUTH_HEADER, feedbackReport));", "originalCommit": "10295219cbd078ed1f72caf35e84c4e4aee064c2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b5cf6a67b0aae518f83c87cd15d119f6fc10520d", "chunk": "diff --git a/lock-api/src/main/java/com/palantir/lock/client/metrics/TimeLockFeedbackBackgroundTask.java b/lock-api/src/main/java/com/palantir/lock/client/metrics/TimeLockFeedbackBackgroundTask.java\nindex 881cc4c370..d988692fa0 100644\n--- a/lock-api/src/main/java/com/palantir/lock/client/metrics/TimeLockFeedbackBackgroundTask.java\n+++ b/lock-api/src/main/java/com/palantir/lock/client/metrics/TimeLockFeedbackBackgroundTask.java\n\n@@ -79,15 +82,15 @@ public final class TimeLockFeedbackBackgroundTask implements AutoCloseable {\n             try {\n                 ConjureTimeLockClientFeedback feedbackReport = ConjureTimeLockClientFeedback\n                         .builder()\n-                        .stats(ImmutableMap.of(\"conjureTimelockServiceBlocking.startTransactions\",\n-                                getEndpointStatsForStartTxn()))\n+                        .startTransaction(getEndpointStatsForStartTxn())\n+                        .leaderTime(getEndpointStatsForLeaderTime())\n                         .atlasVersion(versionSupplier.get())\n                         .nodeId(nodeId)\n                         .serviceName(serviceName)\n                         .build();\n                 timeLockClientFeedbackServices\n-                        .get()\n-                        .forEach(service -> service.reportFeedback(AUTH_HEADER, feedbackReport));\n+                        .current()\n+                        .forEach(service -> reportClientFeedbackToService(feedbackReport, service));\n                 log.info(\"The TimeLock client metrics for startTransaction endpoint aggregated \"\n                                 + \"over the last 1 minute - {}\",\n                         SafeArg.of(\"startTxnStats\", feedbackReport));\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjIyOTMxMQ==", "url": "https://github.com/palantir/atlasdb/pull/4845#discussion_r442229311", "bodyText": "Fix message", "author": "sudiksha27", "createdAt": "2020-06-18T13:34:05Z", "path": "lock-api/src/main/java/com/palantir/lock/client/metrics/TimeLockFeedbackBackgroundTask.java", "diffHunk": "@@ -88,6 +102,17 @@ public void scheduleWithFixedDelay() {\n                 TimeUnit.SECONDS);\n     }\n \n+    private void reportClientFeedbackToService(ConjureTimeLockClientFeedback feedbackReport,\n+            TimeLockClientFeedbackService service) {\n+        try {\n+            service.reportFeedback(AUTH_HEADER, feedbackReport);\n+        } catch (Exception e) {\n+            // we do not want this exception to bubble up so that feedback can be reported to other hosts\n+            log.warn(\"A problem occurred while reporting client feedback for timeLock \"\n+                    + \"adjudication to host - {} .\", e);", "originalCommit": "80f2a3b51eba94a2cfc2200a6fa51ece04cec701", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b5cf6a67b0aae518f83c87cd15d119f6fc10520d", "chunk": "diff --git a/lock-api/src/main/java/com/palantir/lock/client/metrics/TimeLockFeedbackBackgroundTask.java b/lock-api/src/main/java/com/palantir/lock/client/metrics/TimeLockFeedbackBackgroundTask.java\nindex 82590a0c72..d988692fa0 100644\n--- a/lock-api/src/main/java/com/palantir/lock/client/metrics/TimeLockFeedbackBackgroundTask.java\n+++ b/lock-api/src/main/java/com/palantir/lock/client/metrics/TimeLockFeedbackBackgroundTask.java\n\n@@ -97,8 +98,8 @@ public final class TimeLockFeedbackBackgroundTask implements AutoCloseable {\n                 log.warn(\"A problem occurred while reporting client feedback for timeLock adjudication.\", e);\n             }\n         },\n-                timeLockClientFeedbackReportInterval.getSeconds(),\n-                timeLockClientFeedbackReportInterval.getSeconds(),\n+                TIMELOCK_CLIENT_FEEDBACK_REPORT_INTERVAL.getSeconds(),\n+                TIMELOCK_CLIENT_FEEDBACK_REPORT_INTERVAL.getSeconds(),\n                 TimeUnit.SECONDS);\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM0Mjc5Ng==", "url": "https://github.com/palantir/atlasdb/pull/4845#discussion_r442342796", "bodyText": "The passed in user-agent isn't the versioned one though: it needs to have the atlasdb-http-client added as an auxiliary agent (see AtlasDbDialogueServiceProvider for how this is done), so that we can respond correctly to 429s and 503s (even if we aren't going to get 308s, we need to know how to deal with the other two)", "author": "jeremyk-91", "createdAt": "2020-06-18T16:11:59Z", "path": "atlasdb-config/src/main/java/com/palantir/atlasdb/factory/BroadcastDialogueServiceProvider.java", "diffHunk": "@@ -0,0 +1,123 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.factory;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.Maps;\n+import com.palantir.atlasdb.config.AuxiliaryRemotingParameters;\n+import com.palantir.atlasdb.config.ImmutableAuxiliaryRemotingParameters;\n+import com.palantir.atlasdb.config.ImmutableServerListConfig;\n+import com.palantir.atlasdb.config.ServerListConfig;\n+import com.palantir.atlasdb.http.AtlasDbHttpProtocolVersion;\n+import com.palantir.atlasdb.http.v2.DialogueClientOptions;\n+import com.palantir.atlasdb.http.v2.DialogueShimFactory;\n+import com.palantir.atlasdb.http.v2.ImmutableRemoteServiceConfiguration;\n+import com.palantir.atlasdb.http.v2.RemoteServiceConfiguration;\n+import com.palantir.common.streams.KeyedStream;\n+import com.palantir.conjure.java.api.config.service.UserAgent;\n+import com.palantir.dialogue.Channel;\n+import com.palantir.dialogue.clients.DialogueClients;\n+import com.palantir.refreshable.Refreshable;\n+\n+/**\n+ * Provides a mechanism for creating individual proxies that use Dialogue for communication for each node in the cluster.\n+ *\n+ * Furthermore, proxies should include in their {@link com.palantir.conjure.java.api.config.service.UserAgent}\n+ * information to allow client services to identify the protocol they are using to talk, via\n+ * {@link AtlasDbHttpProtocolVersion}.\n+ */\n+public final class BroadcastDialogueServiceProvider {\n+    DialogueClients.ReloadingFactory reloadingFactory;\n+    Refreshable<ServerListConfig> serverListConfigSupplier;\n+\n+    private BroadcastDialogueServiceProvider(DialogueClients.ReloadingFactory reloadingFactory,\n+            Refreshable<ServerListConfig> serverListConfigSupplier) {\n+        this.reloadingFactory = reloadingFactory;\n+        this.serverListConfigSupplier = serverListConfigSupplier;\n+    }\n+\n+    public static BroadcastDialogueServiceProvider create(\n+            DialogueClients.ReloadingFactory baseFactory,\n+            Refreshable<ServerListConfig> serverListConfigSupplier,\n+            UserAgent versionedAgent,", "originalCommit": "ba1f8f5561cff3a8d380b6938d6241c66e9c0e5a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b5cf6a67b0aae518f83c87cd15d119f6fc10520d", "chunk": "diff --git a/atlasdb-config/src/main/java/com/palantir/atlasdb/factory/BroadcastDialogueServiceProvider.java b/atlasdb-config/src/main/java/com/palantir/atlasdb/factory/BroadcastDialogueClientFactory.java\nsimilarity index 82%\nrename from atlasdb-config/src/main/java/com/palantir/atlasdb/factory/BroadcastDialogueServiceProvider.java\nrename to atlasdb-config/src/main/java/com/palantir/atlasdb/factory/BroadcastDialogueClientFactory.java\nindex 20226d311c..7e1d2c6bf8 100644\n--- a/atlasdb-config/src/main/java/com/palantir/atlasdb/factory/BroadcastDialogueServiceProvider.java\n+++ b/atlasdb-config/src/main/java/com/palantir/atlasdb/factory/BroadcastDialogueClientFactory.java\n\n@@ -28,6 +28,7 @@ import com.palantir.atlasdb.config.ImmutableAuxiliaryRemotingParameters;\n import com.palantir.atlasdb.config.ImmutableServerListConfig;\n import com.palantir.atlasdb.config.ServerListConfig;\n import com.palantir.atlasdb.http.AtlasDbHttpProtocolVersion;\n+import com.palantir.atlasdb.http.AtlasDbRemotingConstants;\n import com.palantir.atlasdb.http.v2.DialogueClientOptions;\n import com.palantir.atlasdb.http.v2.DialogueShimFactory;\n import com.palantir.atlasdb.http.v2.ImmutableRemoteServiceConfiguration;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM0NjU2OQ==", "url": "https://github.com/palantir/atlasdb/pull/4845#discussion_r442346569", "bodyText": "Currently this creates the clients every time, which is not ideal: maybe the BroadcastDialogueServiceProvider could return a more helpful type?", "author": "jeremyk-91", "createdAt": "2020-06-18T16:17:51Z", "path": "lock-api/src/main/java/com/palantir/lock/client/metrics/TimeLockFeedbackBackgroundTask.java", "diffHunk": "@@ -69,16 +77,20 @@ public static TimeLockFeedbackBackgroundTask create(TaggedMetricRegistry taggedM\n     public void scheduleWithFixedDelay() {\n         executor.scheduleWithFixedDelay(() -> {\n             try {\n+                ConjureTimeLockClientFeedback feedbackReport = ConjureTimeLockClientFeedback\n+                        .builder()\n+                        .startTransaction(getEndpointStatsForStartTxn())\n+                        .leaderTime(getEndpointStatsForLeaderTime())\n+                        .atlasVersion(versionSupplier.get())\n+                        .nodeId(nodeId)\n+                        .serviceName(serviceName)\n+                        .build();\n+                timeLockClientFeedbackServices\n+                        .get()", "originalCommit": "ba1f8f5561cff3a8d380b6938d6241c66e9c0e5a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b5cf6a67b0aae518f83c87cd15d119f6fc10520d", "chunk": "diff --git a/lock-api/src/main/java/com/palantir/lock/client/metrics/TimeLockFeedbackBackgroundTask.java b/lock-api/src/main/java/com/palantir/lock/client/metrics/TimeLockFeedbackBackgroundTask.java\nindex 867d83a1b1..d988692fa0 100644\n--- a/lock-api/src/main/java/com/palantir/lock/client/metrics/TimeLockFeedbackBackgroundTask.java\n+++ b/lock-api/src/main/java/com/palantir/lock/client/metrics/TimeLockFeedbackBackgroundTask.java\n\n@@ -86,7 +89,7 @@ public final class TimeLockFeedbackBackgroundTask implements AutoCloseable {\n                         .serviceName(serviceName)\n                         .build();\n                 timeLockClientFeedbackServices\n-                        .get()\n+                        .current()\n                         .forEach(service -> reportClientFeedbackToService(feedbackReport, service));\n                 log.info(\"The TimeLock client metrics for startTransaction endpoint aggregated \"\n                                 + \"over the last 1 minute - {}\",\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjc4MTgwMQ==", "url": "https://github.com/palantir/atlasdb/pull/4845#discussion_r442781801", "bodyText": "It's worth calling out AtlasDbDialogueServiceProvider and explaining why this is different.\nI'd even consider naming this BroadcastDialogueClientFactory or something along those lines, mainly because Service within the context of AtlasDB has a different meaning (which is generally the one in AtlasDbDialogueServiceProvider).", "author": "jeremyk-91", "createdAt": "2020-06-19T11:15:48Z", "path": "atlasdb-config/src/main/java/com/palantir/atlasdb/factory/BroadcastDialogueServiceProvider.java", "diffHunk": "@@ -0,0 +1,126 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.factory;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.Maps;\n+import com.palantir.atlasdb.config.AuxiliaryRemotingParameters;\n+import com.palantir.atlasdb.config.ImmutableAuxiliaryRemotingParameters;\n+import com.palantir.atlasdb.config.ImmutableServerListConfig;\n+import com.palantir.atlasdb.config.ServerListConfig;\n+import com.palantir.atlasdb.http.AtlasDbHttpProtocolVersion;\n+import com.palantir.atlasdb.http.AtlasDbRemotingConstants;\n+import com.palantir.atlasdb.http.v2.DialogueClientOptions;\n+import com.palantir.atlasdb.http.v2.DialogueShimFactory;\n+import com.palantir.atlasdb.http.v2.ImmutableRemoteServiceConfiguration;\n+import com.palantir.atlasdb.http.v2.RemoteServiceConfiguration;\n+import com.palantir.common.streams.KeyedStream;\n+import com.palantir.conjure.java.api.config.service.UserAgent;\n+import com.palantir.dialogue.Channel;\n+import com.palantir.dialogue.clients.DialogueClients;\n+import com.palantir.refreshable.Refreshable;\n+\n+/**\n+ * Provides a mechanism for creating individual proxies that use Dialogue for communication for each node in the\n+ * cluster.", "originalCommit": "125600cd918d62708ce643a072789e604096171a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b5cf6a67b0aae518f83c87cd15d119f6fc10520d", "chunk": "diff --git a/atlasdb-config/src/main/java/com/palantir/atlasdb/factory/BroadcastDialogueServiceProvider.java b/atlasdb-config/src/main/java/com/palantir/atlasdb/factory/BroadcastDialogueClientFactory.java\nsimilarity index 89%\nrename from atlasdb-config/src/main/java/com/palantir/atlasdb/factory/BroadcastDialogueServiceProvider.java\nrename to atlasdb-config/src/main/java/com/palantir/atlasdb/factory/BroadcastDialogueClientFactory.java\nindex 321cea5ba5..7e1d2c6bf8 100644\n--- a/atlasdb-config/src/main/java/com/palantir/atlasdb/factory/BroadcastDialogueServiceProvider.java\n+++ b/atlasdb-config/src/main/java/com/palantir/atlasdb/factory/BroadcastDialogueClientFactory.java\n\n@@ -40,24 +40,25 @@ import com.palantir.dialogue.clients.DialogueClients;\n import com.palantir.refreshable.Refreshable;\n \n /**\n- * Provides a mechanism for creating individual proxies that use Dialogue for communication for each node in the\n- * cluster.\n+ * Provides a mechanism for creating individual proxy for each node in a cluster that use Dialogue for communication\n+ * unlike {@link AtlasDbDialogueServiceProvider} which creates a proxy for a service i.e. a cluster of\n+ * zero or more nodes, where contacting any of the nodes is legitimate (subject to redirects via 308s and 503s).\n  *\n  * Furthermore, proxies should include in their {@link com.palantir.conjure.java.api.config.service.UserAgent}\n  * information to allow client services to identify the protocol they are using to talk, via\n  * {@link AtlasDbHttpProtocolVersion}.\n  */\n-public final class BroadcastDialogueServiceProvider {\n+public final class BroadcastDialogueClientFactory {\n     DialogueClients.ReloadingFactory reloadingFactory;\n     Refreshable<ServerListConfig> serverListConfigSupplier;\n \n-    private BroadcastDialogueServiceProvider(DialogueClients.ReloadingFactory reloadingFactory,\n+    private BroadcastDialogueClientFactory(DialogueClients.ReloadingFactory reloadingFactory,\n             Refreshable<ServerListConfig> serverListConfigSupplier) {\n         this.reloadingFactory = reloadingFactory;\n         this.serverListConfigSupplier = serverListConfigSupplier;\n     }\n \n-    public static BroadcastDialogueServiceProvider create(\n+    public static BroadcastDialogueClientFactory create(\n             DialogueClients.ReloadingFactory baseFactory,\n             Refreshable<ServerListConfig> serverListConfigSupplier,\n             UserAgent userAgent,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjc4MzgyMw==", "url": "https://github.com/palantir/atlasdb/pull/4845#discussion_r442783823", "bodyText": "nit: should be 204 for things without a body", "author": "jeremyk-91", "createdAt": "2020-06-19T11:20:45Z", "path": "atlasdb-config/src/test/java/com/palantir/atlasdb/factory/TransactionManagersTest.java", "diffHunk": "@@ -191,6 +204,7 @@ public void setup() throws JsonProcessingException {\n                 (\"\\\"\" + UUID.randomUUID().toString() + \"\\\"\").getBytes())));\n         availableServer.stubFor(TIMESTAMP_MAPPING.willReturn(aResponse().withStatus(200).withBody(\"1\")));\n         availableServer.stubFor(LOCK_MAPPING.willReturn(aResponse().withStatus(200).withBody(\"2\")));\n+        availableServer.stubFor(FEEDBACK_MAPPING.willReturn(aResponse().withStatus(200)));", "originalCommit": "125600cd918d62708ce643a072789e604096171a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b5cf6a67b0aae518f83c87cd15d119f6fc10520d", "chunk": "diff --git a/atlasdb-config/src/test/java/com/palantir/atlasdb/factory/TransactionManagersTest.java b/atlasdb-config/src/test/java/com/palantir/atlasdb/factory/TransactionManagersTest.java\nindex 4212eee45d..3804b86072 100644\n--- a/atlasdb-config/src/test/java/com/palantir/atlasdb/factory/TransactionManagersTest.java\n+++ b/atlasdb-config/src/test/java/com/palantir/atlasdb/factory/TransactionManagersTest.java\n\n@@ -204,7 +204,7 @@ public class TransactionManagersTest {\n                 (\"\\\"\" + UUID.randomUUID().toString() + \"\\\"\").getBytes())));\n         availableServer.stubFor(TIMESTAMP_MAPPING.willReturn(aResponse().withStatus(200).withBody(\"1\")));\n         availableServer.stubFor(LOCK_MAPPING.willReturn(aResponse().withStatus(200).withBody(\"2\")));\n-        availableServer.stubFor(FEEDBACK_MAPPING.willReturn(aResponse().withStatus(200)));\n+        availableServer.stubFor(FEEDBACK_MAPPING.willReturn(aResponse().withStatus(204)));\n \n         config = mock(AtlasDbConfig.class);\n         when(config.leader()).thenReturn(Optional.empty());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjc4NDA5NQ==", "url": "https://github.com/palantir/atlasdb/pull/4845#discussion_r442784095", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            //        timeLockRuntimeConfig = getTimelockRuntimeConfig(ImmutableList.of(getUriForPort(availablePort)));", "author": "jeremyk-91", "createdAt": "2020-06-19T11:21:24Z", "path": "atlasdb-config/src/test/java/com/palantir/atlasdb/factory/TransactionManagersTest.java", "diffHunk": "@@ -200,18 +214,21 @@ public void setup() throws JsonProcessingException {\n         when(config.keyValueService()).thenReturn(new InMemoryAtlasDbConfig());\n         when(config.initializeAsync()).thenReturn(false);\n \n-        runtimeConfig = mock(AtlasDbRuntimeConfig.class);\n-        when(runtimeConfig.timestampClient()).thenReturn(ImmutableTimestampClientConfig.of(false));\n-        when(runtimeConfig.timelockRuntime()).thenReturn(Optional.empty());\n-        when(runtimeConfig.remotingClient()).thenReturn(RemotingClientConfigs.DEFAULT);\n+        mockAtlasDbRuntimeConfig = mock(AtlasDbRuntimeConfig.class);\n+        when(mockAtlasDbRuntimeConfig.timestampClient()).thenReturn(ImmutableTimestampClientConfig.of(false));\n+        when(mockAtlasDbRuntimeConfig.timelockRuntime()).thenReturn(Optional.empty());\n+        when(mockAtlasDbRuntimeConfig.remotingClient()).thenReturn(RemotingClientConfigs.DEFAULT);\n \n         environment = mock(Consumer.class);\n \n         invalidator = mock(TimestampStoreInvalidator.class);\n         when(invalidator.backupAndInvalidate()).thenReturn(EMBEDDED_BOUND);\n \n         availablePort = availableServer.port();\n+\n         mockClientConfig = getTimelockConfigForServers(ImmutableList.of(getUriForPort(availablePort)));\n+//        timeLockRuntimeConfig = getTimelockRuntimeConfig(ImmutableList.of(getUriForPort(availablePort)));", "originalCommit": "125600cd918d62708ce643a072789e604096171a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b5cf6a67b0aae518f83c87cd15d119f6fc10520d", "chunk": "diff --git a/atlasdb-config/src/test/java/com/palantir/atlasdb/factory/TransactionManagersTest.java b/atlasdb-config/src/test/java/com/palantir/atlasdb/factory/TransactionManagersTest.java\nindex 4212eee45d..3804b86072 100644\n--- a/atlasdb-config/src/test/java/com/palantir/atlasdb/factory/TransactionManagersTest.java\n+++ b/atlasdb-config/src/test/java/com/palantir/atlasdb/factory/TransactionManagersTest.java\n\n@@ -225,9 +225,7 @@ public class TransactionManagersTest {\n         when(invalidator.backupAndInvalidate()).thenReturn(EMBEDDED_BOUND);\n \n         availablePort = availableServer.port();\n-\n         mockClientConfig = getTimelockConfigForServers(ImmutableList.of(getUriForPort(availablePort)));\n-//        timeLockRuntimeConfig = getTimelockRuntimeConfig(ImmutableList.of(getUriForPort(availablePort)));\n \n         rawRemoteServerConfig = ImmutableServerListConfig.builder()\n                 .addServers(getUriForPort(availablePort))\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjc4NjA4OQ==", "url": "https://github.com/palantir/atlasdb/pull/4845#discussion_r442786089", "bodyText": "oops, not sure how this slipped the naming conventions the last time, but constants typically have capital snake case", "author": "jeremyk-91", "createdAt": "2020-06-19T11:26:41Z", "path": "lock-api/src/main/java/com/palantir/lock/client/metrics/TimeLockFeedbackBackgroundTask.java", "diffHunk": "@@ -18,26 +18,30 @@\n \n \n import java.time.Duration;\n+import java.util.List;\n import java.util.UUID;\n import java.util.concurrent.ScheduledExecutorService;\n import java.util.concurrent.TimeUnit;\n import java.util.function.Supplier;\n-\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n-import com.google.common.collect.ImmutableMap;\n+import com.palantir.atlasdb.timelock.adjudicate.feedback.TimeLockClientFeedbackService;\n import com.palantir.common.concurrent.NamedThreadFactory;\n import com.palantir.common.concurrent.PTExecutors;\n import com.palantir.lock.client.ConjureTimelockServiceBlockingMetrics;\n import com.palantir.logsafe.SafeArg;\n+import com.palantir.refreshable.Refreshable;\n import com.palantir.timelock.feedback.ConjureTimeLockClientFeedback;\n import com.palantir.timelock.feedback.EndpointStatistics;\n+import com.palantir.tokens.auth.AuthHeader;\n import com.palantir.tritium.metrics.registry.TaggedMetricRegistry;\n \n public final class TimeLockFeedbackBackgroundTask implements AutoCloseable {\n     private static final Logger log = LoggerFactory.getLogger(\n             TimeLockFeedbackBackgroundTask.class);\n+\n+    private static final AuthHeader AUTH_HEADER = AuthHeader.valueOf(\"Bearer omitted\");\n     private static final String TIMELOCK_FEEDBACK_THREAD_PREFIX = \"TimeLockFeedbackBackgroundTask\";\n     private static final Duration timeLockClientFeedbackReportInterval = Duration.ofSeconds(30);", "originalCommit": "125600cd918d62708ce643a072789e604096171a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b5cf6a67b0aae518f83c87cd15d119f6fc10520d", "chunk": "diff --git a/lock-api/src/main/java/com/palantir/lock/client/metrics/TimeLockFeedbackBackgroundTask.java b/lock-api/src/main/java/com/palantir/lock/client/metrics/TimeLockFeedbackBackgroundTask.java\nindex 4b196297d4..d988692fa0 100644\n--- a/lock-api/src/main/java/com/palantir/lock/client/metrics/TimeLockFeedbackBackgroundTask.java\n+++ b/lock-api/src/main/java/com/palantir/lock/client/metrics/TimeLockFeedbackBackgroundTask.java\n\n@@ -43,7 +43,7 @@ public final class TimeLockFeedbackBackgroundTask implements AutoCloseable {\n \n     private static final AuthHeader AUTH_HEADER = AuthHeader.valueOf(\"Bearer omitted\");\n     private static final String TIMELOCK_FEEDBACK_THREAD_PREFIX = \"TimeLockFeedbackBackgroundTask\";\n-    private static final Duration timeLockClientFeedbackReportInterval = Duration.ofSeconds(30);\n+    private static final Duration TIMELOCK_CLIENT_FEEDBACK_REPORT_INTERVAL = Duration.ofSeconds(30);\n \n     private final ScheduledExecutorService executor = PTExecutors.newSingleThreadScheduledExecutor(\n                     new NamedThreadFactory(TIMELOCK_FEEDBACK_THREAD_PREFIX, true));\n"}}, {"oid": "b5cf6a67b0aae518f83c87cd15d119f6fc10520d", "url": "https://github.com/palantir/atlasdb/commit/b5cf6a67b0aae518f83c87cd15d119f6fc10520d", "message": "Test fix + address comments", "committedDate": "2020-06-19T15:27:15Z", "type": "forcePushed"}, {"oid": "06ee97abcc44dfeb79a76e9275b8d0bec8ab2519", "url": "https://github.com/palantir/atlasdb/commit/06ee97abcc44dfeb79a76e9275b8d0bec8ab2519", "message": "report feedback to timeLock | poc", "committedDate": "2020-06-22T13:53:13Z", "type": "commit"}, {"oid": "07bcc58744cbb6e1d03aa9a2a79e38a6e40edbf1", "url": "https://github.com/palantir/atlasdb/commit/07bcc58744cbb6e1d03aa9a2a79e38a6e40edbf1", "message": "Reloading proxies", "committedDate": "2020-06-22T13:53:32Z", "type": "commit"}, {"oid": "19d99b2363ce3cc92c186c1c330dacb7b6a005cb", "url": "https://github.com/palantir/atlasdb/commit/19d99b2363ce3cc92c186c1c330dacb7b6a005cb", "message": "Use dialogue", "committedDate": "2020-06-22T13:53:33Z", "type": "commit"}, {"oid": "77d22ccfaba2e6b54d89e9140726f96eed3f6a54", "url": "https://github.com/palantir/atlasdb/commit/77d22ccfaba2e6b54d89e9140726f96eed3f6a54", "message": "Address comments", "committedDate": "2020-06-22T13:53:33Z", "type": "commit"}, {"oid": "09d0c3fbefae75ba3a843e167a513aa0fece5afb", "url": "https://github.com/palantir/atlasdb/commit/09d0c3fbefae75ba3a843e167a513aa0fece5afb", "message": "refactor", "committedDate": "2020-06-22T13:53:33Z", "type": "commit"}, {"oid": "d1e45f31c2f23276ecbc1323da248edf46149e1a", "url": "https://github.com/palantir/atlasdb/commit/d1e45f31c2f23276ecbc1323da248edf46149e1a", "message": "Sanity test", "committedDate": "2020-06-22T13:53:33Z", "type": "commit"}, {"oid": "081f5f7a71148c7971820b5f9abf9d2d1fb31a9e", "url": "https://github.com/palantir/atlasdb/commit/081f5f7a71148c7971820b5f9abf9d2d1fb31a9e", "message": "Use broadcasting dialogue service provider", "committedDate": "2020-06-22T13:53:33Z", "type": "commit"}, {"oid": "176b8960451f6adf92526b377d171d85632bc7ed", "url": "https://github.com/palantir/atlasdb/commit/176b8960451f6adf92526b377d171d85632bc7ed", "message": "clean up", "committedDate": "2020-06-22T13:53:33Z", "type": "commit"}, {"oid": "3ee29e05bece7bc5ace0271dfb4e72574b6e7cbd", "url": "https://github.com/palantir/atlasdb/commit/3ee29e05bece7bc5ace0271dfb4e72574b6e7cbd", "message": "Refactor", "committedDate": "2020-06-22T13:53:33Z", "type": "commit"}, {"oid": "ce74b64a2bd9bb9bcfe7a9477cc6c04b024f9f29", "url": "https://github.com/palantir/atlasdb/commit/ce74b64a2bd9bb9bcfe7a9477cc6c04b024f9f29", "message": "clean", "committedDate": "2020-06-22T13:53:33Z", "type": "commit"}, {"oid": "2fc381a0ad73f51d21aac38fc19e443acc7042fe", "url": "https://github.com/palantir/atlasdb/commit/2fc381a0ad73f51d21aac38fc19e443acc7042fe", "message": "Checkstyle", "committedDate": "2020-06-22T13:53:33Z", "type": "commit"}, {"oid": "a119eb3383ee5fe3a71f591b7a12d2318b4f0337", "url": "https://github.com/palantir/atlasdb/commit/a119eb3383ee5fe3a71f591b7a12d2318b4f0337", "message": "Add generated changelog entries", "committedDate": "2020-06-22T13:53:33Z", "type": "commit"}, {"oid": "123078de6416afe47f9d1befe0a49839b9ccd4b8", "url": "https://github.com/palantir/atlasdb/commit/123078de6416afe47f9d1befe0a49839b9ccd4b8", "message": "Try", "committedDate": "2020-06-22T13:53:33Z", "type": "commit"}, {"oid": "e3fa5783c9c13534fc129da1dcb9080dff99464f", "url": "https://github.com/palantir/atlasdb/commit/e3fa5783c9c13534fc129da1dcb9080dff99464f", "message": "refactor", "committedDate": "2020-06-22T13:53:33Z", "type": "commit"}, {"oid": "8369559f245f5b2255026fb530db3938368144f2", "url": "https://github.com/palantir/atlasdb/commit/8369559f245f5b2255026fb530db3938368144f2", "message": "fix + refactor", "committedDate": "2020-06-22T13:53:33Z", "type": "commit"}, {"oid": "d31a08fb7c26108ddc44882d3ff8eb69caf916d7", "url": "https://github.com/palantir/atlasdb/commit/d31a08fb7c26108ddc44882d3ff8eb69caf916d7", "message": "Use refreshable", "committedDate": "2020-06-22T13:53:49Z", "type": "commit"}, {"oid": "19e5315dd964d1f28c66f6aed24998b5e8a60908", "url": "https://github.com/palantir/atlasdb/commit/19e5315dd964d1f28c66f6aed24998b5e8a60908", "message": "versioned user agent", "committedDate": "2020-06-22T13:53:49Z", "type": "commit"}, {"oid": "a1e03580ce8cbfdd627ad72f9cbed8635ce27f15", "url": "https://github.com/palantir/atlasdb/commit/a1e03580ce8cbfdd627ad72f9cbed8635ce27f15", "message": "Update test", "committedDate": "2020-06-22T13:53:49Z", "type": "commit"}, {"oid": "b86e9691fec33a7a952375e1a9b69b266b90b68d", "url": "https://github.com/palantir/atlasdb/commit/b86e9691fec33a7a952375e1a9b69b266b90b68d", "message": "checkstyle", "committedDate": "2020-06-22T13:53:49Z", "type": "commit"}, {"oid": "e9ab829018f1c7121229275813eaa4908abe148e", "url": "https://github.com/palantir/atlasdb/commit/e9ab829018f1c7121229275813eaa4908abe148e", "message": "Address comments - 1", "committedDate": "2020-06-22T13:53:49Z", "type": "commit"}, {"oid": "7f8b0bf6c9bb02b145e2c35562a9163fcc08eb3a", "url": "https://github.com/palantir/atlasdb/commit/7f8b0bf6c9bb02b145e2c35562a9163fcc08eb3a", "message": "Test fix + address comments", "committedDate": "2020-06-22T13:54:47Z", "type": "commit"}, {"oid": "f39c225789609f45739b53a5c7708f426c6d7385", "url": "https://github.com/palantir/atlasdb/commit/f39c225789609f45739b53a5c7708f426c6d7385", "message": "bug fix", "committedDate": "2020-06-22T13:54:47Z", "type": "commit"}, {"oid": "f39c225789609f45739b53a5c7708f426c6d7385", "url": "https://github.com/palantir/atlasdb/commit/f39c225789609f45739b53a5c7708f426c6d7385", "message": "bug fix", "committedDate": "2020-06-22T13:54:47Z", "type": "forcePushed"}, {"oid": "57ca1c1a3925ba51fa79a14fb873b622020bd5d7", "url": "https://github.com/palantir/atlasdb/commit/57ca1c1a3925ba51fa79a14fb873b622020bd5d7", "message": "kill log", "committedDate": "2020-06-22T14:38:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzU3NjAwNQ==", "url": "https://github.com/palantir/atlasdb/pull/4845#discussion_r443576005", "bodyText": "nit: oops!\n\n  \n    \n      \n        Suggested change", "author": "jeremyk-91", "createdAt": "2020-06-22T13:56:07Z", "path": "atlasdb-config/src/main/java/com/palantir/atlasdb/factory/BroadcastDialogueClientFactory.java", "diffHunk": "@@ -0,0 +1,127 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.factory;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.Maps;\n+import com.palantir.atlasdb.config.AuxiliaryRemotingParameters;\n+import com.palantir.atlasdb.config.ImmutableAuxiliaryRemotingParameters;\n+import com.palantir.atlasdb.config.ImmutableServerListConfig;\n+import com.palantir.atlasdb.config.ServerListConfig;\n+import com.palantir.atlasdb.http.AtlasDbHttpProtocolVersion;\n+import com.palantir.atlasdb.http.AtlasDbRemotingConstants;\n+import com.palantir.atlasdb.http.v2.DialogueClientOptions;\n+import com.palantir.atlasdb.http.v2.DialogueShimFactory;\n+import com.palantir.atlasdb.http.v2.ImmutableRemoteServiceConfiguration;\n+import com.palantir.atlasdb.http.v2.RemoteServiceConfiguration;\n+import com.palantir.common.streams.KeyedStream;\n+import com.palantir.conjure.java.api.config.service.UserAgent;\n+import com.palantir.dialogue.Channel;\n+import com.palantir.dialogue.clients.DialogueClients;\n+import com.palantir.refreshable.Refreshable;\n+\n+/**\n+ * Provides a mechanism for creating individual proxy for each node in a cluster that use Dialogue for communication\n+ * unlike {@link AtlasDbDialogueServiceProvider} which creates a proxy for a service i.e. a cluster of\n+ * zero or more nodes, where contacting any of the nodes is legitimate (subject to redirects via 308s and 503s).\n+ *\n+ * Furthermore, proxies should include in their {@link com.palantir.conjure.java.api.config.service.UserAgent}\n+ * information to allow client services to identify the protocol they are using to talk, via\n+ * {@link AtlasDbHttpProtocolVersion}.\n+ */\n+public final class BroadcastDialogueClientFactory {\n+    DialogueClients.ReloadingFactory reloadingFactory;\n+    Refreshable<ServerListConfig> serverListConfigSupplier;\n+\n+    private BroadcastDialogueClientFactory(DialogueClients.ReloadingFactory reloadingFactory,\n+            Refreshable<ServerListConfig> serverListConfigSupplier) {\n+        this.reloadingFactory = reloadingFactory;\n+        this.serverListConfigSupplier = serverListConfigSupplier;\n+    }\n+\n+    public static BroadcastDialogueClientFactory create(\n+            DialogueClients.ReloadingFactory baseFactory,\n+            Refreshable<ServerListConfig> serverListConfigSupplier,\n+            UserAgent userAgent,\n+            AuxiliaryRemotingParameters parameters) {\n+        UserAgent versionedAgent = userAgent.addAgent(AtlasDbRemotingConstants.ATLASDB_HTTP_CLIENT_AGENT);\n+        Refreshable<Map<String, RemoteServiceConfiguration>> timeLockRemoteConfigurations = serverListConfigSupplier\n+                .map(serverListConfig -> createRemoteServiceConfigurations(\n+                        serverListConfig,\n+                        versionedAgent,\n+                        parameters));\n+\n+        DialogueClients.ReloadingFactory reloadingFactory = baseFactory.reloading(\n+                timeLockRemoteConfigurations.map(DialogueClientOptions::toServicesConfigBlock))\n+                .withUserAgent(versionedAgent);\n+        return new BroadcastDialogueClientFactory(reloadingFactory, serverListConfigSupplier);\n+    }\n+\n+    private static Map<String, RemoteServiceConfiguration> createRemoteServiceConfigurations(\n+            ServerListConfig serverListConfig, UserAgent versionedAgent, AuxiliaryRemotingParameters parameters) {\n+        return KeyedStream.of(serverListConfig.servers())\n+                .map(server -> ImmutableServerListConfig.builder()\n+                        .from(serverListConfig)\n+                        .servers(ImmutableList.of(server))\n+                        .build())\n+                .flatMapEntries((uri, singleServerConfig) -> Stream.of(false, true)\n+                        .map(retry -> createSingleServiceConfigurationMapping(\n+                                uri, singleServerConfig, parameters, versionedAgent, retry)))\n+                .collectToMap();\n+    }\n+\n+", "originalCommit": "f39c225789609f45739b53a5c7708f426c6d7385", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b2237a09111f983c43dc74ab6b4396b1092fec9b", "chunk": "diff --git a/atlasdb-config/src/main/java/com/palantir/atlasdb/factory/BroadcastDialogueClientFactory.java b/atlasdb-config/src/main/java/com/palantir/atlasdb/factory/BroadcastDialogueClientFactory.java\nindex 7e1d2c6bf8..1933eef147 100644\n--- a/atlasdb-config/src/main/java/com/palantir/atlasdb/factory/BroadcastDialogueClientFactory.java\n+++ b/atlasdb-config/src/main/java/com/palantir/atlasdb/factory/BroadcastDialogueClientFactory.java\n\n@@ -89,7 +89,6 @@ public final class BroadcastDialogueClientFactory {\n                 .collectToMap();\n     }\n \n-\n     private static Map.Entry<String, RemoteServiceConfiguration> createSingleServiceConfigurationMapping(\n             String uri,\n             ServerListConfig singleServerConfig,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzYxMTI4MA==", "url": "https://github.com/palantir/atlasdb/pull/4845#discussion_r443611280", "bodyText": "nit: You could probably have a function that takes a Timer and gets the 99th percentile (then it can be shared with the StartTransaction ones).", "author": "jeremyk-91", "createdAt": "2020-06-22T14:43:12Z", "path": "lock-api/src/main/java/com/palantir/lock/client/metrics/TimeLockFeedbackBackgroundTask.java", "diffHunk": "@@ -69,25 +80,52 @@ public static TimeLockFeedbackBackgroundTask create(TaggedMetricRegistry taggedM\n     public void scheduleWithFixedDelay() {\n         executor.scheduleWithFixedDelay(() -> {\n             try {\n-                log.info(\"The TimeLock client metrics for startTransaction endpoint aggregated \"\n-                                + \"over the last 1 minute - {}\",\n-                        SafeArg.of(\"startTxnStats\", ConjureTimeLockClientFeedback\n-                                .builder()\n-                                .stats(ImmutableMap.of(\"conjureTimelockServiceBlocking.startTransactions\",\n-                                        getEndpointStatsForStartTxn()))\n-                                .atlasVersion(versionSupplier.get())\n-                                .nodeId(nodeId)\n-                                .serviceName(serviceName)\n-                                .build()));\n+                ConjureTimeLockClientFeedback feedbackReport = ConjureTimeLockClientFeedback\n+                        .builder()\n+                        .startTransaction(getEndpointStatsForStartTxn())\n+                        .leaderTime(getEndpointStatsForLeaderTime())\n+                        .atlasVersion(versionSupplier.get())\n+                        .nodeId(nodeId)\n+                        .serviceName(serviceName)\n+                        .build();\n+                timeLockClientFeedbackServices\n+                        .current()\n+                        .forEach(service -> reportClientFeedbackToService(feedbackReport, service));\n             } catch (Exception e) {\n                 log.warn(\"A problem occurred while reporting client feedback for timeLock adjudication.\", e);\n             }\n         },\n-                timeLockClientFeedbackReportInterval.getSeconds(),\n-                timeLockClientFeedbackReportInterval.getSeconds(),\n+                TIMELOCK_CLIENT_FEEDBACK_REPORT_INTERVAL.getSeconds(),\n+                TIMELOCK_CLIENT_FEEDBACK_REPORT_INTERVAL.getSeconds(),\n                 TimeUnit.SECONDS);\n     }\n \n+    private void reportClientFeedbackToService(ConjureTimeLockClientFeedback feedbackReport,\n+            TimeLockClientFeedbackService service) {\n+        try {\n+            service.reportFeedback(AUTH_HEADER, feedbackReport);\n+        } catch (Exception e) {\n+            // we do not want this exception to bubble up so that feedback can be reported to other hosts\n+            log.warn(\"Failed to report feedback to TimeLock host.\", e);\n+        }\n+    }\n+\n+    private EndpointStatistics getEndpointStatsForLeaderTime() {\n+        return EndpointStatistics.of(getP99ForLeaderTime(),\n+                getOneMinuteRateForLeaderTime());\n+    }\n+\n+    private double getOneMinuteRateForLeaderTime() {\n+        return conjureTimelockServiceBlockingMetrics.leaderTime().getOneMinuteRate();\n+    }\n+\n+    private double getP99ForLeaderTime() {\n+        return conjureTimelockServiceBlockingMetrics\n+                .leaderTime()\n+                .getSnapshot()\n+                .get99thPercentile();", "originalCommit": "57ca1c1a3925ba51fa79a14fb873b622020bd5d7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b2237a09111f983c43dc74ab6b4396b1092fec9b", "chunk": "diff --git a/lock-api/src/main/java/com/palantir/lock/client/metrics/TimeLockFeedbackBackgroundTask.java b/lock-api/src/main/java/com/palantir/lock/client/metrics/TimeLockFeedbackBackgroundTask.java\nindex e0a573d45d..bbb5694f24 100644\n--- a/lock-api/src/main/java/com/palantir/lock/client/metrics/TimeLockFeedbackBackgroundTask.java\n+++ b/lock-api/src/main/java/com/palantir/lock/client/metrics/TimeLockFeedbackBackgroundTask.java\n\n@@ -120,10 +121,8 @@ public final class TimeLockFeedbackBackgroundTask implements AutoCloseable {\n     }\n \n     private double getP99ForLeaderTime() {\n-        return conjureTimelockServiceBlockingMetrics\n-                .leaderTime()\n-                .getSnapshot()\n-                .get99thPercentile();\n+        return getP99(() -> conjureTimelockServiceBlockingMetrics.leaderTime());\n+\n     }\n \n     private EndpointStatistics getEndpointStatsForStartTxn() {\n"}}, {"oid": "b2237a09111f983c43dc74ab6b4396b1092fec9b", "url": "https://github.com/palantir/atlasdb/commit/b2237a09111f983c43dc74ab6b4396b1092fec9b", "message": "Address comments", "committedDate": "2020-06-22T15:07:51Z", "type": "commit"}]}