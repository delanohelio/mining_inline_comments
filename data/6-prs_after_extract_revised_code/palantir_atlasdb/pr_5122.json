{"pr_number": 5122, "pr_title": "[Cross Client Batching LeaderTimes - 2b] | MultiClientConjureTimelockService Dialogue Clients", "pr_createdAt": "2020-11-19T18:54:51Z", "pr_url": "https://github.com/palantir/atlasdb/pull/5122", "timeline": [{"oid": "97fd2737405c5e748a03d94fc5cac258361c9f5b", "url": "https://github.com/palantir/atlasdb/commit/97fd2737405c5e748a03d94fc5cac258361c9f5b", "message": " Fix tests + remove redundant tests", "committedDate": "2020-11-19T18:21:13Z", "type": "commit"}, {"oid": "b29f21a48ffec3c35777b1052180f02f0aa3a47c", "url": "https://github.com/palantir/atlasdb/commit/b29f21a48ffec3c35777b1052180f02f0aa3a47c", "message": "Refactor LeaderTimeGetter", "committedDate": "2020-11-19T18:22:00Z", "type": "commit"}, {"oid": "c5a9196255c30684aada5e74efe4941b8da31ef5", "url": "https://github.com/palantir/atlasdb/commit/c5a9196255c30684aada5e74efe4941b8da31ef5", "message": "Configurable bufferSize", "committedDate": "2020-11-19T18:22:00Z", "type": "commit"}, {"oid": "66831ceacc4187c2ef4bfad18bcb795343cd38f4", "url": "https://github.com/palantir/atlasdb/commit/66831ceacc4187c2ef4bfad18bcb795343cd38f4", "message": "Implement LeaderTimeCoalescingBatcher", "committedDate": "2020-11-19T18:22:00Z", "type": "commit"}, {"oid": "904a0264e0dfb04a2174a13649c4fe6d6eaafc68", "url": "https://github.com/palantir/atlasdb/commit/904a0264e0dfb04a2174a13649c4fe6d6eaafc68", "message": "Wire LeaderTimeGetter", "committedDate": "2020-11-19T18:22:00Z", "type": "commit"}, {"oid": "e777d72f96808db68a59aee9c4951164ae3b775b", "url": "https://github.com/palantir/atlasdb/commit/e777d72f96808db68a59aee9c4951164ae3b775b", "message": "Fix build", "committedDate": "2020-11-19T18:22:00Z", "type": "commit"}, {"oid": "605cbc3619f4252951b12377397f1a949e1dd998", "url": "https://github.com/palantir/atlasdb/commit/605cbc3619f4252951b12377397f1a949e1dd998", "message": "Address comments", "committedDate": "2020-11-19T18:22:00Z", "type": "commit"}, {"oid": "d66dec83618a44d80b189fb881c489d5f17fc4af", "url": "https://github.com/palantir/atlasdb/commit/d66dec83618a44d80b189fb881c489d5f17fc4af", "message": "Remove redundant line", "committedDate": "2020-11-19T18:26:27Z", "type": "commit"}, {"oid": "b112b32f738970dc78620ba4a2232efa2672ed84", "url": "https://github.com/palantir/atlasdb/commit/b112b32f738970dc78620ba4a2232efa2672ed84", "message": "Fix tests", "committedDate": "2020-11-19T18:45:27Z", "type": "commit"}, {"oid": "35f74badc329dc922c01d66423fd3eeee6e6c0f3", "url": "https://github.com/palantir/atlasdb/commit/35f74badc329dc922c01d66423fd3eeee6e6c0f3", "message": "Add generated changelog entries", "committedDate": "2020-11-19T18:45:27Z", "type": "commit"}, {"oid": "3676c5373b79ce897dd2e998e9b139323cbde18d", "url": "https://github.com/palantir/atlasdb/commit/3676c5373b79ce897dd2e998e9b139323cbde18d", "message": "Dialogue proxy for MultiClientConjureTimelockService", "committedDate": "2020-11-19T18:53:16Z", "type": "commit"}, {"oid": "0bb112997f793060dfa8c4ab7b49cbe1637977ce", "url": "https://github.com/palantir/atlasdb/commit/0bb112997f793060dfa8c4ab7b49cbe1637977ce", "message": "Spotless", "committedDate": "2020-11-19T18:54:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzYzMzUxMQ==", "url": "https://github.com/palantir/atlasdb/pull/5122#discussion_r527633511", "bodyText": "This should implement MultiClientConjureTimelockService?", "author": "jeremyk-91", "createdAt": "2020-11-20T11:36:51Z", "path": "lock-api/src/main/java/com/palantir/lock/client/DialogueAdaptingMultiClientConjureTimelockService.java", "diffHunk": "@@ -0,0 +1,38 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.lock.client;\n+\n+import com.palantir.atlasdb.timelock.api.LeaderTimes;\n+import com.palantir.atlasdb.timelock.api.MultiClientConjureTimelockServiceBlocking;\n+import com.palantir.atlasdb.timelock.api.Namespace;\n+import com.palantir.tokens.auth.AuthHeader;\n+import java.util.Set;\n+\n+public class DialogueAdaptingMultiClientConjureTimelockService {", "originalCommit": "0bb112997f793060dfa8c4ab7b49cbe1637977ce", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a6fabfd31050ff7d2807d7c9a4f264d4b2c58224", "chunk": "diff --git a/lock-api/src/main/java/com/palantir/lock/client/DialogueAdaptingMultiClientConjureTimelockService.java b/lock-api/src/main/java/com/palantir/lock/client/AuthenticatingMultiClientConjureTimelockServiceImpl.java\nsimilarity index 71%\nrename from lock-api/src/main/java/com/palantir/lock/client/DialogueAdaptingMultiClientConjureTimelockService.java\nrename to lock-api/src/main/java/com/palantir/lock/client/AuthenticatingMultiClientConjureTimelockServiceImpl.java\nindex 43357e21f6..bc5b83f45a 100644\n--- a/lock-api/src/main/java/com/palantir/lock/client/DialogueAdaptingMultiClientConjureTimelockService.java\n+++ b/lock-api/src/main/java/com/palantir/lock/client/AuthenticatingMultiClientConjureTimelockServiceImpl.java\n\n@@ -22,17 +22,18 @@ import com.palantir.atlasdb.timelock.api.Namespace;\n import com.palantir.tokens.auth.AuthHeader;\n import java.util.Set;\n \n-public class DialogueAdaptingMultiClientConjureTimelockService {\n+public class AuthenticatingMultiClientConjureTimelockServiceImpl\n+        implements AuthenticatingMultiClientConjureTimelockService {\n     private static final AuthHeader AUTH_HEADER = AuthHeader.valueOf(\"Bearer omitted\");\n \n-    private final MultiClientConjureTimelockServiceBlocking dialogueDelegate;\n+    private final MultiClientConjureTimelockServiceBlocking delegate;\n \n-    public DialogueAdaptingMultiClientConjureTimelockService(\n-            MultiClientConjureTimelockServiceBlocking dialogueDelegate) {\n-        this.dialogueDelegate = dialogueDelegate;\n+    public AuthenticatingMultiClientConjureTimelockServiceImpl(MultiClientConjureTimelockServiceBlocking delegate) {\n+        this.delegate = delegate;\n     }\n \n+    @Override\n     public LeaderTimes leaderTimes(Set<Namespace> namespaces) {\n-        return dialogueDelegate.leaderTimes(AUTH_HEADER, namespaces);\n+        return delegate.leaderTimes(AUTH_HEADER, namespaces);\n     }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzYzMzU5Nw==", "url": "https://github.com/palantir/atlasdb/pull/5122#discussion_r527633597", "bodyText": "This shouldn't depend on the concrete type", "author": "jeremyk-91", "createdAt": "2020-11-20T11:37:03Z", "path": "atlasdb-config/src/main/java/com/palantir/atlasdb/factory/AtlasDbDialogueServiceProvider.java", "diffHunk": "@@ -113,6 +115,17 @@ ConjureTimelockService getConjureTimelockService() {\n         return new TimeoutSensitiveConjureTimelockService(shortAndLongTimeoutServices);\n     }\n \n+    DialogueAdaptingMultiClientConjureTimelockService getMultiClientConjureTimelockService() {", "originalCommit": "0bb112997f793060dfa8c4ab7b49cbe1637977ce", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2e5a918484a68fdae46c5f9e706eeb94c39755a1", "chunk": "diff --git a/atlasdb-config/src/main/java/com/palantir/atlasdb/factory/AtlasDbDialogueServiceProvider.java b/atlasdb-config/src/main/java/com/palantir/atlasdb/factory/AtlasDbDialogueServiceProvider.java\nindex 227ecf063c..b43cb2502e 100644\n--- a/atlasdb-config/src/main/java/com/palantir/atlasdb/factory/AtlasDbDialogueServiceProvider.java\n+++ b/atlasdb-config/src/main/java/com/palantir/atlasdb/factory/AtlasDbDialogueServiceProvider.java\n\n@@ -115,15 +114,14 @@ public final class AtlasDbDialogueServiceProvider {\n         return new TimeoutSensitiveConjureTimelockService(shortAndLongTimeoutServices);\n     }\n \n-    DialogueAdaptingMultiClientConjureTimelockService getMultiClientConjureTimelockService() {\n+    MultiClientConjureTimelockServiceBlocking getMultiClientConjureTimelockService() {\n         MultiClientConjureTimelockServiceBlocking blockingService =\n                 dialogueClientFactory.get(MultiClientConjureTimelockServiceBlocking.class, TIMELOCK_SHORT_TIMEOUT);\n-        MultiClientConjureTimelockServiceBlocking instrumentedService = AtlasDbMetrics.instrumentWithTaggedMetrics(\n+        return AtlasDbMetrics.instrumentWithTaggedMetrics(\n                 taggedMetricRegistry,\n                 MultiClientConjureTimelockServiceBlocking.class,\n                 FastFailoverProxy.newProxyInstance(\n                         MultiClientConjureTimelockServiceBlocking.class, () -> blockingService));\n-        return new DialogueAdaptingMultiClientConjureTimelockService(instrumentedService);\n     }\n \n     TimestampManagementRpcClient getTimestampManagementRpcClient() {\n"}}, {"oid": "58d4d6d043e72ec755a91e5a69bd2b376675b9d2", "url": "https://github.com/palantir/atlasdb/commit/58d4d6d043e72ec755a91e5a69bd2b376675b9d2", "message": "Merge branch 'develop' into ccb-lts-2b", "committedDate": "2020-11-20T12:46:16Z", "type": "commit"}, {"oid": "2e5a918484a68fdae46c5f9e706eeb94c39755a1", "url": "https://github.com/palantir/atlasdb/commit/2e5a918484a68fdae46c5f9e706eeb94c39755a1", "message": "Remove responsibilty of concrete class from DialogueServiceProvider", "committedDate": "2020-11-20T12:55:38Z", "type": "commit"}, {"oid": "a6fabfd31050ff7d2807d7c9a4f264d4b2c58224", "url": "https://github.com/palantir/atlasdb/commit/a6fabfd31050ff7d2807d7c9a4f264d4b2c58224", "message": "Dependency Inversion", "committedDate": "2020-11-20T18:19:47Z", "type": "commit"}, {"oid": "2a515e50ca64dc01d8ea5a2bca8f6bb76545aa25", "url": "https://github.com/palantir/atlasdb/commit/2a515e50ca64dc01d8ea5a2bca8f6bb76545aa25", "message": "Add change so previous commit makes sense", "committedDate": "2020-11-20T18:23:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODcwODA3Ng==", "url": "https://github.com/palantir/atlasdb/pull/5122#discussion_r528708076", "bodyText": "IntelliJ says this can be package-private, so please do so.", "author": "Jolyon-S", "createdAt": "2020-11-23T13:37:37Z", "path": "lock-api/src/main/java/com/palantir/lock/client/LeaderTimeCoalescingBatcher.java", "diffHunk": "@@ -49,15 +47,15 @@ public void close() {\n     }\n \n     static class LeaderTimeCoalescingConsumer implements CoalescingRequestFunction<Namespace, LeaderTime> {\n-        private final MultiClientConjureTimelockService delegate;\n+        private final AuthenticatingMultiClientConjureTimelockService delegate;\n \n-        public LeaderTimeCoalescingConsumer(MultiClientConjureTimelockService delegate) {\n+        public LeaderTimeCoalescingConsumer(AuthenticatingMultiClientConjureTimelockService delegate) {", "originalCommit": "2a515e50ca64dc01d8ea5a2bca8f6bb76545aa25", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "4be23f250658d6b42b2374e009db1f235d96e6a3", "chunk": "diff --git a/lock-api/src/main/java/com/palantir/lock/client/LeaderTimeCoalescingBatcher.java b/lock-api/src/main/java/com/palantir/lock/client/LeaderTimeCoalescingBatcher.java\nindex 5aa9201e36..1116ef3ec1 100644\n--- a/lock-api/src/main/java/com/palantir/lock/client/LeaderTimeCoalescingBatcher.java\n+++ b/lock-api/src/main/java/com/palantir/lock/client/LeaderTimeCoalescingBatcher.java\n\n@@ -47,9 +46,9 @@ public class LeaderTimeCoalescingBatcher implements AutoCloseable {\n     }\n \n     static class LeaderTimeCoalescingConsumer implements CoalescingRequestFunction<Namespace, LeaderTime> {\n-        private final AuthenticatingMultiClientConjureTimelockService delegate;\n+        private final InternalMultiClientConjureTimelockService delegate;\n \n-        public LeaderTimeCoalescingConsumer(AuthenticatingMultiClientConjureTimelockService delegate) {\n+        public LeaderTimeCoalescingConsumer(InternalMultiClientConjureTimelockService delegate) {\n             this.delegate = delegate;\n         }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODcwOTQ1Nw==", "url": "https://github.com/palantir/atlasdb/pull/5122#discussion_r528709457", "bodyText": "I think I understand why we need the impl, but not the interface - I feel like this is a very specific interface (where I'd rather there is a more generic interface and AMCCTS is one of the implementations). Regardless, this is also possibly a misleading name: this always passes a token that is \"Bearer omitted\", which while technically is on the theme of authentication, feels a bit odd to call this an authenticating service.", "author": "Jolyon-S", "createdAt": "2020-11-23T13:39:55Z", "path": "lock-api/src/main/java/com/palantir/lock/client/AuthenticatingMultiClientConjureTimelockService.java", "diffHunk": "@@ -0,0 +1,25 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.lock.client;\n+\n+import com.palantir.atlasdb.timelock.api.LeaderTimes;\n+import com.palantir.atlasdb.timelock.api.Namespace;\n+import java.util.Set;\n+\n+public interface AuthenticatingMultiClientConjureTimelockService {", "originalCommit": "2a515e50ca64dc01d8ea5a2bca8f6bb76545aa25", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODc3Mjg2OQ==", "url": "https://github.com/palantir/atlasdb/pull/5122#discussion_r528772869", "bodyText": "I wouldn't name this in this way: users elsewhere in the AtlasDB client code shouldn't need to know that authentication (or the lack thereof!) is a thing that's happening beyond this layer, which is an implementation detail. Conceptually this interface should be something like InternalMultiClientConjureTimelockService (possibly not a great name) and then your AuthMCCTSImpl should be AuthIMCCTS (or even UnauthedIMCCTS).", "author": "jeremyk-91", "createdAt": "2020-11-23T15:10:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODcwOTQ1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODgyMDc3Ng==", "url": "https://github.com/palantir/atlasdb/pull/5122#discussion_r528820776", "bodyText": "I hit a mental block in trying to come up with a name for this interface, InternalMultiClientConjureTimelockService is reasonable.", "author": "sudiksha27", "createdAt": "2020-11-23T16:09:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODcwOTQ1Nw=="}], "type": "inlineReview", "revised_code": {"commit": "4be23f250658d6b42b2374e009db1f235d96e6a3", "chunk": "diff --git a/lock-api/src/main/java/com/palantir/lock/client/AuthenticatingMultiClientConjureTimelockService.java b/lock-api/src/main/java/com/palantir/lock/client/InternalMultiClientConjureTimelockService.java\nsimilarity index 92%\nrename from lock-api/src/main/java/com/palantir/lock/client/AuthenticatingMultiClientConjureTimelockService.java\nrename to lock-api/src/main/java/com/palantir/lock/client/InternalMultiClientConjureTimelockService.java\nindex 784b78c5a3..a76d2513bb 100644\n--- a/lock-api/src/main/java/com/palantir/lock/client/AuthenticatingMultiClientConjureTimelockService.java\n+++ b/lock-api/src/main/java/com/palantir/lock/client/InternalMultiClientConjureTimelockService.java\n\n@@ -20,6 +20,6 @@ import com.palantir.atlasdb.timelock.api.LeaderTimes;\n import com.palantir.atlasdb.timelock.api.Namespace;\n import java.util.Set;\n \n-public interface AuthenticatingMultiClientConjureTimelockService {\n+public interface InternalMultiClientConjureTimelockService {\n     LeaderTimes leaderTimes(Set<Namespace> namespaces);\n }\n"}}, {"oid": "4be23f250658d6b42b2374e009db1f235d96e6a3", "url": "https://github.com/palantir/atlasdb/commit/4be23f250658d6b42b2374e009db1f235d96e6a3", "message": "Refactor", "committedDate": "2020-11-23T15:48:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODgyNDQ3Nw==", "url": "https://github.com/palantir/atlasdb/pull/5122#discussion_r528824477", "bodyText": "nit: sorry for confusion, AuthIMCCTS was just used as a short-hand, I'd prefer we use either Authenticated or Unauthenticated in full rather than Auth, which doesn't say much", "author": "jeremyk-91", "createdAt": "2020-11-23T16:14:14Z", "path": "lock-api/src/main/java/com/palantir/lock/client/AuthInternalMultiClientConjureTimelockService.java", "diffHunk": "@@ -0,0 +1,38 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.lock.client;\n+\n+import com.palantir.atlasdb.timelock.api.LeaderTimes;\n+import com.palantir.atlasdb.timelock.api.MultiClientConjureTimelockServiceBlocking;\n+import com.palantir.atlasdb.timelock.api.Namespace;\n+import com.palantir.tokens.auth.AuthHeader;\n+import java.util.Set;\n+\n+public class AuthInternalMultiClientConjureTimelockService implements InternalMultiClientConjureTimelockService {", "originalCommit": "4be23f250658d6b42b2374e009db1f235d96e6a3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b2ee933c8a123feac4212a161ed2ad7471028e08", "chunk": "diff --git a/lock-api/src/main/java/com/palantir/lock/client/AuthInternalMultiClientConjureTimelockService.java b/lock-api/src/main/java/com/palantir/lock/client/AuthenticatedInternalMultiClientConjureTimelockService.java\nsimilarity index 83%\nrename from lock-api/src/main/java/com/palantir/lock/client/AuthInternalMultiClientConjureTimelockService.java\nrename to lock-api/src/main/java/com/palantir/lock/client/AuthenticatedInternalMultiClientConjureTimelockService.java\nindex 68e338c49e..b27f19f98a 100644\n--- a/lock-api/src/main/java/com/palantir/lock/client/AuthInternalMultiClientConjureTimelockService.java\n+++ b/lock-api/src/main/java/com/palantir/lock/client/AuthenticatedInternalMultiClientConjureTimelockService.java\n\n@@ -22,12 +22,13 @@ import com.palantir.atlasdb.timelock.api.Namespace;\n import com.palantir.tokens.auth.AuthHeader;\n import java.util.Set;\n \n-public class AuthInternalMultiClientConjureTimelockService implements InternalMultiClientConjureTimelockService {\n+public class AuthenticatedInternalMultiClientConjureTimelockService\n+        implements InternalMultiClientConjureTimelockService {\n     private static final AuthHeader AUTH_HEADER = AuthHeader.valueOf(\"Bearer omitted\");\n \n     private final MultiClientConjureTimelockServiceBlocking delegate;\n \n-    public AuthInternalMultiClientConjureTimelockService(MultiClientConjureTimelockServiceBlocking delegate) {\n+    public AuthenticatedInternalMultiClientConjureTimelockService(MultiClientConjureTimelockServiceBlocking delegate) {\n         this.delegate = delegate;\n     }\n \n"}}, {"oid": "b2ee933c8a123feac4212a161ed2ad7471028e08", "url": "https://github.com/palantir/atlasdb/commit/b2ee933c8a123feac4212a161ed2ad7471028e08", "message": "Rename", "committedDate": "2020-11-23T16:18:12Z", "type": "commit"}]}