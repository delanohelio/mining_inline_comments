{"pr_number": 880, "pr_title": "Refactoring with lombok + Throttling", "pr_createdAt": "2020-04-02T22:30:42Z", "pr_url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/880", "timeline": [{"oid": "46b1c1aeb3c8178bc22651ee23367155305c31f3", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/46b1c1aeb3c8178bc22651ee23367155305c31f3", "message": "Refactor commands using lombok", "committedDate": "2020-04-02T20:10:21Z", "type": "commit"}, {"oid": "381e6df3d6f8716783909b052fa96bb49a38008c", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/381e6df3d6f8716783909b052fa96bb49a38008c", "message": "Merge branch 'dev' into shahzaibj/lombok", "committedDate": "2020-04-02T22:27:30Z", "type": "commit"}, {"oid": "3dc442fadc89c169662ac09d2cc33f98f589c0db", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/3dc442fadc89c169662ac09d2cc33f98f589c0db", "message": "Remove nonnull annotations", "committedDate": "2020-04-03T01:00:37Z", "type": "commit"}, {"oid": "cdde397aa3ca9eda9c57ffbabd7783c928ca809b", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/cdde397aa3ca9eda9c57ffbabd7783c928ca809b", "message": "Add expose annotations to command parameters", "committedDate": "2020-04-03T16:11:39Z", "type": "commit"}, {"oid": "ecdd3ddf9c88c93d6301d634721c9c07a2da8346", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/ecdd3ddf9c88c93d6301d634721c9c07a2da8346", "message": "Add transient for command parameters where needed", "committedDate": "2020-04-03T18:36:48Z", "type": "commit"}, {"oid": "25614541a76a04192eadcb3c68bc3ff70492f42e", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/25614541a76a04192eadcb3c68bc3ff70492f42e", "message": "Use lombok as compile time only", "committedDate": "2020-04-03T19:19:21Z", "type": "commit"}, {"oid": "bde1fdd53eca0813c6293c9feb71b1ba0f372fea", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/bde1fdd53eca0813c6293c9feb71b1ba0f372fea", "message": "Remove disabling of lint for invalid package", "committedDate": "2020-04-03T19:28:01Z", "type": "commit"}, {"oid": "15e835962ce41679f422deb20b7ebd3e557d2889", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/15e835962ce41679f422deb20b7ebd3e557d2889", "message": "Remove commented code", "committedDate": "2020-04-03T19:34:59Z", "type": "commit"}, {"oid": "278e5e7661adfb38b804f3519a0a362ed7da3626", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/278e5e7661adfb38b804f3519a0a362ed7da3626", "message": "Add validate logic to silent token command parameters", "committedDate": "2020-04-03T20:49:08Z", "type": "commit"}, {"oid": "2140b1786a32878d3b16cd9e24fa085af601b8a2", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/2140b1786a32878d3b16cd9e24fa085af601b8a2", "message": "Remove operation parameters", "committedDate": "2020-04-03T20:50:17Z", "type": "commit"}, {"oid": "374138f5fc62c73a5ca47dfe87daa8dc829041ff", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/374138f5fc62c73a5ca47dfe87daa8dc829041ff", "message": "Add missing license", "committedDate": "2020-04-03T20:59:13Z", "type": "commit"}, {"oid": "376d3bed8538c95a4306bef07cae52154bf32c8d", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/376d3bed8538c95a4306bef07cae52154bf32c8d", "message": "Remove broker operation parameters, add broker request type enum", "committedDate": "2020-04-03T21:15:37Z", "type": "commit"}, {"oid": "2236ac521fdfee9e49b458d75b42b176ec4c7818", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/2236ac521fdfee9e49b458d75b42b176ec4c7818", "message": "Make parameter collections immutable by returning a clone", "committedDate": "2020-04-06T22:37:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ1Mjg5MA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/880#discussion_r404452890", "bodyText": "Is this import needed?", "author": "shahzaibj", "createdAt": "2020-04-06T23:42:03Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/commands/CommandCallback.java", "diffHunk": "@@ -20,7 +20,9 @@\n //  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n //  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n //  THE SOFTWARE.\n-package com.microsoft.identity.common.internal.controllers;\n+package com.microsoft.identity.common.internal.commands;\n+\n+import com.microsoft.identity.common.internal.controllers.TaskCompletedCallbackWithError;", "originalCommit": "2236ac521fdfee9e49b458d75b42b176ec4c7818", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI1MTk4MQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/880#discussion_r408251981", "bodyText": "Yes, it is needed ofcourse", "author": "shahzaibj", "createdAt": "2020-04-14T15:59:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ1Mjg5MA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ1NTY3Ng==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/880#discussion_r404455676", "bodyText": "Is this needed?", "author": "shahzaibj", "createdAt": "2020-04-06T23:50:35Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/controllers/CommandResultCache.java", "diffHunk": "@@ -24,6 +24,8 @@\n \n import android.util.LruCache;\n \n+import com.microsoft.identity.common.internal.commands.BaseCommand;", "originalCommit": "2236ac521fdfee9e49b458d75b42b176ec4c7818", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI1NDQyMA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/880#discussion_r408254420", "bodyText": "Yes", "author": "shahzaibj", "createdAt": "2020-04-14T16:03:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ1NTY3Ng=="}], "type": "inlineReview", "revised_code": null}, {"oid": "007f6600f682c38ce49270ef7ee5667f37996738", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/007f6600f682c38ce49270ef7ee5667f37996738", "message": "Move extra scopes and extra qp to interactive parameters", "committedDate": "2020-04-06T23:55:39Z", "type": "commit"}, {"oid": "fe4ea2eeba32d7a1cb0131ff7417619345f48cf5", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/fe4ea2eeba32d7a1cb0131ff7417619345f48cf5", "message": "Remove setting extra qp on silent parameters in broker adapters", "committedDate": "2020-04-07T00:37:32Z", "type": "commit"}, {"oid": "f6277dfd1bd79f11fdae7c5a5627c59359e89736", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/f6277dfd1bd79f11fdae7c5a5627c59359e89736", "message": "Add equals and hash code annotation to all commands and parameter classes", "committedDate": "2020-04-10T03:26:32Z", "type": "commit"}, {"oid": "abdcee2c6aec85b43cf5d53ce763a4151efbb494", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/abdcee2c6aec85b43cf5d53ce763a4151efbb494", "message": "Add back throttling to Command Dispatcher", "committedDate": "2020-04-10T03:26:57Z", "type": "commit"}, {"oid": "a8d8895f35a36fd5a9a97a33b1f9b1334dfc6be7", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/a8d8895f35a36fd5a9a97a33b1f9b1334dfc6be7", "message": "Merge branch 'dev' into shahzaibj/lombok", "committedDate": "2020-04-10T03:27:16Z", "type": "commit"}, {"oid": "c0531f18337327232ed930dd864dac62eb5f585c", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/c0531f18337327232ed930dd864dac62eb5f585c", "message": "Add lombok version to version file", "committedDate": "2020-04-14T15:54:14Z", "type": "commit"}, {"oid": "9dee485b6e89755c3d491b7a74a6662306eeb9ec", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/9dee485b6e89755c3d491b7a74a6662306eeb9ec", "message": "Format code", "committedDate": "2020-04-14T16:03:50Z", "type": "commit"}, {"oid": "155e289ccdbd92883bf21cedf709c27f530c5f47", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/155e289ccdbd92883bf21cedf709c27f530c5f47", "message": "Merge branch 'dev' into shahzaibj/lombok", "committedDate": "2020-04-15T18:22:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTMyMTE4NA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/880#discussion_r409321184", "bodyText": "nit: add @ getter and remove getName()?", "author": "rpdome", "createdAt": "2020-04-16T06:52:24Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/authscheme/AbstractAuthenticationScheme.java", "diffHunk": "@@ -26,9 +26,12 @@\n \n import com.google.gson.annotations.SerializedName;\n \n+import lombok.EqualsAndHashCode;\n+\n /**\n  * Abstract base class for AuthenticationSchemes.\n  */\n+@EqualsAndHashCode", "originalCommit": "155e289ccdbd92883bf21cedf709c27f530c5f47", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQxMzE5Mw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/880#discussion_r410413193", "bodyText": "We don't need to - as part of this change I am not removing existing getters and setters. This equals was only added as it was needed and wasn't there.", "author": "shahzaibj", "createdAt": "2020-04-17T18:58:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTMyMTE4NA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTMyMTYyNA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/880#discussion_r409321624", "bodyText": "nit: add extra line above", "author": "rpdome", "createdAt": "2020-04-16T06:53:16Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/commands/Command.java", "diffHunk": "@@ -20,10 +20,15 @@\n //  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n //  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n //  THE SOFTWARE.\n-package com.microsoft.identity.common.internal.controllers;\n+package com.microsoft.identity.common.internal.commands;\n+\n+import com.microsoft.identity.common.internal.controllers.BaseController;\n \n public interface Command<T> {\n     T execute() throws Exception;\n \n     boolean isEligibleForEstsTelemetry();\n+    BaseController getDefaultController();", "originalCommit": "155e289ccdbd92883bf21cedf709c27f530c5f47", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQxMzU5OA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/880#discussion_r410413598", "bodyText": "Addressed", "author": "shahzaibj", "createdAt": "2020-04-17T18:59:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTMyMTYyNA=="}], "type": "inlineReview", "revised_code": {"commit": "f5b9c3811da9c084caba3f2222ae279c139be081", "chunk": "diff --git a/common/src/main/java/com/microsoft/identity/common/internal/commands/Command.java b/common/src/main/java/com/microsoft/identity/common/internal/commands/Command.java\nindex 2c843ce16..974159451 100644\n--- a/common/src/main/java/com/microsoft/identity/common/internal/commands/Command.java\n+++ b/common/src/main/java/com/microsoft/identity/common/internal/commands/Command.java\n\n@@ -28,6 +28,7 @@ public interface Command<T> {\n     T execute() throws Exception;\n \n     boolean isEligibleForEstsTelemetry();\n+\n     BaseController getDefaultController();\n \n     boolean isEligibleForCaching();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTMyNDA0OA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/880#discussion_r409324048", "bodyText": "nit: one param per line for readability.", "author": "rpdome", "createdAt": "2020-04-16T06:58:34Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/commands/GetDeviceModeCommand.java", "diffHunk": "@@ -20,33 +20,35 @@\n //  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n //  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n //  THE SOFTWARE.\n-package com.microsoft.identity.common.internal.controllers;\n+package com.microsoft.identity.common.internal.commands;\n \n import androidx.annotation.NonNull;\n \n-import com.microsoft.identity.common.internal.request.OperationParameters;\n+import com.microsoft.identity.common.internal.commands.parameters.CommandParameters;\n+import com.microsoft.identity.common.internal.controllers.BaseController;\n+\n+import java.util.List;\n+\n+import lombok.EqualsAndHashCode;\n \n /**\n  * Command class to call controllers to remove the account and return the result to\n  * {@see com.microsoft.identity.common.internal.controllers.CommandDispatcher}.\n  */\n+@EqualsAndHashCode(callSuper = true)\n public class GetDeviceModeCommand extends BaseCommand<Boolean> {\n-    private static final String TAG = GetDeviceModeCommand.class.getSimpleName();\n \n-    public GetDeviceModeCommand(@NonNull final OperationParameters parameters,\n-                                @NonNull final BaseController controller,\n-                                @NonNull final CommandCallback callback) {\n-        super(parameters, controller, callback);\n+    public GetDeviceModeCommand(@NonNull CommandParameters parameters, @NonNull BaseController controller, @NonNull CommandCallback callback, @NonNull String publicApiId) {", "originalCommit": "155e289ccdbd92883bf21cedf709c27f530c5f47", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQxMzY1MA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/880#discussion_r410413650", "bodyText": "Addressed", "author": "shahzaibj", "createdAt": "2020-04-17T18:59:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTMyNDA0OA=="}], "type": "inlineReview", "revised_code": {"commit": "f5b9c3811da9c084caba3f2222ae279c139be081", "chunk": "diff --git a/common/src/main/java/com/microsoft/identity/common/internal/commands/GetDeviceModeCommand.java b/common/src/main/java/com/microsoft/identity/common/internal/commands/GetDeviceModeCommand.java\nindex 1ec223fb5..29714b69f 100644\n--- a/common/src/main/java/com/microsoft/identity/common/internal/commands/GetDeviceModeCommand.java\n+++ b/common/src/main/java/com/microsoft/identity/common/internal/commands/GetDeviceModeCommand.java\n\n@@ -38,11 +38,17 @@ import lombok.EqualsAndHashCode;\n @EqualsAndHashCode(callSuper = true)\n public class GetDeviceModeCommand extends BaseCommand<Boolean> {\n \n-    public GetDeviceModeCommand(@NonNull CommandParameters parameters, @NonNull BaseController controller, @NonNull CommandCallback callback, @NonNull String publicApiId) {\n+    public GetDeviceModeCommand(@NonNull CommandParameters parameters,\n+                                @NonNull BaseController controller,\n+                                @NonNull CommandCallback callback,\n+                                @NonNull String publicApiId) {\n         super(parameters, controller, callback, publicApiId);\n     }\n \n-    public GetDeviceModeCommand(@NonNull CommandParameters parameters, @NonNull List<BaseController> controllers, @NonNull CommandCallback callback, @NonNull String publicApiId) {\n+    public GetDeviceModeCommand(@NonNull CommandParameters parameters,\n+                                @NonNull List<BaseController> controllers,\n+                                @NonNull CommandCallback callback,\n+                                @NonNull String publicApiId) {\n         super(parameters, controllers, callback, publicApiId);\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTMzMTE2Mw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/880#discussion_r409331163", "bodyText": "nit: moving file in the middle of the change makes it harder to review IMO. (i.e. git could get drunk like what we're seeing in this file)\nNext time, let's move the files in a separate PR.", "author": "rpdome", "createdAt": "2020-04-16T07:13:50Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/commands/SilentTokenCommand.java", "diffHunk": "@@ -20,7 +20,7 @@\n //  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n //  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n //  THE SOFTWARE.\n-package com.microsoft.identity.common.internal.controllers;\n+package com.microsoft.identity.common.internal.commands;", "originalCommit": "155e289ccdbd92883bf21cedf709c27f530c5f47", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQxMzcxOA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/880#discussion_r410413718", "bodyText": "Sure", "author": "shahzaibj", "createdAt": "2020-04-17T18:59:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTMzMTE2Mw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTM0OTg3NQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/880#discussion_r409349875", "bodyText": "nit: what does this mean? can't find it in the document.", "author": "rpdome", "createdAt": "2020-04-16T07:47:47Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/commands/parameters/InteractiveTokenCommandParameters.java", "diffHunk": "@@ -0,0 +1,85 @@\n+// Copyright (c) Microsoft Corporation.\n+// All rights reserved.\n+//\n+// This code is licensed under the MIT License.\n+//\n+// Permission is hereby granted, free of charge, to any person obtaining a copy\n+// of this software and associated documentation files(the \"Software\"), to deal\n+// in the Software without restriction, including without limitation the rights\n+// to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+// copies of the Software, and to permit persons to whom the Software is\n+// furnished to do so, subject to the following conditions :\n+//\n+// The above copyright notice and this permission notice shall be included in\n+// all copies or substantial portions of the Software.\n+//\n+// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+// THE SOFTWARE.\n+package com.microsoft.identity.common.internal.commands.parameters;\n+\n+import android.app.Activity;\n+import android.util.Pair;\n+\n+import androidx.fragment.app.Fragment;\n+\n+import com.google.gson.annotations.Expose;\n+import com.microsoft.identity.common.internal.providers.oauth2.OpenIdConnectPromptParameter;\n+import com.microsoft.identity.common.internal.ui.AuthorizationAgent;\n+import com.microsoft.identity.common.internal.ui.browser.BrowserDescriptor;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+\n+import lombok.EqualsAndHashCode;\n+import lombok.Getter;\n+import lombok.experimental.SuperBuilder;\n+\n+@Getter\n+@EqualsAndHashCode(callSuper = true)\n+@SuperBuilder(toBuilder = true)\n+public class InteractiveTokenCommandParameters extends TokenCommandParameters {\n+\n+    @EqualsAndHashCode.Exclude\n+    private transient Activity activity;\n+\n+    @EqualsAndHashCode.Exclude\n+    private transient Fragment fragment;\n+\n+    private transient List<BrowserDescriptor> browserSafeList;\n+\n+    private transient HashMap<String, String> requestHeaders;\n+\n+    private boolean brokerBrowserSupportEnabled;\n+\n+    private String loginHint;\n+\n+    @Expose()\n+    private OpenIdConnectPromptParameter prompt;\n+\n+    @Expose()", "originalCommit": "155e289ccdbd92883bf21cedf709c27f530c5f47", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTY1OTQwMQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/880#discussion_r409659401", "bodyText": "Expose is GSON annotation to indicate whether a field should be serialized/deserialized or not. https://www.javadoc.io/doc/com.google.code.gson/gson/2.6.2/com/google/gson/annotations/Expose.html\nIt doesn't have anything to do with Lombok and this annotation was already present in our code.", "author": "shahzaibj", "createdAt": "2020-04-16T15:43:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTM0OTg3NQ=="}], "type": "inlineReview", "revised_code": {"commit": "664d24a10eae1802787251abb567be486837f5d7", "chunk": "diff --git a/common/src/main/java/com/microsoft/identity/common/internal/commands/parameters/InteractiveTokenCommandParameters.java b/common/src/main/java/com/microsoft/identity/common/internal/commands/parameters/InteractiveTokenCommandParameters.java\nindex 57128d29d..f4b654f6f 100644\n--- a/common/src/main/java/com/microsoft/identity/common/internal/commands/parameters/InteractiveTokenCommandParameters.java\n+++ b/common/src/main/java/com/microsoft/identity/common/internal/commands/parameters/InteractiveTokenCommandParameters.java\n\n@@ -82,4 +82,8 @@ public class InteractiveTokenCommandParameters extends TokenCommandParameters {\n     public List<String> getExtraScopesToConsent() {\n         return this.extraScopesToConsent == null ? null : new ArrayList<>(this.extraScopesToConsent);\n     }\n+\n+    public List<BrowserDescriptor> getBrowserSafeList() {\n+        return this.browserSafeList == null ? null : new ArrayList<>(this.browserSafeList);\n+    }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTM1MTU4MQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/880#discussion_r409351581", "bodyText": "nit: are we including the throttling work in this PR also? if yes, the title is sort of misleading.", "author": "rpdome", "createdAt": "2020-04-16T07:50:31Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/controllers/CommandDispatcher.java", "diffHunk": "@@ -79,6 +86,17 @@ public static void submitSilent(@NonNull final BaseCommand command) {\n                 \"Beginning execution of silent command.\"\n         );\n \n+        if (sExecutingCommands.contains(command)) {", "originalCommit": "155e289ccdbd92883bf21cedf709c27f530c5f47", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTY2MTAyNQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/880#discussion_r409661025", "bodyText": "Yes, we are. I've updated the title.", "author": "shahzaibj", "createdAt": "2020-04-16T15:46:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTM1MTU4MQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTM1NDY4NA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/880#discussion_r409354684", "bodyText": "why hardcoded false?", "author": "rpdome", "createdAt": "2020-04-16T07:55:19Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/request/MsalBrokerRequestAdapter.java", "diffHunk": "@@ -99,9 +106,9 @@ public BrokerRequest brokerRequestFromAcquireTokenParameters(@NonNull final Acqu\n                         parameters.getExtraQueryStringParameters() != null ?\n                                 QueryParamsAdapter._toJson(parameters.getExtraQueryStringParameters())\n                                 : null\n-                ).prompt(parameters.getOpenIdConnectPromptParameter().name())\n+                ).prompt(parameters.getPrompt().name())\n                 .claims(parameters.getClaimsRequestJson())\n-                .forceRefresh(parameters.getForceRefresh())\n+                .forceRefresh(false)", "originalCommit": "155e289ccdbd92883bf21cedf709c27f530c5f47", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTY2MjE1NQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/880#discussion_r409662155", "bodyText": "Interactive doesn't have anything like forceRefresh", "author": "shahzaibj", "createdAt": "2020-04-16T15:47:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTM1NDY4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU2MzAzMQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/880#discussion_r411563031", "bodyText": "This would break claimsRequest flow. Before this change , forceRefresh was on OperationParameter here  and we set forceRefresh to true for interactive calls when claimsRequest is present here . This is done because, in broker we would attempt to silently get a token for interactive calls as well if we a matching account using PRT, FRT, and if claimsRequest is present we would need to skip cache and refresh the token.\nSo i think you should move back forceRefresh to base class and add the logic back", "author": "kreedula", "createdAt": "2020-04-20T17:34:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTM1NDY4NA=="}], "type": "inlineReview", "revised_code": {"commit": "d5674111b5f49ff0701ffdc437b0baed90848cb5", "chunk": "diff --git a/common/src/main/java/com/microsoft/identity/common/internal/request/MsalBrokerRequestAdapter.java b/common/src/main/java/com/microsoft/identity/common/internal/request/MsalBrokerRequestAdapter.java\nindex 716d10f66..883e5e484 100644\n--- a/common/src/main/java/com/microsoft/identity/common/internal/request/MsalBrokerRequestAdapter.java\n+++ b/common/src/main/java/com/microsoft/identity/common/internal/request/MsalBrokerRequestAdapter.java\n\n@@ -108,7 +108,7 @@ public class MsalBrokerRequestAdapter implements IBrokerRequestAdapter {\n                                 : null\n                 ).prompt(parameters.getPrompt().name())\n                 .claims(parameters.getClaimsRequestJson())\n-                .forceRefresh(false)\n+                .forceRefresh(parameters.isForceRefresh())\n                 .correlationId(DiagnosticContext.getRequestContext().get(DiagnosticContext.CORRELATION_ID))\n                 .applicationName(parameters.getApplicationName())\n                 .applicationVersion(parameters.getApplicationVersion())\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTM1NTAyNw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/880#discussion_r409355027", "bodyText": "slow clap \ud83d\udc4f", "author": "rpdome", "createdAt": "2020-04-16T07:55:50Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/request/MsalBrokerRequestAdapter.java", "diffHunk": "@@ -210,42 +200,47 @@ public BrokerAcquireTokenOperationParameters brokerInteractiveParametersFromActi\n \n         if (authority != null) {\n             authority.setMultipleCloudsSupported(brokerRequest.getMultipleCloudsSupported());\n-            parameters.setAuthority(authority);\n         }\n \n-        parameters.setScopes(getScopesAsSet(brokerRequest.getScope()));\n-\n-        parameters.setClientId(brokerRequest.getClientId());\n-\n-        parameters.setRedirectUri(brokerRequest.getRedirect());\n-\n-        parameters.setLoginHint(brokerRequest.getUserName());\n-\n         String correlationIdString = brokerRequest.getCorrelationId();\n \n         if (TextUtils.isEmpty(correlationIdString)) {\n             UUID correlationId = UUID.randomUUID();\n             correlationIdString = correlationId.toString();\n         }\n-        parameters.setCorrelationId(correlationIdString);\n \n-        parameters.setClaimsRequest(brokerRequest.getClaims());\n+        Logger.info(TAG, \"Authorization agent passed in by MSAL: \" + brokerRequest.getAuthorizationAgent());", "originalCommit": "155e289ccdbd92883bf21cedf709c27f530c5f47", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f5b9c3811da9c084caba3f2222ae279c139be081", "chunk": "diff --git a/common/src/main/java/com/microsoft/identity/common/internal/request/MsalBrokerRequestAdapter.java b/common/src/main/java/com/microsoft/identity/common/internal/request/MsalBrokerRequestAdapter.java\nindex 716d10f66..812c7b10e 100644\n--- a/common/src/main/java/com/microsoft/identity/common/internal/request/MsalBrokerRequestAdapter.java\n+++ b/common/src/main/java/com/microsoft/identity/common/internal/request/MsalBrokerRequestAdapter.java\n\n@@ -236,9 +236,10 @@ public class MsalBrokerRequestAdapter implements IBrokerRequestAdapter {\n                 && brokerRequest.getAuthorizationAgent().equalsIgnoreCase(AuthorizationAgent.BROWSER.name())\n                 && isCallingPackageIntune(brokerRequest.getApplicationName())) { // TODO : Remove this whenever we enable System Browser support in Broker for apps.\n             Logger.info(TAG, \"Setting Authorization Agent to Browser for Intune app\");\n-            commandParametersBuilder.authorizationAgent(AuthorizationAgent.BROWSER);\n-            commandParametersBuilder.brokerBrowserSupportEnabled(true);\n-            commandParametersBuilder.browserSafeList(getBrowserSafeListForBroker());\n+            commandParametersBuilder\n+                    .authorizationAgent(AuthorizationAgent.BROWSER)\n+                    .brokerBrowserSupportEnabled(true)\n+                    .browserSafeList(getBrowserSafeListForBroker());\n         } else {\n             commandParametersBuilder.authorizationAgent(AuthorizationAgent.WEBVIEW);\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTM1NTY1Ng==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/880#discussion_r409355656", "bodyText": "nit: can we do nested method calling here?", "author": "rpdome", "createdAt": "2020-04-16T07:56:52Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/request/MsalBrokerRequestAdapter.java", "diffHunk": "@@ -210,42 +200,47 @@ public BrokerAcquireTokenOperationParameters brokerInteractiveParametersFromActi\n \n         if (authority != null) {\n             authority.setMultipleCloudsSupported(brokerRequest.getMultipleCloudsSupported());\n-            parameters.setAuthority(authority);\n         }\n \n-        parameters.setScopes(getScopesAsSet(brokerRequest.getScope()));\n-\n-        parameters.setClientId(brokerRequest.getClientId());\n-\n-        parameters.setRedirectUri(brokerRequest.getRedirect());\n-\n-        parameters.setLoginHint(brokerRequest.getUserName());\n-\n         String correlationIdString = brokerRequest.getCorrelationId();\n \n         if (TextUtils.isEmpty(correlationIdString)) {\n             UUID correlationId = UUID.randomUUID();\n             correlationIdString = correlationId.toString();\n         }\n-        parameters.setCorrelationId(correlationIdString);\n \n-        parameters.setClaimsRequest(brokerRequest.getClaims());\n+        Logger.info(TAG, \"Authorization agent passed in by MSAL: \" + brokerRequest.getAuthorizationAgent());\n \n-        parameters.setOpenIdConnectPromptParameter(\n-                brokerRequest.getPrompt() != null ?\n+        final BrokerInteractiveTokenCommandParameters.BrokerInteractiveTokenCommandParametersBuilder\n+                commandParametersBuilder = BrokerInteractiveTokenCommandParameters.builder()\n+                .authenticationScheme(getAuthenticationScheme(callingActivity, brokerRequest))\n+                .activity(callingActivity)\n+                .androidApplicationContext(callingActivity.getApplicationContext())\n+                .sdkType(SdkType.MSAL)\n+                .callerUid(callingAppUid)\n+                .callerPackageName(brokerRequest.getApplicationName())\n+                .callerAppVersion(brokerRequest.getApplicationVersion())\n+                .extraQueryStringParameters(extraQP)\n+                .authority(authority)\n+                .scopes(getScopesAsSet(brokerRequest.getScope()))\n+                .clientId(brokerRequest.getClientId())\n+                .redirectUri(brokerRequest.getRedirect())\n+                .loginHint(brokerRequest.getUserName())\n+                .correlationId(correlationIdString)\n+                .claimsRequestJson(brokerRequest.getClaims())\n+                .prompt(brokerRequest.getPrompt() != null ?\n                         OpenIdConnectPromptParameter.valueOf(brokerRequest.getPrompt()) :\n-                        OpenIdConnectPromptParameter.NONE\n-        );\n-        Logger.info(TAG, \"Authorization agent passed in by MSAL: \" + brokerRequest.getAuthorizationAgent());\n+                        OpenIdConnectPromptParameter.NONE);\n+\n         if (brokerRequest.getAuthorizationAgent() != null\n                 && brokerRequest.getAuthorizationAgent().equalsIgnoreCase(AuthorizationAgent.BROWSER.name())\n-                && isCallingPackageIntune(parameters.getCallerPackageName())) { // TODO : Remove this whenever we enable System Browser support in Broker for apps.\n+                && isCallingPackageIntune(brokerRequest.getApplicationName())) { // TODO : Remove this whenever we enable System Browser support in Broker for apps.\n             Logger.info(TAG, \"Setting Authorization Agent to Browser for Intune app\");\n-            parameters.setAuthorizationAgent(AuthorizationAgent.BROWSER);\n-            parameters.setBrokerBrowserSupportEnabled(true);\n-            parameters.setBrowserSafeList(getBrowserSafeListForBroker());\n+            commandParametersBuilder.authorizationAgent(AuthorizationAgent.BROWSER);\n+            commandParametersBuilder.brokerBrowserSupportEnabled(true);", "originalCommit": "155e289ccdbd92883bf21cedf709c27f530c5f47", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQxMzc4NQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/880#discussion_r410413785", "bodyText": "Addressed", "author": "shahzaibj", "createdAt": "2020-04-17T18:59:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTM1NTY1Ng=="}], "type": "inlineReview", "revised_code": {"commit": "f5b9c3811da9c084caba3f2222ae279c139be081", "chunk": "diff --git a/common/src/main/java/com/microsoft/identity/common/internal/request/MsalBrokerRequestAdapter.java b/common/src/main/java/com/microsoft/identity/common/internal/request/MsalBrokerRequestAdapter.java\nindex 716d10f66..812c7b10e 100644\n--- a/common/src/main/java/com/microsoft/identity/common/internal/request/MsalBrokerRequestAdapter.java\n+++ b/common/src/main/java/com/microsoft/identity/common/internal/request/MsalBrokerRequestAdapter.java\n\n@@ -236,9 +236,10 @@ public class MsalBrokerRequestAdapter implements IBrokerRequestAdapter {\n                 && brokerRequest.getAuthorizationAgent().equalsIgnoreCase(AuthorizationAgent.BROWSER.name())\n                 && isCallingPackageIntune(brokerRequest.getApplicationName())) { // TODO : Remove this whenever we enable System Browser support in Broker for apps.\n             Logger.info(TAG, \"Setting Authorization Agent to Browser for Intune app\");\n-            commandParametersBuilder.authorizationAgent(AuthorizationAgent.BROWSER);\n-            commandParametersBuilder.brokerBrowserSupportEnabled(true);\n-            commandParametersBuilder.browserSafeList(getBrowserSafeListForBroker());\n+            commandParametersBuilder\n+                    .authorizationAgent(AuthorizationAgent.BROWSER)\n+                    .brokerBrowserSupportEnabled(true)\n+                    .browserSafeList(getBrowserSafeListForBroker());\n         } else {\n             commandParametersBuilder.authorizationAgent(AuthorizationAgent.WEBVIEW);\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTM1NjI5Nw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/880#discussion_r409356297", "bodyText": "why removing this?", "author": "rpdome", "createdAt": "2020-04-16T07:57:49Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/request/MsalBrokerRequestAdapter.java", "diffHunk": "@@ -304,40 +280,35 @@ public BrokerAcquireTokenSilentOperationParameters brokerSilentParametersFromBun\n             );\n         }\n \n-        parameters.setAuthority(authority);\n-\n         String correlationIdString = bundle.getString(\n                 brokerRequest.getCorrelationId()\n         );\n         if (TextUtils.isEmpty(correlationIdString)) {\n             UUID correlationId = UUID.randomUUID();\n             correlationIdString = correlationId.toString();\n         }\n-        parameters.setCorrelationId(correlationIdString);\n-\n-        parameters.setScopes(\n-                getScopesAsSet(brokerRequest.getScope())\n-        );\n-\n-        parameters.setRedirectUri(brokerRequest.getRedirect());\n \n-        parameters.setClientId(brokerRequest.getClientId());\n-\n-        parameters.setForceRefresh(brokerRequest.getForceRefresh());\n-\n-        parameters.setClaimsRequest(brokerRequest.getClaims());\n-\n-        parameters.setLoginHint(brokerRequest.getUserName());\n-\n-        parameters.setHomeAccountId(brokerRequest.getHomeAccountId());\n-\n-        parameters.setLocalAccountId(brokerRequest.getLocalAccountId());\n+        final BrokerSilentTokenCommandParameters commandParameters = BrokerSilentTokenCommandParameters\n+                .builder()\n+                .authenticationScheme(getAuthenticationScheme(context, brokerRequest))\n+                .androidApplicationContext(context)\n+                .accountManagerAccount(account)\n+                .sdkType(SdkType.MSAL)\n+                .callerUid(callingAppUid)\n+                .callerPackageName(brokerRequest.getApplicationName())\n+                .callerAppVersion(brokerRequest.getApplicationVersion())\n+                .authority(authority)\n+                .correlationId(correlationIdString)\n+                .scopes(getScopesAsSet(brokerRequest.getScope()))\n+                .redirectUri(brokerRequest.getRedirect())\n+                .clientId(brokerRequest.getClientId())\n+                .forceRefresh(brokerRequest.getForceRefresh())\n+                .claimsRequestJson(brokerRequest.getClaims())\n+                .loginHint(brokerRequest.getUserName())\n+                .homeAccountId(brokerRequest.getHomeAccountId())\n+                .localAccountId(brokerRequest.getLocalAccountId())\n+                .build();\n \n-        if (!TextUtils.isEmpty(brokerRequest.getExtraQueryStringParameter())) {", "originalCommit": "155e289ccdbd92883bf21cedf709c27f530c5f47", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTY2NDQyNg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/880#discussion_r409664426", "bodyText": "Extra Query parameters are not used for silent token commands and have been removed from silent parameters therefore.", "author": "shahzaibj", "createdAt": "2020-04-16T15:50:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTM1NjI5Nw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTY1OTkwNg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/880#discussion_r409659906", "bodyText": "Need immutable getter for this collection too", "author": "shahzaibj", "createdAt": "2020-04-16T15:44:31Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/commands/parameters/RemoveAccountCommandParameters.java", "diffHunk": "@@ -0,0 +1,41 @@\n+// Copyright (c) Microsoft Corporation.\n+// All rights reserved.\n+//\n+// This code is licensed under the MIT License.\n+//\n+// Permission is hereby granted, free of charge, to any person obtaining a copy\n+// of this software and associated documentation files(the \"Software\"), to deal\n+// in the Software without restriction, including without limitation the rights\n+// to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+// copies of the Software, and to permit persons to whom the Software is\n+// furnished to do so, subject to the following conditions :\n+//\n+// The above copyright notice and this permission notice shall be included in\n+// all copies or substantial portions of the Software.\n+//\n+// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+// THE SOFTWARE.\n+package com.microsoft.identity.common.internal.commands.parameters;\n+\n+import com.microsoft.identity.common.internal.dto.IAccountRecord;\n+import com.microsoft.identity.common.internal.ui.browser.BrowserDescriptor;\n+\n+import java.util.List;\n+\n+import lombok.EqualsAndHashCode;\n+import lombok.Getter;\n+import lombok.experimental.SuperBuilder;\n+\n+@Getter\n+@SuperBuilder(toBuilder = true)\n+@EqualsAndHashCode(callSuper = true)\n+public class RemoveAccountCommandParameters extends CommandParameters {\n+\n+    private IAccountRecord account;\n+    private List<BrowserDescriptor> browserSafeList;", "originalCommit": "155e289ccdbd92883bf21cedf709c27f530c5f47", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQxNjU5OA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/880#discussion_r410416598", "bodyText": "Addressed", "author": "shahzaibj", "createdAt": "2020-04-17T19:06:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTY1OTkwNg=="}], "type": "inlineReview", "revised_code": {"commit": "664d24a10eae1802787251abb567be486837f5d7", "chunk": "diff --git a/common/src/main/java/com/microsoft/identity/common/internal/commands/parameters/RemoveAccountCommandParameters.java b/common/src/main/java/com/microsoft/identity/common/internal/commands/parameters/RemoveAccountCommandParameters.java\nindex fc3df3d68..b959ebec7 100644\n--- a/common/src/main/java/com/microsoft/identity/common/internal/commands/parameters/RemoveAccountCommandParameters.java\n+++ b/common/src/main/java/com/microsoft/identity/common/internal/commands/parameters/RemoveAccountCommandParameters.java\n\n@@ -25,6 +25,7 @@ package com.microsoft.identity.common.internal.commands.parameters;\n import com.microsoft.identity.common.internal.dto.IAccountRecord;\n import com.microsoft.identity.common.internal.ui.browser.BrowserDescriptor;\n \n+import java.util.ArrayList;\n import java.util.List;\n \n import lombok.EqualsAndHashCode;\n"}}, {"oid": "6848a9e41b6a2cfb9972aa82f605035f8cc30aa4", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/6848a9e41b6a2cfb9972aa82f605035f8cc30aa4", "message": "Merge branch 'dev' into shahzaibj/lombok", "committedDate": "2020-04-17T18:44:19Z", "type": "commit"}, {"oid": "f5b9c3811da9c084caba3f2222ae279c139be081", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/f5b9c3811da9c084caba3f2222ae279c139be081", "message": "Address comments", "committedDate": "2020-04-17T18:59:00Z", "type": "commit"}, {"oid": "664d24a10eae1802787251abb567be486837f5d7", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/664d24a10eae1802787251abb567be486837f5d7", "message": "Add clone getter for browser safe list", "committedDate": "2020-04-17T19:05:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU0ODA2NQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/880#discussion_r411548065", "bodyText": "Why this class , if we don't have any additional properties associated with it?", "author": "kreedula", "createdAt": "2020-04-20T17:11:30Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/commands/TokenCommand.java", "diffHunk": "@@ -0,0 +1,55 @@\n+// Copyright (c) Microsoft Corporation.\n+// All rights reserved.\n+//\n+// This code is licensed under the MIT License.\n+//\n+// Permission is hereby granted, free of charge, to any person obtaining a copy\n+// of this software and associated documentation files(the \"Software\"), to deal\n+// in the Software without restriction, including without limitation the rights\n+// to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+// copies of the Software, and to permit persons to whom the Software is\n+// furnished to do so, subject to the following conditions :\n+//\n+// The above copyright notice and this permission notice shall be included in\n+// all copies or substantial portions of the Software.\n+//\n+// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+// THE SOFTWARE.\n+package com.microsoft.identity.common.internal.commands;\n+\n+import android.content.Intent;\n+\n+import androidx.annotation.NonNull;\n+\n+import com.microsoft.identity.common.internal.commands.parameters.TokenCommandParameters;\n+import com.microsoft.identity.common.internal.controllers.BaseController;\n+import com.microsoft.identity.common.internal.result.AcquireTokenResult;\n+\n+import java.util.List;\n+\n+import lombok.EqualsAndHashCode;\n+\n+@EqualsAndHashCode(callSuper = true)\n+public abstract class TokenCommand extends BaseCommand<AcquireTokenResult> {", "originalCommit": "664d24a10eae1802787251abb567be486837f5d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU3MzYxMA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/880#discussion_r411573610", "bodyText": "It has an abstract method, and primarily meant as a base abstract command for any type of Token Command. Other token commands can just extend this.", "author": "shahzaibj", "createdAt": "2020-04-20T17:50:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU0ODA2NQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU2NzM5Mw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/880#discussion_r411567393", "bodyText": "This would break claimsRequest flow. Before this change , forceRefresh was on OperationParameter here  and we set forceRefresh to true for interactive calls when claimsRequest is present here . This is done because, in broker we would attempt to silently get a token for interactive calls as well if we a matching account using PRT, FRT, and if claimsRequest is present we would need to skip cache and refresh the token.\nSo i think you should move back forceRefresh to base class and add the logic back", "author": "kreedula", "createdAt": "2020-04-20T17:40:57Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/request/MsalBrokerRequestAdapter.java", "diffHunk": "@@ -99,9 +106,9 @@ public BrokerRequest brokerRequestFromAcquireTokenParameters(@NonNull final Acqu\n                         parameters.getExtraQueryStringParameters() != null ?\n                                 QueryParamsAdapter._toJson(parameters.getExtraQueryStringParameters())\n                                 : null\n-                ).prompt(parameters.getOpenIdConnectPromptParameter().name())\n+                ).prompt(parameters.getPrompt().name())\n                 .claims(parameters.getClaimsRequestJson())\n-                .forceRefresh(parameters.getForceRefresh())\n+                .forceRefresh(false)", "originalCommit": "664d24a10eae1802787251abb567be486837f5d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU2ODk2MA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/880#discussion_r411568960", "bodyText": "@kreedula forceRefresh was indeed set on base class operation parameters but I believe it was never used in any interactive flow and hence I removed it and put it only on silent. Can you share the code snippet where this value is actually being used during an interactive call?", "author": "shahzaibj", "createdAt": "2020-04-20T17:43:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU2NzM5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU3NTIxNw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/880#discussion_r411575217", "bodyText": "Okay, I see so it seems it was never used on the OperationParameters but we need it on the BrokerRequest object to decide if we need to skip cache or not.", "author": "shahzaibj", "createdAt": "2020-04-20T17:52:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU2NzM5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU3NjQ4Mg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/880#discussion_r411576482", "bodyText": "@kreedula I don't think I need to put them on base command parameter class in that case. I think I can just do this logic here at the adapter level and set the value of forceRefresh on BrokerRequest based on that.", "author": "shahzaibj", "createdAt": "2020-04-20T17:54:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU2NzM5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU5MDI5MA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/880#discussion_r411590290", "bodyText": "It should work with the current implementation, as we unpack the BrokerRequest twice , once here   and the other one to convert to BrokerAcquireTokenParameters. I would like to make some changes to avoid unpacking BrokerRequest twice especially with compressed payloads, have a work item for it. So it should be on TokenCommandParameters so that when we transform BrokerRequest to BrokerAcquireTokenCommandParameters , we would have the value to set and get", "author": "kreedula", "createdAt": "2020-04-20T18:16:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU2NzM5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTYwNTM5MA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/880#discussion_r411605390", "bodyText": "@kreedula That doesn't make sense to me. All you need is for forceRefresh to be available on BrokerRequest regardless of how many times we unpack it. Why do you need it on TokenCommandParameters? When we skip cache in broker, then we create silent token command parameters and not interactive so you shouldn't need it to be on either interactive parameters or the base class. Would there be a case where we would need forceRefresh to live on interactive parameters? Am i missing something here?", "author": "shahzaibj", "createdAt": "2020-04-20T18:41:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU2NzM5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTYyMjU3NQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/880#discussion_r411622575", "bodyText": "let's chat offline, so we can resolve this faster", "author": "kreedula", "createdAt": "2020-04-20T19:09:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU2NzM5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTYzMzczMQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/880#discussion_r411633731", "bodyText": "Resolved offline, consensus is to forceRefresh to BrokerRequest based on claimsRequest  and leave it out of TokenCommandParameters", "author": "kreedula", "createdAt": "2020-04-20T19:28:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU2NzM5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTY2NDI4Ng==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/880#discussion_r411664286", "bodyText": "Per second discussion decided to go with @kreedula suggestion to put force refresh on base token command parameters as we would need to send it to broker request based on the value of Claims Request passed in by the developer and not the merged claims request as that could contain client capabilities.\nAddressed it in common here: d567411\nMSAL here: AzureAD/microsoft-authentication-library-for-android@69984b2\nAdded back tests here: AzureAD/microsoft-authentication-library-for-android@13a7dae", "author": "shahzaibj", "createdAt": "2020-04-20T20:19:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU2NzM5Mw=="}], "type": "inlineReview", "revised_code": {"commit": "d5674111b5f49ff0701ffdc437b0baed90848cb5", "chunk": "diff --git a/common/src/main/java/com/microsoft/identity/common/internal/request/MsalBrokerRequestAdapter.java b/common/src/main/java/com/microsoft/identity/common/internal/request/MsalBrokerRequestAdapter.java\nindex 812c7b10e..883e5e484 100644\n--- a/common/src/main/java/com/microsoft/identity/common/internal/request/MsalBrokerRequestAdapter.java\n+++ b/common/src/main/java/com/microsoft/identity/common/internal/request/MsalBrokerRequestAdapter.java\n\n@@ -108,7 +108,7 @@ public class MsalBrokerRequestAdapter implements IBrokerRequestAdapter {\n                                 : null\n                 ).prompt(parameters.getPrompt().name())\n                 .claims(parameters.getClaimsRequestJson())\n-                .forceRefresh(false)\n+                .forceRefresh(parameters.isForceRefresh())\n                 .correlationId(DiagnosticContext.getRequestContext().get(DiagnosticContext.CORRELATION_ID))\n                 .applicationName(parameters.getApplicationName())\n                 .applicationVersion(parameters.getApplicationVersion())\n"}}, {"oid": "d5674111b5f49ff0701ffdc437b0baed90848cb5", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/d5674111b5f49ff0701ffdc437b0baed90848cb5", "message": "Put force refresh on base token command parameters", "committedDate": "2020-04-20T20:05:36Z", "type": "commit"}]}