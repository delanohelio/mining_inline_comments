{"pr_number": 794, "pr_title": "Resolves #793 - Fix for Token Caching", "pr_createdAt": "2020-01-29T00:02:32Z", "pr_url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/794", "timeline": [{"oid": "d8da04b02b153d7ff1e78d1839a49d4ffe91a197", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/d8da04b02b153d7ff1e78d1839a49d4ffe91a197", "message": "Re: #793\n\nDo not artificially inject default scopes in cache", "committedDate": "2020-01-28T22:53:28Z", "type": "commit"}, {"oid": "7dbb34b2ce4266fab60433c3f140148f53b6d28e", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/7dbb34b2ce4266fab60433c3f140148f53b6d28e", "message": "Removing no longer needed comment", "committedDate": "2020-01-28T23:09:39Z", "type": "commit"}, {"oid": "89fefb9222e410aba77afe85d574a9119025e135", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/89fefb9222e410aba77afe85d574a9119025e135", "message": "RE: #793 - Omit DEFAULT_SCOPES from token lookup, only udont inject defaults to cache", "committedDate": "2020-01-28T23:59:44Z", "type": "commit"}, {"oid": "44b3452a130e64f26fbc5071f41249e77a84c1a8", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/44b3452a130e64f26fbc5071f41249e77a84c1a8", "message": "Minor formatting", "committedDate": "2020-01-29T00:38:50Z", "type": "commit"}, {"oid": "40a81894613239fe6334dcab21b0cffa438588d9", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/40a81894613239fe6334dcab21b0cffa438588d9", "message": "Update for behavior doc'd in RFC-6749", "committedDate": "2020-01-29T00:53:07Z", "type": "commit"}, {"oid": "a85a0ea57678202caa705568ee5eaae6da69e6dd", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/a85a0ea57678202caa705568ee5eaae6da69e6dd", "message": "Merge branch 'dev' into iambmelt/793", "committedDate": "2020-02-05T23:20:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTU3MzczOQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/794#discussion_r375573739", "bodyText": "nit: should we even expose this boolean? (as we always use 'true' as its value)", "author": "rpdome", "createdAt": "2020-02-05T23:52:55Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/cache/AbstractAccountCredentialCache.java", "diffHunk": "@@ -210,13 +212,16 @@\n     /**\n      * Examines the intersections of the provided targets (scopes).\n      *\n-     * @param targetToMatch    The target value[s] our cache-query is looking for.\n-     * @param credentialTarget The target against which our sought value will be compared.\n+     * @param targetToMatch     The target value[s] our cache-query is looking for.\n+     * @param credentialTarget  The target against which our sought value will be compared.\n+     * @param omitDefaultScopes True if MSAL's default scopes should be considered in this lookup.\n+     *                          False otherwise.\n      * @return True, if the credentialTarget contains all of the targets (scopes) declared by\n      * targetToMatch. False otherwise.\n      */\n     static boolean targetsIntersect(@NonNull final String targetToMatch,\n-                                    @NonNull final String credentialTarget) {\n+                                    @NonNull final String credentialTarget,\n+                                    boolean omitDefaultScopes) {", "originalCommit": "a85a0ea57678202caa705568ee5eaae6da69e6dd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTYzMzA0MQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/794#discussion_r375633041", "bodyText": "I think it would be good to have in case if a child implementation of AbstractAccountCredentialCache wishes to override it in the future", "author": "shahzaibj", "createdAt": "2020-02-06T04:14:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTU3MzczOQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTYzMzQyNQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/794#discussion_r375633425", "bodyText": "I think it would be better to use a StringBuilder here as the size of the scope set isn't known and could be big", "author": "shahzaibj", "createdAt": "2020-02-06T04:17:12Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/cache/MicrosoftStsAccountCredentialAdapter.java", "diffHunk": "@@ -129,18 +130,27 @@ private String getCredentialType(@NonNull final String tokenType) {\n      * @param responseScope The response scope to parse.\n      * @return The target containing default scopes.\n      */\n-    private String getTarget(@NonNull final String responseScope) {\n-        if (responseScope.contains(AuthenticationConstants.OAuth2Scopes.OPEN_ID_SCOPE)) {\n-            if (responseScope.contains(AuthenticationConstants.OAuth2Scopes.OFFLINE_ACCESS_SCOPE)) {\n-                return responseScope;\n-            } else {\n-                return responseScope + \" \" + AuthenticationConstants.OAuth2Scopes.OFFLINE_ACCESS_SCOPE;\n+    private String getTarget(@NonNull final String requestScope,\n+                             @NonNull final String responseScope) {\n+        String scopesToCache = \"\";\n+\n+        if (TextUtils.isEmpty(responseScope)) {\n+            // The response scopes were empty -- per https://tools.ietf.org/html/rfc6749#section-3.3\n+            // we are going to fall back to a the request scopes minus any default scopes....\n+            final String[] requestScopes = requestScope.split(\"\\\\s+\");\n+            final Set<String> requestScopeSet = new HashSet<>(Arrays.asList(requestScopes));\n+            requestScopeSet.removeAll(DEFAULT_SCOPES);\n+\n+            for (final String scope : requestScopeSet) {\n+                scopesToCache += scope + \" \";", "originalCommit": "a85a0ea57678202caa705568ee5eaae6da69e6dd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjAyMDIwMA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/794#discussion_r376020200", "bodyText": "The perf of + and StringBuilder is fairly comparable due to compiler optimizations. Given that StringBuilder hurts readability IMO, I'm going to leave as is.", "author": "iambmelt", "createdAt": "2020-02-06T18:56:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTYzMzQyNQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "2d9c503b787e02def3664f8e583ab834c18e7ba3", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/2d9c503b787e02def3664f8e583ab834c18e7ba3", "message": "Merge branch 'dev' into iambmelt/793", "committedDate": "2020-02-06T18:07:50Z", "type": "commit"}]}