{"pr_number": 992, "pr_title": "Add app-name and app-ver headers to /auth and /token requests", "pr_createdAt": "2020-08-07T03:25:44Z", "pr_url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/992", "timeline": [{"oid": "7addb4942cff06e06606ecf1c7a9d24445756fcb", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/7addb4942cff06e06606ecf1c7a9d24445756fcb", "message": "Add app-name and app-ver headers to /auth and /token requests", "committedDate": "2020-08-07T03:15:53Z", "type": "commit"}, {"oid": "b752017df98ea579a73fa9703631c71a843ba112", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/b752017df98ea579a73fa9703631c71a843ba112", "message": "Merge branch 'dev' into shahzaibj/app-name-and-version", "committedDate": "2020-08-07T17:21:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE4NzExOQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/992#discussion_r467187119", "bodyText": "This is super-trivial, but we can save some allocations on the map resize if we size it to start with or use the Map/Map constructor to handle this trivially.", "author": "AdamBJohnsonx", "createdAt": "2020-08-07T17:55:17Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/controllers/BaseController.java", "diffHunk": "@@ -188,6 +189,18 @@ public abstract AcquireTokenResult acquireDeviceCodeFlowToken(final Authorizatio\n                 scopes.addAll(interactiveTokenCommandParameters.getExtraScopesToConsent());\n             }\n \n+            final HashMap<String, String> completeRequestHeaders = new HashMap<>();\n+\n+            if (interactiveTokenCommandParameters.getRequestHeaders() != null) {\n+                completeRequestHeaders.putAll(interactiveTokenCommandParameters.getRequestHeaders());", "originalCommit": "b752017df98ea579a73fa9703631c71a843ba112", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzIyNTA0NA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/992#discussion_r467225044", "bodyText": "Yeah, I'll keep as is for now to avoid branched logic for creating hashmap. because this could be null", "author": "shahzaibj", "createdAt": "2020-08-07T19:17:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE4NzExOQ=="}], "type": "inlineReview", "revised_code": {"commit": "c2c7d53ab58ee5f05a4008301941df9f2e37d53b", "chunk": "diff --git a/common/src/main/java/com/microsoft/identity/common/internal/controllers/BaseController.java b/common/src/main/java/com/microsoft/identity/common/internal/controllers/BaseController.java\nindex b40f2551d..471dfcfa2 100644\n--- a/common/src/main/java/com/microsoft/identity/common/internal/controllers/BaseController.java\n+++ b/common/src/main/java/com/microsoft/identity/common/internal/controllers/BaseController.java\n\n@@ -195,11 +195,13 @@ public abstract class BaseController {\n                 completeRequestHeaders.putAll(interactiveTokenCommandParameters.getRequestHeaders());\n             }\n \n-            final String appName = parameters.getApplicationName();\n-            final String appVer = parameters.getApplicationVersion();\n-\n-            completeRequestHeaders.put(AuthenticationConstants.AAD.APP_PACKAGE_NAME, appName);\n-            completeRequestHeaders.put(AuthenticationConstants.AAD.APP_VERSION, appVer);\n+            completeRequestHeaders.put(\n+                    AuthenticationConstants.AAD.APP_PACKAGE_NAME,\n+                    parameters.getApplicationName()\n+            );\n+            completeRequestHeaders.put(AuthenticationConstants.AAD.APP_VERSION,\n+                    parameters.getApplicationVersion()\n+            );\n \n             // Add additional fields to the AuthorizationRequest.Builder to support interactive\n             builder.setLoginHint(\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE4NzUyNA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/992#discussion_r467187524", "bodyText": "nit: Do we need these variables?", "author": "AdamBJohnsonx", "createdAt": "2020-08-07T17:56:07Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/providers/microsoft/microsoftsts/MicrosoftStsOAuth2Strategy.java", "diffHunk": "@@ -469,6 +470,12 @@ private HttpResponse performPKeyAuthRequest(\n         headers.put(\"client-request-id\", DiagnosticContext.getRequestContext().get(DiagnosticContext.CORRELATION_ID));\n         headers.putAll(Device.getPlatformIdParameters());\n \n+        final String appName = request.getClientAppName();\n+        final String appVer = request.getClientAppVersion();", "originalCommit": "b752017df98ea579a73fa9703631c71a843ba112", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzIyNDIwMg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/992#discussion_r467224202", "bodyText": "Addressed", "author": "shahzaibj", "createdAt": "2020-08-07T19:15:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE4NzUyNA=="}], "type": "inlineReview", "revised_code": {"commit": "63c8a2985a0c03303d4dd97811cdb3eaad1182f4", "chunk": "diff --git a/common/src/main/java/com/microsoft/identity/common/internal/providers/microsoft/microsoftsts/MicrosoftStsOAuth2Strategy.java b/common/src/main/java/com/microsoft/identity/common/internal/providers/microsoft/microsoftsts/MicrosoftStsOAuth2Strategy.java\nindex e90b8c1c8..79d9dfaa4 100644\n--- a/common/src/main/java/com/microsoft/identity/common/internal/providers/microsoft/microsoftsts/MicrosoftStsOAuth2Strategy.java\n+++ b/common/src/main/java/com/microsoft/identity/common/internal/providers/microsoft/microsoftsts/MicrosoftStsOAuth2Strategy.java\n\n@@ -470,11 +470,8 @@ public class MicrosoftStsOAuth2Strategy\n         headers.put(\"client-request-id\", DiagnosticContext.getRequestContext().get(DiagnosticContext.CORRELATION_ID));\n         headers.putAll(Device.getPlatformIdParameters());\n \n-        final String appName = request.getClientAppName();\n-        final String appVer = request.getClientAppVersion();\n-\n-        headers.put(AuthenticationConstants.AAD.APP_PACKAGE_NAME, appName);\n-        headers.put(AuthenticationConstants.AAD.APP_VERSION, appVer);\n+        headers.put(AuthenticationConstants.AAD.APP_PACKAGE_NAME, request.getClientAppName());\n+        headers.put(AuthenticationConstants.AAD.APP_VERSION, request.getClientAppVersion());\n \n         final String challengeHeader = response.getHeaders().get(CHALLENGE_REQUEST_HEADER).get(0);\n         Logger.info(TAG + methodName, \"Device certificate challenge request. \");\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE4NzcyOQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/992#discussion_r467187729", "bodyText": "nit: do we need these variables?", "author": "AdamBJohnsonx", "createdAt": "2020-08-07T17:56:31Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/providers/oauth2/OAuth2Strategy.java", "diffHunk": "@@ -185,6 +186,14 @@ protected HttpResponse performTokenRequest(final GenericTokenRequest request) th\n         headers.putAll(Device.getPlatformIdParameters());\n         headers.putAll(EstsTelemetry.getInstance().getTelemetryHeaders());\n \n+        if (request instanceof MicrosoftTokenRequest) {\n+            final String appName = ((MicrosoftTokenRequest) request).getClientAppName();\n+            final String appVer = ((MicrosoftTokenRequest) request).getClientAppVersion();", "originalCommit": "b752017df98ea579a73fa9703631c71a843ba112", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzIyNDI1Nw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/992#discussion_r467224257", "bodyText": "Addressed", "author": "shahzaibj", "createdAt": "2020-08-07T19:15:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE4NzcyOQ=="}], "type": "inlineReview", "revised_code": {"commit": "63c8a2985a0c03303d4dd97811cdb3eaad1182f4", "chunk": "diff --git a/common/src/main/java/com/microsoft/identity/common/internal/providers/oauth2/OAuth2Strategy.java b/common/src/main/java/com/microsoft/identity/common/internal/providers/oauth2/OAuth2Strategy.java\nindex eab223db5..ce3c948b0 100644\n--- a/common/src/main/java/com/microsoft/identity/common/internal/providers/oauth2/OAuth2Strategy.java\n+++ b/common/src/main/java/com/microsoft/identity/common/internal/providers/oauth2/OAuth2Strategy.java\n\n@@ -187,11 +187,14 @@ public abstract class OAuth2Strategy\n         headers.putAll(EstsTelemetry.getInstance().getTelemetryHeaders());\n \n         if (request instanceof MicrosoftTokenRequest) {\n-            final String appName = ((MicrosoftTokenRequest) request).getClientAppName();\n-            final String appVer = ((MicrosoftTokenRequest) request).getClientAppVersion();\n-\n-            headers.put(AuthenticationConstants.AAD.APP_PACKAGE_NAME, appName);\n-            headers.put(AuthenticationConstants.AAD.APP_VERSION, appVer);\n+            headers.put(\n+                    AuthenticationConstants.AAD.APP_PACKAGE_NAME,\n+                    ((MicrosoftTokenRequest) request).getClientAppName()\n+            );\n+            headers.put(\n+                    AuthenticationConstants.AAD.APP_VERSION,\n+                    ((MicrosoftTokenRequest) request).getClientAppVersion()\n+            );\n         }\n \n         final HttpResponse response = HttpRequest.sendPost(\n"}}, {"oid": "63c8a2985a0c03303d4dd97811cdb3eaad1182f4", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/63c8a2985a0c03303d4dd97811cdb3eaad1182f4", "message": "Address comment", "committedDate": "2020-08-07T19:14:52Z", "type": "commit"}, {"oid": "7e877ebf2cf76e4ada393b264acc13e59240ec1b", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/7e877ebf2cf76e4ada393b264acc13e59240ec1b", "message": "Merge branch 'dev' into shahzaibj/app-name-and-version", "committedDate": "2020-08-07T19:16:02Z", "type": "commit"}, {"oid": "c2c7d53ab58ee5f05a4008301941df9f2e37d53b", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/c2c7d53ab58ee5f05a4008301941df9f2e37d53b", "message": "Address comment", "committedDate": "2020-08-07T19:18:29Z", "type": "commit"}]}