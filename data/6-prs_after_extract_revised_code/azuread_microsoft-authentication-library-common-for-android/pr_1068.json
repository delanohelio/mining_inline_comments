{"pr_number": 1068, "pr_title": "Do not allow for missing secret key data to cause an NPE", "pr_createdAt": "2020-10-04T00:00:56Z", "pr_url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1068", "timeline": [{"oid": "eb7e8b5e8f309c0898a212d33ee968ef8b8b4c24", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/eb7e8b5e8f309c0898a212d33ee968ef8b8b4c24", "message": "Do not allow for missing secert key data to cause NPE.\n\nCheck for null data and do not decrypt it.\nProperly synchronize and safe-copy the key array.", "committedDate": "2020-10-04T00:01:48Z", "type": "commit"}, {"oid": "eb7e8b5e8f309c0898a212d33ee968ef8b8b4c24", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/eb7e8b5e8f309c0898a212d33ee968ef8b8b4c24", "message": "Do not allow for missing secert key data to cause NPE.\n\nCheck for null data and do not decrypt it.\nProperly synchronize and safe-copy the key array.", "committedDate": "2020-10-04T00:01:48Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkwOTgzOQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1068#discussion_r499909839", "bodyText": "So are we no longer using getters and setters? Do we still need them?", "author": "shahzaibj", "createdAt": "2020-10-05T22:37:56Z", "path": "common/src/main/java/com/microsoft/identity/common/adal/internal/AuthenticationSettings.java", "diffHunk": "@@ -88,8 +93,8 @@\n      *\n      * @return byte[] secret data\n      */\n-    public byte[] getSecretKeyData() {\n-        return mSecretKeyData.get();", "originalCommit": "eb7e8b5e8f309c0898a212d33ee968ef8b8b4c24", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkxMDY4Mw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1068#discussion_r499910683", "bodyText": "we're using them.  Just adding synchronization/safe-copy.", "author": "AdamBJohnsonx", "createdAt": "2020-10-05T22:40:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkwOTgzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkxMTc0NQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1068#discussion_r499911745", "bodyText": "Ohh okay, so Arrays.copyOf() acts as a copy + get.....hadn't used this one before", "author": "shahzaibj", "createdAt": "2020-10-05T22:43:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkwOTgzOQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkxMjM3Ng==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1068#discussion_r499912376", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            SecretKey key = getSecretKey(secretKeyData);\n          \n          \n            \n                            return key;\n          \n          \n            \n                            return getSecretKey(secretKeyData);", "author": "shahzaibj", "createdAt": "2020-10-05T22:45:28Z", "path": "common/src/main/java/com/microsoft/identity/common/adal/internal/cache/StorageHelper.java", "diffHunk": "@@ -590,7 +590,13 @@ public SecretKey loadSecretKey(@NonNull final KeyType keyType) throws IOExceptio\n                 return getSecretKey(AuthenticationSettings.INSTANCE.getBrokerSecretKeys().get(COMPANY_PORTAL_APP_PACKAGE_NAME));\n \n             case ADAL_USER_DEFINED_KEY:\n-                return getSecretKey(AuthenticationSettings.INSTANCE.getSecretKeyData());\n+                final byte[] secretKeyData = AuthenticationSettings.INSTANCE.getSecretKeyData();\n+                if (secretKeyData == null) {\n+                    Logger.error(\"StorageHelper:loadSecretKey\", \"Went looking for a key that wasn't there.\", null);\n+                    return null;\n+                }\n+                SecretKey key = getSecretKey(secretKeyData);\n+                return key;", "originalCommit": "eb7e8b5e8f309c0898a212d33ee968ef8b8b4c24", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "54f8e1856cc421e2e329b6420edfa31d60a357c6", "chunk": "diff --git a/common/src/main/java/com/microsoft/identity/common/adal/internal/cache/StorageHelper.java b/common/src/main/java/com/microsoft/identity/common/adal/internal/cache/StorageHelper.java\nindex 0e9b8c41f..681d49a4f 100644\n--- a/common/src/main/java/com/microsoft/identity/common/adal/internal/cache/StorageHelper.java\n+++ b/common/src/main/java/com/microsoft/identity/common/adal/internal/cache/StorageHelper.java\n\n@@ -595,8 +595,7 @@ public class StorageHelper implements IStorageHelper {\n                     Logger.error(\"StorageHelper:loadSecretKey\", \"Went looking for a key that wasn't there.\", null);\n                     return null;\n                 }\n-                SecretKey key = getSecretKey(secretKeyData);\n-                return key;\n+                return getSecretKey(secretKeyData);\n \n             case KEYSTORE_ENCRYPTED_KEY:\n                 return loadKeyStoreEncryptedKey();\n"}}, {"oid": "54f8e1856cc421e2e329b6420edfa31d60a357c6", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/54f8e1856cc421e2e329b6420edfa31d60a357c6", "message": "Update common/src/main/java/com/microsoft/identity/common/adal/internal/cache/StorageHelper.java\r\n\r\nRemove useless assignment.\n\nCo-authored-by: Shahzaib <37125644+shahzaibj@users.noreply.github.com>", "committedDate": "2020-10-05T22:46:32Z", "type": "commit"}]}