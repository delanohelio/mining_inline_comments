{"pr_number": 940, "pr_title": "Changes to delete RT's if we get an invalid_grant with bad token while renewing tokens", "pr_createdAt": "2020-06-24T01:26:00Z", "pr_url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/940", "timeline": [{"oid": "cb39c36207434f32f947ffbe97f298df447d2c5f", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/cb39c36207434f32f947ffbe97f298df447d2c5f", "message": "Changes to delete RT's if we get an invalid_grant with bad token while renewing tokens", "committedDate": "2020-06-24T01:24:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU5MzgwOA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/940#discussion_r444593808", "bodyText": "Can we log the contents of the sub_error?", "author": "iambmelt", "createdAt": "2020-06-24T01:27:44Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/controllers/BaseController.java", "diffHunk": "@@ -300,6 +302,16 @@ protected void renewAccessToken(@NonNull final SilentTokenCommandParameters para\n \n             // Set the AuthenticationResult on the final result object\n             acquireTokenSilentResult.setLocalAuthenticationResult(authenticationResult);\n+        }else {\n+            if (tokenResult.getErrorResponse() != null) {\n+                final String errorCode = tokenResult.getErrorResponse().getError();\n+                final String subErrorCode = tokenResult.getErrorResponse().getSubError();\n+\n+                if (errorCode.equals(INVALID_GRANT) && subErrorCode.equals(BAD_TOKEN)) {\n+                    Logger.info(TAG, \"Refresh token is invalid, deleting from cache\");\n+                    tokenCache.removeCredential(cacheRecord.getRefreshToken());\n+                }", "originalCommit": "cb39c36207434f32f947ffbe97f298df447d2c5f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU5Njk2OQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/940#discussion_r444596969", "bodyText": "logging both error and suberror now", "author": "kreedula", "createdAt": "2020-06-24T01:40:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU5MzgwOA=="}], "type": "inlineReview", "revised_code": {"commit": "0bfabcf155df5d1b1941a4df584b9eaa51d817eb", "chunk": "diff --git a/common/src/main/java/com/microsoft/identity/common/internal/controllers/BaseController.java b/common/src/main/java/com/microsoft/identity/common/internal/controllers/BaseController.java\nindex 6503350d7..e60e8e2f1 100644\n--- a/common/src/main/java/com/microsoft/identity/common/internal/controllers/BaseController.java\n+++ b/common/src/main/java/com/microsoft/identity/common/internal/controllers/BaseController.java\n\n@@ -302,10 +302,11 @@ public abstract class BaseController {\n \n             // Set the AuthenticationResult on the final result object\n             acquireTokenSilentResult.setLocalAuthenticationResult(authenticationResult);\n-        }else {\n+        } else {\n             if (tokenResult.getErrorResponse() != null) {\n                 final String errorCode = tokenResult.getErrorResponse().getError();\n                 final String subErrorCode = tokenResult.getErrorResponse().getSubError();\n+                Logger.info(TAG, \"Error: \" + errorCode + \" Suberror: \" + subErrorCode);\n \n                 if (errorCode.equals(INVALID_GRANT) && subErrorCode.equals(BAD_TOKEN)) {\n                     Logger.info(TAG, \"Refresh token is invalid, deleting from cache\");\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU5Mzg3Ng==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/940#discussion_r444593876", "bodyText": "Nit formatter", "author": "iambmelt", "createdAt": "2020-06-24T01:28:01Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/controllers/BaseController.java", "diffHunk": "@@ -300,6 +302,16 @@ protected void renewAccessToken(@NonNull final SilentTokenCommandParameters para\n \n             // Set the AuthenticationResult on the final result object\n             acquireTokenSilentResult.setLocalAuthenticationResult(authenticationResult);\n+        }else {", "originalCommit": "cb39c36207434f32f947ffbe97f298df447d2c5f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "0bfabcf155df5d1b1941a4df584b9eaa51d817eb", "chunk": "diff --git a/common/src/main/java/com/microsoft/identity/common/internal/controllers/BaseController.java b/common/src/main/java/com/microsoft/identity/common/internal/controllers/BaseController.java\nindex 6503350d7..e60e8e2f1 100644\n--- a/common/src/main/java/com/microsoft/identity/common/internal/controllers/BaseController.java\n+++ b/common/src/main/java/com/microsoft/identity/common/internal/controllers/BaseController.java\n\n@@ -302,10 +302,11 @@ public abstract class BaseController {\n \n             // Set the AuthenticationResult on the final result object\n             acquireTokenSilentResult.setLocalAuthenticationResult(authenticationResult);\n-        }else {\n+        } else {\n             if (tokenResult.getErrorResponse() != null) {\n                 final String errorCode = tokenResult.getErrorResponse().getError();\n                 final String subErrorCode = tokenResult.getErrorResponse().getSubError();\n+                Logger.info(TAG, \"Error: \" + errorCode + \" Suberror: \" + subErrorCode);\n \n                 if (errorCode.equals(INVALID_GRANT) && subErrorCode.equals(BAD_TOKEN)) {\n                     Logger.info(TAG, \"Refresh token is invalid, deleting from cache\");\n"}}, {"oid": "0bfabcf155df5d1b1941a4df584b9eaa51d817eb", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/0bfabcf155df5d1b1941a4df584b9eaa51d817eb", "message": "Addressing comments", "committedDate": "2020-06-24T01:39:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU5ODM1MA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/940#discussion_r444598350", "bodyText": "Can we add one more else case here where if the request isn't successful, but also doesn't contain an error response, we log a warning message?", "author": "iambmelt", "createdAt": "2020-06-24T01:45:22Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/controllers/BaseController.java", "diffHunk": "@@ -300,6 +302,17 @@ protected void renewAccessToken(@NonNull final SilentTokenCommandParameters para\n \n             // Set the AuthenticationResult on the final result object\n             acquireTokenSilentResult.setLocalAuthenticationResult(authenticationResult);\n+        } else {\n+            if (tokenResult.getErrorResponse() != null) {\n+                final String errorCode = tokenResult.getErrorResponse().getError();\n+                final String subErrorCode = tokenResult.getErrorResponse().getSubError();\n+                Logger.info(TAG, \"Error: \" + errorCode + \" Suberror: \" + subErrorCode);\n+\n+                if (errorCode.equals(INVALID_GRANT) && subErrorCode.equals(BAD_TOKEN)) {\n+                    Logger.info(TAG, \"Refresh token is invalid, deleting from cache\");\n+                    tokenCache.removeCredential(cacheRecord.getRefreshToken());\n+                }\n+            }", "originalCommit": "0bfabcf155df5d1b1941a4df584b9eaa51d817eb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU5ODU2OA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/940#discussion_r444598568", "bodyText": "(Obviously, this condition shouldn't ever happen)", "author": "iambmelt", "createdAt": "2020-06-24T01:46:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU5ODM1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU5OTcxMg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/940#discussion_r444599712", "bodyText": "yep, should never happen, but no harm adding", "author": "kreedula", "createdAt": "2020-06-24T01:51:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU5ODM1MA=="}], "type": "inlineReview", "revised_code": {"commit": "b1ec04006ed19e433aad9c8b992b32c317395b55", "chunk": "diff --git a/common/src/main/java/com/microsoft/identity/common/internal/controllers/BaseController.java b/common/src/main/java/com/microsoft/identity/common/internal/controllers/BaseController.java\nindex e60e8e2f1..1a2a7cc7b 100644\n--- a/common/src/main/java/com/microsoft/identity/common/internal/controllers/BaseController.java\n+++ b/common/src/main/java/com/microsoft/identity/common/internal/controllers/BaseController.java\n\n@@ -312,6 +312,8 @@ public abstract class BaseController {\n                     Logger.info(TAG, \"Refresh token is invalid, deleting from cache\");\n                     tokenCache.removeCredential(cacheRecord.getRefreshToken());\n                 }\n+            }else {\n+                Logger.warn(TAG, \"Invalid state, No token success or error response on the token result\");\n             }\n         }\n     }\n"}}, {"oid": "b1ec04006ed19e433aad9c8b992b32c317395b55", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/b1ec04006ed19e433aad9c8b992b32c317395b55", "message": "Addressing comments", "committedDate": "2020-06-24T01:50:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU5OTcxOA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/940#discussion_r444599718", "bodyText": "Let's also check the return value here, should be  boolean if this removal was successful", "author": "iambmelt", "createdAt": "2020-06-24T01:51:06Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/controllers/BaseController.java", "diffHunk": "@@ -300,6 +302,17 @@ protected void renewAccessToken(@NonNull final SilentTokenCommandParameters para\n \n             // Set the AuthenticationResult on the final result object\n             acquireTokenSilentResult.setLocalAuthenticationResult(authenticationResult);\n+        } else {\n+            if (tokenResult.getErrorResponse() != null) {\n+                final String errorCode = tokenResult.getErrorResponse().getError();\n+                final String subErrorCode = tokenResult.getErrorResponse().getSubError();\n+                Logger.info(TAG, \"Error: \" + errorCode + \" Suberror: \" + subErrorCode);\n+\n+                if (errorCode.equals(INVALID_GRANT) && subErrorCode.equals(BAD_TOKEN)) {\n+                    Logger.info(TAG, \"Refresh token is invalid, deleting from cache\");\n+                    tokenCache.removeCredential(cacheRecord.getRefreshToken());", "originalCommit": "0bfabcf155df5d1b1941a4df584b9eaa51d817eb", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f0bcd0c033aea8052f4fbff89934b3fc9007cfdd", "chunk": "diff --git a/common/src/main/java/com/microsoft/identity/common/internal/controllers/BaseController.java b/common/src/main/java/com/microsoft/identity/common/internal/controllers/BaseController.java\nindex e60e8e2f1..679e01c1e 100644\n--- a/common/src/main/java/com/microsoft/identity/common/internal/controllers/BaseController.java\n+++ b/common/src/main/java/com/microsoft/identity/common/internal/controllers/BaseController.java\n\n@@ -309,9 +309,13 @@ public abstract class BaseController {\n                 Logger.info(TAG, \"Error: \" + errorCode + \" Suberror: \" + subErrorCode);\n \n                 if (errorCode.equals(INVALID_GRANT) && subErrorCode.equals(BAD_TOKEN)) {\n-                    Logger.info(TAG, \"Refresh token is invalid, deleting from cache\");\n-                    tokenCache.removeCredential(cacheRecord.getRefreshToken());\n+                    boolean isRemoved = tokenCache.removeCredential(cacheRecord.getRefreshToken());\n+                    Logger.info(TAG, \"Refresh token is invalid, \" +\n+                            \"attempting to delete the RT from cache, result:\" + isRemoved\n+                    );\n                 }\n+            }else {\n+                Logger.warn(TAG, \"Invalid state, No token success or error response on the token result\");\n             }\n         }\n     }\n"}}, {"oid": "f0bcd0c033aea8052f4fbff89934b3fc9007cfdd", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/f0bcd0c033aea8052f4fbff89934b3fc9007cfdd", "message": "Addressing comments", "committedDate": "2020-06-24T01:53:26Z", "type": "commit"}]}