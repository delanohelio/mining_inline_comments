{"pr_number": 1130, "pr_title": "(Make changes to) persist refresh token in joined flow.", "pr_createdAt": "2020-11-16T05:39:08Z", "pr_url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1130", "timeline": [{"oid": "096e692924364aba2a587fdb9b27cb6df6b3dcb7", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/096e692924364aba2a587fdb9b27cb6df6b3dcb7", "message": "persist rt", "committedDate": "2020-11-16T08:32:05Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjI2OTU0OA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1130#discussion_r526269548", "bodyText": "Why changing this?", "author": "shahzaibj", "createdAt": "2020-11-18T17:24:56Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/migration/TokenCacheItemMigrationAdapter.java", "diffHunk": "@@ -184,7 +185,7 @@ public static boolean tryFociTokenWithGivenClientId(@SuppressWarnings(WarningTyp\n         final MicrosoftStsOAuth2Strategy strategy = new MicrosoftStsOAuth2Strategy(config, strategyParameters);\n \n         final String refreshToken = refreshTokenRecord.getSecret();\n-        final String scopes = BaseController.getDelimitedDefaultScopeString();\n+        final String scopes = AuthenticationConstants.OAuth2Scopes.OPEN_ID_SCOPE;", "originalCommit": "f9c375c8b77ffba24e6dfc1c653a6150a5193cca", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ0OTIwOQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1130#discussion_r526449209", "bodyText": "This seems like a mistake.  What should this be?", "author": "AdamBJohnsonx", "createdAt": "2020-11-18T21:56:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjI2OTU0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjU0MjY2OQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1130#discussion_r526542669", "bodyText": "I was trying to scope it down to the minimum - so that the application that does not require MSGraph does not have to request preauthorization for the other 2 - which is optional in the form.\nMaybe it's not a good idea and we should keep the same pattern throughout the code (that our minimum = getDelimitedDefaultScopeString())", "author": "rpdome", "createdAt": "2020-11-19T02:00:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjI2OTU0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjU0MzkzNw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1130#discussion_r526543937", "bodyText": "Can we send the customary offline_access openid profile and not specify a resource? Seems preferable, as MS Graph doesn't exist in all clouds", "author": "iambmelt", "createdAt": "2020-11-19T02:04:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjI2OTU0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjk1MjQwMA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1130#discussion_r526952400", "bodyText": "https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-permissions-and-consent#openid-connect-scopes\nThe Microsoft identity platform implementation of OpenID Connect has a few well-defined scopes that are also hosted on the Microsoft Graph: openid, email, profile, and offline_access. The address and phone OpenID Connect scopes are not supported.\nThis describes why I was hitting the MSgraph preauthorized error with those scopes (AADSTS65002: Consent between first party application '[CLIENT_ID]' and first party resource '00000003-0000-0000-c000-000000000000' must be configured via preauthorization. Visit https://identitydocs.azurewebsites.net/static/aad/preauthorization.html).", "author": "rpdome", "createdAt": "2020-11-19T14:58:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjI2OTU0OA=="}], "type": "inlineReview", "revised_code": {"commit": "b501200e04c41f52c47e1ad813aaf53adb3595a3", "chunk": "diff --git a/common/src/main/java/com/microsoft/identity/common/internal/migration/TokenCacheItemMigrationAdapter.java b/common/src/main/java/com/microsoft/identity/common/internal/migration/TokenCacheItemMigrationAdapter.java\nindex 4134bb754..edbbcc3b0 100644\n--- a/common/src/main/java/com/microsoft/identity/common/internal/migration/TokenCacheItemMigrationAdapter.java\n+++ b/common/src/main/java/com/microsoft/identity/common/internal/migration/TokenCacheItemMigrationAdapter.java\n\n@@ -185,7 +185,7 @@ public class TokenCacheItemMigrationAdapter {\n         final MicrosoftStsOAuth2Strategy strategy = new MicrosoftStsOAuth2Strategy(config, strategyParameters);\n \n         final String refreshToken = refreshTokenRecord.getSecret();\n-        final String scopes = AuthenticationConstants.OAuth2Scopes.OPEN_ID_SCOPE;\n+        final String scopes = BaseController.getDelimitedDefaultScopeString();\n \n         // Create a correlation_id for the request\n         final UUID correlationId = UUID.randomUUID();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzM2MDIyMw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1130#discussion_r527360223", "bodyText": "I would prefer to see new API + tests added for this, rather than have to increment the major version of common to change this API", "author": "iambmelt", "createdAt": "2020-11-20T02:50:32Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/cache/BrokerOAuth2TokenCache.java", "diffHunk": "@@ -180,6 +181,7 @@ public BrokerOAuth2TokenCache(@NonNull Context context,\n     public ICacheRecord save(@NonNull AccountRecord accountRecord,\n                              @NonNull IdTokenRecord idTokenRecord,\n                              @NonNull AccessTokenRecord accessTokenRecord,\n+                             @NonNull RefreshTokenRecord refreshTokenRecord,", "originalCommit": "678e290b0bff407b7f2ef8766b0e59520091d1cd", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b501200e04c41f52c47e1ad813aaf53adb3595a3", "chunk": "diff --git a/common/src/main/java/com/microsoft/identity/common/internal/cache/BrokerOAuth2TokenCache.java b/common/src/main/java/com/microsoft/identity/common/internal/cache/BrokerOAuth2TokenCache.java\nindex 4a780905c..b17062ee6 100644\n--- a/common/src/main/java/com/microsoft/identity/common/internal/cache/BrokerOAuth2TokenCache.java\n+++ b/common/src/main/java/com/microsoft/identity/common/internal/cache/BrokerOAuth2TokenCache.java\n\n@@ -178,12 +178,65 @@ public class BrokerOAuth2TokenCache\n      * @return The {@link ICacheRecord} result of this save action.\n      * @throws ClientException If the supplied Accounts or Credentials are schema invalid.\n      */\n+    @Deprecated\n+    public ICacheRecord save(@NonNull AccountRecord accountRecord,\n+                             @NonNull IdTokenRecord idTokenRecord,\n+                             @NonNull AccessTokenRecord accessTokenRecord,\n+                             @Nullable String familyId) throws ClientException {\n+        final String methodName = \":save (4 args)\";\n+        return saveInternal(\n+                accountRecord,\n+                idTokenRecord,\n+                accessTokenRecord,\n+                null,\n+                familyId,\n+                methodName);\n+    }\n+\n+\n+    /**\n+     * Broker-only API to persist WPJ's Accounts & their associated credentials.\n+     *\n+     * @param accountRecord      The {@link AccountRecord} to store.\n+     * @param idTokenRecord      The {@link IdTokenRecord} to store.\n+     * @param accessTokenRecord  The {@link AccessTokenRecord} to store.\n+     * @param refreshTokenRecord The {@link RefreshTokenRecord} to store.\n+     * @param familyId           The family_id or null, if not applicable.\n+     * @return The {@link ICacheRecord} result of this save action.\n+     * @throws ClientException If the supplied Accounts or Credentials are schema invalid.\n+     */\n     public ICacheRecord save(@NonNull AccountRecord accountRecord,\n                              @NonNull IdTokenRecord idTokenRecord,\n                              @NonNull AccessTokenRecord accessTokenRecord,\n                              @NonNull RefreshTokenRecord refreshTokenRecord,\n                              @Nullable String familyId) throws ClientException {\n-        final String methodName = \":save\";\n+        final String methodName = \":save (5 args)\";\n+        return saveInternal(\n+                accountRecord,\n+                idTokenRecord,\n+                accessTokenRecord,\n+                refreshTokenRecord,\n+                familyId,\n+                methodName);\n+    }\n+\n+    /**\n+     * Broker-only API to persist WPJ's Accounts & their associated credentials.\n+     *\n+     * @param accountRecord      The {@link AccountRecord} to store.\n+     * @param idTokenRecord      The {@link IdTokenRecord} to store.\n+     * @param accessTokenRecord  The {@link AccessTokenRecord} to store.\n+     * @param refreshTokenRecord The {@link RefreshTokenRecord} to store.\n+     * @param familyId           The family_id or null, if not applicable.\n+     * @return The {@link ICacheRecord} result of this save action.\n+     * @throws ClientException If the supplied Accounts or Credentials are schema invalid.\n+     */\n+    private ICacheRecord saveInternal(@NonNull AccountRecord accountRecord,\n+                                      @NonNull IdTokenRecord idTokenRecord,\n+                                      @NonNull AccessTokenRecord accessTokenRecord,\n+                                      @Nullable RefreshTokenRecord refreshTokenRecord,\n+                                      @Nullable String familyId,\n+                                      @NonNull String methodName) throws ClientException {\n \n         final ICacheRecord result;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzM2MDMxNA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1130#discussion_r527360314", "bodyText": "Same here -- this would be a major version break. Let's add new API + tests", "author": "iambmelt", "createdAt": "2020-11-20T02:50:55Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/cache/BrokerOAuth2TokenCache.java", "diffHunk": "@@ -243,13 +247,15 @@ public ICacheRecord save(@NonNull AccountRecord accountRecord,\n             @NonNull final AccountRecord accountRecord,\n             @NonNull final IdTokenRecord idTokenRecord,\n             @NonNull final AccessTokenRecord accessTokenRecord,\n+            @NonNull final RefreshTokenRecord refreshTokenRecord,", "originalCommit": "678e290b0bff407b7f2ef8766b0e59520091d1cd", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b501200e04c41f52c47e1ad813aaf53adb3595a3", "chunk": "diff --git a/common/src/main/java/com/microsoft/identity/common/internal/cache/BrokerOAuth2TokenCache.java b/common/src/main/java/com/microsoft/identity/common/internal/cache/BrokerOAuth2TokenCache.java\nindex 4a780905c..b17062ee6 100644\n--- a/common/src/main/java/com/microsoft/identity/common/internal/cache/BrokerOAuth2TokenCache.java\n+++ b/common/src/main/java/com/microsoft/identity/common/internal/cache/BrokerOAuth2TokenCache.java\n\n@@ -242,12 +311,11 @@ public class BrokerOAuth2TokenCache\n         return result;\n     }\n \n-    @SuppressWarnings(\"unchecked\")\n+    @Deprecated\n     public synchronized List<ICacheRecord> saveAndLoadAggregatedAccountData(\n             @NonNull final AccountRecord accountRecord,\n             @NonNull final IdTokenRecord idTokenRecord,\n             @NonNull final AccessTokenRecord accessTokenRecord,\n-            @NonNull final RefreshTokenRecord refreshTokenRecord,\n             @Nullable final String familyId,\n             @NonNull final AbstractAuthenticationScheme authScheme) throws ClientException {\n         synchronized (this) {\n"}}, {"oid": "b501200e04c41f52c47e1ad813aaf53adb3595a3", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/b501200e04c41f52c47e1ad813aaf53adb3595a3", "message": "update test cases / resolve comments", "committedDate": "2020-11-20T05:35:14Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzg1OTE4NA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1130#discussion_r527859184", "bodyText": "@rpdome Can we make the RT @Nullable in this API and have the older API call this one? At a glance, it looks like that would allow for removal of some duplicated code", "author": "iambmelt", "createdAt": "2020-11-20T17:40:02Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/cache/MsalOAuth2TokenCache.java", "diffHunk": "@@ -219,6 +220,65 @@ ICacheRecord save(@NonNull AccountRecord accountRecord,\n         return result;\n     }\n \n+    /**\n+     * @param accountRecord      The {@link AccountRecord} to store.\n+     * @param idTokenRecord      The {@link IdTokenRecord} to store.\n+     * @param accessTokenRecord  The {@link AccessTokenRecord} to store.\n+     * @param refreshTokenRecord The {@link RefreshTokenRecord} to store.\n+     * @return The {@link ICacheRecord} result of this save action.\n+     * @throws ClientException If the supplied Accounts or Credentials are schema invalid.\n+     * @see OAuth2TokenCache#save(AccountRecord, IdTokenRecord)\n+     */\n+    ICacheRecord save(final @NonNull AccountRecord accountRecord,\n+                      final @NonNull IdTokenRecord idTokenRecord,\n+                      final @NonNull AccessTokenRecord accessTokenRecord,\n+                      final @NonNull RefreshTokenRecord refreshTokenRecord) throws ClientException {", "originalCommit": "3d7223d0671df07b35fce79b86475c51dde949bc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzg3Mjk4OA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1130#discussion_r527872988", "bodyText": "I did that and reverted back - not liking the idea of having refreshToken nullable (since the value shouldn't be null from the public API perspective)", "author": "rpdome", "createdAt": "2020-11-20T17:54:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzg1OTE4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzkwODg1MA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1130#discussion_r527908850", "bodyText": "OK - thanks @rpdome", "author": "iambmelt", "createdAt": "2020-11-20T18:55:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzg1OTE4NA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzkxMDA1NQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1130#discussion_r527910055", "bodyText": "Not immediately clear to me why this result needs to be casted, doesn't this API always return this type?", "author": "iambmelt", "createdAt": "2020-11-20T18:58:01Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/cache/BrokerOAuth2TokenCache.java", "diffHunk": "@@ -253,26 +330,51 @@ public ICacheRecord save(@NonNull AccountRecord accountRecord,\n                     familyId\n             );\n \n-            final String clientId = cacheRecord.getAccessToken().getClientId();\n-            final String target = cacheRecord.getAccessToken().getTarget();\n-            final String environment = cacheRecord.getAccessToken().getEnvironment();\n+            return loadAggregatedAccountData(authScheme, cacheRecord);\n+        }\n+    }\n \n-            // Now get the cache we just saved to....\n-            final MsalOAuth2TokenCache cache = getTokenCacheForClient(\n-                    clientId,\n-                    environment,\n-                    mCallingProcessUid\n+    public synchronized List<ICacheRecord> saveAndLoadAggregatedAccountData(\n+            final @NonNull AccountRecord accountRecord,\n+            final @NonNull IdTokenRecord idTokenRecord,\n+            final @NonNull AccessTokenRecord accessTokenRecord,\n+            final @NonNull RefreshTokenRecord refreshTokenRecord,\n+            final @Nullable String familyId,\n+            final @NonNull AbstractAuthenticationScheme authScheme) throws ClientException {\n+        synchronized (this) {\n+            final ICacheRecord cacheRecord = save(\n+                    accountRecord,\n+                    idTokenRecord,\n+                    accessTokenRecord,\n+                    refreshTokenRecord,\n+                    familyId\n             );\n \n-            return (List<ICacheRecord>) cache.loadWithAggregatedAccountData(\n-                    clientId,\n-                    target,\n-                    cacheRecord.getAccount(),\n-                    authScheme\n-            );\n+            return loadAggregatedAccountData(authScheme, cacheRecord);\n         }\n     }\n \n+    @SuppressWarnings(\"unchecked\")\n+    private List<ICacheRecord> loadAggregatedAccountData(final @NonNull AbstractAuthenticationScheme authScheme,\n+                                                         final @NonNull ICacheRecord cacheRecord) {\n+        final String clientId = cacheRecord.getAccessToken().getClientId();\n+        final String target = cacheRecord.getAccessToken().getTarget();\n+        final String environment = cacheRecord.getAccessToken().getEnvironment();\n+\n+        final MsalOAuth2TokenCache cache = getTokenCacheForClient(\n+                clientId,\n+                environment,\n+                mCallingProcessUid\n+        );\n+\n+        return (List<ICacheRecord>) cache.loadWithAggregatedAccountData(", "originalCommit": "3d7223d0671df07b35fce79b86475c51dde949bc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODQ4MTk2Mg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1130#discussion_r528481962", "bodyText": "This was automatically generated by the extract function in Android Studio. Will remove \ud83d\ude05", "author": "rpdome", "createdAt": "2020-11-23T05:47:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzkxMDA1NQ=="}], "type": "inlineReview", "revised_code": {"commit": "303733bea169b5fc290848ec736bbe26608e2340", "chunk": "diff --git a/common/src/main/java/com/microsoft/identity/common/internal/cache/BrokerOAuth2TokenCache.java b/common/src/main/java/com/microsoft/identity/common/internal/cache/BrokerOAuth2TokenCache.java\nindex c4ea3abd6..587c06264 100644\n--- a/common/src/main/java/com/microsoft/identity/common/internal/cache/BrokerOAuth2TokenCache.java\n+++ b/common/src/main/java/com/microsoft/identity/common/internal/cache/BrokerOAuth2TokenCache.java\n\n@@ -367,7 +367,7 @@ public class BrokerOAuth2TokenCache\n                 mCallingProcessUid\n         );\n \n-        return (List<ICacheRecord>) cache.loadWithAggregatedAccountData(\n+        return cache.loadWithAggregatedAccountData(\n                 clientId,\n                 target,\n                 cacheRecord.getAccount(),\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzkxMDE4NQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1130#discussion_r527910185", "bodyText": "Nit: params final", "author": "iambmelt", "createdAt": "2020-11-20T18:58:17Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/cache/BrokerOAuth2TokenCache.java", "diffHunk": "@@ -238,7 +240,82 @@ public ICacheRecord save(@NonNull AccountRecord accountRecord,\n         return result;\n     }\n \n-    @SuppressWarnings(\"unchecked\")\n+    /**\n+     * Broker-only API to persist WPJ's Accounts & their associated credentials.\n+     *\n+     * @param accountRecord      The {@link AccountRecord} to store.\n+     * @param idTokenRecord      The {@link IdTokenRecord} to store.\n+     * @param accessTokenRecord  The {@link AccessTokenRecord} to store.\n+     * @param refreshTokenRecord The {@link RefreshTokenRecord} to store.\n+     * @param familyId           The family_id or null, if not applicable.\n+     * @return The {@link ICacheRecord} result of this save action.\n+     * @throws ClientException If the supplied Accounts or Credentials are schema invalid.\n+     */\n+    public ICacheRecord save(@NonNull AccountRecord accountRecord,", "originalCommit": "3d7223d0671df07b35fce79b86475c51dde949bc", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "303733bea169b5fc290848ec736bbe26608e2340", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/303733bea169b5fc290848ec736bbe26608e2340", "message": "(Make changes to) persist refresh token in joined flow", "committedDate": "2020-11-23T05:50:41Z", "type": "commit"}, {"oid": "303733bea169b5fc290848ec736bbe26608e2340", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/303733bea169b5fc290848ec736bbe26608e2340", "message": "(Make changes to) persist refresh token in joined flow", "committedDate": "2020-11-23T05:50:41Z", "type": "forcePushed"}]}