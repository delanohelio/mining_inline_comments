{"pr_number": 1140, "pr_title": "Hardcode Teams Agent clientID/scope for FoCi call", "pr_createdAt": "2020-11-27T11:02:21Z", "pr_url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1140", "timeline": [{"oid": "1f01d87a35bb4ce9331fe0827fd46e83d3eb965d", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/1f01d87a35bb4ce9331fe0827fd46e83d3eb965d", "message": "Hardcode Teams Agent clientID/scope for Foci call", "committedDate": "2020-11-27T10:51:45Z", "type": "commit"}, {"oid": "1f01d87a35bb4ce9331fe0827fd46e83d3eb965d", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/1f01d87a35bb4ce9331fe0827fd46e83d3eb965d", "message": "Hardcode Teams Agent clientID/scope for Foci call", "committedDate": "2020-11-27T10:51:45Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjgxMTczMg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1140#discussion_r532811732", "bodyText": "2-way linking to an ADO issue?", "author": "AdamBJohnsonx", "createdAt": "2020-11-30T18:31:54Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/migration/TokenCacheItemMigrationAdapter.java", "diffHunk": "@@ -185,7 +185,18 @@ public static boolean tryFociTokenWithGivenClientId(@SuppressWarnings(WarningTyp\n         final MicrosoftStsOAuth2Strategy strategy = new MicrosoftStsOAuth2Strategy(config, strategyParameters);\n \n         final String refreshToken = refreshTokenRecord.getSecret();\n-        final String scopes = BaseController.getDelimitedDefaultScopeString();\n+\n+        final String scopes;\n+        // Hardcoding Teams Agent's client ID with the scope it's pre-authorized for.\n+        // This is because if only the default scope is passed, eSTS will set the resource ID (on its side)\n+        // based on the RT (Which the given clientId might not be pre-authorized for).\n+        // TODO: make pre-authorization of MSGraph User.read (and the default scopes) a requirement", "originalCommit": "1f01d87a35bb4ce9331fe0827fd46e83d3eb965d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6b6f6def41dc682c3ce73b66ec03f91dd045060a", "chunk": "diff --git a/common/src/main/java/com/microsoft/identity/common/internal/migration/TokenCacheItemMigrationAdapter.java b/common/src/main/java/com/microsoft/identity/common/internal/migration/TokenCacheItemMigrationAdapter.java\nindex d383f865c..899b256eb 100644\n--- a/common/src/main/java/com/microsoft/identity/common/internal/migration/TokenCacheItemMigrationAdapter.java\n+++ b/common/src/main/java/com/microsoft/identity/common/internal/migration/TokenCacheItemMigrationAdapter.java\n\n@@ -192,8 +192,11 @@ public class TokenCacheItemMigrationAdapter {\n         // based on the RT (Which the given clientId might not be pre-authorized for).\n         // TODO: make pre-authorization of MSGraph User.read (and the default scopes) a requirement\n         //       for every FoCI apps (and hardcode it here).\n+        //       https://identitydivision.visualstudio.com/Engineering/_workitems/edit/1222002\n         if (TextUtils.equals(clientId, \"87749df4-7ccf-48f8-aa87-704bad0e0e16\")) {\n             scopes = \"https://devicemgmt.teams.microsoft.com/.default \" + BaseController.getDelimitedDefaultScopeString();\n+            Logger.info(TAG + methodName,\n+                    \"Teams agent client ID - making a test request with teams agent resource.\");\n         } else {\n             scopes = BaseController.getDelimitedDefaultScopeString();\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjgxMjI5OQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1140#discussion_r532812299", "bodyText": "Can we add a constant for this?", "author": "iambmelt", "createdAt": "2020-11-30T18:32:53Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/migration/TokenCacheItemMigrationAdapter.java", "diffHunk": "@@ -185,7 +185,18 @@ public static boolean tryFociTokenWithGivenClientId(@SuppressWarnings(WarningTyp\n         final MicrosoftStsOAuth2Strategy strategy = new MicrosoftStsOAuth2Strategy(config, strategyParameters);\n \n         final String refreshToken = refreshTokenRecord.getSecret();\n-        final String scopes = BaseController.getDelimitedDefaultScopeString();\n+\n+        final String scopes;\n+        // Hardcoding Teams Agent's client ID with the scope it's pre-authorized for.\n+        // This is because if only the default scope is passed, eSTS will set the resource ID (on its side)\n+        // based on the RT (Which the given clientId might not be pre-authorized for).\n+        // TODO: make pre-authorization of MSGraph User.read (and the default scopes) a requirement\n+        //       for every FoCI apps (and hardcode it here).\n+        if (TextUtils.equals(clientId, \"87749df4-7ccf-48f8-aa87-704bad0e0e16\")) {", "originalCommit": "1f01d87a35bb4ce9331fe0827fd46e83d3eb965d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM2OTE1MQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1140#discussion_r533369151", "bodyText": "This is temporary and should be removed in the next release. (once we verify that using MSGraph user.read doesn't break anything) - because of that I prefer putting all of them in one place.", "author": "rpdome", "createdAt": "2020-12-01T12:24:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjgxMjI5OQ=="}], "type": "inlineReview", "revised_code": {"commit": "6b6f6def41dc682c3ce73b66ec03f91dd045060a", "chunk": "diff --git a/common/src/main/java/com/microsoft/identity/common/internal/migration/TokenCacheItemMigrationAdapter.java b/common/src/main/java/com/microsoft/identity/common/internal/migration/TokenCacheItemMigrationAdapter.java\nindex d383f865c..899b256eb 100644\n--- a/common/src/main/java/com/microsoft/identity/common/internal/migration/TokenCacheItemMigrationAdapter.java\n+++ b/common/src/main/java/com/microsoft/identity/common/internal/migration/TokenCacheItemMigrationAdapter.java\n\n@@ -192,8 +192,11 @@ public class TokenCacheItemMigrationAdapter {\n         // based on the RT (Which the given clientId might not be pre-authorized for).\n         // TODO: make pre-authorization of MSGraph User.read (and the default scopes) a requirement\n         //       for every FoCI apps (and hardcode it here).\n+        //       https://identitydivision.visualstudio.com/Engineering/_workitems/edit/1222002\n         if (TextUtils.equals(clientId, \"87749df4-7ccf-48f8-aa87-704bad0e0e16\")) {\n             scopes = \"https://devicemgmt.teams.microsoft.com/.default \" + BaseController.getDelimitedDefaultScopeString();\n+            Logger.info(TAG + methodName,\n+                    \"Teams agent client ID - making a test request with teams agent resource.\");\n         } else {\n             scopes = BaseController.getDelimitedDefaultScopeString();\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjgxMjM2Ng==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1140#discussion_r532812366", "bodyText": "And for this?", "author": "iambmelt", "createdAt": "2020-11-30T18:33:00Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/migration/TokenCacheItemMigrationAdapter.java", "diffHunk": "@@ -185,7 +185,18 @@ public static boolean tryFociTokenWithGivenClientId(@SuppressWarnings(WarningTyp\n         final MicrosoftStsOAuth2Strategy strategy = new MicrosoftStsOAuth2Strategy(config, strategyParameters);\n \n         final String refreshToken = refreshTokenRecord.getSecret();\n-        final String scopes = BaseController.getDelimitedDefaultScopeString();\n+\n+        final String scopes;\n+        // Hardcoding Teams Agent's client ID with the scope it's pre-authorized for.\n+        // This is because if only the default scope is passed, eSTS will set the resource ID (on its side)\n+        // based on the RT (Which the given clientId might not be pre-authorized for).\n+        // TODO: make pre-authorization of MSGraph User.read (and the default scopes) a requirement\n+        //       for every FoCI apps (and hardcode it here).\n+        if (TextUtils.equals(clientId, \"87749df4-7ccf-48f8-aa87-704bad0e0e16\")) {\n+            scopes = \"https://devicemgmt.teams.microsoft.com/.default \" + BaseController.getDelimitedDefaultScopeString();", "originalCommit": "1f01d87a35bb4ce9331fe0827fd46e83d3eb965d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM2OTE5Mg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1140#discussion_r533369192", "bodyText": "same as above.", "author": "rpdome", "createdAt": "2020-12-01T12:24:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjgxMjM2Ng=="}], "type": "inlineReview", "revised_code": {"commit": "6b6f6def41dc682c3ce73b66ec03f91dd045060a", "chunk": "diff --git a/common/src/main/java/com/microsoft/identity/common/internal/migration/TokenCacheItemMigrationAdapter.java b/common/src/main/java/com/microsoft/identity/common/internal/migration/TokenCacheItemMigrationAdapter.java\nindex d383f865c..899b256eb 100644\n--- a/common/src/main/java/com/microsoft/identity/common/internal/migration/TokenCacheItemMigrationAdapter.java\n+++ b/common/src/main/java/com/microsoft/identity/common/internal/migration/TokenCacheItemMigrationAdapter.java\n\n@@ -192,8 +192,11 @@ public class TokenCacheItemMigrationAdapter {\n         // based on the RT (Which the given clientId might not be pre-authorized for).\n         // TODO: make pre-authorization of MSGraph User.read (and the default scopes) a requirement\n         //       for every FoCI apps (and hardcode it here).\n+        //       https://identitydivision.visualstudio.com/Engineering/_workitems/edit/1222002\n         if (TextUtils.equals(clientId, \"87749df4-7ccf-48f8-aa87-704bad0e0e16\")) {\n             scopes = \"https://devicemgmt.teams.microsoft.com/.default \" + BaseController.getDelimitedDefaultScopeString();\n+            Logger.info(TAG + methodName,\n+                    \"Teams agent client ID - making a test request with teams agent resource.\");\n         } else {\n             scopes = BaseController.getDelimitedDefaultScopeString();\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjgxNTYyMw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1140#discussion_r532815623", "bodyText": "Do we want a log statement here?", "author": "AdamBJohnsonx", "createdAt": "2020-11-30T18:38:43Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/migration/TokenCacheItemMigrationAdapter.java", "diffHunk": "@@ -185,7 +185,18 @@ public static boolean tryFociTokenWithGivenClientId(@SuppressWarnings(WarningTyp\n         final MicrosoftStsOAuth2Strategy strategy = new MicrosoftStsOAuth2Strategy(config, strategyParameters);\n \n         final String refreshToken = refreshTokenRecord.getSecret();\n-        final String scopes = BaseController.getDelimitedDefaultScopeString();\n+\n+        final String scopes;\n+        // Hardcoding Teams Agent's client ID with the scope it's pre-authorized for.\n+        // This is because if only the default scope is passed, eSTS will set the resource ID (on its side)\n+        // based on the RT (Which the given clientId might not be pre-authorized for).\n+        // TODO: make pre-authorization of MSGraph User.read (and the default scopes) a requirement\n+        //       for every FoCI apps (and hardcode it here).\n+        if (TextUtils.equals(clientId, \"87749df4-7ccf-48f8-aa87-704bad0e0e16\")) {", "originalCommit": "1f01d87a35bb4ce9331fe0827fd46e83d3eb965d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6b6f6def41dc682c3ce73b66ec03f91dd045060a", "chunk": "diff --git a/common/src/main/java/com/microsoft/identity/common/internal/migration/TokenCacheItemMigrationAdapter.java b/common/src/main/java/com/microsoft/identity/common/internal/migration/TokenCacheItemMigrationAdapter.java\nindex d383f865c..899b256eb 100644\n--- a/common/src/main/java/com/microsoft/identity/common/internal/migration/TokenCacheItemMigrationAdapter.java\n+++ b/common/src/main/java/com/microsoft/identity/common/internal/migration/TokenCacheItemMigrationAdapter.java\n\n@@ -192,8 +192,11 @@ public class TokenCacheItemMigrationAdapter {\n         // based on the RT (Which the given clientId might not be pre-authorized for).\n         // TODO: make pre-authorization of MSGraph User.read (and the default scopes) a requirement\n         //       for every FoCI apps (and hardcode it here).\n+        //       https://identitydivision.visualstudio.com/Engineering/_workitems/edit/1222002\n         if (TextUtils.equals(clientId, \"87749df4-7ccf-48f8-aa87-704bad0e0e16\")) {\n             scopes = \"https://devicemgmt.teams.microsoft.com/.default \" + BaseController.getDelimitedDefaultScopeString();\n+            Logger.info(TAG + methodName,\n+                    \"Teams agent client ID - making a test request with teams agent resource.\");\n         } else {\n             scopes = BaseController.getDelimitedDefaultScopeString();\n         }\n"}}, {"oid": "6b6f6def41dc682c3ce73b66ec03f91dd045060a", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/6b6f6def41dc682c3ce73b66ec03f91dd045060a", "message": "Address comments", "committedDate": "2020-12-01T12:31:27Z", "type": "commit"}]}