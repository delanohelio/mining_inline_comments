{"pr_number": 868, "pr_title": "Closes #864 - Implements Client Clock Skew Mitigation for AT/PoP", "pr_createdAt": "2020-03-21T02:37:55Z", "pr_url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/868", "timeline": [{"oid": "a2c35f8b2762fa929f0f9eef69de054dc24ae148", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/a2c35f8b2762fa929f0f9eef69de054dc24ae148", "message": "WIP clock skew impl", "committedDate": "2020-03-21T01:57:00Z", "type": "commit"}, {"oid": "93d78ab3019f4127773d6baca99938bef01dc8de", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/93d78ab3019f4127773d6baca99938bef01dc8de", "message": "WIP -- Broker scenarios outstanding. The broker's context must be set on\nthe AuthenticationScheme object so that signing can complete", "committedDate": "2020-03-21T02:34:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk1MzgyOA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/868#discussion_r395953828", "bodyText": "TODO for interactive & silent cases", "author": "iambmelt", "createdAt": "2020-03-21T02:38:47Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/request/BrokerAcquireTokenSilentOperationParameters.java", "diffHunk": "@@ -181,6 +181,7 @@ public BrokerAcquireTokenSilentOperationParameters(@NonNull final BrokerAcquireT\n                         ? acquireTokenOperationParameters.getAuthenticationScheme()\n                         : new BearerAuthenticationSchemeInternal() // If null, assume Bearer for back-compat\n         );\n+        // TODO set the broker's context on the auth scheme...", "originalCommit": "93d78ab3019f4127773d6baca99938bef01dc8de", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "99a269796a8cdf8cbe51e7200a9d17ebf71905a3", "chunk": "diff --git a/common/src/main/java/com/microsoft/identity/common/internal/request/BrokerAcquireTokenSilentOperationParameters.java b/common/src/main/java/com/microsoft/identity/common/internal/request/BrokerAcquireTokenSilentOperationParameters.java\nindex 8ce7602a0..e81c257c3 100644\n--- a/common/src/main/java/com/microsoft/identity/common/internal/request/BrokerAcquireTokenSilentOperationParameters.java\n+++ b/common/src/main/java/com/microsoft/identity/common/internal/request/BrokerAcquireTokenSilentOperationParameters.java\n\n@@ -181,7 +181,6 @@ public class BrokerAcquireTokenSilentOperationParameters extends AcquireTokenSil\n                         ? acquireTokenOperationParameters.getAuthenticationScheme()\n                         : new BearerAuthenticationSchemeInternal() // If null, assume Bearer for back-compat\n         );\n-        // TODO set the broker's context on the auth scheme...\n     }\n \n     @Override\n"}}, {"oid": "79344415db8b7e2af86bac0e67433352c8fa3bfc", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/79344415db8b7e2af86bac0e67433352c8fa3bfc", "message": "Broker arg setting", "committedDate": "2020-03-21T03:03:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY3OTY3MQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/868#discussion_r396679671", "bodyText": "Update the javadoc here to specify if this is millis or secs", "author": "iambmelt", "createdAt": "2020-03-23T18:47:45Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/platform/DevicePopManager.java", "diffHunk": "@@ -443,6 +443,7 @@ public void run() {\n \n     @Override\n     public String mintSignedAccessToken(@NonNull final String httpMethod,\n+                                        final long timestamp,", "originalCommit": "79344415db8b7e2af86bac0e67433352c8fa3bfc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY4ODg2Mw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/868#discussion_r396688863", "bodyText": "Added in 33fd57e", "author": "iambmelt", "createdAt": "2020-03-23T19:03:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY3OTY3MQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "33fd57e65cb3865fa29dd48d6900b99068dc2b9e", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/33fd57e65cb3865fa29dd48d6900b99068dc2b9e", "message": "Update javadoc", "committedDate": "2020-03-23T19:01:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY4OTEyMg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/868#discussion_r396689122", "bodyText": "Use a constant", "author": "iambmelt", "createdAt": "2020-03-23T19:03:57Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/authscheme/PopAuthenticationSchemeInternal.java", "diffHunk": "@@ -71,27 +77,38 @@\n         super(SCHEME_POP);\n     }\n \n-    PopAuthenticationSchemeInternal(@NonNull final String httpMethod,\n+    PopAuthenticationSchemeInternal(@NonNull Context context,\n+                                    @NonNull final String httpMethod,\n                                     @NonNull final URL url,\n                                     @Nullable final String nonce) {\n         super(SCHEME_POP);\n+        mContext = context;\n         mHttpMethod = httpMethod;\n         mUrl = url;\n         mNonce = nonce;\n     }\n \n     @Override\n     public String getAccessTokenForScheme(@NonNull final String accessToken) throws ClientException {\n+        // Use the provided context to get the skew\n+        final IClockSkewManager clockSkewManager = new ClockSkewManager(mContext);\n+        final long timestampMillis = clockSkewManager.getAdjustedReferenceTime().getTime();\n+\n         return Device\n                 .getDevicePoPManagerInstance()\n                 .mintSignedAccessToken(\n                         getHttpMethod(),\n+                        timestampMillis / 1000L,", "originalCommit": "79344415db8b7e2af86bac0e67433352c8fa3bfc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njc0MzQ5NA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/868#discussion_r396743494", "bodyText": "Resolved in c37caba", "author": "iambmelt", "createdAt": "2020-03-23T20:41:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY4OTEyMg=="}], "type": "inlineReview", "revised_code": {"commit": "c37cabaaf4967c3041158eb75423a44256fca06f", "chunk": "diff --git a/common/src/main/java/com/microsoft/identity/common/internal/authscheme/PopAuthenticationSchemeInternal.java b/common/src/main/java/com/microsoft/identity/common/internal/authscheme/PopAuthenticationSchemeInternal.java\nindex 753ecaddb..ddfff8d2f 100644\n--- a/common/src/main/java/com/microsoft/identity/common/internal/authscheme/PopAuthenticationSchemeInternal.java\n+++ b/common/src/main/java/com/microsoft/identity/common/internal/authscheme/PopAuthenticationSchemeInternal.java\n\n@@ -90,6 +90,8 @@ public class PopAuthenticationSchemeInternal\n \n     @Override\n     public String getAccessTokenForScheme(@NonNull final String accessToken) throws ClientException {\n+        final long ONE_SECOND_MILLIS = 1000L;\n+\n         // Use the provided context to get the skew\n         final IClockSkewManager clockSkewManager = new ClockSkewManager(mContext);\n         final long timestampMillis = clockSkewManager.getAdjustedReferenceTime().getTime();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY4OTE5NA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/868#discussion_r396689194", "bodyText": "nit: final", "author": "iambmelt", "createdAt": "2020-03-23T19:04:04Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/authscheme/PopAuthenticationSchemeInternal.java", "diffHunk": "@@ -71,27 +77,38 @@\n         super(SCHEME_POP);\n     }\n \n-    PopAuthenticationSchemeInternal(@NonNull final String httpMethod,\n+    PopAuthenticationSchemeInternal(@NonNull Context context,\n+                                    @NonNull final String httpMethod,\n                                     @NonNull final URL url,\n                                     @Nullable final String nonce) {\n         super(SCHEME_POP);\n+        mContext = context;\n         mHttpMethod = httpMethod;\n         mUrl = url;\n         mNonce = nonce;\n     }\n \n     @Override\n     public String getAccessTokenForScheme(@NonNull final String accessToken) throws ClientException {\n+        // Use the provided context to get the skew\n+        final IClockSkewManager clockSkewManager = new ClockSkewManager(mContext);\n+        final long timestampMillis = clockSkewManager.getAdjustedReferenceTime().getTime();\n+\n         return Device\n                 .getDevicePoPManagerInstance()\n                 .mintSignedAccessToken(\n                         getHttpMethod(),\n+                        timestampMillis / 1000L,\n                         getUrl(),\n                         accessToken,\n                         getNonce()\n                 );\n     }\n \n+    public void setContext(Context context) {", "originalCommit": "79344415db8b7e2af86bac0e67433352c8fa3bfc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njc0NDM5Ng==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/868#discussion_r396744396", "bodyText": "Resolved in 5e9f835", "author": "iambmelt", "createdAt": "2020-03-23T20:43:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY4OTE5NA=="}], "type": "inlineReview", "revised_code": {"commit": "c37cabaaf4967c3041158eb75423a44256fca06f", "chunk": "diff --git a/common/src/main/java/com/microsoft/identity/common/internal/authscheme/PopAuthenticationSchemeInternal.java b/common/src/main/java/com/microsoft/identity/common/internal/authscheme/PopAuthenticationSchemeInternal.java\nindex 753ecaddb..ddfff8d2f 100644\n--- a/common/src/main/java/com/microsoft/identity/common/internal/authscheme/PopAuthenticationSchemeInternal.java\n+++ b/common/src/main/java/com/microsoft/identity/common/internal/authscheme/PopAuthenticationSchemeInternal.java\n\n@@ -90,6 +90,8 @@ public class PopAuthenticationSchemeInternal\n \n     @Override\n     public String getAccessTokenForScheme(@NonNull final String accessToken) throws ClientException {\n+        final long ONE_SECOND_MILLIS = 1000L;\n+\n         // Use the provided context to get the skew\n         final IClockSkewManager clockSkewManager = new ClockSkewManager(mContext);\n         final long timestampMillis = clockSkewManager.getAdjustedReferenceTime().getTime();\n"}}, {"oid": "c37cabaaf4967c3041158eb75423a44256fca06f", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/c37cabaaf4967c3041158eb75423a44256fca06f", "message": "Adds a constant for millis -> second conversion", "committedDate": "2020-03-23T20:40:29Z", "type": "commit"}, {"oid": "5e9f835f00c4107b012bc3e536f8e58a24ee265c", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/5e9f835f00c4107b012bc3e536f8e58a24ee265c", "message": "Adds final + nullability annot to method input", "committedDate": "2020-03-23T20:42:28Z", "type": "commit"}, {"oid": "1218c9f868bfb016a816065b3a3f880d9341fee5", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/1218c9f868bfb016a816065b3a3f880d9341fee5", "message": "Add tests", "committedDate": "2020-03-23T21:38:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkxNzY4Nw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/868#discussion_r396917687", "bodyText": "Add a comment explaining what's going on here.\nIt would be preferable to have some kind of SkewProvider object here that removes the tight-coupling between the pop auth scheme and the data source", "author": "iambmelt", "createdAt": "2020-03-24T05:59:58Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/request/MsalBrokerRequestAdapter.java", "diffHunk": "@@ -143,13 +143,19 @@ public BrokerRequest brokerRequestFromSilentOperationParameters(@NonNull final A\n     }\n \n     @NonNull\n-    private static AbstractAuthenticationScheme getAuthenticationScheme(@NonNull final BrokerRequest request) {\n+    private static AbstractAuthenticationScheme getAuthenticationScheme(\n+            @NonNull final Context context,\n+            @NonNull final BrokerRequest request) {\n         final AbstractAuthenticationScheme requestScheme = request.getAuthenticationScheme();\n \n         if (null == requestScheme) {\n             // Default assumes the scheme is Bearer\n             return new BearerAuthenticationSchemeInternal();\n         } else {\n+            if (requestScheme instanceof PopAuthenticationSchemeInternal) {\n+                ((PopAuthenticationSchemeInternal) requestScheme).setContext(context);", "originalCommit": "1218c9f868bfb016a816065b3a3f880d9341fee5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUxMjY5Ng==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/868#discussion_r397512696", "bodyText": "Tidied up a bit in: dff1332", "author": "iambmelt", "createdAt": "2020-03-24T23:00:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkxNzY4Nw=="}], "type": "inlineReview", "revised_code": {"commit": "dff13326e369b599f0ea4aa483c401431b56076b", "chunk": "diff --git a/common/src/main/java/com/microsoft/identity/common/internal/request/MsalBrokerRequestAdapter.java b/common/src/main/java/com/microsoft/identity/common/internal/request/MsalBrokerRequestAdapter.java\nindex 5df03b4d0..feee87033 100644\n--- a/common/src/main/java/com/microsoft/identity/common/internal/request/MsalBrokerRequestAdapter.java\n+++ b/common/src/main/java/com/microsoft/identity/common/internal/request/MsalBrokerRequestAdapter.java\n\n@@ -153,7 +155,8 @@ public class MsalBrokerRequestAdapter implements IBrokerRequestAdapter {\n             return new BearerAuthenticationSchemeInternal();\n         } else {\n             if (requestScheme instanceof PopAuthenticationSchemeInternal) {\n-                ((PopAuthenticationSchemeInternal) requestScheme).setContext(context);\n+                final IClockSkewManager clockSkewManager = new ClockSkewManager(context);\n+                ((PopAuthenticationSchemeInternal) requestScheme).setClockSkewManager(clockSkewManager);\n             }\n \n             return requestScheme;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkxNzc4MA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/868#discussion_r396917780", "bodyText": "Junk comment, remove", "author": "iambmelt", "createdAt": "2020-03-24T06:00:18Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/request/BrokerAcquireTokenSilentOperationParameters.java", "diffHunk": "@@ -181,6 +181,7 @@ public BrokerAcquireTokenSilentOperationParameters(@NonNull final BrokerAcquireT\n                         ? acquireTokenOperationParameters.getAuthenticationScheme()\n                         : new BearerAuthenticationSchemeInternal() // If null, assume Bearer for back-compat\n         );\n+        // TODO set the broker's context on the auth scheme...", "originalCommit": "1218c9f868bfb016a816065b3a3f880d9341fee5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM0NDQxNg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/868#discussion_r397344416", "bodyText": "Removed in 99a2697", "author": "iambmelt", "createdAt": "2020-03-24T17:43:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkxNzc4MA=="}], "type": "inlineReview", "revised_code": {"commit": "99a269796a8cdf8cbe51e7200a9d17ebf71905a3", "chunk": "diff --git a/common/src/main/java/com/microsoft/identity/common/internal/request/BrokerAcquireTokenSilentOperationParameters.java b/common/src/main/java/com/microsoft/identity/common/internal/request/BrokerAcquireTokenSilentOperationParameters.java\nindex 8ce7602a0..e81c257c3 100644\n--- a/common/src/main/java/com/microsoft/identity/common/internal/request/BrokerAcquireTokenSilentOperationParameters.java\n+++ b/common/src/main/java/com/microsoft/identity/common/internal/request/BrokerAcquireTokenSilentOperationParameters.java\n\n@@ -181,7 +181,6 @@ public class BrokerAcquireTokenSilentOperationParameters extends AcquireTokenSil\n                         ? acquireTokenOperationParameters.getAuthenticationScheme()\n                         : new BearerAuthenticationSchemeInternal() // If null, assume Bearer for back-compat\n         );\n-        // TODO set the broker's context on the auth scheme...\n     }\n \n     @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkxNzk5Mg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/868#discussion_r396917992", "bodyText": "Extract to a method", "author": "iambmelt", "createdAt": "2020-03-24T06:00:57Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/providers/oauth2/OAuth2Strategy.java", "diffHunk": "@@ -162,12 +172,18 @@ protected HttpResponse performTokenRequest(final GenericTokenRequest request) th\n         headers.putAll(Device.getPlatformIdParameters());\n         headers.putAll(EstsTelemetry.getInstance().getTelemetryHeaders());\n \n-        return HttpRequest.sendPost(\n+        final HttpResponse response = HttpRequest.sendPost(\n                 new URL(mTokenEndpoint),\n                 headers,\n                 requestBody.getBytes(ObjectMapper.ENCODING_SCHEME),\n                 TOKEN_REQUEST_CONTENT_TYPE\n         );\n+\n+        if (null != mClockSkewManager && null != response.getDate()) {", "originalCommit": "1218c9f868bfb016a816065b3a3f880d9341fee5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUwNzMyNw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/868#discussion_r397507327", "bodyText": "Cleaned up in 78c0b0b", "author": "iambmelt", "createdAt": "2020-03-24T22:46:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkxNzk5Mg=="}], "type": "inlineReview", "revised_code": {"commit": "78c0b0bfaaaacd9c874142080ba47d3044dd6c97", "chunk": "diff --git a/common/src/main/java/com/microsoft/identity/common/internal/providers/oauth2/OAuth2Strategy.java b/common/src/main/java/com/microsoft/identity/common/internal/providers/oauth2/OAuth2Strategy.java\nindex b29435c11..513a10e29 100644\n--- a/common/src/main/java/com/microsoft/identity/common/internal/providers/oauth2/OAuth2Strategy.java\n+++ b/common/src/main/java/com/microsoft/identity/common/internal/providers/oauth2/OAuth2Strategy.java\n\n@@ -179,13 +179,20 @@ public abstract class OAuth2Strategy\n                 TOKEN_REQUEST_CONTENT_TYPE\n         );\n \n-        if (null != mClockSkewManager && null != response.getDate()) {\n-            mClockSkewManager.onTimestampReceived(response.getDate().getTime());\n+        // Record the clock skew between *this device* and EVO...\n+        if (null != response.getDate()) {\n+            recordClockSkew(response.getDate().getTime());\n         }\n \n         return response;\n     }\n \n+    private void recordClockSkew(final long referenceTimeMillis) {\n+        if (null != mClockSkewManager) {\n+            mClockSkewManager.onTimestampReceived(referenceTimeMillis);\n+        }\n+    }\n+\n     protected final void setTokenEndpoint(final String tokenEndpoint) {\n         mTokenEndpoint = tokenEndpoint;\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkxODA3MQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/868#discussion_r396918071", "bodyText": "Log info", "author": "iambmelt", "createdAt": "2020-03-24T06:01:14Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/providers/oauth2/OAuth2Strategy.java", "diffHunk": "@@ -88,6 +91,13 @@ public OAuth2Strategy(GenericOAuth2Configuration config,\n                           GenericOAuth2StrategyParameters strategyParameters) {\n         mConfig = config;\n         mStrategyParameters = strategyParameters;\n+\n+        if (null != mStrategyParameters.getContext()) {\n+            mClockSkewManager = new ClockSkewManager(mStrategyParameters.getContext());\n+        } else {\n+            // No valid context to persist clock skew with!", "originalCommit": "1218c9f868bfb016a816065b3a3f880d9341fee5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUwODQ5Ng==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/868#discussion_r397508496", "bodyText": "9a5fb46", "author": "iambmelt", "createdAt": "2020-03-24T22:49:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkxODA3MQ=="}], "type": "inlineReview", "revised_code": {"commit": "9a5fb46226ca56f6acb1021fc559e4d5a3e3050c", "chunk": "diff --git a/common/src/main/java/com/microsoft/identity/common/internal/providers/oauth2/OAuth2Strategy.java b/common/src/main/java/com/microsoft/identity/common/internal/providers/oauth2/OAuth2Strategy.java\nindex b29435c11..92c8d436e 100644\n--- a/common/src/main/java/com/microsoft/identity/common/internal/providers/oauth2/OAuth2Strategy.java\n+++ b/common/src/main/java/com/microsoft/identity/common/internal/providers/oauth2/OAuth2Strategy.java\n\n@@ -95,7 +95,7 @@ public abstract class OAuth2Strategy\n         if (null != mStrategyParameters.getContext()) {\n             mClockSkewManager = new ClockSkewManager(mStrategyParameters.getContext());\n         } else {\n-            // No valid context to persist clock skew with!\n+            Logger.info(TAG, \"No valid context to persist clock skew with!\");\n             mClockSkewManager = null;\n         }\n     }\n"}}, {"oid": "8e472128dce6cdb734c76fcdc49a1c6af596d5e1", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/8e472128dce6cdb734c76fcdc49a1c6af596d5e1", "message": "Merge branch 'dev' into iambmelt/864", "committedDate": "2020-03-24T17:40:43Z", "type": "commit"}, {"oid": "99a269796a8cdf8cbe51e7200a9d17ebf71905a3", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/99a269796a8cdf8cbe51e7200a9d17ebf71905a3", "message": "Remove stray comment", "committedDate": "2020-03-24T17:42:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM2NTI1Mg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/868#discussion_r397365252", "bodyText": "Curious: why do we need a separate interface? Do you foresee having another ClockSkewManager?", "author": "rpdome", "createdAt": "2020-03-24T18:16:06Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/util/IClockSkewManager.java", "diffHunk": "@@ -0,0 +1,81 @@\n+//  Copyright (c) Microsoft Corporation.\n+//  All rights reserved.\n+//\n+//  This code is licensed under the MIT License.\n+//\n+//  Permission is hereby granted, free of charge, to any person obtaining a copy\n+//  of this software and associated documentation files(the \"Software\"), to deal\n+//  in the Software without restriction, including without limitation the rights\n+//  to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+//  copies of the Software, and to permit persons to whom the Software is\n+//  furnished to do so, subject to the following conditions :\n+//\n+//  The above copyright notice and this permission notice shall be included in\n+//  all copies or substantial portions of the Software.\n+//\n+//  THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+//  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+//  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+//  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+//  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+//  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+//  THE SOFTWARE.\n+package com.microsoft.identity.common.internal.util;\n+\n+import java.util.Date;\n+\n+/**\n+ * Provides functionality related to calculating and storing server clock skews for client\n+ * synchronization.\n+ */\n+public interface IClockSkewManager {", "originalCommit": "99a269796a8cdf8cbe51e7200a9d17ebf71905a3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ5NTE1OA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/868#discussion_r397495158", "bodyText": "In general it's good to provide an interface for any object that hits network or a data store. In this case, we're hitting a data store (sharedpreferences) so I've provided an interface", "author": "iambmelt", "createdAt": "2020-03-24T22:16:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM2NTI1Mg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ5ODkzMw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/868#discussion_r397498933", "bodyText": "nit: Rename to context", "author": "shahzaibj", "createdAt": "2020-03-24T22:25:38Z", "path": "common/src/androidTest/java/com/microsoft/identity/common/ClockSkewManagerTest.java", "diffHunk": "@@ -0,0 +1,132 @@\n+//  Copyright (c) Microsoft Corporation.\n+//  All rights reserved.\n+//\n+//  This code is licensed under the MIT License.\n+//\n+//  Permission is hereby granted, free of charge, to any person obtaining a copy\n+//  of this software and associated documentation files(the \"Software\"), to deal\n+//  in the Software without restriction, including without limitation the rights\n+//  to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+//  copies of the Software, and to permit persons to whom the Software is\n+//  furnished to do so, subject to the following conditions :\n+//\n+//  The above copyright notice and this permission notice shall be included in\n+//  all copies or substantial portions of the Software.\n+//\n+//  THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+//  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+//  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+//  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+//  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+//  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+//  THE SOFTWARE.\n+package com.microsoft.identity.common;\n+\n+import android.content.Context;\n+\n+import androidx.test.InstrumentationRegistry;\n+import androidx.test.ext.junit.runners.AndroidJUnit4;\n+\n+import com.microsoft.identity.common.internal.util.ClockSkewManager;\n+import com.microsoft.identity.common.internal.util.IClockSkewManager;\n+\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+\n+import java.util.Date;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+@RunWith(AndroidJUnit4.class)\n+public class ClockSkewManagerTest {\n+\n+    private Context sContext;", "originalCommit": "99a269796a8cdf8cbe51e7200a9d17ebf71905a3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ5OTAwMg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/868#discussion_r397499002", "bodyText": "as it's not static", "author": "shahzaibj", "createdAt": "2020-03-24T22:25:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ5ODkzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUwMzAxNw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/868#discussion_r397503017", "bodyText": "Sure", "author": "iambmelt", "createdAt": "2020-03-24T22:35:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ5ODkzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUwMzY0MQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/868#discussion_r397503641", "bodyText": "7ceaf62", "author": "iambmelt", "createdAt": "2020-03-24T22:37:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ5ODkzMw=="}], "type": "inlineReview", "revised_code": {"commit": "7ceaf623f3ea9d34cc3c44bbcb2b8f831d59e075", "chunk": "diff --git a/common/src/androidTest/java/com/microsoft/identity/common/ClockSkewManagerTest.java b/common/src/androidTest/java/com/microsoft/identity/common/ClockSkewManagerTest.java\nindex 57e40ceef..3e03c5eba 100644\n--- a/common/src/androidTest/java/com/microsoft/identity/common/ClockSkewManagerTest.java\n+++ b/common/src/androidTest/java/com/microsoft/identity/common/ClockSkewManagerTest.java\n\n@@ -42,28 +42,28 @@ import static org.junit.Assert.assertEquals;\n @RunWith(AndroidJUnit4.class)\n public class ClockSkewManagerTest {\n \n-    private Context sContext;\n-    private static IClockSkewManager sClockSkewMgr;\n+    private Context context;\n+    private IClockSkewManager clockSkewManager;\n \n     @Before\n     public void setUp() {\n-        sContext = InstrumentationRegistry.getTargetContext();\n+        context = InstrumentationRegistry.getTargetContext();\n     }\n \n     @After\n     public void tearDown() {\n         // Reset the skew to 0\n-        if (null != sClockSkewMgr) {\n-            sClockSkewMgr.onTimestampReceived(0L);\n+        if (null != clockSkewManager) {\n+            clockSkewManager.onTimestampReceived(0L);\n         }\n \n         // Reset the Context\n-        sContext = null;\n+        context = null;\n     }\n \n     @Test\n     public void testOnTimestampReceived() {\n-        sClockSkewMgr = new ClockSkewManager(sContext) {\n+        clockSkewManager = new ClockSkewManager(context) {\n             @Override\n             public Date getCurrentClientTime() {\n                 return new Date(12345);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ5OTU5Mw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/868#discussion_r397499593", "bodyText": "Does this need to be static?", "author": "shahzaibj", "createdAt": "2020-03-24T22:27:11Z", "path": "common/src/androidTest/java/com/microsoft/identity/common/ClockSkewManagerTest.java", "diffHunk": "@@ -0,0 +1,132 @@\n+//  Copyright (c) Microsoft Corporation.\n+//  All rights reserved.\n+//\n+//  This code is licensed under the MIT License.\n+//\n+//  Permission is hereby granted, free of charge, to any person obtaining a copy\n+//  of this software and associated documentation files(the \"Software\"), to deal\n+//  in the Software without restriction, including without limitation the rights\n+//  to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+//  copies of the Software, and to permit persons to whom the Software is\n+//  furnished to do so, subject to the following conditions :\n+//\n+//  The above copyright notice and this permission notice shall be included in\n+//  all copies or substantial portions of the Software.\n+//\n+//  THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+//  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+//  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+//  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+//  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+//  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+//  THE SOFTWARE.\n+package com.microsoft.identity.common;\n+\n+import android.content.Context;\n+\n+import androidx.test.InstrumentationRegistry;\n+import androidx.test.ext.junit.runners.AndroidJUnit4;\n+\n+import com.microsoft.identity.common.internal.util.ClockSkewManager;\n+import com.microsoft.identity.common.internal.util.IClockSkewManager;\n+\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+\n+import java.util.Date;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+@RunWith(AndroidJUnit4.class)\n+public class ClockSkewManagerTest {\n+\n+    private Context sContext;\n+    private static IClockSkewManager sClockSkewMgr;", "originalCommit": "99a269796a8cdf8cbe51e7200a9d17ebf71905a3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUwMzA5OA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/868#discussion_r397503098", "bodyText": "Nope will update", "author": "iambmelt", "createdAt": "2020-03-24T22:36:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ5OTU5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUwMzYwMQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/868#discussion_r397503601", "bodyText": "7ceaf62", "author": "iambmelt", "createdAt": "2020-03-24T22:37:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ5OTU5Mw=="}], "type": "inlineReview", "revised_code": {"commit": "7ceaf623f3ea9d34cc3c44bbcb2b8f831d59e075", "chunk": "diff --git a/common/src/androidTest/java/com/microsoft/identity/common/ClockSkewManagerTest.java b/common/src/androidTest/java/com/microsoft/identity/common/ClockSkewManagerTest.java\nindex 57e40ceef..3e03c5eba 100644\n--- a/common/src/androidTest/java/com/microsoft/identity/common/ClockSkewManagerTest.java\n+++ b/common/src/androidTest/java/com/microsoft/identity/common/ClockSkewManagerTest.java\n\n@@ -42,28 +42,28 @@ import static org.junit.Assert.assertEquals;\n @RunWith(AndroidJUnit4.class)\n public class ClockSkewManagerTest {\n \n-    private Context sContext;\n-    private static IClockSkewManager sClockSkewMgr;\n+    private Context context;\n+    private IClockSkewManager clockSkewManager;\n \n     @Before\n     public void setUp() {\n-        sContext = InstrumentationRegistry.getTargetContext();\n+        context = InstrumentationRegistry.getTargetContext();\n     }\n \n     @After\n     public void tearDown() {\n         // Reset the skew to 0\n-        if (null != sClockSkewMgr) {\n-            sClockSkewMgr.onTimestampReceived(0L);\n+        if (null != clockSkewManager) {\n+            clockSkewManager.onTimestampReceived(0L);\n         }\n \n         // Reset the Context\n-        sContext = null;\n+        context = null;\n     }\n \n     @Test\n     public void testOnTimestampReceived() {\n-        sClockSkewMgr = new ClockSkewManager(sContext) {\n+        clockSkewManager = new ClockSkewManager(context) {\n             @Override\n             public Date getCurrentClientTime() {\n                 return new Date(12345);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUwMTQwNg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/868#discussion_r397501406", "bodyText": "Why still using String internally?", "author": "shahzaibj", "createdAt": "2020-03-24T22:31:41Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/cache/SharedPreferencesFileManager.java", "diffHunk": "@@ -158,6 +158,22 @@ public final String getString(final String key) {\n         return restoredValue;\n     }\n \n+    @Override\n+    public void putLong(final String key, final long value) {\n+        putString(key, String.valueOf(value));", "originalCommit": "99a269796a8cdf8cbe51e7200a9d17ebf71905a3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUwMjQ0OA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/868#discussion_r397502448", "bodyText": "so it can be optionally encrypted", "author": "iambmelt", "createdAt": "2020-03-24T22:34:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUwMTQwNg=="}], "type": "inlineReview", "revised_code": null}, {"oid": "7ceaf623f3ea9d34cc3c44bbcb2b8f831d59e075", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/7ceaf623f3ea9d34cc3c44bbcb2b8f831d59e075", "message": "Var renames", "committedDate": "2020-03-24T22:36:22Z", "type": "commit"}, {"oid": "78c0b0bfaaaacd9c874142080ba47d3044dd6c97", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/78c0b0bfaaaacd9c874142080ba47d3044dd6c97", "message": "Adding comment + moving to own method", "committedDate": "2020-03-24T22:46:16Z", "type": "commit"}, {"oid": "9a5fb46226ca56f6acb1021fc559e4d5a3e3050c", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/9a5fb46226ca56f6acb1021fc559e4d5a3e3050c", "message": "Adding logging", "committedDate": "2020-03-24T22:48:15Z", "type": "commit"}, {"oid": "44423b149074a898862467ab380bad2cbc79dfb4", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/44423b149074a898862467ab380bad2cbc79dfb4", "message": "Make param final", "committedDate": "2020-03-24T22:54:03Z", "type": "commit"}, {"oid": "dff13326e369b599f0ea4aa483c401431b56076b", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/dff13326e369b599f0ea4aa483c401431b56076b", "message": "Remove tight coupling between auth scheme and context", "committedDate": "2020-03-24T22:59:34Z", "type": "commit"}]}