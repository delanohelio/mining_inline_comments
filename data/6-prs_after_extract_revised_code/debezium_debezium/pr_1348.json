{"pr_number": 1348, "pr_title": "DBZ-1874 Stablize MongoDB transaction metadata support", "pr_createdAt": "2020-03-17T14:40:46Z", "pr_url": "https://github.com/debezium/debezium/pull/1348", "timeline": [{"oid": "bad0852b531153d86ad1ed905e320edd3b896cc4", "url": "https://github.com/debezium/debezium/commit/bad0852b531153d86ad1ed905e320edd3b896cc4", "message": "DBZ-1874 Stablize MongoDB transaction metadata support\n\n* Added TransactionMetadataIT use test\n* Correctly resolve transaction metadata and field emission", "committedDate": "2020-03-17T14:40:21Z", "type": "commit"}, {"oid": "b82f70463cc7ca8f7893d9ae5a563bc941fa329d", "url": "https://github.com/debezium/debezium/commit/b82f70463cc7ca8f7893d9ae5a563bc941fa329d", "message": "DBZ-1874 Add check for tx support in test.", "committedDate": "2020-03-17T15:31:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzc4MTc3Nw==", "url": "https://github.com/debezium/debezium/pull/1348#discussion_r393781777", "bodyText": "This looks a bit suspicious; shouldn't at least the var name (txOrder) be adjusted, too?", "author": "gunnarmorling", "createdAt": "2020-03-17T15:51:03Z", "path": "debezium-connector-mongodb/src/main/java/io/debezium/connector/mongodb/MongoDbEventMetadataProvider.java", "diffHunk": "@@ -59,7 +59,7 @@ public String getTransactionId(DataCollectionId source, OffsetContext offset, Ob\n         if (source == null) {\n             return null;\n         }\n-        final Long txOrder = sourceInfo.getInt64(SourceInfo.TX_ORD);\n+        final Long txOrder = sourceInfo.getInt64(SourceInfo.OPERATION_ID);", "originalCommit": "bad0852b531153d86ad1ed905e320edd3b896cc4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e5bbe3edade4d0cf4ed8703183c6f89273ec2a98", "chunk": "diff --git a/debezium-connector-mongodb/src/main/java/io/debezium/connector/mongodb/MongoDbEventMetadataProvider.java b/debezium-connector-mongodb/src/main/java/io/debezium/connector/mongodb/MongoDbEventMetadataProvider.java\nindex 949e1444d..daaa49405 100644\n--- a/debezium-connector-mongodb/src/main/java/io/debezium/connector/mongodb/MongoDbEventMetadataProvider.java\n+++ b/debezium-connector-mongodb/src/main/java/io/debezium/connector/mongodb/MongoDbEventMetadataProvider.java\n\n@@ -59,10 +59,10 @@ public String getTransactionId(DataCollectionId source, OffsetContext offset, Ob\n         if (source == null) {\n             return null;\n         }\n-        final Long txOrder = sourceInfo.getInt64(SourceInfo.OPERATION_ID);\n-        if (txOrder == null) {\n+        final Long operationId = sourceInfo.getInt64(SourceInfo.OPERATION_ID);\n+        if (operationId == null) {\n             return null;\n         }\n-        return Long.toString(txOrder);\n+        return Long.toString(operationId);\n     }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzgyNjEyMg==", "url": "https://github.com/debezium/debezium/pull/1348#discussion_r393826122", "bodyText": "Maybe extract \"h\" into a constant, to give it some meaning?", "author": "gunnarmorling", "createdAt": "2020-03-17T16:53:11Z", "path": "debezium-connector-mongodb/src/main/java/io/debezium/connector/mongodb/MongoDbStreamingChangeEventSource.java", "diffHunk": "@@ -300,7 +300,7 @@ private boolean handleOplogEvent(ServerAddress primaryAddress, Document event, D\n                 return true;\n             }\n             try {\n-                dispatcher.dispatchTransactionStartedEvent(Long.toString(txOrder), oplogContext.getOffset());\n+                dispatcher.dispatchTransactionStartedEvent(Long.toString(event.getLong(\"h\")), oplogContext.getOffset());", "originalCommit": "bad0852b531153d86ad1ed905e320edd3b896cc4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e5bbe3edade4d0cf4ed8703183c6f89273ec2a98", "chunk": "diff --git a/debezium-connector-mongodb/src/main/java/io/debezium/connector/mongodb/MongoDbStreamingChangeEventSource.java b/debezium-connector-mongodb/src/main/java/io/debezium/connector/mongodb/MongoDbStreamingChangeEventSource.java\nindex f80d1b42d..1dd5b13ea 100644\n--- a/debezium-connector-mongodb/src/main/java/io/debezium/connector/mongodb/MongoDbStreamingChangeEventSource.java\n+++ b/debezium-connector-mongodb/src/main/java/io/debezium/connector/mongodb/MongoDbStreamingChangeEventSource.java\n\n@@ -300,7 +300,8 @@ private boolean handleOplogEvent(ServerAddress primaryAddress, Document event, D\n                 return true;\n             }\n             try {\n-                dispatcher.dispatchTransactionStartedEvent(Long.toString(event.getLong(\"h\")), oplogContext.getOffset());\n+                final Long operationId = event.getLong(SourceInfo.OPERATION_ID);\n+                dispatcher.dispatchTransactionStartedEvent(Long.toString(operationId), oplogContext.getOffset());\n                 for (Document change : txChanges) {\n                     final boolean r = handleOplogEvent(primaryAddress, change, event, ++txOrder, oplogContext);\n                     if (!r) {\n"}}, {"oid": "e5bbe3edade4d0cf4ed8703183c6f89273ec2a98", "url": "https://github.com/debezium/debezium/commit/e5bbe3edade4d0cf4ed8703183c6f89273ec2a98", "message": "DBZ-1874 Recommended changes", "committedDate": "2020-03-17T19:50:02Z", "type": "commit"}, {"oid": "1cfeb90066ece01f4212b821cf6eb4241ea01380", "url": "https://github.com/debezium/debezium/commit/1cfeb90066ece01f4212b821cf6eb4241ea01380", "message": "DBZ-1880 Fix compatibility with event metadata and V1 source info block", "committedDate": "2020-03-17T19:51:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk2NjQzMg==", "url": "https://github.com/debezium/debezium/pull/1348#discussion_r393966432", "bodyText": "Isn't the units for the \"sec\" field second, not microseconds?", "author": "jgraf50", "createdAt": "2020-03-17T20:58:23Z", "path": "debezium-connector-mongodb/src/main/java/io/debezium/connector/mongodb/MongoDbEventMetadataProvider.java", "diffHunk": "@@ -32,6 +33,10 @@ public Instant getEventTimestamp(DataCollectionId source, OffsetContext offset,\n         if (source == null) {\n             return null;\n         }\n+        if (sourceInfo.schema().field(SourceInfo.TIMESTAMP) != null) {\n+            final Integer timestamp = sourceInfo.getInt32(SourceInfo.TIMESTAMP);\n+            return timestamp == null ? null : Conversions.toInstantFromMicros(timestamp);", "originalCommit": "1cfeb90066ece01f4212b821cf6eb4241ea01380", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDQwMTcxNw==", "url": "https://github.com/debezium/debezium/pull/1348#discussion_r394401717", "bodyText": "You're absolutely correct, the time value in the source-info block is seconds since epoch and so this should be changed.", "author": "Naros", "createdAt": "2020-03-18T14:46:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk2NjQzMg=="}], "type": "inlineReview", "revised_code": {"commit": "898ee8b7d6a5c9adad31c1a2e791ed3c19de1062", "chunk": "diff --git a/debezium-connector-mongodb/src/main/java/io/debezium/connector/mongodb/MongoDbEventMetadataProvider.java b/debezium-connector-mongodb/src/main/java/io/debezium/connector/mongodb/MongoDbEventMetadataProvider.java\nindex 16338cfcf..722380c4b 100644\n--- a/debezium-connector-mongodb/src/main/java/io/debezium/connector/mongodb/MongoDbEventMetadataProvider.java\n+++ b/debezium-connector-mongodb/src/main/java/io/debezium/connector/mongodb/MongoDbEventMetadataProvider.java\n\n@@ -35,7 +34,7 @@ public Instant getEventTimestamp(DataCollectionId source, OffsetContext offset,\n         }\n         if (sourceInfo.schema().field(SourceInfo.TIMESTAMP) != null) {\n             final Integer timestamp = sourceInfo.getInt32(SourceInfo.TIMESTAMP);\n-            return timestamp == null ? null : Conversions.toInstantFromMicros(timestamp);\n+            return timestamp == null ? null : Instant.ofEpochSecond(timestamp);\n         }\n         final Long timestamp = sourceInfo.getInt64(SourceInfo.TIMESTAMP_KEY);\n         return timestamp == null ? null : Instant.ofEpochMilli(timestamp);\n"}}, {"oid": "898ee8b7d6a5c9adad31c1a2e791ed3c19de1062", "url": "https://github.com/debezium/debezium/commit/898ee8b7d6a5c9adad31c1a2e791ed3c19de1062", "message": "DBZ-1874 Use seconds to get timestamp from legacy source info blocks", "committedDate": "2020-03-18T15:17:45Z", "type": "commit"}, {"oid": "89ac061861cb75aa30cd4f30540a68c541954ec5", "url": "https://github.com/debezium/debezium/commit/89ac061861cb75aa30cd4f30540a68c541954ec5", "message": "DBZ-1874 Resolve metrics test failures", "committedDate": "2020-03-18T18:18:26Z", "type": "commit"}]}