{"pr_number": 1654, "pr_title": "DBZ-2275: Updated default database history DML filter default to handle additional RDS statements", "pr_createdAt": "2020-06-24T16:43:51Z", "pr_url": "https://github.com/debezium/debezium/pull/1654", "timeline": [{"oid": "77ca68eb595ad460578ad4ebf8e77a7d7e770a22", "url": "https://github.com/debezium/debezium/commit/77ca68eb595ad460578ad4ebf8e77a7d7e770a22", "message": "DBZ-2275: Updated default database history DML filter default to handle additional RDS statements\n\nAdded two more regular expressions to the default database history DML filter. These are intended to catch and filter out `INSERT into mysql.rds_monitor\u2026` statements that RDS may write in the binlog.\n\nAdded a new unit test that checks that the regular expressions do catch some example statements.", "committedDate": "2020-06-24T16:37:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTM0MDk5NQ==", "url": "https://github.com/debezium/debezium/pull/1654#discussion_r445340995", "bodyText": "Why is that you read an explicit value from the properties file? Wouldn't it make more sense to assert that the default value (as per your change below) excludes those tables?", "author": "gunnarmorling", "createdAt": "2020-06-25T06:47:00Z", "path": "debezium-connector-mysql/src/test/java/io/debezium/connector/mysql/MySqlTaskContextTest.java", "diffHunk": "@@ -119,6 +120,20 @@ public void shouldCreateTaskFromConfigurationWithWhenNeededSnapshotMode() throws\n         assertThat(context.isSnapshotNeverAllowed()).isEqualTo(false);\n     }\n \n+    @Test\n+    public void shouldFilterInternalDmlStatements() throws Exception {\n+        // Load from a properties file to eliminate risk of improper escaping in Java literals\n+        Properties props = new Properties();\n+        props.load(Testing.Files.readResourceAsStream(\"dml-filter.properties\"));\n+        config = simpleConfig().with(MySqlConnectorConfig.SNAPSHOT_MODE, SnapshotMode.WHEN_NEEDED)\n+                .with(\"internal.database.history.ddl.filter\", props.get(\"internal.database.history.ddl.filter\"))", "originalCommit": "77ca68eb595ad460578ad4ebf8e77a7d7e770a22", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTYxNjMzNQ==", "url": "https://github.com/debezium/debezium/pull/1654#discussion_r445616335", "bodyText": "Good point. I had used this file to verify that a value used in a configuration file had the proper escapes in the regex, but you are correct that this test does not need that.\nI've updated the test to use the default, removed the properties file from the PR, and added a few more conditions to the unit test.", "author": "rhauch", "createdAt": "2020-06-25T14:48:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTM0MDk5NQ=="}], "type": "inlineReview", "revised_code": {"commit": "1f82fb4b5a4582f464a12a1312c43fe4d213609f", "chunk": "diff --git a/debezium-connector-mysql/src/test/java/io/debezium/connector/mysql/MySqlTaskContextTest.java b/debezium-connector-mysql/src/test/java/io/debezium/connector/mysql/MySqlTaskContextTest.java\nindex f985c3035..b81a0ca93 100644\n--- a/debezium-connector-mysql/src/test/java/io/debezium/connector/mysql/MySqlTaskContextTest.java\n+++ b/debezium-connector-mysql/src/test/java/io/debezium/connector/mysql/MySqlTaskContextTest.java\n\n@@ -121,17 +121,22 @@ public void shouldCreateTaskFromConfigurationWithWhenNeededSnapshotMode() throws\n     }\n \n     @Test\n-    public void shouldFilterInternalDmlStatements() throws Exception {\n-        // Load from a properties file to eliminate risk of improper escaping in Java literals\n-        Properties props = new Properties();\n-        props.load(Testing.Files.readResourceAsStream(\"dml-filter.properties\"));\n-        config = simpleConfig().with(MySqlConnectorConfig.SNAPSHOT_MODE, SnapshotMode.WHEN_NEEDED)\n-                .with(\"internal.database.history.ddl.filter\", props.get(\"internal.database.history.ddl.filter\"))\n-                .build();\n+    public void shouldFilterInternalDmlStatementsUsingDefaultFilter() throws Exception {\n+        config = simpleConfig().build();\n         context = new MySqlTaskContext(config, new Filters.Builder(config).build(), false, null);\n \n+        assertThat(context.ddlFilter().test(\"INSERT INTO mysql.rds_heartbeat2(name) values ('innodb_txn_key') ON DUPLICATE KEY UPDATE value = 'v'\")).isTrue();\n         assertThat(context.ddlFilter().test(\"INSERT INTO mysql.rds_sysinfo(name, value) values ('innodb_txn_key','Sat Jun 13 06:26:02 UTC 2020')\")).isTrue();\n         assertThat(context.ddlFilter().test(\"INSERT INTO mysql.rds_monitor(name, value) values ('innodb_txn_key','Sat Jun 13 06:26:02 UTC 2020')\")).isTrue();\n+        assertThat(context.ddlFilter().test(\"INSERT INTO mysql.rds_monitor(name) values ('innodb_txn_key') ON DUPLICATE KEY UPDATE value = 'v'\")).isTrue();\n+        assertThat(context.ddlFilter().test(\"DELETE FROM mysql.rds_sysinfo\")).isTrue();\n+        assertThat(context.ddlFilter().test(\"DELETE FROM mysql.rds_monitor;\")).isTrue();\n+        assertThat(context.ddlFilter().test(\"FLUSH RELAY LOGS;\")).isTrue();\n+        assertThat(context.ddlFilter().test(\"SAVEPOINT x\")).isTrue();\n+        // Missing 'ON DUPLICATE ...' clause\n+        assertThat(context.ddlFilter().test(\"INSERT INTO mysql.rds_heartbeat2(name) values ('innodb_txn_key')\")).isFalse();\n+        // No space after 'SAVEPOINT'\n+        assertThat(context.ddlFilter().test(\"SAVEPOINT;\")).isFalse();\n     }\n \n     @Test\n"}}, {"oid": "1f82fb4b5a4582f464a12a1312c43fe4d213609f", "url": "https://github.com/debezium/debezium/commit/1f82fb4b5a4582f464a12a1312c43fe4d213609f", "message": "DBZ-2275: Simplified DML filter test to use default and added more conditions", "committedDate": "2020-06-25T14:47:38Z", "type": "commit"}, {"oid": "08044ee3ef4195606e37de9ffd33d303ccbda345", "url": "https://github.com/debezium/debezium/commit/08044ee3ef4195606e37de9ffd33d303ccbda345", "message": "DBZ-2275: Remove unused import", "committedDate": "2020-06-25T16:48:09Z", "type": "commit"}]}