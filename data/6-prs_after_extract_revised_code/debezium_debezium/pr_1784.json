{"pr_number": 1784, "pr_title": "DBZ-2461 LSN must not be flushed after connection close", "pr_createdAt": "2020-09-03T10:13:05Z", "pr_url": "https://github.com/debezium/debezium/pull/1784", "timeline": [{"oid": "835ec75feae0b26eca4533e154ff9801cd9d7029", "url": "https://github.com/debezium/debezium/commit/835ec75feae0b26eca4533e154ff9801cd9d7029", "message": "DBZ-2461 LSN must not be flushed after connection close", "committedDate": "2020-09-03T10:12:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg3NzgwMw==", "url": "https://github.com/debezium/debezium/pull/1784#discussion_r482877803", "bodyText": "Can we avoid this via Awaitility?", "author": "gunnarmorling", "createdAt": "2020-09-03T10:33:56Z", "path": "debezium-connector-postgres/src/test/java/io/debezium/connector/postgresql/DebeziumEngineIT.java", "diffHunk": "@@ -197,4 +198,61 @@ public void shouldSerializeToCloudEvents() throws Exception {\n         }\n     }\n \n+    @Test\n+    @FixFor(\"DBZ-2461\")\n+    public void testOffsetsCommitAfterStop() throws Exception {\n+        final AtomicReference<Throwable> exception = new AtomicReference<>();\n+        DebeziumEngine<ChangeEvent<String, String>> engine;\n+\n+        TestHelper.execute(\"DROP TABLE IF EXISTS tests;\", \"CREATE TABLE tests (id SERIAL PRIMARY KEY);\");\n+\n+        final Properties props = new Properties();\n+        props.putAll(TestHelper.defaultConfig().build().asMap());\n+        props.setProperty(\"name\", \"debezium-engine\");\n+        props.setProperty(\"connector.class\", \"io.debezium.connector.postgresql.PostgresConnector\");\n+        props.setProperty(StandaloneConfig.OFFSET_STORAGE_FILE_FILENAME_CONFIG,\n+                OFFSET_STORE_PATH.toAbsolutePath().toString());\n+        props.setProperty(\"offset.flush.interval.ms\", \"3000\");\n+        props.setProperty(\"converter.schemas.enable\", \"false\");\n+\n+        engine = DebeziumEngine.create(Json.class).using(props).using(new DebeziumEngine.ConnectorCallback() {\n+            @Override\n+            public void connectorStarted() {\n+            }\n+\n+            @Override\n+            public void connectorStopped() {\n+            }\n+        }).using((success, message, error) -> {\n+            exception.compareAndSet(null, error);\n+        }).notifying((records, committer) -> {\n+            try {\n+\n+                for (ChangeEvent<String, String> record : records) {\n+                    committer.markProcessed(record);\n+                }\n+                committer.markBatchFinished();\n+            }\n+            catch (Exception e) {\n+                Testing.printError(e);\n+            }\n+        }).build();\n+\n+        ExecutorService executor = Executors.newSingleThreadExecutor();\n+        executor.execute(engine);\n+\n+        for (int i = 0; i < 100; i++) {\n+            TestHelper.execute(\"INSERT INTO tests VALUES(default)\");\n+        }\n+        Thread.sleep(5000);", "originalCommit": "835ec75feae0b26eca4533e154ff9801cd9d7029", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjkwNjAyOQ==", "url": "https://github.com/debezium/debezium/pull/1784#discussion_r482906029", "bodyText": "Probably yes but I am not sure if it is worth the effort. This is just a way how to increase the probaility that the bug is visible, not for the test stability. TO use awaitility we would need to monitor offset store and validate if there are offsets of some condition.", "author": "jpechane", "createdAt": "2020-09-03T11:27:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg3NzgwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjkxODQyNA==", "url": "https://github.com/debezium/debezium/pull/1784#discussion_r482918424", "bodyText": "I'm not so much concerned about stability, but about overall execution time of the test suite.", "author": "gunnarmorling", "createdAt": "2020-09-03T11:51:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg3NzgwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjgzNjUzMg==", "url": "https://github.com/debezium/debezium/pull/1784#discussion_r486836532", "bodyText": "We are not going to short it down much anyway. We need to wait for 3 secs at least to make sure the offset committer commits offsets. I don't want to reduce that interval too much as with loer values the issue tended to disappear.", "author": "jpechane", "createdAt": "2020-09-11T07:48:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg3NzgwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njg2NDg1Nw==", "url": "https://github.com/debezium/debezium/pull/1784#discussion_r486864857", "bodyText": "Ok, not super-excited, but so be it.", "author": "gunnarmorling", "createdAt": "2020-09-11T08:41:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg3NzgwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODQ5Njk1OA==", "url": "https://github.com/debezium/debezium/pull/1784#discussion_r488496958", "bodyText": "Removed as by-product of fixing block issue", "author": "jpechane", "createdAt": "2020-09-15T08:49:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg3NzgwMw=="}], "type": "inlineReview", "revised_code": {"commit": "6f70c241c83d82da4622dd4428a1c565118da894", "chunk": "diff --git a/debezium-connector-postgres/src/test/java/io/debezium/connector/postgresql/DebeziumEngineIT.java b/debezium-connector-postgres/src/test/java/io/debezium/connector/postgresql/DebeziumEngineIT.java\nindex 3f32ccf8c..132f6725c 100644\n--- a/debezium-connector-postgres/src/test/java/io/debezium/connector/postgresql/DebeziumEngineIT.java\n+++ b/debezium-connector-postgres/src/test/java/io/debezium/connector/postgresql/DebeziumEngineIT.java\n\n@@ -198,6 +209,25 @@ public void shouldSerializeToCloudEvents() throws Exception {\n         }\n     }\n \n+    private static final AtomicInteger offsetStoreSetCalls = new AtomicInteger();\n+\n+    public static class TestOffsetStore extends FileOffsetBackingStore {\n+\n+        @Override\n+        public Future<Map<ByteBuffer, ByteBuffer>> get(Collection<ByteBuffer> keys) {\n+            LOGGER.info(\"Get offsets called\");\n+            return super.get(keys);\n+        }\n+\n+        @Override\n+        public Future<Void> set(Map<ByteBuffer, ByteBuffer> values, Callback<Void> callback) {\n+            LOGGER.info(\"Set offsets called\");\n+            offsetStoreSetCalls.incrementAndGet();\n+            return super.set(values, callback);\n+        }\n+\n+    }\n+\n     @Test\n     @FixFor(\"DBZ-2461\")\n     public void testOffsetsCommitAfterStop() throws Exception {\n"}}, {"oid": "6f70c241c83d82da4622dd4428a1c565118da894", "url": "https://github.com/debezium/debezium/commit/6f70c241c83d82da4622dd4428a1c565118da894", "message": "DBZ-2461 Remove sleeps from test", "committedDate": "2020-09-15T08:48:27Z", "type": "commit"}, {"oid": "6f70c241c83d82da4622dd4428a1c565118da894", "url": "https://github.com/debezium/debezium/commit/6f70c241c83d82da4622dd4428a1c565118da894", "message": "DBZ-2461 Remove sleeps from test", "committedDate": "2020-09-15T08:48:27Z", "type": "forcePushed"}]}