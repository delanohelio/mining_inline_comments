{"pr_number": 1463, "pr_title": "DBZ-1963 Emit outbox events with value schema names", "pr_createdAt": "2020-04-30T22:16:09Z", "pr_url": "https://github.com/debezium/debezium/pull/1463", "timeline": [{"oid": "df23da5a5764079ac191485a049fe89d08817126", "url": "https://github.com/debezium/debezium/commit/df23da5a5764079ac191485a049fe89d08817126", "message": "DBZ-1963 Emit outbox events with value schema names", "committedDate": "2020-04-30T22:59:45Z", "type": "commit"}, {"oid": "df23da5a5764079ac191485a049fe89d08817126", "url": "https://github.com/debezium/debezium/commit/df23da5a5764079ac191485a049fe89d08817126", "message": "DBZ-1963 Emit outbox events with value schema names", "committedDate": "2020-04-30T22:59:45Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTI1MjEwNg==", "url": "https://github.com/debezium/debezium/pull/1463#discussion_r419252106", "bodyText": "The reporter of the issue suggested this:\n\nThe expected outcome would be that debezium register schemas in the registry with the proper name and namespace taken from the database.server.name and aggregate type or something similar right ?\n\nI would agree with this, i.e. I don't see much value really in that configurable suffix, but adding the aggregate type seems reasonable. In particular, it sets us up nicely for later on, when the actual payload structure (and its schema) is more apparent on the Kafka record level (see DBZ-1297). I.e. here we might have a schema name like test_server.outboxsmtit.outbox.User.Value. We might also consider excluding the outbox table name test_server.outboxsmtit.User.Value, but then the name might collide with other tables and/or event types from other outbox tables in the same schema. So probably not a good idea.", "author": "gunnarmorling", "createdAt": "2020-05-04T07:24:24Z", "path": "debezium-connector-postgres/src/test/java/io/debezium/connector/postgresql/OutboxEventRouterIT.java", "diffHunk": "@@ -133,6 +133,7 @@ public void shouldConsumeRecordsFromInsert() throws Exception {\n         assertThat(routedEvent.topic()).isEqualTo(\"outbox.event.User\");\n \n         Struct valueStruct = requireStruct(routedEvent.value(), \"test payload\");\n+        assertThat(valueStruct.schema().name()).isEqualTo(\"test_server.outboxsmtit.outbox.Value-outbox\");", "originalCommit": "df23da5a5764079ac191485a049fe89d08817126", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTI1MjM0OQ==", "url": "https://github.com/debezium/debezium/pull/1463#discussion_r419252349", "bodyText": "Could you also add an assertion for the key schema?", "author": "gunnarmorling", "createdAt": "2020-05-04T07:24:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTI1MjEwNg=="}], "type": "inlineReview", "revised_code": {"commit": "75c8d7a697a65d1843fb3d026bef8de6f265dda0", "chunk": "diff --git a/debezium-connector-postgres/src/test/java/io/debezium/connector/postgresql/OutboxEventRouterIT.java b/debezium-connector-postgres/src/test/java/io/debezium/connector/postgresql/OutboxEventRouterIT.java\nindex 9ee20e3d1..eabab5898 100644\n--- a/debezium-connector-postgres/src/test/java/io/debezium/connector/postgresql/OutboxEventRouterIT.java\n+++ b/debezium-connector-postgres/src/test/java/io/debezium/connector/postgresql/OutboxEventRouterIT.java\n\n@@ -132,8 +132,11 @@ public void shouldConsumeRecordsFromInsert() throws Exception {\n         assertThat(routedEvent).isNotNull();\n         assertThat(routedEvent.topic()).isEqualTo(\"outbox.event.User\");\n \n+        assertThat(routedEvent.keySchema()).isEqualTo(Schema.STRING_SCHEMA);\n+        assertThat(routedEvent.key()).isEqualTo(\"10711fa5\");\n+\n         Struct valueStruct = requireStruct(routedEvent.value(), \"test payload\");\n-        assertThat(valueStruct.schema().name()).isEqualTo(\"test_server.outboxsmtit.outbox.Value-outbox\");\n+        assertThat(valueStruct.schema().name()).isEqualTo(\"test_server.outboxsmtit.outbox.User.Value\");\n         assertThat(valueStruct.getString(\"eventType\")).isEqualTo(\"UserCreated\");\n         JsonNode payload = (new ObjectMapper()).readTree(valueStruct.getString(\"payload\"));\n         assertThat(payload.get(\"email\")).isEqualTo(null);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTI1Mjc0Mg==", "url": "https://github.com/debezium/debezium/pull/1463#discussion_r419252742", "bodyText": "See above, I don't think the suffix and this option add much value (unless I'm missing something), and we should rather put the aggregate type into schema names.", "author": "gunnarmorling", "createdAt": "2020-05-04T07:25:55Z", "path": "debezium-core/src/main/java/io/debezium/transforms/outbox/EventRouterConfigDefinition.java", "diffHunk": "@@ -226,6 +226,13 @@ public String getAlias() {\n                     \" in case something else is processed this transform can log it as warning, error or stop the\" +\n                     \" process\");\n \n+    static final Field SCHEMA_NAME_SUFFIX = Field.create(\"debezium.schema.name.suffix\")", "originalCommit": "df23da5a5764079ac191485a049fe89d08817126", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTU4MzAyNA==", "url": "https://github.com/debezium/debezium/pull/1463#discussion_r419583024", "bodyText": "We can certainly do that; the suffix was merely a suggestion in the issue from @jpechane and I think using the aggregate type in the schema name works all the same.  I'll remove this and change the behavior accordingly.", "author": "Naros", "createdAt": "2020-05-04T16:57:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTI1Mjc0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTg5NTY3Mw==", "url": "https://github.com/debezium/debezium/pull/1463#discussion_r419895673", "bodyText": "Cool, thanks!", "author": "gunnarmorling", "createdAt": "2020-05-05T06:45:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTI1Mjc0Mg=="}], "type": "inlineReview", "revised_code": {"commit": "75c8d7a697a65d1843fb3d026bef8de6f265dda0", "chunk": "diff --git a/debezium-core/src/main/java/io/debezium/transforms/outbox/EventRouterConfigDefinition.java b/debezium-core/src/main/java/io/debezium/transforms/outbox/EventRouterConfigDefinition.java\nindex 093784c92..2c2af2aef 100644\n--- a/debezium-core/src/main/java/io/debezium/transforms/outbox/EventRouterConfigDefinition.java\n+++ b/debezium-core/src/main/java/io/debezium/transforms/outbox/EventRouterConfigDefinition.java\n\n@@ -226,13 +226,6 @@ public String getAlias() {\n                     \" in case something else is processed this transform can log it as warning, error or stop the\" +\n                     \" process\");\n \n-    static final Field SCHEMA_NAME_SUFFIX = Field.create(\"debezium.schema.name.suffix\")\n-            .withDisplayName(\"The suffix to append to value schema\")\n-            .withDefault(\"-outbox\")\n-            .withWidth(ConfigDef.Width.MEDIUM)\n-            .withImportance(ConfigDef.Importance.MEDIUM)\n-            .withDescription(\"A suffix that is appended to the source message value schema for the emitted outbox message\");\n-\n     static final Field[] CONFIG_FIELDS = {\n             FIELD_EVENT_ID,\n             FIELD_EVENT_KEY,\n"}}, {"oid": "75c8d7a697a65d1843fb3d026bef8de6f265dda0", "url": "https://github.com/debezium/debezium/commit/75c8d7a697a65d1843fb3d026bef8de6f265dda0", "message": "DBZ-1963 Suggested changes", "committedDate": "2020-05-04T19:00:13Z", "type": "commit"}, {"oid": "75c8d7a697a65d1843fb3d026bef8de6f265dda0", "url": "https://github.com/debezium/debezium/commit/75c8d7a697a65d1843fb3d026bef8de6f265dda0", "message": "DBZ-1963 Suggested changes", "committedDate": "2020-05-04T19:00:13Z", "type": "forcePushed"}]}