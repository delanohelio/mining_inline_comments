{"pr_number": 2363, "pr_title": "Add opt-in to cache responses with errors", "pr_createdAt": "2020-06-15T10:34:14Z", "pr_url": "https://github.com/apollographql/apollo-android/pull/2363", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA4ODE3MQ==", "url": "https://github.com/apollographql/apollo-android/pull/2363#discussion_r440088171", "bodyText": "Nit: maybe merge this condition with the one above? A second if isn't really required here.", "author": "martinbonnin", "createdAt": "2020-06-15T10:44:05Z", "path": "apollo-runtime/src/main/java/com/apollographql/apollo/internal/interceptor/ApolloCacheInterceptor.java", "diffHunk": "@@ -124,7 +125,9 @@ InterceptorResponse resolveFromCache(InterceptorRequest request) throws ApolloEx\n   Set<String> cacheResponse(final InterceptorResponse networkResponse,\n       final InterceptorRequest request) {\n     if (networkResponse.parsedResponse.isPresent() && networkResponse.parsedResponse.get().hasErrors()) {\n-      return Collections.emptySet();\n+      if (!request.cacheHeaders.hasHeader(ApolloCacheHeaders.STORE_PARTIAL_RESPONSES)) {", "originalCommit": "c992f9dc9ec6f57ee13c1255aeae46e1a1ed4c8d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA5MDQ0NA==", "url": "https://github.com/apollographql/apollo-android/pull/2363#discussion_r440090444", "bodyText": "Done. I hope formatting is fine, IntelliJ doesn't seem to format the file for me at all \ud83d\ude15", "author": "lwasyl", "createdAt": "2020-06-15T10:48:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA4ODE3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA5NjY1Nw==", "url": "https://github.com/apollographql/apollo-android/pull/2363#discussion_r440096657", "bodyText": "Looks good, thanks!", "author": "martinbonnin", "createdAt": "2020-06-15T11:01:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA4ODE3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA5OTk2MA==", "url": "https://github.com/apollographql/apollo-android/pull/2363#discussion_r440099960", "bodyText": "Damn, checkstyle is now complaining with: '&&' should be on a new line.. Can you move that &&?", "author": "martinbonnin", "createdAt": "2020-06-15T11:08:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA4ODE3MQ=="}], "type": "inlineReview", "revised_code": {"commit": "7d95a48c2cbb2a80cb53de5d6eb2051ad996bc76", "chunk": "diff --git a/apollo-runtime/src/main/java/com/apollographql/apollo/internal/interceptor/ApolloCacheInterceptor.java b/apollo-runtime/src/main/java/com/apollographql/apollo/internal/interceptor/ApolloCacheInterceptor.java\nindex 1992ad9fa..78ec86735 100644\n--- a/apollo-runtime/src/main/java/com/apollographql/apollo/internal/interceptor/ApolloCacheInterceptor.java\n+++ b/apollo-runtime/src/main/java/com/apollographql/apollo/internal/interceptor/ApolloCacheInterceptor.java\n\n@@ -124,10 +124,11 @@ public final class ApolloCacheInterceptor implements ApolloInterceptor {\n \n   Set<String> cacheResponse(final InterceptorResponse networkResponse,\n       final InterceptorRequest request) {\n-    if (networkResponse.parsedResponse.isPresent() && networkResponse.parsedResponse.get().hasErrors()) {\n-      if (!request.cacheHeaders.hasHeader(ApolloCacheHeaders.STORE_PARTIAL_RESPONSES)) {\n+    if (networkResponse.parsedResponse.isPresent() &&\n+        networkResponse.parsedResponse.get().hasErrors() &&\n+        !request.cacheHeaders.hasHeader(ApolloCacheHeaders.STORE_PARTIAL_RESPONSES)\n+    ) {\n         return Collections.emptySet();\n-      }\n     }\n     final Optional<List<Record>> records = networkResponse.cacheRecords.map(\n         new Function<Collection<Record>, List<Record>>() {\n"}}, {"oid": "7d95a48c2cbb2a80cb53de5d6eb2051ad996bc76", "url": "https://github.com/apollographql/apollo-android/commit/7d95a48c2cbb2a80cb53de5d6eb2051ad996bc76", "message": "Add opt-in to cache responses with errors", "committedDate": "2020-06-15T10:47:22Z", "type": "forcePushed"}, {"oid": "f1b4a57f404346f528ec0acad032d7eddee4f4dc", "url": "https://github.com/apollographql/apollo-android/commit/f1b4a57f404346f528ec0acad032d7eddee4f4dc", "message": "Add opt-in to cache responses with errors", "committedDate": "2020-06-15T15:52:03Z", "type": "commit"}, {"oid": "f1b4a57f404346f528ec0acad032d7eddee4f4dc", "url": "https://github.com/apollographql/apollo-android/commit/f1b4a57f404346f528ec0acad032d7eddee4f4dc", "message": "Add opt-in to cache responses with errors", "committedDate": "2020-06-15T15:52:03Z", "type": "forcePushed"}]}