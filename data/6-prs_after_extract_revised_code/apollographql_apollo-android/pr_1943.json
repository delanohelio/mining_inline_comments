{"pr_number": 1943, "pr_title": "Add support for auto persisted subscriptions", "pr_createdAt": "2020-01-26T05:15:15Z", "pr_url": "https://github.com/apollographql/apollo-android/pull/1943", "timeline": [{"oid": "5809fce374cc7f836389cb620cbc5d4d7485229c", "url": "https://github.com/apollographql/apollo-android/commit/5809fce374cc7f836389cb620cbc5d4d7485229c", "message": "Add support for auto persisted subscriptions\n\n- Introduce new configuration flag to enable subscription auto persistence feature (it was intentionally introduced as a separate flag to avoid messing with regular subscriptions, though I'm not really confident if need it, we might use the same flag as for regular queries `enableAutoPersistedQueries`)\n- Update `Start` protocol message to support auto persistence\n- Handle subscription `protocol negotiation errors` and resend `Start` message with subscription document\n- Tests.\n\nCloses https://github.com/apollographql/apollo-android/issues/1850", "committedDate": "2020-01-26T05:14:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTAxMDI1OA==", "url": "https://github.com/apollographql/apollo-android/pull/1943#discussion_r371010258", "bodyText": "Should this just be queryHashMethod? It's not necessarily sha256", "author": "kenyee", "createdAt": "2020-01-26T16:02:19Z", "path": "apollo-runtime/src/main/java/com/apollographql/apollo/subscription/OperationClientMessage.java", "diffHunk": "@@ -62,26 +62,48 @@ public Init(@NotNull Map<String, Object> connectionParams) {\n     private static final String JSON_KEY_QUERY = \"query\";\n     private static final String JSON_KEY_VARIABLES = \"variables\";\n     private static final String JSON_KEY_OPERATION_NAME = \"operationName\";\n+    private static final String JSON_KEY_EXTENSIONS = \"extensions\";\n+    private static final String JSON_KEY_EXTENSIONS_PERSISTED_QUERY = \"persistedQuery\";\n+    private static final String JSON_KEY_EXTENSIONS_PERSISTED_QUERY_VERSION = \"version\";\n+    private static final String JSON_KEY_EXTENSIONS_PERSISTED_QUERY_HASH = \"sha256Hash\";", "originalCommit": "5809fce374cc7f836389cb620cbc5d4d7485229c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTU5Njc4NQ==", "url": "https://github.com/apollographql/apollo-android/pull/1943#discussion_r371596785", "bodyText": "that part is really interesting, GraphQL spec doesn't have any info regarding this. BTW I noticed the same issue with regular queries, we sending sha256Hash  but as you said it can be different (md5). As far as I remember Apollo server expects sha256Hash.\nWhat about your use case, what GraphQL server are you using? Are you using sha256 as hash?\nI guess the only option right now is to make it configurable.", "author": "sav007", "createdAt": "2020-01-28T03:41:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTAxMDI1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTEyMjI1Nw==", "url": "https://github.com/apollographql/apollo-android/pull/1943#discussion_r405122257", "bodyText": "@sav007 . This part is already merged, but would it be better to just name it hash as it could be anything.\nWe use md5", "author": "SaurabhKukreja", "createdAt": "2020-04-07T21:24:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTAxMDI1OA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTAxMDM1MA==", "url": "https://github.com/apollographql/apollo-android/pull/1943#discussion_r371010350", "bodyText": "Nice renaming of this method \ud83d\ude42", "author": "kenyee", "createdAt": "2020-01-26T16:03:33Z", "path": "apollo-runtime/src/main/java/com/apollographql/apollo/response/OperationResponseParser.java", "diffHunk": "@@ -130,15 +130,15 @@ public OperationResponseParser(Operation<D, W, ?> operation, ResponseFieldMapper\n       @Override public Error read(ResponseJsonStreamReader reader) throws IOException {\n         return reader.nextObject(true, new ResponseJsonStreamReader.ObjectReader<Error>() {\n           @Override public Error read(ResponseJsonStreamReader reader) throws IOException {\n-            return readError(reader.toMap());\n+            return parseError(reader.toMap());\n           }\n         });\n       }\n     });\n   }\n \n   @SuppressWarnings(\"unchecked\")\n-  private Error readError(Map<String, Object> payload) {\n+  public static Error parseError(Map<String, Object> payload) {", "originalCommit": "5809fce374cc7f836389cb620cbc5d4d7485229c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjA4MDk2Ng==", "url": "https://github.com/apollographql/apollo-android/pull/1943#discussion_r372080966", "bodyText": "This looks little weird in terms of code style. Would be nice to leave this false alone", "author": "tasomaniac", "createdAt": "2020-01-28T21:56:18Z", "path": "apollo-runtime/src/main/java/com/apollographql/apollo/internal/subscription/RealSubscriptionManager.java", "diffHunk": "@@ -165,13 +170,16 @@ void doSubscribe(Subscription subscription, SubscriptionManager.Callback callbac\n         timer.cancelTask(INACTIVITY_TIMEOUT_TIMER_TASK_ID);\n \n         final UUID subscriptionId = UUID.randomUUID();\n-\n         subscriptions.put(subscriptionId, new SubscriptionRecord(subscriptionId, subscription, callback));\n+\n         if (state == SubscriptionManagerState.DISCONNECTED) {\n           state = SubscriptionManagerState.CONNECTING;\n           transport.connect();\n         } else if (state == SubscriptionManagerState.ACTIVE) {\n-          transport.send(new OperationClientMessage.Start(subscriptionId.toString(), subscription, scalarTypeAdapters));\n+          transport.send(\n+              new OperationClientMessage.Start(subscriptionId.toString(), subscription, scalarTypeAdapters, autoPersistSubscription,\n+                  false)", "originalCommit": "5809fce374cc7f836389cb620cbc5d4d7485229c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "33d743d5e65a33c2c4fb033ee5ec14b7324f418c", "chunk": "diff --git a/apollo-runtime/src/main/java/com/apollographql/apollo/internal/subscription/RealSubscriptionManager.java b/apollo-runtime/src/main/java/com/apollographql/apollo/internal/subscription/RealSubscriptionManager.java\nindex f73a9103f..b24dfabe7 100644\n--- a/apollo-runtime/src/main/java/com/apollographql/apollo/internal/subscription/RealSubscriptionManager.java\n+++ b/apollo-runtime/src/main/java/com/apollographql/apollo/internal/subscription/RealSubscriptionManager.java\n\n@@ -177,8 +177,7 @@ public final class RealSubscriptionManager implements SubscriptionManager {\n           transport.connect();\n         } else if (state == SubscriptionManagerState.ACTIVE) {\n           transport.send(\n-              new OperationClientMessage.Start(subscriptionId.toString(), subscription, scalarTypeAdapters, autoPersistSubscription,\n-                  false)\n+              new OperationClientMessage.Start(subscriptionId.toString(), subscription, scalarTypeAdapters, autoPersistSubscription, false)\n           );\n         }\n       }\n"}}, {"oid": "33d743d5e65a33c2c4fb033ee5ec14b7324f418c", "url": "https://github.com/apollographql/apollo-android/commit/33d743d5e65a33c2c4fb033ee5ec14b7324f418c", "message": "Feedback", "committedDate": "2020-01-29T21:36:41Z", "type": "commit"}, {"oid": "7e9b4d50739d856a1e5230d85954c824fb244ecf", "url": "https://github.com/apollographql/apollo-android/commit/7e9b4d50739d856a1e5230d85954c824fb244ecf", "message": "Lint", "committedDate": "2020-01-29T21:37:57Z", "type": "commit"}]}