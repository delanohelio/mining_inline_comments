{"pr_number": 517, "pr_title": "[OC-1092] Delete a card from the UI", "pr_createdAt": "2020-10-08T18:29:12Z", "pr_url": "https://github.com/opfab/operatorfabric-core/pull/517", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI1MTI5Mg==", "url": "https://github.com/opfab/operatorfabric-core/pull/517#discussion_r502251292", "bodyText": "Generate just one card", "author": "freddidierRTE", "createdAt": "2020-10-09T07:53:54Z", "path": "services/core/cards-publication/src/test/java/org/lfenergy/operatorfabric/cards/publication/controllers/CardControllerShould.java", "diffHunk": "@@ -133,6 +133,19 @@ void keepTheCardRepository_Untouched_when_ARandomId_isGiven() {\n \n     }\n \n+    @Test\n+    void deleteUserCardWithUnauthenticatedUser() throws Exception {\n+\n+        EasyRandom randomGenerator = instantiateEasyRandom();\n+\n+        int numberOfCards = 10;", "originalCommit": "e02a4f88c6978206cf0803d3ed9bbdbb6784c69b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUyNDE4Ng==", "url": "https://github.com/opfab/operatorfabric-core/pull/517#discussion_r502524186", "bodyText": "Done", "author": "vlo-rte", "createdAt": "2020-10-09T15:53:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI1MTI5Mg=="}], "type": "inlineReview", "revised_code": {"commit": "ab350e28ca417fa71d50a0625933a83130137110", "chunk": "diff --git a/services/core/cards-publication/src/test/java/org/lfenergy/operatorfabric/cards/publication/controllers/CardControllerShould.java b/services/core/cards-publication/src/test/java/org/lfenergy/operatorfabric/cards/publication/controllers/CardControllerShould.java\nindex ce5776d4e..ea67f39cd 100644\n--- a/services/core/cards-publication/src/test/java/org/lfenergy/operatorfabric/cards/publication/controllers/CardControllerShould.java\n+++ b/services/core/cards-publication/src/test/java/org/lfenergy/operatorfabric/cards/publication/controllers/CardControllerShould.java\n\n@@ -138,7 +138,7 @@ class CardControllerShould extends CardControllerShouldBase {\n \n         EasyRandom randomGenerator = instantiateEasyRandom();\n \n-        int numberOfCards = 10;\n+        int numberOfCards = 1;\n         List<CardPublicationData> cardsInRepository = instantiateCardPublicationData(randomGenerator, numberOfCards);\n \n         cardRepository.saveAll(cardsInRepository).subscribe();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjM3NDQ5OA==", "url": "https://github.com/opfab/operatorfabric-core/pull/517#discussion_r502374498", "bodyText": "Remove this comment redundant with the code", "author": "freddidierRTE", "createdAt": "2020-10-09T11:52:13Z", "path": "services/core/cards-publication/src/main/java/org/lfenergy/operatorfabric/cards/publication/services/CardProcessingService.java", "diffHunk": "@@ -245,6 +270,22 @@ public void deleteCards(List<CardPublicationData> cardPublicationData) {\n         return deletedCard;\n     }\n \n+    public boolean isUserAllowedToDeleteThisCard(CardPublicationData card, CurrentUserWithPerimeters user) {\n+        List<ComputedPerimeter> perimetersOfTheUserList = user.getComputedPerimeters();\n+        List<String>            entitiesOfTheUserList   = user.getUserData().getEntities();\n+\n+        if ((card.getPublisherType() == PublisherTypeEnum.ENTITY) &&    //1st check : card.publisherType == ENTITY", "originalCommit": "e02a4f88c6978206cf0803d3ed9bbdbb6784c69b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUzNjkzMg==", "url": "https://github.com/opfab/operatorfabric-core/pull/517#discussion_r502536932", "bodyText": "As discussed, I've put the comments above the method.", "author": "vlo-rte", "createdAt": "2020-10-09T16:15:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjM3NDQ5OA=="}], "type": "inlineReview", "revised_code": {"commit": "ab350e28ca417fa71d50a0625933a83130137110", "chunk": "diff --git a/services/core/cards-publication/src/main/java/org/lfenergy/operatorfabric/cards/publication/services/CardProcessingService.java b/services/core/cards-publication/src/main/java/org/lfenergy/operatorfabric/cards/publication/services/CardProcessingService.java\nindex b9c43c468..b27a55577 100644\n--- a/services/core/cards-publication/src/main/java/org/lfenergy/operatorfabric/cards/publication/services/CardProcessingService.java\n+++ b/services/core/cards-publication/src/main/java/org/lfenergy/operatorfabric/cards/publication/services/CardProcessingService.java\n\n@@ -270,14 +270,17 @@ public class CardProcessingService {\n         return deletedCard;\n     }\n \n+    /* 1st check : card.publisherType == ENTITY\n+       2nd check : the card has been sent by an entity of the user connected\n+       3rd check : the user has the Write access to the process/state of the card */\n     public boolean isUserAllowedToDeleteThisCard(CardPublicationData card, CurrentUserWithPerimeters user) {\n         List<ComputedPerimeter> perimetersOfTheUserList = user.getComputedPerimeters();\n         List<String>            entitiesOfTheUserList   = user.getUserData().getEntities();\n \n-        if ((card.getPublisherType() == PublisherTypeEnum.ENTITY) &&    //1st check : card.publisherType == ENTITY\n-            (entitiesOfTheUserList.contains(card.getPublisher()))){     //2nd check : the card has been sent by an entity of the user connected\n+        if ((card.getPublisherType() == PublisherTypeEnum.ENTITY) &&\n+            (entitiesOfTheUserList.contains(card.getPublisher()))){\n \n-            for (ComputedPerimeter perimeter : perimetersOfTheUserList) {   //3rd check : the user has the Write access to the process/state of the card\n+            for (ComputedPerimeter perimeter : perimetersOfTheUserList) {\n                 if ((perimeter.getProcess().equals(card.getProcess())) &&\n                     (perimeter.getState().equals(card.getState())) &&\n                     ((perimeter.getRights() == RightsEnum.WRITE) || (perimeter.getRights() == RightsEnum.RECEIVEANDWRITE)))\n"}}, {"oid": "ab350e28ca417fa71d50a0625933a83130137110", "url": "https://github.com/opfab/operatorfabric-core/commit/ab350e28ca417fa71d50a0625933a83130137110", "message": "[OC-1092] adding of 2 popups for result of deleting card", "committedDate": "2020-10-12T07:54:54Z", "type": "forcePushed"}, {"oid": "193520e8202436f95927dfb87c1d0e4a70006d55", "url": "https://github.com/opfab/operatorfabric-core/commit/193520e8202436f95927dfb87c1d0e4a70006d55", "message": "[OC-1092] Delete a card from the UI", "committedDate": "2020-10-12T08:00:26Z", "type": "forcePushed"}, {"oid": "5a21fe31658174b59464f5ea6f40c59820edd989", "url": "https://github.com/opfab/operatorfabric-core/commit/5a21fe31658174b59464f5ea6f40c59820edd989", "message": "[OC-1092] Delete a card from the UI", "committedDate": "2020-10-12T08:34:08Z", "type": "commit"}, {"oid": "5a21fe31658174b59464f5ea6f40c59820edd989", "url": "https://github.com/opfab/operatorfabric-core/commit/5a21fe31658174b59464f5ea6f40c59820edd989", "message": "[OC-1092] Delete a card from the UI", "committedDate": "2020-10-12T08:34:08Z", "type": "forcePushed"}, {"oid": "456cec44f748b07e4964253692906dfb14acc813", "url": "https://github.com/opfab/operatorfabric-core/commit/456cec44f748b07e4964253692906dfb14acc813", "message": "Merge branch 'develop' into OC-1092", "committedDate": "2020-10-12T12:49:23Z", "type": "commit"}]}