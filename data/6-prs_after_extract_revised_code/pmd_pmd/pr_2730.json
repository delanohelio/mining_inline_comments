{"pr_number": 2730, "pr_title": "Cleanup: StringBuilder issues", "pr_createdAt": "2020-08-24T09:35:35Z", "pr_url": "https://github.com/pmd/pmd/pull/2730", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTgxMDI0MA==", "url": "https://github.com/pmd/pmd/pull/2730#discussion_r475810240", "bodyText": "This line is way too long", "author": "oowekyala", "createdAt": "2020-08-24T18:23:47Z", "path": "pmd-core/src/main/java/net/sourceforge/pmd/renderers/TextColorRenderer.java", "diffHunk": "@@ -125,17 +125,12 @@ public void end() throws IOException {\n             String nextFile = determineFileName(rv.getFilename());\n             if (!nextFile.equals(lastFile)) {\n                 lastFile = nextFile;\n-                buf.append(this.yellowBold + \"*\" + this.colorReset + \" file: \" + this.whiteBold\n-                        + this.getRelativePath(lastFile) + this.colorReset + PMD.EOL);\n+                buf.append(this.yellowBold).append(\"*\").append(this.colorReset).append(\" file: \").append(this.whiteBold).append(this.getRelativePath(lastFile)).append(this.colorReset).append(PMD.EOL);\n             }\n-            buf.append(\n-                    this.green + \"    src:  \" + this.cyan + lastFile.substring(lastFile.lastIndexOf(File.separator) + 1)\n-                            + this.colorReset + \":\" + this.cyan + rv.getBeginLine()\n-                            + (rv.getEndLine() == -1 ? \"\" : \":\" + rv.getEndLine()) + this.colorReset + PMD.EOL);\n-            buf.append(this.green + \"    rule: \" + this.colorReset + rv.getRule().getName() + PMD.EOL);\n-            buf.append(this.green + \"    msg:  \" + this.colorReset + rv.getDescription() + PMD.EOL);\n-            buf.append(this.green + \"    code: \" + this.colorReset + this.getLine(lastFile, rv.getBeginLine()) + PMD.EOL\n-                    + PMD.EOL);\n+            buf.append(this.green).append(\"    src:  \").append(this.cyan).append(lastFile.substring(lastFile.lastIndexOf(File.separator) + 1)).append(this.colorReset).append(\":\").append(this.cyan).append(rv.getBeginLine()).append(rv.getEndLine() == -1 ? \"\" : \":\" + rv.getEndLine()).append(this.colorReset).append(PMD.EOL);", "originalCommit": "53ab816e4f7a506d8a357cd98ad0b782c1166629", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTgzNDE5Nw==", "url": "https://github.com/pmd/pmd/pull/2730#discussion_r475834197", "bodyText": "@oowekyala line splited.", "author": "XenoAmess", "createdAt": "2020-08-24T19:08:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTgxMDI0MA=="}], "type": "inlineReview", "revised_code": {"commit": "90f53f892f6f6fd1f54a206147bc48018285d46d", "chunk": "diff --git a/pmd-core/src/main/java/net/sourceforge/pmd/renderers/TextColorRenderer.java b/pmd-core/src/main/java/net/sourceforge/pmd/renderers/TextColorRenderer.java\nindex cb840c8f60..c4a960c464 100644\n--- a/pmd-core/src/main/java/net/sourceforge/pmd/renderers/TextColorRenderer.java\n+++ b/pmd-core/src/main/java/net/sourceforge/pmd/renderers/TextColorRenderer.java\n\n@@ -125,12 +125,41 @@ public class TextColorRenderer extends AbstractAccumulatingRenderer {\n             String nextFile = determineFileName(rv.getFilename());\n             if (!nextFile.equals(lastFile)) {\n                 lastFile = nextFile;\n-                buf.append(this.yellowBold).append(\"*\").append(this.colorReset).append(\" file: \").append(this.whiteBold).append(this.getRelativePath(lastFile)).append(this.colorReset).append(PMD.EOL);\n+                buf.append(this.yellowBold)\n+                        .append(\"*\")\n+                        .append(this.colorReset)\n+                        .append(\" file: \")\n+                        .append(this.whiteBold)\n+                        .append(this.getRelativePath(lastFile))\n+                        .append(this.colorReset)\n+                        .append(PMD.EOL);\n             }\n-            buf.append(this.green).append(\"    src:  \").append(this.cyan).append(lastFile.substring(lastFile.lastIndexOf(File.separator) + 1)).append(this.colorReset).append(\":\").append(this.cyan).append(rv.getBeginLine()).append(rv.getEndLine() == -1 ? \"\" : \":\" + rv.getEndLine()).append(this.colorReset).append(PMD.EOL);\n-            buf.append(this.green).append(\"    rule: \").append(this.colorReset).append(rv.getRule().getName()).append(PMD.EOL);\n-            buf.append(this.green).append(\"    msg:  \").append(this.colorReset).append(rv.getDescription()).append(PMD.EOL);\n-            buf.append(this.green).append(\"    code: \").append(this.colorReset).append(this.getLine(lastFile, rv.getBeginLine())).append(PMD.EOL).append(PMD.EOL);\n+            buf.append(this.green)\n+                    .append(\"    src:  \")\n+                    .append(this.cyan)\n+                    .append(lastFile.substring(lastFile.lastIndexOf(File.separator) + 1))\n+                    .append(this.colorReset).append(\":\")\n+                    .append(this.cyan)\n+                    .append(rv.getBeginLine())\n+                    .append(rv.getEndLine() == -1 ? \"\" : \":\" + rv.getEndLine())\n+                    .append(this.colorReset)\n+                    .append(PMD.EOL);\n+            buf.append(this.green)\n+                    .append(\"    rule: \")\n+                    .append(this.colorReset)\n+                    .append(rv.getRule().getName())\n+                    .append(PMD.EOL);\n+            buf.append(this.green)\n+                    .append(\"    msg:  \")\n+                    .append(this.colorReset)\n+                    .append(rv.getDescription())\n+                    .append(PMD.EOL);\n+            buf.append(this.green)\n+                    .append(\"    code: \")\n+                    .append(this.colorReset)\n+                    .append(this.getLine(lastFile, rv.getBeginLine()))\n+                    .append(PMD.EOL)\n+                    .append(PMD.EOL);\n             writer.write(buf.toString());\n         }\n         writer.write(PMD.EOL + PMD.EOL);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTgxMDU2MA==", "url": "https://github.com/pmd/pmd/pull/2730#discussion_r475810560", "bodyText": "Please don't edit this file as it has been removed in another branch", "author": "oowekyala", "createdAt": "2020-08-24T18:24:25Z", "path": "pmd-java/src/test/java/net/sourceforge/pmd/lang/java/ast/AccessNodeTest.java", "diffHunk": "@@ -139,9 +139,9 @@ public void testPackagePrivate() {\n \n \n     private static String makeAccessJavaCode(String[] access, String declRest) {\n-        String result = \"public class Test { \";\n+        StringBuilder result = new StringBuilder(\"public class Test { \");", "originalCommit": "53ab816e4f7a506d8a357cd98ad0b782c1166629", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTgzMzk3OA==", "url": "https://github.com/pmd/pmd/pull/2730#discussion_r475833978", "bodyText": "@oowekyala reverted&rebased", "author": "XenoAmess", "createdAt": "2020-08-24T19:08:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTgxMDU2MA=="}], "type": "inlineReview", "revised_code": {"commit": "90f53f892f6f6fd1f54a206147bc48018285d46d", "chunk": "diff --git a/pmd-java/src/test/java/net/sourceforge/pmd/lang/java/ast/AccessNodeTest.java b/pmd-java/src/test/java/net/sourceforge/pmd/lang/java/ast/AccessNodeTest.java\nindex 2a6af3be08..84b9090d83 100644\n--- a/pmd-java/src/test/java/net/sourceforge/pmd/lang/java/ast/AccessNodeTest.java\n+++ b/pmd-java/src/test/java/net/sourceforge/pmd/lang/java/ast/AccessNodeTest.java\n\n@@ -139,9 +139,9 @@ public class AccessNodeTest extends BaseParserTest {\n \n \n     private static String makeAccessJavaCode(String[] access, String declRest) {\n-        StringBuilder result = new StringBuilder(\"public class Test { \");\n+        String result = \"public class Test { \";\n         for (String s : access) {\n-            result.append(s).append(' ');\n+            result += s + \" \";\n         }\n         return result + \" \" + declRest + \" }\";\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTgxMDk4MA==", "url": "https://github.com/pmd/pmd/pull/2730#discussion_r475810980", "bodyText": "Please don't edit this file as it has been removed in another branch", "author": "oowekyala", "createdAt": "2020-08-24T18:25:06Z", "path": "pmd-vm/src/main/java/net/sourceforge/pmd/lang/vm/ast/TokenMgrError.java", "diffHunk": "@@ -101,7 +101,7 @@ protected static final String addEscapes(final String str) {\n                 ch = str.charAt(i);\n                 if (ch < 0x20 || ch > 0x7e) {\n                     final String s = \"0000\" + Integer.toString(ch, 16);\n-                    retval.append(\"\\\\u\" + s.substring(s.length() - 4, s.length()));\n+                    retval.append(\"\\\\u\").append(s.substring(s.length() - 4, s.length()));", "originalCommit": "53ab816e4f7a506d8a357cd98ad0b782c1166629", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTgzNDA4MA==", "url": "https://github.com/pmd/pmd/pull/2730#discussion_r475834080", "bodyText": "@oowekyala reverted&rebased", "author": "XenoAmess", "createdAt": "2020-08-24T19:08:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTgxMDk4MA=="}], "type": "inlineReview", "revised_code": {"commit": "90f53f892f6f6fd1f54a206147bc48018285d46d", "chunk": "diff --git a/pmd-vm/src/main/java/net/sourceforge/pmd/lang/vm/ast/TokenMgrError.java b/pmd-vm/src/main/java/net/sourceforge/pmd/lang/vm/ast/TokenMgrError.java\nindex e93e14675e..898ad8dfec 100644\n--- a/pmd-vm/src/main/java/net/sourceforge/pmd/lang/vm/ast/TokenMgrError.java\n+++ b/pmd-vm/src/main/java/net/sourceforge/pmd/lang/vm/ast/TokenMgrError.java\n\n@@ -101,7 +101,7 @@ public class TokenMgrError extends RuntimeException {\n                 ch = str.charAt(i);\n                 if (ch < 0x20 || ch > 0x7e) {\n                     final String s = \"0000\" + Integer.toString(ch, 16);\n-                    retval.append(\"\\\\u\").append(s.substring(s.length() - 4, s.length()));\n+                    retval.append(\"\\\\u\" + s.substring(s.length() - 4, s.length()));\n                 } else {\n                     retval.append(ch);\n                 }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTgxMTcwNQ==", "url": "https://github.com/pmd/pmd/pull/2730#discussion_r475811705", "bodyText": "This stringbuilder uses a concatenation as an argument", "author": "oowekyala", "createdAt": "2020-08-24T18:26:26Z", "path": "pmd-core/src/main/java/net/sourceforge/pmd/renderers/CodeClimateRenderer.java", "diffHunk": "@@ -145,27 +145,27 @@ private int getRemediationPoints() {\n     }\n \n     private <T> String getBody() {\n-        String result = \"## \" + rule.getName() + \"\\\\n\\\\n\" + \"Since: PMD \" + rule.getSince() + \"\\\\n\\\\n\" + \"Priority: \"\n-            + rule.getPriority() + \"\\\\n\\\\n\"\n-            + \"[Categories](https://github.com/codeclimate/platform/blob/master/spec/analyzers/SPEC.md#categories): \"\n-            + Arrays.toString(getCategories()).replaceAll(\"[\\\\[\\\\]]\", \"\") + \"\\\\n\\\\n\"\n-            + \"[Remediation Points](https://github.com/codeclimate/platform/blob/master/spec/analyzers/SPEC.md#remediation-points): \"\n-            + getRemediationPoints() + \"\\\\n\\\\n\" + cleaned(rule.getDescription());\n+        StringBuilder result = new StringBuilder(\"## \" + rule.getName() + \"\\\\n\\\\n\" + \"Since: PMD \" + rule.getSince() + \"\\\\n\\\\n\" + \"Priority: \"", "originalCommit": "53ab816e4f7a506d8a357cd98ad0b782c1166629", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTgzNDM4Nw==", "url": "https://github.com/pmd/pmd/pull/2730#discussion_r475834387", "bodyText": "@oowekyala my bad. re-done&rebased.", "author": "XenoAmess", "createdAt": "2020-08-24T19:08:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTgxMTcwNQ=="}], "type": "inlineReview", "revised_code": {"commit": "90f53f892f6f6fd1f54a206147bc48018285d46d", "chunk": "diff --git a/pmd-core/src/main/java/net/sourceforge/pmd/renderers/CodeClimateRenderer.java b/pmd-core/src/main/java/net/sourceforge/pmd/renderers/CodeClimateRenderer.java\nindex 710689e904..c738fac851 100644\n--- a/pmd-core/src/main/java/net/sourceforge/pmd/renderers/CodeClimateRenderer.java\n+++ b/pmd-core/src/main/java/net/sourceforge/pmd/renderers/CodeClimateRenderer.java\n\n@@ -145,12 +145,23 @@ public class CodeClimateRenderer extends AbstractIncrementingRenderer {\n     }\n \n     private <T> String getBody() {\n-        StringBuilder result = new StringBuilder(\"## \" + rule.getName() + \"\\\\n\\\\n\" + \"Since: PMD \" + rule.getSince() + \"\\\\n\\\\n\" + \"Priority: \"\n-                + rule.getPriority() + \"\\\\n\\\\n\"\n-                + \"[Categories](https://github.com/codeclimate/platform/blob/master/spec/analyzers/SPEC.md#categories): \"\n-                + Arrays.toString(getCategories()).replaceAll(\"[\\\\[\\\\]]\", \"\") + \"\\\\n\\\\n\"\n-                + \"[Remediation Points](https://github.com/codeclimate/platform/blob/master/spec/analyzers/SPEC.md#remediation-points): \"\n-                + getRemediationPoints() + \"\\\\n\\\\n\" + cleaned(rule.getDescription()));\n+        StringBuilder result = new StringBuilder();\n+        result.append(\"## \")\n+                .append(rule.getName())\n+                .append(\"\\\\n\\\\n\")\n+                .append(\"Since: PMD \")\n+                .append(rule.getSince())\n+                .append(\"\\\\n\\\\n\")\n+                .append(\"Priority: \")\n+                .append(rule.getPriority())\n+                .append(\"\\\\n\\\\n\")\n+                .append(\"[Categories](https://github.com/codeclimate/platform/blob/master/spec/analyzers/SPEC.md#categories): \")\n+                .append(Arrays.toString(getCategories()).replaceAll(\"[\\\\[\\\\]]\", \"\"))\n+                .append(\"\\\\n\\\\n\")\n+                .append(\"[Remediation Points](https://github.com/codeclimate/platform/blob/master/spec/analyzers/SPEC.md#remediation-points): \")\n+                .append(getRemediationPoints())\n+                .append(\"\\\\n\\\\n\")\n+                .append(cleaned(rule.getDescription()));\n \n         if (!rule.getExamples().isEmpty()) {\n             result.append(\"\\\\n\\\\n### Example:\\\\n\\\\n\");\n"}}, {"oid": "90f53f892f6f6fd1f54a206147bc48018285d46d", "url": "https://github.com/pmd/pmd/commit/90f53f892f6f6fd1f54a206147bc48018285d46d", "message": "StringBuilder issues", "committedDate": "2020-08-24T19:06:56Z", "type": "commit"}, {"oid": "90f53f892f6f6fd1f54a206147bc48018285d46d", "url": "https://github.com/pmd/pmd/commit/90f53f892f6f6fd1f54a206147bc48018285d46d", "message": "StringBuilder issues", "committedDate": "2020-08-24T19:06:56Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzI3MzExMQ==", "url": "https://github.com/pmd/pmd/pull/2730#discussion_r477273111", "bodyText": "@XenoAmess This introduces a NPE.", "author": "tweimer", "createdAt": "2020-08-26T12:48:09Z", "path": "pmd-core/src/main/java/net/sourceforge/pmd/cli/PMDCommandLineInterface.java", "diffHunk": "@@ -60,10 +60,10 @@ public static String buildUsageText() {\n     public static String buildUsageText(JCommander jcommander) {\n         StringBuilder usage = new StringBuilder();\n \n-        String allCommandsDescription = null;\n+        StringBuilder allCommandsDescription = null;\n         if (jcommander != null && jcommander.getCommands() != null) {\n             for (String command : jcommander.getCommands().keySet()) {\n-                allCommandsDescription += jcommander.getCommandDescription(command) + PMD.EOL;\n+                allCommandsDescription.append(jcommander.getCommandDescription(command)).append(PMD.EOL);", "originalCommit": "90f53f892f6f6fd1f54a206147bc48018285d46d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzI4NDMyMA==", "url": "https://github.com/pmd/pmd/pull/2730#discussion_r477284320", "bodyText": "@tweimer\nmy bad.\nbtw: is this funtion covered by any test?\nAnd is there any, coverage report for this repo?", "author": "XenoAmess", "createdAt": "2020-08-26T13:05:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzI3MzExMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzI4NzQ0OQ==", "url": "https://github.com/pmd/pmd/pull/2730#discussion_r477287449", "bodyText": "@XenoAmess This introduces a NPE.\n\n@tweimer fixed in #2745.", "author": "XenoAmess", "createdAt": "2020-08-26T13:10:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzI3MzExMQ=="}], "type": "inlineReview", "revised_code": null}]}