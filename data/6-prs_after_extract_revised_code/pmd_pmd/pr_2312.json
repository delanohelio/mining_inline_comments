{"pr_number": 2312, "pr_title": "[apex] Update ApexCRUDViolation Rule", "pr_createdAt": "2020-02-25T18:19:50Z", "pr_url": "https://github.com/pmd/pmd/pull/2312", "timeline": [{"oid": "df1609356261138f0f8653056e0ccde50cd594b2", "url": "https://github.com/pmd/pmd/commit/df1609356261138f0f8653056e0ccde50cd594b2", "message": "Modify CURD rule to support SECURITY_ENFORCE clause", "committedDate": "2020-02-20T20:03:01Z", "type": "commit"}, {"oid": "8b944630743494d8a8e956350e3c70ea6884173d", "url": "https://github.com/pmd/pmd/commit/8b944630743494d8a8e956350e3c70ea6884173d", "message": "Modify CURD rule to support regex for SECURITY_ENFORCE clause", "committedDate": "2020-02-20T23:31:19Z", "type": "commit"}, {"oid": "c54c9887a947f26b04a26c7bd5bfc0e3880d418f", "url": "https://github.com/pmd/pmd/commit/c54c9887a947f26b04a26c7bd5bfc0e3880d418f", "message": "Updated the regex to support case insensitivity in apex", "committedDate": "2020-02-20T23:57:46Z", "type": "commit"}, {"oid": "a2aba08c9a06d2612ba72856b99aef9c2b87f2b5", "url": "https://github.com/pmd/pmd/commit/a2aba08c9a06d2612ba72856b99aef9c2b87f2b5", "message": "Updated regex", "committedDate": "2020-02-25T00:27:12Z", "type": "commit"}, {"oid": "7bbb65720ac1fb0120df8759268bda45e6b7ad05", "url": "https://github.com/pmd/pmd/commit/7bbb65720ac1fb0120df8759268bda45e6b7ad05", "message": "Removed 'Accepts Clause WITH SECURITY_ENFORCED Failed' Test", "committedDate": "2020-02-25T18:10:33Z", "type": "commit"}, {"oid": "6efc10eb4cb4e05d4904fe39817ba261f8713e7b", "url": "https://github.com/pmd/pmd/commit/6efc10eb4cb4e05d4904fe39817ba261f8713e7b", "message": "Fixed syntax error with  'Accepts Clause WITH SECURITY_ENFORCED in a list' Test", "committedDate": "2020-02-26T00:08:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTE3NzEzNA==", "url": "https://github.com/pmd/pmd/pull/2312#discussion_r385177134", "bodyText": "Would node.getNode().getQuery().endsWith(\"WITH SECURITY_ENFORCED\"); produce the same result?", "author": "J-Spillane", "createdAt": "2020-02-27T15:15:49Z", "path": "pmd-apex/src/main/java/net/sourceforge/pmd/lang/apex/rule/security/ApexCRUDViolationRule.java", "diffHunk": "@@ -337,6 +337,15 @@ private boolean isLastMethodName(final ASTMethodCallExpression methodNode, final\n         return false;\n     }\n \n+    private boolean isWithSecurityEnforced(final AbstractApexNode<?> node){\n+        if(node instanceof ASTSoqlExpression){\n+            String pattern = \"(?i).*[^']\\\\s*WITH SECURITY_ENFORCED\\\\s*[^']*\";\n+            String query = ((ASTSoqlExpression) node).getQuery();\n+            return query.matches(pattern);", "originalCommit": "6efc10eb4cb4e05d4904fe39817ba261f8713e7b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjAxNzIxNQ==", "url": "https://github.com/pmd/pmd/pull/2312#discussion_r386017215", "bodyText": "I guess, we could also write query.toUpperCase(Locale.ROOT).contains(\"WITH SECURITY_ENFORCED\").\nBtw. - are multiple spaces between \"WITH\" and \"SECURITY_ENFORCED\" allowed? If yes, then we probably need to use a regex. In that case, we should create a precompiled pattern constant.", "author": "adangel", "createdAt": "2020-02-29T10:03:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTE3NzEzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjAxODExNw==", "url": "https://github.com/pmd/pmd/pull/2312#discussion_r386018117", "bodyText": "I see, we need to make sure, this text is not used inside a quoted string... So we'll need a regex.\nPlease create a private final static field:\nprivate static final Pattern WITH_SECURITY_ENFORCED = Pattern.compile(\"(?i).*[^']\\\\s*WITH\\\\s+SECURITY_ENFORCED\\\\s*[^']*\");\nAnd use it here then like this:\nreturn WITH_SECURITY_ENFORCED.matcher(soqlExpression.getQuery()).matches();", "author": "adangel", "createdAt": "2020-02-29T10:20:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTE3NzEzNA=="}], "type": "inlineReview", "revised_code": {"commit": "57279e11dbc6a2e4b68e138bbe6dfc2fda95ba34", "chunk": "diff --git a/pmd-apex/src/main/java/net/sourceforge/pmd/lang/apex/rule/security/ApexCRUDViolationRule.java b/pmd-apex/src/main/java/net/sourceforge/pmd/lang/apex/rule/security/ApexCRUDViolationRule.java\nindex d3c44bb7cf..307f8389ef 100644\n--- a/pmd-apex/src/main/java/net/sourceforge/pmd/lang/apex/rule/security/ApexCRUDViolationRule.java\n+++ b/pmd-apex/src/main/java/net/sourceforge/pmd/lang/apex/rule/security/ApexCRUDViolationRule.java\n\n@@ -337,8 +337,8 @@ public class ApexCRUDViolationRule extends AbstractApexRule {\n         return false;\n     }\n \n-    private boolean isWithSecurityEnforced(final AbstractApexNode<?> node){\n-        if(node instanceof ASTSoqlExpression){\n+    private boolean isWithSecurityEnforced(final AbstractApexNode<?> node) {\n+        if (node instanceof ASTSoqlExpression) {\n             String pattern = \"(?i).*[^']\\\\s*WITH SECURITY_ENFORCED\\\\s*[^']*\";\n             String query = ((ASTSoqlExpression) node).getQuery();\n             return query.matches(pattern);\n"}}, {"oid": "57279e11dbc6a2e4b68e138bbe6dfc2fda95ba34", "url": "https://github.com/pmd/pmd/commit/57279e11dbc6a2e4b68e138bbe6dfc2fda95ba34", "message": "Fixed styling errors during build", "committedDate": "2020-02-28T22:21:41Z", "type": "commit"}, {"oid": "7b34f04be18969a54687b9c02ca209c65b6d0ebb", "url": "https://github.com/pmd/pmd/commit/7b34f04be18969a54687b9c02ca209c65b6d0ebb", "message": "create a local pattern for the class and update isSecurityEnforced", "committedDate": "2020-03-09T22:55:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTUzNDUwOQ==", "url": "https://github.com/pmd/pmd/pull/2312#discussion_r391534509", "bodyText": "Please remove this commented code - this is failing the build:\n[INFO] --- maven-checkstyle-plugin:3.1.1:check (checkstyle-check) @ pmd-apex ---\n[INFO] There are 4 errors reported by Checkstyle 8.30 with /net/sourceforge/pmd/pmd-checkstyle-config.xml ruleset.\n[ERROR] src/main/java/net/sourceforge/pmd/lang/apex/rule/security/ApexCRUDViolationRule.java:[348] (indentation) CommentsIndentation: Comment has incorrect indentation level 0, expected is 10, indentation should be the same level as line 349.", "author": "adangel", "createdAt": "2020-03-12T10:41:55Z", "path": "pmd-apex/src/main/java/net/sourceforge/pmd/lang/apex/rule/security/ApexCRUDViolationRule.java", "diffHunk": "@@ -337,6 +339,19 @@ private boolean isLastMethodName(final ASTMethodCallExpression methodNode, final\n         return false;\n     }\n \n+    private boolean isWithSecurityEnforced(final AbstractApexNode<?> node) {\n+//        if (node instanceof ASTSoqlExpression) {\n+//            String pattern = \"(?i).*[^']\\\\s*WITH SECURITY_ENFORCED\\\\s*[^']*\";\n+//            String query = ((ASTSoqlExpression) node).getQuery();\n+//            return query.matches(pattern);\n+//        }\n+//        return false;", "originalCommit": "7b34f04be18969a54687b9c02ca209c65b6d0ebb", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "be72ec153daa2b8c2e4c3184406812c20ecbaed2", "chunk": "diff --git a/pmd-apex/src/main/java/net/sourceforge/pmd/lang/apex/rule/security/ApexCRUDViolationRule.java b/pmd-apex/src/main/java/net/sourceforge/pmd/lang/apex/rule/security/ApexCRUDViolationRule.java\nindex e27eab890c..2dd0cff20b 100644\n--- a/pmd-apex/src/main/java/net/sourceforge/pmd/lang/apex/rule/security/ApexCRUDViolationRule.java\n+++ b/pmd-apex/src/main/java/net/sourceforge/pmd/lang/apex/rule/security/ApexCRUDViolationRule.java\n\n@@ -340,16 +340,11 @@ public class ApexCRUDViolationRule extends AbstractApexRule {\n     }\n \n     private boolean isWithSecurityEnforced(final AbstractApexNode<?> node) {\n-//        if (node instanceof ASTSoqlExpression) {\n-//            String pattern = \"(?i).*[^']\\\\s*WITH SECURITY_ENFORCED\\\\s*[^']*\";\n-//            String query = ((ASTSoqlExpression) node).getQuery();\n-//            return query.matches(pattern);\n-//        }\n-//        return false;\n-          if (node instanceof ASTSoqlExpression) {\n-            return WITH_SECURITY_ENFORCED.matcher(((ASTSoqlExpression) node).getQuery()).matches();\n-          }\n-          return false;\n+        if (node instanceof ASTSoqlExpression) {\n+            boolean temp = WITH_SECURITY_ENFORCED.matcher(((ASTSoqlExpression) node).getQuery()).matches();\n+            return temp;//WITH_SECURITY_ENFORCED.matcher(((ASTSoqlExpression) node).getQuery()).matches();\n+        }\n+        return false;\n     }\n \n     private String getType(final ASTMethodCallExpression methodNode) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTUzNTg2Mg==", "url": "https://github.com/pmd/pmd/pull/2312#discussion_r391535862", "bodyText": "There seems to be some indentation problem which is failing the build. It seems, these lines are indented with two spaces too much...\n[ERROR] src/main/java/net/sourceforge/pmd/lang/apex/rule/security/ApexCRUDViolationRule.java:[349] (indentation) Indentation: 'if' has incorrect indentation level 10, expected level should be 8.\n[ERROR] src/main/java/net/sourceforge/pmd/lang/apex/rule/security/ApexCRUDViolationRule.java:[351] (indentation) Indentation: 'if rcurly' has incorrect indentation level 10, expected level should be 8.\n[ERROR] src/main/java/net/sourceforge/pmd/lang/apex/rule/security/ApexCRUDViolationRule.java:[352] (indentation) Indentation: 'method def' child has incorrect indentation level 10, expected level should be 8.", "author": "adangel", "createdAt": "2020-03-12T10:44:16Z", "path": "pmd-apex/src/main/java/net/sourceforge/pmd/lang/apex/rule/security/ApexCRUDViolationRule.java", "diffHunk": "@@ -337,6 +339,19 @@ private boolean isLastMethodName(final ASTMethodCallExpression methodNode, final\n         return false;\n     }\n \n+    private boolean isWithSecurityEnforced(final AbstractApexNode<?> node) {\n+//        if (node instanceof ASTSoqlExpression) {\n+//            String pattern = \"(?i).*[^']\\\\s*WITH SECURITY_ENFORCED\\\\s*[^']*\";\n+//            String query = ((ASTSoqlExpression) node).getQuery();\n+//            return query.matches(pattern);\n+//        }\n+//        return false;\n+          if (node instanceof ASTSoqlExpression) {\n+            return WITH_SECURITY_ENFORCED.matcher(((ASTSoqlExpression) node).getQuery()).matches();\n+          }\n+          return false;\n+    }", "originalCommit": "7b34f04be18969a54687b9c02ca209c65b6d0ebb", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "be72ec153daa2b8c2e4c3184406812c20ecbaed2", "chunk": "diff --git a/pmd-apex/src/main/java/net/sourceforge/pmd/lang/apex/rule/security/ApexCRUDViolationRule.java b/pmd-apex/src/main/java/net/sourceforge/pmd/lang/apex/rule/security/ApexCRUDViolationRule.java\nindex e27eab890c..2dd0cff20b 100644\n--- a/pmd-apex/src/main/java/net/sourceforge/pmd/lang/apex/rule/security/ApexCRUDViolationRule.java\n+++ b/pmd-apex/src/main/java/net/sourceforge/pmd/lang/apex/rule/security/ApexCRUDViolationRule.java\n\n@@ -340,16 +340,11 @@ public class ApexCRUDViolationRule extends AbstractApexRule {\n     }\n \n     private boolean isWithSecurityEnforced(final AbstractApexNode<?> node) {\n-//        if (node instanceof ASTSoqlExpression) {\n-//            String pattern = \"(?i).*[^']\\\\s*WITH SECURITY_ENFORCED\\\\s*[^']*\";\n-//            String query = ((ASTSoqlExpression) node).getQuery();\n-//            return query.matches(pattern);\n-//        }\n-//        return false;\n-          if (node instanceof ASTSoqlExpression) {\n-            return WITH_SECURITY_ENFORCED.matcher(((ASTSoqlExpression) node).getQuery()).matches();\n-          }\n-          return false;\n+        if (node instanceof ASTSoqlExpression) {\n+            boolean temp = WITH_SECURITY_ENFORCED.matcher(((ASTSoqlExpression) node).getQuery()).matches();\n+            return temp;//WITH_SECURITY_ENFORCED.matcher(((ASTSoqlExpression) node).getQuery()).matches();\n+        }\n+        return false;\n     }\n \n     private String getType(final ASTMethodCallExpression methodNode) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTUzNzEzNQ==", "url": "https://github.com/pmd/pmd/pull/2312#discussion_r391537135", "bodyText": "Please combine the 3 if statements to avoid nesting:\nif (!typeToDMLOperationMapping.containsKey(typeCheck)\n    && !isProperESAPICheckForDML(typeCheck, crudMethod)\n    && !isWithSecurityEnforced(node)) {\n...", "author": "adangel", "createdAt": "2020-03-12T10:46:26Z", "path": "pmd-apex/src/main/java/net/sourceforge/pmd/lang/apex/rule/security/ApexCRUDViolationRule.java", "diffHunk": "@@ -506,7 +521,9 @@ private void validateCRUDCheckPresent(final AbstractApexNode<?> node, final Obje\n             final String typeCheck) {\n         if (!typeToDMLOperationMapping.containsKey(typeCheck)) {\n             if (!isProperESAPICheckForDML(typeCheck, crudMethod)) {\n-                addViolation(data, node);\n+                if (!isWithSecurityEnforced(node)) {", "originalCommit": "7b34f04be18969a54687b9c02ca209c65b6d0ebb", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "be72ec153daa2b8c2e4c3184406812c20ecbaed2", "chunk": "diff --git a/pmd-apex/src/main/java/net/sourceforge/pmd/lang/apex/rule/security/ApexCRUDViolationRule.java b/pmd-apex/src/main/java/net/sourceforge/pmd/lang/apex/rule/security/ApexCRUDViolationRule.java\nindex e27eab890c..2dd0cff20b 100644\n--- a/pmd-apex/src/main/java/net/sourceforge/pmd/lang/apex/rule/security/ApexCRUDViolationRule.java\n+++ b/pmd-apex/src/main/java/net/sourceforge/pmd/lang/apex/rule/security/ApexCRUDViolationRule.java\n\n@@ -517,13 +512,16 @@ public class ApexCRUDViolationRule extends AbstractApexRule {\n \n     }\n \n+\n     private void validateCRUDCheckPresent(final AbstractApexNode<?> node, final Object data, final String crudMethod,\n             final String typeCheck) {\n-        if (!typeToDMLOperationMapping.containsKey(typeCheck)) {\n-            if (!isProperESAPICheckForDML(typeCheck, crudMethod)) {\n-                if (!isWithSecurityEnforced(node)) {\n-                    addViolation(data, node);\n-                }\n+        boolean missingKey = !typeToDMLOperationMapping.containsKey(typeCheck);\n+        boolean isImproperDMLCheck = !isProperESAPICheckForDML(typeCheck, crudMethod);\n+        boolean noSecurityEnforced = !isWithSecurityEnforced(node);\n+        if (missingKey) {\n+            //if condition returns true, add violation, otherwise return.\n+            if (isImproperDMLCheck && noSecurityEnforced) {\n+                addViolation(data, node);\n             }\n         } else {\n             boolean properChecksHappened = false;\n"}}, {"oid": "be72ec153daa2b8c2e4c3184406812c20ecbaed2", "url": "https://github.com/pmd/pmd/commit/be72ec153daa2b8c2e4c3184406812c20ecbaed2", "message": "Fixed more style changes and improved logic", "committedDate": "2020-03-12T21:06:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjEyMzM3Mg==", "url": "https://github.com/pmd/pmd/pull/2312#discussion_r392123372", "bodyText": "@jarquile\nThe build is still failing (see https://travis-ci.org/github/pmd/pmd/builds/661704547?utm_source=github_status&utm_medium=notification):\n[INFO] --- maven-pmd-plugin:3.13.0:check (default) @ pmd-apex ---\n\n[INFO] PMD version: 6.22.0\n\n[INFO] PMD Failure: net.sourceforge.pmd.lang.apex.rule.security.ApexCRUDViolationRule:345 Rule:UnnecessaryLocalBeforeReturn Priority:1 Consider simply returning the value vs storing it in local variable 'temp'.\n\nJust write return WITH_SECURITY_ENFORCED.matcher(((ASTSoqlExpression) node).getQuery()).matches();\nAnd remove the comment.", "author": "adangel", "createdAt": "2020-03-13T09:44:47Z", "path": "pmd-apex/src/main/java/net/sourceforge/pmd/lang/apex/rule/security/ApexCRUDViolationRule.java", "diffHunk": "@@ -340,16 +340,11 @@ private boolean isLastMethodName(final ASTMethodCallExpression methodNode, final\n     }\n \n     private boolean isWithSecurityEnforced(final AbstractApexNode<?> node) {\n-//        if (node instanceof ASTSoqlExpression) {\n-//            String pattern = \"(?i).*[^']\\\\s*WITH SECURITY_ENFORCED\\\\s*[^']*\";\n-//            String query = ((ASTSoqlExpression) node).getQuery();\n-//            return query.matches(pattern);\n-//        }\n-//        return false;\n-          if (node instanceof ASTSoqlExpression) {\n-            return WITH_SECURITY_ENFORCED.matcher(((ASTSoqlExpression) node).getQuery()).matches();\n-          }\n-          return false;\n+        if (node instanceof ASTSoqlExpression) {\n+            boolean temp = WITH_SECURITY_ENFORCED.matcher(((ASTSoqlExpression) node).getQuery()).matches();\n+            return temp;//WITH_SECURITY_ENFORCED.matcher(((ASTSoqlExpression) node).getQuery()).matches();", "originalCommit": "be72ec153daa2b8c2e4c3184406812c20ecbaed2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjYwMjc0Ng==", "url": "https://github.com/pmd/pmd/pull/2312#discussion_r392602746", "bodyText": "I'll fix it myself....", "author": "adangel", "createdAt": "2020-03-14T16:58:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjEyMzM3Mg=="}], "type": "inlineReview", "revised_code": null}]}