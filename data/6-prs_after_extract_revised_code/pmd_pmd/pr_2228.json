{"pr_number": 2228, "pr_title": "[java] Symbol tables for imports", "pr_createdAt": "2020-01-15T23:55:57Z", "pr_url": "https://github.com/pmd/pmd/pull/2228", "timeline": [{"oid": "50d62298499c91d819c7ad6910ca0c48e4aadb79", "url": "https://github.com/pmd/pmd/commit/50d62298499c91d819c7ad6910ca0c48e4aadb79", "message": "Checkout symbol tables", "committedDate": "2020-01-11T08:58:22Z", "type": "commit"}, {"oid": "2d51379949a8a55ff41953382cdd8ca759fc096d", "url": "https://github.com/pmd/pmd/commit/2d51379949a8a55ff41953382cdd8ca759fc096d", "message": "Stash stuff for later", "committedDate": "2020-01-11T08:58:22Z", "type": "commit"}, {"oid": "571018244b1f7df4c3cdead3307b74cd40a9ed26", "url": "https://github.com/pmd/pmd/commit/571018244b1f7df4c3cdead3307b74cd40a9ed26", "message": "Fix tests", "committedDate": "2020-01-11T09:01:39Z", "type": "commit"}, {"oid": "d56fa7451819e8d12f17525f68575b1fa2b999f1", "url": "https://github.com/pmd/pmd/commit/d56fa7451819e8d12f17525f68575b1fa2b999f1", "message": "Resolve results", "committedDate": "2020-01-11T12:22:09Z", "type": "commit"}, {"oid": "cb0aa4d4d0ffb128ad5a881d38b097eae0ca065b", "url": "https://github.com/pmd/pmd/commit/cb0aa4d4d0ffb128ad5a881d38b097eae0ca065b", "message": "Merge branch 'java-grammar' into sym-table-impl", "committedDate": "2020-01-15T11:19:43Z", "type": "commit"}, {"oid": "7ca7fb331f00b6a694d75aa12a34669a9d0c1418", "url": "https://github.com/pmd/pmd/commit/7ca7fb331f00b6a694d75aa12a34669a9d0c1418", "message": "Cleanup", "committedDate": "2020-01-15T23:02:04Z", "type": "commit"}, {"oid": "fb7d0747a9ea483fd1b348a7506d52e88840e550", "url": "https://github.com/pmd/pmd/commit/fb7d0747a9ea483fd1b348a7506d52e88840e550", "message": "Merge branch 'java-grammar' into sym-table-impl", "committedDate": "2020-01-15T23:06:27Z", "type": "commit"}, {"oid": "3b7c849f2fad582cc697cee36a5864fb66bbae2c", "url": "https://github.com/pmd/pmd/commit/3b7c849f2fad582cc697cee36a5864fb66bbae2c", "message": "Merge branch 'java-grammar' into sym-table-impl", "committedDate": "2020-01-15T23:13:12Z", "type": "commit"}, {"oid": "5fba0aeb5bb8e82cfe09f675bf34b34b82796426", "url": "https://github.com/pmd/pmd/commit/5fba0aeb5bb8e82cfe09f675bf34b34b82796426", "message": "Remove failed resolve result", "committedDate": "2020-01-15T23:38:35Z", "type": "commit"}, {"oid": "80d9255cf5f2eab154e245840ce1ae4a1e72af99", "url": "https://github.com/pmd/pmd/commit/80d9255cf5f2eab154e245840ce1ae4a1e72af99", "message": "Merge branch 'java-grammar' into sym-table-impl", "committedDate": "2020-01-16T03:35:06Z", "type": "commit"}, {"oid": "c8b967135dcc4bab0ff1755d3605424adb096b35", "url": "https://github.com/pmd/pmd/commit/c8b967135dcc4bab0ff1755d3605424adb096b35", "message": "Change some names", "committedDate": "2020-01-16T04:48:37Z", "type": "commit"}, {"oid": "e8f30fdcd2bfc17309bba59a61305cce4dbf8c4c", "url": "https://github.com/pmd/pmd/commit/e8f30fdcd2bfc17309bba59a61305cce4dbf8c4c", "message": "Merge branch 'java-grammar' into sym-table-impl", "committedDate": "2020-01-16T22:22:08Z", "type": "commit"}, {"oid": "286de16e7e349641b4b2c65896978a0733a6d6c4", "url": "https://github.com/pmd/pmd/commit/286de16e7e349641b4b2c65896978a0733a6d6c4", "message": "Fix test\n\nAutoformat of IDE removed imports", "committedDate": "2020-01-16T22:26:56Z", "type": "commit"}, {"oid": "1262e4ba27dca2e28389047a50c116829aad9dc9", "url": "https://github.com/pmd/pmd/commit/1262e4ba27dca2e28389047a50c116829aad9dc9", "message": "Merge branch 'java-grammar' into sym-table-impl", "committedDate": "2020-01-17T14:47:09Z", "type": "commit"}, {"oid": "c3f31f2ff29be3b78b3325f141c7b29ea4d1f0b9", "url": "https://github.com/pmd/pmd/commit/c3f31f2ff29be3b78b3325f141c7b29ea4d1f0b9", "message": "Merge branch 'java-grammar' into sym-table-impl", "committedDate": "2020-01-17T15:45:12Z", "type": "commit"}, {"oid": "4f88f5dde2bb12ee5973aaa9f83f4f51749c2cc6", "url": "https://github.com/pmd/pmd/commit/4f88f5dde2bb12ee5973aaa9f83f4f51749c2cc6", "message": "Merge branch 'java-grammar' into sym-table-impl", "committedDate": "2020-01-18T23:21:32Z", "type": "commit"}, {"oid": "842e871b0e24f2bc71bfedba17edde55e6bc4605", "url": "https://github.com/pmd/pmd/commit/842e871b0e24f2bc71bfedba17edde55e6bc4605", "message": "Fix compil", "committedDate": "2020-01-18T23:22:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODMxMzEzNg==", "url": "https://github.com/pmd/pmd/pull/2228#discussion_r368313136", "bodyText": "Maybe throw a IllegalArgumentException like in SingleImportSymbolTable?", "author": "adangel", "createdAt": "2020-01-19T18:40:20Z", "path": "pmd-java/src/main/java/net/sourceforge/pmd/lang/java/symbols/table/internal/ImportOnDemandSymbolTable.java", "diffHunk": "@@ -0,0 +1,116 @@\n+/*\n+ * BSD-style license; for more info see http://pmd.sourceforge.net/license.html\n+ */\n+\n+package net.sourceforge.pmd.lang.java.symbols.table.internal;\n+\n+import java.lang.reflect.Modifier;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Map.Entry;\n+\n+import org.checkerframework.checker.nullness.qual.Nullable;\n+\n+import net.sourceforge.pmd.lang.java.ast.ASTImportDeclaration;\n+import net.sourceforge.pmd.lang.java.symbols.JClassSymbol;\n+import net.sourceforge.pmd.lang.java.symbols.JFieldSymbol;\n+import net.sourceforge.pmd.lang.java.symbols.JMethodSymbol;\n+import net.sourceforge.pmd.lang.java.symbols.JTypeDeclSymbol;\n+import net.sourceforge.pmd.lang.java.symbols.table.JSymbolTable;\n+import net.sourceforge.pmd.lang.java.symbols.table.ResolveResult;\n+import net.sourceforge.pmd.lang.java.symbols.table.internal.ResolveResultImpl.ClassResolveResult;\n+\n+\n+/**\n+ * Scope for imports on demand. Imports-on-demand never shadow anything, so this scope, if it exists,\n+ * is the top-level non-empty scope. All scope stacks have {@link EmptySymbolTable} as bottom though, for\n+ * implementation simplicity.\n+ *\n+ * @since 7.0.0\n+ */\n+final class ImportOnDemandSymbolTable extends AbstractImportSymbolTable {\n+\n+    /** Stores the names of packages and types for which all their types are imported. */\n+    private final Map<String, ASTImportDeclaration> importedPackagesAndTypes = new HashMap<>();\n+\n+\n+    /**\n+     * @param importsOnDemand List of import-on-demand statements, mustn't be single imports!\n+     */\n+    ImportOnDemandSymbolTable(JSymbolTable parent, SymbolTableHelper helper, List<ASTImportDeclaration> importsOnDemand) {\n+        super(parent, helper);\n+\n+        for (ASTImportDeclaration anImport : importsOnDemand) {\n+            assert anImport.isImportOnDemand() : \"Expected import on demand: \" + anImport;", "originalCommit": "842e871b0e24f2bc71bfedba17edde55e6bc4605", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTA1ODI1OA==", "url": "https://github.com/pmd/pmd/pull/2228#discussion_r369058258", "bodyText": "Maybe the other one should be an assert instead... In fact maybe we need to rationalize some guidelines about this? I tend to use assert statements for simple sanity checks, that should fail during testing if ever. For example here, the dataflow leading to this constructor is simple, entirely known, and doesn't allow anything else to happen. OTOH I use IllegalArgumentException for visible API, where a method is expected by a caller to check its arguments (and we can't know the whole dataflow leading to it, because the method is somehow public). Meaning, an assert tests the sanity of the upstream data flow, whereas an IllegalArgumentException means it's expected that someday someone will throw something illegal at it. Not sure this makes complete sense..", "author": "oowekyala", "createdAt": "2020-01-21T15:11:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODMxMzEzNg=="}], "type": "inlineReview", "revised_code": null}, {"oid": "cb4ade9eee927f8aca7daf28b0156a5f0636f4c9", "url": "https://github.com/pmd/pmd/commit/cb4ade9eee927f8aca7daf28b0156a5f0636f4c9", "message": "Merge branch 'java-grammar' into sym-table-impl", "committedDate": "2020-01-21T15:13:21Z", "type": "commit"}, {"oid": "cceba2210fad8b117f946e140bd013414c8b9f14", "url": "https://github.com/pmd/pmd/commit/cceba2210fad8b117f946e140bd013414c8b9f14", "message": "Merge branch 'java-grammar' into sym-table-impl", "committedDate": "2020-01-24T22:53:13Z", "type": "commit"}]}