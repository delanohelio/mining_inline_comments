{"pr_number": 2264, "pr_title": "Check additional Docker config file paths ($HOME, .dockerconfigjson, and legacy .dockercfg)", "pr_createdAt": "2020-02-03T21:49:42Z", "pr_url": "https://github.com/GoogleContainerTools/jib/pull/2264", "timeline": [{"oid": "1913ff16c57af3a64c6ca976744546cc465fb12d", "url": "https://github.com/GoogleContainerTools/jib/commit/1913ff16c57af3a64c6ca976744546cc465fb12d", "message": "wip", "committedDate": "2020-01-31T23:18:54Z", "type": "commit"}, {"oid": "8cab88b7b7be75512aa2852c4092adf235148b83", "url": "https://github.com/GoogleContainerTools/jib/commit/8cab88b7b7be75512aa2852c4092adf235148b83", "message": "wip", "committedDate": "2020-02-03T15:45:32Z", "type": "commit"}, {"oid": "c58e975eeeb9ffd981e6a5566eccda7168807913", "url": "https://github.com/GoogleContainerTools/jib/commit/c58e975eeeb9ffd981e6a5566eccda7168807913", "message": "wip", "committedDate": "2020-02-03T21:05:10Z", "type": "commit"}, {"oid": "5648e08bc5b9e767bfea051ae6b826b779e3fddc", "url": "https://github.com/GoogleContainerTools/jib/commit/5648e08bc5b9e767bfea051ae6b826b779e3fddc", "message": "Search for .dockerconfigjson too", "committedDate": "2020-02-03T21:27:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTMzNzkzOA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2264#discussion_r375337938", "bodyText": "This was API'ish (I used it in Cram).  It would be nice to not break any users even if it wasn't officially API.", "author": "briandealwis", "createdAt": "2020-02-05T15:47:27Z", "path": "jib-core/src/main/java/com/google/cloud/tools/jib/frontend/CredentialRetrieverFactory.java", "diffHunk": "@@ -187,17 +187,6 @@ public CredentialRetriever wellKnownCredentialHelpers() {\n     };\n   }\n \n-  /**\n-   * Creates a new {@link CredentialRetriever} that tries to retrieve credentials from Docker config\n-   * (located at {@code $USER_HOME/.docker/config.json}).\n-   *\n-   * @return a new {@link CredentialRetriever}\n-   * @see DockerConfigCredentialRetriever\n-   */\n-  public CredentialRetriever dockerConfig() {", "originalCommit": "5648e08bc5b9e767bfea051ae6b826b779e3fddc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjU4NzcyMA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2264#discussion_r376587720", "bodyText": "So do we look in $USER_HOME first and if no file exists then check user.home?", "author": "loosebazooka", "createdAt": "2020-02-07T20:17:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTMzNzkzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjU5MzQzMw==", "url": "https://github.com/GoogleContainerTools/jib/pull/2264#discussion_r376593433", "bodyText": "As of now, we only check user.home. With this PR, we first check user.home, and if we fail, we try $HOME. We don't introduce a breaking change.", "author": "chanseokoh", "createdAt": "2020-02-07T20:32:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTMzNzkzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzIxODQzMg==", "url": "https://github.com/GoogleContainerTools/jib/pull/2264#discussion_r377218432", "bodyText": "I must be missing something but from what I can see you've removed this arg-less function and replaced with with two other variants that require a pointer to a file.  We use this method in the jib-core examples README", "author": "briandealwis", "createdAt": "2020-02-10T17:48:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTMzNzkzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzIyNTc1OA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2264#discussion_r377225758", "bodyText": "I was talking to @loosebazooka. The method is restored.", "author": "chanseokoh", "createdAt": "2020-02-10T18:03:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTMzNzkzOA=="}], "type": "inlineReview", "revised_code": {"commit": "0e2623d787af22543f2172e44210cb2715635f01", "chunk": "diff --git a/jib-core/src/main/java/com/google/cloud/tools/jib/frontend/CredentialRetrieverFactory.java b/jib-core/src/main/java/com/google/cloud/tools/jib/frontend/CredentialRetrieverFactory.java\nindex fa0993fc..90a867fe 100644\n--- a/jib-core/src/main/java/com/google/cloud/tools/jib/frontend/CredentialRetrieverFactory.java\n+++ b/jib-core/src/main/java/com/google/cloud/tools/jib/frontend/CredentialRetrieverFactory.java\n\n@@ -187,6 +187,20 @@ public class CredentialRetrieverFactory {\n     };\n   }\n \n+  /**\n+   * Creates a new {@link CredentialRetriever} that tries to retrieve credentials from Docker config\n+   * (located at {@code System.getProperty(\"user.home\")/.docker/config.json}).\n+   *\n+   * @return a new {@link CredentialRetriever}\n+   * @see DockerConfigCredentialRetriever\n+   */\n+  public CredentialRetriever dockerConfig() {\n+    return dockerConfig(\n+        DockerConfigCredentialRetriever.create(\n+            imageReference.getRegistry(),\n+            Paths.get(System.getProperty(\"user.home\"), \".docker\", \"config.json\")));\n+  }\n+\n   /**\n    * Creates a new {@link CredentialRetriever} that tries to retrieve credentials from a custom path\n    * to a Docker config.\n"}}, {"oid": "0e2623d787af22543f2172e44210cb2715635f01", "url": "https://github.com/GoogleContainerTools/jib/commit/0e2623d787af22543f2172e44210cb2715635f01", "message": "Restore dockerConfig() API", "committedDate": "2020-02-05T17:22:55Z", "type": "commit"}, {"oid": "dfc96008f3c5c325fe6fc71a8ca0dfb29d0b1c4e", "url": "https://github.com/GoogleContainerTools/jib/commit/dfc96008f3c5c325fe6fc71a8ca0dfb29d0b1c4e", "message": "typo", "committedDate": "2020-02-05T17:27:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjYwNzk1Mg==", "url": "https://github.com/GoogleContainerTools/jib/pull/2264#discussion_r376607952", "bodyText": "potential value in adding comment here (or somewhere) that legacyConfigFormat = auths{} block of dockerConfig.", "author": "loosebazooka", "createdAt": "2020-02-07T21:07:32Z", "path": "jib-core/src/main/java/com/google/cloud/tools/jib/registry/credentials/DockerConfigCredentialRetriever.java", "diffHunk": "@@ -81,6 +85,20 @@ public Path getDockerConfigFile() {\n     if (!Files.exists(dockerConfigFile)) {\n       return Optional.empty();\n     }\n+\n+    if (legacyConfigFormat) {", "originalCommit": "dfc96008f3c5c325fe6fc71a8ca0dfb29d0b1c4e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjYyMjc3Mg==", "url": "https://github.com/GoogleContainerTools/jib/pull/2264#discussion_r376622772", "bodyText": "I was able to simplify this a bit.", "author": "chanseokoh", "createdAt": "2020-02-07T21:46:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjYwNzk1Mg=="}], "type": "inlineReview", "revised_code": {"commit": "dbf414581e6c2d0d53400d4e67efb7cb6d65d80c", "chunk": "diff --git a/jib-core/src/main/java/com/google/cloud/tools/jib/registry/credentials/DockerConfigCredentialRetriever.java b/jib-core/src/main/java/com/google/cloud/tools/jib/registry/credentials/DockerConfigCredentialRetriever.java\nindex 1697d080..8a6dcaa0 100644\n--- a/jib-core/src/main/java/com/google/cloud/tools/jib/registry/credentials/DockerConfigCredentialRetriever.java\n+++ b/jib-core/src/main/java/com/google/cloud/tools/jib/registry/credentials/DockerConfigCredentialRetriever.java\n\n@@ -87,14 +88,12 @@ public class DockerConfigCredentialRetriever {\n     }\n \n     if (legacyConfigFormat) {\n-      ObjectMapper objectMapper = new ObjectMapper();\n-      MapType mapType =\n-          objectMapper\n-              .getTypeFactory()\n-              .constructMapType(Map.class, String.class, DockerConfigTemplate.AuthTemplate.class);\n       try (InputStream fileIn = Files.newInputStream(dockerConfigFile)) {\n-        DockerConfig dockerConfig =\n-            new DockerConfig(new DockerConfigTemplate(objectMapper.readValue(fileIn, mapType)));\n+        // legacy config format is the value of the \"auths\":{ <map> } block of the new config (i.e.,\n+        // the <map> of string -> DockerConfigTemplate.AuthTemplate).\n+        Map<String, AuthTemplate> auths =\n+            new ObjectMapper().readValue(fileIn, new TypeReference<Map<String, AuthTemplate>>() {});\n+        DockerConfig dockerConfig = new DockerConfig(new DockerConfigTemplate(auths));\n         return retrieve(dockerConfig, logger);\n       }\n     }\n"}}, {"oid": "dbf414581e6c2d0d53400d4e67efb7cb6d65d80c", "url": "https://github.com/GoogleContainerTools/jib/commit/dbf414581e6c2d0d53400d4e67efb7cb6d65d80c", "message": "Add comment", "committedDate": "2020-02-07T21:46:18Z", "type": "commit"}, {"oid": "43883f60e567f630d8ed7331c08bbca7a401afe6", "url": "https://github.com/GoogleContainerTools/jib/commit/43883f60e567f630d8ed7331c08bbca7a401afe6", "message": "formatting", "committedDate": "2020-02-07T21:52:59Z", "type": "commit"}]}