{"pr_number": 2380, "pr_title": "Add Maven plugin extension API", "pr_createdAt": "2020-04-02T14:33:10Z", "pr_url": "https://github.com/GoogleContainerTools/jib/pull/2380", "timeline": [{"oid": "2465fd5b5f66d0436924d0bf9f191a0d47d2da65", "url": "https://github.com/GoogleContainerTools/jib/commit/2465fd5b5f66d0436924d0bf9f191a0d47d2da65", "message": "Add extension API classes", "committedDate": "2020-04-02T14:16:23Z", "type": "commit"}, {"oid": "5bd5d3919bbb00bd1c6bef101bc59c1e5de93d96", "url": "https://github.com/GoogleContainerTools/jib/commit/5bd5d3919bbb00bd1c6bef101bc59c1e5de93d96", "message": "Merge branch 'master' into plugin-extension-java-src", "committedDate": "2020-04-08T14:50:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY2NzY2OQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2380#discussion_r405667669", "bodyText": "So we just inject an implementation of this that connects to the jib event system?", "author": "loosebazooka", "createdAt": "2020-04-08T16:48:37Z", "path": "jib-maven-plugin-extension-api/src/main/java/com/google/cloud/tools/jib/maven/extension/JibMavenPluginExtension.java", "diffHunk": "@@ -0,0 +1,49 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.maven.extension;\n+\n+import com.google.cloud.tools.jib.api.buildplan.ContainerBuildPlan;\n+import com.google.cloud.tools.jib.plugins.extension.ExtensionLogger;\n+import com.google.cloud.tools.jib.plugins.extension.JibPluginExtension;\n+import com.google.cloud.tools.jib.plugins.extension.JibPluginExtensionException;\n+import org.apache.maven.execution.MavenSession;\n+import org.apache.maven.project.MavenProject;\n+\n+/**\n+ * Jib Maven plugin extension API. If a class implementing the interface is visible on the classpath\n+ * of the Jib Maven plugin, the Jib plugin extension framework calls the interface method of the\n+ * class.\n+ */\n+public interface JibMavenPluginExtension extends JibPluginExtension {\n+\n+  /**\n+   * Extends the build plan prepared by the Jib Maven plugin.\n+   *\n+   * @param buildPlan original build plan prepared by the Jib Maven plugin\n+   * @param project the {@link MavenProject}\n+   * @param session the {@link MavenSession}\n+   * @param logger logger for writing log messages\n+   * @return updated build plan\n+   * @throws JibPluginExtensionException if an error occurs while running the plugin extension\n+   */\n+  ContainerBuildPlan extendContainerBuildPlan(\n+      ContainerBuildPlan buildPlan,\n+      MavenProject project,\n+      MavenSession session,\n+      ExtensionLogger logger)", "originalCommit": "2465fd5b5f66d0436924d0bf9f191a0d47d2da65", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcxNTYzMA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2380#discussion_r405715630", "bodyText": "That's right. Here's the logger in the prototype.", "author": "chanseokoh", "createdAt": "2020-04-08T18:07:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY2NzY2OQ=="}], "type": "inlineReview", "revised_code": {"commit": "ab59c73e0c7303009b78776bc9d8ab3f5353df40", "chunk": "diff --git a/jib-maven-plugin-extension-api/src/main/java/com/google/cloud/tools/jib/maven/extension/JibMavenPluginExtension.java b/jib-maven-plugin-extension-api/src/main/java/com/google/cloud/tools/jib/maven/extension/JibMavenPluginExtension.java\nindex f5b7e4ac..2e83b86f 100644\n--- a/jib-maven-plugin-extension-api/src/main/java/com/google/cloud/tools/jib/maven/extension/JibMavenPluginExtension.java\n+++ b/jib-maven-plugin-extension-api/src/main/java/com/google/cloud/tools/jib/maven/extension/JibMavenPluginExtension.java\n\n@@ -20,13 +20,13 @@ import com.google.cloud.tools.jib.api.buildplan.ContainerBuildPlan;\n import com.google.cloud.tools.jib.plugins.extension.ExtensionLogger;\n import com.google.cloud.tools.jib.plugins.extension.JibPluginExtension;\n import com.google.cloud.tools.jib.plugins.extension.JibPluginExtensionException;\n-import org.apache.maven.execution.MavenSession;\n-import org.apache.maven.project.MavenProject;\n \n /**\n- * Jib Maven plugin extension API. If a class implementing the interface is visible on the classpath\n- * of the Jib Maven plugin, the Jib plugin extension framework calls the interface method of the\n- * class.\n+ * Jib Maven plugin extension API.\n+ *\n+ * <p>If a class implementing the interface is visible on the classpath of the Jib Maven plugin and\n+ * the plugin is configured to load the extension class, the Jib plugin extension framework calls\n+ * the interface method of the class.\n  */\n public interface JibMavenPluginExtension extends JibPluginExtension {\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY2ODQ4MA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2380#discussion_r405668480", "bodyText": "this is used just to indentify the services to load?", "author": "loosebazooka", "createdAt": "2020-04-08T16:49:48Z", "path": "jib-plugins-extension-common/src/main/java/com/google/cloud/tools/jib/plugins/extension/JibPluginExtension.java", "diffHunk": "@@ -0,0 +1,20 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.plugins.extension;\n+\n+/** Base type for Jib plugin extensions. */\n+public interface JibPluginExtension {}", "originalCommit": "2465fd5b5f66d0436924d0bf9f191a0d47d2da65", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcxNjcxOQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2380#discussion_r405716719", "bodyText": "Not really, but at least this type is required in the shared JibPluginExtensionException whose constructors force to pass an extension class.", "author": "chanseokoh", "createdAt": "2020-04-08T18:09:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY2ODQ4MA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY2ODk2Nw==", "url": "https://github.com/GoogleContainerTools/jib/pull/2380#discussion_r405668967", "bodyText": "It doesn't feel like ExecutionException is the right Exception to extend? Do we even need to really extend an exception like this?", "author": "loosebazooka", "createdAt": "2020-04-08T16:50:29Z", "path": "jib-plugins-extension-common/src/main/java/com/google/cloud/tools/jib/plugins/extension/JibPluginExtensionException.java", "diffHunk": "@@ -0,0 +1,59 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.plugins.extension;\n+\n+import java.util.concurrent.ExecutionException;\n+\n+/** Exception while running Jib plugin extensions. */\n+public class JibPluginExtensionException extends ExecutionException {", "originalCommit": "2465fd5b5f66d0436924d0bf9f191a0d47d2da65", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcxNzE2Mg==", "url": "https://github.com/GoogleContainerTools/jib/pull/2380#discussion_r405717162", "bodyText": "Ah, good catch. Leftover from previous POC iterations.", "author": "chanseokoh", "createdAt": "2020-04-08T18:10:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY2ODk2Nw=="}], "type": "inlineReview", "revised_code": {"commit": "ab59c73e0c7303009b78776bc9d8ab3f5353df40", "chunk": "diff --git a/jib-plugins-extension-common/src/main/java/com/google/cloud/tools/jib/plugins/extension/JibPluginExtensionException.java b/jib-plugins-extension-common/src/main/java/com/google/cloud/tools/jib/plugins/extension/JibPluginExtensionException.java\nindex 74b931b3..1d9eb156 100644\n--- a/jib-plugins-extension-common/src/main/java/com/google/cloud/tools/jib/plugins/extension/JibPluginExtensionException.java\n+++ b/jib-plugins-extension-common/src/main/java/com/google/cloud/tools/jib/plugins/extension/JibPluginExtensionException.java\n\n@@ -16,10 +16,8 @@\n \n package com.google.cloud.tools.jib.plugins.extension;\n \n-import java.util.concurrent.ExecutionException;\n-\n /** Exception while running Jib plugin extensions. */\n-public class JibPluginExtensionException extends ExecutionException {\n+public class JibPluginExtensionException extends Exception {\n \n   private final Class<? extends JibPluginExtension> extensionClass;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY3MDUwNA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2380#discussion_r405670504", "bodyText": "Instead of MavenProject, MavenSession should we send a MavenStuff (not Stuff but something like that) that contains anything from Maven that we inject?\nIf we ever extend this out to include to more Maven things, like stuff from the Reactor or something, then we can just add them to MavenStuff without changing the API and older extensions will continue to work?", "author": "loosebazooka", "createdAt": "2020-04-08T16:52:58Z", "path": "jib-maven-plugin-extension-api/src/main/java/com/google/cloud/tools/jib/maven/extension/JibMavenPluginExtension.java", "diffHunk": "@@ -0,0 +1,49 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.maven.extension;\n+\n+import com.google.cloud.tools.jib.api.buildplan.ContainerBuildPlan;\n+import com.google.cloud.tools.jib.plugins.extension.ExtensionLogger;\n+import com.google.cloud.tools.jib.plugins.extension.JibPluginExtension;\n+import com.google.cloud.tools.jib.plugins.extension.JibPluginExtensionException;\n+import org.apache.maven.execution.MavenSession;\n+import org.apache.maven.project.MavenProject;\n+\n+/**\n+ * Jib Maven plugin extension API. If a class implementing the interface is visible on the classpath\n+ * of the Jib Maven plugin, the Jib plugin extension framework calls the interface method of the\n+ * class.\n+ */\n+public interface JibMavenPluginExtension extends JibPluginExtension {\n+\n+  /**\n+   * Extends the build plan prepared by the Jib Maven plugin.\n+   *\n+   * @param buildPlan original build plan prepared by the Jib Maven plugin\n+   * @param project the {@link MavenProject}\n+   * @param session the {@link MavenSession}\n+   * @param logger logger for writing log messages\n+   * @return updated build plan\n+   * @throws JibPluginExtensionException if an error occurs while running the plugin extension\n+   */\n+  ContainerBuildPlan extendContainerBuildPlan(\n+      ContainerBuildPlan buildPlan,\n+      MavenProject project,", "originalCommit": "2465fd5b5f66d0436924d0bf9f191a0d47d2da65", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcxOTU0NA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2380#discussion_r405719544", "bodyText": "MavenBaggage, MavenObjects,MavenInterface, MavenFacet, MavenControlPlane, or something else? I think MavenBaggage works and is future proof. Thoughts?", "author": "chanseokoh", "createdAt": "2020-04-08T18:14:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY3MDUwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc0MjE2MQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2380#discussion_r405742161", "bodyText": "I think maybe Baggage has a little bit of a negative connotation, but I can't really think of a better one for now. MavenEnv? <-- but even this doesn't sound great.", "author": "loosebazooka", "createdAt": "2020-04-08T18:52:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY3MDUwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc0MzYzNg==", "url": "https://github.com/GoogleContainerTools/jib/pull/2380#discussion_r405743636", "bodyText": "MavenBuildProperties ?", "author": "loosebazooka", "createdAt": "2020-04-08T18:55:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY3MDUwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgwMzQzOA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2380#discussion_r405803438", "bodyText": "We settled on MavenData. I went for an interface instead of class for MavenData.", "author": "chanseokoh", "createdAt": "2020-04-08T20:44:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY3MDUwNA=="}], "type": "inlineReview", "revised_code": {"commit": "ab59c73e0c7303009b78776bc9d8ab3f5353df40", "chunk": "diff --git a/jib-maven-plugin-extension-api/src/main/java/com/google/cloud/tools/jib/maven/extension/JibMavenPluginExtension.java b/jib-maven-plugin-extension-api/src/main/java/com/google/cloud/tools/jib/maven/extension/JibMavenPluginExtension.java\nindex f5b7e4ac..2e83b86f 100644\n--- a/jib-maven-plugin-extension-api/src/main/java/com/google/cloud/tools/jib/maven/extension/JibMavenPluginExtension.java\n+++ b/jib-maven-plugin-extension-api/src/main/java/com/google/cloud/tools/jib/maven/extension/JibMavenPluginExtension.java\n\n@@ -20,13 +20,13 @@ import com.google.cloud.tools.jib.api.buildplan.ContainerBuildPlan;\n import com.google.cloud.tools.jib.plugins.extension.ExtensionLogger;\n import com.google.cloud.tools.jib.plugins.extension.JibPluginExtension;\n import com.google.cloud.tools.jib.plugins.extension.JibPluginExtensionException;\n-import org.apache.maven.execution.MavenSession;\n-import org.apache.maven.project.MavenProject;\n \n /**\n- * Jib Maven plugin extension API. If a class implementing the interface is visible on the classpath\n- * of the Jib Maven plugin, the Jib plugin extension framework calls the interface method of the\n- * class.\n+ * Jib Maven plugin extension API.\n+ *\n+ * <p>If a class implementing the interface is visible on the classpath of the Jib Maven plugin and\n+ * the plugin is configured to load the extension class, the Jib plugin extension framework calls\n+ * the interface method of the class.\n  */\n public interface JibMavenPluginExtension extends JibPluginExtension {\n \n"}}, {"oid": "ab59c73e0c7303009b78776bc9d8ab3f5353df40", "url": "https://github.com/GoogleContainerTools/jib/commit/ab59c73e0c7303009b78776bc9d8ab3f5353df40", "message": "MavenData and remove ExecutionException", "committedDate": "2020-04-08T20:43:04Z", "type": "commit"}]}