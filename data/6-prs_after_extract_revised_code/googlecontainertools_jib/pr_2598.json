{"pr_number": 2598, "pr_title": "Add BuildFileSpec for buildfile", "pr_createdAt": "2020-07-17T16:36:21Z", "pr_url": "https://github.com/GoogleContainerTools/jib/pull/2598", "timeline": [{"oid": "6e90a7242ce85d8e14d809fad10d7c94ec595168", "url": "https://github.com/GoogleContainerTools/jib/commit/6e90a7242ce85d8e14d809fad10d7c94ec595168", "message": "Add BuildFileSpec for buildfile", "committedDate": "2020-07-17T16:35:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjU3MzA5MA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2598#discussion_r456573090", "bodyText": "There's no test for user:.", "author": "chanseokoh", "createdAt": "2020-07-17T17:20:11Z", "path": "jib-cli/src/test/java/com/google/cloud/tools/jib/cli/buildfile/BuildFileSpecTest.java", "diffHunk": "@@ -0,0 +1,130 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.cli.buildfile;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.dataformat.yaml.YAMLFactory;\n+import com.google.cloud.tools.jib.api.Ports;\n+import com.google.cloud.tools.jib.api.buildplan.AbsoluteUnixPath;\n+import com.google.cloud.tools.jib.api.buildplan.ImageFormat;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableMap;\n+import com.google.common.collect.ImmutableSet;\n+import java.nio.file.Paths;\n+import java.time.Instant;\n+import org.hamcrest.CoreMatchers;\n+import org.hamcrest.MatcherAssert;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+/** Tests for {@link BuildFileSpec}. */\n+public class BuildFileSpecTest {\n+\n+  private static final ObjectMapper mapper = new ObjectMapper(new YAMLFactory());\n+\n+  @Test\n+  public void testBuildFileSpec_full() throws JsonProcessingException {\n+    String data =\n+        \"apiVersion: v1alpha1\\n\"\n+            + \"kind: BuildFile\\n\"\n+            + \"from:\\n\" // trivial base image spec\n+            + \"  image: gcr.io/example/jib\\n\"\n+            + \"creationTime: 1\\n\"\n+            + \"format: OCI\\n\"\n+            + \"environment:\\n\"\n+            + \"  env_key: env_value\\n\"\n+            + \"labels:\\n\"\n+            + \"  label_key: label_value\\n\"\n+            + \"volumes:\\n\"\n+            + \"   - /my/volume\\n\"\n+            + \"exposedPorts:\\n\"\n+            + \"  - 8080\\n\"\n+            + \"user: username\\n\"\n+            + \"workingDirectory: /workspace\\n\"\n+            + \"entrypoint:\\n\"\n+            + \"  - java\\n\"\n+            + \"  - -jar\\n\"\n+            + \"cmd:\\n\"\n+            + \"  - myjar.jar\\n\"\n+            + \"layers:\\n\" // trivial layers\n+            + \"  entries:\\n\"\n+            + \"    - name: some layer\\n\"\n+            + \"      archive: /something.tgz\\n\";\n+\n+    BuildFileSpec parsed = mapper.readValue(data, BuildFileSpec.class);\n+    Assert.assertEquals(\"v1alpha1\", parsed.getApiVersion());\n+    Assert.assertEquals(\"BuildFile\", parsed.getKind());\n+    Assert.assertEquals(\"gcr.io/example/jib\", parsed.getFrom().get().getImage());\n+    Assert.assertEquals(Instant.ofEpochMilli(1), parsed.getCreationTime().get());\n+    Assert.assertEquals(ImageFormat.OCI, parsed.getFormat().get());\n+    Assert.assertEquals(ImmutableMap.of(\"env_key\", \"env_value\"), parsed.getEnvironment().get());\n+    Assert.assertEquals(ImmutableMap.of(\"label_key\", \"label_value\"), parsed.getLabels().get());\n+    Assert.assertEquals(\n+        ImmutableSet.of(AbsoluteUnixPath.get(\"/my/volume\")), parsed.getVolumes().get());\n+    Assert.assertEquals(Ports.parse(ImmutableList.of(\"8080\")), parsed.getExposedPorts().get());", "originalCommit": "6e90a7242ce85d8e14d809fad10d7c94ec595168", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "4033fbbb822081c1291df3548736c8faa7ebd630", "chunk": "diff --git a/jib-cli/src/test/java/com/google/cloud/tools/jib/cli/buildfile/BuildFileSpecTest.java b/jib-cli/src/test/java/com/google/cloud/tools/jib/cli/buildfile/BuildFileSpecTest.java\nindex 0fd45eb90..0a2f99c62 100644\n--- a/jib-cli/src/test/java/com/google/cloud/tools/jib/cli/buildfile/BuildFileSpecTest.java\n+++ b/jib-cli/src/test/java/com/google/cloud/tools/jib/cli/buildfile/BuildFileSpecTest.java\n\n@@ -77,6 +77,7 @@ public class BuildFileSpecTest {\n     Assert.assertEquals(\n         ImmutableSet.of(AbsoluteUnixPath.get(\"/my/volume\")), parsed.getVolumes().get());\n     Assert.assertEquals(Ports.parse(ImmutableList.of(\"8080\")), parsed.getExposedPorts().get());\n+    Assert.assertEquals(\"username\", parsed.getUser().get());\n     Assert.assertEquals(AbsoluteUnixPath.get(\"/workspace\"), parsed.getWorkingDirectory().get());\n     Assert.assertEquals(ImmutableList.of(\"java\", \"-jar\"), parsed.getEntrypoint().get());\n     Assert.assertEquals(ImmutableList.of(\"myjar.jar\"), parsed.getCmd().get());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjU3Mzk2OQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2598#discussion_r456573969", "bodyText": "iso 8601", "author": "chanseokoh", "createdAt": "2020-07-17T17:22:00Z", "path": "jib-cli/src/main/java/com/google/cloud/tools/jib/cli/buildfile/BuildFileSpec.java", "diffHunk": "@@ -0,0 +1,197 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.cli.buildfile;\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.google.cloud.tools.jib.api.Ports;\n+import com.google.cloud.tools.jib.api.buildplan.AbsoluteUnixPath;\n+import com.google.cloud.tools.jib.api.buildplan.ImageFormat;\n+import com.google.cloud.tools.jib.api.buildplan.Port;\n+import com.google.common.base.Preconditions;\n+import java.time.Instant;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import javax.annotation.Nullable;\n+\n+/**\n+ * A yaml block for specifying a jib cli buildfile.\n+ *\n+ * <p>Example use of this yaml.\n+ *\n+ * <pre>{@code\n+ * apiVersion: v1alpha1\n+ * kind: BuildFile\n+ * from: see {@link BaseImageSpec}\n+ * creationTime: 100\n+ * format: docker\n+ * environment:\n+ *   env_key: env_value\n+ * labels:\n+ *   label_key: label_value\n+ * volumes:\n+ *   - /my/volume\n+ * exposedPorts:\n+ *   - 8080\n+ * user: username\n+ * workingDirectory: /workspace\n+ * entrypoint:\n+ *   - java\n+ *   - -jar\n+ * cmd:\n+ *   - myjar.jar\n+ * layers: see {@link LayersSpec}\n+ * }</pre>\n+ */\n+public class BuildFileSpec {\n+  private String apiVersion;\n+  private String kind;\n+  @Nullable private BaseImageSpec from;\n+  @Nullable private Instant creationTime;\n+  @Nullable private ImageFormat format;\n+  @Nullable private Map<String, String> environment;\n+  @Nullable private Map<String, String> labels;\n+  @Nullable private Set<AbsoluteUnixPath> volumes;\n+  @Nullable private Set<Port> exposedPorts;\n+  @Nullable private String user;\n+  @Nullable private AbsoluteUnixPath workingDirectory;\n+  @Nullable private List<String> entrypoint;\n+  @Nullable private List<String> cmd;\n+\n+  @Nullable private LayersSpec layers;\n+\n+  /**\n+   * Constructor for use by jackson to populate this object.\n+   *\n+   * @param apiVersion the api version of this buildfile\n+   * @param kind the kind (always BuildFile)\n+   * @param from a {@link BaseImageSpec} for base image\n+   * @param creationTime in milliseconds since epoch or ISO 6801 datetime", "originalCommit": "6e90a7242ce85d8e14d809fad10d7c94ec595168", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "4033fbbb822081c1291df3548736c8faa7ebd630", "chunk": "diff --git a/jib-cli/src/main/java/com/google/cloud/tools/jib/cli/buildfile/BuildFileSpec.java b/jib-cli/src/main/java/com/google/cloud/tools/jib/cli/buildfile/BuildFileSpec.java\nindex 3332ee6f1..b13f4c91d 100644\n--- a/jib-cli/src/main/java/com/google/cloud/tools/jib/cli/buildfile/BuildFileSpec.java\n+++ b/jib-cli/src/main/java/com/google/cloud/tools/jib/cli/buildfile/BuildFileSpec.java\n\n@@ -83,7 +83,7 @@ public class BuildFileSpec {\n    * @param apiVersion the api version of this buildfile\n    * @param kind the kind (always BuildFile)\n    * @param from a {@link BaseImageSpec} for base image\n-   * @param creationTime in milliseconds since epoch or ISO 6801 datetime\n+   * @param creationTime in milliseconds since epoch or ISO 8601 datetime\n    * @param format of the container, valid values in {@link ImageFormat}\n    * @param environment to write into container\n    * @param labels to write into container metadata\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjU3NzU1MA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2598#discussion_r456577550", "bodyText": "I know it's basically a JSON class, which is probably why you made all the fields @Nullable, but I just wonder if it makes sense or even possible to give a default value to some fields (e.g., format = Docker).\nRelated, ContainerBuildPlan starts with empty set/list/map for most collection fields and avoids returning Optional<Collection>, but I guess this is also a matter of policy.", "author": "chanseokoh", "createdAt": "2020-07-17T17:29:34Z", "path": "jib-cli/src/main/java/com/google/cloud/tools/jib/cli/buildfile/BuildFileSpec.java", "diffHunk": "@@ -0,0 +1,197 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.cli.buildfile;\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.google.cloud.tools.jib.api.Ports;\n+import com.google.cloud.tools.jib.api.buildplan.AbsoluteUnixPath;\n+import com.google.cloud.tools.jib.api.buildplan.ImageFormat;\n+import com.google.cloud.tools.jib.api.buildplan.Port;\n+import com.google.common.base.Preconditions;\n+import java.time.Instant;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import javax.annotation.Nullable;\n+\n+/**\n+ * A yaml block for specifying a jib cli buildfile.\n+ *\n+ * <p>Example use of this yaml.\n+ *\n+ * <pre>{@code\n+ * apiVersion: v1alpha1\n+ * kind: BuildFile\n+ * from: see {@link BaseImageSpec}\n+ * creationTime: 100\n+ * format: docker\n+ * environment:\n+ *   env_key: env_value\n+ * labels:\n+ *   label_key: label_value\n+ * volumes:\n+ *   - /my/volume\n+ * exposedPorts:\n+ *   - 8080\n+ * user: username\n+ * workingDirectory: /workspace\n+ * entrypoint:\n+ *   - java\n+ *   - -jar\n+ * cmd:\n+ *   - myjar.jar\n+ * layers: see {@link LayersSpec}\n+ * }</pre>\n+ */\n+public class BuildFileSpec {\n+  private String apiVersion;\n+  private String kind;\n+  @Nullable private BaseImageSpec from;\n+  @Nullable private Instant creationTime;\n+  @Nullable private ImageFormat format;\n+  @Nullable private Map<String, String> environment;\n+  @Nullable private Map<String, String> labels;\n+  @Nullable private Set<AbsoluteUnixPath> volumes;\n+  @Nullable private Set<Port> exposedPorts;", "originalCommit": "6e90a7242ce85d8e14d809fad10d7c94ec595168", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjYzMDk4Ng==", "url": "https://github.com/GoogleContainerTools/jib/pull/2598#discussion_r456630986", "bodyText": "So I'm working under the assumption that defaults come from the build plan. However, this is something we can discuss. Added to tracking bug.", "author": "loosebazooka", "createdAt": "2020-07-17T19:21:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjU3NzU1MA=="}], "type": "inlineReview", "revised_code": {"commit": "4033fbbb822081c1291df3548736c8faa7ebd630", "chunk": "diff --git a/jib-cli/src/main/java/com/google/cloud/tools/jib/cli/buildfile/BuildFileSpec.java b/jib-cli/src/main/java/com/google/cloud/tools/jib/cli/buildfile/BuildFileSpec.java\nindex 3332ee6f1..b13f4c91d 100644\n--- a/jib-cli/src/main/java/com/google/cloud/tools/jib/cli/buildfile/BuildFileSpec.java\n+++ b/jib-cli/src/main/java/com/google/cloud/tools/jib/cli/buildfile/BuildFileSpec.java\n\n@@ -83,7 +83,7 @@ public class BuildFileSpec {\n    * @param apiVersion the api version of this buildfile\n    * @param kind the kind (always BuildFile)\n    * @param from a {@link BaseImageSpec} for base image\n-   * @param creationTime in milliseconds since epoch or ISO 6801 datetime\n+   * @param creationTime in milliseconds since epoch or ISO 8601 datetime\n    * @param format of the container, valid values in {@link ImageFormat}\n    * @param environment to write into container\n    * @param labels to write into container metadata\n"}}, {"oid": "4033fbbb822081c1291df3548736c8faa7ebd630", "url": "https://github.com/GoogleContainerTools/jib/commit/4033fbbb822081c1291df3548736c8faa7ebd630", "message": "minor fixes", "committedDate": "2020-07-17T19:20:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjczMDcyOA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2598#discussion_r456730728", "bodyText": "is it possible to get a bit more context into these two variables?", "author": "mpeddada1", "createdAt": "2020-07-18T01:12:23Z", "path": "jib-cli/src/main/java/com/google/cloud/tools/jib/cli/buildfile/BuildFileSpec.java", "diffHunk": "@@ -0,0 +1,197 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.cli.buildfile;\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.google.cloud.tools.jib.api.Ports;\n+import com.google.cloud.tools.jib.api.buildplan.AbsoluteUnixPath;\n+import com.google.cloud.tools.jib.api.buildplan.ImageFormat;\n+import com.google.cloud.tools.jib.api.buildplan.Port;\n+import com.google.common.base.Preconditions;\n+import java.time.Instant;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import javax.annotation.Nullable;\n+\n+/**\n+ * A yaml block for specifying a jib cli buildfile.\n+ *\n+ * <p>Example use of this yaml.\n+ *\n+ * <pre>{@code\n+ * apiVersion: v1alpha1\n+ * kind: BuildFile\n+ * from: see {@link BaseImageSpec}\n+ * creationTime: 100\n+ * format: docker\n+ * environment:\n+ *   env_key: env_value\n+ * labels:\n+ *   label_key: label_value\n+ * volumes:\n+ *   - /my/volume\n+ * exposedPorts:\n+ *   - 8080\n+ * user: username\n+ * workingDirectory: /workspace\n+ * entrypoint:\n+ *   - java\n+ *   - -jar\n+ * cmd:\n+ *   - myjar.jar\n+ * layers: see {@link LayersSpec}\n+ * }</pre>\n+ */\n+public class BuildFileSpec {\n+  private String apiVersion;\n+  private String kind;\n+  @Nullable private BaseImageSpec from;\n+  @Nullable private Instant creationTime;\n+  @Nullable private ImageFormat format;\n+  @Nullable private Map<String, String> environment;\n+  @Nullable private Map<String, String> labels;\n+  @Nullable private Set<AbsoluteUnixPath> volumes;\n+  @Nullable private Set<Port> exposedPorts;\n+  @Nullable private String user;\n+  @Nullable private AbsoluteUnixPath workingDirectory;\n+  @Nullable private List<String> entrypoint;\n+  @Nullable private List<String> cmd;\n+\n+  @Nullable private LayersSpec layers;\n+\n+  /**\n+   * Constructor for use by jackson to populate this object.\n+   *\n+   * @param apiVersion the api version of this buildfile\n+   * @param kind the kind (always BuildFile)\n+   * @param from a {@link BaseImageSpec} for base image", "originalCommit": "4033fbbb822081c1291df3548736c8faa7ebd630", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njk2NjkwMg==", "url": "https://github.com/GoogleContainerTools/jib/pull/2598#discussion_r456966902", "bodyText": "kind and from?", "author": "loosebazooka", "createdAt": "2020-07-19T23:06:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjczMDcyOA=="}], "type": "inlineReview", "revised_code": {"commit": "542718456e7ed5ff3ff7fccb8adfef4512c1ff0c", "chunk": "diff --git a/jib-cli/src/main/java/com/google/cloud/tools/jib/cli/buildfile/BuildFileSpec.java b/jib-cli/src/main/java/com/google/cloud/tools/jib/cli/buildfile/BuildFileSpec.java\nindex b13f4c91d..ec36b0fff 100644\n--- a/jib-cli/src/main/java/com/google/cloud/tools/jib/cli/buildfile/BuildFileSpec.java\n+++ b/jib-cli/src/main/java/com/google/cloud/tools/jib/cli/buildfile/BuildFileSpec.java\n\n@@ -81,8 +81,8 @@ public class BuildFileSpec {\n    * Constructor for use by jackson to populate this object.\n    *\n    * @param apiVersion the api version of this buildfile\n-   * @param kind the kind (always BuildFile)\n-   * @param from a {@link BaseImageSpec} for base image\n+   * @param kind the type of configuration file (always BuildFile)\n+   * @param from a {@link BaseImageSpec} for specifying the base image\n    * @param creationTime in milliseconds since epoch or ISO 8601 datetime\n    * @param format of the container, valid values in {@link ImageFormat}\n    * @param environment to write into container\n"}}, {"oid": "542718456e7ed5ff3ff7fccb8adfef4512c1ff0c", "url": "https://github.com/GoogleContainerTools/jib/commit/542718456e7ed5ff3ff7fccb8adfef4512c1ff0c", "message": "minor javadoc update", "committedDate": "2020-07-19T23:07:32Z", "type": "commit"}]}