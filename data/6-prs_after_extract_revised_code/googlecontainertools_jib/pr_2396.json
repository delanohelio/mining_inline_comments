{"pr_number": 2396, "pr_title": "Allow null tags", "pr_createdAt": "2020-04-09T15:32:08Z", "pr_url": "https://github.com/GoogleContainerTools/jib/pull/2396", "timeline": [{"oid": "41c6e9c4a5859051053464e7007a991a62d5f529", "url": "https://github.com/GoogleContainerTools/jib/commit/41c6e9c4a5859051053464e7007a991a62d5f529", "message": "Allow null tags", "committedDate": "2020-04-08T19:57:56Z", "type": "commit"}, {"oid": "34474fd73675828bb66eaa77173969b5c9ee2a81", "url": "https://github.com/GoogleContainerTools/jib/commit/34474fd73675828bb66eaa77173969b5c9ee2a81", "message": "Changelog", "committedDate": "2020-04-09T15:27:16Z", "type": "commit"}, {"oid": "e8395a71fbe3f7bb359ccf9ccfe96d9cf352fc67", "url": "https://github.com/GoogleContainerTools/jib/commit/e8395a71fbe3f7bb359ccf9ccfe96d9cf352fc67", "message": "Changelog", "committedDate": "2020-04-09T15:34:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMzNzI0NA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2396#discussion_r406337244", "bodyText": "Just documenting: I think there's a possibility that these are not necessary. Seems like the whole ImageReference code can cope with an empty tag or digest by always checking isNullOrEmpty(). For example, the of() method passes empty tag and digest without coercing null. But because tag and digest are given as a result of parsing here, I think it makes sense to force null unlike of().\nToo bad, I think it could have been simpler if we prevented passing an empty string at the first place.", "author": "chanseokoh", "createdAt": "2020-04-09T16:45:23Z", "path": "jib-core/src/main/java/com/google/cloud/tools/jib/api/ImageReference.java", "diffHunk": "@@ -138,9 +138,15 @@ public static ImageReference parse(String reference) throws InvalidImageReferenc\n       repository = LIBRARY_REPOSITORY_PREFIX + repository;\n     }\n \n-    if (Strings.isNullOrEmpty(tag)) {\n+    if (Strings.isNullOrEmpty(tag) && Strings.isNullOrEmpty(digest)) {\n       tag = DEFAULT_TAG;\n     }\n+    if (Strings.isNullOrEmpty(tag)) {\n+      tag = null;\n+    }\n+    if (Strings.isNullOrEmpty(digest)) {\n+      digest = null;\n+    }", "originalCommit": "e8395a71fbe3f7bb359ccf9ccfe96d9cf352fc67", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjM3NzE2MQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2396#discussion_r406377161", "bodyText": "I feel like it's cleaner to change\n\nincludeTagIfDigestPresent --> includeTagAndDigest (or noQualifier or onlyRegistryAndRepository). Then we can short-circuit if it doesn't have to print any tag or digest.\ntoString(boolean includeTagIfDigestPresent) -> toString(boolean includeTagAndDigest)\ntoString() is simply toString(true).\ntoStringWithQualifier() is simply toString(false) + getQualifier(). No conditionally needed in the method.\n\nWDYT?", "author": "chanseokoh", "createdAt": "2020-04-09T17:55:05Z", "path": "jib-core/src/main/java/com/google/cloud/tools/jib/api/ImageReference.java", "diffHunk": "@@ -380,7 +411,7 @@ private String toString(boolean includeTagIfDigestPresent) {\n \n     if (Strings.isNullOrEmpty(digest) || includeTagIfDigestPresent) {", "originalCommit": "e8395a71fbe3f7bb359ccf9ccfe96d9cf352fc67", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg0NDY5MA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2396#discussion_r406844690", "bodyText": "toStringWithQualifier() is simply toString(false) + getQualifier(). No conditionally needed in the method.\n\nI think there's still some conditionality needed here to add either a : or an @ depending on whether it's a tag or digest. getQualifier() doesn't have these.", "author": "TadCordle", "createdAt": "2020-04-10T16:52:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjM3NzE2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg2NTY5Mw==", "url": "https://github.com/GoogleContainerTools/jib/pull/2396#discussion_r406865693", "bodyText": "Ah, yeah, I missed the : and @. I still think we can make this simpler with\n\ntoString() { return toString(false); }\ntoStringWithQualifier() { return toString(true); }\n\ntoString(boolean) is already complex with conditionals and exists only because of toStringWithQualifier(). Moreover, I think the conditional connotation in the name includeTagIfDigestPresent makes it not easy to reason the implementation. I don't find a good reason to have a separate conditional in toStringWithQualifier().", "author": "chanseokoh", "createdAt": "2020-04-10T17:41:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjM3NzE2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg3MzQzMA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2396#discussion_r406873430", "bodyText": "But what I just said may not necessarily be true. Just try the basic idea and if it adversely makes it complex, just forgo the idea.", "author": "chanseokoh", "createdAt": "2020-04-10T18:01:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjM3NzE2MQ=="}], "type": "inlineReview", "revised_code": {"commit": "e23a97576f9f14387ba34c4dec0b60dc9677ad8f", "chunk": "diff --git a/jib-core/src/main/java/com/google/cloud/tools/jib/api/ImageReference.java b/jib-core/src/main/java/com/google/cloud/tools/jib/api/ImageReference.java\nindex 0451731f4..909076116 100644\n--- a/jib-core/src/main/java/com/google/cloud/tools/jib/api/ImageReference.java\n+++ b/jib-core/src/main/java/com/google/cloud/tools/jib/api/ImageReference.java\n\n@@ -409,13 +414,19 @@ public class ImageReference {\n       referenceString.append(repository);\n     }\n \n-    if (Strings.isNullOrEmpty(digest) || includeTagIfDigestPresent) {\n-      // Use tag if not the default tag.\n-      if (!Strings.isNullOrEmpty(tag) && !isDefaultTag(tag)) {\n+    if (singleQualifier) {\n+      // Include the digest if set, else include the tag\n+      if (!Strings.isNullOrEmpty(digest)) {\n+        referenceString.append('@').append(digest);\n+      } else if (!Strings.isNullOrEmpty(tag)) {\n         referenceString.append(':').append(tag);\n       }\n+      return referenceString.toString();\n     }\n \n+    if (!Strings.isNullOrEmpty(tag) && !usesDefaultTag()) {\n+      referenceString.append(':').append(tag);\n+    }\n     if (!Strings.isNullOrEmpty(digest)) {\n       referenceString.append('@').append(digest);\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ2NDM2Nw==", "url": "https://github.com/GoogleContainerTools/jib/pull/2396#discussion_r406464367", "bodyText": "I think this answers some of my earlier questions. When given both a tag and a digest, the end result is to ignore a tag, right?\nIf so, since there's no point in specifying a tag in a Jib config, maybe we should print a warning. This doesn't have to be addressed in this PR.", "author": "chanseokoh", "createdAt": "2020-04-09T20:40:41Z", "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/PullBaseImageStep.java", "diffHunk": "@@ -191,7 +191,7 @@ private Image pullBaseImage(\n     EventHandlers eventHandlers = buildContext.getEventHandlers();\n \n     ManifestAndDigest<?> manifestAndDigest =\n-        registryClient.pullManifest(buildContext.getBaseImageConfiguration().getImageTag());\n+        registryClient.pullManifest(buildContext.getBaseImageConfiguration().getImageQualifier());", "originalCommit": "e8395a71fbe3f7bb359ccf9ccfe96d9cf352fc67", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg5ODMwOQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2396#discussion_r406898309", "bodyText": "I will file an issue around these questions. Ultimately, we should guard accidental misuse and confusion.\nUPDATE: filed #2398.", "author": "chanseokoh", "createdAt": "2020-04-10T19:02:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ2NDM2Nw=="}], "type": "inlineReview", "revised_code": null}, {"oid": "7d2abf3ec54ace037dd4d7589abe0994c19b7350", "url": "https://github.com/GoogleContainerTools/jib/commit/7d2abf3ec54ace037dd4d7589abe0994c19b7350", "message": "Changelog", "committedDate": "2020-04-10T16:57:13Z", "type": "commit"}, {"oid": "e23a97576f9f14387ba34c4dec0b60dc9677ad8f", "url": "https://github.com/GoogleContainerTools/jib/commit/e23a97576f9f14387ba34c4dec0b60dc9677ad8f", "message": "Maybe easier to understand", "committedDate": "2020-04-10T18:52:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg5Njg0NA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2396#discussion_r406896844", "bodyText": "This check is probably unnecessary, much like in getQualifer()? We verify either tag or digest is set in the constructor.", "author": "chanseokoh", "createdAt": "2020-04-10T18:58:52Z", "path": "jib-core/src/main/java/com/google/cloud/tools/jib/api/ImageReference.java", "diffHunk": "@@ -378,13 +414,19 @@ private String toString(boolean includeTagIfDigestPresent) {\n       referenceString.append(repository);\n     }\n \n-    if (Strings.isNullOrEmpty(digest) || includeTagIfDigestPresent) {\n-      // Use tag if not the default tag.\n-      if (!DEFAULT_TAG.equals(tag)) {\n+    if (singleQualifier) {\n+      // Include the digest if set, else include the tag\n+      if (!Strings.isNullOrEmpty(digest)) {\n+        referenceString.append('@').append(digest);\n+      } else if (!Strings.isNullOrEmpty(tag)) {", "originalCommit": "e23a97576f9f14387ba34c4dec0b60dc9677ad8f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "388a471584aaa0ef36b0cacdc995ce91e1ae2eb6", "chunk": "diff --git a/jib-core/src/main/java/com/google/cloud/tools/jib/api/ImageReference.java b/jib-core/src/main/java/com/google/cloud/tools/jib/api/ImageReference.java\nindex 909076116..c21563bcd 100644\n--- a/jib-core/src/main/java/com/google/cloud/tools/jib/api/ImageReference.java\n+++ b/jib-core/src/main/java/com/google/cloud/tools/jib/api/ImageReference.java\n\n@@ -415,20 +415,18 @@ public class ImageReference {\n     }\n \n     if (singleQualifier) {\n-      // Include the digest if set, else include the tag\n       if (!Strings.isNullOrEmpty(digest)) {\n         referenceString.append('@').append(digest);\n-      } else if (!Strings.isNullOrEmpty(tag)) {\n+      } else {\n         referenceString.append(':').append(tag);\n       }\n-      return referenceString.toString();\n-    }\n-\n-    if (!Strings.isNullOrEmpty(tag) && !usesDefaultTag()) {\n-      referenceString.append(':').append(tag);\n-    }\n-    if (!Strings.isNullOrEmpty(digest)) {\n-      referenceString.append('@').append(digest);\n+    } else {\n+      if (!Strings.isNullOrEmpty(tag) && !usesDefaultTag()) {\n+        referenceString.append(':').append(tag);\n+      }\n+      if (!Strings.isNullOrEmpty(digest)) {\n+        referenceString.append('@').append(digest);\n+      }\n     }\n \n     return referenceString.toString();\n"}}, {"oid": "388a471584aaa0ef36b0cacdc995ce91e1ae2eb6", "url": "https://github.com/GoogleContainerTools/jib/commit/388a471584aaa0ef36b0cacdc995ce91e1ae2eb6", "message": "Clarity", "committedDate": "2020-04-10T20:09:47Z", "type": "commit"}]}