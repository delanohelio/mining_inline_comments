{"pr_number": 2352, "pr_title": "Push out project version setting to tool", "pr_createdAt": "2020-03-22T00:28:05Z", "pr_url": "https://github.com/GoogleContainerTools/jib/pull/2352", "timeline": [{"oid": "ab4b99f1f548bac24e88ab767bbd02c006e6b6e9", "url": "https://github.com/GoogleContainerTools/jib/commit/ab4b99f1f548bac24e88ab767bbd02c006e6b6e9", "message": "push out project version setting to tool", "committedDate": "2020-03-22T00:35:09Z", "type": "forcePushed"}, {"oid": "08eff88dd12b8f030d643009081494c7ff237599", "url": "https://github.com/GoogleContainerTools/jib/commit/08eff88dd12b8f030d643009081494c7ff237599", "message": "push out project version setting to tool", "committedDate": "2020-03-22T04:34:56Z", "type": "commit"}, {"oid": "08eff88dd12b8f030d643009081494c7ff237599", "url": "https://github.com/GoogleContainerTools/jib/commit/08eff88dd12b8f030d643009081494c7ff237599", "message": "push out project version setting to tool", "committedDate": "2020-03-22T04:34:56Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjU3MjI5NA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2352#discussion_r396572294", "bodyText": "I am guessing the order of version and then name is to preserve the current behavior, but this ordering is really weird. The suffix string should be \"name version\". Ideally \"name/version\" to be compliant with the conventional format in User-Agent, but maybe we'll never able to fix #1067. If we have to preserve the current format, maybe we should set the suffix as \"jib \" + getToolVersion() + \" \" + getToolName() here.", "author": "chanseokoh", "createdAt": "2020-03-23T16:12:42Z", "path": "jib-core/src/main/java/com/google/cloud/tools/jib/configuration/BuildContext.java", "diffHunk": "@@ -500,7 +521,7 @@ public boolean getAlwaysCacheBaseImage() {\n               targetImageConfiguration.getImageRepository(),\n               baseImageConfiguration.getImageRepository(),\n               httpClient)\n-          .setUserAgentSuffix(getToolName());\n+          .setUserAgentSuffix(getToolVersion() + \" \" + getToolName());", "originalCommit": "08eff88dd12b8f030d643009081494c7ff237599", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjU4MDc3Ng==", "url": "https://github.com/GoogleContainerTools/jib/pull/2352#discussion_r396580776", "bodyText": "Yeah this is to preserve behavior. I don't really know what to do about this, but the point of this PR was to change the injection point without changing any behavior.\nthe \"jib\" string is injected at a later point.", "author": "loosebazooka", "createdAt": "2020-03-23T16:23:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjU3MjI5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjU5ODM0NQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2352#discussion_r396598345", "bodyText": "But you already changed the code so that we inject getToolVersion() here as opposed to at a later point. My point is, can't we do the same for the jib string?", "author": "chanseokoh", "createdAt": "2020-03-23T16:47:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjU3MjI5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjYwMDE1Ng==", "url": "https://github.com/GoogleContainerTools/jib/pull/2352#discussion_r396600156", "bodyText": "Oh I see, I misread this, lemme go take a look", "author": "loosebazooka", "createdAt": "2020-03-23T16:50:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjU3MjI5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njc4MzQwNw==", "url": "https://github.com/GoogleContainerTools/jib/pull/2352#discussion_r396783407", "bodyText": "So this one is a little weirder, should reigstry client never build the user agent? Perhaps it should delegate it all to an input?\n\n  \n    \n      jib/jib-core/src/main/java/com/google/cloud/tools/jib/registry/RegistryClient.java\n    \n    \n        Lines 125 to 141\n      in\n      a6aa257\n    \n    \n    \n    \n\n        \n          \n             private String makeUserAgent() { \n        \n\n        \n          \n               if (!JibSystemProperties.isUserAgentEnabled()) { \n        \n\n        \n          \n                 return \"\"; \n        \n\n        \n          \n               } \n        \n\n        \n          \n            \n        \n\n        \n          \n               StringBuilder userAgentBuilder = new StringBuilder(\"jib \").append(ProjectInfo.VERSION); \n        \n\n        \n          \n               if (userAgentSuffix != null) { \n        \n\n        \n          \n                 userAgentBuilder.append(\" \").append(userAgentSuffix); \n        \n\n        \n          \n               } \n        \n\n        \n          \n               if (!Strings.isNullOrEmpty(System.getProperty(JibSystemProperties.UPSTREAM_CLIENT))) { \n        \n\n        \n          \n                 userAgentBuilder \n        \n\n        \n          \n                     .append(\" \") \n        \n\n        \n          \n                     .append(System.getProperty(JibSystemProperties.UPSTREAM_CLIENT)); \n        \n\n        \n          \n               } \n        \n\n        \n          \n               return userAgentBuilder.toString(); \n        \n\n        \n          \n             } \n        \n\n        \n          \n           }", "author": "loosebazooka", "createdAt": "2020-03-23T22:02:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjU3MjI5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjgyMjUyNw==", "url": "https://github.com/GoogleContainerTools/jib/pull/2352#discussion_r396822527", "bodyText": "I haven't looked into this carefully, but I agree. I do remember I thought it was wrong for RegistryClient to build any part of the user agent. RegistryClient should really be like an independent library where the libraries user should have full control over the user agent. I remember I tried to refactor this but quit shortly after it got into a snowball.", "author": "chanseokoh", "createdAt": "2020-03-23T23:36:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjU3MjI5NA=="}], "type": "inlineReview", "revised_code": {"commit": "bade91d6df8d94f3a1bef2df3cba1689d1437b9f", "chunk": "diff --git a/jib-core/src/main/java/com/google/cloud/tools/jib/configuration/BuildContext.java b/jib-core/src/main/java/com/google/cloud/tools/jib/configuration/BuildContext.java\nindex f5b59f7f..5a799379 100644\n--- a/jib-core/src/main/java/com/google/cloud/tools/jib/configuration/BuildContext.java\n+++ b/jib-core/src/main/java/com/google/cloud/tools/jib/configuration/BuildContext.java\n\n@@ -521,7 +522,7 @@ public class BuildContext implements Closeable {\n               targetImageConfiguration.getImageRepository(),\n               baseImageConfiguration.getImageRepository(),\n               httpClient)\n-          .setUserAgentSuffix(getToolVersion() + \" \" + getToolName());\n+          .setUserAgent(makeUserAgent());\n     }\n     return newRegistryClientFactory(targetImageConfiguration);\n   }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjU3MjYxNA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2352#discussion_r396572614", "bodyText": "So related to my previous comment, I didn't like the current format jib 2.1.0 jib-maven-plugin, which should really be like jib-maven-plugin/2.1.0 jib-core/0.13.0-SNAPSHOT Google-HTTP-Java-Client/1.27.0. Maybe don't add jib here, but set it inside userAgentSuffix?", "author": "chanseokoh", "createdAt": "2020-03-23T16:13:03Z", "path": "jib-core/src/main/java/com/google/cloud/tools/jib/registry/RegistryClient.java", "diffHunk": "@@ -127,7 +126,7 @@ private String makeUserAgent() {\n         return \"\";\n       }\n \n-      StringBuilder userAgentBuilder = new StringBuilder(\"jib \").append(ProjectInfo.VERSION);\n+      StringBuilder userAgentBuilder = new StringBuilder(\"jib\");", "originalCommit": "08eff88dd12b8f030d643009081494c7ff237599", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjU4NjI1OA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2352#discussion_r396586258", "bodyText": "I don't think we can actually change this. We have dependencies on parsing this in other systems.", "author": "loosebazooka", "createdAt": "2020-03-23T16:31:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjU3MjYxNA=="}], "type": "inlineReview", "revised_code": {"commit": "bade91d6df8d94f3a1bef2df3cba1689d1437b9f", "chunk": "diff --git a/jib-core/src/main/java/com/google/cloud/tools/jib/registry/RegistryClient.java b/jib-core/src/main/java/com/google/cloud/tools/jib/registry/RegistryClient.java\nindex 861dfabb..b00abf31 100644\n--- a/jib-core/src/main/java/com/google/cloud/tools/jib/registry/RegistryClient.java\n+++ b/jib-core/src/main/java/com/google/cloud/tools/jib/registry/RegistryClient.java\n\n@@ -106,36 +105,7 @@ public class RegistryClient {\n      */\n     public RegistryClient newRegistryClient() {\n       return new RegistryClient(\n-          eventHandlers,\n-          credential,\n-          registryEndpointRequestProperties,\n-          makeUserAgent(),\n-          httpClient);\n-    }\n-\n-    /**\n-     * The {@code User-Agent} is in the form of {@code jib <version> <type>}. For example: {@code\n-     * jib 0.9.0 jib-maven-plugin}.\n-     *\n-     * @return the {@code User-Agent} header to send. The {@code User-Agent} can be disabled by\n-     *     setting the system property variable {@code _JIB_DISABLE_USER_AGENT} to any non-empty\n-     *     string.\n-     */\n-    private String makeUserAgent() {\n-      if (!JibSystemProperties.isUserAgentEnabled()) {\n-        return \"\";\n-      }\n-\n-      StringBuilder userAgentBuilder = new StringBuilder(\"jib\");\n-      if (userAgentSuffix != null) {\n-        userAgentBuilder.append(\" \").append(userAgentSuffix);\n-      }\n-      if (!Strings.isNullOrEmpty(System.getProperty(JibSystemProperties.UPSTREAM_CLIENT))) {\n-        userAgentBuilder\n-            .append(\" \")\n-            .append(System.getProperty(JibSystemProperties.UPSTREAM_CLIENT));\n-      }\n-      return userAgentBuilder.toString();\n+          eventHandlers, credential, registryEndpointRequestProperties, userAgent, httpClient);\n     }\n   }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjU3NjE5MA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2352#discussion_r396576190", "bodyText": "It feels weird that the parameter is declared as @Nullable but passing a null causes an exception. Perhaps the caller should do Verify.verifyNotNull() before passing the argument.", "author": "chanseokoh", "createdAt": "2020-03-23T16:17:42Z", "path": "jib-maven-plugin/src/main/java/com/google/cloud/tools/jib/maven/MavenProjectProperties.java", "diffHunk": "@@ -82,18 +83,22 @@\n   /**\n    * Static factory method for {@link MavenProjectProperties}.\n    *\n+   * @param jibPluginDescriptor the jib-maven-plugin plugin descriptor\n    * @param project the {@link MavenProject} for the plugin.\n    * @param session the {@link MavenSession} for the plugin.\n    * @param log the Maven {@link Log} to log messages during Jib execution\n    * @param tempDirectoryProvider temporary directory provider\n    * @return a MavenProjectProperties from the given project and logger.\n    */\n   public static MavenProjectProperties getForProject(\n+      @Nullable PluginDescriptor jibPluginDescriptor,\n       MavenProject project,\n       MavenSession session,\n       Log log,\n       TempDirectoryProvider tempDirectoryProvider) {\n-    return new MavenProjectProperties(project, session, log, tempDirectoryProvider);\n+    Preconditions.checkNotNull(jibPluginDescriptor);", "originalCommit": "08eff88dd12b8f030d643009081494c7ff237599", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjU4MTYyNw==", "url": "https://github.com/GoogleContainerTools/jib/pull/2352#discussion_r396581627", "bodyText": "That's a good point.", "author": "loosebazooka", "createdAt": "2020-03-23T16:24:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjU3NjE5MA=="}], "type": "inlineReview", "revised_code": {"commit": "684e8f40f0fb4daa793a1ca1d301a474255e7d0f", "chunk": "diff --git a/jib-maven-plugin/src/main/java/com/google/cloud/tools/jib/maven/MavenProjectProperties.java b/jib-maven-plugin/src/main/java/com/google/cloud/tools/jib/maven/MavenProjectProperties.java\nindex e0485c51..d21bbf9c 100644\n--- a/jib-maven-plugin/src/main/java/com/google/cloud/tools/jib/maven/MavenProjectProperties.java\n+++ b/jib-maven-plugin/src/main/java/com/google/cloud/tools/jib/maven/MavenProjectProperties.java\n\n@@ -91,7 +91,7 @@ public class MavenProjectProperties implements ProjectProperties {\n    * @return a MavenProjectProperties from the given project and logger.\n    */\n   public static MavenProjectProperties getForProject(\n-      @Nullable PluginDescriptor jibPluginDescriptor,\n+      PluginDescriptor jibPluginDescriptor,\n       MavenProject project,\n       MavenSession session,\n       Log log,\n"}}, {"oid": "684e8f40f0fb4daa793a1ca1d301a474255e7d0f", "url": "https://github.com/GoogleContainerTools/jib/commit/684e8f40f0fb4daa793a1ca1d301a474255e7d0f", "message": "move null check earlier", "committedDate": "2020-03-23T22:00:38Z", "type": "commit"}, {"oid": "bade91d6df8d94f3a1bef2df3cba1689d1437b9f", "url": "https://github.com/GoogleContainerTools/jib/commit/bade91d6df8d94f3a1bef2df3cba1689d1437b9f", "message": "construct user agent string in build context", "committedDate": "2020-03-25T23:33:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODU4MTk1Mg==", "url": "https://github.com/GoogleContainerTools/jib/pull/2352#discussion_r398581952", "bodyText": "\"Sets a the ...\" --> \"Sets the ...\"", "author": "chanseokoh", "createdAt": "2020-03-26T13:44:09Z", "path": "jib-core/src/main/java/com/google/cloud/tools/jib/registry/RegistryClient.java", "diffHunk": "@@ -89,13 +88,13 @@ public Factory setCredential(@Nullable Credential credential) {\n     }\n \n     /**\n-     * Sets a suffix to append to {@code User-Agent} headers. See {@link #makeUserAgent()}.\n+     * Sets a the value of {@code User-Agent} in headers for registry requests.", "originalCommit": "bade91d6df8d94f3a1bef2df3cba1689d1437b9f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "401887a29bc689d5ecb1a300f81d0a476968fea6", "chunk": "diff --git a/jib-core/src/main/java/com/google/cloud/tools/jib/registry/RegistryClient.java b/jib-core/src/main/java/com/google/cloud/tools/jib/registry/RegistryClient.java\nindex b00abf31..2089490c 100644\n--- a/jib-core/src/main/java/com/google/cloud/tools/jib/registry/RegistryClient.java\n+++ b/jib-core/src/main/java/com/google/cloud/tools/jib/registry/RegistryClient.java\n\n@@ -88,12 +88,12 @@ public class RegistryClient {\n     }\n \n     /**\n-     * Sets a the value of {@code User-Agent} in headers for registry requests.\n+     * Sets the value of {@code User-Agent} in headers for registry requests.\n      *\n-     * @param userAgent non-null user agent string, can be empty\n+     * @param userAgent user agent string\n      * @return this\n      */\n-    public Factory setUserAgent(String userAgent) {\n+    public Factory setUserAgent(@Nullable String userAgent) {\n       this.userAgent = userAgent;\n       return this;\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODYzMzMzNg==", "url": "https://github.com/GoogleContainerTools/jib/pull/2352#discussion_r398633336", "bodyText": "jib <version> <type> --> jib <toolVersion> <toolName>", "author": "chanseokoh", "createdAt": "2020-03-26T14:50:29Z", "path": "jib-core/src/main/java/com/google/cloud/tools/jib/configuration/BuildContext.java", "diffHunk": "@@ -521,4 +543,27 @@ public void close() throws IOException {\n     }\n     httpClient.shutDown();\n   }\n+\n+  /**\n+   * The {@code User-Agent} is in the form of {@code jib <version> <type>}. For example: {@code jib", "originalCommit": "bade91d6df8d94f3a1bef2df3cba1689d1437b9f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "401887a29bc689d5ecb1a300f81d0a476968fea6", "chunk": "diff --git a/jib-core/src/main/java/com/google/cloud/tools/jib/configuration/BuildContext.java b/jib-core/src/main/java/com/google/cloud/tools/jib/configuration/BuildContext.java\nindex 5a799379..b144840d 100644\n--- a/jib-core/src/main/java/com/google/cloud/tools/jib/configuration/BuildContext.java\n+++ b/jib-core/src/main/java/com/google/cloud/tools/jib/configuration/BuildContext.java\n\n@@ -545,8 +545,8 @@ public class BuildContext implements Closeable {\n   }\n \n   /**\n-   * The {@code User-Agent} is in the form of {@code jib <version> <type>}. For example: {@code jib\n-   * 0.9.0 jib-maven-plugin}.\n+   * The {@code User-Agent} is in the form of {@code jib <toolVersion> <toolName>}. For example:\n+   * {@code jib 0.9.0 jib-maven-plugin}.\n    *\n    * @return the {@code User-Agent} header to send. The {@code User-Agent} can be disabled by\n    *     setting the system property variable {@code _JIB_DISABLE_USER_AGENT} to any non-empty\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODYzMzg2MA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2352#discussion_r398633860", "bodyText": "private static\nSo Gradle doesn't have something like PluginDescriptor?", "author": "chanseokoh", "createdAt": "2020-03-26T14:51:10Z", "path": "jib-gradle-plugin/src/main/java/com/google/cloud/tools/jib/gradle/GradleProjectProperties.java", "diffHunk": "@@ -69,6 +69,10 @@\n   /** Used to generate the User-Agent header and history metadata. */\n   private static final String TOOL_NAME = \"jib-gradle-plugin\";\n \n+  /** Used to generate the User-Agent header and history metadata and verify versions. */\n+  static final String TOOL_VERSION =", "originalCommit": "bade91d6df8d94f3a1bef2df3cba1689d1437b9f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODc2OTg0MQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2352#discussion_r398769841", "bodyText": "Yeah I don't think so, I tried looking :\\", "author": "loosebazooka", "createdAt": "2020-03-26T17:46:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODYzMzg2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODc5NzI2Mg==", "url": "https://github.com/GoogleContainerTools/jib/pull/2352#discussion_r398797262", "bodyText": "The one option is to search the build classpath for jib-gradle-plugin and extract the version from there. But that's basically the same as doing this.", "author": "loosebazooka", "createdAt": "2020-03-26T18:25:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODYzMzg2MA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "401887a29bc689d5ecb1a300f81d0a476968fea6", "url": "https://github.com/GoogleContainerTools/jib/commit/401887a29bc689d5ecb1a300f81d0a476968fea6", "message": "registry client accept null useragent + fixes", "committedDate": "2020-03-26T18:15:44Z", "type": "commit"}, {"oid": "23eacbe643e7d2d0b449c94dfd19df109b5e6103", "url": "https://github.com/GoogleContainerTools/jib/commit/23eacbe643e7d2d0b449c94dfd19df109b5e6103", "message": "undo the nullable removal for now", "committedDate": "2020-03-26T18:35:41Z", "type": "commit"}]}