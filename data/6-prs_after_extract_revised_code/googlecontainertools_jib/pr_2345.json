{"pr_number": 2345, "pr_title": "Add glob support for extra file permissions", "pr_createdAt": "2020-03-19T17:22:21Z", "pr_url": "https://github.com/GoogleContainerTools/jib/pull/2345", "timeline": [{"oid": "f28125fb7bbb8927507ee1a6cf2b8da30057fda9", "url": "https://github.com/GoogleContainerTools/jib/commit/f28125fb7bbb8927507ee1a6cf2b8da30057fda9", "message": "Add glob support for extra file permissions", "committedDate": "2020-03-19T17:13:47Z", "type": "commit"}, {"oid": "9135fc1f4fa85418cd8a02a5ea7ec6a97c7144ae", "url": "https://github.com/GoogleContainerTools/jib/commit/9135fc1f4fa85418cd8a02a5ea7ec6a97c7144ae", "message": "Merge branch 'master' of github.com:GoogleContainerTools/jib into i1200-permission-globs", "committedDate": "2020-03-19T17:27:15Z", "type": "commit"}, {"oid": "feab7ab96ffa49d719e4a578f1c6c4f2d68038d1", "url": "https://github.com/GoogleContainerTools/jib/commit/feab7ab96ffa49d719e4a578f1c6c4f2d68038d1", "message": "Maintain order", "committedDate": "2020-03-20T16:51:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkxNjI2NQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2345#discussion_r395916265", "bodyText": "This looks good. I just think we can instantiate PathMatchers before new DirectoryWalker(...). That way, we don't have to instantiate them over and over for each file in extraDirectory. Then at least we won't instantiate them again within the same layer. This is a minor optimization, but I think it's worth, because\n\nIn practice, almost all the time, you will have some files whose permissions are not configured. That is, you'll get into this line a lot.\nThe optimization doesn't add new code but just amounts to moving the code outside .walk().\n\nWe could even skip path strings that aren't glob, but I think this is unnecessary and rather adds more code.\nWDYT?", "author": "chanseokoh", "createdAt": "2020-03-20T22:26:57Z", "path": "jib-plugins-common/src/main/java/com/google/cloud/tools/jib/plugins/common/JavaContainerBuilderHelper.java", "diffHunk": "@@ -58,10 +62,26 @@ public static FileEntriesLayer extraDirectoryLayerConfiguration(\n               AbsoluteUnixPath pathOnContainer =\n                   AbsoluteUnixPath.get(\"/\").resolve(extraDirectory.relativize(localPath));\n               Instant modificationTime = modificationTimeProvider.apply(localPath, pathOnContainer);\n-              FilePermissions permissions = extraDirectoryPermissions.get(pathOnContainer);\n+              FilePermissions permissions =\n+                  extraDirectoryPermissions.get(pathOnContainer.toString());\n               if (permissions == null) {\n+                // Check for matching globs\n+                Path containerPath = Paths.get(pathOnContainer.toString());\n+                for (Map.Entry<String, FilePermissions> entry :\n+                    extraDirectoryPermissions.entrySet()) {\n+                  PathMatcher pathMatcher =\n+                      FileSystems.getDefault().getPathMatcher(\"glob:\" + entry.getKey());", "originalCommit": "feab7ab96ffa49d719e4a578f1c6c4f2d68038d1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5e9cd2c9596a58cd2c7f8300ec9a5faeb809c2e8", "chunk": "diff --git a/jib-plugins-common/src/main/java/com/google/cloud/tools/jib/plugins/common/JavaContainerBuilderHelper.java b/jib-plugins-common/src/main/java/com/google/cloud/tools/jib/plugins/common/JavaContainerBuilderHelper.java\nindex 84a99f97..f3b748ba 100644\n--- a/jib-plugins-common/src/main/java/com/google/cloud/tools/jib/plugins/common/JavaContainerBuilderHelper.java\n+++ b/jib-plugins-common/src/main/java/com/google/cloud/tools/jib/plugins/common/JavaContainerBuilderHelper.java\n\n@@ -55,6 +57,11 @@ public class JavaContainerBuilderHelper {\n       throws IOException {\n     FileEntriesLayer.Builder builder =\n         FileEntriesLayer.builder().setName(LayerType.EXTRA_FILES.getName());\n+    Map<String, PathMatcher> pathMatchers = new HashMap<>();\n+    for (String glob : extraDirectoryPermissions.keySet()) {\n+      pathMatchers.put(glob, FileSystems.getDefault().getPathMatcher(\"glob:\" + glob));\n+    }\n+\n     new DirectoryWalker(extraDirectory)\n         .filterRoot()\n         .walk(\n"}}, {"oid": "5e9cd2c9596a58cd2c7f8300ec9a5faeb809c2e8", "url": "https://github.com/GoogleContainerTools/jib/commit/5e9cd2c9596a58cd2c7f8300ec9a5faeb809c2e8", "message": "Instantiate patterns before walking", "committedDate": "2020-03-20T23:42:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk0MzkwOQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2345#discussion_r395943909", "bodyText": "Hmm... Isn't Map<PathMatcher, Permissions> more natural? Inside walk(), you iterate over this map instead of extraDirectoryPermissions.", "author": "chanseokoh", "createdAt": "2020-03-21T00:46:39Z", "path": "jib-plugins-common/src/main/java/com/google/cloud/tools/jib/plugins/common/JavaContainerBuilderHelper.java", "diffHunk": "@@ -46,22 +52,43 @@\n    */\n   public static FileEntriesLayer extraDirectoryLayerConfiguration(\n       Path extraDirectory,\n-      Map<AbsoluteUnixPath, FilePermissions> extraDirectoryPermissions,\n+      Map<String, FilePermissions> extraDirectoryPermissions,\n       BiFunction<Path, AbsoluteUnixPath, Instant> modificationTimeProvider)\n       throws IOException {\n     FileEntriesLayer.Builder builder =\n         FileEntriesLayer.builder().setName(LayerType.EXTRA_FILES.getName());\n+    Map<String, PathMatcher> pathMatchers = new HashMap<>();", "originalCommit": "5e9cd2c9596a58cd2c7f8300ec9a5faeb809c2e8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk0NDUzOA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2345#discussion_r395944538", "bodyText": "Oh, yeah. Wasn't seeing it at the time but I get it now.", "author": "TadCordle", "createdAt": "2020-03-21T00:51:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk0MzkwOQ=="}], "type": "inlineReview", "revised_code": {"commit": "601154c8c2c7add776d53af690f08feb649110c2", "chunk": "diff --git a/jib-plugins-common/src/main/java/com/google/cloud/tools/jib/plugins/common/JavaContainerBuilderHelper.java b/jib-plugins-common/src/main/java/com/google/cloud/tools/jib/plugins/common/JavaContainerBuilderHelper.java\nindex f3b748ba..a94aea5c 100644\n--- a/jib-plugins-common/src/main/java/com/google/cloud/tools/jib/plugins/common/JavaContainerBuilderHelper.java\n+++ b/jib-plugins-common/src/main/java/com/google/cloud/tools/jib/plugins/common/JavaContainerBuilderHelper.java\n\n@@ -57,9 +56,9 @@ public class JavaContainerBuilderHelper {\n       throws IOException {\n     FileEntriesLayer.Builder builder =\n         FileEntriesLayer.builder().setName(LayerType.EXTRA_FILES.getName());\n-    Map<String, PathMatcher> pathMatchers = new HashMap<>();\n-    for (String glob : extraDirectoryPermissions.keySet()) {\n-      pathMatchers.put(glob, FileSystems.getDefault().getPathMatcher(\"glob:\" + glob));\n+    Map<PathMatcher, FilePermissions> pathMatchers = new HashMap<>();\n+    for (Map.Entry<String, FilePermissions> glob : extraDirectoryPermissions.entrySet()) {\n+      pathMatchers.put(FileSystems.getDefault().getPathMatcher(\"glob:\" + glob), glob.getValue());\n     }\n \n     new DirectoryWalker(extraDirectory)\n"}}, {"oid": "601154c8c2c7add776d53af690f08feb649110c2", "url": "https://github.com/GoogleContainerTools/jib/commit/601154c8c2c7add776d53af690f08feb649110c2", "message": "Better", "committedDate": "2020-03-21T00:51:34Z", "type": "commit"}, {"oid": "4d9176f589c4478c733e307b39353c476e004f92", "url": "https://github.com/GoogleContainerTools/jib/commit/4d9176f589c4478c733e307b39353c476e004f92", "message": "oops", "committedDate": "2020-03-21T01:03:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUwMDE2MQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2345#discussion_r396500161", "bodyText": "Did we add something to \"validate a layer\"?", "author": "chanseokoh", "createdAt": "2020-03-23T14:39:33Z", "path": "jib-plugins-common/src/main/java/com/google/cloud/tools/jib/plugins/common/JavaContainerBuilderHelper.java", "diffHunk": "@@ -36,7 +40,8 @@\n public class JavaContainerBuilderHelper {\n \n   /**\n-   * Returns a {@link FileEntriesLayer} for adding the extra directory to the container.\n+   * Validates and returns a {@link FileEntriesLayer} for adding the extra directory to the", "originalCommit": "4d9176f589c4478c733e307b39353c476e004f92", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "cb1894a8a4b3faae043db0618baf1ca7dd9ccd9d", "chunk": "diff --git a/jib-plugins-common/src/main/java/com/google/cloud/tools/jib/plugins/common/JavaContainerBuilderHelper.java b/jib-plugins-common/src/main/java/com/google/cloud/tools/jib/plugins/common/JavaContainerBuilderHelper.java\nindex 7a6751d0..1ee26d4b 100644\n--- a/jib-plugins-common/src/main/java/com/google/cloud/tools/jib/plugins/common/JavaContainerBuilderHelper.java\n+++ b/jib-plugins-common/src/main/java/com/google/cloud/tools/jib/plugins/common/JavaContainerBuilderHelper.java\n\n@@ -40,8 +40,7 @@ import java.util.function.Predicate;\n public class JavaContainerBuilderHelper {\n \n   /**\n-   * Validates and returns a {@link FileEntriesLayer} for adding the extra directory to the\n-   * container.\n+   * Returns a {@link FileEntriesLayer} for adding the extra directory to the container.\n    *\n    * @param extraDirectory the source extra directory path\n    * @param extraDirectoryPermissions map from path on container to file permissions\n"}}, {"oid": "cb1894a8a4b3faae043db0618baf1ca7dd9ccd9d", "url": "https://github.com/GoogleContainerTools/jib/commit/cb1894a8a4b3faae043db0618baf1ca7dd9ccd9d", "message": "Fix comment", "committedDate": "2020-03-24T15:16:39Z", "type": "commit"}]}