{"pr_number": 1487, "pr_title": "Add new Xtext editor quickfixes on *.xtext files", "pr_createdAt": "2020-07-06T13:15:54Z", "pr_url": "https://github.com/eclipse/xtext-eclipse/pull/1487", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY0ODg5Nw==", "url": "https://github.com/eclipse/xtext-eclipse/pull/1487#discussion_r450648897", "bodyText": "Do we also get the Convert terminal fragment to terminal rule quickfix for this case?", "author": "szarnekow", "createdAt": "2020-07-07T06:57:19Z", "path": "org.eclipse.xtext.xtext.ui.tests/src/org/eclipse/xtext/xtext/ui/editor/quickfix/XtextGrammarQuickfixProviderTest.java", "diffHunk": "@@ -184,6 +184,30 @@ public void fixAddActionForGrammarWithAlias() throws Exception {\n \t\t\t\t\"Add actions to ensure object creation\");\n \t}\n \n+\t@Test\n+\tpublic void testConvertTerminalFragmentToTerminalRule() throws Exception {\n+\t\tassertAndApplySingleResolution(editorForGrammar(\"Model: digit=ABC;\", \"terminal fragment ABC: '0'..'9';\"),\n+\t\t\t\tINVALID_TERMINAL_FRAGMENT_RULE_REFERENCE, 0, \"Convert terminal fragment to terminal rule\");\n+\t}\n+\n+\t@Test\n+\tpublic void testFixInvalidTerminalFragmentHiddenToken() throws Exception {\n+\t\tassertAndApplySingleResolution(editorForGrammar(\"Model hidden(ABC): a=ID;\", \"terminal fragment ABC: '0'..'9';\"),", "originalCommit": "7dbf31822fc6944ac2a4579d8d6225d01732f4c1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzUxMTI4Nw==", "url": "https://github.com/eclipse/xtext-eclipse/pull/1487#discussion_r453511287", "bodyText": "I have enhanced the code to show the above quick-fix.", "author": "nbhusare", "createdAt": "2020-07-13T09:18:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY0ODg5Nw=="}], "type": "inlineReview", "revised_code": {"commit": "61c110e5777fed7f2df21cb0dfe5ceb36ac9c639", "chunk": "diff --git a/org.eclipse.xtext.xtext.ui.tests/src/org/eclipse/xtext/xtext/ui/editor/quickfix/XtextGrammarQuickfixProviderTest.java b/org.eclipse.xtext.xtext.ui.tests/src/org/eclipse/xtext/xtext/ui/editor/quickfix/XtextGrammarQuickfixProviderTest.java\nindex 21a72d9ba..58040343a 100644\n--- a/org.eclipse.xtext.xtext.ui.tests/src/org/eclipse/xtext/xtext/ui/editor/quickfix/XtextGrammarQuickfixProviderTest.java\n+++ b/org.eclipse.xtext.xtext.ui.tests/src/org/eclipse/xtext/xtext/ui/editor/quickfix/XtextGrammarQuickfixProviderTest.java\n\n@@ -189,6 +189,12 @@ public class XtextGrammarQuickfixProviderTest extends AbstractQuickfixTest {\n \t\tassertAndApplySingleResolution(editorForGrammar(\"Model: digit=ABC;\", \"terminal fragment ABC: '0'..'9';\"),\n \t\t\t\tINVALID_TERMINAL_FRAGMENT_RULE_REFERENCE, 0, \"Convert terminal fragment to terminal rule\");\n \t}\n+\t\n+\t@Test\n+\tpublic void testConvertTerminalFragmentWithInlineCommandToTerminalRule() throws Exception {\n+\t\tassertAndApplySingleResolution(editorForGrammar(\"Model: digit=ABC;\", \"terminal fragment/*comment*/FRAG: 'a';\"),\n+\t\t\t\tINVALID_TERMINAL_FRAGMENT_RULE_REFERENCE, 0, \"Convert terminal fragment to terminal rule\");\n+\t}\n \n \t@Test\n \tpublic void testFixInvalidTerminalFragmentHiddenToken() throws Exception {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY0OTM5MA==", "url": "https://github.com/eclipse/xtext-eclipse/pull/1487#discussion_r450649390", "bodyText": "Please reword to Create terminal fragment instead of Create terminal fragment rule", "author": "szarnekow", "createdAt": "2020-07-07T06:58:23Z", "path": "org.eclipse.xtext.xtext.ui/src/org/eclipse/xtext/xtext/ui/editor/quickfix/XtextGrammarQuickfixProvider.java", "diffHunk": "@@ -134,24 +137,39 @@\n \t@Inject\n \tprivate ILineSeparatorInformation separatorInfo;\n \t\n+\t@Inject\n+\tprivate XtextGrammarAccess grammarAccess;\n+\t\n \t@Fix(XtextLinkingDiagnosticMessageProvider.UNRESOLVED_RULE)\n \tpublic void fixUnresolvedRule(final Issue issue, IssueResolutionAcceptor acceptor) {\n \t\tfinal String ruleName = issue.getData()[0];\n-\t\tacceptor.accept(issue, \"Create rule '\" + ruleName + \"'\", \"Create rule '\" + ruleName + \"'\", NULL_QUICKFIX_IMAGE,\n-\t\t\t\tnew ISemanticModification() {\n-\t\t\t\t\t@Override\n-\t\t\t\t\tpublic void apply(final EObject element, IModificationContext context) throws BadLocationException {\n-\t\t\t\t\t\tAbstractRule abstractRule = EcoreUtil2.getContainerOfType(element, ParserRule.class);\n-\t\t\t\t\t\tICompositeNode node = NodeModelUtils.getNode(abstractRule);\n-\t\t\t\t\t\tint offset = node.getEndOffset();\n-\t\t\t\t\t\tString nl = context.getXtextDocument().getLineDelimiter(0);\n-\t\t\t\t\t\tStringBuilder builder = new StringBuilder(nl+nl);\n-\t\t\t\t\t\tif (abstractRule instanceof TerminalRule)\n-\t\t\t\t\t\t\tbuilder.append(\"terminal \");\n-\t\t\t\t\t\tString newRule = builder.append(ruleName).append(\":\" + nl + \"\\t\" + nl + \";\").toString();\n-\t\t\t\t\t\tcontext.getXtextDocument().replace(offset, 0, newRule);\n-\t\t\t\t\t}\n-\t\t\t\t});\n+\t\tacceptor.accept(issue, // \n+\t\t\t\t\"Create rule '\" + ruleName + \"'\", //\n+\t\t\t\t\"Create rule '\" + ruleName + \"'\", //\n+\t\t\t\tNULL_QUICKFIX_IMAGE, //\n+\t\t\t\tcreateNewRule(ruleName, false));\n+\t\tcreateLinkingIssueResolutions(issue, acceptor);\n+\t}\n+\n+\t@Fix(XtextLinkingDiagnosticMessageProvider.UNRESOLVED_TERMINAL_RULE)\n+\tpublic void fixUnresolvedTerminalRule(final Issue issue, IssueResolutionAcceptor acceptor) {\n+\t\tfinal String ruleName = issue.getData()[0];\n+\t\tacceptor.accept(issue, //\n+\t\t\t\t\"Create terminal rule '\" + ruleName + \"'\", // \n+\t\t\t\t\"Create terminal rule '\" + ruleName + \"'\", //\n+\t\t\t\tNULL_QUICKFIX_IMAGE, //\n+\t\t\t\tcreateNewRule(ruleName, false));\n+\t\tcreateLinkingIssueResolutions(issue, acceptor);\n+\t}\n+\t\n+\t@Fix(XtextLinkingDiagnosticMessageProvider.UNRESOLVED_TERMINAL_RULE)\n+\tpublic void fixUnresolvedTerminalFragmentRule(final Issue issue, IssueResolutionAcceptor acceptor) {\n+\t\tfinal String ruleName = issue.getData()[0];\n+\t\tacceptor.accept(issue, //\n+\t\t\t\t\"Create terminal fragment rule '\" + ruleName + \"'\", // ", "originalCommit": "7dbf31822fc6944ac2a4579d8d6225d01732f4c1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzUxNTE3Mw==", "url": "https://github.com/eclipse/xtext-eclipse/pull/1487#discussion_r453515173", "bodyText": "Done.", "author": "nbhusare", "createdAt": "2020-07-13T09:24:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY0OTM5MA=="}], "type": "inlineReview", "revised_code": {"commit": "61c110e5777fed7f2df21cb0dfe5ceb36ac9c639", "chunk": "diff --git a/org.eclipse.xtext.xtext.ui/src/org/eclipse/xtext/xtext/ui/editor/quickfix/XtextGrammarQuickfixProvider.java b/org.eclipse.xtext.xtext.ui/src/org/eclipse/xtext/xtext/ui/editor/quickfix/XtextGrammarQuickfixProvider.java\nindex 4e93c25ef..759bc89c2 100644\n--- a/org.eclipse.xtext.xtext.ui/src/org/eclipse/xtext/xtext/ui/editor/quickfix/XtextGrammarQuickfixProvider.java\n+++ b/org.eclipse.xtext.xtext.ui/src/org/eclipse/xtext/xtext/ui/editor/quickfix/XtextGrammarQuickfixProvider.java\n\n@@ -155,8 +155,8 @@ public class XtextGrammarQuickfixProvider extends DefaultQuickfixProvider {\n \tpublic void fixUnresolvedTerminalRule(final Issue issue, IssueResolutionAcceptor acceptor) {\n \t\tfinal String ruleName = issue.getData()[0];\n \t\tacceptor.accept(issue, //\n-\t\t\t\t\"Create terminal rule '\" + ruleName + \"'\", // \n-\t\t\t\t\"Create terminal rule '\" + ruleName + \"'\", //\n+\t\t\t\t\"Create terminal '\" + ruleName + \"'\", // \n+\t\t\t\t\"Create terminal '\" + ruleName + \"'\", //\n \t\t\t\tNULL_QUICKFIX_IMAGE, //\n \t\t\t\tcreateNewRule(ruleName, false));\n \t\tcreateLinkingIssueResolutions(issue, acceptor);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY0OTk2Mg==", "url": "https://github.com/eclipse/xtext-eclipse/pull/1487#discussion_r450649962", "bodyText": "I know that it is extremely unlikely to have that in production, but could you please add a test with this rule declaration:\nterminal fragment/*comment*/FRAG: 'a';", "author": "szarnekow", "createdAt": "2020-07-07T06:59:43Z", "path": "org.eclipse.xtext.xtext.ui/src/org/eclipse/xtext/xtext/ui/editor/quickfix/XtextGrammarQuickfixProvider.java", "diffHunk": "@@ -599,5 +617,75 @@ private void applyToNode(AbstractElement node, String actionText, MultiTextEdit\n \t\t\t\t\t}\n \t\t\t\t});\n \t}\n+\t\n+\t@Fix(INVALID_TERMINAL_FRAGMENT_RULE_REFERENCE)\n+\tpublic void fixConvertTerminalFragmentToTerminalRule(Issue issue, IssueResolutionAcceptor acceptor) {\n+\t\tacceptor.accept(issue, //\n+\t\t\t\t\"Convert terminal fragment to terminal rule\", //\n+\t\t\t\t\"Convert terminal fragment to terminal rule\", //\n+\t\t\t\tNULL_QUICKFIX_IMAGE, //\n+\t\t\t\t(context) -> {\n+\t\t\t\t\tIXtextDocument xtextDocument = context.getXtextDocument();\n+\t\t\t\t\txtextDocument.modify(new IUnitOfWork.Void<XtextResource>() {\n+\n+\t\t\t\t\t\t@Override\n+\t\t\t\t\t\tpublic void process(XtextResource state) throws Exception {\n+\t\t\t\t\t\t\tif (state == null) {\n+\t\t\t\t\t\t\t\treturn;\n+\t\t\t\t\t\t\t}\n+\n+\t\t\t\t\t\t\tRuleCall ruleCall = (RuleCall) state.getEObject(issue.getUriToProblem().fragment());\n+\t\t\t\t\t\t\tICompositeNode ruleNode = NodeModelUtils.findActualNodeFor(ruleCall.getRule());\n+\t\t\t\t\t\t\tfor (INode node : ruleNode.getAsTreeIterable()) {\n+\t\t\t\t\t\t\t\tif (node.getGrammarElement() != null && node.getGrammarElement() == grammarAccess.getTerminalRuleAccess()\n+\t\t\t\t\t\t\t\t\t\t.getFragmentFragmentKeyword_2_0_0_0()) {\n+\t\t\t\t\t\t\t\t\tITextRegion fragmentRegion = node.getTextRegion();\n+\t\t\t\t\t\t\t\t\txtextDocument.replace(fragmentRegion.getOffset(), fragmentRegion.getLength() + 1, \"\");", "originalCommit": "7dbf31822fc6944ac2a4579d8d6225d01732f4c1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzUxNDUyNA==", "url": "https://github.com/eclipse/xtext-eclipse/pull/1487#discussion_r453514524", "bodyText": "I had to adapt the code after introducing the test for the above rule declaration. Could you please verify the changes.", "author": "nbhusare", "createdAt": "2020-07-13T09:23:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY0OTk2Mg=="}], "type": "inlineReview", "revised_code": {"commit": "61c110e5777fed7f2df21cb0dfe5ceb36ac9c639", "chunk": "diff --git a/org.eclipse.xtext.xtext.ui/src/org/eclipse/xtext/xtext/ui/editor/quickfix/XtextGrammarQuickfixProvider.java b/org.eclipse.xtext.xtext.ui/src/org/eclipse/xtext/xtext/ui/editor/quickfix/XtextGrammarQuickfixProvider.java\nindex 4e93c25ef..759bc89c2 100644\n--- a/org.eclipse.xtext.xtext.ui/src/org/eclipse/xtext/xtext/ui/editor/quickfix/XtextGrammarQuickfixProvider.java\n+++ b/org.eclipse.xtext.xtext.ui/src/org/eclipse/xtext/xtext/ui/editor/quickfix/XtextGrammarQuickfixProvider.java\n\n@@ -618,6 +618,7 @@ public class XtextGrammarQuickfixProvider extends DefaultQuickfixProvider {\n \t\t\t\t});\n \t}\n \t\n+\t@Fix(INVALID_HIDDEN_TOKEN_FRAGMENT)\n \t@Fix(INVALID_TERMINAL_FRAGMENT_RULE_REFERENCE)\n \tpublic void fixConvertTerminalFragmentToTerminalRule(Issue issue, IssueResolutionAcceptor acceptor) {\n \t\tacceptor.accept(issue, //\n"}}, {"oid": "61c110e5777fed7f2df21cb0dfe5ceb36ac9c639", "url": "https://github.com/eclipse/xtext-eclipse/commit/61c110e5777fed7f2df21cb0dfe5ceb36ac9c639", "message": "Fix broken cross-references\nQUick fix for illegal hidden token definition\n\nSigned-off-by: nbhusare <neerajbhusare@gmail.com>", "committedDate": "2020-07-13T09:14:37Z", "type": "forcePushed"}, {"oid": "481f1641a63c53cb8ab8de10d8924cd0be9f0e7e", "url": "https://github.com/eclipse/xtext-eclipse/commit/481f1641a63c53cb8ab8de10d8924cd0be9f0e7e", "message": "Fix broken cross-references\nQUick fix for illegal hidden token definition\n\nSigned-off-by: nbhusare <neerajbhusare@gmail.com>", "committedDate": "2020-07-13T09:29:53Z", "type": "forcePushed"}, {"oid": "5cf29dd8c1bb183487671cc7537654ea0da52619", "url": "https://github.com/eclipse/xtext-eclipse/commit/5cf29dd8c1bb183487671cc7537654ea0da52619", "message": "Fix broken cross-references\nQUick fix for illegal hidden token definition\n\nSigned-off-by: nbhusare <neerajbhusare@gmail.com>", "committedDate": "2020-07-13T10:22:38Z", "type": "forcePushed"}, {"oid": "d37c35c79acc9011332d2f3b037ecec70de31453", "url": "https://github.com/eclipse/xtext-eclipse/commit/d37c35c79acc9011332d2f3b037ecec70de31453", "message": "Fix broken cross-references\nQUick fix for illegal hidden token definition\n\nSigned-off-by: nbhusare <neerajbhusare@gmail.com>", "committedDate": "2020-07-13T11:19:05Z", "type": "forcePushed"}, {"oid": "fafc7cde73c4fd306a5647f00ab638c945437b32", "url": "https://github.com/eclipse/xtext-eclipse/commit/fafc7cde73c4fd306a5647f00ab638c945437b32", "message": "Fix broken cross-references\nQUick fix for illegal hidden token definition\n\nSigned-off-by: nbhusare <neerajbhusare@gmail.com>", "committedDate": "2020-07-14T06:07:46Z", "type": "forcePushed"}, {"oid": "8a84e5e15774b5f3f7143e845b7a558692065de6", "url": "https://github.com/eclipse/xtext-eclipse/commit/8a84e5e15774b5f3f7143e845b7a558692065de6", "message": "Fix broken cross-references\nQUick fix for illegal hidden token definition\n\nSigned-off-by: nbhusare <neerajbhusare@gmail.com>", "committedDate": "2020-07-14T07:05:57Z", "type": "forcePushed"}, {"oid": "9579363ad5ad86791598bb9c25956d6a9cae61d7", "url": "https://github.com/eclipse/xtext-eclipse/commit/9579363ad5ad86791598bb9c25956d6a9cae61d7", "message": "Fix broken cross-references\nQUick fix for illegal hidden token definition\n\nSigned-off-by: nbhusare <neerajbhusare@gmail.com>", "committedDate": "2020-07-14T10:18:10Z", "type": "commit"}, {"oid": "9579363ad5ad86791598bb9c25956d6a9cae61d7", "url": "https://github.com/eclipse/xtext-eclipse/commit/9579363ad5ad86791598bb9c25956d6a9cae61d7", "message": "Fix broken cross-references\nQUick fix for illegal hidden token definition\n\nSigned-off-by: nbhusare <neerajbhusare@gmail.com>", "committedDate": "2020-07-14T10:18:10Z", "type": "forcePushed"}]}