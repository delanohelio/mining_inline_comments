{"pr_number": 660, "pr_title": "The MicroProfile test fails if message history is turned off", "pr_createdAt": "2020-01-23T11:43:02Z", "pr_url": "https://github.com/apache/camel-quarkus/pull/660", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDA3ODUwMQ==", "url": "https://github.com/apache/camel-quarkus/pull/660#discussion_r370078501", "bodyText": "I wonder if we can simplify this to just:\ncamelContext.setMessageHistory(true);\ncamelContext.setMessageHistoryFactory(new MicroProfileMetricsMessageHistoryFactory());\n\nAnd not bother with the other checks?\nIn 3.1.0, when you add the MessageHistoryFactory, message history is auto enabled on the CamelContext anyway.", "author": "jamesnetherton", "createdAt": "2020-01-23T12:02:03Z", "path": "extensions/microprofile-metrics/runtime/src/main/java/org/apache/camel/quarkus/component/microprofile/metrics/runtime/CamelMicroProfileMetricsRecorder.java", "diffHunk": "@@ -61,4 +63,24 @@ public void configureCamelContext(CamelMicroProfileMetricsConfig config,\n             managementStrategy.addEventNotifier(new MicroProfileMetricsCamelContextEventNotifier());\n         }\n     }\n+\n+    private static class MicroProfileMetricsContextConfigurerListener extends MainListenerSupport {\n+        private static final Logger LOGGER = Logger.getLogger(MicroProfileMetricsContextConfigurerListener.class);\n+        private final CamelMicroProfileMetricsConfig config;\n+\n+        public MicroProfileMetricsContextConfigurerListener(CamelMicroProfileMetricsConfig config) {\n+            this.config = config;\n+        }\n+\n+        @Override\n+        public void configure(CamelContext camelContext) {\n+            if (camelContext.isMessageHistory() && config.enableMessageHistory) {", "originalCommit": "b30cdda2552191f0fb40990e052428d14d0cbb9b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDA4Nzg2Ng==", "url": "https://github.com/apache/camel-quarkus/pull/660#discussion_r370087866", "bodyText": "It can certainly be done, my only reasoning was: what if the user has explicitly disabled message history ? by adding the extension we would then revert its change without notice.\nI guess I can add a log that say that the message history has been turned on in case it was not, maybe the same should happen on 3.1.x.", "author": "lburgazzoli", "createdAt": "2020-01-23T12:25:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDA3ODUwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDA5NDUyNw==", "url": "https://github.com/apache/camel-quarkus/pull/660#discussion_r370094527", "bodyText": "@jamesnetherton I've simplified it a bit, does it look better now ?", "author": "lburgazzoli", "createdAt": "2020-01-23T12:41:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDA3ODUwMQ=="}], "type": "inlineReview", "revised_code": {"commit": "0ba2e815a3fa6cfb28f3a72ca3e71f169886c902", "chunk": "diff --git a/extensions/microprofile-metrics/runtime/src/main/java/org/apache/camel/quarkus/component/microprofile/metrics/runtime/CamelMicroProfileMetricsRecorder.java b/extensions/microprofile-metrics/runtime/src/main/java/org/apache/camel/quarkus/component/microprofile/metrics/runtime/CamelMicroProfileMetricsRecorder.java\nindex 5a4e2271f..e0a2c75d3 100644\n--- a/extensions/microprofile-metrics/runtime/src/main/java/org/apache/camel/quarkus/component/microprofile/metrics/runtime/CamelMicroProfileMetricsRecorder.java\n+++ b/extensions/microprofile-metrics/runtime/src/main/java/org/apache/camel/quarkus/component/microprofile/metrics/runtime/CamelMicroProfileMetricsRecorder.java\n\n@@ -74,13 +74,18 @@ public class CamelMicroProfileMetricsRecorder {\n \n         @Override\n         public void configure(CamelContext camelContext) {\n-            if (camelContext.isMessageHistory() && config.enableMessageHistory) {\n-                camelContext.setMessageHistory(true);\n-                camelContext.setMessageHistoryFactory(new MicroProfileMetricsMessageHistoryFactory());\n-            } else if (!camelContext.isMessageHistory() && config.enableMessageHistory) {\n+            if (!config.enableMessageHistory) {\n+                return;\n+            }\n+\n+            if (!camelContext.isMessageHistory()) {\n                 LOGGER.warn(\n-                        \"Cannot enable MicroProfileMetrics for Camel's MessageHistory as Camel's message history is turned off\");\n+                        \"MessageHistory is not use and will be enabled as required by MicroProfile Metrics for MessageHistory\");\n+\n+                camelContext.setMessageHistory(true);\n             }\n+\n+            camelContext.setMessageHistoryFactory(new MicroProfileMetricsMessageHistoryFactory());\n         }\n     }\n }\n"}}, {"oid": "0ba2e815a3fa6cfb28f3a72ca3e71f169886c902", "url": "https://github.com/apache/camel-quarkus/commit/0ba2e815a3fa6cfb28f3a72ca3e71f169886c902", "message": "The MicroProfile test fails if message history is turned off #650", "committedDate": "2020-01-23T12:40:26Z", "type": "commit"}, {"oid": "0ba2e815a3fa6cfb28f3a72ca3e71f169886c902", "url": "https://github.com/apache/camel-quarkus/commit/0ba2e815a3fa6cfb28f3a72ca3e71f169886c902", "message": "The MicroProfile test fails if message history is turned off #650", "committedDate": "2020-01-23T12:40:26Z", "type": "forcePushed"}]}