{"pr_number": 3459, "pr_title": "#3453 amendments to allow the Subject Area FVT to run with the Graph Repo", "pr_createdAt": "2020-08-06T12:47:54Z", "pr_url": "https://github.com/odpi/egeria/pull/3459", "timeline": [{"oid": "3776965d1d5406fe3e37c846667ee7fb3d7589e9", "url": "https://github.com/odpi/egeria/commit/3776965d1d5406fe3e37c846667ee7fb3d7589e9", "message": "#3453 Include classification type on classifications supplied with term create\n\nSigned-off-by: David Radley <david_radley@uk.ibm.com>", "committedDate": "2020-08-05T20:57:38Z", "type": "commit"}, {"oid": "e7371e6b76e45818452a9c106cec620403bb3e7b", "url": "https://github.com/odpi/egeria/commit/e7371e6b76e45818452a9c106cec620403bb3e7b", "message": "comment out TermFVT test\n\nSigned-off-by: David Radley <david_radley@uk.ibm.com>", "committedDate": "2020-08-06T10:42:33Z", "type": "commit"}, {"oid": "5cb1635d6439a5fad8ab464940da4c28fbdf0aea", "url": "https://github.com/odpi/egeria/commit/5cb1635d6439a5fad8ab464940da4c28fbdf0aea", "message": "remove unwanted changes\n\nSigned-off-by: David Radley <david_radley@uk.ibm.com>", "committedDate": "2020-08-06T10:45:44Z", "type": "commit"}, {"oid": "c0e700b138020c534b949255960487f731173eba", "url": "https://github.com/odpi/egeria/commit/c0e700b138020c534b949255960487f731173eba", "message": "prevent concurrent modification exception in graph repo during declassify entity\n\nSigned-off-by: David Radley <david_radley@uk.ibm.com>", "committedDate": "2020-08-06T10:47:35Z", "type": "commit"}, {"oid": "a9d8ac5b4851b82bc57c44363bc507300b412d0b", "url": "https://github.com/odpi/egeria/commit/a9d8ac5b4851b82bc57c44363bc507300b412d0b", "message": "Self protect in the FVT if there is existing content\n\nSigned-off-by: David Radley <david_radley@uk.ibm.com>", "committedDate": "2020-08-06T12:45:12Z", "type": "commit"}, {"oid": "d64f0afa6cc7a972f1465de245d870e0a5d10fc0", "url": "https://github.com/odpi/egeria/commit/d64f0afa6cc7a972f1465de245d870e0a5d10fc0", "message": "Merge branch 'master' into git3453", "committedDate": "2020-08-06T12:50:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQxNTg1Ng==", "url": "https://github.com/odpi/egeria/pull/3459#discussion_r466415856", "bodyText": "Could you use the RepositoryHelper's getSkeletonClassification method here instea? It looks like it could save quite a bit of this construction code.", "author": "grahamwallis", "createdAt": "2020-08-06T13:34:31Z", "path": "open-metadata-implementation/access-services/subject-area/subject-area-server/src/main/java/org/odpi/openmetadata/accessservices/subjectarea/server/mappers/classifications/ClassificationMapper.java", "diffHunk": "@@ -106,10 +108,18 @@ public Classification mapBeanToOmrs(org.odpi.openmetadata.accessservices.subject\n          org.odpi.openmetadata.repositoryservices.connectors.stores.metadatacollectionstore.properties.instances.Classification omrsClassification = new org.odpi.openmetadata.repositoryservices.connectors.stores.metadatacollectionstore.properties.instances.Classification();\n          SubjectAreaUtils.populateSystemAttributesForInstanceAuditHeader(systemAttributes, omrsClassification);\n          // copy over the classification name\n-         omrsClassification.setName(omasClassification.getClassificationName());\n+         String classificationName = omasClassification.getClassificationName();\n+         omrsClassification.setName(classificationName);\n+         // copy over the classification type\n+         OpenMetadataTypesArchiveAccessor archiveAccessor = OpenMetadataTypesArchiveAccessor.getInstance();\n+         String classificationTypeGuid = archiveAccessor.getClassificationDefByName(classificationName).getGUID();", "originalCommit": "d64f0afa6cc7a972f1465de245d870e0a5d10fc0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODYxNTA1Ng==", "url": "https://github.com/odpi/egeria/pull/3459#discussion_r468615056", "bodyText": "@grahamwallis raised issue #3477 to track this suggested refactor.", "author": "davidradl", "createdAt": "2020-08-11T14:16:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQxNTg1Ng=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQxOTM3OA==", "url": "https://github.com/odpi/egeria/pull/3459#discussion_r466419378", "bodyText": "I don't see why this helps. I may be missing something but I can't see what's wrong with removing the unwanted classification as soon as it is identified, i.e. within the loop.\nIf there's a good reason for this change, does it not also apply to the classifier edges that need to be removed?\nI'm not sure what behaviour occurred that prompted this change. Is it possible that there's a problem with the order of the remove operations?", "author": "grahamwallis", "createdAt": "2020-08-06T13:39:53Z", "path": "open-metadata-implementation/adapters/open-connectors/repository-services-connectors/open-metadata-collection-store-connectors/graph-repository-connector/src/main/java/org/odpi/openmetadata/adapters/repositoryservices/graphrepository/repositoryconnector/GraphOMRSMetadataStore.java", "diffHunk": "@@ -1146,12 +1147,16 @@ private void updateEntityClassifications(EntitySummary entity, Vertex vertex, Gr\n                 log.debug(\"{} entity remove classification: {}\", methodName, existingName);\n                 Vertex classificationVertex = existingClassificationVerticesByName.get(existingName);\n                 classificationVertex.remove();\n-                existingClassificationVerticesByName.remove(existingName);\n+                namesToRemoveSet.add(existingName);", "originalCommit": "d64f0afa6cc7a972f1465de245d870e0a5d10fc0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjUwNjU2MQ==", "url": "https://github.com/odpi/egeria/pull/3459#discussion_r466506561", "bodyText": "@grahamwallis This change fixed a concurrent modification exception, I believe the issue was that we called an iterator .next , then a  .remove then .next on the same map (existingClassificationVerticesByName) or its iterator. The second .next got the exception, presumably because it realises that the collection it is iterating over has changed underneath it. The fix solves the problem as the .remove is not done in the iterator loop. I don't think it applies to the classifier vertices as they are not being iterated over. Have I misunderstood something ?", "author": "davidradl", "createdAt": "2020-08-06T15:42:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQxOTM3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njg4Njk4Nw==", "url": "https://github.com/odpi/egeria/pull/3459#discussion_r466886987", "bodyText": "the explanation makes sense to me from the code.", "author": "planetf1", "createdAt": "2020-08-07T08:03:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQxOTM3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzcyODMxMg==", "url": "https://github.com/odpi/egeria/pull/3459#discussion_r467728312", "bodyText": "Yes - that makes good sense. I hadn't looked closely enough :-) I was wondering whether it was an issue with the removal of the vertices and then the edges (which should be fine). Thanks for the explanation and for fixing!", "author": "grahamwallis", "createdAt": "2020-08-10T07:26:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQxOTM3OA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQyMDAyNw==", "url": "https://github.com/odpi/egeria/pull/3459#discussion_r466420027", "bodyText": "Minor: string still contains a superfluous space.", "author": "grahamwallis", "createdAt": "2020-08-06T13:40:48Z", "path": "open-metadata-test/open-metadata-fvt/access-services-fvt/subject-area-fvt/src/main/java/org/odpi/openmetadata/accessservices/subjectarea/fvt/TermFVT.java", "diffHunk": "@@ -135,7 +135,7 @@ public void run() throws SubjectAreaFVTCheckedException, InvalidParameterExcepti\n             throw new SubjectAreaFVTCheckedException(\"ERROR: Governance actions retention not returned  as expected\");\n         }\n         if (!governanceActions.getCriticality().getLevel().equals(term3.getGovernanceActions().getCriticality().getLevel())) {\n-            throw new SubjectAreaFVTCheckedException(\"ERROR: Governance actions criticality not returned  as expected\");\n+            throw new SubjectAreaFVTCheckedException(\"ERROR: Governance actions criticality not returned  as expected. \");", "originalCommit": "d64f0afa6cc7a972f1465de245d870e0a5d10fc0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjUwNzIyMQ==", "url": "https://github.com/odpi/egeria/pull/3459#discussion_r466507221", "bodyText": "Minor: string still contains a superfluous space.\n\nI suggest that I fix if I need to make another code change on this pr.", "author": "davidradl", "createdAt": "2020-08-06T15:43:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQyMDAyNw=="}], "type": "inlineReview", "revised_code": null}, {"oid": "98aa506c7a6cc2eafb78e0c8762b904f03d79293", "url": "https://github.com/odpi/egeria/commit/98aa506c7a6cc2eafb78e0c8762b904f03d79293", "message": "Merge branch 'master' into git3453", "committedDate": "2020-08-07T08:00:49Z", "type": "commit"}, {"oid": "eb76b531ba671a87bd16a88dda90e7b7386055e1", "url": "https://github.com/odpi/egeria/commit/eb76b531ba671a87bd16a88dda90e7b7386055e1", "message": "Merge branch 'master' into git3453", "committedDate": "2020-08-07T10:27:42Z", "type": "commit"}, {"oid": "9fc5107423b1c77a0f2f4d9267282955a9ac8572", "url": "https://github.com/odpi/egeria/commit/9fc5107423b1c77a0f2f4d9267282955a9ac8572", "message": "Merge branch 'master' into git3453", "committedDate": "2020-08-11T14:11:58Z", "type": "commit"}]}