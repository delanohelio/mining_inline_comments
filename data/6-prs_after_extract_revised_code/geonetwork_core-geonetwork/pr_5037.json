{"pr_number": 5037, "pr_title": "ISODate UTC timezone fixes", "pr_createdAt": "2020-09-23T03:38:57Z", "pr_url": "https://github.com/geonetwork/core-geonetwork/pull/5037", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzQ0MjQzMw==", "url": "https://github.com/geonetwork/core-geonetwork/pull/5037#discussion_r493442433", "bodyText": "Any reason to check the same thing twice?", "author": "ianwallen", "createdAt": "2020-09-23T10:49:20Z", "path": "domain/src/main/java/org/fao/geonet/domain/ISODate.java", "diffHunk": "@@ -430,7 +447,8 @@ public void setDateAndTime(String isoDate) {\n             // JODAISODate. This class converts to UTC format to avoid timezones\n             // issues.\n             String afterT = timeAndDate.substring(indexOfT + 1);\n-            boolean timeZoneInfo = afterT.contains(\"+\") || afterT.contains(\"-\");\n+            boolean timeZoneInfo = afterT.contains(\"+\") || afterT.contains(\"-\")\n+                || afterT.endsWith(\"Z\") || afterT.endsWith(\"Z\");", "originalCommit": "0d1cc265c65d2ea8a48e53e29cb31cbb7b9b74d6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzY2OTQ3MQ==", "url": "https://github.com/geonetwork/core-geonetwork/pull/5037#discussion_r493669471", "bodyText": "Sorry one of those was intended to be lowercase.", "author": "jodygarnett", "createdAt": "2020-09-23T15:06:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzQ0MjQzMw=="}], "type": "inlineReview", "revised_code": {"commit": "b723c37c2dd1a142a98fdc2847adfa98cc4664d2", "chunk": "diff --git a/domain/src/main/java/org/fao/geonet/domain/ISODate.java b/domain/src/main/java/org/fao/geonet/domain/ISODate.java\nindex efe7f47bf0..b342bf5537 100644\n--- a/domain/src/main/java/org/fao/geonet/domain/ISODate.java\n+++ b/domain/src/main/java/org/fao/geonet/domain/ISODate.java\n\n@@ -448,7 +448,7 @@ public class ISODate\n             // issues.\n             String afterT = timeAndDate.substring(indexOfT + 1);\n             boolean timeZoneInfo = afterT.contains(\"+\") || afterT.contains(\"-\")\n-                || afterT.endsWith(\"Z\") || afterT.endsWith(\"Z\");\n+                || afterT.toUpperCase().endsWith(\"Z\");\n \n             if (timeZoneInfo) {\n                 timeAndDate = parseISODateTime(timeAndDate);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzU4NjU5NA==", "url": "https://github.com/geonetwork/core-geonetwork/pull/5037#discussion_r493586594", "bodyText": "It is incorrect to use PST since it is PDT roughly half of the year.\nGenerally prefer to use the zone name i.e. in \"Pacific Time Zone\" or \"Pacific\"\nSame for EST below.", "author": "ianwallen", "createdAt": "2020-09-23T13:27:14Z", "path": "domain/src/test/java/org/fao/geonet/domain/ISODateTest.java", "diffHunk": "@@ -448,4 +453,34 @@ public void testSub() throws Exception {\n         org.junit.Assert.assertEquals(-60, isoDate2.timeDifferenceInSeconds(isoDate1));\n     }\n \n+\n+    @Test\n+    public void testZ() throws Exception {\n+        ISODate isoDate = new ISODate(\"2019-06-01T00:00Z\");\n+        Instant instant = isoDate.toDate().toInstant().truncatedTo(ChronoUnit.SECONDS);\n+\n+        ZonedDateTime expectedDateTime =\n+            ZonedDateTime.of(\n+                2019, 6, 1, 0, 0, 0, 0, ZoneId.of(\"Z\").normalized());\n+        Instant expected = expectedDateTime.toInstant().truncatedTo(ChronoUnit.SECONDS);\n+        assertEquals( \"Z\", expected, instant );\n+\n+        ISODate pstDate = new ISODate(\"2019-06-01T00:00-07:00\");\n+        instant = pstDate.toDate().toInstant().truncatedTo(ChronoUnit.SECONDS);\n+\n+        ZonedDateTime pstDateTime =\n+            ZonedDateTime.of(\n+                2019, 6, 1, 0, 0, 0, 0, ZoneId.of(\"America/Vancouver\").normalized());\n+        expected = pstDateTime.toInstant().truncatedTo(ChronoUnit.SECONDS);\n+        assertEquals( \"PST\", expected, instant );", "originalCommit": "0d1cc265c65d2ea8a48e53e29cb31cbb7b9b74d6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc2MzQ1Mw==", "url": "https://github.com/geonetwork/core-geonetwork/pull/5037#discussion_r493763453", "bodyText": "Thanks, reading the ZoneId docs I am going to use UTC-04:00 as I am more interested in testing differences in timezone than anything else.", "author": "jodygarnett", "createdAt": "2020-09-23T17:24:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzU4NjU5NA=="}], "type": "inlineReview", "revised_code": {"commit": "b723c37c2dd1a142a98fdc2847adfa98cc4664d2", "chunk": "diff --git a/domain/src/test/java/org/fao/geonet/domain/ISODateTest.java b/domain/src/test/java/org/fao/geonet/domain/ISODateTest.java\nindex 7c92969333..5b95943713 100644\n--- a/domain/src/test/java/org/fao/geonet/domain/ISODateTest.java\n+++ b/domain/src/test/java/org/fao/geonet/domain/ISODateTest.java\n\n@@ -470,17 +470,17 @@ public class ISODateTest {\n \n         ZonedDateTime pstDateTime =\n             ZonedDateTime.of(\n-                2019, 6, 1, 0, 0, 0, 0, ZoneId.of(\"America/Vancouver\").normalized());\n+                2019, 6, 1, 0, 0, 0, 0, ZoneId.of(\"UTC-07:00\").normalized());\n         expected = pstDateTime.toInstant().truncatedTo(ChronoUnit.SECONDS);\n-        assertEquals( \"PST\", expected, instant );\n+        assertEquals( \"UTC-07:00\", expected, instant );\n \n         ISODate estDate = new ISODate(\"2019-06-01T00:00-04:00\");\n         instant = estDate.toDate().toInstant().truncatedTo(ChronoUnit.SECONDS);\n \n         ZonedDateTime estDateTime =\n             ZonedDateTime.of(\n-                2019, 6, 1, 0, 0, 0, 0, ZoneId.of(\"America/Toronto\").normalized());\n+                2019, 6, 1, 0, 0, 0, 0, ZoneId.of(\"UTC-04:00\").normalized());\n         expected = estDateTime.toInstant().truncatedTo(ChronoUnit.SECONDS);\n-        assertEquals( \"EST\", expected, instant );\n+        assertEquals( \"UTC-04:00\", expected, instant );\n     }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzU4OTE4OA==", "url": "https://github.com/geonetwork/core-geonetwork/pull/5037#discussion_r493589188", "bodyText": "I see that you are using \"-04:00\" in the test and comparing it to \"America/Toronto\"\nI believe this test will fail roughly half the year when it switches to EDT", "author": "ianwallen", "createdAt": "2020-09-23T13:29:35Z", "path": "domain/src/test/java/org/fao/geonet/domain/ISODateTest.java", "diffHunk": "@@ -448,4 +453,34 @@ public void testSub() throws Exception {\n         org.junit.Assert.assertEquals(-60, isoDate2.timeDifferenceInSeconds(isoDate1));\n     }\n \n+\n+    @Test\n+    public void testZ() throws Exception {\n+        ISODate isoDate = new ISODate(\"2019-06-01T00:00Z\");\n+        Instant instant = isoDate.toDate().toInstant().truncatedTo(ChronoUnit.SECONDS);\n+\n+        ZonedDateTime expectedDateTime =\n+            ZonedDateTime.of(\n+                2019, 6, 1, 0, 0, 0, 0, ZoneId.of(\"Z\").normalized());\n+        Instant expected = expectedDateTime.toInstant().truncatedTo(ChronoUnit.SECONDS);\n+        assertEquals( \"Z\", expected, instant );\n+\n+        ISODate pstDate = new ISODate(\"2019-06-01T00:00-07:00\");\n+        instant = pstDate.toDate().toInstant().truncatedTo(ChronoUnit.SECONDS);\n+\n+        ZonedDateTime pstDateTime =\n+            ZonedDateTime.of(\n+                2019, 6, 1, 0, 0, 0, 0, ZoneId.of(\"America/Vancouver\").normalized());\n+        expected = pstDateTime.toInstant().truncatedTo(ChronoUnit.SECONDS);\n+        assertEquals( \"PST\", expected, instant );\n+\n+        ISODate estDate = new ISODate(\"2019-06-01T00:00-04:00\");", "originalCommit": "0d1cc265c65d2ea8a48e53e29cb31cbb7b9b74d6", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b723c37c2dd1a142a98fdc2847adfa98cc4664d2", "chunk": "diff --git a/domain/src/test/java/org/fao/geonet/domain/ISODateTest.java b/domain/src/test/java/org/fao/geonet/domain/ISODateTest.java\nindex 7c92969333..5b95943713 100644\n--- a/domain/src/test/java/org/fao/geonet/domain/ISODateTest.java\n+++ b/domain/src/test/java/org/fao/geonet/domain/ISODateTest.java\n\n@@ -470,17 +470,17 @@ public class ISODateTest {\n \n         ZonedDateTime pstDateTime =\n             ZonedDateTime.of(\n-                2019, 6, 1, 0, 0, 0, 0, ZoneId.of(\"America/Vancouver\").normalized());\n+                2019, 6, 1, 0, 0, 0, 0, ZoneId.of(\"UTC-07:00\").normalized());\n         expected = pstDateTime.toInstant().truncatedTo(ChronoUnit.SECONDS);\n-        assertEquals( \"PST\", expected, instant );\n+        assertEquals( \"UTC-07:00\", expected, instant );\n \n         ISODate estDate = new ISODate(\"2019-06-01T00:00-04:00\");\n         instant = estDate.toDate().toInstant().truncatedTo(ChronoUnit.SECONDS);\n \n         ZonedDateTime estDateTime =\n             ZonedDateTime.of(\n-                2019, 6, 1, 0, 0, 0, 0, ZoneId.of(\"America/Toronto\").normalized());\n+                2019, 6, 1, 0, 0, 0, 0, ZoneId.of(\"UTC-04:00\").normalized());\n         expected = estDateTime.toInstant().truncatedTo(ChronoUnit.SECONDS);\n-        assertEquals( \"EST\", expected, instant );\n+        assertEquals( \"UTC-04:00\", expected, instant );\n     }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzU5MjYwOA==", "url": "https://github.com/geonetwork/core-geonetwork/pull/5037#discussion_r493592608", "bodyText": "I see that you are using \"-07:00\" in the test and comparing it to \"America/Vancouver\"\nI believe this test will fail roughly half the year when it switches to PDT\nI believe you may need to get the current timezone offset for the same zone to do the comparison.", "author": "ianwallen", "createdAt": "2020-09-23T13:32:49Z", "path": "domain/src/test/java/org/fao/geonet/domain/ISODateTest.java", "diffHunk": "@@ -448,4 +453,34 @@ public void testSub() throws Exception {\n         org.junit.Assert.assertEquals(-60, isoDate2.timeDifferenceInSeconds(isoDate1));\n     }\n \n+\n+    @Test\n+    public void testZ() throws Exception {\n+        ISODate isoDate = new ISODate(\"2019-06-01T00:00Z\");\n+        Instant instant = isoDate.toDate().toInstant().truncatedTo(ChronoUnit.SECONDS);\n+\n+        ZonedDateTime expectedDateTime =\n+            ZonedDateTime.of(\n+                2019, 6, 1, 0, 0, 0, 0, ZoneId.of(\"Z\").normalized());\n+        Instant expected = expectedDateTime.toInstant().truncatedTo(ChronoUnit.SECONDS);\n+        assertEquals( \"Z\", expected, instant );\n+\n+        ISODate pstDate = new ISODate(\"2019-06-01T00:00-07:00\");", "originalCommit": "0d1cc265c65d2ea8a48e53e29cb31cbb7b9b74d6", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b723c37c2dd1a142a98fdc2847adfa98cc4664d2", "chunk": "diff --git a/domain/src/test/java/org/fao/geonet/domain/ISODateTest.java b/domain/src/test/java/org/fao/geonet/domain/ISODateTest.java\nindex 7c92969333..5b95943713 100644\n--- a/domain/src/test/java/org/fao/geonet/domain/ISODateTest.java\n+++ b/domain/src/test/java/org/fao/geonet/domain/ISODateTest.java\n\n@@ -470,17 +470,17 @@ public class ISODateTest {\n \n         ZonedDateTime pstDateTime =\n             ZonedDateTime.of(\n-                2019, 6, 1, 0, 0, 0, 0, ZoneId.of(\"America/Vancouver\").normalized());\n+                2019, 6, 1, 0, 0, 0, 0, ZoneId.of(\"UTC-07:00\").normalized());\n         expected = pstDateTime.toInstant().truncatedTo(ChronoUnit.SECONDS);\n-        assertEquals( \"PST\", expected, instant );\n+        assertEquals( \"UTC-07:00\", expected, instant );\n \n         ISODate estDate = new ISODate(\"2019-06-01T00:00-04:00\");\n         instant = estDate.toDate().toInstant().truncatedTo(ChronoUnit.SECONDS);\n \n         ZonedDateTime estDateTime =\n             ZonedDateTime.of(\n-                2019, 6, 1, 0, 0, 0, 0, ZoneId.of(\"America/Toronto\").normalized());\n+                2019, 6, 1, 0, 0, 0, 0, ZoneId.of(\"UTC-04:00\").normalized());\n         expected = estDateTime.toInstant().truncatedTo(ChronoUnit.SECONDS);\n-        assertEquals( \"EST\", expected, instant );\n+        assertEquals( \"UTC-04:00\", expected, instant );\n     }\n }\n"}}, {"oid": "10f1557b5f1aeb80d7cbe918480572c44824d83e", "url": "https://github.com/geonetwork/core-geonetwork/commit/10f1557b5f1aeb80d7cbe918480572c44824d83e", "message": "ISODate Z indicate UTC timezone and document ISODate constructor use of milliseconds\n\nSigned-off-by: Jody Garnett <jody.garnett@gmail.com>", "committedDate": "2020-10-02T06:53:58Z", "type": "commit"}, {"oid": "b723c37c2dd1a142a98fdc2847adfa98cc4664d2", "url": "https://github.com/geonetwork/core-geonetwork/commit/b723c37c2dd1a142a98fdc2847adfa98cc4664d2", "message": "Test using UTC-04:00 rather than location for ZoneId\n\nThis prevents the tests failing due to location based ZoneId adjusting to daylight saving time changes over the course of hte year\n\nSigned-off-by: Jody Garnett <jody.garnett@gmail.com>", "committedDate": "2020-10-02T06:53:58Z", "type": "commit"}, {"oid": "b723c37c2dd1a142a98fdc2847adfa98cc4664d2", "url": "https://github.com/geonetwork/core-geonetwork/commit/b723c37c2dd1a142a98fdc2847adfa98cc4664d2", "message": "Test using UTC-04:00 rather than location for ZoneId\n\nThis prevents the tests failing due to location based ZoneId adjusting to daylight saving time changes over the course of hte year\n\nSigned-off-by: Jody Garnett <jody.garnett@gmail.com>", "committedDate": "2020-10-02T06:53:58Z", "type": "forcePushed"}]}