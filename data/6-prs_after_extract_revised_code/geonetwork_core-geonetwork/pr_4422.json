{"pr_number": 4422, "pr_title": "Display bounding polygons in 19139 full view", "pr_createdAt": "2020-02-04T06:11:47Z", "pr_url": "https://github.com/geonetwork/core-geonetwork/pull/4422", "timeline": [{"oid": "07c8fb12113344a7ad119741e8518411cb68baae", "url": "https://github.com/geonetwork/core-geonetwork/commit/07c8fb12113344a7ad119741e8518411cb68baae", "message": "Display bounding polygons in 19139 full view", "committedDate": "2020-02-04T05:54:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDUwNDEwMQ==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4422#discussion_r374504101", "bodyText": "Should we add ISO19115-3 case here too ? ie gex:polygon and gex:westBoundLongitude", "author": "fxprunayre", "createdAt": "2020-02-04T07:09:49Z", "path": "services/src/main/java/org/fao/geonet/api/regions/metadata/MetadataRegionSearchRequest.java", "diffHunk": "@@ -168,33 +193,75 @@ private void loadAll(List<Region> regions, Id id) throws Exception {\n     }\n \n     Region parseRegion(Id mdId, Element extentObj) throws Exception {\n+        MultiPolygon geometry = parseElement(extentObj);\n+\n+        String id = null;\n+        if (geometry != null) {\n+            Element element = extentObj.getChild(\"element\", Geonet.Namespaces.GEONET);\n+            if (element != null) {\n+                id = element.getAttributeValue(\"ref\");\n+            }\n+            return new MetadataRegion(mdId, id, geometry);\n+        } else {\n+            return null;\n+        }\n+    }\n+\n+    private MultiPolygon parseElement(Element extentObj) throws Exception {\n         GeonetContext gc = (GeonetContext) context.getHandlerContext(Geonet.CONTEXT_NAME);\n         gc.getBean(DataManager.class).getEditLib().removeEditingInfo(extentObj);\n \n-        String id = null;\n-        Geometry geometry = null;\n+        MultiPolygon geometry = null;\n         if (\"polygon\".equals(extentObj.getName())) {\n-            String gml = Xml.getString(extentObj);\n-            geometry = SpatialIndexWriter.parseGml(parsers[0], gml);\n+            geometry = parsePolygon(extentObj);\n         } else if (\"EX_BoundingPolygon\".equals(extentObj.getName())) {\n-            String gml = Xml.getString(extentObj.getChild(\"polygon\", Geonet.Namespaces.GMD));\n-            geometry = SpatialIndexWriter.parseGml(parsers[0], gml);\n+            Element polygon = extentObj.getChild(\"polygon\", Namespaces.GMD);", "originalCommit": "07c8fb12113344a7ad119741e8518411cb68baae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDUzMDk4Mg==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4422#discussion_r374530982", "bodyText": "Yes. looking at 19115-3 now", "author": "jonescc", "createdAt": "2020-02-04T08:29:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDUwNDEwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU5NDg0Mw==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4422#discussion_r374594843", "bodyText": "Support for 19115-3 added.  PR for 19115-3:2018 to follow", "author": "jonescc", "createdAt": "2020-02-04T10:39:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDUwNDEwMQ=="}], "type": "inlineReview", "revised_code": {"commit": "da475bfdfd234c44ec4c187d345927332622727b", "chunk": "diff --git a/services/src/main/java/org/fao/geonet/api/regions/metadata/MetadataRegionSearchRequest.java b/services/src/main/java/org/fao/geonet/api/regions/metadata/MetadataRegionSearchRequest.java\nindex ebaf0948f0..bfb232fa7c 100644\n--- a/services/src/main/java/org/fao/geonet/api/regions/metadata/MetadataRegionSearchRequest.java\n+++ b/services/src/main/java/org/fao/geonet/api/regions/metadata/MetadataRegionSearchRequest.java\n\n@@ -215,13 +215,13 @@ public class MetadataRegionSearchRequest extends Request {\n         if (\"polygon\".equals(extentObj.getName())) {\n             geometry = parsePolygon(extentObj);\n         } else if (\"EX_BoundingPolygon\".equals(extentObj.getName())) {\n-            Element polygon = extentObj.getChild(\"polygon\", Namespaces.GMD);\n+            Element polygon = Xml.selectElement(extentObj, \"*[local-name()='polygon']\");\n             geometry = parsePolygon(polygon);\n         } else if (\"EX_GeographicBoundingBox\".equals(extentObj.getName())) {\n-            double minx = Double.parseDouble(extentObj.getChild(\"westBoundLongitude\", Geonet.Namespaces.GMD).getChildText(\"Decimal\", Geonet.Namespaces.GCO));\n-            double maxx = Double.parseDouble(extentObj.getChild(\"eastBoundLongitude\", Geonet.Namespaces.GMD).getChildText(\"Decimal\", Geonet.Namespaces.GCO));\n-            double miny = Double.parseDouble(extentObj.getChild(\"southBoundLatitude\", Geonet.Namespaces.GMD).getChildText(\"Decimal\", Geonet.Namespaces.GCO));\n-            double maxy = Double.parseDouble(extentObj.getChild(\"northBoundLatitude\", Geonet.Namespaces.GMD).getChildText(\"Decimal\", Geonet.Namespaces.GCO));\n+            double minx = Double.parseDouble(Xml.selectString(extentObj, \"*[local-name()='westBoundLongitude']/*\"));\n+            double maxx = Double.parseDouble(Xml.selectString(extentObj, \"*[local-name()='eastBoundLongitude']/*\"));\n+            double miny = Double.parseDouble(Xml.selectString(extentObj, \"*[local-name()='southBoundLatitude']/*\"));\n+            double maxy = Double.parseDouble(Xml.selectString(extentObj, \"*[local-name()='northBoundLatitude']/*\"));\n             Polygon[] polygons = {(Polygon)factory.toGeometry(new Envelope(minx, maxx, miny, maxy))};\n             geometry = factory.createMultiPolygon(polygons);\n         }\n"}}, {"oid": "da475bfdfd234c44ec4c187d345927332622727b", "url": "https://github.com/geonetwork/core-geonetwork/commit/da475bfdfd234c44ec4c187d345927332622727b", "message": "Add support for drawing 19115-3 bounding polygons", "committedDate": "2020-02-04T10:36:31Z", "type": "commit"}]}