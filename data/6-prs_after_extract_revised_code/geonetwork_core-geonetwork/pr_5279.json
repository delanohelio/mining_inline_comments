{"pr_number": 5279, "pr_title": "Fix some working copy merge issues", "pr_createdAt": "2020-12-18T20:48:30Z", "pr_url": "https://github.com/geonetwork/core-geonetwork/pull/5279", "timeline": [{"oid": "3d7af0c7967b56f3cdb2ef99cd5a3a3cef654093", "url": "https://github.com/geonetwork/core-geonetwork/commit/3d7af0c7967b56f3cdb2ef99cd5a3a3cef654093", "message": "Create replaceDataDir to be used when merging a draft back to approved record. The previous copyDataDir would just copy the data and not remove the records that were deleted in the draft. Also added cleanup of resources after the draft is merged to the approved record.", "committedDate": "2020-12-18T20:42:35Z", "type": "commit"}, {"oid": "f752f8b8d3b2a0b4b6e9e454479f7766a55a46ad", "url": "https://github.com/geonetwork/core-geonetwork/commit/f752f8b8d3b2a0b4b6e9e454479f7766a55a46ad", "message": "Merge branch 'master' of https://github.com/geonetwork/core-geonetwork into working_copy_replace", "committedDate": "2021-01-04T11:59:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTk1MjgxOA==", "url": "https://github.com/geonetwork/core-geonetwork/pull/5279#discussion_r551952818", "bodyText": "This code is updating the list in the parameter l, can cause some side effects. I would create a copied list instead of relying to clone the list in the function call as done later:\n exceptMetadataResource(new ArrayList<>(targetResources), sourceResources);", "author": "josegar74", "createdAt": "2021-01-05T14:07:37Z", "path": "core/src/main/java/org/fao/geonet/api/records/attachments/StoreUtils.java", "diffHunk": "@@ -80,6 +77,82 @@ public static void copyDataDir(ServiceContext context, String oldUuid, String ne\n         }\n     }\n \n+    /**\n+     * Ues to to remove items from a metadataResource list\n+     *\n+     * @param l left list\n+     * @param r right list\n+     * @return l except r\n+     */\n+    private static List<MetadataResource> exceptMetadataResource(List<MetadataResource> l, List<MetadataResource> r)  {\n+        Map<String,MetadataResource> rMap = new HashMap<>();\n+        for (MetadataResource mr : r) rMap.put(mr.getId(),mr);\n+\n+        Iterator<MetadataResource> itr = l.iterator();", "originalCommit": "f752f8b8d3b2a0b4b6e9e454479f7766a55a46ad", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "97b7ccf09a270c64bc61a1b2d814b5dd47abc6bf", "chunk": "diff --git a/core/src/main/java/org/fao/geonet/api/records/attachments/StoreUtils.java b/core/src/main/java/org/fao/geonet/api/records/attachments/StoreUtils.java\nindex 04af4a2233..70b141758e 100644\n--- a/core/src/main/java/org/fao/geonet/api/records/attachments/StoreUtils.java\n+++ b/core/src/main/java/org/fao/geonet/api/records/attachments/StoreUtils.java\n\n@@ -88,20 +88,23 @@ public abstract class StoreUtils {\n         Map<String,MetadataResource> rMap = new HashMap<>();\n         for (MetadataResource mr : r) rMap.put(mr.getId(),mr);\n \n-        Iterator<MetadataResource> itr = l.iterator();\n+        // Start the results with a copy of the l list.\n+        List<MetadataResource> results = new ArrayList<>(l);\n+\n+        Iterator<MetadataResource> itResults = results.iterator();\n         // remove all that exist in rMap\n-        while (itr.hasNext()) {\n-            MetadataResource m = itr.next();\n+        while (itResults.hasNext()) {\n+            MetadataResource m = itResults.next();\n             if (rMap.containsKey(m.getId())) {\n                 MetadataResource mCheck = rMap.get(m.getId());\n                 if (mCheck.getFilename().equals(m.getFilename())\n                     && mCheck.getMetadataUuid().equals(m.getMetadataUuid())\n                     && mCheck.getVisibility().equals(m.getVisibility())) {\n-                    itr.remove();\n+                    itResults.remove();\n                 }\n             }\n         }\n-        return l;\n+        return results;\n     }\n \n     /**\n"}}, {"oid": "97b7ccf09a270c64bc61a1b2d814b5dd47abc6bf", "url": "https://github.com/geonetwork/core-geonetwork/commit/97b7ccf09a270c64bc61a1b2d814b5dd47abc6bf", "message": "Update exceptMetadataResource so that it makes a clone of the data that it modifies.", "committedDate": "2021-01-05T19:57:43Z", "type": "commit"}, {"oid": "b2f90b0e3c4a2c6c52798a8e3e6918bd453858df", "url": "https://github.com/geonetwork/core-geonetwork/commit/b2f90b0e3c4a2c6c52798a8e3e6918bd453858df", "message": "Minor corrections to typos in comments.", "committedDate": "2021-01-06T18:04:14Z", "type": "commit"}]}