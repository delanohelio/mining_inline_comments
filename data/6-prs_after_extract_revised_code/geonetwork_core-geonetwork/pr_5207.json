{"pr_number": 5207, "pr_title": "Fixed some keycloak issues when calling API's ", "pr_createdAt": "2020-11-24T18:10:51Z", "pr_url": "https://github.com/geonetwork/core-geonetwork/pull/5207", "timeline": [{"oid": "93592afb943d6b4d9d0a3eaaa8addee045aa5b37", "url": "https://github.com/geonetwork/core-geonetwork/commit/93592afb943d6b4d9d0a3eaaa8addee045aa5b37", "message": "Fixed some issues when calling API's autodetect-bearer-only needs to be set to true query string was not in the redirect url so parameters were being dropped. Added query string to redirect. In a reverse proxy situation, the request could be http when the server is setup to use https and this was causing issues. Ensure it is using https if the server is configured that way.", "committedDate": "2020-11-24T17:58:28Z", "type": "commit"}, {"oid": "f79d0bd5ae2d5f99fac2c620f45129c99ecd3ed4", "url": "https://github.com/geonetwork/core-geonetwork/commit/f79d0bd5ae2d5f99fac2c620f45129c99ecd3ed4", "message": "Fix bug in creating new group where the group language values were not being set", "committedDate": "2020-12-08T18:54:55Z", "type": "commit"}, {"oid": "ea459eeb7c259dc96c495eebf8a15bcdd753642a", "url": "https://github.com/geonetwork/core-geonetwork/commit/ea459eeb7c259dc96c495eebf8a15bcdd753642a", "message": "Fixed issue where api calls were not being authenticated correctly and they were being redirected when they should not be.", "committedDate": "2020-12-08T19:33:26Z", "type": "commit"}, {"oid": "f3cfab014e0809cfa4bdf05521444e5b4d3b804a", "url": "https://github.com/geonetwork/core-geonetwork/commit/f3cfab014e0809cfa4bdf05521444e5b4d3b804a", "message": "Remove http/https redirect caused by reverse proxy as this seems like a hack and the real solution seems to be to configure application server and keycloak correctly.\nhttps://www.keycloak.org/docs/latest/server_installation/#enable-https-ssl-with-a-reverse-proxy.", "committedDate": "2020-12-08T19:41:15Z", "type": "commit"}, {"oid": "647bac25c936525dba4856065e59a43a41bb28d5", "url": "https://github.com/geonetwork/core-geonetwork/commit/647bac25c936525dba4856065e59a43a41bb28d5", "message": "Fix resource selection so that it always gets the resource from the current client. This fixes and issue where a client from the same realm makes a api call using the token. It was using the issuer but in this case the issuer was the other client and we don't want that as it was not setting the proper permissions.", "committedDate": "2020-12-11T15:24:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDA5NTIyNQ==", "url": "https://github.com/geonetwork/core-geonetwork/pull/5207#discussion_r544095225", "bodyText": "I would add a comment explaining a bit the checks done, for example about the AdapterConstants values checks and in case that makes sense wrap them in a function.", "author": "josegar74", "createdAt": "2020-12-16T08:15:35Z", "path": "core/src/main/java/org/fao/geonet/kernel/security/keycloak/keycloakPreAuthActionsLoginFilter.java", "diffHunk": "@@ -58,12 +59,24 @@ public void doFilter(ServletRequest request, ServletResponse response, FilterCha\n         HttpServletResponse servletResponse = (HttpServletResponse) response;\n \n         if (servletRequest.getPathInfo() != null &&\n-                !(servletRequest.getContextPath() + KeycloakUtil.getSigninPath()).equals(servletRequest.getRequestURI())  &&\n-                !(servletRequest.getPathInfo()).equals(\"/k_logout\")  &&\n-                !isAuthenticated() ) {\n+            !KeycloakAuthenticationProcessingFilter.DEFAULT_REQUEST_MATCHER.matches(servletRequest) &&", "originalCommit": "647bac25c936525dba4856065e59a43a41bb28d5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a40dc35f38588327fececd6fa61273b42785a00f", "chunk": "diff --git a/core/src/main/java/org/fao/geonet/kernel/security/keycloak/keycloakPreAuthActionsLoginFilter.java b/core/src/main/java/org/fao/geonet/kernel/security/keycloak/keycloakPreAuthActionsLoginFilter.java\nindex c91707ae6f..a75c1348f2 100644\n--- a/core/src/main/java/org/fao/geonet/kernel/security/keycloak/keycloakPreAuthActionsLoginFilter.java\n+++ b/core/src/main/java/org/fao/geonet/kernel/security/keycloak/keycloakPreAuthActionsLoginFilter.java\n\n@@ -58,6 +58,12 @@ public class keycloakPreAuthActionsLoginFilter extends KeycloakPreAuthActionsFil\n         HttpServletRequest servletRequest = (HttpServletRequest) request;\n         HttpServletResponse servletResponse = (HttpServletResponse) response;\n \n+        // Lets redirect the user to the signin page if\n+        //     - The session is not authenticate\n+        //     - This is not a request for the signin page (we don't want endless loop to sign in page)\n+        //     - It does not match the default request matcher (which is mostly used to validate bearer tokens request for api's)\n+        //       No sign in page required for api calls.\n+        //     - and it is not an internal k_* request which should be processed by keycloak adapter and also don't required login page.\n         if (servletRequest.getPathInfo() != null &&\n             !KeycloakAuthenticationProcessingFilter.DEFAULT_REQUEST_MATCHER.matches(servletRequest) &&\n             !isAuthenticated() &&\n"}}, {"oid": "a40dc35f38588327fececd6fa61273b42785a00f", "url": "https://github.com/geonetwork/core-geonetwork/commit/a40dc35f38588327fececd6fa61273b42785a00f", "message": "Added comment explaining condition for sign in page redirect.", "committedDate": "2020-12-16T11:07:46Z", "type": "commit"}]}