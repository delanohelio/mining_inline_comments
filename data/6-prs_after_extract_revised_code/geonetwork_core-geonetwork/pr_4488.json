{"pr_number": 4488, "pr_title": "Migrate to GeoTools 23.0", "pr_createdAt": "2020-03-02T11:07:25Z", "pr_url": "https://github.com/geonetwork/core-geonetwork/pull/4488", "timeline": [{"oid": "908df9be59d57886d3fb894e64ad2f11052ad3bf", "url": "https://github.com/geonetwork/core-geonetwork/commit/908df9be59d57886d3fb894e64ad2f11052ad3bf", "message": "Migrate to GeoTools 22.3", "committedDate": "2020-03-02T10:54:59Z", "type": "commit"}, {"oid": "908df9be59d57886d3fb894e64ad2f11052ad3bf", "url": "https://github.com/geonetwork/core-geonetwork/commit/908df9be59d57886d3fb894e64ad2f11052ad3bf", "message": "Migrate to GeoTools 22.3", "committedDate": "2020-03-02T10:54:59Z", "type": "forcePushed"}, {"oid": "aeb4ab8c300110815d5952ced12aa1274835534f", "url": "https://github.com/geonetwork/core-geonetwork/commit/aeb4ab8c300110815d5952ced12aa1274835534f", "message": "Correct feature reprojection in WFS indexation", "committedDate": "2020-03-06T09:41:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzg5MDI1Nw==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4488#discussion_r397890257", "bodyText": "I like this approach, very safe to retroject to something you know (CRS:84) just based on the returned features.", "author": "jodygarnett", "createdAt": "2020-03-25T14:19:32Z", "path": "workers/wfsfeature-harvester/src/main/java/org/fao/geonet/harvester/wfsfeatures/worker/EsWFSFeatureIndexer.java", "diffHunk": "@@ -260,7 +256,10 @@ public void indexFeatures(Exchange exchange) throws Exception {\n             BulkResutHandler brh = new AsyncBulkResutHandler(phaser, typeName, url, nbOfFeatures, report);\n \n             long begin = System.currentTimeMillis();\n-            FeatureIterator<SimpleFeature> features = wfs.getFeatureSource(typeName).getFeatures(query).features();\n+\n+            ReprojectingFeatureCollection rfc = new ReprojectingFeatureCollection(wfs.getFeatureSource(typeName).getFeatures(query), CRS.decode(\"urn:ogc:def:crs:OGC:1.3:CRS84\"));", "originalCommit": "aeb4ab8c300110815d5952ced12aa1274835534f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA2MDM1Ng==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4488#discussion_r409060356", "bodyText": "I do not think query is adding value above, it just has query.setCoordinateSystem( ... ) which is then going to be managed locally by ReprojectingFeatureCollection.\nConsider simplification to:\nSimpleFeatureCollection features = was.getFeatureSource(typeName().getFeatures();\nReprojectingFeatureCollection rfc = new ReprojectingFeatureCollection( features, CRS.decode(\"urn:ogc:def:crs:OGC:1.3:CRS84\"));", "author": "jodygarnett", "createdAt": "2020-04-15T18:50:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzg5MDI1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA3OTMzMA==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4488#discussion_r409079330", "bodyText": "So if we not more use the query object, should I also remove its declaration  ?\nLine 248 -> 250", "author": "jusabatier", "createdAt": "2020-04-15T19:23:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzg5MDI1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTYzMjIwOQ==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4488#discussion_r409632209", "bodyText": "Yes good catch!", "author": "jodygarnett", "createdAt": "2020-04-16T15:06:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzg5MDI1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTcyNTcwNw==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4488#discussion_r409725707", "bodyText": "Done", "author": "jusabatier", "createdAt": "2020-04-16T17:25:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzg5MDI1Nw=="}], "type": "inlineReview", "revised_code": {"commit": "b5c638567530ff5976451d86af071b3e30f3fd62", "chunk": "diff --git a/workers/wfsfeature-harvester/src/main/java/org/fao/geonet/harvester/wfsfeatures/worker/EsWFSFeatureIndexer.java b/workers/wfsfeature-harvester/src/main/java/org/fao/geonet/harvester/wfsfeatures/worker/EsWFSFeatureIndexer.java\nindex 15896005e0..714e8248ab 100644\n--- a/workers/wfsfeature-harvester/src/main/java/org/fao/geonet/harvester/wfsfeatures/worker/EsWFSFeatureIndexer.java\n+++ b/workers/wfsfeature-harvester/src/main/java/org/fao/geonet/harvester/wfsfeatures/worker/EsWFSFeatureIndexer.java\n\n@@ -245,10 +245,6 @@ public class EsWFSFeatureIndexer {\n             throw new RuntimeException(\"couldn't initialize es report, don't even try to go further querying wfs.\");\n         }\n \n-        Query query = new Query();\n-\n-        query.setCoordinateSystem(wfs.getWfsClient().getDefaultCRS(wfs.getRemoteTypeName(wfs.getFeatureSource(typeName).getEntry().getName())));\n-\n         try {\n             nbOfFeatures = 0;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA2MDY0NA==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4488#discussion_r409060644", "bodyText": "Use try/finally block to ensure FeatureIterator is closed.", "author": "jodygarnett", "createdAt": "2020-04-15T18:50:49Z", "path": "workers/wfsfeature-harvester/src/main/java/org/fao/geonet/harvester/wfsfeatures/worker/EsWFSFeatureIndexer.java", "diffHunk": "@@ -260,7 +256,10 @@ public void indexFeatures(Exchange exchange) throws Exception {\n             BulkResutHandler brh = new AsyncBulkResutHandler(phaser, typeName, url, nbOfFeatures, report);\n \n             long begin = System.currentTimeMillis();\n-            FeatureIterator<SimpleFeature> features = wfs.getFeatureSource(typeName).getFeatures(query).features();\n+\n+            ReprojectingFeatureCollection rfc = new ReprojectingFeatureCollection(wfs.getFeatureSource(typeName).getFeatures(query), CRS.decode(\"urn:ogc:def:crs:OGC:1.3:CRS84\"));\n+\n+            FeatureIterator<SimpleFeature> features = rfc.features();", "originalCommit": "aeb4ab8c300110815d5952ced12aa1274835534f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTcyNTkxOQ==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4488#discussion_r409725919", "bodyText": "Done", "author": "jusabatier", "createdAt": "2020-04-16T17:25:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA2MDY0NA=="}], "type": "inlineReview", "revised_code": {"commit": "b5c638567530ff5976451d86af071b3e30f3fd62", "chunk": "diff --git a/workers/wfsfeature-harvester/src/main/java/org/fao/geonet/harvester/wfsfeatures/worker/EsWFSFeatureIndexer.java b/workers/wfsfeature-harvester/src/main/java/org/fao/geonet/harvester/wfsfeatures/worker/EsWFSFeatureIndexer.java\nindex 15896005e0..714e8248ab 100644\n--- a/workers/wfsfeature-harvester/src/main/java/org/fao/geonet/harvester/wfsfeatures/worker/EsWFSFeatureIndexer.java\n+++ b/workers/wfsfeature-harvester/src/main/java/org/fao/geonet/harvester/wfsfeatures/worker/EsWFSFeatureIndexer.java\n\n@@ -245,10 +245,6 @@ public class EsWFSFeatureIndexer {\n             throw new RuntimeException(\"couldn't initialize es report, don't even try to go further querying wfs.\");\n         }\n \n-        Query query = new Query();\n-\n-        query.setCoordinateSystem(wfs.getWfsClient().getDefaultCRS(wfs.getRemoteTypeName(wfs.getFeatureSource(typeName).getEntry().getName())));\n-\n         try {\n             nbOfFeatures = 0;\n \n"}}, {"oid": "5b1aa9213f772c1ee4e1d0155001a2b240e26b88", "url": "https://github.com/geonetwork/core-geonetwork/commit/5b1aa9213f772c1ee4e1d0155001a2b240e26b88", "message": "Upgrade to GeoTools 23.0", "committedDate": "2020-04-15T19:07:53Z", "type": "commit"}, {"oid": "b5c638567530ff5976451d86af071b3e30f3fd62", "url": "https://github.com/geonetwork/core-geonetwork/commit/b5c638567530ff5976451d86af071b3e30f3fd62", "message": "Remove unusefull query and add final statement to close iterator", "committedDate": "2020-04-16T17:23:15Z", "type": "commit"}, {"oid": "5d1adfa3809a35b88c576e7f0cd33c1479057bb1", "url": "https://github.com/geonetwork/core-geonetwork/commit/5d1adfa3809a35b88c576e7f0cd33c1479057bb1", "message": "Merge remote-tracking branch 'origin/master' into patch-geotools-22.3", "committedDate": "2020-04-17T12:42:14Z", "type": "commit"}]}