{"pr_number": 1078, "pr_title": "Add bxc version to software agent", "pr_createdAt": "2020-08-17T12:57:00Z", "pr_url": "https://github.com/UNC-Libraries/box-c/pull/1078", "timeline": [{"oid": "68edab2988772cd8c0c4030455b2dfd81b85300d", "url": "https://github.com/UNC-Libraries/box-c/commit/68edab2988772cd8c0c4030455b2dfd81b85300d", "message": "Add bxc version to software agent", "committedDate": "2020-08-17T12:55:25Z", "type": "commit"}, {"oid": "62bb3e95ebe2d13f78595410f969e3eadf7ba5e8", "url": "https://github.com/UNC-Libraries/box-c/commit/62bb3e95ebe2d13f78595410f969e3eadf7ba5e8", "message": "* Add bxc5 version to the spring context\n* Move bxc3 version to an enum\n* Bump default deposit version", "committedDate": "2020-08-18T15:23:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjI4MzA1NQ==", "url": "https://github.com/UNC-Libraries/box-c/pull/1078#discussion_r472283055", "bodyText": "if its a new work, then it was generated in bxc5, so you should need to override here", "author": "bbpennel", "createdAt": "2020-08-18T15:26:10Z", "path": "migration-util/src/main/java/edu/unc/lib/dcr/migration/content/ContentObjectTransformer.java", "diffHunk": "@@ -363,7 +364,7 @@ private void populateFileObject(Resource bxc3Resc, Model depositModel) {\n         // transform existing PREMIS as the events for the file object, rather than work\n         transformPremis(originalPid, filePid);\n         if (isNewWork) {\n-            addMigrationEvent(getPremisLogger(newPid));\n+            addMigrationEvent(getPremisLogger(newPid), depositBxc3.getFullname());", "originalCommit": "62bb3e95ebe2d13f78595410f969e3eadf7ba5e8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "70c21cddc5271759fcbea680f075d1ce38c9bf16", "chunk": "diff --git a/migration-util/src/main/java/edu/unc/lib/dcr/migration/content/ContentObjectTransformer.java b/migration-util/src/main/java/edu/unc/lib/dcr/migration/content/ContentObjectTransformer.java\nindex bb9bd9f1b..893634845 100644\n--- a/migration-util/src/main/java/edu/unc/lib/dcr/migration/content/ContentObjectTransformer.java\n+++ b/migration-util/src/main/java/edu/unc/lib/dcr/migration/content/ContentObjectTransformer.java\n\n@@ -364,7 +363,7 @@ public class ContentObjectTransformer extends RecursiveAction {\n         // transform existing PREMIS as the events for the file object, rather than work\n         transformPremis(originalPid, filePid);\n         if (isNewWork) {\n-            addMigrationEvent(getPremisLogger(newPid), depositBxc3.getFullname());\n+            addMigrationEvent(getPremisLogger(newPid));\n         }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjI4Mzc1Mg==", "url": "https://github.com/UNC-Libraries/box-c/pull/1078#discussion_r472283752", "bodyText": "this event describes the migration of the object from boxc3 to 5, so it should have the migration-util 5.0 agent.", "author": "bbpennel", "createdAt": "2020-08-18T15:27:04Z", "path": "migration-util/src/main/java/edu/unc/lib/dcr/migration/content/ContentObjectTransformer.java", "diffHunk": "@@ -381,18 +382,20 @@ private void transformPremis(PID bxc3Pid, PID bxc5Pid) {\n         premisTransformer.compute();\n \n         // Add migration event\n-        addMigrationEvent(premisLogger);\n+        addMigrationEvent(premisLogger, depositBxc3.getFullname());", "originalCommit": "62bb3e95ebe2d13f78595410f969e3eadf7ba5e8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "70c21cddc5271759fcbea680f075d1ce38c9bf16", "chunk": "diff --git a/migration-util/src/main/java/edu/unc/lib/dcr/migration/content/ContentObjectTransformer.java b/migration-util/src/main/java/edu/unc/lib/dcr/migration/content/ContentObjectTransformer.java\nindex bb9bd9f1b..893634845 100644\n--- a/migration-util/src/main/java/edu/unc/lib/dcr/migration/content/ContentObjectTransformer.java\n+++ b/migration-util/src/main/java/edu/unc/lib/dcr/migration/content/ContentObjectTransformer.java\n\n@@ -382,7 +381,7 @@ public class ContentObjectTransformer extends RecursiveAction {\n         premisTransformer.compute();\n \n         // Add migration event\n-        addMigrationEvent(premisLogger, depositBxc3.getFullname());\n+        addMigrationEvent(premisLogger);\n     }\n \n     private PremisLogger getPremisLogger(PID bxc5Pid) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjI4OTAyNw==", "url": "https://github.com/UNC-Libraries/box-c/pull/1078#discussion_r472289027", "bodyText": "I think you can remove this. It looks like TransformContentCommand uses service-context.xml now as well, so cdrVersion should be getting set that way already.", "author": "bbpennel", "createdAt": "2020-08-18T15:34:06Z", "path": "migration-util/src/main/java/edu/unc/lib/dcr/migration/content/ContentObjectTransformer.java", "diffHunk": "@@ -381,18 +382,20 @@ private void transformPremis(PID bxc3Pid, PID bxc5Pid) {\n         premisTransformer.compute();\n \n         // Add migration event\n-        addMigrationEvent(premisLogger);\n+        addMigrationEvent(premisLogger, depositBxc3.getFullname());\n     }\n \n     private PremisLogger getPremisLogger(PID bxc5Pid) {\n         Path transformedPremisPath = directoryManager.getPremisPath(bxc5Pid);\n         return premisLoggerFactory.createPremisLogger(bxc5Pid, transformedPremisPath.toFile());\n     }\n \n-    private void addMigrationEvent(PremisLogger premisLogger) {\n+    private void addMigrationEvent(PremisLogger premisLogger, String version) {\n+        SoftwareAgentConstants.setCdrVersion(version);", "originalCommit": "62bb3e95ebe2d13f78595410f969e3eadf7ba5e8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "70c21cddc5271759fcbea680f075d1ce38c9bf16", "chunk": "diff --git a/migration-util/src/main/java/edu/unc/lib/dcr/migration/content/ContentObjectTransformer.java b/migration-util/src/main/java/edu/unc/lib/dcr/migration/content/ContentObjectTransformer.java\nindex bb9bd9f1b..893634845 100644\n--- a/migration-util/src/main/java/edu/unc/lib/dcr/migration/content/ContentObjectTransformer.java\n+++ b/migration-util/src/main/java/edu/unc/lib/dcr/migration/content/ContentObjectTransformer.java\n\n@@ -382,7 +381,7 @@ public class ContentObjectTransformer extends RecursiveAction {\n         premisTransformer.compute();\n \n         // Add migration event\n-        addMigrationEvent(premisLogger, depositBxc3.getFullname());\n+        addMigrationEvent(premisLogger);\n     }\n \n     private PremisLogger getPremisLogger(PID bxc5Pid) {\n"}}, {"oid": "70c21cddc5271759fcbea680f075d1ce38c9bf16", "url": "https://github.com/UNC-Libraries/box-c/commit/70c21cddc5271759fcbea680f075d1ce38c9bf16", "message": "Move version update to premis transformers", "committedDate": "2020-08-18T17:54:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzAwODM0MA==", "url": "https://github.com/UNC-Libraries/box-c/pull/1078#discussion_r473008340", "bodyText": "Once you make the change to the definition of \"depositBxc3\" suggested above, I think you'll be able to remove this method since the regular getFullname() method should be adding in 3.0 already since version is defined.", "author": "bbpennel", "createdAt": "2020-08-19T12:58:04Z", "path": "metadata/src/main/java/edu/unc/lib/dl/util/SoftwareAgentConstants.java", "diffHunk": "@@ -60,6 +61,10 @@ private SoftwareAgent(String value, String version) {\n             this.version = version;\n         }\n \n+        public String getFullname(String bxcVersion) {", "originalCommit": "70c21cddc5271759fcbea680f075d1ce38c9bf16", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "16cb27f789dc6be3057e6b7cf251dac19b1a8ab2", "chunk": "diff --git a/metadata/src/main/java/edu/unc/lib/dl/util/SoftwareAgentConstants.java b/metadata/src/main/java/edu/unc/lib/dl/util/SoftwareAgentConstants.java\nindex 6c7f202bc..edbac5a8e 100644\n--- a/metadata/src/main/java/edu/unc/lib/dl/util/SoftwareAgentConstants.java\n+++ b/metadata/src/main/java/edu/unc/lib/dl/util/SoftwareAgentConstants.java\n\n@@ -61,14 +61,11 @@ public class SoftwareAgentConstants {\n             this.version = version;\n         }\n \n-        public String getFullname(String bxcVersion) {\n-            return value + \"-\" + bxcVersion;\n-        }\n-\n         public String getFullname() {\n             if (version == null) {\n                 return value + \"-\" + getCdrVersion();\n             }\n+\n             return value + \"-\" + version;\n         }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzAwOTE1MA==", "url": "https://github.com/UNC-Libraries/box-c/pull/1078#discussion_r473009150", "bodyText": "you need to add the name of the service, depositBxc3(\"deposit\", \"3.0\"), right now you're setting the version as the name of the service.", "author": "bbpennel", "createdAt": "2020-08-19T12:59:13Z", "path": "metadata/src/main/java/edu/unc/lib/dl/util/SoftwareAgentConstants.java", "diffHunk": "@@ -44,6 +44,7 @@ public static String getCdrVersion() {\n         embargoUpdateService(\"embargo-update\"),\n         migrationUtil(\"bxc-migration-util\"),\n         clamav(\"clamav\", \"0.99\"),\n+        depositBxc3(\"3.0\"),", "originalCommit": "70c21cddc5271759fcbea680f075d1ce38c9bf16", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "16cb27f789dc6be3057e6b7cf251dac19b1a8ab2", "chunk": "diff --git a/metadata/src/main/java/edu/unc/lib/dl/util/SoftwareAgentConstants.java b/metadata/src/main/java/edu/unc/lib/dl/util/SoftwareAgentConstants.java\nindex 6c7f202bc..edbac5a8e 100644\n--- a/metadata/src/main/java/edu/unc/lib/dl/util/SoftwareAgentConstants.java\n+++ b/metadata/src/main/java/edu/unc/lib/dl/util/SoftwareAgentConstants.java\n\n@@ -44,7 +44,7 @@ public class SoftwareAgentConstants {\n         embargoUpdateService(\"embargo-update\"),\n         migrationUtil(\"bxc-migration-util\"),\n         clamav(\"clamav\", \"0.99\"),\n-        depositBxc3(\"3.0\"),\n+        depositBxc3(\"deposit\", \"3.0\"),\n         FITS(\"fits\", \"1.0.6\"),\n         curatorsWorkbench(\"curators-workbench\"),\n         embargoExpirationService(\"embargo-update-service\");\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzAxMDYwNA==", "url": "https://github.com/UNC-Libraries/box-c/pull/1078#discussion_r473010604", "bodyText": "i'm guessing these changes won't be necessary after updating depositBxc3 to have the name of the service, so you should be able to roll them back", "author": "bbpennel", "createdAt": "2020-08-19T13:01:25Z", "path": "migration-util/src/main/java/edu/unc/lib/dcr/migration/premis/ContentPremisToRdfTransformer.java", "diffHunk": "@@ -307,7 +308,11 @@ private void addFixityEvent(Element eventEl, String eventOutcome) {\n     }\n \n     private void addEvent(Element eventEl, Resource eventType, String eventDetail, SoftwareAgent agent) {\n-        addEvent(eventEl, eventType, eventDetail, true, agent.getFullname());\n+        String agentFullname = agent.getFullname();", "originalCommit": "70c21cddc5271759fcbea680f075d1ce38c9bf16", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "16cb27f789dc6be3057e6b7cf251dac19b1a8ab2", "chunk": "diff --git a/migration-util/src/main/java/edu/unc/lib/dcr/migration/premis/ContentPremisToRdfTransformer.java b/migration-util/src/main/java/edu/unc/lib/dcr/migration/premis/ContentPremisToRdfTransformer.java\nindex bef25cebd..36aef4aad 100644\n--- a/migration-util/src/main/java/edu/unc/lib/dcr/migration/premis/ContentPremisToRdfTransformer.java\n+++ b/migration-util/src/main/java/edu/unc/lib/dcr/migration/premis/ContentPremisToRdfTransformer.java\n\n@@ -308,11 +307,7 @@ public class ContentPremisToRdfTransformer extends AbstractPremisToRdfTransforme\n     }\n \n     private void addEvent(Element eventEl, Resource eventType, String eventDetail, SoftwareAgent agent) {\n-        String agentFullname = agent.getFullname();\n-        if (agentFullname.equals(\"deposit\")) {\n-            agentFullname += depositBxc3.getFullname();\n-        }\n-        addEvent(eventEl, eventType, eventDetail, true, agentFullname);\n+        addEvent(eventEl, eventType, eventDetail, true, agent.getFullname());\n     }\n \n     private void addEvent(Element eventEl, Resource eventType, String eventDetail,\n"}}, {"oid": "16cb27f789dc6be3057e6b7cf251dac19b1a8ab2", "url": "https://github.com/UNC-Libraries/box-c/commit/16cb27f789dc6be3057e6b7cf251dac19b1a8ab2", "message": "Add \"name\" for depositBxc3", "committedDate": "2020-08-19T18:48:46Z", "type": "commit"}, {"oid": "16cb27f789dc6be3057e6b7cf251dac19b1a8ab2", "url": "https://github.com/UNC-Libraries/box-c/commit/16cb27f789dc6be3057e6b7cf251dac19b1a8ab2", "message": "Add \"name\" for depositBxc3", "committedDate": "2020-08-19T18:48:46Z", "type": "forcePushed"}]}