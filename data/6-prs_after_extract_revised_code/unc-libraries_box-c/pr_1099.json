{"pr_number": 1099, "pr_title": "Add delay before retrying ingests due to checksum failure", "pr_createdAt": "2020-10-13T17:05:57Z", "pr_url": "https://github.com/UNC-Libraries/box-c/pull/1099", "timeline": [{"oid": "6f75caf4ee8bbc42a0f15f77acabf18316464c26", "url": "https://github.com/UNC-Libraries/box-c/commit/6f75caf4ee8bbc42a0f15f77acabf18316464c26", "message": "Add delay before retrying ingest", "committedDate": "2020-10-13T16:54:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE0Nzk4Nw==", "url": "https://github.com/UNC-Libraries/box-c/pull/1099#discussion_r504147987", "bodyText": "might be simpler to perform the delay in the ChecksumMismatchException catch, it already has a block to check if retries are remaining and the automatic result would be there wouldn't be a delay until after the first try.", "author": "bbpennel", "createdAt": "2020-10-13T17:53:36Z", "path": "deposit/src/main/java/edu/unc/lib/deposit/fcrepo4/IngestContentObjectsJob.java", "diffHunk": "@@ -396,6 +396,15 @@ private FileObject addFileToWork(WorkObject work, Resource childResc)\n         // Retry if there are checksum failures\n         for (int retryCnt = 1; retryCnt <= CHECKSUM_RETRIES; retryCnt++) {\n             try {\n+                if (retryCnt > 1) {", "originalCommit": "6f75caf4ee8bbc42a0f15f77acabf18316464c26", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3b2b972fbc24d294288cf185d5ca6e200d0ed232", "chunk": "diff --git a/deposit/src/main/java/edu/unc/lib/deposit/fcrepo4/IngestContentObjectsJob.java b/deposit/src/main/java/edu/unc/lib/deposit/fcrepo4/IngestContentObjectsJob.java\nindex e35f226ab..211a7cf39 100644\n--- a/deposit/src/main/java/edu/unc/lib/deposit/fcrepo4/IngestContentObjectsJob.java\n+++ b/deposit/src/main/java/edu/unc/lib/deposit/fcrepo4/IngestContentObjectsJob.java\n\n@@ -396,21 +397,17 @@ public class IngestContentObjectsJob extends AbstractDepositJob {\n         // Retry if there are checksum failures\n         for (int retryCnt = 1; retryCnt <= CHECKSUM_RETRIES; retryCnt++) {\n             try {\n-                if (retryCnt > 1) {\n-                    try {\n-                        Thread.sleep(retryCnt * 1000);\n-                    } catch (InterruptedException e) {\n-                        log.debug(\"Retry ingest pause for {} due to a checksum mismatch, {} retries remaining: {}\",\n-                                childPid.getQualifiedId(), CHECKSUM_RETRIES - retryCnt, e.getMessage());\n-                    }\n-                }\n-\n                 fileObj = work.addDataFile(childPid, storageUri, label, mimetype, sha1, md5, aipModel);\n                 break;\n             } catch (ChecksumMismatchException e) {\n                 if ((CHECKSUM_RETRIES - retryCnt) > 0) {\n                     log.warn(\"Failed to ingest file {} due to a checksum mismatch, {} retries remaining: {}\",\n                             childPid.getQualifiedId(), CHECKSUM_RETRIES - retryCnt, e.getMessage());\n+                    try {\n+                        Thread.sleep(retryCnt * 1000);\n+                    } catch (InterruptedException ef) {\n+                        throw new JobInterruptedException(e.getMessage());\n+                    }\n                 } else {\n                     failJob(\"Unable to ingest \" + childPid.getQualifiedId(), e.getMessage());\n                 }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE0OTEyOQ==", "url": "https://github.com/UNC-Libraries/box-c/pull/1099#discussion_r504149129", "bodyText": "rather than eating the interrupt, could you rethrow it as a JobInterruptedException? Shouldn't need an extra log statement in that case.", "author": "bbpennel", "createdAt": "2020-10-13T17:55:32Z", "path": "deposit/src/main/java/edu/unc/lib/deposit/fcrepo4/IngestContentObjectsJob.java", "diffHunk": "@@ -396,6 +396,15 @@ private FileObject addFileToWork(WorkObject work, Resource childResc)\n         // Retry if there are checksum failures\n         for (int retryCnt = 1; retryCnt <= CHECKSUM_RETRIES; retryCnt++) {\n             try {\n+                if (retryCnt > 1) {\n+                    try {\n+                        Thread.sleep(retryCnt * 1000);\n+                    } catch (InterruptedException e) {\n+                        log.debug(\"Retry ingest pause for {} due to a checksum mismatch, {} retries remaining: {}\",", "originalCommit": "6f75caf4ee8bbc42a0f15f77acabf18316464c26", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3b2b972fbc24d294288cf185d5ca6e200d0ed232", "chunk": "diff --git a/deposit/src/main/java/edu/unc/lib/deposit/fcrepo4/IngestContentObjectsJob.java b/deposit/src/main/java/edu/unc/lib/deposit/fcrepo4/IngestContentObjectsJob.java\nindex e35f226ab..211a7cf39 100644\n--- a/deposit/src/main/java/edu/unc/lib/deposit/fcrepo4/IngestContentObjectsJob.java\n+++ b/deposit/src/main/java/edu/unc/lib/deposit/fcrepo4/IngestContentObjectsJob.java\n\n@@ -396,21 +397,17 @@ public class IngestContentObjectsJob extends AbstractDepositJob {\n         // Retry if there are checksum failures\n         for (int retryCnt = 1; retryCnt <= CHECKSUM_RETRIES; retryCnt++) {\n             try {\n-                if (retryCnt > 1) {\n-                    try {\n-                        Thread.sleep(retryCnt * 1000);\n-                    } catch (InterruptedException e) {\n-                        log.debug(\"Retry ingest pause for {} due to a checksum mismatch, {} retries remaining: {}\",\n-                                childPid.getQualifiedId(), CHECKSUM_RETRIES - retryCnt, e.getMessage());\n-                    }\n-                }\n-\n                 fileObj = work.addDataFile(childPid, storageUri, label, mimetype, sha1, md5, aipModel);\n                 break;\n             } catch (ChecksumMismatchException e) {\n                 if ((CHECKSUM_RETRIES - retryCnt) > 0) {\n                     log.warn(\"Failed to ingest file {} due to a checksum mismatch, {} retries remaining: {}\",\n                             childPid.getQualifiedId(), CHECKSUM_RETRIES - retryCnt, e.getMessage());\n+                    try {\n+                        Thread.sleep(retryCnt * 1000);\n+                    } catch (InterruptedException ef) {\n+                        throw new JobInterruptedException(e.getMessage());\n+                    }\n                 } else {\n                     failJob(\"Unable to ingest \" + childPid.getQualifiedId(), e.getMessage());\n                 }\n"}}, {"oid": "3b2b972fbc24d294288cf185d5ca6e200d0ed232", "url": "https://github.com/UNC-Libraries/box-c/commit/3b2b972fbc24d294288cf185d5ca6e200d0ed232", "message": "Move retry delay", "committedDate": "2020-10-13T20:22:51Z", "type": "commit"}, {"oid": "3b2b972fbc24d294288cf185d5ca6e200d0ed232", "url": "https://github.com/UNC-Libraries/box-c/commit/3b2b972fbc24d294288cf185d5ca6e200d0ed232", "message": "Move retry delay", "committedDate": "2020-10-13T20:22:51Z", "type": "forcePushed"}]}