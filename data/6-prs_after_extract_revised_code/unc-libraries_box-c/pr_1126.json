{"pr_number": 1126, "pr_title": "BXC-2856 - Fix user based permissions issues", "pr_createdAt": "2020-11-12T17:01:51Z", "pr_url": "https://github.com/UNC-Libraries/box-c/pull/1126", "timeline": [{"oid": "659bd943c84e4287604d8d16d544137b6148e001", "url": "https://github.com/UNC-Libraries/box-c/commit/659bd943c84e4287604d8d16d544137b6148e001", "message": "Make sure that the user principal is provided for most ACL checks by using getAgentPrincipal instead of getGroups. Store agent principals in the group thread store rather than regenerating on each method call. Fix NPE when accessing structure browse in admin interface with no permissions to the content root", "committedDate": "2020-11-12T16:56:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjMyOTYzMw==", "url": "https://github.com/UNC-Libraries/box-c/pull/1126#discussion_r522329633", "bodyText": "Not a big issue, but would a wrapper method be useful for all of these GroupsThreadStore.getAgentPrincipals().getPrincipals() calls?", "author": "lfarrell", "createdAt": "2020-11-12T18:37:31Z", "path": "access-common/src/main/java/edu/unc/lib/dl/ui/access/StoreAccessLevelFilter.java", "diffHunk": "@@ -73,17 +73,17 @@ public void doFilterInternal(HttpServletRequest request, HttpServletResponse res\n                 session.removeAttribute(\"accessLevel\");\n                 accessLevel = new AccessLevel(username);\n                 session.setAttribute(\"accessLevel\", accessLevel);\n-                AccessGroupSet groups = GroupsThreadStore.getGroups();\n-                if (globalPermissionEvaluator.hasGlobalPrincipal(groups)) {\n-                    Set<UserRole> roles = globalPermissionEvaluator.getGlobalUserRoles(groups);\n+                AccessGroupSet principals = GroupsThreadStore.getAgentPrincipals().getPrincipals();", "originalCommit": "659bd943c84e4287604d8d16d544137b6148e001", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1a6336bf13469f81aa07418995c86f615f67f140", "chunk": "diff --git a/access-common/src/main/java/edu/unc/lib/dl/ui/access/StoreAccessLevelFilter.java b/access-common/src/main/java/edu/unc/lib/dl/ui/access/StoreAccessLevelFilter.java\nindex eb1d17bbc..cdadf482f 100644\n--- a/access-common/src/main/java/edu/unc/lib/dl/ui/access/StoreAccessLevelFilter.java\n+++ b/access-common/src/main/java/edu/unc/lib/dl/ui/access/StoreAccessLevelFilter.java\n\n@@ -73,7 +73,7 @@ public class StoreAccessLevelFilter extends OncePerRequestFilter implements Serv\n                 session.removeAttribute(\"accessLevel\");\n                 accessLevel = new AccessLevel(username);\n                 session.setAttribute(\"accessLevel\", accessLevel);\n-                AccessGroupSet principals = GroupsThreadStore.getAgentPrincipals().getPrincipals();\n+                AccessGroupSet principals = GroupsThreadStore.getPrincipals();\n                 if (globalPermissionEvaluator.hasGlobalPrincipal(principals)) {\n                     Set<UserRole> roles = globalPermissionEvaluator.getGlobalUserRoles(principals);\n                     if (roles.contains(UserRole.administrator)) {\n"}}, {"oid": "1a6336bf13469f81aa07418995c86f615f67f140", "url": "https://github.com/UNC-Libraries/box-c/commit/1a6336bf13469f81aa07418995c86f615f67f140", "message": "Use wrapper for getting principals", "committedDate": "2020-11-12T20:52:31Z", "type": "commit"}]}