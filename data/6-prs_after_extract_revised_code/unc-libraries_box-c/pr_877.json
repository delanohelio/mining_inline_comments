{"pr_number": 877, "pr_title": "BXC-2471 - Destroy action cleans up external files", "pr_createdAt": "2020-01-08T22:13:00Z", "pr_url": "https://github.com/UNC-Libraries/box-c/pull/877", "timeline": [{"oid": "a1812f2f2e70b7e79c4f47e0049c9557f0942e2e", "url": "https://github.com/UNC-Libraries/box-c/commit/a1812f2f2e70b7e79c4f47e0049c9557f0942e2e", "message": "Refactor destroy action into a camel task. Add test for destroy service. Split acl service initialization into its own context for tests\"", "committedDate": "2020-01-07T18:46:42Z", "type": "commit"}, {"oid": "55b13250e57ad6527f36d89a02346be2232b0c29", "url": "https://github.com/UNC-Libraries/box-c/commit/55b13250e57ad6527f36d89a02346be2232b0c29", "message": "Add method to delete files from storage locations", "committedDate": "2020-01-07T19:04:03Z", "type": "commit"}, {"oid": "8bdaaffc72ff51e69ea09e9fc7690b5ee45a8fed", "url": "https://github.com/UNC-Libraries/box-c/commit/8bdaaffc72ff51e69ea09e9fc7690b5ee45a8fed", "message": "Destroy action cleans up external binaries for original files. Normalizing external binary uris to only have :/ instead of :/// for file uris, since fedora does this to the uris", "committedDate": "2020-01-08T18:58:50Z", "type": "commit"}, {"oid": "8b4da9485a6e061497b88f708bb214cd417fce59", "url": "https://github.com/UNC-Libraries/box-c/commit/8b4da9485a6e061497b88f708bb214cd417fce59", "message": "Clear objects from solr index after they are destroyed", "committedDate": "2020-01-08T22:02:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTk4MTg3Ng==", "url": "https://github.com/UNC-Libraries/box-c/pull/877#discussion_r365981876", "bodyText": "Don't delete the binaries until the fedora cleanup has been successful, otherwise the rollback can result in objects with missing files.", "author": "bbpennel", "createdAt": "2020-01-13T19:21:08Z", "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/destroy/DestroyObjectsJob.java", "diffHunk": "@@ -84,10 +112,18 @@ public void run() {\n             // convert each destroyed obj to a tombstone\n             for (PID pid : objsToDestroy) {\n                 RepositoryObject repoObj = repoObjLoader.getRepositoryObject(pid);\n+\n+                assertCanDestroy(agent, repoObj, aclService);", "originalCommit": "8b4da9485a6e061497b88f708bb214cd417fce59", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8a442fdd9c20c1936028a1414d81b5c3a80d00ef", "chunk": "diff --git a/persistence/src/main/java/edu/unc/lib/dl/persist/services/destroy/DestroyObjectsJob.java b/persistence/src/main/java/edu/unc/lib/dl/persist/services/destroy/DestroyObjectsJob.java\nindex 99a605798..243a220ab 100644\n--- a/persistence/src/main/java/edu/unc/lib/dl/persist/services/destroy/DestroyObjectsJob.java\n+++ b/persistence/src/main/java/edu/unc/lib/dl/persist/services/destroy/DestroyObjectsJob.java\n\n@@ -130,6 +135,9 @@ public class DestroyObjectsJob implements Runnable {\n         } finally {\n              tx.close();\n         }\n+\n+        // Defer binary cleanup until after fedora destroy transaction completes\n+        destroyBinaries();\n     }\n \n     private void destroyTree(RepositoryObject rootOfTree) throws FedoraException, IOException,\n"}}, {"oid": "8a442fdd9c20c1936028a1414d81b5c3a80d00ef", "url": "https://github.com/UNC-Libraries/box-c/commit/8a442fdd9c20c1936028a1414d81b5c3a80d00ef", "message": "Defer binary cleanup until after fedora destroy transaction completes", "committedDate": "2020-01-13T19:45:13Z", "type": "commit"}, {"oid": "27dd79ae6306ce847b3f08ec4260abae6118a1e5", "url": "https://github.com/UNC-Libraries/box-c/commit/27dd79ae6306ce847b3f08ec4260abae6118a1e5", "message": "Skip binary destruction if the uri array is empty", "committedDate": "2020-01-13T21:17:28Z", "type": "commit"}]}