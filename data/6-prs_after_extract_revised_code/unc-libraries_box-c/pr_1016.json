{"pr_number": 1016, "pr_title": "Check if file has already been ingested", "pr_createdAt": "2020-06-15T19:01:40Z", "pr_url": "https://github.com/UNC-Libraries/box-c/pull/1016", "timeline": [{"oid": "805597c07790cf6c6c9219261fe6b47ad34a42fc", "url": "https://github.com/UNC-Libraries/box-c/commit/805597c07790cf6c6c9219261fe6b47ad34a42fc", "message": "Check if file has already been ingested", "committedDate": "2020-06-15T19:00:37Z", "type": "commit"}, {"oid": "7dc0705928d6d46e5ece3b4daec8222fced61df3", "url": "https://github.com/UNC-Libraries/box-c/commit/7dc0705928d6d46e5ece3b4daec8222fced61df3", "message": "Move check into file ingest methods", "committedDate": "2020-06-15T19:24:18Z", "type": "commit"}, {"oid": "d6c8d7a5a9d282d8d09dbb5e5ca146c0551c83f9", "url": "https://github.com/UNC-Libraries/box-c/commit/d6c8d7a5a9d282d8d09dbb5e5ca146c0551c83f9", "message": "Make names consistent", "committedDate": "2020-06-16T13:30:23Z", "type": "commit"}, {"oid": "f62f15a793e8220c26a1c609df0c0ed2ba175775", "url": "https://github.com/UNC-Libraries/box-c/commit/f62f15a793e8220c26a1c609df0c0ed2ba175775", "message": "Don't set retrieveStatus as a global", "committedDate": "2020-06-16T14:48:12Z", "type": "commit"}, {"oid": "48da62fd29b3fe46e6fc334d2c77106a355a50e8", "url": "https://github.com/UNC-Libraries/box-c/commit/48da62fd29b3fe46e6fc334d2c77106a355a50e8", "message": "Use datastream Id", "committedDate": "2020-06-16T18:58:52Z", "type": "commit"}, {"oid": "21c91db8097d0ced7575daa353b6a48727b74855", "url": "https://github.com/UNC-Libraries/box-c/commit/21c91db8097d0ced7575daa353b6a48727b74855", "message": "Check if manifest has already been deposited", "committedDate": "2020-06-17T14:04:37Z", "type": "commit"}, {"oid": "097aef815230013bae1f5fcefacb8bdcdd75aca8", "url": "https://github.com/UNC-Libraries/box-c/commit/097aef815230013bae1f5fcefacb8bdcdd75aca8", "message": "Switch to using depositUUID + classname for redis key", "committedDate": "2020-06-17T18:17:05Z", "type": "commit"}, {"oid": "097aef815230013bae1f5fcefacb8bdcdd75aca8", "url": "https://github.com/UNC-Libraries/box-c/commit/097aef815230013bae1f5fcefacb8bdcdd75aca8", "message": "Switch to using depositUUID + classname for redis key", "committedDate": "2020-06-17T18:17:05Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTgzOTY3Mw==", "url": "https://github.com/UNC-Libraries/box-c/pull/1016#discussion_r441839673", "bodyText": "Could you change the name of the two new methods to use the \"Completed\" language instead of \"Ingested\"? And add javadoc to describe what they are for", "author": "bbpennel", "createdAt": "2020-06-17T21:17:34Z", "path": "metadata/src/main/java/edu/unc/lib/dl/util/JobStatusFactory.java", "diffHunk": "@@ -161,6 +163,18 @@ public void setTotalCompletion(String jobUUID, int totalClicks) {\n         }\n     }\n \n+    public boolean objectIsIngested(String depositId, String objectId) {", "originalCommit": "097aef815230013bae1f5fcefacb8bdcdd75aca8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9bd40e652fb939e1cf4e9531f350f41e0c2a7416", "chunk": "diff --git a/metadata/src/main/java/edu/unc/lib/dl/util/JobStatusFactory.java b/metadata/src/main/java/edu/unc/lib/dl/util/JobStatusFactory.java\nindex bb94a0bf1..3c2510e42 100644\n--- a/metadata/src/main/java/edu/unc/lib/dl/util/JobStatusFactory.java\n+++ b/metadata/src/main/java/edu/unc/lib/dl/util/JobStatusFactory.java\n\n@@ -163,13 +163,26 @@ public class JobStatusFactory {\n         }\n     }\n \n-    public boolean objectIsIngested(String depositId, String objectId) {\n+    /**\n+     * Checks if a binary is already in the list of deposited objects for the current deposit\n+     *\n+     * @param depositId Id of the current deposit\n+     * @param objectId Id of the currently ingesting object\n+     * @return boolean\n+     */\n+    public boolean objectIsCompleted(String depositId, String objectId) {\n         try (Jedis jedis = getJedisPool().getResource()) {\n             return jedis.sismember(JOB_COMPLETED_OBJECTS + depositId, objectId);\n         }\n     }\n \n-    public void addObjectIngested(String depositId, String objectId) {\n+    /**\n+     * A list of the values of the current deposit's objects that have been ingested\n+     *\n+     * @param depositId Id of the current deposit\n+     * @param objectId Id of the ingested object\n+     */\n+    public void addObjectCompleted(String depositId, String objectId) {\n         try (Jedis jedis = getJedisPool().getResource()) {\n             jedis.sadd(JOB_COMPLETED_OBJECTS + depositId, objectId);\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTg0MDg5MQ==", "url": "https://github.com/UNC-Libraries/box-c/pull/1016#discussion_r441840891", "bodyText": "This seems like an operation we are going to be doing in many places. It would likely make sense and save some repetition to add protected methods to the parent class for the deposit jobs, isObjectCompleted and markObjectCompleted. They can both take a PID, the parent class should already have access to the deposit id and jobStatusFactory.\nThe parent class can also setup the identifier used for the progress tracking field. You should be able to do something like:\nString depositJobId = depositUUID + \":\" + this.getClass().getName();\nto get the name of the job running rather than the name of parent class.", "author": "bbpennel", "createdAt": "2020-06-17T21:20:16Z", "path": "deposit/src/main/java/edu/unc/lib/deposit/transfer/TransferBinariesToStorageJob.java", "diffHunk": "@@ -164,9 +191,15 @@ private void transferDepositManifests(PID objPid, Resource resc, BinaryTransferS\n                         manifestPath, getDepositUUID());\n                 continue;\n             }\n+\n+            JobStatusFactory jobStatusFactory = getJobStatusFactory();\n             PID manifestPid = getDepositManifestPid(objPid, manifestFile.getName());\n-            URI storageUri = transferSession.transfer(manifestPid, manifestUri);\n-            resc.addLiteral(CdrDeposit.storageUri, storageUri.toString());\n+\n+            if (!jobStatusFactory.objectIsIngested(depositId, manifestPid.getQualifiedId())) {", "originalCommit": "097aef815230013bae1f5fcefacb8bdcdd75aca8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9bd40e652fb939e1cf4e9531f350f41e0c2a7416", "chunk": "diff --git a/deposit/src/main/java/edu/unc/lib/deposit/transfer/TransferBinariesToStorageJob.java b/deposit/src/main/java/edu/unc/lib/deposit/transfer/TransferBinariesToStorageJob.java\nindex a4f49e1f1..b3ca19b32 100644\n--- a/deposit/src/main/java/edu/unc/lib/deposit/transfer/TransferBinariesToStorageJob.java\n+++ b/deposit/src/main/java/edu/unc/lib/deposit/transfer/TransferBinariesToStorageJob.java\n\n@@ -192,13 +176,12 @@ public class TransferBinariesToStorageJob extends AbstractDepositJob {\n                 continue;\n             }\n \n-            JobStatusFactory jobStatusFactory = getJobStatusFactory();\n             PID manifestPid = getDepositManifestPid(objPid, manifestFile.getName());\n \n-            if (!jobStatusFactory.objectIsIngested(depositId, manifestPid.getQualifiedId())) {\n+            if (!isObjectCompleted(manifestPid)) {\n                 URI storageUri = transferSession.transfer(manifestPid, manifestUri);\n                 resc.addLiteral(CdrDeposit.storageUri, storageUri.toString());\n-                jobStatusFactory.addObjectIngested(depositId, manifestPid.getQualifiedId());\n+                markObjectCompleted(manifestPid);\n             }\n         }\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTg0Mzk1Nw==", "url": "https://github.com/UNC-Libraries/box-c/pull/1016#discussion_r441843957", "bodyText": "this would probably be clearer as depositJobId", "author": "bbpennel", "createdAt": "2020-06-17T21:27:02Z", "path": "deposit/src/main/java/edu/unc/lib/deposit/transfer/TransferBinariesToStorageJob.java", "diffHunk": "@@ -74,6 +77,7 @@ public TransferBinariesToStorageJob() {\n      */\n     public TransferBinariesToStorageJob(String uuid, String depositUUID) {\n         super(uuid, depositUUID);\n+        this.depositId = depositUUID + \":\" + TransferBinariesToStorageJob.class.getName();", "originalCommit": "097aef815230013bae1f5fcefacb8bdcdd75aca8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9bd40e652fb939e1cf4e9531f350f41e0c2a7416", "chunk": "diff --git a/deposit/src/main/java/edu/unc/lib/deposit/transfer/TransferBinariesToStorageJob.java b/deposit/src/main/java/edu/unc/lib/deposit/transfer/TransferBinariesToStorageJob.java\nindex a4f49e1f1..b3ca19b32 100644\n--- a/deposit/src/main/java/edu/unc/lib/deposit/transfer/TransferBinariesToStorageJob.java\n+++ b/deposit/src/main/java/edu/unc/lib/deposit/transfer/TransferBinariesToStorageJob.java\n\n@@ -77,7 +74,6 @@ public class TransferBinariesToStorageJob extends AbstractDepositJob {\n      */\n     public TransferBinariesToStorageJob(String uuid, String depositUUID) {\n         super(uuid, depositUUID);\n-        this.depositId = depositUUID + \":\" + TransferBinariesToStorageJob.class.getName();\n     }\n \n     @Override\n"}}, {"oid": "9bd40e652fb939e1cf4e9531f350f41e0c2a7416", "url": "https://github.com/UNC-Libraries/box-c/commit/9bd40e652fb939e1cf4e9531f350f41e0c2a7416", "message": "Add wrapper methods for \"object completed\" checks", "committedDate": "2020-06-18T13:08:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjI3NzkxMA==", "url": "https://github.com/UNC-Libraries/box-c/pull/1016#discussion_r442277910", "bodyText": "change binary to object since this isn't limited to binaries", "author": "bbpennel", "createdAt": "2020-06-18T14:38:51Z", "path": "metadata/src/main/java/edu/unc/lib/dl/util/JobStatusFactory.java", "diffHunk": "@@ -161,6 +163,31 @@ public void setTotalCompletion(String jobUUID, int totalClicks) {\n         }\n     }\n \n+    /**\n+     * Checks if a binary is already in the list of deposited objects for the current deposit", "originalCommit": "9bd40e652fb939e1cf4e9531f350f41e0c2a7416", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ce1ca73bd1ab0eeae71805f723695ebf558cc112", "chunk": "diff --git a/metadata/src/main/java/edu/unc/lib/dl/util/JobStatusFactory.java b/metadata/src/main/java/edu/unc/lib/dl/util/JobStatusFactory.java\nindex 3c2510e42..217539103 100644\n--- a/metadata/src/main/java/edu/unc/lib/dl/util/JobStatusFactory.java\n+++ b/metadata/src/main/java/edu/unc/lib/dl/util/JobStatusFactory.java\n\n@@ -164,7 +164,7 @@ public class JobStatusFactory {\n     }\n \n     /**\n-     * Checks if a binary is already in the list of deposited objects for the current deposit\n+     * Checks if an object is already in the list of deposited objects for the current deposit\n      *\n      * @param depositId Id of the current deposit\n      * @param objectId Id of the currently ingesting object\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjI3ODM1Nw==", "url": "https://github.com/UNC-Libraries/box-c/pull/1016#discussion_r442278357", "bodyText": "change ingested to completed here and for objectId", "author": "bbpennel", "createdAt": "2020-06-18T14:39:27Z", "path": "metadata/src/main/java/edu/unc/lib/dl/util/JobStatusFactory.java", "diffHunk": "@@ -161,6 +163,31 @@ public void setTotalCompletion(String jobUUID, int totalClicks) {\n         }\n     }\n \n+    /**\n+     * Checks if a binary is already in the list of deposited objects for the current deposit\n+     *\n+     * @param depositId Id of the current deposit\n+     * @param objectId Id of the currently ingesting object\n+     * @return boolean\n+     */\n+    public boolean objectIsCompleted(String depositId, String objectId) {\n+        try (Jedis jedis = getJedisPool().getResource()) {\n+            return jedis.sismember(JOB_COMPLETED_OBJECTS + depositId, objectId);\n+        }\n+    }\n+\n+    /**\n+     * A list of the values of the current deposit's objects that have been ingested", "originalCommit": "9bd40e652fb939e1cf4e9531f350f41e0c2a7416", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ce1ca73bd1ab0eeae71805f723695ebf558cc112", "chunk": "diff --git a/metadata/src/main/java/edu/unc/lib/dl/util/JobStatusFactory.java b/metadata/src/main/java/edu/unc/lib/dl/util/JobStatusFactory.java\nindex 3c2510e42..217539103 100644\n--- a/metadata/src/main/java/edu/unc/lib/dl/util/JobStatusFactory.java\n+++ b/metadata/src/main/java/edu/unc/lib/dl/util/JobStatusFactory.java\n\n@@ -164,7 +164,7 @@ public class JobStatusFactory {\n     }\n \n     /**\n-     * Checks if a binary is already in the list of deposited objects for the current deposit\n+     * Checks if an object is already in the list of deposited objects for the current deposit\n      *\n      * @param depositId Id of the current deposit\n      * @param objectId Id of the currently ingesting object\n"}}, {"oid": "ce1ca73bd1ab0eeae71805f723695ebf558cc112", "url": "https://github.com/UNC-Libraries/box-c/commit/ce1ca73bd1ab0eeae71805f723695ebf558cc112", "message": "Update javadoc", "committedDate": "2020-06-18T14:43:23Z", "type": "commit"}, {"oid": "93ba566215919976b031f0263574278e5d6d6b0a", "url": "https://github.com/UNC-Libraries/box-c/commit/93ba566215919976b031f0263574278e5d6d6b0a", "message": "Update javadoc", "committedDate": "2020-06-18T14:46:55Z", "type": "commit"}]}