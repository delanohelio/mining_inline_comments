{"pr_number": 1082, "pr_title": "Have DirectoryToBagJob produce works instead of folders", "pr_createdAt": "2020-08-21T17:03:51Z", "pr_url": "https://github.com/UNC-Libraries/box-c/pull/1082", "timeline": [{"oid": "c2c5a5b5f4bf313f4e306af9cfde44c8076faa20", "url": "https://github.com/UNC-Libraries/box-c/commit/c2c5a5b5f4bf313f4e306af9cfde44c8076faa20", "message": "Have DirectoryToBagJob produce works instead of folders", "committedDate": "2020-08-21T16:57:24Z", "type": "commit"}, {"oid": "cc25ad6882f7988a43479384e21316dcf1062ad6", "url": "https://github.com/UNC-Libraries/box-c/commit/cc25ad6882f7988a43479384e21316dcf1062ad6", "message": "Wrap files in work objects", "committedDate": "2020-08-25T19:23:00Z", "type": "commit"}, {"oid": "ccb2f610b77a25bb586af08572903d2a987282d9", "url": "https://github.com/UNC-Libraries/box-c/commit/ccb2f610b77a25bb586af08572903d2a987282d9", "message": "Add test to verify that nested directories work in directory deposit job", "committedDate": "2020-08-26T16:15:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzMxMzgzMA==", "url": "https://github.com/UNC-Libraries/box-c/pull/1082#discussion_r477313830", "bodyText": "Seems like you can undo this change since we don't want to generate DirectoryToBag deposits are being inside of one giant work", "author": "bbpennel", "createdAt": "2020-08-26T13:47:28Z", "path": "deposit/src/main/java/edu/unc/lib/deposit/normalize/AbstractFileServerToBagJob.java", "diffHunk": "@@ -68,31 +68,37 @@ public AbstractFileServerToBagJob(String uuid, String depositUUID) {\n     @Override\n     public abstract void runJob();\n \n-    protected Bag getSourceBag(Bag depositBag, File sourceFile) {\n+    protected Bag getSourceBag(Bag depositBag, File sourceFile, Resource objectType) {", "originalCommit": "cc25ad6882f7988a43479384e21316dcf1062ad6", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5317ffba43d4ebb54b844e17fa2587e3714d89d1", "chunk": "diff --git a/deposit/src/main/java/edu/unc/lib/deposit/normalize/AbstractFileServerToBagJob.java b/deposit/src/main/java/edu/unc/lib/deposit/normalize/AbstractFileServerToBagJob.java\nindex 8a388d3f5..67e365dcb 100644\n--- a/deposit/src/main/java/edu/unc/lib/deposit/normalize/AbstractFileServerToBagJob.java\n+++ b/deposit/src/main/java/edu/unc/lib/deposit/normalize/AbstractFileServerToBagJob.java\n\n@@ -68,37 +68,31 @@ public abstract class AbstractFileServerToBagJob extends AbstractDepositJob {\n     @Override\n     public abstract void runJob();\n \n-    protected Bag getSourceBag(Bag depositBag, File sourceFile, Resource objectType) {\n+    protected Bag getSourceBag(Bag depositBag, File sourceFile) {\n         Model model = depositBag.getModel();\n         Map<String, String> status = getDepositStatus();\n \n         PID containerPID = createPID();\n-        Bag bagContainer = model.createBag(containerPID.getURI());\n+        Bag bagFolder = model.createBag(containerPID.getURI());\n         // Determine the label to use for this the root directory of the deposit package\n-        String label = null;\n-\n-        if (!objectType.equals(Cdr.Work)) {\n-            label = status.get(DepositField.depositSlug.name());\n-        }\n-\n+        String label = status.get(DepositField.depositSlug.name());\n         if (label == null) {\n             label = status.get(DepositField.fileName.name());\n         }\n         if (label == null) {\n             label = sourceFile.getName();\n         }\n-\n-        model.add(bagContainer, CdrDeposit.label, label);\n-        model.add(bagContainer, RDF.type, objectType);\n-        depositBag.add(bagContainer);\n+        model.add(bagFolder, CdrDeposit.label, label);\n+        model.add(bagFolder, RDF.type, Cdr.Folder);\n+        depositBag.add(bagFolder);\n \n         // Cache the source bag folder\n-        pathToFolderBagCache.put(sourceFile.getName(), bagContainer);\n+        pathToFolderBagCache.put(sourceFile.getName(), bagFolder);\n \n         // Add extra descriptive information\n         addDescription(containerPID, status);\n \n-        return bagContainer;\n+        return bagFolder;\n     }\n \n     /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzM4ODY4MA==", "url": "https://github.com/UNC-Libraries/box-c/pull/1082#discussion_r477388680", "bodyText": "Hmm, this isn't the right outcome, there should be the same number of immediate children as before, the difference is the child should be a work, and that work should contain the file", "author": "bbpennel", "createdAt": "2020-08-26T15:26:00Z", "path": "deposit/src/test/java/edu/unc/lib/deposit/normalize/DirectoryToBagJobTest.java", "diffHunk": "@@ -120,10 +120,14 @@ public void testConversion() throws Exception {\n \n         Bag childrenBag = model.getBag(folder.getURI());\n \n-        assertEquals(1, childrenBag.size());", "originalCommit": "cc25ad6882f7988a43479384e21316dcf1062ad6", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "aa8b2e4421ebdee3716b3fb303835e5191e4ff8e", "chunk": "diff --git a/deposit/src/test/java/edu/unc/lib/deposit/normalize/DirectoryToBagJobTest.java b/deposit/src/test/java/edu/unc/lib/deposit/normalize/DirectoryToBagJobTest.java\nindex b74ecd9e4..bdcd73b92 100644\n--- a/deposit/src/test/java/edu/unc/lib/deposit/normalize/DirectoryToBagJobTest.java\n+++ b/deposit/src/test/java/edu/unc/lib/deposit/normalize/DirectoryToBagJobTest.java\n\n@@ -120,7 +120,7 @@ public class DirectoryToBagJobTest extends AbstractNormalizationJobTest {\n \n         Bag childrenBag = model.getBag(folder.getURI());\n \n-        assertEquals(2, childrenBag.size());\n+        assertEquals(1, childrenBag.size());\n \n         // Verify that file and its properties were added to work\n         Resource work = getChildByLabel(childrenBag, \"lorem.txt\");\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQyMTM1OA==", "url": "https://github.com/UNC-Libraries/box-c/pull/1082#discussion_r477421358", "bodyText": "This is just occurring to me now, but it'd make sense to refactor getFileResource to generate a work which wraps the file. That way it continues to be useful, the Bagit job also gets to benefit from this change, and you wouldn't have to make much (or any) changes to the behavior here.\nSo you would basically want to move all this work construction and wrapping into getFileResource, which should already correctly be handling adding to the right parent folder.", "author": "bbpennel", "createdAt": "2020-08-26T16:12:52Z", "path": "deposit/src/main/java/edu/unc/lib/deposit/normalize/DirectoryToBagJob.java", "diffHunk": "@@ -80,21 +81,32 @@ public void runJob() {\n \n             log.debug(\"Adding object {}: {}\", i++, file.getName());\n \n-            Boolean isDir = file.isDirectory();\n-\n             Path filePath = sourcePath.getParent().relativize(file.toPath());\n             String filePathString = filePath.toString();\n             String filename = filePath.getFileName().toString();\n+            Bag folderBag = getFolderBag(sourceBag, filePathString);\n+            model.add(folderBag, CdrDeposit.label, filename);\n+\n+            if (!file.isDirectory()) {\n+                // Create work object\n+                PID workPid = pidMinter.mintContentPid();\n+                Bag workBag = model.createBag(workPid.getURI());\n+                model.add(folderBag, RDF.type, Cdr.Work);\n+                model.add(folderBag, CdrDeposit.label, filename);\n \n-            if (!isDir) {\n-                Resource fileResource = getFileResource(sourceBag, filePathString);", "originalCommit": "cc25ad6882f7988a43479384e21316dcf1062ad6", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5317ffba43d4ebb54b844e17fa2587e3714d89d1", "chunk": "diff --git a/deposit/src/main/java/edu/unc/lib/deposit/normalize/DirectoryToBagJob.java b/deposit/src/main/java/edu/unc/lib/deposit/normalize/DirectoryToBagJob.java\nindex 57857d1de..1647e2c55 100644\n--- a/deposit/src/main/java/edu/unc/lib/deposit/normalize/DirectoryToBagJob.java\n+++ b/deposit/src/main/java/edu/unc/lib/deposit/normalize/DirectoryToBagJob.java\n\n@@ -88,24 +87,11 @@ public class DirectoryToBagJob extends AbstractFileServerToBagJob {\n             model.add(folderBag, CdrDeposit.label, filename);\n \n             if (!file.isDirectory()) {\n-                // Create work object\n-                PID workPid = pidMinter.mintContentPid();\n-                Bag workBag = model.createBag(workPid.getURI());\n-                model.add(folderBag, RDF.type, Cdr.Work);\n-                model.add(folderBag, CdrDeposit.label, filename);\n-\n-                // Add file object to work\n-                model.add(workBag, RDF.type, Cdr.FileObject);\n-                model.add(workBag, CdrDeposit.label, filename);\n+                Resource fileResource = getFileResource(sourceBag, filePathString);\n \n+                // Find staged path for the file\n                 Path storedPath = Paths.get(file.getAbsolutePath());\n-                model.add(workBag, CdrDeposit.stagingLocation, storedPath.toUri().toString());\n-\n-                Resource fileResource = getFileResource(folderBag, filePathString);\n-                workBag.add(fileResource);\n-                workBag.addProperty(Cdr.primaryObject, fileResource);\n-\n-                folderBag.add(workBag);\n+                model.add(fileResource, CdrDeposit.stagingLocation, storedPath.toUri().toString());\n             } else {\n                 model.add(folderBag, RDF.type, Cdr.Folder);\n             }\n"}}, {"oid": "5317ffba43d4ebb54b844e17fa2587e3714d89d1", "url": "https://github.com/UNC-Libraries/box-c/commit/5317ffba43d4ebb54b844e17fa2587e3714d89d1", "message": "Move file wrapping to getFileResource", "committedDate": "2020-08-26T20:14:40Z", "type": "commit"}, {"oid": "de995d8c47f28356fa02194b9abc2cd4a3fcfa58", "url": "https://github.com/UNC-Libraries/box-c/commit/de995d8c47f28356fa02194b9abc2cd4a3fcfa58", "message": "Merge branch 'dir-work' of https://github.com/UNC-Libraries/Carolina-Digital-Repository into dir-work", "committedDate": "2020-08-26T20:15:45Z", "type": "commit"}, {"oid": "aa8b2e4421ebdee3716b3fb303835e5191e4ff8e", "url": "https://github.com/UNC-Libraries/box-c/commit/aa8b2e4421ebdee3716b3fb303835e5191e4ff8e", "message": "* Fix tests\n* Revert DirectoryToBagJob", "committedDate": "2020-08-27T12:50:06Z", "type": "commit"}]}