{"pr_number": 601, "pr_title": "fix(telemetry): do no crash when TelemetryJob can't lock internal tables", "pr_createdAt": "2020-09-14T12:20:41Z", "pr_url": "https://github.com/questdb/questdb/pull/601", "timeline": [{"oid": "0b145529badb919b29eaf59c6491d05a28e4fe55", "url": "https://github.com/questdb/questdb/commit/0b145529badb919b29eaf59c6491d05a28e4fe55", "message": "fix(telemetry): do no crash when TelemetryJob can't lock internal tables", "committedDate": "2020-09-14T12:20:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzg4NDgzMQ==", "url": "https://github.com/questdb/questdb/pull/601#discussion_r487884831", "bodyText": "when you set enabled=false just return out of the method to avoid tripping over second table and also peppering the rest of the code with conditionals.\nWhen coming out of the method like that though ensure that all writers are released.\nFor example when first writer lock succeeds and second fails - first writer is never released.", "author": "bluestreak01", "createdAt": "2020-09-14T12:48:36Z", "path": "core/src/main/java/io/questdb/TelemetryJob.java", "diffHunk": "@@ -89,47 +89,50 @@ public TelemetryJob(CairoEngine engine, @Nullable FunctionFactoryCache functionF\n                 this.writer = new TableWriter(configuration, tableName);\n             } catch (CairoException ex) {\n                 LOG.error().$(\"could not open [table=\").utf8(tableName).$(\"]\").$();\n-                throw ex;\n+                enabled = false;", "originalCommit": "0b145529badb919b29eaf59c6491d05a28e4fe55", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzkwOTc3NA==", "url": "https://github.com/questdb/questdb/pull/601#discussion_r487909774", "bodyText": "\"return out of the method\"\n--> done\n\"For example when first writer lock succeeds and second fails - first writer is never released.\"\n--> this is not the case, the writer is released.", "author": "mpsq", "createdAt": "2020-09-14T13:25:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzg4NDgzMQ=="}], "type": "inlineReview", "revised_code": {"commit": "d7ae8b9535716d0a14f4edb775a81517a3680b88", "chunk": "diff --git a/core/src/main/java/io/questdb/TelemetryJob.java b/core/src/main/java/io/questdb/TelemetryJob.java\nindex d4102739d..4dc703252 100644\n--- a/core/src/main/java/io/questdb/TelemetryJob.java\n+++ b/core/src/main/java/io/questdb/TelemetryJob.java\n\n@@ -90,6 +89,7 @@ public class TelemetryJob extends SynchronizedJob implements Closeable {\n             } catch (CairoException ex) {\n                 LOG.error().$(\"could not open [table=\").utf8(tableName).$(\"]\").$();\n                 enabled = false;\n+                return;\n             }\n \n             // todo: close writerConfig. We currently keep it opened to prevent users from\n"}}, {"oid": "d7ae8b9535716d0a14f4edb775a81517a3680b88", "url": "https://github.com/questdb/questdb/commit/d7ae8b9535716d0a14f4edb775a81517a3680b88", "message": "chore: address comment", "committedDate": "2020-09-14T13:24:42Z", "type": "commit"}]}