{"pr_number": 303, "pr_title": "Security", "pr_createdAt": "2020-05-18T17:09:01Z", "pr_url": "https://github.com/questdb/questdb/pull/303", "timeline": [{"oid": "449b3ec3f11bb331019e7a76dc8bb12f08e88bfc", "url": "https://github.com/questdb/questdb/commit/449b3ec3f11bb331019e7a76dc8bb12f08e88bfc", "message": "feat(cairo): Security", "committedDate": "2020-05-18T17:04:45Z", "type": "commit"}, {"oid": "fcd406053116ffea1935b3bc4e06331b25cf2e82", "url": "https://github.com/questdb/questdb/commit/fcd406053116ffea1935b3bc4e06331b25cf2e82", "message": "feat(cairo): Security", "committedDate": "2020-05-18T17:05:54Z", "type": "commit"}, {"oid": "bc42575ca50be9ddda81d827b9395a85221718b4", "url": "https://github.com/questdb/questdb/commit/bc42575ca50be9ddda81d827b9395a85221718b4", "message": "feat(cairo): Security", "committedDate": "2020-05-18T17:05:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzE4ODIzOQ==", "url": "https://github.com/questdb/questdb/pull/303#discussion_r427188239", "bodyText": "static call looks a little strange here. I was expecting something like\nsecurityContext.checkWritePermission();", "author": "bluestreak01", "createdAt": "2020-05-19T10:12:47Z", "path": "core/src/main/java/io/questdb/cairo/CairoEngine.java", "diffHunk": "@@ -82,6 +83,7 @@ public void creatTable(\n             Path path,\n             TableStructure struct\n     ) {\n+        CairoSecurityContext.checkWritePermission(securityContext);", "originalCommit": "bc42575ca50be9ddda81d827b9395a85221718b4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8ab579355203499834a2c59a79d05d10da2f0dd3", "chunk": "diff --git a/core/src/main/java/io/questdb/cairo/CairoEngine.java b/core/src/main/java/io/questdb/cairo/CairoEngine.java\nindex add31ef23..50f956e1a 100644\n--- a/core/src/main/java/io/questdb/cairo/CairoEngine.java\n+++ b/core/src/main/java/io/questdb/cairo/CairoEngine.java\n\n@@ -83,7 +83,7 @@ public class CairoEngine implements Closeable {\n             Path path,\n             TableStructure struct\n     ) {\n-        CairoSecurityContext.checkWritePermission(securityContext);\n+        securityContext.checkWritePermission();\n         TableUtils.createTable(\n                 configuration.getFilesFacade(),\n                 mem,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzE5MDU4OQ==", "url": "https://github.com/questdb/questdb/pull/303#discussion_r427190589", "bodyText": "Generally speaking nothing in the codebase handles exceptions via Throwable. The rule of thumb when new exception is introduced a special consideration needs to be paid to how this exception is received by API users. This special consideration is missing from the PR.\nEasier way to deal with this is to reuse CairoException this is also a runtime exception and it is handled (and handling is tested)", "author": "bluestreak01", "createdAt": "2020-05-19T10:16:58Z", "path": "core/src/main/java/io/questdb/cairo/CairoSecurityContext.java", "diffHunk": "@@ -24,5 +24,15 @@\n \n package io.questdb.cairo;\n \n+import io.questdb.cairo.security.CairoSecurityException;\n+\n public interface CairoSecurityContext {\n+\n+    public static void checkWritePermission(CairoSecurityContext securityContext) {\n+        if (null == securityContext || !securityContext.canWrite()) {\n+            throw CairoSecurityException.instance().put(\"Write permission denied\");", "originalCommit": "bc42575ca50be9ddda81d827b9395a85221718b4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzIwMzM3OA==", "url": "https://github.com/questdb/questdb/pull/303#discussion_r427203378", "bodyText": "Yes, I can see how this breaks the GUI, I didn't notice that. I had originally used a CairoException but the problem with that is that SqlCompiler.alterTable catches CairoException and assumes its due to a failed table lock and then throws a SqlException which is wrong due to the incorrect assumption.\nIn my view I should be using a CairoException, but the behaviour of SqlCompiler.alterTable is wrong, we shouldn't be making assumptions on the reasons for exceptions", "author": "patrickSpaceSurfer", "createdAt": "2020-05-19T10:40:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzE5MDU4OQ=="}], "type": "inlineReview", "revised_code": {"commit": "8ab579355203499834a2c59a79d05d10da2f0dd3", "chunk": "diff --git a/core/src/main/java/io/questdb/cairo/CairoSecurityContext.java b/core/src/main/java/io/questdb/cairo/CairoSecurityContext.java\nindex 28b880062..da99b0c74 100644\n--- a/core/src/main/java/io/questdb/cairo/CairoSecurityContext.java\n+++ b/core/src/main/java/io/questdb/cairo/CairoSecurityContext.java\n\n@@ -28,8 +28,8 @@ import io.questdb.cairo.security.CairoSecurityException;\n \n public interface CairoSecurityContext {\n \n-    public static void checkWritePermission(CairoSecurityContext securityContext) {\n-        if (null == securityContext || !securityContext.canWrite()) {\n+    default void checkWritePermission() {\n+        if (!canWrite()) {\n             throw CairoSecurityException.instance().put(\"Write permission denied\");\n         }\n     }\n"}}, {"oid": "8ab579355203499834a2c59a79d05d10da2f0dd3", "url": "https://github.com/questdb/questdb/commit/8ab579355203499834a2c59a79d05d10da2f0dd3", "message": "feat(cairo): Security", "committedDate": "2020-05-19T10:31:34Z", "type": "commit"}, {"oid": "9a63361b1481e8e0f0b9348a178a28ac34880d87", "url": "https://github.com/questdb/questdb/commit/9a63361b1481e8e0f0b9348a178a28ac34880d87", "message": "feat(cairo): Security", "committedDate": "2020-05-19T11:09:36Z", "type": "commit"}]}