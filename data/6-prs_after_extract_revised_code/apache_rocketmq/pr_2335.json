{"pr_number": 2335, "pr_title": "[ISSUE #2334] Polish the log and response remark when service not available", "pr_createdAt": "2020-10-01T01:55:00Z", "pr_url": "https://github.com/apache/rocketmq/pull/2335", "timeline": [{"oid": "2b1ff553dc2bc33428499bff7311b5fc91debac4", "url": "https://github.com/apache/rocketmq/commit/2b1ff553dc2bc33428499bff7311b5fc91debac4", "message": "enhancement(response & log):polish the log and response remark when service not available", "committedDate": "2020-10-01T01:48:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjM4MzU3MA==", "url": "https://github.com/apache/rocketmq/pull/2335#discussion_r502383570", "bodyText": "Too many uncertain reasons can drive people crazy. You are advised to change them to \u201cyou could check...\u201d if not any diagnosis could be provided furtherly.", "author": "vongosling", "createdAt": "2020-10-09T12:11:11Z", "path": "broker/src/main/java/org/apache/rocketmq/broker/processor/ReplyMessageProcessor.java", "diffHunk": "@@ -263,7 +263,7 @@ private void handlePutMessageResult(PutMessageResult putMessageResult,\n                 break;\n             case SERVICE_NOT_AVAILABLE:\n                 log.info(\n-                    \"service not available now, maybe disk full, maybe your broker machine memory too small.\");\n+                    \"service not available now, maybe disk full, maybe put messages to slave, maybe message store shutdown, etc.\");", "originalCommit": "2b1ff553dc2bc33428499bff7311b5fc91debac4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "671edc05a0b267e77253facefabd7b511a4864b4", "chunk": "diff --git a/broker/src/main/java/org/apache/rocketmq/broker/processor/ReplyMessageProcessor.java b/broker/src/main/java/org/apache/rocketmq/broker/processor/ReplyMessageProcessor.java\nindex 0a50a914..2890fc4d 100644\n--- a/broker/src/main/java/org/apache/rocketmq/broker/processor/ReplyMessageProcessor.java\n+++ b/broker/src/main/java/org/apache/rocketmq/broker/processor/ReplyMessageProcessor.java\n\n@@ -251,28 +251,29 @@ public class ReplyMessageProcessor extends AbstractSendMessageProcessor implemen\n \n             // Failed\n             case CREATE_MAPEDFILE_FAILED:\n-                log.info(\"create mapped file failed, server is busy or broken.\");\n+                log.warn(\"create mapped file failed, server is busy or broken.\");\n                 break;\n             case MESSAGE_ILLEGAL:\n-                log.info(\n+                log.warn(\n                     \"the message is illegal, maybe msg properties length limit 32k.\");\n                 break;\n             case PROPERTIES_SIZE_EXCEEDED:\n-                log.info(\n+                log.warn(\n                     \"the message is illegal, maybe msg body or properties length not matched. msg body length limit 128k.\");\n                 break;\n             case SERVICE_NOT_AVAILABLE:\n-                log.info(\n-                    \"service not available now, maybe disk full, maybe put messages to slave, maybe message store shutdown, etc.\");\n+                log.warn(\n+                    \"service not available now. It may be caused by one of the following reasons: \" +\n+                        \"the broker's disk is full, messages are put to the slave, message store has been shut down, etc.\");\n                 break;\n             case OS_PAGECACHE_BUSY:\n-                log.info(\"[PC_SYNCHRONIZED]broker busy, start flow control for a while\");\n+                log.warn(\"[PC_SYNCHRONIZED]broker busy, start flow control for a while\");\n                 break;\n             case UNKNOWN_ERROR:\n-                log.info(\"UNKNOWN_ERROR\");\n+                log.warn(\"UNKNOWN_ERROR\");\n                 break;\n             default:\n-                log.info(\"UNKNOWN_ERROR DEFAULT\");\n+                log.warn(\"UNKNOWN_ERROR DEFAULT\");\n                 break;\n         }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjM4NDIzMg==", "url": "https://github.com/apache/rocketmq/pull/2335#discussion_r502384232", "bodyText": "IMO, maybe is not a strict customer advice.", "author": "vongosling", "createdAt": "2020-10-09T12:12:34Z", "path": "store/src/main/java/org/apache/rocketmq/store/DefaultMessageStore.java", "diffHunk": "@@ -392,15 +392,15 @@ private PutMessageStatus checkStoreStatus() {\n         if (BrokerRole.SLAVE == this.messageStoreConfig.getBrokerRole()) {\n             long value = this.printTimes.getAndIncrement();\n             if ((value % 50000) == 0) {\n-                log.warn(\"message store has shutdown, so putMessage is forbidden\");\n+                log.warn(\"broke role is slave, so putMessage is forbidden\");\n             }\n             return PutMessageStatus.SERVICE_NOT_AVAILABLE;\n         }\n \n         if (!this.runningFlags.isWriteable()) {\n             long value = this.printTimes.getAndIncrement();\n             if ((value % 50000) == 0) {\n-                log.warn(\"message store has shutdown, so putMessage is forbidden\");\n+                log.warn(\"message store could not write (may be disk full) so putMessage is forbidden\");", "originalCommit": "2b1ff553dc2bc33428499bff7311b5fc91debac4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "671edc05a0b267e77253facefabd7b511a4864b4", "chunk": "diff --git a/store/src/main/java/org/apache/rocketmq/store/DefaultMessageStore.java b/store/src/main/java/org/apache/rocketmq/store/DefaultMessageStore.java\nindex ea1f5d8e..89e2cc02 100644\n--- a/store/src/main/java/org/apache/rocketmq/store/DefaultMessageStore.java\n+++ b/store/src/main/java/org/apache/rocketmq/store/DefaultMessageStore.java\n\n@@ -400,7 +400,8 @@ public class DefaultMessageStore implements MessageStore {\n         if (!this.runningFlags.isWriteable()) {\n             long value = this.printTimes.getAndIncrement();\n             if ((value % 50000) == 0) {\n-                log.warn(\"message store could not write (may be disk full) so putMessage is forbidden\");\n+                log.warn(\"the message store is not writable. It may be caused by one of the following reasons: \" +\n+                    \"the broker's disk is full, write to logic queue error, write to index file error, etc\");\n             }\n             return PutMessageStatus.SERVICE_NOT_AVAILABLE;\n         } else {\n"}}, {"oid": "671edc05a0b267e77253facefabd7b511a4864b4", "url": "https://github.com/apache/rocketmq/commit/671edc05a0b267e77253facefabd7b511a4864b4", "message": "enhancement(response remark & log): make log and response remark better understand", "committedDate": "2020-10-10T14:47:14Z", "type": "commit"}, {"oid": "a07764fb785375ce970eaac8389be7b0f329d2f0", "url": "https://github.com/apache/rocketmq/commit/a07764fb785375ce970eaac8389be7b0f329d2f0", "message": "chore(style): modify code style to pass CI tests", "committedDate": "2020-10-10T14:52:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjk5MTUwNQ==", "url": "https://github.com/apache/rocketmq/pull/2335#discussion_r502991505", "bodyText": "Good catch", "author": "vongosling", "createdAt": "2020-10-12T00:56:23Z", "path": "broker/src/main/java/org/apache/rocketmq/broker/processor/ReplyMessageProcessor.java", "diffHunk": "@@ -251,28 +251,29 @@ private void handlePutMessageResult(PutMessageResult putMessageResult,\n \n             // Failed\n             case CREATE_MAPEDFILE_FAILED:\n-                log.info(\"create mapped file failed, server is busy or broken.\");\n+                log.warn(\"create mapped file failed, server is busy or broken.\");", "originalCommit": "a07764fb785375ce970eaac8389be7b0f329d2f0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}