{"pr_number": 1758, "pr_title": "[ISSUE #1751]Fix bug in MessageClientIDSetter", "pr_createdAt": "2020-02-03T13:28:28Z", "pr_url": "https://github.com/apache/rocketmq/pull/1758", "timeline": [{"oid": "0955fcc7805cb94bee0706e5bde0655181688082", "url": "https://github.com/apache/rocketmq/commit/0955fcc7805cb94bee0706e5bde0655181688082", "message": "pid 4bytes", "committedDate": "2020-01-30T10:36:51Z", "type": "commit"}, {"oid": "ce0c14c18322462cf0a74194357d6bedc9593e22", "url": "https://github.com/apache/rocketmq/commit/ce0c14c18322462cf0a74194357d6bedc9593e22", "message": "pid is 4 bytes", "committedDate": "2020-02-02T04:07:13Z", "type": "commit"}, {"oid": "4fb7710f7773fdd184b2a3be96f71be5a4a5fb7b", "url": "https://github.com/apache/rocketmq/commit/4fb7710f7773fdd184b2a3be96f71be5a4a5fb7b", "message": "#1751 fix bug and add a unit test", "committedDate": "2020-02-03T13:20:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODAyNjIyMw==", "url": "https://github.com/apache/rocketmq/pull/1758#discussion_r378026223", "bodyText": "pid is short\uff0cso maybe putShort can resolve this issue\uff0cand this indeed a bug, ip.length + 2 will remove the lower 2 bytes.", "author": "duhenglucky", "createdAt": "2020-02-12T03:41:21Z", "path": "common/src/main/java/org/apache/rocketmq/common/message/MessageClientIDSetter.java", "diffHunk": "@@ -37,13 +37,10 @@\n         } catch (Exception e) {\n             ip = createFakeIP();\n         }\n-        LEN = ip.length + 2 + 4 + 4 + 2;\n-        ByteBuffer tempBuffer = ByteBuffer.allocate(ip.length + 2 + 4);\n-        tempBuffer.position(0);\n+        LEN = ip.length + 4 + 4 + 4 + 2;\n+        ByteBuffer tempBuffer = ByteBuffer.allocate(ip.length + 4 + 4);\n         tempBuffer.put(ip);\n-        tempBuffer.position(ip.length);\n         tempBuffer.putInt(UtilAll.getPid());\n-        tempBuffer.position(ip.length + 2);", "originalCommit": "4fb7710f7773fdd184b2a3be96f71be5a4a5fb7b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA0NzM3Ng==", "url": "https://github.com/apache/rocketmq/pull/1758#discussion_r378047376", "bodyText": "https://unix.stackexchange.com/questions/16883/what-is-the-maximum-value-of-the-process-id", "author": "rushsky518", "createdAt": "2020-02-12T05:31:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODAyNjIyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA0ODYxMA==", "url": "https://github.com/apache/rocketmq/pull/1758#discussion_r378048610", "bodyText": "issue is here\uff1a#1751", "author": "rushsky518", "createdAt": "2020-02-12T05:37:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODAyNjIyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA1MTEwMQ==", "url": "https://github.com/apache/rocketmq/pull/1758#discussion_r378051101", "bodyText": "and there are 2 methods\n\"org.apache.rocketmq.common.MixAll#getPID\"\n\"org.apache.rocketmq.common.UtilAll#getPid\"", "author": "rushsky518", "createdAt": "2020-02-12T05:48:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODAyNjIyMw=="}], "type": "inlineReview", "revised_code": {"commit": "81a19560cd0491924c3d1b47c01003d7a455f0da", "chunk": "diff --git a/common/src/main/java/org/apache/rocketmq/common/message/MessageClientIDSetter.java b/common/src/main/java/org/apache/rocketmq/common/message/MessageClientIDSetter.java\nindex 58040970..4568d519 100644\n--- a/common/src/main/java/org/apache/rocketmq/common/message/MessageClientIDSetter.java\n+++ b/common/src/main/java/org/apache/rocketmq/common/message/MessageClientIDSetter.java\n\n@@ -37,10 +37,10 @@ public class MessageClientIDSetter {\n         } catch (Exception e) {\n             ip = createFakeIP();\n         }\n-        LEN = ip.length + 4 + 4 + 4 + 2;\n-        ByteBuffer tempBuffer = ByteBuffer.allocate(ip.length + 4 + 4);\n+        LEN = ip.length + 2 + 4 + 4 + 2;\n+        ByteBuffer tempBuffer = ByteBuffer.allocate(ip.length + 2 + 4);\n         tempBuffer.put(ip);\n-        tempBuffer.putInt(UtilAll.getPid());\n+        tempBuffer.putShort(UtilAll.getPid());\n         tempBuffer.putInt(MessageClientIDSetter.class.getClassLoader().hashCode());\n         FIX_STRING = UtilAll.bytes2string(tempBuffer.array());\n         setStartTime(System.currentTimeMillis());\n"}}, {"oid": "81a19560cd0491924c3d1b47c01003d7a455f0da", "url": "https://github.com/apache/rocketmq/commit/81a19560cd0491924c3d1b47c01003d7a455f0da", "message": "#1751 short pid", "committedDate": "2020-02-12T05:33:29Z", "type": "commit"}, {"oid": "9385825c0edbadb8d4130f39820a91488dd3ff08", "url": "https://github.com/apache/rocketmq/commit/9385825c0edbadb8d4130f39820a91488dd3ff08", "message": "\u4fdd\u6301\u539f\u6765", "committedDate": "2020-02-12T06:08:44Z", "type": "commit"}, {"oid": "5de8764b58f80ce1c3c957852ddad30a747da78a", "url": "https://github.com/apache/rocketmq/commit/5de8764b58f80ce1c3c957852ddad30a747da78a", "message": "#1751 remove repeat code", "committedDate": "2020-02-12T07:17:26Z", "type": "commit"}]}