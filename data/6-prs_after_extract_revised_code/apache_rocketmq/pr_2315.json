{"pr_number": 2315, "pr_title": "[ISSUE #2219]  Add some asynchronous API for batch messages", "pr_createdAt": "2020-09-20T15:31:55Z", "pr_url": "https://github.com/apache/rocketmq/pull/2315", "timeline": [{"oid": "89a78c7ed82dabc18918d4c4db10f4a50158e17b", "url": "https://github.com/apache/rocketmq/commit/89a78c7ed82dabc18918d4c4db10f4a50158e17b", "message": "[ISSUE #2219] Add asynchronous batch send method.", "committedDate": "2020-09-20T15:28:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTg2OTQ5NA==", "url": "https://github.com/apache/rocketmq/pull/2315#discussion_r491869494", "bodyText": "I have a question, here you can add another test case to coverage the case which send message successfully based on the specified message queue.", "author": "zongtanghu", "createdAt": "2020-09-21T08:29:09Z", "path": "client/src/test/java/org/apache/rocketmq/client/producer/DefaultMQProducerTest.java", "diffHunk": "@@ -232,6 +232,49 @@ public MessageQueue select(List<MessageQueue> mqs, Message msg, Object arg) {\n         countDownLatch.await(3000L, TimeUnit.MILLISECONDS);\n         assertThat(cc.get()).isEqualTo(5);\n     }\n+    \n+    @Test\n+    public void testBatchSendMessageAsync()\n+            throws RemotingException, MQClientException, InterruptedException, MQBrokerException {\n+        final AtomicInteger cc = new AtomicInteger(0);\n+        final CountDownLatch countDownLatch = new CountDownLatch(4);\n+\n+        when(mQClientAPIImpl.getTopicRouteInfoFromNameServer(anyString(), anyLong())).thenReturn(createTopicRoute());\n+        SendCallback sendCallback = new SendCallback() {\n+            @Override\n+            public void onSuccess(SendResult sendResult) {\n+                countDownLatch.countDown();\n+            }\n+\n+            @Override\n+            public void onException(Throwable e) {\n+                e.printStackTrace();\n+                cc.incrementAndGet();\n+                countDownLatch.countDown();\n+            }\n+        };\n+        MessageQueueSelector messageQueueSelector = new MessageQueueSelector() {\n+            @Override\n+            public MessageQueue select(List<MessageQueue> mqs, Message msg, Object arg) {\n+                return null;\n+            }\n+        };\n+\n+        List<Message> msgs = new ArrayList<>();\n+        for (int i = 0; i < 5; i++) {\n+            Message message = new Message();\n+            message.setTopic(\"test\");\n+            message.setBody((\"hello world\" + i).getBytes());\n+            msgs.add(message);\n+        }\n+        producer.send(msgs, sendCallback);\n+        producer.send(msgs, sendCallback, 1000);\n+        producer.send(msgs, new MessageQueue(), sendCallback);\n+        producer.send(msgs, new MessageQueue(), sendCallback, 1000);", "originalCommit": "89a78c7ed82dabc18918d4c4db10f4a50158e17b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f4cc1403bf719e0066b0f4ed9317b5f6a8e3dc1f", "chunk": "diff --git a/client/src/test/java/org/apache/rocketmq/client/producer/DefaultMQProducerTest.java b/client/src/test/java/org/apache/rocketmq/client/producer/DefaultMQProducerTest.java\nindex 78b503aa..e1771b96 100644\n--- a/client/src/test/java/org/apache/rocketmq/client/producer/DefaultMQProducerTest.java\n+++ b/client/src/test/java/org/apache/rocketmq/client/producer/DefaultMQProducerTest.java\n\n@@ -269,11 +269,13 @@ public class DefaultMQProducerTest {\n         }\n         producer.send(msgs, sendCallback);\n         producer.send(msgs, sendCallback, 1000);\n-        producer.send(msgs, new MessageQueue(), sendCallback);\n+        MessageQueue mq = new MessageQueue(\"test\", \"BrokerA\", 1);\n+        producer.send(msgs, mq, sendCallback);\n+        // this message is send failed\n         producer.send(msgs, new MessageQueue(), sendCallback, 1000);\n \n         countDownLatch.await(3000L, TimeUnit.MILLISECONDS);\n-        assertThat(cc.get()).isEqualTo(2);\n+        assertThat(cc.get()).isEqualTo(1);\n     }\n \n     @Test\n"}}, {"oid": "f4cc1403bf719e0066b0f4ed9317b5f6a8e3dc1f", "url": "https://github.com/apache/rocketmq/commit/f4cc1403bf719e0066b0f4ed9317b5f6a8e3dc1f", "message": "modify the ut", "committedDate": "2020-09-21T09:33:40Z", "type": "commit"}]}