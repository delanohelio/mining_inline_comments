{"pr_number": 2347, "pr_title": "Fixed CargoNetworkTask not checking for other slots before dropping i\u2026", "pr_createdAt": "2020-09-26T14:51:39Z", "pr_url": "https://github.com/Slimefun/Slimefun4/pull/2347", "timeline": [{"oid": "4d49e1ec8fc41e47b1d173ff51b985bd84268d94", "url": "https://github.com/Slimefun/Slimefun4/commit/4d49e1ec8fc41e47b1d173ff51b985bd84268d94", "message": "Fixed CargoNetworkTask not checking for other slots before dropping items on ground", "committedDate": "2020-09-26T14:39:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ2NDQ3Nw==", "url": "https://github.com/Slimefun/Slimefun4/pull/2347#discussion_r495464477", "bodyText": "This could lead to an IndexOutOfBoundsException. So doing .isEmpty() on the returned map instead would be much safer.", "author": "TheBusyBiscuit", "createdAt": "2020-09-26T14:56:08Z", "path": "src/main/java/io/github/thebusybiscuit/slimefun4/core/networks/cargo/CargoNetworkTask.java", "diffHunk": "@@ -111,7 +111,8 @@ private void routeItems(Location inputNode, Block inputTarget, int frequency, Ma\n                 if (inv.getItem(previousSlot) == null) {\n                     inv.setItem(previousSlot, stack);\n                 }\n-                else {\n+                // Making sure the item cannot be added to another slot before dropping it on ground\n+                else if((stack = inv.addItem(stack).get(0)) != null){", "originalCommit": "4d49e1ec8fc41e47b1d173ff51b985bd84268d94", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ2NTE4MQ==", "url": "https://github.com/Slimefun/Slimefun4/pull/2347#discussion_r495465181", "bodyText": "You are wrong, that's a Map, not a List. Therefore, running Map#get(0) will return null if everything was fine, not an IndexOutOfBoundsException", "author": "OmerBenGera", "createdAt": "2020-09-26T15:04:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ2NDQ3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ2NTQ3NQ==", "url": "https://github.com/Slimefun/Slimefun4/pull/2347#discussion_r495465475", "bodyText": "I even wrote Map but yeah I thought of a Collection, still could be simplified to .isEmpty() nonetheless", "author": "TheBusyBiscuit", "createdAt": "2020-09-26T15:07:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ2NDQ3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ2NTc5MA==", "url": "https://github.com/Slimefun/Slimefun4/pull/2347#discussion_r495465790", "bodyText": "I even wrote Map but yeah I thought of a Collection, still could be simplified to .isEmpty() nonetheless\n\nIt will just make the code longer, this version works fine and can be easily understood", "author": "OmerBenGera", "createdAt": "2020-09-26T15:11:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ2NDQ3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ2NTkyOQ==", "url": "https://github.com/Slimefun/Slimefun4/pull/2347#discussion_r495465929", "bodyText": "I think the opposite is true.\nDoing isEmpty() would be significantly shorter and much easier to read than an assignment and a null check.", "author": "TheBusyBiscuit", "createdAt": "2020-09-26T15:12:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ2NDQ3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ2NjA2NQ==", "url": "https://github.com/Slimefun/Slimefun4/pull/2347#discussion_r495466065", "bodyText": "I think the opposite is true.\nDoing isEmpty() would be significantly shorter and much easier to read than an assignment and a null check.\n\nI will change it if I have the time...", "author": "OmerBenGera", "createdAt": "2020-09-26T15:14:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ2NDQ3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ2NjMwMw==", "url": "https://github.com/Slimefun/Slimefun4/pull/2347#discussion_r495466303", "bodyText": "Lemme change it to a \"suggested code change\" then you only need to hit apply.", "author": "TheBusyBiscuit", "createdAt": "2020-09-26T15:16:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ2NDQ3Nw=="}], "type": "inlineReview", "revised_code": {"commit": "75da0b883a576ab41c9c2829950a91187c6c549f", "chunk": "diff --git a/src/main/java/io/github/thebusybiscuit/slimefun4/core/networks/cargo/CargoNetworkTask.java b/src/main/java/io/github/thebusybiscuit/slimefun4/core/networks/cargo/CargoNetworkTask.java\nindex 85b1ce474..7ac5912ed 100644\n--- a/src/main/java/io/github/thebusybiscuit/slimefun4/core/networks/cargo/CargoNetworkTask.java\n+++ b/src/main/java/io/github/thebusybiscuit/slimefun4/core/networks/cargo/CargoNetworkTask.java\n\n@@ -108,12 +108,18 @@ class CargoNetworkTask implements Runnable {\n             Inventory inv = inventories.get(inputTarget.getLocation());\n \n             if (inv != null) {\n+                // Check if the original slot hasn't been occupied in the meantime\n                 if (inv.getItem(previousSlot) == null) {\n                     inv.setItem(previousSlot, stack);\n                 }\n-                // Making sure the item cannot be added to another slot before dropping it on ground\n-                else if((stack = inv.addItem(stack).get(0)) != null){\n-                    inputTarget.getWorld().dropItem(inputTarget.getLocation().add(0, 1, 0), stack);\n+                else {\n+                    // Try to add the item into another available slot then\n+                    ItemStack rest = inv.addItem(stack).get(0);\n+                    \n+                    if (rest != null) {\n+                        // If the item still couldn't be inserted, simply drop it on the ground\n+                        inputTarget.getWorld().dropItem(inputTarget.getLocation().add(0, 1, 0), rest);\n+                    }\n                 }\n             }\n             else {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ2NDU5OA==", "url": "https://github.com/Slimefun/Slimefun4/pull/2347#discussion_r495464598", "bodyText": "nitpick: Space after if and after the ending closing bracket", "author": "WalshyDev", "createdAt": "2020-09-26T14:57:34Z", "path": "src/main/java/io/github/thebusybiscuit/slimefun4/core/networks/cargo/CargoNetworkTask.java", "diffHunk": "@@ -111,7 +111,8 @@ private void routeItems(Location inputNode, Block inputTarget, int frequency, Ma\n                 if (inv.getItem(previousSlot) == null) {\n                     inv.setItem(previousSlot, stack);\n                 }\n-                else {\n+                // Making sure the item cannot be added to another slot before dropping it on ground\n+                else if((stack = inv.addItem(stack).get(0)) != null){", "originalCommit": "4d49e1ec8fc41e47b1d173ff51b985bd84268d94", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "75da0b883a576ab41c9c2829950a91187c6c549f", "chunk": "diff --git a/src/main/java/io/github/thebusybiscuit/slimefun4/core/networks/cargo/CargoNetworkTask.java b/src/main/java/io/github/thebusybiscuit/slimefun4/core/networks/cargo/CargoNetworkTask.java\nindex 85b1ce474..7ac5912ed 100644\n--- a/src/main/java/io/github/thebusybiscuit/slimefun4/core/networks/cargo/CargoNetworkTask.java\n+++ b/src/main/java/io/github/thebusybiscuit/slimefun4/core/networks/cargo/CargoNetworkTask.java\n\n@@ -108,12 +108,18 @@ class CargoNetworkTask implements Runnable {\n             Inventory inv = inventories.get(inputTarget.getLocation());\n \n             if (inv != null) {\n+                // Check if the original slot hasn't been occupied in the meantime\n                 if (inv.getItem(previousSlot) == null) {\n                     inv.setItem(previousSlot, stack);\n                 }\n-                // Making sure the item cannot be added to another slot before dropping it on ground\n-                else if((stack = inv.addItem(stack).get(0)) != null){\n-                    inputTarget.getWorld().dropItem(inputTarget.getLocation().add(0, 1, 0), stack);\n+                else {\n+                    // Try to add the item into another available slot then\n+                    ItemStack rest = inv.addItem(stack).get(0);\n+                    \n+                    if (rest != null) {\n+                        // If the item still couldn't be inserted, simply drop it on the ground\n+                        inputTarget.getWorld().dropItem(inputTarget.getLocation().add(0, 1, 0), rest);\n+                    }\n                 }\n             }\n             else {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ2NjM5MQ==", "url": "https://github.com/Slimefun/Slimefun4/pull/2347#discussion_r495466391", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            else if((stack = inv.addItem(stack).get(0)) != null){\n          \n          \n            \n                            else if (!inv.addItem(stack).isEmpty()) {", "author": "TheBusyBiscuit", "createdAt": "2020-09-26T15:18:08Z", "path": "src/main/java/io/github/thebusybiscuit/slimefun4/core/networks/cargo/CargoNetworkTask.java", "diffHunk": "@@ -111,7 +111,8 @@ private void routeItems(Location inputNode, Block inputTarget, int frequency, Ma\n                 if (inv.getItem(previousSlot) == null) {\n                     inv.setItem(previousSlot, stack);\n                 }\n-                else {\n+                // Making sure the item cannot be added to another slot before dropping it on ground\n+                else if((stack = inv.addItem(stack).get(0)) != null){", "originalCommit": "4d49e1ec8fc41e47b1d173ff51b985bd84268d94", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ2Njg5MQ==", "url": "https://github.com/Slimefun/Slimefun4/pull/2347#discussion_r495466891", "bodyText": "This will lead to duplication. Let's say some of the items were deposited into the source inventory, you are ignoring the leftovers and you deposit the old item, which will result in a possible duplication (some were deposited to the source already, and you drop the original one on ground)", "author": "OmerBenGera", "createdAt": "2020-09-26T15:23:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ2NjM5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ2NzMzMg==", "url": "https://github.com/Slimefun/Slimefun4/pull/2347#discussion_r495467332", "bodyText": "Oh you are right. Yeah, in that case your solution would be better.\nI think I really need a break or some sleep o_O", "author": "TheBusyBiscuit", "createdAt": "2020-09-26T15:27:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ2NjM5MQ=="}], "type": "inlineReview", "revised_code": {"commit": "75da0b883a576ab41c9c2829950a91187c6c549f", "chunk": "diff --git a/src/main/java/io/github/thebusybiscuit/slimefun4/core/networks/cargo/CargoNetworkTask.java b/src/main/java/io/github/thebusybiscuit/slimefun4/core/networks/cargo/CargoNetworkTask.java\nindex 85b1ce474..7ac5912ed 100644\n--- a/src/main/java/io/github/thebusybiscuit/slimefun4/core/networks/cargo/CargoNetworkTask.java\n+++ b/src/main/java/io/github/thebusybiscuit/slimefun4/core/networks/cargo/CargoNetworkTask.java\n\n@@ -108,12 +108,18 @@ class CargoNetworkTask implements Runnable {\n             Inventory inv = inventories.get(inputTarget.getLocation());\n \n             if (inv != null) {\n+                // Check if the original slot hasn't been occupied in the meantime\n                 if (inv.getItem(previousSlot) == null) {\n                     inv.setItem(previousSlot, stack);\n                 }\n-                // Making sure the item cannot be added to another slot before dropping it on ground\n-                else if((stack = inv.addItem(stack).get(0)) != null){\n-                    inputTarget.getWorld().dropItem(inputTarget.getLocation().add(0, 1, 0), stack);\n+                else {\n+                    // Try to add the item into another available slot then\n+                    ItemStack rest = inv.addItem(stack).get(0);\n+                    \n+                    if (rest != null) {\n+                        // If the item still couldn't be inserted, simply drop it on the ground\n+                        inputTarget.getWorld().dropItem(inputTarget.getLocation().add(0, 1, 0), rest);\n+                    }\n                 }\n             }\n             else {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ3MDU3Nw==", "url": "https://github.com/Slimefun/Slimefun4/pull/2347#discussion_r495470577", "bodyText": "I think this is a bit messy. Maybe create a variable of inv.addItem().get() and then check if it's null. I don't quite understand how checking if the inventory is empty can duplicate the item though.", "author": "LinoxGH", "createdAt": "2020-09-26T16:04:50Z", "path": "src/main/java/io/github/thebusybiscuit/slimefun4/core/networks/cargo/CargoNetworkTask.java", "diffHunk": "@@ -111,7 +111,8 @@ private void routeItems(Location inputNode, Block inputTarget, int frequency, Ma\n                 if (inv.getItem(previousSlot) == null) {\n                     inv.setItem(previousSlot, stack);\n                 }\n-                else {\n+                // Making sure the item cannot be added to another slot before dropping it on ground\n+                else if((stack = inv.addItem(stack).get(0)) != null){", "originalCommit": "4d49e1ec8fc41e47b1d173ff51b985bd84268d94", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ3MTkzMw==", "url": "https://github.com/Slimefun/Slimefun4/pull/2347#discussion_r495471933", "bodyText": "I think this is a bit messy. Maybe create a variable of inv.addItem().get() and then check if it's null. I don't quite understand how checking if the inventory is empty can duplicate the item though.\n\naddItem is adding the item, and returns the results. If it tried to add 64 of an item, but only 28 of it could be added, it would return the item with an amount of 36. If you only check if it's empty, and you drop the original item (the 64 one), you drop 64, however 28 were already deposited. Aka, the items was duped.\nInstead of checking why the PR is not good, just accept it lmao\nIt's such a simple additional, I don't understand why you keep refusing to accept it", "author": "OmerBenGera", "createdAt": "2020-09-26T16:18:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ3MDU3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ3MjQzMw==", "url": "https://github.com/Slimefun/Slimefun4/pull/2347#discussion_r495472433", "bodyText": "We aren't checking whether the PR is good, we are doing code reviews to ensure changes won't break anything.\nThere is always a bias with the person who wrote the changes so we require 2 approving reviews from maintainers to ensure nothing goes unnoticed.\nEspecially in such a messy area of the codebase there really isn't anything like a \"simple addition\".\nI agree today's reviews didnt go as usual, but its still important to review changes before merging and to ask questions and get a better understanding of the situation.", "author": "TheBusyBiscuit", "createdAt": "2020-09-26T16:24:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ3MDU3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ3MjQzNA==", "url": "https://github.com/Slimefun/Slimefun4/pull/2347#discussion_r495472434", "bodyText": "Because it's still hard to read. Can't you separate it into a couple lines. Like 1 for the variable and other checking if that variable is null. Just add spaces around the brackets and instead of assigning the variable inside if statement, assign it in an upper line.", "author": "LinoxGH", "createdAt": "2020-09-26T16:24:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ3MDU3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ3MjY0Mg==", "url": "https://github.com/Slimefun/Slimefun4/pull/2347#discussion_r495472642", "bodyText": "Because it's still hard to read. Can't you separate it into a couple lines. Like 1 for the variable and other checking if that variable is null. Just add spaces around the brackets and instead of assigning the variable inside if statement, assign it in an upper line.\n\nit makes no sense to separate the lines. If you really want to separate them, go for it.\nYou are only looking for reasons why to not accept a literally cleaned and working code", "author": "OmerBenGera", "createdAt": "2020-09-26T16:26:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ3MDU3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ3Mjk1Nw==", "url": "https://github.com/Slimefun/Slimefun4/pull/2347#discussion_r495472957", "bodyText": "Because it's still hard to read. Can't you separate it into a couple lines. Like 1 for the variable and other checking if that variable is null. Just add spaces around the brackets and instead of assigning the variable inside if statement, assign it in an upper line.\n\nit makes no sense to separate the lines. If you really want to separate them, go for it.\nYou are only looking for reasons why to not accept a literally cleaned and working code\n\nAnd you are now looking for ways to start a fight. In nowhere of sf code, it was used. Your code does not follow the code standards of this repo. All changes we have asked for can easily be done even on github website and on mobile. You could have done them already while writing all these comments.", "author": "LinoxGH", "createdAt": "2020-09-26T16:30:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ3MDU3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ3MzIyNQ==", "url": "https://github.com/Slimefun/Slimefun4/pull/2347#discussion_r495473225", "bodyText": "No need to fight, both of you. Mistakes have been made here by multiple people. Formatting and docs can always be improved further. But no need to drag this on even longer.", "author": "TheBusyBiscuit", "createdAt": "2020-09-26T16:33:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ3MDU3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ3MzMzMw==", "url": "https://github.com/Slimefun/Slimefun4/pull/2347#discussion_r495473333", "bodyText": "I am not starting a fight. I don't see a point in changing it, and if you really want to do that - go for it.\nI don't know what are your coding rules, and I am 100% sure that if I change it you'll have complaints again.\nI am not gonna continue this pointless discussion. If you want to change it, do it. If not, then fine - the code is good like this.\nAnd as you said, \"All changes we have asked for can easily be done even on github website and on mobile. You could have done them already while writing all these comments.\" - then just do the changes instead of wasting my time.", "author": "OmerBenGera", "createdAt": "2020-09-26T16:34:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ3MDU3Nw=="}], "type": "inlineReview", "revised_code": {"commit": "75da0b883a576ab41c9c2829950a91187c6c549f", "chunk": "diff --git a/src/main/java/io/github/thebusybiscuit/slimefun4/core/networks/cargo/CargoNetworkTask.java b/src/main/java/io/github/thebusybiscuit/slimefun4/core/networks/cargo/CargoNetworkTask.java\nindex 85b1ce474..7ac5912ed 100644\n--- a/src/main/java/io/github/thebusybiscuit/slimefun4/core/networks/cargo/CargoNetworkTask.java\n+++ b/src/main/java/io/github/thebusybiscuit/slimefun4/core/networks/cargo/CargoNetworkTask.java\n\n@@ -108,12 +108,18 @@ class CargoNetworkTask implements Runnable {\n             Inventory inv = inventories.get(inputTarget.getLocation());\n \n             if (inv != null) {\n+                // Check if the original slot hasn't been occupied in the meantime\n                 if (inv.getItem(previousSlot) == null) {\n                     inv.setItem(previousSlot, stack);\n                 }\n-                // Making sure the item cannot be added to another slot before dropping it on ground\n-                else if((stack = inv.addItem(stack).get(0)) != null){\n-                    inputTarget.getWorld().dropItem(inputTarget.getLocation().add(0, 1, 0), stack);\n+                else {\n+                    // Try to add the item into another available slot then\n+                    ItemStack rest = inv.addItem(stack).get(0);\n+                    \n+                    if (rest != null) {\n+                        // If the item still couldn't be inserted, simply drop it on the ground\n+                        inputTarget.getWorld().dropItem(inputTarget.getLocation().add(0, 1, 0), rest);\n+                    }\n                 }\n             }\n             else {\n"}}, {"oid": "75da0b883a576ab41c9c2829950a91187c6c549f", "url": "https://github.com/Slimefun/Slimefun4/commit/75da0b883a576ab41c9c2829950a91187c6c549f", "message": "Refactored code", "committedDate": "2020-09-26T20:05:47Z", "type": "commit"}]}