{"pr_number": 2367, "pr_title": "Missing TERMINATED transition in UnicastManySinkNoBackpressure", "pr_createdAt": "2020-09-09T13:42:26Z", "pr_url": "https://github.com/reactor/reactor-core/pull/2367", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTYyMjYxMw==", "url": "https://github.com/reactor/reactor-core/pull/2367#discussion_r485622613", "bodyText": "WDYT about changing it to for (...) to avoid the recursion (== longer stacktrace)?", "author": "bsideup", "createdAt": "2020-09-09T13:44:24Z", "path": "reactor-core/src/main/java/reactor/core/publisher/UnicastManySinkNoBackpressure.java", "diffHunk": "@@ -182,18 +216,31 @@ public void emitComplete() {\n \tpublic Emission tryEmitComplete() {\n \t\tswitch (state) {\n \t\t\tcase INITIAL:\n-\t\t\t\t// TODO different Emission?\n-\t\t\t\treturn Emission.OK;\n+\t\t\t\tif (STATE.compareAndSet(this, State.INITIAL, State.TERMINATED_BEFORE_SUBSCRIPTION)) {\n+\t\t\t\t\treturn Emission.OK;\n+\t\t\t\t}\n+\t\t\t\telse {\n+\t\t\t\t\t//recurse", "originalCommit": "f43e1515a1a1098f24cef01daa373417aebda7e8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTcyMTUxMA==", "url": "https://github.com/reactor/reactor-core/pull/2367#discussion_r485721510", "bodyText": "done", "author": "simonbasle", "createdAt": "2020-09-09T15:54:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTYyMjYxMw=="}], "type": "inlineReview", "revised_code": {"commit": "5bbec1fc471f125520e2be2547e02d6d673c81f6", "chunk": "diff --git a/reactor-core/src/main/java/reactor/core/publisher/UnicastManySinkNoBackpressure.java b/reactor-core/src/main/java/reactor/core/publisher/UnicastManySinkNoBackpressure.java\nindex 205664acc..8d64028fb 100644\n--- a/reactor-core/src/main/java/reactor/core/publisher/UnicastManySinkNoBackpressure.java\n+++ b/reactor-core/src/main/java/reactor/core/publisher/UnicastManySinkNoBackpressure.java\n\n@@ -214,33 +182,25 @@ final class UnicastManySinkNoBackpressure<T> extends Flux<T> implements Sinks.Ma\n \n \t@Override\n \tpublic Emission tryEmitComplete() {\n-\t\tswitch (state) {\n-\t\t\tcase INITIAL:\n-\t\t\t\tif (STATE.compareAndSet(this, State.INITIAL, State.TERMINATED_BEFORE_SUBSCRIPTION)) {\n-\t\t\t\t\treturn Emission.OK;\n-\t\t\t\t}\n-\t\t\t\telse {\n-\t\t\t\t\t//recurse\n-\t\t\t\t\treturn tryEmitComplete();\n-\t\t\t\t}\n-\t\t\tcase SUBSCRIBED:\n-\t\t\t\tif (STATE.compareAndSet(this, State.SUBSCRIBED, State.TERMINATED)) {\n-\t\t\t\t\tactual.onComplete();\n-\t\t\t\t\tactual = null;\n-\t\t\t\t\treturn Emission.OK;\n-\t\t\t\t}\n-\t\t\t\telse {\n-\t\t\t\t\t// recurse\n-\t\t\t\t\treturn tryEmitComplete();\n-\t\t\t\t}\n-\t\t\tcase TERMINATED:\n-\t\t\tcase TERMINATED_BEFORE_SUBSCRIPTION:\n-\t\t\t\treturn Emission.FAIL_TERMINATED;\n-\t\t\tcase CANCELLED:\n-\t\t\t\treturn Emission.FAIL_CANCELLED;\n-\t\t\tdefault:\n-\t\t\t\tthrow new IllegalStateException();\n+\t\tfor (;;) { //for the benefit of retrying SUBSCRIBED\n+\t\t\tState s = this.state;\n+\t\t\tswitch (s) {\n+\t\t\t\tcase INITIAL:\n+\t\t\t\t\treturn Emission.FAIL_TERMINATED; //FIXME use ZERO_SUBSCRIBER LATER\n+\t\t\t\tcase SUBSCRIBED:\n+\t\t\t\t\tif (STATE.compareAndSet(this, s, State.TERMINATED)) {\n+\t\t\t\t\t\tactual.onComplete();\n+\t\t\t\t\t\tactual = null;\n+\t\t\t\t\t\treturn Emission.OK;\n+\t\t\t\t\t}\n+\t\t\t\t\tcontinue;\n+\t\t\t\tcase TERMINATED:\n+\t\t\t\t\treturn Emission.FAIL_TERMINATED;\n+\t\t\t\tcase CANCELLED:\n+\t\t\t\t\treturn Emission.FAIL_CANCELLED;\n+\t\t\t\tdefault:\n+\t\t\t\t\tthrow new IllegalStateException();\n+\t\t\t}\n \t\t}\n \t}\n-\n }\n"}}, {"oid": "5bbec1fc471f125520e2be2547e02d6d673c81f6", "url": "https://github.com/reactor/reactor-core/commit/5bbec1fc471f125520e2be2547e02d6d673c81f6", "message": "don't retain terminations but rather fail (rather than OK)", "committedDate": "2020-09-11T15:27:46Z", "type": "forcePushed"}, {"oid": "e385136c2d7999b56738567760d326a920911959", "url": "https://github.com/reactor/reactor-core/commit/e385136c2d7999b56738567760d326a920911959", "message": "Let UnicastManySinkNoBackpressure switch to terminal state (#2367)\n\nThis commit polishes the new unicast onBackpressureError so that it\nperforms the state transition to the TERMINATED state when completing\nor erroring the sink.\n\nAlso contains some state checks code style polish.", "committedDate": "2020-09-11T17:33:36Z", "type": "commit"}, {"oid": "e385136c2d7999b56738567760d326a920911959", "url": "https://github.com/reactor/reactor-core/commit/e385136c2d7999b56738567760d326a920911959", "message": "Let UnicastManySinkNoBackpressure switch to terminal state (#2367)\n\nThis commit polishes the new unicast onBackpressureError so that it\nperforms the state transition to the TERMINATED state when completing\nor erroring the sink.\n\nAlso contains some state checks code style polish.", "committedDate": "2020-09-11T17:33:36Z", "type": "forcePushed"}]}