{"pr_number": 2545, "pr_title": "fix #2538 Let `TestLogger` be configured with simplified format", "pr_createdAt": "2020-12-17T17:02:23Z", "pr_url": "https://github.com/reactor/reactor-core/pull/2545", "timeline": [{"oid": "570443b8a20e7c3ea7c716a0a8ba0538c79b9b53", "url": "https://github.com/reactor/reactor-core/commit/570443b8a20e7c3ea7c716a0a8ba0538c79b9b53", "message": "fix #2538 Let `TestLogger` be configured with static message", "committedDate": "2020-12-11T16:48:58Z", "type": "commit"}, {"oid": "8c3d4369810950afe5ef085fb00964476c465672", "url": "https://github.com/reactor/reactor-core/commit/8c3d4369810950afe5ef085fb00964476c465672", "message": "removed unnecessary changes to Logger.java", "committedDate": "2020-12-11T17:22:04Z", "type": "commit"}, {"oid": "90617f842a446f887cc054d6374df107c16c02da", "url": "https://github.com/reactor/reactor-core/commit/90617f842a446f887cc054d6374df107c16c02da", "message": "Reverted previous unnecessary changes", "committedDate": "2020-12-14T14:13:27Z", "type": "commit"}, {"oid": "d0112daf6b7ea4baedc2bf96cffc5d13ec814d7d", "url": "https://github.com/reactor/reactor-core/commit/d0112daf6b7ea4baedc2bf96cffc5d13ec814d7d", "message": "add customization to opt-out of logging thread name", "committedDate": "2020-12-17T16:55:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTI1Njc5MQ==", "url": "https://github.com/reactor/reactor-core/pull/2545#discussion_r545256791", "bodyText": "looking at this, I'm thinking maybe a second method like private String format could be used in all the log methods, in order to mutualize this if/else choice, wdyt?\nthe new method would get two strings as input: the prefix ([TRACE] and the other variants) and the user-provided message / format(format, arguments) result. it would then decide whether or not to put the thread name in the middle, centralizing that decision.", "author": "simonbasle", "createdAt": "2020-12-17T17:11:29Z", "path": "reactor-test/src/main/java/reactor/test/util/TestLogger.java", "diffHunk": "@@ -83,16 +85,28 @@ public boolean isTraceEnabled() {\n \n \t@Override\n \tpublic synchronized void trace(String msg) {\n-\t\tthis.log.format(\"[TRACE] (%s) %s\\n\", Thread.currentThread().getName(), msg);\n+\t\tif(logCurrentThreadName){", "originalCommit": "d0112daf6b7ea4baedc2bf96cffc5d13ec814d7d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTE2OTc3MQ==", "url": "https://github.com/reactor/reactor-core/pull/2545#discussion_r559169771", "bodyText": "Thanks for the suggestion, that way is much cleaner.", "author": "vdjuketic", "createdAt": "2021-01-17T11:48:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTI1Njc5MQ=="}], "type": "inlineReview", "revised_code": {"commit": "6acafbe9e4e3987cb7b61c972ad2ee261cfeb7e2", "chunk": "diff --git a/reactor-test/src/main/java/reactor/test/util/TestLogger.java b/reactor-test/src/main/java/reactor/test/util/TestLogger.java\nindex 35c09b3c4..5a262d2c5 100644\n--- a/reactor-test/src/main/java/reactor/test/util/TestLogger.java\n+++ b/reactor-test/src/main/java/reactor/test/util/TestLogger.java\n\n@@ -85,29 +93,17 @@ public class TestLogger implements Logger {\n \n \t@Override\n \tpublic synchronized void trace(String msg) {\n-\t\tif(logCurrentThreadName){\n-\t\t\tthis.log.format(\"[TRACE] (%s) %s\\n\", Thread.currentThread().getName(), msg);\n-\t\t} else {\n-\t\t\tthis.log.format(\"[TRACE] %s\\n\", msg);\n-\t\t}\n+\t\tthis.log.format(logContent(\"TRACE\", msg));\n \t}\n \n \t@Override\n \tpublic synchronized void trace(String format, Object... arguments) {\n-\t\tif(logCurrentThreadName){\n-\t\t\tthis.log.format(\"[TRACE] (%s) %s\\n\", Thread.currentThread().getName(), format(format, arguments));\n-\t\t} else {\n-\t\t\tthis.log.format(\"[TRACE] %s\\n\", format(format, arguments));\n-\t\t}\n+\t\tthis.log.format(logContent(\"TRACE\", format(format, arguments)));\n \t}\n \t@Override\n \tpublic synchronized void trace(String msg, Throwable t) {\n-\t\tif(logCurrentThreadName){\n-\t\t\tthis.log.format(\"[TRACE] (%s) %s - %s\\n\", Thread.currentThread().getName(), msg, t);\n-\t\t} else {\n-\t\t\tthis.log.format(\"[TRACE] %s - %s\\n\", msg, t);\n-\t\t}\n-\t\tt.printStackTrace(this.log);\n+\t\tthis.log.format(logContent(\"TRACE\", String.format(\"%s - %s\", msg, t)));\n+\t\tt.printStackTrace(this.err);\n \t}\n \n \t@Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTI1ODI0MA==", "url": "https://github.com/reactor/reactor-core/pull/2545#discussion_r545258240", "bodyText": "I don't think there is much need to make it mutable. could you replace the setter with a second constructor taking the boolean directly, and make the field final?", "author": "simonbasle", "createdAt": "2020-12-17T17:13:33Z", "path": "reactor-test/src/main/java/reactor/test/util/TestLogger.java", "diffHunk": "@@ -166,17 +216,37 @@ public boolean isErrorEnabled() {\n \n \t@Override\n \tpublic synchronized void error(String msg) {\n-\t\tthis.err.format(\"[ERROR] (%s) %s\\n\", Thread.currentThread().getName(), msg);\n+\t\tif(logCurrentThreadName){\n+\t\t\tthis.err.format(\"[ERROR] (%s) %s\\n\", Thread.currentThread().getName(), msg);\n+\t\t} else {\n+\t\t\tthis.err.format(\"[ERROR] %s\\n\", msg);\n+\t\t}\n \t}\n \n \t@Override\n \tpublic synchronized void error(String format, Object... arguments) {\n-\t\tthis.err.format(\"[ERROR] (%s) %s\\n\", Thread.currentThread().getName(), format(format, arguments));\n+\t\tif(logCurrentThreadName){\n+\t\t\tthis.err.format(\"[ERROR] (%s) %s\\n\", Thread.currentThread().getName(), format(format, arguments));\n+\t\t} else {\n+\t\t\tthis.err.format(\"[ERROR] %s\\n\", format(format, arguments));\n+\t\t}\n \t}\n \n \t@Override\n \tpublic synchronized void error(String msg, Throwable t) {\n-\t\tthis.err.format(\"[ERROR] (%s) %s - %s\\n\", Thread.currentThread().getName(), msg, t);\n+\t\tif(logCurrentThreadName){\n+\t\t\tthis.err.format(\"[ERROR] (%s) %s - %s\\n\", Thread.currentThread().getName(), msg, t);\n+\t\t} else {\n+\t\t\tthis.err.format(\"[ERROR] %s - %s\\n\", msg, t);\n+\t\t}\n \t\tt.printStackTrace(this.err);\n \t}\n+\n+\tpublic boolean isLogCurrentThreadName() {\n+\t\treturn logCurrentThreadName;\n+\t}\n+\n+\tpublic void setLogCurrentThreadName(boolean logCurrentThreadName) {", "originalCommit": "d0112daf6b7ea4baedc2bf96cffc5d13ec814d7d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6acafbe9e4e3987cb7b61c972ad2ee261cfeb7e2", "chunk": "diff --git a/reactor-test/src/main/java/reactor/test/util/TestLogger.java b/reactor-test/src/main/java/reactor/test/util/TestLogger.java\nindex 35c09b3c4..5a262d2c5 100644\n--- a/reactor-test/src/main/java/reactor/test/util/TestLogger.java\n+++ b/reactor-test/src/main/java/reactor/test/util/TestLogger.java\n\n@@ -216,37 +176,30 @@ public class TestLogger implements Logger {\n \n \t@Override\n \tpublic synchronized void error(String msg) {\n-\t\tif(logCurrentThreadName){\n-\t\t\tthis.err.format(\"[ERROR] (%s) %s\\n\", Thread.currentThread().getName(), msg);\n-\t\t} else {\n-\t\t\tthis.err.format(\"[ERROR] %s\\n\", msg);\n-\t\t}\n+\t\tthis.err.format(logContent(\"ERROR\", msg));\n \t}\n \n \t@Override\n \tpublic synchronized void error(String format, Object... arguments) {\n-\t\tif(logCurrentThreadName){\n-\t\t\tthis.err.format(\"[ERROR] (%s) %s\\n\", Thread.currentThread().getName(), format(format, arguments));\n-\t\t} else {\n-\t\t\tthis.err.format(\"[ERROR] %s\\n\", format(format, arguments));\n-\t\t}\n+\t\tthis.err.format(logContent(\"ERROR\", format(format, arguments)));\n \t}\n \n \t@Override\n \tpublic synchronized void error(String msg, Throwable t) {\n+\t\tthis.err.format(logContent(\"ERROR\", String.format(\"%s - %s\", msg, t)));\n+\t\tt.printStackTrace(this.err);\n+\t}\n+\n+\tString logContent(String logType, String msg){\n \t\tif(logCurrentThreadName){\n-\t\t\tthis.err.format(\"[ERROR] (%s) %s - %s\\n\", Thread.currentThread().getName(), msg, t);\n+\t\t\treturn String.format(\"[%s] (%s) %s\\n\", logType,\n+\t\t\t\t\tThread.currentThread().getName(), msg);\n \t\t} else {\n-\t\t\tthis.err.format(\"[ERROR] %s - %s\\n\", msg, t);\n+\t\t\treturn String.format(\"[%s] %s\\n\", logType, msg);\n \t\t}\n-\t\tt.printStackTrace(this.err);\n \t}\n \n \tpublic boolean isLogCurrentThreadName() {\n \t\treturn logCurrentThreadName;\n \t}\n-\n-\tpublic void setLogCurrentThreadName(boolean logCurrentThreadName) {\n-\t\tthis.logCurrentThreadName = logCurrentThreadName;\n-\t}\n }\n"}}, {"oid": "6acafbe9e4e3987cb7b61c972ad2ee261cfeb7e2", "url": "https://github.com/reactor/reactor-core/commit/6acafbe9e4e3987cb7b61c972ad2ee261cfeb7e2", "message": "refactor TestLogger to mutualize if/else in log methods", "committedDate": "2021-01-17T11:46:23Z", "type": "commit"}, {"oid": "7b155e9fa327674a805c216d157773862be11ec4", "url": "https://github.com/reactor/reactor-core/commit/7b155e9fa327674a805c216d157773862be11ec4", "message": "fix failing unit tests", "committedDate": "2021-01-18T08:14:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTQyNjk4MQ==", "url": "https://github.com/reactor/reactor-core/pull/2545#discussion_r559426981", "bodyText": "can you just ensure the log levels are padded left? [%5s] in both format Strings should suffice", "author": "simonbasle", "createdAt": "2021-01-18T09:32:12Z", "path": "reactor-test/src/main/java/reactor/test/util/TestLogger.java", "diffHunk": "@@ -216,37 +176,30 @@ public boolean isErrorEnabled() {\n \n \t@Override\n \tpublic synchronized void error(String msg) {\n-\t\tif(logCurrentThreadName){\n-\t\t\tthis.err.format(\"[ERROR] (%s) %s\\n\", Thread.currentThread().getName(), msg);\n-\t\t} else {\n-\t\t\tthis.err.format(\"[ERROR] %s\\n\", msg);\n-\t\t}\n+\t\tthis.err.format(logContent(\"ERROR\", msg));\n \t}\n \n \t@Override\n \tpublic synchronized void error(String format, Object... arguments) {\n-\t\tif(logCurrentThreadName){\n-\t\t\tthis.err.format(\"[ERROR] (%s) %s\\n\", Thread.currentThread().getName(), format(format, arguments));\n-\t\t} else {\n-\t\t\tthis.err.format(\"[ERROR] %s\\n\", format(format, arguments));\n-\t\t}\n+\t\tthis.err.format(logContent(\"ERROR\", format(format, arguments)));\n \t}\n \n \t@Override\n \tpublic synchronized void error(String msg, Throwable t) {\n+\t\tthis.err.format(logContent(\"ERROR\", String.format(\"%s - %s\", msg, t)));\n+\t\tt.printStackTrace(this.err);\n+\t}\n+\n+\tString logContent(String logType, String msg){", "originalCommit": "6acafbe9e4e3987cb7b61c972ad2ee261cfeb7e2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTQyOTA3Ng==", "url": "https://github.com/reactor/reactor-core/pull/2545#discussion_r559429076", "bodyText": "ah I see you've fixed that directly in each method. I'll let you decide if you prefer to mutualize that padding in the logContent method or not. Just let me know in response to this comment.", "author": "simonbasle", "createdAt": "2021-01-18T09:35:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTQyNjk4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTQ0MTc4Ng==", "url": "https://github.com/reactor/reactor-core/pull/2545#discussion_r559441786", "bodyText": "I noticed that WARN and INFO level logging is padded differently than the rest and I wasn't sure if there's a specific reason for that so I did it this way. There's a couple of different unit tests relying on that padding as well.", "author": "vdjuketic", "createdAt": "2021-01-18T09:54:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTQyNjk4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTQ0NDMzNw==", "url": "https://github.com/reactor/reactor-core/pull/2545#discussion_r559444337", "bodyText": "I don't mind updating those unit tests if every log type is supposed to have that padding", "author": "vdjuketic", "createdAt": "2021-01-18T09:58:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTQyNjk4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTUzNDcwMg==", "url": "https://github.com/reactor/reactor-core/pull/2545#discussion_r559534702", "bodyText": "yeah it was sort of a cosmetic thing, intending to align the log level part of the output. with your latest changes the unit tests are fine. it is more a question of putting the padding in the logContent method vs in the info(...) and warn(...) methods.", "author": "simonbasle", "createdAt": "2021-01-18T12:32:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTQyNjk4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTc0ODI3MA==", "url": "https://github.com/reactor/reactor-core/pull/2545#discussion_r559748270", "bodyText": "In that case i think we can leave it how it is right now with padding in the individual methods", "author": "vdjuketic", "createdAt": "2021-01-18T18:50:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTQyNjk4MQ=="}], "type": "inlineReview", "revised_code": null}]}