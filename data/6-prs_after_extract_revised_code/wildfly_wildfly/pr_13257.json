{"pr_number": 13257, "pr_title": "[WFLY-13298] Set up mixed domain testing against EAP 7.3", "pr_createdAt": "2020-04-30T16:55:38Z", "pr_url": "https://github.com/wildfly/wildfly/pull/13257", "timeline": [{"oid": "5e710290af6b32817f932c7cf8fa31a6b9f2aeca", "url": "https://github.com/wildfly/wildfly/commit/5e710290af6b32817f932c7cf8fa31a6b9f2aeca", "message": "[WFLY-13420] Enable Elytron mixed domain test suites", "committedDate": "2020-04-30T11:34:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM1OTE2Ng==", "url": "https://github.com/wildfly/wildfly/pull/13257#discussion_r418359166", "bodyText": "I don't understand this one. This resource exists in domain.xml for all versions from EAP 7.1 onward. Which is consistent with the comment above. So I'd think this method would be part of DomainAdjuster700.\nCurrently, it's here, it's also in DomainAdjuster720 (which means the removal gets run twice) and it's also left over as an unused method in DomainAdjuster710.", "author": "bstansberry", "createdAt": "2020-05-01T00:18:37Z", "path": "testsuite/mixed-domain/src/test/java/org/jboss/as/test/integration/domain/mixed/eap730/DomainAdjuster730.java", "diffHunk": "@@ -43,16 +46,36 @@\n \n     @Override\n     protected List<ModelNode> adjustForVersion(final DomainClient client, PathAddress profileAddress, boolean withMasterServers) throws Exception {\n-        final List<ModelNode> list = new ArrayList<>();\n+        final List<ModelNode> ops = new ArrayList<>();\n \n-        removeMicroProfileJWT(list, profileAddress.append(SUBSYSTEM, \"microprofile-jwt-smallrye\"));\n+        removeMicroProfileJWT(ops, profileAddress.append(SUBSYSTEM, \"microprofile-jwt-smallrye\"));\n+        adjustUndertow(ops, profileAddress.append(SUBSYSTEM, \"undertow\"));\n+        adjustOpenTracing(ops, profileAddress.append(SUBSYSTEM, \"microprofile-opentracing-smallrye\"));\n \n-        return list;\n+        return ops;\n     }\n \n-    private void removeMicroProfileJWT(final List<ModelNode> list, final PathAddress subsystem) {\n-        list.add(createRemoveOperation(subsystem));\n-        list.add(createRemoveOperation(PathAddress.pathAddress(EXTENSION, \"org.wildfly.extension.microprofile.jwt-smallrye\")));\n+    private void removeMicroProfileJWT(final List<ModelNode> ops, final PathAddress subsystem) {\n+        ops.add(createRemoveOperation(subsystem));\n+        ops.add(createRemoveOperation(PathAddress.pathAddress(EXTENSION, \"org.wildfly.extension.microprofile.jwt-smallrye\")));\n     }\n \n+    private void adjustUndertow(final List<ModelNode> ops, final PathAddress subsystem) {\n+        // EAP 7.0 and earlier required explicit SSL configuration. Wildfly 10.1 added support\n+        // for SSL by default, which automatically generates certs.\n+        // This could be removed if all hosts were configured to contain a security domain with SSL\n+        // enabled.\n+        final PathAddress httpsListener = subsystem\n+                .append(\"server\", \"default-server\")\n+                .append(\"https-listener\", \"https\");\n+        ops.add(Util.getEmptyOperation(ModelDescriptionConstants.REMOVE, httpsListener.toModelNode()));\n+    }", "originalCommit": "cd083b1a5e68871c0205a897ab50a1629ea11b64", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTI2MDQ4Nw==", "url": "https://github.com/wildfly/wildfly/pull/13257#discussion_r419260487", "bodyText": "I only executed the 7.3.0 tests in local so I did not realise that this adjustment must be moved from previous DomainAdjusters to the new ones. I have removed it now from DomainAdjuster710 and DomainAdjuster720 and added it only on DomainAdjuster730 to avoid the duplicity and the 'resource not exist' error.\nWe need this adjustment because the host slave configuration file used in the mixed domain tests does not add the SSL identity for the ApplicationRealm (to make the configuration compatible across all previous server releases including 7.0.0 and below), so we need to remove the undertow https to be able to deploy an application on the servers managed by the slave which does not have an SSL context available.", "author": "yersan", "createdAt": "2020-05-04T07:43:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM1OTE2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTE0NjkwNA==", "url": "https://github.com/wildfly/wildfly/pull/13257#discussion_r421146904", "bodyText": "Thanks!", "author": "bstansberry", "createdAt": "2020-05-06T23:18:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM1OTE2Ng=="}], "type": "inlineReview", "revised_code": {"commit": "988045cf10caf766baf60cd13c3ad902fec92e52", "chunk": "diff --git a/testsuite/mixed-domain/src/test/java/org/jboss/as/test/integration/domain/mixed/eap730/DomainAdjuster730.java b/testsuite/mixed-domain/src/test/java/org/jboss/as/test/integration/domain/mixed/eap730/DomainAdjuster730.java\nindex e6c9856a42..71c3663268 100644\n--- a/testsuite/mixed-domain/src/test/java/org/jboss/as/test/integration/domain/mixed/eap730/DomainAdjuster730.java\n+++ b/testsuite/mixed-domain/src/test/java/org/jboss/as/test/integration/domain/mixed/eap730/DomainAdjuster730.java\n\n@@ -63,8 +63,9 @@ public class DomainAdjuster730 extends DomainAdjuster {\n     private void adjustUndertow(final List<ModelNode> ops, final PathAddress subsystem) {\n         // EAP 7.0 and earlier required explicit SSL configuration. Wildfly 10.1 added support\n         // for SSL by default, which automatically generates certs.\n-        // This could be removed if all hosts were configured to contain a security domain with SSL\n-        // enabled.\n+        // This could be removed if all hosts were configured to contain a security domain with SSL enabled.\n+        // However, for the mixed domain tests, we are using a reduced host slave configuration file (see slave-config resource dir)\n+        // these configurations do not configure a SSL on ApplicationRealm, hence this removal to make it compatible across all domains.\n         final PathAddress httpsListener = subsystem\n                 .append(\"server\", \"default-server\")\n                 .append(\"https-listener\", \"https\");\n"}}, {"oid": "988045cf10caf766baf60cd13c3ad902fec92e52", "url": "https://github.com/wildfly/wildfly/commit/988045cf10caf766baf60cd13c3ad902fec92e52", "message": "[WFLY-13298] Set up mixed domain testing against EAP 7.3\n\n[WFLY-13298] Add legacy configuration files for parse and marshal model tests", "committedDate": "2020-05-04T07:30:32Z", "type": "commit"}, {"oid": "988045cf10caf766baf60cd13c3ad902fec92e52", "url": "https://github.com/wildfly/wildfly/commit/988045cf10caf766baf60cd13c3ad902fec92e52", "message": "[WFLY-13298] Set up mixed domain testing against EAP 7.3\n\n[WFLY-13298] Add legacy configuration files for parse and marshal model tests", "committedDate": "2020-05-04T07:30:32Z", "type": "forcePushed"}]}