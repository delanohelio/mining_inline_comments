{"pr_number": 13262, "pr_title": "[WFLY-13424]: External pooled connection factory won't be properl injected if it has several JNDI entries.", "pr_createdAt": "2020-05-04T14:08:36Z", "pr_url": "https://github.com/wildfly/wildfly/pull/13262", "timeline": [{"oid": "bb45cd4e27719363ab08ee18600b04bdb1648000", "url": "https://github.com/wildfly/wildfly/commit/bb45cd4e27719363ab08ee18600b04bdb1648000", "message": "[WFLY-13424]: External pooled connection factory won't be properl injected if it has several JNDI entries.\n\n* if the bound name is not the first one then we get a reference to a\n  reference service instead ofg the pcf service.\n* resolving this so that we get the proper resource adapter service name.\n\nJira: https://issues.redhat.com/browse/WFLY-13424", "committedDate": "2020-05-04T14:08:50Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY4MDcyMw==", "url": "https://github.com/wildfly/wildfly/pull/13262#discussion_r421680723", "bodyText": "Minor point; ignore if you want -- this L435-437 block duplicates L423-425 and could be dropped if this entire new code block from L426 was moved above L423.", "author": "bstansberry", "createdAt": "2020-05-07T17:43:03Z", "path": "messaging-activemq/src/main/java/org/wildfly/extension/messaging/activemq/deployment/JMSConnectionFactoryDefinitionInjectionSource.java", "diffHunk": "@@ -420,6 +423,21 @@ static String getDefaulResourceAdapter(DeploymentUnit deploymentUnit) {\n                 if (pcf != null && pcf instanceof ConnectionFactoryReferenceFactoryService) {\n                     return ((ConnectionFactoryReferenceFactoryService) pcf).getName();\n                 }\n+                //In case of multiple JNDI entries only the 1st is properly bound\n+                if (pcf != null && pcf instanceof ContextListAndJndiViewManagedReferenceFactory) {\n+                    ManagedReference ref = ((ContextListAndJndiViewManagedReferenceFactory) pcf).getReference();\n+                    Object ra = ref.getInstance();\n+                    if (ra instanceof ActiveMQRAConnectionFactoryImpl) {\n+                        bindInfo = ContextNames.bindInfoFor(((ActiveMQRAConnectionFactoryImpl) ra).getReference().getClassName());\n+                        binder = deploymentUnit.getServiceRegistry().getService(bindInfo.getBinderServiceName());\n+                        if (binder != null) {\n+                            pcf = binder.getService().getValue();\n+                            if (pcf != null && pcf instanceof ConnectionFactoryReferenceFactoryService) {\n+                                return ((ConnectionFactoryReferenceFactoryService) pcf).getName();\n+                            }", "originalCommit": "bb45cd4e27719363ab08ee18600b04bdb1648000", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a91eba91c96f0a511fe0be68fdd456fb632cf937", "chunk": "diff --git a/messaging-activemq/src/main/java/org/wildfly/extension/messaging/activemq/deployment/JMSConnectionFactoryDefinitionInjectionSource.java b/messaging-activemq/src/main/java/org/wildfly/extension/messaging/activemq/deployment/JMSConnectionFactoryDefinitionInjectionSource.java\nindex 6e67f637d0..c6e01a4e1d 100644\n--- a/messaging-activemq/src/main/java/org/wildfly/extension/messaging/activemq/deployment/JMSConnectionFactoryDefinitionInjectionSource.java\n+++ b/messaging-activemq/src/main/java/org/wildfly/extension/messaging/activemq/deployment/JMSConnectionFactoryDefinitionInjectionSource.java\n\n@@ -420,9 +420,6 @@ public class JMSConnectionFactoryDefinitionInjectionSource extends ResourceDefin\n             ServiceController binder = deploymentUnit.getServiceRegistry().getService(bindInfo.getBinderServiceName());\n             if (binder != null) {\n                 Object pcf = binder.getService().getValue();\n-                if (pcf != null && pcf instanceof ConnectionFactoryReferenceFactoryService) {\n-                    return ((ConnectionFactoryReferenceFactoryService) pcf).getName();\n-                }\n                 //In case of multiple JNDI entries only the 1st is properly bound\n                 if (pcf != null && pcf instanceof ContextListAndJndiViewManagedReferenceFactory) {\n                     ManagedReference ref = ((ContextListAndJndiViewManagedReferenceFactory) pcf).getReference();\n"}}, {"oid": "a91eba91c96f0a511fe0be68fdd456fb632cf937", "url": "https://github.com/wildfly/wildfly/commit/a91eba91c96f0a511fe0be68fdd456fb632cf937", "message": "[(nobranch,rebasingWFLY-13424)]:  [WFLY-13424]: External pooled connection factory won't be properl injected if it has several JNDI entries.\n\n* if the bound name is not the first one then we get a reference to a\n  reference service instead ofg the pcf service.\n* resolving this so that we get the proper resource adapter service name.\n\nJira: https://issues.redhat.com/browse/WFLY-13424", "committedDate": "2020-05-11T12:30:24Z", "type": "commit"}, {"oid": "a91eba91c96f0a511fe0be68fdd456fb632cf937", "url": "https://github.com/wildfly/wildfly/commit/a91eba91c96f0a511fe0be68fdd456fb632cf937", "message": "[(nobranch,rebasingWFLY-13424)]:  [WFLY-13424]: External pooled connection factory won't be properl injected if it has several JNDI entries.\n\n* if the bound name is not the first one then we get a reference to a\n  reference service instead ofg the pcf service.\n* resolving this so that we get the proper resource adapter service name.\n\nJira: https://issues.redhat.com/browse/WFLY-13424", "committedDate": "2020-05-11T12:30:24Z", "type": "forcePushed"}]}