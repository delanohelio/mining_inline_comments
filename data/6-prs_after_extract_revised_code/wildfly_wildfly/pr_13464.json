{"pr_number": 13464, "pr_title": "WFLY-13521 Upgrade Infinispan to 11.0.3.Final", "pr_createdAt": "2020-08-06T15:37:22Z", "pr_url": "https://github.com/wildfly/wildfly/pull/13464", "timeline": [{"oid": "251fbc36eb5bf881e7faace90bb66c88e0a888f2", "url": "https://github.com/wildfly/wildfly/commit/251fbc36eb5bf881e7faace90bb66c88e0a888f2", "message": "WFLY-13521 Upgrade Infinispan to 11.0.3.Final", "committedDate": "2020-08-08T15:01:08Z", "type": "forcePushed"}, {"oid": "fbe9ed1266633617922433ab83b8203281d55dd8", "url": "https://github.com/wildfly/wildfly/commit/fbe9ed1266633617922433ab83b8203281d55dd8", "message": "WFLY-13521 Upgrade Infinispan to 11.0.3.Final", "committedDate": "2020-08-10T13:24:06Z", "type": "forcePushed"}, {"oid": "e58ae007b9c1b516c2f3b62cfd1c9a332a4c5a9a", "url": "https://github.com/wildfly/wildfly/commit/e58ae007b9c1b516c2f3b62cfd1c9a332a4c5a9a", "message": "WFLY-13521 Upgrade Infinispan to 11.0.3.Final", "committedDate": "2020-08-10T16:34:20Z", "type": "forcePushed"}, {"oid": "38ae6957235ccc0960849682bb53592a38b35291", "url": "https://github.com/wildfly/wildfly/commit/38ae6957235ccc0960849682bb53592a38b35291", "message": "WFLY-13521 Upgrade Infinispan to 11.0.3.Final", "committedDate": "2020-08-10T16:35:54Z", "type": "forcePushed"}, {"oid": "681eb8f0792007c23db363b66dd3d5a64e359331", "url": "https://github.com/wildfly/wildfly/commit/681eb8f0792007c23db363b66dd3d5a64e359331", "message": "WFLY-13521 Upgrade Infinispan to 11.0.3.Final", "committedDate": "2020-08-11T13:53:18Z", "type": "forcePushed"}, {"oid": "7e362d12aefc0c7f34be2635d80837d6205bf7f1", "url": "https://github.com/wildfly/wildfly/commit/7e362d12aefc0c7f34be2635d80837d6205bf7f1", "message": "WFLY-13521 Upgrade Infinispan to 11.0.3.Final", "committedDate": "2020-08-12T13:45:55Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTMzNTM3OQ==", "url": "https://github.com/wildfly/wildfly/pull/13464#discussion_r469335379", "bodyText": "Looks like this can be gone?", "author": "rhusar", "createdAt": "2020-08-12T15:14:14Z", "path": "clustering/infinispan/extension/src/main/java/org/jboss/as/clustering/infinispan/subsystem/OffHeapMemoryResourceDefinition.java", "diffHunk": "@@ -62,24 +102,101 @@\n         public AttributeDefinition getDefinition() {\n             return this.definition;\n         }\n+\n+        @Override\n+        public SimpleAttributeDefinitionBuilder apply(SimpleAttributeDefinitionBuilder builder) {\n+            return builder;\n+        }\n     }\n \n     static void buildTransformation(ModelVersion version, ResourceTransformationDescriptionBuilder parent) {\n         if (InfinispanModel.VERSION_6_0_0.requiresTransformation(version)) {\n             parent.rejectChildResource(PATH);\n+        } else {\n+            ResourceTransformationDescriptionBuilder builder = parent.addChildResource(PATH);\n+            // We cannot convert these size values - as there is not guarantee that such a converter would run before the sizeUnitConverter\n+            for (MemorySizeUnit unit : EnumSet.complementOf(EnumSet.of(MemorySizeUnit.ENTRIES, MemorySizeUnit.BYTES))) {\n+                builder.getAttributeBuilder().addRejectCheck(new RejectAttributeChecker.SimpleRejectAttributeChecker(new ModelNode(unit.name())), Attribute.SIZE_UNIT.getName());\n+            }\n+            SimpleAttributeConverter.Converter sizeUnitConverter = new SimpleAttributeConverter.Converter() {\n+                @SuppressWarnings(\"deprecation\")\n+                @Override\n+                public void convert(PathAddress address, String name, ModelNode value, ModelNode model, TransformationContext context) {\n+                    if (value.isDefined()) {\n+                        MemorySizeUnit unit = MemorySizeUnit.valueOf(value.asString());\n+                        if (unit == MemorySizeUnit.ENTRIES) {\n+                            value.clear();\n+                        } else {\n+                            value.set(org.infinispan.eviction.EvictionType.MEMORY.name());\n+                        }\n+                        //value.set((unit == MemorySizeUnit.ENTRIES ? org.infinispan.eviction.EvictionType.COUNT : org.infinispan.eviction.EvictionType.MEMORY).name());", "originalCommit": "7e362d12aefc0c7f34be2635d80837d6205bf7f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTM4MTM1MA==", "url": "https://github.com/wildfly/wildfly/pull/13464#discussion_r469381350", "bodyText": "Yup.", "author": "pferraro", "createdAt": "2020-08-12T16:17:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTMzNTM3OQ=="}], "type": "inlineReview", "revised_code": {"commit": "099625b359a668efa420f3f055de39ae4ec7db63", "chunk": "diff --git a/clustering/infinispan/extension/src/main/java/org/jboss/as/clustering/infinispan/subsystem/OffHeapMemoryResourceDefinition.java b/clustering/infinispan/extension/src/main/java/org/jboss/as/clustering/infinispan/subsystem/OffHeapMemoryResourceDefinition.java\nindex 2597c82071..5bd953e4e8 100644\n--- a/clustering/infinispan/extension/src/main/java/org/jboss/as/clustering/infinispan/subsystem/OffHeapMemoryResourceDefinition.java\n+++ b/clustering/infinispan/extension/src/main/java/org/jboss/as/clustering/infinispan/subsystem/OffHeapMemoryResourceDefinition.java\n\n@@ -129,7 +129,6 @@ public class OffHeapMemoryResourceDefinition extends MemoryResourceDefinition {\n                         } else {\n                             value.set(org.infinispan.eviction.EvictionType.MEMORY.name());\n                         }\n-                        //value.set((unit == MemorySizeUnit.ENTRIES ? org.infinispan.eviction.EvictionType.COUNT : org.infinispan.eviction.EvictionType.MEMORY).name());\n                     }\n                 }\n             };\n"}}, {"oid": "099625b359a668efa420f3f055de39ae4ec7db63", "url": "https://github.com/wildfly/wildfly/commit/099625b359a668efa420f3f055de39ae4ec7db63", "message": "WFLY-13786 DistributableSessionManager.getSession(...) should not propagate exceptions", "committedDate": "2020-08-20T15:36:00Z", "type": "forcePushed"}, {"oid": "336d49cb7d078094e24fbb6f8d8423f8ac17d0c1", "url": "https://github.com/wildfly/wildfly/commit/336d49cb7d078094e24fbb6f8d8423f8ac17d0c1", "message": "WFLY-13521 Upgrade Infinispan to 11.0.3.Final", "committedDate": "2020-08-21T13:03:09Z", "type": "forcePushed"}, {"oid": "329c5f07f91f5e542e09ea454e34dd9db5792d93", "url": "https://github.com/wildfly/wildfly/commit/329c5f07f91f5e542e09ea454e34dd9db5792d93", "message": "WFLY-13521 Upgrade Infinispan to 11.0.3.Final", "committedDate": "2020-08-21T13:13:12Z", "type": "forcePushed"}, {"oid": "b9f784cfa885b407808ec1690471d160888b1379", "url": "https://github.com/wildfly/wildfly/commit/b9f784cfa885b407808ec1690471d160888b1379", "message": "Add Infinispan subsystem model version 13.0.0", "committedDate": "2020-08-21T15:03:41Z", "type": "commit"}, {"oid": "b907f1920e30be2cc948c2e2db3f95ab3ca1a4d6", "url": "https://github.com/wildfly/wildfly/commit/b907f1920e30be2cc948c2e2db3f95ab3ca1a4d6", "message": "Infinispan subsystem schema version 11.0.", "committedDate": "2020-08-21T15:03:41Z", "type": "commit"}, {"oid": "a473ac10f59aaf6906ca6d6bbde86354d4cc8379", "url": "https://github.com/wildfly/wildfly/commit/a473ac10f59aaf6906ca6d6bbde86354d4cc8379", "message": "WFLY-13521 Upgrade Infinispan to 11.0.3.Final", "committedDate": "2020-08-21T15:09:48Z", "type": "commit"}, {"oid": "a473ac10f59aaf6906ca6d6bbde86354d4cc8379", "url": "https://github.com/wildfly/wildfly/commit/a473ac10f59aaf6906ca6d6bbde86354d4cc8379", "message": "WFLY-13521 Upgrade Infinispan to 11.0.3.Final", "committedDate": "2020-08-21T15:09:48Z", "type": "forcePushed"}]}