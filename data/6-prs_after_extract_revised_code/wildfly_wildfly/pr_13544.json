{"pr_number": 13544, "pr_title": "WFLY-13832 Bug in detecting the org.apache.cxf module", "pr_createdAt": "2020-09-09T14:21:04Z", "pr_url": "https://github.com/wildfly/wildfly/pull/13544", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjczMjI2OQ==", "url": "https://github.com/wildfly/wildfly/pull/13544#discussion_r486732269", "bodyText": "If I understand this correctly, here we already checked Ear deployment. Do we really need this recursion after this check ?\nI don't know if this case has already been checked:  there is another sub-deployment has cxf dependencies, and ear-subdeployments-isolated set to false . Do we need to look at this ?", "author": "jimma", "createdAt": "2020-09-11T02:12:00Z", "path": "webservices/server-integration/src/main/java/org/jboss/as/webservices/deployers/WSClassVerificationProcessor.java", "diffHunk": "@@ -138,14 +138,28 @@ private void verifyApacheCXFModuleDependencyRequirement(DeploymentUnit unit) {\n         }\n     }\n \n-    private static boolean hasCxfModuleDependency(DeploymentUnit unit) {\n+    static boolean hasCxfModuleDependency(DeploymentUnit unit) {\n         final ModuleSpecification moduleSpec = unit.getAttachment(Attachments.MODULE_SPECIFICATION);\n         for (ModuleDependency dep : moduleSpec.getUserDependencies()) {\n             final String id = dep.getIdentifier().getName();\n             if (cxfExportingModules.contains(id)) {\n                 return true;\n             }\n         }\n+        return hasParentCxfModuleDependency(unit);\n+    }\n+\n+    private static boolean hasParentCxfModuleDependency(DeploymentUnit unit) {\n+        if (unit.getParent() != null) {\n+            final ModuleSpecification moduleSpec = unit.getParent().getAttachment(Attachments.MODULE_SPECIFICATION);\n+            for (ModuleDependency dep : moduleSpec.getUserDependencies()) {\n+                final String id = dep.getIdentifier().getName();\n+                if (cxfExportingModules.contains(id) && dep.isExport()) {\n+                    return true;\n+                }\n+            }\n+            return hasParentCxfModuleDependency(unit.getParent());", "originalCommit": "8eb6faff6b198f771463e2e703df51ec0459d7e3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODgwNjcxNg==", "url": "https://github.com/wildfly/wildfly/pull/13544#discussion_r488806716", "bodyText": "Agree, based on jboss deployment structure XSD, recursion is not necessary.\nI added another check that should take subdeployments-isolated into account.", "author": "TomasHofman", "createdAt": "2020-09-15T16:36:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjczMjI2OQ=="}], "type": "inlineReview", "revised_code": {"commit": "6ecc8bf54d73e0b3b658ff4363f8781d5cd88ed0", "chunk": "diff --git a/webservices/server-integration/src/main/java/org/jboss/as/webservices/deployers/WSClassVerificationProcessor.java b/webservices/server-integration/src/main/java/org/jboss/as/webservices/deployers/WSClassVerificationProcessor.java\nindex beccd1fc39..4646b474fa 100644\n--- a/webservices/server-integration/src/main/java/org/jboss/as/webservices/deployers/WSClassVerificationProcessor.java\n+++ b/webservices/server-integration/src/main/java/org/jboss/as/webservices/deployers/WSClassVerificationProcessor.java\n\n@@ -158,7 +158,6 @@ public class WSClassVerificationProcessor implements DeploymentUnitProcessor {\n                     return true;\n                 }\n             }\n-            return hasParentCxfModuleDependency(unit.getParent());\n         }\n         return false;\n     }\n"}}, {"oid": "6ecc8bf54d73e0b3b658ff4363f8781d5cd88ed0", "url": "https://github.com/wildfly/wildfly/commit/6ecc8bf54d73e0b3b658ff4363f8781d5cd88ed0", "message": "WFLY-13832 Bug in detecting the org.apache.cxf module\n\nLook for cxf module also in exported parent dependencies", "committedDate": "2020-09-15T06:27:14Z", "type": "forcePushed"}, {"oid": "9cfc7bae9410288514fad6ad348276833690a1da", "url": "https://github.com/wildfly/wildfly/commit/9cfc7bae9410288514fad6ad348276833690a1da", "message": "WFLY-13832 Bug in detecting the org.apache.cxf module\n\nLook for cxf module also in exported parent dependencies", "committedDate": "2020-09-15T16:32:47Z", "type": "commit"}, {"oid": "9cfc7bae9410288514fad6ad348276833690a1da", "url": "https://github.com/wildfly/wildfly/commit/9cfc7bae9410288514fad6ad348276833690a1da", "message": "WFLY-13832 Bug in detecting the org.apache.cxf module\n\nLook for cxf module also in exported parent dependencies", "committedDate": "2020-09-15T16:32:47Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTcxMzg5MA==", "url": "https://github.com/wildfly/wildfly/pull/13544#discussion_r489713890", "bodyText": "Missing copyright header.", "author": "darranl", "createdAt": "2020-09-16T19:46:43Z", "path": "webservices/server-integration/src/test/java/org/jboss/as/webservices/deployers/WSClassVerificationProcessorTestCase.java", "diffHunk": "@@ -0,0 +1,95 @@\n+package org.jboss.as.webservices.deployers;", "originalCommit": "9cfc7bae9410288514fad6ad348276833690a1da", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDAyNzY5Mg==", "url": "https://github.com/wildfly/wildfly/pull/13544#discussion_r490027692", "bodyText": "Fixed by #13580, thanks!", "author": "TomasHofman", "createdAt": "2020-09-17T07:26:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTcxMzg5MA=="}], "type": "inlineReview", "revised_code": null}]}