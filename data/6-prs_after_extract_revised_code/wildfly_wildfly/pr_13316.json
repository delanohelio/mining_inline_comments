{"pr_number": 13316, "pr_title": "[WFLY-13423] Remove the uses of AbstractOutboundConnectionService fro\u2026", "pr_createdAt": "2020-05-21T09:17:34Z", "pr_url": "https://github.com/wildfly/wildfly/pull/13316", "timeline": [{"oid": "4bc039e5b57429dfc8519c0cba72193eb1b393fd", "url": "https://github.com/wildfly/wildfly/commit/4bc039e5b57429dfc8519c0cba72193eb1b393fd", "message": "[WFLY-13423] Remove the uses of AbstractOutboundConnectionService from ejb3 subsystem\n\n[WFLY-13423] Provision org.jboss.as.remoting on ejb3 for required resources", "committedDate": "2020-05-27T08:50:32Z", "type": "forcePushed"}, {"oid": "49a47229a48394d6f8eaf91adb132fae36b8ee5a", "url": "https://github.com/wildfly/wildfly/commit/49a47229a48394d6f8eaf91adb132fae36b8ee5a", "message": "[WFLY-13423] Remove the uses of AbstractOutboundConnectionService from ejb3 subsystem\n\n[WFLY-13423] Provision org.jboss.as.remoting on ejb3 for required resources", "committedDate": "2020-05-28T18:25:03Z", "type": "forcePushed"}, {"oid": "9837d374293e44e01e3e3a0bf5fdcb3f746d685a", "url": "https://github.com/wildfly/wildfly/commit/9837d374293e44e01e3e3a0bf5fdcb3f746d685a", "message": "[WFLY-13423] Remove the uses of AbstractOutboundConnectionService from ejb3 subsystem\n\n[WFLY-13423] Provision org.jboss.as.remoting on ejb3 for required resources", "committedDate": "2020-05-29T09:30:17Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzAwNDcxMA==", "url": "https://github.com/wildfly/wildfly/pull/13316#discussion_r437004710", "bodyText": "Is this validation necessary?  This isn't a management model consistency check, where we need to fail in Stage.MODEL if something is wrong. This is runtime stuff. If the reference is invalid won't MSC report the service wiring failure? I'm reluctant to start adding additional validation. It has the potential to produce nicer failures (although a \"missing capability\" message isn't particularly nicer than a \"missing service\" message) but it's either going to end up being done in a few random spots or it will be a very large addition of potentially fragile code.", "author": "bstansberry", "createdAt": "2020-06-08T21:14:03Z", "path": "ejb3/src/main/java/org/jboss/as/ejb3/deployment/processors/EJBClientDescriptorMetaDataProcessor.java", "diffHunk": "@@ -133,6 +136,19 @@ public void deploy(DeploymentPhaseContext phaseContext) throws DeploymentUnitPro\n         if (ejbClientDescriptorMetaData == null && ! interceptorsDefined) {\n             return;\n         }\n+\n+        final CapabilityServiceSupport support = deploymentUnit.getAttachment(org.jboss.as.server.deployment.Attachments.CAPABILITY_SERVICE_SUPPORT);\n+        if (ejbClientDescriptorMetaData != null && ejbClientDescriptorMetaData.getProfile() == null) {\n+                for (EJBClientDescriptorMetaData.RemotingReceiverConfiguration receiverConfiguration : ejbClientDescriptorMetaData.getRemotingReceiverConfigurations()) {\n+                    final String requiredCap = RuntimeCapability.buildDynamicCapabilityName(OUTBOUND_CONNECTION_CAPABILITY_NAME, receiverConfiguration.getOutboundConnectionRef());\n+                    if (!support.hasCapability(requiredCap)) {\n+                        throw EjbLogger.DEPLOYMENT_LOGGER.deploymentRequiresCapability(\n+                                deploymentUnit.getName(),\n+                                requiredCap);\n+                    }\n+            }\n+        }\n+", "originalCommit": "9837d374293e44e01e3e3a0bf5fdcb3f746d685a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzM3OTk2Mg==", "url": "https://github.com/wildfly/wildfly/pull/13316#discussion_r437379962", "bodyText": "It is unnecessary, the intention was fail as soon as possible with a nicer message.\nI agree on your points so I'll remove this and let the missing service message in case a user runs into this situation.", "author": "yersan", "createdAt": "2020-06-09T12:39:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzAwNDcxMA=="}], "type": "inlineReview", "revised_code": {"commit": "c82a7d5e63aacba2f1ceff9a15d2bc626b6361e3", "chunk": "diff --git a/ejb3/src/main/java/org/jboss/as/ejb3/deployment/processors/EJBClientDescriptorMetaDataProcessor.java b/ejb3/src/main/java/org/jboss/as/ejb3/deployment/processors/EJBClientDescriptorMetaDataProcessor.java\nindex 4fce3dd6c1..7859cf3195 100644\n--- a/ejb3/src/main/java/org/jboss/as/ejb3/deployment/processors/EJBClientDescriptorMetaDataProcessor.java\n+++ b/ejb3/src/main/java/org/jboss/as/ejb3/deployment/processors/EJBClientDescriptorMetaDataProcessor.java\n\n@@ -136,19 +135,6 @@ public class EJBClientDescriptorMetaDataProcessor implements DeploymentUnitProce\n         if (ejbClientDescriptorMetaData == null && ! interceptorsDefined) {\n             return;\n         }\n-\n-        final CapabilityServiceSupport support = deploymentUnit.getAttachment(org.jboss.as.server.deployment.Attachments.CAPABILITY_SERVICE_SUPPORT);\n-        if (ejbClientDescriptorMetaData != null && ejbClientDescriptorMetaData.getProfile() == null) {\n-                for (EJBClientDescriptorMetaData.RemotingReceiverConfiguration receiverConfiguration : ejbClientDescriptorMetaData.getRemotingReceiverConfigurations()) {\n-                    final String requiredCap = RuntimeCapability.buildDynamicCapabilityName(OUTBOUND_CONNECTION_CAPABILITY_NAME, receiverConfiguration.getOutboundConnectionRef());\n-                    if (!support.hasCapability(requiredCap)) {\n-                        throw EjbLogger.DEPLOYMENT_LOGGER.deploymentRequiresCapability(\n-                                deploymentUnit.getName(),\n-                                requiredCap);\n-                    }\n-            }\n-        }\n-\n         // install the descriptor based EJB client context service\n         final ServiceName ejbClientContextServiceName = EJBClientContextService.DEPLOYMENT_BASE_SERVICE_NAME.append(deploymentUnit.getName());\n         final ServiceTarget serviceTarget = phaseContext.getServiceTarget();\n"}}, {"oid": "c82a7d5e63aacba2f1ceff9a15d2bc626b6361e3", "url": "https://github.com/wildfly/wildfly/commit/c82a7d5e63aacba2f1ceff9a15d2bc626b6361e3", "message": "[WFLY-13423] Remove the uses of AbstractOutboundConnectionService from ejb3 subsystem", "committedDate": "2020-06-10T11:35:21Z", "type": "commit"}, {"oid": "c82a7d5e63aacba2f1ceff9a15d2bc626b6361e3", "url": "https://github.com/wildfly/wildfly/commit/c82a7d5e63aacba2f1ceff9a15d2bc626b6361e3", "message": "[WFLY-13423] Remove the uses of AbstractOutboundConnectionService from ejb3 subsystem", "committedDate": "2020-06-10T11:35:21Z", "type": "forcePushed"}]}