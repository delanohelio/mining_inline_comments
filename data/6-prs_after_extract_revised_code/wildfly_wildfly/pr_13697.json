{"pr_number": 13697, "pr_title": "WFLY-14055 Implement caching inside ExternalBeanArchiveProcessor to i\u2026", "pr_createdAt": "2020-11-10T14:55:43Z", "pr_url": "https://github.com/wildfly/wildfly/pull/13697", "timeline": [{"oid": "25f4df73b14e357e710757a4e686bab597142862", "url": "https://github.com/wildfly/wildfly/commit/25f4df73b14e357e710757a4e686bab597142862", "message": "WFLY-14055 Implement caching inside ExternalBeanArchiveProcessor to improve deployment times for big applications.", "committedDate": "2020-11-10T15:26:31Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgzNjI4Ng==", "url": "https://github.com/wildfly/wildfly/pull/13697#discussion_r520836286", "bodyText": "This will always return false as the keys are dependencyModule.getName().", "author": "bstansberry", "createdAt": "2020-11-10T19:56:00Z", "path": "weld/subsystem/src/main/java/org/jboss/as/weld/deployment/processors/ExternalBeanArchiveProcessor.java", "diffHunk": "@@ -325,9 +328,13 @@ private Index tryLoadIndex(URL indexUrl) {\n      * @param dependencyModule\n      * @return the map of exported resources\n      */\n-    private Map<URL, URL> findExportedResources(Module dependencyModule) {\n+    private Map<URL, URL> findExportedResources(Module dependencyModule, Map<String, Map<URL, URL>> exportedResourcesCache) {\n+        if (exportedResourcesCache.containsKey(dependencyModule)) {", "originalCommit": "25f4df73b14e357e710757a4e686bab597142862", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTEyMzgyMw==", "url": "https://github.com/wildfly/wildfly/pull/13697#discussion_r521123823", "bodyText": "Thanks for spotting this @bstansberry! Should be fixed now.", "author": "manovotn", "createdAt": "2020-11-11T05:37:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgzNjI4Ng=="}], "type": "inlineReview", "revised_code": {"commit": "34088875f09252d608c30a42780ac306d23ff106", "chunk": "diff --git a/weld/subsystem/src/main/java/org/jboss/as/weld/deployment/processors/ExternalBeanArchiveProcessor.java b/weld/subsystem/src/main/java/org/jboss/as/weld/deployment/processors/ExternalBeanArchiveProcessor.java\nindex 80c98050e6..5fb02fda0f 100644\n--- a/weld/subsystem/src/main/java/org/jboss/as/weld/deployment/processors/ExternalBeanArchiveProcessor.java\n+++ b/weld/subsystem/src/main/java/org/jboss/as/weld/deployment/processors/ExternalBeanArchiveProcessor.java\n\n@@ -329,7 +329,7 @@ public class ExternalBeanArchiveProcessor implements DeploymentUnitProcessor {\n      * @return the map of exported resources\n      */\n     private Map<URL, URL> findExportedResources(Module dependencyModule, Map<String, Map<URL, URL>> exportedResourcesCache) {\n-        if (exportedResourcesCache.containsKey(dependencyModule)) {\n+        if (exportedResourcesCache.containsKey(dependencyModule.getName())) {\n             return exportedResourcesCache.get(dependencyModule.getName());\n         }\n         Set<URL> beanXmls = findExportedResource(dependencyModule, META_INF_BEANS_XML);\n"}}, {"oid": "34088875f09252d608c30a42780ac306d23ff106", "url": "https://github.com/wildfly/wildfly/commit/34088875f09252d608c30a42780ac306d23ff106", "message": "WFLY-14055 Implement caching inside ExternalBeanArchiveProcessor to improve deployment times for big applications.", "committedDate": "2020-11-11T05:35:05Z", "type": "commit"}, {"oid": "34088875f09252d608c30a42780ac306d23ff106", "url": "https://github.com/wildfly/wildfly/commit/34088875f09252d608c30a42780ac306d23ff106", "message": "WFLY-14055 Implement caching inside ExternalBeanArchiveProcessor to improve deployment times for big applications.", "committedDate": "2020-11-11T05:35:05Z", "type": "forcePushed"}, {"oid": "02a7739a7328f7770a433f65a4563fca346b06bb", "url": "https://github.com/wildfly/wildfly/commit/02a7739a7328f7770a433f65a4563fca346b06bb", "message": "WFLY-14055 Optimize BeanDeploymentArchiveImpl, avoid calling Module.getIdentifier.", "committedDate": "2020-11-11T13:56:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTM5MzQ5OA==", "url": "https://github.com/wildfly/wildfly/pull/13697#discussion_r521393498", "bodyText": "This is the only part where I am not certain - the comparison takes the name of ModuleDependencySpec and that of a Module. But I assume that if their identifiers were comparable and those were replaced by String names, then the names should be comparable as well. Feel free to prove me wrong.", "author": "manovotn", "createdAt": "2020-11-11T14:25:19Z", "path": "weld/subsystem/src/main/java/org/jboss/as/weld/deployment/BeanDeploymentArchiveImpl.java", "diffHunk": "@@ -239,11 +239,12 @@ public boolean isAccessible(BeanDeploymentArchive target) {\n             return true;\n         }\n \n+        final String thatIdentifier = that.getModule().getName();\n         // basic check whether the module is our dependency\n         for (DependencySpec dependency : module.getDependencies()) {\n             if (dependency instanceof ModuleDependencySpec) {\n                 ModuleDependencySpec moduleDependency = (ModuleDependencySpec) dependency;\n-                if (moduleDependency.getIdentifier().equals(that.getModule().getIdentifier())) {\n+                if (moduleDependency.getName().equals(thatIdentifier)) {", "originalCommit": "02a7739a7328f7770a433f65a4563fca346b06bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY5Njg0Mw==", "url": "https://github.com/wildfly/wildfly/pull/13697#discussion_r521696843", "bodyText": "@manovotn LGTM.  I'll just assume the existing equals is valid. If not, that's not the concern of this PR. ;)\nRe the change in both classes getIdentifier() is deprecated with javadoc saying to use getName(). And internally both implement getIdentfier() as ModuleIdentifier.fromString(name). So this change is valid according to both the implementation and the javadoc.", "author": "bstansberry", "createdAt": "2020-11-11T23:20:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTM5MzQ5OA=="}], "type": "inlineReview", "revised_code": null}]}