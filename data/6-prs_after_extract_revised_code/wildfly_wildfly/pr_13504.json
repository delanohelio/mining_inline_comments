{"pr_number": 13504, "pr_title": "[WFLY-13188] Defer vendor metric registration until completion of boot", "pr_createdAt": "2020-08-26T01:22:12Z", "pr_url": "https://github.com/wildfly/wildfly/pull/13504", "timeline": [{"oid": "e0200d992e17ea87a1596e06ea8d998392275814", "url": "https://github.com/wildfly/wildfly/commit/e0200d992e17ea87a1596e06ea8d998392275814", "message": "[WFLY-13188] Add a test of reading WildFly metrics during boot", "committedDate": "2020-08-26T12:25:51Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzM0NDIzNg==", "url": "https://github.com/wildfly/wildfly/pull/13504#discussion_r477344236", "bodyText": "@bstansberry it's probably a stupid question, but is there a risk of registering the metric twice if the state flips to RUNNING after listener is added but before the condition?", "author": "spyrkob", "createdAt": "2020-08-26T14:26:53Z", "path": "microprofile/metrics-smallrye/src/main/java/org/wildfly/extension/microprofile/metrics/MetricCollector.java", "diffHunk": "@@ -88,6 +94,26 @@ public MetricRegistration collectResourceMetrics(final Resource resource,\n                                                      Function<PathAddress, PathAddress> resourceAddressResolver) {\n         MetricRegistration registration = new MetricRegistration();\n         collectResourceMetrics0(resource, managementResourceRegistration, EMPTY_ADDRESS, resourceAddressResolver, registration);\n+        // Defer the actual registration until the server is running and they can be collected w/o errors\n+        PropertyChangeListener listener = new PropertyChangeListener() {\n+            @Override\n+            public void propertyChange(PropertyChangeEvent evt) {\n+                if (ControlledProcessState.State.RUNNING == evt.getNewValue()) {\n+                    registration.register();\n+                } else if (ControlledProcessState.State.STOPPING == evt.getNewValue()) {\n+                    // Unregister so if this is a reload they won't still be around in a static cache in MetricsRegistry\n+                    // and cause problems when the server is starting\n+                    registration.unregister();\n+                    processStateNotifier.removePropertyChangeListener(this);\n+                }\n+\n+            }\n+        };\n+        this.processStateNotifier.addPropertyChangeListener(listener);\n+        // If server is already running, we won't get a change event so register now\n+        if (ControlledProcessState.State.RUNNING == this.processStateNotifier.getCurrentState()) {\n+            registration.register();", "originalCommit": "e0200d992e17ea87a1596e06ea8d998392275814", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQyMDg2Mg==", "url": "https://github.com/wildfly/wildfly/pull/13504#discussion_r477420862", "bodyText": "@spyrkob No, there isn't, but it's probably better to code defensively against it by making the method synchronized.\nIt's not a stupid question. :)\nThis method is called in the context of a management op that modifying the system. The switch to RUNNING also occurs in the context of such a management op (a big composite op that runs during boot) and the switch to RUNNING doesn't happen until the code that would call this method has completed. The system won't allow concurrent execution of 2 such management ops.", "author": "bstansberry", "createdAt": "2020-08-26T16:12:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzM0NDIzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQyNjQ0MQ==", "url": "https://github.com/wildfly/wildfly/pull/13504#discussion_r477426441", "bodyText": "Great, thanks for the explanation :)", "author": "spyrkob", "createdAt": "2020-08-26T16:20:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzM0NDIzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQ3MDIxOQ==", "url": "https://github.com/wildfly/wildfly/pull/13504#discussion_r477470219", "bodyText": "@spyrkob I added the synchronized", "author": "bstansberry", "createdAt": "2020-08-26T17:31:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzM0NDIzNg=="}], "type": "inlineReview", "revised_code": null}, {"oid": "46ce32f764517370b45d1ade85fe2762c1a6c35b", "url": "https://github.com/wildfly/wildfly/commit/46ce32f764517370b45d1ade85fe2762c1a6c35b", "message": "[WFLY-13188] Defer vendor metric registration until completion of boot", "committedDate": "2020-08-26T17:28:17Z", "type": "commit"}, {"oid": "a4731555379ec04c7fb17718eb9579eb15ab1194", "url": "https://github.com/wildfly/wildfly/commit/a4731555379ec04c7fb17718eb9579eb15ab1194", "message": "Save a bit of memory on wildfly metrics unregistration tasks", "committedDate": "2020-08-26T17:28:17Z", "type": "commit"}, {"oid": "481d5693b1377a3f24d706b3720e93d6f230e9b7", "url": "https://github.com/wildfly/wildfly/commit/481d5693b1377a3f24d706b3720e93d6f230e9b7", "message": "[WFLY-13188] Add a test of reading WildFly metrics during boot", "committedDate": "2020-08-26T17:28:17Z", "type": "commit"}, {"oid": "481d5693b1377a3f24d706b3720e93d6f230e9b7", "url": "https://github.com/wildfly/wildfly/commit/481d5693b1377a3f24d706b3720e93d6f230e9b7", "message": "[WFLY-13188] Add a test of reading WildFly metrics during boot", "committedDate": "2020-08-26T17:28:17Z", "type": "forcePushed"}]}