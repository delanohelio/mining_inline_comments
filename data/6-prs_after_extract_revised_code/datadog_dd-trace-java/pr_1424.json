{"pr_number": 1424, "pr_title": "[Breaking change for dd-trace-api] Deprecate scope finishOnClose and continuation close", "pr_createdAt": "2020-05-01T20:28:18Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/1424", "timeline": [{"oid": "32c5add892f9466ee77f001776768d29be6ed19e", "url": "https://github.com/DataDog/dd-trace-java/commit/32c5add892f9466ee77f001776768d29be6ed19e", "message": "Update the easy cases...", "committedDate": "2020-05-01T21:05:44Z", "type": "forcePushed"}, {"oid": "b823c7273ebe8b8ed9c4567796ef584ce2413de7", "url": "https://github.com/DataDog/dd-trace-java/commit/b823c7273ebe8b8ed9c4567796ef584ce2413de7", "message": "Update the easy cases...", "committedDate": "2020-05-01T21:17:42Z", "type": "forcePushed"}, {"oid": "c4958fbffd6ea1f6054dea6ccf583987b769464a", "url": "https://github.com/DataDog/dd-trace-java/commit/c4958fbffd6ea1f6054dea6ccf583987b769464a", "message": "[Breaking change] Deprecate scope finishOnClose and continuation close\n\nThese deprecated methods will be removed in the following release.", "committedDate": "2020-05-04T17:35:56Z", "type": "commit"}, {"oid": "cf8bea6b90fb8a233cf12de79ad2ece0b43d3945", "url": "https://github.com/DataDog/dd-trace-java/commit/cf8bea6b90fb8a233cf12de79ad2ece0b43d3945", "message": "Remove usage of deprecated methods\n\nFrom internal instrumentation and tests.\n\nStill have problematic usage in Hibernate and Lettuce instrumentation that needs to be fixed.", "committedDate": "2020-05-04T17:35:56Z", "type": "forcePushed"}, {"oid": "dcc17637319f951c18433b033c5e61d2895af75a", "url": "https://github.com/DataDog/dd-trace-java/commit/dcc17637319f951c18433b033c5e61d2895af75a", "message": "Remove usage of deprecated methods\n\nFrom internal instrumentation and tests.\n\nStill have problematic usage in Hibernate and Lettuce instrumentation that needs to be fixed.", "committedDate": "2020-05-04T18:54:47Z", "type": "forcePushed"}, {"oid": "c4958fbffd6ea1f6054dea6ccf583987b769464a", "url": "https://github.com/DataDog/dd-trace-java/commit/c4958fbffd6ea1f6054dea6ccf583987b769464a", "message": "[Breaking change] Deprecate scope finishOnClose and continuation close\n\nThese deprecated methods will be removed in the following release.", "committedDate": "2020-05-04T17:35:56Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDI4OTQ0Mg==", "url": "https://github.com/DataDog/dd-trace-java/pull/1424#discussion_r420289442", "bodyText": "Is this code exposed by dd-trace-api to our users?", "author": "devinsba", "createdAt": "2020-05-05T17:39:22Z", "path": "dd-trace-core/src/main/java/datadog/trace/core/scopemanager/ContinuableScope.java", "diffHunk": "@@ -183,11 +183,24 @@ public ContinuableScope activate() {\n       }\n     }\n \n+    public void cancel() {\n+      assert !finishOnClose : \"cancel() should not be used with finishOnClose=true\";", "originalCommit": "c4958fbffd6ea1f6054dea6ccf583987b769464a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDMyNDM2MA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1424#discussion_r420324360", "bodyText": "@devinsba yes... right here.", "author": "tylerbenson", "createdAt": "2020-05-05T18:36:50Z", "path": "dd-trace-api/src/main/java/datadog/trace/context/TraceScope.java", "diffHunk": "@@ -26,28 +26,40 @@\n    */\n   void setAsyncPropagation(boolean value);\n \n-  /** Used to pass async context between workers. */\n+  /**\n+   * Used to pass async context between workers. Either activate or cancel must be called on each\n+   * continuation instance to allow the trace to be reported.\n+   */\n   interface Continuation {\n+\n     /**\n      * Activate the continuation.\n      *\n      * <p>Should be called on the child thread.\n+     *\n+     * <p>Consider calling this in a try-with-resources initialization block to ensure the returned\n+     * scope is closed properly.\n      */\n     TraceScope activate();\n \n+    /** Allow trace to stop waiting on this continuation for reporting. */\n+    void cancel();", "originalCommit": "c4958fbffd6ea1f6054dea6ccf583987b769464a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDMyNjU1Mw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1424#discussion_r420326553", "bodyText": "whoops, I meant dd-trace-ot. Anyway, I'm not sure we want to expose an assertion to users even if it would be ignored nearly all of the time, maybe a warn log would be better", "author": "devinsba", "createdAt": "2020-05-05T18:40:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDMyNDM2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM2Njk1Nw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1424#discussion_r420366957", "bodyText": "Normally I would agree with you, but this is a new method, not something that would be called in existing code.  I think we should have it for this first version, but we will remove it with the deprecated methods.", "author": "tylerbenson", "createdAt": "2020-05-05T19:52:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDMyNDM2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM3MDEzNA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1424#discussion_r420370134", "bodyText": "Works for me", "author": "devinsba", "createdAt": "2020-05-05T19:58:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDMyNDM2MA=="}], "type": "inlineReview", "revised_code": null}]}