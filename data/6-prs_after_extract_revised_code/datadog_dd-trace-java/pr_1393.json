{"pr_number": 1393, "pr_title": "merge DD_VERSION and DD_ENV with \"dd.trace.global.tags\"", "pr_createdAt": "2020-04-21T16:26:15Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/1393", "timeline": [{"oid": "48402c44810a22a7b926b6e8b666df6cb03e7ce4", "url": "https://github.com/DataDog/dd-trace-java/commit/48402c44810a22a7b926b6e8b666df6cb03e7ce4", "message": "merge DD_VERSION and DD_ENV with \"dd.trace.global.tags\"", "committedDate": "2020-04-21T21:41:52Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjU0MDUxMA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1393#discussion_r412540510", "bodyText": "weird formatting...", "author": "tylerbenson", "createdAt": "2020-04-21T22:41:12Z", "path": "dd-trace-api/src/main/java/datadog/trace/api/Config.java", "diffHunk": "@@ -375,11 +375,26 @@ private String profilingProxyPasswordMasker() {\n         getBooleanSettingFromEnvironment(TRACE_RESOLVER_ENABLED, DEFAULT_TRACE_RESOLVER_ENABLED);\n     serviceMapping = getMapSettingFromEnvironment(SERVICE_MAPPING, null);\n \n-    final Map<String, String> tagsPreMap = new HashMap<>(getMapSettingFromEnvironment(TAGS, null));\n-    addPropToMapIfDefinedByEnvironment(tagsPreMap, ENV);\n-    addPropToMapIfDefinedByEnvironment(tagsPreMap, VERSION);\n-    tags = Collections.unmodifiableMap(tagsPreMap);\n-    globalTags = getMapSettingFromEnvironment(GLOBAL_TAGS, null);\n+    {\n+      final Map<String, String> tagsPreMap =\n+          new HashMap<>(getMapSettingFromEnvironment(TAGS, null));\n+      if (tagsPreMap != null && !tagsPreMap.isEmpty()) {\n+        // we only populate this tags if we use 'dd.tags'. If we don't use it: we populate this tags\n+        // to\n+        // 'dd.trace.global.tags' and globalTags field", "originalCommit": "48402c44810a22a7b926b6e8b666df6cb03e7ce4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5e66734796fc700349c96144fccc35d1961a8cb8", "chunk": "diff --git a/dd-trace-api/src/main/java/datadog/trace/api/Config.java b/dd-trace-api/src/main/java/datadog/trace/api/Config.java\nindex f9321a4a6f..5ac99e71ee 100644\n--- a/dd-trace-api/src/main/java/datadog/trace/api/Config.java\n+++ b/dd-trace-api/src/main/java/datadog/trace/api/Config.java\n\n@@ -376,24 +377,18 @@ public class Config {\n     serviceMapping = getMapSettingFromEnvironment(SERVICE_MAPPING, null);\n \n     {\n-      final Map<String, String> tagsPreMap =\n-          new HashMap<>(getMapSettingFromEnvironment(TAGS, null));\n+      final Map<String, String> tagsPreMap = getMapSettingFromEnvironment(TAGS, null);\n       if (tagsPreMap != null && !tagsPreMap.isEmpty()) {\n         // we only populate this tags if we use 'dd.tags'. If we don't use it: we populate this tags\n-        // to\n-        // 'dd.trace.global.tags' and globalTags field\n-        addPropToMapIfDefinedByEnvironment(tagsPreMap, ENV);\n-        addPropToMapIfDefinedByEnvironment(tagsPreMap, VERSION);\n+        // to 'dd.trace.global.tags' and globalTags field\n+        tags = getMapWithPropertiesDefinedByEnvironment(tagsPreMap, ENV, VERSION);\n+      } else {\n+        tags = Collections.emptyMap();\n       }\n-      tags = Collections.unmodifiableMap(tagsPreMap);\n-    }\n-    {\n-      final Map<String, String> globalTagsPreMap =\n-          new HashMap<>(getMapSettingFromEnvironment(GLOBAL_TAGS, null));\n-      addPropToMapIfDefinedByEnvironment(globalTagsPreMap, ENV);\n-      addPropToMapIfDefinedByEnvironment(globalTagsPreMap, VERSION);\n-      globalTags = Collections.unmodifiableMap(globalTagsPreMap);\n     }\n+    globalTags =\n+        getMapWithPropertiesDefinedByEnvironment(\n+            getMapSettingFromEnvironment(GLOBAL_TAGS, null), ENV, VERSION);\n \n     spanTags = getMapSettingFromEnvironment(SPAN_TAGS, null);\n     jmxTags = getMapSettingFromEnvironment(JMX_TAGS, null);\n"}}, {"oid": "5e66734796fc700349c96144fccc35d1961a8cb8", "url": "https://github.com/DataDog/dd-trace-java/commit/5e66734796fc700349c96144fccc35d1961a8cb8", "message": "merge DD_VERSION and DD_ENV with \"dd.trace.global.tags\"", "committedDate": "2020-04-22T00:10:13Z", "type": "forcePushed"}, {"oid": "d02ceb3d9446bdbc2fc883bc4fb77674d53245e5", "url": "https://github.com/DataDog/dd-trace-java/commit/d02ceb3d9446bdbc2fc883bc4fb77674d53245e5", "message": "merge DD_VERSION and DD_ENV with \"dd.trace.global.tags\"", "committedDate": "2020-04-22T01:25:36Z", "type": "forcePushed"}, {"oid": "b82171f522bae86c5c428f37c9c86a463e11823e", "url": "https://github.com/DataDog/dd-trace-java/commit/b82171f522bae86c5c428f37c9c86a463e11823e", "message": "merge DD_VERSION and DD_ENV with \"dd.trace.global.tags\"", "committedDate": "2020-04-22T06:12:02Z", "type": "forcePushed"}, {"oid": "baae56954071f35ab1fb8f1e3844f7f8300ef2a6", "url": "https://github.com/DataDog/dd-trace-java/commit/baae56954071f35ab1fb8f1e3844f7f8300ef2a6", "message": "merge DD_VERSION and DD_ENV with \"dd.trace.global.tags\"", "committedDate": "2020-04-22T07:13:37Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDYzNTYzNg==", "url": "https://github.com/DataDog/dd-trace-java/pull/1393#discussion_r414635636", "bodyText": "Do you think it would simplify things to reduce the distinction between tags and global tags and combine them into a single map as soon as possible?  (End result being just a single tags field.)", "author": "tylerbenson", "createdAt": "2020-04-24T14:49:23Z", "path": "dd-trace-api/src/main/java/datadog/trace/api/Config.java", "diffHunk": "@@ -375,11 +376,20 @@ private String profilingProxyPasswordMasker() {\n         getBooleanSettingFromEnvironment(TRACE_RESOLVER_ENABLED, DEFAULT_TRACE_RESOLVER_ENABLED);\n     serviceMapping = getMapSettingFromEnvironment(SERVICE_MAPPING, null);\n \n-    final Map<String, String> tagsPreMap = new HashMap<>(getMapSettingFromEnvironment(TAGS, null));\n-    addPropToMapIfDefinedByEnvironment(tagsPreMap, ENV);\n-    addPropToMapIfDefinedByEnvironment(tagsPreMap, VERSION);\n-    tags = Collections.unmodifiableMap(tagsPreMap);\n-    globalTags = getMapSettingFromEnvironment(GLOBAL_TAGS, null);\n+    {\n+      final Map<String, String> tagsPreMap = getMapSettingFromEnvironment(TAGS, null);\n+      if (tagsPreMap != null && !tagsPreMap.isEmpty()) {\n+        // we only populate this tags if we use 'dd.tags'. If we don't use it: we populate this tags\n+        // to 'dd.trace.global.tags' and globalTags field\n+        tags = getMapWithPropertiesDefinedByEnvironment(tagsPreMap, ENV, VERSION);\n+      } else {\n+        tags = Collections.emptyMap();\n+      }\n+    }\n+    globalTags =\n+        getMapWithPropertiesDefinedByEnvironment(\n+            getMapSettingFromEnvironment(GLOBAL_TAGS, null), ENV, VERSION);\n+", "originalCommit": "baae56954071f35ab1fb8f1e3844f7f8300ef2a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc3MTE5Mw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1393#discussion_r414771193", "bodyText": "+1 I think this idea makes sense too. We just need to be careful about the order of precedence for updating the single map.\nE.g.,\n\nLook for DD_ prefixed env var first for env/service/version.\nThen look at JMX flags.", "author": "jdgumz", "createdAt": "2020-04-24T18:15:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDYzNTYzNg=="}], "type": "inlineReview", "revised_code": {"commit": "f50a4871c55a0cee2e4596503e81e6088a26ce25", "chunk": "diff --git a/dd-trace-api/src/main/java/datadog/trace/api/Config.java b/dd-trace-api/src/main/java/datadog/trace/api/Config.java\nindex 5ac99e71ee..623c4702a8 100644\n--- a/dd-trace-api/src/main/java/datadog/trace/api/Config.java\n+++ b/dd-trace-api/src/main/java/datadog/trace/api/Config.java\n\n@@ -377,18 +377,10 @@ public class Config {\n     serviceMapping = getMapSettingFromEnvironment(SERVICE_MAPPING, null);\n \n     {\n-      final Map<String, String> tagsPreMap = getMapSettingFromEnvironment(TAGS, null);\n-      if (tagsPreMap != null && !tagsPreMap.isEmpty()) {\n-        // we only populate this tags if we use 'dd.tags'. If we don't use it: we populate this tags\n-        // to 'dd.trace.global.tags' and globalTags field\n-        tags = getMapWithPropertiesDefinedByEnvironment(tagsPreMap, ENV, VERSION);\n-      } else {\n-        tags = Collections.emptyMap();\n-      }\n+      final Map<String, String> tags = new HashMap<>(getMapSettingFromEnvironment(GLOBAL_TAGS, null));\n+      tags.putAll(getMapSettingFromEnvironment(TAGS, null));\n+      this.tags = getMapWithPropertiesDefinedByEnvironment(tags, ENV, VERSION);\n     }\n-    globalTags =\n-        getMapWithPropertiesDefinedByEnvironment(\n-            getMapSettingFromEnvironment(GLOBAL_TAGS, null), ENV, VERSION);\n \n     spanTags = getMapSettingFromEnvironment(SPAN_TAGS, null);\n     jmxTags = getMapSettingFromEnvironment(JMX_TAGS, null);\n"}}, {"oid": "8994a8b37bf78e59d342a44726981eca4aa0b71a", "url": "https://github.com/DataDog/dd-trace-java/commit/8994a8b37bf78e59d342a44726981eca4aa0b71a", "message": "merge DD_VERSION and DD_ENV with \"dd.trace.global.tags\"", "committedDate": "2020-04-27T06:30:26Z", "type": "commit"}, {"oid": "f50a4871c55a0cee2e4596503e81e6088a26ce25", "url": "https://github.com/DataDog/dd-trace-java/commit/f50a4871c55a0cee2e4596503e81e6088a26ce25", "message": "DD_SERVICE priority over DD_SERVICE_NAME; merge TAGS and GLOBAL_TAGS", "committedDate": "2020-04-27T06:53:07Z", "type": "forcePushed"}, {"oid": "2bab0776f81603348332bab998a6a466f779fdfa", "url": "https://github.com/DataDog/dd-trace-java/commit/2bab0776f81603348332bab998a6a466f779fdfa", "message": "DD_SERVICE priority over DD_SERVICE_NAME; merge TAGS and GLOBAL_TAGS", "committedDate": "2020-04-27T06:55:07Z", "type": "commit"}, {"oid": "2bab0776f81603348332bab998a6a466f779fdfa", "url": "https://github.com/DataDog/dd-trace-java/commit/2bab0776f81603348332bab998a6a466f779fdfa", "message": "DD_SERVICE priority over DD_SERVICE_NAME; merge TAGS and GLOBAL_TAGS", "committedDate": "2020-04-27T06:55:07Z", "type": "forcePushed"}]}