{"pr_number": 1233, "pr_title": "Remove costly matchers from ignore list", "pr_createdAt": "2020-02-19T22:58:34Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/1233", "timeline": [{"oid": "88aa31b63edba7de4906dd87eaa0a4ba27d3e379", "url": "https://github.com/DataDog/dd-trace-java/commit/88aa31b63edba7de4906dd87eaa0a4ba27d3e379", "message": "Remove costly matchers from ignore list\n\nRemoving these matchers caused the time spent matching ignores to go from greater than 1 second to less than 100 ms.", "committedDate": "2020-02-20T00:24:23Z", "type": "commit"}, {"oid": "6e4b55304e34a32d357757fbd204b2b855b34b04", "url": "https://github.com/DataDog/dd-trace-java/commit/6e4b55304e34a32d357757fbd204b2b855b34b04", "message": "Add special handling for ignoring `javax.decorator.Decorator` annotated classes.", "committedDate": "2020-02-20T00:24:23Z", "type": "commit"}, {"oid": "6e4b55304e34a32d357757fbd204b2b855b34b04", "url": "https://github.com/DataDog/dd-trace-java/commit/6e4b55304e34a32d357757fbd204b2b855b34b04", "message": "Add special handling for ignoring `javax.decorator.Decorator` annotated classes.", "committedDate": "2020-02-20T00:24:23Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTk2MzA3Nw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1233#discussion_r381963077", "bodyText": "It is really-really surprising that these are slow - by the looks is it they should just be doing an & on two ints.", "author": "mar-kolya", "createdAt": "2020-02-20T12:16:24Z", "path": "dd-java-agent/agent-tooling/src/main/java/datadog/trace/agent/tooling/AgentInstaller.java", "diffHunk": "@@ -68,10 +66,11 @@ public static ResettableClassFileTransformer installBytebuddyAgent(\n             // https://github.com/raphw/byte-buddy/issues/558\n             // .with(AgentBuilder.LambdaInstrumentationStrategy.ENABLED)\n             .ignore(any(), skipClassLoader())\n-            // Unlikely to ever need to instrument an annotation:\n-            .or(ElementMatchers.<TypeDescription>isAnnotation())\n-            // Unlikely to ever need to instrument an enum:\n-            .or(ElementMatchers.<TypeDescription>isEnum())", "originalCommit": "6e4b55304e34a32d357757fbd204b2b855b34b04", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjAzNDIyMg==", "url": "https://github.com/DataDog/dd-trace-java/pull/1233#discussion_r382034222", "bodyText": "Yes, it is a bit counter intuitive, but I think understand why.\nMy suspicion is that name checks don't actually require materializing the TypeDescription from the underlying class file, since the name is known ahead of time.\nOn the other hand, the enum & annotation flag are only present in the class file, so ByteBuddy probably has to load the class file to do the check.\nIf the TypeDescription were already loaded then I have no doubt that isEnum & isAnnotation would be cheaper than the name check.", "author": "dougqh", "createdAt": "2020-02-20T14:30:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTk2MzA3Nw=="}], "type": "inlineReview", "revised_code": null}]}