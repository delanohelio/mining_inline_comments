{"pr_number": 1521, "pr_title": "Update play-2.6 instrumentation to support Play version 2.8.x", "pr_createdAt": "2020-06-02T01:55:00Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/1521", "timeline": [{"oid": "059ac4b56c84da641d5218d59965cc3cba2814a3", "url": "https://github.com/DataDog/dd-trace-java/commit/059ac4b56c84da641d5218d59965cc3cba2814a3", "message": "Fix Play2.8 instrumentation\n\nplay.api.libs.TypedKey.asScala was added in Play 26. play.api.libs.TypedKey.underlying was deprecated in 2.7 and removed in 2.8.", "committedDate": "2020-06-02T01:37:12Z", "type": "commit"}, {"oid": "87814acd1f1cfc966537fccecdc89a84b106ba96", "url": "https://github.com/DataDog/dd-trace-java/commit/87814acd1f1cfc966537fccecdc89a84b106ba96", "message": "fix typo", "committedDate": "2020-06-02T01:56:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk1NzkxNA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1521#discussion_r433957914", "bodyText": "Unfortunately this method was not added until 2.6.8: https://github.com/playframework/playframework/blob/2.6.8/framework/src/play/src/main/java/play/libs/typedmap/TypedKey.java#L31\nMaking this change while good would break support of some play 2.6 versions. Given the size of this change, can you make this call with reflection to the appropriate method instead? (make asScala the default path)\nI don't think this is a place where creating a whole new version makes sense", "author": "devinsba", "createdAt": "2020-06-02T15:19:20Z", "path": "dd-java-agent/instrumentation/play-2.6/src/main/java8/datadog/trace/instrumentation/play26/PlayHttpServerDecorator.java", "diffHunk": "@@ -61,7 +61,7 @@ public AgentSpan onRequest(final AgentSpan span, final Request request) {\n       // more about routes here:\n       // https://github.com/playframework/playframework/blob/master/documentation/manual/releases/release26/migration26/Migration26.md\n       final Option<HandlerDef> defOption =\n-          request.attrs().get(Router.Attrs.HANDLER_DEF.underlying());\n+          request.attrs().get(Router.Attrs.HANDLER_DEF.asScala());", "originalCommit": "87814acd1f1cfc966537fccecdc89a84b106ba96", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk2ODk4NQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1521#discussion_r435968985", "bodyText": "Well, I'd appreciate if you could pick this up, I'm not very familiar with the codebase yet. thank you!", "author": "keki", "createdAt": "2020-06-05T14:42:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk1NzkxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk3OTg3Nw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1521#discussion_r435979877", "bodyText": "Thanks - we'll take a closer look on our end to get over the finish line!", "author": "andrewsouthard1", "createdAt": "2020-06-05T15:00:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk1NzkxNA=="}], "type": "inlineReview", "revised_code": {"commit": "f20bf9c031744bd8ec99335ca93faaacc4c197d8", "chunk": "diff --git a/dd-java-agent/instrumentation/play-2.6/src/main/java8/datadog/trace/instrumentation/play26/PlayHttpServerDecorator.java b/dd-java-agent/instrumentation/play-2.6/src/main/java8/datadog/trace/instrumentation/play26/PlayHttpServerDecorator.java\nindex 26ff1f8767..85af1b971a 100644\n--- a/dd-java-agent/instrumentation/play-2.6/src/main/java8/datadog/trace/instrumentation/play26/PlayHttpServerDecorator.java\n+++ b/dd-java-agent/instrumentation/play-2.6/src/main/java8/datadog/trace/instrumentation/play26/PlayHttpServerDecorator.java\n\n@@ -60,9 +81,19 @@ public class PlayHttpServerDecorator extends HttpServerDecorator<Request, Reques\n     if (request != null) {\n       // more about routes here:\n       // https://github.com/playframework/playframework/blob/master/documentation/manual/releases/release26/migration26/Migration26.md\n-      final Option<HandlerDef> defOption =\n-          request.attrs().get(Router.Attrs.HANDLER_DEF.asScala());\n-      if (!defOption.isEmpty()) {\n+      Option<HandlerDef> defOption = null;\n+      if (typedKeyGetUnderlying != null) { // Should always be non-null but just to make sure\n+        try {\n+          defOption =\n+              request\n+                  .attrs()\n+                  .get(\n+                      (play.api.libs.typedmap.TypedKey<HandlerDef>)\n+                          typedKeyGetUnderlying.invoke(Router.Attrs.HANDLER_DEF));\n+        } catch (final IllegalAccessException | InvocationTargetException ignored) {\n+        }\n+      }\n+      if (defOption != null && !defOption.isEmpty()) {\n         final String path = defOption.get().path();\n         span.setTag(DDTags.RESOURCE_NAME, request.method() + \" \" + path);\n       }\n"}}, {"oid": "f20bf9c031744bd8ec99335ca93faaacc4c197d8", "url": "https://github.com/DataDog/dd-trace-java/commit/f20bf9c031744bd8ec99335ca93faaacc4c197d8", "message": "Use reflection to resolve method to get underlying handler", "committedDate": "2020-06-05T18:16:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjE0MTU2OQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1521#discussion_r436141569", "bodyText": "This is probably subverting the muzzle check... so if they change this in the future, we might not detect it properly.  Lightbend will likely break our instrumentation in the next \"minor\" version anyway so we should be sure to split it out as a separate module at that point.", "author": "tylerbenson", "createdAt": "2020-06-05T20:10:02Z", "path": "dd-java-agent/instrumentation/play-2.6/src/main/java8/datadog/trace/instrumentation/play26/PlayHttpServerDecorator.java", "diffHunk": "@@ -5,20 +5,41 @@\n import datadog.trace.bootstrap.instrumentation.api.Tags;\n import datadog.trace.bootstrap.instrumentation.decorator.HttpServerDecorator;\n import java.lang.reflect.InvocationTargetException;\n+import java.lang.reflect.Method;\n import java.lang.reflect.UndeclaredThrowableException;\n import java.net.URI;\n import java.net.URISyntaxException;\n import lombok.extern.slf4j.Slf4j;\n import play.api.mvc.Request;\n import play.api.mvc.Result;\n import play.api.routing.HandlerDef;\n+import play.libs.typedmap.TypedKey;\n import play.routing.Router;\n import scala.Option;\n \n @Slf4j\n public class PlayHttpServerDecorator extends HttpServerDecorator<Request, Request, Result> {\n   public static final PlayHttpServerDecorator DECORATE = new PlayHttpServerDecorator();\n \n+  private static final Method typedKeyGetUnderlying;\n+\n+  static {\n+    Method typedKeyGetUnderlyingCheck = null;\n+    try {\n+      // This method was added in Play 2.6.8\n+      typedKeyGetUnderlyingCheck = TypedKey.class.getMethod(\"asScala\");\n+    } catch (final NoSuchMethodException ignored) {\n+    }\n+    // Fallback\n+    if (typedKeyGetUnderlyingCheck == null) {\n+      try {\n+        typedKeyGetUnderlyingCheck = TypedKey.class.getMethod(\"underlying\");\n+      } catch (final NoSuchMethodException ignored) {\n+      }\n+    }\n+    typedKeyGetUnderlying = typedKeyGetUnderlyingCheck;\n+  }", "originalCommit": "f20bf9c031744bd8ec99335ca93faaacc4c197d8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjE0OTg0OA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1521#discussion_r436149848", "bodyText": "It's definitely subverting it, I think the API of that class is unlikely to remove this method without the class completely changing", "author": "devinsba", "createdAt": "2020-06-05T20:30:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjE0MTU2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQxMzIxNQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1521#discussion_r461413215", "bodyText": "I'm curious why you need all this reflection logic. You should be able to call request.asJava() to convert the request to a Java request, so you can use all the normal Play Java API.\nSo below you could write:\nrequest.asJava().attrs().getOptional(Router.Attrs.HANDLER_DEF).ifPresent(hd -> {\n  span.setTag(DDTags.RESOURCE_NAME, hd.verb() + \" \" + hd.path());\n});\nIt's not an immediate issue for me but I was trying to better understand how this integration works.", "author": "gmethvin", "createdAt": "2020-07-28T08:36:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjE0MTU2OQ=="}], "type": "inlineReview", "revised_code": null}]}