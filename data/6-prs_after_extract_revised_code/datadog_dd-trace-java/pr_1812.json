{"pr_number": 1812, "pr_title": "Use alternative weak-keyed map implementations to reduce work done in CommonTaskExecutor", "pr_createdAt": "2020-08-28T16:26:24Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/1812", "timeline": [{"oid": "171ad4cf5b9b747797252b949d8dafaff57a08fc", "url": "https://github.com/DataDog/dd-trace-java/commit/171ad4cf5b9b747797252b949d8dafaff57a08fc", "message": "allow inlining of weak map expunging to avoid background cleaning which persists beyond the usage of the map", "committedDate": "2020-08-28T16:53:40Z", "type": "forcePushed"}, {"oid": "bd0e874556a05073e56b87eaac05b176f26801e9", "url": "https://github.com/DataDog/dd-trace-java/commit/bd0e874556a05073e56b87eaac05b176f26801e9", "message": "allow inlining of weak map expunging to avoid background cleaning which persists beyond the usage of the map", "committedDate": "2020-08-28T17:03:43Z", "type": "forcePushed"}, {"oid": "29dc20d868a73c0c218e33388990361df42bdc1b", "url": "https://github.com/DataDog/dd-trace-java/commit/29dc20d868a73c0c218e33388990361df42bdc1b", "message": "allow inlining of weak map expunging to avoid background cleaning which persists beyond the usage of the map", "committedDate": "2020-08-28T17:34:53Z", "type": "forcePushed"}, {"oid": "f094977b2d70b527ee4d661ae458c33095d7e8ef", "url": "https://github.com/DataDog/dd-trace-java/commit/f094977b2d70b527ee4d661ae458c33095d7e8ef", "message": "expunge on background threads", "committedDate": "2020-08-28T18:35:27Z", "type": "forcePushed"}, {"oid": "f42745481efe535bd3cbeed48f63f094abba66b0", "url": "https://github.com/DataDog/dd-trace-java/commit/f42745481efe535bd3cbeed48f63f094abba66b0", "message": "allow inlining of weak map expunging to avoid background cleaning which persists beyond the usage of the map", "committedDate": "2020-08-28T18:40:12Z", "type": "forcePushed"}, {"oid": "ead09a55a1964520bafd96b1892ed49e31ea3ee0", "url": "https://github.com/DataDog/dd-trace-java/commit/ead09a55a1964520bafd96b1892ed49e31ea3ee0", "message": "use synchronized wrapper around WeakHashMap in HelperInjector to avoid background cleaning of WeakConcurrentHashMap which persists beyond the usage of the map, use ClassValue instead of WeakMap in JAX-RS instrumentations", "committedDate": "2020-08-28T21:25:43Z", "type": "commit"}, {"oid": "ead09a55a1964520bafd96b1892ed49e31ea3ee0", "url": "https://github.com/DataDog/dd-trace-java/commit/ead09a55a1964520bafd96b1892ed49e31ea3ee0", "message": "use synchronized wrapper around WeakHashMap in HelperInjector to avoid background cleaning of WeakConcurrentHashMap which persists beyond the usage of the map, use ClassValue instead of WeakMap in JAX-RS instrumentations", "committedDate": "2020-08-28T21:25:43Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDE4NzcwMw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1812#discussion_r480187703", "bodyText": "I believe that WeakHashMap is still doing expungeStaleEntries() inline.  If that's the case, is it still better to use that instead of WeakConcurrentMap?", "author": "tylerbenson", "createdAt": "2020-08-31T14:57:56Z", "path": "dd-java-agent/agent-tooling/src/main/java/datadog/trace/agent/tooling/HelperInjector.java", "diffHunk": "@@ -44,7 +43,8 @@ public String toString() {\n   private final Set<String> helperClassNames;\n   private final Map<String, byte[]> dynamicTypeMap = new LinkedHashMap<>();\n \n-  private final WeakMap<ClassLoader, Boolean> injectedClassLoaders = newWeakMap();\n+  private final Map<ClassLoader, Boolean> injectedClassLoaders =\n+      Collections.synchronizedMap(new WeakHashMap<ClassLoader, Boolean>());", "originalCommit": "ead09a55a1964520bafd96b1892ed49e31ea3ee0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDMwNTU3NQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1812#discussion_r480305575", "bodyText": "Yes, it does, whenever getTable() is called.\nHowever, this question suggests that you may not have understood what I'm trying to achieve here. We have hundreds of background tasks executed once per second, because we use a WeakMap implementation with a \"background\" cleanup policy. These background tasks continue until the application shuts down, but the injectedClassLoaders map may never actually be used, and even if it is, its usefulness is short-lived and concentrated at the start of the application's life. To reduce the total cost of these maps' existence, increasing the costs of access (if the map is ever used) would make sense, but there's no evidence a synchronized wrapper around a WeakHashMap incurs significant (any?) cost over WeakConcurrentMap.", "author": "richardstartin", "createdAt": "2020-08-31T18:20:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDE4NzcwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDM2ODM5NQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1812#discussion_r480368395", "bodyText": "I understand what you're trying to achieve here.  I just didn't understand why you chose this option vs the inline WeakConcurrentMap.  That said, I don't disagree with your choice.\nAs for why the tests are failing, I'm not sure.  I can look into it.  Is it easy to reproduce if I run locally?", "author": "tylerbenson", "createdAt": "2020-08-31T20:03:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDE4NzcwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDM3OTkyMQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1812#discussion_r480379921", "bodyText": "The motivation is for this to be completely independent of the (quite complex) provision mechanism. I don't expect there to be any contention on injectedClassLoaders and the wrapper is there as an insurance policy against multithreaded use, so I don't expect to get anything in return for using WeakConcurrentMap here. I found the changes necessary to support multiple WeakMap implementations broke the test suite mysteriously, in exactly the same way this commit does. (This is my second attempt at getting rid of these background tasks).\nTo reproduce, run\n./gradlew :dd-java-agent:test --stacktrace\n\nIt will time out after 120s and probably give you as much information about why as can be seen here: none whatsoever :(", "author": "richardstartin", "createdAt": "2020-08-31T20:26:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDE4NzcwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDM5NTcyNw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1812#discussion_r480395727", "bodyText": "I was reduced to putting System.err.printlns into CoreTracer's constructor - PendingTrace.initialize() hangs. It seems PendingTrace relies on HelperInjector to initialise the background clean up, I'd need to take a thread dump to check if it's deadlocked somehow, but that's a task for tomorrow.\nI wonder why the author of this comment in CoreTracer  just before initializing PendingTrace wrote this comment:\n    // Ensure that PendingTrace.SPAN_CLEANER is initialized in this thread:\n    // FIXME: add test to verify the span cleaner thread is started with this call.\n    PendingTrace.initialize();", "author": "richardstartin", "createdAt": "2020-08-31T20:59:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDE4NzcwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQwNjcxNg==", "url": "https://github.com/DataDog/dd-trace-java/pull/1812#discussion_r480406716", "bodyText": "Check out my latest commit", "author": "richardstartin", "createdAt": "2020-08-31T21:23:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDE4NzcwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQyODAwNA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1812#discussion_r480428004", "bodyText": "Hmm, seems like we have a lot of brittleness in our initialization order.\nI'd expect the first job to always start-up the background thread regardless of which job it is & order.  From a maintenance perspective, it seems like a pretty serious design flaw to be relying on something else to start the pool.\nThis looks a nice improvement.  Although, I'm wondering if we don't need to just take a hard look at our initialization in general.", "author": "dougqh", "createdAt": "2020-08-31T22:12:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDE4NzcwMw=="}], "type": "inlineReview", "revised_code": null}, {"oid": "2a4b59386aa8a917bd480b60c7f38308dd61e05e", "url": "https://github.com/DataDog/dd-trace-java/commit/2a4b59386aa8a917bd480b60c7f38308dd61e05e", "message": "Prevent PendingTrace.initialize From Hanging With This One Weird Trick", "committedDate": "2020-08-31T21:21:53Z", "type": "commit"}]}