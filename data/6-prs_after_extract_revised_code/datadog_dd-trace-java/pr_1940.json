{"pr_number": 1940, "pr_title": "Added CI/Git information to test spans for CI providers", "pr_createdAt": "2020-10-01T15:33:23Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/1940", "timeline": [{"oid": "d45d49d4f749ac977ff50d1d50bb4bc1197c264d", "url": "https://github.com/DataDog/dd-trace-java/commit/d45d49d4f749ac977ff50d1d50bb4bc1197c264d", "message": "Add CI providers information for Test spans", "committedDate": "2020-10-02T07:07:54Z", "type": "commit"}, {"oid": "d45d49d4f749ac977ff50d1d50bb4bc1197c264d", "url": "https://github.com/DataDog/dd-trace-java/commit/d45d49d4f749ac977ff50d1d50bb4bc1197c264d", "message": "Add CI providers information for Test spans", "committedDate": "2020-10-02T07:07:54Z", "type": "forcePushed"}, {"oid": "e676aee2054c16bb35f545de46c9759cea86260a", "url": "https://github.com/DataDog/dd-trace-java/commit/e676aee2054c16bb35f545de46c9759cea86260a", "message": "Use setSpanType", "committedDate": "2020-10-02T07:11:00Z", "type": "commit"}, {"oid": "7548823e4c6b6c3aa4a560240b315dfcfe0f729b", "url": "https://github.com/DataDog/dd-trace-java/commit/7548823e4c6b6c3aa4a560240b315dfcfe0f729b", "message": "Remove unnecesary blank lines", "committedDate": "2020-10-02T07:42:31Z", "type": "commit"}, {"oid": "b9e29073eea9089eee89df8d405bf8c2628523c7", "url": "https://github.com/DataDog/dd-trace-java/commit/b9e29073eea9089eee89df8d405bf8c2628523c7", "message": "Clear discriminant CI env vars on test setup for TestDecoratorTest", "committedDate": "2020-10-02T07:58:32Z", "type": "commit"}, {"oid": "e78d8eaac18a31905d7c14520ee6be2e753166da", "url": "https://github.com/DataDog/dd-trace-java/commit/e78d8eaac18a31905d7c14520ee6be2e753166da", "message": "Check Test.BUILD_SOURCE_ROOT", "committedDate": "2020-10-02T08:12:11Z", "type": "commit"}, {"oid": "582b2969cd4d016df09efa80571ac3a7ce453987", "url": "https://github.com/DataDog/dd-trace-java/commit/582b2969cd4d016df09efa80571ac3a7ce453987", "message": "Check ci.pipeline.name in tests spans", "committedDate": "2020-10-02T08:28:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODcwODU4NA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1940#discussion_r498708584", "bodyText": "Do you want a hierarchy here instead?", "author": "richardstartin", "createdAt": "2020-10-02T09:16:26Z", "path": "dd-java-agent/agent-bootstrap/src/main/java/datadog/trace/bootstrap/instrumentation/decorator/TestDecorator.java", "diffHunk": "@@ -69,6 +170,20 @@ public TestDecorator() {\n       setJenkinsData();\n     } else if (System.getenv(GITLAB) != null) {\n       setGitLabData();\n+    } else if (System.getenv(TRAVIS) != null) {", "originalCommit": "582b2969cd4d016df09efa80571ac3a7ce453987", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODczMjc0OA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1940#discussion_r498732748", "bodyText": "I think it's fine to have it like this. A hierarchy for CI/Git decorators is too specific for the \"CiApp\" use case, and it will not be reusable for any other case. I'd not create a lot of decorators only for this case, IMHO.", "author": "drodriguezhdez", "createdAt": "2020-10-02T10:08:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODcwODU4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTM3NDE1MA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1940#discussion_r499374150", "bodyText": "I think the code would be easier to read if things were pulled apart a bit, so that you have one abstract CiInformation class that has all the methods that you need to implement, i.e. getProviderName(), getPipelineId et.c., and then have a specific subclass for each provider like gitlab, travis, et.c. As it's written right now, I can't really see if all the setter methods actually set all the fields they should.", "author": "bantonsson", "createdAt": "2020-10-05T06:46:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODcwODU4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTUyMDA3Mg==", "url": "https://github.com/DataDog/dd-trace-java/pull/1940#discussion_r499520072", "bodyText": "Refactored into different CIProviderInfo implementations.", "author": "drodriguezhdez", "createdAt": "2020-10-05T11:12:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODcwODU4NA=="}], "type": "inlineReview", "revised_code": {"commit": "5eb97bc9f1a4a9534f83acbc596a0a90407ab5df", "chunk": "diff --git a/dd-java-agent/agent-bootstrap/src/main/java/datadog/trace/bootstrap/instrumentation/decorator/TestDecorator.java b/dd-java-agent/agent-bootstrap/src/main/java/datadog/trace/bootstrap/instrumentation/decorator/TestDecorator.java\nindex f8b1ccbe8d..bbdd74ee4b 100644\n--- a/dd-java-agent/agent-bootstrap/src/main/java/datadog/trace/bootstrap/instrumentation/decorator/TestDecorator.java\n+++ b/dd-java-agent/agent-bootstrap/src/main/java/datadog/trace/bootstrap/instrumentation/decorator/TestDecorator.java\n\n@@ -23,168 +20,36 @@ public abstract class TestDecorator extends BaseDecorator {\n   public static final String TEST_FAIL = \"fail\";\n   public static final String TEST_SKIP = \"skip\";\n \n-  // https://wiki.jenkins.io/display/JENKINS/Building+a+software+project\n-  public static final String JENKINS = \"JENKINS_URL\";\n-  static final String JENKINS_PROVIDER_NAME = \"jenkins\";\n-  static final String JENKINS_PIPELINE_ID = \"BUILD_TAG\";\n-  static final String JENKINS_PIPELINE_NUMBER = \"BUILD_NUMBER\";\n-  static final String JENKINS_PIPELINE_URL = \"BUILD_URL\";\n-  static final String JENKINS_PIPELINE_NAME = \"JOB_NAME\";\n-  static final String JENKINS_JOB_URL = \"JOB_URL\";\n-  static final String JENKINS_WORKSPACE_PATH = \"WORKSPACE\";\n-  static final String JENKINS_GIT_REPOSITORY_URL = \"GIT_URL\";\n-  static final String JENKINS_GIT_COMMIT = \"GIT_COMMIT\";\n-  static final String JENKINS_GIT_BRANCH = \"GIT_BRANCH\";\n-\n-  // https://docs.gitlab.com/ee/ci/variables/predefined_variables.html\n-  public static final String GITLAB = \"GITLAB_CI\";\n-  static final String GITLAB_PROVIDER_NAME = \"gitlab\";\n-  static final String GITLAB_PIPELINE_ID = \"CI_PIPELINE_ID\";\n-  static final String GITLAB_PIPELINE_NAME = \"CI_PROJECT_PATH\";\n-  static final String GITLAB_PIPELINE_NUMBER = \"CI_PIPELINE_IID\";\n-  static final String GITLAB_PIPELINE_URL = \"CI_PIPELINE_URL\";\n-  static final String GITLAB_JOB_URL = \"CI_JOB_URL\";\n-  static final String GITLAB_WORKSPACE_PATH = \"CI_PROJECT_DIR\";\n-  static final String GITLAB_GIT_REPOSITORY_URL = \"CI_REPOSITORY_URL\";\n-  static final String GITLAB_GIT_COMMIT = \"CI_COMMIT_SHA\";\n-  static final String GITLAB_GIT_BRANCH = \"CI_COMMIT_BRANCH\";\n-  static final String GITLAB_GIT_TAG = \"CI_COMMIT_TAG\";\n-\n-  // https://docs.travis-ci.com/user/environment-variables/#default-environment-variables\n-  public static final String TRAVIS = \"TRAVIS\";\n-  static final String TRAVIS_PROVIDER_NAME = \"travisci\";\n-  static final String TRAVIS_PIPELINE_ID = \"TRAVIS_BUILD_ID\";\n-  static final String TRAVIS_PIPELINE_NUMBER = \"TRAVIS_BUILD_NUMBER\";\n-  static final String TRAVIS_PIPELINE_URL = \"TRAVIS_BUILD_WEB_URL\";\n-  static final String TRAVIS_JOB_URL = \"TRAVIS_JOB_WEB_URL\";\n-  static final String TRAVIS_WORKSPACE_PATH = \"TRAVIS_BUILD_DIR\";\n-  static final String TRAVIS_REPOSITORY_SLUG = \"TRAVIS_REPO_SLUG\";\n-  static final String TRAVIS_PR_REPOSITORY_SLUG = \"TRAVIS_PULL_REQUEST_SLUG\";\n-  static final String TRAVIS_GIT_COMMIT = \"TRAVIS_COMMIT\";\n-  static final String TRAVIS_GIT_PR_BRANCH = \"TRAVIS_PULL_REQUEST_BRANCH\";\n-  static final String TRAVIS_GIT_BRANCH = \"TRAVIS_BRANCH\";\n-  static final String TRAVIS_GIT_TAG = \"TRAVIS_TAG\";\n-\n-  // https://circleci.com/docs/2.0/env-vars/#built-in-environment-variables\n-  public static final String CIRCLECI = \"CIRCLECI\";\n-  static final String CIRCLECI_PROVIDER_NAME = \"circleci\";\n-  static final String CIRCLECI_PIPELINE_ID = \"CIRCLE_WORKFLOW_ID\";\n-  static final String CIRCLECI_PIPELINE_NAME = \"CIRCLE_PROJECT_REPONAME\";\n-  static final String CIRCLECI_PIPELINE_NUMBER = \"CIRCLE_BUILD_NUM\";\n-  static final String CIRCLECI_BUILD_URL = \"CIRCLE_BUILD_URL\";\n-  static final String CIRCLECI_WORKSPACE_PATH = \"CIRCLE_WORKING_DIRECTORY\";\n-  static final String CIRCLECI_GIT_REPOSITORY_URL = \"CIRCLE_REPOSITORY_URL\";\n-  static final String CIRCLECI_GIT_COMMIT = \"CIRCLE_SHA1\";\n-  static final String CIRCLECI_GIT_BRANCH = \"CIRCLE_BRANCH\";\n-  static final String CIRCLECI_GIT_TAG = \"CIRCLE_TAG\";\n-\n-  // https://www.appveyor.com/docs/environment-variables/\n-  public static final String APPVEYOR = \"APPVEYOR\";\n-  static final String APPVEYOR_PROVIDER_NAME = \"appveyor\";\n-  static final String APPVEYOR_BUILD_ID = \"APPVEYOR_BUILD_ID\";\n-  static final String APPVEYOR_REPO_NAME = \"APPVEYOR_REPO_NAME\";\n-  static final String APPVEYOR_PIPELINE_NUMBER = \"APPVEYOR_BUILD_NUMBER\";\n-  static final String APPVEYOR_WORKSPACE_PATH = \"APPVEYOR_BUILD_FOLDER\";\n-  static final String APPVEYOR_REPO_PROVIDER = \"APPVEYOR_REPO_PROVIDER\";\n-  static final String APPVEYOR_REPO_COMMIT = \"APPVEYOR_REPO_COMMIT\";\n-  static final String APPVEYOR_REPO_BRANCH = \"APPVEYOR_REPO_BRANCH\";\n-  static final String APPVEYOR_PULL_REQUEST_HEAD_REPO_BRANCH =\n-      \"APPVEYOR_PULL_REQUEST_HEAD_REPO_BRANCH\";\n-  static final String APPVEYOR_REPO_TAG_NAME = \"APPVEYOR_REPO_TAG_NAME\";\n-\n-  // https://docs.microsoft.com/en-us/azure/devops/pipelines/build/variables?view=azure-devops\n-  public static final String AZURE = \"TF_BUILD\";\n-  static final String AZURE_PROVIDER_NAME = \"azurepipelines\";\n-  static final String AZURE_PIPELINE_NAME = \"BUILD_DEFINITIONNAME\";\n-  static final String AZURE_PIPELINE_NUMBER = \"BUILD_BUILDNUMBER\";\n-  static final String AZURE_SYSTEM_TEAMFOUNDATIONSERVERURI = \"SYSTEM_TEAMFOUNDATIONSERVERURI\";\n-  static final String AZURE_SYSTEM_TEAMPROJECT = \"SYSTEM_TEAMPROJECT\";\n-  static final String AZURE_BUILD_BUILDID = \"BUILD_BUILDID\";\n-  static final String AZURE_SYSTEM_JOBID = \"SYSTEM_JOBID\";\n-  static final String AZURE_SYSTEM_TASKINSTANCEID = \"SYSTEM_TASKINSTANCEID\";\n-  static final String AZURE_WORKSPACE_PATH = \"BUILD_SOURCESDIRECTORY\";\n-  static final String AZURE_SYSTEM_PULLREQUEST_SOURCEREPOSITORYURI =\n-      \"SYSTEM_PULLREQUEST_SOURCEREPOSITORYURI\";\n-  static final String AZURE_BUILD_REPOSITORY_URI = \"BUILD_REPOSITORY_URI\";\n-  static final String AZURE_SYSTEM_PULLREQUEST_SOURCECOMMITID = \"SYSTEM_PULLREQUEST_SOURCECOMMITID\";\n-  static final String AZURE_BUILD_SOURCEVERSION = \"BUILD_SOURCEVERSION\";\n-  static final String AZURE_SYSTEM_PULLREQUEST_SOURCEBRANCH = \"SYSTEM_PULLREQUEST_SOURCEBRANCH\";\n-  static final String AZURE_BUILD_SOURCEBRANCH = \"BUILD_SOURCEBRANCH\";\n-\n-  // https://support.atlassian.com/bitbucket-cloud/docs/variables-and-secrets/\n-  public static final String BITBUCKET = \"BITBUCKET_COMMIT\";\n-  static final String BITBUCKET_PROVIDER_NAME = \"bitbucket\";\n-  static final String BITBUCKET_PIPELINE_ID = \"BITBUCKET_PIPELINE_UUID\";\n-  static final String BITBUCKET_REPO_FULL_NAME = \"BITBUCKET_REPO_FULL_NAME\";\n-  static final String BITBUCKET_BUILD_NUMBER = \"BITBUCKET_BUILD_NUMBER\";\n-  static final String BITBUCKET_WORKSPACE_PATH = \"BITBUCKET_CLONE_DIR\";\n-  static final String BITBUCKET_GIT_REPOSITORY_URL = \"BITBUCKET_GIT_SSH_ORIGIN\";\n-  static final String BITBUCKET_GIT_COMMIT = \"BITBUCKET_COMMIT\";\n-  static final String BITBUCKET_GIT_BRANCH = \"BITBUCKET_BRANCH\";\n-  static final String BITBUCKET_GIT_TAG = \"BITBUCKET_TAG\";\n-\n-  // https://docs.github.com/en/free-pro-team@latest/actions/reference/environment-variables#default-environment-variables\n-  public static final String GHACTIONS = \"GITHUB_ACTION\";\n-  static final String GHACTIONS_PROVIDER_NAME = \"github\";\n-  static final String GHACTIONS_PIPELINE_ID = \"GITHUB_RUN_ID\";\n-  static final String GHACTIONS_PIPELINE_NAME = \"GITHUB_WORKFLOW\";\n-  static final String GHACTIONS_PIPELINE_NUMBER = \"GITHUB_RUN_NUMBER\";\n-  static final String GHACTIONS_WORKSPACE_PATH = \"GITHUB_WORKSPACE\";\n-  static final String GHACTIONS_REPOSITORY = \"GITHUB_REPOSITORY\";\n-  static final String GHACTIONS_SHA = \"GITHUB_SHA\";\n-  static final String GHACTIONS_HEAD_REF = \"GITHUB_HEAD_REF\";\n-  static final String GHACTIONS_REF = \"GITHUB_REF\";\n-\n-  // https://buildkite.com/docs/pipelines/environment-variables\n-  public static final String BUILDKITE = \"BUILDKITE\";\n-  static final String BUILDKITE_PROVIDER_NAME = \"buildkite\";\n-  static final String BUILDKITE_PIPELINE_ID = \"BUILDKITE_BUILD_ID\";\n-  static final String BUILDKITE_PIPELINE_NAME = \"BUILDKITE_PIPELINE_SLUG\";\n-  static final String BUILDKITE_PIPELINE_NUMBER = \"BUILDKITE_BUILD_NUMBER\";\n-  static final String BUILDKITE_BUILD_URL = \"BUILDKITE_BUILD_URL\";\n-  static final String BUILDKITE_JOB_ID = \"BUILDKITE_JOB_ID\";\n-  static final String BUILDKITE_WORKSPACE_PATH = \"BUILDKITE_BUILD_CHECKOUT_PATH\";\n-  static final String BUILDKITE_GIT_REPOSITORY_URL = \"BUILDKITE_REPO\";\n-  static final String BUILDKITE_GIT_COMMIT = \"BUILDKITE_COMMIT\";\n-  static final String BUILDKITE_GIT_BRANCH = \"BUILDKITE_BRANCH\";\n-  static final String BUILDKITE_GIT_TAG = \"BUILDKITE_TAG\";\n-\n-  @Getter private boolean isCI;\n-  @Getter private String ciProviderName;\n-  @Getter private String ciPipelineId;\n-  @Getter private String ciPipelineName;\n-  @Getter private String ciPipelineNumber;\n-  @Getter private String ciPipelineUrl;\n-  @Getter private String ciJobUrl;\n-  @Getter private String ciWorkspacePath;\n-  @Getter private String gitRepositoryUrl;\n-  @Getter private String gitCommit;\n-  @Getter private String gitBranch;\n-  @Getter private String gitTag;\n+  @Getter private final boolean isCI;\n+  @Getter private final String ciProviderName;\n+  @Getter private final String ciPipelineId;\n+  @Getter private final String ciPipelineName;\n+  @Getter private final String ciPipelineNumber;\n+  @Getter private final String ciPipelineUrl;\n+  @Getter private final String ciJobUrl;\n+  @Getter private final String ciWorkspacePath;\n+  @Getter private final String gitRepositoryUrl;\n+  @Getter private final String gitCommit;\n+  @Getter private final String gitBranch;\n+  @Getter private final String gitTag;\n \n   public TestDecorator() {\n-    // CI and Git information is obtained\n-    // from different environment variables\n-    // depending on which CI server is running the build.\n-    if (System.getenv(JENKINS) != null) {\n-      setJenkinsData();\n-    } else if (System.getenv(GITLAB) != null) {\n-      setGitLabData();\n-    } else if (System.getenv(TRAVIS) != null) {\n-      setTravisData();\n-    } else if (System.getenv(CIRCLECI) != null) {\n-      setCircleCIData();\n-    } else if (System.getenv(APPVEYOR) != null) {\n-      setAppveyorData();\n-    } else if (System.getenv(AZURE) != null) {\n-      setAzureData();\n-    } else if (System.getenv(BITBUCKET) != null) {\n-      setBitBucketData();\n-    } else if (System.getenv(GHACTIONS) != null) {\n-      setGHActionsData();\n-    } else if (System.getenv(BUILDKITE) != null) {\n-      setBuildkiteData();\n-    }\n+    this(CIProviderInfo.selectCI());\n+  }\n+\n+  TestDecorator(final CIProviderInfo ciInfo) {\n+    this.isCI = ciInfo.isCI();\n+    this.ciProviderName = ciInfo.getCiProviderName();\n+    this.ciPipelineId = ciInfo.getCiPipelineId();\n+    this.ciPipelineName = ciInfo.getCiPipelineName();\n+    this.ciPipelineNumber = ciInfo.getCiPipelineNumber();\n+    this.ciPipelineUrl = ciInfo.getCiPipelineUrl();\n+    this.ciJobUrl = ciInfo.getCiJobUrl();\n+    this.ciWorkspacePath = ciInfo.getCiWorkspacePath();\n+    this.gitRepositoryUrl = ciInfo.getGitRepositoryUrl();\n+    this.gitCommit = ciInfo.getGitCommit();\n+    this.gitBranch = ciInfo.getGitBranch();\n+    this.gitTag = ciInfo.getGitTag();\n   }\n \n   protected abstract String testFramework();\n"}}, {"oid": "5eb97bc9f1a4a9534f83acbc596a0a90407ab5df", "url": "https://github.com/DataDog/dd-trace-java/commit/5eb97bc9f1a4a9534f83acbc596a0a90407ab5df", "message": "Refactor into CIProviderInfo's", "committedDate": "2020-10-05T11:10:16Z", "type": "commit"}, {"oid": "dbf70c01fab2301c8453ec35178a32a67a64eab3", "url": "https://github.com/DataDog/dd-trace-java/commit/dbf70c01fab2301c8453ec35178a32a67a64eab3", "message": "Fix CodeNarc violations", "committedDate": "2020-10-05T11:22:53Z", "type": "commit"}]}