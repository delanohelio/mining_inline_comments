{"pr_number": 1461, "pr_title": "JMX StackTrace provider", "pr_createdAt": "2020-05-14T12:20:23Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/1461", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTIxMTkwNA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1461#discussion_r425211904", "bodyText": "Coul you please explain why it mutates parameter instead of just returning a new list?", "author": "mar-kolya", "createdAt": "2020-05-14T15:09:03Z", "path": "dd-trace-core/src/main/java/datadog/trace/core/util/ThreadStackProvider.java", "diffHunk": "@@ -0,0 +1,8 @@\n+package datadog.trace.core.util;\n+\n+import java.util.List;\n+import java.util.Set;\n+\n+public interface ThreadStackProvider {\n+  void getStackTrace(Set<Long> threadIds, List<StackTraceElement[]> stackTraces);", "originalCommit": "5be1b2390e5a1bc73913c49a3bc873812ae845cd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTIxNDI0OA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1461#discussion_r425214248", "bodyText": "To let the caller having the choice to allocate or reuse the list (reducing garbage...)", "author": "jpbempel", "createdAt": "2020-05-14T15:12:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTIxMTkwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTI4MTc5Mw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1461#discussion_r425281793", "bodyText": "Overall this seems like a premature optimization considering amount of allocation happening beyond that list. And also this is not a public API so we could potentially change it later if we needed to optimize...\nBut if you strongly feel this is the way to go, could you please:\n\nrename it to fill...\ndocument that it mutates parameter\ndocument that is requires caller to clean up the list before call", "author": "mar-kolya", "createdAt": "2020-05-14T16:43:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTIxMTkwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTYzOTIxMA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1461#discussion_r425639210", "bodyText": "I agree with @mar-kolya here.\nUnfortunately, the number of stack frames is not fixed so the list will need to be resized from time to time. Also, it needs to be cleared after use which basically makes all objects originally contained by this list eligible for GC unless they are referenced from elsewhere. So we could save some allocations of the underlying array if we are lucky and don't need a lot of resizing. Would be good to measure the effect before an attempt to optimize this.", "author": "jbachorik", "createdAt": "2020-05-15T08:14:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTIxMTkwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTY0NDQ3OQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1461#discussion_r425644479", "bodyText": "The list depends on the number of the threads not the depth of the stacks which are arrays of StrackTraceElement.\nThis is not an optimization, but an api design that allow flexibility on how to deal with object lifecycle and does not enforce the fact that we need to allocate an object to return the requested information.\nHowever I will change to comply to your comments.", "author": "jpbempel", "createdAt": "2020-05-15T08:24:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTIxMTkwNA=="}], "type": "inlineReview", "revised_code": {"commit": "c58596a39e41ab7732882cb3833cd31542376703", "chunk": "diff --git a/dd-trace-core/src/main/java/datadog/trace/core/util/ThreadStackProvider.java b/dd-trace-core/src/main/java/datadog/trace/core/util/ThreadStackProvider.java\nindex 0d8c7961b5..7c5c27e86b 100644\n--- a/dd-trace-core/src/main/java/datadog/trace/core/util/ThreadStackProvider.java\n+++ b/dd-trace-core/src/main/java/datadog/trace/core/util/ThreadStackProvider.java\n\n@@ -4,5 +4,5 @@ import java.util.List;\n import java.util.Set;\n \n public interface ThreadStackProvider {\n-  void getStackTrace(Set<Long> threadIds, List<StackTraceElement[]> stackTraces);\n+  List<StackTraceElement[]> getStackTrace(Set<Long> threadIds);\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTIxMjQyMA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1461#discussion_r425212420", "bodyText": "Why to just use toArray?", "author": "mar-kolya", "createdAt": "2020-05-14T15:09:42Z", "path": "dd-trace-core/src/main/java/datadog/trace/core/util/JmxThreadStackProvider.java", "diffHunk": "@@ -0,0 +1,27 @@\n+package datadog.trace.core.util;\n+\n+import java.lang.management.ManagementFactory;\n+import java.lang.management.ThreadInfo;\n+import java.lang.management.ThreadMXBean;\n+import java.util.List;\n+import java.util.Set;\n+\n+public class JmxThreadStackProvider implements ThreadStackProvider {\n+  private final ThreadMXBean threadMXBean = ManagementFactory.getThreadMXBean();\n+\n+  public static final ThreadStackProvider INSTANCE = new JmxThreadStackProvider();\n+\n+  @Override\n+  public void getStackTrace(Set<Long> threadIds, List<StackTraceElement[]> stackTraces) {\n+    long[] ids = new long[threadIds.size()];\n+    int idx = 0;\n+    for (Long id : threadIds) {\n+      ids[idx] = id;\n+      idx++;\n+    }", "originalCommit": "5be1b2390e5a1bc73913c49a3bc873812ae845cd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTIxODkxOQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1461#discussion_r425218919", "bodyText": "because toArray does not return a primitive array", "author": "jpbempel", "createdAt": "2020-05-14T15:18:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTIxMjQyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTI3NDU3Mg==", "url": "https://github.com/DataDog/dd-trace-java/pull/1461#discussion_r425274572", "bodyText": "ah, ok, and we cannot use streams I guess.", "author": "mar-kolya", "createdAt": "2020-05-14T16:32:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTIxMjQyMA=="}], "type": "inlineReview", "revised_code": {"commit": "c58596a39e41ab7732882cb3833cd31542376703", "chunk": "diff --git a/dd-trace-core/src/main/java/datadog/trace/core/util/JmxThreadStackProvider.java b/dd-trace-core/src/main/java/datadog/trace/core/util/JmxThreadStackProvider.java\nindex 7fcab89223..2ae354284a 100644\n--- a/dd-trace-core/src/main/java/datadog/trace/core/util/JmxThreadStackProvider.java\n+++ b/dd-trace-core/src/main/java/datadog/trace/core/util/JmxThreadStackProvider.java\n\n@@ -3,6 +3,8 @@ package datadog.trace.core.util;\n import java.lang.management.ManagementFactory;\n import java.lang.management.ThreadInfo;\n import java.lang.management.ThreadMXBean;\n+import java.util.ArrayList;\n+import java.util.Collections;\n import java.util.List;\n import java.util.Set;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTIxMzc1Mg==", "url": "https://github.com/DataDog/dd-trace-java/pull/1461#discussion_r425213752", "bodyText": "FWIW: if you didn't have this static instance the whole class could be GCed once real thing is loaded...", "author": "mar-kolya", "createdAt": "2020-05-14T15:11:25Z", "path": "dd-trace-core/src/main/java/datadog/trace/core/util/NoneThreadStackProvider.java", "diffHunk": "@@ -0,0 +1,12 @@\n+package datadog.trace.core.util;\n+\n+import java.util.List;\n+import java.util.Set;\n+\n+public class NoneThreadStackProvider implements ThreadStackProvider {\n+\n+  public static final ThreadStackProvider INSTANCE = new NoneThreadStackProvider();", "originalCommit": "5be1b2390e5a1bc73913c49a3bc873812ae845cd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTIzMjM0NQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1461#discussion_r425232345", "bodyText": "true", "author": "jpbempel", "createdAt": "2020-05-14T15:35:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTIxMzc1Mg=="}], "type": "inlineReview", "revised_code": {"commit": "9dbb380ce165e7541cf0091a7c33844427893f17", "chunk": "diff --git a/dd-trace-core/src/main/java/datadog/trace/core/util/NoneThreadStackProvider.java b/dd-trace-core/src/main/java/datadog/trace/core/util/NoneThreadStackProvider.java\nindex 29c41abd1f..d14537eaa3 100644\n--- a/dd-trace-core/src/main/java/datadog/trace/core/util/NoneThreadStackProvider.java\n+++ b/dd-trace-core/src/main/java/datadog/trace/core/util/NoneThreadStackProvider.java\n\n@@ -5,8 +5,6 @@ import java.util.Set;\n \n public class NoneThreadStackProvider implements ThreadStackProvider {\n \n-  public static final ThreadStackProvider INSTANCE = new NoneThreadStackProvider();\n-\n   @Override\n   public void getStackTrace(Set<Long> threadIds, List<StackTraceElement[]> stackTraces) {}\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTk1NjQ4NQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1461#discussion_r425956485", "bodyText": "I have a concern about this API . We can have 2 different Sets with all same elements, but iteration order over these elements will be different.  As a result of this method, we can have a list with stack traces ordered in a different way for equal Sets. So, it requires user of this API strictly rely on iteration order of the set which we pass as an argument. Moreover, there is no guarantee, that iteration by one iterator will return the same order for another iterator for some instance of Set. It means even having the same instance of the Set, we won't necessarily be able to understand which stacktrace correspond to which thread ID.", "author": "lpriima", "createdAt": "2020-05-15T17:48:41Z", "path": "dd-trace-core/src/main/java/datadog/trace/core/util/ThreadStackProvider.java", "diffHunk": "@@ -0,0 +1,8 @@\n+package datadog.trace.core.util;\n+\n+import java.util.List;\n+import java.util.Set;\n+\n+public interface ThreadStackProvider {\n+  List<StackTraceElement[]> getStackTrace(Set<Long> threadIds);", "originalCommit": "94f81182900741c55a27989264581a721de87951", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTk1OTc1NA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1461#discussion_r425959754", "bodyText": "true, good catch", "author": "jpbempel", "createdAt": "2020-05-15T17:55:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTk1NjQ4NQ=="}], "type": "inlineReview", "revised_code": {"commit": "a6b1fbd8aa45729d832bf14c48ef935fd896f213", "chunk": "diff --git a/dd-trace-core/src/main/java/datadog/trace/core/util/ThreadStackProvider.java b/dd-trace-core/src/main/java/datadog/trace/core/util/ThreadStackProvider.java\nindex 7c5c27e86b..0d8c7961b5 100644\n--- a/dd-trace-core/src/main/java/datadog/trace/core/util/ThreadStackProvider.java\n+++ b/dd-trace-core/src/main/java/datadog/trace/core/util/ThreadStackProvider.java\n\n@@ -4,5 +4,5 @@ import java.util.List;\n import java.util.Set;\n \n public interface ThreadStackProvider {\n-  List<StackTraceElement[]> getStackTrace(Set<Long> threadIds);\n+  void getStackTrace(Set<Long> threadIds, List<StackTraceElement[]> stackTraces);\n }\n"}}, {"oid": "a6b1fbd8aa45729d832bf14c48ef935fd896f213", "url": "https://github.com/DataDog/dd-trace-java/commit/a6b1fbd8aa45729d832bf14c48ef935fd896f213", "message": "JMX StackTrace provider\n\nprovides a safe way to access stacktraces through JMX getThreadInfo\ncall", "committedDate": "2020-05-15T17:55:55Z", "type": "commit"}, {"oid": "9dbb380ce165e7541cf0091a7c33844427893f17", "url": "https://github.com/DataDog/dd-trace-java/commit/9dbb380ce165e7541cf0091a7c33844427893f17", "message": "remove static None instance", "committedDate": "2020-05-15T17:55:55Z", "type": "commit"}, {"oid": "c58596a39e41ab7732882cb3833cd31542376703", "url": "https://github.com/DataDog/dd-trace-java/commit/c58596a39e41ab7732882cb3833cd31542376703", "message": "Change provider signature\n\nadd test", "committedDate": "2020-05-15T17:55:55Z", "type": "commit"}, {"oid": "d983c2e392d583d811a84ddc012bc210d4d50bf2", "url": "https://github.com/DataDog/dd-trace-java/commit/d983c2e392d583d811a84ddc012bc210d4d50bf2", "message": "Change Set to list", "committedDate": "2020-05-15T18:01:58Z", "type": "commit"}, {"oid": "d983c2e392d583d811a84ddc012bc210d4d50bf2", "url": "https://github.com/DataDog/dd-trace-java/commit/d983c2e392d583d811a84ddc012bc210d4d50bf2", "message": "Change Set to list", "committedDate": "2020-05-15T18:01:58Z", "type": "forcePushed"}]}