{"pr_number": 1898, "pr_title": " Sort traces within ListWriter by start time before asserting", "pr_createdAt": "2020-09-22T18:30:06Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/1898", "timeline": [{"oid": "c5062c4b2322780ff118662b52b77aaa3b39ebe6", "url": "https://github.com/DataDog/dd-trace-java/commit/c5062c4b2322780ff118662b52b77aaa3b39ebe6", "message": "Sort traces within ListWriter by start time before asserting\n\nUses the `PendingTrace.startNanoTicks` to provide the greatest precision.", "committedDate": "2020-09-23T14:55:18Z", "type": "commit"}, {"oid": "df04e09c0521b591132fd2824251b13ab71acefc", "url": "https://github.com/DataDog/dd-trace-java/commit/df04e09c0521b591132fd2824251b13ab71acefc", "message": "Remove indexes from trace and span assert declaration\n\nInstead rely strictly on declaration order.", "committedDate": "2020-09-23T14:55:18Z", "type": "commit"}, {"oid": "cc93defac2cdebda9c9e1d06a0a47b86c32fc5cc", "url": "https://github.com/DataDog/dd-trace-java/commit/cc93defac2cdebda9c9e1d06a0a47b86c32fc5cc", "message": "Apply Idea formatting to various groovy files", "committedDate": "2020-09-23T14:55:18Z", "type": "commit"}, {"oid": "d613eab18796850fb8d38576272d83a03a17f166", "url": "https://github.com/DataDog/dd-trace-java/commit/d613eab18796850fb8d38576272d83a03a17f166", "message": "Apply reordering and index removal to tests\n\nIncluding removal of various methods attempting to resort the trace list.", "committedDate": "2020-09-23T14:55:18Z", "type": "commit"}, {"oid": "142dd79d98bc4353cc87b2297c5797227d116b5a", "url": "https://github.com/DataDog/dd-trace-java/commit/142dd79d98bc4353cc87b2297c5797227d116b5a", "message": "Improve Couchbase test cleanup", "committedDate": "2020-09-23T14:55:18Z", "type": "commit"}, {"oid": "142dd79d98bc4353cc87b2297c5797227d116b5a", "url": "https://github.com/DataDog/dd-trace-java/commit/142dd79d98bc4353cc87b2297c5797227d116b5a", "message": "Improve Couchbase test cleanup", "committedDate": "2020-09-23T14:55:18Z", "type": "forcePushed"}, {"oid": "9aca31b6f572ce41efc5630ecdfbae3635a833e1", "url": "https://github.com/DataDog/dd-trace-java/commit/9aca31b6f572ce41efc5630ecdfbae3635a833e1", "message": "Fix for Java 7", "committedDate": "2020-09-23T15:44:03Z", "type": "commit"}, {"oid": "b211260cb296660e9b69fee0fd5ee181fcd22b47", "url": "https://github.com/DataDog/dd-trace-java/commit/b211260cb296660e9b69fee0fd5ee181fcd22b47", "message": "Increase test timeout", "committedDate": "2020-09-23T16:00:49Z", "type": "commit"}, {"oid": "49859a02adf948b237659eab3d92ede2022d7f80", "url": "https://github.com/DataDog/dd-trace-java/commit/49859a02adf948b237659eab3d92ede2022d7f80", "message": "jacoco should ignore new test assert classes\n\nWe should probably add proper tests for these at some point.", "committedDate": "2020-09-23T16:06:40Z", "type": "commit"}, {"oid": "08d489f8c3833644f4ba0c3d644abe7242b0f0e6", "url": "https://github.com/DataDog/dd-trace-java/commit/08d489f8c3833644f4ba0c3d644abe7242b0f0e6", "message": "Ignore additional traces from Spring JMS Listener test.", "committedDate": "2020-09-23T17:04:26Z", "type": "commit"}, {"oid": "89425ac977054113e26630255b54d5ae50e1a2e3", "url": "https://github.com/DataDog/dd-trace-java/commit/89425ac977054113e26630255b54d5ae50e1a2e3", "message": "Make elasticsearch cleanup more reliable", "committedDate": "2020-09-23T18:29:16Z", "type": "commit"}, {"oid": "89425ac977054113e26630255b54d5ae50e1a2e3", "url": "https://github.com/DataDog/dd-trace-java/commit/89425ac977054113e26630255b54d5ae50e1a2e3", "message": "Make elasticsearch cleanup more reliable", "committedDate": "2020-09-23T18:29:16Z", "type": "forcePushed"}, {"oid": "70cad5b47a23cfb0ebe257568539a353535b0d90", "url": "https://github.com/DataDog/dd-trace-java/commit/70cad5b47a23cfb0ebe257568539a353535b0d90", "message": "Don't reference specific traces in TEST_WRITER\n\nSince the traces are sorted before asserting, but the change isn't reflected in the TEST_WRITER, we should reference the sorted traces instead.", "committedDate": "2020-09-23T20:24:47Z", "type": "forcePushed"}, {"oid": "c514b5699bcd908cf4f54c550e12625da1c63479", "url": "https://github.com/DataDog/dd-trace-java/commit/c514b5699bcd908cf4f54c550e12625da1c63479", "message": "Add couchbase span sorting", "committedDate": "2020-09-23T20:48:21Z", "type": "forcePushed"}, {"oid": "39163d7e4b2e4dc46f2b63e331698d1f927fd290", "url": "https://github.com/DataDog/dd-trace-java/commit/39163d7e4b2e4dc46f2b63e331698d1f927fd290", "message": "Add couchbase span sorting", "committedDate": "2020-09-23T21:10:01Z", "type": "commit"}, {"oid": "97c8d6285b0b5d49936ce9cb19961a1263cbfd14", "url": "https://github.com/DataDog/dd-trace-java/commit/97c8d6285b0b5d49936ce9cb19961a1263cbfd14", "message": "Don't reference specific traces in TEST_WRITER\n\nSince the traces are sorted before asserting, but the change isn't reflected in the TEST_WRITER, we should reference the sorted traces instead.", "committedDate": "2020-09-23T21:11:53Z", "type": "forcePushed"}, {"oid": "8e2f4e19ea63f887fde1f99c737b575b1d8d0d38", "url": "https://github.com/DataDog/dd-trace-java/commit/8e2f4e19ea63f887fde1f99c737b575b1d8d0d38", "message": "Don't reference specific traces in TEST_WRITER\n\nSince the traces are sorted before asserting, but the change isn't reflected in the TEST_WRITER, we should reference the sorted traces instead.", "committedDate": "2020-09-23T21:38:22Z", "type": "commit"}, {"oid": "bf6de4d7cb6b1d23697004530dee08ad3d48480d", "url": "https://github.com/DataDog/dd-trace-java/commit/bf6de4d7cb6b1d23697004530dee08ad3d48480d", "message": "Fix index of a couple reordered spans", "committedDate": "2020-09-23T22:41:20Z", "type": "commit"}, {"oid": "bf6de4d7cb6b1d23697004530dee08ad3d48480d", "url": "https://github.com/DataDog/dd-trace-java/commit/bf6de4d7cb6b1d23697004530dee08ad3d48480d", "message": "Fix index of a couple reordered spans", "committedDate": "2020-09-23T22:41:20Z", "type": "forcePushed"}, {"oid": "ab417cf00d677dec350f62800f78e7538de5e041", "url": "https://github.com/DataDog/dd-trace-java/commit/ab417cf00d677dec350f62800f78e7538de5e041", "message": "More ES test fixes", "committedDate": "2020-09-24T02:54:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDMwMTE0NQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1898#discussion_r494301145", "bodyText": "should we check this before adding the latch?  maybe even move it into the while condition, ie.\nwhile (!isReported(span)) {\n  // ... add latch and wait...", "author": "mcculls", "createdAt": "2020-09-24T13:07:07Z", "path": "dd-trace-core/src/main/java/datadog/trace/common/writer/ListWriter.java", "diffHunk": "@@ -52,6 +52,32 @@ public void waitForTraces(final int number) throws InterruptedException, Timeout\n     }\n   }\n \n+  public void waitUntilReported(final DDSpan span) throws InterruptedException, TimeoutException {\n+    while (true) {\n+      final CountDownLatch latch = new CountDownLatch(size() + 1);\n+      synchronized (latches) {\n+        latches.add(latch);\n+      }\n+      if (isReported(span)) {", "originalCommit": "ab417cf00d677dec350f62800f78e7538de5e041", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDMxMzgyMQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1898#discussion_r494313821", "bodyText": "The reason I added the latch first is to avoid the risk of a race condition where you check and it's not there, but then it gets added before the latch is added. Would you prefer a double (before and after) isReported check?", "author": "tylerbenson", "createdAt": "2020-09-24T13:25:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDMwMTE0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDMxNzM2MQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1898#discussion_r494317361", "bodyText": "OK, that makes sense", "author": "mcculls", "createdAt": "2020-09-24T13:29:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDMwMTE0NQ=="}], "type": "inlineReview", "revised_code": null}]}