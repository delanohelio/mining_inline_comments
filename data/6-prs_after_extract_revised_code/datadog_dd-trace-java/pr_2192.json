{"pr_number": 2192, "pr_title": "metrics testing and quality improvements", "pr_createdAt": "2020-12-11T12:50:30Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/2192", "timeline": [{"oid": "b4a81b538ede5b37a48343a6c162a32982e632b9", "url": "https://github.com/DataDog/dd-trace-java/commit/b4a81b538ede5b37a48343a6c162a32982e632b9", "message": "verify LRU cache expires aggregates when limit is exceeded", "committedDate": "2020-12-11T11:16:48Z", "type": "commit"}, {"oid": "39578d76ce1373c533f4963fb7620b91762416c1", "url": "https://github.com/DataDog/dd-trace-java/commit/39578d76ce1373c533f4963fb7620b91762416c1", "message": "make histograms final", "committedDate": "2020-12-11T11:19:24Z", "type": "commit"}, {"oid": "10a44f337e4a111cd0b7c34aece5b3d07ab6b555", "url": "https://github.com/DataDog/dd-trace-java/commit/10a44f337e4a111cd0b7c34aece5b3d07ab6b555", "message": "test hit counts include errors, but ok latencies exclude errors", "committedDate": "2020-12-11T11:41:24Z", "type": "commit"}, {"oid": "838afaed3dbb061e39cd6deb6484fe0ec37ce4ba", "url": "https://github.com/DataDog/dd-trace-java/commit/838afaed3dbb061e39cd6deb6484fe0ec37ce4ba", "message": "verify unmeasured top level spans have metrics calculated", "committedDate": "2020-12-11T11:49:52Z", "type": "commit"}, {"oid": "5292e06f405f1bae3e12c3a1fe358ff44a246433", "url": "https://github.com/DataDog/dd-trace-java/commit/5292e06f405f1bae3e12c3a1fe358ff44a246433", "message": "repair dormant integration test", "committedDate": "2020-12-11T11:52:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDkyNTA0NQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/2192#discussion_r540925045", "bodyText": "Within the context of writer.format buffer resizes can be managed", "author": "richardstartin", "createdAt": "2020-12-11T12:51:20Z", "path": "dd-trace-core/src/main/java/datadog/trace/common/metrics/SerializingMetricWriter.java", "diffHunk": "@@ -71,41 +73,58 @@ public void startBucket(int metricCount, long start, long duration) {\n \n   @Override\n   public void add(MetricKey key, AggregateMetric aggregate) {\n-    writer.startMap(10);\n+    writer.format(\n+        new Metric(key, aggregate),", "originalCommit": "11155a8d9f13b631cecada13f7c7c6928f5adab4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "5f8bbeb1c366a21739a251e71364bc396332d631", "url": "https://github.com/DataDog/dd-trace-java/commit/5f8bbeb1c366a21739a251e71364bc396332d631", "message": "add footprint test for aggregates storage, fix bug uncovered in SerializingMetricWriter", "committedDate": "2020-12-11T13:16:46Z", "type": "commit"}, {"oid": "5f8bbeb1c366a21739a251e71364bc396332d631", "url": "https://github.com/DataDog/dd-trace-java/commit/5f8bbeb1c366a21739a251e71364bc396332d631", "message": "add footprint test for aggregates storage, fix bug uncovered in SerializingMetricWriter", "committedDate": "2020-12-11T13:16:46Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTAwNjUyNg==", "url": "https://github.com/DataDog/dd-trace-java/pull/2192#discussion_r541006526", "bodyText": "Oh, sneaky.", "author": "bantonsson", "createdAt": "2020-12-11T14:58:25Z", "path": "dd-trace-core/src/main/java/datadog/trace/common/metrics/Aggregator.java", "diffHunk": "@@ -36,7 +36,7 @@\n     this.writer = writer;\n     this.batchPool = batchPool;\n     this.inbox = inbox;\n-    this.aggregates = new LRUCache<>(maxAggregates, 0.75f, maxAggregates * 4 / 3);\n+    this.aggregates = new LRUCache<>(maxAggregates * 4 / 3, 0.75f, maxAggregates);", "originalCommit": "b4a81b538ede5b37a48343a6c162a32982e632b9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}