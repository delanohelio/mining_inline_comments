{"pr_number": 1569, "pr_title": "Add container id header to profile uploads", "pr_createdAt": "2020-06-10T16:03:42Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/1569", "timeline": [{"oid": "f162d31fc91818beba97e083a9680e914faa133d", "url": "https://github.com/DataDog/dd-trace-java/commit/f162d31fc91818beba97e083a9680e914faa133d", "message": "Add container id header to profile uploads", "committedDate": "2020-06-12T08:55:51Z", "type": "commit"}, {"oid": "f162d31fc91818beba97e083a9680e914faa133d", "url": "https://github.com/DataDog/dd-trace-java/commit/f162d31fc91818beba97e083a9680e914faa133d", "message": "Add container id header to profile uploads", "committedDate": "2020-06-12T08:55:51Z", "type": "forcePushed"}, {"oid": "8513b0f151462a41cbbc5291dd3f03b4f44960c5", "url": "https://github.com/DataDog/dd-trace-java/commit/8513b0f151462a41cbbc5291dd3f03b4f44960c5", "message": "Extract ContainerInfo in shared :utils:container-utils module", "committedDate": "2020-06-12T10:12:05Z", "type": "commit"}, {"oid": "6e703e7d680f24d493bd47ccfb674a310280ef82", "url": "https://github.com/DataDog/dd-trace-java/commit/6e703e7d680f24d493bd47ccfb674a310280ef82", "message": "Improve ContainerInfo coverage to enable check on new module", "committedDate": "2020-06-12T11:06:04Z", "type": "commit"}, {"oid": "6e703e7d680f24d493bd47ccfb674a310280ef82", "url": "https://github.com/DataDog/dd-trace-java/commit/6e703e7d680f24d493bd47ccfb674a310280ef82", "message": "Improve ContainerInfo coverage to enable check on new module", "committedDate": "2020-06-12T11:06:04Z", "type": "forcePushed"}, {"oid": "b2f4b20207da4b61fffa71419f9c84c2c9d47ec8", "url": "https://github.com/DataDog/dd-trace-java/commit/b2f4b20207da4b61fffa71419f9c84c2c9d47ec8", "message": "Add exception for API/ABI break due to ContainerInfo move", "committedDate": "2020-06-12T11:19:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTM4OTIzMA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1569#discussion_r439389230", "bodyText": "Would you be able to use a constant for header name here?", "author": "mar-kolya", "createdAt": "2020-06-12T12:30:26Z", "path": "dd-java-agent/agent-profiling/profiling-uploader/src/test/java/com/datadog/profiling/uploader/ProfileUploaderTest.java", "diffHunk": "@@ -192,6 +192,30 @@ public void testRequestParameters(final String compression)\n     assertArrayEquals(expectedBytes, uploadedBytes);\n   }\n \n+  @Test\n+  public void testRequestWithoutContainerID() throws IOException, InterruptedException {\n+    uploader = new ProfileUploader(config, null);\n+\n+    server.enqueue(new MockResponse().setResponseCode(200));\n+    uploader.upload(RECORDING_TYPE, mockRecordingData(RECORDING_RESOURCE));\n+\n+    final RecordedRequest request = server.takeRequest(5, TimeUnit.SECONDS);\n+    assertNotNull(request);\n+    assertNull(request.getHeader(\"Datadog-Container-ID\"));\n+  }\n+\n+  @Test\n+  public void testRequestWithContainerId() throws IOException, InterruptedException {\n+    uploader = new ProfileUploader(config, \"container-id\");\n+\n+    server.enqueue(new MockResponse().setResponseCode(200));\n+    uploader.upload(RECORDING_TYPE, mockRecordingData(RECORDING_RESOURCE));\n+\n+    final RecordedRequest request = server.takeRequest(5, TimeUnit.SECONDS);\n+    assertNotNull(request);\n+    assertEquals(request.getHeader(\"Datadog-Container-ID\"), \"container-id\");", "originalCommit": "b2f4b20207da4b61fffa71419f9c84c2c9d47ec8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c8d19bf70f99b0d576e3c6bc6a10c907f4484d9f", "chunk": "diff --git a/dd-java-agent/agent-profiling/profiling-uploader/src/test/java/com/datadog/profiling/uploader/ProfileUploaderTest.java b/dd-java-agent/agent-profiling/profiling-uploader/src/test/java/com/datadog/profiling/uploader/ProfileUploaderTest.java\nindex e40c50ca7a..97864b2788 100644\n--- a/dd-java-agent/agent-profiling/profiling-uploader/src/test/java/com/datadog/profiling/uploader/ProfileUploaderTest.java\n+++ b/dd-java-agent/agent-profiling/profiling-uploader/src/test/java/com/datadog/profiling/uploader/ProfileUploaderTest.java\n\n@@ -201,7 +201,7 @@ public class ProfileUploaderTest {\n \n     final RecordedRequest request = server.takeRequest(5, TimeUnit.SECONDS);\n     assertNotNull(request);\n-    assertNull(request.getHeader(\"Datadog-Container-ID\"));\n+    assertNull(request.getHeader(ProfileUploader.HEADER_DD_CONTAINER_ID));\n   }\n \n   @Test\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTM4OTQ1Mw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1569#discussion_r439389453", "bodyText": "I think you can fold one of these tests into testRequestParameters - which is sort of our 'happy path' test.", "author": "mar-kolya", "createdAt": "2020-06-12T12:30:54Z", "path": "dd-java-agent/agent-profiling/profiling-uploader/src/test/java/com/datadog/profiling/uploader/ProfileUploaderTest.java", "diffHunk": "@@ -192,6 +192,30 @@ public void testRequestParameters(final String compression)\n     assertArrayEquals(expectedBytes, uploadedBytes);\n   }\n \n+  @Test\n+  public void testRequestWithoutContainerID() throws IOException, InterruptedException {", "originalCommit": "b2f4b20207da4b61fffa71419f9c84c2c9d47ec8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c8d19bf70f99b0d576e3c6bc6a10c907f4484d9f", "chunk": "diff --git a/dd-java-agent/agent-profiling/profiling-uploader/src/test/java/com/datadog/profiling/uploader/ProfileUploaderTest.java b/dd-java-agent/agent-profiling/profiling-uploader/src/test/java/com/datadog/profiling/uploader/ProfileUploaderTest.java\nindex e40c50ca7a..97864b2788 100644\n--- a/dd-java-agent/agent-profiling/profiling-uploader/src/test/java/com/datadog/profiling/uploader/ProfileUploaderTest.java\n+++ b/dd-java-agent/agent-profiling/profiling-uploader/src/test/java/com/datadog/profiling/uploader/ProfileUploaderTest.java\n\n@@ -201,7 +201,7 @@ public class ProfileUploaderTest {\n \n     final RecordedRequest request = server.takeRequest(5, TimeUnit.SECONDS);\n     assertNotNull(request);\n-    assertNull(request.getHeader(\"Datadog-Container-ID\"));\n+    assertNull(request.getHeader(ProfileUploader.HEADER_DD_CONTAINER_ID));\n   }\n \n   @Test\n"}}, {"oid": "c8d19bf70f99b0d576e3c6bc6a10c907f4484d9f", "url": "https://github.com/DataDog/dd-trace-java/commit/c8d19bf70f99b0d576e3c6bc6a10c907f4484d9f", "message": "Replace hardcoded strings with constants in ProfileUploaderTest", "committedDate": "2020-06-12T13:47:35Z", "type": "commit"}, {"oid": "ee8974aac6ef5f59cd3caf1a6a8c491e3ab23497", "url": "https://github.com/DataDog/dd-trace-java/commit/ee8974aac6ef5f59cd3caf1a6a8c491e3ab23497", "message": "Remove redundant test code for container IDs in headers", "committedDate": "2020-06-12T13:57:26Z", "type": "commit"}, {"oid": "1b30dc26a525962aee760d410ed9db4afd0e1821", "url": "https://github.com/DataDog/dd-trace-java/commit/1b30dc26a525962aee760d410ed9db4afd0e1821", "message": "Add container-utils to dd-trace-ot, remove revapi exception", "committedDate": "2020-06-12T15:33:19Z", "type": "commit"}]}