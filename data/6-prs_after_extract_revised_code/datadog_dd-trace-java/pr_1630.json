{"pr_number": 1630, "pr_title": "remove deprecated dbtagtypeinterceptor", "pr_createdAt": "2020-06-25T11:39:14Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/1630", "timeline": [{"oid": "23602bf773af4aadabfb2339b73e50fa0fbf68bc", "url": "https://github.com/DataDog/dd-trace-java/commit/23602bf773af4aadabfb2339b73e50fa0fbf68bc", "message": "remove DBTagTypeInterceptor", "committedDate": "2020-06-25T12:51:06Z", "type": "forcePushed"}, {"oid": "567159229e2809ae5a9fcc923291e6f609c5a79a", "url": "https://github.com/DataDog/dd-trace-java/commit/567159229e2809ae5a9fcc923291e6f609c5a79a", "message": "remove DBTagTypeInterceptor", "committedDate": "2020-06-25T13:16:10Z", "type": "forcePushed"}, {"oid": "bc99da0c90e8a7b9ef75d31e45b6f76369978fce", "url": "https://github.com/DataDog/dd-trace-java/commit/bc99da0c90e8a7b9ef75d31e45b6f76369978fce", "message": "remove DBTagTypeInterceptor", "committedDate": "2020-06-25T14:20:31Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY1MzM1OQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1630#discussion_r445653359", "bodyText": "By default a hard coded service name is set to the result of service() implemented by subclasses of this decorator.", "author": "tylerbenson", "createdAt": "2020-06-25T15:40:03Z", "path": "dd-java-agent/agent-bootstrap/src/main/java/datadog/trace/bootstrap/instrumentation/decorator/DatabaseClientDecorator.java", "diffHunk": "@@ -33,14 +40,27 @@ public AgentSpan onConnection(final AgentSpan span, final CONNECTION connection)\n       span.setTag(Tags.DB_USER, dbUser(connection));\n       final String instanceName = dbInstance(connection);\n       span.setTag(Tags.DB_INSTANCE, instanceName);\n-\n+      // TODO - what happens when isDbClientSplitByInstance() returns false?\n+      //  No tag would have been set anyway - is there a test?", "originalCommit": "bc99da0c90e8a7b9ef75d31e45b6f76369978fce", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c261af20b3b37e7216c8ab435a53b446e19c1cdb", "chunk": "diff --git a/dd-java-agent/agent-bootstrap/src/main/java/datadog/trace/bootstrap/instrumentation/decorator/DatabaseClientDecorator.java b/dd-java-agent/agent-bootstrap/src/main/java/datadog/trace/bootstrap/instrumentation/decorator/DatabaseClientDecorator.java\nindex 150435712a..a49e7119a5 100644\n--- a/dd-java-agent/agent-bootstrap/src/main/java/datadog/trace/bootstrap/instrumentation/decorator/DatabaseClientDecorator.java\n+++ b/dd-java-agent/agent-bootstrap/src/main/java/datadog/trace/bootstrap/instrumentation/decorator/DatabaseClientDecorator.java\n\n@@ -40,27 +33,14 @@ public abstract class DatabaseClientDecorator<CONNECTION> extends ClientDecorato\n       span.setTag(Tags.DB_USER, dbUser(connection));\n       final String instanceName = dbInstance(connection);\n       span.setTag(Tags.DB_INSTANCE, instanceName);\n-      // TODO - what happens when isDbClientSplitByInstance() returns false?\n-      //  No tag would have been set anyway - is there a test?\n+\n       if (instanceName != null && Config.get().isDbClientSplitByInstance()) {\n-        setServiceName(span, instanceName);\n+        span.setTag(DDTags.SERVICE_NAME, instanceName);\n       }\n     }\n     return span;\n   }\n \n-  protected void setServiceName(AgentSpan span, String serviceName) {\n-    span.setServiceName(serviceName);\n-    onServiceNameSet(span, serviceName);\n-  }\n-\n-  protected void onServiceNameSet(AgentSpan span, String serviceName) {\n-    // TODO - couchbase and elasticsearch may need overrides of this behaviour\n-    String operationName = CACHE.computeIfAbsent(serviceName, APPEND_OPERATION_SUFFIX);\n-    span.setOperationName(operationName);\n-    span.setSpanType(dbType());\n-  }\n-\n   public AgentSpan onStatement(final AgentSpan span, final String statement) {\n     assert span != null;\n     span.setTag(Tags.DB_STATEMENT, statement);\n"}}, {"oid": "00a52990e1588e4334342bfe48022289da7ebd5e", "url": "https://github.com/DataDog/dd-trace-java/commit/00a52990e1588e4334342bfe48022289da7ebd5e", "message": "move FixedSizeCache to agent-bootstrap, remove DBTagTypeInterceptor, move logic to DB decorator", "committedDate": "2020-06-25T16:20:06Z", "type": "forcePushed"}, {"oid": "c261af20b3b37e7216c8ab435a53b446e19c1cdb", "url": "https://github.com/DataDog/dd-trace-java/commit/c261af20b3b37e7216c8ab435a53b446e19c1cdb", "message": "remove inefficient hashmap access idiom in setting service name", "committedDate": "2020-06-25T19:18:12Z", "type": "commit"}, {"oid": "0773e08e69b98303eef55049975d62e8fbaeeadd", "url": "https://github.com/DataDog/dd-trace-java/commit/0773e08e69b98303eef55049975d62e8fbaeeadd", "message": "remove DBTagTypeInterceptor and move logic into DatabaseClientDecorator hierarchy", "committedDate": "2020-06-25T20:24:08Z", "type": "forcePushed"}, {"oid": "e027fe431adb4a666a0b6105c26b52d852011d4d", "url": "https://github.com/DataDog/dd-trace-java/commit/e027fe431adb4a666a0b6105c26b52d852011d4d", "message": "remove DBTagTypeInterceptor and move logic into DatabaseClientDecorator hierarchy", "committedDate": "2020-06-25T20:35:55Z", "type": "forcePushed"}, {"oid": "7b8ea6fbcca8bc4d2c99f6cc33c97dbf8395d383", "url": "https://github.com/DataDog/dd-trace-java/commit/7b8ea6fbcca8bc4d2c99f6cc33c97dbf8395d383", "message": "no need to set span type twice", "committedDate": "2020-06-25T21:33:35Z", "type": "forcePushed"}, {"oid": "7a237c1abc7df4565edfa44a5907c99aebcb1d8f", "url": "https://github.com/DataDog/dd-trace-java/commit/7a237c1abc7df4565edfa44a5907c99aebcb1d8f", "message": "remove DBTagTypeInterceptor and move logic into DatabaseClientDecorator hierarchy", "committedDate": "2020-06-25T21:34:42Z", "type": "commit"}, {"oid": "cdaf87ea7e2e964bde37fd19fa8311511f34654a", "url": "https://github.com/DataDog/dd-trace-java/commit/cdaf87ea7e2e964bde37fd19fa8311511f34654a", "message": "revapi", "committedDate": "2020-06-25T21:34:42Z", "type": "commit"}, {"oid": "cdaf87ea7e2e964bde37fd19fa8311511f34654a", "url": "https://github.com/DataDog/dd-trace-java/commit/cdaf87ea7e2e964bde37fd19fa8311511f34654a", "message": "revapi", "committedDate": "2020-06-25T21:34:42Z", "type": "forcePushed"}]}