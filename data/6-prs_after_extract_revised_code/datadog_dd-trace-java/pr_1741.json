{"pr_number": 1741, "pr_title": "finer grained synchronization for classloading of agent classes", "pr_createdAt": "2020-08-04T10:30:08Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/1741", "timeline": [{"oid": "2e16c19583599fa1f8c2d529fd5fb83c38bca807", "url": "https://github.com/DataDog/dd-trace-java/commit/2e16c19583599fa1f8c2d529fd5fb83c38bca807", "message": "finer grained synchronization for classloading of agent classes", "committedDate": "2020-08-04T10:29:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDk5MTkxNw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1741#discussion_r464991917", "bodyText": "Nice. Didn't know about this one.", "author": "bantonsson", "createdAt": "2020-08-04T11:48:06Z", "path": "dd-java-agent/agent-bootstrap/src/main/java/datadog/trace/bootstrap/DatadogClassLoader.java", "diffHunk": "@@ -68,7 +68,7 @@ public boolean hasLoadedClass(final String className) {\n \n   Class<?> loadFromPackage(String packageName, String name) throws ClassNotFoundException {\n     if (internalJarURLHandler.getPackages().contains(packageName)) {\n-      synchronized (this) {\n+      synchronized (getClassLoadingLock(name)) {", "originalCommit": "2e16c19583599fa1f8c2d529fd5fb83c38bca807", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDk5NTYwNA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1741#discussion_r464995604", "bodyText": "I'm tempted to do it at package level though. What do you think?", "author": "richardstartin", "createdAt": "2020-08-04T11:54:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDk5MTkxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTAwNDkyMQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1741#discussion_r465004921", "bodyText": "Is it to try to avoid entries in the parallelLockMap?", "author": "bantonsson", "createdAt": "2020-08-04T12:13:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDk5MTkxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTAwNjYyMg==", "url": "https://github.com/DataDog/dd-trace-java/pull/1741#discussion_r465006622", "bodyText": "yes, exactly, we already have the package names in InternalJarURLHandler and we could probably just key the locks against those. Fewer strings, smaller map, negligible or zero size increase over what we already have.", "author": "richardstartin", "createdAt": "2020-08-04T12:16:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDk5MTkxNw=="}], "type": "inlineReview", "revised_code": {"commit": "b6b399b85d1164ecd7395a6f166d73a74ec3936d", "chunk": "diff --git a/dd-java-agent/agent-bootstrap/src/main/java/datadog/trace/bootstrap/DatadogClassLoader.java b/dd-java-agent/agent-bootstrap/src/main/java/datadog/trace/bootstrap/DatadogClassLoader.java\nindex cfd62eb882..113aeb766c 100644\n--- a/dd-java-agent/agent-bootstrap/src/main/java/datadog/trace/bootstrap/DatadogClassLoader.java\n+++ b/dd-java-agent/agent-bootstrap/src/main/java/datadog/trace/bootstrap/DatadogClassLoader.java\n\n@@ -67,8 +67,9 @@ public class DatadogClassLoader extends URLClassLoader {\n   }\n \n   Class<?> loadFromPackage(String packageName, String name) throws ClassNotFoundException {\n-    if (internalJarURLHandler.getPackages().contains(packageName)) {\n-      synchronized (getClassLoadingLock(name)) {\n+    Object packageLock = internalJarURLHandler.getPackageLock(packageName);\n+    if (null != packageLock) {\n+      synchronized (packageLock) {\n         Class<?> loaded = findLoadedClass(name);\n         return null == loaded ? findClass(name) : loaded;\n       }\n"}}, {"oid": "b6b399b85d1164ecd7395a6f166d73a74ec3936d", "url": "https://github.com/DataDog/dd-trace-java/commit/b6b399b85d1164ecd7395a6f166d73a74ec3936d", "message": "synchronize at package level", "committedDate": "2020-08-04T12:26:25Z", "type": "commit"}, {"oid": "b6b399b85d1164ecd7395a6f166d73a74ec3936d", "url": "https://github.com/DataDog/dd-trace-java/commit/b6b399b85d1164ecd7395a6f166d73a74ec3936d", "message": "synchronize at package level", "committedDate": "2020-08-04T12:26:25Z", "type": "forcePushed"}]}