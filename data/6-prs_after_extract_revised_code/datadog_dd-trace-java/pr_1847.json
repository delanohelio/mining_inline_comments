{"pr_number": 1847, "pr_title": "Add a Sampler to force PrioritySampling", "pr_createdAt": "2020-09-09T09:43:56Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/1847", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTgwMjM2Nw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1847#discussion_r485802367", "bodyText": "Can I suggest something to the effect of priority.sampling.force=keep instead?  This would suggest allowing force to be configured to other states too.", "author": "tylerbenson", "createdAt": "2020-09-09T17:42:19Z", "path": "dd-trace-api/src/main/java/datadog/trace/api/config/TracerConfig.java", "diffHunk": "@@ -20,6 +20,7 @@\n   public static final String AGENT_UNIX_DOMAIN_SOCKET = \"trace.agent.unix.domain.socket\";\n   public static final String AGENT_TIMEOUT = \"trace.agent.timeout\";\n   public static final String PRIORITY_SAMPLING = \"priority.sampling\";\n+  public static final String FORCE_PRIORITY_SAMPLER_KEEP = \"force.priority.sampler_keep\";", "originalCommit": "1f99ba082354735fc9c9ccb03d14fa4faea3ba4b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjEyNjIwMw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1847#discussion_r486126203", "bodyText": "Changed \ud83d\udc4d", "author": "drodriguezhdez", "createdAt": "2020-09-10T07:33:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTgwMjM2Nw=="}], "type": "inlineReview", "revised_code": {"commit": "7c0e1caac964437407e516c985b8586687159aa5", "chunk": "diff --git a/dd-trace-api/src/main/java/datadog/trace/api/config/TracerConfig.java b/dd-trace-api/src/main/java/datadog/trace/api/config/TracerConfig.java\nindex 908b751f91..66ead9dc41 100644\n--- a/dd-trace-api/src/main/java/datadog/trace/api/config/TracerConfig.java\n+++ b/dd-trace-api/src/main/java/datadog/trace/api/config/TracerConfig.java\n\n@@ -14,12 +14,14 @@ package datadog.trace.api.config;\n public final class TracerConfig {\n   public static final String ID_GENERATION_STRATEGY = \"id.generation.strategy\";\n   public static final String WRITER_TYPE = \"writer.type\";\n+  public static final String PRIORITIZATION_TYPE = \"prioritization.type\";\n   public static final String AGENT_HOST = \"agent.host\";\n   public static final String TRACE_AGENT_PORT = \"trace.agent.port\";\n   public static final String AGENT_PORT_LEGACY = \"agent.port\";\n   public static final String AGENT_UNIX_DOMAIN_SOCKET = \"trace.agent.unix.domain.socket\";\n   public static final String AGENT_TIMEOUT = \"trace.agent.timeout\";\n   public static final String PRIORITY_SAMPLING = \"priority.sampling\";\n+  public static final String PRIORITY_SAMPLING_FORCE = \"priority.sampling.force\";\n   public static final String FORCE_PRIORITY_SAMPLER_KEEP = \"force.priority.sampler_keep\";\n   public static final String TRACE_RESOLVER_ENABLED = \"trace.resolver.enabled\";\n   public static final String SERVICE_MAPPING = \"service.mapping\";\n"}}, {"oid": "7c0e1caac964437407e516c985b8586687159aa5", "url": "https://github.com/DataDog/dd-trace-java/commit/7c0e1caac964437407e516c985b8586687159aa5", "message": "Change the config property to set ForceKeepSampler", "committedDate": "2020-09-10T07:32:09Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjM2ODUwMw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1847#discussion_r486368503", "bodyText": "The way I envisioned this is to have a sampler that forces priority to a value defined in the constructor, not specifically to keep.", "author": "tylerbenson", "createdAt": "2020-09-10T14:01:55Z", "path": "dd-trace-core/src/main/java/datadog/trace/common/sampling/ForceKeepSampler.java", "diffHunk": "@@ -0,0 +1,20 @@\n+package datadog.trace.common.sampling;\n+\n+import datadog.trace.api.sampling.PrioritySampling;\n+import datadog.trace.core.DDSpan;\n+import lombok.extern.slf4j.Slf4j;\n+\n+/** A sampler which forces the sampling priority to SAMPLER_KEEP */\n+@Slf4j\n+public class ForceKeepSampler implements Sampler, PrioritySampler {", "originalCommit": "34f009adb40168745f54bf2f03219b41b13297ba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ1NjkzMA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1847#discussion_r486456930", "bodyText": "Changed to ForcePrioritySampler where the priority can be defined in the constructor \ud83d\udc4d", "author": "drodriguezhdez", "createdAt": "2020-09-10T15:59:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjM2ODUwMw=="}], "type": "inlineReview", "revised_code": {"commit": "e32fbc4986b90560a833527fed4b9570bd9a8118", "chunk": "diff --git a/dd-trace-core/src/main/java/datadog/trace/common/sampling/ForceKeepSampler.java b/dd-trace-core/src/main/java/datadog/trace/common/sampling/ForceKeepSampler.java\ndeleted file mode 100644\nindex b60c2c64db..0000000000\n--- a/dd-trace-core/src/main/java/datadog/trace/common/sampling/ForceKeepSampler.java\n+++ /dev/null\n\n@@ -1,20 +0,0 @@\n-package datadog.trace.common.sampling;\n-\n-import datadog.trace.api.sampling.PrioritySampling;\n-import datadog.trace.core.DDSpan;\n-import lombok.extern.slf4j.Slf4j;\n-\n-/** A sampler which forces the sampling priority to SAMPLER_KEEP */\n-@Slf4j\n-public class ForceKeepSampler implements Sampler, PrioritySampler {\n-\n-  @Override\n-  public boolean sample(final DDSpan span) {\n-    return true;\n-  }\n-\n-  @Override\n-  public void setSamplingPriority(final DDSpan span) {\n-    span.context().setSamplingPriority(PrioritySampling.SAMPLER_KEEP);\n-  }\n-}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjM3MDI4OQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1847#discussion_r486370289", "bodyText": "Consider adding a drop option?", "author": "tylerbenson", "createdAt": "2020-09-10T14:04:18Z", "path": "internal-api/src/main/java/datadog/trace/bootstrap/instrumentation/api/SamplerConstants.java", "diffHunk": "@@ -0,0 +1,8 @@\n+package datadog.trace.bootstrap.instrumentation.api;\n+\n+public class SamplerConstants {\n+\n+  public static final String KEEP = \"keep\";", "originalCommit": "34f009adb40168745f54bf2f03219b41b13297ba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ1NjI1MA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1847#discussion_r486456250", "bodyText": "Added \ud83d\udc4d", "author": "drodriguezhdez", "createdAt": "2020-09-10T15:58:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjM3MDI4OQ=="}], "type": "inlineReview", "revised_code": {"commit": "7bcff91fb0e161c8db30fed744ae744864c92ea7", "chunk": "diff --git a/internal-api/src/main/java/datadog/trace/bootstrap/instrumentation/api/SamplerConstants.java b/internal-api/src/main/java/datadog/trace/bootstrap/instrumentation/api/SamplerConstants.java\ndeleted file mode 100644\nindex abffd2b397..0000000000\n--- a/internal-api/src/main/java/datadog/trace/bootstrap/instrumentation/api/SamplerConstants.java\n+++ /dev/null\n\n@@ -1,8 +0,0 @@\n-package datadog.trace.bootstrap.instrumentation.api;\n-\n-public class SamplerConstants {\n-\n-  public static final String KEEP = \"keep\";\n-\n-  private SamplerConstants() {}\n-}\n"}}, {"oid": "7bcff91fb0e161c8db30fed744ae744864c92ea7", "url": "https://github.com/DataDog/dd-trace-java/commit/7bcff91fb0e161c8db30fed744ae744864c92ea7", "message": "Added ForceKeepSampler", "committedDate": "2020-09-10T15:39:23Z", "type": "commit"}, {"oid": "fa814c8db4bc0574b595fae28232906035fcd1d8", "url": "https://github.com/DataDog/dd-trace-java/commit/fa814c8db4bc0574b595fae28232906035fcd1d8", "message": "Change the config property to set ForceKeepSampler", "committedDate": "2020-09-10T15:39:23Z", "type": "commit"}, {"oid": "ab5ea05911308f5ed645a177dff4c06ce859099a", "url": "https://github.com/DataDog/dd-trace-java/commit/ab5ea05911308f5ed645a177dff4c06ce859099a", "message": "Removed unnecesary code", "committedDate": "2020-09-10T15:39:23Z", "type": "commit"}, {"oid": "dcbb88e57f42442a62ad2c213ab07b094c5eca01", "url": "https://github.com/DataDog/dd-trace-java/commit/dcbb88e57f42442a62ad2c213ab07b094c5eca01", "message": "Remove unnecesary code", "committedDate": "2020-09-10T15:39:23Z", "type": "commit"}, {"oid": "e32fbc4986b90560a833527fed4b9570bd9a8118", "url": "https://github.com/DataDog/dd-trace-java/commit/e32fbc4986b90560a833527fed4b9570bd9a8118", "message": "Refactor sampler to admit the selected priority in the constructor", "committedDate": "2020-09-10T15:56:10Z", "type": "commit"}, {"oid": "e32fbc4986b90560a833527fed4b9570bd9a8118", "url": "https://github.com/DataDog/dd-trace-java/commit/e32fbc4986b90560a833527fed4b9570bd9a8118", "message": "Refactor sampler to admit the selected priority in the constructor", "committedDate": "2020-09-10T15:56:10Z", "type": "forcePushed"}]}