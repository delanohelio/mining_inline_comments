{"pr_number": 1816, "pr_title": "Make agent connect timeout less aggressive", "pr_createdAt": "2020-08-31T16:09:20Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/1816", "timeline": [{"oid": "71b3da35ad47b7012076a4a8060c376edd809261", "url": "https://github.com/DataDog/dd-trace-java/commit/71b3da35ad47b7012076a4a8060c376edd809261", "message": "Make agent connect timeout less aggressive", "committedDate": "2020-08-31T16:07:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDIzNDMwOQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1816#discussion_r480234309", "bodyText": "Actually use the timeout when trying to connect.", "author": "bantonsson", "createdAt": "2020-08-31T16:10:02Z", "path": "dd-trace-core/src/main/java/datadog/trace/common/writer/ddagent/DDAgentApi.java", "diffHunk": "@@ -397,16 +397,15 @@ String detectEndpointAndBuildClient() {\n     } else {\n       log.warn(\"No connectivity to datadog agent\");\n     }\n-    if (null == detectedVersion) {\n-      log.debug(\"Tried all of {}, no connectivity to datadog agent\", endpoints);\n+    if (null == detectedVersion && log.isDebugEnabled()) {\n+      log.debug(\"Tried all of {}, no connectivity to datadog agent\", Arrays.asList(endpoints));\n     }\n     return detectedVersion;\n   }\n \n-  private boolean isAgentRunning() {\n+  private boolean isAgentRunning(final long timeoutMillis) {\n     try (Socket socket = new Socket()) {\n-      socket.setSoTimeout(CONNECT_TIMEOUT_MS);\n-      socket.connect(new InetSocketAddress(host, port));\n+      socket.connect(new InetSocketAddress(host, port), (int) timeoutMillis);", "originalCommit": "71b3da35ad47b7012076a4a8060c376edd809261", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDIzNTM5NA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1816#discussion_r480235394", "bodyText": "This only logged the first element of the endpoints array.", "author": "bantonsson", "createdAt": "2020-08-31T16:11:59Z", "path": "dd-trace-core/src/main/java/datadog/trace/common/writer/ddagent/DDAgentApi.java", "diffHunk": "@@ -397,16 +397,15 @@ String detectEndpointAndBuildClient() {\n     } else {\n       log.warn(\"No connectivity to datadog agent\");\n     }\n-    if (null == detectedVersion) {\n-      log.debug(\"Tried all of {}, no connectivity to datadog agent\", endpoints);\n+    if (null == detectedVersion && log.isDebugEnabled()) {\n+      log.debug(\"Tried all of {}, no connectivity to datadog agent\", Arrays.asList(endpoints));", "originalCommit": "71b3da35ad47b7012076a4a8060c376edd809261", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDMzMzE4Mw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1816#discussion_r480333183", "bodyText": "This is shameful :(", "author": "richardstartin", "createdAt": "2020-08-31T19:11:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDIzNTM5NA=="}], "type": "inlineReview", "revised_code": null}]}