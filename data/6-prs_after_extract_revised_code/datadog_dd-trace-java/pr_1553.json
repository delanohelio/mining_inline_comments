{"pr_number": 1553, "pr_title": "PROF-1618: Decouple method level tracer from profiling", "pr_createdAt": "2020-06-05T16:39:13Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/1553", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg4NDA1Mg==", "url": "https://github.com/DataDog/dd-trace-java/pull/1553#discussion_r436884052", "bodyText": "Why do we want the isJavaBefore9()?", "author": "tylerbenson", "createdAt": "2020-06-08T17:45:13Z", "path": "dd-java-agent/agent-bootstrap/src/main/java/datadog/trace/bootstrap/Agent.java", "diffHunk": "@@ -100,6 +101,17 @@ public static void start(final Instrumentation inst, final URL bootstrapURL) {\n     } else {\n       startProfilingAgent(bootstrapURL, false);\n     }\n+\n+    /*\n+     * And yet another block for method-level tracer which is using JMX behind the scenes and\n+     * can mess with LogManager.\n+     */\n+    if (isJavaBefore9() && appUsingCustomLogManager) {", "originalCommit": "2ac4516732250870bc23fd889612dfe19d060576", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzk1NTc3NA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1553#discussion_r437955774", "bodyText": "Probably we don't. My copy-paste mistake.", "author": "jbachorik", "createdAt": "2020-06-10T08:35:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg4NDA1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODA5MTg3MA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1553#discussion_r438091870", "bodyText": "The whole init section is not necessary. Removed.", "author": "jbachorik", "createdAt": "2020-06-10T12:44:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg4NDA1Mg=="}], "type": "inlineReview", "revised_code": {"commit": "85ec96dec1d2ba7c10816fccac810cede712fedf", "chunk": "diff --git a/dd-java-agent/agent-bootstrap/src/main/java/datadog/trace/bootstrap/Agent.java b/dd-java-agent/agent-bootstrap/src/main/java/datadog/trace/bootstrap/Agent.java\nindex 3712094b3e..1dbc55ba81 100644\n--- a/dd-java-agent/agent-bootstrap/src/main/java/datadog/trace/bootstrap/Agent.java\n+++ b/dd-java-agent/agent-bootstrap/src/main/java/datadog/trace/bootstrap/Agent.java\n\n@@ -101,17 +100,6 @@ public class Agent {\n     } else {\n       startProfilingAgent(bootstrapURL, false);\n     }\n-\n-    /*\n-     * And yet another block for method-level tracer which is using JMX behind the scenes and\n-     * can mess with LogManager.\n-     */\n-    if (isJavaBefore9() && appUsingCustomLogManager) {\n-      log.debug(\"Custom logger detected. Delaying Method-level Tracer initialization.\");\n-      registerLogManagerCallback(new InstallMethodLevelTracerCallback(bootstrapURL));\n-    } else {\n-      installMethodLevelTracer(bootstrapURL);\n-    }\n   }\n \n   private static void registerLogManagerCallback(final ClassLoadCallBack callback) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODEyOTg4NQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1553#discussion_r438129885", "bodyText": "final useless here", "author": "jpbempel", "createdAt": "2020-06-10T13:40:21Z", "path": "dd-java-agent/agent-mlt/src/main/java/com/datadog/mlt/sampler/ThreadStackAccess.java", "diffHunk": "@@ -1,9 +1,9 @@\n-package datadog.trace.core.util;\n+package com.datadog.mlt.sampler;\n \n import lombok.extern.slf4j.Slf4j;\n \n @Slf4j\n-public class ThreadStackAccess {\n+public final class ThreadStackAccess {", "originalCommit": "b54dd07f45099928af1d9879346ace53cf287db8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "85ec96dec1d2ba7c10816fccac810cede712fedf", "chunk": "diff --git a/dd-java-agent/agent-mlt/src/main/java/com/datadog/mlt/sampler/ThreadStackAccess.java b/dd-trace-core/src/main/java/datadog/trace/core/util/ThreadStackAccess.java\nsimilarity index 93%\nrename from dd-java-agent/agent-mlt/src/main/java/com/datadog/mlt/sampler/ThreadStackAccess.java\nrename to dd-trace-core/src/main/java/datadog/trace/core/util/ThreadStackAccess.java\nindex 8d6315628a..e673a73788 100644\n--- a/dd-java-agent/agent-mlt/src/main/java/com/datadog/mlt/sampler/ThreadStackAccess.java\n+++ b/dd-trace-core/src/main/java/datadog/trace/core/util/ThreadStackAccess.java\n\n@@ -1,9 +1,9 @@\n-package com.datadog.mlt.sampler;\n+package datadog.trace.core.util;\n \n import lombok.extern.slf4j.Slf4j;\n \n @Slf4j\n-public final class ThreadStackAccess {\n+public class ThreadStackAccess {\n   private static volatile ThreadStackProvider threadStackProvider = new NoneThreadStackProvider();\n \n   /**\n"}}, {"oid": "85ec96dec1d2ba7c10816fccac810cede712fedf", "url": "https://github.com/DataDog/dd-trace-java/commit/85ec96dec1d2ba7c10816fccac810cede712fedf", "message": "Remove JFR writer support", "committedDate": "2020-06-10T15:56:48Z", "type": "commit"}, {"oid": "e840bfcecd54e1322104c68632b8ea7fd8e2f879", "url": "https://github.com/DataDog/dd-trace-java/commit/e840bfcecd54e1322104c68632b8ea7fd8e2f879", "message": "Grep the smoke test report log file for ERROR and WARN and make it fail if there are any", "committedDate": "2020-06-10T15:56:48Z", "type": "commit"}, {"oid": "5ec3ae6cf8ac0ebc2e5e421f071e8bc0dd167a09", "url": "https://github.com/DataDog/dd-trace-java/commit/5ec3ae6cf8ac0ebc2e5e421f071e8bc0dd167a09", "message": "Move out the MLT binary format support to a separate module", "committedDate": "2020-06-10T15:56:48Z", "type": "commit"}, {"oid": "6ee17cecebb629fab7c7a59565db177cca52c367", "url": "https://github.com/DataDog/dd-trace-java/commit/6ee17cecebb629fab7c7a59565db177cca52c367", "message": "Create a new agent-mlt project containing the MLT sampler and support\n\nCreate a new agent-mlt project containing the MLT sampler and support", "committedDate": "2020-06-10T15:56:48Z", "type": "commit"}, {"oid": "1163ac23659d936526df6c4833f04908668681ea", "url": "https://github.com/DataDog/dd-trace-java/commit/1163ac23659d936526df6c4833f04908668681ea", "message": "Make formatter happy", "committedDate": "2020-06-10T15:56:48Z", "type": "commit"}, {"oid": "32cebee13c67e5d26f28ea4af7535ded6fe0af4c", "url": "https://github.com/DataDog/dd-trace-java/commit/32cebee13c67e5d26f28ea4af7535ded6fe0af4c", "message": "Fix MLT initialization callback condition", "committedDate": "2020-06-10T15:56:48Z", "type": "commit"}, {"oid": "a900400c853aaf4e00788042608e24f316b15cb5", "url": "https://github.com/DataDog/dd-trace-java/commit/a900400c853aaf4e00788042608e24f316b15cb5", "message": "Various fixes related to restructuring of MLT impl\n\n- remove duplicated classes in shadowed jars\n- move ThreadStackAccess related classes to mlt-agent (solves class loading issues)\n- fix MLT initialization in Agent", "committedDate": "2020-06-10T15:56:48Z", "type": "commit"}, {"oid": "d424480b7ba2b0dfca029ea5c84ec767c082ad5b", "url": "https://github.com/DataDog/dd-trace-java/commit/d424480b7ba2b0dfca029ea5c84ec767c082ad5b", "message": "Remove unused callback class", "committedDate": "2020-06-10T15:56:48Z", "type": "commit"}, {"oid": "d424480b7ba2b0dfca029ea5c84ec767c082ad5b", "url": "https://github.com/DataDog/dd-trace-java/commit/d424480b7ba2b0dfca029ea5c84ec767c082ad5b", "message": "Remove unused callback class", "committedDate": "2020-06-10T15:56:48Z", "type": "forcePushed"}, {"oid": "07e244dcbe98af27d0b7c1b7b31d6ebe59e7da8a", "url": "https://github.com/DataDog/dd-trace-java/commit/07e244dcbe98af27d0b7c1b7b31d6ebe59e7da8a", "message": "Attempt to fix the test errors related to Java version", "committedDate": "2020-06-10T17:24:28Z", "type": "commit"}, {"oid": "eb2ec7c90bacb069568e4dd54e95dc935c9d7309", "url": "https://github.com/DataDog/dd-trace-java/commit/eb2ec7c90bacb069568e4dd54e95dc935c9d7309", "message": "Fix the profiling smoke tests to work with the agent.jar", "committedDate": "2020-06-11T08:29:22Z", "type": "commit"}, {"oid": "33ad76de4571d3619fdc5de57da2d1dee176eefc", "url": "https://github.com/DataDog/dd-trace-java/commit/33ad76de4571d3619fdc5de57da2d1dee176eefc", "message": "Add check for JMXSampler actually collecting stacktraces", "committedDate": "2020-06-11T08:46:21Z", "type": "commit"}, {"oid": "6a715942822f7a3c5e578401a3880d97101d120b", "url": "https://github.com/DataDog/dd-trace-java/commit/6a715942822f7a3c5e578401a3880d97101d120b", "message": "Reformat", "committedDate": "2020-06-11T08:57:36Z", "type": "commit"}]}