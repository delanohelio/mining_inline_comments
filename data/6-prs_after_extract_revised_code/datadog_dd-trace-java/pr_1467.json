{"pr_number": 1467, "pr_title": "More refactoring for ScopeManager", "pr_createdAt": "2020-05-15T22:06:16Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/1467", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjI4NDU0Ng==", "url": "https://github.com/DataDog/dd-trace-java/pull/1467#discussion_r426284546", "bodyText": "Is this essentially for chaining and not really for 'delegate' in a 'wrap and change behaviour'? It would be nice to have some comments into intent of this design.", "author": "mar-kolya", "createdAt": "2020-05-17T17:20:49Z", "path": "dd-trace-core/src/main/java/datadog/trace/core/scopemanager/DelegateScopeInterceptor.java", "diffHunk": "@@ -0,0 +1,52 @@\n+package datadog.trace.core.scopemanager;\n+\n+import datadog.trace.bootstrap.instrumentation.api.AgentScope;\n+import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n+import datadog.trace.context.TraceScope;\n+\n+abstract class DelegateScopeInterceptor implements ScopeInterceptor {\n+  protected final ScopeInterceptor delegate;", "originalCommit": "ef4b34ff9f6a921527c3a42c2f9e6e57b1b145ea", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e84078dcac49841155fdc4623df6e517b911136b", "chunk": "diff --git a/dd-trace-core/src/main/java/datadog/trace/core/scopemanager/DelegateScopeInterceptor.java b/dd-trace-core/src/main/java/datadog/trace/core/scopemanager/DelegateScopeInterceptor.java\ndeleted file mode 100644\nindex 38116b48cf..0000000000\n--- a/dd-trace-core/src/main/java/datadog/trace/core/scopemanager/DelegateScopeInterceptor.java\n+++ /dev/null\n\n@@ -1,52 +0,0 @@\n-package datadog.trace.core.scopemanager;\n-\n-import datadog.trace.bootstrap.instrumentation.api.AgentScope;\n-import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n-import datadog.trace.context.TraceScope;\n-\n-abstract class DelegateScopeInterceptor implements ScopeInterceptor {\n-  protected final ScopeInterceptor delegate;\n-\n-  protected DelegateScopeInterceptor(final ScopeInterceptor delegate) {\n-    if (delegate != null) {\n-      this.delegate = delegate;\n-    } else {\n-      this.delegate =\n-          new ScopeInterceptor() {\n-            @Override\n-            public AgentScope handleSpan(final AgentSpan span) {\n-              return new SimpleScope(span);\n-            }\n-          };\n-    }\n-  }\n-\n-  private static class SimpleScope implements AgentScope {\n-    private final AgentSpan span;\n-\n-    SimpleScope(final AgentSpan span) {\n-      this.span = span;\n-    }\n-\n-    @Override\n-    public AgentSpan span() {\n-      return span;\n-    }\n-\n-    @Override\n-    public void setAsyncPropagation(final boolean value) {}\n-\n-    @Override\n-    public TraceScope.Continuation capture() {\n-      return null;\n-    }\n-\n-    @Override\n-    public void close() {}\n-\n-    @Override\n-    public boolean isAsyncPropagating() {\n-      return false;\n-    }\n-  }\n-}\n"}}, {"oid": "e2f1095131a9f796314d83c1efba3be33dda851f", "url": "https://github.com/DataDog/dd-trace-java/commit/e2f1095131a9f796314d83c1efba3be33dda851f", "message": "Separate out JFR event management from ContextualScopeManager", "committedDate": "2020-05-18T19:34:41Z", "type": "commit"}, {"oid": "b5acc3e6a24084a7cc0beb26eeb3812ae76c94f6", "url": "https://github.com/DataDog/dd-trace-java/commit/b5acc3e6a24084a7cc0beb26eeb3812ae76c94f6", "message": "Separate out ScopeListener notification from ContextualScopeManager", "committedDate": "2020-05-18T19:34:41Z", "type": "commit"}, {"oid": "49d655a287183a43e774bebf442dbc2959148423", "url": "https://github.com/DataDog/dd-trace-java/commit/49d655a287183a43e774bebf442dbc2959148423", "message": "Rename ContextualScopeManager->ContinuableScopeManager", "committedDate": "2020-05-18T19:34:41Z", "type": "commit"}, {"oid": "8b248f2244aac58f212c5366671dfc289faf434f", "url": "https://github.com/DataDog/dd-trace-java/commit/8b248f2244aac58f212c5366671dfc289faf434f", "message": "Move ContinuableScope and Continuation inside ContinuableScopeManager\n\nAnd make private.", "committedDate": "2020-05-18T19:34:42Z", "type": "commit"}, {"oid": "a110966731831b7fb4bd9945a32eba6b71cd41ed", "url": "https://github.com/DataDog/dd-trace-java/commit/a110966731831b7fb4bd9945a32eba6b71cd41ed", "message": "Reduce visibility", "committedDate": "2020-05-18T19:34:42Z", "type": "commit"}, {"oid": "e84078dcac49841155fdc4623df6e517b911136b", "url": "https://github.com/DataDog/dd-trace-java/commit/e84078dcac49841155fdc4623df6e517b911136b", "message": "More refactoring and revapi updates", "committedDate": "2020-05-18T19:37:14Z", "type": "commit"}, {"oid": "3e3b38106b23958fff064bf104599657d4144931", "url": "https://github.com/DataDog/dd-trace-java/commit/3e3b38106b23958fff064bf104599657d4144931", "message": "Avoid duplicate ScopeListener for slf4j", "committedDate": "2020-05-18T19:37:14Z", "type": "commit"}, {"oid": "17f86816c5935f5a747c77dd1bcf6ee7bf30c771", "url": "https://github.com/DataDog/dd-trace-java/commit/17f86816c5935f5a747c77dd1bcf6ee7bf30c771", "message": "Remove unused method and add coverage ignore.", "committedDate": "2020-05-18T19:59:50Z", "type": "forcePushed"}, {"oid": "d6c007f18bdd32bfc244efe56292ed0160b8fa63", "url": "https://github.com/DataDog/dd-trace-java/commit/d6c007f18bdd32bfc244efe56292ed0160b8fa63", "message": "Remove unused method and add coverage ignore.", "committedDate": "2020-05-18T20:51:51Z", "type": "commit"}, {"oid": "d6c007f18bdd32bfc244efe56292ed0160b8fa63", "url": "https://github.com/DataDog/dd-trace-java/commit/d6c007f18bdd32bfc244efe56292ed0160b8fa63", "message": "Remove unused method and add coverage ignore.", "committedDate": "2020-05-18T20:51:51Z", "type": "forcePushed"}, {"oid": "9ec7a222768dba5f84a42e56f136cce09b82751c", "url": "https://github.com/DataDog/dd-trace-java/commit/9ec7a222768dba5f84a42e56f136cce09b82751c", "message": "Add comments and additional refactoring.", "committedDate": "2020-05-18T21:29:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkwMTA3OQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1467#discussion_r426901079", "bodyText": "This whole file seems unrelated to the PR", "author": "randomanderson", "createdAt": "2020-05-18T21:24:11Z", "path": "dd-trace-core/src/main/java/datadog/trace/core/serialization/MsgpackFormatWriter.java", "diffHunk": "@@ -86,16 +93,4 @@ public void writeBigInteger(byte[] key, BigInteger value, MessagePacker destinat\n       destination.packBigInteger(value);\n     }\n   }\n-\n-  private static void writeStringUTF8(String value, MessagePacker destination) throws IOException {\n-    if (value.length() < 256) {\n-      byte[] interned = StringTables.getBytesUTF8(value);\n-      if (null != interned) {\n-        destination.packRawStringHeader(interned.length);\n-        destination.addPayload(interned);\n-        return;\n-      }\n-    }\n-    destination.packString(value);\n-  }", "originalCommit": "d6c007f18bdd32bfc244efe56292ed0160b8fa63", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkxNTE1Mw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1467#discussion_r426915153", "bodyText": "nvm.  I see the commit comment", "author": "randomanderson", "createdAt": "2020-05-18T21:57:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkwMTA3OQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "6b09fc4cdae163d4bc28fa7cd44f950177b36a22", "url": "https://github.com/DataDog/dd-trace-java/commit/6b09fc4cdae163d4bc28fa7cd44f950177b36a22", "message": "Remove type weirdness from refactor in test", "committedDate": "2020-05-18T22:42:52Z", "type": "forcePushed"}, {"oid": "c4d6698a81ee6dd6ed352d1753af725f9ffc10c6", "url": "https://github.com/DataDog/dd-trace-java/commit/c4d6698a81ee6dd6ed352d1753af725f9ffc10c6", "message": "Remove type weirdness from refactor in test", "committedDate": "2020-05-18T23:30:59Z", "type": "forcePushed"}, {"oid": "cb44882ce7ed3830852adf59732ee1dd38e61c46", "url": "https://github.com/DataDog/dd-trace-java/commit/cb44882ce7ed3830852adf59732ee1dd38e61c46", "message": "Remove type weirdness from refactor in test", "committedDate": "2020-05-18T23:51:18Z", "type": "commit"}, {"oid": "cb44882ce7ed3830852adf59732ee1dd38e61c46", "url": "https://github.com/DataDog/dd-trace-java/commit/cb44882ce7ed3830852adf59732ee1dd38e61c46", "message": "Remove type weirdness from refactor in test", "committedDate": "2020-05-18T23:51:18Z", "type": "forcePushed"}]}