{"pr_number": 1719, "pr_title": "UnsafeUtils::setStaticFieldViaUnsafe should use putBooleanVolatile", "pr_createdAt": "2020-07-27T21:29:37Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/1719", "timeline": [{"oid": "a912b09ec834acb9c4727d9637af2313acbeb925", "url": "https://github.com/DataDog/dd-trace-java/commit/a912b09ec834acb9c4727d9637af2313acbeb925", "message": "UnsafeUtils::setStaticFieldViaUnsafe use putObjectVolatile", "committedDate": "2020-07-27T21:54:23Z", "type": "commit"}, {"oid": "a912b09ec834acb9c4727d9637af2313acbeb925", "url": "https://github.com/DataDog/dd-trace-java/commit/a912b09ec834acb9c4727d9637af2313acbeb925", "message": "UnsafeUtils::setStaticFieldViaUnsafe use putObjectVolatile", "committedDate": "2020-07-27T21:54:23Z", "type": "forcePushed"}, {"oid": "143fc943edb5ce6eef850639f8ea19788387a2fc", "url": "https://github.com/DataDog/dd-trace-java/commit/143fc943edb5ce6eef850639f8ea19788387a2fc", "message": "UnsafeUtils::setStaticFieldViaUnsafe use putBooleanVolatile", "committedDate": "2020-07-28T00:50:26Z", "type": "commit"}, {"oid": "143fc943edb5ce6eef850639f8ea19788387a2fc", "url": "https://github.com/DataDog/dd-trace-java/commit/143fc943edb5ce6eef850639f8ea19788387a2fc", "message": "UnsafeUtils::setStaticFieldViaUnsafe use putBooleanVolatile", "committedDate": "2020-07-28T00:50:26Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTM1NTg2OQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1719#discussion_r461355869", "bodyText": "Yup, so much better...", "author": "bantonsson", "createdAt": "2020-07-28T06:49:08Z", "path": "dd-java-agent/testing/src/main/java/datadog/trace/agent/test/utils/UnsafeUtils.java", "diffHunk": "@@ -15,15 +15,17 @@ private static int getJavaVersion() {\n     return Integer.parseInt(javaVersion.substring(beg, end));\n   }\n \n-  private static void setStaticFieldViaUnsafe(final Field field, final Object newValue)\n+  private static void setStaticBooleanFieldViaUnsafe(final Field field, final boolean newValue)\n       throws Exception {\n     final Field unsafeField = sun.misc.Unsafe.class.getDeclaredField(\"theUnsafe\");\n     unsafeField.setAccessible(true);\n     final sun.misc.Unsafe unsafe = (sun.misc.Unsafe) unsafeField.get(null);\n \n+    unsafe.ensureClassInitialized(field.getDeclaringClass());\n+\n     final Object staticFieldBase = unsafe.staticFieldBase(field);\n     final long staticFieldOffset = unsafe.staticFieldOffset(field);\n-    unsafe.putObject(staticFieldBase, staticFieldOffset, newValue);\n+    unsafe.putBooleanVolatile(staticFieldBase, staticFieldOffset, newValue);", "originalCommit": "143fc943edb5ce6eef850639f8ea19788387a2fc", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}