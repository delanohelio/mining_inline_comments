{"pr_number": 2188, "pr_title": "Avoid dns lookup in mongo instrumentations", "pr_createdAt": "2020-12-10T20:59:01Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/2188", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDc0MzQzNw==", "url": "https://github.com/DataDog/dd-trace-java/pull/2188#discussion_r540743437", "bodyText": "Maybe a comment about why it is done this way?", "author": "bantonsson", "createdAt": "2020-12-11T07:29:45Z", "path": "dd-java-agent/instrumentation/mongo/driver-3.1/src/main/java/datadog/trace/instrumentation/mongo/TracingCommandListener.java", "diffHunk": "@@ -29,8 +32,9 @@ public void commandStarted(final CommandStartedEvent event) {\n       if (event.getConnectionDescription() != null\n           && event.getConnectionDescription() != null\n           && event.getConnectionDescription().getServerAddress() != null) {\n-        DECORATE.onPeerConnection(\n-            span, event.getConnectionDescription().getServerAddress().getSocketAddress());\n+        ServerAddress serverAddress = event.getConnectionDescription().getServerAddress();\n+        span.setTag(Tags.PEER_HOSTNAME, serverAddress.getHost())\n+            .setTag(Tags.PEER_PORT, PORTS.get(serverAddress.getPort()));", "originalCommit": "10535acc3ba80a9324fd19caac1b52d426844955", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "72f646f5efdcaea09c377f038e33c3107ea7409e", "chunk": "diff --git a/dd-java-agent/instrumentation/mongo/driver-3.1/src/main/java/datadog/trace/instrumentation/mongo/TracingCommandListener.java b/dd-java-agent/instrumentation/mongo/driver-3.1/src/main/java/datadog/trace/instrumentation/mongo/TracingCommandListener.java\nindex ffbf4367bf..c629f77ed3 100644\n--- a/dd-java-agent/instrumentation/mongo/driver-3.1/src/main/java/datadog/trace/instrumentation/mongo/TracingCommandListener.java\n+++ b/dd-java-agent/instrumentation/mongo/driver-3.1/src/main/java/datadog/trace/instrumentation/mongo/TracingCommandListener.java\n\n@@ -32,6 +32,8 @@ public class TracingCommandListener implements CommandListener {\n       if (event.getConnectionDescription() != null\n           && event.getConnectionDescription() != null\n           && event.getConnectionDescription().getServerAddress() != null) {\n+        // cannot use onPeerConnection because ServerAddress.getSocketAddress()\n+        // may do a DNS lookup\n         ServerAddress serverAddress = event.getConnectionDescription().getServerAddress();\n         span.setTag(Tags.PEER_HOSTNAME, serverAddress.getHost())\n             .setTag(Tags.PEER_PORT, PORTS.get(serverAddress.getPort()));\n"}}, {"oid": "72f646f5efdcaea09c377f038e33c3107ea7409e", "url": "https://github.com/DataDog/dd-trace-java/commit/72f646f5efdcaea09c377f038e33c3107ea7409e", "message": "avoid DNS lookup in mongo instrumentations", "committedDate": "2020-12-11T09:00:34Z", "type": "commit"}, {"oid": "72f646f5efdcaea09c377f038e33c3107ea7409e", "url": "https://github.com/DataDog/dd-trace-java/commit/72f646f5efdcaea09c377f038e33c3107ea7409e", "message": "avoid DNS lookup in mongo instrumentations", "committedDate": "2020-12-11T09:00:34Z", "type": "forcePushed"}]}