{"pr_number": 2177, "pr_title": "capture top level status", "pr_createdAt": "2020-12-09T14:55:08Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/2177", "timeline": [{"oid": "db1c8d6acaa848340d24c036eeef9cd0ce3218a6", "url": "https://github.com/DataDog/dd-trace-java/commit/db1c8d6acaa848340d24c036eeef9cd0ce3218a6", "message": "capture top level status", "committedDate": "2020-12-09T15:08:50Z", "type": "commit"}, {"oid": "10e960eaa40a2dd1e633279f5f1b0796d28bd6d0", "url": "https://github.com/DataDog/dd-trace-java/commit/10e960eaa40a2dd1e633279f5f1b0796d28bd6d0", "message": "track metrics on top level spans", "committedDate": "2020-12-09T15:08:50Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQyMDM5Ng==", "url": "https://github.com/DataDog/dd-trace-java/pull/2177#discussion_r539420396", "bodyText": "I assume \"top level\" means that the resulting service name is different from the parent?\nI think that is something that might warrant clarification otherwise it might be confused with \"local root\".", "author": "tylerbenson", "createdAt": "2020-12-09T15:48:28Z", "path": "dd-trace-core/src/main/java/datadog/trace/core/CoreSpan.java", "diffHunk": "@@ -55,6 +55,8 @@\n \n   boolean isMeasured();\n \n+  boolean isTopLevel();", "originalCommit": "10e960eaa40a2dd1e633279f5f1b0796d28bd6d0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQzMjE1NA==", "url": "https://github.com/DataDog/dd-trace-java/pull/2177#discussion_r539432154", "bodyText": "top level is a fundamental concept in the backend and the agent", "author": "richardstartin", "createdAt": "2020-12-09T16:02:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQyMDM5Ng=="}], "type": "inlineReview", "revised_code": {"commit": "3334433cd13ae165eb98f22fd4edaf2b905a9d25", "chunk": "diff --git a/dd-trace-core/src/main/java/datadog/trace/core/CoreSpan.java b/dd-trace-core/src/main/java/datadog/trace/core/CoreSpan.java\nindex b91804b5d7..000bbe6c16 100644\n--- a/dd-trace-core/src/main/java/datadog/trace/core/CoreSpan.java\n+++ b/dd-trace-core/src/main/java/datadog/trace/core/CoreSpan.java\n\n@@ -55,6 +55,7 @@ public interface CoreSpan<T extends CoreSpan<T>> {\n \n   boolean isMeasured();\n \n+  /** @return whether this span has a different service name from its parent, or is a local root. */\n   boolean isTopLevel();\n \n   Map<CharSequence, Number> getMetrics();\n"}}, {"oid": "3334433cd13ae165eb98f22fd4edaf2b905a9d25", "url": "https://github.com/DataDog/dd-trace-java/commit/3334433cd13ae165eb98f22fd4edaf2b905a9d25", "message": "send top level status to agent", "committedDate": "2020-12-09T16:22:59Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ2OTA0MQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/2177#discussion_r539469041", "bodyText": "High level understanding of last clause looks difficult to me. But seems like you covered all cases with tests: https://github.com/DataDog/dd-trace-java/pull/2177/files#diff-c0f34fdf7aab5b82e441f40c6c5f1931cace8e6ea59d82d7831dd575c4eb18a9R459 :)", "author": "lpriima", "createdAt": "2020-12-09T16:45:34Z", "path": "dd-trace-core/src/main/java/datadog/trace/core/DDSpanContext.java", "diffHunk": "@@ -215,6 +222,16 @@ public void setMeasured(boolean measured) {\n     }\n   }\n \n+  public boolean isTopLevel() {\n+    return topLevel;\n+  }\n+\n+  private static boolean isTopLevel(CharSequence parentServiceName, String serviceName) {\n+    return parentServiceName == null\n+        || parentServiceName.length() == 0\n+        || !serviceName.equals(parentServiceName);", "originalCommit": "3334433cd13ae165eb98f22fd4edaf2b905a9d25", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1b6c510b75a191f2f718c8c907fc49ca8b413d8f", "chunk": "diff --git a/dd-trace-core/src/main/java/datadog/trace/core/DDSpanContext.java b/dd-trace-core/src/main/java/datadog/trace/core/DDSpanContext.java\nindex 7aaf3e1f96..fc942051c1 100644\n--- a/dd-trace-core/src/main/java/datadog/trace/core/DDSpanContext.java\n+++ b/dd-trace-core/src/main/java/datadog/trace/core/DDSpanContext.java\n\n@@ -226,10 +226,10 @@ public class DDSpanContext implements AgentSpan.Context {\n     return topLevel;\n   }\n \n-  private static boolean isTopLevel(CharSequence parentServiceName, String serviceName) {\n+  private static boolean isTopLevel(String parentServiceName, String serviceName) {\n     return parentServiceName == null\n         || parentServiceName.length() == 0\n-        || !serviceName.equals(parentServiceName);\n+        || !parentServiceName.equals(serviceName);\n   }\n \n   public CharSequence getSpanType() {\n"}}, {"oid": "1b6c510b75a191f2f718c8c907fc49ca8b413d8f", "url": "https://github.com/DataDog/dd-trace-java/commit/1b6c510b75a191f2f718c8c907fc49ca8b413d8f", "message": "track metrics on top level spans", "committedDate": "2020-12-09T17:29:27Z", "type": "commit"}, {"oid": "14b5d42bfc19a45a3df4e9553fb7f750f683155c", "url": "https://github.com/DataDog/dd-trace-java/commit/14b5d42bfc19a45a3df4e9553fb7f750f683155c", "message": "send top level status to agent", "committedDate": "2020-12-09T17:29:27Z", "type": "commit"}, {"oid": "14b5d42bfc19a45a3df4e9553fb7f750f683155c", "url": "https://github.com/DataDog/dd-trace-java/commit/14b5d42bfc19a45a3df4e9553fb7f750f683155c", "message": "send top level status to agent", "committedDate": "2020-12-09T17:29:27Z", "type": "forcePushed"}]}