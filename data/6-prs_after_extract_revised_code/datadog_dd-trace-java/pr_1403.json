{"pr_number": 1403, "pr_title": "Check jax-rs AsyncResponse for span before starting new one", "pr_createdAt": "2020-04-27T20:49:50Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/1403", "timeline": [{"oid": "2e8f69517cd1c5a8680a993685dd268e255b213c", "url": "https://github.com/DataDog/dd-trace-java/commit/2e8f69517cd1c5a8680a993685dd268e255b213c", "message": "Check jax-rs AsyncResponse for span before starting new one\n\nThis will prevent the request from being broken due to replacing the unfinished span.", "committedDate": "2020-04-27T19:46:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjE0MzM5NA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1403#discussion_r416143394", "bodyText": "This is not immediately related, though I discovered this problem in the same investigation and it is tangentially related...\nWhen an executor has multiple execute methods, one calling the other, previously they were both instrumented and we would see Failed to set continuation because another continuation is already set log messages.  This is because the first call would create a continuation, set it on the task, then call the next execute method, which would do the same, but it would close the second one and keep the first.  These log messages were a red herring for my investigation as it didn't actually impact the application reporting.", "author": "tylerbenson", "createdAt": "2020-04-27T20:57:48Z", "path": "dd-java-agent/instrumentation/java-concurrent/src/main/java/datadog/trace/instrumentation/java/concurrent/JavaExecutorInstrumentation.java", "diffHunk": "@@ -44,7 +45,7 @@\n   public Map<? extends ElementMatcher<? super MethodDescription>, String> transformers() {\n     final Map<ElementMatcher<? super MethodDescription>, String> transformers = new HashMap<>();\n     transformers.put(\n-        named(\"execute\").and(takesArgument(0, Runnable.class)),\n+        named(\"execute\").and(takesArgument(0, Runnable.class)).and(takesArguments(1)),", "originalCommit": "2e8f69517cd1c5a8680a993685dd268e255b213c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjIyNzYzMA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1403#discussion_r416227630", "bodyText": "what's the point to creating nested if? why not ? :\nif (asyncResponse != null && !asyncResponse.isSuspended()) {\t\n     InstrumentationContext.get(AsyncResponse.class, AgentSpan.class).put(asyncResponse, span);\t\n}\nif (asyncResponse == null  || !asyncResponse.isSuspended()) {\n    DECORATE.beforeFinish(span);\n    span.finish();\n}", "author": "lpriima", "createdAt": "2020-04-27T23:53:18Z", "path": "dd-java-agent/instrumentation/jax-rs-annotations-2/src/main/java/datadog/trace/instrumentation/jaxrs2/JaxRsAnnotationsInstrumentation.java", "diffHunk": "@@ -110,16 +140,11 @@ public static void stopSpan(\n         return;\n       }\n \n-      AsyncResponse asyncResponse = null;\n-      for (final Object arg : args) {\n-        if (arg instanceof AsyncResponse) {\n-          asyncResponse = (AsyncResponse) arg;\n-          break;\n+      if (asyncResponse == null || !asyncResponse.isSuspended()) {\n+        if (asyncResponse != null && !asyncResponse.isSuspended()) {\n+          // Clear span from the asyncResponse\n+          InstrumentationContext.get(AsyncResponse.class, AgentSpan.class).put(asyncResponse, null);\n         }\n-      }\n-      if (asyncResponse != null && asyncResponse.isSuspended()) {\n-        InstrumentationContext.get(AsyncResponse.class, AgentSpan.class).put(asyncResponse, span);\n-      } else {\n         DECORATE.beforeFinish(span);\n         span.finish();\n       }", "originalCommit": "2e8f69517cd1c5a8680a993685dd268e255b213c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjY0ODg4Mw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1403#discussion_r416648883", "bodyText": "done.", "author": "tylerbenson", "createdAt": "2020-04-28T14:15:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjIyNzYzMA=="}], "type": "inlineReview", "revised_code": {"commit": "1f69da615802f0bb5f75aa0c45c57848ee3552d0", "chunk": "diff --git a/dd-java-agent/instrumentation/jax-rs-annotations-2/src/main/java/datadog/trace/instrumentation/jaxrs2/JaxRsAnnotationsInstrumentation.java b/dd-java-agent/instrumentation/jax-rs-annotations-2/src/main/java/datadog/trace/instrumentation/jaxrs2/JaxRsAnnotationsInstrumentation.java\nindex 043ebb45bf..52f757707b 100644\n--- a/dd-java-agent/instrumentation/jax-rs-annotations-2/src/main/java/datadog/trace/instrumentation/jaxrs2/JaxRsAnnotationsInstrumentation.java\n+++ b/dd-java-agent/instrumentation/jax-rs-annotations-2/src/main/java/datadog/trace/instrumentation/jaxrs2/JaxRsAnnotationsInstrumentation.java\n\n@@ -140,11 +140,11 @@ public final class JaxRsAnnotationsInstrumentation extends Instrumenter.Default\n         return;\n       }\n \n+      if (asyncResponse != null && !asyncResponse.isSuspended()) {\n+        // Clear span from the asyncResponse. Logically this should never happen. Added to be safe.\n+        InstrumentationContext.get(AsyncResponse.class, AgentSpan.class).put(asyncResponse, null);\n+      }\n       if (asyncResponse == null || !asyncResponse.isSuspended()) {\n-        if (asyncResponse != null && !asyncResponse.isSuspended()) {\n-          // Clear span from the asyncResponse\n-          InstrumentationContext.get(AsyncResponse.class, AgentSpan.class).put(asyncResponse, null);\n-        }\n         DECORATE.beforeFinish(span);\n         span.finish();\n       }\n"}}, {"oid": "90987a8d232e30705ae307b4c9fb267e22dc9adf", "url": "https://github.com/DataDog/dd-trace-java/commit/90987a8d232e30705ae307b4c9fb267e22dc9adf", "message": "Merge branch 'master' into tyler/jax-rs-nested-async", "committedDate": "2020-04-28T14:12:12Z", "type": "commit"}, {"oid": "1f69da615802f0bb5f75aa0c45c57848ee3552d0", "url": "https://github.com/DataDog/dd-trace-java/commit/1f69da615802f0bb5f75aa0c45c57848ee3552d0", "message": "Remove nested if.", "committedDate": "2020-04-28T14:14:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjc0ODUwMw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1403#discussion_r416748503", "bodyText": "And this doesn't need to be done for datadog.trace.instrumentation.jaxrs1.JaxRsAnnotationsInstrumentation?", "author": "lpriima", "createdAt": "2020-04-28T16:21:00Z", "path": "dd-java-agent/instrumentation/jax-rs-annotations-2/src/main/java/datadog/trace/instrumentation/jaxrs2/JaxRsAnnotationsInstrumentation.java", "diffHunk": "@@ -83,7 +84,28 @@ public JaxRsAnnotationsInstrumentation() {\n \n     @Advice.OnMethodEnter(suppress = Throwable.class)\n     public static AgentScope nameSpan(\n-        @Advice.This final Object target, @Advice.Origin final Method method) {\n+        @Advice.This final Object target,\n+        @Advice.Origin final Method method,\n+        @Advice.AllArguments final Object[] args,\n+        @Advice.Local(\"asyncResponse\") AsyncResponse asyncResponse) {\n+      ContextStore<AsyncResponse, AgentSpan> contextStore = null;\n+      for (final Object arg : args) {\n+        if (arg instanceof AsyncResponse) {\n+          asyncResponse = (AsyncResponse) arg;\n+          contextStore = InstrumentationContext.get(AsyncResponse.class, AgentSpan.class);\n+          if (contextStore.get(asyncResponse) != null) {\n+            /**\n+             * We are probably in a recursive call and don't want to start a new span because it\n+             * would replace the existing span in the asyncResponse and cause it to never finish. We\n+             * could work around this by using a list instead, but we likely don't want the extra\n+             * span anyway.\n+             */\n+            return null;\n+          }\n+          break;\n+        }\n+      }\n+", "originalCommit": "1f69da615802f0bb5f75aa0c45c57848ee3552d0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjc3NTMzMQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1403#discussion_r416775331", "bodyText": "jaxrs1 doesn't support async.  that is the main distinction between the two.", "author": "tylerbenson", "createdAt": "2020-04-28T16:59:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjc0ODUwMw=="}], "type": "inlineReview", "revised_code": null}]}