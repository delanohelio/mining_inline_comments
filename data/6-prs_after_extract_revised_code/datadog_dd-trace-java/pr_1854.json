{"pr_number": 1854, "pr_title": "Trace processing pipeline timing", "pr_createdAt": "2020-09-10T14:11:16Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/1854", "timeline": [{"oid": "e161d3786a689c76cf9af153a0b0602e3a1f65bd", "url": "https://github.com/DataDog/dd-trace-java/commit/e161d3786a689c76cf9af153a0b0602e3a1f65bd", "message": "rename Monitoring to HealthMetrics, introduce Monitoring as a factory for timers, add timing in important places", "committedDate": "2020-09-10T14:19:24Z", "type": "forcePushed"}, {"oid": "9d749641cbdf61bd885ac810a053fd2b0ffa1b43", "url": "https://github.com/DataDog/dd-trace-java/commit/9d749641cbdf61bd885ac810a053fd2b0ffa1b43", "message": "revapi", "committedDate": "2020-09-10T14:52:04Z", "type": "forcePushed"}, {"oid": "c90c538f4398f959afc9bff425c1ac054afd92e8", "url": "https://github.com/DataDog/dd-trace-java/commit/c90c538f4398f959afc9bff425c1ac054afd92e8", "message": "revapi", "committedDate": "2020-09-10T15:06:39Z", "type": "forcePushed"}, {"oid": "5599c8f8745ba928021ffe1d58dbb23b3378fa74", "url": "https://github.com/DataDog/dd-trace-java/commit/5599c8f8745ba928021ffe1d58dbb23b3378fa74", "message": "revapi", "committedDate": "2020-09-10T15:36:48Z", "type": "forcePushed"}, {"oid": "a1e4503a07834b41ab77f368d27c5e05b125bd33", "url": "https://github.com/DataDog/dd-trace-java/commit/a1e4503a07834b41ab77f368d27c5e05b125bd33", "message": "revapi", "committedDate": "2020-09-10T15:58:32Z", "type": "forcePushed"}, {"oid": "1bb00609554f898b9fc27a2a73e10a42069b88d8", "url": "https://github.com/DataDog/dd-trace-java/commit/1bb00609554f898b9fc27a2a73e10a42069b88d8", "message": "revapi", "committedDate": "2020-09-10T16:44:34Z", "type": "forcePushed"}, {"oid": "0be594757960154016a231a12be4f9ce83d98dc3", "url": "https://github.com/DataDog/dd-trace-java/commit/0be594757960154016a231a12be4f9ce83d98dc3", "message": "revapi", "committedDate": "2020-09-10T17:01:30Z", "type": "forcePushed"}, {"oid": "f70e42c0f0dd39e40f7fc2da68ba21c43f220986", "url": "https://github.com/DataDog/dd-trace-java/commit/f70e42c0f0dd39e40f7fc2da68ba21c43f220986", "message": "time pending trace writer lock", "committedDate": "2020-09-10T18:05:16Z", "type": "forcePushed"}, {"oid": "a5d88f5e12d5a2a062567a58976da70a55a7bc9f", "url": "https://github.com/DataDog/dd-trace-java/commit/a5d88f5e12d5a2a062567a58976da70a55a7bc9f", "message": "time pending trace writer lock", "committedDate": "2020-09-10T18:14:45Z", "type": "forcePushed"}, {"oid": "a726753d84d051d8b21de8aedaa56a6a2660e7ed", "url": "https://github.com/DataDog/dd-trace-java/commit/a726753d84d051d8b21de8aedaa56a6a2660e7ed", "message": "revapi", "committedDate": "2020-09-10T18:22:39Z", "type": "forcePushed"}, {"oid": "1317d4d70e68c3c329e33dfc3a7f5db53d8349cf", "url": "https://github.com/DataDog/dd-trace-java/commit/1317d4d70e68c3c329e33dfc3a7f5db53d8349cf", "message": "revapi", "committedDate": "2020-09-10T18:40:17Z", "type": "forcePushed"}, {"oid": "f8f2c64e6baec0d3029ab5501be6d6a95bfa97ab", "url": "https://github.com/DataDog/dd-trace-java/commit/f8f2c64e6baec0d3029ab5501be6d6a95bfa97ab", "message": "revapi", "committedDate": "2020-09-10T18:51:38Z", "type": "forcePushed"}, {"oid": "b6b7398c63e20c7a247eb9e33f1f8329aa689b29", "url": "https://github.com/DataDog/dd-trace-java/commit/b6b7398c63e20c7a247eb9e33f1f8329aa689b29", "message": "revapi", "committedDate": "2020-09-10T19:26:41Z", "type": "forcePushed"}, {"oid": "67394f5d76d2dc6a5bef43a807734d029eae6acd", "url": "https://github.com/DataDog/dd-trace-java/commit/67394f5d76d2dc6a5bef43a807734d029eae6acd", "message": "revapi", "committedDate": "2020-09-10T19:35:15Z", "type": "forcePushed"}, {"oid": "ceaffb601dcaee278d2ef0f2ab27821589e2df96", "url": "https://github.com/DataDog/dd-trace-java/commit/ceaffb601dcaee278d2ef0f2ab27821589e2df96", "message": "revapi", "committedDate": "2020-09-10T19:51:03Z", "type": "forcePushed"}, {"oid": "6774516d64a458c968d15a639cfedec2158a2bb9", "url": "https://github.com/DataDog/dd-trace-java/commit/6774516d64a458c968d15a639cfedec2158a2bb9", "message": "revapi", "committedDate": "2020-09-10T20:06:03Z", "type": "forcePushed"}, {"oid": "972e000ba7aba37e98e3e5283e1f80619fe57868", "url": "https://github.com/DataDog/dd-trace-java/commit/972e000ba7aba37e98e3e5283e1f80619fe57868", "message": "revapi", "committedDate": "2020-09-10T20:09:27Z", "type": "forcePushed"}, {"oid": "7dc89617b9556481fd99353a0452404eb18c1018", "url": "https://github.com/DataDog/dd-trace-java/commit/7dc89617b9556481fd99353a0452404eb18c1018", "message": "revapi", "committedDate": "2020-09-10T20:19:00Z", "type": "forcePushed"}, {"oid": "ecb9087a9a0fe3f027b70a37b621e4ac7897653c", "url": "https://github.com/DataDog/dd-trace-java/commit/ecb9087a9a0fe3f027b70a37b621e4ac7897653c", "message": "revapi", "committedDate": "2020-09-10T20:29:41Z", "type": "forcePushed"}, {"oid": "a7bf56ce95611a5565e280ead253d29ae55255aa", "url": "https://github.com/DataDog/dd-trace-java/commit/a7bf56ce95611a5565e280ead253d29ae55255aa", "message": "revapi", "committedDate": "2020-09-10T20:36:04Z", "type": "forcePushed"}, {"oid": "b33350b2d34eedc7981676735e00936a78c5b61d", "url": "https://github.com/DataDog/dd-trace-java/commit/b33350b2d34eedc7981676735e00936a78c5b61d", "message": "revapi", "committedDate": "2020-09-10T20:38:41Z", "type": "forcePushed"}, {"oid": "089fecad2434eaf539d732fa738fba8260cf37fd", "url": "https://github.com/DataDog/dd-trace-java/commit/089fecad2434eaf539d732fa738fba8260cf37fd", "message": "revapi", "committedDate": "2020-09-10T20:51:08Z", "type": "forcePushed"}, {"oid": "2b2035bc10c18949be275d951361bd3562d10c6f", "url": "https://github.com/DataDog/dd-trace-java/commit/2b2035bc10c18949be275d951361bd3562d10c6f", "message": "rename Monitoring to HealthMetrics, introduce Monitoring as a factory for timers, add timing in important places", "committedDate": "2020-09-10T21:04:28Z", "type": "commit"}, {"oid": "fce432fb757ea6266058403577e6b667f1786670", "url": "https://github.com/DataDog/dd-trace-java/commit/fce432fb757ea6266058403577e6b667f1786670", "message": "revapi", "committedDate": "2020-09-10T21:04:28Z", "type": "commit"}, {"oid": "fce432fb757ea6266058403577e6b667f1786670", "url": "https://github.com/DataDog/dd-trace-java/commit/fce432fb757ea6266058403577e6b667f1786670", "message": "revapi", "committedDate": "2020-09-10T21:04:28Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjgzNTE2OA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1854#discussion_r486835168", "bodyText": "So how does this compare in the backend as opposed to a normal histogram that the agent has computed? I would love for statsd/dogstatsd to have a way to send a histogram in a compact way as one metric.", "author": "bantonsson", "createdAt": "2020-09-11T07:45:58Z", "path": "dd-trace-core/src/main/java/datadog/trace/core/monitor/Timer.java", "diffHunk": "@@ -0,0 +1,89 @@\n+package datadog.trace.core.monitor;\n+\n+import static java.util.concurrent.TimeUnit.SECONDS;\n+\n+import com.timgroup.statsd.StatsDClient;\n+import java.util.Arrays;\n+import org.HdrHistogram.PackedHistogram;\n+\n+/**\n+ * A timer which records times in a histogram, and flushes stats from the histogram after a\n+ * configurable period of time.\n+ */\n+public class Timer extends Recording {\n+\n+  private static final long THIRTY_SECONDS_AS_NANOS = SECONDS.toNanos(30);\n+\n+  private static final String[] MEAN = new String[] {\"stat:avg\"};\n+  private static final String[] P_50 = new String[] {\"stat:p50\"};\n+  private static final String[] P_99 = new String[] {\"stat:p99\"};\n+  private static final String[] MAX = new String[] {\"stat:max\"};\n+\n+  private final String name;\n+  private final StatsDClient statsd;\n+  private final PackedHistogram histogram;\n+  private final long flushAfterNanos;\n+\n+  private final String[] meanTags;\n+  private final String[] p50Tags;\n+  private final String[] p99Tags;\n+  private final String[] maxTags;\n+\n+  private long start;\n+  private long lastFlush = 0;\n+\n+  Timer(final String name, final String[] tags, final StatsDClient statsd, long flushAfterNanos) {\n+    this.name = name;\n+    this.statsd = statsd;\n+    this.flushAfterNanos = flushAfterNanos;\n+    this.histogram = new PackedHistogram(THIRTY_SECONDS_AS_NANOS, 3);\n+    this.meanTags = mergeTags(MEAN, tags);\n+    this.p50Tags = mergeTags(P_50, tags);\n+    this.p99Tags = mergeTags(P_99, tags);\n+    this.maxTags = mergeTags(MAX, tags);", "originalCommit": "2b2035bc10c18949be275d951361bd3562d10c6f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njg1MDY4MQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1854#discussion_r486850681", "bodyText": "I looked at it, and it looks far too heavyweight for some of the things I want to get information about. It wouldn't make sense to build a histogram from from quantiles.", "author": "richardstartin", "createdAt": "2020-09-11T08:15:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjgzNTE2OA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njg0MDMwNg==", "url": "https://github.com/DataDog/dd-trace-java/pull/1854#discussion_r486840306", "bodyText": "This is nice. Using AutoCloseable makes the code less cluttered.", "author": "bantonsson", "createdAt": "2020-09-11T07:55:33Z", "path": "dd-trace-core/src/main/java/datadog/trace/core/monitor/Recording.java", "diffHunk": "@@ -0,0 +1,12 @@\n+package datadog.trace.core.monitor;\n+\n+public abstract class Recording implements AutoCloseable {", "originalCommit": "2b2035bc10c18949be275d951361bd3562d10c6f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}