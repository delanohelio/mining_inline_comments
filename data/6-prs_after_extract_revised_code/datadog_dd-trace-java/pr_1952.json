{"pr_number": 1952, "pr_title": "Remove WeakReference tracking from PendingTrace", "pr_createdAt": "2020-10-05T22:03:38Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/1952", "timeline": [{"oid": "808b2a23536c620f351c135ee2bcbccab1029c17", "url": "https://github.com/DataDog/dd-trace-java/commit/808b2a23536c620f351c135ee2bcbccab1029c17", "message": "Remove WeakReference tracking from PendingTrace\n\nThis means we rely on the delay from PendingTraceBuffer to report traces where the root span is finished but the pendingReference count is not 0. No more cleaning required.", "committedDate": "2020-10-05T23:14:42Z", "type": "forcePushed"}, {"oid": "06e4c04897938ff56d8d3c5cbceeec67ba2eff76", "url": "https://github.com/DataDog/dd-trace-java/commit/06e4c04897938ff56d8d3c5cbceeec67ba2eff76", "message": "Remove WeakReference tracking from PendingTrace\n\nThis means we rely on the delay from PendingTraceBuffer to report traces where the root span is finished but the pendingReference count is not 0. No more cleaning required.", "committedDate": "2020-10-06T14:44:51Z", "type": "commit"}, {"oid": "06e4c04897938ff56d8d3c5cbceeec67ba2eff76", "url": "https://github.com/DataDog/dd-trace-java/commit/06e4c04897938ff56d8d3c5cbceeec67ba2eff76", "message": "Remove WeakReference tracking from PendingTrace\n\nThis means we rely on the delay from PendingTraceBuffer to report traces where the root span is finished but the pendingReference count is not 0. No more cleaning required.", "committedDate": "2020-10-06T14:44:51Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDM3NzkxMw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1952#discussion_r500377913", "bodyText": "Now that there is no reference, should we change the name of expiredReference?", "author": "dougqh", "createdAt": "2020-10-06T15:15:15Z", "path": "dd-trace-core/src/main/java/datadog/trace/core/PendingTrace.java", "diffHunk": "@@ -250,30 +201,16 @@ long oldestFinishedTime() {\n    */\n   @Override\n   public void registerContinuation(final AgentScope.Continuation continuation) {\n-    synchronized (continuation) {\n-      if (!continuation.isRegistered()) {\n-        weakContinuations.add(continuation.register(continuationReferenceQueue));\n-        final int count = pendingReferenceCount.incrementAndGet();\n-        if (log.isDebugEnabled()) {\n-          log.debug(\n-              \"t_id={} -> registered continuation {} -- count = {}\", traceId, continuation, count);\n-        }\n-      } else {\n-        log.debug(\"continuation {} already registered in trace {}\", continuation, traceId);\n-      }\n+    final int count = pendingReferenceCount.incrementAndGet();\n+    if (log.isDebugEnabled()) {\n+      log.debug(\n+          \"t_id={} -> registered continuation {} -- count = {}\", traceId, continuation, count);\n     }\n   }\n \n   @Override\n   public void cancelContinuation(final AgentScope.Continuation continuation) {\n-    synchronized (continuation) {\n-      if (continuation.isRegistered()) {\n-        continuation.cancel(weakContinuations);\n-        expireReference(false);\n-      } else {\n-        log.debug(\"t_id={} -> not registered in trace: {}\", traceId, continuation);\n-      }\n-    }\n+    expireReference(false);\n   }\n \n   private void expireReference(boolean isRootSpan) {", "originalCommit": "06e4c04897938ff56d8d3c5cbceeec67ba2eff76", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ4NzUzNQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1952#discussion_r500487535", "bodyText": "I renamed it, but not in love with the new name.", "author": "tylerbenson", "createdAt": "2020-10-06T17:52:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDM3NzkxMw=="}], "type": "inlineReview", "revised_code": {"commit": "3361392a9b80dc3f222bb8c708abb84540191084", "chunk": "diff --git a/dd-trace-core/src/main/java/datadog/trace/core/PendingTrace.java b/dd-trace-core/src/main/java/datadog/trace/core/PendingTrace.java\nindex b3b3e84d1f..9d5318eff6 100644\n--- a/dd-trace-core/src/main/java/datadog/trace/core/PendingTrace.java\n+++ b/dd-trace-core/src/main/java/datadog/trace/core/PendingTrace.java\n\n@@ -210,10 +210,10 @@ public class PendingTrace implements AgentTrace {\n \n   @Override\n   public void cancelContinuation(final AgentScope.Continuation continuation) {\n-    expireReference(false);\n+    decrementRefAndMaybeWrite(false);\n   }\n \n-  private void expireReference(boolean isRootSpan) {\n+  private void decrementRefAndMaybeWrite(boolean isRootSpan) {\n     if (!traceValid.get()) {\n       return;\n     }\n"}}, {"oid": "3361392a9b80dc3f222bb8c708abb84540191084", "url": "https://github.com/DataDog/dd-trace-java/commit/3361392a9b80dc3f222bb8c708abb84540191084", "message": "Update method name and revapi", "committedDate": "2020-10-06T15:47:59Z", "type": "commit"}, {"oid": "f4df4b62a5f0194627e39cd31537a148f640a1a4", "url": "https://github.com/DataDog/dd-trace-java/commit/f4df4b62a5f0194627e39cd31537a148f640a1a4", "message": "Merge branch 'master' into tyler/remove-weakref-pendingtrace\n\n# Conflicts:\n#\tdd-trace-core/src/main/java/datadog/trace/core/PendingTrace.java", "committedDate": "2020-10-07T15:45:35Z", "type": "commit"}]}