{"pr_number": 1755, "pr_title": "Add Invocation Caller API to internal-api", "pr_createdAt": "2020-08-06T15:04:01Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/1755", "timeline": [{"oid": "c6bab2d9b8d5bc1b5c331b6b83176881d8d34f5f", "url": "https://github.com/DataDog/dd-trace-java/commit/c6bab2d9b8d5bc1b5c331b6b83176881d8d34f5f", "message": "Add Invocation Caller API to internal-api", "committedDate": "2020-08-06T15:00:02Z", "type": "commit"}, {"oid": "3187d1449c64630d600ceb5cffe0ebc047f2cf31", "url": "https://github.com/DataDog/dd-trace-java/commit/3187d1449c64630d600ceb5cffe0ebc047f2cf31", "message": "Allow impl-classes of different bytecode level in bootstrap", "committedDate": "2020-08-06T15:46:44Z", "type": "commit"}, {"oid": "efa9d48e8a490f72534260a33374080cb6868b06", "url": "https://github.com/DataDog/dd-trace-java/commit/efa9d48e8a490f72534260a33374080cb6868b06", "message": "Allow impl-classes of different bytecode level in bootstrap", "committedDate": "2020-08-06T16:00:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjUzMzAwOQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1755#discussion_r466533009", "bodyText": "It seems that's incorrect, it will return null, no?", "author": "jpbempel", "createdAt": "2020-08-06T16:23:56Z", "path": "internal-api/src/main/java/datadog/trace/mlt/Invocation.java", "diffHunk": "@@ -0,0 +1,102 @@\n+package datadog.trace.mlt;\n+\n+import java.lang.reflect.Constructor;\n+import java.util.List;\n+import java.util.Objects;\n+import lombok.NonNull;\n+import lombok.extern.slf4j.Slf4j;\n+\n+@Slf4j\n+public final class Invocation {\n+  static final int INVOCATION_OFFSET = 3;\n+\n+  /**\n+   * A simple data class representing an invocation caller. Provides the caller class and method\n+   * name.\n+   */\n+  public static final class Caller {\n+    public final String className;\n+    public final String methodName;\n+\n+    Caller(String className, String methodName) {\n+      this.className = className;\n+      this.methodName = methodName;\n+    }\n+\n+    @Override\n+    public boolean equals(Object o) {\n+      if (this == o) {\n+        return true;\n+      }\n+      if (o == null || getClass() != o.getClass()) {\n+        return false;\n+      }\n+      Caller caller = (Caller) o;\n+      return className.equals(caller.className) && Objects.equals(methodName, caller.methodName);\n+    }\n+\n+    @Override\n+    public int hashCode() {\n+      return Objects.hash(className, methodName);\n+    }\n+  }\n+\n+  /**\n+   * Invocation caller detection can use StackWalker API which available in Java 9+ only. Therefore\n+   * abstracting the common interface which can be implemented by the default (pre Java 9)\n+   * implementation and the post Java 9 one as well.\n+   */\n+  public interface Impl {\n+    @NonNull\n+    Caller getCaller(int offset);\n+\n+    @NonNull\n+    List<Caller> getCallers();\n+  }\n+\n+  private static final Invocation.Impl impl;\n+\n+  static {\n+    Invocation.Impl rtImpl = new InvocationImplDefault();\n+    try {\n+      Runtime.class.getMethod(\"version\");\n+      Constructor<?> constructor =\n+          Class.forName(Invocation.class.getPackage().getName() + \".InvocationImpl9\")\n+              .getDeclaredConstructor();\n+      constructor.setAccessible(true);\n+      rtImpl = (Invocation.Impl) constructor.newInstance();\n+    } catch (NoSuchMethodException ignored) {\n+      // running on pre-9 Java; silently ignore and use the default impl\n+    } catch (Throwable t) {\n+      log.info(\n+          \"Unable to instantiate StackWalker API based invocation caller impl. Using the default one.\",\n+          t);\n+    }\n+\n+    impl = rtImpl;\n+  }\n+\n+  /**\n+   * Get the method {@linkplain Caller} adjusted by offset. An offset of 0 will return the immediate\n+   * caller.\n+   *\n+   * @param offset the offset to adjust the caller stackframe by\n+   * @return the {@linkplain Caller} located {@literal offset} stackframes above the called method;\n+   *     if the offset is bigger than the current stack depth the callstack root will be returned\n+   *     instead", "originalCommit": "efa9d48e8a490f72534260a33374080cb6868b06", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjkxMDUxOA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1755#discussion_r466910518", "bodyText": "Yes, good catch. Fixed.", "author": "jbachorik", "createdAt": "2020-08-07T08:51:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjUzMzAwOQ=="}], "type": "inlineReview", "revised_code": {"commit": "9e3bfaeb699ebb526221a3e7c0f9db1d3e99f948", "chunk": "diff --git a/internal-api/src/main/java/datadog/trace/mlt/Invocation.java b/internal-api/src/main/java/datadog/trace/mlt/Invocation.java\nindex 459951579a..05caf93e80 100644\n--- a/internal-api/src/main/java/datadog/trace/mlt/Invocation.java\n+++ b/internal-api/src/main/java/datadog/trace/mlt/Invocation.java\n\n@@ -61,7 +61,7 @@ public final class Invocation {\n     try {\n       Runtime.class.getMethod(\"version\");\n       Constructor<?> constructor =\n-          Class.forName(Invocation.class.getPackage().getName() + \".InvocationImpl9\")\n+          Class.forName(Invocation.class.getPackage().getName() + \".InvocationImplStackWalker\")\n               .getDeclaredConstructor();\n       constructor.setAccessible(true);\n       rtImpl = (Invocation.Impl) constructor.newInstance();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjUzNTM5MA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1755#discussion_r466535390", "bodyText": "nit: why not directly creating an ArrayList with the right capacity (based on callerLength) and add Callers inside the list and returning it directly?", "author": "jpbempel", "createdAt": "2020-08-06T16:28:00Z", "path": "internal-api/src/main/java/datadog/trace/mlt/InvocationImplDefault.java", "diffHunk": "@@ -0,0 +1,56 @@\n+package datadog.trace.mlt;\n+\n+import static datadog.trace.mlt.Invocation.INVOCATION_OFFSET;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+import lombok.NonNull;\n+import lombok.extern.slf4j.Slf4j;\n+\n+/**\n+ * Default implementation of the invocation caller detection. Works for all Java versions from 7\n+ * till the latest current one. The downside is a slight performance hit and the inability to report\n+ * the caller method name.\n+ */\n+@Slf4j\n+final class InvocationImplDefault implements Invocation.Impl {\n+  private static final class WhoCalledSM extends SecurityManager {\n+    @Override\n+    public Class<?>[] getClassContext() {\n+      return super.getClassContext();\n+    }\n+  }\n+\n+  private static final WhoCalledSM ACCESSOR = new WhoCalledSM();\n+\n+  @Override\n+  @NonNull\n+  public Invocation.Caller getCaller(int offset) {\n+    if (offset < 0) {\n+      throw new IllegalArgumentException();\n+    }\n+\n+    offset += INVOCATION_OFFSET;\n+\n+    Class<?>[] list = ACCESSOR.getClassContext();\n+\n+    if (list.length <= offset) {\n+      return null;\n+    }\n+\n+    return new Invocation.Caller(list[offset].getName(), null);\n+  }\n+\n+  @Override\n+  @NonNull\n+  public List<Invocation.Caller> getCallers() {\n+    Class<?>[] list = ACCESSOR.getClassContext();\n+    int callerLength = Math.max(list.length - INVOCATION_OFFSET, 0);\n+    Invocation.Caller[] callers = new Invocation.Caller[callerLength];", "originalCommit": "efa9d48e8a490f72534260a33374080cb6868b06", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjkxMDgwNA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1755#discussion_r466910804", "bodyText": "Hm, I don't know :) it makes sense to do it the simplest way - done.", "author": "jbachorik", "createdAt": "2020-08-07T08:52:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjUzNTM5MA=="}], "type": "inlineReview", "revised_code": {"commit": "9e3bfaeb699ebb526221a3e7c0f9db1d3e99f948", "chunk": "diff --git a/internal-api/src/main/java/datadog/trace/mlt/InvocationImplDefault.java b/internal-api/src/main/java/datadog/trace/mlt/InvocationImplDefault.java\nindex 5577aa98c6..7c5568d673 100644\n--- a/internal-api/src/main/java/datadog/trace/mlt/InvocationImplDefault.java\n+++ b/internal-api/src/main/java/datadog/trace/mlt/InvocationImplDefault.java\n\n@@ -2,7 +2,7 @@ package datadog.trace.mlt;\n \n import static datadog.trace.mlt.Invocation.INVOCATION_OFFSET;\n \n-import java.util.Arrays;\n+import java.util.ArrayList;\n import java.util.List;\n import lombok.NonNull;\n import lombok.extern.slf4j.Slf4j;\n"}}, {"oid": "9e3bfaeb699ebb526221a3e7c0f9db1d3e99f948", "url": "https://github.com/DataDog/dd-trace-java/commit/9e3bfaeb699ebb526221a3e7c0f9db1d3e99f948", "message": "Address review comments", "committedDate": "2020-08-07T08:50:43Z", "type": "commit"}, {"oid": "1c33dc7dca3b30c53c8c4429a22079693c56e055", "url": "https://github.com/DataDog/dd-trace-java/commit/1c33dc7dca3b30c53c8c4429a22079693c56e055", "message": "Formatting!", "committedDate": "2020-08-07T09:05:38Z", "type": "commit"}, {"oid": "b30fd8fd4030dc6a2fb7da0e057598cb4638fe24", "url": "https://github.com/DataDog/dd-trace-java/commit/b30fd8fd4030dc6a2fb7da0e057598cb4638fe24", "message": "No need for junit platform.\nIt just makes Java 7 tests fail.", "committedDate": "2020-08-07T10:35:34Z", "type": "commit"}, {"oid": "725b479429e607aa6cf7b24ffdfa9440c1e57e3e", "url": "https://github.com/DataDog/dd-trace-java/commit/725b479429e607aa6cf7b24ffdfa9440c1e57e3e", "message": "Add jacoco exclude", "committedDate": "2020-08-07T10:56:48Z", "type": "commit"}, {"oid": "f26574c58b70ef78a7239798268e67d22ebc9612", "url": "https://github.com/DataDog/dd-trace-java/commit/f26574c58b70ef78a7239798268e67d22ebc9612", "message": "Add jacoco exclude", "committedDate": "2020-08-07T12:16:42Z", "type": "commit"}]}