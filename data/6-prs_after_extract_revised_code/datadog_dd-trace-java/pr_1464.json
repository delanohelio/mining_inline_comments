{"pr_number": 1464, "pr_title": "Change LZ4 config to reduce allocation rate during decompression", "pr_createdAt": "2020-05-15T12:48:08Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/1464", "timeline": [{"oid": "49aa269a952f315f69dea9c7d93400fcd4169243", "url": "https://github.com/DataDog/dd-trace-java/commit/49aa269a952f315f69dea9c7d93400fcd4169243", "message": "Modify LZ4 blocksize and set expected size", "committedDate": "2020-06-23T14:04:02Z", "type": "forcePushed"}, {"oid": "4ff8d469d82989aed8ac6666341246df84b2bcf9", "url": "https://github.com/DataDog/dd-trace-java/commit/4ff8d469d82989aed8ac6666341246df84b2bcf9", "message": "Modify LZ4 blocksize", "committedDate": "2020-06-25T10:55:30Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTQ5Mzk4Ng==", "url": "https://github.com/DataDog/dd-trace-java/pull/1464#discussion_r445493986", "bodyText": "It may be nice to leave some comment here explaining what is going on and what all other values mean or where there are coming from.", "author": "mar-kolya", "createdAt": "2020-06-25T11:37:41Z", "path": "dd-java-agent/agent-profiling/profiling-uploader/src/main/java/com/datadog/profiling/uploader/util/StreamUtils.java", "diffHunk": "@@ -73,7 +73,13 @@\n       return readStream(is, expectedSize, consumer);\n     } else {\n       final FastByteArrayOutputStream baos = new FastByteArrayOutputStream(expectedSize);\n-      try (final OutputStream zipped = new LZ4FrameOutputStream(baos)) {\n+      try (final OutputStream zipped =\n+          new LZ4FrameOutputStream(\n+              baos,\n+              LZ4FrameOutputStream.BLOCKSIZE.SIZE_64KB,\n+              LZ4FrameOutputStream.FLG.Bits.BLOCK_CHECKSUM,\n+              LZ4FrameOutputStream.FLG.Bits.CONTENT_CHECKSUM,\n+              LZ4FrameOutputStream.FLG.Bits.BLOCK_INDEPENDENCE)) {", "originalCommit": "4ff8d469d82989aed8ac6666341246df84b2bcf9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTQ5ODkxNA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1464#discussion_r445498914", "bodyText": "Ok", "author": "jbachorik", "createdAt": "2020-06-25T11:47:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTQ5Mzk4Ng=="}], "type": "inlineReview", "revised_code": {"commit": "ebdffd219161284b1bfa601a71ef6cf9ada1faa4", "chunk": "diff --git a/dd-java-agent/agent-profiling/profiling-uploader/src/main/java/com/datadog/profiling/uploader/util/StreamUtils.java b/dd-java-agent/agent-profiling/profiling-uploader/src/main/java/com/datadog/profiling/uploader/util/StreamUtils.java\nindex 6fcf7a826d..ea5b630bef 100644\n--- a/dd-java-agent/agent-profiling/profiling-uploader/src/main/java/com/datadog/profiling/uploader/util/StreamUtils.java\n+++ b/dd-java-agent/agent-profiling/profiling-uploader/src/main/java/com/datadog/profiling/uploader/util/StreamUtils.java\n\n@@ -74,11 +74,10 @@ public final class StreamUtils {\n     } else {\n       final FastByteArrayOutputStream baos = new FastByteArrayOutputStream(expectedSize);\n       try (final OutputStream zipped =\n-          new LZ4FrameOutputStream(\n+        new LZ4FrameOutputStream(\n               baos,\n               LZ4FrameOutputStream.BLOCKSIZE.SIZE_64KB,\n-              LZ4FrameOutputStream.FLG.Bits.BLOCK_CHECKSUM,\n-              LZ4FrameOutputStream.FLG.Bits.CONTENT_CHECKSUM,\n+              // copy of the default flag(s) used by LZ4FrameOutputStream\n               LZ4FrameOutputStream.FLG.Bits.BLOCK_INDEPENDENCE)) {\n         copy(is, zipped);\n       }\n"}}, {"oid": "13931aadc6d91a4fdfe9ef57721fc3e88db267aa", "url": "https://github.com/DataDog/dd-trace-java/commit/13931aadc6d91a4fdfe9ef57721fc3e88db267aa", "message": "Modify LZ4 blocksize", "committedDate": "2020-06-25T14:28:29Z", "type": "commit"}, {"oid": "ebdffd219161284b1bfa601a71ef6cf9ada1faa4", "url": "https://github.com/DataDog/dd-trace-java/commit/ebdffd219161284b1bfa601a71ef6cf9ada1faa4", "message": "Revert back to the default bits and add comment", "committedDate": "2020-06-25T14:28:29Z", "type": "commit"}, {"oid": "9385ec1b2773056601c4d89f2bfb76a01f8a6693", "url": "https://github.com/DataDog/dd-trace-java/commit/9385ec1b2773056601c4d89f2bfb76a01f8a6693", "message": "Format", "committedDate": "2020-06-25T14:28:29Z", "type": "commit"}, {"oid": "9385ec1b2773056601c4d89f2bfb76a01f8a6693", "url": "https://github.com/DataDog/dd-trace-java/commit/9385ec1b2773056601c4d89f2bfb76a01f8a6693", "message": "Format", "committedDate": "2020-06-25T14:28:29Z", "type": "forcePushed"}]}