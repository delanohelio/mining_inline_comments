{"pr_number": 2334, "pr_title": "Issue #2332: Delete refit file if unable to read it back when saving", "pr_createdAt": "2020-12-29T20:17:23Z", "pr_url": "https://github.com/MegaMek/mekhq/pull/2334", "timeline": [{"oid": "21c3eb4e65ee63f7a1f1aff7ec1b817b330eec47", "url": "https://github.com/MegaMek/mekhq/commit/21c3eb4e65ee63f7a1f1aff7ec1b817b330eec47", "message": "Delete refit file if unable to read it, fixes #2332", "committedDate": "2020-12-29T20:11:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTg5MDkyMA==", "url": "https://github.com/MegaMek/mekhq/pull/2334#discussion_r549890920", "bodyText": "Space after //, and equip should be the full word", "author": "Windchild292", "createdAt": "2020-12-29T23:55:39Z", "path": "MekHQ/src/mekhq/campaign/parts/Refit.java", "diffHunk": "@@ -1558,41 +1558,67 @@ public void saveCustomization() throws EntityLoadingException {\n             }\n         }\n \n+        String fileNameCampaign;\n         try {\n             if (newEntity instanceof Mech) {\n                 //if this file already exists then don't overwrite it or we will end up with a bunch of copies\n                 String fileOutName = sCustomsDir + File.separator + fileName + \".mtf\";\n-                String fileNameCampaign = sCustomsDirCampaign + File.separator + fileName + \".mtf\";\n+                fileNameCampaign = sCustomsDirCampaign + File.separator + fileName + \".mtf\";\n                 if ((new File(fileOutName)).exists() || (new File(fileNameCampaign)).exists()) {\n                     throw new IOException(\"A file already exists with the custom name \"+fileNameCampaign+\". Please choose a different name. (Unit name and/or model)\");\n                 }\n-                FileOutputStream out = new FileOutputStream(fileNameCampaign);\n-                PrintStream p = new PrintStream(out);\n-                p.println(((Mech) newEntity).getMtf());\n-                p.close();\n-                out.close();\n+                try (FileOutputStream out = new FileOutputStream(fileNameCampaign);\n+                    PrintStream p = new PrintStream(out)) {\n+                    p.println(((Mech) newEntity).getMtf());\n+                }\n             } else {\n                 //if this file already exists then don't overwrite it or we will end up with a bunch of copies\n                 String fileOutName = sCustomsDir + File.separator + fileName + \".blk\";\n-                String fileNameCampaign = sCustomsDirCampaign + File.separator + fileName + \".blk\";\n+                fileNameCampaign = sCustomsDirCampaign + File.separator + fileName + \".blk\";\n                 if ((new File(fileOutName)).exists() || (new File(fileNameCampaign)).exists()) {\n                     throw new IOException(\"A file already exists with the custom name \"+fileNameCampaign+\". Please choose a different name. (Unit name and/or model)\");\n                 }\n                 BLKFile.encode(fileNameCampaign, newEntity);\n             }\n         } catch (Exception e) {\n             MekHQ.getLogger().error(e);\n+            fileNameCampaign = null;\n         }\n+\n         getCampaign().addCustom(newEntity.getChassis() + \" \" + newEntity.getModel());\n-        MechSummaryCache.getInstance().loadMechData();\n-        //I need to change the new entity to the one from the mtf file now, so that equip\n-        //numbers will match\n-        MechSummary summary = MechSummaryCache.getInstance().getMech(newEntity.getChassis() + \" \" + newEntity.getModel());\n-        if (null == summary) {\n-            throw(new EntityLoadingException());\n-        }\n \n-        newEntity = new MechFileParser(summary.getSourceFile(), summary.getEntryName()).getEntity();\n+        try {\n+            MechSummaryCache.getInstance().loadMechData();\n+\n+            //I need to change the new entity to the one from the mtf file now, so that equip\n+            //numbers will match", "originalCommit": "21c3eb4e65ee63f7a1f1aff7ec1b817b330eec47", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "139733141537fc2ffff80e3a40e6fd2b1ebe4c11", "chunk": "diff --git a/MekHQ/src/mekhq/campaign/parts/Refit.java b/MekHQ/src/mekhq/campaign/parts/Refit.java\nindex 83c418919..a67b6bd86 100644\n--- a/MekHQ/src/mekhq/campaign/parts/Refit.java\n+++ b/MekHQ/src/mekhq/campaign/parts/Refit.java\n\n@@ -1561,7 +1561,7 @@ public class Refit extends Part implements IAcquisitionWork {\n         String fileNameCampaign;\n         try {\n             if (newEntity instanceof Mech) {\n-                //if this file already exists then don't overwrite it or we will end up with a bunch of copies\n+                // if this file already exists then don't overwrite it or we will end up with a bunch of copies\n                 String fileOutName = sCustomsDir + File.separator + fileName + \".mtf\";\n                 fileNameCampaign = sCustomsDirCampaign + File.separator + fileName + \".mtf\";\n                 if ((new File(fileOutName)).exists() || (new File(fileNameCampaign)).exists()) {\n"}}, {"oid": "139733141537fc2ffff80e3a40e6fd2b1ebe4c11", "url": "https://github.com/MegaMek/mekhq/commit/139733141537fc2ffff80e3a40e6fd2b1ebe4c11", "message": "Update Refit.java", "committedDate": "2020-12-30T01:30:56Z", "type": "commit"}]}