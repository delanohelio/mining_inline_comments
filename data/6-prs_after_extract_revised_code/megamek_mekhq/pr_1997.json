{"pr_number": 1997, "pr_title": "AtB Lance By Role BugFix", "pr_createdAt": "2020-09-07T16:07:42Z", "pr_url": "https://github.com/MegaMek/mekhq/pull/1997", "timeline": [{"oid": "a2d0323e79f5df976f52f8500f63f93aa09a1029", "url": "https://github.com/MegaMek/mekhq/commit/a2d0323e79f5df976f52f8500f63f93aa09a1029", "message": "Converting Battle Role to Int", "committedDate": "2020-09-07T16:05:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDUxMTc1OA==", "url": "https://github.com/MegaMek/mekhq/pull/1997#discussion_r484511758", "bodyText": "How will this handle older saves?", "author": "sixlettervariables", "createdAt": "2020-09-07T16:19:08Z", "path": "MekHQ/src/mekhq/campaign/CampaignOptions.java", "diffHunk": "@@ -3852,14 +3852,14 @@ public static CampaignOptions generateCampaignOptionsFromXml(Node wn) {\n             } else if (wn2.getNodeName().equalsIgnoreCase(\"intensity\")) { // Legacy\n                 double intensity = Double.parseDouble(wn2.getTextContent().trim());\n \n-                retVal.atbBattleChance[AtBLanceRole.FIGHTING.ordinal()] = ((40.0 * intensity) / (40.0 * intensity + 60.0)) * 100.0 + 0.5;\n-                retVal.atbBattleChance[AtBLanceRole.DEFENCE.ordinal()] = ((20.0 * intensity) / (20.0 * intensity + 80.0)) * 100.0 + 0.5;\n-                retVal.atbBattleChance[AtBLanceRole.SCOUTING.ordinal()] = ((60.0 * intensity) / (60.0 * intensity + 40.0)) * 100.0 + 0.5;\n-                retVal.atbBattleChance[AtBLanceRole.TRAINING.ordinal()] = ((10.0 * intensity) / (10.0 * intensity + 90.0)) * 100.0 + 0.5;\n+                retVal.atbBattleChance[AtBLanceRole.FIGHTING.ordinal()] = (int) Math.round(((40.0 * intensity) / (40.0 * intensity + 60.0)) * 100.0 + 0.5);\n+                retVal.atbBattleChance[AtBLanceRole.DEFENCE.ordinal()] = (int) Math.round(((20.0 * intensity) / (20.0 * intensity + 80.0)) * 100.0 + 0.5);\n+                retVal.atbBattleChance[AtBLanceRole.SCOUTING.ordinal()] = (int) Math.round(((60.0 * intensity) / (60.0 * intensity + 40.0)) * 100.0 + 0.5);\n+                retVal.atbBattleChance[AtBLanceRole.TRAINING.ordinal()] = (int) Math.round(((10.0 * intensity) / (10.0 * intensity + 90.0)) * 100.0 + 0.5);\n             } else if (wn2.getNodeName().equalsIgnoreCase(\"atbBattleChance\")) {\n                 String[] values = wn2.getTextContent().split(\",\");\n                 for (int i = 0; i < values.length; i++) {\n-                    retVal.atbBattleChance[i] = Double.parseDouble(values[i]);\n+                    retVal.atbBattleChance[i] = Integer.parseInt(values[i]);", "originalCommit": "a2d0323e79f5df976f52f8500f63f93aa09a1029", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDUxMzA0Nw==", "url": "https://github.com/MegaMek/mekhq/pull/1997#discussion_r484513047", "bodyText": "Not been on any released versions, so I didn't think it would be necessary... however just remembered that a few outside of the dev team have been using this, so I'll add migration now.", "author": "Windchild292", "createdAt": "2020-09-07T16:23:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDUxMTc1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDUxNTk5Mg==", "url": "https://github.com/MegaMek/mekhq/pull/1997#discussion_r484515992", "bodyText": "Implemented a (not great, but working) migration method. We want it to fail if it can't parse the boolean.", "author": "Windchild292", "createdAt": "2020-09-07T16:32:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDUxMTc1OA=="}], "type": "inlineReview", "revised_code": {"commit": "eafec759d8b50ab59eb64dab0b887bdc1886e186", "chunk": "diff --git a/MekHQ/src/mekhq/campaign/CampaignOptions.java b/MekHQ/src/mekhq/campaign/CampaignOptions.java\nindex efbe5c37d..98a5a9a2a 100644\n--- a/MekHQ/src/mekhq/campaign/CampaignOptions.java\n+++ b/MekHQ/src/mekhq/campaign/CampaignOptions.java\n\n@@ -3859,7 +3859,14 @@ public class CampaignOptions implements Serializable {\n             } else if (wn2.getNodeName().equalsIgnoreCase(\"atbBattleChance\")) {\n                 String[] values = wn2.getTextContent().split(\",\");\n                 for (int i = 0; i < values.length; i++) {\n-                    retVal.atbBattleChance[i] = Integer.parseInt(values[i]);\n+                    try {\n+                        retVal.atbBattleChance[i] = Integer.parseInt(values[i]);\n+                    } catch (Exception ignored) {\n+                        // Badly coded, but this is to migrate devs and their games as the swap was\n+                        // done before a release and is thus better to handle this way than through\n+                        // a more code complex method\n+                        retVal.atbBattleChance[i] = (int) Math.round(Double.parseDouble(values[i]));\n+                    }\n                 }\n             } else if (wn2.getNodeName().equalsIgnoreCase(\"generateChases\")) {\n                 retVal.setGenerateChases(Boolean.parseBoolean(wn2.getTextContent().trim()));\n"}}, {"oid": "eafec759d8b50ab59eb64dab0b887bdc1886e186", "url": "https://github.com/MegaMek/mekhq/commit/eafec759d8b50ab59eb64dab0b887bdc1886e186", "message": "Implementing migration", "committedDate": "2020-09-07T16:31:40Z", "type": "commit"}]}