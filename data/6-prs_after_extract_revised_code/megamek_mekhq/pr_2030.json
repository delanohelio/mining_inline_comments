{"pr_number": 2030, "pr_title": "AmmoBin from warehouse can rarely come with free ammo", "pr_createdAt": "2020-09-21T03:24:32Z", "pr_url": "https://github.com/MegaMek/mekhq/pull/2030", "timeline": [{"oid": "9e595fc94c7a615f10d12451cbe87a3b97e03485", "url": "https://github.com/MegaMek/mekhq/commit/9e595fc94c7a615f10d12451cbe87a3b97e03485", "message": "fix for AmmoBin from warehouse can rarely come with free ammo", "committedDate": "2020-09-21T03:21:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTc3ODkyMA==", "url": "https://github.com/MegaMek/mekhq/pull/2030#discussion_r491778920", "bodyText": "This should be able to use updateConditionFromEntity to fix the mismatch first.", "author": "Windchild292", "createdAt": "2020-09-21T03:28:16Z", "path": "MekHQ/src/mekhq/Utilities.java", "diffHunk": "@@ -1170,7 +1170,16 @@ public static void unscrambleEquipmentNumbers(Unit unit, boolean refit) {\n                         if (refit) {\n                             if (m.getType().equals(epart.getType()) && !m.isDestroyed()) {\n                                 epart.setEquipmentNum(equipNum);\n-                                ((AmmoBin) epart).changeMunition(m.getType());\n+                                AmmoBin bin = (AmmoBin) epart;\n+                                // Unload bin before munition change\n+                                // TODO: if part's unit is set, both .unload() and .changeMunition check entity's\n+                                // TODO: bin instead of unit's bin. The bins can be out of sync here,\n+                                // TODO: resulting in full bins replacing empty bins\n+                                // TODO: work-around is to clear then restore part's unit\n+                                bin.setUnit(null);\n+                                bin.unload();\n+                                bin.changeMunition(m.getType());\n+                                bin.setUnit(unit);", "originalCommit": "9e595fc94c7a615f10d12451cbe87a3b97e03485", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTc3OTM2Mw==", "url": "https://github.com/MegaMek/mekhq/pull/2030#discussion_r491779363", "bodyText": "In this case, the Entity has the wrong value though.  Is there a function to update the entity from the unit/part?", "author": "RexPearce", "createdAt": "2020-09-21T03:30:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTc3ODkyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTc3OTg5OQ==", "url": "https://github.com/MegaMek/mekhq/pull/2030#discussion_r491779899", "bodyText": ".updateConditionFromPart looks promising", "author": "RexPearce", "createdAt": "2020-09-21T03:33:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTc3ODkyMA=="}], "type": "inlineReview", "revised_code": {"commit": "f2ff38b2840b3967c8ebac66f60df90e47ba4e25", "chunk": "diff --git a/MekHQ/src/mekhq/Utilities.java b/MekHQ/src/mekhq/Utilities.java\nindex d39272e05..7e765f67a 100644\n--- a/MekHQ/src/mekhq/Utilities.java\n+++ b/MekHQ/src/mekhq/Utilities.java\n\n@@ -1171,15 +1171,11 @@ public class Utilities {\n                             if (m.getType().equals(epart.getType()) && !m.isDestroyed()) {\n                                 epart.setEquipmentNum(equipNum);\n                                 AmmoBin bin = (AmmoBin) epart;\n+                                // Ensure Entity is synch'd with part\n+                                bin.updateConditionFromPart();\n                                 // Unload bin before munition change\n-                                // TODO: if part's unit is set, both .unload() and .changeMunition check entity's\n-                                // TODO: bin instead of unit's bin. The bins can be out of sync here,\n-                                // TODO: resulting in full bins replacing empty bins\n-                                // TODO: work-around is to clear then restore part's unit\n-                                bin.setUnit(null);\n                                 bin.unload();\n                                 bin.changeMunition(m.getType());\n-                                bin.setUnit(unit);\n                                 found = true;\n                                 break;\n                             }\n"}}, {"oid": "f2ff38b2840b3967c8ebac66f60df90e47ba4e25", "url": "https://github.com/MegaMek/mekhq/commit/f2ff38b2840b3967c8ebac66f60df90e47ba4e25", "message": "update Entity from AmmoBin instead of work-around", "committedDate": "2020-09-21T03:42:44Z", "type": "commit"}]}