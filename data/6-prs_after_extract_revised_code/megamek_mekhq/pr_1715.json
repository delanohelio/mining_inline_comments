{"pr_number": 1715, "pr_title": "Prisoner Status Enum", "pr_createdAt": "2020-05-01T17:49:47Z", "pr_url": "https://github.com/MegaMek/mekhq/pull/1715", "timeline": [{"oid": "34e0193028d19f635580a7793c30e0ab386ec0e4", "url": "https://github.com/MegaMek/mekhq/commit/34e0193028d19f635580a7793c30e0ab386ec0e4", "message": "Adding and implementing the PrisonerStatus enum", "committedDate": "2020-04-07T03:54:14Z", "type": "commit"}, {"oid": "a53a2d148127ee9203907ac9e1c0510712c22f4d", "url": "https://github.com/MegaMek/mekhq/commit/a53a2d148127ee9203907ac9e1c0510712c22f4d", "message": "Adding comments explaining the enum choice", "committedDate": "2020-04-07T03:55:20Z", "type": "commit"}, {"oid": "9c26a2617e35ea9ebee2ae6f976709083046aa55", "url": "https://github.com/MegaMek/mekhq/commit/9c26a2617e35ea9ebee2ae6f976709083046aa55", "message": "Fixing merge conflicts", "committedDate": "2020-04-11T14:29:08Z", "type": "commit"}, {"oid": "9b916ef3f09b28a560f8fcb6b8924ade16b02f33", "url": "https://github.com/MegaMek/mekhq/commit/9b916ef3f09b28a560f8fcb6b8924ade16b02f33", "message": "Rework using lessons learned from BabySurname implemenation", "committedDate": "2020-04-11T15:02:48Z", "type": "commit"}, {"oid": "9242bd9c84d47d4be4e47a89c4331eb00a1efcbb", "url": "https://github.com/MegaMek/mekhq/commit/9242bd9c84d47d4be4e47a89c4331eb00a1efcbb", "message": "Fixing spacing issues", "committedDate": "2020-04-11T15:07:07Z", "type": "commit"}, {"oid": "d1430caf8f73a963573b6b78fd7956eca5222dde", "url": "https://github.com/MegaMek/mekhq/commit/d1430caf8f73a963573b6b78fd7956eca5222dde", "message": "Adding Prisoner Defector", "committedDate": "2020-04-11T15:39:55Z", "type": "commit"}, {"oid": "06ca470ac008f81042b734c3e218f41b898c83e6", "url": "https://github.com/MegaMek/mekhq/commit/06ca470ac008f81042b734c3e218f41b898c83e6", "message": "Improving how we do prisoners", "committedDate": "2020-04-11T15:40:40Z", "type": "commit"}, {"oid": "cdd8e7c9cd24b495753397bce4cd39a7faacbc5e", "url": "https://github.com/MegaMek/mekhq/commit/cdd8e7c9cd24b495753397bce4cd39a7faacbc5e", "message": "Adding setPrisonerStatus", "committedDate": "2020-04-11T15:53:25Z", "type": "commit"}, {"oid": "6277243f163f112b9ef2035688d80d6ffa095e52", "url": "https://github.com/MegaMek/mekhq/commit/6277243f163f112b9ef2035688d80d6ffa095e52", "message": "Removing WillingToDefect logic, as it is now an enum type", "committedDate": "2020-04-11T16:00:16Z", "type": "commit"}, {"oid": "714defd721559ce2c54773f5e227c4e0cfd49f3c", "url": "https://github.com/MegaMek/mekhq/commit/714defd721559ce2c54773f5e227c4e0cfd49f3c", "message": "Renaming PrisonerStatus to OppositionPersonnelStatus", "committedDate": "2020-04-11T16:07:21Z", "type": "commit"}, {"oid": "8dbce5c122315a39e49b070128ebac601b1a8757", "url": "https://github.com/MegaMek/mekhq/commit/8dbce5c122315a39e49b070128ebac601b1a8757", "message": "Adding bulk change prisoner status (this might be removed)", "committedDate": "2020-04-11T16:08:03Z", "type": "commit"}, {"oid": "7d2c8be12c8fed89d7efc27b0f53e6cefd2a60c1", "url": "https://github.com/MegaMek/mekhq/commit/7d2c8be12c8fed89d7efc27b0f53e6cefd2a60c1", "message": "Simplifying the code to significantly improve performance", "committedDate": "2020-04-11T16:09:09Z", "type": "commit"}, {"oid": "0b30fa8024c422882a79e83dcba20975b915ae87", "url": "https://github.com/MegaMek/mekhq/commit/0b30fa8024c422882a79e83dcba20975b915ae87", "message": "Implementing and merging methods for changing PrisonerStatus (as we currently have a few bugs relating to this)", "committedDate": "2020-04-11T16:52:50Z", "type": "commit"}, {"oid": "1f25fe58738bf90b484618591c1c7a0ddf6ce34e", "url": "https://github.com/MegaMek/mekhq/commit/1f25fe58738bf90b484618591c1c7a0ddf6ce34e", "message": "Removing all remaining comparisons that aren't part of PrisonerStatus", "committedDate": "2020-04-11T17:04:49Z", "type": "commit"}, {"oid": "3da6231afc92caac2778a7f3a07343a22ed73186", "url": "https://github.com/MegaMek/mekhq/commit/3da6231afc92caac2778a7f3a07343a22ed73186", "message": "Fixing recruitPerson calls, and finishing up the logic for how defectors can happen", "committedDate": "2020-04-11T18:51:51Z", "type": "commit"}, {"oid": "a38c489fddbe7725e755c59caa28a8dcc30ec2cb", "url": "https://github.com/MegaMek/mekhq/commit/a38c489fddbe7725e755c59caa28a8dcc30ec2cb", "message": "Applying changes from personal review, part 1", "committedDate": "2020-04-11T19:40:34Z", "type": "commit"}, {"oid": "7abf11da1e7f8741e4f73958ec949f3f612c7b95", "url": "https://github.com/MegaMek/mekhq/commit/7abf11da1e7f8741e4f73958ec949f3f612c7b95", "message": "Making imprison bulk usable", "committedDate": "2020-04-11T19:46:11Z", "type": "commit"}, {"oid": "595fe178aea358b2631169068e3baf8fa3593bff", "url": "https://github.com/MegaMek/mekhq/commit/595fe178aea358b2631169068e3baf8fa3593bff", "message": "Bulk imprison is now enabled", "committedDate": "2020-04-11T19:53:15Z", "type": "commit"}, {"oid": "962ab1c8ab38e5e9f03c2caaa1ce13b886eae9b5", "url": "https://github.com/MegaMek/mekhq/commit/962ab1c8ab38e5e9f03c2caaa1ce13b886eae9b5", "message": "Fixing merge conflict", "committedDate": "2020-04-13T20:25:03Z", "type": "commit"}, {"oid": "c5ca317b595f7cb3b82d5fcd7aa4e53db72e19df", "url": "https://github.com/MegaMek/mekhq/commit/c5ca317b595f7cb3b82d5fcd7aa4e53db72e19df", "message": "fixing merge conflicts", "committedDate": "2020-04-16T22:40:36Z", "type": "commit"}, {"oid": "c379832ece35d6ff4c9588e4feacc2fb9d9af946", "url": "https://github.com/MegaMek/mekhq/commit/c379832ece35d6ff4c9588e4feacc2fb9d9af946", "message": "Fixing merge conflicts", "committedDate": "2020-04-29T01:18:37Z", "type": "commit"}, {"oid": "72748fb21d642ec1a81bfa07dc1e57438f37bb93", "url": "https://github.com/MegaMek/mekhq/commit/72748fb21d642ec1a81bfa07dc1e57438f37bb93", "message": "Fixing merge conflicts", "committedDate": "2020-05-01T17:49:14Z", "type": "commit"}, {"oid": "e3c4762ecd5c5f399cd7f5ff2d4aaf47adaa9583", "url": "https://github.com/MegaMek/mekhq/commit/e3c4762ecd5c5f399cd7f5ff2d4aaf47adaa9583", "message": "Fixing merge conflicts", "committedDate": "2020-05-08T14:59:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDgxODkxNw==", "url": "https://github.com/MegaMek/mekhq/pull/1715#discussion_r424818917", "bodyText": "You probably still need to say which hash.", "author": "NickAragua", "createdAt": "2020-05-14T01:21:41Z", "path": "MekHQ/src/mekhq/campaign/ResolveScenarioTracker.java", "diffHunk": "@@ -951,24 +952,21 @@ private void processPrisonerCapture(List<TestUnit> unitsToProcess) {\n                 if (null != en.getCrew()) {\n                     currentHits = en.getCrew().getHits();\n                 }\n-                int newHits = (int) Math.max(0, currentHits - existingHits);\n-                casualties = (int) Math.ceil(Compute.getFullCrewSize(en) * (newHits/6.0));\n+                int newHits = Math.max(0, currentHits - existingHits);\n+                casualties = (int) Math.ceil(Compute.getFullCrewSize(en) * (newHits / 6.0));\n             }\n-            for(Person p : crew) {\n-                // Give them a UUID. We won't actually use this for the campaign, but to\n-                //identify them in the prisonerStatus hash\n-                UUID id = p.getId();\n-                if (null == id) {\n-                    id = UUID.randomUUID();\n-                    p.setId(id);\n-                }\n-                PrisonerStatus status = new PrisonerStatus(p.getFullName(), u.getEntity().getDisplayName(), p);\n+            for (Person p : crew) {\n+                // We need to assign them a UUID now to place them into the hash", "originalCommit": "e3c4762ecd5c5f399cd7f5ff2d4aaf47adaa9583", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjE5MzYxOA==", "url": "https://github.com/MegaMek/mekhq/pull/1715#discussion_r426193618", "bodyText": "Added clarification to the comment in question.", "author": "Windchild292", "createdAt": "2020-05-16T21:41:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDgxODkxNw=="}], "type": "inlineReview", "revised_code": {"commit": "51f47650ece1abcbdacbda91d80c4f798470143a", "chunk": "diff --git a/MekHQ/src/mekhq/campaign/ResolveScenarioTracker.java b/MekHQ/src/mekhq/campaign/ResolveScenarioTracker.java\nindex 8b08fad95..9c3beff34 100644\n--- a/MekHQ/src/mekhq/campaign/ResolveScenarioTracker.java\n+++ b/MekHQ/src/mekhq/campaign/ResolveScenarioTracker.java\n\n@@ -956,7 +956,7 @@ public class ResolveScenarioTracker {\n                 casualties = (int) Math.ceil(Compute.getFullCrewSize(en) * (newHits / 6.0));\n             }\n             for (Person p : crew) {\n-                // We need to assign them a UUID now to place them into the hash\n+                // We need to assign them a UUID now to place them into the oppositionPersonnel hash\n                 UUID id = (p.getId() == null) ? UUID.randomUUID() : p.getId();\n                 p.setId(id);\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDgxOTYxMg==", "url": "https://github.com/MegaMek/mekhq/pull/1715#discussion_r424819612", "bodyText": "Seems almost identical to the Bondsman functionality. Is this a) intended, and b) if it is, can it be consolidated?", "author": "NickAragua", "createdAt": "2020-05-14T01:24:23Z", "path": "MekHQ/src/mekhq/campaign/personnel/Person.java", "diffHunk": "@@ -516,44 +507,75 @@ public void setDependent(boolean tf) {\n         }\n     }\n \n-    public boolean isPrisoner() {\n-        return prisonerStatus == PRISONER_YES;\n-    }\n-\n-    public void setPrisoner() {\n-        prisonerStatus = PRISONER_YES;\n-        setRankNumeric(Ranks.RANK_PRISONER);\n-    }\n-\n-    public boolean isBondsman() {\n-        return prisonerStatus == PRISONER_BONDSMAN;\n-    }\n-\n-    public void setBondsman() {\n-        prisonerStatus = PRISONER_BONDSMAN;\n-        willingToDefect = false;\n-        setRankNumeric(Ranks.RANK_BONDSMAN);\n+    public PrisonerStatus getPrisonerStatus() {\n+        return prisonerStatus;\n     }\n \n-    public boolean isFree() {\n-        return (!isPrisoner() && !isBondsman());\n+    public void setPrisonerStatus(PrisonerStatus prisonerStatus) {\n+        setPrisonerStatus(prisonerStatus, true);\n     }\n \n-    public void setFreeMan() {\n-        prisonerStatus = PRISONER_NOT;\n-        willingToDefect = false;\n-    }\n+    public void setPrisonerStatus(PrisonerStatus prisonerStatus, boolean log) {\n+        boolean freed = !this.prisonerStatus.isFree();\n+        this.prisonerStatus = prisonerStatus;\n \n-    public int getPrisonerStatus() {\n-        return prisonerStatus;\n-    }\n+        // Now, we need to fix values and ranks based on the Person's status\n+        switch (prisonerStatus) {\n+            case PRISONER:\n+            case PRISONER_DEFECTOR:\n+                // They don't get to have a rank. Their rank is Bondsman.\n+                getCampaign().changeRank(this, Ranks.RANK_BONDSMAN, true);", "originalCommit": "e3c4762ecd5c5f399cd7f5ff2d4aaf47adaa9583", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjE5MzQ5MQ==", "url": "https://github.com/MegaMek/mekhq/pull/1715#discussion_r426193491", "bodyText": "It is intended, albeit with a typo on the line in question (it should say RANK_PRISONER). However, I consolidated it. I'm also going to create a story to remove the RANK_BONDSMAN and RANK_PRISONER ranks and replacement with leading displays for ranks, as that is significantly more realistic.", "author": "Windchild292", "createdAt": "2020-05-16T21:39:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDgxOTYxMg=="}], "type": "inlineReview", "revised_code": {"commit": "488524f540a451509c81b3d6e52a1705f92ee293", "chunk": "diff --git a/MekHQ/src/mekhq/campaign/personnel/Person.java b/MekHQ/src/mekhq/campaign/personnel/Person.java\nindex 8188ee1da..e0a9ebede 100644\n--- a/MekHQ/src/mekhq/campaign/personnel/Person.java\n+++ b/MekHQ/src/mekhq/campaign/personnel/Person.java\n\n@@ -515,31 +515,40 @@ public class Person implements Serializable, MekHqXmlSerializable {\n         setPrisonerStatus(prisonerStatus, true);\n     }\n \n+    /**\n+     * This requires expanded checks because a number of functionalities are strictly dependant on\n+     * the current person's prisoner status.\n+     * @param prisonerStatus The new prisoner status for the person in question\n+     * @param log whether to log the change or not\n+     */\n     public void setPrisonerStatus(PrisonerStatus prisonerStatus, boolean log) {\n-        boolean freed = !this.prisonerStatus.isFree();\n+        if (getPrisonerStatus() == prisonerStatus) {\n+            return;\n+        }\n+\n+        final boolean freed = !getPrisonerStatus().isFree();\n+        final boolean isPrisoner = prisonerStatus.isPrisoner();\n         this.prisonerStatus = prisonerStatus;\n \n         // Now, we need to fix values and ranks based on the Person's status\n         switch (prisonerStatus) {\n             case PRISONER:\n             case PRISONER_DEFECTOR:\n-                // They don't get to have a rank. Their rank is Bondsman.\n-                getCampaign().changeRank(this, Ranks.RANK_BONDSMAN, true);\n-                setRecruitment(null);\n-                setLastRankChangeDate(null);\n-                if (log) {\n-                    ServiceLogger.madePrisoner(this, getCampaign().getDate(),\n-                            getCampaign().getName(), \"\");\n-                }\n-                break;\n             case BONDSMAN:\n-                // They don't get to have a rank. Their rank is Bondsman.\n-                getCampaign().changeRank(this, Ranks.RANK_BONDSMAN, true);\n+                // They don't get to have a rank. Their rank is Prisoner or Bondsman\n+                // TODO : Remove this as part of permitting ranked prisoners\n+                getCampaign().changeRank(this,\n+                        isPrisoner ? Ranks.RANK_PRISONER : Ranks.RANK_BONDSMAN, true);\n                 setRecruitment(null);\n                 setLastRankChangeDate(null);\n                 if (log) {\n-                    ServiceLogger.madeBondsman(this, getCampaign().getDate(),\n-                            getCampaign().getName(), \"\");\n+                    if (isPrisoner) {\n+                        ServiceLogger.madePrisoner(this, getCampaign().getDate(),\n+                                getCampaign().getName(), \"\");\n+                    } else {\n+                        ServiceLogger.madeBondsman(this, getCampaign().getDate(),\n+                                getCampaign().getName(), \"\");\n+                    }\n                 }\n                 break;\n             case FREE:\n"}}, {"oid": "488524f540a451509c81b3d6e52a1705f92ee293", "url": "https://github.com/MegaMek/mekhq/commit/488524f540a451509c81b3d6e52a1705f92ee293", "message": "Improving prisoner status save functionality", "committedDate": "2020-05-16T21:38:02Z", "type": "commit"}, {"oid": "31e7525edd96c3eb0c1915f9eec60067ed4868fe", "url": "https://github.com/MegaMek/mekhq/commit/31e7525edd96c3eb0c1915f9eec60067ed4868fe", "message": "Fixing merge conflicts", "committedDate": "2020-05-16T21:39:14Z", "type": "commit"}, {"oid": "51f47650ece1abcbdacbda91d80c4f798470143a", "url": "https://github.com/MegaMek/mekhq/commit/51f47650ece1abcbdacbda91d80c4f798470143a", "message": "Adding hash comment clarification", "committedDate": "2020-05-16T21:41:11Z", "type": "commit"}, {"oid": "b5b3185710767cdfe95f55361dd345a6baf314ec", "url": "https://github.com/MegaMek/mekhq/commit/b5b3185710767cdfe95f55361dd345a6baf314ec", "message": "Fixing formatting issue", "committedDate": "2020-05-30T12:22:10Z", "type": "commit"}, {"oid": "5735144b0cc408d90cdaea5881e86f79d202042c", "url": "https://github.com/MegaMek/mekhq/commit/5735144b0cc408d90cdaea5881e86f79d202042c", "message": "Fixing merge conflicts", "committedDate": "2020-05-30T12:34:34Z", "type": "commit"}]}