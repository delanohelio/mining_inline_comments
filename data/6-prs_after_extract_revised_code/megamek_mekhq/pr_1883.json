{"pr_number": 1883, "pr_title": "LocalDate: Finances Swapover", "pr_createdAt": "2020-07-31T00:18:12Z", "pr_url": "https://github.com/MegaMek/mekhq/pull/1883", "timeline": [{"oid": "31641df46f7e27330055e9bf72e49b46710b7f0d", "url": "https://github.com/MegaMek/mekhq/commit/31641df46f7e27330055e9bf72e49b46710b7f0d", "message": "Initial Finances code cleanup", "committedDate": "2020-07-26T15:19:35Z", "type": "commit"}, {"oid": "fa4b0690356596f1ccbdbc4d106d47694f219cf5", "url": "https://github.com/MegaMek/mekhq/commit/fa4b0690356596f1ccbdbc4d106d47694f219cf5", "message": "Fixing tab spacing in Loan.java", "committedDate": "2020-07-26T15:20:27Z", "type": "commit"}, {"oid": "52ce2d0ebab8f7e711bc8a161667d76ea368923f", "url": "https://github.com/MegaMek/mekhq/commit/52ce2d0ebab8f7e711bc8a161667d76ea368923f", "message": "Implementing most of the Finances swapover to LocalDate", "committedDate": "2020-07-26T16:40:45Z", "type": "commit"}, {"oid": "21ad1d9e670a2732186826a3f0914daeba6fa809", "url": "https://github.com/MegaMek/mekhq/commit/21ad1d9e670a2732186826a3f0914daeba6fa809", "message": "Moving DateChooser to LocalDate", "committedDate": "2020-07-26T17:35:44Z", "type": "commit"}, {"oid": "4f00647976761d0e47160bf64b86716bc722e8f1", "url": "https://github.com/MegaMek/mekhq/commit/4f00647976761d0e47160bf64b86716bc722e8f1", "message": "Fixing merge conflicts", "committedDate": "2020-07-30T23:48:00Z", "type": "commit"}, {"oid": "0eec87fa138f4e4fbdae0e8899a46484bcbf3dc6", "url": "https://github.com/MegaMek/mekhq/commit/0eec87fa138f4e4fbdae0e8899a46484bcbf3dc6", "message": "Fixing missed parts of the implementation", "committedDate": "2020-07-31T00:14:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDEwMDI5OQ==", "url": "https://github.com/MegaMek/mekhq/pull/1883#discussion_r464100299", "bodyText": "This logic needs an explanation, if you're just looking for the next Monday/Sunday or something like that there is a more obvious way:\nd.with(TemporalAdjusters.next(DayOfWeek.MONDAY));", "author": "sixlettervariables", "createdAt": "2020-08-02T17:03:56Z", "path": "MekHQ/src/mekhq/campaign/finances/Loan.java", "diffHunk": "@@ -93,102 +85,79 @@ public Loan(Money p, int r, int c, int y, int s, GregorianCalendar today, String\n     }\n \n     public void setFirstPaymentDate() {\n-        boolean keepGoing = true;\n         //We are going to assume a standard grace period, so you have to go\n         //through the first full time length (not partial) before your first\n         //payment\n-        int grace = 1;\n-        switch(schedule) {\n-        case Finances.SCHEDULE_BIWEEKLY:\n-            grace = 2;\n-            break;\n-        case Finances.SCHEDULE_QUARTERLY:\n-            grace = 3;\n-            break;\n-        }\n-        while(keepGoing) {\n-            nextPayment.add(GregorianCalendar.DAY_OF_YEAR, 1);\n-            switch(schedule) {\n+\n+        // First, we need to increase the number of days by one\n+        nextPayment = nextPayment.plusDays(1);\n+\n+        // Then, we create a variable to hold temporary difference values\n+        int temp;\n+\n+        // Finally, we use that and the schedule type to determine the length including the grace period\n+        switch (schedule) {\n             case Finances.SCHEDULE_BIWEEKLY:\n-                if(nextPayment.get(Calendar.DAY_OF_WEEK) == 1) {\n-                    if(grace > 0) {\n-                        grace--;\n-                    }\n-                    else {\n-                        keepGoing = false;\n-                    }\n+                temp = 8 - nextPayment.getDayOfWeek().getValue();", "originalCommit": "0eec87fa138f4e4fbdae0e8899a46484bcbf3dc6", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e5b9445c3def0a8ea4ff613865db4368ad1a169f", "chunk": "diff --git a/MekHQ/src/mekhq/campaign/finances/Loan.java b/MekHQ/src/mekhq/campaign/finances/Loan.java\nindex bf5f5d01d..32af816e2 100644\n--- a/MekHQ/src/mekhq/campaign/finances/Loan.java\n+++ b/MekHQ/src/mekhq/campaign/finances/Loan.java\n\n@@ -98,30 +100,23 @@ public class Loan implements MekHqXmlSerializable {\n         // Finally, we use that and the schedule type to determine the length including the grace period\n         switch (schedule) {\n             case Finances.SCHEDULE_BIWEEKLY:\n-                temp = 8 - nextPayment.getDayOfWeek().getValue();\n-                if (temp != 7) {\n-                    nextPayment = nextPayment.plusDays(temp);\n-                }\n-                nextPayment = nextPayment.plusWeeks(2);\n+                nextPayment = nextPayment.with(TemporalAdjusters.nextOrSame(DayOfWeek.MONDAY)).plusWeeks(2);\n                 break;\n             case Finances.SCHEDULE_MONTHLY:\n-                temp = nextPayment.getDayOfMonth();\n-                if (temp != 1) {\n-                    nextPayment = nextPayment.plusDays(nextPayment.lengthOfMonth() - temp);\n+                if (nextPayment.getDayOfMonth() != 1) {\n+                    nextPayment = nextPayment.with(TemporalAdjusters.firstDayOfNextMonth());\n                 }\n                 nextPayment = nextPayment.plusMonths(1);\n                 break;\n             case Finances.SCHEDULE_QUARTERLY:\n-                temp = nextPayment.getDayOfMonth();\n-                if (temp != 1) {\n-                    nextPayment = nextPayment.plusDays(nextPayment.lengthOfMonth() - temp);\n+                if (nextPayment.getDayOfMonth() != 1) {\n+                    nextPayment = nextPayment.with(TemporalAdjusters.firstDayOfNextMonth());\n                 }\n                 nextPayment = nextPayment.plusMonths(3);\n                 break;\n             case Finances.SCHEDULE_YEARLY:\n-                temp = nextPayment.getDayOfYear();\n-                if (temp != 1) {\n-                    nextPayment = nextPayment.plusDays(nextPayment.lengthOfYear() - temp);\n+                if (nextPayment.getDayOfYear() != 1) {\n+                    nextPayment = nextPayment.with(TemporalAdjusters.firstDayOfNextYear());\n                 }\n                 nextPayment = nextPayment.plusYears(1);\n                 break;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDEwMDMzMw==", "url": "https://github.com/MegaMek/mekhq/pull/1883#discussion_r464100333", "bodyText": "Same as above comment.", "author": "sixlettervariables", "createdAt": "2020-08-02T17:04:18Z", "path": "MekHQ/src/mekhq/campaign/finances/Loan.java", "diffHunk": "@@ -93,102 +85,79 @@ public Loan(Money p, int r, int c, int y, int s, GregorianCalendar today, String\n     }\n \n     public void setFirstPaymentDate() {\n-        boolean keepGoing = true;\n         //We are going to assume a standard grace period, so you have to go\n         //through the first full time length (not partial) before your first\n         //payment\n-        int grace = 1;\n-        switch(schedule) {\n-        case Finances.SCHEDULE_BIWEEKLY:\n-            grace = 2;\n-            break;\n-        case Finances.SCHEDULE_QUARTERLY:\n-            grace = 3;\n-            break;\n-        }\n-        while(keepGoing) {\n-            nextPayment.add(GregorianCalendar.DAY_OF_YEAR, 1);\n-            switch(schedule) {\n+\n+        // First, we need to increase the number of days by one\n+        nextPayment = nextPayment.plusDays(1);\n+\n+        // Then, we create a variable to hold temporary difference values\n+        int temp;\n+\n+        // Finally, we use that and the schedule type to determine the length including the grace period\n+        switch (schedule) {\n             case Finances.SCHEDULE_BIWEEKLY:\n-                if(nextPayment.get(Calendar.DAY_OF_WEEK) == 1) {\n-                    if(grace > 0) {\n-                        grace--;\n-                    }\n-                    else {\n-                        keepGoing = false;\n-                    }\n+                temp = 8 - nextPayment.getDayOfWeek().getValue();\n+                if (temp != 7) {\n+                    nextPayment = nextPayment.plusDays(temp);\n                 }\n+                nextPayment = nextPayment.plusWeeks(2);\n                 break;\n             case Finances.SCHEDULE_MONTHLY:\n-                if(nextPayment.get(Calendar.DAY_OF_MONTH) == 1) {\n-                    if(grace > 0) {\n-                        grace--;\n-                    }\n-                    else {\n-                        keepGoing = false;\n-                    }\n+                temp = nextPayment.getDayOfMonth();", "originalCommit": "0eec87fa138f4e4fbdae0e8899a46484bcbf3dc6", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e5b9445c3def0a8ea4ff613865db4368ad1a169f", "chunk": "diff --git a/MekHQ/src/mekhq/campaign/finances/Loan.java b/MekHQ/src/mekhq/campaign/finances/Loan.java\nindex bf5f5d01d..32af816e2 100644\n--- a/MekHQ/src/mekhq/campaign/finances/Loan.java\n+++ b/MekHQ/src/mekhq/campaign/finances/Loan.java\n\n@@ -98,30 +100,23 @@ public class Loan implements MekHqXmlSerializable {\n         // Finally, we use that and the schedule type to determine the length including the grace period\n         switch (schedule) {\n             case Finances.SCHEDULE_BIWEEKLY:\n-                temp = 8 - nextPayment.getDayOfWeek().getValue();\n-                if (temp != 7) {\n-                    nextPayment = nextPayment.plusDays(temp);\n-                }\n-                nextPayment = nextPayment.plusWeeks(2);\n+                nextPayment = nextPayment.with(TemporalAdjusters.nextOrSame(DayOfWeek.MONDAY)).plusWeeks(2);\n                 break;\n             case Finances.SCHEDULE_MONTHLY:\n-                temp = nextPayment.getDayOfMonth();\n-                if (temp != 1) {\n-                    nextPayment = nextPayment.plusDays(nextPayment.lengthOfMonth() - temp);\n+                if (nextPayment.getDayOfMonth() != 1) {\n+                    nextPayment = nextPayment.with(TemporalAdjusters.firstDayOfNextMonth());\n                 }\n                 nextPayment = nextPayment.plusMonths(1);\n                 break;\n             case Finances.SCHEDULE_QUARTERLY:\n-                temp = nextPayment.getDayOfMonth();\n-                if (temp != 1) {\n-                    nextPayment = nextPayment.plusDays(nextPayment.lengthOfMonth() - temp);\n+                if (nextPayment.getDayOfMonth() != 1) {\n+                    nextPayment = nextPayment.with(TemporalAdjusters.firstDayOfNextMonth());\n                 }\n                 nextPayment = nextPayment.plusMonths(3);\n                 break;\n             case Finances.SCHEDULE_YEARLY:\n-                temp = nextPayment.getDayOfYear();\n-                if (temp != 1) {\n-                    nextPayment = nextPayment.plusDays(nextPayment.lengthOfYear() - temp);\n+                if (nextPayment.getDayOfYear() != 1) {\n+                    nextPayment = nextPayment.with(TemporalAdjusters.firstDayOfNextYear());\n                 }\n                 nextPayment = nextPayment.plusYears(1);\n                 break;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDEwMDY0NQ==", "url": "https://github.com/MegaMek/mekhq/pull/1883#discussion_r464100645", "bodyText": "Does this logic match the old logic, the old logic gave you days % 365 > 0 ? 1 : 0. Is this equivalent?", "author": "sixlettervariables", "createdAt": "2020-08-02T17:08:01Z", "path": "MekHQ/src/mekhq/campaign/finances/Finances.java", "diffHunk": "@@ -111,37 +109,42 @@ public boolean isInDebt() {\n         return getLoanBalance().isPositive();\n     }\n \n-    public int getFullYearsInDebt(GregorianCalendar cal) {\n-        if (null == wentIntoDebt) {\n+    public int getFullYearsInDebt(LocalDate date) {\n+        if (wentIntoDebt == null) {\n             return 0;\n+        } else {\n+            return Math.toIntExact(ChronoUnit.YEARS.between(wentIntoDebt, date));\n         }\n-        return Utilities.getDiffFullYears(wentIntoDebt, cal);\n     }\n \n-    public int getPartialYearsInDebt(GregorianCalendar cal) {\n-        if (wentIntoDebt == null) {\n-            return 0;\n+    public int getPartialYearsInDebt(LocalDate date) {\n+        if (wentIntoDebt != null) {\n+            Period period = Period.between(wentIntoDebt, date);\n+            if ((period.getMonths() > 0) || (period.getDays() > 0)) {", "originalCommit": "0eec87fa138f4e4fbdae0e8899a46484bcbf3dc6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDQzOTM1MQ==", "url": "https://github.com/MegaMek/mekhq/pull/1883#discussion_r464439351", "bodyText": "It does. Period in single calculations will split the time between into days, months, and years. If there is no difference in a category, the value will be 0.", "author": "Windchild292", "createdAt": "2020-08-03T14:12:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDEwMDY0NQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDEwMDc2NA==", "url": "https://github.com/MegaMek/mekhq/pull/1883#discussion_r464100764", "bodyText": "Use TemporalAdjusters.", "author": "sixlettervariables", "createdAt": "2020-08-02T17:09:17Z", "path": "MekHQ/src/mekhq/gui/dialog/CustomizeScenarioDialog.java", "diffHunk": "@@ -371,44 +370,37 @@ private void btnCloseActionPerformed(java.awt.event.ActionEvent evt) {\n \n     private void changeDate() {\n         // show the date chooser\n-        GregorianCalendar day = GregorianCalendar.from(date.atStartOfDay(ZoneId.systemDefault()));\n-        DateChooser dc = new DateChooser(frame, day);\n+        DateChooser dc = new DateChooser(frame, date);\n         // user can either choose a date or cancel by closing\n         if (dc.showDateChooser() == DateChooser.OK_OPTION) {\n             if (scenario.isCurrent()) {\n-                if (dc.getDate().getTime().before(campaign.getDate())) {\n+                if (dc.getDate().isBefore(campaign.getLocalDate())) {\n                     JOptionPane.showMessageDialog(frame,\n                             \"You cannot choose a date before the current date for a pending battle.\",\n                             \"Invalid date\",\n                             JOptionPane.ERROR_MESSAGE);\n                     return;\n                 } else {\n-                    //Calendar math necessitated by variations in locales\n-                    GregorianCalendar nextMonday = new GregorianCalendar();\n-                    nextMonday.setTime(campaign.getDate());\n-                    nextMonday.add(Calendar.DAY_OF_MONTH, 1);\n-                    while (nextMonday.get(Calendar.DAY_OF_WEEK) != Calendar.MONDAY) {\n-                        nextMonday.add(Calendar.DAY_OF_MONTH, 1);\n-                    }\n+                    LocalDate nextMonday = campaign.getLocalDate()", "originalCommit": "0eec87fa138f4e4fbdae0e8899a46484bcbf3dc6", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e5b9445c3def0a8ea4ff613865db4368ad1a169f", "chunk": "diff --git a/MekHQ/src/mekhq/gui/dialog/CustomizeScenarioDialog.java b/MekHQ/src/mekhq/gui/dialog/CustomizeScenarioDialog.java\nindex 92b990c50..b99afcc9c 100644\n--- a/MekHQ/src/mekhq/gui/dialog/CustomizeScenarioDialog.java\n+++ b/MekHQ/src/mekhq/gui/dialog/CustomizeScenarioDialog.java\n\n@@ -381,8 +383,7 @@ public class CustomizeScenarioDialog extends javax.swing.JDialog {\n                             JOptionPane.ERROR_MESSAGE);\n                     return;\n                 } else {\n-                    LocalDate nextMonday = campaign.getLocalDate()\n-                            .plusDays(8 - campaign.getLocalDate().getDayOfWeek().getValue());\n+                    LocalDate nextMonday = campaign.getLocalDate().with(TemporalAdjusters.nextOrSame(DayOfWeek.MONDAY));\n \n                     if (!dc.getDate().isBefore(nextMonday)) {\n                         JOptionPane.showMessageDialog(frame,\n"}}, {"oid": "93a114417c2a5bf797cc57dad5e7e85e449f83b3", "url": "https://github.com/MegaMek/mekhq/commit/93a114417c2a5bf797cc57dad5e7e85e449f83b3", "message": "Merge remote-tracking branch 'upstream/master' into dev_Windchild_FinancesLocalDate", "committedDate": "2020-08-03T13:47:41Z", "type": "commit"}, {"oid": "e5b9445c3def0a8ea4ff613865db4368ad1a169f", "url": "https://github.com/MegaMek/mekhq/commit/e5b9445c3def0a8ea4ff613865db4368ad1a169f", "message": "Swapping over to use TemporalAdjusters", "committedDate": "2020-08-03T14:12:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDQ2MDg4NQ==", "url": "https://github.com/MegaMek/mekhq/pull/1883#discussion_r464460885", "bodyText": "Still needed?", "author": "sixlettervariables", "createdAt": "2020-08-03T14:45:30Z", "path": "MekHQ/src/mekhq/campaign/finances/Loan.java", "diffHunk": "@@ -93,102 +87,72 @@ public Loan(Money p, int r, int c, int y, int s, GregorianCalendar today, String\n     }\n \n     public void setFirstPaymentDate() {\n-        boolean keepGoing = true;\n         //We are going to assume a standard grace period, so you have to go\n         //through the first full time length (not partial) before your first\n         //payment\n-        int grace = 1;\n-        switch(schedule) {\n-        case Finances.SCHEDULE_BIWEEKLY:\n-            grace = 2;\n-            break;\n-        case Finances.SCHEDULE_QUARTERLY:\n-            grace = 3;\n-            break;\n-        }\n-        while(keepGoing) {\n-            nextPayment.add(GregorianCalendar.DAY_OF_YEAR, 1);\n-            switch(schedule) {\n+\n+        // First, we need to increase the number of days by one\n+        nextPayment = nextPayment.plusDays(1);\n+\n+        // Then, we create a variable to hold temporary difference values\n+        int temp;", "originalCommit": "e5b9445c3def0a8ea4ff613865db4368ad1a169f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDQ2NTkzOQ==", "url": "https://github.com/MegaMek/mekhq/pull/1883#discussion_r464465939", "bodyText": "Nope, and odd that my IDE didn't prompt about it being unused.", "author": "Windchild292", "createdAt": "2020-08-03T14:53:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDQ2MDg4NQ=="}], "type": "inlineReview", "revised_code": {"commit": "988d4ede9f836da2e4a0ef1c49e7ef974c3554de", "chunk": "diff --git a/MekHQ/src/mekhq/campaign/finances/Loan.java b/MekHQ/src/mekhq/campaign/finances/Loan.java\nindex 32af816e2..e1cfd56c2 100644\n--- a/MekHQ/src/mekhq/campaign/finances/Loan.java\n+++ b/MekHQ/src/mekhq/campaign/finances/Loan.java\n\n@@ -94,9 +94,6 @@ public class Loan implements MekHqXmlSerializable {\n         // First, we need to increase the number of days by one\n         nextPayment = nextPayment.plusDays(1);\n \n-        // Then, we create a variable to hold temporary difference values\n-        int temp;\n-\n         // Finally, we use that and the schedule type to determine the length including the grace period\n         switch (schedule) {\n             case Finances.SCHEDULE_BIWEEKLY:\n"}}, {"oid": "988d4ede9f836da2e4a0ef1c49e7ef974c3554de", "url": "https://github.com/MegaMek/mekhq/commit/988d4ede9f836da2e4a0ef1c49e7ef974c3554de", "message": "Removing unused variable", "committedDate": "2020-08-03T14:54:02Z", "type": "commit"}]}