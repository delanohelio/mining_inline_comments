{"pr_number": 2201, "pr_title": "Content Lifecycle Management: speedup", "pr_createdAt": "2020-05-11T20:30:08Z", "pr_url": "https://github.com/uyuni-project/uyuni/pull/2201", "timeline": [{"oid": "70c471e33c19264d9dba8fb6c8a1cd4c95a47806", "url": "https://github.com/uyuni-project/uyuni/commit/70c471e33c19264d9dba8fb6c8a1cd4c95a47806", "message": "CLM speedup: disable autoflushing on more code", "committedDate": "2020-05-11T22:58:11Z", "type": "forcePushed"}, {"oid": "4b5e753f800a993a5f536ed35770840c7636d58b", "url": "https://github.com/uyuni-project/uyuni/commit/4b5e753f800a993a5f536ed35770840c7636d58b", "message": "Changelog update", "committedDate": "2020-05-13T21:23:22Z", "type": "forcePushed"}, {"oid": "9eed7a7cd04c508ac488cf5ec4cd9fabb9d9affc", "url": "https://github.com/uyuni-project/uyuni/commit/9eed7a7cd04c508ac488cf5ec4cd9fabb9d9affc", "message": "Changelog update", "committedDate": "2020-05-14T20:56:51Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTc4MjY1MQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2201#discussion_r425782651", "bodyText": "Nit tip: Set.of(errataId)", "author": "hustodemon", "createdAt": "2020-05-15T12:57:03Z", "path": "java/code/src/com/redhat/rhn/manager/errata/cache/ErrataCacheManager.java", "diffHunk": "@@ -269,6 +271,7 @@ public static void insertCacheForChannelErrataAsync(List<Long> channelIdsToUpdat\n      */\n     public static void insertCacheForChannelErrata(Collection<Long> channelIdsToUpdate, Long errataId) {\n         for (Long cid : channelIdsToUpdate) {\n+            ChannelFactory.addErrataToChannel(new HashSet<Long>() {{ add(errataId); }}, cid);", "originalCommit": "b21afbe6dc08926ac37c27e9d2add33ce4d2d7a1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTgxNjQxMA==", "url": "https://github.com/uyuni-project/uyuni/pull/2201#discussion_r425816410", "bodyText": "\ud83d\ude2e", "author": "moio", "createdAt": "2020-05-15T13:52:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTc4MjY1MQ=="}], "type": "inlineReview", "revised_code": {"commit": "acd7026ee942feffecf73cbaca38e3cea1d0cf83", "chunk": "diff --git a/java/code/src/com/redhat/rhn/manager/errata/cache/ErrataCacheManager.java b/java/code/src/com/redhat/rhn/manager/errata/cache/ErrataCacheManager.java\nindex 0b635bc9591..3881552c1be 100644\n--- a/java/code/src/com/redhat/rhn/manager/errata/cache/ErrataCacheManager.java\n+++ b/java/code/src/com/redhat/rhn/manager/errata/cache/ErrataCacheManager.java\n\n@@ -267,13 +264,13 @@ public class ErrataCacheManager extends HibernateFactory {\n      *updates the errata caches for the channels passed in.\n      * @param channelIdsToUpdate - channel IDs (Long) that need their errata\n      * caches updated\n-     * @param errataId ID of the errata to update the cache for. Assumes the errata is published\n+     * @param errata the errata to update the cache for\n      */\n-    public static void insertCacheForChannelErrata(Collection<Long> channelIdsToUpdate, Long errataId) {\n+    public static void insertCacheForChannelErrata(\n+            List<Long> channelIdsToUpdate, Errata errata) {\n         for (Long cid : channelIdsToUpdate) {\n-            ChannelFactory.addErrataToChannel(new HashSet<Long>() {{ add(errataId); }}, cid);\n-            List<Long> pids = ErrataFactory.listErrataChannelPackages(cid, errataId);\n-            ErrataCacheManager.insertCacheForChannelPackages(cid, errataId, pids);\n+            List<Long> pids = ErrataFactory.listErrataChannelPackages(cid, errata.getId());\n+            ErrataCacheManager.insertCacheForChannelPackages(cid, errata.getId(), pids);\n         }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTc5MzYyNA==", "url": "https://github.com/uyuni-project/uyuni/pull/2201#discussion_r425793624", "bodyText": "call ErrataFactory.publish(), but that is a noop if the errata is\nalready published, which is always the case here\n\nIs this true in general (outside CLM context)? This method is also used for general errata cloning via XMLRPC (ChannelSoftwareHandler.mergeErrata).", "author": "hustodemon", "createdAt": "2020-05-15T13:15:49Z", "path": "java/code/src/com/redhat/rhn/manager/errata/ErrataManager.java", "diffHunk": "@@ -2300,7 +2293,11 @@ public static void cloneErrata(Long channelId, Collection<Long> errataToClone, b\n                 }\n                 else {\n                     log.debug(\"Re-publishing clone\");\n-                    publish(clones.get(0), cids, user);\n+                    Errata firstClone = clones.get(0);", "originalCommit": "7ed0743459b6c1c42d721d88a7ae2fc845826b2d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTgxOTk5NQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2201#discussion_r425819995", "bodyText": "It's not true in general, for example the Struts action PackagePushAction calls publish exclusively on unpublished erratas - and for those the behavior is definitely not no-op.", "author": "moio", "createdAt": "2020-05-15T13:57:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTc5MzYyNA=="}], "type": "inlineReview", "revised_code": {"commit": "acd7026ee942feffecf73cbaca38e3cea1d0cf83", "chunk": "diff --git a/java/code/src/com/redhat/rhn/manager/errata/ErrataManager.java b/java/code/src/com/redhat/rhn/manager/errata/ErrataManager.java\nindex 3fe63212c25..d3d4338ae82 100644\n--- a/java/code/src/com/redhat/rhn/manager/errata/ErrataManager.java\n+++ b/java/code/src/com/redhat/rhn/manager/errata/ErrataManager.java\n\n@@ -2281,23 +2277,25 @@ public class ErrataManager extends BaseManager {\n             Errata errata = ErrataFactory.lookupById(eid);\n             // we merge custom errata directly (non Redhat and cloned)\n             if (errata.getOrg() != null) {\n-                ErrataCacheManager.insertCacheForChannelErrata(cids, eid);\n+                errata.addChannel(channel);\n+                ErrataCacheManager.insertCacheForChannelErrata(cids, errata);\n+                errata.addChannelNotification(channel, new Date());\n             }\n             else {\n+                Set<Channel> channelSet = new HashSet<>();\n+                channelSet.add(channel);\n+\n                 List<Errata> clones = lookupPublishedByOriginal(user, errata);\n                 if (clones.size() == 0) {\n                     log.debug(\"Cloning errata\");\n-                    var publishedId = HibernateFactory.doWithoutAutoFlushing(() -> PublishErrataHelper.cloneErrataFaster(eid, user.getOrg()));\n-                    Errata published = ErrataFactory.lookupById(publishedId);\n-                    ErrataCacheManager.insertCacheForChannelErrata(cids, publishedId);\n+                    Errata published = PublishErrataHelper.cloneErrataFast(errata, user.getOrg());\n+                    published.setChannels(channelSet);\n+                    ErrataCacheManager.insertCacheForChannelErrata(cids, published);\n+                    published.addChannelNotification(channel, new Date());\n                 }\n                 else {\n                     log.debug(\"Re-publishing clone\");\n-                    Errata firstClone = clones.get(0);\n-\n-                    ErrataCacheManager.insertCacheForChannelErrata(cids, firstClone.getId());\n-\n-                    updateSearchIndex();\n+                    publish(clones.get(0), cids, user);\n                 }\n             }\n         }\n"}}, {"oid": "acd7026ee942feffecf73cbaca38e3cea1d0cf83", "url": "https://github.com/uyuni-project/uyuni/commit/acd7026ee942feffecf73cbaca38e3cea1d0cf83", "message": "refactoring: make comment agree with code", "committedDate": "2020-05-15T19:42:02Z", "type": "commit"}, {"oid": "503e14d690a404191b56b3ef55bc65fa09334483", "url": "https://github.com/uyuni-project/uyuni/commit/503e14d690a404191b56b3ef55bc65fa09334483", "message": "Make mode queries aware of Hibernate's flush mode\n\nWhen handling many objects in the Hibernate cache, it is sometimes\nappropriate to use the HibernateFactory#doWithoutAutoFlushing helpers\nin order to prevent needless flushing which hurts performance.\n\nMode queries always flushed, thereby making it more difficult to mix\nHibernate-based and mode-query-based code in presence of many objects in\nHibernate's cache.\n\nThis change will prevent flushing in mode queries when\ndoWithoutAutoFlushing is used.", "committedDate": "2020-05-15T19:42:02Z", "type": "commit"}, {"oid": "ffdb99a326c6e3e0838d8044808eebbd21acef4c", "url": "https://github.com/uyuni-project/uyuni/commit/ffdb99a326c6e3e0838d8044808eebbd21acef4c", "message": "CLM speedup: use cloneErrataFaster and avoid flushing\n\nPublishErrataHelper.cloneErrataFaster is indeed faster than\nPublishErrataHelper.cloneErrataFast, but only under the assumption not\nvery many objects are present in Hibernate's cache, because being\nimplemented in mode queries it means it flush()es the Hibernate session\nfrequently.\n\nThis chance uses the faster method, while also preventing flushes - on a\ntypical CLM scenario (SLES 12 SP3-based) it makes the build time ~3x\nfaster.", "committedDate": "2020-05-15T19:42:02Z", "type": "commit"}, {"oid": "2cd4761b73ad9537d3cec662410bc491637573a8", "url": "https://github.com/uyuni-project/uyuni/commit/2cd4761b73ad9537d3cec662410bc491637573a8", "message": "refactoring: change parameter type to reflect implementation is mode-queries only", "committedDate": "2020-05-15T19:42:02Z", "type": "commit"}, {"oid": "8afbe4c54fc2925bc1b8496842cbe5a72951699f", "url": "https://github.com/uyuni-project/uyuni/commit/8afbe4c54fc2925bc1b8496842cbe5a72951699f", "message": "refactoring: insertCacheForChannelErrata: accept any Collection", "committedDate": "2020-05-15T19:42:02Z", "type": "commit"}, {"oid": "7a30693f779379219625507492b86718d204a931", "url": "https://github.com/uyuni-project/uyuni/commit/7a30693f779379219625507492b86718d204a931", "message": "refactoring: method rename to reflect code", "committedDate": "2020-05-15T19:42:02Z", "type": "commit"}, {"oid": "dfae6fc591374addf0c77aec567891d977a6985a", "url": "https://github.com/uyuni-project/uyuni/commit/dfae6fc591374addf0c77aec567891d977a6985a", "message": "refactoring: lookupByIdAndUser never returns null", "committedDate": "2020-05-15T19:42:02Z", "type": "commit"}, {"oid": "78ea8236e496dd5af978d2e22e78732994136ee7", "url": "https://github.com/uyuni-project/uyuni/commit/78ea8236e496dd5af978d2e22e78732994136ee7", "message": "refactoring: move adding errata to channel inside of insertCacheForChannelErrata", "committedDate": "2020-05-15T19:42:02Z", "type": "commit"}, {"oid": "1a0fb1f8aef47a90086fed7852f4032baf2ed55f", "url": "https://github.com/uyuni-project/uyuni/commit/1a0fb1f8aef47a90086fed7852f4032baf2ed55f", "message": "refactoring: change parameter type to reflect implementation is mode-queries only", "committedDate": "2020-05-15T19:42:02Z", "type": "commit"}, {"oid": "29785e51880181fd95f718921d5c4eb8c7317d5c", "url": "https://github.com/uyuni-project/uyuni/commit/29785e51880181fd95f718921d5c4eb8c7317d5c", "message": "refactoring: rename to reflect what code actually does", "committedDate": "2020-05-15T19:42:02Z", "type": "commit"}, {"oid": "807b461a24187948885affc610c0d1b2794f6d92", "url": "https://github.com/uyuni-project/uyuni/commit/807b461a24187948885affc610c0d1b2794f6d92", "message": "refactoring: move method to ErrataManager", "committedDate": "2020-05-15T19:42:02Z", "type": "commit"}, {"oid": "c8d4dd43bf0ff9535ce48185eb7c6b098d8ecf75", "url": "https://github.com/uyuni-project/uyuni/commit/c8d4dd43bf0ff9535ce48185eb7c6b098d8ecf75", "message": "refactoring: move notification setting inside of insertCacheForChannelErrata", "committedDate": "2020-05-15T19:42:02Z", "type": "commit"}, {"oid": "15b4e9df21904809ea10721a28787b342a5eb181", "url": "https://github.com/uyuni-project/uyuni/commit/15b4e9df21904809ea10721a28787b342a5eb181", "message": "refactoring: inline publish() and delete dead code\n\nErrataManager.publish() used to:\n\n - call ErrataFactory.publish(), but that is a noop if the errata is\nalready published, which is always the case here\n - call addChannelsToErrata(), which used to:\n   - make sure the user had access to the specified channel. Moved to\ntop lookup instead, so that it is not done for each errata\n   - call ErrataCacheManager.insertCacheForChannelErrata(), retained\n   - call storeErrata(), which saved the Hibernate entity, but it is not\nchanged by current code (so also a noop)\n   - call updateSearchIndex(), retained", "committedDate": "2020-05-15T19:42:02Z", "type": "commit"}, {"oid": "cbfbc5bfcdaaec1a20cf3c3499585a3a49b60df0", "url": "https://github.com/uyuni-project/uyuni/commit/cbfbc5bfcdaaec1a20cf3c3499585a3a49b60df0", "message": "CLM speedup: reindex search on errata once per channel, not once per errata", "committedDate": "2020-05-15T19:42:02Z", "type": "commit"}, {"oid": "cbc39ac9c67b93e84ce87b5926d60c1b87cd686b", "url": "https://github.com/uyuni-project/uyuni/commit/cbc39ac9c67b93e84ce87b5926d60c1b87cd686b", "message": "refactoring: remove dead code", "committedDate": "2020-05-15T19:42:02Z", "type": "commit"}, {"oid": "267d6f8af5fbfaf6b266a31d7782bdd353b8ebf0", "url": "https://github.com/uyuni-project/uyuni/commit/267d6f8af5fbfaf6b266a31d7782bdd353b8ebf0", "message": "refactoring: rename method to new semantics", "committedDate": "2020-05-15T19:42:02Z", "type": "commit"}, {"oid": "ce40d483c1642ac53836d592b667286f013f39e1", "url": "https://github.com/uyuni-project/uyuni/commit/ce40d483c1642ac53836d592b667286f013f39e1", "message": "CLM speedup: disable autoflushing on more code", "committedDate": "2020-05-15T19:42:02Z", "type": "commit"}, {"oid": "c4e5df92bb12f705ed1caafc4445647e1e1aa87a", "url": "https://github.com/uyuni-project/uyuni/commit/c4e5df92bb12f705ed1caafc4445647e1e1aa87a", "message": "CLM speedup: force ANALYZE of rhnChannelPackage after massive insertions", "committedDate": "2020-05-15T19:42:02Z", "type": "commit"}, {"oid": "70b6a4f61847cdc11a62d60c8ba6d8464e6af47a", "url": "https://github.com/uyuni-project/uyuni/commit/70b6a4f61847cdc11a62d60c8ba6d8464e6af47a", "message": "bugfix: unit test used incorrect user", "committedDate": "2020-05-15T19:42:02Z", "type": "commit"}, {"oid": "0ac9e772d6ba490e4641e0ee38b8a94a33438cc9", "url": "https://github.com/uyuni-project/uyuni/commit/0ac9e772d6ba490e4641e0ee38b8a94a33438cc9", "message": "Changelog update", "committedDate": "2020-05-15T19:42:23Z", "type": "commit"}, {"oid": "a2acdd2fa5612ce627a9b54ad3434805cbe409c7", "url": "https://github.com/uyuni-project/uyuni/commit/a2acdd2fa5612ce627a9b54ad3434805cbe409c7", "message": "refactoring: use proper Set constructor", "committedDate": "2020-05-15T19:42:23Z", "type": "commit"}, {"oid": "a2acdd2fa5612ce627a9b54ad3434805cbe409c7", "url": "https://github.com/uyuni-project/uyuni/commit/a2acdd2fa5612ce627a9b54ad3434805cbe409c7", "message": "refactoring: use proper Set constructor", "committedDate": "2020-05-15T19:42:23Z", "type": "forcePushed"}]}