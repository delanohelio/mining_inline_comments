{"pr_number": 1983, "pr_title": "Virt pool definition", "pr_createdAt": "2020-03-05T11:43:47Z", "pr_url": "https://github.com/uyuni-project/uyuni/pull/1983", "timeline": [{"oid": "3ddf597601fe17c8ef0256b001bcb327824470bb", "url": "https://github.com/uyuni-project/uyuni/commit/3ddf597601fe17c8ef0256b001bcb327824470bb", "message": "Expose REST API to provide the definition of a virtual storage pool.", "committedDate": "2020-03-05T16:13:31Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQwNDE2OQ==", "url": "https://github.com/uyuni-project/uyuni/pull/1983#discussion_r388404169", "bodyText": "I think this can throw a NullPointerException if for some reason the parsing fails and pool is null.", "author": "mateiw", "createdAt": "2020-03-05T16:20:30Z", "path": "java/code/src/com/suse/manager/virtualization/VirtManager.java", "diffHunk": "@@ -80,6 +80,29 @@\n         return saltService.callSync(call, minionId);\n     }\n \n+    /**\n+     * Query virtual storage pool definition\n+     *\n+     * @param minionId the host minion ID\n+     * @param poolName the domain name to look for\n+     * @return the XML definition or an empty Optional\n+     */\n+    public static Optional<PoolDefinition> getPoolDefinition(String minionId, String poolName) {\n+        Map<String, JsonObject> infos = getPools(minionId);\n+\n+        Map<String, Object> args = new LinkedHashMap<>();\n+        args.put(\"name\", poolName);\n+        LocalCall<String> call =\n+                new LocalCall<>(\"virt.pool_get_xml\", Optional.empty(), Optional.of(args), new TypeToken<String>() { });\n+\n+        Optional<String> result = saltService.callSync(call, minionId);\n+        return result.filter(s -> !s.startsWith(\"ERROR\")).map(xml -> {\n+            PoolDefinition pool = PoolDefinition.parse(xml);\n+            pool.setAutostart(infos.get(poolName).get(\"autostart\").getAsInt() == 1);", "originalCommit": "3ddf597601fe17c8ef0256b001bcb327824470bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ0NDEwMg==", "url": "https://github.com/uyuni-project/uyuni/pull/1983#discussion_r388444102", "bodyText": "handled", "author": "cbosdo", "createdAt": "2020-03-05T17:22:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQwNDE2OQ=="}], "type": "inlineReview", "revised_code": {"commit": "a277fe244c04c2f8e8717fedd45c66569a7d6aef", "chunk": "diff --git a/java/code/src/com/suse/manager/virtualization/VirtManager.java b/java/code/src/com/suse/manager/virtualization/VirtManager.java\nindex 1888d2b755e..78e5e68ab1d 100644\n--- a/java/code/src/com/suse/manager/virtualization/VirtManager.java\n+++ b/java/code/src/com/suse/manager/virtualization/VirtManager.java\n\n@@ -98,7 +98,9 @@ public class VirtManager {\n         Optional<String> result = saltService.callSync(call, minionId);\n         return result.filter(s -> !s.startsWith(\"ERROR\")).map(xml -> {\n             PoolDefinition pool = PoolDefinition.parse(xml);\n-            pool.setAutostart(infos.get(poolName).get(\"autostart\").getAsInt() == 1);\n+            if (pool != null) {\n+                pool.setAutostart(infos.get(poolName).get(\"autostart\").getAsInt() == 1);\n+            }\n             return pool;\n         });\n     }\n"}}, {"oid": "a277fe244c04c2f8e8717fedd45c66569a7d6aef", "url": "https://github.com/uyuni-project/uyuni/commit/a277fe244c04c2f8e8717fedd45c66569a7d6aef", "message": "Expose REST API to provide the definition of a virtual storage pool.", "committedDate": "2020-03-05T17:18:59Z", "type": "forcePushed"}, {"oid": "599bec39a543be219eb5e76f57dfb3a11bbd4cdf", "url": "https://github.com/uyuni-project/uyuni/commit/599bec39a543be219eb5e76f57dfb3a11bbd4cdf", "message": "Add virtual pool definition model", "committedDate": "2020-03-06T13:37:55Z", "type": "commit"}, {"oid": "c82a03f3f219f6153e7b605dcc876306d86de5d5", "url": "https://github.com/uyuni-project/uyuni/commit/c82a03f3f219f6153e7b605dcc876306d86de5d5", "message": "VirtManager: expose API to get a pool definition\n\nIn order to edit an existing pool, we need to fetch and parse the\ndefinition from libvirt.", "committedDate": "2020-03-06T13:37:55Z", "type": "commit"}, {"oid": "9b8452433f0cee9c0bc434b58f6ffc670e186258", "url": "https://github.com/uyuni-project/uyuni/commit/9b8452433f0cee9c0bc434b58f6ffc670e186258", "message": "Expose REST API to provide the definition of a virtual storage pool.", "committedDate": "2020-03-06T13:37:55Z", "type": "commit"}, {"oid": "9b8452433f0cee9c0bc434b58f6ffc670e186258", "url": "https://github.com/uyuni-project/uyuni/commit/9b8452433f0cee9c0bc434b58f6ffc670e186258", "message": "Expose REST API to provide the definition of a virtual storage pool.", "committedDate": "2020-03-06T13:37:55Z", "type": "forcePushed"}]}