{"pr_number": 2296, "pr_title": "Drop unpublished errata functionality (API and commandline tools)", "pr_createdAt": "2020-06-05T14:11:37Z", "pr_url": "https://github.com/uyuni-project/uyuni/pull/2296", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk3ODEzNQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2296#discussion_r435978135", "bodyText": "seems you have this line now 2 times", "author": "mcalmer", "createdAt": "2020-06-05T14:57:23Z", "path": "java/code/src/com/redhat/rhn/frontend/action/errata/test/NotifySetupActionTest.java", "diffHunk": "@@ -52,22 +51,10 @@ public void testExecute() throws Exception {\n         User user = requestContext.getCurrentUser();\n         Errata published = ErrataFactoryTest\n                 .createTestPublishedErrata(user.getOrg().getId());\n-        Errata unpublished = ErrataFactoryTest\n-                .createTestUnpublishedErrata(user.getOrg().getId());\n-\n-        //test bad parameter exception\n-        request.setupAddParameter(\"eid\", unpublished.getId().toString());\n-        try {\n-            action.execute(mapping, form, request, response);\n-            fail();\n-        }\n-        catch (BadParameterException e) {\n-            //Success!!!\n-        }\n \n         //test default case\n         request.setupAddParameter(\"eid\", published.getId().toString());\n-        request.setupAddParameter(\"eid\", unpublished.getId().toString());\n+        request.setupAddParameter(\"eid\", published.getId().toString());", "originalCommit": "2d95f9845e1f15efe141db10c3749e4e3e86c1cf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjAyODgzNg==", "url": "https://github.com/uyuni-project/uyuni/pull/2296#discussion_r436028836", "bodyText": "One really needs two in this case, as request is a mock object and the number of times the parameter is read counts!", "author": "moio", "createdAt": "2020-06-05T16:23:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk3ODEzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjM2MDQ4Ng==", "url": "https://github.com/uyuni-project/uyuni/pull/2296#discussion_r436360486", "bodyText": "ok", "author": "mcalmer", "createdAt": "2020-06-07T12:55:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk3ODEzNQ=="}], "type": "inlineReview", "revised_code": {"commit": "48d85d73e016380c090c29a9401db9962c9abb54", "chunk": "diff --git a/java/code/src/com/redhat/rhn/frontend/action/errata/test/NotifySetupActionTest.java b/java/code/src/com/redhat/rhn/frontend/action/errata/test/NotifySetupActionTest.java\nindex e3093bf3e0e..453c8195ec2 100644\n--- a/java/code/src/com/redhat/rhn/frontend/action/errata/test/NotifySetupActionTest.java\n+++ b/java/code/src/com/redhat/rhn/frontend/action/errata/test/NotifySetupActionTest.java\n\n@@ -51,10 +52,22 @@ public class NotifySetupActionTest extends RhnBaseTestCase {\n         User user = requestContext.getCurrentUser();\n         Errata published = ErrataFactoryTest\n                 .createTestPublishedErrata(user.getOrg().getId());\n+        Errata unpublished = ErrataFactoryTest\n+                .createTestUnpublishedErrata(user.getOrg().getId());\n+\n+        //test bad parameter exception\n+        request.setupAddParameter(\"eid\", unpublished.getId().toString());\n+        try {\n+            action.execute(mapping, form, request, response);\n+            fail();\n+        }\n+        catch (BadParameterException e) {\n+            //Success!!!\n+        }\n \n         //test default case\n         request.setupAddParameter(\"eid\", published.getId().toString());\n-        request.setupAddParameter(\"eid\", published.getId().toString());\n+        request.setupAddParameter(\"eid\", unpublished.getId().toString());\n         ActionForward result = action.execute(mapping, form, request, response);\n         assertEquals(RhnHelper.DEFAULT_FORWARD, result.getName());\n         assertNotNull(request.getAttribute(\"advisory\"));\n"}}, {"oid": "61cf70777b538bf9da566b5b711dd3424049de41", "url": "https://github.com/uyuni-project/uyuni/commit/61cf70777b538bf9da566b5b711dd3424049de41", "message": "Changelog updated", "committedDate": "2020-06-05T16:28:16Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjU0NzU0Mg==", "url": "https://github.com/uyuni-project/uyuni/pull/2296#discussion_r436547542", "bodyText": "do we still need this method? shouldn't it be removed entirely?", "author": "chiaradiamarcelo", "createdAt": "2020-06-08T08:54:41Z", "path": "java/code/src/com/redhat/rhn/frontend/xmlrpc/errata/ErrataHandler.java", "diffHunk": "@@ -1324,15 +1324,15 @@ public Errata publish(User loggedInUser, String advisory, List<String> channelLa\n     }\n \n     /**\n-     * Publishes an existing (unpublished) cloned errata to a set of cloned channels\n+     * Publishes an existing cloned errata to a set of cloned channels\n      * according to its original erratum\n      * @param loggedInUser The current user\n      * @param advisory The advisory Name of the errata to publish\n      * @param channelLabels List of channels to publish the errata to\n      * @throws InvalidChannelRoleException if the user perms are incorrect\n      * @return the published errata\n      *\n-     * @xmlrpc.doc Publishes an existing (unpublished) cloned errata to a set of cloned\n+     * @xmlrpc.doc Publishes an existing cloned errata to a set of cloned", "originalCommit": "1df855337efafdba4a654ad9c11e736f194d4408", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjY0NzE0MQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2296#discussion_r436647141", "bodyText": "See https://github.com/uyuni-project/uyuni/pull/2296/files#r436646780", "author": "moio", "createdAt": "2020-06-08T12:11:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjU0NzU0Mg=="}], "type": "inlineReview", "revised_code": {"commit": "48d85d73e016380c090c29a9401db9962c9abb54", "chunk": "diff --git a/java/code/src/com/redhat/rhn/frontend/xmlrpc/errata/ErrataHandler.java b/java/code/src/com/redhat/rhn/frontend/xmlrpc/errata/ErrataHandler.java\nindex 157f9ac9b40..af11136f8c2 100644\n--- a/java/code/src/com/redhat/rhn/frontend/xmlrpc/errata/ErrataHandler.java\n+++ b/java/code/src/com/redhat/rhn/frontend/xmlrpc/errata/ErrataHandler.java\n\n@@ -1324,7 +1375,7 @@ public class ErrataHandler extends BaseHandler {\n     }\n \n     /**\n-     * Publishes an existing cloned errata to a set of cloned channels\n+     * Publishes an existing (unpublished) cloned errata to a set of cloned channels\n      * according to its original erratum\n      * @param loggedInUser The current user\n      * @param advisory The advisory Name of the errata to publish\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjU0ODAwMQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2296#discussion_r436548001", "bodyText": "do we still need this method? shouldn't it be removed entirely?", "author": "chiaradiamarcelo", "createdAt": "2020-06-08T08:55:27Z", "path": "java/code/src/com/redhat/rhn/frontend/xmlrpc/errata/ErrataHandler.java", "diffHunk": "@@ -1303,13 +1303,13 @@ public Integer delete(User loggedInUser, String advisoryName)\n     }\n \n     /**\n-     * Publishes an existing (unpublished) errata to a set of channels\n+     * Publishes an existing errata to a set of channels\n      * @param loggedInUser The current user\n      * @param advisory The advisory Name of the errata to publish\n      * @param channelLabels List of channels to publish the errata to\n      * @return the published errata\n      *\n-     * @xmlrpc.doc Publish an existing (unpublished) errata to a set of channels.\n+     * @xmlrpc.doc Publish an existing errata to a set of channels.", "originalCommit": "1df855337efafdba4a654ad9c11e736f194d4408", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjY0Njc4MA==", "url": "https://github.com/uyuni-project/uyuni/pull/2296#discussion_r436646780", "bodyText": "Not really.\nPublishing a patch to a channel can happen either when the patch has never been published before (unpublished, the case we are removing with this PR and its sister #2280) or when the errata was already published - just in a different channel. The second use case is not expected to go away - and it's actually essential to CLM, for example, when promoting content from a channel (say \"test\") to another (say \"production\").\nWe could come up with another word, but I think publish still makes sense, and in so doing we don't break existing scripts, documentation, etc.", "author": "moio", "createdAt": "2020-06-08T12:11:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjU0ODAwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc4MzYzOQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2296#discussion_r436783639", "bodyText": "I understand that. The thing is not clear to me is: it seems this method was used (AFAIK) only to published \"unpublished\" erratas. We don't have \"unpublished\" erratas anymore.\nSo, either this method should go away now, or this method was also used before to also publish \"published\" erratas.", "author": "chiaradiamarcelo", "createdAt": "2020-06-08T15:11:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjU0ODAwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc5MDUxOA==", "url": "https://github.com/uyuni-project/uyuni/pull/2296#discussion_r436790518", "bodyText": "This is an XMLRPC method, used by spacecmd among others. So already before this PR spacecmd happily passed in published errata IDs, and those worked fine.\nBasically here I corrected the docs because code below did work and was already actively used for published errata as well. It was only documentation being out-of-date - maybe initially this method really only worked / was intended for unpublished errata. That's just not the case today.\nDoes this clarify?", "author": "moio", "createdAt": "2020-06-08T15:20:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjU0ODAwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjkwMzQxOA==", "url": "https://github.com/uyuni-project/uyuni/pull/2296#discussion_r436903418", "bodyText": "Perfect, understood.Thanks", "author": "chiaradiamarcelo", "createdAt": "2020-06-08T18:19:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjU0ODAwMQ=="}], "type": "inlineReview", "revised_code": {"commit": "48d85d73e016380c090c29a9401db9962c9abb54", "chunk": "diff --git a/java/code/src/com/redhat/rhn/frontend/xmlrpc/errata/ErrataHandler.java b/java/code/src/com/redhat/rhn/frontend/xmlrpc/errata/ErrataHandler.java\nindex 157f9ac9b40..af11136f8c2 100644\n--- a/java/code/src/com/redhat/rhn/frontend/xmlrpc/errata/ErrataHandler.java\n+++ b/java/code/src/com/redhat/rhn/frontend/xmlrpc/errata/ErrataHandler.java\n\n@@ -1303,13 +1354,13 @@ public class ErrataHandler extends BaseHandler {\n     }\n \n     /**\n-     * Publishes an existing errata to a set of channels\n+     * Publishes an existing (unpublished) errata to a set of channels\n      * @param loggedInUser The current user\n      * @param advisory The advisory Name of the errata to publish\n      * @param channelLabels List of channels to publish the errata to\n      * @return the published errata\n      *\n-     * @xmlrpc.doc Publish an existing errata to a set of channels.\n+     * @xmlrpc.doc Publish an existing (unpublished) errata to a set of channels.\n      * @xmlrpc.param #session_key()\n      * @xmlrpc.param #param(\"string\", \"advisoryName\")\n      * @xmlrpc.param\n"}}, {"oid": "bdffac42afb3ee69a3a5ac3b79f3559ed94bb360", "url": "https://github.com/uyuni-project/uyuni/commit/bdffac42afb3ee69a3a5ac3b79f3559ed94bb360", "message": "Changelog updated", "committedDate": "2020-06-08T10:59:59Z", "type": "forcePushed"}, {"oid": "48d85d73e016380c090c29a9401db9962c9abb54", "url": "https://github.com/uyuni-project/uyuni/commit/48d85d73e016380c090c29a9401db9962c9abb54", "message": "rhn-clone-errata: drop\n\nThis is a script to clone errata from the Red Hat Network API, which has\nlong been dropped.", "committedDate": "2020-06-08T15:12:56Z", "type": "commit"}, {"oid": "51ef4552ae3351fde37829f5904be4d6e45b1d80", "url": "https://github.com/uyuni-project/uyuni/commit/51ef4552ae3351fde37829f5904be4d6e45b1d80", "message": "ErrataHandler.create: remove flag to create unpublished errata", "committedDate": "2020-06-08T15:12:56Z", "type": "commit"}, {"oid": "2ac4cea94157ff947ca2e1a08756b41135ac3b1c", "url": "https://github.com/uyuni-project/uyuni/commit/2ac4cea94157ff947ca2e1a08756b41135ac3b1c", "message": "ErrataHandler.listUnpublishedErrata: drop", "committedDate": "2020-06-08T15:12:56Z", "type": "commit"}, {"oid": "32373664a84cf554f26063ac9aa9967eb687a3e8", "url": "https://github.com/uyuni-project/uyuni/commit/32373664a84cf554f26063ac9aa9967eb687a3e8", "message": "ErrataHandler.getDetails: limit to published errata", "committedDate": "2020-06-08T15:12:56Z", "type": "commit"}, {"oid": "9e63f2138138fcbfb362b1888eecc3661e8722e0", "url": "https://github.com/uyuni-project/uyuni/commit/9e63f2138138fcbfb362b1888eecc3661e8722e0", "message": "ErrataHandler.setDetails: fix documentation", "committedDate": "2020-06-08T15:12:56Z", "type": "commit"}, {"oid": "662b69e99ea3b0d47717862c019f3904b44b0c6f", "url": "https://github.com/uyuni-project/uyuni/commit/662b69e99ea3b0d47717862c019f3904b44b0c6f", "message": "ErrataHandler.listCves: fix documentation", "committedDate": "2020-06-08T15:12:56Z", "type": "commit"}, {"oid": "0066f85f297be4137ce85c683fa3346027265969", "url": "https://github.com/uyuni-project/uyuni/commit/0066f85f297be4137ce85c683fa3346027265969", "message": "ErrataHandler.publish*: clarify documentation\n\nContrary to what was documented, these methods work equally well on\npublished an unpublished errata.", "committedDate": "2020-06-08T15:12:56Z", "type": "commit"}, {"oid": "4f5efc10192e4fd00ab9b034c73c3273c90164ac", "url": "https://github.com/uyuni-project/uyuni/commit/4f5efc10192e4fd00ab9b034c73c3273c90164ac", "message": "ErrataHandler: fix doc up", "committedDate": "2020-06-08T15:12:57Z", "type": "commit"}, {"oid": "608b41efc8adc8e3e473965f15cbadce2a9d5fef", "url": "https://github.com/uyuni-project/uyuni/commit/608b41efc8adc8e3e473965f15cbadce2a9d5fef", "message": "OvalServlet: do not return unpublished errata\n\nErrataFactory.lookupByAdvisoryId is only called by\nErrataFactory.lookupByIdentifier which is only called by\nErrataManager.lookupErrataByIdentifier which is only called by\nOvalServlet.doGet", "committedDate": "2020-06-08T15:12:57Z", "type": "commit"}, {"oid": "ebdcff8c36f541a29031b305a685154b05839c2e", "url": "https://github.com/uyuni-project/uyuni/commit/ebdcff8c36f541a29031b305a685154b05839c2e", "message": "Bugfix: prevent unpublished errata from being scheduled to apply\n\nErrataFactory.listErrata is only called by\nErrataManager.lookupErrataByIds which is only called by\nErrataManager.applyErrata which is ultimately called by\n - call sites which only used published errata as input:\n   - the single-system errata apply page (which implicitly checked via the UI data flow)\n   - the SSM errata apply page (which implicitly checked via the UI data flow)\n   - the package push page (which implicitly checked via the UI data flow)\n   - the errata notification page (which explicitly checked)\n   - the errata to channel assignment page (which explicitly checked)\n   - ActionManager.scheduleAllErrataUpdate (which only used published errata)\n   - SystemManager.setAutoUpdateBulk (which only used published errata)\n   - ErrataManager.updateStackUpdateNeeded (which only used published errata)\n   - ChannelSoftwareHandler.syncErrata (which explicitly checked)\n\n - call sites which did not check whether input included unpublished\nerrata, and are being fixed by this commit:\n   - ActionChainHandler.addErrataUpdate\n   - ServerGroupHandler.scheduleApplyErrataToActive\n   - SystemHandler.scheduleApplyErrata\n   - the page listing systems affected by an errata\n\n - call sites that are actually broken by this patch\n   - pages to list/add/remove packages, bugs, channels other details to an errata.\nDoing such edits to an unpublished errata will not work at this time,\nunpublished errata will need filtering\n   - the is_published_errata JSP ACL. Pages using that ACL will not work", "committedDate": "2020-06-08T15:12:57Z", "type": "commit"}, {"oid": "c7783d94e63eae6390d69cc9b142423e101f7b87", "url": "https://github.com/uyuni-project/uyuni/commit/c7783d94e63eae6390d69cc9b142423e101f7b87", "message": "Fix JUnit tests after disabling of unpublished errata", "committedDate": "2020-06-08T15:12:57Z", "type": "commit"}, {"oid": "f096691f399d0ac621c3e4fb107e710f1a225741", "url": "https://github.com/uyuni-project/uyuni/commit/f096691f399d0ac621c3e4fb107e710f1a225741", "message": "Changelog updated", "committedDate": "2020-06-08T15:14:07Z", "type": "commit"}, {"oid": "f096691f399d0ac621c3e4fb107e710f1a225741", "url": "https://github.com/uyuni-project/uyuni/commit/f096691f399d0ac621c3e4fb107e710f1a225741", "message": "Changelog updated", "committedDate": "2020-06-08T15:14:07Z", "type": "forcePushed"}]}