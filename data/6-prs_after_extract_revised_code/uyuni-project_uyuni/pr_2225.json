{"pr_number": 2225, "pr_title": "Fix bug with vhm refresh and orgadmins ", "pr_createdAt": "2020-05-18T09:32:51Z", "pr_url": "https://github.com/uyuni-project/uyuni/pull/2225", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjUzNDQ0Mw==", "url": "https://github.com/uyuni-project/uyuni/pull/2225#discussion_r426534443", "bodyText": "With this name, I think we should limit the use and hardcode the bunchName.\nOtherwise it can be used to schedule any bunch which requires Satelite permissions using this new endpoint.\nSee also scheduleRepoSync() .....", "author": "mcalmer", "createdAt": "2020-05-18T10:43:54Z", "path": "java/code/src/com/redhat/rhn/taskomatic/TaskomaticApi.java", "diffHunk": "@@ -221,6 +221,20 @@ public Date scheduleSingleSatBunch(User user, String bunchName,\n         return (Date) invoke(\"tasko.scheduleSingleSatBunchRun\", bunchName, params);\n     }\n \n+    /**\n+     * Creates a new single gatherer schedule\n+     * @param user shall be org admin\n+     * @param bunchName bunch name\n+     * @param params parameters for the bunch\n+     * @return date of the first schedule\n+     * @throws TaskomaticApiException if there was an error\n+     */\n+    public Date scheduleGathererRefresh(User user, String bunchName,", "originalCommit": "16f22055d6c81c71cd097f0669a9b6d426e22455", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjU1NTgyNA==", "url": "https://github.com/uyuni-project/uyuni/pull/2225#discussion_r426555824", "bodyText": "the activation key thing is part of the another pr i made. but i didn't make a separate branch. but i managed to get them removed.", "author": "mseidl", "createdAt": "2020-05-18T11:25:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjUzNDQ0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjY0NTQzOA==", "url": "https://github.com/uyuni-project/uyuni/pull/2225#discussion_r426645438", "bodyText": "I think @mcalmer wants you to get rid of the bunchName parameter and pass the gatherer-matcher-bunch on line 235.\nMoreover, I'd suggest passing a vhmLabel parameter and crafting the params map inside of this method (instead of the whole params map as a param).\nIt'd be also nice to do some additional permission checking here (just call VirtualHostManagerFactory.lookupByLabelAndOrg based on given label and user.getOrg. When the result is null -> throw an exception (IllegalStateException probably)).", "author": "hustodemon", "createdAt": "2020-05-18T13:57:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjUzNDQ0Mw=="}], "type": "inlineReview", "revised_code": {"commit": "17e80d014cf547cc1fc2668bd4e55560644a4f53", "chunk": "diff --git a/java/code/src/com/redhat/rhn/taskomatic/TaskomaticApi.java b/java/code/src/com/redhat/rhn/taskomatic/TaskomaticApi.java\nindex 1c24f421f12..4d0f12cd6ad 100644\n--- a/java/code/src/com/redhat/rhn/taskomatic/TaskomaticApi.java\n+++ b/java/code/src/com/redhat/rhn/taskomatic/TaskomaticApi.java\n\n@@ -221,18 +221,16 @@ public class TaskomaticApi {\n         return (Date) invoke(\"tasko.scheduleSingleSatBunchRun\", bunchName, params);\n     }\n \n-    /**\n+        /**\n      * Creates a new single gatherer schedule\n      * @param user shall be org admin\n-     * @param bunchName bunch name\n      * @param params parameters for the bunch\n      * @return date of the first schedule\n      * @throws TaskomaticApiException if there was an error\n      */\n-    public Date scheduleGathererRefresh(User user, String bunchName,\n-                                       Map<String, String> params) throws TaskomaticApiException {\n+    public Date scheduleGathererRefresh(User user, Map<String, String> params) throws TaskomaticApiException {\n         ensureOrgAdminRole(user);\n-        return (Date) invoke(\"tasko.scheduleSingleSatBunchRun\", bunchName, params);\n+        return (Date) invoke(\"tasko.scheduleSingleSatBunchRun\", \"gatherer-matcher-bunch\", params);\n     }\n \n     /**\n"}}, {"oid": "89743629e8120464dd1c215f63a1713b4f5e5f00", "url": "https://github.com/uyuni-project/uyuni/commit/89743629e8120464dd1c215f63a1713b4f5e5f00", "message": "update changelog", "committedDate": "2020-05-18T11:24:05Z", "type": "forcePushed"}, {"oid": "17e80d014cf547cc1fc2668bd4e55560644a4f53", "url": "https://github.com/uyuni-project/uyuni/commit/17e80d014cf547cc1fc2668bd4e55560644a4f53", "message": "update changelog", "committedDate": "2020-05-19T07:18:29Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTg0ODM2OA==", "url": "https://github.com/uyuni-project/uyuni/pull/2225#discussion_r429848368", "bodyText": "If the label is the only possible value which can be set I would also go with @hustodemon suggestion to replace \"params\" with \"label\" and create the params map inside of the method.\nBut for me this is optional. Not sure what franky think :-)", "author": "mcalmer", "createdAt": "2020-05-25T09:58:50Z", "path": "java/code/src/com/suse/manager/webui/controllers/VirtualHostManagerController.java", "diffHunk": "@@ -616,8 +616,7 @@ public static Object refresh(Request request, Response response, User user) {\n             Map<String, String> params = new HashMap<>();\n             params.put(GathererJob.VHM_LABEL, label);\n             try {\n-                new TaskomaticApi()\n-                        .scheduleSingleSatBunch(user, \"gatherer-matcher-bunch\", params);\n+                new TaskomaticApi().scheduleGathererRefresh(user, params);", "originalCommit": "17e80d014cf547cc1fc2668bd4e55560644a4f53", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTg2NzkxNA==", "url": "https://github.com/uyuni-project/uyuni/pull/2225#discussion_r429867914", "bodyText": "Yes, my comments weren't addressed yet. @mseidl let me know if there is anything unclear about them.", "author": "hustodemon", "createdAt": "2020-05-25T10:45:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTg0ODM2OA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "5c5529eea71c548c02b29234b0b373017f32abf6", "url": "https://github.com/uyuni-project/uyuni/commit/5c5529eea71c548c02b29234b0b373017f32abf6", "message": "update changelog", "committedDate": "2020-05-25T12:23:04Z", "type": "forcePushed"}, {"oid": "8078a2bd940e4c75c92acec5a9e2b6399059754a", "url": "https://github.com/uyuni-project/uyuni/commit/8078a2bd940e4c75c92acec5a9e2b6399059754a", "message": "fix permission issue with orgadmins on vhm refresh", "committedDate": "2020-06-03T21:49:55Z", "type": "commit"}, {"oid": "09cc1d7213897d3065bb005ab9b151f4ba4a1666", "url": "https://github.com/uyuni-project/uyuni/commit/09cc1d7213897d3065bb005ab9b151f4ba4a1666", "message": "update changelog", "committedDate": "2020-06-03T21:50:19Z", "type": "commit"}, {"oid": "09cc1d7213897d3065bb005ab9b151f4ba4a1666", "url": "https://github.com/uyuni-project/uyuni/commit/09cc1d7213897d3065bb005ab9b151f4ba4a1666", "message": "update changelog", "committedDate": "2020-06-03T21:50:19Z", "type": "forcePushed"}]}