{"pr_number": 2498, "pr_title": "Pass the log level to matcher", "pr_createdAt": "2020-08-19T08:14:50Z", "pr_url": "https://github.com/uyuni-project/uyuni/pull/2498", "timeline": [{"oid": "a63d586488774adbd7f5fdfc408aed0e6fe63ea3", "url": "https://github.com/uyuni-project/uyuni/commit/a63d586488774adbd7f5fdfc408aed0e6fe63ea3", "message": "Pass the log level to matcher\n\nDerive the log level from the 'debug' config option and pass it to\nmatcher.", "committedDate": "2020-08-19T08:47:04Z", "type": "forcePushed"}, {"oid": "c03f25256dea4ab8298ec820d50c6935868c89b6", "url": "https://github.com/uyuni-project/uyuni/commit/c03f25256dea4ab8298ec820d50c6935868c89b6", "message": "Pass the log level to matcher\n\nDerive the log level from the 'debug' config option and pass it to\nmatcher.", "committedDate": "2020-08-19T09:21:44Z", "type": "forcePushed"}, {"oid": "9a671276d61bcf06fc89dbe063e8657a3cea31d1", "url": "https://github.com/uyuni-project/uyuni/commit/9a671276d61bcf06fc89dbe063e8657a3cea31d1", "message": "Pass the log level to matcher\n\nDerive the log level from the 'debug' config option and pass it to\nmatcher.", "committedDate": "2020-08-19T09:28:51Z", "type": "forcePushed"}, {"oid": "705832a18ac2f47badad3f80dd00e0cd1c35ba61", "url": "https://github.com/uyuni-project/uyuni/commit/705832a18ac2f47badad3f80dd00e0cd1c35ba61", "message": "Exhaust the matcher output to prevent stuck state", "committedDate": "2020-08-19T12:16:56Z", "type": "forcePushed"}, {"oid": "4068eb76b487ed144496e494aeae4629225a002b", "url": "https://github.com/uyuni-project/uyuni/commit/4068eb76b487ed144496e494aeae4629225a002b", "message": "Exhaust the matcher output to prevent stuck state", "committedDate": "2020-08-19T12:27:47Z", "type": "forcePushed"}, {"oid": "f4c938d3be4369d25ade795d0937e2199c931413", "url": "https://github.com/uyuni-project/uyuni/commit/f4c938d3be4369d25ade795d0937e2199c931413", "message": "Get rid of the 'confirmed' flag in the Match JSON", "committedDate": "2020-08-28T11:59:34Z", "type": "forcePushed"}, {"oid": "d8be6607625d109e0fb946acd372e6589fe93247", "url": "https://github.com/uyuni-project/uyuni/commit/d8be6607625d109e0fb946acd372e6589fe93247", "message": "Get rid of the 'confirmed' flag in the Match JSON", "committedDate": "2020-09-09T11:07:07Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTUzNTg0Mg==", "url": "https://github.com/uyuni-project/uyuni/pull/2498#discussion_r485535842", "bodyText": "Nitpick: could we maybe use try-with-resources here?", "author": "moio", "createdAt": "2020-09-09T11:24:45Z", "path": "java/code/src/com/suse/manager/matcher/MatcherRunner.java", "diffHunk": "@@ -76,22 +80,28 @@ public void run(String csvDelimiter) {\n         });\n \n         Runtime r = Runtime.getRuntime();\n+        ExecutorService errorReaderService = null;\n+        ExecutorService inputReaderService = null;\n         try {\n-            Process p = r.exec(args.toArray(new String[0]));\n-            PrintWriter stdin = new PrintWriter(p.getOutputStream());\n             boolean isISSMaster = IssFactory.getCurrentMaster() == null;\n             boolean isSelfMonitoringEnabled = MonitoringService.isMonitoringEnabled();\n-            String arch = System.getProperty(\"os.arch\");\n             PinnedSubscriptionFactory.getInstance().cleanStalePins();\n+            String arch = System.getProperty(\"os.arch\");\n             String s = new MatcherJsonIO().generateMatcherInput(isISSMaster, arch, isSelfMonitoringEnabled);\n+\n+            Process p = r.exec(args.toArray(new String[0]));\n+            PrintWriter stdin = new PrintWriter(p.getOutputStream());\n             stdin.println(s);\n             stdin.flush();\n             stdin.close();\n \n+            // we need to exhaust the process output not to get stuck\n+            errorReaderService = exhaustOutputOnBackground(p.getErrorStream());", "originalCommit": "3963bb5ca16e5b97e0992954e44dc1dca0a3b509", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a157452ebe5b8d802a37805a376118dc72a8103e", "chunk": "diff --git a/java/code/src/com/suse/manager/matcher/MatcherRunner.java b/java/code/src/com/suse/manager/matcher/MatcherRunner.java\nindex 69c9d35845b..74d6692a0ea 100644\n--- a/java/code/src/com/suse/manager/matcher/MatcherRunner.java\n+++ b/java/code/src/com/suse/manager/matcher/MatcherRunner.java\n\n@@ -80,28 +76,22 @@ public class MatcherRunner {\n         });\n \n         Runtime r = Runtime.getRuntime();\n-        ExecutorService errorReaderService = null;\n-        ExecutorService inputReaderService = null;\n         try {\n+            Process p = r.exec(args.toArray(new String[0]));\n+            PrintWriter stdin = new PrintWriter(p.getOutputStream());\n             boolean isISSMaster = IssFactory.getCurrentMaster() == null;\n             boolean isSelfMonitoringEnabled = MonitoringService.isMonitoringEnabled();\n-            PinnedSubscriptionFactory.getInstance().cleanStalePins();\n             String arch = System.getProperty(\"os.arch\");\n+            PinnedSubscriptionFactory.getInstance().cleanStalePins();\n             String s = new MatcherJsonIO().generateMatcherInput(isISSMaster, arch, isSelfMonitoringEnabled);\n-\n-            Process p = r.exec(args.toArray(new String[0]));\n-            PrintWriter stdin = new PrintWriter(p.getOutputStream());\n             stdin.println(s);\n             stdin.flush();\n             stdin.close();\n \n-            // we need to exhaust the process output not to get stuck\n-            errorReaderService = exhaustOutputOnBackground(p.getErrorStream());\n-            inputReaderService = exhaustOutputOnBackground(p.getInputStream());\n-\n             int exitCode = p.waitFor();\n             if (exitCode != 0) {\n-                logger.error(\"Error while calling the subscription-matcher, exit code \" + exitCode);\n+                logger.error(\"Error while calling the subscription-matcher, exit code \" +\n+                        exitCode);\n                 return;\n             }\n \n"}}, {"oid": "a157452ebe5b8d802a37805a376118dc72a8103e", "url": "https://github.com/uyuni-project/uyuni/commit/a157452ebe5b8d802a37805a376118dc72a8103e", "message": "Pass the log level to matcher\n\nDerive the log level from the 'debug' config option and pass it to\nmatcher.", "committedDate": "2020-09-09T12:29:03Z", "type": "commit"}, {"oid": "f49c582337c7c7624131562567b1ebc4baad2f62", "url": "https://github.com/uyuni-project/uyuni/commit/f49c582337c7c7624131562567b1ebc4baad2f62", "message": "Exhaust the matcher output to prevent stuck state", "committedDate": "2020-09-09T12:29:03Z", "type": "commit"}, {"oid": "c818330efa125b2c6ac4755a8277925704bdd90b", "url": "https://github.com/uyuni-project/uyuni/commit/c818330efa125b2c6ac4755a8277925704bdd90b", "message": "Get rid of the 'confirmed' flag in the Match JSON", "committedDate": "2020-09-09T12:29:03Z", "type": "commit"}, {"oid": "bc5fede46cd654b01860917ed0351e6412fa4714", "url": "https://github.com/uyuni-project/uyuni/commit/bc5fede46cd654b01860917ed0351e6412fa4714", "message": "Use try-with-resources statement", "committedDate": "2020-09-09T12:29:03Z", "type": "commit"}, {"oid": "6f5e2aea844219b7accc2aca430eec1e55c87285", "url": "https://github.com/uyuni-project/uyuni/commit/6f5e2aea844219b7accc2aca430eec1e55c87285", "message": "Make checkstyle happy", "committedDate": "2020-09-09T12:29:03Z", "type": "commit"}, {"oid": "6f5e2aea844219b7accc2aca430eec1e55c87285", "url": "https://github.com/uyuni-project/uyuni/commit/6f5e2aea844219b7accc2aca430eec1e55c87285", "message": "Make checkstyle happy", "committedDate": "2020-09-09T12:29:03Z", "type": "forcePushed"}]}