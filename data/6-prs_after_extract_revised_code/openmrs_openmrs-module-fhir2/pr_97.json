{"pr_number": 97, "pr_title": "FM2-83 : Create appropriate search functionality for allergy intolerance resource", "pr_createdAt": "2020-03-01T13:52:58Z", "pr_url": "https://github.com/openmrs/openmrs-module-fhir2/pull/97", "timeline": [{"oid": "6055d1cefd24ec99ec12d179927720de83d38bd7", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/6055d1cefd24ec99ec12d179927720de83d38bd7", "message": "FM2-83 : Create appropriate search functionality for allergy intolerance resource", "committedDate": "2020-03-01T17:30:46Z", "type": "forcePushed"}, {"oid": "8beea9cdc9c7355d78c31c2ac215a88df3445185", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/8beea9cdc9c7355d78c31c2ac215a88df3445185", "message": "FM2-83 : Create appropriate search functionality for allergy intolerance resource", "committedDate": "2020-03-02T14:15:05Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjUwNDI5NQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/97#discussion_r386504295", "bodyText": "Imported but never used", "author": "corneliouzbett", "createdAt": "2020-03-02T16:32:18Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/impl/FhirAllergyIntoleranceServiceImpl.java", "diffHunk": "@@ -11,8 +11,16 @@\n \n import javax.inject.Inject;\n \n+import java.util.Collection;\n+import java.util.stream.Collectors;\n+\n+import ca.uhn.fhir.rest.param.ReferenceParam;\n+import ca.uhn.fhir.rest.param.StringOrListParam;\n+import ca.uhn.fhir.rest.param.TokenOrListParam;\n import lombok.AccessLevel;\n import lombok.Setter;\n+import org.apache.commons.logging.Log;\n+import org.apache.commons.logging.LogFactory;", "originalCommit": "8beea9cdc9c7355d78c31c2ac215a88df3445185", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ef0c6b08f8dda46610f8f8582bc4ca20aeddbac7", "chunk": "diff --git a/api/src/main/java/org/openmrs/module/fhir2/api/impl/FhirAllergyIntoleranceServiceImpl.java b/api/src/main/java/org/openmrs/module/fhir2/api/impl/FhirAllergyIntoleranceServiceImpl.java\nindex 0d890ada..0817626c 100644\n--- a/api/src/main/java/org/openmrs/module/fhir2/api/impl/FhirAllergyIntoleranceServiceImpl.java\n+++ b/api/src/main/java/org/openmrs/module/fhir2/api/impl/FhirAllergyIntoleranceServiceImpl.java\n\n@@ -19,8 +19,6 @@ import ca.uhn.fhir.rest.param.StringOrListParam;\n import ca.uhn.fhir.rest.param.TokenOrListParam;\n import lombok.AccessLevel;\n import lombok.Setter;\n-import org.apache.commons.logging.Log;\n-import org.apache.commons.logging.LogFactory;\n import org.hl7.fhir.r4.model.AllergyIntolerance;\n import org.openmrs.module.fhir2.api.FhirAllergyIntoleranceService;\n import org.openmrs.module.fhir2.api.dao.FhirAllergyIntoleranceDao;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjUwNTE3MQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/97#discussion_r386505171", "bodyText": "Ditto", "author": "corneliouzbett", "createdAt": "2020-03-02T16:33:37Z", "path": "omod/src/main/java/org/openmrs/module/fhir2/providers/AllergyIntoleranceFhirResourceProvider.java", "diffHunk": "@@ -13,15 +13,25 @@\n import javax.validation.constraints.NotNull;\n \n import ca.uhn.fhir.rest.annotation.IdParam;\n+import ca.uhn.fhir.rest.annotation.OptionalParam;\n import ca.uhn.fhir.rest.annotation.Read;\n+import ca.uhn.fhir.rest.annotation.Search;\n+import ca.uhn.fhir.rest.param.ReferenceParam;\n+import ca.uhn.fhir.rest.param.StringOrListParam;\n+import ca.uhn.fhir.rest.param.TokenOrListParam;\n import ca.uhn.fhir.rest.server.IResourceProvider;\n import ca.uhn.fhir.rest.server.exceptions.ResourceNotFoundException;\n import lombok.AccessLevel;\n import lombok.Setter;\n+import org.apache.commons.logging.Log;\n+import org.apache.commons.logging.LogFactory;", "originalCommit": "8beea9cdc9c7355d78c31c2ac215a88df3445185", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ef0c6b08f8dda46610f8f8582bc4ca20aeddbac7", "chunk": "diff --git a/omod/src/main/java/org/openmrs/module/fhir2/providers/AllergyIntoleranceFhirResourceProvider.java b/omod/src/main/java/org/openmrs/module/fhir2/providers/AllergyIntoleranceFhirResourceProvider.java\nindex 50db76f1..513e1f52 100644\n--- a/omod/src/main/java/org/openmrs/module/fhir2/providers/AllergyIntoleranceFhirResourceProvider.java\n+++ b/omod/src/main/java/org/openmrs/module/fhir2/providers/AllergyIntoleranceFhirResourceProvider.java\n\n@@ -23,8 +23,6 @@ import ca.uhn.fhir.rest.server.IResourceProvider;\n import ca.uhn.fhir.rest.server.exceptions.ResourceNotFoundException;\n import lombok.AccessLevel;\n import lombok.Setter;\n-import org.apache.commons.logging.Log;\n-import org.apache.commons.logging.LogFactory;\n import org.hl7.fhir.instance.model.api.IBaseResource;\n import org.hl7.fhir.r4.model.AllergyIntolerance;\n import org.hl7.fhir.r4.model.Bundle;\n"}}, {"oid": "ef0c6b08f8dda46610f8f8582bc4ca20aeddbac7", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/ef0c6b08f8dda46610f8f8582bc4ca20aeddbac7", "message": "FM2-90 : Add ability to search patients using address-country", "committedDate": "2020-03-02T18:47:48Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njk4OTIxOQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/97#discussion_r386989219", "bodyText": "Why do you pass statusParam as TokenOrListParam", "author": "corneliouzbett", "createdAt": "2020-03-03T12:33:29Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirAllergyIntoleranceDaoImpl.java", "diffHunk": "@@ -10,28 +10,181 @@\n package org.openmrs.module.fhir2.api.dao.impl;\n \n import static org.hibernate.criterion.Restrictions.eq;\n+import static org.hibernate.criterion.Restrictions.in;\n+import static org.hibernate.criterion.Restrictions.or;\n \n import javax.inject.Inject;\n import javax.inject.Named;\n \n+import java.util.Collection;\n+import java.util.Optional;\n+\n+import ca.uhn.fhir.rest.param.ReferenceParam;\n+import ca.uhn.fhir.rest.param.StringOrListParam;\n+import ca.uhn.fhir.rest.param.TokenOrListParam;\n import lombok.AccessLevel;\n import lombok.Setter;\n+import org.hibernate.Criteria;\n import org.hibernate.SessionFactory;\n+import org.hibernate.criterion.Criterion;\n+import org.hl7.fhir.exceptions.FHIRException;\n+import org.hl7.fhir.r4.model.AllergyIntolerance;\n+import org.openmrs.AllergenType;\n import org.openmrs.Allergy;\n+import org.openmrs.Concept;\n+import org.openmrs.module.fhir2.FhirConstants;\n+import org.openmrs.module.fhir2.api.FhirConceptService;\n+import org.openmrs.module.fhir2.api.FhirGlobalPropertyService;\n import org.openmrs.module.fhir2.api.dao.FhirAllergyIntoleranceDao;\n import org.springframework.stereotype.Component;\n \n @Component\n @Setter(AccessLevel.PACKAGE)\n-public class FhirAllergyIntoleranceDaoImpl implements FhirAllergyIntoleranceDao {\n+public class FhirAllergyIntoleranceDaoImpl extends BaseDaoImpl implements FhirAllergyIntoleranceDao {\n \t\n \t@Inject\n \t@Named(\"sessionFactory\")\n \tprivate SessionFactory sessionFactory;\n \t\n+\t@Inject\n+\tprivate FhirConceptService conceptService;\n+\t\n+\t@Inject\n+\tprivate FhirGlobalPropertyService globalPropertyService;\n+\t\n \t@Override\n \tpublic Allergy getAllergyIntoleranceByUuid(String uuid) {\n \t\treturn (Allergy) sessionFactory.getCurrentSession().createCriteria(Allergy.class).add(eq(\"uuid\", uuid))\n \t\t        .uniqueResult();\n \t}\n+\t\n+\t@Override\n+\tpublic Collection<Allergy> searchForAllergies(ReferenceParam patientReference, StringOrListParam category,\n+\t        TokenOrListParam allergen, TokenOrListParam severity, TokenOrListParam manifestationCode,\n+\t        StringOrListParam clinicalStatus) {\n+\t\tCriteria criteria = sessionFactory.getCurrentSession().createCriteria(Allergy.class);\n+\t\thandlePatientReference(criteria, patientReference, \"patient\");\n+\t\thandleAllergenCategory(\"allergen.allergenType\", category);\n+\t\thandleAllergen(criteria, allergen);\n+\t\thandleSeverity(criteria, severity).ifPresent(criteria::add);\n+\t\thandleManifestation(criteria, manifestationCode);\n+\t\thandleBoolean(\"voided\", createClinicalStatusToken(clinicalStatus));\n+\t\t\n+\t\treturn criteria.list();\n+\t}\n+\t\n+\tprivate void handleManifestation(Criteria criteria, TokenOrListParam manifestation) {\n+\t\tif (manifestation == null) {\n+\t\t\treturn;\n+\t\t}\n+\t\tcriteria.createAlias(\"reactions\", \"r\");\n+\t\tcriteria.createAlias(\"r.reaction\", \"c\");\n+\t\t\n+\t\thandleOrListParamBySystem(manifestation, (system, tokens) -> {\n+\t\t\tif (system.isEmpty()) {\n+\t\t\t\treturn Optional.of(in(\"c.uuid\", tokensToList(tokens)));\n+\t\t\t} else {\n+\t\t\t\tif (!containsAlias(criteria, \"rs\")) {\n+\t\t\t\t\tcriteria.createAlias(\"c.uuid\", \"rs\");\n+\t\t\t\t}\n+\t\t\t\t\n+\t\t\t\treturn Optional.of(or(eq(\"rs.name\", system), in(\"c.uuid\", tokensToList(tokens))));\n+\t\t\t}\n+\t\t}).ifPresent(criteria::add);\n+\t}\n+\t\n+\tprivate void handleAllergen(Criteria criteria, TokenOrListParam allergen) {\n+\t\tif (allergen == null) {\n+\t\t\treturn;\n+\t\t}\n+\t\t\n+\t\tcriteria.createAlias(\"allergen.codedAllergen\", \"c\");\n+\t\t\n+\t\thandleOrListParamBySystem(allergen, (system, tokens) -> {\n+\t\t\tif (system.isEmpty()) {\n+\t\t\t\treturn Optional.of(in(\"c.uuid\", tokensToList(tokens)));\n+\t\t\t} else {\n+\t\t\t\tif (!containsAlias(criteria, \"cs\")) {\n+\t\t\t\t\tcriteria.createAlias(\"c.uuid\", \"cs\");\n+\t\t\t\t}\n+\t\t\t\t\n+\t\t\t\treturn Optional.of(or(eq(\"cs.name\", system), in(\"c.uuid\", tokensToList(tokens))));\n+\t\t\t}\n+\t\t}).ifPresent(criteria::add);\n+\t}\n+\t\n+\tprivate Optional<Criterion> handleSeverity(Criteria criteria, TokenOrListParam severityParam) {\n+\t\tif (severityParam == null) {\n+\t\t\treturn Optional.empty();\n+\t\t}\n+\t\tcriteria.createAlias(\"severity\", \"c\");\n+\t\t\n+\t\treturn handleOrListParam(severityParam, token -> {\n+\t\t\ttry {\n+\t\t\t\tAllergyIntolerance.AllergyIntoleranceSeverity severity = AllergyIntolerance.AllergyIntoleranceSeverity\n+\t\t\t\t        .fromCode(token.getValue());\n+\t\t\t\tswitch (severity) {\n+\t\t\t\t\tcase MILD:\n+\t\t\t\t\t\treturn Optional.of(eq(\"c.conceptId\",\n+\t\t\t\t\t\t    getConceptId(globalPropertyService.getGlobalProperty(FhirConstants.GLOBAL_PROPERTY_MILD))));\n+\t\t\t\t\tcase MODERATE:\n+\t\t\t\t\t\treturn Optional.of(eq(\"c.conceptId\",\n+\t\t\t\t\t\t    getConceptId(globalPropertyService.getGlobalProperty(FhirConstants.GLOBAL_PROPERTY_MODERATE))));\n+\t\t\t\t\tcase SEVERE:\n+\t\t\t\t\t\treturn Optional.of(eq(\"c.conceptId\",\n+\t\t\t\t\t\t    getConceptId(globalPropertyService.getGlobalProperty(FhirConstants.GLOBAL_PROPERTY_SEVERE))));\n+\t\t\t\t\tcase NULL:\n+\t\t\t\t\t\treturn Optional.of(eq(\"c.conceptId\",\n+\t\t\t\t\t\t    getConceptId(globalPropertyService.getGlobalProperty(FhirConstants.GLOBAL_PROPERTY_OTHER))));\n+\t\t\t\t}\n+\t\t\t}\n+\t\t\tcatch (FHIRException ignored) {}\n+\t\t\treturn Optional.empty();\n+\t\t});\n+\t\t\n+\t}\n+\t\n+\tprivate Optional<Criterion> handleAllergenCategory(String propertyName, StringOrListParam categoryParam) {\n+\t\tif (categoryParam == null) {\n+\t\t\treturn Optional.empty();\n+\t\t}\n+\t\t\n+\t\treturn handleOrListParam(categoryParam, token -> {\n+\t\t\ttry {\n+\t\t\t\tAllergyIntolerance.AllergyIntoleranceCategory category = AllergyIntolerance.AllergyIntoleranceCategory\n+\t\t\t\t        .fromCode(token.getValue());\n+\t\t\t\tswitch (category) {\n+\t\t\t\t\tcase FOOD:\n+\t\t\t\t\t\treturn Optional.of(eq(propertyName, AllergenType.FOOD));\n+\t\t\t\t\tcase MEDICATION:\n+\t\t\t\t\t\treturn Optional.of(eq(propertyName, AllergenType.DRUG));\n+\t\t\t\t\tcase ENVIRONMENT:\n+\t\t\t\t\t\treturn Optional.of(eq(propertyName, AllergenType.ENVIRONMENT));\n+\t\t\t\t\tcase NULL:\n+\t\t\t\t\t\treturn Optional.of(eq(propertyName, AllergenType.OTHER));\n+\t\t\t\t}\n+\t\t\t}\n+\t\t\tcatch (FHIRException ignored) {}\n+\t\t\treturn Optional.empty();\n+\t\t});\n+\t\t\n+\t}\n+\t\n+\tpublic TokenOrListParam createClinicalStatusToken(StringOrListParam statusParam) {\n+\t\tif (statusParam != null && !statusParam.getValuesAsQueryTokens().isEmpty()) {\n+\t\t\tswitch (statusParam.getValuesAsQueryTokens().get(0).getValue()) {\n+\t\t\t\tcase \"active\":\n+\t\t\t\t\treturn new TokenOrListParam().add(\"false\");\n+\t\t\t\tcase \"inactive\":\n+\t\t\t\t\treturn new TokenOrListParam().add(\"true\");\n+\t\t\t}\n+\t\t}\n+\t\treturn null;\n+\t}", "originalCommit": "ef0c6b08f8dda46610f8f8582bc4ca20aeddbac7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2b3e281559fef9b6cc37eb6c6548bb32727f5f45", "chunk": "diff --git a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirAllergyIntoleranceDaoImpl.java b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirAllergyIntoleranceDaoImpl.java\nindex 62d590c2..d3ad30c2 100644\n--- a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirAllergyIntoleranceDaoImpl.java\n+++ b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirAllergyIntoleranceDaoImpl.java\n\n@@ -17,13 +17,16 @@ import javax.inject.Inject;\n import javax.inject.Named;\n \n import java.util.Collection;\n+import java.util.List;\n import java.util.Optional;\n+import java.util.stream.Collectors;\n \n import ca.uhn.fhir.rest.param.ReferenceParam;\n import ca.uhn.fhir.rest.param.StringOrListParam;\n import ca.uhn.fhir.rest.param.TokenOrListParam;\n import lombok.AccessLevel;\n import lombok.Setter;\n+import org.apache.commons.lang3.math.NumberUtils;\n import org.hibernate.Criteria;\n import org.hibernate.SessionFactory;\n import org.hibernate.criterion.Criterion;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzAxNjM0Nw==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/97#discussion_r387016347", "bodyText": "clinicalStatus should be a TokenOrListParam. The definitions for the values taken by these parameters can be found here. Note that the difference between a TokenParam and a StringParam is that the TokenParam can contain a system value indicating what value-set the value it encodes represents.", "author": "ibacher", "createdAt": "2020-03-03T13:26:16Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/FhirAllergyIntoleranceService.java", "diffHunk": "@@ -11,9 +11,18 @@\n \n import javax.validation.constraints.NotNull;\n \n+import java.util.Collection;\n+\n+import ca.uhn.fhir.rest.param.ReferenceParam;\n+import ca.uhn.fhir.rest.param.StringOrListParam;\n+import ca.uhn.fhir.rest.param.TokenOrListParam;\n import org.hl7.fhir.r4.model.AllergyIntolerance;\n \n public interface FhirAllergyIntoleranceService {\n \t\n \tAllergyIntolerance getAllergyIntoleranceByUuid(@NotNull String uuid);\n+\t\n+\tCollection<AllergyIntolerance> searchForAllergies(ReferenceParam patientReference, StringOrListParam category,\n+\t        TokenOrListParam allergen, TokenOrListParam severity, TokenOrListParam manifestationCode,\n+\t        StringOrListParam clinicalStatus);", "originalCommit": "ef0c6b08f8dda46610f8f8582bc4ca20aeddbac7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2b3e281559fef9b6cc37eb6c6548bb32727f5f45", "chunk": "diff --git a/api/src/main/java/org/openmrs/module/fhir2/api/FhirAllergyIntoleranceService.java b/api/src/main/java/org/openmrs/module/fhir2/api/FhirAllergyIntoleranceService.java\nindex 5f0f16e2..0b899ed9 100644\n--- a/api/src/main/java/org/openmrs/module/fhir2/api/FhirAllergyIntoleranceService.java\n+++ b/api/src/main/java/org/openmrs/module/fhir2/api/FhirAllergyIntoleranceService.java\n\n@@ -24,5 +24,5 @@ public interface FhirAllergyIntoleranceService {\n \t\n \tCollection<AllergyIntolerance> searchForAllergies(ReferenceParam patientReference, StringOrListParam category,\n \t        TokenOrListParam allergen, TokenOrListParam severity, TokenOrListParam manifestationCode,\n-\t        StringOrListParam clinicalStatus);\n+\t        TokenOrListParam clinicalStatus);\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzAxNjUyMA==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/97#discussion_r387016520", "bodyText": "As above for clinicalStatus", "author": "ibacher", "createdAt": "2020-03-03T13:26:34Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/dao/FhirAllergyIntoleranceDao.java", "diffHunk": "@@ -11,9 +11,20 @@\n \n import javax.validation.constraints.NotNull;\n \n+import java.util.Collection;\n+\n+import ca.uhn.fhir.rest.annotation.OptionalParam;\n+import ca.uhn.fhir.rest.param.ReferenceParam;\n+import ca.uhn.fhir.rest.param.StringOrListParam;\n+import ca.uhn.fhir.rest.param.TokenOrListParam;\n+import org.hl7.fhir.r4.model.Patient;\n import org.openmrs.Allergy;\n \n public interface FhirAllergyIntoleranceDao {\n \t\n \tAllergy getAllergyIntoleranceByUuid(@NotNull String uuid);\n+\t\n+\tCollection<Allergy> searchForAllergies(@OptionalParam(name = Patient.SP_IDENTIFIER) ReferenceParam patientReference,\n+\t        StringOrListParam category, TokenOrListParam allergen, TokenOrListParam severity,\n+\t        TokenOrListParam manifestationCode, StringOrListParam clinicalStatus);", "originalCommit": "ef0c6b08f8dda46610f8f8582bc4ca20aeddbac7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2b3e281559fef9b6cc37eb6c6548bb32727f5f45", "chunk": "diff --git a/api/src/main/java/org/openmrs/module/fhir2/api/dao/FhirAllergyIntoleranceDao.java b/api/src/main/java/org/openmrs/module/fhir2/api/dao/FhirAllergyIntoleranceDao.java\nindex da7be4e3..d3c2eb7c 100644\n--- a/api/src/main/java/org/openmrs/module/fhir2/api/dao/FhirAllergyIntoleranceDao.java\n+++ b/api/src/main/java/org/openmrs/module/fhir2/api/dao/FhirAllergyIntoleranceDao.java\n\n@@ -13,18 +13,16 @@ import javax.validation.constraints.NotNull;\n \n import java.util.Collection;\n \n-import ca.uhn.fhir.rest.annotation.OptionalParam;\n import ca.uhn.fhir.rest.param.ReferenceParam;\n import ca.uhn.fhir.rest.param.StringOrListParam;\n import ca.uhn.fhir.rest.param.TokenOrListParam;\n-import org.hl7.fhir.r4.model.Patient;\n import org.openmrs.Allergy;\n \n public interface FhirAllergyIntoleranceDao {\n \t\n \tAllergy getAllergyIntoleranceByUuid(@NotNull String uuid);\n \t\n-\tCollection<Allergy> searchForAllergies(@OptionalParam(name = Patient.SP_IDENTIFIER) ReferenceParam patientReference,\n-\t        StringOrListParam category, TokenOrListParam allergen, TokenOrListParam severity,\n-\t        TokenOrListParam manifestationCode, StringOrListParam clinicalStatus);\n+\tCollection<Allergy> searchForAllergies(ReferenceParam patientReference, StringOrListParam category,\n+\t        TokenOrListParam allergen, TokenOrListParam severity, TokenOrListParam manifestationCode,\n+\t        TokenOrListParam clinicalStatus);\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzAxNjc1Mg==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/97#discussion_r387016752", "bodyText": "@OptionalParam does not belong here, but only on the ResourceProvider.", "author": "ibacher", "createdAt": "2020-03-03T13:27:02Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/dao/FhirAllergyIntoleranceDao.java", "diffHunk": "@@ -11,9 +11,20 @@\n \n import javax.validation.constraints.NotNull;\n \n+import java.util.Collection;\n+\n+import ca.uhn.fhir.rest.annotation.OptionalParam;\n+import ca.uhn.fhir.rest.param.ReferenceParam;\n+import ca.uhn.fhir.rest.param.StringOrListParam;\n+import ca.uhn.fhir.rest.param.TokenOrListParam;\n+import org.hl7.fhir.r4.model.Patient;\n import org.openmrs.Allergy;\n \n public interface FhirAllergyIntoleranceDao {\n \t\n \tAllergy getAllergyIntoleranceByUuid(@NotNull String uuid);\n+\t\n+\tCollection<Allergy> searchForAllergies(@OptionalParam(name = Patient.SP_IDENTIFIER) ReferenceParam patientReference,", "originalCommit": "ef0c6b08f8dda46610f8f8582bc4ca20aeddbac7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2b3e281559fef9b6cc37eb6c6548bb32727f5f45", "chunk": "diff --git a/api/src/main/java/org/openmrs/module/fhir2/api/dao/FhirAllergyIntoleranceDao.java b/api/src/main/java/org/openmrs/module/fhir2/api/dao/FhirAllergyIntoleranceDao.java\nindex da7be4e3..d3c2eb7c 100644\n--- a/api/src/main/java/org/openmrs/module/fhir2/api/dao/FhirAllergyIntoleranceDao.java\n+++ b/api/src/main/java/org/openmrs/module/fhir2/api/dao/FhirAllergyIntoleranceDao.java\n\n@@ -13,18 +13,16 @@ import javax.validation.constraints.NotNull;\n \n import java.util.Collection;\n \n-import ca.uhn.fhir.rest.annotation.OptionalParam;\n import ca.uhn.fhir.rest.param.ReferenceParam;\n import ca.uhn.fhir.rest.param.StringOrListParam;\n import ca.uhn.fhir.rest.param.TokenOrListParam;\n-import org.hl7.fhir.r4.model.Patient;\n import org.openmrs.Allergy;\n \n public interface FhirAllergyIntoleranceDao {\n \t\n \tAllergy getAllergyIntoleranceByUuid(@NotNull String uuid);\n \t\n-\tCollection<Allergy> searchForAllergies(@OptionalParam(name = Patient.SP_IDENTIFIER) ReferenceParam patientReference,\n-\t        StringOrListParam category, TokenOrListParam allergen, TokenOrListParam severity,\n-\t        TokenOrListParam manifestationCode, StringOrListParam clinicalStatus);\n+\tCollection<Allergy> searchForAllergies(ReferenceParam patientReference, StringOrListParam category,\n+\t        TokenOrListParam allergen, TokenOrListParam severity, TokenOrListParam manifestationCode,\n+\t        TokenOrListParam clinicalStatus);\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzAxNzUzNA==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/97#discussion_r387017534", "bodyText": "This seems to be creating a join on the codedAllergen.uuid field, which is not going to work.", "author": "ibacher", "createdAt": "2020-03-03T13:28:35Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirAllergyIntoleranceDaoImpl.java", "diffHunk": "@@ -10,28 +10,181 @@\n package org.openmrs.module.fhir2.api.dao.impl;\n \n import static org.hibernate.criterion.Restrictions.eq;\n+import static org.hibernate.criterion.Restrictions.in;\n+import static org.hibernate.criterion.Restrictions.or;\n \n import javax.inject.Inject;\n import javax.inject.Named;\n \n+import java.util.Collection;\n+import java.util.Optional;\n+\n+import ca.uhn.fhir.rest.param.ReferenceParam;\n+import ca.uhn.fhir.rest.param.StringOrListParam;\n+import ca.uhn.fhir.rest.param.TokenOrListParam;\n import lombok.AccessLevel;\n import lombok.Setter;\n+import org.hibernate.Criteria;\n import org.hibernate.SessionFactory;\n+import org.hibernate.criterion.Criterion;\n+import org.hl7.fhir.exceptions.FHIRException;\n+import org.hl7.fhir.r4.model.AllergyIntolerance;\n+import org.openmrs.AllergenType;\n import org.openmrs.Allergy;\n+import org.openmrs.Concept;\n+import org.openmrs.module.fhir2.FhirConstants;\n+import org.openmrs.module.fhir2.api.FhirConceptService;\n+import org.openmrs.module.fhir2.api.FhirGlobalPropertyService;\n import org.openmrs.module.fhir2.api.dao.FhirAllergyIntoleranceDao;\n import org.springframework.stereotype.Component;\n \n @Component\n @Setter(AccessLevel.PACKAGE)\n-public class FhirAllergyIntoleranceDaoImpl implements FhirAllergyIntoleranceDao {\n+public class FhirAllergyIntoleranceDaoImpl extends BaseDaoImpl implements FhirAllergyIntoleranceDao {\n \t\n \t@Inject\n \t@Named(\"sessionFactory\")\n \tprivate SessionFactory sessionFactory;\n \t\n+\t@Inject\n+\tprivate FhirConceptService conceptService;\n+\t\n+\t@Inject\n+\tprivate FhirGlobalPropertyService globalPropertyService;\n+\t\n \t@Override\n \tpublic Allergy getAllergyIntoleranceByUuid(String uuid) {\n \t\treturn (Allergy) sessionFactory.getCurrentSession().createCriteria(Allergy.class).add(eq(\"uuid\", uuid))\n \t\t        .uniqueResult();\n \t}\n+\t\n+\t@Override\n+\tpublic Collection<Allergy> searchForAllergies(ReferenceParam patientReference, StringOrListParam category,\n+\t        TokenOrListParam allergen, TokenOrListParam severity, TokenOrListParam manifestationCode,\n+\t        StringOrListParam clinicalStatus) {\n+\t\tCriteria criteria = sessionFactory.getCurrentSession().createCriteria(Allergy.class);\n+\t\thandlePatientReference(criteria, patientReference, \"patient\");\n+\t\thandleAllergenCategory(\"allergen.allergenType\", category);\n+\t\thandleAllergen(criteria, allergen);\n+\t\thandleSeverity(criteria, severity).ifPresent(criteria::add);\n+\t\thandleManifestation(criteria, manifestationCode);\n+\t\thandleBoolean(\"voided\", createClinicalStatusToken(clinicalStatus));\n+\t\t\n+\t\treturn criteria.list();\n+\t}\n+\t\n+\tprivate void handleManifestation(Criteria criteria, TokenOrListParam manifestation) {\n+\t\tif (manifestation == null) {\n+\t\t\treturn;\n+\t\t}\n+\t\tcriteria.createAlias(\"reactions\", \"r\");\n+\t\tcriteria.createAlias(\"r.reaction\", \"c\");\n+\t\t\n+\t\thandleOrListParamBySystem(manifestation, (system, tokens) -> {\n+\t\t\tif (system.isEmpty()) {\n+\t\t\t\treturn Optional.of(in(\"c.uuid\", tokensToList(tokens)));\n+\t\t\t} else {\n+\t\t\t\tif (!containsAlias(criteria, \"rs\")) {\n+\t\t\t\t\tcriteria.createAlias(\"c.uuid\", \"rs\");\n+\t\t\t\t}\n+\t\t\t\t\n+\t\t\t\treturn Optional.of(or(eq(\"rs.name\", system), in(\"c.uuid\", tokensToList(tokens))));\n+\t\t\t}\n+\t\t}).ifPresent(criteria::add);\n+\t}\n+\t\n+\tprivate void handleAllergen(Criteria criteria, TokenOrListParam allergen) {\n+\t\tif (allergen == null) {\n+\t\t\treturn;\n+\t\t}\n+\t\t\n+\t\tcriteria.createAlias(\"allergen.codedAllergen\", \"c\");\n+\t\t\n+\t\thandleOrListParamBySystem(allergen, (system, tokens) -> {\n+\t\t\tif (system.isEmpty()) {\n+\t\t\t\treturn Optional.of(in(\"c.uuid\", tokensToList(tokens)));\n+\t\t\t} else {\n+\t\t\t\tif (!containsAlias(criteria, \"cs\")) {\n+\t\t\t\t\tcriteria.createAlias(\"c.uuid\", \"cs\");", "originalCommit": "ef0c6b08f8dda46610f8f8582bc4ca20aeddbac7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2b3e281559fef9b6cc37eb6c6548bb32727f5f45", "chunk": "diff --git a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirAllergyIntoleranceDaoImpl.java b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirAllergyIntoleranceDaoImpl.java\nindex 62d590c2..d3ad30c2 100644\n--- a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirAllergyIntoleranceDaoImpl.java\n+++ b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirAllergyIntoleranceDaoImpl.java\n\n@@ -17,13 +17,16 @@ import javax.inject.Inject;\n import javax.inject.Named;\n \n import java.util.Collection;\n+import java.util.List;\n import java.util.Optional;\n+import java.util.stream.Collectors;\n \n import ca.uhn.fhir.rest.param.ReferenceParam;\n import ca.uhn.fhir.rest.param.StringOrListParam;\n import ca.uhn.fhir.rest.param.TokenOrListParam;\n import lombok.AccessLevel;\n import lombok.Setter;\n+import org.apache.commons.lang3.math.NumberUtils;\n import org.hibernate.Criteria;\n import org.hibernate.SessionFactory;\n import org.hibernate.criterion.Criterion;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzAxNzg4Nw==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/97#discussion_r387017887", "bodyText": "This seems to be creating a join on the r.reaction.uuid field, which is not going to work.", "author": "ibacher", "createdAt": "2020-03-03T13:29:05Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirAllergyIntoleranceDaoImpl.java", "diffHunk": "@@ -10,28 +10,181 @@\n package org.openmrs.module.fhir2.api.dao.impl;\n \n import static org.hibernate.criterion.Restrictions.eq;\n+import static org.hibernate.criterion.Restrictions.in;\n+import static org.hibernate.criterion.Restrictions.or;\n \n import javax.inject.Inject;\n import javax.inject.Named;\n \n+import java.util.Collection;\n+import java.util.Optional;\n+\n+import ca.uhn.fhir.rest.param.ReferenceParam;\n+import ca.uhn.fhir.rest.param.StringOrListParam;\n+import ca.uhn.fhir.rest.param.TokenOrListParam;\n import lombok.AccessLevel;\n import lombok.Setter;\n+import org.hibernate.Criteria;\n import org.hibernate.SessionFactory;\n+import org.hibernate.criterion.Criterion;\n+import org.hl7.fhir.exceptions.FHIRException;\n+import org.hl7.fhir.r4.model.AllergyIntolerance;\n+import org.openmrs.AllergenType;\n import org.openmrs.Allergy;\n+import org.openmrs.Concept;\n+import org.openmrs.module.fhir2.FhirConstants;\n+import org.openmrs.module.fhir2.api.FhirConceptService;\n+import org.openmrs.module.fhir2.api.FhirGlobalPropertyService;\n import org.openmrs.module.fhir2.api.dao.FhirAllergyIntoleranceDao;\n import org.springframework.stereotype.Component;\n \n @Component\n @Setter(AccessLevel.PACKAGE)\n-public class FhirAllergyIntoleranceDaoImpl implements FhirAllergyIntoleranceDao {\n+public class FhirAllergyIntoleranceDaoImpl extends BaseDaoImpl implements FhirAllergyIntoleranceDao {\n \t\n \t@Inject\n \t@Named(\"sessionFactory\")\n \tprivate SessionFactory sessionFactory;\n \t\n+\t@Inject\n+\tprivate FhirConceptService conceptService;\n+\t\n+\t@Inject\n+\tprivate FhirGlobalPropertyService globalPropertyService;\n+\t\n \t@Override\n \tpublic Allergy getAllergyIntoleranceByUuid(String uuid) {\n \t\treturn (Allergy) sessionFactory.getCurrentSession().createCriteria(Allergy.class).add(eq(\"uuid\", uuid))\n \t\t        .uniqueResult();\n \t}\n+\t\n+\t@Override\n+\tpublic Collection<Allergy> searchForAllergies(ReferenceParam patientReference, StringOrListParam category,\n+\t        TokenOrListParam allergen, TokenOrListParam severity, TokenOrListParam manifestationCode,\n+\t        StringOrListParam clinicalStatus) {\n+\t\tCriteria criteria = sessionFactory.getCurrentSession().createCriteria(Allergy.class);\n+\t\thandlePatientReference(criteria, patientReference, \"patient\");\n+\t\thandleAllergenCategory(\"allergen.allergenType\", category);\n+\t\thandleAllergen(criteria, allergen);\n+\t\thandleSeverity(criteria, severity).ifPresent(criteria::add);\n+\t\thandleManifestation(criteria, manifestationCode);\n+\t\thandleBoolean(\"voided\", createClinicalStatusToken(clinicalStatus));\n+\t\t\n+\t\treturn criteria.list();\n+\t}\n+\t\n+\tprivate void handleManifestation(Criteria criteria, TokenOrListParam manifestation) {\n+\t\tif (manifestation == null) {\n+\t\t\treturn;\n+\t\t}\n+\t\tcriteria.createAlias(\"reactions\", \"r\");\n+\t\tcriteria.createAlias(\"r.reaction\", \"c\");\n+\t\t\n+\t\thandleOrListParamBySystem(manifestation, (system, tokens) -> {\n+\t\t\tif (system.isEmpty()) {\n+\t\t\t\treturn Optional.of(in(\"c.uuid\", tokensToList(tokens)));\n+\t\t\t} else {\n+\t\t\t\tif (!containsAlias(criteria, \"rs\")) {\n+\t\t\t\t\tcriteria.createAlias(\"c.uuid\", \"rs\");", "originalCommit": "ef0c6b08f8dda46610f8f8582bc4ca20aeddbac7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2b3e281559fef9b6cc37eb6c6548bb32727f5f45", "chunk": "diff --git a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirAllergyIntoleranceDaoImpl.java b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirAllergyIntoleranceDaoImpl.java\nindex 62d590c2..d3ad30c2 100644\n--- a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirAllergyIntoleranceDaoImpl.java\n+++ b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirAllergyIntoleranceDaoImpl.java\n\n@@ -17,13 +17,16 @@ import javax.inject.Inject;\n import javax.inject.Named;\n \n import java.util.Collection;\n+import java.util.List;\n import java.util.Optional;\n+import java.util.stream.Collectors;\n \n import ca.uhn.fhir.rest.param.ReferenceParam;\n import ca.uhn.fhir.rest.param.StringOrListParam;\n import ca.uhn.fhir.rest.param.TokenOrListParam;\n import lombok.AccessLevel;\n import lombok.Setter;\n+import org.apache.commons.lang3.math.NumberUtils;\n import org.hibernate.Criteria;\n import org.hibernate.SessionFactory;\n import org.hibernate.criterion.Criterion;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzAxODQwOA==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/97#discussion_r387018408", "bodyText": "Please add a new line here", "author": "ibacher", "createdAt": "2020-03-03T13:30:01Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirAllergyIntoleranceDaoImpl.java", "diffHunk": "@@ -10,28 +10,181 @@\n package org.openmrs.module.fhir2.api.dao.impl;\n \n import static org.hibernate.criterion.Restrictions.eq;\n+import static org.hibernate.criterion.Restrictions.in;\n+import static org.hibernate.criterion.Restrictions.or;\n \n import javax.inject.Inject;\n import javax.inject.Named;\n \n+import java.util.Collection;\n+import java.util.Optional;\n+\n+import ca.uhn.fhir.rest.param.ReferenceParam;\n+import ca.uhn.fhir.rest.param.StringOrListParam;\n+import ca.uhn.fhir.rest.param.TokenOrListParam;\n import lombok.AccessLevel;\n import lombok.Setter;\n+import org.hibernate.Criteria;\n import org.hibernate.SessionFactory;\n+import org.hibernate.criterion.Criterion;\n+import org.hl7.fhir.exceptions.FHIRException;\n+import org.hl7.fhir.r4.model.AllergyIntolerance;\n+import org.openmrs.AllergenType;\n import org.openmrs.Allergy;\n+import org.openmrs.Concept;\n+import org.openmrs.module.fhir2.FhirConstants;\n+import org.openmrs.module.fhir2.api.FhirConceptService;\n+import org.openmrs.module.fhir2.api.FhirGlobalPropertyService;\n import org.openmrs.module.fhir2.api.dao.FhirAllergyIntoleranceDao;\n import org.springframework.stereotype.Component;\n \n @Component\n @Setter(AccessLevel.PACKAGE)\n-public class FhirAllergyIntoleranceDaoImpl implements FhirAllergyIntoleranceDao {\n+public class FhirAllergyIntoleranceDaoImpl extends BaseDaoImpl implements FhirAllergyIntoleranceDao {\n \t\n \t@Inject\n \t@Named(\"sessionFactory\")\n \tprivate SessionFactory sessionFactory;\n \t\n+\t@Inject\n+\tprivate FhirConceptService conceptService;\n+\t\n+\t@Inject\n+\tprivate FhirGlobalPropertyService globalPropertyService;\n+\t\n \t@Override\n \tpublic Allergy getAllergyIntoleranceByUuid(String uuid) {\n \t\treturn (Allergy) sessionFactory.getCurrentSession().createCriteria(Allergy.class).add(eq(\"uuid\", uuid))\n \t\t        .uniqueResult();\n \t}\n+\t\n+\t@Override\n+\tpublic Collection<Allergy> searchForAllergies(ReferenceParam patientReference, StringOrListParam category,\n+\t        TokenOrListParam allergen, TokenOrListParam severity, TokenOrListParam manifestationCode,\n+\t        StringOrListParam clinicalStatus) {\n+\t\tCriteria criteria = sessionFactory.getCurrentSession().createCriteria(Allergy.class);\n+\t\thandlePatientReference(criteria, patientReference, \"patient\");\n+\t\thandleAllergenCategory(\"allergen.allergenType\", category);\n+\t\thandleAllergen(criteria, allergen);\n+\t\thandleSeverity(criteria, severity).ifPresent(criteria::add);\n+\t\thandleManifestation(criteria, manifestationCode);\n+\t\thandleBoolean(\"voided\", createClinicalStatusToken(clinicalStatus));\n+\t\t\n+\t\treturn criteria.list();\n+\t}\n+\t\n+\tprivate void handleManifestation(Criteria criteria, TokenOrListParam manifestation) {\n+\t\tif (manifestation == null) {\n+\t\t\treturn;\n+\t\t}\n+\t\tcriteria.createAlias(\"reactions\", \"r\");\n+\t\tcriteria.createAlias(\"r.reaction\", \"c\");\n+\t\t\n+\t\thandleOrListParamBySystem(manifestation, (system, tokens) -> {\n+\t\t\tif (system.isEmpty()) {\n+\t\t\t\treturn Optional.of(in(\"c.uuid\", tokensToList(tokens)));\n+\t\t\t} else {\n+\t\t\t\tif (!containsAlias(criteria, \"rs\")) {\n+\t\t\t\t\tcriteria.createAlias(\"c.uuid\", \"rs\");\n+\t\t\t\t}\n+\t\t\t\t\n+\t\t\t\treturn Optional.of(or(eq(\"rs.name\", system), in(\"c.uuid\", tokensToList(tokens))));\n+\t\t\t}\n+\t\t}).ifPresent(criteria::add);\n+\t}\n+\t\n+\tprivate void handleAllergen(Criteria criteria, TokenOrListParam allergen) {\n+\t\tif (allergen == null) {\n+\t\t\treturn;\n+\t\t}\n+\t\t\n+\t\tcriteria.createAlias(\"allergen.codedAllergen\", \"c\");\n+\t\t\n+\t\thandleOrListParamBySystem(allergen, (system, tokens) -> {\n+\t\t\tif (system.isEmpty()) {\n+\t\t\t\treturn Optional.of(in(\"c.uuid\", tokensToList(tokens)));\n+\t\t\t} else {\n+\t\t\t\tif (!containsAlias(criteria, \"cs\")) {\n+\t\t\t\t\tcriteria.createAlias(\"c.uuid\", \"cs\");\n+\t\t\t\t}\n+\t\t\t\t\n+\t\t\t\treturn Optional.of(or(eq(\"cs.name\", system), in(\"c.uuid\", tokensToList(tokens))));\n+\t\t\t}\n+\t\t}).ifPresent(criteria::add);\n+\t}\n+\t\n+\tprivate Optional<Criterion> handleSeverity(Criteria criteria, TokenOrListParam severityParam) {\n+\t\tif (severityParam == null) {\n+\t\t\treturn Optional.empty();\n+\t\t}\n+\t\tcriteria.createAlias(\"severity\", \"c\");", "originalCommit": "ef0c6b08f8dda46610f8f8582bc4ca20aeddbac7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2b3e281559fef9b6cc37eb6c6548bb32727f5f45", "chunk": "diff --git a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirAllergyIntoleranceDaoImpl.java b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirAllergyIntoleranceDaoImpl.java\nindex 62d590c2..d3ad30c2 100644\n--- a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirAllergyIntoleranceDaoImpl.java\n+++ b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirAllergyIntoleranceDaoImpl.java\n\n@@ -17,13 +17,16 @@ import javax.inject.Inject;\n import javax.inject.Named;\n \n import java.util.Collection;\n+import java.util.List;\n import java.util.Optional;\n+import java.util.stream.Collectors;\n \n import ca.uhn.fhir.rest.param.ReferenceParam;\n import ca.uhn.fhir.rest.param.StringOrListParam;\n import ca.uhn.fhir.rest.param.TokenOrListParam;\n import lombok.AccessLevel;\n import lombok.Setter;\n+import org.apache.commons.lang3.math.NumberUtils;\n import org.hibernate.Criteria;\n import org.hibernate.SessionFactory;\n import org.hibernate.criterion.Criterion;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzAyNjA3Ng==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/97#discussion_r387026076", "bodyText": "This is a proper way to implement this; however, it is probably preferable to cache the values of the calls to getConceptId(globalPropertyService.getGlobalProperty(...)) outside of the lambda expression. something like this:\nfinal int mildConceptId = getConceptId(globalPropertyService.getGlobalProperty(FhirConstants.GLOBAL_PROPERTY_MILD));\n...\nreturn handleOrListParam(severityParam, token -> {\n    try {\n        AllergyIntolerance.AllergyIntoleranceSeverity severity = AllergyIntolerance.AllergyIntoleranceSeverity\n            .fromCode(token.getValue());\n        \n        switch(servity) {\n             case MILD:\n                 return Optional.of(eq(\"c.conceptId\", mildConceptId));\n             ...\n        }\n    }\n    ...\n});\nThinking about this some more, we should probably create a method on the globalPropertyService called getGlobalProperties(String... properties) that looks something like this:\npublic Collection<String> getGlobalProperties(String... properties) {\n    List<GlobalProperty> globalProperties = (GlobalProperty) sessionFactory.getCurrentSession()\n        .createCriteria(GlobalProperty.class).add(Restrictions.in(\"property\", properties)).list();\n    return globalProperties.stream().filter(p -> p != null).map(GlobalProperty::getPropertyValue).collect(Collectors.toList());\n}\nThen we can use this:\nfinal int[] severityConceptUuids = globalPropertyService.getGlobalProperties(FhirConstants.GLOBAL_PROPERTY_MILD, FhirConstants.GLOBAL_PROPERTY_MODERATE, FhirConstants.GLOBAL_PROPERTY_SEVERE, FhirConstants.GLOBAL_PROPERTY_OTHER);\n...\nreturn handleOrListParam(severityParam, token -> {\n    try {\n        AllergyIntolerance.AllergyIntoleranceSeverity severity = AllergyIntolerance.AllergyIntoleranceSeverity\n            .fromCode(token.getValue());\n        \n        switch(servity) {\n             case MILD:\n                 return Optional.of(eq(\"c.uuid\", severityConceptIds[0]));\n             ...\n        }\n    }\n    ...\n});", "author": "ibacher", "createdAt": "2020-03-03T13:43:24Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirAllergyIntoleranceDaoImpl.java", "diffHunk": "@@ -10,28 +10,181 @@\n package org.openmrs.module.fhir2.api.dao.impl;\n \n import static org.hibernate.criterion.Restrictions.eq;\n+import static org.hibernate.criterion.Restrictions.in;\n+import static org.hibernate.criterion.Restrictions.or;\n \n import javax.inject.Inject;\n import javax.inject.Named;\n \n+import java.util.Collection;\n+import java.util.Optional;\n+\n+import ca.uhn.fhir.rest.param.ReferenceParam;\n+import ca.uhn.fhir.rest.param.StringOrListParam;\n+import ca.uhn.fhir.rest.param.TokenOrListParam;\n import lombok.AccessLevel;\n import lombok.Setter;\n+import org.hibernate.Criteria;\n import org.hibernate.SessionFactory;\n+import org.hibernate.criterion.Criterion;\n+import org.hl7.fhir.exceptions.FHIRException;\n+import org.hl7.fhir.r4.model.AllergyIntolerance;\n+import org.openmrs.AllergenType;\n import org.openmrs.Allergy;\n+import org.openmrs.Concept;\n+import org.openmrs.module.fhir2.FhirConstants;\n+import org.openmrs.module.fhir2.api.FhirConceptService;\n+import org.openmrs.module.fhir2.api.FhirGlobalPropertyService;\n import org.openmrs.module.fhir2.api.dao.FhirAllergyIntoleranceDao;\n import org.springframework.stereotype.Component;\n \n @Component\n @Setter(AccessLevel.PACKAGE)\n-public class FhirAllergyIntoleranceDaoImpl implements FhirAllergyIntoleranceDao {\n+public class FhirAllergyIntoleranceDaoImpl extends BaseDaoImpl implements FhirAllergyIntoleranceDao {\n \t\n \t@Inject\n \t@Named(\"sessionFactory\")\n \tprivate SessionFactory sessionFactory;\n \t\n+\t@Inject\n+\tprivate FhirConceptService conceptService;\n+\t\n+\t@Inject\n+\tprivate FhirGlobalPropertyService globalPropertyService;\n+\t\n \t@Override\n \tpublic Allergy getAllergyIntoleranceByUuid(String uuid) {\n \t\treturn (Allergy) sessionFactory.getCurrentSession().createCriteria(Allergy.class).add(eq(\"uuid\", uuid))\n \t\t        .uniqueResult();\n \t}\n+\t\n+\t@Override\n+\tpublic Collection<Allergy> searchForAllergies(ReferenceParam patientReference, StringOrListParam category,\n+\t        TokenOrListParam allergen, TokenOrListParam severity, TokenOrListParam manifestationCode,\n+\t        StringOrListParam clinicalStatus) {\n+\t\tCriteria criteria = sessionFactory.getCurrentSession().createCriteria(Allergy.class);\n+\t\thandlePatientReference(criteria, patientReference, \"patient\");\n+\t\thandleAllergenCategory(\"allergen.allergenType\", category);\n+\t\thandleAllergen(criteria, allergen);\n+\t\thandleSeverity(criteria, severity).ifPresent(criteria::add);\n+\t\thandleManifestation(criteria, manifestationCode);\n+\t\thandleBoolean(\"voided\", createClinicalStatusToken(clinicalStatus));\n+\t\t\n+\t\treturn criteria.list();\n+\t}\n+\t\n+\tprivate void handleManifestation(Criteria criteria, TokenOrListParam manifestation) {\n+\t\tif (manifestation == null) {\n+\t\t\treturn;\n+\t\t}\n+\t\tcriteria.createAlias(\"reactions\", \"r\");\n+\t\tcriteria.createAlias(\"r.reaction\", \"c\");\n+\t\t\n+\t\thandleOrListParamBySystem(manifestation, (system, tokens) -> {\n+\t\t\tif (system.isEmpty()) {\n+\t\t\t\treturn Optional.of(in(\"c.uuid\", tokensToList(tokens)));\n+\t\t\t} else {\n+\t\t\t\tif (!containsAlias(criteria, \"rs\")) {\n+\t\t\t\t\tcriteria.createAlias(\"c.uuid\", \"rs\");\n+\t\t\t\t}\n+\t\t\t\t\n+\t\t\t\treturn Optional.of(or(eq(\"rs.name\", system), in(\"c.uuid\", tokensToList(tokens))));\n+\t\t\t}\n+\t\t}).ifPresent(criteria::add);\n+\t}\n+\t\n+\tprivate void handleAllergen(Criteria criteria, TokenOrListParam allergen) {\n+\t\tif (allergen == null) {\n+\t\t\treturn;\n+\t\t}\n+\t\t\n+\t\tcriteria.createAlias(\"allergen.codedAllergen\", \"c\");\n+\t\t\n+\t\thandleOrListParamBySystem(allergen, (system, tokens) -> {\n+\t\t\tif (system.isEmpty()) {\n+\t\t\t\treturn Optional.of(in(\"c.uuid\", tokensToList(tokens)));\n+\t\t\t} else {\n+\t\t\t\tif (!containsAlias(criteria, \"cs\")) {\n+\t\t\t\t\tcriteria.createAlias(\"c.uuid\", \"cs\");\n+\t\t\t\t}\n+\t\t\t\t\n+\t\t\t\treturn Optional.of(or(eq(\"cs.name\", system), in(\"c.uuid\", tokensToList(tokens))));\n+\t\t\t}\n+\t\t}).ifPresent(criteria::add);\n+\t}\n+\t\n+\tprivate Optional<Criterion> handleSeverity(Criteria criteria, TokenOrListParam severityParam) {\n+\t\tif (severityParam == null) {\n+\t\t\treturn Optional.empty();\n+\t\t}\n+\t\tcriteria.createAlias(\"severity\", \"c\");\n+\t\t\n+\t\treturn handleOrListParam(severityParam, token -> {", "originalCommit": "ef0c6b08f8dda46610f8f8582bc4ca20aeddbac7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2b3e281559fef9b6cc37eb6c6548bb32727f5f45", "chunk": "diff --git a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirAllergyIntoleranceDaoImpl.java b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirAllergyIntoleranceDaoImpl.java\nindex 62d590c2..d3ad30c2 100644\n--- a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirAllergyIntoleranceDaoImpl.java\n+++ b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirAllergyIntoleranceDaoImpl.java\n\n@@ -17,13 +17,16 @@ import javax.inject.Inject;\n import javax.inject.Named;\n \n import java.util.Collection;\n+import java.util.List;\n import java.util.Optional;\n+import java.util.stream.Collectors;\n \n import ca.uhn.fhir.rest.param.ReferenceParam;\n import ca.uhn.fhir.rest.param.StringOrListParam;\n import ca.uhn.fhir.rest.param.TokenOrListParam;\n import lombok.AccessLevel;\n import lombok.Setter;\n+import org.apache.commons.lang3.math.NumberUtils;\n import org.hibernate.Criteria;\n import org.hibernate.SessionFactory;\n import org.hibernate.criterion.Criterion;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzAyNjcxMQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/97#discussion_r387026711", "bodyText": "TokenOrListParam", "author": "ibacher", "createdAt": "2020-03-03T13:44:28Z", "path": "omod/src/main/java/org/openmrs/module/fhir2/providers/AllergyIntoleranceFhirResourceProvider.java", "diffHunk": "@@ -47,4 +55,19 @@ public AllergyIntolerance getAllergyIntoleranceByUuid(@IdParam @NotNull IdType i\n \t\t}\n \t\treturn allergy;\n \t}\n+\t\n+\t@Search\n+\t@SuppressWarnings(\"unused\")\n+\tpublic Bundle searchForAllergies(\n+\t        @OptionalParam(name = AllergyIntolerance.SP_PATIENT, chainWhitelist = { \"\", Patient.SP_IDENTIFIER,\n+\t                Patient.SP_GIVEN, Patient.SP_FAMILY,\n+\t                Patient.SP_NAME }, targetTypes = Patient.class) ReferenceParam patientReference,\n+\t        @OptionalParam(name = AllergyIntolerance.SP_CATEGORY) StringOrListParam category,", "originalCommit": "ef0c6b08f8dda46610f8f8582bc4ca20aeddbac7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2b3e281559fef9b6cc37eb6c6548bb32727f5f45", "chunk": "diff --git a/omod/src/main/java/org/openmrs/module/fhir2/providers/AllergyIntoleranceFhirResourceProvider.java b/omod/src/main/java/org/openmrs/module/fhir2/providers/AllergyIntoleranceFhirResourceProvider.java\nindex 513e1f52..0c77f416 100644\n--- a/omod/src/main/java/org/openmrs/module/fhir2/providers/AllergyIntoleranceFhirResourceProvider.java\n+++ b/omod/src/main/java/org/openmrs/module/fhir2/providers/AllergyIntoleranceFhirResourceProvider.java\n\n@@ -66,7 +66,7 @@ public class AllergyIntoleranceFhirResourceProvider implements IResourceProvider\n \t        @OptionalParam(name = AllergyIntolerance.SP_CODE) TokenOrListParam allergen,\n \t        @OptionalParam(name = AllergyIntolerance.SP_SEVERITY) TokenOrListParam severity,\n \t        @OptionalParam(name = AllergyIntolerance.SP_MANIFESTATION) TokenOrListParam manifestationCode,\n-\t        @OptionalParam(name = AllergyIntolerance.SP_CLINICAL_STATUS) StringOrListParam clinicalStatus) {\n+\t        @OptionalParam(name = AllergyIntolerance.SP_CLINICAL_STATUS) TokenOrListParam clinicalStatus) {\n \t\treturn FhirUtils.convertSearchResultsToBundle(fhirAllergyIntoleranceService.searchForAllergies(patientReference,\n \t\t    category, allergen, severity, manifestationCode, clinicalStatus));\n \t}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzAyNjgzNQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/97#discussion_r387026835", "bodyText": "TokenOrListParam", "author": "ibacher", "createdAt": "2020-03-03T13:44:40Z", "path": "omod/src/main/java/org/openmrs/module/fhir2/providers/AllergyIntoleranceFhirResourceProvider.java", "diffHunk": "@@ -47,4 +55,19 @@ public AllergyIntolerance getAllergyIntoleranceByUuid(@IdParam @NotNull IdType i\n \t\t}\n \t\treturn allergy;\n \t}\n+\t\n+\t@Search\n+\t@SuppressWarnings(\"unused\")\n+\tpublic Bundle searchForAllergies(\n+\t        @OptionalParam(name = AllergyIntolerance.SP_PATIENT, chainWhitelist = { \"\", Patient.SP_IDENTIFIER,\n+\t                Patient.SP_GIVEN, Patient.SP_FAMILY,\n+\t                Patient.SP_NAME }, targetTypes = Patient.class) ReferenceParam patientReference,\n+\t        @OptionalParam(name = AllergyIntolerance.SP_CATEGORY) StringOrListParam category,\n+\t        @OptionalParam(name = AllergyIntolerance.SP_CODE) TokenOrListParam allergen,\n+\t        @OptionalParam(name = AllergyIntolerance.SP_SEVERITY) TokenOrListParam severity,\n+\t        @OptionalParam(name = AllergyIntolerance.SP_MANIFESTATION) TokenOrListParam manifestationCode,\n+\t        @OptionalParam(name = AllergyIntolerance.SP_CLINICAL_STATUS) StringOrListParam clinicalStatus) {", "originalCommit": "ef0c6b08f8dda46610f8f8582bc4ca20aeddbac7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2b3e281559fef9b6cc37eb6c6548bb32727f5f45", "chunk": "diff --git a/omod/src/main/java/org/openmrs/module/fhir2/providers/AllergyIntoleranceFhirResourceProvider.java b/omod/src/main/java/org/openmrs/module/fhir2/providers/AllergyIntoleranceFhirResourceProvider.java\nindex 513e1f52..0c77f416 100644\n--- a/omod/src/main/java/org/openmrs/module/fhir2/providers/AllergyIntoleranceFhirResourceProvider.java\n+++ b/omod/src/main/java/org/openmrs/module/fhir2/providers/AllergyIntoleranceFhirResourceProvider.java\n\n@@ -66,7 +66,7 @@ public class AllergyIntoleranceFhirResourceProvider implements IResourceProvider\n \t        @OptionalParam(name = AllergyIntolerance.SP_CODE) TokenOrListParam allergen,\n \t        @OptionalParam(name = AllergyIntolerance.SP_SEVERITY) TokenOrListParam severity,\n \t        @OptionalParam(name = AllergyIntolerance.SP_MANIFESTATION) TokenOrListParam manifestationCode,\n-\t        @OptionalParam(name = AllergyIntolerance.SP_CLINICAL_STATUS) StringOrListParam clinicalStatus) {\n+\t        @OptionalParam(name = AllergyIntolerance.SP_CLINICAL_STATUS) TokenOrListParam clinicalStatus) {\n \t\treturn FhirUtils.convertSearchResultsToBundle(fhirAllergyIntoleranceService.searchForAllergies(patientReference,\n \t\t    category, allergen, severity, manifestationCode, clinicalStatus));\n \t}\n"}}, {"oid": "2b3e281559fef9b6cc37eb6c6548bb32727f5f45", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/2b3e281559fef9b6cc37eb6c6548bb32727f5f45", "message": "FM2-83 : Create appropriate search functionality for allergy intolerance resource", "committedDate": "2020-03-04T10:14:37Z", "type": "forcePushed"}, {"oid": "b6316843cee11580d9bf4dea7c0d7880730c56a9", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/b6316843cee11580d9bf4dea7c0d7880730c56a9", "message": "FM2-83 : Create appropriate search functionality for allergy intolerance resource", "committedDate": "2020-03-04T10:15:36Z", "type": "forcePushed"}, {"oid": "5e443236a9884bdadb4794a9f312cfa2e55ea5cf", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/5e443236a9884bdadb4794a9f312cfa2e55ea5cf", "message": "FM2-83 : Create appropriate search functionality for allergy intolerance resource", "committedDate": "2020-03-04T10:47:06Z", "type": "forcePushed"}, {"oid": "cad1a96f66c7fdccf2dd75390e99ab2dd9b11567", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/cad1a96f66c7fdccf2dd75390e99ab2dd9b11567", "message": "FM2-83 : Create appropriate search functionality for allergy intolerance resource", "committedDate": "2020-03-04T16:59:42Z", "type": "forcePushed"}, {"oid": "3021c1b610081db187837ea5aa9ac5bf53424f29", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/3021c1b610081db187837ea5aa9ac5bf53424f29", "message": "FM2-83 : Create appropriate search functionality for allergy intolerance resource", "committedDate": "2020-03-09T06:14:01Z", "type": "forcePushed"}, {"oid": "db66eec0bbcdf7f85a557ff5ab5de4b948f30b97", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/db66eec0bbcdf7f85a557ff5ab5de4b948f30b97", "message": "FM2-83 : Create appropriate search functionality for allergy intolerance resource", "committedDate": "2020-03-09T06:16:52Z", "type": "commit"}, {"oid": "db66eec0bbcdf7f85a557ff5ab5de4b948f30b97", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/db66eec0bbcdf7f85a557ff5ab5de4b948f30b97", "message": "FM2-83 : Create appropriate search functionality for allergy intolerance resource", "committedDate": "2020-03-09T06:16:52Z", "type": "forcePushed"}]}