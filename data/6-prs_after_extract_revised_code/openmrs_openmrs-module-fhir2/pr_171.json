{"pr_number": 171, "pr_title": "FM2-164: Update Patient resource to support paging", "pr_createdAt": "2020-05-13T10:15:04Z", "pr_url": "https://github.com/openmrs/openmrs-module-fhir2/pull/171", "timeline": [{"oid": "0e8fbad565ae577f4ac060cfaf8ebe611cba5d90", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/0e8fbad565ae577f4ac060cfaf8ebe611cba5d90", "message": "Update Patient resource to support paging", "committedDate": "2020-05-13T13:03:53Z", "type": "forcePushed"}, {"oid": "425dd0750bbe35eda3519f9b3ebb31f190972178", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/425dd0750bbe35eda3519f9b3ebb31f190972178", "message": "Update Patient resource to support paging", "committedDate": "2020-05-18T11:10:06Z", "type": "forcePushed"}, {"oid": "da4dc9ea45d292ac2b90c0eb5d5d455a6448bebe", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/da4dc9ea45d292ac2b90c0eb5d5d455a6448bebe", "message": "FM2-164: Update patient resource to support paging", "committedDate": "2020-05-19T07:11:00Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ5NTczMw==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/171#discussion_r427495733", "bodyText": "Do we need AtomicReferences here?", "author": "ibacher", "createdAt": "2020-05-19T18:00:31Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirPatientDaoImpl.java", "diffHunk": "@@ -104,4 +115,52 @@ protected String paramToProp(String param) {\n \t\t\n \t\treturn super.paramToProp(param);\n \t}\n+\t\n+\tprivate void handleNames(List<PropParam<?>> params, Criteria criteria) {\n+\t\tAtomicReference<StringAndListParam> name = new AtomicReference<>();", "originalCommit": "da4dc9ea45d292ac2b90c0eb5d5d455a6448bebe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzc1OTA3NA==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/171#discussion_r427759074", "bodyText": "Not necessarily, I used it to avoid duplicate alias. That was the first thing I thought of but I think there's a better of handling this.\nThe goal here is to call handleNames(criteria, name, given, family) once in a query to avoid duplicate alias. Alternative is to call it multiple times with different alias each the method is called. Didn't like the query generated. I chose the first option of storing passed in values temporarily.", "author": "corneliouzbett", "createdAt": "2020-05-20T05:59:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ5NTczMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODAyNzc4Mw==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/171#discussion_r428027783", "bodyText": "Doesn't it just make sense to avoid the using the lambdas altogether:\nprivate void handleNames(List<PropParam<?>> params, Criteria criteria) {\n\tStringAndListParam name = null;\n\tStringAndListParam given = null;\n\tStringAndListParam family = null;\n\n\tfor (PropParam<?> param : params) {\n\t\tswitch (param.getPropertyName()) {\n\t\t\tcase FhirConstants.NAME_PROPERTY:\n\t\t\t\tname = (StringAndListParam) param.getParam();\n\t\t\t\tbreak;\n\t\t\tcase FhirConstants.GIVEN_PROPERTY:\n\t\t\t\tgiven = (StringAndListParam) param.getParam();\n\t\t\t\tbreak;\n\t\t\tcase FhirConstants.FAMILY_PROPERTY:\n\t\t\t\tfamily = (StringAndListParam) param.getParam();\n\t\t\t\tbreak;\n\t\t}\n\t}\n\n\thandleNames(criteria, name, given, family);\n}\nThe for loop is actually marginally more performant and I just don't see the value-added to using the .forEach() function here.", "author": "ibacher", "createdAt": "2020-05-20T13:50:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ5NTczMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODA4OTc2NA==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/171#discussion_r428089764", "bodyText": "That make sense \u263a\ufe0f", "author": "corneliouzbett", "createdAt": "2020-05-20T15:08:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ5NTczMw=="}], "type": "inlineReview", "revised_code": {"commit": "f2de48a0de038b6cb739fa0b7808e0681809ef30", "chunk": "diff --git a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirPatientDaoImpl.java b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirPatientDaoImpl.java\nindex 51fe2978..d2c434a8 100644\n--- a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirPatientDaoImpl.java\n+++ b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirPatientDaoImpl.java\n\n@@ -117,48 +116,49 @@ public class FhirPatientDaoImpl extends BasePersonDao<Patient> implements FhirPa\n \t}\n \t\n \tprivate void handleNames(List<PropParam<?>> params, Criteria criteria) {\n-\t\tAtomicReference<StringAndListParam> name = new AtomicReference<>();\n-\t\tAtomicReference<StringAndListParam> given = new AtomicReference<>();\n-\t\tAtomicReference<StringAndListParam> family = new AtomicReference<>();\n-\t\tparams.forEach(param -> {\n+\t\tStringAndListParam name = null;\n+\t\tStringAndListParam given = null;\n+\t\tStringAndListParam family = null;\n+\t\tfor (PropParam<?> param : params) {\n \t\t\tswitch (param.getPropertyName()) {\n \t\t\t\tcase FhirConstants.NAME_PROPERTY:\n-\t\t\t\t\tname.set((StringAndListParam) param.getParam());\n+\t\t\t\t\tname = (StringAndListParam) param.getParam();\n \t\t\t\t\tbreak;\n \t\t\t\tcase FhirConstants.GIVEN_PROPERTY:\n-\t\t\t\t\tgiven.set((StringAndListParam) param.getParam());\n+\t\t\t\t\tgiven = (StringAndListParam) param.getParam();\n \t\t\t\t\tbreak;\n \t\t\t\tcase FhirConstants.FAMILY_PROPERTY:\n-\t\t\t\t\tfamily.set((StringAndListParam) param.getParam());\n+\t\t\t\t\tfamily = (StringAndListParam) param.getParam();\n \t\t\t\t\tbreak;\n \t\t\t}\n-\t\t});\n-\t\thandleNames(criteria, name.get(), given.get(), family.get());\n+\t\t}\n+\t\t\n+\t\thandleNames(criteria, name, given, family);\n \t}\n \t\n \tprivate void handleAddresses(Criteria criteria, Map.Entry<String, List<PropParam<?>>> entry) {\n-\t\tAtomicReference<StringAndListParam> city = new AtomicReference<>();\n-\t\tAtomicReference<StringAndListParam> country = new AtomicReference<>();\n-\t\tAtomicReference<StringAndListParam> postalCode = new AtomicReference<>();\n-\t\tAtomicReference<StringAndListParam> state = new AtomicReference<>();\n-\t\tentry.getValue().forEach(d -> {\n-\t\t\tswitch (d.getPropertyName()) {\n+\t\tStringAndListParam city = null;\n+\t\tStringAndListParam country = null;\n+\t\tStringAndListParam postalCode = null;\n+\t\tStringAndListParam state = null;\n+\t\tfor (PropParam<?> param : entry.getValue()) {\n+\t\t\tswitch (param.getPropertyName()) {\n \t\t\t\tcase FhirConstants.CITY_PROPERTY:\n-\t\t\t\t\tcity.set((StringAndListParam) d.getParam());\n+\t\t\t\t\tcity = ((StringAndListParam) param.getParam());\n \t\t\t\t\tbreak;\n \t\t\t\tcase FhirConstants.COUNTRY_PROPERTY:\n-\t\t\t\t\tcountry.set((StringAndListParam) d.getParam());\n+\t\t\t\t\tcountry = ((StringAndListParam) param.getParam());\n \t\t\t\t\tbreak;\n \t\t\t\tcase FhirConstants.POSTAL_CODE_PROPERTY:\n-\t\t\t\t\tpostalCode.set((StringAndListParam) d.getParam());\n+\t\t\t\t\tpostalCode = ((StringAndListParam) param.getParam());\n \t\t\t\t\tbreak;\n \t\t\t\tcase FhirConstants.STATE_PROPERTY:\n-\t\t\t\t\tstate.set((StringAndListParam) d.getParam());\n+\t\t\t\t\tstate = ((StringAndListParam) param.getParam());\n \t\t\t\t\tbreak;\n \t\t\t}\n-\t\t});\n+\t\t}\n \t\t\n-\t\thandlePersonAddress(\"pad\", city.get(), state.get(), postalCode.get(), country.get()).ifPresent(c -> {\n+\t\thandlePersonAddress(\"pad\", city, state, postalCode, country).ifPresent(c -> {\n \t\t\tcriteria.createAlias(\"addresses\", \"pad\");\n \t\t\tcriteria.add(c);\n \t\t});\n"}}, {"oid": "f2de48a0de038b6cb739fa0b7808e0681809ef30", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/f2de48a0de038b6cb739fa0b7808e0681809ef30", "message": "FM2-164: Update patient resource to support paging", "committedDate": "2020-05-20T15:26:56Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTI5NTgyOA==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/171#discussion_r429295828", "bodyText": "Really minor point, but could we order these city, state, postal code, property (that's roughly ascending order of size (except that postal code probably belong at the front of the list) just to keep things consistent (my main hang-up is making sure \"state\" is before \"country\" since it isn't always obvious to people that \"state\" means state in the sense of \"US state\" or \"Australian state\" rather than \"country\").", "author": "ibacher", "createdAt": "2020-05-22T14:54:42Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirPatientDaoImpl.java", "diffHunk": "@@ -104,4 +114,53 @@ protected String paramToProp(String param) {\n \t\t\n \t\treturn super.paramToProp(param);\n \t}\n+\t\n+\tprivate void handleNames(List<PropParam<?>> params, Criteria criteria) {\n+\t\tStringAndListParam name = null;\n+\t\tStringAndListParam given = null;\n+\t\tStringAndListParam family = null;\n+\t\tfor (PropParam<?> param : params) {\n+\t\t\tswitch (param.getPropertyName()) {\n+\t\t\t\tcase FhirConstants.NAME_PROPERTY:\n+\t\t\t\t\tname = (StringAndListParam) param.getParam();\n+\t\t\t\t\tbreak;\n+\t\t\t\tcase FhirConstants.GIVEN_PROPERTY:\n+\t\t\t\t\tgiven = (StringAndListParam) param.getParam();\n+\t\t\t\t\tbreak;\n+\t\t\t\tcase FhirConstants.FAMILY_PROPERTY:\n+\t\t\t\t\tfamily = (StringAndListParam) param.getParam();\n+\t\t\t\t\tbreak;\n+\t\t\t}\n+\t\t}\n+\t\t\n+\t\thandleNames(criteria, name, given, family);\n+\t}\n+\t\n+\tprivate void handleAddresses(Criteria criteria, Map.Entry<String, List<PropParam<?>>> entry) {\n+\t\tStringAndListParam city = null;\n+\t\tStringAndListParam country = null;\n+\t\tStringAndListParam postalCode = null;\n+\t\tStringAndListParam state = null;\n+\t\tfor (PropParam<?> param : entry.getValue()) {\n+\t\t\tswitch (param.getPropertyName()) {\n+\t\t\t\tcase FhirConstants.CITY_PROPERTY:\n+\t\t\t\t\tcity = ((StringAndListParam) param.getParam());\n+\t\t\t\t\tbreak;\n+\t\t\t\tcase FhirConstants.COUNTRY_PROPERTY:\n+\t\t\t\t\tcountry = ((StringAndListParam) param.getParam());\n+\t\t\t\t\tbreak;\n+\t\t\t\tcase FhirConstants.POSTAL_CODE_PROPERTY:\n+\t\t\t\t\tpostalCode = ((StringAndListParam) param.getParam());\n+\t\t\t\t\tbreak;\n+\t\t\t\tcase FhirConstants.STATE_PROPERTY:\n+\t\t\t\t\tstate = ((StringAndListParam) param.getParam());\n+\t\t\t\t\tbreak;", "originalCommit": "f2de48a0de038b6cb739fa0b7808e0681809ef30", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2114adfe88a71f902554867ac75f45f031d93367", "chunk": "diff --git a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirPatientDaoImpl.java b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirPatientDaoImpl.java\nindex d2c434a8..199d8046 100644\n--- a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirPatientDaoImpl.java\n+++ b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirPatientDaoImpl.java\n\n@@ -146,14 +140,14 @@ public class FhirPatientDaoImpl extends BasePersonDao<Patient> implements FhirPa\n \t\t\t\tcase FhirConstants.CITY_PROPERTY:\n \t\t\t\t\tcity = ((StringAndListParam) param.getParam());\n \t\t\t\t\tbreak;\n-\t\t\t\tcase FhirConstants.COUNTRY_PROPERTY:\n-\t\t\t\t\tcountry = ((StringAndListParam) param.getParam());\n+\t\t\t\tcase FhirConstants.STATE_PROPERTY:\n+\t\t\t\t\tstate = ((StringAndListParam) param.getParam());\n \t\t\t\t\tbreak;\n \t\t\t\tcase FhirConstants.POSTAL_CODE_PROPERTY:\n \t\t\t\t\tpostalCode = ((StringAndListParam) param.getParam());\n \t\t\t\t\tbreak;\n-\t\t\t\tcase FhirConstants.STATE_PROPERTY:\n-\t\t\t\t\tstate = ((StringAndListParam) param.getParam());\n+\t\t\t\tcase FhirConstants.COUNTRY_PROPERTY:\n+\t\t\t\t\tcountry = ((StringAndListParam) param.getParam());\n \t\t\t\t\tbreak;\n \t\t\t}\n \t\t}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTI5Njc3Nw==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/171#discussion_r429296777", "bodyText": "I would probably prefer caching the call of results.getResources(0, 1) and reusing that as each time we invoke that, it makes a query to the database and, while it's not a huge deal, I'd like to keep the unit tests as quick as possible so people continue to want to run them.", "author": "ibacher", "createdAt": "2020-05-22T14:56:22Z", "path": "omod/src/test/java/org/openmrs/module/fhir2/providers/PatientFhirResourceProviderTest.java", "diffHunk": "@@ -303,14 +316,15 @@ public void searchForPatients_shouldReturnMatchingBundleOfPatientsByCountry() {\n \t\t        .addAnd(new StringOrListParam().add(new StringParam(COUNTRY)));\n \t\twhen(patientService.searchForPatients(isNull(), isNull(), isNull(), isNull(), isNull(), isNull(), isNull(), isNull(),\n \t\t    isNull(), isNull(), isNull(), argThat(is(countryParam)), isNull()))\n-\t\t            .thenReturn(Collections.singletonList(patient));\n+\t\t            .thenReturn(new BaseFhirIBundleResourceProviderTest<>(Collections.singletonList(patient), 10, 1));\n \t\t\n-\t\tBundle results = resourceProvider.searchPatients(null, null, null, null, null, null, null, null, null, null, null,\n-\t\t    countryParam, null);\n+\t\tIBundleProvider results = resourceProvider.searchPatients(null, null, null, null, null, null, null, null, null, null,\n+\t\t    null, countryParam, null);\n \t\t\n \t\tassertThat(results, notNullValue());\n-\t\tassertThat(results.isResource(), is(true));\n-\t\tassertThat(results.getEntry().size(), greaterThanOrEqualTo(1));\n+\t\tassertThat(results.getResources(0, 1), hasSize(equalTo(1)));\n+\t\tassertThat(results.getResources(0, 1).get(0).fhirType(), is(\"Patient\"));\n+\t\tassertThat(results.getResources(0, 1).get(0).getIdElement().getIdPart(), is(PATIENT_UUID));", "originalCommit": "f2de48a0de038b6cb739fa0b7808e0681809ef30", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2114adfe88a71f902554867ac75f45f031d93367", "chunk": "diff --git a/omod/src/test/java/org/openmrs/module/fhir2/providers/PatientFhirResourceProviderTest.java b/api/src/test/java/org/openmrs/module/fhir2/providers/r4/PatientFhirResourceProviderTest.java\nsimilarity index 77%\nrename from omod/src/test/java/org/openmrs/module/fhir2/providers/PatientFhirResourceProviderTest.java\nrename to api/src/test/java/org/openmrs/module/fhir2/providers/r4/PatientFhirResourceProviderTest.java\nindex ae8d9397..51c56c82 100644\n--- a/omod/src/test/java/org/openmrs/module/fhir2/providers/PatientFhirResourceProviderTest.java\n+++ b/api/src/test/java/org/openmrs/module/fhir2/providers/r4/PatientFhirResourceProviderTest.java\n\n@@ -320,18 +333,19 @@ public class PatientFhirResourceProviderTest extends BaseFhirProvenanceResourceT\n \t\t\n \t\tIBundleProvider results = resourceProvider.searchPatients(null, null, null, null, null, null, null, null, null, null,\n \t\t    null, countryParam, null);\n+\t\tList<IBaseResource> resources = getResources(results);\n \t\t\n-\t\tassertThat(results, notNullValue());\n-\t\tassertThat(results.getResources(0, 1), hasSize(equalTo(1)));\n-\t\tassertThat(results.getResources(0, 1).get(0).fhirType(), is(\"Patient\"));\n-\t\tassertThat(results.getResources(0, 1).get(0).getIdElement().getIdPart(), is(PATIENT_UUID));\n+\t\tassertThat(resources, notNullValue());\n+\t\tassertThat(resources, hasSize(equalTo(1)));\n+\t\tassertThat(resources.get(0).fhirType(), is(\"Patient\"));\n+\t\tassertThat(resources.get(0).getIdElement().getIdPart(), is(PATIENT_UUID));\n \t}\n \t\n \t@Test\n \tpublic void getPatientResourceHistory_shouldReturnListOfResource() {\n \t\tIdType id = new IdType();\n \t\tid.setValue(PATIENT_UUID);\n-\t\twhen(patientService.getPatientByUuid(PATIENT_UUID)).thenReturn(patient);\n+\t\twhen(patientService.get(PATIENT_UUID)).thenReturn(patient);\n \t\t\n \t\tList<Resource> resources = resourceProvider.getPatientResourceHistory(id);\n \t\tassertThat(resources, notNullValue());\n"}}, {"oid": "2114adfe88a71f902554867ac75f45f031d93367", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/2114adfe88a71f902554867ac75f45f031d93367", "message": "FM2-164: Update patient resource to support paging", "committedDate": "2020-05-26T09:59:49Z", "type": "commit"}, {"oid": "2114adfe88a71f902554867ac75f45f031d93367", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/2114adfe88a71f902554867ac75f45f031d93367", "message": "FM2-164: Update patient resource to support paging", "committedDate": "2020-05-26T09:59:49Z", "type": "forcePushed"}, {"oid": "468b1a07569217e67107d96b26bc2dc6eb50d77d", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/468b1a07569217e67107d96b26bc2dc6eb50d77d", "message": "Merge branch 'master' into FM2-164", "committedDate": "2020-05-26T16:32:19Z", "type": "commit"}]}