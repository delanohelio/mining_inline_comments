{"pr_number": 98, "pr_title": "FM2-80: Improve Search for Location Resource", "pr_createdAt": "2020-03-01T17:45:46Z", "pr_url": "https://github.com/openmrs/openmrs-module-fhir2/pull/98", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjM3MjE4OA==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/98#discussion_r386372188", "bodyText": "Remove these changes from this commit.", "author": "corneliouzbett", "createdAt": "2020-03-02T12:48:14Z", "path": "api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImplTest.java", "diffHunk": "@@ -36,166 +43,258 @@\n \n @ContextConfiguration(classes = TestFhirSpringConfiguration.class, inheritLocations = false)\n public class FhirLocationDaoImplTest extends BaseModuleContextSensitiveTest {\n-\t\n+\n \tprivate static final String LOCATION_UUID = \"c0938432-1691-11df-97a5-7038c432aaba\";\n-\t\n+\n \tprivate static final String UNKNOWN_LOCATION_UUID = \"c0938432-1691-11df-97a5-7038c432aabz\";\n-\t\n-\tprivate static final String LOCATION_NAME = \"Test location 1\";\n-\t\n+\n+\tprivate static final String LOCATION_NAME = \"Test location 7\";\n+\n \tprivate static final String UNKNOWN_LOCATION_NAME = \"Location2\";\n-\t\n+\n \tprivate static final String LOCATION_CITY = \"Artuor\";\n-\t\n+\n \tprivate static final String UNKNOWN_LOCATION_CITY = \"ArtuorA\";\n-\t\n+\n \tprivate static final String LOCATION_COUNTRY = \"Kenya\";\n-\t\n+\n \tprivate static final String UNKNOWN_LOCATION_COUNTRY = \"KenyaA\";\n-\t\n+\n \tprivate static final String POSTAL_CODE = \"4069-3100\";\n-\t\n+\n \tprivate static final String UNKNOWN_POSTAL_CODE = \"4015-3100\";\n-\t\n+\n \tprivate static final String LOCATION_STATE = \"province\";\n-\t\n+\n \tprivate static final String UNKNOWN_LOCATION_STATE = \"province state\";\n-\t", "originalCommit": "761142c8267328eab6da66ef89fad0d86fe82e23", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjM3NTE1NQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/98#discussion_r386375155", "bodyText": "mvn clean install or mvn package before pushing your changes", "author": "corneliouzbett", "createdAt": "2020-03-02T12:54:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjM3MjE4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjU4MDU2Nw==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/98#discussion_r386580567", "bodyText": "Done", "author": "varung-31", "createdAt": "2020-03-02T18:49:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjM3MjE4OA=="}], "type": "inlineReview", "revised_code": {"commit": "7187751292ff0c39a9a454e7ce9564acbff0b918", "chunk": "diff --git a/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImplTest.java b/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImplTest.java\nindex 7da6615c..a194241f 100644\n--- a/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImplTest.java\n+++ b/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImplTest.java\n\n@@ -43,51 +44,51 @@ import org.springframework.test.context.ContextConfiguration;\n \n @ContextConfiguration(classes = TestFhirSpringConfiguration.class, inheritLocations = false)\n public class FhirLocationDaoImplTest extends BaseModuleContextSensitiveTest {\n-\n+\t\n \tprivate static final String LOCATION_UUID = \"c0938432-1691-11df-97a5-7038c432aaba\";\n-\n+\t\n \tprivate static final String UNKNOWN_LOCATION_UUID = \"c0938432-1691-11df-97a5-7038c432aabz\";\n-\n+\t\n \tprivate static final String LOCATION_NAME = \"Test location 7\";\n-\n+\t\n \tprivate static final String UNKNOWN_LOCATION_NAME = \"Location2\";\n-\n+\t\n \tprivate static final String LOCATION_CITY = \"Artuor\";\n-\n+\t\n \tprivate static final String UNKNOWN_LOCATION_CITY = \"ArtuorA\";\n-\n+\t\n \tprivate static final String LOCATION_COUNTRY = \"Kenya\";\n-\n+\t\n \tprivate static final String UNKNOWN_LOCATION_COUNTRY = \"KenyaA\";\n-\n+\t\n \tprivate static final String POSTAL_CODE = \"4069-3100\";\n-\n+\t\n \tprivate static final String UNKNOWN_POSTAL_CODE = \"4015-3100\";\n-\n+\t\n \tprivate static final String LOCATION_STATE = \"province\";\n-\n+\t\n \tprivate static final String UNKNOWN_LOCATION_STATE = \"province state\";\n-\n+\t\n \tprivate static final String LOGIN_LOCATION_TAG_NAME = \"login\";\n-\n+\t\n \tprivate static final String LOCATION_PARENT_NAME = \"Test location 1\";\n-\n+\t\n \tprivate static final String UNKNOWN_LOCATION_PARENT_NAME = \"Test location 10\";\n-\n+\t\n \tprivate static final String LOCATION_ATTRIBUTE_TYPE_UUID = \"abcde432-1691-11df-97a5-7038c432abcd\";\n-\n+\t\n \tprivate static final String LOCATION_INITIAL_DATA_XML = \"org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImplTest_initial_data.xml\";\n-\n+\t\n \tprivate FhirLocationDaoImpl fhirLocationDao;\n-\n+\t\n \t@Inject\n \t@Named(\"locationService\")\n \tprivate Provider<LocationService> locationServiceProvider;\n-\n+\t\n \t@Inject\n \t@Named(\"sessionFactory\")\n \tprivate Provider<SessionFactory> sessionFactoryProvider;\n-\n+\t\n \t@Before\n \tpublic void setup() throws Exception {\n \t\tfhirLocationDao = new FhirLocationDaoImpl();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjQwMTc4Mw==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/98#discussion_r386401783", "bodyText": "Please refer to this comment on implementing sorting on other parameters.", "author": "CaptainDaVinci", "createdAt": "2020-03-02T13:48:48Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImpl.java", "diffHunk": "@@ -30,49 +39,99 @@\n \n @Component\n @Setter(AccessLevel.PACKAGE)\n-public class FhirLocationDaoImpl implements FhirLocationDao {\n-\t\n+public class FhirLocationDaoImpl extends BaseDaoImpl implements FhirLocationDao {\n+\n \t@Inject\n \tLocationService locationService;\n-\t\n+\n \t@Inject\n \t@Named(\"sessionFactory\")\n \tSessionFactory sessionFactory;\n-\t\n+\n \t@Override\n \tpublic Location getLocationByUuid(String uuid) {\n \t\treturn locationService.getLocationByUuid(uuid);\n \t}\n-\t\n-\t@Override\n-\tpublic Collection<Location> findLocationByName(String name) {\n-\t\treturn locationService.getLocations(name);\n+\n+\tprivate void handleName(Criteria criteria, StringParam namePattern) {\n+\t\tif(namePattern != null) {\n+\t\t\tpropertyLike(\"name\", namePattern).ifPresent(criteria::add);\n+\t\t}\n \t}\n-\t\n-\t@Override\n-\tpublic Collection<Location> findLocationsByCity(String city) {\n-\t\treturn sessionFactory.getCurrentSession().createCriteria(Location.class).add(eq(\"cityVillage\", city)).list();\n+\n+\tprivate void handleCity(Criteria criteria, StringParam city) {\n+\t\tif(city != null) {\n+\t\t\tpropertyLike(\"cityVillage\", city).ifPresent(criteria::add);\n+\t\t}\n \t}\n-\t\n-\t@Override\n-\tpublic Collection<Location> findLocationsByCountry(String country) {\n-\t\treturn sessionFactory.getCurrentSession().createCriteria(Location.class).add(eq(\"country\", country)).list();\n+\n+\tprivate void handleCountry(Criteria criteria, StringParam country) {\n+\t\tif(country != null) {\n+\t\t\tpropertyLike(\"country\", country).ifPresent(criteria::add);\n+\t\t}\n \t}\n-\t\n-\t@Override\n-\tpublic Collection<Location> findLocationsByPostalCode(String postalCode) {\n-\t\treturn sessionFactory.getCurrentSession().createCriteria(Location.class).add(eq(\"postalCode\", postalCode)).list();\n+\n+\tprivate void handlePostalCode(Criteria criteria, StringParam postalCode) {\n+\t\tif(postalCode != null) {\n+\t\t\tpropertyLike(\"postalCode\", postalCode).ifPresent(criteria::add);\n+\t\t}\n \t}\n-\t\n+\n+\tprivate void handleState(Criteria criteria, StringParam state) {\n+\t\tif(state != null) {\n+\t\t\tpropertyLike(\"stateProvince\", state).ifPresent(criteria::add);\n+\t\t}\n+\t}\n+\n+\tprivate void handleTag(Criteria criteria, TokenParam tag) {\n+\t\tif(tag != null) {\n+\t\t\tcriteria.createAlias(\"tags\", \"t\");\n+\t\t\tpropertyLike(\"t.name\", tag).ifPresent(criteria::add);\n+\t\t}\n+\t}\n+\n+\t// handle queries of the form /Location?partof=parent_name\n+\tprivate void handleParentLocation(Criteria criteria, StringParam parent) {\n+\t\tif (parent != null) {\n+\t\t\tProjectionList projList = Projections.projectionList();\n+\t\t\tprojList.add(Projections.property(\"locationId\"));\n+\n+\t\t\tCriteria criteriaForParent = this.sessionFactory.getCurrentSession().createCriteria(Location.class);\n+\t\t\tpropertyLike(\"name\", parent).ifPresent(criteriaForParent::add);\n+\n+\t\t\tSet<Object> possibleParentLocationIdList = new HashSet<>(criteriaForParent.setProjection(projList).list());\n+\n+\t\t\tcriteria.createCriteria(\"parentLocation\").add(in(\"locationId\", possibleParentLocationIdList));\n+\t\t}\n+\t}\n+\n \t@Override\n-\tpublic Collection<Location> findLocationsByState(String state) {\n-\t\treturn sessionFactory.getCurrentSession().createCriteria(Location.class).add(eq(\"stateProvince\", state)).list();\n+\tprotected String paramToProp(@NotNull String paramName) {", "originalCommit": "761142c8267328eab6da66ef89fad0d86fe82e23", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjU1NjMwOA==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/98#discussion_r386556308", "bodyText": "I have already done that for \"name\". In this PR, I only sorted by name.\nI'll implement others in the new revision.", "author": "varung-31", "createdAt": "2020-03-02T18:03:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjQwMTc4Mw=="}], "type": "inlineReview", "revised_code": {"commit": "7187751292ff0c39a9a454e7ce9564acbff0b918", "chunk": "diff --git a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImpl.java b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImpl.java\nindex 8ba408d5..e1b65406 100644\n--- a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImpl.java\n+++ b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImpl.java\n\n@@ -40,88 +40,96 @@ import org.springframework.stereotype.Component;\n @Component\n @Setter(AccessLevel.PACKAGE)\n public class FhirLocationDaoImpl extends BaseDaoImpl implements FhirLocationDao {\n-\n+\t\n \t@Inject\n \tLocationService locationService;\n-\n+\t\n \t@Inject\n \t@Named(\"sessionFactory\")\n \tSessionFactory sessionFactory;\n-\n+\t\n \t@Override\n \tpublic Location getLocationByUuid(String uuid) {\n \t\treturn locationService.getLocationByUuid(uuid);\n \t}\n-\n+\t\n \tprivate void handleName(Criteria criteria, StringParam namePattern) {\n-\t\tif(namePattern != null) {\n+\t\tif (namePattern != null) {\n \t\t\tpropertyLike(\"name\", namePattern).ifPresent(criteria::add);\n \t\t}\n \t}\n-\n+\t\n \tprivate void handleCity(Criteria criteria, StringParam city) {\n-\t\tif(city != null) {\n+\t\tif (city != null) {\n \t\t\tpropertyLike(\"cityVillage\", city).ifPresent(criteria::add);\n \t\t}\n \t}\n-\n+\t\n \tprivate void handleCountry(Criteria criteria, StringParam country) {\n-\t\tif(country != null) {\n+\t\tif (country != null) {\n \t\t\tpropertyLike(\"country\", country).ifPresent(criteria::add);\n \t\t}\n \t}\n-\n+\t\n \tprivate void handlePostalCode(Criteria criteria, StringParam postalCode) {\n-\t\tif(postalCode != null) {\n+\t\tif (postalCode != null) {\n \t\t\tpropertyLike(\"postalCode\", postalCode).ifPresent(criteria::add);\n \t\t}\n \t}\n-\n+\t\n \tprivate void handleState(Criteria criteria, StringParam state) {\n-\t\tif(state != null) {\n+\t\tif (state != null) {\n \t\t\tpropertyLike(\"stateProvince\", state).ifPresent(criteria::add);\n \t\t}\n \t}\n-\n+\t\n \tprivate void handleTag(Criteria criteria, TokenParam tag) {\n-\t\tif(tag != null) {\n+\t\tif (tag != null) {\n \t\t\tcriteria.createAlias(\"tags\", \"t\");\n \t\t\tpropertyLike(\"t.name\", tag).ifPresent(criteria::add);\n \t\t}\n \t}\n-\n+\t\n \t// handle queries of the form /Location?partof=parent_name\n \tprivate void handleParentLocation(Criteria criteria, StringParam parent) {\n \t\tif (parent != null) {\n \t\t\tProjectionList projList = Projections.projectionList();\n \t\t\tprojList.add(Projections.property(\"locationId\"));\n-\n+\t\t\t\n \t\t\tCriteria criteriaForParent = this.sessionFactory.getCurrentSession().createCriteria(Location.class);\n \t\t\tpropertyLike(\"name\", parent).ifPresent(criteriaForParent::add);\n-\n+\t\t\t\n \t\t\tSet<Object> possibleParentLocationIdList = new HashSet<>(criteriaForParent.setProjection(projList).list());\n-\n+\t\t\t\n \t\t\tcriteria.createCriteria(\"parentLocation\").add(in(\"locationId\", possibleParentLocationIdList));\n \t\t}\n \t}\n-\n+\t\n \t@Override\n \tprotected String paramToProp(@NotNull String paramName) {\n \t\tswitch (paramName) {\n \t\t\tcase \"name\":\n \t\t\t\treturn \"name\";\n+\t\t\tcase \"address-city\":\n+\t\t\t\treturn \"cityVillage\";\n+\t\t\tcase \"address-state\":\n+\t\t\t\treturn \"stateProvince\";\n+\t\t\tcase \"address-country\":\n+\t\t\t\treturn \"country\";\n+\t\t\tcase \"address-postalCode\":\n+\t\t\t\treturn \"postalCode\";\n \t\t\tdefault:\n \t\t\t\treturn null;\n \t\t}\n \t}\n-\n+\t\n \t@Override\n \tpublic Collection<Location> searchForLocations(StringParam name, StringParam city, StringParam country,\n-\t\t\tStringParam postalCode, StringParam state, TokenParam tag, StringParam parent, SortSpec sort) {\n-\n+\t        StringParam postalCode, StringParam state, TokenParam tag, StringParam parent, SortSpec sort) {\n+\t\t\n \t\tCriteria criteria = this.sessionFactory.getCurrentSession().createCriteria(Location.class);\n \t\thandleBooleanProperty(\"retired\", false).ifPresent(criteria::add);\n-\n+\t\t\n \t\thandleName(criteria, name);\n \t\thandleCity(criteria, city);\n \t\thandleCountry(criteria, country);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjQwMzIxOQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/98#discussion_r386403219", "bodyText": "Using something like,\nassertThat(resultsList.get(i - 1).getName(), lessThanOrEqualTo(resultsList.get(i).getName());\n\nWould make the tests more readable. Also, the comments would not be required then.", "author": "CaptainDaVinci", "createdAt": "2020-03-02T13:51:30Z", "path": "api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImplTest.java", "diffHunk": "@@ -36,166 +43,258 @@\n \n @ContextConfiguration(classes = TestFhirSpringConfiguration.class, inheritLocations = false)\n public class FhirLocationDaoImplTest extends BaseModuleContextSensitiveTest {\n-\t\n+\n \tprivate static final String LOCATION_UUID = \"c0938432-1691-11df-97a5-7038c432aaba\";\n-\t\n+\n \tprivate static final String UNKNOWN_LOCATION_UUID = \"c0938432-1691-11df-97a5-7038c432aabz\";\n-\t\n-\tprivate static final String LOCATION_NAME = \"Test location 1\";\n-\t\n+\n+\tprivate static final String LOCATION_NAME = \"Test location 7\";\n+\n \tprivate static final String UNKNOWN_LOCATION_NAME = \"Location2\";\n-\t\n+\n \tprivate static final String LOCATION_CITY = \"Artuor\";\n-\t\n+\n \tprivate static final String UNKNOWN_LOCATION_CITY = \"ArtuorA\";\n-\t\n+\n \tprivate static final String LOCATION_COUNTRY = \"Kenya\";\n-\t\n+\n \tprivate static final String UNKNOWN_LOCATION_COUNTRY = \"KenyaA\";\n-\t\n+\n \tprivate static final String POSTAL_CODE = \"4069-3100\";\n-\t\n+\n \tprivate static final String UNKNOWN_POSTAL_CODE = \"4015-3100\";\n-\t\n+\n \tprivate static final String LOCATION_STATE = \"province\";\n-\t\n+\n \tprivate static final String UNKNOWN_LOCATION_STATE = \"province state\";\n-\t\n+\n \tprivate static final String LOGIN_LOCATION_TAG_NAME = \"login\";\n-\t\n+\n+\tprivate static final String LOCATION_PARENT_NAME = \"Test location 1\";\n+\n+\tprivate static final String UNKNOWN_LOCATION_PARENT_NAME = \"Test location 10\";\n+\n \tprivate static final String LOCATION_ATTRIBUTE_TYPE_UUID = \"abcde432-1691-11df-97a5-7038c432abcd\";\n-\t\n+\n \tprivate static final String LOCATION_INITIAL_DATA_XML = \"org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImplTest_initial_data.xml\";\n-\t\n+\n \tprivate FhirLocationDaoImpl fhirLocationDao;\n-\t\n+\n \t@Inject\n \t@Named(\"locationService\")\n \tprivate Provider<LocationService> locationServiceProvider;\n-\t\n+\n \t@Inject\n \t@Named(\"sessionFactory\")\n \tprivate Provider<SessionFactory> sessionFactoryProvider;\n-\t\n+\n \t@Before\n \tpublic void setup() throws Exception {\n \t\tfhirLocationDao = new FhirLocationDaoImpl();\n \t\tfhirLocationDao.setLocationService(locationServiceProvider.get());\n \t\tfhirLocationDao.setSessionFactory(sessionFactoryProvider.get());\n \t\texecuteDataSet(LOCATION_INITIAL_DATA_XML);\n \t}\n-\t\n+\n \t@Test\n \tpublic void getLocationByUuid_shouldReturnMatchingLocation() {\n \t\tLocation location = fhirLocationDao.getLocationByUuid(LOCATION_UUID);\n-\t\t\n+\n \t\tassertThat(location, notNullValue());\n \t\tassertThat(location.getUuid(), equalTo(LOCATION_UUID));\n \t}\n-\t\n+\n \t@Test\n \tpublic void getLocationByUuid_shouldReturnNullWithUnknownUuid() {\n \t\tLocation location = fhirLocationDao.getLocationByUuid(UNKNOWN_LOCATION_UUID);\n-\t\t\n+\n \t\tassertThat(location, nullValue());\n \t}\n-\t\n+\n \t@Test\n-\tpublic void findLocationByName_shouldReturnCorrectLocation() {\n-\t\tCollection<Location> locations = fhirLocationDao.findLocationByName(LOCATION_NAME);\n-\t\t\n+\tpublic void searchForLocations_shouldReturnCorrectLocationByName() {\n+\t\tStringParam location = new StringParam();\n+\t\tlocation.setValue(LOCATION_NAME);\n+\t\tCollection<Location> locations = fhirLocationDao.searchForLocations(location, null, null, null,\n+\t\t\t\tnull, null, null, null);\n+\n \t\tassertThat(locations, notNullValue());\n \t\tassertThat(locations.size(), equalTo(1));\n \t}\n-\t\n+\n \t@Test\n-\tpublic void findLocationByName_shouldReturnEmptyCollectionWhenCalledWithUnknownName() {\n-\t\tCollection<Location> locations = fhirLocationDao.findLocationByName(UNKNOWN_LOCATION_NAME);\n-\t\t\n+\tpublic void searchForLocations_shouldReturnEmptyCollectionWhenCalledWithUnknownName() {\n+\t\tStringParam location = new StringParam();\n+\t\tlocation.setValue(UNKNOWN_LOCATION_NAME);\n+\t\tCollection<Location> locations = fhirLocationDao.searchForLocations(location, null, null, null,\n+\t\t\t\tnull, null, null, null);\n+\n \t\tassertThat(locations, notNullValue());\n \t\tassertThat(locations.size(), equalTo(0));\n \t}\n-\t\n+\n \t@Test\n-\tpublic void findLocationByCity_shouldReturnCorrectLocation() {\n-\t\tCollection<Location> locations = fhirLocationDao.findLocationsByCity(LOCATION_CITY);\n-\t\t\n+\tpublic void searchForLocations_shouldReturnCorrectLocationByCity() {\n+\t\tStringParam city = new StringParam();\n+\t\tcity.setValue(LOCATION_CITY);\n+\t\tCollection<Location> locations = fhirLocationDao.searchForLocations(null, city, null, null,\n+\t\t\t\tnull, null, null, null);\n+\n \t\tassertThat(locations, notNullValue());\n-\t\tassertThat(locations.size(), greaterThanOrEqualTo(1));\n+\t\tassertThat(locations.size(), equalTo(1));\n \t}\n-\t\n+\n \t@Test\n-\tpublic void findLocationByCity_shouldReturnEmptyCollectionWhenCalledWithUnknownCity() {\n-\t\tCollection<Location> locations = fhirLocationDao.findLocationsByCity(UNKNOWN_LOCATION_CITY);\n-\t\t\n+\tpublic void searchForLocations_shouldReturnEmptyCollectionWhenCalledWithUnknownCity() {\n+\t\tStringParam city = new StringParam();\n+\t\tcity.setValue(UNKNOWN_LOCATION_CITY);\n+\t\tCollection<Location> locations = fhirLocationDao.searchForLocations(null, city, null, null,\n+\t\t\t\tnull, null, null, null);\n+\n \t\tassertThat(locations, notNullValue());\n \t\tassertThat(locations.size(), equalTo(0));\n \t}\n-\t\n+\n \t@Test\n-\tpublic void findLocationByCountry_shouldReturnCorrectLocation() {\n-\t\tCollection<Location> locations = fhirLocationDao.findLocationsByCountry(LOCATION_COUNTRY);\n-\t\t\n+\tpublic void searchForLocations_shouldReturnCorrectLocationByCountry() {\n+\t\tStringParam country = new StringParam();\n+\t\tcountry.setValue(LOCATION_COUNTRY);\n+\t\tCollection<Location> locations = fhirLocationDao.searchForLocations(null, null, country, null,\n+\t\t\t\tnull, null, null, null);\n+\n \t\tassertThat(locations, notNullValue());\n-\t\tassertThat(locations.size(), greaterThanOrEqualTo(2));\n+\t\tassertThat(locations.size(), equalTo(2));\n \t}\n-\t\n+\n \t@Test\n-\tpublic void findLocationByCountry_shouldReturnEmptyCollectionWhenCalledWithUnknownCountry() {\n-\t\tCollection<Location> locations = fhirLocationDao.findLocationsByCountry(UNKNOWN_LOCATION_COUNTRY);\n-\t\t\n+\tpublic void searchForLocations_shouldReturnEmptyCollectionWhenCalledWithUnknownCountry() {\n+\t\tStringParam country = new StringParam();\n+\t\tcountry.setValue(UNKNOWN_LOCATION_COUNTRY);\n+\t\tCollection<Location> locations = fhirLocationDao.searchForLocations(null, null, country, null,\n+\t\t\t\tnull, null, null, null);\n+\n \t\tassertThat(locations, notNullValue());\n \t\tassertThat(locations.size(), equalTo(0));\n \t}\n-\t\n+\n \t@Test\n-\tpublic void findLocationsByPostalCode_shouldReturnCorrectLocation() {\n-\t\tCollection<Location> locations = fhirLocationDao.findLocationsByPostalCode(POSTAL_CODE);\n-\t\t\n+\tpublic void searchForLocations_shouldReturnCorrectLocationByPostalCode() {\n+\t\tStringParam postalCode = new StringParam();\n+\t\tpostalCode.setValue(POSTAL_CODE);\n+\t\tCollection<Location> locations = fhirLocationDao.searchForLocations(null, null, null, postalCode,\n+\t\t\t\tnull, null, null, null);\n+\n \t\tassertThat(locations, notNullValue());\n-\t\tassertThat(locations.size(), greaterThanOrEqualTo(2));\n+\t\tassertThat(locations.size(), equalTo(2));\n \t}\n-\t\n+\n \t@Test\n-\tpublic void findLocationsByPostalCode_shouldReturnEmptyCollectionWhenCalledWithUnknownCode() {\n-\t\tCollection<Location> locations = fhirLocationDao.findLocationsByPostalCode(UNKNOWN_POSTAL_CODE);\n-\t\t\n+\tpublic void searchForLocations_shouldReturnEmptyCollectionWhenCalledWithUnknownCode() {\n+\t\tStringParam postalCode = new StringParam();\n+\t\tpostalCode.setValue(UNKNOWN_POSTAL_CODE);\n+\t\tCollection<Location> locations = fhirLocationDao.searchForLocations(null, null, null, postalCode,\n+\t\t\t\tnull, null, null, null);\n+\n \t\tassertThat(locations, notNullValue());\n \t\tassertThat(locations.size(), equalTo(0));\n \t}\n-\t\n+\n \t@Test\n-\tpublic void findLocationsByState_shouldReturnCorrectLocation() {\n-\t\tCollection<Location> locations = fhirLocationDao.findLocationsByState(LOCATION_STATE);\n-\t\t\n+\tpublic void searchForLocations_shouldReturnCorrectLocationByState() {\n+\t\tStringParam state = new StringParam();\n+\t\tstate.setValue(LOCATION_STATE);\n+\t\tCollection<Location> locations = fhirLocationDao.searchForLocations(null, null, null,\n+\t\t\t\tnull, state, null, null, null);\n+\n \t\tassertThat(locations, notNullValue());\n-\t\tassertThat(locations.size(), greaterThanOrEqualTo(1));\n+\t\tassertThat(locations.size(), equalTo(2));\n \t}\n-\t\n+\n \t@Test\n-\tpublic void findLocationsByState_shouldReturnEmptyCollectionWhenCalledWithUnknownState() {\n-\t\tCollection<Location> locations = fhirLocationDao.findLocationsByState(UNKNOWN_LOCATION_STATE);\n-\t\t\n+\tpublic void searchForLocations_shouldReturnEmptyCollectionWhenCalledWithUnknownState() {\n+\t\tStringParam state = new StringParam();\n+\t\tstate.setValue(UNKNOWN_LOCATION_STATE);\n+\t\tCollection<Location> locations = fhirLocationDao.searchForLocations(null, null, null,\n+\t\t\t\tnull, state, null, null, null);\n+\n \t\tassertThat(locations, notNullValue());\n \t\tassertThat(locations.size(), equalTo(0));\n \t}\n-\t\n+\n \t@Test\n-\tpublic void findLocationsByTag_shouldReturnLocationsContainingGivenTag() {\n+\tpublic void searchForLocations_shouldReturnLocationsContainingGivenTag() {\n \t\tTokenParam locationTag = new TokenParam(FhirConstants.OPENMRS_FHIR_EXT_LOCATION_TAG, LOGIN_LOCATION_TAG_NAME);\n-\t\tCollection<Location> locations = fhirLocationDao.findLocationsByTag(locationTag);\n+\t\tCollection<Location> locations = fhirLocationDao.searchForLocations(null, null, null,\n+\t\t\t\tnull, null, locationTag, null, null);\n+\n+\t\tassertThat(locations, notNullValue());\n+\t\tassertThat(locations.size(), equalTo(2));\n+\t}\n+\n+\t@Test\n+\tpublic void searchForLocations_shouldReturnCorrectLocationByParent() {\n+\t\tStringParam parentLocation = new StringParam();\n+\t\tparentLocation.setValue(LOCATION_PARENT_NAME);\n+\t\tCollection<Location> locations = fhirLocationDao\n+\t\t\t\t.searchForLocations(null, null, null, null, null, null, parentLocation, null);\n+\n+\t\tassertThat(locations, notNullValue());\n+\t\tassertThat(locations.size(), equalTo(1));\n+\t}\n+\n+\tpublic void searchForLocations_shouldReturnEmptyCollectionWhenCalledWithUnknownParent() {\n+\t\tStringParam parentLocation = new StringParam();\n+\t\tparentLocation.setValue(UNKNOWN_LOCATION_PARENT_NAME);\n+\t\tCollection<Location> locations = fhirLocationDao\n+\t\t\t\t.searchForLocations(null, null, null, null, null, null, parentLocation, null);\n+\n \t\tassertThat(locations, notNullValue());\n-\t\tassertThat(locations.size(), greaterThanOrEqualTo(2));\n+\t\tassertThat(locations.size(), equalTo(0));\n \t}\n-\t\n+\n \t@Test\n \tpublic void getActiveAttributesByLocationAndAttributeTypeUuid_shouldReturnLocationAttribute() {\n \t\tLocation location = new Location();\n \t\tlocation.setUuid(LOCATION_UUID);\n-\t\t\n+\n \t\tList<LocationAttribute> attributeList = fhirLocationDao.getActiveAttributesByLocationAndAttributeTypeUuid(location,\n-\t\t    LOCATION_ATTRIBUTE_TYPE_UUID);\n-\t\t\n+\t\t\t\tLOCATION_ATTRIBUTE_TYPE_UUID);\n+\n \t\tassertThat(attributeList, notNullValue());\n \t}\n+\n+\t@Test\n+\tpublic void searchForLocations_shouldSortLocationsAsRequested() {\n+\t\tSortSpec sort = new SortSpec();\n+\t\tsort.setParamName(\"name\");\n+\t\tsort.setOrder(SortOrderEnum.ASC);\n+\n+\t\tCollection<Location> results = fhirLocationDao.searchForLocations(null, null, null, null,\n+\t\t\t\tnull, null, null, sort);\n+\n+\t\tassertThat(results, notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.size(), greaterThan(1));\n+\n+\t\tList<Location> resultsList = new ArrayList<>(results);\n+\t\t// check if the sorting is indeed correct by ascending order\n+\t\tfor (int i = 1; i < resultsList.size(); i++) {\n+\t\t\tassertTrue(resultsList.get(i - 1).getName().compareTo(resultsList.get(i).getName()) <= 0);", "originalCommit": "761142c8267328eab6da66ef89fad0d86fe82e23", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjU4MDI1OA==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/98#discussion_r386580258", "bodyText": "Done", "author": "varung-31", "createdAt": "2020-03-02T18:49:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjQwMzIxOQ=="}], "type": "inlineReview", "revised_code": {"commit": "7187751292ff0c39a9a454e7ce9564acbff0b918", "chunk": "diff --git a/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImplTest.java b/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImplTest.java\nindex 7da6615c..a194241f 100644\n--- a/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImplTest.java\n+++ b/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImplTest.java\n\n@@ -43,51 +44,51 @@ import org.springframework.test.context.ContextConfiguration;\n \n @ContextConfiguration(classes = TestFhirSpringConfiguration.class, inheritLocations = false)\n public class FhirLocationDaoImplTest extends BaseModuleContextSensitiveTest {\n-\n+\t\n \tprivate static final String LOCATION_UUID = \"c0938432-1691-11df-97a5-7038c432aaba\";\n-\n+\t\n \tprivate static final String UNKNOWN_LOCATION_UUID = \"c0938432-1691-11df-97a5-7038c432aabz\";\n-\n+\t\n \tprivate static final String LOCATION_NAME = \"Test location 7\";\n-\n+\t\n \tprivate static final String UNKNOWN_LOCATION_NAME = \"Location2\";\n-\n+\t\n \tprivate static final String LOCATION_CITY = \"Artuor\";\n-\n+\t\n \tprivate static final String UNKNOWN_LOCATION_CITY = \"ArtuorA\";\n-\n+\t\n \tprivate static final String LOCATION_COUNTRY = \"Kenya\";\n-\n+\t\n \tprivate static final String UNKNOWN_LOCATION_COUNTRY = \"KenyaA\";\n-\n+\t\n \tprivate static final String POSTAL_CODE = \"4069-3100\";\n-\n+\t\n \tprivate static final String UNKNOWN_POSTAL_CODE = \"4015-3100\";\n-\n+\t\n \tprivate static final String LOCATION_STATE = \"province\";\n-\n+\t\n \tprivate static final String UNKNOWN_LOCATION_STATE = \"province state\";\n-\n+\t\n \tprivate static final String LOGIN_LOCATION_TAG_NAME = \"login\";\n-\n+\t\n \tprivate static final String LOCATION_PARENT_NAME = \"Test location 1\";\n-\n+\t\n \tprivate static final String UNKNOWN_LOCATION_PARENT_NAME = \"Test location 10\";\n-\n+\t\n \tprivate static final String LOCATION_ATTRIBUTE_TYPE_UUID = \"abcde432-1691-11df-97a5-7038c432abcd\";\n-\n+\t\n \tprivate static final String LOCATION_INITIAL_DATA_XML = \"org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImplTest_initial_data.xml\";\n-\n+\t\n \tprivate FhirLocationDaoImpl fhirLocationDao;\n-\n+\t\n \t@Inject\n \t@Named(\"locationService\")\n \tprivate Provider<LocationService> locationServiceProvider;\n-\n+\t\n \t@Inject\n \t@Named(\"sessionFactory\")\n \tprivate Provider<SessionFactory> sessionFactoryProvider;\n-\n+\t\n \t@Before\n \tpublic void setup() throws Exception {\n \t\tfhirLocationDao = new FhirLocationDaoImpl();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjQwMzI5MQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/98#discussion_r386403291", "bodyText": "Same here.", "author": "CaptainDaVinci", "createdAt": "2020-03-02T13:51:39Z", "path": "api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImplTest.java", "diffHunk": "@@ -36,166 +43,258 @@\n \n @ContextConfiguration(classes = TestFhirSpringConfiguration.class, inheritLocations = false)\n public class FhirLocationDaoImplTest extends BaseModuleContextSensitiveTest {\n-\t\n+\n \tprivate static final String LOCATION_UUID = \"c0938432-1691-11df-97a5-7038c432aaba\";\n-\t\n+\n \tprivate static final String UNKNOWN_LOCATION_UUID = \"c0938432-1691-11df-97a5-7038c432aabz\";\n-\t\n-\tprivate static final String LOCATION_NAME = \"Test location 1\";\n-\t\n+\n+\tprivate static final String LOCATION_NAME = \"Test location 7\";\n+\n \tprivate static final String UNKNOWN_LOCATION_NAME = \"Location2\";\n-\t\n+\n \tprivate static final String LOCATION_CITY = \"Artuor\";\n-\t\n+\n \tprivate static final String UNKNOWN_LOCATION_CITY = \"ArtuorA\";\n-\t\n+\n \tprivate static final String LOCATION_COUNTRY = \"Kenya\";\n-\t\n+\n \tprivate static final String UNKNOWN_LOCATION_COUNTRY = \"KenyaA\";\n-\t\n+\n \tprivate static final String POSTAL_CODE = \"4069-3100\";\n-\t\n+\n \tprivate static final String UNKNOWN_POSTAL_CODE = \"4015-3100\";\n-\t\n+\n \tprivate static final String LOCATION_STATE = \"province\";\n-\t\n+\n \tprivate static final String UNKNOWN_LOCATION_STATE = \"province state\";\n-\t\n+\n \tprivate static final String LOGIN_LOCATION_TAG_NAME = \"login\";\n-\t\n+\n+\tprivate static final String LOCATION_PARENT_NAME = \"Test location 1\";\n+\n+\tprivate static final String UNKNOWN_LOCATION_PARENT_NAME = \"Test location 10\";\n+\n \tprivate static final String LOCATION_ATTRIBUTE_TYPE_UUID = \"abcde432-1691-11df-97a5-7038c432abcd\";\n-\t\n+\n \tprivate static final String LOCATION_INITIAL_DATA_XML = \"org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImplTest_initial_data.xml\";\n-\t\n+\n \tprivate FhirLocationDaoImpl fhirLocationDao;\n-\t\n+\n \t@Inject\n \t@Named(\"locationService\")\n \tprivate Provider<LocationService> locationServiceProvider;\n-\t\n+\n \t@Inject\n \t@Named(\"sessionFactory\")\n \tprivate Provider<SessionFactory> sessionFactoryProvider;\n-\t\n+\n \t@Before\n \tpublic void setup() throws Exception {\n \t\tfhirLocationDao = new FhirLocationDaoImpl();\n \t\tfhirLocationDao.setLocationService(locationServiceProvider.get());\n \t\tfhirLocationDao.setSessionFactory(sessionFactoryProvider.get());\n \t\texecuteDataSet(LOCATION_INITIAL_DATA_XML);\n \t}\n-\t\n+\n \t@Test\n \tpublic void getLocationByUuid_shouldReturnMatchingLocation() {\n \t\tLocation location = fhirLocationDao.getLocationByUuid(LOCATION_UUID);\n-\t\t\n+\n \t\tassertThat(location, notNullValue());\n \t\tassertThat(location.getUuid(), equalTo(LOCATION_UUID));\n \t}\n-\t\n+\n \t@Test\n \tpublic void getLocationByUuid_shouldReturnNullWithUnknownUuid() {\n \t\tLocation location = fhirLocationDao.getLocationByUuid(UNKNOWN_LOCATION_UUID);\n-\t\t\n+\n \t\tassertThat(location, nullValue());\n \t}\n-\t\n+\n \t@Test\n-\tpublic void findLocationByName_shouldReturnCorrectLocation() {\n-\t\tCollection<Location> locations = fhirLocationDao.findLocationByName(LOCATION_NAME);\n-\t\t\n+\tpublic void searchForLocations_shouldReturnCorrectLocationByName() {\n+\t\tStringParam location = new StringParam();\n+\t\tlocation.setValue(LOCATION_NAME);\n+\t\tCollection<Location> locations = fhirLocationDao.searchForLocations(location, null, null, null,\n+\t\t\t\tnull, null, null, null);\n+\n \t\tassertThat(locations, notNullValue());\n \t\tassertThat(locations.size(), equalTo(1));\n \t}\n-\t\n+\n \t@Test\n-\tpublic void findLocationByName_shouldReturnEmptyCollectionWhenCalledWithUnknownName() {\n-\t\tCollection<Location> locations = fhirLocationDao.findLocationByName(UNKNOWN_LOCATION_NAME);\n-\t\t\n+\tpublic void searchForLocations_shouldReturnEmptyCollectionWhenCalledWithUnknownName() {\n+\t\tStringParam location = new StringParam();\n+\t\tlocation.setValue(UNKNOWN_LOCATION_NAME);\n+\t\tCollection<Location> locations = fhirLocationDao.searchForLocations(location, null, null, null,\n+\t\t\t\tnull, null, null, null);\n+\n \t\tassertThat(locations, notNullValue());\n \t\tassertThat(locations.size(), equalTo(0));\n \t}\n-\t\n+\n \t@Test\n-\tpublic void findLocationByCity_shouldReturnCorrectLocation() {\n-\t\tCollection<Location> locations = fhirLocationDao.findLocationsByCity(LOCATION_CITY);\n-\t\t\n+\tpublic void searchForLocations_shouldReturnCorrectLocationByCity() {\n+\t\tStringParam city = new StringParam();\n+\t\tcity.setValue(LOCATION_CITY);\n+\t\tCollection<Location> locations = fhirLocationDao.searchForLocations(null, city, null, null,\n+\t\t\t\tnull, null, null, null);\n+\n \t\tassertThat(locations, notNullValue());\n-\t\tassertThat(locations.size(), greaterThanOrEqualTo(1));\n+\t\tassertThat(locations.size(), equalTo(1));\n \t}\n-\t\n+\n \t@Test\n-\tpublic void findLocationByCity_shouldReturnEmptyCollectionWhenCalledWithUnknownCity() {\n-\t\tCollection<Location> locations = fhirLocationDao.findLocationsByCity(UNKNOWN_LOCATION_CITY);\n-\t\t\n+\tpublic void searchForLocations_shouldReturnEmptyCollectionWhenCalledWithUnknownCity() {\n+\t\tStringParam city = new StringParam();\n+\t\tcity.setValue(UNKNOWN_LOCATION_CITY);\n+\t\tCollection<Location> locations = fhirLocationDao.searchForLocations(null, city, null, null,\n+\t\t\t\tnull, null, null, null);\n+\n \t\tassertThat(locations, notNullValue());\n \t\tassertThat(locations.size(), equalTo(0));\n \t}\n-\t\n+\n \t@Test\n-\tpublic void findLocationByCountry_shouldReturnCorrectLocation() {\n-\t\tCollection<Location> locations = fhirLocationDao.findLocationsByCountry(LOCATION_COUNTRY);\n-\t\t\n+\tpublic void searchForLocations_shouldReturnCorrectLocationByCountry() {\n+\t\tStringParam country = new StringParam();\n+\t\tcountry.setValue(LOCATION_COUNTRY);\n+\t\tCollection<Location> locations = fhirLocationDao.searchForLocations(null, null, country, null,\n+\t\t\t\tnull, null, null, null);\n+\n \t\tassertThat(locations, notNullValue());\n-\t\tassertThat(locations.size(), greaterThanOrEqualTo(2));\n+\t\tassertThat(locations.size(), equalTo(2));\n \t}\n-\t\n+\n \t@Test\n-\tpublic void findLocationByCountry_shouldReturnEmptyCollectionWhenCalledWithUnknownCountry() {\n-\t\tCollection<Location> locations = fhirLocationDao.findLocationsByCountry(UNKNOWN_LOCATION_COUNTRY);\n-\t\t\n+\tpublic void searchForLocations_shouldReturnEmptyCollectionWhenCalledWithUnknownCountry() {\n+\t\tStringParam country = new StringParam();\n+\t\tcountry.setValue(UNKNOWN_LOCATION_COUNTRY);\n+\t\tCollection<Location> locations = fhirLocationDao.searchForLocations(null, null, country, null,\n+\t\t\t\tnull, null, null, null);\n+\n \t\tassertThat(locations, notNullValue());\n \t\tassertThat(locations.size(), equalTo(0));\n \t}\n-\t\n+\n \t@Test\n-\tpublic void findLocationsByPostalCode_shouldReturnCorrectLocation() {\n-\t\tCollection<Location> locations = fhirLocationDao.findLocationsByPostalCode(POSTAL_CODE);\n-\t\t\n+\tpublic void searchForLocations_shouldReturnCorrectLocationByPostalCode() {\n+\t\tStringParam postalCode = new StringParam();\n+\t\tpostalCode.setValue(POSTAL_CODE);\n+\t\tCollection<Location> locations = fhirLocationDao.searchForLocations(null, null, null, postalCode,\n+\t\t\t\tnull, null, null, null);\n+\n \t\tassertThat(locations, notNullValue());\n-\t\tassertThat(locations.size(), greaterThanOrEqualTo(2));\n+\t\tassertThat(locations.size(), equalTo(2));\n \t}\n-\t\n+\n \t@Test\n-\tpublic void findLocationsByPostalCode_shouldReturnEmptyCollectionWhenCalledWithUnknownCode() {\n-\t\tCollection<Location> locations = fhirLocationDao.findLocationsByPostalCode(UNKNOWN_POSTAL_CODE);\n-\t\t\n+\tpublic void searchForLocations_shouldReturnEmptyCollectionWhenCalledWithUnknownCode() {\n+\t\tStringParam postalCode = new StringParam();\n+\t\tpostalCode.setValue(UNKNOWN_POSTAL_CODE);\n+\t\tCollection<Location> locations = fhirLocationDao.searchForLocations(null, null, null, postalCode,\n+\t\t\t\tnull, null, null, null);\n+\n \t\tassertThat(locations, notNullValue());\n \t\tassertThat(locations.size(), equalTo(0));\n \t}\n-\t\n+\n \t@Test\n-\tpublic void findLocationsByState_shouldReturnCorrectLocation() {\n-\t\tCollection<Location> locations = fhirLocationDao.findLocationsByState(LOCATION_STATE);\n-\t\t\n+\tpublic void searchForLocations_shouldReturnCorrectLocationByState() {\n+\t\tStringParam state = new StringParam();\n+\t\tstate.setValue(LOCATION_STATE);\n+\t\tCollection<Location> locations = fhirLocationDao.searchForLocations(null, null, null,\n+\t\t\t\tnull, state, null, null, null);\n+\n \t\tassertThat(locations, notNullValue());\n-\t\tassertThat(locations.size(), greaterThanOrEqualTo(1));\n+\t\tassertThat(locations.size(), equalTo(2));\n \t}\n-\t\n+\n \t@Test\n-\tpublic void findLocationsByState_shouldReturnEmptyCollectionWhenCalledWithUnknownState() {\n-\t\tCollection<Location> locations = fhirLocationDao.findLocationsByState(UNKNOWN_LOCATION_STATE);\n-\t\t\n+\tpublic void searchForLocations_shouldReturnEmptyCollectionWhenCalledWithUnknownState() {\n+\t\tStringParam state = new StringParam();\n+\t\tstate.setValue(UNKNOWN_LOCATION_STATE);\n+\t\tCollection<Location> locations = fhirLocationDao.searchForLocations(null, null, null,\n+\t\t\t\tnull, state, null, null, null);\n+\n \t\tassertThat(locations, notNullValue());\n \t\tassertThat(locations.size(), equalTo(0));\n \t}\n-\t\n+\n \t@Test\n-\tpublic void findLocationsByTag_shouldReturnLocationsContainingGivenTag() {\n+\tpublic void searchForLocations_shouldReturnLocationsContainingGivenTag() {\n \t\tTokenParam locationTag = new TokenParam(FhirConstants.OPENMRS_FHIR_EXT_LOCATION_TAG, LOGIN_LOCATION_TAG_NAME);\n-\t\tCollection<Location> locations = fhirLocationDao.findLocationsByTag(locationTag);\n+\t\tCollection<Location> locations = fhirLocationDao.searchForLocations(null, null, null,\n+\t\t\t\tnull, null, locationTag, null, null);\n+\n+\t\tassertThat(locations, notNullValue());\n+\t\tassertThat(locations.size(), equalTo(2));\n+\t}\n+\n+\t@Test\n+\tpublic void searchForLocations_shouldReturnCorrectLocationByParent() {\n+\t\tStringParam parentLocation = new StringParam();\n+\t\tparentLocation.setValue(LOCATION_PARENT_NAME);\n+\t\tCollection<Location> locations = fhirLocationDao\n+\t\t\t\t.searchForLocations(null, null, null, null, null, null, parentLocation, null);\n+\n+\t\tassertThat(locations, notNullValue());\n+\t\tassertThat(locations.size(), equalTo(1));\n+\t}\n+\n+\tpublic void searchForLocations_shouldReturnEmptyCollectionWhenCalledWithUnknownParent() {\n+\t\tStringParam parentLocation = new StringParam();\n+\t\tparentLocation.setValue(UNKNOWN_LOCATION_PARENT_NAME);\n+\t\tCollection<Location> locations = fhirLocationDao\n+\t\t\t\t.searchForLocations(null, null, null, null, null, null, parentLocation, null);\n+\n \t\tassertThat(locations, notNullValue());\n-\t\tassertThat(locations.size(), greaterThanOrEqualTo(2));\n+\t\tassertThat(locations.size(), equalTo(0));\n \t}\n-\t\n+\n \t@Test\n \tpublic void getActiveAttributesByLocationAndAttributeTypeUuid_shouldReturnLocationAttribute() {\n \t\tLocation location = new Location();\n \t\tlocation.setUuid(LOCATION_UUID);\n-\t\t\n+\n \t\tList<LocationAttribute> attributeList = fhirLocationDao.getActiveAttributesByLocationAndAttributeTypeUuid(location,\n-\t\t    LOCATION_ATTRIBUTE_TYPE_UUID);\n-\t\t\n+\t\t\t\tLOCATION_ATTRIBUTE_TYPE_UUID);\n+\n \t\tassertThat(attributeList, notNullValue());\n \t}\n+\n+\t@Test\n+\tpublic void searchForLocations_shouldSortLocationsAsRequested() {\n+\t\tSortSpec sort = new SortSpec();\n+\t\tsort.setParamName(\"name\");\n+\t\tsort.setOrder(SortOrderEnum.ASC);\n+\n+\t\tCollection<Location> results = fhirLocationDao.searchForLocations(null, null, null, null,\n+\t\t\t\tnull, null, null, sort);\n+\n+\t\tassertThat(results, notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.size(), greaterThan(1));\n+\n+\t\tList<Location> resultsList = new ArrayList<>(results);\n+\t\t// check if the sorting is indeed correct by ascending order\n+\t\tfor (int i = 1; i < resultsList.size(); i++) {\n+\t\t\tassertTrue(resultsList.get(i - 1).getName().compareTo(resultsList.get(i).getName()) <= 0);\n+\t\t}\n+\n+\t\tsort.setOrder(SortOrderEnum.DESC);\n+\n+\t\tresults = fhirLocationDao.searchForLocations(null, null, null, null,\n+\t\t\t\tnull, null, null, sort);\n+\n+\t\tassertThat(results, notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.size(), greaterThan(1));\n+\n+\t\tresultsList = new ArrayList<>(results);\n+\t\t// check if the sorting is indeed correct by descending order\n+\t\tfor (int i = 1; i < resultsList.size(); i++) {\n+\t\t\tassertTrue(resultsList.get(i - 1).getName().compareTo(resultsList.get(i).getName()) >= 0);", "originalCommit": "761142c8267328eab6da66ef89fad0d86fe82e23", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjU4MDIxOQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/98#discussion_r386580219", "bodyText": "Done", "author": "varung-31", "createdAt": "2020-03-02T18:49:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjQwMzI5MQ=="}], "type": "inlineReview", "revised_code": {"commit": "7187751292ff0c39a9a454e7ce9564acbff0b918", "chunk": "diff --git a/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImplTest.java b/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImplTest.java\nindex 7da6615c..a194241f 100644\n--- a/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImplTest.java\n+++ b/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImplTest.java\n\n@@ -43,51 +44,51 @@ import org.springframework.test.context.ContextConfiguration;\n \n @ContextConfiguration(classes = TestFhirSpringConfiguration.class, inheritLocations = false)\n public class FhirLocationDaoImplTest extends BaseModuleContextSensitiveTest {\n-\n+\t\n \tprivate static final String LOCATION_UUID = \"c0938432-1691-11df-97a5-7038c432aaba\";\n-\n+\t\n \tprivate static final String UNKNOWN_LOCATION_UUID = \"c0938432-1691-11df-97a5-7038c432aabz\";\n-\n+\t\n \tprivate static final String LOCATION_NAME = \"Test location 7\";\n-\n+\t\n \tprivate static final String UNKNOWN_LOCATION_NAME = \"Location2\";\n-\n+\t\n \tprivate static final String LOCATION_CITY = \"Artuor\";\n-\n+\t\n \tprivate static final String UNKNOWN_LOCATION_CITY = \"ArtuorA\";\n-\n+\t\n \tprivate static final String LOCATION_COUNTRY = \"Kenya\";\n-\n+\t\n \tprivate static final String UNKNOWN_LOCATION_COUNTRY = \"KenyaA\";\n-\n+\t\n \tprivate static final String POSTAL_CODE = \"4069-3100\";\n-\n+\t\n \tprivate static final String UNKNOWN_POSTAL_CODE = \"4015-3100\";\n-\n+\t\n \tprivate static final String LOCATION_STATE = \"province\";\n-\n+\t\n \tprivate static final String UNKNOWN_LOCATION_STATE = \"province state\";\n-\n+\t\n \tprivate static final String LOGIN_LOCATION_TAG_NAME = \"login\";\n-\n+\t\n \tprivate static final String LOCATION_PARENT_NAME = \"Test location 1\";\n-\n+\t\n \tprivate static final String UNKNOWN_LOCATION_PARENT_NAME = \"Test location 10\";\n-\n+\t\n \tprivate static final String LOCATION_ATTRIBUTE_TYPE_UUID = \"abcde432-1691-11df-97a5-7038c432abcd\";\n-\n+\t\n \tprivate static final String LOCATION_INITIAL_DATA_XML = \"org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImplTest_initial_data.xml\";\n-\n+\t\n \tprivate FhirLocationDaoImpl fhirLocationDao;\n-\n+\t\n \t@Inject\n \t@Named(\"locationService\")\n \tprivate Provider<LocationService> locationServiceProvider;\n-\n+\t\n \t@Inject\n \t@Named(\"sessionFactory\")\n \tprivate Provider<SessionFactory> sessionFactoryProvider;\n-\n+\t\n \t@Before\n \tpublic void setup() throws Exception {\n \t\tfhirLocationDao = new FhirLocationDaoImpl();\n"}}, {"oid": "7187751292ff0c39a9a454e7ce9564acbff0b918", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/7187751292ff0c39a9a454e7ce9564acbff0b918", "message": "FM2-80: Improve Search for Location Resource", "committedDate": "2020-03-02T18:41:59Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA3NDY3OQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/98#discussion_r387074679", "bodyText": "I'd prefer boolean to Boolean. Boolean allows the value to be set to null which can cause unexpected issues.", "author": "ibacher", "createdAt": "2020-03-03T14:55:54Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/BaseDaoImpl.java", "diffHunk": "@@ -339,15 +339,19 @@ protected boolean containsAlias(Iterator<CriteriaImpl.Subcriteria> subcriteriaIt\n \t\t// the string matches \"true\". We could potentially be passed a non-valid Boolean value here.\n \t\treturn handleOrListParam(booleanToken, token -> {\n \t\t\tif (token.getValue().equalsIgnoreCase(\"true\")) {\n-\t\t\t\treturn Optional.of(eq(propertyName, true));\n+\t\t\t\treturn handleBooleanProperty(propertyName, true);\n \t\t\t} else if (token.getValue().equalsIgnoreCase(\"false\")) {\n-\t\t\t\treturn Optional.of(eq(propertyName, false));\n+\t\t\t\treturn handleBooleanProperty(propertyName, false);\n \t\t\t}\n \t\t\t\n \t\t\treturn Optional.empty();\n \t\t});\n \t}\n \t\n+\tprotected Optional<Criterion> handleBooleanProperty(String propertyName, Boolean booleanVal) {", "originalCommit": "7187751292ff0c39a9a454e7ce9564acbff0b918", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c9cc6886767eda1994307473ea39527ab2208bd5", "chunk": "diff --git a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/BaseDaoImpl.java b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/BaseDaoImpl.java\nindex b0705c6e..4ece40f0 100644\n--- a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/BaseDaoImpl.java\n+++ b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/BaseDaoImpl.java\n\n@@ -348,7 +348,7 @@ public abstract class BaseDaoImpl {\n \t\t});\n \t}\n \t\n-\tprotected Optional<Criterion> handleBooleanProperty(String propertyName, Boolean booleanVal) {\n+\tprotected Optional<Criterion> handleBooleanProperty(String propertyName, boolean booleanVal) {\n \t\treturn Optional.of(eq(propertyName, booleanVal));\n \t}\n \t\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA3OTUxNA==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/98#discussion_r387079514", "bodyText": "I don't think we should actually be adding this. For TokenParam unlike StringParam, the match should always be equality, i.e., so instead of propertyLike(\"t.uuid\", tag), we should really just be doing eq(\"t.uuid\", tag).", "author": "ibacher", "createdAt": "2020-03-03T15:02:40Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/BaseDaoImpl.java", "diffHunk": "@@ -693,19 +697,27 @@ protected String paramToProp(@NotNull String param) {\n \t\t\treturn Optional.of(ilike(propertyName, param.getValue(), MatchMode.EXACT));\n \t\t} else if (param.isContains()) {\n \t\t\treturn Optional.of(ilike(propertyName, param.getValue(), MatchMode.ANYWHERE));\n-\t\t} else {\n-\t\t\treturn Optional.of(ilike(propertyName, param.getValue(), MatchMode.START));\n \t\t}\n+\t\t\n+\t\treturn Optional.of(ilike(propertyName, param.getValue(), MatchMode.START));\n+\t}\n+\t\n+\tprotected Optional<Criterion> propertyLike(@NotNull String propertyName, TokenParam tag) {\n+\t\tif (tag == null) {\n+\t\t\treturn Optional.empty();\n+\t\t}\n+\t\t\n+\t\treturn propertyLike(propertyName, new StringParam(tag.getValue()));", "originalCommit": "7187751292ff0c39a9a454e7ce9564acbff0b918", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c9cc6886767eda1994307473ea39527ab2208bd5", "chunk": "diff --git a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/BaseDaoImpl.java b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/BaseDaoImpl.java\nindex b0705c6e..4ece40f0 100644\n--- a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/BaseDaoImpl.java\n+++ b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/BaseDaoImpl.java\n\n@@ -702,14 +724,6 @@ public abstract class BaseDaoImpl {\n \t\treturn Optional.of(ilike(propertyName, param.getValue(), MatchMode.START));\n \t}\n \t\n-\tprotected Optional<Criterion> propertyLike(@NotNull String propertyName, TokenParam tag) {\n-\t\tif (tag == null) {\n-\t\t\treturn Optional.empty();\n-\t\t}\n-\t\t\n-\t\treturn propertyLike(propertyName, new StringParam(tag.getValue()));\n-\t}\n-\t\n \tprotected Optional<CriteriaImpl> asImpl(Criteria criteria) {\n \t\tif (CriteriaImpl.class.isAssignableFrom(criteria.getClass())) {\n \t\t\treturn Optional.of((CriteriaImpl) criteria);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA4MDM4NQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/98#discussion_r387080385", "bodyText": "See above.\ncritieria.add(eq(\"t.name\", tag.getValue()))", "author": "ibacher", "createdAt": "2020-03-03T15:03:56Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImpl.java", "diffHunk": "@@ -44,35 +53,93 @@ public Location getLocationByUuid(String uuid) {\n \t\treturn locationService.getLocationByUuid(uuid);\n \t}\n \t\n-\t@Override\n-\tpublic Collection<Location> findLocationByName(String name) {\n-\t\treturn locationService.getLocations(name);\n+\tprivate void handleName(Criteria criteria, StringParam namePattern) {\n+\t\tif (namePattern != null) {\n+\t\t\tpropertyLike(\"name\", namePattern).ifPresent(criteria::add);\n+\t\t}\n \t}\n \t\n-\t@Override\n-\tpublic Collection<Location> findLocationsByCity(String city) {\n-\t\treturn sessionFactory.getCurrentSession().createCriteria(Location.class).add(eq(\"cityVillage\", city)).list();\n+\tprivate void handleCity(Criteria criteria, StringParam city) {\n+\t\tif (city != null) {\n+\t\t\tpropertyLike(\"cityVillage\", city).ifPresent(criteria::add);\n+\t\t}\n \t}\n \t\n-\t@Override\n-\tpublic Collection<Location> findLocationsByCountry(String country) {\n-\t\treturn sessionFactory.getCurrentSession().createCriteria(Location.class).add(eq(\"country\", country)).list();\n+\tprivate void handleCountry(Criteria criteria, StringParam country) {\n+\t\tif (country != null) {\n+\t\t\tpropertyLike(\"country\", country).ifPresent(criteria::add);\n+\t\t}\n \t}\n \t\n-\t@Override\n-\tpublic Collection<Location> findLocationsByPostalCode(String postalCode) {\n-\t\treturn sessionFactory.getCurrentSession().createCriteria(Location.class).add(eq(\"postalCode\", postalCode)).list();\n+\tprivate void handlePostalCode(Criteria criteria, StringParam postalCode) {\n+\t\tif (postalCode != null) {\n+\t\t\tpropertyLike(\"postalCode\", postalCode).ifPresent(criteria::add);\n+\t\t}\n+\t}\n+\t\n+\tprivate void handleState(Criteria criteria, StringParam state) {\n+\t\tif (state != null) {\n+\t\t\tpropertyLike(\"stateProvince\", state).ifPresent(criteria::add);\n+\t\t}\n+\t}\n+\t\n+\tprivate void handleTag(Criteria criteria, TokenParam tag) {\n+\t\tif (tag != null) {\n+\t\t\tcriteria.createAlias(\"tags\", \"t\");\n+\t\t\tpropertyLike(\"t.name\", tag).ifPresent(criteria::add);", "originalCommit": "7187751292ff0c39a9a454e7ce9564acbff0b918", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c9cc6886767eda1994307473ea39527ab2208bd5", "chunk": "diff --git a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImpl.java b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImpl.java\nindex e1b65406..4ff2d73e 100644\n--- a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImpl.java\n+++ b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImpl.java\n\n@@ -50,58 +50,83 @@ public class FhirLocationDaoImpl extends BaseDaoImpl implements FhirLocationDao\n \t\n \t@Override\n \tpublic Location getLocationByUuid(String uuid) {\n-\t\treturn locationService.getLocationByUuid(uuid);\n+\t\treturn (Location) sessionFactory.getCurrentSession().createCriteria(Location.class).add(eq(\"uuid\", uuid))\n+\t\t        .uniqueResult();\n \t}\n \t\n-\tprivate void handleName(Criteria criteria, StringParam namePattern) {\n+\t@Override\n+\tpublic Collection<Location> searchForLocations(StringOrListParam name, StringOrListParam city, StringOrListParam country,\n+\t        StringOrListParam postalCode, StringOrListParam state, TokenOrListParam tag, ReferenceOrListParam parent,\n+\t        SortSpec sort) {\n+\t\t\n+\t\tCriteria criteria = this.sessionFactory.getCurrentSession().createCriteria(Location.class);\n+\t\thandleBooleanProperty(\"retired\", false).ifPresent(criteria::add);\n+\t\t\n+\t\thandleName(criteria, name);\n+\t\thandleCity(criteria, city);\n+\t\thandleCountry(criteria, country);\n+\t\thandlePostalCode(criteria, postalCode);\n+\t\thandleState(criteria, state);\n+\t\thandleTag(criteria, tag);\n+\t\thandleParentLocation(criteria, parent);\n+\t\thandleSort(criteria, sort);\n+\t\t\n+\t\treturn criteria.list();\n+\t}\n+\t\n+\t@Override\n+\tpublic List<LocationAttribute> getActiveAttributesByLocationAndAttributeTypeUuid(Location location,\n+\t        String locationAttributeTypeUuid) {\n+\t\treturn (List<LocationAttribute>) sessionFactory.getCurrentSession().createCriteria(LocationAttribute.class)\n+\t\t        .createAlias(\"location\", \"l\", JoinType.INNER_JOIN, eq(\"l.id\", location.getId()))\n+\t\t        .createAlias(\"attributeType\", \"lat\").add(eq(\"lat.uuid\", locationAttributeTypeUuid)).add(eq(\"voided\", false))\n+\t\t        .list();\n+\t}\n+\t\n+\tprivate void handleName(Criteria criteria, StringOrListParam namePattern) {\n \t\tif (namePattern != null) {\n-\t\t\tpropertyLike(\"name\", namePattern).ifPresent(criteria::add);\n+\t\t\thandleOrListParam(namePattern, (givenName) -> propertyLike(\"name\", givenName)).ifPresent(criteria::add);\n \t\t}\n \t}\n \t\n-\tprivate void handleCity(Criteria criteria, StringParam city) {\n+\tprivate void handleCity(Criteria criteria, StringOrListParam city) {\n \t\tif (city != null) {\n-\t\t\tpropertyLike(\"cityVillage\", city).ifPresent(criteria::add);\n+\t\t\thandleOrListParam(city, (givenCity) -> propertyLike(\"cityVillage\", givenCity)).ifPresent(criteria::add);\n \t\t}\n \t}\n \t\n-\tprivate void handleCountry(Criteria criteria, StringParam country) {\n+\tprivate void handleCountry(Criteria criteria, StringOrListParam country) {\n \t\tif (country != null) {\n-\t\t\tpropertyLike(\"country\", country).ifPresent(criteria::add);\n+\t\t\thandleOrListParam(country, (givenCountry) -> propertyLike(\"country\", givenCountry)).ifPresent(criteria::add);\n \t\t}\n \t}\n \t\n-\tprivate void handlePostalCode(Criteria criteria, StringParam postalCode) {\n+\tprivate void handlePostalCode(Criteria criteria, StringOrListParam postalCode) {\n \t\tif (postalCode != null) {\n-\t\t\tpropertyLike(\"postalCode\", postalCode).ifPresent(criteria::add);\n+\t\t\thandleOrListParam(postalCode, (givenPostalCode) -> propertyLike(\"postalCode\", givenPostalCode))\n+\t\t\t        .ifPresent(criteria::add);\n \t\t}\n \t}\n \t\n-\tprivate void handleState(Criteria criteria, StringParam state) {\n+\tprivate void handleState(Criteria criteria, StringOrListParam state) {\n \t\tif (state != null) {\n-\t\t\tpropertyLike(\"stateProvince\", state).ifPresent(criteria::add);\n+\t\t\thandleOrListParam(state, (givenState) -> propertyLike(\"stateProvince\", givenState)).ifPresent(criteria::add);\n \t\t}\n \t}\n \t\n-\tprivate void handleTag(Criteria criteria, TokenParam tag) {\n+\tprivate void handleTag(Criteria criteria, TokenOrListParam tag) {\n \t\tif (tag != null) {\n \t\t\tcriteria.createAlias(\"tags\", \"t\");\n-\t\t\tpropertyLike(\"t.name\", tag).ifPresent(criteria::add);\n+\t\t\thandleOrListParam(tag, (givenTag) -> Optional.of(eq(\"t.name\", givenTag.getValue()))).ifPresent(criteria::add);\n \t\t}\n \t}\n \t\n-\t// handle queries of the form /Location?partof=parent_name\n-\tprivate void handleParentLocation(Criteria criteria, StringParam parent) {\n+\tprivate void handleParentLocation(Criteria criteria, ReferenceOrListParam parent) {\n \t\tif (parent != null) {\n-\t\t\tProjectionList projList = Projections.projectionList();\n-\t\t\tprojList.add(Projections.property(\"locationId\"));\n-\t\t\t\n-\t\t\tCriteria criteriaForParent = this.sessionFactory.getCurrentSession().createCriteria(Location.class);\n-\t\t\tpropertyLike(\"name\", parent).ifPresent(criteriaForParent::add);\n-\t\t\t\n-\t\t\tSet<Object> possibleParentLocationIdList = new HashSet<>(criteriaForParent.setProjection(projList).list());\n-\t\t\t\n-\t\t\tcriteria.createCriteria(\"parentLocation\").add(in(\"locationId\", possibleParentLocationIdList));\n+\t\t\tDetachedCriteria criteriaForParent = DetachedCriteria.forClass(Location.class);\n+\t\t\thandleOrListParam(parent, this::handleParentReference).ifPresent(criteriaForParent::add);\n+\t\t\tcriteriaForParent.setProjection(Projections.property(\"locationId\"));\n+\t\t\tcriteria.add(Subqueries.propertyIn(\"parentLocation.locationId\", criteriaForParent));\n \t\t}\n \t}\n \t\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA4MTIwNg==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/98#discussion_r387081206", "bodyText": "parent should be defined as a referenceParam. See the definition here.", "author": "ibacher", "createdAt": "2020-03-03T15:05:11Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImpl.java", "diffHunk": "@@ -44,35 +53,93 @@ public Location getLocationByUuid(String uuid) {\n \t\treturn locationService.getLocationByUuid(uuid);\n \t}\n \t\n-\t@Override\n-\tpublic Collection<Location> findLocationByName(String name) {\n-\t\treturn locationService.getLocations(name);\n+\tprivate void handleName(Criteria criteria, StringParam namePattern) {\n+\t\tif (namePattern != null) {\n+\t\t\tpropertyLike(\"name\", namePattern).ifPresent(criteria::add);\n+\t\t}\n \t}\n \t\n-\t@Override\n-\tpublic Collection<Location> findLocationsByCity(String city) {\n-\t\treturn sessionFactory.getCurrentSession().createCriteria(Location.class).add(eq(\"cityVillage\", city)).list();\n+\tprivate void handleCity(Criteria criteria, StringParam city) {\n+\t\tif (city != null) {\n+\t\t\tpropertyLike(\"cityVillage\", city).ifPresent(criteria::add);\n+\t\t}\n \t}\n \t\n-\t@Override\n-\tpublic Collection<Location> findLocationsByCountry(String country) {\n-\t\treturn sessionFactory.getCurrentSession().createCriteria(Location.class).add(eq(\"country\", country)).list();\n+\tprivate void handleCountry(Criteria criteria, StringParam country) {\n+\t\tif (country != null) {\n+\t\t\tpropertyLike(\"country\", country).ifPresent(criteria::add);\n+\t\t}\n \t}\n \t\n-\t@Override\n-\tpublic Collection<Location> findLocationsByPostalCode(String postalCode) {\n-\t\treturn sessionFactory.getCurrentSession().createCriteria(Location.class).add(eq(\"postalCode\", postalCode)).list();\n+\tprivate void handlePostalCode(Criteria criteria, StringParam postalCode) {\n+\t\tif (postalCode != null) {\n+\t\t\tpropertyLike(\"postalCode\", postalCode).ifPresent(criteria::add);\n+\t\t}\n+\t}\n+\t\n+\tprivate void handleState(Criteria criteria, StringParam state) {\n+\t\tif (state != null) {\n+\t\t\tpropertyLike(\"stateProvince\", state).ifPresent(criteria::add);\n+\t\t}\n+\t}\n+\t\n+\tprivate void handleTag(Criteria criteria, TokenParam tag) {\n+\t\tif (tag != null) {\n+\t\t\tcriteria.createAlias(\"tags\", \"t\");\n+\t\t\tpropertyLike(\"t.name\", tag).ifPresent(criteria::add);\n+\t\t}\n+\t}\n+\t\n+\t// handle queries of the form /Location?partof=parent_name\n+\tprivate void handleParentLocation(Criteria criteria, StringParam parent) {", "originalCommit": "7187751292ff0c39a9a454e7ce9564acbff0b918", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c9cc6886767eda1994307473ea39527ab2208bd5", "chunk": "diff --git a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImpl.java b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImpl.java\nindex e1b65406..4ff2d73e 100644\n--- a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImpl.java\n+++ b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImpl.java\n\n@@ -50,58 +50,83 @@ public class FhirLocationDaoImpl extends BaseDaoImpl implements FhirLocationDao\n \t\n \t@Override\n \tpublic Location getLocationByUuid(String uuid) {\n-\t\treturn locationService.getLocationByUuid(uuid);\n+\t\treturn (Location) sessionFactory.getCurrentSession().createCriteria(Location.class).add(eq(\"uuid\", uuid))\n+\t\t        .uniqueResult();\n \t}\n \t\n-\tprivate void handleName(Criteria criteria, StringParam namePattern) {\n+\t@Override\n+\tpublic Collection<Location> searchForLocations(StringOrListParam name, StringOrListParam city, StringOrListParam country,\n+\t        StringOrListParam postalCode, StringOrListParam state, TokenOrListParam tag, ReferenceOrListParam parent,\n+\t        SortSpec sort) {\n+\t\t\n+\t\tCriteria criteria = this.sessionFactory.getCurrentSession().createCriteria(Location.class);\n+\t\thandleBooleanProperty(\"retired\", false).ifPresent(criteria::add);\n+\t\t\n+\t\thandleName(criteria, name);\n+\t\thandleCity(criteria, city);\n+\t\thandleCountry(criteria, country);\n+\t\thandlePostalCode(criteria, postalCode);\n+\t\thandleState(criteria, state);\n+\t\thandleTag(criteria, tag);\n+\t\thandleParentLocation(criteria, parent);\n+\t\thandleSort(criteria, sort);\n+\t\t\n+\t\treturn criteria.list();\n+\t}\n+\t\n+\t@Override\n+\tpublic List<LocationAttribute> getActiveAttributesByLocationAndAttributeTypeUuid(Location location,\n+\t        String locationAttributeTypeUuid) {\n+\t\treturn (List<LocationAttribute>) sessionFactory.getCurrentSession().createCriteria(LocationAttribute.class)\n+\t\t        .createAlias(\"location\", \"l\", JoinType.INNER_JOIN, eq(\"l.id\", location.getId()))\n+\t\t        .createAlias(\"attributeType\", \"lat\").add(eq(\"lat.uuid\", locationAttributeTypeUuid)).add(eq(\"voided\", false))\n+\t\t        .list();\n+\t}\n+\t\n+\tprivate void handleName(Criteria criteria, StringOrListParam namePattern) {\n \t\tif (namePattern != null) {\n-\t\t\tpropertyLike(\"name\", namePattern).ifPresent(criteria::add);\n+\t\t\thandleOrListParam(namePattern, (givenName) -> propertyLike(\"name\", givenName)).ifPresent(criteria::add);\n \t\t}\n \t}\n \t\n-\tprivate void handleCity(Criteria criteria, StringParam city) {\n+\tprivate void handleCity(Criteria criteria, StringOrListParam city) {\n \t\tif (city != null) {\n-\t\t\tpropertyLike(\"cityVillage\", city).ifPresent(criteria::add);\n+\t\t\thandleOrListParam(city, (givenCity) -> propertyLike(\"cityVillage\", givenCity)).ifPresent(criteria::add);\n \t\t}\n \t}\n \t\n-\tprivate void handleCountry(Criteria criteria, StringParam country) {\n+\tprivate void handleCountry(Criteria criteria, StringOrListParam country) {\n \t\tif (country != null) {\n-\t\t\tpropertyLike(\"country\", country).ifPresent(criteria::add);\n+\t\t\thandleOrListParam(country, (givenCountry) -> propertyLike(\"country\", givenCountry)).ifPresent(criteria::add);\n \t\t}\n \t}\n \t\n-\tprivate void handlePostalCode(Criteria criteria, StringParam postalCode) {\n+\tprivate void handlePostalCode(Criteria criteria, StringOrListParam postalCode) {\n \t\tif (postalCode != null) {\n-\t\t\tpropertyLike(\"postalCode\", postalCode).ifPresent(criteria::add);\n+\t\t\thandleOrListParam(postalCode, (givenPostalCode) -> propertyLike(\"postalCode\", givenPostalCode))\n+\t\t\t        .ifPresent(criteria::add);\n \t\t}\n \t}\n \t\n-\tprivate void handleState(Criteria criteria, StringParam state) {\n+\tprivate void handleState(Criteria criteria, StringOrListParam state) {\n \t\tif (state != null) {\n-\t\t\tpropertyLike(\"stateProvince\", state).ifPresent(criteria::add);\n+\t\t\thandleOrListParam(state, (givenState) -> propertyLike(\"stateProvince\", givenState)).ifPresent(criteria::add);\n \t\t}\n \t}\n \t\n-\tprivate void handleTag(Criteria criteria, TokenParam tag) {\n+\tprivate void handleTag(Criteria criteria, TokenOrListParam tag) {\n \t\tif (tag != null) {\n \t\t\tcriteria.createAlias(\"tags\", \"t\");\n-\t\t\tpropertyLike(\"t.name\", tag).ifPresent(criteria::add);\n+\t\t\thandleOrListParam(tag, (givenTag) -> Optional.of(eq(\"t.name\", givenTag.getValue()))).ifPresent(criteria::add);\n \t\t}\n \t}\n \t\n-\t// handle queries of the form /Location?partof=parent_name\n-\tprivate void handleParentLocation(Criteria criteria, StringParam parent) {\n+\tprivate void handleParentLocation(Criteria criteria, ReferenceOrListParam parent) {\n \t\tif (parent != null) {\n-\t\t\tProjectionList projList = Projections.projectionList();\n-\t\t\tprojList.add(Projections.property(\"locationId\"));\n-\t\t\t\n-\t\t\tCriteria criteriaForParent = this.sessionFactory.getCurrentSession().createCriteria(Location.class);\n-\t\t\tpropertyLike(\"name\", parent).ifPresent(criteriaForParent::add);\n-\t\t\t\n-\t\t\tSet<Object> possibleParentLocationIdList = new HashSet<>(criteriaForParent.setProjection(projList).list());\n-\t\t\t\n-\t\t\tcriteria.createCriteria(\"parentLocation\").add(in(\"locationId\", possibleParentLocationIdList));\n+\t\t\tDetachedCriteria criteriaForParent = DetachedCriteria.forClass(Location.class);\n+\t\t\thandleOrListParam(parent, this::handleParentReference).ifPresent(criteriaForParent::add);\n+\t\t\tcriteriaForParent.setProjection(Projections.property(\"locationId\"));\n+\t\t\tcriteria.add(Subqueries.propertyIn(\"parentLocation.locationId\", criteriaForParent));\n \t\t}\n \t}\n \t\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA4MTY1Nw==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/98#discussion_r387081657", "bodyText": "If you're going to do something like this, used DetachedCriteria instead of Criteria.", "author": "ibacher", "createdAt": "2020-03-03T15:05:50Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImpl.java", "diffHunk": "@@ -44,35 +53,93 @@ public Location getLocationByUuid(String uuid) {\n \t\treturn locationService.getLocationByUuid(uuid);\n \t}\n \t\n-\t@Override\n-\tpublic Collection<Location> findLocationByName(String name) {\n-\t\treturn locationService.getLocations(name);\n+\tprivate void handleName(Criteria criteria, StringParam namePattern) {\n+\t\tif (namePattern != null) {\n+\t\t\tpropertyLike(\"name\", namePattern).ifPresent(criteria::add);\n+\t\t}\n \t}\n \t\n-\t@Override\n-\tpublic Collection<Location> findLocationsByCity(String city) {\n-\t\treturn sessionFactory.getCurrentSession().createCriteria(Location.class).add(eq(\"cityVillage\", city)).list();\n+\tprivate void handleCity(Criteria criteria, StringParam city) {\n+\t\tif (city != null) {\n+\t\t\tpropertyLike(\"cityVillage\", city).ifPresent(criteria::add);\n+\t\t}\n \t}\n \t\n-\t@Override\n-\tpublic Collection<Location> findLocationsByCountry(String country) {\n-\t\treturn sessionFactory.getCurrentSession().createCriteria(Location.class).add(eq(\"country\", country)).list();\n+\tprivate void handleCountry(Criteria criteria, StringParam country) {\n+\t\tif (country != null) {\n+\t\t\tpropertyLike(\"country\", country).ifPresent(criteria::add);\n+\t\t}\n \t}\n \t\n-\t@Override\n-\tpublic Collection<Location> findLocationsByPostalCode(String postalCode) {\n-\t\treturn sessionFactory.getCurrentSession().createCriteria(Location.class).add(eq(\"postalCode\", postalCode)).list();\n+\tprivate void handlePostalCode(Criteria criteria, StringParam postalCode) {\n+\t\tif (postalCode != null) {\n+\t\t\tpropertyLike(\"postalCode\", postalCode).ifPresent(criteria::add);\n+\t\t}\n+\t}\n+\t\n+\tprivate void handleState(Criteria criteria, StringParam state) {\n+\t\tif (state != null) {\n+\t\t\tpropertyLike(\"stateProvince\", state).ifPresent(criteria::add);\n+\t\t}\n+\t}\n+\t\n+\tprivate void handleTag(Criteria criteria, TokenParam tag) {\n+\t\tif (tag != null) {\n+\t\t\tcriteria.createAlias(\"tags\", \"t\");\n+\t\t\tpropertyLike(\"t.name\", tag).ifPresent(criteria::add);\n+\t\t}\n+\t}\n+\t\n+\t// handle queries of the form /Location?partof=parent_name\n+\tprivate void handleParentLocation(Criteria criteria, StringParam parent) {\n+\t\tif (parent != null) {\n+\t\t\tProjectionList projList = Projections.projectionList();\n+\t\t\tprojList.add(Projections.property(\"locationId\"));\n+\t\t\t\n+\t\t\tCriteria criteriaForParent = this.sessionFactory.getCurrentSession().createCriteria(Location.class);", "originalCommit": "7187751292ff0c39a9a454e7ce9564acbff0b918", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c9cc6886767eda1994307473ea39527ab2208bd5", "chunk": "diff --git a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImpl.java b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImpl.java\nindex e1b65406..4ff2d73e 100644\n--- a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImpl.java\n+++ b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImpl.java\n\n@@ -50,58 +50,83 @@ public class FhirLocationDaoImpl extends BaseDaoImpl implements FhirLocationDao\n \t\n \t@Override\n \tpublic Location getLocationByUuid(String uuid) {\n-\t\treturn locationService.getLocationByUuid(uuid);\n+\t\treturn (Location) sessionFactory.getCurrentSession().createCriteria(Location.class).add(eq(\"uuid\", uuid))\n+\t\t        .uniqueResult();\n \t}\n \t\n-\tprivate void handleName(Criteria criteria, StringParam namePattern) {\n+\t@Override\n+\tpublic Collection<Location> searchForLocations(StringOrListParam name, StringOrListParam city, StringOrListParam country,\n+\t        StringOrListParam postalCode, StringOrListParam state, TokenOrListParam tag, ReferenceOrListParam parent,\n+\t        SortSpec sort) {\n+\t\t\n+\t\tCriteria criteria = this.sessionFactory.getCurrentSession().createCriteria(Location.class);\n+\t\thandleBooleanProperty(\"retired\", false).ifPresent(criteria::add);\n+\t\t\n+\t\thandleName(criteria, name);\n+\t\thandleCity(criteria, city);\n+\t\thandleCountry(criteria, country);\n+\t\thandlePostalCode(criteria, postalCode);\n+\t\thandleState(criteria, state);\n+\t\thandleTag(criteria, tag);\n+\t\thandleParentLocation(criteria, parent);\n+\t\thandleSort(criteria, sort);\n+\t\t\n+\t\treturn criteria.list();\n+\t}\n+\t\n+\t@Override\n+\tpublic List<LocationAttribute> getActiveAttributesByLocationAndAttributeTypeUuid(Location location,\n+\t        String locationAttributeTypeUuid) {\n+\t\treturn (List<LocationAttribute>) sessionFactory.getCurrentSession().createCriteria(LocationAttribute.class)\n+\t\t        .createAlias(\"location\", \"l\", JoinType.INNER_JOIN, eq(\"l.id\", location.getId()))\n+\t\t        .createAlias(\"attributeType\", \"lat\").add(eq(\"lat.uuid\", locationAttributeTypeUuid)).add(eq(\"voided\", false))\n+\t\t        .list();\n+\t}\n+\t\n+\tprivate void handleName(Criteria criteria, StringOrListParam namePattern) {\n \t\tif (namePattern != null) {\n-\t\t\tpropertyLike(\"name\", namePattern).ifPresent(criteria::add);\n+\t\t\thandleOrListParam(namePattern, (givenName) -> propertyLike(\"name\", givenName)).ifPresent(criteria::add);\n \t\t}\n \t}\n \t\n-\tprivate void handleCity(Criteria criteria, StringParam city) {\n+\tprivate void handleCity(Criteria criteria, StringOrListParam city) {\n \t\tif (city != null) {\n-\t\t\tpropertyLike(\"cityVillage\", city).ifPresent(criteria::add);\n+\t\t\thandleOrListParam(city, (givenCity) -> propertyLike(\"cityVillage\", givenCity)).ifPresent(criteria::add);\n \t\t}\n \t}\n \t\n-\tprivate void handleCountry(Criteria criteria, StringParam country) {\n+\tprivate void handleCountry(Criteria criteria, StringOrListParam country) {\n \t\tif (country != null) {\n-\t\t\tpropertyLike(\"country\", country).ifPresent(criteria::add);\n+\t\t\thandleOrListParam(country, (givenCountry) -> propertyLike(\"country\", givenCountry)).ifPresent(criteria::add);\n \t\t}\n \t}\n \t\n-\tprivate void handlePostalCode(Criteria criteria, StringParam postalCode) {\n+\tprivate void handlePostalCode(Criteria criteria, StringOrListParam postalCode) {\n \t\tif (postalCode != null) {\n-\t\t\tpropertyLike(\"postalCode\", postalCode).ifPresent(criteria::add);\n+\t\t\thandleOrListParam(postalCode, (givenPostalCode) -> propertyLike(\"postalCode\", givenPostalCode))\n+\t\t\t        .ifPresent(criteria::add);\n \t\t}\n \t}\n \t\n-\tprivate void handleState(Criteria criteria, StringParam state) {\n+\tprivate void handleState(Criteria criteria, StringOrListParam state) {\n \t\tif (state != null) {\n-\t\t\tpropertyLike(\"stateProvince\", state).ifPresent(criteria::add);\n+\t\t\thandleOrListParam(state, (givenState) -> propertyLike(\"stateProvince\", givenState)).ifPresent(criteria::add);\n \t\t}\n \t}\n \t\n-\tprivate void handleTag(Criteria criteria, TokenParam tag) {\n+\tprivate void handleTag(Criteria criteria, TokenOrListParam tag) {\n \t\tif (tag != null) {\n \t\t\tcriteria.createAlias(\"tags\", \"t\");\n-\t\t\tpropertyLike(\"t.name\", tag).ifPresent(criteria::add);\n+\t\t\thandleOrListParam(tag, (givenTag) -> Optional.of(eq(\"t.name\", givenTag.getValue()))).ifPresent(criteria::add);\n \t\t}\n \t}\n \t\n-\t// handle queries of the form /Location?partof=parent_name\n-\tprivate void handleParentLocation(Criteria criteria, StringParam parent) {\n+\tprivate void handleParentLocation(Criteria criteria, ReferenceOrListParam parent) {\n \t\tif (parent != null) {\n-\t\t\tProjectionList projList = Projections.projectionList();\n-\t\t\tprojList.add(Projections.property(\"locationId\"));\n-\t\t\t\n-\t\t\tCriteria criteriaForParent = this.sessionFactory.getCurrentSession().createCriteria(Location.class);\n-\t\t\tpropertyLike(\"name\", parent).ifPresent(criteriaForParent::add);\n-\t\t\t\n-\t\t\tSet<Object> possibleParentLocationIdList = new HashSet<>(criteriaForParent.setProjection(projList).list());\n-\t\t\t\n-\t\t\tcriteria.createCriteria(\"parentLocation\").add(in(\"locationId\", possibleParentLocationIdList));\n+\t\t\tDetachedCriteria criteriaForParent = DetachedCriteria.forClass(Location.class);\n+\t\t\thandleOrListParam(parent, this::handleParentReference).ifPresent(criteriaForParent::add);\n+\t\t\tcriteriaForParent.setProjection(Projections.property(\"locationId\"));\n+\t\t\tcriteria.add(Subqueries.propertyIn(\"parentLocation.locationId\", criteriaForParent));\n \t\t}\n \t}\n \t\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA4MjkwNQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/98#discussion_r387082905", "bodyText": "Instead of this:\ncriteriaForParent.setProjection(projectionList);\n\ncriteria.add(Subqueries.in(\"parent.locationId\", criteriaForParent));\nYour current implementation results in 2 db queries. This results in just one, which should be our goal.", "author": "ibacher", "createdAt": "2020-03-03T15:07:39Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImpl.java", "diffHunk": "@@ -44,35 +53,93 @@ public Location getLocationByUuid(String uuid) {\n \t\treturn locationService.getLocationByUuid(uuid);\n \t}\n \t\n-\t@Override\n-\tpublic Collection<Location> findLocationByName(String name) {\n-\t\treturn locationService.getLocations(name);\n+\tprivate void handleName(Criteria criteria, StringParam namePattern) {\n+\t\tif (namePattern != null) {\n+\t\t\tpropertyLike(\"name\", namePattern).ifPresent(criteria::add);\n+\t\t}\n \t}\n \t\n-\t@Override\n-\tpublic Collection<Location> findLocationsByCity(String city) {\n-\t\treturn sessionFactory.getCurrentSession().createCriteria(Location.class).add(eq(\"cityVillage\", city)).list();\n+\tprivate void handleCity(Criteria criteria, StringParam city) {\n+\t\tif (city != null) {\n+\t\t\tpropertyLike(\"cityVillage\", city).ifPresent(criteria::add);\n+\t\t}\n \t}\n \t\n-\t@Override\n-\tpublic Collection<Location> findLocationsByCountry(String country) {\n-\t\treturn sessionFactory.getCurrentSession().createCriteria(Location.class).add(eq(\"country\", country)).list();\n+\tprivate void handleCountry(Criteria criteria, StringParam country) {\n+\t\tif (country != null) {\n+\t\t\tpropertyLike(\"country\", country).ifPresent(criteria::add);\n+\t\t}\n \t}\n \t\n-\t@Override\n-\tpublic Collection<Location> findLocationsByPostalCode(String postalCode) {\n-\t\treturn sessionFactory.getCurrentSession().createCriteria(Location.class).add(eq(\"postalCode\", postalCode)).list();\n+\tprivate void handlePostalCode(Criteria criteria, StringParam postalCode) {\n+\t\tif (postalCode != null) {\n+\t\t\tpropertyLike(\"postalCode\", postalCode).ifPresent(criteria::add);\n+\t\t}\n+\t}\n+\t\n+\tprivate void handleState(Criteria criteria, StringParam state) {\n+\t\tif (state != null) {\n+\t\t\tpropertyLike(\"stateProvince\", state).ifPresent(criteria::add);\n+\t\t}\n+\t}\n+\t\n+\tprivate void handleTag(Criteria criteria, TokenParam tag) {\n+\t\tif (tag != null) {\n+\t\t\tcriteria.createAlias(\"tags\", \"t\");\n+\t\t\tpropertyLike(\"t.name\", tag).ifPresent(criteria::add);\n+\t\t}\n+\t}\n+\t\n+\t// handle queries of the form /Location?partof=parent_name\n+\tprivate void handleParentLocation(Criteria criteria, StringParam parent) {\n+\t\tif (parent != null) {\n+\t\t\tProjectionList projList = Projections.projectionList();\n+\t\t\tprojList.add(Projections.property(\"locationId\"));\n+\t\t\t\n+\t\t\tCriteria criteriaForParent = this.sessionFactory.getCurrentSession().createCriteria(Location.class);\n+\t\t\tpropertyLike(\"name\", parent).ifPresent(criteriaForParent::add);\n+\t\t\t\n+\t\t\tSet<Object> possibleParentLocationIdList = new HashSet<>(criteriaForParent.setProjection(projList).list());", "originalCommit": "7187751292ff0c39a9a454e7ce9564acbff0b918", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM4ODcxOQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/98#discussion_r389388719", "bodyText": "I was stuck on this for a while because we need to use \"Subqueries.propertyIn\" and not \"Subqueries.in\" as the test was failing repeatedly. Thanks for the hint though :)", "author": "varung-31", "createdAt": "2020-03-08T17:20:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA4MjkwNQ=="}], "type": "inlineReview", "revised_code": {"commit": "c9cc6886767eda1994307473ea39527ab2208bd5", "chunk": "diff --git a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImpl.java b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImpl.java\nindex e1b65406..4ff2d73e 100644\n--- a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImpl.java\n+++ b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImpl.java\n\n@@ -50,58 +50,83 @@ public class FhirLocationDaoImpl extends BaseDaoImpl implements FhirLocationDao\n \t\n \t@Override\n \tpublic Location getLocationByUuid(String uuid) {\n-\t\treturn locationService.getLocationByUuid(uuid);\n+\t\treturn (Location) sessionFactory.getCurrentSession().createCriteria(Location.class).add(eq(\"uuid\", uuid))\n+\t\t        .uniqueResult();\n \t}\n \t\n-\tprivate void handleName(Criteria criteria, StringParam namePattern) {\n+\t@Override\n+\tpublic Collection<Location> searchForLocations(StringOrListParam name, StringOrListParam city, StringOrListParam country,\n+\t        StringOrListParam postalCode, StringOrListParam state, TokenOrListParam tag, ReferenceOrListParam parent,\n+\t        SortSpec sort) {\n+\t\t\n+\t\tCriteria criteria = this.sessionFactory.getCurrentSession().createCriteria(Location.class);\n+\t\thandleBooleanProperty(\"retired\", false).ifPresent(criteria::add);\n+\t\t\n+\t\thandleName(criteria, name);\n+\t\thandleCity(criteria, city);\n+\t\thandleCountry(criteria, country);\n+\t\thandlePostalCode(criteria, postalCode);\n+\t\thandleState(criteria, state);\n+\t\thandleTag(criteria, tag);\n+\t\thandleParentLocation(criteria, parent);\n+\t\thandleSort(criteria, sort);\n+\t\t\n+\t\treturn criteria.list();\n+\t}\n+\t\n+\t@Override\n+\tpublic List<LocationAttribute> getActiveAttributesByLocationAndAttributeTypeUuid(Location location,\n+\t        String locationAttributeTypeUuid) {\n+\t\treturn (List<LocationAttribute>) sessionFactory.getCurrentSession().createCriteria(LocationAttribute.class)\n+\t\t        .createAlias(\"location\", \"l\", JoinType.INNER_JOIN, eq(\"l.id\", location.getId()))\n+\t\t        .createAlias(\"attributeType\", \"lat\").add(eq(\"lat.uuid\", locationAttributeTypeUuid)).add(eq(\"voided\", false))\n+\t\t        .list();\n+\t}\n+\t\n+\tprivate void handleName(Criteria criteria, StringOrListParam namePattern) {\n \t\tif (namePattern != null) {\n-\t\t\tpropertyLike(\"name\", namePattern).ifPresent(criteria::add);\n+\t\t\thandleOrListParam(namePattern, (givenName) -> propertyLike(\"name\", givenName)).ifPresent(criteria::add);\n \t\t}\n \t}\n \t\n-\tprivate void handleCity(Criteria criteria, StringParam city) {\n+\tprivate void handleCity(Criteria criteria, StringOrListParam city) {\n \t\tif (city != null) {\n-\t\t\tpropertyLike(\"cityVillage\", city).ifPresent(criteria::add);\n+\t\t\thandleOrListParam(city, (givenCity) -> propertyLike(\"cityVillage\", givenCity)).ifPresent(criteria::add);\n \t\t}\n \t}\n \t\n-\tprivate void handleCountry(Criteria criteria, StringParam country) {\n+\tprivate void handleCountry(Criteria criteria, StringOrListParam country) {\n \t\tif (country != null) {\n-\t\t\tpropertyLike(\"country\", country).ifPresent(criteria::add);\n+\t\t\thandleOrListParam(country, (givenCountry) -> propertyLike(\"country\", givenCountry)).ifPresent(criteria::add);\n \t\t}\n \t}\n \t\n-\tprivate void handlePostalCode(Criteria criteria, StringParam postalCode) {\n+\tprivate void handlePostalCode(Criteria criteria, StringOrListParam postalCode) {\n \t\tif (postalCode != null) {\n-\t\t\tpropertyLike(\"postalCode\", postalCode).ifPresent(criteria::add);\n+\t\t\thandleOrListParam(postalCode, (givenPostalCode) -> propertyLike(\"postalCode\", givenPostalCode))\n+\t\t\t        .ifPresent(criteria::add);\n \t\t}\n \t}\n \t\n-\tprivate void handleState(Criteria criteria, StringParam state) {\n+\tprivate void handleState(Criteria criteria, StringOrListParam state) {\n \t\tif (state != null) {\n-\t\t\tpropertyLike(\"stateProvince\", state).ifPresent(criteria::add);\n+\t\t\thandleOrListParam(state, (givenState) -> propertyLike(\"stateProvince\", givenState)).ifPresent(criteria::add);\n \t\t}\n \t}\n \t\n-\tprivate void handleTag(Criteria criteria, TokenParam tag) {\n+\tprivate void handleTag(Criteria criteria, TokenOrListParam tag) {\n \t\tif (tag != null) {\n \t\t\tcriteria.createAlias(\"tags\", \"t\");\n-\t\t\tpropertyLike(\"t.name\", tag).ifPresent(criteria::add);\n+\t\t\thandleOrListParam(tag, (givenTag) -> Optional.of(eq(\"t.name\", givenTag.getValue()))).ifPresent(criteria::add);\n \t\t}\n \t}\n \t\n-\t// handle queries of the form /Location?partof=parent_name\n-\tprivate void handleParentLocation(Criteria criteria, StringParam parent) {\n+\tprivate void handleParentLocation(Criteria criteria, ReferenceOrListParam parent) {\n \t\tif (parent != null) {\n-\t\t\tProjectionList projList = Projections.projectionList();\n-\t\t\tprojList.add(Projections.property(\"locationId\"));\n-\t\t\t\n-\t\t\tCriteria criteriaForParent = this.sessionFactory.getCurrentSession().createCriteria(Location.class);\n-\t\t\tpropertyLike(\"name\", parent).ifPresent(criteriaForParent::add);\n-\t\t\t\n-\t\t\tSet<Object> possibleParentLocationIdList = new HashSet<>(criteriaForParent.setProjection(projList).list());\n-\t\t\t\n-\t\t\tcriteria.createCriteria(\"parentLocation\").add(in(\"locationId\", possibleParentLocationIdList));\n+\t\t\tDetachedCriteria criteriaForParent = DetachedCriteria.forClass(Location.class);\n+\t\t\thandleOrListParam(parent, this::handleParentReference).ifPresent(criteriaForParent::add);\n+\t\t\tcriteriaForParent.setProjection(Projections.property(\"locationId\"));\n+\t\t\tcriteria.add(Subqueries.propertyIn(\"parentLocation.locationId\", criteriaForParent));\n \t\t}\n \t}\n \t\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA4MzQyNQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/98#discussion_r387083425", "bodyText": "private LocationService locationService", "author": "ibacher", "createdAt": "2020-03-03T15:08:25Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImpl.java", "diffHunk": "@@ -30,7 +39,7 @@\n \n @Component\n @Setter(AccessLevel.PACKAGE)\n-public class FhirLocationDaoImpl implements FhirLocationDao {\n+public class FhirLocationDaoImpl extends BaseDaoImpl implements FhirLocationDao {\n \t\n \t@Inject\n \tLocationService locationService;", "originalCommit": "7187751292ff0c39a9a454e7ce9564acbff0b918", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c9cc6886767eda1994307473ea39527ab2208bd5", "chunk": "diff --git a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImpl.java b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImpl.java\nindex e1b65406..4ff2d73e 100644\n--- a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImpl.java\n+++ b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImpl.java\n\n@@ -42,7 +42,7 @@ import org.springframework.stereotype.Component;\n public class FhirLocationDaoImpl extends BaseDaoImpl implements FhirLocationDao {\n \t\n \t@Inject\n-\tLocationService locationService;\n+\tprivate LocationService locationService;\n \t\n \t@Inject\n \t@Named(\"sessionFactory\")\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA4MzYxNQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/98#discussion_r387083615", "bodyText": "As this is a public method, it should be near the top of the class.", "author": "ibacher", "createdAt": "2020-03-03T15:08:42Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImpl.java", "diffHunk": "@@ -44,35 +53,93 @@ public Location getLocationByUuid(String uuid) {\n \t\treturn locationService.getLocationByUuid(uuid);\n \t}\n \t\n-\t@Override\n-\tpublic Collection<Location> findLocationByName(String name) {\n-\t\treturn locationService.getLocations(name);\n+\tprivate void handleName(Criteria criteria, StringParam namePattern) {\n+\t\tif (namePattern != null) {\n+\t\t\tpropertyLike(\"name\", namePattern).ifPresent(criteria::add);\n+\t\t}\n \t}\n \t\n-\t@Override\n-\tpublic Collection<Location> findLocationsByCity(String city) {\n-\t\treturn sessionFactory.getCurrentSession().createCriteria(Location.class).add(eq(\"cityVillage\", city)).list();\n+\tprivate void handleCity(Criteria criteria, StringParam city) {\n+\t\tif (city != null) {\n+\t\t\tpropertyLike(\"cityVillage\", city).ifPresent(criteria::add);\n+\t\t}\n \t}\n \t\n-\t@Override\n-\tpublic Collection<Location> findLocationsByCountry(String country) {\n-\t\treturn sessionFactory.getCurrentSession().createCriteria(Location.class).add(eq(\"country\", country)).list();\n+\tprivate void handleCountry(Criteria criteria, StringParam country) {\n+\t\tif (country != null) {\n+\t\t\tpropertyLike(\"country\", country).ifPresent(criteria::add);\n+\t\t}\n \t}\n \t\n-\t@Override\n-\tpublic Collection<Location> findLocationsByPostalCode(String postalCode) {\n-\t\treturn sessionFactory.getCurrentSession().createCriteria(Location.class).add(eq(\"postalCode\", postalCode)).list();\n+\tprivate void handlePostalCode(Criteria criteria, StringParam postalCode) {\n+\t\tif (postalCode != null) {\n+\t\t\tpropertyLike(\"postalCode\", postalCode).ifPresent(criteria::add);\n+\t\t}\n+\t}\n+\t\n+\tprivate void handleState(Criteria criteria, StringParam state) {\n+\t\tif (state != null) {\n+\t\t\tpropertyLike(\"stateProvince\", state).ifPresent(criteria::add);\n+\t\t}\n+\t}\n+\t\n+\tprivate void handleTag(Criteria criteria, TokenParam tag) {\n+\t\tif (tag != null) {\n+\t\t\tcriteria.createAlias(\"tags\", \"t\");\n+\t\t\tpropertyLike(\"t.name\", tag).ifPresent(criteria::add);\n+\t\t}\n+\t}\n+\t\n+\t// handle queries of the form /Location?partof=parent_name\n+\tprivate void handleParentLocation(Criteria criteria, StringParam parent) {\n+\t\tif (parent != null) {\n+\t\t\tProjectionList projList = Projections.projectionList();\n+\t\t\tprojList.add(Projections.property(\"locationId\"));\n+\t\t\t\n+\t\t\tCriteria criteriaForParent = this.sessionFactory.getCurrentSession().createCriteria(Location.class);\n+\t\t\tpropertyLike(\"name\", parent).ifPresent(criteriaForParent::add);\n+\t\t\t\n+\t\t\tSet<Object> possibleParentLocationIdList = new HashSet<>(criteriaForParent.setProjection(projList).list());\n+\t\t\t\n+\t\t\tcriteria.createCriteria(\"parentLocation\").add(in(\"locationId\", possibleParentLocationIdList));\n+\t\t}\n \t}\n \t\n \t@Override\n-\tpublic Collection<Location> findLocationsByState(String state) {\n-\t\treturn sessionFactory.getCurrentSession().createCriteria(Location.class).add(eq(\"stateProvince\", state)).list();\n+\tprotected String paramToProp(@NotNull String paramName) {\n+\t\tswitch (paramName) {\n+\t\t\tcase \"name\":\n+\t\t\t\treturn \"name\";\n+\t\t\tcase \"address-city\":\n+\t\t\t\treturn \"cityVillage\";\n+\t\t\tcase \"address-state\":\n+\t\t\t\treturn \"stateProvince\";\n+\t\t\tcase \"address-country\":\n+\t\t\t\treturn \"country\";\n+\t\t\tcase \"address-postalCode\":\n+\t\t\t\treturn \"postalCode\";\n+\t\t\tdefault:\n+\t\t\t\treturn null;\n+\t\t}\n \t}\n \t\n \t@Override\n-\tpublic Collection<Location> findLocationsByTag(TokenParam tag) {\n-\t\treturn sessionFactory.getCurrentSession().createCriteria(Location.class).createAlias(\"tags\", \"t\")\n-\t\t        .add(eq(\"t.name\", tag.getValue())).list();\n+\tpublic Collection<Location> searchForLocations(StringParam name, StringParam city, StringParam country,", "originalCommit": "7187751292ff0c39a9a454e7ce9564acbff0b918", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c9cc6886767eda1994307473ea39527ab2208bd5", "chunk": "diff --git a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImpl.java b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImpl.java\nindex e1b65406..4ff2d73e 100644\n--- a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImpl.java\n+++ b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImpl.java\n\n@@ -50,58 +50,83 @@ public class FhirLocationDaoImpl extends BaseDaoImpl implements FhirLocationDao\n \t\n \t@Override\n \tpublic Location getLocationByUuid(String uuid) {\n-\t\treturn locationService.getLocationByUuid(uuid);\n+\t\treturn (Location) sessionFactory.getCurrentSession().createCriteria(Location.class).add(eq(\"uuid\", uuid))\n+\t\t        .uniqueResult();\n \t}\n \t\n-\tprivate void handleName(Criteria criteria, StringParam namePattern) {\n+\t@Override\n+\tpublic Collection<Location> searchForLocations(StringOrListParam name, StringOrListParam city, StringOrListParam country,\n+\t        StringOrListParam postalCode, StringOrListParam state, TokenOrListParam tag, ReferenceOrListParam parent,\n+\t        SortSpec sort) {\n+\t\t\n+\t\tCriteria criteria = this.sessionFactory.getCurrentSession().createCriteria(Location.class);\n+\t\thandleBooleanProperty(\"retired\", false).ifPresent(criteria::add);\n+\t\t\n+\t\thandleName(criteria, name);\n+\t\thandleCity(criteria, city);\n+\t\thandleCountry(criteria, country);\n+\t\thandlePostalCode(criteria, postalCode);\n+\t\thandleState(criteria, state);\n+\t\thandleTag(criteria, tag);\n+\t\thandleParentLocation(criteria, parent);\n+\t\thandleSort(criteria, sort);\n+\t\t\n+\t\treturn criteria.list();\n+\t}\n+\t\n+\t@Override\n+\tpublic List<LocationAttribute> getActiveAttributesByLocationAndAttributeTypeUuid(Location location,\n+\t        String locationAttributeTypeUuid) {\n+\t\treturn (List<LocationAttribute>) sessionFactory.getCurrentSession().createCriteria(LocationAttribute.class)\n+\t\t        .createAlias(\"location\", \"l\", JoinType.INNER_JOIN, eq(\"l.id\", location.getId()))\n+\t\t        .createAlias(\"attributeType\", \"lat\").add(eq(\"lat.uuid\", locationAttributeTypeUuid)).add(eq(\"voided\", false))\n+\t\t        .list();\n+\t}\n+\t\n+\tprivate void handleName(Criteria criteria, StringOrListParam namePattern) {\n \t\tif (namePattern != null) {\n-\t\t\tpropertyLike(\"name\", namePattern).ifPresent(criteria::add);\n+\t\t\thandleOrListParam(namePattern, (givenName) -> propertyLike(\"name\", givenName)).ifPresent(criteria::add);\n \t\t}\n \t}\n \t\n-\tprivate void handleCity(Criteria criteria, StringParam city) {\n+\tprivate void handleCity(Criteria criteria, StringOrListParam city) {\n \t\tif (city != null) {\n-\t\t\tpropertyLike(\"cityVillage\", city).ifPresent(criteria::add);\n+\t\t\thandleOrListParam(city, (givenCity) -> propertyLike(\"cityVillage\", givenCity)).ifPresent(criteria::add);\n \t\t}\n \t}\n \t\n-\tprivate void handleCountry(Criteria criteria, StringParam country) {\n+\tprivate void handleCountry(Criteria criteria, StringOrListParam country) {\n \t\tif (country != null) {\n-\t\t\tpropertyLike(\"country\", country).ifPresent(criteria::add);\n+\t\t\thandleOrListParam(country, (givenCountry) -> propertyLike(\"country\", givenCountry)).ifPresent(criteria::add);\n \t\t}\n \t}\n \t\n-\tprivate void handlePostalCode(Criteria criteria, StringParam postalCode) {\n+\tprivate void handlePostalCode(Criteria criteria, StringOrListParam postalCode) {\n \t\tif (postalCode != null) {\n-\t\t\tpropertyLike(\"postalCode\", postalCode).ifPresent(criteria::add);\n+\t\t\thandleOrListParam(postalCode, (givenPostalCode) -> propertyLike(\"postalCode\", givenPostalCode))\n+\t\t\t        .ifPresent(criteria::add);\n \t\t}\n \t}\n \t\n-\tprivate void handleState(Criteria criteria, StringParam state) {\n+\tprivate void handleState(Criteria criteria, StringOrListParam state) {\n \t\tif (state != null) {\n-\t\t\tpropertyLike(\"stateProvince\", state).ifPresent(criteria::add);\n+\t\t\thandleOrListParam(state, (givenState) -> propertyLike(\"stateProvince\", givenState)).ifPresent(criteria::add);\n \t\t}\n \t}\n \t\n-\tprivate void handleTag(Criteria criteria, TokenParam tag) {\n+\tprivate void handleTag(Criteria criteria, TokenOrListParam tag) {\n \t\tif (tag != null) {\n \t\t\tcriteria.createAlias(\"tags\", \"t\");\n-\t\t\tpropertyLike(\"t.name\", tag).ifPresent(criteria::add);\n+\t\t\thandleOrListParam(tag, (givenTag) -> Optional.of(eq(\"t.name\", givenTag.getValue()))).ifPresent(criteria::add);\n \t\t}\n \t}\n \t\n-\t// handle queries of the form /Location?partof=parent_name\n-\tprivate void handleParentLocation(Criteria criteria, StringParam parent) {\n+\tprivate void handleParentLocation(Criteria criteria, ReferenceOrListParam parent) {\n \t\tif (parent != null) {\n-\t\t\tProjectionList projList = Projections.projectionList();\n-\t\t\tprojList.add(Projections.property(\"locationId\"));\n-\t\t\t\n-\t\t\tCriteria criteriaForParent = this.sessionFactory.getCurrentSession().createCriteria(Location.class);\n-\t\t\tpropertyLike(\"name\", parent).ifPresent(criteriaForParent::add);\n-\t\t\t\n-\t\t\tSet<Object> possibleParentLocationIdList = new HashSet<>(criteriaForParent.setProjection(projList).list());\n-\t\t\t\n-\t\t\tcriteria.createCriteria(\"parentLocation\").add(in(\"locationId\", possibleParentLocationIdList));\n+\t\t\tDetachedCriteria criteriaForParent = DetachedCriteria.forClass(Location.class);\n+\t\t\thandleOrListParam(parent, this::handleParentReference).ifPresent(criteriaForParent::add);\n+\t\t\tcriteriaForParent.setProjection(Projections.property(\"locationId\"));\n+\t\t\tcriteria.add(Subqueries.propertyIn(\"parentLocation.locationId\", criteriaForParent));\n \t\t}\n \t}\n \t\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA4NDIxMg==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/98#discussion_r387084212", "bodyText": "These should be StringOrListParams", "author": "ibacher", "createdAt": "2020-03-03T15:09:37Z", "path": "omod/src/main/java/org/openmrs/module/fhir2/providers/LocationFhirResourceProvider.java", "diffHunk": "@@ -56,37 +58,13 @@ public Location getLocationById(@IdParam @NotNull IdType id) {\n \t\n \t@Search\n \t@SuppressWarnings(\"unused\")\n-\tpublic Bundle findLocationByName(@RequiredParam(name = Location.SP_NAME) StringParam name) {\n-\t\treturn FhirUtils.convertSearchResultsToBundle(fhirLocationService.findLocationByName(name.getValue()));\n-\t}\n-\t\n-\t@Search\n-\t@SuppressWarnings(\"unused\")\n-\tpublic Bundle findLocationByCity(@RequiredParam(name = Location.SP_ADDRESS_CITY) StringParam city) {\n-\t\treturn FhirUtils.convertSearchResultsToBundle(fhirLocationService.findLocationsByCity(city.getValue()));\n-\t}\n-\t\n-\t@Search\n-\t@SuppressWarnings(\"unused\")\n-\tpublic Bundle findLocationByCountry(@RequiredParam(name = Location.SP_ADDRESS_COUNTRY) StringParam country) {\n-\t\treturn FhirUtils.convertSearchResultsToBundle(fhirLocationService.findLocationsByCountry(country.getValue()));\n-\t}\n-\t\n-\t@Search\n-\t@SuppressWarnings(\"unused\")\n-\tpublic Bundle findLocationByPostalCode(@RequiredParam(name = Location.SP_ADDRESS_POSTALCODE) StringParam postalCode) {\n-\t\treturn FhirUtils.convertSearchResultsToBundle(fhirLocationService.findLocationsByPostalCode(postalCode.getValue()));\n-\t}\n-\t\n-\t@Search\n-\t@SuppressWarnings(\"unused\")\n-\tpublic Bundle findLocationByState(@RequiredParam(name = Location.SP_ADDRESS_STATE) StringParam state) {\n-\t\treturn FhirUtils.convertSearchResultsToBundle(fhirLocationService.findLocationsByState(state.getValue()));\n-\t}\n-\t\n-\t@Search\n-\t@SuppressWarnings(\"unused\")\n-\tpublic Bundle findLocationsByTag(@RequiredParam(name = \"_tag\") TokenParam tag) {\n-\t\treturn FhirUtils.convertSearchResultsToBundle(fhirLocationService.findLocationsByTag(tag));\n+\tpublic Bundle searchLocations(@OptionalParam(name = Location.SP_NAME) StringParam name,", "originalCommit": "7187751292ff0c39a9a454e7ce9564acbff0b918", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c9cc6886767eda1994307473ea39527ab2208bd5", "chunk": "diff --git a/omod/src/main/java/org/openmrs/module/fhir2/providers/LocationFhirResourceProvider.java b/omod/src/main/java/org/openmrs/module/fhir2/providers/LocationFhirResourceProvider.java\nindex 2e43ada2..01012007 100644\n--- a/omod/src/main/java/org/openmrs/module/fhir2/providers/LocationFhirResourceProvider.java\n+++ b/omod/src/main/java/org/openmrs/module/fhir2/providers/LocationFhirResourceProvider.java\n\n@@ -55,16 +62,26 @@ public class LocationFhirResourceProvider implements IResourceProvider {\n \t\t}\n \t\treturn location;\n \t}\n-\t\n-\t@Search\n+\n+\t@History\n \t@SuppressWarnings(\"unused\")\n-\tpublic Bundle searchLocations(@OptionalParam(name = Location.SP_NAME) StringParam name,\n-\t        @OptionalParam(name = Location.SP_ADDRESS_CITY) StringParam city,\n-\t        @OptionalParam(name = Location.SP_ADDRESS_COUNTRY) StringParam country,\n-\t        @OptionalParam(name = Location.SP_ADDRESS_POSTALCODE) StringParam postalCode,\n-\t        @OptionalParam(name = Location.SP_ADDRESS_STATE) StringParam state, @OptionalParam(name = \"_tag\") TokenParam tag,\n-\t        @OptionalParam(name = Location.SP_PARTOF) StringParam parent, @Sort SortSpec sort) {\n-\t\treturn FhirUtils.convertSearchResultsToBundle(\n+\tpublic List<Resource> getLocationHistoryById(@IdParam @NotNull IdType id) {\n+\t\tLocation location = fhirLocationService.getLocationByUuid(id.getIdPart());\n+\t\tif (location == null) {\n+\t\t\tthrow new ResourceNotFoundException(\"Could not find location with Id \" + id.getIdPart());\n+\t\t}\n+\t\treturn location.getContained();\n+\t}\n+\n+\t@Search\n+\tpublic Bundle searchLocations(@OptionalParam(name = Location.SP_NAME) StringOrListParam name,\n+\t        @OptionalParam(name = Location.SP_ADDRESS_CITY) StringOrListParam city,\n+\t        @OptionalParam(name = Location.SP_ADDRESS_COUNTRY) StringOrListParam country,\n+\t        @OptionalParam(name = Location.SP_ADDRESS_POSTALCODE) StringOrListParam postalCode,\n+\t        @OptionalParam(name = Location.SP_ADDRESS_STATE) StringOrListParam state,\n+\t        @OptionalParam(name = PARAM_TAG) TokenOrListParam tag,\n+\t        @OptionalParam(name = Location.SP_PARTOF) ReferenceOrListParam parent, @Sort SortSpec sort) {\n+\t\treturn FhirServerUtils.convertSearchResultsToBundle(\n \t\t    fhirLocationService.searchForLocations(name, city, country, postalCode, state, tag, parent, sort));\n \t}\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA4NDY3OA==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/98#discussion_r387084678", "bodyText": "This should be a ReferenceParam or, better, a ReferenceOrListParam. Note you can add searches for additional properties as we do for Patient elsewhere.", "author": "ibacher", "createdAt": "2020-03-03T15:10:19Z", "path": "omod/src/main/java/org/openmrs/module/fhir2/providers/LocationFhirResourceProvider.java", "diffHunk": "@@ -56,37 +58,13 @@ public Location getLocationById(@IdParam @NotNull IdType id) {\n \t\n \t@Search\n \t@SuppressWarnings(\"unused\")\n-\tpublic Bundle findLocationByName(@RequiredParam(name = Location.SP_NAME) StringParam name) {\n-\t\treturn FhirUtils.convertSearchResultsToBundle(fhirLocationService.findLocationByName(name.getValue()));\n-\t}\n-\t\n-\t@Search\n-\t@SuppressWarnings(\"unused\")\n-\tpublic Bundle findLocationByCity(@RequiredParam(name = Location.SP_ADDRESS_CITY) StringParam city) {\n-\t\treturn FhirUtils.convertSearchResultsToBundle(fhirLocationService.findLocationsByCity(city.getValue()));\n-\t}\n-\t\n-\t@Search\n-\t@SuppressWarnings(\"unused\")\n-\tpublic Bundle findLocationByCountry(@RequiredParam(name = Location.SP_ADDRESS_COUNTRY) StringParam country) {\n-\t\treturn FhirUtils.convertSearchResultsToBundle(fhirLocationService.findLocationsByCountry(country.getValue()));\n-\t}\n-\t\n-\t@Search\n-\t@SuppressWarnings(\"unused\")\n-\tpublic Bundle findLocationByPostalCode(@RequiredParam(name = Location.SP_ADDRESS_POSTALCODE) StringParam postalCode) {\n-\t\treturn FhirUtils.convertSearchResultsToBundle(fhirLocationService.findLocationsByPostalCode(postalCode.getValue()));\n-\t}\n-\t\n-\t@Search\n-\t@SuppressWarnings(\"unused\")\n-\tpublic Bundle findLocationByState(@RequiredParam(name = Location.SP_ADDRESS_STATE) StringParam state) {\n-\t\treturn FhirUtils.convertSearchResultsToBundle(fhirLocationService.findLocationsByState(state.getValue()));\n-\t}\n-\t\n-\t@Search\n-\t@SuppressWarnings(\"unused\")\n-\tpublic Bundle findLocationsByTag(@RequiredParam(name = \"_tag\") TokenParam tag) {\n-\t\treturn FhirUtils.convertSearchResultsToBundle(fhirLocationService.findLocationsByTag(tag));\n+\tpublic Bundle searchLocations(@OptionalParam(name = Location.SP_NAME) StringParam name,\n+\t        @OptionalParam(name = Location.SP_ADDRESS_CITY) StringParam city,\n+\t        @OptionalParam(name = Location.SP_ADDRESS_COUNTRY) StringParam country,\n+\t        @OptionalParam(name = Location.SP_ADDRESS_POSTALCODE) StringParam postalCode,\n+\t        @OptionalParam(name = Location.SP_ADDRESS_STATE) StringParam state, @OptionalParam(name = \"_tag\") TokenParam tag,\n+\t        @OptionalParam(name = Location.SP_PARTOF) StringParam parent, @Sort SortSpec sort) {", "originalCommit": "7187751292ff0c39a9a454e7ce9564acbff0b918", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c9cc6886767eda1994307473ea39527ab2208bd5", "chunk": "diff --git a/omod/src/main/java/org/openmrs/module/fhir2/providers/LocationFhirResourceProvider.java b/omod/src/main/java/org/openmrs/module/fhir2/providers/LocationFhirResourceProvider.java\nindex 2e43ada2..01012007 100644\n--- a/omod/src/main/java/org/openmrs/module/fhir2/providers/LocationFhirResourceProvider.java\n+++ b/omod/src/main/java/org/openmrs/module/fhir2/providers/LocationFhirResourceProvider.java\n\n@@ -55,16 +62,26 @@ public class LocationFhirResourceProvider implements IResourceProvider {\n \t\t}\n \t\treturn location;\n \t}\n-\t\n-\t@Search\n+\n+\t@History\n \t@SuppressWarnings(\"unused\")\n-\tpublic Bundle searchLocations(@OptionalParam(name = Location.SP_NAME) StringParam name,\n-\t        @OptionalParam(name = Location.SP_ADDRESS_CITY) StringParam city,\n-\t        @OptionalParam(name = Location.SP_ADDRESS_COUNTRY) StringParam country,\n-\t        @OptionalParam(name = Location.SP_ADDRESS_POSTALCODE) StringParam postalCode,\n-\t        @OptionalParam(name = Location.SP_ADDRESS_STATE) StringParam state, @OptionalParam(name = \"_tag\") TokenParam tag,\n-\t        @OptionalParam(name = Location.SP_PARTOF) StringParam parent, @Sort SortSpec sort) {\n-\t\treturn FhirUtils.convertSearchResultsToBundle(\n+\tpublic List<Resource> getLocationHistoryById(@IdParam @NotNull IdType id) {\n+\t\tLocation location = fhirLocationService.getLocationByUuid(id.getIdPart());\n+\t\tif (location == null) {\n+\t\t\tthrow new ResourceNotFoundException(\"Could not find location with Id \" + id.getIdPart());\n+\t\t}\n+\t\treturn location.getContained();\n+\t}\n+\n+\t@Search\n+\tpublic Bundle searchLocations(@OptionalParam(name = Location.SP_NAME) StringOrListParam name,\n+\t        @OptionalParam(name = Location.SP_ADDRESS_CITY) StringOrListParam city,\n+\t        @OptionalParam(name = Location.SP_ADDRESS_COUNTRY) StringOrListParam country,\n+\t        @OptionalParam(name = Location.SP_ADDRESS_POSTALCODE) StringOrListParam postalCode,\n+\t        @OptionalParam(name = Location.SP_ADDRESS_STATE) StringOrListParam state,\n+\t        @OptionalParam(name = PARAM_TAG) TokenOrListParam tag,\n+\t        @OptionalParam(name = Location.SP_PARTOF) ReferenceOrListParam parent, @Sort SortSpec sort) {\n+\t\treturn FhirServerUtils.convertSearchResultsToBundle(\n \t\t    fhirLocationService.searchForLocations(name, city, country, postalCode, state, tag, parent, sort));\n \t}\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMwMzg5Mw==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/98#discussion_r389303893", "bodyText": "@varung-31 I would suggest you to add some more tests here to confirm that the method is working in the desired manner. For example\n\t\tassertThat(locations.iterator().next().getCityVillage(),equalTo(LOCATION_CITY));\n\n@ibacher Please have a say on this", "author": "VaishSiddharth", "createdAt": "2020-03-07T18:54:54Z", "path": "api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImplTest.java", "diffHunk": "@@ -101,91 +113,140 @@ public void getLocationByUuid_shouldReturnNullWithUnknownUuid() {\n \t}\n \t\n \t@Test\n-\tpublic void findLocationByName_shouldReturnCorrectLocation() {\n-\t\tCollection<Location> locations = fhirLocationDao.findLocationByName(LOCATION_NAME);\n+\tpublic void searchForLocations_shouldReturnCorrectLocationByName() {\n+\t\tStringParam location = new StringParam();\n+\t\tlocation.setValue(LOCATION_NAME);\n+\t\tCollection<Location> locations = fhirLocationDao.searchForLocations(location, null, null, null, null, null, null,\n+\t\t    null);\n \t\t\n \t\tassertThat(locations, notNullValue());\n \t\tassertThat(locations.size(), equalTo(1));\n \t}\n \t\n \t@Test\n-\tpublic void findLocationByName_shouldReturnEmptyCollectionWhenCalledWithUnknownName() {\n-\t\tCollection<Location> locations = fhirLocationDao.findLocationByName(UNKNOWN_LOCATION_NAME);\n+\tpublic void searchForLocations_shouldReturnEmptyCollectionWhenCalledWithUnknownName() {\n+\t\tStringParam location = new StringParam();\n+\t\tlocation.setValue(UNKNOWN_LOCATION_NAME);\n+\t\tCollection<Location> locations = fhirLocationDao.searchForLocations(location, null, null, null, null, null, null,\n+\t\t    null);\n \t\t\n \t\tassertThat(locations, notNullValue());\n \t\tassertThat(locations.size(), equalTo(0));\n \t}\n \t\n \t@Test\n-\tpublic void findLocationByCity_shouldReturnCorrectLocation() {\n-\t\tCollection<Location> locations = fhirLocationDao.findLocationsByCity(LOCATION_CITY);\n+\tpublic void searchForLocations_shouldReturnCorrectLocationByCity() {\n+\t\tStringParam city = new StringParam();\n+\t\tcity.setValue(LOCATION_CITY);\n+\t\tCollection<Location> locations = fhirLocationDao.searchForLocations(null, city, null, null, null, null, null, null);\n \t\t\n \t\tassertThat(locations, notNullValue());\n-\t\tassertThat(locations.size(), greaterThanOrEqualTo(1));\n+\t\tassertThat(locations.size(), equalTo(1));", "originalCommit": "7187751292ff0c39a9a454e7ce9564acbff0b918", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM1MDQ0NA==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/98#discussion_r389350444", "bodyText": "I've noticed these in few other tests as well, shouldn't every resource item be tested to see if contains the correct value according to the search query?", "author": "CaptainDaVinci", "createdAt": "2020-03-08T09:13:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMwMzg5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM1NTgzMw==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/98#discussion_r389355833", "bodyText": "Yes every test should check according to query where every possible", "author": "VaishSiddharth", "createdAt": "2020-03-08T10:29:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMwMzg5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDI4MTYzMQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/98#discussion_r390281631", "bodyText": "I concur with @VaishSiddharth here and elsewhere. We should be checking that the property we're querying by is in the actual results.", "author": "ibacher", "createdAt": "2020-03-10T12:35:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMwMzg5Mw=="}], "type": "inlineReview", "revised_code": {"commit": "c9cc6886767eda1994307473ea39527ab2208bd5", "chunk": "diff --git a/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImplTest.java b/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImplTest.java\nindex a194241f..9e17103c 100644\n--- a/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImplTest.java\n+++ b/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImplTest.java\n\n@@ -114,8 +121,7 @@ public class FhirLocationDaoImplTest extends BaseModuleContextSensitiveTest {\n \t\n \t@Test\n \tpublic void searchForLocations_shouldReturnCorrectLocationByName() {\n-\t\tStringParam location = new StringParam();\n-\t\tlocation.setValue(LOCATION_NAME);\n+\t\tStringOrListParam location = new StringOrListParam().add(new StringParam(LOCATION_NAME));\n \t\tCollection<Location> locations = fhirLocationDao.searchForLocations(location, null, null, null, null, null, null,\n \t\t    null);\n \t\t\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMwMzkzNQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/98#discussion_r389303935", "bodyText": "Similarly here\n\t\tassertThat(locations.iterator().next().getCountry(),equalTo(LOCATION_COUNTRY));", "author": "VaishSiddharth", "createdAt": "2020-03-07T18:55:40Z", "path": "api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImplTest.java", "diffHunk": "@@ -101,91 +113,140 @@ public void getLocationByUuid_shouldReturnNullWithUnknownUuid() {\n \t}\n \t\n \t@Test\n-\tpublic void findLocationByName_shouldReturnCorrectLocation() {\n-\t\tCollection<Location> locations = fhirLocationDao.findLocationByName(LOCATION_NAME);\n+\tpublic void searchForLocations_shouldReturnCorrectLocationByName() {\n+\t\tStringParam location = new StringParam();\n+\t\tlocation.setValue(LOCATION_NAME);\n+\t\tCollection<Location> locations = fhirLocationDao.searchForLocations(location, null, null, null, null, null, null,\n+\t\t    null);\n \t\t\n \t\tassertThat(locations, notNullValue());\n \t\tassertThat(locations.size(), equalTo(1));\n \t}\n \t\n \t@Test\n-\tpublic void findLocationByName_shouldReturnEmptyCollectionWhenCalledWithUnknownName() {\n-\t\tCollection<Location> locations = fhirLocationDao.findLocationByName(UNKNOWN_LOCATION_NAME);\n+\tpublic void searchForLocations_shouldReturnEmptyCollectionWhenCalledWithUnknownName() {\n+\t\tStringParam location = new StringParam();\n+\t\tlocation.setValue(UNKNOWN_LOCATION_NAME);\n+\t\tCollection<Location> locations = fhirLocationDao.searchForLocations(location, null, null, null, null, null, null,\n+\t\t    null);\n \t\t\n \t\tassertThat(locations, notNullValue());\n \t\tassertThat(locations.size(), equalTo(0));\n \t}\n \t\n \t@Test\n-\tpublic void findLocationByCity_shouldReturnCorrectLocation() {\n-\t\tCollection<Location> locations = fhirLocationDao.findLocationsByCity(LOCATION_CITY);\n+\tpublic void searchForLocations_shouldReturnCorrectLocationByCity() {\n+\t\tStringParam city = new StringParam();\n+\t\tcity.setValue(LOCATION_CITY);\n+\t\tCollection<Location> locations = fhirLocationDao.searchForLocations(null, city, null, null, null, null, null, null);\n \t\t\n \t\tassertThat(locations, notNullValue());\n-\t\tassertThat(locations.size(), greaterThanOrEqualTo(1));\n+\t\tassertThat(locations.size(), equalTo(1));\n \t}\n \t\n \t@Test\n-\tpublic void findLocationByCity_shouldReturnEmptyCollectionWhenCalledWithUnknownCity() {\n-\t\tCollection<Location> locations = fhirLocationDao.findLocationsByCity(UNKNOWN_LOCATION_CITY);\n+\tpublic void searchForLocations_shouldReturnEmptyCollectionWhenCalledWithUnknownCity() {\n+\t\tStringParam city = new StringParam();\n+\t\tcity.setValue(UNKNOWN_LOCATION_CITY);\n+\t\tCollection<Location> locations = fhirLocationDao.searchForLocations(null, city, null, null, null, null, null, null);\n \t\t\n \t\tassertThat(locations, notNullValue());\n \t\tassertThat(locations.size(), equalTo(0));\n \t}\n \t\n \t@Test\n-\tpublic void findLocationByCountry_shouldReturnCorrectLocation() {\n-\t\tCollection<Location> locations = fhirLocationDao.findLocationsByCountry(LOCATION_COUNTRY);\n+\tpublic void searchForLocations_shouldReturnCorrectLocationByCountry() {\n+\t\tStringParam country = new StringParam();\n+\t\tcountry.setValue(LOCATION_COUNTRY);\n+\t\tCollection<Location> locations = fhirLocationDao.searchForLocations(null, null, country, null, null, null, null,\n+\t\t    null);\n \t\t\n \t\tassertThat(locations, notNullValue());\n-\t\tassertThat(locations.size(), greaterThanOrEqualTo(2));\n+\t\tassertThat(locations.size(), equalTo(2));", "originalCommit": "7187751292ff0c39a9a454e7ce9564acbff0b918", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c9cc6886767eda1994307473ea39527ab2208bd5", "chunk": "diff --git a/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImplTest.java b/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImplTest.java\nindex a194241f..9e17103c 100644\n--- a/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImplTest.java\n+++ b/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImplTest.java\n\n@@ -114,8 +121,7 @@ public class FhirLocationDaoImplTest extends BaseModuleContextSensitiveTest {\n \t\n \t@Test\n \tpublic void searchForLocations_shouldReturnCorrectLocationByName() {\n-\t\tStringParam location = new StringParam();\n-\t\tlocation.setValue(LOCATION_NAME);\n+\t\tStringOrListParam location = new StringOrListParam().add(new StringParam(LOCATION_NAME));\n \t\tCollection<Location> locations = fhirLocationDao.searchForLocations(location, null, null, null, null, null, null,\n \t\t    null);\n \t\t\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMwNDAwMA==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/98#discussion_r389304000", "bodyText": "similarly here\n\t\tassertThat(locations.iterator().next().getPostalCode(),equalTo(POSTAL_CODE));", "author": "VaishSiddharth", "createdAt": "2020-03-07T18:56:24Z", "path": "api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImplTest.java", "diffHunk": "@@ -101,91 +113,140 @@ public void getLocationByUuid_shouldReturnNullWithUnknownUuid() {\n \t}\n \t\n \t@Test\n-\tpublic void findLocationByName_shouldReturnCorrectLocation() {\n-\t\tCollection<Location> locations = fhirLocationDao.findLocationByName(LOCATION_NAME);\n+\tpublic void searchForLocations_shouldReturnCorrectLocationByName() {\n+\t\tStringParam location = new StringParam();\n+\t\tlocation.setValue(LOCATION_NAME);\n+\t\tCollection<Location> locations = fhirLocationDao.searchForLocations(location, null, null, null, null, null, null,\n+\t\t    null);\n \t\t\n \t\tassertThat(locations, notNullValue());\n \t\tassertThat(locations.size(), equalTo(1));\n \t}\n \t\n \t@Test\n-\tpublic void findLocationByName_shouldReturnEmptyCollectionWhenCalledWithUnknownName() {\n-\t\tCollection<Location> locations = fhirLocationDao.findLocationByName(UNKNOWN_LOCATION_NAME);\n+\tpublic void searchForLocations_shouldReturnEmptyCollectionWhenCalledWithUnknownName() {\n+\t\tStringParam location = new StringParam();\n+\t\tlocation.setValue(UNKNOWN_LOCATION_NAME);\n+\t\tCollection<Location> locations = fhirLocationDao.searchForLocations(location, null, null, null, null, null, null,\n+\t\t    null);\n \t\t\n \t\tassertThat(locations, notNullValue());\n \t\tassertThat(locations.size(), equalTo(0));\n \t}\n \t\n \t@Test\n-\tpublic void findLocationByCity_shouldReturnCorrectLocation() {\n-\t\tCollection<Location> locations = fhirLocationDao.findLocationsByCity(LOCATION_CITY);\n+\tpublic void searchForLocations_shouldReturnCorrectLocationByCity() {\n+\t\tStringParam city = new StringParam();\n+\t\tcity.setValue(LOCATION_CITY);\n+\t\tCollection<Location> locations = fhirLocationDao.searchForLocations(null, city, null, null, null, null, null, null);\n \t\t\n \t\tassertThat(locations, notNullValue());\n-\t\tassertThat(locations.size(), greaterThanOrEqualTo(1));\n+\t\tassertThat(locations.size(), equalTo(1));\n \t}\n \t\n \t@Test\n-\tpublic void findLocationByCity_shouldReturnEmptyCollectionWhenCalledWithUnknownCity() {\n-\t\tCollection<Location> locations = fhirLocationDao.findLocationsByCity(UNKNOWN_LOCATION_CITY);\n+\tpublic void searchForLocations_shouldReturnEmptyCollectionWhenCalledWithUnknownCity() {\n+\t\tStringParam city = new StringParam();\n+\t\tcity.setValue(UNKNOWN_LOCATION_CITY);\n+\t\tCollection<Location> locations = fhirLocationDao.searchForLocations(null, city, null, null, null, null, null, null);\n \t\t\n \t\tassertThat(locations, notNullValue());\n \t\tassertThat(locations.size(), equalTo(0));\n \t}\n \t\n \t@Test\n-\tpublic void findLocationByCountry_shouldReturnCorrectLocation() {\n-\t\tCollection<Location> locations = fhirLocationDao.findLocationsByCountry(LOCATION_COUNTRY);\n+\tpublic void searchForLocations_shouldReturnCorrectLocationByCountry() {\n+\t\tStringParam country = new StringParam();\n+\t\tcountry.setValue(LOCATION_COUNTRY);\n+\t\tCollection<Location> locations = fhirLocationDao.searchForLocations(null, null, country, null, null, null, null,\n+\t\t    null);\n \t\t\n \t\tassertThat(locations, notNullValue());\n-\t\tassertThat(locations.size(), greaterThanOrEqualTo(2));\n+\t\tassertThat(locations.size(), equalTo(2));\n \t}\n \t\n \t@Test\n-\tpublic void findLocationByCountry_shouldReturnEmptyCollectionWhenCalledWithUnknownCountry() {\n-\t\tCollection<Location> locations = fhirLocationDao.findLocationsByCountry(UNKNOWN_LOCATION_COUNTRY);\n+\tpublic void searchForLocations_shouldReturnEmptyCollectionWhenCalledWithUnknownCountry() {\n+\t\tStringParam country = new StringParam();\n+\t\tcountry.setValue(UNKNOWN_LOCATION_COUNTRY);\n+\t\tCollection<Location> locations = fhirLocationDao.searchForLocations(null, null, country, null, null, null, null,\n+\t\t    null);\n \t\t\n \t\tassertThat(locations, notNullValue());\n \t\tassertThat(locations.size(), equalTo(0));\n \t}\n \t\n \t@Test\n-\tpublic void findLocationsByPostalCode_shouldReturnCorrectLocation() {\n-\t\tCollection<Location> locations = fhirLocationDao.findLocationsByPostalCode(POSTAL_CODE);\n+\tpublic void searchForLocations_shouldReturnCorrectLocationByPostalCode() {\n+\t\tStringParam postalCode = new StringParam();\n+\t\tpostalCode.setValue(POSTAL_CODE);\n+\t\tCollection<Location> locations = fhirLocationDao.searchForLocations(null, null, null, postalCode, null, null, null,\n+\t\t    null);\n \t\t\n \t\tassertThat(locations, notNullValue());\n-\t\tassertThat(locations.size(), greaterThanOrEqualTo(2));\n+\t\tassertThat(locations.size(), equalTo(2));", "originalCommit": "7187751292ff0c39a9a454e7ce9564acbff0b918", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c9cc6886767eda1994307473ea39527ab2208bd5", "chunk": "diff --git a/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImplTest.java b/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImplTest.java\nindex a194241f..9e17103c 100644\n--- a/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImplTest.java\n+++ b/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImplTest.java\n\n@@ -114,8 +121,7 @@ public class FhirLocationDaoImplTest extends BaseModuleContextSensitiveTest {\n \t\n \t@Test\n \tpublic void searchForLocations_shouldReturnCorrectLocationByName() {\n-\t\tStringParam location = new StringParam();\n-\t\tlocation.setValue(LOCATION_NAME);\n+\t\tStringOrListParam location = new StringOrListParam().add(new StringParam(LOCATION_NAME));\n \t\tCollection<Location> locations = fhirLocationDao.searchForLocations(location, null, null, null, null, null, null,\n \t\t    null);\n \t\t\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMwNDA4NQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/98#discussion_r389304085", "bodyText": "Here\n\t\tassertThat(locations.iterator().next().getStateProvince(),equalTo(LOCATION_STATE));", "author": "VaishSiddharth", "createdAt": "2020-03-07T18:57:30Z", "path": "api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImplTest.java", "diffHunk": "@@ -101,91 +113,140 @@ public void getLocationByUuid_shouldReturnNullWithUnknownUuid() {\n \t}\n \t\n \t@Test\n-\tpublic void findLocationByName_shouldReturnCorrectLocation() {\n-\t\tCollection<Location> locations = fhirLocationDao.findLocationByName(LOCATION_NAME);\n+\tpublic void searchForLocations_shouldReturnCorrectLocationByName() {\n+\t\tStringParam location = new StringParam();\n+\t\tlocation.setValue(LOCATION_NAME);\n+\t\tCollection<Location> locations = fhirLocationDao.searchForLocations(location, null, null, null, null, null, null,\n+\t\t    null);\n \t\t\n \t\tassertThat(locations, notNullValue());\n \t\tassertThat(locations.size(), equalTo(1));\n \t}\n \t\n \t@Test\n-\tpublic void findLocationByName_shouldReturnEmptyCollectionWhenCalledWithUnknownName() {\n-\t\tCollection<Location> locations = fhirLocationDao.findLocationByName(UNKNOWN_LOCATION_NAME);\n+\tpublic void searchForLocations_shouldReturnEmptyCollectionWhenCalledWithUnknownName() {\n+\t\tStringParam location = new StringParam();\n+\t\tlocation.setValue(UNKNOWN_LOCATION_NAME);\n+\t\tCollection<Location> locations = fhirLocationDao.searchForLocations(location, null, null, null, null, null, null,\n+\t\t    null);\n \t\t\n \t\tassertThat(locations, notNullValue());\n \t\tassertThat(locations.size(), equalTo(0));\n \t}\n \t\n \t@Test\n-\tpublic void findLocationByCity_shouldReturnCorrectLocation() {\n-\t\tCollection<Location> locations = fhirLocationDao.findLocationsByCity(LOCATION_CITY);\n+\tpublic void searchForLocations_shouldReturnCorrectLocationByCity() {\n+\t\tStringParam city = new StringParam();\n+\t\tcity.setValue(LOCATION_CITY);\n+\t\tCollection<Location> locations = fhirLocationDao.searchForLocations(null, city, null, null, null, null, null, null);\n \t\t\n \t\tassertThat(locations, notNullValue());\n-\t\tassertThat(locations.size(), greaterThanOrEqualTo(1));\n+\t\tassertThat(locations.size(), equalTo(1));\n \t}\n \t\n \t@Test\n-\tpublic void findLocationByCity_shouldReturnEmptyCollectionWhenCalledWithUnknownCity() {\n-\t\tCollection<Location> locations = fhirLocationDao.findLocationsByCity(UNKNOWN_LOCATION_CITY);\n+\tpublic void searchForLocations_shouldReturnEmptyCollectionWhenCalledWithUnknownCity() {\n+\t\tStringParam city = new StringParam();\n+\t\tcity.setValue(UNKNOWN_LOCATION_CITY);\n+\t\tCollection<Location> locations = fhirLocationDao.searchForLocations(null, city, null, null, null, null, null, null);\n \t\t\n \t\tassertThat(locations, notNullValue());\n \t\tassertThat(locations.size(), equalTo(0));\n \t}\n \t\n \t@Test\n-\tpublic void findLocationByCountry_shouldReturnCorrectLocation() {\n-\t\tCollection<Location> locations = fhirLocationDao.findLocationsByCountry(LOCATION_COUNTRY);\n+\tpublic void searchForLocations_shouldReturnCorrectLocationByCountry() {\n+\t\tStringParam country = new StringParam();\n+\t\tcountry.setValue(LOCATION_COUNTRY);\n+\t\tCollection<Location> locations = fhirLocationDao.searchForLocations(null, null, country, null, null, null, null,\n+\t\t    null);\n \t\t\n \t\tassertThat(locations, notNullValue());\n-\t\tassertThat(locations.size(), greaterThanOrEqualTo(2));\n+\t\tassertThat(locations.size(), equalTo(2));\n \t}\n \t\n \t@Test\n-\tpublic void findLocationByCountry_shouldReturnEmptyCollectionWhenCalledWithUnknownCountry() {\n-\t\tCollection<Location> locations = fhirLocationDao.findLocationsByCountry(UNKNOWN_LOCATION_COUNTRY);\n+\tpublic void searchForLocations_shouldReturnEmptyCollectionWhenCalledWithUnknownCountry() {\n+\t\tStringParam country = new StringParam();\n+\t\tcountry.setValue(UNKNOWN_LOCATION_COUNTRY);\n+\t\tCollection<Location> locations = fhirLocationDao.searchForLocations(null, null, country, null, null, null, null,\n+\t\t    null);\n \t\t\n \t\tassertThat(locations, notNullValue());\n \t\tassertThat(locations.size(), equalTo(0));\n \t}\n \t\n \t@Test\n-\tpublic void findLocationsByPostalCode_shouldReturnCorrectLocation() {\n-\t\tCollection<Location> locations = fhirLocationDao.findLocationsByPostalCode(POSTAL_CODE);\n+\tpublic void searchForLocations_shouldReturnCorrectLocationByPostalCode() {\n+\t\tStringParam postalCode = new StringParam();\n+\t\tpostalCode.setValue(POSTAL_CODE);\n+\t\tCollection<Location> locations = fhirLocationDao.searchForLocations(null, null, null, postalCode, null, null, null,\n+\t\t    null);\n \t\t\n \t\tassertThat(locations, notNullValue());\n-\t\tassertThat(locations.size(), greaterThanOrEqualTo(2));\n+\t\tassertThat(locations.size(), equalTo(2));\n \t}\n \t\n \t@Test\n-\tpublic void findLocationsByPostalCode_shouldReturnEmptyCollectionWhenCalledWithUnknownCode() {\n-\t\tCollection<Location> locations = fhirLocationDao.findLocationsByPostalCode(UNKNOWN_POSTAL_CODE);\n+\tpublic void searchForLocations_shouldReturnEmptyCollectionWhenCalledWithUnknownCode() {\n+\t\tStringParam postalCode = new StringParam();\n+\t\tpostalCode.setValue(UNKNOWN_POSTAL_CODE);\n+\t\tCollection<Location> locations = fhirLocationDao.searchForLocations(null, null, null, postalCode, null, null, null,\n+\t\t    null);\n \t\t\n \t\tassertThat(locations, notNullValue());\n \t\tassertThat(locations.size(), equalTo(0));\n \t}\n \t\n \t@Test\n-\tpublic void findLocationsByState_shouldReturnCorrectLocation() {\n-\t\tCollection<Location> locations = fhirLocationDao.findLocationsByState(LOCATION_STATE);\n+\tpublic void searchForLocations_shouldReturnCorrectLocationByState() {\n+\t\tStringParam state = new StringParam();\n+\t\tstate.setValue(LOCATION_STATE);\n+\t\tCollection<Location> locations = fhirLocationDao.searchForLocations(null, null, null, null, state, null, null, null);\n \t\t\n \t\tassertThat(locations, notNullValue());\n-\t\tassertThat(locations.size(), greaterThanOrEqualTo(1));\n+\t\tassertThat(locations.size(), equalTo(2));", "originalCommit": "7187751292ff0c39a9a454e7ce9564acbff0b918", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c9cc6886767eda1994307473ea39527ab2208bd5", "chunk": "diff --git a/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImplTest.java b/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImplTest.java\nindex a194241f..9e17103c 100644\n--- a/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImplTest.java\n+++ b/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImplTest.java\n\n@@ -114,8 +121,7 @@ public class FhirLocationDaoImplTest extends BaseModuleContextSensitiveTest {\n \t\n \t@Test\n \tpublic void searchForLocations_shouldReturnCorrectLocationByName() {\n-\t\tStringParam location = new StringParam();\n-\t\tlocation.setValue(LOCATION_NAME);\n+\t\tStringOrListParam location = new StringOrListParam().add(new StringParam(LOCATION_NAME));\n \t\tCollection<Location> locations = fhirLocationDao.searchForLocations(location, null, null, null, null, null, null,\n \t\t    null);\n \t\t\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMwNDM1Nw==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/98#discussion_r389304357", "bodyText": "Here something like this might work\n\t\tassertThat(locations.iterator().next().getTags().iterator().next().getLocationTagId(),equalTo(LOCATIONT_TAG));", "author": "VaishSiddharth", "createdAt": "2020-03-07T19:01:16Z", "path": "api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImplTest.java", "diffHunk": "@@ -101,91 +113,140 @@ public void getLocationByUuid_shouldReturnNullWithUnknownUuid() {\n \t}\n \t\n \t@Test\n-\tpublic void findLocationByName_shouldReturnCorrectLocation() {\n-\t\tCollection<Location> locations = fhirLocationDao.findLocationByName(LOCATION_NAME);\n+\tpublic void searchForLocations_shouldReturnCorrectLocationByName() {\n+\t\tStringParam location = new StringParam();\n+\t\tlocation.setValue(LOCATION_NAME);\n+\t\tCollection<Location> locations = fhirLocationDao.searchForLocations(location, null, null, null, null, null, null,\n+\t\t    null);\n \t\t\n \t\tassertThat(locations, notNullValue());\n \t\tassertThat(locations.size(), equalTo(1));\n \t}\n \t\n \t@Test\n-\tpublic void findLocationByName_shouldReturnEmptyCollectionWhenCalledWithUnknownName() {\n-\t\tCollection<Location> locations = fhirLocationDao.findLocationByName(UNKNOWN_LOCATION_NAME);\n+\tpublic void searchForLocations_shouldReturnEmptyCollectionWhenCalledWithUnknownName() {\n+\t\tStringParam location = new StringParam();\n+\t\tlocation.setValue(UNKNOWN_LOCATION_NAME);\n+\t\tCollection<Location> locations = fhirLocationDao.searchForLocations(location, null, null, null, null, null, null,\n+\t\t    null);\n \t\t\n \t\tassertThat(locations, notNullValue());\n \t\tassertThat(locations.size(), equalTo(0));\n \t}\n \t\n \t@Test\n-\tpublic void findLocationByCity_shouldReturnCorrectLocation() {\n-\t\tCollection<Location> locations = fhirLocationDao.findLocationsByCity(LOCATION_CITY);\n+\tpublic void searchForLocations_shouldReturnCorrectLocationByCity() {\n+\t\tStringParam city = new StringParam();\n+\t\tcity.setValue(LOCATION_CITY);\n+\t\tCollection<Location> locations = fhirLocationDao.searchForLocations(null, city, null, null, null, null, null, null);\n \t\t\n \t\tassertThat(locations, notNullValue());\n-\t\tassertThat(locations.size(), greaterThanOrEqualTo(1));\n+\t\tassertThat(locations.size(), equalTo(1));\n \t}\n \t\n \t@Test\n-\tpublic void findLocationByCity_shouldReturnEmptyCollectionWhenCalledWithUnknownCity() {\n-\t\tCollection<Location> locations = fhirLocationDao.findLocationsByCity(UNKNOWN_LOCATION_CITY);\n+\tpublic void searchForLocations_shouldReturnEmptyCollectionWhenCalledWithUnknownCity() {\n+\t\tStringParam city = new StringParam();\n+\t\tcity.setValue(UNKNOWN_LOCATION_CITY);\n+\t\tCollection<Location> locations = fhirLocationDao.searchForLocations(null, city, null, null, null, null, null, null);\n \t\t\n \t\tassertThat(locations, notNullValue());\n \t\tassertThat(locations.size(), equalTo(0));\n \t}\n \t\n \t@Test\n-\tpublic void findLocationByCountry_shouldReturnCorrectLocation() {\n-\t\tCollection<Location> locations = fhirLocationDao.findLocationsByCountry(LOCATION_COUNTRY);\n+\tpublic void searchForLocations_shouldReturnCorrectLocationByCountry() {\n+\t\tStringParam country = new StringParam();\n+\t\tcountry.setValue(LOCATION_COUNTRY);\n+\t\tCollection<Location> locations = fhirLocationDao.searchForLocations(null, null, country, null, null, null, null,\n+\t\t    null);\n \t\t\n \t\tassertThat(locations, notNullValue());\n-\t\tassertThat(locations.size(), greaterThanOrEqualTo(2));\n+\t\tassertThat(locations.size(), equalTo(2));\n \t}\n \t\n \t@Test\n-\tpublic void findLocationByCountry_shouldReturnEmptyCollectionWhenCalledWithUnknownCountry() {\n-\t\tCollection<Location> locations = fhirLocationDao.findLocationsByCountry(UNKNOWN_LOCATION_COUNTRY);\n+\tpublic void searchForLocations_shouldReturnEmptyCollectionWhenCalledWithUnknownCountry() {\n+\t\tStringParam country = new StringParam();\n+\t\tcountry.setValue(UNKNOWN_LOCATION_COUNTRY);\n+\t\tCollection<Location> locations = fhirLocationDao.searchForLocations(null, null, country, null, null, null, null,\n+\t\t    null);\n \t\t\n \t\tassertThat(locations, notNullValue());\n \t\tassertThat(locations.size(), equalTo(0));\n \t}\n \t\n \t@Test\n-\tpublic void findLocationsByPostalCode_shouldReturnCorrectLocation() {\n-\t\tCollection<Location> locations = fhirLocationDao.findLocationsByPostalCode(POSTAL_CODE);\n+\tpublic void searchForLocations_shouldReturnCorrectLocationByPostalCode() {\n+\t\tStringParam postalCode = new StringParam();\n+\t\tpostalCode.setValue(POSTAL_CODE);\n+\t\tCollection<Location> locations = fhirLocationDao.searchForLocations(null, null, null, postalCode, null, null, null,\n+\t\t    null);\n \t\t\n \t\tassertThat(locations, notNullValue());\n-\t\tassertThat(locations.size(), greaterThanOrEqualTo(2));\n+\t\tassertThat(locations.size(), equalTo(2));\n \t}\n \t\n \t@Test\n-\tpublic void findLocationsByPostalCode_shouldReturnEmptyCollectionWhenCalledWithUnknownCode() {\n-\t\tCollection<Location> locations = fhirLocationDao.findLocationsByPostalCode(UNKNOWN_POSTAL_CODE);\n+\tpublic void searchForLocations_shouldReturnEmptyCollectionWhenCalledWithUnknownCode() {\n+\t\tStringParam postalCode = new StringParam();\n+\t\tpostalCode.setValue(UNKNOWN_POSTAL_CODE);\n+\t\tCollection<Location> locations = fhirLocationDao.searchForLocations(null, null, null, postalCode, null, null, null,\n+\t\t    null);\n \t\t\n \t\tassertThat(locations, notNullValue());\n \t\tassertThat(locations.size(), equalTo(0));\n \t}\n \t\n \t@Test\n-\tpublic void findLocationsByState_shouldReturnCorrectLocation() {\n-\t\tCollection<Location> locations = fhirLocationDao.findLocationsByState(LOCATION_STATE);\n+\tpublic void searchForLocations_shouldReturnCorrectLocationByState() {\n+\t\tStringParam state = new StringParam();\n+\t\tstate.setValue(LOCATION_STATE);\n+\t\tCollection<Location> locations = fhirLocationDao.searchForLocations(null, null, null, null, state, null, null, null);\n \t\t\n \t\tassertThat(locations, notNullValue());\n-\t\tassertThat(locations.size(), greaterThanOrEqualTo(1));\n+\t\tassertThat(locations.size(), equalTo(2));\n \t}\n \t\n \t@Test\n-\tpublic void findLocationsByState_shouldReturnEmptyCollectionWhenCalledWithUnknownState() {\n-\t\tCollection<Location> locations = fhirLocationDao.findLocationsByState(UNKNOWN_LOCATION_STATE);\n+\tpublic void searchForLocations_shouldReturnEmptyCollectionWhenCalledWithUnknownState() {\n+\t\tStringParam state = new StringParam();\n+\t\tstate.setValue(UNKNOWN_LOCATION_STATE);\n+\t\tCollection<Location> locations = fhirLocationDao.searchForLocations(null, null, null, null, state, null, null, null);\n \t\t\n \t\tassertThat(locations, notNullValue());\n \t\tassertThat(locations.size(), equalTo(0));\n \t}\n \t\n \t@Test\n-\tpublic void findLocationsByTag_shouldReturnLocationsContainingGivenTag() {\n+\tpublic void searchForLocations_shouldReturnLocationsContainingGivenTag() {\n \t\tTokenParam locationTag = new TokenParam(FhirConstants.OPENMRS_FHIR_EXT_LOCATION_TAG, LOGIN_LOCATION_TAG_NAME);\n-\t\tCollection<Location> locations = fhirLocationDao.findLocationsByTag(locationTag);\n+\t\tCollection<Location> locations = fhirLocationDao.searchForLocations(null, null, null, null, null, locationTag, null,\n+\t\t    null);\n+\t\t\n \t\tassertThat(locations, notNullValue());\n-\t\tassertThat(locations.size(), greaterThanOrEqualTo(2));\n+\t\tassertThat(locations.size(), equalTo(2));", "originalCommit": "7187751292ff0c39a9a454e7ce9564acbff0b918", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c9cc6886767eda1994307473ea39527ab2208bd5", "chunk": "diff --git a/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImplTest.java b/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImplTest.java\nindex a194241f..9e17103c 100644\n--- a/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImplTest.java\n+++ b/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImplTest.java\n\n@@ -114,8 +121,7 @@ public class FhirLocationDaoImplTest extends BaseModuleContextSensitiveTest {\n \t\n \t@Test\n \tpublic void searchForLocations_shouldReturnCorrectLocationByName() {\n-\t\tStringParam location = new StringParam();\n-\t\tlocation.setValue(LOCATION_NAME);\n+\t\tStringOrListParam location = new StringOrListParam().add(new StringParam(LOCATION_NAME));\n \t\tCollection<Location> locations = fhirLocationDao.searchForLocations(location, null, null, null, null, null, null,\n \t\t    null);\n \t\t\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM1Mjk1NQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/98#discussion_r389352955", "bodyText": "You can replace the literal \"_tag\" by PARAM_TAG present in ca.uhn.fhir.rest.api.Constants", "author": "CaptainDaVinci", "createdAt": "2020-03-08T09:49:10Z", "path": "omod/src/main/java/org/openmrs/module/fhir2/providers/LocationFhirResourceProvider.java", "diffHunk": "@@ -56,37 +58,13 @@ public Location getLocationById(@IdParam @NotNull IdType id) {\n \t\n \t@Search\n \t@SuppressWarnings(\"unused\")\n-\tpublic Bundle findLocationByName(@RequiredParam(name = Location.SP_NAME) StringParam name) {\n-\t\treturn FhirUtils.convertSearchResultsToBundle(fhirLocationService.findLocationByName(name.getValue()));\n-\t}\n-\t\n-\t@Search\n-\t@SuppressWarnings(\"unused\")\n-\tpublic Bundle findLocationByCity(@RequiredParam(name = Location.SP_ADDRESS_CITY) StringParam city) {\n-\t\treturn FhirUtils.convertSearchResultsToBundle(fhirLocationService.findLocationsByCity(city.getValue()));\n-\t}\n-\t\n-\t@Search\n-\t@SuppressWarnings(\"unused\")\n-\tpublic Bundle findLocationByCountry(@RequiredParam(name = Location.SP_ADDRESS_COUNTRY) StringParam country) {\n-\t\treturn FhirUtils.convertSearchResultsToBundle(fhirLocationService.findLocationsByCountry(country.getValue()));\n-\t}\n-\t\n-\t@Search\n-\t@SuppressWarnings(\"unused\")\n-\tpublic Bundle findLocationByPostalCode(@RequiredParam(name = Location.SP_ADDRESS_POSTALCODE) StringParam postalCode) {\n-\t\treturn FhirUtils.convertSearchResultsToBundle(fhirLocationService.findLocationsByPostalCode(postalCode.getValue()));\n-\t}\n-\t\n-\t@Search\n-\t@SuppressWarnings(\"unused\")\n-\tpublic Bundle findLocationByState(@RequiredParam(name = Location.SP_ADDRESS_STATE) StringParam state) {\n-\t\treturn FhirUtils.convertSearchResultsToBundle(fhirLocationService.findLocationsByState(state.getValue()));\n-\t}\n-\t\n-\t@Search\n-\t@SuppressWarnings(\"unused\")\n-\tpublic Bundle findLocationsByTag(@RequiredParam(name = \"_tag\") TokenParam tag) {\n-\t\treturn FhirUtils.convertSearchResultsToBundle(fhirLocationService.findLocationsByTag(tag));\n+\tpublic Bundle searchLocations(@OptionalParam(name = Location.SP_NAME) StringParam name,\n+\t        @OptionalParam(name = Location.SP_ADDRESS_CITY) StringParam city,\n+\t        @OptionalParam(name = Location.SP_ADDRESS_COUNTRY) StringParam country,\n+\t        @OptionalParam(name = Location.SP_ADDRESS_POSTALCODE) StringParam postalCode,\n+\t        @OptionalParam(name = Location.SP_ADDRESS_STATE) StringParam state, @OptionalParam(name = \"_tag\") TokenParam tag,", "originalCommit": "7187751292ff0c39a9a454e7ce9564acbff0b918", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c9cc6886767eda1994307473ea39527ab2208bd5", "chunk": "diff --git a/omod/src/main/java/org/openmrs/module/fhir2/providers/LocationFhirResourceProvider.java b/omod/src/main/java/org/openmrs/module/fhir2/providers/LocationFhirResourceProvider.java\nindex 2e43ada2..01012007 100644\n--- a/omod/src/main/java/org/openmrs/module/fhir2/providers/LocationFhirResourceProvider.java\n+++ b/omod/src/main/java/org/openmrs/module/fhir2/providers/LocationFhirResourceProvider.java\n\n@@ -55,16 +62,26 @@ public class LocationFhirResourceProvider implements IResourceProvider {\n \t\t}\n \t\treturn location;\n \t}\n-\t\n-\t@Search\n+\n+\t@History\n \t@SuppressWarnings(\"unused\")\n-\tpublic Bundle searchLocations(@OptionalParam(name = Location.SP_NAME) StringParam name,\n-\t        @OptionalParam(name = Location.SP_ADDRESS_CITY) StringParam city,\n-\t        @OptionalParam(name = Location.SP_ADDRESS_COUNTRY) StringParam country,\n-\t        @OptionalParam(name = Location.SP_ADDRESS_POSTALCODE) StringParam postalCode,\n-\t        @OptionalParam(name = Location.SP_ADDRESS_STATE) StringParam state, @OptionalParam(name = \"_tag\") TokenParam tag,\n-\t        @OptionalParam(name = Location.SP_PARTOF) StringParam parent, @Sort SortSpec sort) {\n-\t\treturn FhirUtils.convertSearchResultsToBundle(\n+\tpublic List<Resource> getLocationHistoryById(@IdParam @NotNull IdType id) {\n+\t\tLocation location = fhirLocationService.getLocationByUuid(id.getIdPart());\n+\t\tif (location == null) {\n+\t\t\tthrow new ResourceNotFoundException(\"Could not find location with Id \" + id.getIdPart());\n+\t\t}\n+\t\treturn location.getContained();\n+\t}\n+\n+\t@Search\n+\tpublic Bundle searchLocations(@OptionalParam(name = Location.SP_NAME) StringOrListParam name,\n+\t        @OptionalParam(name = Location.SP_ADDRESS_CITY) StringOrListParam city,\n+\t        @OptionalParam(name = Location.SP_ADDRESS_COUNTRY) StringOrListParam country,\n+\t        @OptionalParam(name = Location.SP_ADDRESS_POSTALCODE) StringOrListParam postalCode,\n+\t        @OptionalParam(name = Location.SP_ADDRESS_STATE) StringOrListParam state,\n+\t        @OptionalParam(name = PARAM_TAG) TokenOrListParam tag,\n+\t        @OptionalParam(name = Location.SP_PARTOF) ReferenceOrListParam parent, @Sort SortSpec sort) {\n+\t\treturn FhirServerUtils.convertSearchResultsToBundle(\n \t\t    fhirLocationService.searchForLocations(name, city, country, postalCode, state, tag, parent, sort));\n \t}\n }\n"}}, {"oid": "c9cc6886767eda1994307473ea39527ab2208bd5", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/c9cc6886767eda1994307473ea39527ab2208bd5", "message": "FM2-80: Improve Search for Location Resource", "committedDate": "2020-03-08T20:21:11Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDI3NjU4Nw==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/98#discussion_r390276587", "bodyText": "I prefer to have a space before the return line.", "author": "ibacher", "createdAt": "2020-03-10T12:25:03Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/BaseDaoImpl.java", "diffHunk": "@@ -470,6 +474,28 @@ protected void handleLocationReference(Criteria criteria, ReferenceParam locatio\n \t\t}\n \t}\n \t\n+\tprotected Optional<Criterion> handleParentReference(ReferenceParam parentReference) {\n+\t\tif (parentReference != null) {\n+\t\t\tif (parentReference.getChain() != null) {\n+\t\t\t\tswitch (parentReference.getChain()) {\n+\t\t\t\t\tcase Location.SP_NAME:\n+\t\t\t\t\t\treturn propertyLike(\"name\", parentReference.getValue());\n+\t\t\t\t\tcase Location.SP_ADDRESS_CITY:\n+\t\t\t\t\t\treturn propertyLike(\"cityVillage\", parentReference.getValue());\n+\t\t\t\t\tcase Location.SP_ADDRESS_STATE:\n+\t\t\t\t\t\treturn propertyLike(\"stateProvince\", parentReference.getValue());\n+\t\t\t\t\tcase Location.SP_ADDRESS_COUNTRY:\n+\t\t\t\t\t\treturn propertyLike(\"country\", parentReference.getValue());\n+\t\t\t\t\tcase Location.SP_ADDRESS_POSTALCODE:\n+\t\t\t\t\t\treturn propertyLike(\"postalCode\", parentReference.getValue());\n+\t\t\t\t\tcase \"\":\n+\t\t\t\t\t\treturn Optional.of(eq(\"locationId\", Integer.parseInt(parentReference.getValue())));\n+\t\t\t\t}\n+\t\t\t}\n+\t\t}\n+\t\treturn Optional.empty();", "originalCommit": "c9cc6886767eda1994307473ea39527ab2208bd5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5ecbc70d13f872e7817bbfca3942c8a836eb221d", "chunk": "diff --git a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/BaseDaoImpl.java b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/BaseDaoImpl.java\nindex 4ece40f0..70ceb53e 100644\n--- a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/BaseDaoImpl.java\n+++ b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/BaseDaoImpl.java\n\n@@ -474,28 +481,6 @@ public abstract class BaseDaoImpl {\n \t\t}\n \t}\n \t\n-\tprotected Optional<Criterion> handleParentReference(ReferenceParam parentReference) {\n-\t\tif (parentReference != null) {\n-\t\t\tif (parentReference.getChain() != null) {\n-\t\t\t\tswitch (parentReference.getChain()) {\n-\t\t\t\t\tcase Location.SP_NAME:\n-\t\t\t\t\t\treturn propertyLike(\"name\", parentReference.getValue());\n-\t\t\t\t\tcase Location.SP_ADDRESS_CITY:\n-\t\t\t\t\t\treturn propertyLike(\"cityVillage\", parentReference.getValue());\n-\t\t\t\t\tcase Location.SP_ADDRESS_STATE:\n-\t\t\t\t\t\treturn propertyLike(\"stateProvince\", parentReference.getValue());\n-\t\t\t\t\tcase Location.SP_ADDRESS_COUNTRY:\n-\t\t\t\t\t\treturn propertyLike(\"country\", parentReference.getValue());\n-\t\t\t\t\tcase Location.SP_ADDRESS_POSTALCODE:\n-\t\t\t\t\t\treturn propertyLike(\"postalCode\", parentReference.getValue());\n-\t\t\t\t\tcase \"\":\n-\t\t\t\t\t\treturn Optional.of(eq(\"locationId\", Integer.parseInt(parentReference.getValue())));\n-\t\t\t\t}\n-\t\t\t}\n-\t\t}\n-\t\treturn Optional.empty();\n-\t}\n-\t\n \tprotected void handleParticipantReference(Criteria criteria, ReferenceParam participantReference) {\n \t\tif (participantReference != null) {\n \t\t\tcriteria.createAlias(\"encounterProviders\", \"ep\");\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDI3NzAxMA==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/98#discussion_r390277010", "bodyText": "I'd group these with the other handle... calls.", "author": "ibacher", "createdAt": "2020-03-10T12:25:51Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImpl.java", "diffHunk": "@@ -42,43 +55,97 @@ public Location getLocationByUuid(String uuid) {\n \t}\n \t\n \t@Override\n-\tpublic Collection<Location> findLocationByName(String name) {\n-\t\treturn sessionFactory.getCurrentSession().createCriteria(Location.class).add(eq(\"name\", name)).list();\n+\tpublic Collection<Location> searchForLocations(StringOrListParam name, StringOrListParam city, StringOrListParam country,\n+\t        StringOrListParam postalCode, StringOrListParam state, TokenOrListParam tag, ReferenceOrListParam parent,\n+\t        SortSpec sort) {\n+\t\t\n+\t\tCriteria criteria = this.sessionFactory.getCurrentSession().createCriteria(Location.class);\n+\t\thandleBooleanProperty(\"retired\", false).ifPresent(criteria::add);", "originalCommit": "c9cc6886767eda1994307473ea39527ab2208bd5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5ecbc70d13f872e7817bbfca3942c8a836eb221d", "chunk": "diff --git a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImpl.java b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImpl.java\nindex 4ff2d73e..f1537bc1 100644\n--- a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImpl.java\n+++ b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImpl.java\n\n@@ -60,8 +58,8 @@ public class FhirLocationDaoImpl extends BaseDaoImpl implements FhirLocationDao\n \t        SortSpec sort) {\n \t\t\n \t\tCriteria criteria = this.sessionFactory.getCurrentSession().createCriteria(Location.class);\n-\t\thandleBooleanProperty(\"retired\", false).ifPresent(criteria::add);\n \t\t\n+\t\thandleBooleanProperty(\"retired\", false).ifPresent(criteria::add);\n \t\thandleName(criteria, name);\n \t\thandleCity(criteria, city);\n \t\thandleCountry(criteria, country);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDI3NzUzMg==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/98#discussion_r390277532", "bodyText": "givenName really only applies to things with a PersonName (OpenMRS) or HumanName (FHIR). This should just be called name, i.e., it gets called \"givenName\" to distinguish it from \"familyName\" (it makes a bit more sense in French where they're, respectively, \"pr\u00e9nom\" and \"nom\"). Very European-parochial.", "author": "ibacher", "createdAt": "2020-03-10T12:26:57Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImpl.java", "diffHunk": "@@ -42,43 +55,97 @@ public Location getLocationByUuid(String uuid) {\n \t}\n \t\n \t@Override\n-\tpublic Collection<Location> findLocationByName(String name) {\n-\t\treturn sessionFactory.getCurrentSession().createCriteria(Location.class).add(eq(\"name\", name)).list();\n+\tpublic Collection<Location> searchForLocations(StringOrListParam name, StringOrListParam city, StringOrListParam country,\n+\t        StringOrListParam postalCode, StringOrListParam state, TokenOrListParam tag, ReferenceOrListParam parent,\n+\t        SortSpec sort) {\n+\t\t\n+\t\tCriteria criteria = this.sessionFactory.getCurrentSession().createCriteria(Location.class);\n+\t\thandleBooleanProperty(\"retired\", false).ifPresent(criteria::add);\n+\t\t\n+\t\thandleName(criteria, name);\n+\t\thandleCity(criteria, city);\n+\t\thandleCountry(criteria, country);\n+\t\thandlePostalCode(criteria, postalCode);\n+\t\thandleState(criteria, state);\n+\t\thandleTag(criteria, tag);\n+\t\thandleParentLocation(criteria, parent);\n+\t\thandleSort(criteria, sort);\n+\t\t\n+\t\treturn criteria.list();\n \t}\n \t\n \t@Override\n-\tpublic Collection<Location> findLocationsByCity(String city) {\n-\t\treturn sessionFactory.getCurrentSession().createCriteria(Location.class).add(eq(\"cityVillage\", city)).list();\n+\tpublic List<LocationAttribute> getActiveAttributesByLocationAndAttributeTypeUuid(Location location,\n+\t        String locationAttributeTypeUuid) {\n+\t\treturn (List<LocationAttribute>) sessionFactory.getCurrentSession().createCriteria(LocationAttribute.class)\n+\t\t        .createAlias(\"location\", \"l\", JoinType.INNER_JOIN, eq(\"l.id\", location.getId()))\n+\t\t        .createAlias(\"attributeType\", \"lat\").add(eq(\"lat.uuid\", locationAttributeTypeUuid)).add(eq(\"voided\", false))\n+\t\t        .list();\n \t}\n \t\n-\t@Override\n-\tpublic Collection<Location> findLocationsByCountry(String country) {\n-\t\treturn sessionFactory.getCurrentSession().createCriteria(Location.class).add(eq(\"country\", country)).list();\n+\tprivate void handleName(Criteria criteria, StringOrListParam namePattern) {\n+\t\tif (namePattern != null) {\n+\t\t\thandleOrListParam(namePattern, (givenName) -> propertyLike(\"name\", givenName)).ifPresent(criteria::add);", "originalCommit": "c9cc6886767eda1994307473ea39527ab2208bd5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5ecbc70d13f872e7817bbfca3942c8a836eb221d", "chunk": "diff --git a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImpl.java b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImpl.java\nindex 4ff2d73e..f1537bc1 100644\n--- a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImpl.java\n+++ b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImpl.java\n\n@@ -60,8 +58,8 @@ public class FhirLocationDaoImpl extends BaseDaoImpl implements FhirLocationDao\n \t        SortSpec sort) {\n \t\t\n \t\tCriteria criteria = this.sessionFactory.getCurrentSession().createCriteria(Location.class);\n-\t\thandleBooleanProperty(\"retired\", false).ifPresent(criteria::add);\n \t\t\n+\t\thandleBooleanProperty(\"retired\", false).ifPresent(criteria::add);\n \t\thandleName(criteria, name);\n \t\thandleCity(criteria, city);\n \t\thandleCountry(criteria, country);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDI3NzgxOA==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/98#discussion_r390277818", "bodyText": "Ditto on removing given", "author": "ibacher", "createdAt": "2020-03-10T12:27:32Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImpl.java", "diffHunk": "@@ -42,43 +55,97 @@ public Location getLocationByUuid(String uuid) {\n \t}\n \t\n \t@Override\n-\tpublic Collection<Location> findLocationByName(String name) {\n-\t\treturn sessionFactory.getCurrentSession().createCriteria(Location.class).add(eq(\"name\", name)).list();\n+\tpublic Collection<Location> searchForLocations(StringOrListParam name, StringOrListParam city, StringOrListParam country,\n+\t        StringOrListParam postalCode, StringOrListParam state, TokenOrListParam tag, ReferenceOrListParam parent,\n+\t        SortSpec sort) {\n+\t\t\n+\t\tCriteria criteria = this.sessionFactory.getCurrentSession().createCriteria(Location.class);\n+\t\thandleBooleanProperty(\"retired\", false).ifPresent(criteria::add);\n+\t\t\n+\t\thandleName(criteria, name);\n+\t\thandleCity(criteria, city);\n+\t\thandleCountry(criteria, country);\n+\t\thandlePostalCode(criteria, postalCode);\n+\t\thandleState(criteria, state);\n+\t\thandleTag(criteria, tag);\n+\t\thandleParentLocation(criteria, parent);\n+\t\thandleSort(criteria, sort);\n+\t\t\n+\t\treturn criteria.list();\n \t}\n \t\n \t@Override\n-\tpublic Collection<Location> findLocationsByCity(String city) {\n-\t\treturn sessionFactory.getCurrentSession().createCriteria(Location.class).add(eq(\"cityVillage\", city)).list();\n+\tpublic List<LocationAttribute> getActiveAttributesByLocationAndAttributeTypeUuid(Location location,\n+\t        String locationAttributeTypeUuid) {\n+\t\treturn (List<LocationAttribute>) sessionFactory.getCurrentSession().createCriteria(LocationAttribute.class)\n+\t\t        .createAlias(\"location\", \"l\", JoinType.INNER_JOIN, eq(\"l.id\", location.getId()))\n+\t\t        .createAlias(\"attributeType\", \"lat\").add(eq(\"lat.uuid\", locationAttributeTypeUuid)).add(eq(\"voided\", false))\n+\t\t        .list();\n \t}\n \t\n-\t@Override\n-\tpublic Collection<Location> findLocationsByCountry(String country) {\n-\t\treturn sessionFactory.getCurrentSession().createCriteria(Location.class).add(eq(\"country\", country)).list();\n+\tprivate void handleName(Criteria criteria, StringOrListParam namePattern) {\n+\t\tif (namePattern != null) {\n+\t\t\thandleOrListParam(namePattern, (givenName) -> propertyLike(\"name\", givenName)).ifPresent(criteria::add);\n+\t\t}\n \t}\n \t\n-\t@Override\n-\tpublic Collection<Location> findLocationsByPostalCode(String postalCode) {\n-\t\treturn sessionFactory.getCurrentSession().createCriteria(Location.class).add(eq(\"postalCode\", postalCode)).list();\n+\tprivate void handleCity(Criteria criteria, StringOrListParam city) {\n+\t\tif (city != null) {\n+\t\t\thandleOrListParam(city, (givenCity) -> propertyLike(\"cityVillage\", givenCity)).ifPresent(criteria::add);", "originalCommit": "c9cc6886767eda1994307473ea39527ab2208bd5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5ecbc70d13f872e7817bbfca3942c8a836eb221d", "chunk": "diff --git a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImpl.java b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImpl.java\nindex 4ff2d73e..f1537bc1 100644\n--- a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImpl.java\n+++ b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImpl.java\n\n@@ -60,8 +58,8 @@ public class FhirLocationDaoImpl extends BaseDaoImpl implements FhirLocationDao\n \t        SortSpec sort) {\n \t\t\n \t\tCriteria criteria = this.sessionFactory.getCurrentSession().createCriteria(Location.class);\n-\t\thandleBooleanProperty(\"retired\", false).ifPresent(criteria::add);\n \t\t\n+\t\thandleBooleanProperty(\"retired\", false).ifPresent(criteria::add);\n \t\thandleName(criteria, name);\n \t\thandleCity(criteria, city);\n \t\thandleCountry(criteria, country);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDI3ODgxNw==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/98#discussion_r390278817", "bodyText": "Ditto given", "author": "ibacher", "createdAt": "2020-03-10T12:29:44Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImpl.java", "diffHunk": "@@ -42,43 +55,97 @@ public Location getLocationByUuid(String uuid) {\n \t}\n \t\n \t@Override\n-\tpublic Collection<Location> findLocationByName(String name) {\n-\t\treturn sessionFactory.getCurrentSession().createCriteria(Location.class).add(eq(\"name\", name)).list();\n+\tpublic Collection<Location> searchForLocations(StringOrListParam name, StringOrListParam city, StringOrListParam country,\n+\t        StringOrListParam postalCode, StringOrListParam state, TokenOrListParam tag, ReferenceOrListParam parent,\n+\t        SortSpec sort) {\n+\t\t\n+\t\tCriteria criteria = this.sessionFactory.getCurrentSession().createCriteria(Location.class);\n+\t\thandleBooleanProperty(\"retired\", false).ifPresent(criteria::add);\n+\t\t\n+\t\thandleName(criteria, name);\n+\t\thandleCity(criteria, city);\n+\t\thandleCountry(criteria, country);\n+\t\thandlePostalCode(criteria, postalCode);\n+\t\thandleState(criteria, state);\n+\t\thandleTag(criteria, tag);\n+\t\thandleParentLocation(criteria, parent);\n+\t\thandleSort(criteria, sort);\n+\t\t\n+\t\treturn criteria.list();\n \t}\n \t\n \t@Override\n-\tpublic Collection<Location> findLocationsByCity(String city) {\n-\t\treturn sessionFactory.getCurrentSession().createCriteria(Location.class).add(eq(\"cityVillage\", city)).list();\n+\tpublic List<LocationAttribute> getActiveAttributesByLocationAndAttributeTypeUuid(Location location,\n+\t        String locationAttributeTypeUuid) {\n+\t\treturn (List<LocationAttribute>) sessionFactory.getCurrentSession().createCriteria(LocationAttribute.class)\n+\t\t        .createAlias(\"location\", \"l\", JoinType.INNER_JOIN, eq(\"l.id\", location.getId()))\n+\t\t        .createAlias(\"attributeType\", \"lat\").add(eq(\"lat.uuid\", locationAttributeTypeUuid)).add(eq(\"voided\", false))\n+\t\t        .list();\n \t}\n \t\n-\t@Override\n-\tpublic Collection<Location> findLocationsByCountry(String country) {\n-\t\treturn sessionFactory.getCurrentSession().createCriteria(Location.class).add(eq(\"country\", country)).list();\n+\tprivate void handleName(Criteria criteria, StringOrListParam namePattern) {\n+\t\tif (namePattern != null) {\n+\t\t\thandleOrListParam(namePattern, (givenName) -> propertyLike(\"name\", givenName)).ifPresent(criteria::add);\n+\t\t}\n \t}\n \t\n-\t@Override\n-\tpublic Collection<Location> findLocationsByPostalCode(String postalCode) {\n-\t\treturn sessionFactory.getCurrentSession().createCriteria(Location.class).add(eq(\"postalCode\", postalCode)).list();\n+\tprivate void handleCity(Criteria criteria, StringOrListParam city) {\n+\t\tif (city != null) {\n+\t\t\thandleOrListParam(city, (givenCity) -> propertyLike(\"cityVillage\", givenCity)).ifPresent(criteria::add);\n+\t\t}\n \t}\n \t\n-\t@Override\n-\tpublic Collection<Location> findLocationsByState(String state) {\n-\t\treturn sessionFactory.getCurrentSession().createCriteria(Location.class).add(eq(\"stateProvince\", state)).list();\n+\tprivate void handleCountry(Criteria criteria, StringOrListParam country) {\n+\t\tif (country != null) {\n+\t\t\thandleOrListParam(country, (givenCountry) -> propertyLike(\"country\", givenCountry)).ifPresent(criteria::add);", "originalCommit": "c9cc6886767eda1994307473ea39527ab2208bd5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5ecbc70d13f872e7817bbfca3942c8a836eb221d", "chunk": "diff --git a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImpl.java b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImpl.java\nindex 4ff2d73e..f1537bc1 100644\n--- a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImpl.java\n+++ b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImpl.java\n\n@@ -60,8 +58,8 @@ public class FhirLocationDaoImpl extends BaseDaoImpl implements FhirLocationDao\n \t        SortSpec sort) {\n \t\t\n \t\tCriteria criteria = this.sessionFactory.getCurrentSession().createCriteria(Location.class);\n-\t\thandleBooleanProperty(\"retired\", false).ifPresent(criteria::add);\n \t\t\n+\t\thandleBooleanProperty(\"retired\", false).ifPresent(criteria::add);\n \t\thandleName(criteria, name);\n \t\thandleCity(criteria, city);\n \t\thandleCountry(criteria, country);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDI3OTAzNQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/98#discussion_r390279035", "bodyText": "Ditto given", "author": "ibacher", "createdAt": "2020-03-10T12:30:12Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImpl.java", "diffHunk": "@@ -42,43 +55,97 @@ public Location getLocationByUuid(String uuid) {\n \t}\n \t\n \t@Override\n-\tpublic Collection<Location> findLocationByName(String name) {\n-\t\treturn sessionFactory.getCurrentSession().createCriteria(Location.class).add(eq(\"name\", name)).list();\n+\tpublic Collection<Location> searchForLocations(StringOrListParam name, StringOrListParam city, StringOrListParam country,\n+\t        StringOrListParam postalCode, StringOrListParam state, TokenOrListParam tag, ReferenceOrListParam parent,\n+\t        SortSpec sort) {\n+\t\t\n+\t\tCriteria criteria = this.sessionFactory.getCurrentSession().createCriteria(Location.class);\n+\t\thandleBooleanProperty(\"retired\", false).ifPresent(criteria::add);\n+\t\t\n+\t\thandleName(criteria, name);\n+\t\thandleCity(criteria, city);\n+\t\thandleCountry(criteria, country);\n+\t\thandlePostalCode(criteria, postalCode);\n+\t\thandleState(criteria, state);\n+\t\thandleTag(criteria, tag);\n+\t\thandleParentLocation(criteria, parent);\n+\t\thandleSort(criteria, sort);\n+\t\t\n+\t\treturn criteria.list();\n \t}\n \t\n \t@Override\n-\tpublic Collection<Location> findLocationsByCity(String city) {\n-\t\treturn sessionFactory.getCurrentSession().createCriteria(Location.class).add(eq(\"cityVillage\", city)).list();\n+\tpublic List<LocationAttribute> getActiveAttributesByLocationAndAttributeTypeUuid(Location location,\n+\t        String locationAttributeTypeUuid) {\n+\t\treturn (List<LocationAttribute>) sessionFactory.getCurrentSession().createCriteria(LocationAttribute.class)\n+\t\t        .createAlias(\"location\", \"l\", JoinType.INNER_JOIN, eq(\"l.id\", location.getId()))\n+\t\t        .createAlias(\"attributeType\", \"lat\").add(eq(\"lat.uuid\", locationAttributeTypeUuid)).add(eq(\"voided\", false))\n+\t\t        .list();\n \t}\n \t\n-\t@Override\n-\tpublic Collection<Location> findLocationsByCountry(String country) {\n-\t\treturn sessionFactory.getCurrentSession().createCriteria(Location.class).add(eq(\"country\", country)).list();\n+\tprivate void handleName(Criteria criteria, StringOrListParam namePattern) {\n+\t\tif (namePattern != null) {\n+\t\t\thandleOrListParam(namePattern, (givenName) -> propertyLike(\"name\", givenName)).ifPresent(criteria::add);\n+\t\t}\n \t}\n \t\n-\t@Override\n-\tpublic Collection<Location> findLocationsByPostalCode(String postalCode) {\n-\t\treturn sessionFactory.getCurrentSession().createCriteria(Location.class).add(eq(\"postalCode\", postalCode)).list();\n+\tprivate void handleCity(Criteria criteria, StringOrListParam city) {\n+\t\tif (city != null) {\n+\t\t\thandleOrListParam(city, (givenCity) -> propertyLike(\"cityVillage\", givenCity)).ifPresent(criteria::add);\n+\t\t}\n \t}\n \t\n-\t@Override\n-\tpublic Collection<Location> findLocationsByState(String state) {\n-\t\treturn sessionFactory.getCurrentSession().createCriteria(Location.class).add(eq(\"stateProvince\", state)).list();\n+\tprivate void handleCountry(Criteria criteria, StringOrListParam country) {\n+\t\tif (country != null) {\n+\t\t\thandleOrListParam(country, (givenCountry) -> propertyLike(\"country\", givenCountry)).ifPresent(criteria::add);\n+\t\t}\n \t}\n \t\n-\t@Override\n-\tpublic Collection<Location> findLocationsByTag(TokenParam tag) {\n-\t\treturn sessionFactory.getCurrentSession().createCriteria(Location.class).createAlias(\"tags\", \"t\")\n-\t\t        .add(eq(\"t.name\", tag.getValue())).list();\n+\tprivate void handlePostalCode(Criteria criteria, StringOrListParam postalCode) {\n+\t\tif (postalCode != null) {\n+\t\t\thandleOrListParam(postalCode, (givenPostalCode) -> propertyLike(\"postalCode\", givenPostalCode))\n+\t\t\t        .ifPresent(criteria::add);\n+\t\t}\n+\t}\n+\t\n+\tprivate void handleState(Criteria criteria, StringOrListParam state) {\n+\t\tif (state != null) {\n+\t\t\thandleOrListParam(state, (givenState) -> propertyLike(\"stateProvince\", givenState)).ifPresent(criteria::add);", "originalCommit": "c9cc6886767eda1994307473ea39527ab2208bd5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5ecbc70d13f872e7817bbfca3942c8a836eb221d", "chunk": "diff --git a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImpl.java b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImpl.java\nindex 4ff2d73e..f1537bc1 100644\n--- a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImpl.java\n+++ b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImpl.java\n\n@@ -60,8 +58,8 @@ public class FhirLocationDaoImpl extends BaseDaoImpl implements FhirLocationDao\n \t        SortSpec sort) {\n \t\t\n \t\tCriteria criteria = this.sessionFactory.getCurrentSession().createCriteria(Location.class);\n-\t\thandleBooleanProperty(\"retired\", false).ifPresent(criteria::add);\n \t\t\n+\t\thandleBooleanProperty(\"retired\", false).ifPresent(criteria::add);\n \t\thandleName(criteria, name);\n \t\thandleCity(criteria, city);\n \t\thandleCountry(criteria, country);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDI3OTIyMw==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/98#discussion_r390279223", "bodyText": "The tag parameter should be called tags", "author": "ibacher", "createdAt": "2020-03-10T12:30:38Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImpl.java", "diffHunk": "@@ -42,43 +55,97 @@ public Location getLocationByUuid(String uuid) {\n \t}\n \t\n \t@Override\n-\tpublic Collection<Location> findLocationByName(String name) {\n-\t\treturn sessionFactory.getCurrentSession().createCriteria(Location.class).add(eq(\"name\", name)).list();\n+\tpublic Collection<Location> searchForLocations(StringOrListParam name, StringOrListParam city, StringOrListParam country,\n+\t        StringOrListParam postalCode, StringOrListParam state, TokenOrListParam tag, ReferenceOrListParam parent,\n+\t        SortSpec sort) {\n+\t\t\n+\t\tCriteria criteria = this.sessionFactory.getCurrentSession().createCriteria(Location.class);\n+\t\thandleBooleanProperty(\"retired\", false).ifPresent(criteria::add);\n+\t\t\n+\t\thandleName(criteria, name);\n+\t\thandleCity(criteria, city);\n+\t\thandleCountry(criteria, country);\n+\t\thandlePostalCode(criteria, postalCode);\n+\t\thandleState(criteria, state);\n+\t\thandleTag(criteria, tag);\n+\t\thandleParentLocation(criteria, parent);\n+\t\thandleSort(criteria, sort);\n+\t\t\n+\t\treturn criteria.list();\n \t}\n \t\n \t@Override\n-\tpublic Collection<Location> findLocationsByCity(String city) {\n-\t\treturn sessionFactory.getCurrentSession().createCriteria(Location.class).add(eq(\"cityVillage\", city)).list();\n+\tpublic List<LocationAttribute> getActiveAttributesByLocationAndAttributeTypeUuid(Location location,\n+\t        String locationAttributeTypeUuid) {\n+\t\treturn (List<LocationAttribute>) sessionFactory.getCurrentSession().createCriteria(LocationAttribute.class)\n+\t\t        .createAlias(\"location\", \"l\", JoinType.INNER_JOIN, eq(\"l.id\", location.getId()))\n+\t\t        .createAlias(\"attributeType\", \"lat\").add(eq(\"lat.uuid\", locationAttributeTypeUuid)).add(eq(\"voided\", false))\n+\t\t        .list();\n \t}\n \t\n-\t@Override\n-\tpublic Collection<Location> findLocationsByCountry(String country) {\n-\t\treturn sessionFactory.getCurrentSession().createCriteria(Location.class).add(eq(\"country\", country)).list();\n+\tprivate void handleName(Criteria criteria, StringOrListParam namePattern) {\n+\t\tif (namePattern != null) {\n+\t\t\thandleOrListParam(namePattern, (givenName) -> propertyLike(\"name\", givenName)).ifPresent(criteria::add);\n+\t\t}\n \t}\n \t\n-\t@Override\n-\tpublic Collection<Location> findLocationsByPostalCode(String postalCode) {\n-\t\treturn sessionFactory.getCurrentSession().createCriteria(Location.class).add(eq(\"postalCode\", postalCode)).list();\n+\tprivate void handleCity(Criteria criteria, StringOrListParam city) {\n+\t\tif (city != null) {\n+\t\t\thandleOrListParam(city, (givenCity) -> propertyLike(\"cityVillage\", givenCity)).ifPresent(criteria::add);\n+\t\t}\n \t}\n \t\n-\t@Override\n-\tpublic Collection<Location> findLocationsByState(String state) {\n-\t\treturn sessionFactory.getCurrentSession().createCriteria(Location.class).add(eq(\"stateProvince\", state)).list();\n+\tprivate void handleCountry(Criteria criteria, StringOrListParam country) {\n+\t\tif (country != null) {\n+\t\t\thandleOrListParam(country, (givenCountry) -> propertyLike(\"country\", givenCountry)).ifPresent(criteria::add);\n+\t\t}\n \t}\n \t\n-\t@Override\n-\tpublic Collection<Location> findLocationsByTag(TokenParam tag) {\n-\t\treturn sessionFactory.getCurrentSession().createCriteria(Location.class).createAlias(\"tags\", \"t\")\n-\t\t        .add(eq(\"t.name\", tag.getValue())).list();\n+\tprivate void handlePostalCode(Criteria criteria, StringOrListParam postalCode) {\n+\t\tif (postalCode != null) {\n+\t\t\thandleOrListParam(postalCode, (givenPostalCode) -> propertyLike(\"postalCode\", givenPostalCode))\n+\t\t\t        .ifPresent(criteria::add);\n+\t\t}\n+\t}\n+\t\n+\tprivate void handleState(Criteria criteria, StringOrListParam state) {\n+\t\tif (state != null) {\n+\t\t\thandleOrListParam(state, (givenState) -> propertyLike(\"stateProvince\", givenState)).ifPresent(criteria::add);\n+\t\t}\n+\t}\n+\t\n+\tprivate void handleTag(Criteria criteria, TokenOrListParam tag) {", "originalCommit": "c9cc6886767eda1994307473ea39527ab2208bd5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5ecbc70d13f872e7817bbfca3942c8a836eb221d", "chunk": "diff --git a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImpl.java b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImpl.java\nindex 4ff2d73e..f1537bc1 100644\n--- a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImpl.java\n+++ b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImpl.java\n\n@@ -60,8 +58,8 @@ public class FhirLocationDaoImpl extends BaseDaoImpl implements FhirLocationDao\n \t        SortSpec sort) {\n \t\t\n \t\tCriteria criteria = this.sessionFactory.getCurrentSession().createCriteria(Location.class);\n-\t\thandleBooleanProperty(\"retired\", false).ifPresent(criteria::add);\n \t\t\n+\t\thandleBooleanProperty(\"retired\", false).ifPresent(criteria::add);\n \t\thandleName(criteria, name);\n \t\thandleCity(criteria, city);\n \t\thandleCountry(criteria, country);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDI3OTQyNw==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/98#discussion_r390279427", "bodyText": "Ditto given.", "author": "ibacher", "createdAt": "2020-03-10T12:31:01Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImpl.java", "diffHunk": "@@ -42,43 +55,97 @@ public Location getLocationByUuid(String uuid) {\n \t}\n \t\n \t@Override\n-\tpublic Collection<Location> findLocationByName(String name) {\n-\t\treturn sessionFactory.getCurrentSession().createCriteria(Location.class).add(eq(\"name\", name)).list();\n+\tpublic Collection<Location> searchForLocations(StringOrListParam name, StringOrListParam city, StringOrListParam country,\n+\t        StringOrListParam postalCode, StringOrListParam state, TokenOrListParam tag, ReferenceOrListParam parent,\n+\t        SortSpec sort) {\n+\t\t\n+\t\tCriteria criteria = this.sessionFactory.getCurrentSession().createCriteria(Location.class);\n+\t\thandleBooleanProperty(\"retired\", false).ifPresent(criteria::add);\n+\t\t\n+\t\thandleName(criteria, name);\n+\t\thandleCity(criteria, city);\n+\t\thandleCountry(criteria, country);\n+\t\thandlePostalCode(criteria, postalCode);\n+\t\thandleState(criteria, state);\n+\t\thandleTag(criteria, tag);\n+\t\thandleParentLocation(criteria, parent);\n+\t\thandleSort(criteria, sort);\n+\t\t\n+\t\treturn criteria.list();\n \t}\n \t\n \t@Override\n-\tpublic Collection<Location> findLocationsByCity(String city) {\n-\t\treturn sessionFactory.getCurrentSession().createCriteria(Location.class).add(eq(\"cityVillage\", city)).list();\n+\tpublic List<LocationAttribute> getActiveAttributesByLocationAndAttributeTypeUuid(Location location,\n+\t        String locationAttributeTypeUuid) {\n+\t\treturn (List<LocationAttribute>) sessionFactory.getCurrentSession().createCriteria(LocationAttribute.class)\n+\t\t        .createAlias(\"location\", \"l\", JoinType.INNER_JOIN, eq(\"l.id\", location.getId()))\n+\t\t        .createAlias(\"attributeType\", \"lat\").add(eq(\"lat.uuid\", locationAttributeTypeUuid)).add(eq(\"voided\", false))\n+\t\t        .list();\n \t}\n \t\n-\t@Override\n-\tpublic Collection<Location> findLocationsByCountry(String country) {\n-\t\treturn sessionFactory.getCurrentSession().createCriteria(Location.class).add(eq(\"country\", country)).list();\n+\tprivate void handleName(Criteria criteria, StringOrListParam namePattern) {\n+\t\tif (namePattern != null) {\n+\t\t\thandleOrListParam(namePattern, (givenName) -> propertyLike(\"name\", givenName)).ifPresent(criteria::add);\n+\t\t}\n \t}\n \t\n-\t@Override\n-\tpublic Collection<Location> findLocationsByPostalCode(String postalCode) {\n-\t\treturn sessionFactory.getCurrentSession().createCriteria(Location.class).add(eq(\"postalCode\", postalCode)).list();\n+\tprivate void handleCity(Criteria criteria, StringOrListParam city) {\n+\t\tif (city != null) {\n+\t\t\thandleOrListParam(city, (givenCity) -> propertyLike(\"cityVillage\", givenCity)).ifPresent(criteria::add);\n+\t\t}\n \t}\n \t\n-\t@Override\n-\tpublic Collection<Location> findLocationsByState(String state) {\n-\t\treturn sessionFactory.getCurrentSession().createCriteria(Location.class).add(eq(\"stateProvince\", state)).list();\n+\tprivate void handleCountry(Criteria criteria, StringOrListParam country) {\n+\t\tif (country != null) {\n+\t\t\thandleOrListParam(country, (givenCountry) -> propertyLike(\"country\", givenCountry)).ifPresent(criteria::add);\n+\t\t}\n \t}\n \t\n-\t@Override\n-\tpublic Collection<Location> findLocationsByTag(TokenParam tag) {\n-\t\treturn sessionFactory.getCurrentSession().createCriteria(Location.class).createAlias(\"tags\", \"t\")\n-\t\t        .add(eq(\"t.name\", tag.getValue())).list();\n+\tprivate void handlePostalCode(Criteria criteria, StringOrListParam postalCode) {\n+\t\tif (postalCode != null) {\n+\t\t\thandleOrListParam(postalCode, (givenPostalCode) -> propertyLike(\"postalCode\", givenPostalCode))\n+\t\t\t        .ifPresent(criteria::add);\n+\t\t}\n+\t}\n+\t\n+\tprivate void handleState(Criteria criteria, StringOrListParam state) {\n+\t\tif (state != null) {\n+\t\t\thandleOrListParam(state, (givenState) -> propertyLike(\"stateProvince\", givenState)).ifPresent(criteria::add);\n+\t\t}\n+\t}\n+\t\n+\tprivate void handleTag(Criteria criteria, TokenOrListParam tag) {\n+\t\tif (tag != null) {\n+\t\t\tcriteria.createAlias(\"tags\", \"t\");\n+\t\t\thandleOrListParam(tag, (givenTag) -> Optional.of(eq(\"t.name\", givenTag.getValue()))).ifPresent(criteria::add);", "originalCommit": "c9cc6886767eda1994307473ea39527ab2208bd5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5ecbc70d13f872e7817bbfca3942c8a836eb221d", "chunk": "diff --git a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImpl.java b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImpl.java\nindex 4ff2d73e..f1537bc1 100644\n--- a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImpl.java\n+++ b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImpl.java\n\n@@ -60,8 +58,8 @@ public class FhirLocationDaoImpl extends BaseDaoImpl implements FhirLocationDao\n \t        SortSpec sort) {\n \t\t\n \t\tCriteria criteria = this.sessionFactory.getCurrentSession().createCriteria(Location.class);\n-\t\thandleBooleanProperty(\"retired\", false).ifPresent(criteria::add);\n \t\t\n+\t\thandleBooleanProperty(\"retired\", false).ifPresent(criteria::add);\n \t\thandleName(criteria, name);\n \t\thandleCity(criteria, city);\n \t\thandleCountry(criteria, country);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDI4MDE5NQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/98#discussion_r390280195", "bodyText": "Why is this here instead of in the LocationDaoImpl? Unlike other reference handlers, this is pretty specific to Locations.", "author": "ibacher", "createdAt": "2020-03-10T12:32:38Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/BaseDaoImpl.java", "diffHunk": "@@ -470,6 +474,28 @@ protected void handleLocationReference(Criteria criteria, ReferenceParam locatio\n \t\t}\n \t}\n \t\n+\tprotected Optional<Criterion> handleParentReference(ReferenceParam parentReference) {", "originalCommit": "c9cc6886767eda1994307473ea39527ab2208bd5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5ecbc70d13f872e7817bbfca3942c8a836eb221d", "chunk": "diff --git a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/BaseDaoImpl.java b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/BaseDaoImpl.java\nindex 4ece40f0..70ceb53e 100644\n--- a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/BaseDaoImpl.java\n+++ b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/BaseDaoImpl.java\n\n@@ -474,28 +481,6 @@ public abstract class BaseDaoImpl {\n \t\t}\n \t}\n \t\n-\tprotected Optional<Criterion> handleParentReference(ReferenceParam parentReference) {\n-\t\tif (parentReference != null) {\n-\t\t\tif (parentReference.getChain() != null) {\n-\t\t\t\tswitch (parentReference.getChain()) {\n-\t\t\t\t\tcase Location.SP_NAME:\n-\t\t\t\t\t\treturn propertyLike(\"name\", parentReference.getValue());\n-\t\t\t\t\tcase Location.SP_ADDRESS_CITY:\n-\t\t\t\t\t\treturn propertyLike(\"cityVillage\", parentReference.getValue());\n-\t\t\t\t\tcase Location.SP_ADDRESS_STATE:\n-\t\t\t\t\t\treturn propertyLike(\"stateProvince\", parentReference.getValue());\n-\t\t\t\t\tcase Location.SP_ADDRESS_COUNTRY:\n-\t\t\t\t\t\treturn propertyLike(\"country\", parentReference.getValue());\n-\t\t\t\t\tcase Location.SP_ADDRESS_POSTALCODE:\n-\t\t\t\t\t\treturn propertyLike(\"postalCode\", parentReference.getValue());\n-\t\t\t\t\tcase \"\":\n-\t\t\t\t\t\treturn Optional.of(eq(\"locationId\", Integer.parseInt(parentReference.getValue())));\n-\t\t\t\t}\n-\t\t\t}\n-\t\t}\n-\t\treturn Optional.empty();\n-\t}\n-\t\n \tprotected void handleParticipantReference(Criteria criteria, ReferenceParam participantReference) {\n \t\tif (participantReference != null) {\n \t\t\tcriteria.createAlias(\"encounterProviders\", \"ep\");\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDI4MDg0OQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/98#discussion_r390280849", "bodyText": "We shouldn't expect a locationId passed in here. We should expect a uuid for the location instead. Generally speaking, except for the special case of concepts, we should only be dealing with UUIDs (concepts are special for historical reasons).", "author": "ibacher", "createdAt": "2020-03-10T12:33:57Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/BaseDaoImpl.java", "diffHunk": "@@ -470,6 +474,28 @@ protected void handleLocationReference(Criteria criteria, ReferenceParam locatio\n \t\t}\n \t}\n \t\n+\tprotected Optional<Criterion> handleParentReference(ReferenceParam parentReference) {\n+\t\tif (parentReference != null) {\n+\t\t\tif (parentReference.getChain() != null) {\n+\t\t\t\tswitch (parentReference.getChain()) {\n+\t\t\t\t\tcase Location.SP_NAME:\n+\t\t\t\t\t\treturn propertyLike(\"name\", parentReference.getValue());\n+\t\t\t\t\tcase Location.SP_ADDRESS_CITY:\n+\t\t\t\t\t\treturn propertyLike(\"cityVillage\", parentReference.getValue());\n+\t\t\t\t\tcase Location.SP_ADDRESS_STATE:\n+\t\t\t\t\t\treturn propertyLike(\"stateProvince\", parentReference.getValue());\n+\t\t\t\t\tcase Location.SP_ADDRESS_COUNTRY:\n+\t\t\t\t\t\treturn propertyLike(\"country\", parentReference.getValue());\n+\t\t\t\t\tcase Location.SP_ADDRESS_POSTALCODE:\n+\t\t\t\t\t\treturn propertyLike(\"postalCode\", parentReference.getValue());\n+\t\t\t\t\tcase \"\":\n+\t\t\t\t\t\treturn Optional.of(eq(\"locationId\", Integer.parseInt(parentReference.getValue())));", "originalCommit": "c9cc6886767eda1994307473ea39527ab2208bd5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5ecbc70d13f872e7817bbfca3942c8a836eb221d", "chunk": "diff --git a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/BaseDaoImpl.java b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/BaseDaoImpl.java\nindex 4ece40f0..70ceb53e 100644\n--- a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/BaseDaoImpl.java\n+++ b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/BaseDaoImpl.java\n\n@@ -474,28 +481,6 @@ public abstract class BaseDaoImpl {\n \t\t}\n \t}\n \t\n-\tprotected Optional<Criterion> handleParentReference(ReferenceParam parentReference) {\n-\t\tif (parentReference != null) {\n-\t\t\tif (parentReference.getChain() != null) {\n-\t\t\t\tswitch (parentReference.getChain()) {\n-\t\t\t\t\tcase Location.SP_NAME:\n-\t\t\t\t\t\treturn propertyLike(\"name\", parentReference.getValue());\n-\t\t\t\t\tcase Location.SP_ADDRESS_CITY:\n-\t\t\t\t\t\treturn propertyLike(\"cityVillage\", parentReference.getValue());\n-\t\t\t\t\tcase Location.SP_ADDRESS_STATE:\n-\t\t\t\t\t\treturn propertyLike(\"stateProvince\", parentReference.getValue());\n-\t\t\t\t\tcase Location.SP_ADDRESS_COUNTRY:\n-\t\t\t\t\t\treturn propertyLike(\"country\", parentReference.getValue());\n-\t\t\t\t\tcase Location.SP_ADDRESS_POSTALCODE:\n-\t\t\t\t\t\treturn propertyLike(\"postalCode\", parentReference.getValue());\n-\t\t\t\t\tcase \"\":\n-\t\t\t\t\t\treturn Optional.of(eq(\"locationId\", Integer.parseInt(parentReference.getValue())));\n-\t\t\t\t}\n-\t\t\t}\n-\t\t}\n-\t\treturn Optional.empty();\n-\t}\n-\t\n \tprotected void handleParticipantReference(Criteria criteria, ReferenceParam participantReference) {\n \t\tif (participantReference != null) {\n \t\t\tcriteria.createAlias(\"encounterProviders\", \"ep\");\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDI4Mjc0Ng==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/98#discussion_r390282746", "bodyText": "I wouldn't import this statically for consistency with the other parameters.", "author": "ibacher", "createdAt": "2020-03-10T12:37:50Z", "path": "omod/src/main/java/org/openmrs/module/fhir2/providers/LocationFhirResourceProvider.java", "diffHunk": "@@ -9,18 +9,23 @@\n  */\n package org.openmrs.module.fhir2.providers;\n \n+import static ca.uhn.fhir.rest.api.Constants.PARAM_TAG;", "originalCommit": "c9cc6886767eda1994307473ea39527ab2208bd5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5ecbc70d13f872e7817bbfca3942c8a836eb221d", "chunk": "diff --git a/omod/src/main/java/org/openmrs/module/fhir2/providers/LocationFhirResourceProvider.java b/omod/src/main/java/org/openmrs/module/fhir2/providers/LocationFhirResourceProvider.java\nindex 01012007..d28f6d0e 100644\n--- a/omod/src/main/java/org/openmrs/module/fhir2/providers/LocationFhirResourceProvider.java\n+++ b/omod/src/main/java/org/openmrs/module/fhir2/providers/LocationFhirResourceProvider.java\n\n@@ -9,8 +9,6 @@\n  */\n package org.openmrs.module.fhir2.providers;\n \n-import static ca.uhn.fhir.rest.api.Constants.PARAM_TAG;\n-\n import javax.inject.Inject;\n import javax.validation.constraints.NotNull;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDI4MzE3OA==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/98#discussion_r390283178", "bodyText": "We actually do want most of these tests, even if they need to be modified.", "author": "ibacher", "createdAt": "2020-03-10T12:38:45Z", "path": "omod/src/test/java/org/openmrs/module/fhir2/providers/LocationFhirResourceProviderTest.java", "diffHunk": "@@ -129,124 +121,22 @@ public void getLocationWithWrongUuid_shouldThrowResourceNotFoundException() {\n \t}\n \t\n \t@Test\n-\tpublic void findLocationsByName_shouldReturnMatchingBundleOfLocations() {", "originalCommit": "c9cc6886767eda1994307473ea39527ab2208bd5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5ecbc70d13f872e7817bbfca3942c8a836eb221d", "chunk": "diff --git a/omod/src/test/java/org/openmrs/module/fhir2/providers/LocationFhirResourceProviderTest.java b/omod/src/test/java/org/openmrs/module/fhir2/providers/LocationFhirResourceProviderTest.java\nindex a5e09e67..7bef638b 100644\n--- a/omod/src/test/java/org/openmrs/module/fhir2/providers/LocationFhirResourceProviderTest.java\n+++ b/omod/src/test/java/org/openmrs/module/fhir2/providers/LocationFhirResourceProviderTest.java\n\n@@ -120,6 +124,85 @@ public class LocationFhirResourceProviderTest extends BaseFhirProvenanceResource\n \t\tassertThat(result, nullValue());\n \t}\n \t\n+\t@Test\n+\tpublic void findLocationsByName_shouldReturnMatchingBundleOfLocations() {\n+\t\tStringOrListParam nameParam = new StringOrListParam().add(new StringParam(LOCATION_NAME));\n+\t\twhen(locationService.searchForLocations(argThat(Matchers.is(nameParam)), isNull(), isNull(), isNull(), isNull(),\n+\t\t    isNull(), isNull(), isNull())).thenReturn(Collections.singletonList(location));\n+\t\t\n+\t\tBundle results = resourceProvider.searchLocations(nameParam, null, null, null, null, null, null, null);\n+\t\t\n+\t\tassertThat(results, notNullValue());\n+\t\tassertThat(results.isResource(), is(true));\n+\t\tassertThat(results.getEntry().size(), greaterThanOrEqualTo(1));\n+\t}\n+\t\n+\t@Test\n+\tpublic void findLocationsByCity_shouldReturnMatchingBundleOfLocations() {\n+\t\tStringOrListParam cityParam = new StringOrListParam().add(new StringParam(CITY));\n+\t\twhen(locationService.searchForLocations(isNull(), argThat(Matchers.is(cityParam)), isNull(), isNull(), isNull(),\n+\t\t    isNull(), isNull(), isNull())).thenReturn(Collections.singletonList(location));\n+\t\t\n+\t\tBundle results = resourceProvider.searchLocations(null, cityParam, null, null, null, null, null, null);\n+\t\t\n+\t\tassertThat(results, Matchers.notNullValue());\n+\t\tassertThat(results.isResource(), Matchers.is(true));\n+\t\tassertThat(results.getEntry().size(), greaterThanOrEqualTo(1));\n+\t}\n+\t\n+\t@Test\n+\tpublic void findLocationsByCountry_shouldReturnMatchingBundleOfLocations() {\n+\t\tStringOrListParam countryParam = new StringOrListParam().add(new StringParam(COUNTRY));\n+\t\twhen(locationService.searchForLocations(isNull(), isNull(), argThat(Matchers.is(countryParam)), isNull(), isNull(),\n+\t\t    isNull(), isNull(), isNull())).thenReturn(Collections.singletonList(location));\n+\t\t\n+\t\tBundle results = resourceProvider.searchLocations(null, null, countryParam, null, null, null, null, null);\n+\t\t\n+\t\tassertThat(results, Matchers.notNullValue());\n+\t\tassertThat(results.isResource(), Matchers.is(true));\n+\t\tassertThat(results.getEntry().size(), greaterThanOrEqualTo(1));\n+\t}\n+\t\n+\t@Test\n+\tpublic void findLocationsByState_shouldReturnMatchingBundleOfLocations() {\n+\t\tStringOrListParam stateParam = new StringOrListParam().add(new StringParam(STATE));\n+\t\twhen(locationService.searchForLocations(isNull(), isNull(), isNull(), isNull(), argThat(Matchers.is(stateParam)),\n+\t\t    isNull(), isNull(), isNull())).thenReturn(Collections.singletonList(location));\n+\t\t\n+\t\tBundle results = resourceProvider.searchLocations(null, null, null, null, stateParam, null, null, null);\n+\t\t\n+\t\tassertThat(results, Matchers.notNullValue());\n+\t\tassertThat(results.isResource(), Matchers.is(true));\n+\t\tassertThat(results.getEntry().size(), greaterThanOrEqualTo(1));\n+\t}\n+\t\n+\t@Test\n+\tpublic void findLocationsByPostalCode_shouldReturnMatchingBundleOfLocations() {\n+\t\tStringOrListParam postalCodeParam = new StringOrListParam().add(new StringParam(POSTAL_CODE));\n+\t\twhen(locationService.searchForLocations(isNull(), isNull(), isNull(), argThat(Matchers.is(postalCodeParam)),\n+\t\t    isNull(), isNull(), isNull(), isNull())).thenReturn(Collections.singletonList(location));\n+\t\t\n+\t\tBundle results = resourceProvider.searchLocations(null, null, null, postalCodeParam, null, null, null, null);\n+\t\t\n+\t\tassertThat(results, Matchers.notNullValue());\n+\t\tassertThat(results.isResource(), Matchers.is(true));\n+\t\tassertThat(results.getEntry().size(), greaterThanOrEqualTo(1));\n+\t}\n+\t\n+\t@Test\n+\tpublic void findLocationsByTags_shouldReturnLocationsContainingGivenTag() {\n+\t\tTokenOrListParam tag = new TokenOrListParam()\n+\t\t        .add(new TokenParam(FhirConstants.OPENMRS_FHIR_EXT_LOCATION_TAG, LOGIN_LOCATION_TAG_NAME));\n+\t\twhen(locationService.searchForLocations(isNull(), isNull(), isNull(), isNull(), isNull(), argThat(Matchers.is(tag)),\n+\t\t    isNull(), isNull())).thenReturn(Collections.singletonList(location));\n+\t\t\n+\t\tBundle results = resourceProvider.searchLocations(null, null, null, null, null, tag, null, null);\n+\t\t\n+\t\tassertThat(results, notNullValue());\n+\t\tassertThat(results.isResource(), is(true));\n+\t\tassertThat(results.getEntry().size(), greaterThanOrEqualTo(1));\n+\t}\n+\t\n \t@Test\n \tpublic void searchLocations_shouldReturnMatchingBundleOfLocations() {\n \t\tList<Location> locations = new ArrayList<>();\n"}}, {"oid": "5ecbc70d13f872e7817bbfca3942c8a836eb221d", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/5ecbc70d13f872e7817bbfca3942c8a836eb221d", "message": "FM2-80: Improve Search for Location Resource", "committedDate": "2020-03-10T17:42:41Z", "type": "forcePushed"}, {"oid": "1c598b44593fe4dda5d2d6dec43a3b4fa22c73c0", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/1c598b44593fe4dda5d2d6dec43a3b4fa22c73c0", "message": "FM2-80: Improve Search for Location Resource", "committedDate": "2020-03-10T17:47:47Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDU0NjU5OQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/98#discussion_r390546599", "bodyText": "Don't include this in this PR", "author": "ibacher", "createdAt": "2020-03-10T19:05:47Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirTaskDaoImpl.java", "diffHunk": "@@ -78,7 +78,8 @@ public FhirTask getTaskByUuid(String uuid) {\n \t\t// TODO: Handle optional params\n \t\t// Task.basedOn\n \t\tif (validReferenceParam(basedOnReference)) {\n-\t\t\tcriteria.createAlias(\"basedOnReferences\", \"bo\").add(Restrictions.eq(\"bo.reference\", basedOnReference.getIdPart()))", "originalCommit": "1c598b44593fe4dda5d2d6dec43a3b4fa22c73c0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTExODQyMA==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/98#discussion_r391118420", "bodyText": "I really don't know how it came here!", "author": "varung-31", "createdAt": "2020-03-11T16:54:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDU0NjU5OQ=="}], "type": "inlineReview", "revised_code": {"commit": "f80ae72b9a1a59df5ef632b162b2727332acc8b6", "chunk": "diff --git a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirTaskDaoImpl.java b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirTaskDaoImpl.java\nindex c89e757b..25ee49da 100644\n--- a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirTaskDaoImpl.java\n+++ b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirTaskDaoImpl.java\n\n@@ -78,8 +78,7 @@ public class FhirTaskDaoImpl extends BaseDaoImpl implements FhirTaskDao {\n \t\t// TODO: Handle optional params\n \t\t// Task.basedOn\n \t\tif (validReferenceParam(basedOnReference)) {\n-\t\t\tcriteria.createAlias(\"basedOnReferences\", \"bo\")\n-\t\t\t        .add(Restrictions.eq(\"bo.reference\", basedOnReference.getIdPart()))\n+\t\t\tcriteria.createAlias(\"basedOnReferences\", \"bo\").add(Restrictions.eq(\"bo.reference\", basedOnReference.getIdPart()))\n \t\t\t        .add(Restrictions.eq(\"bo.type\", basedOnReference.getResourceType()));\n \t\t}\n \t\t\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDU1MDY0Nw==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/98#discussion_r390550647", "bodyText": "This should actually be .setValue(...).setChain(...) and so on for the others. The reason is that the .setValue() method resets the value of the chain. This will probably fix the coverage.", "author": "ibacher", "createdAt": "2020-03-10T19:12:40Z", "path": "api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImplTest.java", "diffHunk": "@@ -95,91 +118,201 @@ public void getLocationByUuid_shouldReturnNullWithUnknownUuid() {\n \t}\n \t\n \t@Test\n-\tpublic void findLocationByName_shouldReturnCorrectLocation() {\n-\t\tCollection<Location> locations = fhirLocationDao.findLocationByName(LOCATION_NAME);\n+\tpublic void searchForLocations_shouldReturnCorrectLocationByName() {\n+\t\tStringOrListParam location = new StringOrListParam().add(new StringParam(LOCATION_NAME));\n+\t\tCollection<Location> locations = fhirLocationDao.searchForLocations(location, null, null, null, null, null, null,\n+\t\t    null);\n \t\t\n \t\tassertThat(locations, notNullValue());\n \t\tassertThat(locations.size(), equalTo(1));\n+\t\tassertThat(locations.iterator().next().getName(), equalTo(LOCATION_NAME));\n \t}\n \t\n \t@Test\n-\tpublic void findLocationByName_shouldReturnEmptyCollectionWhenCalledWithUnknownName() {\n-\t\tCollection<Location> locations = fhirLocationDao.findLocationByName(UNKNOWN_LOCATION_NAME);\n+\tpublic void searchForLocations_shouldReturnEmptyCollectionWhenCalledWithUnknownName() {\n+\t\tStringOrListParam location = new StringOrListParam().add(new StringParam(UNKNOWN_LOCATION_NAME));\n+\t\tCollection<Location> locations = fhirLocationDao.searchForLocations(location, null, null, null, null, null, null,\n+\t\t    null);\n \t\t\n \t\tassertThat(locations, notNullValue());\n \t\tassertThat(locations.size(), equalTo(0));\n \t}\n \t\n \t@Test\n-\tpublic void findLocationByCity_shouldReturnCorrectLocation() {\n-\t\tCollection<Location> locations = fhirLocationDao.findLocationsByCity(LOCATION_CITY);\n+\tpublic void searchForLocations_shouldReturnCorrectLocationByCity() {\n+\t\tStringOrListParam city = new StringOrListParam().add(new StringParam(LOCATION_CITY));\n+\t\tCollection<Location> locations = fhirLocationDao.searchForLocations(null, city, null, null, null, null, null, null);\n \t\t\n \t\tassertThat(locations, notNullValue());\n-\t\tassertThat(locations.size(), greaterThanOrEqualTo(1));\n+\t\tassertThat(locations.size(), equalTo(1));\n+\t\tassertThat(locations.iterator().next().getCityVillage(), equalTo(LOCATION_CITY));\n \t}\n \t\n \t@Test\n-\tpublic void findLocationByCity_shouldReturnEmptyCollectionWhenCalledWithUnknownCity() {\n-\t\tCollection<Location> locations = fhirLocationDao.findLocationsByCity(UNKNOWN_LOCATION_CITY);\n+\tpublic void searchForLocations_shouldReturnEmptyCollectionWhenCalledWithUnknownCity() {\n+\t\tStringOrListParam city = new StringOrListParam().add(new StringParam(UNKNOWN_LOCATION_CITY));\n+\t\tCollection<Location> locations = fhirLocationDao.searchForLocations(null, city, null, null, null, null, null, null);\n \t\t\n \t\tassertThat(locations, notNullValue());\n \t\tassertThat(locations.size(), equalTo(0));\n \t}\n \t\n \t@Test\n-\tpublic void findLocationByCountry_shouldReturnCorrectLocation() {\n-\t\tCollection<Location> locations = fhirLocationDao.findLocationsByCountry(LOCATION_COUNTRY);\n+\tpublic void searchForLocations_shouldReturnCorrectLocationByCountry() {\n+\t\tStringOrListParam country = new StringOrListParam().add(new StringParam(LOCATION_COUNTRY));\n+\t\tCollection<Location> locations = fhirLocationDao.searchForLocations(null, null, country, null, null, null, null,\n+\t\t    null);\n \t\t\n \t\tassertThat(locations, notNullValue());\n-\t\tassertThat(locations.size(), greaterThanOrEqualTo(2));\n+\t\tassertThat(locations.size(), equalTo(2));\n+\t\tassertThat(locations.iterator().next().getCountry(), equalTo(LOCATION_COUNTRY));\n \t}\n \t\n \t@Test\n-\tpublic void findLocationByCountry_shouldReturnEmptyCollectionWhenCalledWithUnknownCountry() {\n-\t\tCollection<Location> locations = fhirLocationDao.findLocationsByCountry(UNKNOWN_LOCATION_COUNTRY);\n+\tpublic void searchForLocations_shouldReturnEmptyCollectionWhenCalledWithUnknownCountry() {\n+\t\tStringOrListParam country = new StringOrListParam().add(new StringParam(UNKNOWN_LOCATION_COUNTRY));\n+\t\tCollection<Location> locations = fhirLocationDao.searchForLocations(null, null, country, null, null, null, null,\n+\t\t    null);\n \t\t\n \t\tassertThat(locations, notNullValue());\n \t\tassertThat(locations.size(), equalTo(0));\n \t}\n \t\n \t@Test\n-\tpublic void findLocationsByPostalCode_shouldReturnCorrectLocation() {\n-\t\tCollection<Location> locations = fhirLocationDao.findLocationsByPostalCode(POSTAL_CODE);\n+\tpublic void searchForLocations_shouldReturnCorrectLocationByPostalCode() {\n+\t\tStringOrListParam postalCode = new StringOrListParam().add(new StringParam(POSTAL_CODE));\n+\t\tCollection<Location> locations = fhirLocationDao.searchForLocations(null, null, null, postalCode, null, null, null,\n+\t\t    null);\n \t\t\n \t\tassertThat(locations, notNullValue());\n-\t\tassertThat(locations.size(), greaterThanOrEqualTo(2));\n+\t\tassertThat(locations.size(), equalTo(2));\n+\t\tassertThat(locations.iterator().next().getPostalCode(), equalTo(POSTAL_CODE));\n \t}\n \t\n \t@Test\n-\tpublic void findLocationsByPostalCode_shouldReturnEmptyCollectionWhenCalledWithUnknownCode() {\n-\t\tCollection<Location> locations = fhirLocationDao.findLocationsByPostalCode(UNKNOWN_POSTAL_CODE);\n+\tpublic void searchForLocations_shouldReturnEmptyCollectionWhenCalledWithUnknownCode() {\n+\t\tStringOrListParam postalCode = new StringOrListParam().add(new StringParam(UNKNOWN_POSTAL_CODE));\n+\t\tCollection<Location> locations = fhirLocationDao.searchForLocations(null, null, null, postalCode, null, null, null,\n+\t\t    null);\n \t\t\n \t\tassertThat(locations, notNullValue());\n \t\tassertThat(locations.size(), equalTo(0));\n \t}\n \t\n \t@Test\n-\tpublic void findLocationsByState_shouldReturnCorrectLocation() {\n-\t\tCollection<Location> locations = fhirLocationDao.findLocationsByState(LOCATION_STATE);\n+\tpublic void searchForLocations_shouldReturnCorrectLocationByState() {\n+\t\tStringOrListParam state = new StringOrListParam().add(new StringParam(LOCATION_STATE));\n+\t\tCollection<Location> locations = fhirLocationDao.searchForLocations(null, null, null, null, state, null, null, null);\n \t\t\n \t\tassertThat(locations, notNullValue());\n-\t\tassertThat(locations.size(), greaterThanOrEqualTo(1));\n+\t\tassertThat(locations.size(), equalTo(2));\n+\t\tassertThat(locations.iterator().next().getStateProvince(), equalTo(LOCATION_STATE));\n \t}\n \t\n \t@Test\n-\tpublic void findLocationsByState_shouldReturnEmptyCollectionWhenCalledWithUnknownState() {\n-\t\tCollection<Location> locations = fhirLocationDao.findLocationsByState(UNKNOWN_LOCATION_STATE);\n+\tpublic void searchForLocations_shouldReturnEmptyCollectionWhenCalledWithUnknownState() {\n+\t\tStringOrListParam state = new StringOrListParam().add(new StringParam(UNKNOWN_LOCATION_STATE));\n+\t\tCollection<Location> locations = fhirLocationDao.searchForLocations(null, null, null, null, state, null, null, null);\n \t\t\n \t\tassertThat(locations, notNullValue());\n \t\tassertThat(locations.size(), equalTo(0));\n \t}\n \t\n \t@Test\n-\tpublic void findLocationsByTag_shouldReturnLocationsContainingGivenTag() {\n-\t\tTokenParam locationTag = new TokenParam(FhirConstants.OPENMRS_FHIR_EXT_LOCATION_TAG, LOGIN_LOCATION_TAG_NAME);\n-\t\tCollection<Location> locations = fhirLocationDao.findLocationsByTag(locationTag);\n+\tpublic void searchForLocations_shouldReturnLocationsContainingGivenTag() {\n+\t\tTokenOrListParam locationTag = new TokenOrListParam(FhirConstants.OPENMRS_FHIR_EXT_LOCATION_TAG,\n+\t\t        LOGIN_LOCATION_TAG_NAME);\n+\t\tCollection<Location> locations = fhirLocationDao.searchForLocations(null, null, null, null, null, locationTag, null,\n+\t\t    null);\n+\t\t\n+\t\tassertThat(locations, notNullValue());\n+\t\tassertThat(locations.size(), equalTo(2));\n+\t\tassertThat(locations.iterator().next().getTags().iterator().next().getName(), equalTo(LOGIN_LOCATION_TAG_NAME));\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForLocations_shouldReturnCorrectLocationByParentUUID() {\n+\t\tReferenceOrListParam parentLocation = new ReferenceOrListParam()\n+\t\t        .add(new ReferenceParam().setChain(\"\").setValue(LOCATION_PARENT_ID));\n+\t\tCollection<Location> locations = fhirLocationDao.searchForLocations(null, null, null, null, null, null,\n+\t\t    parentLocation, null);\n+\t\t\n \t\tassertThat(locations, notNullValue());\n-\t\tassertThat(locations.size(), greaterThanOrEqualTo(2));\n+\t\tassertThat(locations.size(), equalTo(1));\n+\t\tassertThat(locations.iterator().next().getParentLocation().getUuid(), equalTo(LOCATION_PARENT_ID));\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForLocations_shouldReturnCorrectLocationByParentName() {\n+\t\tReferenceOrListParam parentLocation = new ReferenceOrListParam()\n+\t\t        .add(new ReferenceParam().setChain(\"name\").setValue(LOCATION_PARENT_NAME));", "originalCommit": "1c598b44593fe4dda5d2d6dec43a3b4fa22c73c0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTEzODYwNw==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/98#discussion_r391138607", "bodyText": "This did fix the coverage! Thanks.", "author": "varung-31", "createdAt": "2020-03-11T17:25:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDU1MDY0Nw=="}], "type": "inlineReview", "revised_code": {"commit": "f80ae72b9a1a59df5ef632b162b2727332acc8b6", "chunk": "diff --git a/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImplTest.java b/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImplTest.java\nindex 13cce49c..3a1b7620 100644\n--- a/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImplTest.java\n+++ b/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImplTest.java\n\n@@ -233,7 +233,7 @@ public class FhirLocationDaoImplTest extends BaseModuleContextSensitiveTest {\n \t@Test\n \tpublic void searchForLocations_shouldReturnCorrectLocationByParentUUID() {\n \t\tReferenceOrListParam parentLocation = new ReferenceOrListParam()\n-\t\t        .add(new ReferenceParam().setChain(\"\").setValue(LOCATION_PARENT_ID));\n+\t\t        .add(new ReferenceParam().setValue(LOCATION_PARENT_ID).setChain(\"\"));\n \t\tCollection<Location> locations = fhirLocationDao.searchForLocations(null, null, null, null, null, null,\n \t\t    parentLocation, null);\n \t\t\n"}}, {"oid": "f80ae72b9a1a59df5ef632b162b2727332acc8b6", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/f80ae72b9a1a59df5ef632b162b2727332acc8b6", "message": "FM2-80: Improve Search for Location Resource", "committedDate": "2020-03-11T17:06:39Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTEzNjk1Mw==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/98#discussion_r391136953", "bodyText": "address-postalcode", "author": "ibacher", "createdAt": "2020-03-11T17:22:59Z", "path": "api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirLocationDaoImplTest.java", "diffHunk": "@@ -192,4 +325,140 @@ public void getActiveAttributesByLocationAndAttributeTypeUuid_shouldReturnLocati\n \t\t\n \t\tassertThat(attributeList, notNullValue());\n \t}\n+\t\n+\t@Test\n+\tpublic void searchForLocations_shouldSortLocationsByNameAsRequested() {\n+\t\tSortSpec sort = new SortSpec();\n+\t\tsort.setParamName(\"name\");\n+\t\tsort.setOrder(SortOrderEnum.ASC);\n+\t\t\n+\t\tList<Location> resultsList = new ArrayList<>(getNonNullLocationListForSorting(sort));\n+\t\t// check if the sorting is indeed correct by ascending order\n+\t\tfor (int i = 1; i < resultsList.size(); i++) {\n+\t\t\tassertThat(resultsList.get(i - 1).getName(), lessThanOrEqualTo(resultsList.get(i).getName()));\n+\t\t}\n+\t\t\n+\t\tsort.setOrder(SortOrderEnum.DESC);\n+\t\t\n+\t\tresultsList = new ArrayList<>(getNonNullLocationListForSorting(sort));\n+\t\t// check if the sorting is indeed correct by descending order\n+\t\tfor (int i = 1; i < resultsList.size(); i++) {\n+\t\t\tassertThat(resultsList.get(i - 1).getName(), greaterThanOrEqualTo(resultsList.get(i).getName()));\n+\t\t}\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForLocations_shouldSortLocationsByCountryAsRequested() {\n+\t\tSortSpec sort = new SortSpec();\n+\t\tsort.setParamName(\"address-country\");\n+\t\tsort.setOrder(SortOrderEnum.ASC);\n+\t\t\n+\t\tList<Location> resultsList = new ArrayList<>(getNonNullLocationListForSorting(sort));\n+\t\t// check if the sorting is indeed correct by ascending order\n+\t\tfor (int i = 1; i < resultsList.size(); i++) {\n+\t\t\tassertThat(resultsList.get(i - 1).getCountry(), lessThanOrEqualTo(resultsList.get(i).getCountry()));\n+\t\t}\n+\t\t\n+\t\tsort.setOrder(SortOrderEnum.DESC);\n+\t\t\n+\t\tresultsList = new ArrayList<>(getNonNullLocationListForSorting(sort));\n+\t\t// check if the sorting is indeed correct by descending order\n+\t\tfor (int i = 1; i < resultsList.size(); i++) {\n+\t\t\tassertThat(resultsList.get(i - 1).getCountry(), greaterThanOrEqualTo(resultsList.get(i).getCountry()));\n+\t\t}\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForLocations_shouldSortLocationsByStateAsRequested() {\n+\t\tSortSpec sort = new SortSpec();\n+\t\tsort.setParamName(\"address-state\");\n+\t\tsort.setOrder(SortOrderEnum.ASC);\n+\t\t\n+\t\tList<Location> resultsList = new ArrayList<>(getNonNullLocationListForSorting(sort));\n+\t\t// check if the sorting is indeed correct by ascending order\n+\t\tfor (int i = 1; i < resultsList.size(); i++) {\n+\t\t\tassertThat(resultsList.get(i - 1).getStateProvince(), lessThanOrEqualTo(resultsList.get(i).getStateProvince()));\n+\t\t}\n+\t\t\n+\t\tsort.setOrder(SortOrderEnum.DESC);\n+\t\t\n+\t\tresultsList = new ArrayList<>(getNonNullLocationListForSorting(sort));\n+\t\t// check if the sorting is indeed correct by descending order\n+\t\tfor (int i = 1; i < resultsList.size(); i++) {\n+\t\t\tassertThat(resultsList.get(i - 1).getStateProvince(),\n+\t\t\t    greaterThanOrEqualTo(resultsList.get(i).getStateProvince()));\n+\t\t}\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForLocations_shouldSortLocationsByPostalCodeAsRequested() {\n+\t\tSortSpec sort = new SortSpec();\n+\t\tsort.setParamName(\"address-postalCode\");\n+\t\tsort.setOrder(SortOrderEnum.ASC);\n+\t\t\n+\t\tList<Location> resultsList = new ArrayList<>(getNonNullLocationListForSorting(sort));\n+\t\t// check if the sorting is indeed correct by ascending order\n+\t\tfor (int i = 1; i < resultsList.size(); i++) {\n+\t\t\tassertThat(resultsList.get(i - 1).getPostalCode(), lessThanOrEqualTo(resultsList.get(i).getPostalCode()));\n+\t\t}\n+\t\t\n+\t\tsort.setOrder(SortOrderEnum.DESC);\n+\t\t\n+\t\tresultsList = new ArrayList<>(getNonNullLocationListForSorting(sort));\n+\t\t// check if the sorting is indeed correct by descending order\n+\t\tfor (int i = 1; i < resultsList.size(); i++) {\n+\t\t\tassertThat(resultsList.get(i - 1).getPostalCode(), greaterThanOrEqualTo(resultsList.get(i).getPostalCode()));\n+\t\t}\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForLocations_shouldSortLocationsByCityAsRequested() {\n+\t\tSortSpec sort = new SortSpec();\n+\t\tsort.setParamName(\"address-city\");\n+\t\tsort.setOrder(SortOrderEnum.ASC);\n+\t\t\n+\t\tList<Location> resultsList = new ArrayList<>(getNonNullLocationListForSorting(sort));\n+\t\t// check if the sorting is indeed correct by ascending order\n+\t\tfor (int i = 1; i < resultsList.size(); i++) {\n+\t\t\tassertThat(resultsList.get(i - 1).getCityVillage(), lessThanOrEqualTo(resultsList.get(i).getCityVillage()));\n+\t\t}\n+\t\t\n+\t\tsort.setOrder(SortOrderEnum.DESC);\n+\t\t\n+\t\tresultsList = new ArrayList<>(getNonNullLocationListForSorting(sort));\n+\t\t// check if the sorting is indeed correct by descending order\n+\t\tfor (int i = 1; i < resultsList.size(); i++) {\n+\t\t\tassertThat(resultsList.get(i - 1).getCityVillage(), greaterThanOrEqualTo(resultsList.get(i).getCityVillage()));\n+\t\t}\n+\t}\n+\t\n+\tprivate List<Location> getNonNullLocationListForSorting(SortSpec sort) {\n+\t\tCollection<Location> locations = fhirLocationDao.searchForLocations(null, null, null, null, null, null, null, sort);\n+\t\t\n+\t\tassertThat(locations, notNullValue());\n+\t\tassertThat(locations, not(empty()));\n+\t\tassertThat(locations.size(), greaterThan(1));\n+\t\t\n+\t\tList<Location> locationList = new ArrayList<>(locations);\n+\t\t// Remove people with sort parameter value null, to allow comparison while asserting.\n+\t\tswitch (sort.getParamName()) {\n+\t\t\tcase \"name\":\n+\t\t\t\tlocationList.removeIf(p -> p.getName() == null);\n+\t\t\t\tbreak;\n+\t\t\tcase \"address-city\":\n+\t\t\t\tlocationList.removeIf(p -> p.getCityVillage() == null);\n+\t\t\t\tbreak;\n+\t\t\tcase \"address-state\":\n+\t\t\t\tlocationList.removeIf(p -> p.getStateProvince() == null);\n+\t\t\t\tbreak;\n+\t\t\tcase \"address-postalCode\":", "originalCommit": "f80ae72b9a1a59df5ef632b162b2727332acc8b6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTEzOTA5Nw==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/98#discussion_r391139097", "bodyText": "Yeah I noticed that because of the coverage :P", "author": "varung-31", "createdAt": "2020-03-11T17:26:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTEzNjk1Mw=="}], "type": "inlineReview", "revised_code": null}, {"oid": "796b9fdc9709203d335192e646813b04f529ec40", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/796b9fdc9709203d335192e646813b04f529ec40", "message": "FM2-80: Improve Search for Location Resource", "committedDate": "2020-03-11T17:23:15Z", "type": "commit"}, {"oid": "796b9fdc9709203d335192e646813b04f529ec40", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/796b9fdc9709203d335192e646813b04f529ec40", "message": "FM2-80: Improve Search for Location Resource", "committedDate": "2020-03-11T17:23:15Z", "type": "forcePushed"}]}