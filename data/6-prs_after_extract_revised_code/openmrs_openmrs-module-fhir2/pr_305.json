{"pr_number": 305, "pr_title": "FM2-191: Add support for estimated birthdates", "pr_createdAt": "2020-11-03T13:15:12Z", "pr_url": "https://github.com/openmrs/openmrs-module-fhir2/pull/305", "timeline": [{"oid": "e40121a5afb7624ba3c9ffab4fd9b6a6b5d96c50", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/e40121a5afb7624ba3c9ffab4fd9b6a6b5d96c50", "message": "FM2-191: support for Estimated Birthdates", "committedDate": "2020-11-03T13:11:39Z", "type": "commit"}, {"oid": "3d8cbf31e0a8b510e6f30a37a14a7f9d3683e851", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/3d8cbf31e0a8b510e6f30a37a14a7f9d3683e851", "message": "added test for birthdate translator", "committedDate": "2020-11-03T21:35:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI1MzcwMg==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/305#discussion_r525253702", "bodyText": "What happens if the birthdate is not estimated?", "author": "ibacher", "createdAt": "2020-11-17T15:31:51Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/translators/impl/PatientTranslatorImpl.java", "diffHunk": "@@ -79,8 +82,26 @@ public Patient toFhirResource(@Nonnull org.openmrs.Patient openmrsPatient) {\n \t\t\n \t\tPatient patient = new Patient();\n \t\tpatient.setId(openmrsPatient.getUuid());\n-\t\tpatient.setBirthDate(openmrsPatient.getBirthdate());\n \t\tpatient.setActive(!openmrsPatient.getVoided());\n+\t\tpatient.setBirthDate(openmrsPatient.getBirthdate());\n+\t\t\n+\t\tif (openmrsPatient.getBirthdateEstimated() != null) {", "originalCommit": "3d8cbf31e0a8b510e6f30a37a14a7f9d3683e851", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODQ4NTIyMg==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/305#discussion_r528485222", "bodyText": "it will set the birthday as usual. it will alter only if birthday is estimated.", "author": "theanandankit", "createdAt": "2020-11-23T06:04:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI1MzcwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUzOTg5MQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/305#discussion_r528539891", "bodyText": "I have put all this in if else statement. it will check whether the birthday is estimated or not and according to this we will set the birthday.", "author": "theanandankit", "createdAt": "2020-11-23T08:40:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI1MzcwMg=="}], "type": "inlineReview", "revised_code": {"commit": "eeaf1e608b4dd8551397e8f0c0750a9d8d907ec8", "chunk": "diff --git a/api/src/main/java/org/openmrs/module/fhir2/api/translators/impl/PatientTranslatorImpl.java b/api/src/main/java/org/openmrs/module/fhir2/api/translators/impl/PatientTranslatorImpl.java\nindex bd1afa23..7d01094d 100644\n--- a/api/src/main/java/org/openmrs/module/fhir2/api/translators/impl/PatientTranslatorImpl.java\n+++ b/api/src/main/java/org/openmrs/module/fhir2/api/translators/impl/PatientTranslatorImpl.java\n\n@@ -83,15 +84,13 @@ public class PatientTranslatorImpl implements PatientTranslator {\n \t\tPatient patient = new Patient();\n \t\tpatient.setId(openmrsPatient.getUuid());\n \t\tpatient.setActive(!openmrsPatient.getVoided());\n-\t\tpatient.setBirthDate(openmrsPatient.getBirthdate());\n \t\t\n \t\tif (openmrsPatient.getBirthdateEstimated() != null) {\n \t\t\tif (openmrsPatient.getBirthdateEstimated()) {\n \t\t\t\tDateType dateType = new DateType();\n-\t\t\t\tCalendar calendar = Calendar.getInstance();\n-\t\t\t\tint currentYear = calendar.get(Calendar.YEAR);\n-\t\t\t\tcalendar.setTime(openmrsPatient.getBirthdate());\n-\t\t\t\tint birthDateYear = calendar.get(Calendar.YEAR);\n+\t\t\t\tint currentYear = LocalDate.now().getYear();\n+\t\t\t\tint birthDateYear = LocalDate.parse(new SimpleDateFormat(\"yyyy-MM-dd\").format(openmrsPatient.getBirthdate()))\n+\t\t\t\t        .getYear();\n \t\t\t\t\n \t\t\t\tif ((currentYear - birthDateYear) > 5) {\n \t\t\t\t\tdateType.setValue(openmrsPatient.getBirthdate(), TemporalPrecisionEnum.YEAR);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI1NDU0MQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/305#discussion_r525254541", "bodyText": "Doesn't this potentially set birthdate twice?", "author": "ibacher", "createdAt": "2020-11-17T15:32:24Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/translators/impl/PersonTranslatorImpl.java", "diffHunk": "@@ -69,6 +72,23 @@\n \t\tperson.setActive(!openmrsPerson.getVoided());\n \t\tperson.setBirthDate(openmrsPerson.getBirthdate());\n \t\t\n+\t\tif (openmrsPerson.getBirthdateEstimated() != null) {", "originalCommit": "3d8cbf31e0a8b510e6f30a37a14a7f9d3683e851", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODQ4NjEyOA==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/305#discussion_r528486128", "bodyText": "Initially it will set the birthday as usual but if the birthday is estimated then it will set the new birthday as expected.", "author": "theanandankit", "createdAt": "2020-11-23T06:08:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI1NDU0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODU0MDExOQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/305#discussion_r528540119", "bodyText": "I have put all this in if else statement. it will check whether the birthday is estimated or not and according to this we will set the birthday.", "author": "theanandankit", "createdAt": "2020-11-23T08:41:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI1NDU0MQ=="}], "type": "inlineReview", "revised_code": {"commit": "eeaf1e608b4dd8551397e8f0c0750a9d8d907ec8", "chunk": "diff --git a/api/src/main/java/org/openmrs/module/fhir2/api/translators/impl/PersonTranslatorImpl.java b/api/src/main/java/org/openmrs/module/fhir2/api/translators/impl/PersonTranslatorImpl.java\nindex d61e4dee..872b5338 100644\n--- a/api/src/main/java/org/openmrs/module/fhir2/api/translators/impl/PersonTranslatorImpl.java\n+++ b/api/src/main/java/org/openmrs/module/fhir2/api/translators/impl/PersonTranslatorImpl.java\n\n@@ -70,15 +71,13 @@ public class PersonTranslatorImpl implements PersonTranslator {\n \t\torg.hl7.fhir.r4.model.Person person = new org.hl7.fhir.r4.model.Person();\n \t\tperson.setId(openmrsPerson.getUuid());\n \t\tperson.setActive(!openmrsPerson.getVoided());\n-\t\tperson.setBirthDate(openmrsPerson.getBirthdate());\n \t\t\n \t\tif (openmrsPerson.getBirthdateEstimated() != null) {\n \t\t\tif (openmrsPerson.getBirthdateEstimated()) {\n \t\t\t\tDateType dateType = new DateType();\n-\t\t\t\tCalendar calendar = Calendar.getInstance();\n-\t\t\t\tint currentYear = calendar.get(Calendar.YEAR);\n-\t\t\t\tcalendar.setTime(openmrsPerson.getBirthdate());\n-\t\t\t\tint birthDateYear = calendar.get(Calendar.YEAR);\n+\t\t\t\tint currentYear = LocalDate.now().getYear();\n+\t\t\t\tint birthDateYear = LocalDate.parse(new SimpleDateFormat(\"yyyy-MM-dd\").format(openmrsPerson.getBirthdate()))\n+\t\t\t\t        .getYear();\n \t\t\t\t\n \t\t\t\tif ((currentYear - birthDateYear) > 5) {\n \t\t\t\t\tdateType.setValue(openmrsPerson.getBirthdate(), TemporalPrecisionEnum.YEAR);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI1NjI4Mg==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/305#discussion_r525256282", "bodyText": "Instead of using Calendar can we change this to use the java.time package classes?", "author": "ibacher", "createdAt": "2020-11-17T15:33:52Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/translators/impl/PersonTranslatorImpl.java", "diffHunk": "@@ -69,6 +72,23 @@\n \t\tperson.setActive(!openmrsPerson.getVoided());\n \t\tperson.setBirthDate(openmrsPerson.getBirthdate());\n \t\t\n+\t\tif (openmrsPerson.getBirthdateEstimated() != null) {\n+\t\t\tif (openmrsPerson.getBirthdateEstimated()) {\n+\t\t\t\tDateType dateType = new DateType();\n+\t\t\t\tCalendar calendar = Calendar.getInstance();", "originalCommit": "3d8cbf31e0a8b510e6f30a37a14a7f9d3683e851", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODQ4Njg3Ng==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/305#discussion_r528486876", "bodyText": "@ibacher thank. i will change this.", "author": "theanandankit", "createdAt": "2020-11-23T06:11:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI1NjI4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODU0MDY4MQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/305#discussion_r528540681", "bodyText": "changed the calendar to java.time package classes.", "author": "theanandankit", "createdAt": "2020-11-23T08:42:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI1NjI4Mg=="}], "type": "inlineReview", "revised_code": {"commit": "eeaf1e608b4dd8551397e8f0c0750a9d8d907ec8", "chunk": "diff --git a/api/src/main/java/org/openmrs/module/fhir2/api/translators/impl/PersonTranslatorImpl.java b/api/src/main/java/org/openmrs/module/fhir2/api/translators/impl/PersonTranslatorImpl.java\nindex d61e4dee..872b5338 100644\n--- a/api/src/main/java/org/openmrs/module/fhir2/api/translators/impl/PersonTranslatorImpl.java\n+++ b/api/src/main/java/org/openmrs/module/fhir2/api/translators/impl/PersonTranslatorImpl.java\n\n@@ -70,15 +71,13 @@ public class PersonTranslatorImpl implements PersonTranslator {\n \t\torg.hl7.fhir.r4.model.Person person = new org.hl7.fhir.r4.model.Person();\n \t\tperson.setId(openmrsPerson.getUuid());\n \t\tperson.setActive(!openmrsPerson.getVoided());\n-\t\tperson.setBirthDate(openmrsPerson.getBirthdate());\n \t\t\n \t\tif (openmrsPerson.getBirthdateEstimated() != null) {\n \t\t\tif (openmrsPerson.getBirthdateEstimated()) {\n \t\t\t\tDateType dateType = new DateType();\n-\t\t\t\tCalendar calendar = Calendar.getInstance();\n-\t\t\t\tint currentYear = calendar.get(Calendar.YEAR);\n-\t\t\t\tcalendar.setTime(openmrsPerson.getBirthdate());\n-\t\t\t\tint birthDateYear = calendar.get(Calendar.YEAR);\n+\t\t\t\tint currentYear = LocalDate.now().getYear();\n+\t\t\t\tint birthDateYear = LocalDate.parse(new SimpleDateFormat(\"yyyy-MM-dd\").format(openmrsPerson.getBirthdate()))\n+\t\t\t\t        .getYear();\n \t\t\t\t\n \t\t\t\tif ((currentYear - birthDateYear) > 5) {\n \t\t\t\t\tdateType.setValue(openmrsPerson.getBirthdate(), TemporalPrecisionEnum.YEAR);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI1NjU5Mw==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/305#discussion_r525256593", "bodyText": "Instead of using Calendar can we change this to use the java.time package classes?", "author": "ibacher", "createdAt": "2020-11-17T15:34:16Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/translators/impl/PractitionerTranslatorUserImpl.java", "diffHunk": "@@ -54,7 +58,27 @@ public Practitioner toFhirResource(@Nonnull User user) {\n \t\tpractitioner.addIdentifier(userIdentifier);\n \t\t\n \t\tif (user.getPerson() != null) {\n+\t\t\t\n+\t\t\tif (user.getPerson().getBirthdateEstimated() != null) {\n+\t\t\t\tif (user.getPerson().getBirthdateEstimated()) {\n+\t\t\t\t\tDateType dateType = new DateType();\n+\t\t\t\t\tCalendar calendar = Calendar.getInstance();", "originalCommit": "3d8cbf31e0a8b510e6f30a37a14a7f9d3683e851", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODU0MDczNQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/305#discussion_r528540735", "bodyText": "changed the calendar to java.time package classes.", "author": "theanandankit", "createdAt": "2020-11-23T08:42:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI1NjU5Mw=="}], "type": "inlineReview", "revised_code": {"commit": "eeaf1e608b4dd8551397e8f0c0750a9d8d907ec8", "chunk": "diff --git a/api/src/main/java/org/openmrs/module/fhir2/api/translators/impl/PractitionerTranslatorUserImpl.java b/api/src/main/java/org/openmrs/module/fhir2/api/translators/impl/PractitionerTranslatorUserImpl.java\nindex dd3848e8..dc7367d7 100644\n--- a/api/src/main/java/org/openmrs/module/fhir2/api/translators/impl/PractitionerTranslatorUserImpl.java\n+++ b/api/src/main/java/org/openmrs/module/fhir2/api/translators/impl/PractitionerTranslatorUserImpl.java\n\n@@ -62,10 +63,9 @@ public class PractitionerTranslatorUserImpl implements PractitionerTranslator<Us\n \t\t\tif (user.getPerson().getBirthdateEstimated() != null) {\n \t\t\t\tif (user.getPerson().getBirthdateEstimated()) {\n \t\t\t\t\tDateType dateType = new DateType();\n-\t\t\t\t\tCalendar calendar = Calendar.getInstance();\n-\t\t\t\t\tint currentYear = calendar.get(Calendar.YEAR);\n-\t\t\t\t\tcalendar.setTime(user.getPerson().getBirthdate());\n-\t\t\t\t\tint birthDateYear = calendar.get(Calendar.YEAR);\n+\t\t\t\t\tint currentYear = LocalDate.now().getYear();\n+\t\t\t\t\tint birthDateYear = LocalDate\n+\t\t\t\t\t        .parse(new SimpleDateFormat(\"yyyy-MM-dd\").format(user.getPerson().getBirthdate())).getYear();\n \t\t\t\t\t\n \t\t\t\t\tif ((currentYear - birthDateYear) > 5) {\n \t\t\t\t\t\tdateType.setValue(user.getPerson().getBirthdate(), TemporalPrecisionEnum.YEAR);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI1Njg5Ng==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/305#discussion_r525256896", "bodyText": "Instead of using Calendar can we change this to use the java.time package classes?", "author": "ibacher", "createdAt": "2020-11-17T15:34:39Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/translators/impl/RelatedPersonTranslatorImpl.java", "diffHunk": "@@ -62,9 +65,26 @@ public RelatedPerson toFhirResource(@Nonnull Relationship relationship) {\n \t\t\n \t\tPerson omrsRelatedPerson = relationship.getPersonA();\n \t\tRelatedPerson relatedPerson = new RelatedPerson();\n-\t\t\n-\t\trelatedPerson.setId(relationship.getUuid());\n \t\trelatedPerson.setBirthDate(omrsRelatedPerson.getBirthdate());\n+\t\trelatedPerson.setId(relationship.getUuid());\n+\t\t\n+\t\tif (omrsRelatedPerson.getBirthdateEstimated() != null) {\n+\t\t\tif (omrsRelatedPerson.getBirthdateEstimated()) {\n+\t\t\t\tDateType dateType = new DateType();\n+\t\t\t\tCalendar calendar = Calendar.getInstance();", "originalCommit": "3d8cbf31e0a8b510e6f30a37a14a7f9d3683e851", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODU0MDgxMg==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/305#discussion_r528540812", "bodyText": "changed the calendar to java.time package classes.", "author": "theanandankit", "createdAt": "2020-11-23T08:42:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI1Njg5Ng=="}], "type": "inlineReview", "revised_code": {"commit": "eeaf1e608b4dd8551397e8f0c0750a9d8d907ec8", "chunk": "diff --git a/api/src/main/java/org/openmrs/module/fhir2/api/translators/impl/RelatedPersonTranslatorImpl.java b/api/src/main/java/org/openmrs/module/fhir2/api/translators/impl/RelatedPersonTranslatorImpl.java\nindex 7710777a..28747d45 100644\n--- a/api/src/main/java/org/openmrs/module/fhir2/api/translators/impl/RelatedPersonTranslatorImpl.java\n+++ b/api/src/main/java/org/openmrs/module/fhir2/api/translators/impl/RelatedPersonTranslatorImpl.java\n\n@@ -65,16 +66,14 @@ public class RelatedPersonTranslatorImpl implements RelatedPersonTranslator {\n \t\t\n \t\tPerson omrsRelatedPerson = relationship.getPersonA();\n \t\tRelatedPerson relatedPerson = new RelatedPerson();\n-\t\trelatedPerson.setBirthDate(omrsRelatedPerson.getBirthdate());\n \t\trelatedPerson.setId(relationship.getUuid());\n \t\t\n \t\tif (omrsRelatedPerson.getBirthdateEstimated() != null) {\n \t\t\tif (omrsRelatedPerson.getBirthdateEstimated()) {\n \t\t\t\tDateType dateType = new DateType();\n-\t\t\t\tCalendar calendar = Calendar.getInstance();\n-\t\t\t\tint currentYear = calendar.get(Calendar.YEAR);\n-\t\t\t\tcalendar.setTime(omrsRelatedPerson.getBirthdate());\n-\t\t\t\tint birthDateYear = calendar.get(Calendar.YEAR);\n+\t\t\t\tint currentYear = LocalDate.now().getYear();\n+\t\t\t\tint birthDateYear = LocalDate\n+\t\t\t\t        .parse(new SimpleDateFormat(\"yyyy-MM-dd\").format(omrsRelatedPerson.getBirthdate())).getYear();\n \t\t\t\t\n \t\t\t\tif ((currentYear - birthDateYear) > 5) {\n \t\t\t\t\tdateType.setValue(omrsRelatedPerson.getBirthdate(), TemporalPrecisionEnum.YEAR);\n"}}, {"oid": "eeaf1e608b4dd8551397e8f0c0750a9d8d907ec8", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/eeaf1e608b4dd8551397e8f0c0750a9d8d907ec8", "message": "changed the calendar to java.time package", "committedDate": "2020-11-23T07:46:44Z", "type": "commit"}]}