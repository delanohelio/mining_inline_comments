{"pr_number": 86, "pr_title": "FM2-79 Improve Search for Encounter", "pr_createdAt": "2020-02-23T11:48:14Z", "pr_url": "https://github.com/openmrs/openmrs-module-fhir2/pull/86", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzE4MDY5Nw==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/86#discussion_r383180697", "bodyText": "I noticed that a similar handlers are used for PatientDaoImpl and will be used for PersonDaoImpl as well, shouldn't we refactor this to be present in the BaseDaoImpl?", "author": "CaptainDaVinci", "createdAt": "2020-02-24T10:21:07Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirEncounterDaoImpl.java", "diffHunk": "@@ -44,4 +57,116 @@ public Encounter getEncounterByUuid(String uuid) {\n \t\t        .createAlias(\"patient\", \"p\").createAlias(\"p.identifiers\", \"pi\").add(eq(\"pi.identifier\", patientIdentifier))\n \t\t        .list();\n \t}\n+\t\n+\t@Override\n+\tpublic Collection<Encounter> searchForEncounters(DateRangeParam date, ReferenceParam location,\n+\t        ReferenceParam participant, ReferenceParam subject, TokenOrListParam participantIdentifier,\n+\t        StringOrListParam participantName, StringOrListParam participantGiven, StringOrListParam participantFamily,\n+\t        TokenOrListParam subjectIdentifier, StringOrListParam subjectName, StringOrListParam subjectGiven,\n+\t        StringOrListParam subjectFamily) {\n+\t\t\n+\t\tCriteria criteria = sessionFactory.getCurrentSession().createCriteria(Encounter.class);\n+\t\thandleSubjectNames(criteria, subjectName, subjectGiven, subjectFamily);\n+\t\thandleParticipantNames(criteria, participantName, participantGiven, participantFamily);\n+\t\thandleSubjectIdentifier(criteria, subjectIdentifier);\n+\t\thandleParticipantIdentifier(criteria, participantIdentifier);\n+\t\thandleDateRange(\"date\", date).ifPresent(criteria::add);\n+\t\t//TODO: handle ReferenceParam for participant, subject, location\n+\t\t\n+\t\treturn criteria.list();\n+\t}\n+\t\n+\tprivate void handleParticipantIdentifier(Criteria criteria, TokenOrListParam identifier) {\n+\t\tif (identifier == null) {\n+\t\t\treturn;\n+\t\t}\n+\t\t\n+\t\tcriteria.createAlias(\"identifiers\", \"pi\", JoinType.INNER_JOIN, eq(\"pi.voided\", false));\n+\t\t\n+\t\thandleOrListParamBySystem(identifier, (system, tokens) -> {\n+\t\t\tif (system.isEmpty()) {\n+\t\t\t\treturn Optional.of(in(\"pi.identifier\", tokensToList(tokens)));\n+\t\t\t} else {\n+\t\t\t\tif (!containsAlias(criteria, \"pit\")) {\n+\t\t\t\t\tcriteria.createAlias(\"pi.identifierType\", \"pit\");\n+\t\t\t\t}\n+\t\t\t\t\n+\t\t\t\treturn Optional.of(and(eq(\"pit.name\", system), in(\"pi.identifier\", tokensToList(tokens))));\n+\t\t\t}\n+\t\t}).ifPresent(criteria::add);\n+\t}\n+\t\n+\tprivate void handleSubjectIdentifier(Criteria criteria, TokenOrListParam identifier) {\n+\t\tif (identifier == null) {\n+\t\t\treturn;\n+\t\t}\n+\t\t\n+\t\tcriteria.createAlias(\"identifiers\", \"si\", JoinType.INNER_JOIN, eq(\"si.voided\", false));\n+\t\t\n+\t\thandleOrListParamBySystem(identifier, (system, tokens) -> {\n+\t\t\tif (system.isEmpty()) {\n+\t\t\t\treturn Optional.of(in(\"si.identifier\", tokensToList(tokens)));\n+\t\t\t} else {\n+\t\t\t\tif (!containsAlias(criteria, \"sit\")) {\n+\t\t\t\t\tcriteria.createAlias(\"si.identifierType\", \"sit\");\n+\t\t\t\t}\n+\t\t\t\t\n+\t\t\t\treturn Optional.of(and(eq(\"sit.name\", system), in(\"si.identifier\", tokensToList(tokens))));\n+\t\t\t}\n+\t\t}).ifPresent(criteria::add);\n+\t}\n+\t\n+\tprivate void handleSubjectNames(Criteria criteria, StringOrListParam name, StringOrListParam given,", "originalCommit": "ea6852b8f2e92f67f578408865141311d7b4298e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI1MjIwOA==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/86#discussion_r383252208", "bodyText": "Yes, we should", "author": "ibacher", "createdAt": "2020-02-24T13:04:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzE4MDY5Nw=="}], "type": "inlineReview", "revised_code": {"commit": "59d2836e433bcc1f5dd99eeec420d6a0d3d5dd80", "chunk": "diff --git a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirEncounterDaoImpl.java b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirEncounterDaoImpl.java\nindex c5bd61ca..31caf0d7 100644\n--- a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirEncounterDaoImpl.java\n+++ b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirEncounterDaoImpl.java\n\n@@ -50,123 +40,17 @@ public class FhirEncounterDaoImpl extends BaseDaoImpl implements FhirEncounterDa\n \t\t        .uniqueResult();\n \t}\n \t\n-\t@Override\n-\t@SuppressWarnings(\"unchecked\")\n-\tpublic List<Encounter> findEncountersByPatientIdentifier(String patientIdentifier) {\n-\t\treturn (List<Encounter>) sessionFactory.getCurrentSession().createCriteria(Encounter.class)\n-\t\t        .createAlias(\"patient\", \"p\").createAlias(\"p.identifiers\", \"pi\").add(eq(\"pi.identifier\", patientIdentifier))\n-\t\t        .list();\n-\t}\n-\t\n \t@Override\n \tpublic Collection<Encounter> searchForEncounters(DateRangeParam date, ReferenceParam location,\n-\t        ReferenceParam participant, ReferenceParam subject, TokenOrListParam participantIdentifier,\n-\t        StringOrListParam participantName, StringOrListParam participantGiven, StringOrListParam participantFamily,\n-\t        TokenOrListParam subjectIdentifier, StringOrListParam subjectName, StringOrListParam subjectGiven,\n-\t        StringOrListParam subjectFamily) {\n+\t        ReferenceParam participant, ReferenceParam subject) {\n \t\t\n \t\tCriteria criteria = sessionFactory.getCurrentSession().createCriteria(Encounter.class);\n-\t\thandleSubjectNames(criteria, subjectName, subjectGiven, subjectFamily);\n-\t\thandleParticipantNames(criteria, participantName, participantGiven, participantFamily);\n-\t\thandleSubjectIdentifier(criteria, subjectIdentifier);\n-\t\thandleParticipantIdentifier(criteria, participantIdentifier);\n-\t\thandleDateRange(\"date\", date).ifPresent(criteria::add);\n+\t\thandleDateRange(\"encounterDatetime\", date).ifPresent(criteria::add);\n+\t\thandleLocationReference(criteria, location);\n+\t\thandleParticipantReference(criteria, participant);\n+\t\thandlePatientReference(criteria, subject);\n \t\t//TODO: handle ReferenceParam for participant, subject, location\n \t\t\n \t\treturn criteria.list();\n \t}\n-\t\n-\tprivate void handleParticipantIdentifier(Criteria criteria, TokenOrListParam identifier) {\n-\t\tif (identifier == null) {\n-\t\t\treturn;\n-\t\t}\n-\t\t\n-\t\tcriteria.createAlias(\"identifiers\", \"pi\", JoinType.INNER_JOIN, eq(\"pi.voided\", false));\n-\t\t\n-\t\thandleOrListParamBySystem(identifier, (system, tokens) -> {\n-\t\t\tif (system.isEmpty()) {\n-\t\t\t\treturn Optional.of(in(\"pi.identifier\", tokensToList(tokens)));\n-\t\t\t} else {\n-\t\t\t\tif (!containsAlias(criteria, \"pit\")) {\n-\t\t\t\t\tcriteria.createAlias(\"pi.identifierType\", \"pit\");\n-\t\t\t\t}\n-\t\t\t\t\n-\t\t\t\treturn Optional.of(and(eq(\"pit.name\", system), in(\"pi.identifier\", tokensToList(tokens))));\n-\t\t\t}\n-\t\t}).ifPresent(criteria::add);\n-\t}\n-\t\n-\tprivate void handleSubjectIdentifier(Criteria criteria, TokenOrListParam identifier) {\n-\t\tif (identifier == null) {\n-\t\t\treturn;\n-\t\t}\n-\t\t\n-\t\tcriteria.createAlias(\"identifiers\", \"si\", JoinType.INNER_JOIN, eq(\"si.voided\", false));\n-\t\t\n-\t\thandleOrListParamBySystem(identifier, (system, tokens) -> {\n-\t\t\tif (system.isEmpty()) {\n-\t\t\t\treturn Optional.of(in(\"si.identifier\", tokensToList(tokens)));\n-\t\t\t} else {\n-\t\t\t\tif (!containsAlias(criteria, \"sit\")) {\n-\t\t\t\t\tcriteria.createAlias(\"si.identifierType\", \"sit\");\n-\t\t\t\t}\n-\t\t\t\t\n-\t\t\t\treturn Optional.of(and(eq(\"sit.name\", system), in(\"si.identifier\", tokensToList(tokens))));\n-\t\t\t}\n-\t\t}).ifPresent(criteria::add);\n-\t}\n-\t\n-\tprivate void handleSubjectNames(Criteria criteria, StringOrListParam name, StringOrListParam given,\n-\t        StringOrListParam family) {\n-\t\tif (name == null && given == null && family == null) {\n-\t\t\treturn;\n-\t\t}\n-\t\t\n-\t\tcriteria.createAlias(\"names\", \"sn\");\n-\t\t\n-\t\tif (name != null) {\n-\t\t\thandleOrListParamAsStream(name,\n-\t\t\t    (nameParam) -> Arrays.stream(StringUtils.split(nameParam.getValue(), \" \\t,\"))\n-\t\t\t            .map(token -> new StringParam().setValue(token).setExact(nameParam.isExact())\n-\t\t\t                    .setContains(nameParam.isContains()))\n-\t\t\t            .map(tokenParam -> Arrays.asList(propertyLike(\"sn.givenName\", tokenParam),\n-\t\t\t                propertyLike(\"sn.middleName\", tokenParam), propertyLike(\"sn.familyName\", tokenParam)))\n-\t\t\t            .flatMap(Collection::stream)).ifPresent(criteria::add);\n-\t\t}\n-\t\t\n-\t\tif (given != null) {\n-\t\t\thandleOrListParam(given, (givenName) -> propertyLike(\"sn.givenName\", givenName)).ifPresent(criteria::add);\n-\t\t}\n-\t\t\n-\t\tif (family != null) {\n-\t\t\thandleOrListParam(family, (familyName) -> propertyLike(\"sn.familyName\", familyName)).ifPresent(criteria::add);\n-\t\t}\n-\t}\n-\t\n-\tprivate void handleParticipantNames(Criteria criteria, StringOrListParam name, StringOrListParam given,\n-\t        StringOrListParam family) {\n-\t\tif (name == null && given == null && family == null) {\n-\t\t\treturn;\n-\t\t}\n-\t\t\n-\t\tcriteria.createAlias(\"names\", \"pn\");\n-\t\t\n-\t\tif (name != null) {\n-\t\t\thandleOrListParamAsStream(name,\n-\t\t\t    (nameParam) -> Arrays.stream(StringUtils.split(nameParam.getValue(), \" \\t,\"))\n-\t\t\t            .map(token -> new StringParam().setValue(token).setExact(nameParam.isExact())\n-\t\t\t                    .setContains(nameParam.isContains()))\n-\t\t\t            .map(tokenParam -> Arrays.asList(propertyLike(\"pn.givenName\", tokenParam),\n-\t\t\t                propertyLike(\"pn.middleName\", tokenParam), propertyLike(\"pn.familyName\", tokenParam)))\n-\t\t\t            .flatMap(Collection::stream)).ifPresent(criteria::add);\n-\t\t}\n-\t\t\n-\t\tif (given != null) {\n-\t\t\thandleOrListParam(given, (givenName) -> propertyLike(\"pn.givenName\", givenName)).ifPresent(criteria::add);\n-\t\t}\n-\t\t\n-\t\tif (family != null) {\n-\t\t\thandleOrListParam(family, (familyName) -> propertyLike(\"pn.familyName\", familyName)).ifPresent(criteria::add);\n-\t\t}\n-\t}\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQ5ODg1MQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/86#discussion_r383498851", "bodyText": "You seem to have mapped Encounter.SP_SUBJECT twice. Are you sure this is right?", "author": "ibacher", "createdAt": "2020-02-24T20:33:55Z", "path": "omod/src/main/java/org/openmrs/module/fhir2/providers/EncounterFhirResourceProvider.java", "diffHunk": "@@ -59,4 +62,18 @@ public Bundle findEncountersByPatientIdentifier(@RequiredParam(name = Encounter.\n \t\treturn FhirUtils\n \t\t        .convertSearchResultsToBundle(encounterService.findEncountersByPatientIdentifier(identifier.getIdPart()));\n \t}\n+\t\n+\t@Search\n+\t@SuppressWarnings(\"unused\")\n+\tpublic Bundle searchEncounter(@OperationParam(name = Encounter.SP_DATE) DateRangeParam date,\n+\t        @OperationParam(name = Encounter.SP_LOCATION) ReferenceParam location,\n+\t        @OptionalParam(name = Encounter.SP_SUBJECT, chainWhitelist = { \"\", Patient.SP_IDENTIFIER, Patient.SP_GIVEN,", "originalCommit": "739857e5b4ce2bf8b4aee3e71c47920ad9e60377", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "59d2836e433bcc1f5dd99eeec420d6a0d3d5dd80", "chunk": "diff --git a/omod/src/main/java/org/openmrs/module/fhir2/providers/EncounterFhirResourceProvider.java b/omod/src/main/java/org/openmrs/module/fhir2/providers/EncounterFhirResourceProvider.java\nindex 9aef23cd..daa4db73 100644\n--- a/omod/src/main/java/org/openmrs/module/fhir2/providers/EncounterFhirResourceProvider.java\n+++ b/omod/src/main/java/org/openmrs/module/fhir2/providers/EncounterFhirResourceProvider.java\n\n@@ -57,18 +57,13 @@ public class EncounterFhirResourceProvider implements IResourceProvider {\n \t}\n \t\n \t@Search\n-\tpublic Bundle findEncountersByPatientIdentifier(@RequiredParam(name = Encounter.SP_PATIENT, chainWhitelist = {\n-\t        Patient.SP_IDENTIFIER }) ReferenceParam identifier) {\n-\t\treturn FhirUtils\n-\t\t        .convertSearchResultsToBundle(encounterService.findEncountersByPatientIdentifier(identifier.getIdPart()));\n-\t}\n-\t\n-\t@Search\n-\t@SuppressWarnings(\"unused\")\n-\tpublic Bundle searchEncounter(@OperationParam(name = Encounter.SP_DATE) DateRangeParam date,\n-\t        @OperationParam(name = Encounter.SP_LOCATION) ReferenceParam location,\n-\t        @OptionalParam(name = Encounter.SP_SUBJECT, chainWhitelist = { \"\", Patient.SP_IDENTIFIER, Patient.SP_GIVEN,\n-\t                Patient.SP_FAMILY, Patient.SP_NAME }, targetTypes = Patient.class) ReferenceParam participantReference,\n+\tpublic Bundle searchEncounter(@OptionalParam(name = Encounter.SP_DATE) DateRangeParam date,\n+\t        @OptionalParam(name = Encounter.SP_LOCATION, chainWhitelist = { \"\", Location.SP_ADDRESS_CITY,\n+\t                Location.SP_ADDRESS_STATE, Location.SP_ADDRESS_COUNTRY,\n+\t                Location.SP_ADDRESS_POSTALCODE }, targetTypes = Location.class) ReferenceParam location,\n+\t        @OptionalParam(name = Encounter.SP_PARTICIPANT, chainWhitelist = { \"\", Practitioner.SP_IDENTIFIER,\n+\t                Practitioner.SP_GIVEN, Practitioner.SP_FAMILY,\n+\t                Practitioner.SP_NAME }, targetTypes = Practitioner.class) ReferenceParam participantReference,\n \t        @OptionalParam(name = Encounter.SP_SUBJECT, chainWhitelist = { \"\", Patient.SP_IDENTIFIER, Patient.SP_GIVEN,\n \t                Patient.SP_FAMILY, Patient.SP_NAME }, targetTypes = Patient.class) ReferenceParam subjectReference) {\n \t\treturn FhirUtils.convertSearchResultsToBundle(\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQ5OTU3OQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/86#discussion_r383499579", "bodyText": "Should we be using Patient.SP_IDENTIFIER here?", "author": "ibacher", "createdAt": "2020-02-24T20:35:30Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirEncounterDaoImpl.java", "diffHunk": "@@ -44,4 +57,121 @@ public Encounter getEncounterByUuid(String uuid) {\n \t\t        .createAlias(\"patient\", \"p\").createAlias(\"p.identifiers\", \"pi\").add(eq(\"pi.identifier\", patientIdentifier))\n \t\t        .list();\n \t}\n+\t\n+\t@Override\n+\tpublic Collection<Encounter> searchForEncounters(DateRangeParam date, ReferenceParam location,\n+\t        ReferenceParam participant, ReferenceParam subject) {\n+\t\t\n+\t\tCriteria criteria = sessionFactory.getCurrentSession().createCriteria(Encounter.class);\n+\t\thandleDateRange(\"encounterDatetime\", date).ifPresent(criteria::add);\n+\t\thandleLocationReference(criteria, location);\n+\t\thandleParticipantReference(criteria, participant);\n+\t\thandleSubjectReference(criteria, subject);\n+\t\t//TODO: handle ReferenceParam for participant, subject, location\n+\t\t\n+\t\treturn criteria.list();\n+\t}\n+\t\n+\tprivate void handleLocationReference(Criteria criteria, ReferenceParam locationReference) {\n+\t\tif (locationReference != null) {\n+\t\t\tcriteria.createAlias(\"location\", \"l\");\n+\t\t\t\n+\t\t\tif (locationReference.getChain() != null) {\n+\t\t\t\tswitch (locationReference.getChain()) {\n+\t\t\t\t\tcase Location.SP_ADDRESS_CITY:\n+\t\t\t\t\t\tcriteria.add(ilike(\"l.cityVillage\", locationReference.getValue(), MatchMode.START));\n+\t\t\t\t\t\tbreak;\n+\t\t\t\t\tcase Location.SP_ADDRESS_STATE:\n+\t\t\t\t\t\tcriteria.add(ilike(\"l.stateProvince\", locationReference.getValue(), MatchMode.START));\n+\t\t\t\t\t\tbreak;\n+\t\t\t\t\tcase Location.SP_ADDRESS_POSTALCODE:\n+\t\t\t\t\t\tcriteria.add(ilike(\"l.postalCode\", locationReference.getValue(), MatchMode.START));\n+\t\t\t\t\t\tbreak;\n+\t\t\t\t\tcase Location.SP_ADDRESS_COUNTRY:\n+\t\t\t\t\t\tcriteria.add(ilike(\"l.country\", locationReference.getValue(), MatchMode.START));\n+\t\t\t\t\t\tbreak;\n+\t\t\t\t\tcase \"\":\n+\t\t\t\t\t\tcriteria.add(eq(\"l.uuid\", locationReference.getValue()));\n+\t\t\t\t\t\tbreak;\n+\t\t\t\t}\n+\t\t\t}\n+\t\t}\n+\t}\n+\t\n+\tprivate void handleParticipantReference(Criteria criteria, ReferenceParam participantReference) {\n+\t\tif (participantReference != null) {\n+\t\t\tcriteria.createAlias(\"encounterProviders\", \"ep\");\n+\t\t\t\n+\t\t\tif (participantReference.getChain() != null) {\n+\t\t\t\tswitch (participantReference.getChain()) {\n+\t\t\t\t\tcase Patient.SP_IDENTIFIER:", "originalCommit": "739857e5b4ce2bf8b4aee3e71c47920ad9e60377", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUwOTA5MQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/86#discussion_r383509091", "bodyText": "@ibacher I guess we should use Practitioner", "author": "VaishSiddharth", "createdAt": "2020-02-24T20:55:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQ5OTU3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUwOTUzMg==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/86#discussion_r383509532", "bodyText": "Yes, exactly!", "author": "ibacher", "createdAt": "2020-02-24T20:56:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQ5OTU3OQ=="}], "type": "inlineReview", "revised_code": {"commit": "59d2836e433bcc1f5dd99eeec420d6a0d3d5dd80", "chunk": "diff --git a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirEncounterDaoImpl.java b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirEncounterDaoImpl.java\nindex 31b81fef..31caf0d7 100644\n--- a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirEncounterDaoImpl.java\n+++ b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirEncounterDaoImpl.java\n\n@@ -50,14 +40,6 @@ public class FhirEncounterDaoImpl extends BaseDaoImpl implements FhirEncounterDa\n \t\t        .uniqueResult();\n \t}\n \t\n-\t@Override\n-\t@SuppressWarnings(\"unchecked\")\n-\tpublic List<Encounter> findEncountersByPatientIdentifier(String patientIdentifier) {\n-\t\treturn (List<Encounter>) sessionFactory.getCurrentSession().createCriteria(Encounter.class)\n-\t\t        .createAlias(\"patient\", \"p\").createAlias(\"p.identifiers\", \"pi\").add(eq(\"pi.identifier\", patientIdentifier))\n-\t\t        .list();\n-\t}\n-\t\n \t@Override\n \tpublic Collection<Encounter> searchForEncounters(DateRangeParam date, ReferenceParam location,\n \t        ReferenceParam participant, ReferenceParam subject) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUwMDA5OA==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/86#discussion_r383500098", "bodyText": "How does this differ from the handlePatientReference() function that already exists?", "author": "ibacher", "createdAt": "2020-02-24T20:36:39Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirEncounterDaoImpl.java", "diffHunk": "@@ -44,4 +57,121 @@ public Encounter getEncounterByUuid(String uuid) {\n \t\t        .createAlias(\"patient\", \"p\").createAlias(\"p.identifiers\", \"pi\").add(eq(\"pi.identifier\", patientIdentifier))\n \t\t        .list();\n \t}\n+\t\n+\t@Override\n+\tpublic Collection<Encounter> searchForEncounters(DateRangeParam date, ReferenceParam location,\n+\t        ReferenceParam participant, ReferenceParam subject) {\n+\t\t\n+\t\tCriteria criteria = sessionFactory.getCurrentSession().createCriteria(Encounter.class);\n+\t\thandleDateRange(\"encounterDatetime\", date).ifPresent(criteria::add);\n+\t\thandleLocationReference(criteria, location);\n+\t\thandleParticipantReference(criteria, participant);\n+\t\thandleSubjectReference(criteria, subject);\n+\t\t//TODO: handle ReferenceParam for participant, subject, location\n+\t\t\n+\t\treturn criteria.list();\n+\t}\n+\t\n+\tprivate void handleLocationReference(Criteria criteria, ReferenceParam locationReference) {\n+\t\tif (locationReference != null) {\n+\t\t\tcriteria.createAlias(\"location\", \"l\");\n+\t\t\t\n+\t\t\tif (locationReference.getChain() != null) {\n+\t\t\t\tswitch (locationReference.getChain()) {\n+\t\t\t\t\tcase Location.SP_ADDRESS_CITY:\n+\t\t\t\t\t\tcriteria.add(ilike(\"l.cityVillage\", locationReference.getValue(), MatchMode.START));\n+\t\t\t\t\t\tbreak;\n+\t\t\t\t\tcase Location.SP_ADDRESS_STATE:\n+\t\t\t\t\t\tcriteria.add(ilike(\"l.stateProvince\", locationReference.getValue(), MatchMode.START));\n+\t\t\t\t\t\tbreak;\n+\t\t\t\t\tcase Location.SP_ADDRESS_POSTALCODE:\n+\t\t\t\t\t\tcriteria.add(ilike(\"l.postalCode\", locationReference.getValue(), MatchMode.START));\n+\t\t\t\t\t\tbreak;\n+\t\t\t\t\tcase Location.SP_ADDRESS_COUNTRY:\n+\t\t\t\t\t\tcriteria.add(ilike(\"l.country\", locationReference.getValue(), MatchMode.START));\n+\t\t\t\t\t\tbreak;\n+\t\t\t\t\tcase \"\":\n+\t\t\t\t\t\tcriteria.add(eq(\"l.uuid\", locationReference.getValue()));\n+\t\t\t\t\t\tbreak;\n+\t\t\t\t}\n+\t\t\t}\n+\t\t}\n+\t}\n+\t\n+\tprivate void handleParticipantReference(Criteria criteria, ReferenceParam participantReference) {\n+\t\tif (participantReference != null) {\n+\t\t\tcriteria.createAlias(\"encounterProviders\", \"ep\");\n+\t\t\t\n+\t\t\tif (participantReference.getChain() != null) {\n+\t\t\t\tswitch (participantReference.getChain()) {\n+\t\t\t\t\tcase Patient.SP_IDENTIFIER:\n+\t\t\t\t\t\tcriteria.createAlias(\"ep.provider\", \"p\").add(ilike(\"p.identifier\", participantReference.getValue()));\n+\t\t\t\t\t\tbreak;\n+\t\t\t\t\tcase Patient.SP_GIVEN:\n+\t\t\t\t\t\tcriteria.createAlias(\"ep.provider\", \"p\").createAlias(\"p.person\", \"ps\").createAlias(\"ps.names\", \"pn\")\n+\t\t\t\t\t\t        .add(ilike(\"pn.givenName\", participantReference.getValue(), MatchMode.START));\n+\t\t\t\t\t\tbreak;\n+\t\t\t\t\tcase Patient.SP_FAMILY:\n+\t\t\t\t\t\tcriteria.createAlias(\"ep.provider\", \"p\").createAlias(\"p.person\", \"ps\").createAlias(\"ps.names\", \"pn\")\n+\t\t\t\t\t\t        .add(ilike(\"pn.familyName\", participantReference.getValue(), MatchMode.START));\n+\t\t\t\t\t\tbreak;\n+\t\t\t\t\tcase Patient.SP_NAME:\n+\t\t\t\t\t\tcriteria.createAlias(\"ep.provider\", \"p\").createAlias(\"p.person\", \"ps\").createAlias(\"ps.names\", \"pn\");\n+\t\t\t\t\t\t\n+\t\t\t\t\t\tList<Optional<Criterion>> criterionList = new ArrayList<>();\n+\t\t\t\t\t\t\n+\t\t\t\t\t\tfor (String token : StringUtils.split(participantReference.getValue(), \" \\t,\")) {\n+\t\t\t\t\t\t\tcriterionList.add(propertyLike(\"pn.givenName\", token));\n+\t\t\t\t\t\t\tcriterionList.add(propertyLike(\"pn.middleName\", token));\n+\t\t\t\t\t\t\tcriterionList.add(propertyLike(\"pn.familyName\", token));\n+\t\t\t\t\t\t}\n+\t\t\t\t\t\t\n+\t\t\t\t\t\tcriteria.add(or(toCriteriaArray(criterionList)));\n+\t\t\t\t\t\tbreak;\n+\t\t\t\t\tcase \"\":\n+\t\t\t\t\t\tcriteria.add(eq(\"ep.uuid\", participantReference.getValue()));\n+\t\t\t\t\t\tbreak;\n+\t\t\t\t}\n+\t\t\t}\n+\t\t}\n+\t}\n+\t\n+\tprotected void handleSubjectReference(Criteria criteria, ReferenceParam subjectReference) {", "originalCommit": "739857e5b4ce2bf8b4aee3e71c47920ad9e60377", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUxMDQ0OQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/86#discussion_r383510449", "bodyText": "@ibacher handlePatientReference() has person as alias but this has patient as alias if I try to use handlePatientReference() then an erreo like cannot resolve propery person pops (after writing tests)", "author": "VaishSiddharth", "createdAt": "2020-02-24T20:58:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUwMDA5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUxMzc0Mg==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/86#discussion_r383513742", "bodyText": "Absolutely right. I've fixed this in the latest master.", "author": "ibacher", "createdAt": "2020-02-24T21:05:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUwMDA5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzg3NDUwMA==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/86#discussion_r383874500", "bodyText": "@VaishSiddharth Can you rebase onto the latest version of master and use the handlePatientReference() method instead? Thanks \ud83d\ude04", "author": "ibacher", "createdAt": "2020-02-25T13:23:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUwMDA5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzg4MTE5OQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/86#discussion_r383881199", "bodyText": "@ibacher Working in it. Will soon send another commit after resolving all these issues.", "author": "VaishSiddharth", "createdAt": "2020-02-25T13:36:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUwMDA5OA=="}], "type": "inlineReview", "revised_code": {"commit": "59d2836e433bcc1f5dd99eeec420d6a0d3d5dd80", "chunk": "diff --git a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirEncounterDaoImpl.java b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirEncounterDaoImpl.java\nindex 31b81fef..31caf0d7 100644\n--- a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirEncounterDaoImpl.java\n+++ b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirEncounterDaoImpl.java\n\n@@ -50,14 +40,6 @@ public class FhirEncounterDaoImpl extends BaseDaoImpl implements FhirEncounterDa\n \t\t        .uniqueResult();\n \t}\n \t\n-\t@Override\n-\t@SuppressWarnings(\"unchecked\")\n-\tpublic List<Encounter> findEncountersByPatientIdentifier(String patientIdentifier) {\n-\t\treturn (List<Encounter>) sessionFactory.getCurrentSession().createCriteria(Encounter.class)\n-\t\t        .createAlias(\"patient\", \"p\").createAlias(\"p.identifiers\", \"pi\").add(eq(\"pi.identifier\", patientIdentifier))\n-\t\t        .list();\n-\t}\n-\t\n \t@Override\n \tpublic Collection<Encounter> searchForEncounters(DateRangeParam date, ReferenceParam location,\n \t        ReferenceParam participant, ReferenceParam subject) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzg3NTQ0Nw==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/86#discussion_r383875447", "bodyText": "We should still be able to search by patient identifier, right?", "author": "ibacher", "createdAt": "2020-02-25T13:25:28Z", "path": "api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirEncounterDaoImplTest.java", "diffHunk": "@@ -72,21 +91,66 @@ public void shouldReturnNullWithUnknownEncounterUuid() {\n \t}\n \t\n \t@Test\n-\tpublic void findEncountersByPatientIdentifier_shouldReturnCollectionOfEncounters() {", "originalCommit": "5308c2c1d204d1a8dba16d670594e583910b460e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "59d2836e433bcc1f5dd99eeec420d6a0d3d5dd80", "chunk": "diff --git a/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirEncounterDaoImplTest.java b/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirEncounterDaoImplTest.java\nindex 6faefc89..0837e3a5 100644\n--- a/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirEncounterDaoImplTest.java\n+++ b/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirEncounterDaoImplTest.java\n\n@@ -92,65 +98,169 @@ public class FhirEncounterDaoImplTest extends BaseModuleContextSensitiveTest {\n \t\n \t@Test\n \tpublic void searchForEncounters_shouldSearchForEncountersByDate() {\n-\t\tCollection<Encounter> results = dao.searchForEncounters(new DateRangeParam(new DateParam(ENCOUNTER_DATE)), null,\n+\t\tCollection<Encounter> results = dao.searchForEncounters(new DateRangeParam(new DateParam(ENCOUNTER_DATETIME)), null,\n \t\t    null, null);\n \t\t\n \t\tassertThat(results, Matchers.notNullValue());\n-\t\t//TODO: THIS FAILS\n-\t\t//java.lang.AssertionError:\n-\t\t//Expected: not an empty collection\n-\t\t//     but: was <[]>\n-\t\t//Expected :not an empty collection\n-\t\t//Actual   :<[]>\n \t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.iterator().next().getEncounterDatetime().toString(), equalTo(ENCOUNTER_DATE));\n \t}\n \t\n \t@Test\n \tpublic void searchForEncounters_shouldSearchForEncountersBySubjectName() {\n \t\tReferenceParam subjectReference = new ReferenceParam();\n+\t\t\n+\t\tsubjectReference.setValue(PATIENT_FULL_NAME);\n \t\tsubjectReference.setChain(Patient.SP_NAME);\n-\t\tsubjectReference.setValue(PATIENT_GIVEN_NAME + \" \" + PATIENT_FAMILY_NAME);\n \t\t\n \t\tCollection<Encounter> results = dao.searchForEncounters(null, null, null, subjectReference);\n \t\t\n \t\tassertThat(results, Matchers.notNullValue());\n \t\tassertThat(results, not(empty()));\n-\t\tassertThat(results, hasItem(hasProperty(\"uuid\", Matchers.equalTo(ENCOUNTER_UUID))));\n+\t\tassertThat(results.iterator().next().getPatient().getPerson().getPersonName().getFullName(),\n+\t\t    equalTo(PATIENT_FULL_NAME));\n \t}\n \t\n \t@Test\n-\tpublic void searchForEncounters_shouldSearchForEncountersByParticipantName() {\n+\tpublic void searchForEncounters_shouldSearchForEncountersBySubjectFamilyName() {\n+\t\tReferenceParam subjectReference = new ReferenceParam();\n+\t\t\n+\t\tsubjectReference.setValue(PATIENT_FAMILY_NAME);\n+\t\tsubjectReference.setChain(Patient.SP_FAMILY);\n+\t\t\n+\t\tCollection<Encounter> results = dao.searchForEncounters(null, null, null, subjectReference);\n+\t\t\n+\t\tassertThat(results, Matchers.notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.iterator().next().getPatient().getPerson().getPersonName().getFamilyName(),\n+\t\t    equalTo(PATIENT_FAMILY_NAME));\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForEncounters_shouldSearchForEncountersBySubjectGivenName() {\n+\t\tReferenceParam subjectReference = new ReferenceParam();\n+\t\t\n+\t\tsubjectReference.setValue(PATIENT_GIVEN_NAME);\n+\t\tsubjectReference.setChain(Patient.SP_GIVEN);\n+\t\t\n+\t\tCollection<Encounter> results = dao.searchForEncounters(null, null, null, subjectReference);\n+\t\t\n+\t\tassertThat(results, Matchers.notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.iterator().next().getPatient().getPerson().getPersonName().getGivenName(),\n+\t\t    equalTo(PATIENT_GIVEN_NAME));\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForEncounters_shouldSearchForEncountersBySubjectIdentifier() {\n+\t\tReferenceParam subjectReference = new ReferenceParam();\n+\t\t\n+\t\tsubjectReference.setValue(PATIENT_IDENTIFIER);\n+\t\tsubjectReference.setChain(Patient.SP_IDENTIFIER);\n+\t\t\n+\t\tCollection<Encounter> results = dao.searchForEncounters(null, null, null, subjectReference);\n+\t\t\n+\t\tassertThat(results, Matchers.notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.iterator().next().getPatient().getPatientIdentifier().getIdentifier(),\n+\t\t    equalTo(PATIENT_IDENTIFIER));\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForEncounters_shouldSearchForEncountersByParticipantIdentifier() {\n+\t\tReferenceParam participantReference = new ReferenceParam();\n+\t\t\n+\t\tparticipantReference.setChain(Practitioner.SP_IDENTIFIER);\n+\t\tparticipantReference.setValue(PATIENT_IDENTIFIER);\n+\t\t\n+\t\tCollection<Encounter> results = dao.searchForEncounters(null, null, participantReference, null);\n+\t\t\n+\t\tassertThat(results, Matchers.notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.iterator().next().getEncounterProviders().size(), greaterThanOrEqualTo(1));\n+\t\tassertThat(results.iterator().next().getEncounterProviders().iterator().next().getProvider(), notNullValue());\n+\t\tassertThat(results.iterator().next().getEncounterProviders().iterator().next().getProvider().getIdentifier(),\n+\t\t    equalTo(PARTICIPANT_IDENTIFIER));\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForEncounters_shouldSearchForEncountersByParticipantGivenName() {\n+\t\tReferenceParam participantReference = new ReferenceParam();\n+\t\t\n+\t\tparticipantReference.setValue(PARTICIPANT_GIVEN_NAME);\n+\t\tparticipantReference.setChain(Practitioner.SP_GIVEN);\n+\t\t\n+\t\tCollection<Encounter> results = dao.searchForEncounters(null, null, participantReference, null);\n+\t\t\n+\t\tassertThat(results, Matchers.notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.iterator().next().getEncounterProviders().size(), greaterThanOrEqualTo(1));\n+\t\tassertThat(results.iterator().next().getEncounterProviders().iterator().next().getProvider(), notNullValue());\n+\t\tassertThat(results.iterator().next().getEncounterProviders().iterator().next().getProvider().getPerson()\n+\t\t        .getPersonName().getGivenName(),\n+\t\t    equalTo(PARTICIPANT_GIVEN_NAME));\n+\t\t\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForEncounters_shouldSearchForEncountersByParticipantFamilyName() {\n \t\tReferenceParam participantReference = new ReferenceParam();\n-\t\tparticipantReference.setChain(\"\");\n-\t\tparticipantReference.setValue(ENCOUNTER_UUID);\n+\t\t\n+\t\tparticipantReference.setValue(PARTICIPANT_FAMILY_NAME);\n+\t\tparticipantReference.setChain(Practitioner.SP_FAMILY);\n \t\t\n \t\tCollection<Encounter> results = dao.searchForEncounters(null, null, participantReference, null);\n \t\t\n \t\tassertThat(results, Matchers.notNullValue());\n-\t\t//TODO: THIS FAILS\n-\t\t//java.lang.AssertionError:\n-\t\t//Expected: not an empty collection\n-\t\t//     but: was <[]>\n-\t\t//Expected :not an empty collection\n-\t\t//Actual   :<[]>\n \t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.iterator().next().getEncounterProviders().size(), greaterThanOrEqualTo(1));\n+\t\tassertThat(results.iterator().next().getEncounterProviders().iterator().next().getProvider(), notNullValue());\n+\t\tassertThat(results.iterator().next().getEncounterProviders().iterator().next().getProvider().getPerson()\n+\t\t        .getPersonName().getFamilyName(),\n+\t\t    equalTo(PARTICIPANT_FAMILY_NAME));\n+\t\t\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForEncounters_shouldSearchForEncountersByParticipantName() {\n+\t\tReferenceParam subjectReference = new ReferenceParam();\n+\t\t\n+\t\tsubjectReference.setValue(PATIENT_FULL_NAME);\n+\t\tsubjectReference.setChain(Practitioner.SP_NAME);\n+\t\t\n+\t\tCollection<Encounter> results = dao.searchForEncounters(null, null, null, subjectReference);\n+\t\t\n+\t\tassertThat(results, Matchers.notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.iterator().next().getPatient().getPerson().getPersonName().getFullName(),\n+\t\t    equalTo(PATIENT_FULL_NAME));\n \t}\n \t\n \t@Test\n-\tpublic void searchForEncounters_shouldSearchForEncountersByEncounterLocation() {\n+\tpublic void searchForEncounters_shouldSearchForEncountersByEncounterLocationCity() {\n \t\tReferenceParam locationReference = new ReferenceParam();\n+\t\t\n+\t\tlocationReference.setValue(ADDRESS_CITY);\n \t\tlocationReference.setChain(Location.SP_ADDRESS_CITY);\n-\t\tlocationReference.setValue(ENCOUNTER_ADDRESS_CITY);\n \t\t\n \t\tCollection<Encounter> results = dao.searchForEncounters(null, locationReference, null, null);\n \t\t\n \t\tassertThat(results, Matchers.notNullValue());\n-\t\t//TODO: THIS FAILS\n-\t\t//java.lang.AssertionError:\n-\t\t//Expected: not an empty collection\n-\t\t//     but: was <[]>\n-\t\t//Expected :not an empty collection\n-\t\t//Actual   :<[]>\n \t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.iterator().next().getLocation().getCityVillage(), equalTo(ADDRESS_CITY));\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForEncounters_shouldSearchForEncountersByEncounterLocationState() {\n+\t\tReferenceParam locationReference = new ReferenceParam();\n+\t\t\n+\t\tlocationReference.setValue(ENCOUNTER_ADDRESS_STATE);\n+\t\tlocationReference.setChain(Location.SP_ADDRESS_STATE);\n+\t\t\n+\t\tCollection<Encounter> results = dao.searchForEncounters(null, locationReference, null, null);\n+\t\t\n+\t\tassertThat(results, Matchers.notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.iterator().next().getLocation().getStateProvince(), equalTo(ENCOUNTER_ADDRESS_STATE));\n \t}\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzg3NTc1Mw==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/86#discussion_r383875753", "bodyText": "Take a look at the data defined for this class (in the XML file)", "author": "ibacher", "createdAt": "2020-02-25T13:26:03Z", "path": "api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirEncounterDaoImplTest.java", "diffHunk": "@@ -72,21 +91,66 @@ public void shouldReturnNullWithUnknownEncounterUuid() {\n \t}\n \t\n \t@Test\n-\tpublic void findEncountersByPatientIdentifier_shouldReturnCollectionOfEncounters() {\n-\t\tList<Encounter> encounters = dao.findEncountersByPatientIdentifier(PATIENT_IDENTIFIER);\n-\t\tassertThat(encounters, notNullValue());\n-\t\tassertThat(encounters.size(), greaterThanOrEqualTo(1));\n-\t\tassertThat(encounters.stream().findFirst().isPresent(), is(true));\n-\t\tassertThat(encounters.stream().findFirst().get().getPatient(), notNullValue());\n-\t\tassertThat(encounters.stream().findFirst().get().getPatient().getPatientIdentifier().getIdentifier(),\n-\t\t    equalTo(PATIENT_IDENTIFIER));\n+\tpublic void searchForEncounters_shouldSearchForEncountersByDate() {\n+\t\tCollection<Encounter> results = dao.searchForEncounters(new DateRangeParam(new DateParam(ENCOUNTER_DATE)), null,\n+\t\t    null, null);\n+\t\t\n+\t\tassertThat(results, Matchers.notNullValue());\n+\t\t//TODO: THIS FAILS", "originalCommit": "5308c2c1d204d1a8dba16d670594e583910b460e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "59d2836e433bcc1f5dd99eeec420d6a0d3d5dd80", "chunk": "diff --git a/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirEncounterDaoImplTest.java b/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirEncounterDaoImplTest.java\nindex 6faefc89..0837e3a5 100644\n--- a/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirEncounterDaoImplTest.java\n+++ b/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirEncounterDaoImplTest.java\n\n@@ -92,65 +98,169 @@ public class FhirEncounterDaoImplTest extends BaseModuleContextSensitiveTest {\n \t\n \t@Test\n \tpublic void searchForEncounters_shouldSearchForEncountersByDate() {\n-\t\tCollection<Encounter> results = dao.searchForEncounters(new DateRangeParam(new DateParam(ENCOUNTER_DATE)), null,\n+\t\tCollection<Encounter> results = dao.searchForEncounters(new DateRangeParam(new DateParam(ENCOUNTER_DATETIME)), null,\n \t\t    null, null);\n \t\t\n \t\tassertThat(results, Matchers.notNullValue());\n-\t\t//TODO: THIS FAILS\n-\t\t//java.lang.AssertionError:\n-\t\t//Expected: not an empty collection\n-\t\t//     but: was <[]>\n-\t\t//Expected :not an empty collection\n-\t\t//Actual   :<[]>\n \t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.iterator().next().getEncounterDatetime().toString(), equalTo(ENCOUNTER_DATE));\n \t}\n \t\n \t@Test\n \tpublic void searchForEncounters_shouldSearchForEncountersBySubjectName() {\n \t\tReferenceParam subjectReference = new ReferenceParam();\n+\t\t\n+\t\tsubjectReference.setValue(PATIENT_FULL_NAME);\n \t\tsubjectReference.setChain(Patient.SP_NAME);\n-\t\tsubjectReference.setValue(PATIENT_GIVEN_NAME + \" \" + PATIENT_FAMILY_NAME);\n \t\t\n \t\tCollection<Encounter> results = dao.searchForEncounters(null, null, null, subjectReference);\n \t\t\n \t\tassertThat(results, Matchers.notNullValue());\n \t\tassertThat(results, not(empty()));\n-\t\tassertThat(results, hasItem(hasProperty(\"uuid\", Matchers.equalTo(ENCOUNTER_UUID))));\n+\t\tassertThat(results.iterator().next().getPatient().getPerson().getPersonName().getFullName(),\n+\t\t    equalTo(PATIENT_FULL_NAME));\n \t}\n \t\n \t@Test\n-\tpublic void searchForEncounters_shouldSearchForEncountersByParticipantName() {\n+\tpublic void searchForEncounters_shouldSearchForEncountersBySubjectFamilyName() {\n+\t\tReferenceParam subjectReference = new ReferenceParam();\n+\t\t\n+\t\tsubjectReference.setValue(PATIENT_FAMILY_NAME);\n+\t\tsubjectReference.setChain(Patient.SP_FAMILY);\n+\t\t\n+\t\tCollection<Encounter> results = dao.searchForEncounters(null, null, null, subjectReference);\n+\t\t\n+\t\tassertThat(results, Matchers.notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.iterator().next().getPatient().getPerson().getPersonName().getFamilyName(),\n+\t\t    equalTo(PATIENT_FAMILY_NAME));\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForEncounters_shouldSearchForEncountersBySubjectGivenName() {\n+\t\tReferenceParam subjectReference = new ReferenceParam();\n+\t\t\n+\t\tsubjectReference.setValue(PATIENT_GIVEN_NAME);\n+\t\tsubjectReference.setChain(Patient.SP_GIVEN);\n+\t\t\n+\t\tCollection<Encounter> results = dao.searchForEncounters(null, null, null, subjectReference);\n+\t\t\n+\t\tassertThat(results, Matchers.notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.iterator().next().getPatient().getPerson().getPersonName().getGivenName(),\n+\t\t    equalTo(PATIENT_GIVEN_NAME));\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForEncounters_shouldSearchForEncountersBySubjectIdentifier() {\n+\t\tReferenceParam subjectReference = new ReferenceParam();\n+\t\t\n+\t\tsubjectReference.setValue(PATIENT_IDENTIFIER);\n+\t\tsubjectReference.setChain(Patient.SP_IDENTIFIER);\n+\t\t\n+\t\tCollection<Encounter> results = dao.searchForEncounters(null, null, null, subjectReference);\n+\t\t\n+\t\tassertThat(results, Matchers.notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.iterator().next().getPatient().getPatientIdentifier().getIdentifier(),\n+\t\t    equalTo(PATIENT_IDENTIFIER));\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForEncounters_shouldSearchForEncountersByParticipantIdentifier() {\n+\t\tReferenceParam participantReference = new ReferenceParam();\n+\t\t\n+\t\tparticipantReference.setChain(Practitioner.SP_IDENTIFIER);\n+\t\tparticipantReference.setValue(PATIENT_IDENTIFIER);\n+\t\t\n+\t\tCollection<Encounter> results = dao.searchForEncounters(null, null, participantReference, null);\n+\t\t\n+\t\tassertThat(results, Matchers.notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.iterator().next().getEncounterProviders().size(), greaterThanOrEqualTo(1));\n+\t\tassertThat(results.iterator().next().getEncounterProviders().iterator().next().getProvider(), notNullValue());\n+\t\tassertThat(results.iterator().next().getEncounterProviders().iterator().next().getProvider().getIdentifier(),\n+\t\t    equalTo(PARTICIPANT_IDENTIFIER));\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForEncounters_shouldSearchForEncountersByParticipantGivenName() {\n+\t\tReferenceParam participantReference = new ReferenceParam();\n+\t\t\n+\t\tparticipantReference.setValue(PARTICIPANT_GIVEN_NAME);\n+\t\tparticipantReference.setChain(Practitioner.SP_GIVEN);\n+\t\t\n+\t\tCollection<Encounter> results = dao.searchForEncounters(null, null, participantReference, null);\n+\t\t\n+\t\tassertThat(results, Matchers.notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.iterator().next().getEncounterProviders().size(), greaterThanOrEqualTo(1));\n+\t\tassertThat(results.iterator().next().getEncounterProviders().iterator().next().getProvider(), notNullValue());\n+\t\tassertThat(results.iterator().next().getEncounterProviders().iterator().next().getProvider().getPerson()\n+\t\t        .getPersonName().getGivenName(),\n+\t\t    equalTo(PARTICIPANT_GIVEN_NAME));\n+\t\t\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForEncounters_shouldSearchForEncountersByParticipantFamilyName() {\n \t\tReferenceParam participantReference = new ReferenceParam();\n-\t\tparticipantReference.setChain(\"\");\n-\t\tparticipantReference.setValue(ENCOUNTER_UUID);\n+\t\t\n+\t\tparticipantReference.setValue(PARTICIPANT_FAMILY_NAME);\n+\t\tparticipantReference.setChain(Practitioner.SP_FAMILY);\n \t\t\n \t\tCollection<Encounter> results = dao.searchForEncounters(null, null, participantReference, null);\n \t\t\n \t\tassertThat(results, Matchers.notNullValue());\n-\t\t//TODO: THIS FAILS\n-\t\t//java.lang.AssertionError:\n-\t\t//Expected: not an empty collection\n-\t\t//     but: was <[]>\n-\t\t//Expected :not an empty collection\n-\t\t//Actual   :<[]>\n \t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.iterator().next().getEncounterProviders().size(), greaterThanOrEqualTo(1));\n+\t\tassertThat(results.iterator().next().getEncounterProviders().iterator().next().getProvider(), notNullValue());\n+\t\tassertThat(results.iterator().next().getEncounterProviders().iterator().next().getProvider().getPerson()\n+\t\t        .getPersonName().getFamilyName(),\n+\t\t    equalTo(PARTICIPANT_FAMILY_NAME));\n+\t\t\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForEncounters_shouldSearchForEncountersByParticipantName() {\n+\t\tReferenceParam subjectReference = new ReferenceParam();\n+\t\t\n+\t\tsubjectReference.setValue(PATIENT_FULL_NAME);\n+\t\tsubjectReference.setChain(Practitioner.SP_NAME);\n+\t\t\n+\t\tCollection<Encounter> results = dao.searchForEncounters(null, null, null, subjectReference);\n+\t\t\n+\t\tassertThat(results, Matchers.notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.iterator().next().getPatient().getPerson().getPersonName().getFullName(),\n+\t\t    equalTo(PATIENT_FULL_NAME));\n \t}\n \t\n \t@Test\n-\tpublic void searchForEncounters_shouldSearchForEncountersByEncounterLocation() {\n+\tpublic void searchForEncounters_shouldSearchForEncountersByEncounterLocationCity() {\n \t\tReferenceParam locationReference = new ReferenceParam();\n+\t\t\n+\t\tlocationReference.setValue(ADDRESS_CITY);\n \t\tlocationReference.setChain(Location.SP_ADDRESS_CITY);\n-\t\tlocationReference.setValue(ENCOUNTER_ADDRESS_CITY);\n \t\t\n \t\tCollection<Encounter> results = dao.searchForEncounters(null, locationReference, null, null);\n \t\t\n \t\tassertThat(results, Matchers.notNullValue());\n-\t\t//TODO: THIS FAILS\n-\t\t//java.lang.AssertionError:\n-\t\t//Expected: not an empty collection\n-\t\t//     but: was <[]>\n-\t\t//Expected :not an empty collection\n-\t\t//Actual   :<[]>\n \t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.iterator().next().getLocation().getCityVillage(), equalTo(ADDRESS_CITY));\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForEncounters_shouldSearchForEncountersByEncounterLocationState() {\n+\t\tReferenceParam locationReference = new ReferenceParam();\n+\t\t\n+\t\tlocationReference.setValue(ENCOUNTER_ADDRESS_STATE);\n+\t\tlocationReference.setChain(Location.SP_ADDRESS_STATE);\n+\t\t\n+\t\tCollection<Encounter> results = dao.searchForEncounters(null, locationReference, null, null);\n+\t\t\n+\t\tassertThat(results, Matchers.notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.iterator().next().getLocation().getStateProvince(), equalTo(ENCOUNTER_ADDRESS_STATE));\n \t}\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzg3NjI3OA==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/86#discussion_r383876278", "bodyText": "We should also have tests by Given and Family", "author": "ibacher", "createdAt": "2020-02-25T13:27:03Z", "path": "api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirEncounterDaoImplTest.java", "diffHunk": "@@ -72,21 +91,66 @@ public void shouldReturnNullWithUnknownEncounterUuid() {\n \t}\n \t\n \t@Test\n-\tpublic void findEncountersByPatientIdentifier_shouldReturnCollectionOfEncounters() {\n-\t\tList<Encounter> encounters = dao.findEncountersByPatientIdentifier(PATIENT_IDENTIFIER);\n-\t\tassertThat(encounters, notNullValue());\n-\t\tassertThat(encounters.size(), greaterThanOrEqualTo(1));\n-\t\tassertThat(encounters.stream().findFirst().isPresent(), is(true));\n-\t\tassertThat(encounters.stream().findFirst().get().getPatient(), notNullValue());\n-\t\tassertThat(encounters.stream().findFirst().get().getPatient().getPatientIdentifier().getIdentifier(),\n-\t\t    equalTo(PATIENT_IDENTIFIER));\n+\tpublic void searchForEncounters_shouldSearchForEncountersByDate() {\n+\t\tCollection<Encounter> results = dao.searchForEncounters(new DateRangeParam(new DateParam(ENCOUNTER_DATE)), null,\n+\t\t    null, null);\n+\t\t\n+\t\tassertThat(results, Matchers.notNullValue());\n+\t\t//TODO: THIS FAILS\n+\t\t//java.lang.AssertionError:\n+\t\t//Expected: not an empty collection\n+\t\t//     but: was <[]>\n+\t\t//Expected :not an empty collection\n+\t\t//Actual   :<[]>\n+\t\tassertThat(results, not(empty()));\n \t}\n \t\n \t@Test\n-\tpublic void findEncountersByWrongPatientIdentifier_shouldReturnEmptyCollectionOfEncounters() {\n-\t\tList<Encounter> encounters = dao.findEncountersByPatientIdentifier(WRONG_PATIENT_IDENTIFIER);\n-\t\tassertThat(encounters, notNullValue());\n-\t\tassertThat(encounters, is(empty()));\n+\tpublic void searchForEncounters_shouldSearchForEncountersBySubjectName() {\n+\t\tReferenceParam subjectReference = new ReferenceParam();\n+\t\tsubjectReference.setChain(Patient.SP_NAME);\n+\t\tsubjectReference.setValue(PATIENT_GIVEN_NAME + \" \" + PATIENT_FAMILY_NAME);\n+\t\t\n+\t\tCollection<Encounter> results = dao.searchForEncounters(null, null, null, subjectReference);\n+\t\t\n+\t\tassertThat(results, Matchers.notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results, hasItem(hasProperty(\"uuid\", Matchers.equalTo(ENCOUNTER_UUID))));\n \t}\n \t\n+\t@Test\n+\tpublic void searchForEncounters_shouldSearchForEncountersByParticipantName() {", "originalCommit": "5308c2c1d204d1a8dba16d670594e583910b460e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "59d2836e433bcc1f5dd99eeec420d6a0d3d5dd80", "chunk": "diff --git a/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirEncounterDaoImplTest.java b/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirEncounterDaoImplTest.java\nindex 6faefc89..0837e3a5 100644\n--- a/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirEncounterDaoImplTest.java\n+++ b/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirEncounterDaoImplTest.java\n\n@@ -92,65 +98,169 @@ public class FhirEncounterDaoImplTest extends BaseModuleContextSensitiveTest {\n \t\n \t@Test\n \tpublic void searchForEncounters_shouldSearchForEncountersByDate() {\n-\t\tCollection<Encounter> results = dao.searchForEncounters(new DateRangeParam(new DateParam(ENCOUNTER_DATE)), null,\n+\t\tCollection<Encounter> results = dao.searchForEncounters(new DateRangeParam(new DateParam(ENCOUNTER_DATETIME)), null,\n \t\t    null, null);\n \t\t\n \t\tassertThat(results, Matchers.notNullValue());\n-\t\t//TODO: THIS FAILS\n-\t\t//java.lang.AssertionError:\n-\t\t//Expected: not an empty collection\n-\t\t//     but: was <[]>\n-\t\t//Expected :not an empty collection\n-\t\t//Actual   :<[]>\n \t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.iterator().next().getEncounterDatetime().toString(), equalTo(ENCOUNTER_DATE));\n \t}\n \t\n \t@Test\n \tpublic void searchForEncounters_shouldSearchForEncountersBySubjectName() {\n \t\tReferenceParam subjectReference = new ReferenceParam();\n+\t\t\n+\t\tsubjectReference.setValue(PATIENT_FULL_NAME);\n \t\tsubjectReference.setChain(Patient.SP_NAME);\n-\t\tsubjectReference.setValue(PATIENT_GIVEN_NAME + \" \" + PATIENT_FAMILY_NAME);\n \t\t\n \t\tCollection<Encounter> results = dao.searchForEncounters(null, null, null, subjectReference);\n \t\t\n \t\tassertThat(results, Matchers.notNullValue());\n \t\tassertThat(results, not(empty()));\n-\t\tassertThat(results, hasItem(hasProperty(\"uuid\", Matchers.equalTo(ENCOUNTER_UUID))));\n+\t\tassertThat(results.iterator().next().getPatient().getPerson().getPersonName().getFullName(),\n+\t\t    equalTo(PATIENT_FULL_NAME));\n \t}\n \t\n \t@Test\n-\tpublic void searchForEncounters_shouldSearchForEncountersByParticipantName() {\n+\tpublic void searchForEncounters_shouldSearchForEncountersBySubjectFamilyName() {\n+\t\tReferenceParam subjectReference = new ReferenceParam();\n+\t\t\n+\t\tsubjectReference.setValue(PATIENT_FAMILY_NAME);\n+\t\tsubjectReference.setChain(Patient.SP_FAMILY);\n+\t\t\n+\t\tCollection<Encounter> results = dao.searchForEncounters(null, null, null, subjectReference);\n+\t\t\n+\t\tassertThat(results, Matchers.notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.iterator().next().getPatient().getPerson().getPersonName().getFamilyName(),\n+\t\t    equalTo(PATIENT_FAMILY_NAME));\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForEncounters_shouldSearchForEncountersBySubjectGivenName() {\n+\t\tReferenceParam subjectReference = new ReferenceParam();\n+\t\t\n+\t\tsubjectReference.setValue(PATIENT_GIVEN_NAME);\n+\t\tsubjectReference.setChain(Patient.SP_GIVEN);\n+\t\t\n+\t\tCollection<Encounter> results = dao.searchForEncounters(null, null, null, subjectReference);\n+\t\t\n+\t\tassertThat(results, Matchers.notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.iterator().next().getPatient().getPerson().getPersonName().getGivenName(),\n+\t\t    equalTo(PATIENT_GIVEN_NAME));\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForEncounters_shouldSearchForEncountersBySubjectIdentifier() {\n+\t\tReferenceParam subjectReference = new ReferenceParam();\n+\t\t\n+\t\tsubjectReference.setValue(PATIENT_IDENTIFIER);\n+\t\tsubjectReference.setChain(Patient.SP_IDENTIFIER);\n+\t\t\n+\t\tCollection<Encounter> results = dao.searchForEncounters(null, null, null, subjectReference);\n+\t\t\n+\t\tassertThat(results, Matchers.notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.iterator().next().getPatient().getPatientIdentifier().getIdentifier(),\n+\t\t    equalTo(PATIENT_IDENTIFIER));\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForEncounters_shouldSearchForEncountersByParticipantIdentifier() {\n+\t\tReferenceParam participantReference = new ReferenceParam();\n+\t\t\n+\t\tparticipantReference.setChain(Practitioner.SP_IDENTIFIER);\n+\t\tparticipantReference.setValue(PATIENT_IDENTIFIER);\n+\t\t\n+\t\tCollection<Encounter> results = dao.searchForEncounters(null, null, participantReference, null);\n+\t\t\n+\t\tassertThat(results, Matchers.notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.iterator().next().getEncounterProviders().size(), greaterThanOrEqualTo(1));\n+\t\tassertThat(results.iterator().next().getEncounterProviders().iterator().next().getProvider(), notNullValue());\n+\t\tassertThat(results.iterator().next().getEncounterProviders().iterator().next().getProvider().getIdentifier(),\n+\t\t    equalTo(PARTICIPANT_IDENTIFIER));\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForEncounters_shouldSearchForEncountersByParticipantGivenName() {\n+\t\tReferenceParam participantReference = new ReferenceParam();\n+\t\t\n+\t\tparticipantReference.setValue(PARTICIPANT_GIVEN_NAME);\n+\t\tparticipantReference.setChain(Practitioner.SP_GIVEN);\n+\t\t\n+\t\tCollection<Encounter> results = dao.searchForEncounters(null, null, participantReference, null);\n+\t\t\n+\t\tassertThat(results, Matchers.notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.iterator().next().getEncounterProviders().size(), greaterThanOrEqualTo(1));\n+\t\tassertThat(results.iterator().next().getEncounterProviders().iterator().next().getProvider(), notNullValue());\n+\t\tassertThat(results.iterator().next().getEncounterProviders().iterator().next().getProvider().getPerson()\n+\t\t        .getPersonName().getGivenName(),\n+\t\t    equalTo(PARTICIPANT_GIVEN_NAME));\n+\t\t\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForEncounters_shouldSearchForEncountersByParticipantFamilyName() {\n \t\tReferenceParam participantReference = new ReferenceParam();\n-\t\tparticipantReference.setChain(\"\");\n-\t\tparticipantReference.setValue(ENCOUNTER_UUID);\n+\t\t\n+\t\tparticipantReference.setValue(PARTICIPANT_FAMILY_NAME);\n+\t\tparticipantReference.setChain(Practitioner.SP_FAMILY);\n \t\t\n \t\tCollection<Encounter> results = dao.searchForEncounters(null, null, participantReference, null);\n \t\t\n \t\tassertThat(results, Matchers.notNullValue());\n-\t\t//TODO: THIS FAILS\n-\t\t//java.lang.AssertionError:\n-\t\t//Expected: not an empty collection\n-\t\t//     but: was <[]>\n-\t\t//Expected :not an empty collection\n-\t\t//Actual   :<[]>\n \t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.iterator().next().getEncounterProviders().size(), greaterThanOrEqualTo(1));\n+\t\tassertThat(results.iterator().next().getEncounterProviders().iterator().next().getProvider(), notNullValue());\n+\t\tassertThat(results.iterator().next().getEncounterProviders().iterator().next().getProvider().getPerson()\n+\t\t        .getPersonName().getFamilyName(),\n+\t\t    equalTo(PARTICIPANT_FAMILY_NAME));\n+\t\t\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForEncounters_shouldSearchForEncountersByParticipantName() {\n+\t\tReferenceParam subjectReference = new ReferenceParam();\n+\t\t\n+\t\tsubjectReference.setValue(PATIENT_FULL_NAME);\n+\t\tsubjectReference.setChain(Practitioner.SP_NAME);\n+\t\t\n+\t\tCollection<Encounter> results = dao.searchForEncounters(null, null, null, subjectReference);\n+\t\t\n+\t\tassertThat(results, Matchers.notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.iterator().next().getPatient().getPerson().getPersonName().getFullName(),\n+\t\t    equalTo(PATIENT_FULL_NAME));\n \t}\n \t\n \t@Test\n-\tpublic void searchForEncounters_shouldSearchForEncountersByEncounterLocation() {\n+\tpublic void searchForEncounters_shouldSearchForEncountersByEncounterLocationCity() {\n \t\tReferenceParam locationReference = new ReferenceParam();\n+\t\t\n+\t\tlocationReference.setValue(ADDRESS_CITY);\n \t\tlocationReference.setChain(Location.SP_ADDRESS_CITY);\n-\t\tlocationReference.setValue(ENCOUNTER_ADDRESS_CITY);\n \t\t\n \t\tCollection<Encounter> results = dao.searchForEncounters(null, locationReference, null, null);\n \t\t\n \t\tassertThat(results, Matchers.notNullValue());\n-\t\t//TODO: THIS FAILS\n-\t\t//java.lang.AssertionError:\n-\t\t//Expected: not an empty collection\n-\t\t//     but: was <[]>\n-\t\t//Expected :not an empty collection\n-\t\t//Actual   :<[]>\n \t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.iterator().next().getLocation().getCityVillage(), equalTo(ADDRESS_CITY));\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForEncounters_shouldSearchForEncountersByEncounterLocationState() {\n+\t\tReferenceParam locationReference = new ReferenceParam();\n+\t\t\n+\t\tlocationReference.setValue(ENCOUNTER_ADDRESS_STATE);\n+\t\tlocationReference.setChain(Location.SP_ADDRESS_STATE);\n+\t\t\n+\t\tCollection<Encounter> results = dao.searchForEncounters(null, locationReference, null, null);\n+\t\t\n+\t\tassertThat(results, Matchers.notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.iterator().next().getLocation().getStateProvince(), equalTo(ENCOUNTER_ADDRESS_STATE));\n \t}\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzg3NjM0NQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/86#discussion_r383876345", "bodyText": "We should also have tests by Given and Family", "author": "ibacher", "createdAt": "2020-02-25T13:27:11Z", "path": "api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirEncounterDaoImplTest.java", "diffHunk": "@@ -72,21 +91,66 @@ public void shouldReturnNullWithUnknownEncounterUuid() {\n \t}\n \t\n \t@Test\n-\tpublic void findEncountersByPatientIdentifier_shouldReturnCollectionOfEncounters() {\n-\t\tList<Encounter> encounters = dao.findEncountersByPatientIdentifier(PATIENT_IDENTIFIER);\n-\t\tassertThat(encounters, notNullValue());\n-\t\tassertThat(encounters.size(), greaterThanOrEqualTo(1));\n-\t\tassertThat(encounters.stream().findFirst().isPresent(), is(true));\n-\t\tassertThat(encounters.stream().findFirst().get().getPatient(), notNullValue());\n-\t\tassertThat(encounters.stream().findFirst().get().getPatient().getPatientIdentifier().getIdentifier(),\n-\t\t    equalTo(PATIENT_IDENTIFIER));\n+\tpublic void searchForEncounters_shouldSearchForEncountersByDate() {\n+\t\tCollection<Encounter> results = dao.searchForEncounters(new DateRangeParam(new DateParam(ENCOUNTER_DATE)), null,\n+\t\t    null, null);\n+\t\t\n+\t\tassertThat(results, Matchers.notNullValue());\n+\t\t//TODO: THIS FAILS\n+\t\t//java.lang.AssertionError:\n+\t\t//Expected: not an empty collection\n+\t\t//     but: was <[]>\n+\t\t//Expected :not an empty collection\n+\t\t//Actual   :<[]>\n+\t\tassertThat(results, not(empty()));\n \t}\n \t\n \t@Test\n-\tpublic void findEncountersByWrongPatientIdentifier_shouldReturnEmptyCollectionOfEncounters() {\n-\t\tList<Encounter> encounters = dao.findEncountersByPatientIdentifier(WRONG_PATIENT_IDENTIFIER);\n-\t\tassertThat(encounters, notNullValue());\n-\t\tassertThat(encounters, is(empty()));\n+\tpublic void searchForEncounters_shouldSearchForEncountersBySubjectName() {", "originalCommit": "5308c2c1d204d1a8dba16d670594e583910b460e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "59d2836e433bcc1f5dd99eeec420d6a0d3d5dd80", "chunk": "diff --git a/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirEncounterDaoImplTest.java b/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirEncounterDaoImplTest.java\nindex 6faefc89..0837e3a5 100644\n--- a/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirEncounterDaoImplTest.java\n+++ b/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirEncounterDaoImplTest.java\n\n@@ -92,65 +98,169 @@ public class FhirEncounterDaoImplTest extends BaseModuleContextSensitiveTest {\n \t\n \t@Test\n \tpublic void searchForEncounters_shouldSearchForEncountersByDate() {\n-\t\tCollection<Encounter> results = dao.searchForEncounters(new DateRangeParam(new DateParam(ENCOUNTER_DATE)), null,\n+\t\tCollection<Encounter> results = dao.searchForEncounters(new DateRangeParam(new DateParam(ENCOUNTER_DATETIME)), null,\n \t\t    null, null);\n \t\t\n \t\tassertThat(results, Matchers.notNullValue());\n-\t\t//TODO: THIS FAILS\n-\t\t//java.lang.AssertionError:\n-\t\t//Expected: not an empty collection\n-\t\t//     but: was <[]>\n-\t\t//Expected :not an empty collection\n-\t\t//Actual   :<[]>\n \t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.iterator().next().getEncounterDatetime().toString(), equalTo(ENCOUNTER_DATE));\n \t}\n \t\n \t@Test\n \tpublic void searchForEncounters_shouldSearchForEncountersBySubjectName() {\n \t\tReferenceParam subjectReference = new ReferenceParam();\n+\t\t\n+\t\tsubjectReference.setValue(PATIENT_FULL_NAME);\n \t\tsubjectReference.setChain(Patient.SP_NAME);\n-\t\tsubjectReference.setValue(PATIENT_GIVEN_NAME + \" \" + PATIENT_FAMILY_NAME);\n \t\t\n \t\tCollection<Encounter> results = dao.searchForEncounters(null, null, null, subjectReference);\n \t\t\n \t\tassertThat(results, Matchers.notNullValue());\n \t\tassertThat(results, not(empty()));\n-\t\tassertThat(results, hasItem(hasProperty(\"uuid\", Matchers.equalTo(ENCOUNTER_UUID))));\n+\t\tassertThat(results.iterator().next().getPatient().getPerson().getPersonName().getFullName(),\n+\t\t    equalTo(PATIENT_FULL_NAME));\n \t}\n \t\n \t@Test\n-\tpublic void searchForEncounters_shouldSearchForEncountersByParticipantName() {\n+\tpublic void searchForEncounters_shouldSearchForEncountersBySubjectFamilyName() {\n+\t\tReferenceParam subjectReference = new ReferenceParam();\n+\t\t\n+\t\tsubjectReference.setValue(PATIENT_FAMILY_NAME);\n+\t\tsubjectReference.setChain(Patient.SP_FAMILY);\n+\t\t\n+\t\tCollection<Encounter> results = dao.searchForEncounters(null, null, null, subjectReference);\n+\t\t\n+\t\tassertThat(results, Matchers.notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.iterator().next().getPatient().getPerson().getPersonName().getFamilyName(),\n+\t\t    equalTo(PATIENT_FAMILY_NAME));\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForEncounters_shouldSearchForEncountersBySubjectGivenName() {\n+\t\tReferenceParam subjectReference = new ReferenceParam();\n+\t\t\n+\t\tsubjectReference.setValue(PATIENT_GIVEN_NAME);\n+\t\tsubjectReference.setChain(Patient.SP_GIVEN);\n+\t\t\n+\t\tCollection<Encounter> results = dao.searchForEncounters(null, null, null, subjectReference);\n+\t\t\n+\t\tassertThat(results, Matchers.notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.iterator().next().getPatient().getPerson().getPersonName().getGivenName(),\n+\t\t    equalTo(PATIENT_GIVEN_NAME));\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForEncounters_shouldSearchForEncountersBySubjectIdentifier() {\n+\t\tReferenceParam subjectReference = new ReferenceParam();\n+\t\t\n+\t\tsubjectReference.setValue(PATIENT_IDENTIFIER);\n+\t\tsubjectReference.setChain(Patient.SP_IDENTIFIER);\n+\t\t\n+\t\tCollection<Encounter> results = dao.searchForEncounters(null, null, null, subjectReference);\n+\t\t\n+\t\tassertThat(results, Matchers.notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.iterator().next().getPatient().getPatientIdentifier().getIdentifier(),\n+\t\t    equalTo(PATIENT_IDENTIFIER));\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForEncounters_shouldSearchForEncountersByParticipantIdentifier() {\n+\t\tReferenceParam participantReference = new ReferenceParam();\n+\t\t\n+\t\tparticipantReference.setChain(Practitioner.SP_IDENTIFIER);\n+\t\tparticipantReference.setValue(PATIENT_IDENTIFIER);\n+\t\t\n+\t\tCollection<Encounter> results = dao.searchForEncounters(null, null, participantReference, null);\n+\t\t\n+\t\tassertThat(results, Matchers.notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.iterator().next().getEncounterProviders().size(), greaterThanOrEqualTo(1));\n+\t\tassertThat(results.iterator().next().getEncounterProviders().iterator().next().getProvider(), notNullValue());\n+\t\tassertThat(results.iterator().next().getEncounterProviders().iterator().next().getProvider().getIdentifier(),\n+\t\t    equalTo(PARTICIPANT_IDENTIFIER));\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForEncounters_shouldSearchForEncountersByParticipantGivenName() {\n+\t\tReferenceParam participantReference = new ReferenceParam();\n+\t\t\n+\t\tparticipantReference.setValue(PARTICIPANT_GIVEN_NAME);\n+\t\tparticipantReference.setChain(Practitioner.SP_GIVEN);\n+\t\t\n+\t\tCollection<Encounter> results = dao.searchForEncounters(null, null, participantReference, null);\n+\t\t\n+\t\tassertThat(results, Matchers.notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.iterator().next().getEncounterProviders().size(), greaterThanOrEqualTo(1));\n+\t\tassertThat(results.iterator().next().getEncounterProviders().iterator().next().getProvider(), notNullValue());\n+\t\tassertThat(results.iterator().next().getEncounterProviders().iterator().next().getProvider().getPerson()\n+\t\t        .getPersonName().getGivenName(),\n+\t\t    equalTo(PARTICIPANT_GIVEN_NAME));\n+\t\t\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForEncounters_shouldSearchForEncountersByParticipantFamilyName() {\n \t\tReferenceParam participantReference = new ReferenceParam();\n-\t\tparticipantReference.setChain(\"\");\n-\t\tparticipantReference.setValue(ENCOUNTER_UUID);\n+\t\t\n+\t\tparticipantReference.setValue(PARTICIPANT_FAMILY_NAME);\n+\t\tparticipantReference.setChain(Practitioner.SP_FAMILY);\n \t\t\n \t\tCollection<Encounter> results = dao.searchForEncounters(null, null, participantReference, null);\n \t\t\n \t\tassertThat(results, Matchers.notNullValue());\n-\t\t//TODO: THIS FAILS\n-\t\t//java.lang.AssertionError:\n-\t\t//Expected: not an empty collection\n-\t\t//     but: was <[]>\n-\t\t//Expected :not an empty collection\n-\t\t//Actual   :<[]>\n \t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.iterator().next().getEncounterProviders().size(), greaterThanOrEqualTo(1));\n+\t\tassertThat(results.iterator().next().getEncounterProviders().iterator().next().getProvider(), notNullValue());\n+\t\tassertThat(results.iterator().next().getEncounterProviders().iterator().next().getProvider().getPerson()\n+\t\t        .getPersonName().getFamilyName(),\n+\t\t    equalTo(PARTICIPANT_FAMILY_NAME));\n+\t\t\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForEncounters_shouldSearchForEncountersByParticipantName() {\n+\t\tReferenceParam subjectReference = new ReferenceParam();\n+\t\t\n+\t\tsubjectReference.setValue(PATIENT_FULL_NAME);\n+\t\tsubjectReference.setChain(Practitioner.SP_NAME);\n+\t\t\n+\t\tCollection<Encounter> results = dao.searchForEncounters(null, null, null, subjectReference);\n+\t\t\n+\t\tassertThat(results, Matchers.notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.iterator().next().getPatient().getPerson().getPersonName().getFullName(),\n+\t\t    equalTo(PATIENT_FULL_NAME));\n \t}\n \t\n \t@Test\n-\tpublic void searchForEncounters_shouldSearchForEncountersByEncounterLocation() {\n+\tpublic void searchForEncounters_shouldSearchForEncountersByEncounterLocationCity() {\n \t\tReferenceParam locationReference = new ReferenceParam();\n+\t\t\n+\t\tlocationReference.setValue(ADDRESS_CITY);\n \t\tlocationReference.setChain(Location.SP_ADDRESS_CITY);\n-\t\tlocationReference.setValue(ENCOUNTER_ADDRESS_CITY);\n \t\t\n \t\tCollection<Encounter> results = dao.searchForEncounters(null, locationReference, null, null);\n \t\t\n \t\tassertThat(results, Matchers.notNullValue());\n-\t\t//TODO: THIS FAILS\n-\t\t//java.lang.AssertionError:\n-\t\t//Expected: not an empty collection\n-\t\t//     but: was <[]>\n-\t\t//Expected :not an empty collection\n-\t\t//Actual   :<[]>\n \t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.iterator().next().getLocation().getCityVillage(), equalTo(ADDRESS_CITY));\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForEncounters_shouldSearchForEncountersByEncounterLocationState() {\n+\t\tReferenceParam locationReference = new ReferenceParam();\n+\t\t\n+\t\tlocationReference.setValue(ENCOUNTER_ADDRESS_STATE);\n+\t\tlocationReference.setChain(Location.SP_ADDRESS_STATE);\n+\t\t\n+\t\tCollection<Encounter> results = dao.searchForEncounters(null, locationReference, null, null);\n+\t\t\n+\t\tassertThat(results, Matchers.notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.iterator().next().getLocation().getStateProvince(), equalTo(ENCOUNTER_ADDRESS_STATE));\n \t}\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzg3NjU3OQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/86#discussion_r383876579", "bodyText": "Could this be useful in other places?", "author": "ibacher", "createdAt": "2020-02-25T13:27:41Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirEncounterDaoImpl.java", "diffHunk": "@@ -38,10 +52,119 @@ public Encounter getEncounterByUuid(String uuid) {\n \t}\n \t\n \t@Override\n-\t@SuppressWarnings(\"unchecked\")\n-\tpublic List<Encounter> findEncountersByPatientIdentifier(String patientIdentifier) {\n-\t\treturn (List<Encounter>) sessionFactory.getCurrentSession().createCriteria(Encounter.class)\n-\t\t        .createAlias(\"patient\", \"p\").createAlias(\"p.identifiers\", \"pi\").add(eq(\"pi.identifier\", patientIdentifier))\n-\t\t        .list();\n+\tpublic Collection<Encounter> searchForEncounters(DateRangeParam date, ReferenceParam location,\n+\t        ReferenceParam participant, ReferenceParam subject) {\n+\t\t\n+\t\tCriteria criteria = sessionFactory.getCurrentSession().createCriteria(Encounter.class);\n+\t\thandleDateRange(\"encounterDatetime\", date).ifPresent(criteria::add);\n+\t\thandleLocationReference(criteria, location);\n+\t\thandleParticipantReference(criteria, participant);\n+\t\thandleSubjectReference(criteria, subject);\n+\t\t//TODO: handle ReferenceParam for participant, subject, location\n+\t\t\n+\t\treturn criteria.list();\n \t}\n+\t\n+\tprivate void handleLocationReference(Criteria criteria, ReferenceParam locationReference) {", "originalCommit": "5308c2c1d204d1a8dba16d670594e583910b460e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "59d2836e433bcc1f5dd99eeec420d6a0d3d5dd80", "chunk": "diff --git a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirEncounterDaoImpl.java b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirEncounterDaoImpl.java\nindex ee3703d6..31caf0d7 100644\n--- a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirEncounterDaoImpl.java\n+++ b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirEncounterDaoImpl.java\n\n@@ -59,112 +48,9 @@ public class FhirEncounterDaoImpl extends BaseDaoImpl implements FhirEncounterDa\n \t\thandleDateRange(\"encounterDatetime\", date).ifPresent(criteria::add);\n \t\thandleLocationReference(criteria, location);\n \t\thandleParticipantReference(criteria, participant);\n-\t\thandleSubjectReference(criteria, subject);\n+\t\thandlePatientReference(criteria, subject);\n \t\t//TODO: handle ReferenceParam for participant, subject, location\n \t\t\n \t\treturn criteria.list();\n \t}\n-\t\n-\tprivate void handleLocationReference(Criteria criteria, ReferenceParam locationReference) {\n-\t\tif (locationReference != null) {\n-\t\t\tcriteria.createAlias(\"location\", \"l\");\n-\t\t\t\n-\t\t\tif (locationReference.getChain() != null) {\n-\t\t\t\tswitch (locationReference.getChain()) {\n-\t\t\t\t\tcase Location.SP_ADDRESS_CITY:\n-\t\t\t\t\t\tcriteria.add(ilike(\"l.cityVillage\", locationReference.getValue(), MatchMode.START));\n-\t\t\t\t\t\tbreak;\n-\t\t\t\t\tcase Location.SP_ADDRESS_STATE:\n-\t\t\t\t\t\tcriteria.add(ilike(\"l.stateProvince\", locationReference.getValue(), MatchMode.START));\n-\t\t\t\t\t\tbreak;\n-\t\t\t\t\tcase Location.SP_ADDRESS_POSTALCODE:\n-\t\t\t\t\t\tcriteria.add(ilike(\"l.postalCode\", locationReference.getValue(), MatchMode.START));\n-\t\t\t\t\t\tbreak;\n-\t\t\t\t\tcase Location.SP_ADDRESS_COUNTRY:\n-\t\t\t\t\t\tcriteria.add(ilike(\"l.country\", locationReference.getValue(), MatchMode.START));\n-\t\t\t\t\t\tbreak;\n-\t\t\t\t\tcase \"\":\n-\t\t\t\t\t\tcriteria.add(eq(\"l.uuid\", locationReference.getValue()));\n-\t\t\t\t\t\tbreak;\n-\t\t\t\t}\n-\t\t\t}\n-\t\t}\n-\t}\n-\t\n-\tprivate void handleParticipantReference(Criteria criteria, ReferenceParam participantReference) {\n-\t\tif (participantReference != null) {\n-\t\t\tcriteria.createAlias(\"encounterProviders\", \"ep\");\n-\t\t\t\n-\t\t\tif (participantReference.getChain() != null) {\n-\t\t\t\tswitch (participantReference.getChain()) {\n-\t\t\t\t\tcase Practitioner.SP_IDENTIFIER:\n-\t\t\t\t\t\tcriteria.createAlias(\"ep.provider\", \"p\").add(ilike(\"p.identifier\", participantReference.getValue()));\n-\t\t\t\t\t\tbreak;\n-\t\t\t\t\tcase Practitioner.SP_GIVEN:\n-\t\t\t\t\t\tcriteria.createAlias(\"ep.provider\", \"p\").createAlias(\"p.person\", \"ps\").createAlias(\"ps.names\", \"pn\")\n-\t\t\t\t\t\t        .add(ilike(\"pn.givenName\", participantReference.getValue(), MatchMode.START));\n-\t\t\t\t\t\tbreak;\n-\t\t\t\t\tcase Practitioner.SP_FAMILY:\n-\t\t\t\t\t\tcriteria.createAlias(\"ep.provider\", \"p\").createAlias(\"p.person\", \"ps\").createAlias(\"ps.names\", \"pn\")\n-\t\t\t\t\t\t        .add(ilike(\"pn.familyName\", participantReference.getValue(), MatchMode.START));\n-\t\t\t\t\t\tbreak;\n-\t\t\t\t\tcase Practitioner.SP_NAME:\n-\t\t\t\t\t\tcriteria.createAlias(\"ep.provider\", \"p\").createAlias(\"p.person\", \"ps\").createAlias(\"ps.names\", \"pn\");\n-\t\t\t\t\t\t\n-\t\t\t\t\t\tList<Optional<Criterion>> criterionList = new ArrayList<>();\n-\t\t\t\t\t\t\n-\t\t\t\t\t\tfor (String token : StringUtils.split(participantReference.getValue(), \" \\t,\")) {\n-\t\t\t\t\t\t\tcriterionList.add(propertyLike(\"pn.givenName\", token));\n-\t\t\t\t\t\t\tcriterionList.add(propertyLike(\"pn.middleName\", token));\n-\t\t\t\t\t\t\tcriterionList.add(propertyLike(\"pn.familyName\", token));\n-\t\t\t\t\t\t}\n-\t\t\t\t\t\t\n-\t\t\t\t\t\tcriteria.add(or(toCriteriaArray(criterionList)));\n-\t\t\t\t\t\tbreak;\n-\t\t\t\t\tcase \"\":\n-\t\t\t\t\t\tcriteria.add(eq(\"ep.uuid\", participantReference.getValue()));\n-\t\t\t\t\t\tbreak;\n-\t\t\t\t}\n-\t\t\t}\n-\t\t}\n-\t}\n-\t\n-\tprotected void handleSubjectReference(Criteria criteria, ReferenceParam subjectReference) {\n-\t\tif (subjectReference != null) {\n-\t\t\tcriteria.createAlias(\"patient\", \"p\");\n-\t\t\t\n-\t\t\tif (subjectReference.getChain() != null) {\n-\t\t\t\tswitch (subjectReference.getChain()) {\n-\t\t\t\t\tcase Patient.SP_IDENTIFIER:\n-\t\t\t\t\t\tcriteria.createAlias(\"p.identifiers\", \"pi\").add(ilike(\"pi.identifier\", subjectReference.getValue()));\n-\t\t\t\t\t\tbreak;\n-\t\t\t\t\tcase Patient.SP_GIVEN:\n-\t\t\t\t\t\tcriteria.createAlias(\"p.names\", \"pn\")\n-\t\t\t\t\t\t        .add(ilike(\"pn.givenName\", subjectReference.getValue(), MatchMode.START));\n-\t\t\t\t\t\tbreak;\n-\t\t\t\t\tcase Patient.SP_FAMILY:\n-\t\t\t\t\t\tcriteria.createAlias(\"p.names\", \"pn\")\n-\t\t\t\t\t\t        .add(ilike(\"pn.familyName\", subjectReference.getValue(), MatchMode.START));\n-\t\t\t\t\t\tbreak;\n-\t\t\t\t\tcase Patient.SP_NAME:\n-\t\t\t\t\t\tcriteria.createAlias(\"p.names\", \"pn\");\n-\t\t\t\t\t\t\n-\t\t\t\t\t\tList<Optional<Criterion>> criterionList = new ArrayList<>();\n-\t\t\t\t\t\t\n-\t\t\t\t\t\tfor (String token : StringUtils.split(subjectReference.getValue(), \" \\t,\")) {\n-\t\t\t\t\t\t\tcriterionList.add(propertyLike(\"pn.givenName\", token));\n-\t\t\t\t\t\t\tcriterionList.add(propertyLike(\"pn.middleName\", token));\n-\t\t\t\t\t\t\tcriterionList.add(propertyLike(\"pn.familyName\", token));\n-\t\t\t\t\t\t}\n-\t\t\t\t\t\t\n-\t\t\t\t\t\tcriteria.add(or(toCriteriaArray(criterionList)));\n-\t\t\t\t\t\tbreak;\n-\t\t\t\t\tcase \"\":\n-\t\t\t\t\t\tcriteria.add(eq(\"p.uuid\", subjectReference.getValue()));\n-\t\t\t\t\t\tbreak;\n-\t\t\t\t}\n-\t\t\t}\n-\t\t}\n-\t}\n-\t\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzg3NjY2OQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/86#discussion_r383876669", "bodyText": "I think you've already done this!", "author": "ibacher", "createdAt": "2020-02-25T13:27:50Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirEncounterDaoImpl.java", "diffHunk": "@@ -38,10 +52,119 @@ public Encounter getEncounterByUuid(String uuid) {\n \t}\n \t\n \t@Override\n-\t@SuppressWarnings(\"unchecked\")\n-\tpublic List<Encounter> findEncountersByPatientIdentifier(String patientIdentifier) {\n-\t\treturn (List<Encounter>) sessionFactory.getCurrentSession().createCriteria(Encounter.class)\n-\t\t        .createAlias(\"patient\", \"p\").createAlias(\"p.identifiers\", \"pi\").add(eq(\"pi.identifier\", patientIdentifier))\n-\t\t        .list();\n+\tpublic Collection<Encounter> searchForEncounters(DateRangeParam date, ReferenceParam location,\n+\t        ReferenceParam participant, ReferenceParam subject) {\n+\t\t\n+\t\tCriteria criteria = sessionFactory.getCurrentSession().createCriteria(Encounter.class);\n+\t\thandleDateRange(\"encounterDatetime\", date).ifPresent(criteria::add);\n+\t\thandleLocationReference(criteria, location);\n+\t\thandleParticipantReference(criteria, participant);\n+\t\thandleSubjectReference(criteria, subject);\n+\t\t//TODO: handle ReferenceParam for participant, subject, location", "originalCommit": "5308c2c1d204d1a8dba16d670594e583910b460e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDUzNTU2MQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/86#discussion_r384535561", "bodyText": "Remove this comment", "author": "ibacher", "createdAt": "2020-02-26T14:43:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzg3NjY2OQ=="}], "type": "inlineReview", "revised_code": {"commit": "59d2836e433bcc1f5dd99eeec420d6a0d3d5dd80", "chunk": "diff --git a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirEncounterDaoImpl.java b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirEncounterDaoImpl.java\nindex ee3703d6..31caf0d7 100644\n--- a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirEncounterDaoImpl.java\n+++ b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirEncounterDaoImpl.java\n\n@@ -59,112 +48,9 @@ public class FhirEncounterDaoImpl extends BaseDaoImpl implements FhirEncounterDa\n \t\thandleDateRange(\"encounterDatetime\", date).ifPresent(criteria::add);\n \t\thandleLocationReference(criteria, location);\n \t\thandleParticipantReference(criteria, participant);\n-\t\thandleSubjectReference(criteria, subject);\n+\t\thandlePatientReference(criteria, subject);\n \t\t//TODO: handle ReferenceParam for participant, subject, location\n \t\t\n \t\treturn criteria.list();\n \t}\n-\t\n-\tprivate void handleLocationReference(Criteria criteria, ReferenceParam locationReference) {\n-\t\tif (locationReference != null) {\n-\t\t\tcriteria.createAlias(\"location\", \"l\");\n-\t\t\t\n-\t\t\tif (locationReference.getChain() != null) {\n-\t\t\t\tswitch (locationReference.getChain()) {\n-\t\t\t\t\tcase Location.SP_ADDRESS_CITY:\n-\t\t\t\t\t\tcriteria.add(ilike(\"l.cityVillage\", locationReference.getValue(), MatchMode.START));\n-\t\t\t\t\t\tbreak;\n-\t\t\t\t\tcase Location.SP_ADDRESS_STATE:\n-\t\t\t\t\t\tcriteria.add(ilike(\"l.stateProvince\", locationReference.getValue(), MatchMode.START));\n-\t\t\t\t\t\tbreak;\n-\t\t\t\t\tcase Location.SP_ADDRESS_POSTALCODE:\n-\t\t\t\t\t\tcriteria.add(ilike(\"l.postalCode\", locationReference.getValue(), MatchMode.START));\n-\t\t\t\t\t\tbreak;\n-\t\t\t\t\tcase Location.SP_ADDRESS_COUNTRY:\n-\t\t\t\t\t\tcriteria.add(ilike(\"l.country\", locationReference.getValue(), MatchMode.START));\n-\t\t\t\t\t\tbreak;\n-\t\t\t\t\tcase \"\":\n-\t\t\t\t\t\tcriteria.add(eq(\"l.uuid\", locationReference.getValue()));\n-\t\t\t\t\t\tbreak;\n-\t\t\t\t}\n-\t\t\t}\n-\t\t}\n-\t}\n-\t\n-\tprivate void handleParticipantReference(Criteria criteria, ReferenceParam participantReference) {\n-\t\tif (participantReference != null) {\n-\t\t\tcriteria.createAlias(\"encounterProviders\", \"ep\");\n-\t\t\t\n-\t\t\tif (participantReference.getChain() != null) {\n-\t\t\t\tswitch (participantReference.getChain()) {\n-\t\t\t\t\tcase Practitioner.SP_IDENTIFIER:\n-\t\t\t\t\t\tcriteria.createAlias(\"ep.provider\", \"p\").add(ilike(\"p.identifier\", participantReference.getValue()));\n-\t\t\t\t\t\tbreak;\n-\t\t\t\t\tcase Practitioner.SP_GIVEN:\n-\t\t\t\t\t\tcriteria.createAlias(\"ep.provider\", \"p\").createAlias(\"p.person\", \"ps\").createAlias(\"ps.names\", \"pn\")\n-\t\t\t\t\t\t        .add(ilike(\"pn.givenName\", participantReference.getValue(), MatchMode.START));\n-\t\t\t\t\t\tbreak;\n-\t\t\t\t\tcase Practitioner.SP_FAMILY:\n-\t\t\t\t\t\tcriteria.createAlias(\"ep.provider\", \"p\").createAlias(\"p.person\", \"ps\").createAlias(\"ps.names\", \"pn\")\n-\t\t\t\t\t\t        .add(ilike(\"pn.familyName\", participantReference.getValue(), MatchMode.START));\n-\t\t\t\t\t\tbreak;\n-\t\t\t\t\tcase Practitioner.SP_NAME:\n-\t\t\t\t\t\tcriteria.createAlias(\"ep.provider\", \"p\").createAlias(\"p.person\", \"ps\").createAlias(\"ps.names\", \"pn\");\n-\t\t\t\t\t\t\n-\t\t\t\t\t\tList<Optional<Criterion>> criterionList = new ArrayList<>();\n-\t\t\t\t\t\t\n-\t\t\t\t\t\tfor (String token : StringUtils.split(participantReference.getValue(), \" \\t,\")) {\n-\t\t\t\t\t\t\tcriterionList.add(propertyLike(\"pn.givenName\", token));\n-\t\t\t\t\t\t\tcriterionList.add(propertyLike(\"pn.middleName\", token));\n-\t\t\t\t\t\t\tcriterionList.add(propertyLike(\"pn.familyName\", token));\n-\t\t\t\t\t\t}\n-\t\t\t\t\t\t\n-\t\t\t\t\t\tcriteria.add(or(toCriteriaArray(criterionList)));\n-\t\t\t\t\t\tbreak;\n-\t\t\t\t\tcase \"\":\n-\t\t\t\t\t\tcriteria.add(eq(\"ep.uuid\", participantReference.getValue()));\n-\t\t\t\t\t\tbreak;\n-\t\t\t\t}\n-\t\t\t}\n-\t\t}\n-\t}\n-\t\n-\tprotected void handleSubjectReference(Criteria criteria, ReferenceParam subjectReference) {\n-\t\tif (subjectReference != null) {\n-\t\t\tcriteria.createAlias(\"patient\", \"p\");\n-\t\t\t\n-\t\t\tif (subjectReference.getChain() != null) {\n-\t\t\t\tswitch (subjectReference.getChain()) {\n-\t\t\t\t\tcase Patient.SP_IDENTIFIER:\n-\t\t\t\t\t\tcriteria.createAlias(\"p.identifiers\", \"pi\").add(ilike(\"pi.identifier\", subjectReference.getValue()));\n-\t\t\t\t\t\tbreak;\n-\t\t\t\t\tcase Patient.SP_GIVEN:\n-\t\t\t\t\t\tcriteria.createAlias(\"p.names\", \"pn\")\n-\t\t\t\t\t\t        .add(ilike(\"pn.givenName\", subjectReference.getValue(), MatchMode.START));\n-\t\t\t\t\t\tbreak;\n-\t\t\t\t\tcase Patient.SP_FAMILY:\n-\t\t\t\t\t\tcriteria.createAlias(\"p.names\", \"pn\")\n-\t\t\t\t\t\t        .add(ilike(\"pn.familyName\", subjectReference.getValue(), MatchMode.START));\n-\t\t\t\t\t\tbreak;\n-\t\t\t\t\tcase Patient.SP_NAME:\n-\t\t\t\t\t\tcriteria.createAlias(\"p.names\", \"pn\");\n-\t\t\t\t\t\t\n-\t\t\t\t\t\tList<Optional<Criterion>> criterionList = new ArrayList<>();\n-\t\t\t\t\t\t\n-\t\t\t\t\t\tfor (String token : StringUtils.split(subjectReference.getValue(), \" \\t,\")) {\n-\t\t\t\t\t\t\tcriterionList.add(propertyLike(\"pn.givenName\", token));\n-\t\t\t\t\t\t\tcriterionList.add(propertyLike(\"pn.middleName\", token));\n-\t\t\t\t\t\t\tcriterionList.add(propertyLike(\"pn.familyName\", token));\n-\t\t\t\t\t\t}\n-\t\t\t\t\t\t\n-\t\t\t\t\t\tcriteria.add(or(toCriteriaArray(criterionList)));\n-\t\t\t\t\t\tbreak;\n-\t\t\t\t\tcase \"\":\n-\t\t\t\t\t\tcriteria.add(eq(\"p.uuid\", subjectReference.getValue()));\n-\t\t\t\t\t\tbreak;\n-\t\t\t\t}\n-\t\t\t}\n-\t\t}\n-\t}\n-\t\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzg3NzUwMA==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/86#discussion_r383877500", "bodyText": "What does this method actually test?", "author": "ibacher", "createdAt": "2020-02-25T13:29:28Z", "path": "api/src/test/java/org/openmrs/module/fhir2/api/impl/FhirEncounterServiceImplTest.java", "diffHunk": "@@ -70,16 +75,21 @@ public void shouldGetEncounterByUuid() {\n \t}\n \t\n \t@Test\n-\tpublic void findEncountersByPatientIdentifier_shouldReturnCollectionOfEncounters() {\n-\t\twhen(dao.findEncountersByPatientIdentifier(PATIENT_IDENTIFIER))\n-\t\t        .thenReturn(Collections.singletonList(openMrsEncounter));\n-\t\twhen(encounterTranslator.toFhirResource(openMrsEncounter)).thenReturn(fhirEncounter);\n+\tpublic void searchForEncounter_shouldSearchForEncounterBySubjectName() {", "originalCommit": "5308c2c1d204d1a8dba16d670594e583910b460e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "59d2836e433bcc1f5dd99eeec420d6a0d3d5dd80", "chunk": "diff --git a/api/src/test/java/org/openmrs/module/fhir2/api/impl/FhirEncounterServiceImplTest.java b/api/src/test/java/org/openmrs/module/fhir2/api/impl/FhirEncounterServiceImplTest.java\nindex 4954002d..5531af36 100644\n--- a/api/src/test/java/org/openmrs/module/fhir2/api/impl/FhirEncounterServiceImplTest.java\n+++ b/api/src/test/java/org/openmrs/module/fhir2/api/impl/FhirEncounterServiceImplTest.java\n\n@@ -75,21 +104,84 @@ public class FhirEncounterServiceImplTest {\n \t}\n \t\n \t@Test\n-\tpublic void searchForEncounter_shouldSearchForEncounterBySubjectName() {\n+\tpublic void searchForEncounter_shouldReturnCollectionOfEncounterByDate() {\n+\t\tCollection<Encounter> encounters = new ArrayList<>();\n+\t\tDateRangeParam dateRangeParam = new DateRangeParam(new DateParam(ENCOUNTER_DATETIME));\n+\t\t\n+\t\tencounters.add(openMrsEncounter);\n+\t\t\n+\t\tfhirEncounter.setId(ENCOUNTER_UUID);\n+\t\twhen(dao.searchForEncounters(argThat(is(dateRangeParam)), any(), any(), any())).thenReturn(encounters);\n+\t\twhen(encounterTranslator.toFhirResource(openMrsEncounter)).thenReturn(fhirEncounter);\n+\t\t\n+\t\tCollection<org.hl7.fhir.r4.model.Encounter> results = encounterService.searchForEncounters(dateRangeParam, null,\n+\t\t    null, null);\n+\t\t\n+\t\tassertThat(results, Matchers.notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.iterator().next().getId(), equalTo(ENCOUNTER_UUID));\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForEncounter_shouldReturnCollectionOfEncounterByLocation() {\n+\t\tCollection<Encounter> encounters = new ArrayList<>();\n+\t\tReferenceParam location = new ReferenceParam();\n+\t\tlocation.setValue(ENCOUNTER_ADDRESS_STATE);\n+\t\tlocation.setChain(Location.SP_ADDRESS_CITY);\n+\t\t\n+\t\tencounters.add(openMrsEncounter);\n+\t\t\n+\t\tfhirEncounter.setId(ENCOUNTER_UUID);\n+\t\twhen(dao.searchForEncounters(any(), argThat(is(location)), any(), any())).thenReturn(encounters);\n+\t\twhen(encounterTranslator.toFhirResource(openMrsEncounter)).thenReturn(fhirEncounter);\n+\t\t\n+\t\tCollection<org.hl7.fhir.r4.model.Encounter> results = encounterService.searchForEncounters(null, location, null,\n+\t\t    null);\n+\t\t\n+\t\tassertThat(results, Matchers.notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.size(), greaterThanOrEqualTo(1));\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForEncounter_shouldReturnCollectionOfEncounterByParticipant() {\n \t\tCollection<Encounter> encounters = new ArrayList<>();\n-\t\tEncounter encounter = new Encounter();\n-\t\tencounter.setUuid(ENCOUNTER_UUID);\n-\t\tencounters.add(encounter);\n+\t\tReferenceParam participant = new ReferenceParam();\n+\t\tparticipant.setValue(PARTICIPANT_IDENTIFIER);\n+\t\tparticipant.setChain(Practitioner.SP_IDENTIFIER);\n \t\t\n-\t\torg.hl7.fhir.r4.model.Encounter enc = new org.hl7.fhir.r4.model.Encounter();\n-\t\tenc.setId(ENCOUNTER_UUID);\n-\t\twhen(dao.searchForEncounters(any(), any(), any(), any())).thenReturn(encounters);\n-\t\twhen(encounterTranslator.toFhirResource(encounter)).thenReturn(enc);\n+\t\tencounters.add(openMrsEncounter);\n+\t\t\n+\t\tfhirEncounter.setId(ENCOUNTER_UUID);\n+\t\twhen(dao.searchForEncounters(any(), any(), argThat(is(participant)), any())).thenReturn(encounters);\n+\t\twhen(encounterTranslator.toFhirResource(openMrsEncounter)).thenReturn(fhirEncounter);\n+\t\t\n+\t\tCollection<org.hl7.fhir.r4.model.Encounter> results = encounterService.searchForEncounters(null, null, participant,\n+\t\t    null);\n+\t\t\n+\t\tassertThat(results, Matchers.notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.size(), greaterThanOrEqualTo(1));\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForEncounter_shouldReturnCollectionOfEncounterBySubject() {\n+\t\tCollection<Encounter> encounters = new ArrayList<>();\n+\t\tReferenceParam subject = new ReferenceParam();\n+\t\tsubject.setValue(PATIENT_FAMILY_NAME);\n+\t\tsubject.setChain(Patient.SP_FAMILY);\n+\t\t\n+\t\tencounters.add(openMrsEncounter);\n+\t\t\n+\t\tfhirEncounter.setId(ENCOUNTER_UUID);\n+\t\twhen(dao.searchForEncounters(any(), any(), any(), argThat(is(subject)))).thenReturn(encounters);\n+\t\twhen(encounterTranslator.toFhirResource(openMrsEncounter)).thenReturn(fhirEncounter);\n \t\t\n-\t\tCollection<org.hl7.fhir.r4.model.Encounter> results = encounterService.searchForEncounters(null, null, null, null);\n+\t\tCollection<org.hl7.fhir.r4.model.Encounter> results = encounterService.searchForEncounters(null, null, null,\n+\t\t    subject);\n \t\t\n \t\tassertThat(results, Matchers.notNullValue());\n \t\tassertThat(results, not(empty()));\n-\t\tassertThat(results, hasItem(hasProperty(\"id\", Matchers.equalTo(ENCOUNTER_UUID))));\n+\t\tassertThat(results.size(), greaterThanOrEqualTo(1));\n \t}\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzg3NzgyMw==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/86#discussion_r383877823", "bodyText": "Should this property still be referring to Patient?", "author": "ibacher", "createdAt": "2020-02-25T13:30:10Z", "path": "omod/src/main/java/org/openmrs/module/fhir2/providers/EncounterFhirResourceProvider.java", "diffHunk": "@@ -54,9 +56,16 @@ public Encounter getEncounterByUuid(@IdParam @NotNull IdType id) {\n \t}\n \t\n \t@Search\n-\tpublic Bundle findEncountersByPatientIdentifier(@RequiredParam(name = Encounter.SP_PATIENT, chainWhitelist = {\n-\t        Patient.SP_IDENTIFIER }) ReferenceParam identifier) {\n-\t\treturn FhirUtils\n-\t\t        .convertSearchResultsToBundle(encounterService.findEncountersByPatientIdentifier(identifier.getIdPart()));\n+\t@SuppressWarnings(\"unused\")\n+\tpublic Bundle searchEncounter(@OperationParam(name = Encounter.SP_DATE) DateRangeParam date,\n+\t        @OperationParam(name = Encounter.SP_LOCATION) ReferenceParam location,\n+\t        @OptionalParam(name = Encounter.SP_PARTICIPANT, chainWhitelist = { \"\", Patient.SP_IDENTIFIER, Patient.SP_GIVEN,", "originalCommit": "5308c2c1d204d1a8dba16d670594e583910b460e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "59d2836e433bcc1f5dd99eeec420d6a0d3d5dd80", "chunk": "diff --git a/omod/src/main/java/org/openmrs/module/fhir2/providers/EncounterFhirResourceProvider.java b/omod/src/main/java/org/openmrs/module/fhir2/providers/EncounterFhirResourceProvider.java\nindex 0e40ad60..daa4db73 100644\n--- a/omod/src/main/java/org/openmrs/module/fhir2/providers/EncounterFhirResourceProvider.java\n+++ b/omod/src/main/java/org/openmrs/module/fhir2/providers/EncounterFhirResourceProvider.java\n\n@@ -56,11 +57,13 @@ public class EncounterFhirResourceProvider implements IResourceProvider {\n \t}\n \t\n \t@Search\n-\t@SuppressWarnings(\"unused\")\n-\tpublic Bundle searchEncounter(@OperationParam(name = Encounter.SP_DATE) DateRangeParam date,\n-\t        @OperationParam(name = Encounter.SP_LOCATION) ReferenceParam location,\n-\t        @OptionalParam(name = Encounter.SP_PARTICIPANT, chainWhitelist = { \"\", Patient.SP_IDENTIFIER, Patient.SP_GIVEN,\n-\t                Patient.SP_FAMILY, Patient.SP_NAME }, targetTypes = Patient.class) ReferenceParam participantReference,\n+\tpublic Bundle searchEncounter(@OptionalParam(name = Encounter.SP_DATE) DateRangeParam date,\n+\t        @OptionalParam(name = Encounter.SP_LOCATION, chainWhitelist = { \"\", Location.SP_ADDRESS_CITY,\n+\t                Location.SP_ADDRESS_STATE, Location.SP_ADDRESS_COUNTRY,\n+\t                Location.SP_ADDRESS_POSTALCODE }, targetTypes = Location.class) ReferenceParam location,\n+\t        @OptionalParam(name = Encounter.SP_PARTICIPANT, chainWhitelist = { \"\", Practitioner.SP_IDENTIFIER,\n+\t                Practitioner.SP_GIVEN, Practitioner.SP_FAMILY,\n+\t                Practitioner.SP_NAME }, targetTypes = Practitioner.class) ReferenceParam participantReference,\n \t        @OptionalParam(name = Encounter.SP_SUBJECT, chainWhitelist = { \"\", Patient.SP_IDENTIFIER, Patient.SP_GIVEN,\n \t                Patient.SP_FAMILY, Patient.SP_NAME }, targetTypes = Patient.class) ReferenceParam subjectReference) {\n \t\treturn FhirUtils.convertSearchResultsToBundle(\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzg3Nzk5OQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/86#discussion_r383877999", "bodyText": "Will this support sub-properties of location?", "author": "ibacher", "createdAt": "2020-02-25T13:30:28Z", "path": "omod/src/main/java/org/openmrs/module/fhir2/providers/EncounterFhirResourceProvider.java", "diffHunk": "@@ -54,9 +56,16 @@ public Encounter getEncounterByUuid(@IdParam @NotNull IdType id) {\n \t}\n \t\n \t@Search\n-\tpublic Bundle findEncountersByPatientIdentifier(@RequiredParam(name = Encounter.SP_PATIENT, chainWhitelist = {\n-\t        Patient.SP_IDENTIFIER }) ReferenceParam identifier) {\n-\t\treturn FhirUtils\n-\t\t        .convertSearchResultsToBundle(encounterService.findEncountersByPatientIdentifier(identifier.getIdPart()));\n+\t@SuppressWarnings(\"unused\")\n+\tpublic Bundle searchEncounter(@OperationParam(name = Encounter.SP_DATE) DateRangeParam date,\n+\t        @OperationParam(name = Encounter.SP_LOCATION) ReferenceParam location,", "originalCommit": "5308c2c1d204d1a8dba16d670594e583910b460e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "59d2836e433bcc1f5dd99eeec420d6a0d3d5dd80", "chunk": "diff --git a/omod/src/main/java/org/openmrs/module/fhir2/providers/EncounterFhirResourceProvider.java b/omod/src/main/java/org/openmrs/module/fhir2/providers/EncounterFhirResourceProvider.java\nindex 0e40ad60..daa4db73 100644\n--- a/omod/src/main/java/org/openmrs/module/fhir2/providers/EncounterFhirResourceProvider.java\n+++ b/omod/src/main/java/org/openmrs/module/fhir2/providers/EncounterFhirResourceProvider.java\n\n@@ -56,11 +57,13 @@ public class EncounterFhirResourceProvider implements IResourceProvider {\n \t}\n \t\n \t@Search\n-\t@SuppressWarnings(\"unused\")\n-\tpublic Bundle searchEncounter(@OperationParam(name = Encounter.SP_DATE) DateRangeParam date,\n-\t        @OperationParam(name = Encounter.SP_LOCATION) ReferenceParam location,\n-\t        @OptionalParam(name = Encounter.SP_PARTICIPANT, chainWhitelist = { \"\", Patient.SP_IDENTIFIER, Patient.SP_GIVEN,\n-\t                Patient.SP_FAMILY, Patient.SP_NAME }, targetTypes = Patient.class) ReferenceParam participantReference,\n+\tpublic Bundle searchEncounter(@OptionalParam(name = Encounter.SP_DATE) DateRangeParam date,\n+\t        @OptionalParam(name = Encounter.SP_LOCATION, chainWhitelist = { \"\", Location.SP_ADDRESS_CITY,\n+\t                Location.SP_ADDRESS_STATE, Location.SP_ADDRESS_COUNTRY,\n+\t                Location.SP_ADDRESS_POSTALCODE }, targetTypes = Location.class) ReferenceParam location,\n+\t        @OptionalParam(name = Encounter.SP_PARTICIPANT, chainWhitelist = { \"\", Practitioner.SP_IDENTIFIER,\n+\t                Practitioner.SP_GIVEN, Practitioner.SP_FAMILY,\n+\t                Practitioner.SP_NAME }, targetTypes = Practitioner.class) ReferenceParam participantReference,\n \t        @OptionalParam(name = Encounter.SP_SUBJECT, chainWhitelist = { \"\", Patient.SP_IDENTIFIER, Patient.SP_GIVEN,\n \t                Patient.SP_FAMILY, Patient.SP_NAME }, targetTypes = Patient.class) ReferenceParam subjectReference) {\n \t\treturn FhirUtils.convertSearchResultsToBundle(\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzg3ODMwMg==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/86#discussion_r383878302", "bodyText": "Don't forget to re-add similar tests", "author": "ibacher", "createdAt": "2020-02-25T13:30:57Z", "path": "omod/src/test/java/org/openmrs/module/fhir2/providers/EncounterFhirResourceProviderTest.java", "diffHunk": "@@ -85,24 +79,4 @@ public void getEncounterWithWrongUuid_shouldThrowResourceNotFoundException() {\n \t\tEncounter result = resourceProvider.getEncounterByUuid(id);\n \t\tassertThat(result, nullValue());\n \t}\n-\t\n-\t@Test\n-\tpublic void findEncountersByPatientIdentifier_shouldReturnMatchingBundleOfEncounters() {", "originalCommit": "5308c2c1d204d1a8dba16d670594e583910b460e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "59d2836e433bcc1f5dd99eeec420d6a0d3d5dd80", "chunk": "diff --git a/omod/src/test/java/org/openmrs/module/fhir2/providers/EncounterFhirResourceProviderTest.java b/omod/src/test/java/org/openmrs/module/fhir2/providers/EncounterFhirResourceProviderTest.java\nindex 69e55cb9..2e6eeeee 100644\n--- a/omod/src/test/java/org/openmrs/module/fhir2/providers/EncounterFhirResourceProviderTest.java\n+++ b/omod/src/test/java/org/openmrs/module/fhir2/providers/EncounterFhirResourceProviderTest.java\n\n@@ -79,4 +86,24 @@ public class EncounterFhirResourceProviderTest {\n \t\tEncounter result = resourceProvider.getEncounterByUuid(id);\n \t\tassertThat(result, nullValue());\n \t}\n+\t\n+\t@Test\n+\tpublic void searchEncounters_shouldReturnMatchingEncounters() {\n+\t\tList<Encounter> encounters = new ArrayList<>();\n+\t\tencounters.add(encounter);\n+\t\twhen(encounterService.searchForEncounters(any(), any(), any(), any())).thenReturn(encounters);\n+\t\tReferenceParam subjectreference = new ReferenceParam();\n+\t\tsubjectreference.setChain(Patient.SP_NAME);\n+\t\t\n+\t\torg.hl7.fhir.r4.model.Encounter enc = new org.hl7.fhir.r4.model.Encounter();\n+\t\tenc.setId(ENCOUNTER_UUID);\n+\t\t\n+\t\tBundle results = resourceProvider.searchEncounter(null, null, null, subjectreference);\n+\t\t\n+\t\tassertThat(results, notNullValue());\n+\t\tassertThat(results.getTotal(), equalTo(1));\n+\t\tassertThat(results.getEntry(), notNullValue());\n+\t\tassertThat(results.getEntry().get(0).getResource().fhirType(), equalTo(\"Encounter\"));\n+\t\tassertThat(results.getEntry().get(0).getResource().getId(), equalTo(ENCOUNTER_UUID));\n+\t}\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzg3ODQ4OA==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/86#discussion_r383878488", "bodyText": "This test should not be removed.", "author": "ibacher", "createdAt": "2020-02-25T13:31:16Z", "path": "omod/src/test/java/org/openmrs/module/fhir2/providers/EncounterFhirResourceProviderWebTest.java", "diffHunk": "@@ -81,32 +72,4 @@ public void getEncounterByWrongUuid_shouldReturn404() throws Exception {\n \t\tassertThat(response, isNotFound());\n \t}\n \t\n-\t@Test\n-\tpublic void findEncountersByPatientIdentifier_shouldReturnBundleOfEncounters() throws IOException, ServletException {", "originalCommit": "5308c2c1d204d1a8dba16d670594e583910b460e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "59d2836e433bcc1f5dd99eeec420d6a0d3d5dd80", "chunk": "diff --git a/omod/src/test/java/org/openmrs/module/fhir2/providers/EncounterFhirResourceProviderWebTest.java b/omod/src/test/java/org/openmrs/module/fhir2/providers/EncounterFhirResourceProviderWebTest.java\nindex b3053d9e..071de6be 100644\n--- a/omod/src/test/java/org/openmrs/module/fhir2/providers/EncounterFhirResourceProviderWebTest.java\n+++ b/omod/src/test/java/org/openmrs/module/fhir2/providers/EncounterFhirResourceProviderWebTest.java\n\n@@ -72,4 +124,146 @@ public class EncounterFhirResourceProviderWebTest extends BaseFhirResourceProvid\n \t\tassertThat(response, isNotFound());\n \t}\n \t\n+\t@Test\n+\tpublic void shouldGetObservationsBySubjectUuid() throws Exception {\n+\t\tverifyUri(String.format(\"/Encounter?subject:Patient=%s\", PATIENT_UUID));\n+\t\t\n+\t\tverify(encounterService).searchForEncounters(isNull(), isNull(), isNull(), subjectCaptor.capture());\n+\t\tassertThat(subjectCaptor.getValue(), notNullValue());\n+\t\tassertThat(subjectCaptor.getValue().getIdPart(), equalTo(PATIENT_UUID));\n+\t}\n+\t\n+\t@Test\n+\tpublic void shouldGetObservationsByDate() throws Exception {\n+\t\tverifyUri(\"/Encounter/?date=ge1975-02-02\");\n+\t\t\n+\t\tverify(encounterService).searchForEncounters(dateRangeCaptor.capture(), isNull(), isNull(), isNull());\n+\t\tassertThat(dateRangeCaptor.getValue(), notNullValue());\n+\t\t\n+\t\tCalendar calendar = Calendar.getInstance();\n+\t\tcalendar.set(1975, 1, 2);\n+\t\t\n+\t\tassertThat(dateRangeCaptor.getValue().getLowerBound().getValue(),\n+\t\t    equalTo(DateUtils.truncate(calendar.getTime(), Calendar.DATE)));\n+\t\tassertThat(dateRangeCaptor.getValue().getUpperBound(), nullValue());\n+\t}\n+\t\n+\t@Test\n+\tpublic void shouldGetObservationsByLocationCityVillage() throws Exception {\n+\t\tverifyUri(String.format(\"/Encounter/?location.address-city=%s\", ENCOUNTER_ADDRESS_CITY));\n+\t\t\n+\t\tverify(encounterService).searchForEncounters(isNull(), locationCaptor.capture(), isNull(), isNull());\n+\t\tassertThat(locationCaptor.getValue(), notNullValue());\n+\t\tassertThat(locationCaptor.getValue().getChain(), equalTo(\"address-city\"));\n+\t\tassertThat(locationCaptor.getValue().getValue(), equalTo(ENCOUNTER_ADDRESS_CITY));\n+\t}\n+\t\n+\t@Test\n+\tpublic void shouldGetObservationsByLocationState() throws Exception {\n+\t\tverifyUri(String.format(\"/Encounter/?location.address-state=%s\", ENCOUNTER_ADDRESS_STATE));\n+\t\t\n+\t\tverify(encounterService).searchForEncounters(isNull(), locationCaptor.capture(), isNull(), isNull());\n+\t\tassertThat(locationCaptor.getValue(), notNullValue());\n+\t\tassertThat(locationCaptor.getValue().getChain(), equalTo(\"address-state\"));\n+\t\tassertThat(locationCaptor.getValue().getValue(), equalTo(ENCOUNTER_ADDRESS_STATE));\n+\t}\n+\t\n+\t@Test\n+\tpublic void shouldGetObservationsByLocationPostalCode() throws Exception {\n+\t\tverifyUri(String.format(\"/Encounter/?location.address-postalcode=%s\", ENCOUNTER_POSTALCODE));\n+\t\t\n+\t\tverify(encounterService).searchForEncounters(isNull(), locationCaptor.capture(), isNull(), isNull());\n+\t\tassertThat(locationCaptor.getValue(), notNullValue());\n+\t\tassertThat(locationCaptor.getValue().getChain(), equalTo(\"address-postalcode\"));\n+\t\tassertThat(locationCaptor.getValue().getValue(), equalTo(ENCOUNTER_POSTALCODE));\n+\t}\n+\t\n+\t@Test\n+\tpublic void shouldGetObservationsByLocationCountry() throws Exception {\n+\t\tverifyUri(String.format(\"/Encounter/?location.address-country=%s\", ENCOUNTER_ADDRESS_COUNTRY));\n+\t\t\n+\t\tverify(encounterService).searchForEncounters(isNull(), locationCaptor.capture(), isNull(), isNull());\n+\t\tassertThat(locationCaptor.getValue(), notNullValue());\n+\t\tassertThat(locationCaptor.getValue().getChain(), equalTo(\"address-country\"));\n+\t\tassertThat(locationCaptor.getValue().getValue(), equalTo(ENCOUNTER_ADDRESS_COUNTRY));\n+\t}\n+\t\n+\t@Test\n+\tpublic void shouldGetObservationsByParticipantGivenName() throws Exception {\n+\t\tverifyUri(String.format(\"/Encounter/?participant:Practitioner.given=%s\", PATIENT_GIVEN_NAME));\n+\t\t\n+\t\tverify(encounterService).searchForEncounters(isNull(), isNull(), participantCaptor.capture(), isNull());\n+\t\tassertThat(participantCaptor.getValue(), notNullValue());\n+\t\tassertThat(participantCaptor.getValue().getChain(), equalTo(\"given\"));\n+\t\tassertThat(participantCaptor.getValue().getValue(), equalTo(PATIENT_GIVEN_NAME));\n+\t}\n+\t\n+\t@Test\n+\tpublic void shouldGetObservationsByParticipantFamilyName() throws Exception {\n+\t\tverifyUri(String.format(\"/Encounter/?participant:Practitioner.family=%s\", PATIENT_FAMILY_NAME));\n+\t\t\n+\t\tverify(encounterService).searchForEncounters(isNull(), isNull(), participantCaptor.capture(), isNull());\n+\t\tassertThat(participantCaptor.getValue(), notNullValue());\n+\t\tassertThat(participantCaptor.getValue().getChain(), equalTo(\"family\"));\n+\t\tassertThat(participantCaptor.getValue().getValue(), equalTo(PATIENT_FAMILY_NAME));\n+\t}\n+\t\n+\t@Test\n+\tpublic void shouldGetObservationsByParticipantIdentifier() throws Exception {\n+\t\tverifyUri(String.format(\"/Encounter/?participant:Practitioner.identifier=%s\", PATIENT_IDENTIFIER));\n+\t\t\n+\t\tverify(encounterService).searchForEncounters(isNull(), isNull(), participantCaptor.capture(), isNull());\n+\t\tassertThat(participantCaptor.getValue(), notNullValue());\n+\t\tassertThat(participantCaptor.getValue().getChain(), equalTo(\"identifier\"));\n+\t\tassertThat(participantCaptor.getValue().getValue(), equalTo(PATIENT_IDENTIFIER));\n+\t}\n+\t\n+\t@Test\n+\tpublic void shouldGetObservationsBySubjectGivenName() throws Exception {\n+\t\tverifyUri(String.format(\"/Encounter/?subject.given=%s\", PATIENT_GIVEN_NAME));\n+\t\t\n+\t\tverify(encounterService).searchForEncounters(isNull(), isNull(), isNull(), subjectCaptor.capture());\n+\t\tassertThat(subjectCaptor.getValue(), notNullValue());\n+\t\tassertThat(subjectCaptor.getValue().getChain(), equalTo(\"given\"));\n+\t\tassertThat(subjectCaptor.getValue().getValue(), equalTo(PATIENT_GIVEN_NAME));\n+\t}\n+\t\n+\t@Test\n+\tpublic void shouldGetObservationsBySubjectFamilyName() throws Exception {\n+\t\tverifyUri(String.format(\"/Encounter?subject.family=%s\", PATIENT_FAMILY_NAME));\n+\t\t\n+\t\tverify(encounterService).searchForEncounters(isNull(), isNull(), isNull(), subjectCaptor.capture());\n+\t\tassertThat(subjectCaptor.getValue(), notNullValue());\n+\t\tassertThat(subjectCaptor.getValue().getChain(), equalTo(\"family\"));\n+\t\tassertThat(subjectCaptor.getValue().getValue(), equalTo(PATIENT_FAMILY_NAME));\n+\t}\n+\t\n+\t@Test\n+\tpublic void shouldGetObservationsBySubjectIdentifier() throws Exception {\n+\t\tverifyUri(String.format(\"/Encounter?subject.identifier=%s\", PATIENT_IDENTIFIER));\n+\t\t\n+\t\tverify(encounterService).searchForEncounters(isNull(), isNull(), isNull(), subjectCaptor.capture());\n+\t\tassertThat(subjectCaptor.getValue(), notNullValue());\n+\t\tassertThat(subjectCaptor.getValue().getChain(), equalTo(\"identifier\"));\n+\t\tassertThat(subjectCaptor.getValue().getValue(), equalTo(PATIENT_IDENTIFIER));\n+\t}\n+\t\n+\tprivate void verifyUri(String uri) throws Exception {\n+\t\tEncounter encounter = new Encounter();\n+\t\tencounter.setId(ENCOUNTER_UUID);\n+\t\twhen(encounterService.searchForEncounters(any(), any(), any(), any()))\n+\t\t        .thenReturn(Collections.singletonList(encounter));\n+\t\t\n+\t\tMockHttpServletResponse response = get(uri).accept(FhirMediaTypes.JSON).go();\n+\t\t\n+\t\tassertThat(response, isOk());\n+\t\tassertThat(response.getContentType(), equalTo(FhirMediaTypes.JSON.toString()));\n+\t\t\n+\t\tBundle results = readBundleResponse(response);\n+\t\tassertThat(results.getEntry(), notNullValue());\n+\t\tassertThat(results.getEntry(), not(empty()));\n+\t\tassertThat(results.getEntry().get(0).getResource(), notNullValue());\n+\t\tassertThat(results.getEntry().get(0).getResource().getIdElement().getIdPart(), equalTo(ENCOUNTER_UUID));\n+\t}\n+\t\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA4OTcxMg==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/86#discussion_r384089712", "bodyText": "I appreciate the initiative, but unless these are directly necessary for the encounter stuff, don't modify these tests here. I've got another ticket to deal with that.", "author": "ibacher", "createdAt": "2020-02-25T19:51:35Z", "path": "api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirObservationDaoImplTest.java", "diffHunk": "@@ -220,8 +220,8 @@ public void searchForObs_shouldSupportMappedAndUnmappedConcepts() {\n \t@Test", "originalCommit": "128058fa8e53dd1a8fab6fb772adda45e288dfe6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDUzNzE4NQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/86#discussion_r384537185", "bodyText": "Can we actually remove this file from the PR?", "author": "ibacher", "createdAt": "2020-02-26T14:45:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA4OTcxMg=="}], "type": "inlineReview", "revised_code": {"commit": "59d2836e433bcc1f5dd99eeec420d6a0d3d5dd80", "chunk": "diff --git a/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirObservationDaoImplTest.java b/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirObservationDaoImplTest.java\nindex ef42404d..3f522d6f 100644\n--- a/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirObservationDaoImplTest.java\n+++ b/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirObservationDaoImplTest.java\n\n@@ -220,8 +220,8 @@ public class FhirObservationDaoImplTest extends BaseModuleContextSensitiveTest {\n \t@Test\n \tpublic void searchForObs_shouldReturnObsByPatientUuid() {\n \t\tReferenceParam patientReference = new ReferenceParam();\n-\t\tpatientReference.setValue(PATIENT_UUID);\n \t\tpatientReference.setChain(\"\");\n+\t\tpatientReference.setValue(PATIENT_UUID);\n \t\t\n \t\tCollection<Obs> results = dao.searchForObservations(null, patientReference, null, null);\n \t\t\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDE1NTc4OQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/86#discussion_r384155789", "bodyText": "I know that this is wrong will revert this in the next commit", "author": "VaishSiddharth", "createdAt": "2020-02-25T22:07:09Z", "path": "omod/src/main/java/org/openmrs/module/fhir2/providers/EncounterFhirResourceProvider.java", "diffHunk": "@@ -58,12 +58,13 @@ public Encounter getEncounterByUuid(@IdParam @NotNull IdType id) {\n \t}\n \t\n \t@Search\n-\tpublic Bundle searchEncounter(@OperationParam(name = Encounter.SP_DATE) DateRangeParam date,\n+\tpublic Bundle searchEncounter(@RequiredParam(name = Encounter.SP_DATE) DateRangeParam date,", "originalCommit": "1b39b0f5ed28df36936a181492a2c8789b2c72e9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "59d2836e433bcc1f5dd99eeec420d6a0d3d5dd80", "chunk": "diff --git a/omod/src/main/java/org/openmrs/module/fhir2/providers/EncounterFhirResourceProvider.java b/omod/src/main/java/org/openmrs/module/fhir2/providers/EncounterFhirResourceProvider.java\nindex 2884b653..daa4db73 100644\n--- a/omod/src/main/java/org/openmrs/module/fhir2/providers/EncounterFhirResourceProvider.java\n+++ b/omod/src/main/java/org/openmrs/module/fhir2/providers/EncounterFhirResourceProvider.java\n\n@@ -58,7 +57,7 @@ public class EncounterFhirResourceProvider implements IResourceProvider {\n \t}\n \t\n \t@Search\n-\tpublic Bundle searchEncounter(@RequiredParam(name = Encounter.SP_DATE) DateRangeParam date,\n+\tpublic Bundle searchEncounter(@OptionalParam(name = Encounter.SP_DATE) DateRangeParam date,\n \t        @OptionalParam(name = Encounter.SP_LOCATION, chainWhitelist = { \"\", Location.SP_ADDRESS_CITY,\n \t                Location.SP_ADDRESS_STATE, Location.SP_ADDRESS_COUNTRY,\n \t                Location.SP_ADDRESS_POSTALCODE }, targetTypes = Location.class) ReferenceParam location,\n"}}, {"oid": "59d2836e433bcc1f5dd99eeec420d6a0d3d5dd80", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/59d2836e433bcc1f5dd99eeec420d6a0d3d5dd80", "message": "FM2-79 Improve Search for Encounter", "committedDate": "2020-02-26T13:34:43Z", "type": "commit"}, {"oid": "59d2836e433bcc1f5dd99eeec420d6a0d3d5dd80", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/59d2836e433bcc1f5dd99eeec420d6a0d3d5dd80", "message": "FM2-79 Improve Search for Encounter", "committedDate": "2020-02-26T13:34:43Z", "type": "forcePushed"}, {"oid": "abfdde871aa48708a002414bac97c705dac8df9c", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/abfdde871aa48708a002414bac97c705dac8df9c", "message": "Merge branch 'master' into FM2-79", "committedDate": "2020-02-26T14:03:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDUzNTQyOA==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/86#discussion_r384535428", "bodyText": "Can we simplify the ilike() construction to just propertyLike(\"l.cityVillage\", locationReference.getValue())?", "author": "ibacher", "createdAt": "2020-02-26T14:42:55Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/BaseDaoImpl.java", "diffHunk": "@@ -440,6 +442,73 @@ protected boolean containsAlias(Iterator<CriteriaImpl.Subcriteria> subcriteriaIt\n \t\t});\n \t}\n \t\n+\tprotected void handleLocationReference(Criteria criteria, ReferenceParam locationReference) {\n+\t\tif (locationReference != null) {\n+\t\t\tcriteria.createAlias(\"location\", \"l\");\n+\t\t\t\n+\t\t\tif (locationReference.getChain() != null) {\n+\t\t\t\tswitch (locationReference.getChain()) {\n+\t\t\t\t\tcase Location.SP_ADDRESS_CITY:\n+\t\t\t\t\t\tcriteria.add(ilike(\"l.cityVillage\", locationReference.getValue(), MatchMode.START));", "originalCommit": "abfdde871aa48708a002414bac97c705dac8df9c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9e7618c7ea7dc002a5338ac49792b88f95b60c29", "chunk": "diff --git a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/BaseDaoImpl.java b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/BaseDaoImpl.java\nindex 86ba24d7..7b4f31a4 100644\n--- a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/BaseDaoImpl.java\n+++ b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/BaseDaoImpl.java\n\n@@ -449,16 +449,16 @@ public abstract class BaseDaoImpl {\n \t\t\tif (locationReference.getChain() != null) {\n \t\t\t\tswitch (locationReference.getChain()) {\n \t\t\t\t\tcase Location.SP_ADDRESS_CITY:\n-\t\t\t\t\t\tcriteria.add(ilike(\"l.cityVillage\", locationReference.getValue(), MatchMode.START));\n+\t\t\t\t\t\tpropertyLike(\"l.cityVillage\", locationReference.getValue()).ifPresent(criteria::add);\n \t\t\t\t\t\tbreak;\n \t\t\t\t\tcase Location.SP_ADDRESS_STATE:\n-\t\t\t\t\t\tcriteria.add(ilike(\"l.stateProvince\", locationReference.getValue(), MatchMode.START));\n+\t\t\t\t\t\tpropertyLike(\"l.stateProvince\", locationReference.getValue()).ifPresent(criteria::add);\n \t\t\t\t\t\tbreak;\n \t\t\t\t\tcase Location.SP_ADDRESS_POSTALCODE:\n-\t\t\t\t\t\tcriteria.add(ilike(\"l.postalCode\", locationReference.getValue(), MatchMode.START));\n+\t\t\t\t\t\tpropertyLike(\"l.postalCode\", locationReference.getValue()).ifPresent(criteria::add);\n \t\t\t\t\t\tbreak;\n \t\t\t\t\tcase Location.SP_ADDRESS_COUNTRY:\n-\t\t\t\t\t\tcriteria.add(ilike(\"l.country\", locationReference.getValue(), MatchMode.START));\n+\t\t\t\t\t\tpropertyLike(\"l.country\", locationReference.getValue()).ifPresent(criteria::add);\n \t\t\t\t\t\tbreak;\n \t\t\t\t\tcase \"\":\n \t\t\t\t\t\tcriteria.add(eq(\"l.uuid\", locationReference.getValue()));\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDUzNjA2NA==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/86#discussion_r384536064", "bodyText": "We should still have tests making use of WRONG_PATIENT_IDENTIFIER", "author": "ibacher", "createdAt": "2020-02-26T14:43:54Z", "path": "api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirEncounterDaoImplTest.java", "diffHunk": "@@ -40,10 +47,28 @@\n \t\n \tprivate static final String PATIENT_IDENTIFIER = \"1000WF\";\n \t\n-\tprivate static final String WRONG_PATIENT_IDENTIFIER = \"12334HD\";", "originalCommit": "abfdde871aa48708a002414bac97c705dac8df9c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9e7618c7ea7dc002a5338ac49792b88f95b60c29", "chunk": "diff --git a/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirEncounterDaoImplTest.java b/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirEncounterDaoImplTest.java\nindex 0837e3a5..d4528652 100644\n--- a/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirEncounterDaoImplTest.java\n+++ b/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirEncounterDaoImplTest.java\n\n@@ -47,6 +48,8 @@ public class FhirEncounterDaoImplTest extends BaseModuleContextSensitiveTest {\n \t\n \tprivate static final String PATIENT_IDENTIFIER = \"1000WF\";\n \t\n+\tprivate static final String WRONG_PATIENT_IDENTIFIER = \"12334HD\";\n+\t\n \tprivate static final String PATIENT_FULL_NAME = \"Mr. John Doe\";\n \t\n \tprivate static final String ENCOUNTER_INITIAL_DATA_XML = \"org/openmrs/module/fhir2/api/dao/impl/FhirEncounterDaoImplTest_initial_data.xml\";\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDUzNzk4NA==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/86#discussion_r384537984", "bodyText": "We shouldn't need the encounter data XML file anywhere outside of the DAO tests. Everything else should be mocked.", "author": "ibacher", "createdAt": "2020-02-26T14:46:32Z", "path": "api/src/test/java/org/openmrs/module/fhir2/api/impl/FhirEncounterServiceImplTest.java", "diffHunk": "@@ -34,6 +46,28 @@\n \t\n \tprivate static final String PATIENT_IDENTIFIER = \"1003GH\";\n \t\n+\tprivate static final String PATIENT_FULL_NAME = \"Mr. John Doe\";\n+\t\n+\tprivate static final String ENCOUNTER_INITIAL_DATA_XML = \"org/openmrs/module/fhir2/api/dao/impl/FhirEncounterDaoImplTest_initial_data.xml\";", "originalCommit": "abfdde871aa48708a002414bac97c705dac8df9c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9e7618c7ea7dc002a5338ac49792b88f95b60c29", "chunk": "diff --git a/api/src/test/java/org/openmrs/module/fhir2/api/impl/FhirEncounterServiceImplTest.java b/api/src/test/java/org/openmrs/module/fhir2/api/impl/FhirEncounterServiceImplTest.java\nindex 5531af36..9a241647 100644\n--- a/api/src/test/java/org/openmrs/module/fhir2/api/impl/FhirEncounterServiceImplTest.java\n+++ b/api/src/test/java/org/openmrs/module/fhir2/api/impl/FhirEncounterServiceImplTest.java\n\n@@ -44,30 +44,14 @@ public class FhirEncounterServiceImplTest {\n \t\n \tprivate static final String ENCOUNTER_UUID = \"344kk343-45hj45-34jk34-34ui33\";\n \t\n-\tprivate static final String PATIENT_IDENTIFIER = \"1003GH\";\n-\t\n-\tprivate static final String PATIENT_FULL_NAME = \"Mr. John Doe\";\n-\t\n-\tprivate static final String ENCOUNTER_INITIAL_DATA_XML = \"org/openmrs/module/fhir2/api/dao/impl/FhirEncounterDaoImplTest_initial_data.xml\";\n-\t\n \tprivate static final String ENCOUNTER_DATETIME = \"2005-01-01T00:00:00.0\";\n \t\n-\tprivate static final String ENCOUNTER_DATE = \"2005-01-01 00:00:00.0\";\n-\t\n-\tprivate static final String PATIENT_GIVEN_NAME = \"John\";\n-\t\n \tprivate static final String PATIENT_FAMILY_NAME = \"Doe\";\n \t\n-\tprivate static final String ADDRESS_CITY = \"Boston\";\n-\t\n \tprivate static final String ENCOUNTER_ADDRESS_STATE = \"MA\";\n \t\n \tprivate static final String PARTICIPANT_IDENTIFIER = \"1\";\n \t\n-\tprivate static final String PARTICIPANT_FAMILY_NAME = \"Tim\";\n-\t\n-\tprivate static final String PARTICIPANT_GIVEN_NAME = \"Him\";\n-\t\n \t@Mock\n \tprivate FhirEncounterDao dao;\n \t\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDUzODQ1NQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/86#discussion_r384538455", "bodyText": "Can these statements be ordered in a more logical fashion? This is very confusing to read.", "author": "ibacher", "createdAt": "2020-02-26T14:47:16Z", "path": "api/src/test/java/org/openmrs/module/fhir2/api/impl/FhirEncounterServiceImplTest.java", "diffHunk": "@@ -70,16 +104,84 @@ public void shouldGetEncounterByUuid() {\n \t}\n \t\n \t@Test\n-\tpublic void findEncountersByPatientIdentifier_shouldReturnCollectionOfEncounters() {\n-\t\twhen(dao.findEncountersByPatientIdentifier(PATIENT_IDENTIFIER))\n-\t\t        .thenReturn(Collections.singletonList(openMrsEncounter));\n+\tpublic void searchForEncounter_shouldReturnCollectionOfEncounterByDate() {\n+\t\tCollection<Encounter> encounters = new ArrayList<>();", "originalCommit": "abfdde871aa48708a002414bac97c705dac8df9c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9e7618c7ea7dc002a5338ac49792b88f95b60c29", "chunk": "diff --git a/api/src/test/java/org/openmrs/module/fhir2/api/impl/FhirEncounterServiceImplTest.java b/api/src/test/java/org/openmrs/module/fhir2/api/impl/FhirEncounterServiceImplTest.java\nindex 5531af36..9a241647 100644\n--- a/api/src/test/java/org/openmrs/module/fhir2/api/impl/FhirEncounterServiceImplTest.java\n+++ b/api/src/test/java/org/openmrs/module/fhir2/api/impl/FhirEncounterServiceImplTest.java\n\n@@ -125,13 +109,13 @@ public class FhirEncounterServiceImplTest {\n \t@Test\n \tpublic void searchForEncounter_shouldReturnCollectionOfEncounterByLocation() {\n \t\tCollection<Encounter> encounters = new ArrayList<>();\n+\t\tencounters.add(openMrsEncounter);\n+\t\tfhirEncounter.setId(ENCOUNTER_UUID);\n+\t\t\n \t\tReferenceParam location = new ReferenceParam();\n \t\tlocation.setValue(ENCOUNTER_ADDRESS_STATE);\n \t\tlocation.setChain(Location.SP_ADDRESS_CITY);\n \t\t\n-\t\tencounters.add(openMrsEncounter);\n-\t\t\n-\t\tfhirEncounter.setId(ENCOUNTER_UUID);\n \t\twhen(dao.searchForEncounters(any(), argThat(is(location)), any(), any())).thenReturn(encounters);\n \t\twhen(encounterTranslator.toFhirResource(openMrsEncounter)).thenReturn(fhirEncounter);\n \t\t\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDUzOTMyOQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/86#discussion_r384539329", "bodyText": "Ditto on ordering", "author": "ibacher", "createdAt": "2020-02-26T14:48:28Z", "path": "api/src/test/java/org/openmrs/module/fhir2/api/impl/FhirEncounterServiceImplTest.java", "diffHunk": "@@ -70,16 +104,84 @@ public void shouldGetEncounterByUuid() {\n \t}\n \t\n \t@Test\n-\tpublic void findEncountersByPatientIdentifier_shouldReturnCollectionOfEncounters() {\n-\t\twhen(dao.findEncountersByPatientIdentifier(PATIENT_IDENTIFIER))\n-\t\t        .thenReturn(Collections.singletonList(openMrsEncounter));\n+\tpublic void searchForEncounter_shouldReturnCollectionOfEncounterByDate() {\n+\t\tCollection<Encounter> encounters = new ArrayList<>();\n+\t\tDateRangeParam dateRangeParam = new DateRangeParam(new DateParam(ENCOUNTER_DATETIME));\n+\t\t\n+\t\tencounters.add(openMrsEncounter);\n+\t\t\n+\t\tfhirEncounter.setId(ENCOUNTER_UUID);\n+\t\twhen(dao.searchForEncounters(argThat(is(dateRangeParam)), any(), any(), any())).thenReturn(encounters);\n \t\twhen(encounterTranslator.toFhirResource(openMrsEncounter)).thenReturn(fhirEncounter);\n \t\t\n-\t\tCollection<org.hl7.fhir.r4.model.Encounter> results = encounterService\n-\t\t        .findEncountersByPatientIdentifier(PATIENT_IDENTIFIER);\n-\t\tassertThat(results, notNullValue());\n-\t\tassertThat(results.size(), equalTo(1));\n-\t\tassertThat(results.stream().findFirst().isPresent(), is(true));\n+\t\tCollection<org.hl7.fhir.r4.model.Encounter> results = encounterService.searchForEncounters(dateRangeParam, null,\n+\t\t    null, null);\n+\t\t\n+\t\tassertThat(results, Matchers.notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.iterator().next().getId(), equalTo(ENCOUNTER_UUID));\n \t}\n \t\n+\t@Test\n+\tpublic void searchForEncounter_shouldReturnCollectionOfEncounterByLocation() {\n+\t\tCollection<Encounter> encounters = new ArrayList<>();\n+\t\tReferenceParam location = new ReferenceParam();", "originalCommit": "abfdde871aa48708a002414bac97c705dac8df9c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU1OTg4Mw==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/86#discussion_r384559883", "bodyText": "@ibacher Not sure what to do here, we haven't included any parameter like order", "author": "VaishSiddharth", "createdAt": "2020-02-26T15:18:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDUzOTMyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU2MDY5Nw==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/86#discussion_r384560697", "bodyText": "@ibacher Got it you mean that the method name should be ordered logical", "author": "VaishSiddharth", "createdAt": "2020-02-26T15:19:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDUzOTMyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU2MDgxNQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/86#discussion_r384560815", "bodyText": "I mean the order that the code is written in.", "author": "ibacher", "createdAt": "2020-02-26T15:19:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDUzOTMyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU2MjIwMg==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/86#discussion_r384562202", "bodyText": "Basically, I'd like to see something like:\nReferenceParam location = new ReferenceParam();\nlocation.setValue(ENCOUNTER_ADDRESS_STATE);\nlocation.setChain(Location.SP_ADDRESS_CITY)\n\nCollection<Encounter> encounters = new ArrayList<>();\nencounters.add(openMrsEncounter);\n\nfhirEncounter.setId(ENCOUNTER_UUID);\nSo that each part is created and populated in order.", "author": "ibacher", "createdAt": "2020-02-26T15:21:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDUzOTMyOQ=="}], "type": "inlineReview", "revised_code": {"commit": "9e7618c7ea7dc002a5338ac49792b88f95b60c29", "chunk": "diff --git a/api/src/test/java/org/openmrs/module/fhir2/api/impl/FhirEncounterServiceImplTest.java b/api/src/test/java/org/openmrs/module/fhir2/api/impl/FhirEncounterServiceImplTest.java\nindex 5531af36..9a241647 100644\n--- a/api/src/test/java/org/openmrs/module/fhir2/api/impl/FhirEncounterServiceImplTest.java\n+++ b/api/src/test/java/org/openmrs/module/fhir2/api/impl/FhirEncounterServiceImplTest.java\n\n@@ -125,13 +109,13 @@ public class FhirEncounterServiceImplTest {\n \t@Test\n \tpublic void searchForEncounter_shouldReturnCollectionOfEncounterByLocation() {\n \t\tCollection<Encounter> encounters = new ArrayList<>();\n+\t\tencounters.add(openMrsEncounter);\n+\t\tfhirEncounter.setId(ENCOUNTER_UUID);\n+\t\t\n \t\tReferenceParam location = new ReferenceParam();\n \t\tlocation.setValue(ENCOUNTER_ADDRESS_STATE);\n \t\tlocation.setChain(Location.SP_ADDRESS_CITY);\n \t\t\n-\t\tencounters.add(openMrsEncounter);\n-\t\t\n-\t\tfhirEncounter.setId(ENCOUNTER_UUID);\n \t\twhen(dao.searchForEncounters(any(), argThat(is(location)), any(), any())).thenReturn(encounters);\n \t\twhen(encounterTranslator.toFhirResource(openMrsEncounter)).thenReturn(fhirEncounter);\n \t\t\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDUzOTQzMw==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/86#discussion_r384539433", "bodyText": "Ditto on ordering", "author": "ibacher", "createdAt": "2020-02-26T14:48:35Z", "path": "api/src/test/java/org/openmrs/module/fhir2/api/impl/FhirEncounterServiceImplTest.java", "diffHunk": "@@ -70,16 +104,84 @@ public void shouldGetEncounterByUuid() {\n \t}\n \t\n \t@Test\n-\tpublic void findEncountersByPatientIdentifier_shouldReturnCollectionOfEncounters() {\n-\t\twhen(dao.findEncountersByPatientIdentifier(PATIENT_IDENTIFIER))\n-\t\t        .thenReturn(Collections.singletonList(openMrsEncounter));\n+\tpublic void searchForEncounter_shouldReturnCollectionOfEncounterByDate() {\n+\t\tCollection<Encounter> encounters = new ArrayList<>();\n+\t\tDateRangeParam dateRangeParam = new DateRangeParam(new DateParam(ENCOUNTER_DATETIME));\n+\t\t\n+\t\tencounters.add(openMrsEncounter);\n+\t\t\n+\t\tfhirEncounter.setId(ENCOUNTER_UUID);\n+\t\twhen(dao.searchForEncounters(argThat(is(dateRangeParam)), any(), any(), any())).thenReturn(encounters);\n \t\twhen(encounterTranslator.toFhirResource(openMrsEncounter)).thenReturn(fhirEncounter);\n \t\t\n-\t\tCollection<org.hl7.fhir.r4.model.Encounter> results = encounterService\n-\t\t        .findEncountersByPatientIdentifier(PATIENT_IDENTIFIER);\n-\t\tassertThat(results, notNullValue());\n-\t\tassertThat(results.size(), equalTo(1));\n-\t\tassertThat(results.stream().findFirst().isPresent(), is(true));\n+\t\tCollection<org.hl7.fhir.r4.model.Encounter> results = encounterService.searchForEncounters(dateRangeParam, null,\n+\t\t    null, null);\n+\t\t\n+\t\tassertThat(results, Matchers.notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.iterator().next().getId(), equalTo(ENCOUNTER_UUID));\n \t}\n \t\n+\t@Test\n+\tpublic void searchForEncounter_shouldReturnCollectionOfEncounterByLocation() {\n+\t\tCollection<Encounter> encounters = new ArrayList<>();\n+\t\tReferenceParam location = new ReferenceParam();\n+\t\tlocation.setValue(ENCOUNTER_ADDRESS_STATE);\n+\t\tlocation.setChain(Location.SP_ADDRESS_CITY);\n+\t\t\n+\t\tencounters.add(openMrsEncounter);\n+\t\t\n+\t\tfhirEncounter.setId(ENCOUNTER_UUID);\n+\t\twhen(dao.searchForEncounters(any(), argThat(is(location)), any(), any())).thenReturn(encounters);\n+\t\twhen(encounterTranslator.toFhirResource(openMrsEncounter)).thenReturn(fhirEncounter);\n+\t\t\n+\t\tCollection<org.hl7.fhir.r4.model.Encounter> results = encounterService.searchForEncounters(null, location, null,\n+\t\t    null);\n+\t\t\n+\t\tassertThat(results, Matchers.notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.size(), greaterThanOrEqualTo(1));\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForEncounter_shouldReturnCollectionOfEncounterByParticipant() {\n+\t\tCollection<Encounter> encounters = new ArrayList<>();\n+\t\tReferenceParam participant = new ReferenceParam();", "originalCommit": "abfdde871aa48708a002414bac97c705dac8df9c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9e7618c7ea7dc002a5338ac49792b88f95b60c29", "chunk": "diff --git a/api/src/test/java/org/openmrs/module/fhir2/api/impl/FhirEncounterServiceImplTest.java b/api/src/test/java/org/openmrs/module/fhir2/api/impl/FhirEncounterServiceImplTest.java\nindex 5531af36..9a241647 100644\n--- a/api/src/test/java/org/openmrs/module/fhir2/api/impl/FhirEncounterServiceImplTest.java\n+++ b/api/src/test/java/org/openmrs/module/fhir2/api/impl/FhirEncounterServiceImplTest.java\n\n@@ -125,13 +109,13 @@ public class FhirEncounterServiceImplTest {\n \t@Test\n \tpublic void searchForEncounter_shouldReturnCollectionOfEncounterByLocation() {\n \t\tCollection<Encounter> encounters = new ArrayList<>();\n+\t\tencounters.add(openMrsEncounter);\n+\t\tfhirEncounter.setId(ENCOUNTER_UUID);\n+\t\t\n \t\tReferenceParam location = new ReferenceParam();\n \t\tlocation.setValue(ENCOUNTER_ADDRESS_STATE);\n \t\tlocation.setChain(Location.SP_ADDRESS_CITY);\n \t\t\n-\t\tencounters.add(openMrsEncounter);\n-\t\t\n-\t\tfhirEncounter.setId(ENCOUNTER_UUID);\n \t\twhen(dao.searchForEncounters(any(), argThat(is(location)), any(), any())).thenReturn(encounters);\n \t\twhen(encounterTranslator.toFhirResource(openMrsEncounter)).thenReturn(fhirEncounter);\n \t\t\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDUzOTU4Nw==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/86#discussion_r384539587", "bodyText": "Ditto on ordering", "author": "ibacher", "createdAt": "2020-02-26T14:48:46Z", "path": "api/src/test/java/org/openmrs/module/fhir2/api/impl/FhirEncounterServiceImplTest.java", "diffHunk": "@@ -70,16 +104,84 @@ public void shouldGetEncounterByUuid() {\n \t}\n \t\n \t@Test\n-\tpublic void findEncountersByPatientIdentifier_shouldReturnCollectionOfEncounters() {\n-\t\twhen(dao.findEncountersByPatientIdentifier(PATIENT_IDENTIFIER))\n-\t\t        .thenReturn(Collections.singletonList(openMrsEncounter));\n+\tpublic void searchForEncounter_shouldReturnCollectionOfEncounterByDate() {\n+\t\tCollection<Encounter> encounters = new ArrayList<>();\n+\t\tDateRangeParam dateRangeParam = new DateRangeParam(new DateParam(ENCOUNTER_DATETIME));\n+\t\t\n+\t\tencounters.add(openMrsEncounter);\n+\t\t\n+\t\tfhirEncounter.setId(ENCOUNTER_UUID);\n+\t\twhen(dao.searchForEncounters(argThat(is(dateRangeParam)), any(), any(), any())).thenReturn(encounters);\n \t\twhen(encounterTranslator.toFhirResource(openMrsEncounter)).thenReturn(fhirEncounter);\n \t\t\n-\t\tCollection<org.hl7.fhir.r4.model.Encounter> results = encounterService\n-\t\t        .findEncountersByPatientIdentifier(PATIENT_IDENTIFIER);\n-\t\tassertThat(results, notNullValue());\n-\t\tassertThat(results.size(), equalTo(1));\n-\t\tassertThat(results.stream().findFirst().isPresent(), is(true));\n+\t\tCollection<org.hl7.fhir.r4.model.Encounter> results = encounterService.searchForEncounters(dateRangeParam, null,\n+\t\t    null, null);\n+\t\t\n+\t\tassertThat(results, Matchers.notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.iterator().next().getId(), equalTo(ENCOUNTER_UUID));\n \t}\n \t\n+\t@Test\n+\tpublic void searchForEncounter_shouldReturnCollectionOfEncounterByLocation() {\n+\t\tCollection<Encounter> encounters = new ArrayList<>();\n+\t\tReferenceParam location = new ReferenceParam();\n+\t\tlocation.setValue(ENCOUNTER_ADDRESS_STATE);\n+\t\tlocation.setChain(Location.SP_ADDRESS_CITY);\n+\t\t\n+\t\tencounters.add(openMrsEncounter);\n+\t\t\n+\t\tfhirEncounter.setId(ENCOUNTER_UUID);\n+\t\twhen(dao.searchForEncounters(any(), argThat(is(location)), any(), any())).thenReturn(encounters);\n+\t\twhen(encounterTranslator.toFhirResource(openMrsEncounter)).thenReturn(fhirEncounter);\n+\t\t\n+\t\tCollection<org.hl7.fhir.r4.model.Encounter> results = encounterService.searchForEncounters(null, location, null,\n+\t\t    null);\n+\t\t\n+\t\tassertThat(results, Matchers.notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.size(), greaterThanOrEqualTo(1));\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForEncounter_shouldReturnCollectionOfEncounterByParticipant() {\n+\t\tCollection<Encounter> encounters = new ArrayList<>();\n+\t\tReferenceParam participant = new ReferenceParam();\n+\t\tparticipant.setValue(PARTICIPANT_IDENTIFIER);\n+\t\tparticipant.setChain(Practitioner.SP_IDENTIFIER);\n+\t\t\n+\t\tencounters.add(openMrsEncounter);\n+\t\t\n+\t\tfhirEncounter.setId(ENCOUNTER_UUID);\n+\t\twhen(dao.searchForEncounters(any(), any(), argThat(is(participant)), any())).thenReturn(encounters);\n+\t\twhen(encounterTranslator.toFhirResource(openMrsEncounter)).thenReturn(fhirEncounter);\n+\t\t\n+\t\tCollection<org.hl7.fhir.r4.model.Encounter> results = encounterService.searchForEncounters(null, null, participant,\n+\t\t    null);\n+\t\t\n+\t\tassertThat(results, Matchers.notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.size(), greaterThanOrEqualTo(1));\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForEncounter_shouldReturnCollectionOfEncounterBySubject() {\n+\t\tCollection<Encounter> encounters = new ArrayList<>();\n+\t\tReferenceParam subject = new ReferenceParam();", "originalCommit": "abfdde871aa48708a002414bac97c705dac8df9c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9e7618c7ea7dc002a5338ac49792b88f95b60c29", "chunk": "diff --git a/api/src/test/java/org/openmrs/module/fhir2/api/impl/FhirEncounterServiceImplTest.java b/api/src/test/java/org/openmrs/module/fhir2/api/impl/FhirEncounterServiceImplTest.java\nindex 5531af36..9a241647 100644\n--- a/api/src/test/java/org/openmrs/module/fhir2/api/impl/FhirEncounterServiceImplTest.java\n+++ b/api/src/test/java/org/openmrs/module/fhir2/api/impl/FhirEncounterServiceImplTest.java\n\n@@ -125,13 +109,13 @@ public class FhirEncounterServiceImplTest {\n \t@Test\n \tpublic void searchForEncounter_shouldReturnCollectionOfEncounterByLocation() {\n \t\tCollection<Encounter> encounters = new ArrayList<>();\n+\t\tencounters.add(openMrsEncounter);\n+\t\tfhirEncounter.setId(ENCOUNTER_UUID);\n+\t\t\n \t\tReferenceParam location = new ReferenceParam();\n \t\tlocation.setValue(ENCOUNTER_ADDRESS_STATE);\n \t\tlocation.setChain(Location.SP_ADDRESS_CITY);\n \t\t\n-\t\tencounters.add(openMrsEncounter);\n-\t\t\n-\t\tfhirEncounter.setId(ENCOUNTER_UUID);\n \t\twhen(dao.searchForEncounters(any(), argThat(is(location)), any(), any())).thenReturn(encounters);\n \t\twhen(encounterTranslator.toFhirResource(openMrsEncounter)).thenReturn(fhirEncounter);\n \t\t\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU0MDYwNw==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/86#discussion_r384540607", "bodyText": "Why is this here?", "author": "ibacher", "createdAt": "2020-02-26T14:50:11Z", "path": "omod/src/test/java/org/openmrs/module/fhir2/providers/EncounterFhirResourceProviderTest.java", "diffHunk": "@@ -87,22 +88,22 @@ public void getEncounterWithWrongUuid_shouldThrowResourceNotFoundException() {\n \t}\n \t\n \t@Test\n-\tpublic void findEncountersByPatientIdentifier_shouldReturnMatchingBundleOfEncounters() {\n-\t\twhen(encounterService.findEncountersByPatientIdentifier(PATIENT_IDENTIFIER))\n-\t\t        .thenReturn(Collections.singletonList(encounter));\n-\t\tReferenceParam param = new ReferenceParam();\n-\t\tparam.setValue(PATIENT_IDENTIFIER);\n-\t\tBundle encounterBundle = resourceProvider.findEncountersByPatientIdentifier(param);\n-\t\tassertThat(encounterBundle, notNullValue());\n-\t\tassertThat(encounterBundle.getEntry().size(), equalTo(1));\n-\t}\n-\t\n-\t@Test\n-\tpublic void findEncountersByWrongPatientIdentifier_shouldReturnBundleWithEmptyEntries() {\n-\t\tReferenceParam param = new ReferenceParam();\n-\t\tparam.setValue(PATIENT_IDENTIFIER);\n-\t\tBundle bundle = resourceProvider.findEncountersByPatientIdentifier(param);\n-\t\tassertThat(bundle, notNullValue());\n-\t\tassertThat(bundle.getEntry(), is(empty()));\n+\tpublic void searchEncounters_shouldReturnMatchingEncounters() {\n+\t\tList<Encounter> encounters = new ArrayList<>();\n+\t\tencounters.add(encounter);\n+\t\twhen(encounterService.searchForEncounters(any(), any(), any(), any())).thenReturn(encounters);\n+\t\tReferenceParam subjectreference = new ReferenceParam();\n+\t\tsubjectreference.setChain(Patient.SP_NAME);\n+\t\t\n+\t\torg.hl7.fhir.r4.model.Encounter enc = new org.hl7.fhir.r4.model.Encounter();", "originalCommit": "abfdde871aa48708a002414bac97c705dac8df9c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9e7618c7ea7dc002a5338ac49792b88f95b60c29", "chunk": "diff --git a/omod/src/test/java/org/openmrs/module/fhir2/providers/EncounterFhirResourceProviderTest.java b/omod/src/test/java/org/openmrs/module/fhir2/providers/EncounterFhirResourceProviderTest.java\nindex 2e6eeeee..e8ce1260 100644\n--- a/omod/src/test/java/org/openmrs/module/fhir2/providers/EncounterFhirResourceProviderTest.java\n+++ b/omod/src/test/java/org/openmrs/module/fhir2/providers/EncounterFhirResourceProviderTest.java\n\n@@ -92,14 +92,11 @@ public class EncounterFhirResourceProviderTest {\n \t\tList<Encounter> encounters = new ArrayList<>();\n \t\tencounters.add(encounter);\n \t\twhen(encounterService.searchForEncounters(any(), any(), any(), any())).thenReturn(encounters);\n+\t\t\n \t\tReferenceParam subjectreference = new ReferenceParam();\n \t\tsubjectreference.setChain(Patient.SP_NAME);\n \t\t\n-\t\torg.hl7.fhir.r4.model.Encounter enc = new org.hl7.fhir.r4.model.Encounter();\n-\t\tenc.setId(ENCOUNTER_UUID);\n-\t\t\n \t\tBundle results = resourceProvider.searchEncounter(null, null, null, subjectreference);\n-\t\t\n \t\tassertThat(results, notNullValue());\n \t\tassertThat(results.getTotal(), equalTo(1));\n \t\tassertThat(results.getEntry(), notNullValue());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU0MDkxMA==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/86#discussion_r384540910", "bodyText": "Observations?", "author": "ibacher", "createdAt": "2020-02-26T14:50:38Z", "path": "omod/src/test/java/org/openmrs/module/fhir2/providers/EncounterFhirResourceProviderWebTest.java", "diffHunk": "@@ -82,31 +125,145 @@ public void getEncounterByWrongUuid_shouldReturn404() throws Exception {\n \t}\n \t\n \t@Test\n-\tpublic void findEncountersByPatientIdentifier_shouldReturnBundleOfEncounters() throws IOException, ServletException {\n-\t\tEncounter encounter = new Encounter();\n-\t\tencounter.setId(ENCOUNTER_UUID);\n-\t\twhen(encounterService.findEncountersByPatientIdentifier(PATIENT_IDENTIFIER))\n-\t\t        .thenReturn(Collections.singletonList(encounter));\n+\tpublic void shouldGetObservationsBySubjectUuid() throws Exception {", "originalCommit": "abfdde871aa48708a002414bac97c705dac8df9c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU2NTMwOA==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/86#discussion_r384565308", "bodyText": "@ibacher Oh sorry was a bit lazy in typing the full name so copied it from Observations and then forgot to change it to encounters.", "author": "VaishSiddharth", "createdAt": "2020-02-26T15:25:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU0MDkxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU2NjAxMA==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/86#discussion_r384566010", "bodyText": "@VaishSiddharth That happens and it's fine; just needs to be fixed before we can merge it \ud83d\ude42", "author": "ibacher", "createdAt": "2020-02-26T15:26:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU0MDkxMA=="}], "type": "inlineReview", "revised_code": {"commit": "9e7618c7ea7dc002a5338ac49792b88f95b60c29", "chunk": "diff --git a/omod/src/test/java/org/openmrs/module/fhir2/providers/EncounterFhirResourceProviderWebTest.java b/omod/src/test/java/org/openmrs/module/fhir2/providers/EncounterFhirResourceProviderWebTest.java\nindex 071de6be..14c26321 100644\n--- a/omod/src/test/java/org/openmrs/module/fhir2/providers/EncounterFhirResourceProviderWebTest.java\n+++ b/omod/src/test/java/org/openmrs/module/fhir2/providers/EncounterFhirResourceProviderWebTest.java\n\n@@ -125,7 +128,7 @@ public class EncounterFhirResourceProviderWebTest extends BaseFhirResourceProvid\n \t}\n \t\n \t@Test\n-\tpublic void shouldGetObservationsBySubjectUuid() throws Exception {\n+\tpublic void shouldGetEncountersBySubjectUuid() throws Exception {\n \t\tverifyUri(String.format(\"/Encounter?subject:Patient=%s\", PATIENT_UUID));\n \t\t\n \t\tverify(encounterService).searchForEncounters(isNull(), isNull(), isNull(), subjectCaptor.capture());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU0MTAzMg==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/86#discussion_r384541032", "bodyText": "Observations?", "author": "ibacher", "createdAt": "2020-02-26T14:50:49Z", "path": "omod/src/test/java/org/openmrs/module/fhir2/providers/EncounterFhirResourceProviderWebTest.java", "diffHunk": "@@ -82,31 +125,145 @@ public void getEncounterByWrongUuid_shouldReturn404() throws Exception {\n \t}\n \t\n \t@Test\n-\tpublic void findEncountersByPatientIdentifier_shouldReturnBundleOfEncounters() throws IOException, ServletException {\n-\t\tEncounter encounter = new Encounter();\n-\t\tencounter.setId(ENCOUNTER_UUID);\n-\t\twhen(encounterService.findEncountersByPatientIdentifier(PATIENT_IDENTIFIER))\n-\t\t        .thenReturn(Collections.singletonList(encounter));\n+\tpublic void shouldGetObservationsBySubjectUuid() throws Exception {\n+\t\tverifyUri(String.format(\"/Encounter?subject:Patient=%s\", PATIENT_UUID));\n \t\t\n-\t\tMockHttpServletResponse response = get(\"/Encounter?patient.identifier=\" + PATIENT_IDENTIFIER)\n-\t\t        .accept(FhirMediaTypes.JSON).go();\n+\t\tverify(encounterService).searchForEncounters(isNull(), isNull(), isNull(), subjectCaptor.capture());\n+\t\tassertThat(subjectCaptor.getValue(), notNullValue());\n+\t\tassertThat(subjectCaptor.getValue().getIdPart(), equalTo(PATIENT_UUID));\n+\t}\n+\t\n+\t@Test\n+\tpublic void shouldGetObservationsByDate() throws Exception {", "originalCommit": "abfdde871aa48708a002414bac97c705dac8df9c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9e7618c7ea7dc002a5338ac49792b88f95b60c29", "chunk": "diff --git a/omod/src/test/java/org/openmrs/module/fhir2/providers/EncounterFhirResourceProviderWebTest.java b/omod/src/test/java/org/openmrs/module/fhir2/providers/EncounterFhirResourceProviderWebTest.java\nindex 071de6be..14c26321 100644\n--- a/omod/src/test/java/org/openmrs/module/fhir2/providers/EncounterFhirResourceProviderWebTest.java\n+++ b/omod/src/test/java/org/openmrs/module/fhir2/providers/EncounterFhirResourceProviderWebTest.java\n\n@@ -125,7 +128,7 @@ public class EncounterFhirResourceProviderWebTest extends BaseFhirResourceProvid\n \t}\n \t\n \t@Test\n-\tpublic void shouldGetObservationsBySubjectUuid() throws Exception {\n+\tpublic void shouldGetEncountersBySubjectUuid() throws Exception {\n \t\tverifyUri(String.format(\"/Encounter?subject:Patient=%s\", PATIENT_UUID));\n \t\t\n \t\tverify(encounterService).searchForEncounters(isNull(), isNull(), isNull(), subjectCaptor.capture());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU0MTIwMA==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/86#discussion_r384541200", "bodyText": "Ditto", "author": "ibacher", "createdAt": "2020-02-26T14:51:01Z", "path": "omod/src/test/java/org/openmrs/module/fhir2/providers/EncounterFhirResourceProviderWebTest.java", "diffHunk": "@@ -82,31 +125,145 @@ public void getEncounterByWrongUuid_shouldReturn404() throws Exception {\n \t}\n \t\n \t@Test\n-\tpublic void findEncountersByPatientIdentifier_shouldReturnBundleOfEncounters() throws IOException, ServletException {\n-\t\tEncounter encounter = new Encounter();\n-\t\tencounter.setId(ENCOUNTER_UUID);\n-\t\twhen(encounterService.findEncountersByPatientIdentifier(PATIENT_IDENTIFIER))\n-\t\t        .thenReturn(Collections.singletonList(encounter));\n+\tpublic void shouldGetObservationsBySubjectUuid() throws Exception {\n+\t\tverifyUri(String.format(\"/Encounter?subject:Patient=%s\", PATIENT_UUID));\n \t\t\n-\t\tMockHttpServletResponse response = get(\"/Encounter?patient.identifier=\" + PATIENT_IDENTIFIER)\n-\t\t        .accept(FhirMediaTypes.JSON).go();\n+\t\tverify(encounterService).searchForEncounters(isNull(), isNull(), isNull(), subjectCaptor.capture());\n+\t\tassertThat(subjectCaptor.getValue(), notNullValue());\n+\t\tassertThat(subjectCaptor.getValue().getIdPart(), equalTo(PATIENT_UUID));\n+\t}\n+\t\n+\t@Test\n+\tpublic void shouldGetObservationsByDate() throws Exception {\n+\t\tverifyUri(\"/Encounter/?date=ge1975-02-02\");\n \t\t\n-\t\tassertThat(response, isOk());\n-\t\tassertThat(response.getContentType(), equalTo(FhirMediaTypes.JSON.toString()));\n-\t\tassertThat(readBundleResponse(response).getEntry().size(), greaterThanOrEqualTo(1));\n+\t\tverify(encounterService).searchForEncounters(dateRangeCaptor.capture(), isNull(), isNull(), isNull());\n+\t\tassertThat(dateRangeCaptor.getValue(), notNullValue());\n+\t\t\n+\t\tCalendar calendar = Calendar.getInstance();\n+\t\tcalendar.set(1975, 1, 2);\n+\t\t\n+\t\tassertThat(dateRangeCaptor.getValue().getLowerBound().getValue(),\n+\t\t    equalTo(DateUtils.truncate(calendar.getTime(), Calendar.DATE)));\n+\t\tassertThat(dateRangeCaptor.getValue().getUpperBound(), nullValue());\n+\t}\n+\t\n+\t@Test\n+\tpublic void shouldGetObservationsByLocationCityVillage() throws Exception {", "originalCommit": "abfdde871aa48708a002414bac97c705dac8df9c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9e7618c7ea7dc002a5338ac49792b88f95b60c29", "chunk": "diff --git a/omod/src/test/java/org/openmrs/module/fhir2/providers/EncounterFhirResourceProviderWebTest.java b/omod/src/test/java/org/openmrs/module/fhir2/providers/EncounterFhirResourceProviderWebTest.java\nindex 071de6be..14c26321 100644\n--- a/omod/src/test/java/org/openmrs/module/fhir2/providers/EncounterFhirResourceProviderWebTest.java\n+++ b/omod/src/test/java/org/openmrs/module/fhir2/providers/EncounterFhirResourceProviderWebTest.java\n\n@@ -125,7 +128,7 @@ public class EncounterFhirResourceProviderWebTest extends BaseFhirResourceProvid\n \t}\n \t\n \t@Test\n-\tpublic void shouldGetObservationsBySubjectUuid() throws Exception {\n+\tpublic void shouldGetEncountersBySubjectUuid() throws Exception {\n \t\tverifyUri(String.format(\"/Encounter?subject:Patient=%s\", PATIENT_UUID));\n \t\t\n \t\tverify(encounterService).searchForEncounters(isNull(), isNull(), isNull(), subjectCaptor.capture());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU0MTI4MQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/86#discussion_r384541281", "bodyText": "Ditto", "author": "ibacher", "createdAt": "2020-02-26T14:51:08Z", "path": "omod/src/test/java/org/openmrs/module/fhir2/providers/EncounterFhirResourceProviderWebTest.java", "diffHunk": "@@ -82,31 +125,145 @@ public void getEncounterByWrongUuid_shouldReturn404() throws Exception {\n \t}\n \t\n \t@Test\n-\tpublic void findEncountersByPatientIdentifier_shouldReturnBundleOfEncounters() throws IOException, ServletException {\n-\t\tEncounter encounter = new Encounter();\n-\t\tencounter.setId(ENCOUNTER_UUID);\n-\t\twhen(encounterService.findEncountersByPatientIdentifier(PATIENT_IDENTIFIER))\n-\t\t        .thenReturn(Collections.singletonList(encounter));\n+\tpublic void shouldGetObservationsBySubjectUuid() throws Exception {\n+\t\tverifyUri(String.format(\"/Encounter?subject:Patient=%s\", PATIENT_UUID));\n \t\t\n-\t\tMockHttpServletResponse response = get(\"/Encounter?patient.identifier=\" + PATIENT_IDENTIFIER)\n-\t\t        .accept(FhirMediaTypes.JSON).go();\n+\t\tverify(encounterService).searchForEncounters(isNull(), isNull(), isNull(), subjectCaptor.capture());\n+\t\tassertThat(subjectCaptor.getValue(), notNullValue());\n+\t\tassertThat(subjectCaptor.getValue().getIdPart(), equalTo(PATIENT_UUID));\n+\t}\n+\t\n+\t@Test\n+\tpublic void shouldGetObservationsByDate() throws Exception {\n+\t\tverifyUri(\"/Encounter/?date=ge1975-02-02\");\n \t\t\n-\t\tassertThat(response, isOk());\n-\t\tassertThat(response.getContentType(), equalTo(FhirMediaTypes.JSON.toString()));\n-\t\tassertThat(readBundleResponse(response).getEntry().size(), greaterThanOrEqualTo(1));\n+\t\tverify(encounterService).searchForEncounters(dateRangeCaptor.capture(), isNull(), isNull(), isNull());\n+\t\tassertThat(dateRangeCaptor.getValue(), notNullValue());\n+\t\t\n+\t\tCalendar calendar = Calendar.getInstance();\n+\t\tcalendar.set(1975, 1, 2);\n+\t\t\n+\t\tassertThat(dateRangeCaptor.getValue().getLowerBound().getValue(),\n+\t\t    equalTo(DateUtils.truncate(calendar.getTime(), Calendar.DATE)));\n+\t\tassertThat(dateRangeCaptor.getValue().getUpperBound(), nullValue());\n+\t}\n+\t\n+\t@Test\n+\tpublic void shouldGetObservationsByLocationCityVillage() throws Exception {\n+\t\tverifyUri(String.format(\"/Encounter/?location.address-city=%s\", ENCOUNTER_ADDRESS_CITY));\n+\t\t\n+\t\tverify(encounterService).searchForEncounters(isNull(), locationCaptor.capture(), isNull(), isNull());\n+\t\tassertThat(locationCaptor.getValue(), notNullValue());\n+\t\tassertThat(locationCaptor.getValue().getChain(), equalTo(\"address-city\"));\n+\t\tassertThat(locationCaptor.getValue().getValue(), equalTo(ENCOUNTER_ADDRESS_CITY));\n+\t}\n+\t\n+\t@Test\n+\tpublic void shouldGetObservationsByLocationState() throws Exception {", "originalCommit": "abfdde871aa48708a002414bac97c705dac8df9c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9e7618c7ea7dc002a5338ac49792b88f95b60c29", "chunk": "diff --git a/omod/src/test/java/org/openmrs/module/fhir2/providers/EncounterFhirResourceProviderWebTest.java b/omod/src/test/java/org/openmrs/module/fhir2/providers/EncounterFhirResourceProviderWebTest.java\nindex 071de6be..14c26321 100644\n--- a/omod/src/test/java/org/openmrs/module/fhir2/providers/EncounterFhirResourceProviderWebTest.java\n+++ b/omod/src/test/java/org/openmrs/module/fhir2/providers/EncounterFhirResourceProviderWebTest.java\n\n@@ -125,7 +128,7 @@ public class EncounterFhirResourceProviderWebTest extends BaseFhirResourceProvid\n \t}\n \t\n \t@Test\n-\tpublic void shouldGetObservationsBySubjectUuid() throws Exception {\n+\tpublic void shouldGetEncountersBySubjectUuid() throws Exception {\n \t\tverifyUri(String.format(\"/Encounter?subject:Patient=%s\", PATIENT_UUID));\n \t\t\n \t\tverify(encounterService).searchForEncounters(isNull(), isNull(), isNull(), subjectCaptor.capture());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU0MzQyMA==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/86#discussion_r384543420", "bodyText": "This also needs some tests verifying complex behaviour. I.e., what should happen if I request\n/Encounter?subject.given=Harold&location.address-postalcode=90210,90177?", "author": "ibacher", "createdAt": "2020-02-26T14:54:05Z", "path": "omod/src/test/java/org/openmrs/module/fhir2/providers/EncounterFhirResourceProviderWebTest.java", "diffHunk": "@@ -12,22 +12,29 @@\n import static org.hamcrest.MatcherAssert.assertThat;", "originalCommit": "abfdde871aa48708a002414bac97c705dac8df9c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU3NjA1MA==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/86#discussion_r384576050", "bodyText": "@ibacher What should happen in this case?\n@Test\n\tpublic void shouldGetEncountersBySubjectGivenNameAndLocationPostalCode() throws Exception {\n\t\tverifyUri(\"/Encounter?subject.given=Harold&?location.address-postalcode=90210,90177\");\n\n\t\tverify(encounterService).searchForEncounters(isNull(), locationCaptor.capture(), isNull(), subjectCaptor.capture());\n\t\tassertThat(subjectCaptor.getValue(), notNullValue());\n\t\tassertThat(locationCaptor.getValue(), notNullValue());\n\t\tassertThat(subjectCaptor.getValue().getChain(), equalTo(\"given\"));\n\t\tassertThat(subjectCaptor.getValue().getValue(), equalTo(PATIENT_GIVEN_NAME));\n\t\tassertThat(locationCaptor.getValue().getChain(), equalTo(\"address-postalcode\"));\n\t\tassertThat(locationCaptor.getValue().getValue(), equalTo(ENCOUNTER_POSTALCODE));\n\t}\nThe error failed with error message\n\njava.lang.AssertionError: \nExpected: response with HTTP status indicating request was handled successfully\n     but: response with status code <400> with message \"Invalid request: The FHIR endpoint on this server does not know how to handle GET operation[Encounter] with parameters [[?location.address-postalcode, subject.given]]\"", "author": "VaishSiddharth", "createdAt": "2020-02-26T15:40:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU0MzQyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU3NzMwNA==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/86#discussion_r384577304", "bodyText": "@ibacher Its working if I use only one parameter in location\nlike this\n/Encounter?subject.given=Hannibal&location.address-postalcode=248001", "author": "VaishSiddharth", "createdAt": "2020-02-26T15:42:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU0MzQyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDY3OTk4Mg==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/86#discussion_r384679982", "bodyText": "Oh yeah, fair enough, we'd have to change it to a ReferenceOrListParam, which probably isn't worth it for this PR.", "author": "ibacher", "createdAt": "2020-02-26T18:27:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU0MzQyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDY4MTU1OQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/86#discussion_r384681559", "bodyText": "@ibacher I think I have fixed everything else. So is it ready for getting merged ?", "author": "VaishSiddharth", "createdAt": "2020-02-26T18:29:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU0MzQyMA=="}], "type": "inlineReview", "revised_code": {"commit": "9e7618c7ea7dc002a5338ac49792b88f95b60c29", "chunk": "diff --git a/omod/src/test/java/org/openmrs/module/fhir2/providers/EncounterFhirResourceProviderWebTest.java b/omod/src/test/java/org/openmrs/module/fhir2/providers/EncounterFhirResourceProviderWebTest.java\nindex 071de6be..14c26321 100644\n--- a/omod/src/test/java/org/openmrs/module/fhir2/providers/EncounterFhirResourceProviderWebTest.java\n+++ b/omod/src/test/java/org/openmrs/module/fhir2/providers/EncounterFhirResourceProviderWebTest.java\n\n@@ -20,6 +20,8 @@ import static org.mockito.ArgumentMatchers.isNull;\n import static org.mockito.Mockito.verify;\n import static org.mockito.Mockito.when;\n \n+import java.io.UnsupportedEncodingException;\n+import java.net.URLEncoder;\n import java.util.Calendar;\n import java.util.Collections;\n \n"}}, {"oid": "9e7618c7ea7dc002a5338ac49792b88f95b60c29", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/9e7618c7ea7dc002a5338ac49792b88f95b60c29", "message": "issues fixed", "committedDate": "2020-02-26T16:57:59Z", "type": "commit"}, {"oid": "5afb7189963f1536dcd3742eac504eb5d2d521bb", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/5afb7189963f1536dcd3742eac504eb5d2d521bb", "message": "observation file removed and code ordered properly", "committedDate": "2020-02-26T17:15:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDY4MTU3NA==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/86#discussion_r384681574", "bodyText": "This seems to be searching by subject rather than participant", "author": "ibacher", "createdAt": "2020-02-26T18:29:55Z", "path": "api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirEncounterDaoImplTest.java", "diffHunk": "@@ -72,21 +100,183 @@ public void shouldReturnNullWithUnknownEncounterUuid() {\n \t}\n \t\n \t@Test\n-\tpublic void findEncountersByPatientIdentifier_shouldReturnCollectionOfEncounters() {\n-\t\tList<Encounter> encounters = dao.findEncountersByPatientIdentifier(PATIENT_IDENTIFIER);\n-\t\tassertThat(encounters, notNullValue());\n-\t\tassertThat(encounters.size(), greaterThanOrEqualTo(1));\n-\t\tassertThat(encounters.stream().findFirst().isPresent(), is(true));\n-\t\tassertThat(encounters.stream().findFirst().get().getPatient(), notNullValue());\n-\t\tassertThat(encounters.stream().findFirst().get().getPatient().getPatientIdentifier().getIdentifier(),\n+\tpublic void searchForEncounters_shouldSearchForEncountersByDate() {\n+\t\tCollection<Encounter> results = dao.searchForEncounters(new DateRangeParam(new DateParam(ENCOUNTER_DATETIME)), null,\n+\t\t    null, null);\n+\t\t\n+\t\tassertThat(results, Matchers.notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.iterator().next().getEncounterDatetime().toString(), equalTo(ENCOUNTER_DATE));\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForEncounters_shouldSearchForEncountersBySubjectName() {\n+\t\tReferenceParam subjectReference = new ReferenceParam();\n+\t\t\n+\t\tsubjectReference.setValue(PATIENT_FULL_NAME);\n+\t\tsubjectReference.setChain(Patient.SP_NAME);\n+\t\t\n+\t\tCollection<Encounter> results = dao.searchForEncounters(null, null, null, subjectReference);\n+\t\t\n+\t\tassertThat(results, Matchers.notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.iterator().next().getPatient().getPerson().getPersonName().getFullName(),\n+\t\t    equalTo(PATIENT_FULL_NAME));\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForEncounters_shouldSearchForEncountersBySubjectFamilyName() {\n+\t\tReferenceParam subjectReference = new ReferenceParam();\n+\t\t\n+\t\tsubjectReference.setValue(PATIENT_FAMILY_NAME);\n+\t\tsubjectReference.setChain(Patient.SP_FAMILY);\n+\t\t\n+\t\tCollection<Encounter> results = dao.searchForEncounters(null, null, null, subjectReference);\n+\t\t\n+\t\tassertThat(results, Matchers.notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.iterator().next().getPatient().getPerson().getPersonName().getFamilyName(),\n+\t\t    equalTo(PATIENT_FAMILY_NAME));\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForEncounters_shouldSearchForEncountersBySubjectGivenName() {\n+\t\tReferenceParam subjectReference = new ReferenceParam();\n+\t\t\n+\t\tsubjectReference.setValue(PATIENT_GIVEN_NAME);\n+\t\tsubjectReference.setChain(Patient.SP_GIVEN);\n+\t\t\n+\t\tCollection<Encounter> results = dao.searchForEncounters(null, null, null, subjectReference);\n+\t\t\n+\t\tassertThat(results, Matchers.notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.iterator().next().getPatient().getPerson().getPersonName().getGivenName(),\n+\t\t    equalTo(PATIENT_GIVEN_NAME));\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForEncounters_shouldSearchForEncountersBySubjectIdentifier() {\n+\t\tReferenceParam subjectReference = new ReferenceParam();\n+\t\t\n+\t\tsubjectReference.setValue(PATIENT_IDENTIFIER);\n+\t\tsubjectReference.setChain(Patient.SP_IDENTIFIER);\n+\t\t\n+\t\tCollection<Encounter> results = dao.searchForEncounters(null, null, null, subjectReference);\n+\t\t\n+\t\tassertThat(results, Matchers.notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.iterator().next().getPatient().getPatientIdentifier().getIdentifier(),\n \t\t    equalTo(PATIENT_IDENTIFIER));\n \t}\n \t\n \t@Test\n-\tpublic void findEncountersByWrongPatientIdentifier_shouldReturnEmptyCollectionOfEncounters() {\n-\t\tList<Encounter> encounters = dao.findEncountersByPatientIdentifier(WRONG_PATIENT_IDENTIFIER);\n-\t\tassertThat(encounters, notNullValue());\n-\t\tassertThat(encounters, is(empty()));\n+\tpublic void searchForEncounters_shouldReturnEmptyCollectionOfEncountersByWrongSubjectIdentifier() {\n+\t\tReferenceParam subjectReference = new ReferenceParam();\n+\t\t\n+\t\tsubjectReference.setValue(WRONG_PATIENT_IDENTIFIER);\n+\t\tsubjectReference.setChain(Patient.SP_IDENTIFIER);\n+\t\t\n+\t\tCollection<Encounter> results = dao.searchForEncounters(null, null, null, subjectReference);\n+\t\t\n+\t\tassertThat(results, Matchers.notNullValue());\n+\t\tassertThat(results, is(empty()));\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForEncounters_shouldSearchForEncountersByParticipantIdentifier() {\n+\t\tReferenceParam participantReference = new ReferenceParam();\n+\t\t\n+\t\tparticipantReference.setChain(Practitioner.SP_IDENTIFIER);\n+\t\tparticipantReference.setValue(PATIENT_IDENTIFIER);\n+\t\t\n+\t\tCollection<Encounter> results = dao.searchForEncounters(null, null, participantReference, null);\n+\t\t\n+\t\tassertThat(results, Matchers.notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.iterator().next().getEncounterProviders().size(), greaterThanOrEqualTo(1));\n+\t\tassertThat(results.iterator().next().getEncounterProviders().iterator().next().getProvider(), notNullValue());\n+\t\tassertThat(results.iterator().next().getEncounterProviders().iterator().next().getProvider().getIdentifier(),\n+\t\t    equalTo(PARTICIPANT_IDENTIFIER));\n \t}\n \t\n+\t@Test\n+\tpublic void searchForEncounters_shouldSearchForEncountersByParticipantGivenName() {\n+\t\tReferenceParam participantReference = new ReferenceParam();\n+\t\t\n+\t\tparticipantReference.setValue(PARTICIPANT_GIVEN_NAME);\n+\t\tparticipantReference.setChain(Practitioner.SP_GIVEN);\n+\t\t\n+\t\tCollection<Encounter> results = dao.searchForEncounters(null, null, participantReference, null);\n+\t\t\n+\t\tassertThat(results, Matchers.notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.iterator().next().getEncounterProviders().size(), greaterThanOrEqualTo(1));\n+\t\tassertThat(results.iterator().next().getEncounterProviders().iterator().next().getProvider(), notNullValue());\n+\t\tassertThat(results.iterator().next().getEncounterProviders().iterator().next().getProvider().getPerson()\n+\t\t        .getPersonName().getGivenName(),\n+\t\t    equalTo(PARTICIPANT_GIVEN_NAME));\n+\t\t\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForEncounters_shouldSearchForEncountersByParticipantFamilyName() {\n+\t\tReferenceParam participantReference = new ReferenceParam();\n+\t\t\n+\t\tparticipantReference.setValue(PARTICIPANT_FAMILY_NAME);\n+\t\tparticipantReference.setChain(Practitioner.SP_FAMILY);\n+\t\t\n+\t\tCollection<Encounter> results = dao.searchForEncounters(null, null, participantReference, null);\n+\t\t\n+\t\tassertThat(results, Matchers.notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.iterator().next().getEncounterProviders().size(), greaterThanOrEqualTo(1));\n+\t\tassertThat(results.iterator().next().getEncounterProviders().iterator().next().getProvider(), notNullValue());\n+\t\tassertThat(results.iterator().next().getEncounterProviders().iterator().next().getProvider().getPerson()\n+\t\t        .getPersonName().getFamilyName(),\n+\t\t    equalTo(PARTICIPANT_FAMILY_NAME));\n+\t\t\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForEncounters_shouldSearchForEncountersByParticipantName() {", "originalCommit": "5afb7189963f1536dcd3742eac504eb5d2d521bb", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ee11aeee393035fc7a351c44a075cc23ae6fa84b", "chunk": "diff --git a/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirEncounterDaoImplTest.java b/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirEncounterDaoImplTest.java\nindex d4528652..af62759c 100644\n--- a/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirEncounterDaoImplTest.java\n+++ b/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirEncounterDaoImplTest.java\n\n@@ -186,8 +188,8 @@ public class FhirEncounterDaoImplTest extends BaseModuleContextSensitiveTest {\n \tpublic void searchForEncounters_shouldSearchForEncountersByParticipantIdentifier() {\n \t\tReferenceParam participantReference = new ReferenceParam();\n \t\t\n+\t\tparticipantReference.setValue(PARTICIPANT_IDENTIFIER);\n \t\tparticipantReference.setChain(Practitioner.SP_IDENTIFIER);\n-\t\tparticipantReference.setValue(PATIENT_IDENTIFIER);\n \t\t\n \t\tCollection<Encounter> results = dao.searchForEncounters(null, null, participantReference, null);\n \t\t\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDY4MjEwNQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/86#discussion_r384682105", "bodyText": "The constant we use here should be PARTICIPANT_IDENTIFIER even if it has the same value as PATIENT_IDENTIFIER.", "author": "ibacher", "createdAt": "2020-02-26T18:30:53Z", "path": "api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirEncounterDaoImplTest.java", "diffHunk": "@@ -72,21 +100,183 @@ public void shouldReturnNullWithUnknownEncounterUuid() {\n \t}\n \t\n \t@Test\n-\tpublic void findEncountersByPatientIdentifier_shouldReturnCollectionOfEncounters() {\n-\t\tList<Encounter> encounters = dao.findEncountersByPatientIdentifier(PATIENT_IDENTIFIER);\n-\t\tassertThat(encounters, notNullValue());\n-\t\tassertThat(encounters.size(), greaterThanOrEqualTo(1));\n-\t\tassertThat(encounters.stream().findFirst().isPresent(), is(true));\n-\t\tassertThat(encounters.stream().findFirst().get().getPatient(), notNullValue());\n-\t\tassertThat(encounters.stream().findFirst().get().getPatient().getPatientIdentifier().getIdentifier(),\n+\tpublic void searchForEncounters_shouldSearchForEncountersByDate() {\n+\t\tCollection<Encounter> results = dao.searchForEncounters(new DateRangeParam(new DateParam(ENCOUNTER_DATETIME)), null,\n+\t\t    null, null);\n+\t\t\n+\t\tassertThat(results, Matchers.notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.iterator().next().getEncounterDatetime().toString(), equalTo(ENCOUNTER_DATE));\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForEncounters_shouldSearchForEncountersBySubjectName() {\n+\t\tReferenceParam subjectReference = new ReferenceParam();\n+\t\t\n+\t\tsubjectReference.setValue(PATIENT_FULL_NAME);\n+\t\tsubjectReference.setChain(Patient.SP_NAME);\n+\t\t\n+\t\tCollection<Encounter> results = dao.searchForEncounters(null, null, null, subjectReference);\n+\t\t\n+\t\tassertThat(results, Matchers.notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.iterator().next().getPatient().getPerson().getPersonName().getFullName(),\n+\t\t    equalTo(PATIENT_FULL_NAME));\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForEncounters_shouldSearchForEncountersBySubjectFamilyName() {\n+\t\tReferenceParam subjectReference = new ReferenceParam();\n+\t\t\n+\t\tsubjectReference.setValue(PATIENT_FAMILY_NAME);\n+\t\tsubjectReference.setChain(Patient.SP_FAMILY);\n+\t\t\n+\t\tCollection<Encounter> results = dao.searchForEncounters(null, null, null, subjectReference);\n+\t\t\n+\t\tassertThat(results, Matchers.notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.iterator().next().getPatient().getPerson().getPersonName().getFamilyName(),\n+\t\t    equalTo(PATIENT_FAMILY_NAME));\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForEncounters_shouldSearchForEncountersBySubjectGivenName() {\n+\t\tReferenceParam subjectReference = new ReferenceParam();\n+\t\t\n+\t\tsubjectReference.setValue(PATIENT_GIVEN_NAME);\n+\t\tsubjectReference.setChain(Patient.SP_GIVEN);\n+\t\t\n+\t\tCollection<Encounter> results = dao.searchForEncounters(null, null, null, subjectReference);\n+\t\t\n+\t\tassertThat(results, Matchers.notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.iterator().next().getPatient().getPerson().getPersonName().getGivenName(),\n+\t\t    equalTo(PATIENT_GIVEN_NAME));\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForEncounters_shouldSearchForEncountersBySubjectIdentifier() {\n+\t\tReferenceParam subjectReference = new ReferenceParam();\n+\t\t\n+\t\tsubjectReference.setValue(PATIENT_IDENTIFIER);\n+\t\tsubjectReference.setChain(Patient.SP_IDENTIFIER);\n+\t\t\n+\t\tCollection<Encounter> results = dao.searchForEncounters(null, null, null, subjectReference);\n+\t\t\n+\t\tassertThat(results, Matchers.notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.iterator().next().getPatient().getPatientIdentifier().getIdentifier(),\n \t\t    equalTo(PATIENT_IDENTIFIER));\n \t}\n \t\n \t@Test\n-\tpublic void findEncountersByWrongPatientIdentifier_shouldReturnEmptyCollectionOfEncounters() {\n-\t\tList<Encounter> encounters = dao.findEncountersByPatientIdentifier(WRONG_PATIENT_IDENTIFIER);\n-\t\tassertThat(encounters, notNullValue());\n-\t\tassertThat(encounters, is(empty()));\n+\tpublic void searchForEncounters_shouldReturnEmptyCollectionOfEncountersByWrongSubjectIdentifier() {\n+\t\tReferenceParam subjectReference = new ReferenceParam();\n+\t\t\n+\t\tsubjectReference.setValue(WRONG_PATIENT_IDENTIFIER);\n+\t\tsubjectReference.setChain(Patient.SP_IDENTIFIER);\n+\t\t\n+\t\tCollection<Encounter> results = dao.searchForEncounters(null, null, null, subjectReference);\n+\t\t\n+\t\tassertThat(results, Matchers.notNullValue());\n+\t\tassertThat(results, is(empty()));\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForEncounters_shouldSearchForEncountersByParticipantIdentifier() {\n+\t\tReferenceParam participantReference = new ReferenceParam();\n+\t\t\n+\t\tparticipantReference.setChain(Practitioner.SP_IDENTIFIER);\n+\t\tparticipantReference.setValue(PATIENT_IDENTIFIER);", "originalCommit": "5afb7189963f1536dcd3742eac504eb5d2d521bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDY4Mzg2Nw==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/86#discussion_r384683867", "bodyText": "Also remember that the chain property needs to be set after the value.", "author": "ibacher", "createdAt": "2020-02-26T18:33:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDY4MjEwNQ=="}], "type": "inlineReview", "revised_code": {"commit": "ee11aeee393035fc7a351c44a075cc23ae6fa84b", "chunk": "diff --git a/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirEncounterDaoImplTest.java b/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirEncounterDaoImplTest.java\nindex d4528652..af62759c 100644\n--- a/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirEncounterDaoImplTest.java\n+++ b/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirEncounterDaoImplTest.java\n\n@@ -186,8 +188,8 @@ public class FhirEncounterDaoImplTest extends BaseModuleContextSensitiveTest {\n \tpublic void searchForEncounters_shouldSearchForEncountersByParticipantIdentifier() {\n \t\tReferenceParam participantReference = new ReferenceParam();\n \t\t\n+\t\tparticipantReference.setValue(PARTICIPANT_IDENTIFIER);\n \t\tparticipantReference.setChain(Practitioner.SP_IDENTIFIER);\n-\t\tparticipantReference.setValue(PATIENT_IDENTIFIER);\n \t\t\n \t\tCollection<Encounter> results = dao.searchForEncounters(null, null, participantReference, null);\n \t\t\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDY4MjQyNQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/86#discussion_r384682425", "bodyText": "This constant should be PRACTITIONER_FULL_NAME even if it has the same value as PATIENT_FULL_NAME", "author": "ibacher", "createdAt": "2020-02-26T18:31:29Z", "path": "api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirEncounterDaoImplTest.java", "diffHunk": "@@ -72,21 +100,183 @@ public void shouldReturnNullWithUnknownEncounterUuid() {\n \t}\n \t\n \t@Test\n-\tpublic void findEncountersByPatientIdentifier_shouldReturnCollectionOfEncounters() {\n-\t\tList<Encounter> encounters = dao.findEncountersByPatientIdentifier(PATIENT_IDENTIFIER);\n-\t\tassertThat(encounters, notNullValue());\n-\t\tassertThat(encounters.size(), greaterThanOrEqualTo(1));\n-\t\tassertThat(encounters.stream().findFirst().isPresent(), is(true));\n-\t\tassertThat(encounters.stream().findFirst().get().getPatient(), notNullValue());\n-\t\tassertThat(encounters.stream().findFirst().get().getPatient().getPatientIdentifier().getIdentifier(),\n+\tpublic void searchForEncounters_shouldSearchForEncountersByDate() {\n+\t\tCollection<Encounter> results = dao.searchForEncounters(new DateRangeParam(new DateParam(ENCOUNTER_DATETIME)), null,\n+\t\t    null, null);\n+\t\t\n+\t\tassertThat(results, Matchers.notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.iterator().next().getEncounterDatetime().toString(), equalTo(ENCOUNTER_DATE));\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForEncounters_shouldSearchForEncountersBySubjectName() {\n+\t\tReferenceParam subjectReference = new ReferenceParam();\n+\t\t\n+\t\tsubjectReference.setValue(PATIENT_FULL_NAME);\n+\t\tsubjectReference.setChain(Patient.SP_NAME);\n+\t\t\n+\t\tCollection<Encounter> results = dao.searchForEncounters(null, null, null, subjectReference);\n+\t\t\n+\t\tassertThat(results, Matchers.notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.iterator().next().getPatient().getPerson().getPersonName().getFullName(),\n+\t\t    equalTo(PATIENT_FULL_NAME));\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForEncounters_shouldSearchForEncountersBySubjectFamilyName() {\n+\t\tReferenceParam subjectReference = new ReferenceParam();\n+\t\t\n+\t\tsubjectReference.setValue(PATIENT_FAMILY_NAME);\n+\t\tsubjectReference.setChain(Patient.SP_FAMILY);\n+\t\t\n+\t\tCollection<Encounter> results = dao.searchForEncounters(null, null, null, subjectReference);\n+\t\t\n+\t\tassertThat(results, Matchers.notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.iterator().next().getPatient().getPerson().getPersonName().getFamilyName(),\n+\t\t    equalTo(PATIENT_FAMILY_NAME));\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForEncounters_shouldSearchForEncountersBySubjectGivenName() {\n+\t\tReferenceParam subjectReference = new ReferenceParam();\n+\t\t\n+\t\tsubjectReference.setValue(PATIENT_GIVEN_NAME);\n+\t\tsubjectReference.setChain(Patient.SP_GIVEN);\n+\t\t\n+\t\tCollection<Encounter> results = dao.searchForEncounters(null, null, null, subjectReference);\n+\t\t\n+\t\tassertThat(results, Matchers.notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.iterator().next().getPatient().getPerson().getPersonName().getGivenName(),\n+\t\t    equalTo(PATIENT_GIVEN_NAME));\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForEncounters_shouldSearchForEncountersBySubjectIdentifier() {\n+\t\tReferenceParam subjectReference = new ReferenceParam();\n+\t\t\n+\t\tsubjectReference.setValue(PATIENT_IDENTIFIER);\n+\t\tsubjectReference.setChain(Patient.SP_IDENTIFIER);\n+\t\t\n+\t\tCollection<Encounter> results = dao.searchForEncounters(null, null, null, subjectReference);\n+\t\t\n+\t\tassertThat(results, Matchers.notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.iterator().next().getPatient().getPatientIdentifier().getIdentifier(),\n \t\t    equalTo(PATIENT_IDENTIFIER));\n \t}\n \t\n \t@Test\n-\tpublic void findEncountersByWrongPatientIdentifier_shouldReturnEmptyCollectionOfEncounters() {\n-\t\tList<Encounter> encounters = dao.findEncountersByPatientIdentifier(WRONG_PATIENT_IDENTIFIER);\n-\t\tassertThat(encounters, notNullValue());\n-\t\tassertThat(encounters, is(empty()));\n+\tpublic void searchForEncounters_shouldReturnEmptyCollectionOfEncountersByWrongSubjectIdentifier() {\n+\t\tReferenceParam subjectReference = new ReferenceParam();\n+\t\t\n+\t\tsubjectReference.setValue(WRONG_PATIENT_IDENTIFIER);\n+\t\tsubjectReference.setChain(Patient.SP_IDENTIFIER);\n+\t\t\n+\t\tCollection<Encounter> results = dao.searchForEncounters(null, null, null, subjectReference);\n+\t\t\n+\t\tassertThat(results, Matchers.notNullValue());\n+\t\tassertThat(results, is(empty()));\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForEncounters_shouldSearchForEncountersByParticipantIdentifier() {\n+\t\tReferenceParam participantReference = new ReferenceParam();\n+\t\t\n+\t\tparticipantReference.setChain(Practitioner.SP_IDENTIFIER);\n+\t\tparticipantReference.setValue(PATIENT_IDENTIFIER);\n+\t\t\n+\t\tCollection<Encounter> results = dao.searchForEncounters(null, null, participantReference, null);\n+\t\t\n+\t\tassertThat(results, Matchers.notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.iterator().next().getEncounterProviders().size(), greaterThanOrEqualTo(1));\n+\t\tassertThat(results.iterator().next().getEncounterProviders().iterator().next().getProvider(), notNullValue());\n+\t\tassertThat(results.iterator().next().getEncounterProviders().iterator().next().getProvider().getIdentifier(),\n+\t\t    equalTo(PARTICIPANT_IDENTIFIER));\n \t}\n \t\n+\t@Test\n+\tpublic void searchForEncounters_shouldSearchForEncountersByParticipantGivenName() {\n+\t\tReferenceParam participantReference = new ReferenceParam();\n+\t\t\n+\t\tparticipantReference.setValue(PARTICIPANT_GIVEN_NAME);\n+\t\tparticipantReference.setChain(Practitioner.SP_GIVEN);\n+\t\t\n+\t\tCollection<Encounter> results = dao.searchForEncounters(null, null, participantReference, null);\n+\t\t\n+\t\tassertThat(results, Matchers.notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.iterator().next().getEncounterProviders().size(), greaterThanOrEqualTo(1));\n+\t\tassertThat(results.iterator().next().getEncounterProviders().iterator().next().getProvider(), notNullValue());\n+\t\tassertThat(results.iterator().next().getEncounterProviders().iterator().next().getProvider().getPerson()\n+\t\t        .getPersonName().getGivenName(),\n+\t\t    equalTo(PARTICIPANT_GIVEN_NAME));\n+\t\t\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForEncounters_shouldSearchForEncountersByParticipantFamilyName() {\n+\t\tReferenceParam participantReference = new ReferenceParam();\n+\t\t\n+\t\tparticipantReference.setValue(PARTICIPANT_FAMILY_NAME);\n+\t\tparticipantReference.setChain(Practitioner.SP_FAMILY);\n+\t\t\n+\t\tCollection<Encounter> results = dao.searchForEncounters(null, null, participantReference, null);\n+\t\t\n+\t\tassertThat(results, Matchers.notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.iterator().next().getEncounterProviders().size(), greaterThanOrEqualTo(1));\n+\t\tassertThat(results.iterator().next().getEncounterProviders().iterator().next().getProvider(), notNullValue());\n+\t\tassertThat(results.iterator().next().getEncounterProviders().iterator().next().getProvider().getPerson()\n+\t\t        .getPersonName().getFamilyName(),\n+\t\t    equalTo(PARTICIPANT_FAMILY_NAME));\n+\t\t\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForEncounters_shouldSearchForEncountersByParticipantName() {\n+\t\tReferenceParam subjectReference = new ReferenceParam();\n+\t\t\n+\t\tsubjectReference.setValue(PATIENT_FULL_NAME);", "originalCommit": "5afb7189963f1536dcd3742eac504eb5d2d521bb", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ee11aeee393035fc7a351c44a075cc23ae6fa84b", "chunk": "diff --git a/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirEncounterDaoImplTest.java b/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirEncounterDaoImplTest.java\nindex d4528652..af62759c 100644\n--- a/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirEncounterDaoImplTest.java\n+++ b/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirEncounterDaoImplTest.java\n\n@@ -186,8 +188,8 @@ public class FhirEncounterDaoImplTest extends BaseModuleContextSensitiveTest {\n \tpublic void searchForEncounters_shouldSearchForEncountersByParticipantIdentifier() {\n \t\tReferenceParam participantReference = new ReferenceParam();\n \t\t\n+\t\tparticipantReference.setValue(PARTICIPANT_IDENTIFIER);\n \t\tparticipantReference.setChain(Practitioner.SP_IDENTIFIER);\n-\t\tparticipantReference.setValue(PATIENT_IDENTIFIER);\n \t\t\n \t\tCollection<Encounter> results = dao.searchForEncounters(null, null, participantReference, null);\n \t\t\n"}}, {"oid": "ee11aeee393035fc7a351c44a075cc23ae6fa84b", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/ee11aeee393035fc7a351c44a075cc23ae6fa84b", "message": "names in tests corrected", "committedDate": "2020-02-26T19:05:14Z", "type": "commit"}]}