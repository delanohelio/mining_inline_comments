{"pr_number": 179, "pr_title": "FM2-145: Add display property to concept translator with translations", "pr_createdAt": "2020-05-20T11:07:27Z", "pr_url": "https://github.com/openmrs/openmrs-module-fhir2/pull/179", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM4MTc0OQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/179#discussion_r429381749", "bodyText": "It's stored in the user_property table with the user_id equal to the user_id and the property equal to defaultLocale (OpenmrsConstants.USER_PROPERTY_DEFAULT_LOCALE). Of course, the difficult thing is \"how do we know who the current user is\". Unfortunately, this information is stored in a ThreadLocal object stored in Context...", "author": "ibacher", "createdAt": "2020-05-22T17:54:48Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/impl/FhirUserDefaultPropertiesImpl.java", "diffHunk": "@@ -0,0 +1,45 @@\n+/*\n+ * This Source Code Form is subject to the terms of the Mozilla Public License,\n+ * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n+ * obtain one at http://mozilla.org/MPL/2.0/. OpenMRS is also distributed under\n+ * the terms of the Healthcare Disclaimer located at http://openmrs.org/license.\n+ *\n+ * Copyright (C) OpenMRS Inc. OpenMRS is a registered trademark and the OpenMRS\n+ * graphic logo is a trademark of OpenMRS Inc.\n+ */\n+package org.openmrs.module.fhir2.api.impl;\n+\n+import java.util.Locale;\n+\n+import lombok.AccessLevel;\n+import lombok.Setter;\n+import lombok.extern.slf4j.Slf4j;\n+import org.openmrs.module.fhir2.api.FhirGlobalPropertyService;\n+import org.openmrs.module.fhir2.api.FhirUserDefaultProperties;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Component;\n+import org.springframework.transaction.annotation.Transactional;\n+\n+@Slf4j\n+@Component\n+@Transactional\n+@Setter(AccessLevel.PACKAGE)\n+public class FhirUserDefaultPropertiesImpl implements FhirUserDefaultProperties {\n+\t\n+\t@Autowired\n+\tprivate FhirGlobalPropertyService globalPropertyService;\n+\t\n+\t@Override\n+\tpublic Locale getDefaultLocale() {\n+\t\t// TODO find a way of getting userLocale without relying on context\n+\t\t// return Context.getLocale();", "originalCommit": "da2bd1c2d85bb2ada2260f540be6e0b3ff14169f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM5MzQxMg==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/179#discussion_r429393412", "bodyText": "The one place we could kind of get access to the current user is in the AuthenticationFilter.", "author": "ibacher", "createdAt": "2020-05-22T18:23:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM4MTc0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDI0MzY0NQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/179#discussion_r430243645", "bodyText": "Or Context.getAuthenticatedUser(). I know using Context or UserContext is the last thing we need.", "author": "corneliouzbett", "createdAt": "2020-05-26T08:30:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM4MTc0OQ=="}], "type": "inlineReview", "revised_code": {"commit": "14f5f818265baebfd4dd23816d079706ed490ea6", "chunk": "diff --git a/api/src/main/java/org/openmrs/module/fhir2/api/impl/FhirUserDefaultPropertiesImpl.java b/api/src/main/java/org/openmrs/module/fhir2/api/impl/FhirUserDefaultPropertiesImpl.java\nindex 1fb92035..3f7345fb 100644\n--- a/api/src/main/java/org/openmrs/module/fhir2/api/impl/FhirUserDefaultPropertiesImpl.java\n+++ b/api/src/main/java/org/openmrs/module/fhir2/api/impl/FhirUserDefaultPropertiesImpl.java\n\n@@ -31,15 +31,9 @@ public class FhirUserDefaultPropertiesImpl implements FhirUserDefaultProperties\n \t\n \t@Override\n \tpublic Locale getDefaultLocale() {\n-\t\t// TODO find a way of getting userLocale without relying on context\n-\t\t// return Context.getLocale();\n \t\tString locale = globalPropertyService.getGlobalProperty(\"default_locale\", \"en_GB\");\n-\t\tif (locale.contains(\"_\")) {\n-\t\t\tString[] langRegion = locale.split(\"_\");\n-\t\t\tlog.info(\"Language :\" + langRegion[0]);\n-\t\t\tlog.info(\"Region :\" + langRegion[1]);\n-\t\t\treturn new Locale.Builder().setLanguage(langRegion[0]).setRegion(langRegion[1]).build();\n-\t\t}\n-\t\treturn new Locale.Builder().setLanguage(locale).build();\n+\t\tlocale = locale.replace(\"_\", \"-\");\n+\t\t\n+\t\treturn new Locale.Builder().setLanguageTag(locale).build();\n \t}\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM4NDYzMQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/179#discussion_r429384631", "bodyText": "I'd suggest that rather than doing this, we replace the _ with - and call Locale.forLanguageTag() with the resulting string. The reason is that this way we can support a much wider range of locales than is possible if we assume this rather narrow format.", "author": "ibacher", "createdAt": "2020-05-22T18:01:48Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/impl/FhirUserDefaultPropertiesImpl.java", "diffHunk": "@@ -0,0 +1,45 @@\n+/*\n+ * This Source Code Form is subject to the terms of the Mozilla Public License,\n+ * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n+ * obtain one at http://mozilla.org/MPL/2.0/. OpenMRS is also distributed under\n+ * the terms of the Healthcare Disclaimer located at http://openmrs.org/license.\n+ *\n+ * Copyright (C) OpenMRS Inc. OpenMRS is a registered trademark and the OpenMRS\n+ * graphic logo is a trademark of OpenMRS Inc.\n+ */\n+package org.openmrs.module.fhir2.api.impl;\n+\n+import java.util.Locale;\n+\n+import lombok.AccessLevel;\n+import lombok.Setter;\n+import lombok.extern.slf4j.Slf4j;\n+import org.openmrs.module.fhir2.api.FhirGlobalPropertyService;\n+import org.openmrs.module.fhir2.api.FhirUserDefaultProperties;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Component;\n+import org.springframework.transaction.annotation.Transactional;\n+\n+@Slf4j\n+@Component\n+@Transactional\n+@Setter(AccessLevel.PACKAGE)\n+public class FhirUserDefaultPropertiesImpl implements FhirUserDefaultProperties {\n+\t\n+\t@Autowired\n+\tprivate FhirGlobalPropertyService globalPropertyService;\n+\t\n+\t@Override\n+\tpublic Locale getDefaultLocale() {\n+\t\t// TODO find a way of getting userLocale without relying on context\n+\t\t// return Context.getLocale();\n+\t\tString locale = globalPropertyService.getGlobalProperty(\"default_locale\", \"en_GB\");\n+\t\tif (locale.contains(\"_\")) {\n+\t\t\tString[] langRegion = locale.split(\"_\");\n+\t\t\tlog.info(\"Language :\" + langRegion[0]);\n+\t\t\tlog.info(\"Region :\" + langRegion[1]);\n+\t\t\treturn new Locale.Builder().setLanguage(langRegion[0]).setRegion(langRegion[1]).build();", "originalCommit": "da2bd1c2d85bb2ada2260f540be6e0b3ff14169f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "14f5f818265baebfd4dd23816d079706ed490ea6", "chunk": "diff --git a/api/src/main/java/org/openmrs/module/fhir2/api/impl/FhirUserDefaultPropertiesImpl.java b/api/src/main/java/org/openmrs/module/fhir2/api/impl/FhirUserDefaultPropertiesImpl.java\nindex 1fb92035..3f7345fb 100644\n--- a/api/src/main/java/org/openmrs/module/fhir2/api/impl/FhirUserDefaultPropertiesImpl.java\n+++ b/api/src/main/java/org/openmrs/module/fhir2/api/impl/FhirUserDefaultPropertiesImpl.java\n\n@@ -31,15 +31,9 @@ public class FhirUserDefaultPropertiesImpl implements FhirUserDefaultProperties\n \t\n \t@Override\n \tpublic Locale getDefaultLocale() {\n-\t\t// TODO find a way of getting userLocale without relying on context\n-\t\t// return Context.getLocale();\n \t\tString locale = globalPropertyService.getGlobalProperty(\"default_locale\", \"en_GB\");\n-\t\tif (locale.contains(\"_\")) {\n-\t\t\tString[] langRegion = locale.split(\"_\");\n-\t\t\tlog.info(\"Language :\" + langRegion[0]);\n-\t\t\tlog.info(\"Region :\" + langRegion[1]);\n-\t\t\treturn new Locale.Builder().setLanguage(langRegion[0]).setRegion(langRegion[1]).build();\n-\t\t}\n-\t\treturn new Locale.Builder().setLanguage(locale).build();\n+\t\tlocale = locale.replace(\"_\", \"-\");\n+\t\t\n+\t\treturn new Locale.Builder().setLanguageTag(locale).build();\n \t}\n }\n"}}, {"oid": "14f5f818265baebfd4dd23816d079706ed490ea6", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/14f5f818265baebfd4dd23816d079706ed490ea6", "message": "FM2-145: Adding display property to coding with translations", "committedDate": "2020-05-29T05:46:50Z", "type": "commit"}, {"oid": "14f5f818265baebfd4dd23816d079706ed490ea6", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/14f5f818265baebfd4dd23816d079706ed490ea6", "message": "FM2-145: Adding display property to coding with translations", "committedDate": "2020-05-29T05:46:50Z", "type": "forcePushed"}]}