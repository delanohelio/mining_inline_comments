{"pr_number": 77, "pr_title": "FM2-75 Address gaps in supported elements for DiagnosticReport, Task, and ServiceRequest ", "pr_createdAt": "2020-02-20T06:10:48Z", "pr_url": "https://github.com/openmrs/openmrs-module-fhir2/pull/77", "timeline": [{"oid": "2afe6eea2d0eb3049683129faafe441910a3eeef", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/2afe6eea2d0eb3049683129faafe441910a3eeef", "message": "Implemented required Task, ServiceRequest,\nand DiagnosticReport translations for FM2-75", "committedDate": "2020-02-24T06:46:02Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzMyMDk5NA==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/77#discussion_r383320994", "bodyText": "Change this to anything else. Even \"for_\" will work.", "author": "ibacher", "createdAt": "2020-02-24T15:10:13Z", "path": "api/src/main/java/org/openmrs/module/fhir2/FhirTask.java", "diffHunk": "@@ -71,20 +71,47 @@\n \t * Referenced resources represented with relative resource identifier string in the format of\n \t * <ResourceName>/<ResourceId>.\n \t */\n+\t@ElementCollection\n+\t@CollectionTable(name = \"fhir_task_based_on\", joinColumns = @JoinColumn(name = \"task_id\"))\n \t@Column(name = \"based_on\")\n-\tprivate String basedOn;\n+\tprivate Collection<String> basedOnReferences;\n+\t\n+\t/**\n+\t * Referenced resources represented with relative resource identifier string in the format of\n+\t * <ResourceName>/<ResourceId>.\n+\t */\n+\t@Column(name = \"for\")", "originalCommit": "2afe6eea2d0eb3049683129faafe441910a3eeef", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bbf43a264560746f09686f02c80a883dc6c9bf06", "chunk": "diff --git a/api/src/main/java/org/openmrs/module/fhir2/FhirTask.java b/api/src/main/java/org/openmrs/module/fhir2/FhirTask.java\nindex 84e339a6..c17fc9a5 100644\n--- a/api/src/main/java/org/openmrs/module/fhir2/FhirTask.java\n+++ b/api/src/main/java/org/openmrs/module/fhir2/FhirTask.java\n\n@@ -68,50 +69,33 @@ public class FhirTask extends BaseOpenmrsData {\n \tprivate TaskIntent intent;\n \t\n \t/**\n-\t * Referenced resources represented with relative resource identifier string in the format of\n-\t * <ResourceName>/<ResourceId>.\n+\t * BasedOn refers to a higher-level authorization that triggered the creation of the task. It\n+\t * references a \"request\" resource such as a ServiceRequest, MedicationRequest, ServiceRequest,\n+\t * CarePlan, etc. which is distinct from the \"request\" resource the task is seeking to fulfill. This\n+\t * latter resource is referenced by FocusOn. For example, based on a ServiceRequest (= BasedOn), a\n+\t * task is created to fulfill a procedureRequest ( = FocusOn ) to collect a specimen from a patient.\n \t */\n-\t@ElementCollection\n-\t@CollectionTable(name = \"fhir_task_based_on\", joinColumns = @JoinColumn(name = \"task_id\"))\n-\t@Column(name = \"based_on\")\n-\tprivate Collection<String> basedOnReferences;\n+\t@OneToMany(cascade = CascadeType.ALL)\n+\t@JoinColumn(name = \"based_on_reference_id\", referencedColumnName = \"reference_id\")\n+\tprivate Collection<FhirReference> basedOnReferences;\n \t\n-\t/**\n-\t * Referenced resources represented with relative resource identifier string in the format of\n-\t * <ResourceName>/<ResourceId>.\n-\t */\n-\t@Column(name = \"for\")\n-\tprivate String forReference;\n+\t@OneToOne(cascade = CascadeType.ALL)\n+\t@JoinColumn(name = \"for_reference_id\", referencedColumnName = \"reference_id\")\n+\tprivate FhirReference forReference;\n \t\n-\t/**\n-\t * Referenced resources represented with relative resource identifier string in the format of\n-\t * <ResourceName>/<ResourceId>.\n-\t */\n-\t@Column(name = \"encounter\")\n-\tprivate String encounterReference;\n+\t@OneToOne(cascade = CascadeType.ALL)\n+\t@JoinColumn(name = \"encounter_reference_id\", referencedColumnName = \"reference_id\")\n+\tprivate FhirReference encounterReference;\n \t\n-\t/**\n-\t * Referenced resources represented with relative resource identifier string in the format of\n-\t * <ResourceName>/<ResourceId>.\n-\t */\n-\t@Column(name = \"owner\")\n-\tprivate String ownerReference;\n+\t@OneToOne(cascade = CascadeType.ALL)\n+\t@JoinColumn(name = \"owner_reference_id\", referencedColumnName = \"reference_id\")\n+\tprivate FhirReference ownerReference;\n \t\n-\t/**\n-\t * Referenced resources represented with relative resource identifier string in the format of\n-\t * <ResourceName>/<ResourceId>.\n-\t */\n-\t@ElementCollection\n-\t@CollectionTable(name = \"fhir_task_inputs\", joinColumns = @JoinColumn(name = \"task_id\"))\n-\t@Column(name = \"input\")\n-\tprivate Collection<String> inputReferences;\n+\t@OneToMany(cascade = CascadeType.ALL)\n+\t@JoinColumn(name = \"task_id\")\n+\tprivate Collection<FhirTaskInput> input;\n \t\n-\t/**\n-\t * Referenced resources represented with relative resource identifier string in the format of\n-\t * <ResourceName>/<ResourceId>.\n-\t */\n-\t@ElementCollection\n-\t@CollectionTable(name = \"fhir_task_outputs\", joinColumns = @JoinColumn(name = \"task_id\"))\n-\t@Column(name = \"output\")\n-\tprivate Collection<String> outputReferences;\n+\t@OneToMany(cascade = CascadeType.ALL)\n+\t@JoinColumn(name = \"task_id\")\n+\tprivate Collection<FhirTaskOutput> output;\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzMyMjIzMA==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/77#discussion_r383322230", "bodyText": "Might it be worth it to create our own Reference type that's marked as @Embedded or similar that can handle parsing the reference properly?", "author": "ibacher", "createdAt": "2020-02-24T15:12:16Z", "path": "api/src/main/java/org/openmrs/module/fhir2/FhirTask.java", "diffHunk": "@@ -71,20 +71,47 @@\n \t * Referenced resources represented with relative resource identifier string in the format of\n \t * <ResourceName>/<ResourceId>.\n \t */\n+\t@ElementCollection\n+\t@CollectionTable(name = \"fhir_task_based_on\", joinColumns = @JoinColumn(name = \"task_id\"))\n \t@Column(name = \"based_on\")\n-\tprivate String basedOn;\n+\tprivate Collection<String> basedOnReferences;\n+\t\n+\t/**\n+\t * Referenced resources represented with relative resource identifier string in the format of\n+\t * <ResourceName>/<ResourceId>.\n+\t */\n+\t@Column(name = \"for\")\n+\tprivate String forReference;", "originalCommit": "2afe6eea2d0eb3049683129faafe441910a3eeef", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bbf43a264560746f09686f02c80a883dc6c9bf06", "chunk": "diff --git a/api/src/main/java/org/openmrs/module/fhir2/FhirTask.java b/api/src/main/java/org/openmrs/module/fhir2/FhirTask.java\nindex 84e339a6..c17fc9a5 100644\n--- a/api/src/main/java/org/openmrs/module/fhir2/FhirTask.java\n+++ b/api/src/main/java/org/openmrs/module/fhir2/FhirTask.java\n\n@@ -68,50 +69,33 @@ public class FhirTask extends BaseOpenmrsData {\n \tprivate TaskIntent intent;\n \t\n \t/**\n-\t * Referenced resources represented with relative resource identifier string in the format of\n-\t * <ResourceName>/<ResourceId>.\n+\t * BasedOn refers to a higher-level authorization that triggered the creation of the task. It\n+\t * references a \"request\" resource such as a ServiceRequest, MedicationRequest, ServiceRequest,\n+\t * CarePlan, etc. which is distinct from the \"request\" resource the task is seeking to fulfill. This\n+\t * latter resource is referenced by FocusOn. For example, based on a ServiceRequest (= BasedOn), a\n+\t * task is created to fulfill a procedureRequest ( = FocusOn ) to collect a specimen from a patient.\n \t */\n-\t@ElementCollection\n-\t@CollectionTable(name = \"fhir_task_based_on\", joinColumns = @JoinColumn(name = \"task_id\"))\n-\t@Column(name = \"based_on\")\n-\tprivate Collection<String> basedOnReferences;\n+\t@OneToMany(cascade = CascadeType.ALL)\n+\t@JoinColumn(name = \"based_on_reference_id\", referencedColumnName = \"reference_id\")\n+\tprivate Collection<FhirReference> basedOnReferences;\n \t\n-\t/**\n-\t * Referenced resources represented with relative resource identifier string in the format of\n-\t * <ResourceName>/<ResourceId>.\n-\t */\n-\t@Column(name = \"for\")\n-\tprivate String forReference;\n+\t@OneToOne(cascade = CascadeType.ALL)\n+\t@JoinColumn(name = \"for_reference_id\", referencedColumnName = \"reference_id\")\n+\tprivate FhirReference forReference;\n \t\n-\t/**\n-\t * Referenced resources represented with relative resource identifier string in the format of\n-\t * <ResourceName>/<ResourceId>.\n-\t */\n-\t@Column(name = \"encounter\")\n-\tprivate String encounterReference;\n+\t@OneToOne(cascade = CascadeType.ALL)\n+\t@JoinColumn(name = \"encounter_reference_id\", referencedColumnName = \"reference_id\")\n+\tprivate FhirReference encounterReference;\n \t\n-\t/**\n-\t * Referenced resources represented with relative resource identifier string in the format of\n-\t * <ResourceName>/<ResourceId>.\n-\t */\n-\t@Column(name = \"owner\")\n-\tprivate String ownerReference;\n+\t@OneToOne(cascade = CascadeType.ALL)\n+\t@JoinColumn(name = \"owner_reference_id\", referencedColumnName = \"reference_id\")\n+\tprivate FhirReference ownerReference;\n \t\n-\t/**\n-\t * Referenced resources represented with relative resource identifier string in the format of\n-\t * <ResourceName>/<ResourceId>.\n-\t */\n-\t@ElementCollection\n-\t@CollectionTable(name = \"fhir_task_inputs\", joinColumns = @JoinColumn(name = \"task_id\"))\n-\t@Column(name = \"input\")\n-\tprivate Collection<String> inputReferences;\n+\t@OneToMany(cascade = CascadeType.ALL)\n+\t@JoinColumn(name = \"task_id\")\n+\tprivate Collection<FhirTaskInput> input;\n \t\n-\t/**\n-\t * Referenced resources represented with relative resource identifier string in the format of\n-\t * <ResourceName>/<ResourceId>.\n-\t */\n-\t@ElementCollection\n-\t@CollectionTable(name = \"fhir_task_outputs\", joinColumns = @JoinColumn(name = \"task_id\"))\n-\t@Column(name = \"output\")\n-\tprivate Collection<String> outputReferences;\n+\t@OneToMany(cascade = CascadeType.ALL)\n+\t@JoinColumn(name = \"task_id\")\n+\tprivate Collection<FhirTaskOutput> output;\n }\n"}}, {"oid": "bbf43a264560746f09686f02c80a883dc6c9bf06", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/bbf43a264560746f09686f02c80a883dc6c9bf06", "message": "FM2-75 Address gaps for Lab workflow in DiagnosticReport, Task, and ServiceRequest.", "committedDate": "2020-02-24T17:37:08Z", "type": "forcePushed"}, {"oid": "b053ba200a375e2f66770d53667c786c27c10563", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/b053ba200a375e2f66770d53667c786c27c10563", "message": "FM2-75 Address gaps for Lab workflow in DiagnosticReport, Task, and ServiceRequest.", "committedDate": "2020-02-24T18:47:11Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzg4NzkwNw==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/77#discussion_r383887907", "bodyText": "I think you need to add referencedColumnName", "author": "ibacher", "createdAt": "2020-02-25T13:48:05Z", "path": "api/src/main/java/org/openmrs/module/fhir2/FhirTask.java", "diffHunk": "@@ -68,23 +69,33 @@\n \tprivate TaskIntent intent;\n \t\n \t/**\n-\t * Referenced resources represented with relative resource identifier string in the format of\n-\t * <ResourceName>/<ResourceId>.\n+\t * BasedOn refers to a higher-level authorization that triggered the creation of the task. It\n+\t * references a \"request\" resource such as a ServiceRequest, MedicationRequest, ServiceRequest,\n+\t * CarePlan, etc. which is distinct from the \"request\" resource the task is seeking to fulfill. This\n+\t * latter resource is referenced by FocusOn. For example, based on a ServiceRequest (= BasedOn), a\n+\t * task is created to fulfill a procedureRequest ( = FocusOn ) to collect a specimen from a patient.\n \t */\n-\t@Column(name = \"based_on\")\n-\tprivate String basedOn;\n+\t@OneToMany(cascade = CascadeType.ALL)\n+\t@JoinColumn(name = \"based_on_reference_id\", referencedColumnName = \"reference_id\")\n+\tprivate Collection<FhirReference> basedOnReferences;\n \t\n-\t@ElementCollection\n-\t@CollectionTable(name = \"fhir_task_inputs\", joinColumns = @JoinColumn(name = \"task_input_id\"))\n-\t@Column(name = \"input\")\n-\tprivate Collection<String> inputs;\n+\t@OneToOne(cascade = CascadeType.ALL)\n+\t@JoinColumn(name = \"for_reference_id\", referencedColumnName = \"reference_id\")\n+\tprivate FhirReference forReference;\n \t\n-\t@ElementCollection\n-\t@CollectionTable(name = \"fhir_task_outputs\", joinColumns = @JoinColumn(name = \"task_output_id\"))\n-\t@Column(name = \"output\")\n-\tprivate Collection<String> outputs;\n+\t@OneToOne(cascade = CascadeType.ALL)\n+\t@JoinColumn(name = \"encounter_reference_id\", referencedColumnName = \"reference_id\")\n+\tprivate FhirReference encounterReference;\n \t\n-\t@Column(name = \"description\")\n-\tprivate String description;\n+\t@OneToOne(cascade = CascadeType.ALL)\n+\t@JoinColumn(name = \"owner_reference_id\", referencedColumnName = \"reference_id\")\n+\tprivate FhirReference ownerReference;\n \t\n+\t@OneToMany(cascade = CascadeType.ALL)\n+\t@JoinColumn(name = \"task_id\")", "originalCommit": "b053ba200a375e2f66770d53667c786c27c10563", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "4385da0cfd96ed35c126b47f55b39f2cc2d4b825", "chunk": "diff --git a/api/src/main/java/org/openmrs/module/fhir2/FhirTask.java b/api/src/main/java/org/openmrs/module/fhir2/FhirTask.java\nindex c17fc9a5..bb492d51 100644\n--- a/api/src/main/java/org/openmrs/module/fhir2/FhirTask.java\n+++ b/api/src/main/java/org/openmrs/module/fhir2/FhirTask.java\n\n@@ -57,13 +59,23 @@ public class FhirTask extends BaseOpenmrsData {\n \t@Column(name = \"task_id\")\n \tprivate Integer id;\n \t\n+\t/**\n+\t * The current status of the task.\n+\t */\n \t@Column(name = \"status\")\n \t@Enumerated(EnumType.STRING)\n \tprivate TaskStatus status;\n \t\n+\t/**\n+\t * An explanation as to why this task is held, failed, was refused, etc.\n+\t */\n \t@Column(name = \"status_reason\")\n \tprivate String statusReason;\n \t\n+\t/**\n+\t * Indicates the \"level\" of actionability associated with the Task, i.e. i+R[9]Cs this a proposed\n+\t * task, a planned task, an actionable task, etc.\n+\t */\n \t@Column(name = \"intent\")\n \t@Enumerated(EnumType.STRING)\n \tprivate TaskIntent intent;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzg4ODEzNw==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/77#discussion_r383888137", "bodyText": "This should almost certainly be @OneToMany", "author": "ibacher", "createdAt": "2020-02-25T13:48:26Z", "path": "api/src/main/java/org/openmrs/module/fhir2/FhirTaskParam.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/*\n+ * This Source Code Form is subject to the terms of the Mozilla Public License,\n+ * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n+ * obtain one at http://mozilla.org/MPL/2.0/. OpenMRS is also distributed under\n+ * the terms of the Healthcare Disclaimer located at http://openmrs.org/license.\n+ *\n+ * Copyright (C) OpenMRS Inc. OpenMRS is a registered trademark and the OpenMRS\n+ * graphic logo is a trademark of OpenMRS Inc.\n+ */\n+package org.openmrs.module.fhir2;\n+\n+import javax.persistence.CascadeType;\n+import javax.persistence.Column;\n+import javax.persistence.JoinColumn;\n+import javax.persistence.MappedSuperclass;\n+import javax.persistence.OneToOne;\n+\n+import java.util.Date;\n+\n+import lombok.Data;\n+import lombok.EqualsAndHashCode;\n+import lombok.NoArgsConstructor;\n+import org.openmrs.BaseOpenmrsData;\n+import org.openmrs.Concept;\n+\n+@Data(staticConstructor = \"of\")\n+@NoArgsConstructor\n+@EqualsAndHashCode(callSuper = true)\n+@MappedSuperclass\n+public abstract class FhirTaskParam extends BaseOpenmrsData {\n+\t\n+\t@OneToOne", "originalCommit": "b053ba200a375e2f66770d53667c786c27c10563", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "4385da0cfd96ed35c126b47f55b39f2cc2d4b825", "chunk": "diff --git a/api/src/main/java/org/openmrs/module/fhir2/FhirTaskParam.java b/api/src/main/java/org/openmrs/module/fhir2/FhirTaskParam.java\nindex 74837dae..4226cd8a 100644\n--- a/api/src/main/java/org/openmrs/module/fhir2/FhirTaskParam.java\n+++ b/api/src/main/java/org/openmrs/module/fhir2/FhirTaskParam.java\n\n@@ -20,20 +20,20 @@ import java.util.Date;\n import lombok.Data;\n import lombok.EqualsAndHashCode;\n import lombok.NoArgsConstructor;\n-import org.openmrs.BaseOpenmrsData;\n+import org.openmrs.BaseOpenmrsMetadata;\n import org.openmrs.Concept;\n \n @Data(staticConstructor = \"of\")\n @NoArgsConstructor\n @EqualsAndHashCode(callSuper = true)\n @MappedSuperclass\n-public abstract class FhirTaskParam extends BaseOpenmrsData {\n+public abstract class FhirTaskParam extends BaseOpenmrsMetadata {\n \t\n \t@OneToOne\n \t@JoinColumn(name = \"task_id\")\n \tprotected FhirTask task;\n \t\n-\t@Column(name = \"type\")\n+\t@Column(name = \"type_id\")\n \tprotected Concept type;\n \t\n \t@Column(name = \"value_datetime\")\n"}}, {"oid": "4385da0cfd96ed35c126b47f55b39f2cc2d4b825", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/4385da0cfd96ed35c126b47f55b39f2cc2d4b825", "message": "FM2-75 Addresses gaps for Lab Workflow in Task, ServiceRequest, and DiagnosticReport", "committedDate": "2020-02-26T20:18:58Z", "type": "forcePushed"}, {"oid": "b7e8d0f7898306f906662c279b99908862113567", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/b7e8d0f7898306f906662c279b99908862113567", "message": "FM2-75 Addresses gaps for Lab Workflow in Task, ServiceRequest, and DiagnosticReport", "committedDate": "2020-02-26T20:30:03Z", "type": "forcePushed"}, {"oid": "21936e30c6c2eb5f0b5fd5c4a79672af5c407c8d", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/21936e30c6c2eb5f0b5fd5c4a79672af5c407c8d", "message": "FM2-75 Addresses gaps for Lab Workflow in Task, ServiceRequest, and DiagnosticReport", "committedDate": "2020-02-26T21:10:01Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc1NjcwOQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/77#discussion_r384756709", "bodyText": "For a final PR, we shouldn't have commented-out code.", "author": "ibacher", "createdAt": "2020-02-26T20:49:38Z", "path": "api/src/main/java/org/openmrs/module/fhir2/FhirTask.java", "diffHunk": "@@ -56,35 +59,85 @@\n \t@Column(name = \"task_id\")\n \tprivate Integer id;\n \t\n+\t/**\n+\t * The current status of the task.\n+\t */\n \t@Column(name = \"status\")\n \t@Enumerated(EnumType.STRING)\n \tprivate TaskStatus status;\n \t\n+\t/**\n+\t * An explanation as to why this task is held, failed, was refused, etc.\n+\t */\n \t@Column(name = \"status_reason\")\n \tprivate String statusReason;\n \t\n+\t/**\n+\t * Indicates the \"level\" of actionability associated with the Task, i.e. i+R[9]Cs this a proposed\n+\t * task, a planned task, an actionable task, etc.\n+\t */\n \t@Column(name = \"intent\")\n \t@Enumerated(EnumType.STRING)\n \tprivate TaskIntent intent;\n \t\n \t/**\n-\t * Referenced resources represented with relative resource identifier string in the format of\n-\t * <ResourceName>/<ResourceId>.\n+\t * BasedOn refers to a higher-level authorization that triggered the creation of the task. It\n+\t * references a \"request\" resource such as a ServiceRequest, MedicationRequest, ServiceRequest,\n+\t * CarePlan, etc. which is distinct from the \"request\" resource the task is seeking to fulfill. This\n+\t * latter resource is referenced by FocusOn. For example, based on a ServiceRequest (= BasedOn), a\n+\t * task is created to fulfill a procedureRequest ( = FocusOn ) to collect a specimen from a patient.\n+\t */\n+\t@OneToMany\n+\t@JoinTable(name = \"fhir_task_based_on_reference\", joinColumns = @JoinColumn(name = \"task_id\"), inverseJoinColumns = @JoinColumn(name = \"reference_id\"))\n+\tprivate Set<FhirReference> basedOnReferences;\n+\t\n+\t//\tpublic Collection<FhirReference> getBasedOn() {", "originalCommit": "b7e8d0f7898306f906662c279b99908862113567", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "21936e30c6c2eb5f0b5fd5c4a79672af5c407c8d", "chunk": "diff --git a/api/src/main/java/org/openmrs/module/fhir2/FhirTask.java b/api/src/main/java/org/openmrs/module/fhir2/FhirTask.java\nindex bb492d51..40db11ba 100644\n--- a/api/src/main/java/org/openmrs/module/fhir2/FhirTask.java\n+++ b/api/src/main/java/org/openmrs/module/fhir2/FhirTask.java\n\n@@ -91,19 +91,6 @@ public class FhirTask extends BaseOpenmrsMetadata {\n \t@JoinTable(name = \"fhir_task_based_on_reference\", joinColumns = @JoinColumn(name = \"task_id\"), inverseJoinColumns = @JoinColumn(name = \"reference_id\"))\n \tprivate Set<FhirReference> basedOnReferences;\n \t\n-\t//\tpublic Collection<FhirReference> getBasedOn() {\n-\t//\t\treturn this.getBasedOnReferences().stream().map(referenceJoin -> referenceJoin.getReference()).collect(Collectors.toList());\n-\t//\t}\n-\t//\n-\t//\tpublic void setBasedOn(Collection<FhirReference> references) {\n-\t//\t\tthis.setBasedOnReferences(references.stream().map(reference -> {\n-\t//\t\t\tFhirTaskBasedOnReference joinRef = new FhirTaskBasedOnReference();\n-\t//\t\t\tjoinRef.setTask(this);\n-\t//\t\t\tjoinRef.setReference(reference);\n-\t//\t\t\treturn joinRef;\n-\t//\t\t}).collect(Collectors.toList()));\n-\t//\t}\n-\t\n \t/**\n \t * The entity who benefits from the performance of the service specified in the task (e.g., the\n \t * patient).\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc1ODI5MA==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/77#discussion_r384758290", "bodyText": "Should we mark this field as nullable = false since, per the profile, its a required element?", "author": "ibacher", "createdAt": "2020-02-26T20:52:26Z", "path": "api/src/main/java/org/openmrs/module/fhir2/FhirTask.java", "diffHunk": "@@ -56,35 +59,85 @@\n \t@Column(name = \"task_id\")\n \tprivate Integer id;\n \t\n+\t/**\n+\t * The current status of the task.\n+\t */\n \t@Column(name = \"status\")\n \t@Enumerated(EnumType.STRING)\n \tprivate TaskStatus status;\n \t\n+\t/**\n+\t * An explanation as to why this task is held, failed, was refused, etc.\n+\t */\n \t@Column(name = \"status_reason\")\n \tprivate String statusReason;\n \t\n+\t/**\n+\t * Indicates the \"level\" of actionability associated with the Task, i.e. i+R[9]Cs this a proposed\n+\t * task, a planned task, an actionable task, etc.\n+\t */\n \t@Column(name = \"intent\")\n \t@Enumerated(EnumType.STRING)\n \tprivate TaskIntent intent;", "originalCommit": "b7e8d0f7898306f906662c279b99908862113567", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "21936e30c6c2eb5f0b5fd5c4a79672af5c407c8d", "chunk": "diff --git a/api/src/main/java/org/openmrs/module/fhir2/FhirTask.java b/api/src/main/java/org/openmrs/module/fhir2/FhirTask.java\nindex bb492d51..40db11ba 100644\n--- a/api/src/main/java/org/openmrs/module/fhir2/FhirTask.java\n+++ b/api/src/main/java/org/openmrs/module/fhir2/FhirTask.java\n\n@@ -91,19 +91,6 @@ public class FhirTask extends BaseOpenmrsMetadata {\n \t@JoinTable(name = \"fhir_task_based_on_reference\", joinColumns = @JoinColumn(name = \"task_id\"), inverseJoinColumns = @JoinColumn(name = \"reference_id\"))\n \tprivate Set<FhirReference> basedOnReferences;\n \t\n-\t//\tpublic Collection<FhirReference> getBasedOn() {\n-\t//\t\treturn this.getBasedOnReferences().stream().map(referenceJoin -> referenceJoin.getReference()).collect(Collectors.toList());\n-\t//\t}\n-\t//\n-\t//\tpublic void setBasedOn(Collection<FhirReference> references) {\n-\t//\t\tthis.setBasedOnReferences(references.stream().map(reference -> {\n-\t//\t\t\tFhirTaskBasedOnReference joinRef = new FhirTaskBasedOnReference();\n-\t//\t\t\tjoinRef.setTask(this);\n-\t//\t\t\tjoinRef.setReference(reference);\n-\t//\t\t\treturn joinRef;\n-\t//\t\t}).collect(Collectors.toList()));\n-\t//\t}\n-\t\n \t/**\n \t * The entity who benefits from the performance of the service specified in the task (e.g., the\n \t * patient).\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc1ODMzNA==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/77#discussion_r384758334", "bodyText": "Should we mark this field as nullable = false since, per the profile, its a required element?", "author": "ibacher", "createdAt": "2020-02-26T20:52:32Z", "path": "api/src/main/java/org/openmrs/module/fhir2/FhirTask.java", "diffHunk": "@@ -56,35 +59,85 @@\n \t@Column(name = \"task_id\")\n \tprivate Integer id;\n \t\n+\t/**\n+\t * The current status of the task.\n+\t */\n \t@Column(name = \"status\")\n \t@Enumerated(EnumType.STRING)\n \tprivate TaskStatus status;", "originalCommit": "b7e8d0f7898306f906662c279b99908862113567", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "21936e30c6c2eb5f0b5fd5c4a79672af5c407c8d", "chunk": "diff --git a/api/src/main/java/org/openmrs/module/fhir2/FhirTask.java b/api/src/main/java/org/openmrs/module/fhir2/FhirTask.java\nindex bb492d51..40db11ba 100644\n--- a/api/src/main/java/org/openmrs/module/fhir2/FhirTask.java\n+++ b/api/src/main/java/org/openmrs/module/fhir2/FhirTask.java\n\n@@ -91,19 +91,6 @@ public class FhirTask extends BaseOpenmrsMetadata {\n \t@JoinTable(name = \"fhir_task_based_on_reference\", joinColumns = @JoinColumn(name = \"task_id\"), inverseJoinColumns = @JoinColumn(name = \"reference_id\"))\n \tprivate Set<FhirReference> basedOnReferences;\n \t\n-\t//\tpublic Collection<FhirReference> getBasedOn() {\n-\t//\t\treturn this.getBasedOnReferences().stream().map(referenceJoin -> referenceJoin.getReference()).collect(Collectors.toList());\n-\t//\t}\n-\t//\n-\t//\tpublic void setBasedOn(Collection<FhirReference> references) {\n-\t//\t\tthis.setBasedOnReferences(references.stream().map(reference -> {\n-\t//\t\t\tFhirTaskBasedOnReference joinRef = new FhirTaskBasedOnReference();\n-\t//\t\t\tjoinRef.setTask(this);\n-\t//\t\t\tjoinRef.setReference(reference);\n-\t//\t\t\treturn joinRef;\n-\t//\t\t}).collect(Collectors.toList()));\n-\t//\t}\n-\t\n \t/**\n \t * The entity who benefits from the performance of the service specified in the task (e.g., the\n \t * patient).\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc2OTM0NQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/77#discussion_r384769345", "bodyText": "It might be worth dropping this field. It's supposed to be a CodeableConcept, but there's no real terminology binding, so it's hard to assess what we need to store.", "author": "ibacher", "createdAt": "2020-02-26T21:14:46Z", "path": "api/src/main/java/org/openmrs/module/fhir2/FhirTask.java", "diffHunk": "@@ -56,35 +59,72 @@\n \t@Column(name = \"task_id\")\n \tprivate Integer id;\n \t\n+\t/**\n+\t * The current status of the task.\n+\t */\n \t@Column(name = \"status\")\n \t@Enumerated(EnumType.STRING)\n \tprivate TaskStatus status;\n \t\n+\t/**\n+\t * An explanation as to why this task is held, failed, was refused, etc.\n+\t */\n \t@Column(name = \"status_reason\")\n \tprivate String statusReason;", "originalCommit": "21936e30c6c2eb5f0b5fd5c4a79672af5c407c8d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "fad60a40e866b73ef9dcef10f3e9f36d2c1c27b5", "chunk": "diff --git a/api/src/main/java/org/openmrs/module/fhir2/FhirTask.java b/api/src/main/java/org/openmrs/module/fhir2/FhirTask.java\nindex 40db11ba..5060c612 100644\n--- a/api/src/main/java/org/openmrs/module/fhir2/FhirTask.java\n+++ b/api/src/main/java/org/openmrs/module/fhir2/FhirTask.java\n\n@@ -62,21 +61,15 @@ public class FhirTask extends BaseOpenmrsMetadata {\n \t/**\n \t * The current status of the task.\n \t */\n-\t@Column(name = \"status\")\n+\t@Column(name = \"status\", nullable = false)\n \t@Enumerated(EnumType.STRING)\n \tprivate TaskStatus status;\n \t\n-\t/**\n-\t * An explanation as to why this task is held, failed, was refused, etc.\n-\t */\n-\t@Column(name = \"status_reason\")\n-\tprivate String statusReason;\n-\t\n \t/**\n \t * Indicates the \"level\" of actionability associated with the Task, i.e. i+R[9]Cs this a proposed\n \t * task, a planned task, an actionable task, etc.\n \t */\n-\t@Column(name = \"intent\")\n+\t@Column(name = \"intent\", nullable = false)\n \t@Enumerated(EnumType.STRING)\n \tprivate TaskIntent intent;\n \t\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc3MDIyNg==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/77#discussion_r384770226", "bodyText": "Assuming this is storing the UUID of the reference, we can safely limit this column down to 32 characters (size = 32)", "author": "ibacher", "createdAt": "2020-02-26T21:16:06Z", "path": "api/src/main/java/org/openmrs/module/fhir2/FhirReference.java", "diffHunk": "@@ -0,0 +1,46 @@\n+/*\n+ * This Source Code Form is subject to the terms of the Mozilla Public License,\n+ * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n+ * obtain one at http://mozilla.org/MPL/2.0/. OpenMRS is also distributed under\n+ * the terms of the Healthcare Disclaimer located at http://openmrs.org/license.\n+ *\n+ * Copyright (C) OpenMRS Inc. OpenMRS is a registered trademark and the OpenMRS\n+ * graphic logo is a trademark of OpenMRS Inc.\n+ */\n+package org.openmrs.module.fhir2;\n+\n+import javax.persistence.Column;\n+import javax.persistence.Entity;\n+import javax.persistence.GeneratedValue;\n+import javax.persistence.GenerationType;\n+import javax.persistence.Id;\n+import javax.persistence.Table;\n+\n+import lombok.Data;\n+import lombok.EqualsAndHashCode;\n+import lombok.NoArgsConstructor;\n+import org.openmrs.BaseOpenmrsMetadata;\n+\n+/**\n+ * FHIR Reference - https://www.hl7.org/fhir/references.html\n+ */\n+@Data(staticConstructor = \"of\")\n+@NoArgsConstructor\n+@EqualsAndHashCode(callSuper = true)\n+@Entity\n+@Table(name = \"fhir_reference\")\n+public class FhirReference extends BaseOpenmrsMetadata {\n+\t\n+\tprivate static final long serialVersionUID = 1L;\n+\t\n+\t@Id\n+\t@GeneratedValue(strategy = GenerationType.AUTO)\n+\t@Column(name = \"reference_id\")\n+\tprivate Integer id;\n+\t\n+\t@Column(name = \"reference_type\")\n+\tprivate String type;\n+\t\n+\t@Column(name = \"reference\")", "originalCommit": "21936e30c6c2eb5f0b5fd5c4a79672af5c407c8d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQzMzg1Mw==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/77#discussion_r385433853", "bodyText": "If this is to be a true representation of a FHIR Reference (and not just of a FHIR reference that targets system objects by UUID) we might want to relax this limit.\nThe reference element is defined as:\n\nA reference to a location at which the other resource is found. The reference may be a relative reference, in which case it is relative to the service base URL, or an absolute URL that resolves to the location where the resource is found. The reference may be version specific or not. If the reference is not to a FHIR RESTful server, then it should be assumed to be version specific. Internal fragment references (start with '#') refer to contained resources.\n\n\nUsing absolute URLs provides a stable scalable approach suitable for a cloud/web context, while using relative/logical references provides a flexible approach suitable for use when trading across closed eco-system boundaries. Absolute URLs do not need to point to a FHIR RESTful server, though this is the preferred approach. If the URL conforms to the structure \"/[type]/[id]\" then it should be assumed that the reference is to a FHIR RESTful server.", "author": "pmanko", "createdAt": "2020-02-27T23:42:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc3MDIyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzEzMzQ4MA==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/77#discussion_r387133480", "bodyText": "Good point", "author": "ibacher", "createdAt": "2020-03-03T16:19:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc3MDIyNg=="}], "type": "inlineReview", "revised_code": {"commit": "fad60a40e866b73ef9dcef10f3e9f36d2c1c27b5", "chunk": "diff --git a/api/src/main/java/org/openmrs/module/fhir2/FhirReference.java b/api/src/main/java/org/openmrs/module/fhir2/FhirReference.java\nindex 6fba377b..01a2d58b 100644\n--- a/api/src/main/java/org/openmrs/module/fhir2/FhirReference.java\n+++ b/api/src/main/java/org/openmrs/module/fhir2/FhirReference.java\n\n@@ -38,7 +38,7 @@ public class FhirReference extends BaseOpenmrsMetadata {\n \t@Column(name = \"reference_id\")\n \tprivate Integer id;\n \t\n-\t@Column(name = \"reference_type\")\n+\t@Column(name = \"target_type\")\n \tprivate String type;\n \t\n \t@Column(name = \"reference\")\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc3MTM2OQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/77#discussion_r384771369", "bodyText": "I get what these are doing, but we should probably either 1) add a function here or 2) just add a Javadoc on the FhirTaskParam that doesn't explicitly reference input or output.", "author": "ibacher", "createdAt": "2020-02-26T21:17:57Z", "path": "api/src/main/java/org/openmrs/module/fhir2/FhirTaskInput.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*\n+ * This Source Code Form is subject to the terms of the Mozilla Public License,\n+ * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n+ * obtain one at http://mozilla.org/MPL/2.0/. OpenMRS is also distributed under\n+ * the terms of the Healthcare Disclaimer located at http://openmrs.org/license.\n+ *\n+ * Copyright (C) OpenMRS Inc. OpenMRS is a registered trademark and the OpenMRS\n+ * graphic logo is a trademark of OpenMRS Inc.\n+ */\n+package org.openmrs.module.fhir2;\n+\n+import javax.persistence.Column;\n+import javax.persistence.Entity;\n+import javax.persistence.GeneratedValue;\n+import javax.persistence.GenerationType;\n+import javax.persistence.Id;\n+import javax.persistence.Table;\n+\n+import lombok.Data;\n+import lombok.EqualsAndHashCode;\n+import lombok.NoArgsConstructor;\n+import org.hl7.fhir.r4.model.Task;\n+\n+/**\n+ * FHIR Task.input - https://www.hl7.org/fhir/task-definitions.html#Task.input\n+ */\n+@Data(staticConstructor = \"of\")\n+@NoArgsConstructor\n+@EqualsAndHashCode(callSuper = true)\n+@Entity\n+@Table(name = \"fhir_task_input\")\n+public class FhirTaskInput extends FhirTaskParam {\n+\t\n+\tprivate static final long serialVersionUID = 1L;\n+\t\n+\t@Id\n+\t@GeneratedValue(strategy = GenerationType.AUTO)\n+\t@Column(name = \"task_input_id\")\n+\tprivate Integer id;\n+\t\n+\t/**\n+\t * FhirTaskInput.type: A code or description indicating how the input is intended to be used as part", "originalCommit": "21936e30c6c2eb5f0b5fd5c4a79672af5c407c8d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "fad60a40e866b73ef9dcef10f3e9f36d2c1c27b5", "chunk": "diff --git a/api/src/main/java/org/openmrs/module/fhir2/FhirTaskInput.java b/api/src/main/java/org/openmrs/module/fhir2/FhirTaskInput.java\nindex 142a6ed4..9b16868f 100644\n--- a/api/src/main/java/org/openmrs/module/fhir2/FhirTaskInput.java\n+++ b/api/src/main/java/org/openmrs/module/fhir2/FhirTaskInput.java\n\n@@ -37,14 +37,4 @@ public class FhirTaskInput extends FhirTaskParam {\n \t@GeneratedValue(strategy = GenerationType.AUTO)\n \t@Column(name = \"task_input_id\")\n \tprivate Integer id;\n-\t\n-\t/**\n-\t * FhirTaskInput.type: A code or description indicating how the input is intended to be used as part\n-\t * of the task execution.\n-\t */\n-\t\n-\t/**\n-\t * FhirTaskInput.value: The value of the input parameter as a basic type\n-\t * (https://www.hl7.org/fhir/datatypes.html#open).\n-\t */\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc3MTg0MQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/77#discussion_r384771841", "bodyText": "This should probably be marked nullable = false", "author": "ibacher", "createdAt": "2020-02-26T21:18:43Z", "path": "api/src/main/java/org/openmrs/module/fhir2/FhirTaskParam.java", "diffHunk": "@@ -0,0 +1,52 @@\n+/*\n+ * This Source Code Form is subject to the terms of the Mozilla Public License,\n+ * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n+ * obtain one at http://mozilla.org/MPL/2.0/. OpenMRS is also distributed under\n+ * the terms of the Healthcare Disclaimer located at http://openmrs.org/license.\n+ *\n+ * Copyright (C) OpenMRS Inc. OpenMRS is a registered trademark and the OpenMRS\n+ * graphic logo is a trademark of OpenMRS Inc.\n+ */\n+package org.openmrs.module.fhir2;\n+\n+import javax.persistence.CascadeType;\n+import javax.persistence.Column;\n+import javax.persistence.JoinColumn;\n+import javax.persistence.ManyToOne;\n+import javax.persistence.MappedSuperclass;\n+import javax.persistence.OneToOne;\n+\n+import java.util.Date;\n+\n+import lombok.Data;\n+import lombok.EqualsAndHashCode;\n+import lombok.NoArgsConstructor;\n+import org.openmrs.BaseOpenmrsMetadata;\n+import org.openmrs.Concept;\n+\n+@Data(staticConstructor = \"of\")\n+@NoArgsConstructor\n+@EqualsAndHashCode(callSuper = true)\n+@MappedSuperclass\n+public abstract class FhirTaskParam extends BaseOpenmrsMetadata {\n+\t\n+\t@ManyToOne\n+\t@JoinColumn(name = \"task_id\")\n+\tprotected FhirTask task;\n+\t\n+\t@Column(name = \"type_id\")", "originalCommit": "21936e30c6c2eb5f0b5fd5c4a79672af5c407c8d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "fad60a40e866b73ef9dcef10f3e9f36d2c1c27b5", "chunk": "diff --git a/api/src/main/java/org/openmrs/module/fhir2/FhirTaskParam.java b/api/src/main/java/org/openmrs/module/fhir2/FhirTaskParam.java\nindex 37ce2d8b..1ebc6f80 100644\n--- a/api/src/main/java/org/openmrs/module/fhir2/FhirTaskParam.java\n+++ b/api/src/main/java/org/openmrs/module/fhir2/FhirTaskParam.java\n\n@@ -34,7 +34,7 @@ public abstract class FhirTaskParam extends BaseOpenmrsMetadata {\n \t@JoinColumn(name = \"task_id\")\n \tprotected FhirTask task;\n \t\n-\t@Column(name = \"type_id\")\n+\t@Column(name = \"type_id\", nullable = false)\n \tprotected Concept type;\n \t\n \t@Column(name = \"value_datetime\")\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc3NTA5Mw==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/77#discussion_r384775093", "bodyText": "Not a point for this PR, but maybe we should talk through this class. The more I look at it, the more I feel like its pretty tightly coupling ServiceRequest to Task which makes sense in the lab workflow, but I don't think is a good, generalizable thing.", "author": "ibacher", "createdAt": "2020-02-26T21:24:55Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/translators/impl/BaseServiceRequestTranslatorImpl.java", "diffHunk": "@@ -15,6 +15,7 @@\n ", "originalCommit": "21936e30c6c2eb5f0b5fd5c4a79672af5c407c8d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc3NjE1MQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/77#discussion_r384776151", "bodyText": "Does this work if there is no effectiveStopDate? I'm not sure if this parameter makes sense in the context of a one-off non-medication order.", "author": "ibacher", "createdAt": "2020-02-26T21:26:52Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/translators/impl/ServiceRequestTranslatorImpl.java", "diffHunk": "@@ -37,8 +49,20 @@ public ServiceRequest toFhirResource(TestOrder order) {\n \t\tserviceRequest.setId(order.getUuid());\n \t\t\n \t\tserviceRequest.setStatus(determineServiceRequestStatus(order.getUuid()));\n+\t\t\n \t\tserviceRequest.setCode(conceptTranslator.toFhirResource(order.getConcept()));\n+\t\t\n \t\tserviceRequest.setIntent(ServiceRequest.ServiceRequestIntent.ORDER);\n+\t\t\n+\t\tserviceRequest.setSubject(patientReferenceTranslator.toFhirResource(order.getPatient()));\n+\t\t\n+\t\tserviceRequest.setRequester(providerReferenceTranslator.toFhirResource(order.getOrderer()));\n+\t\t\n+\t\tserviceRequest.setPerformer(Collections.singletonList(determineServiceRequestPerformer(order.getUuid())));\n+\t\t\n+\t\tserviceRequest", "originalCommit": "21936e30c6c2eb5f0b5fd5c4a79672af5c407c8d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQzMDMwMg==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/77#discussion_r385430302", "bodyText": "Yeah, I wasn't sure how exactly to model the effective dates to dateTime/Period/Timing.\nI'll talk about this at the design forum, but for now I'll set a period like this, and have an empty start and/or end.\nThe FHIR docs mention this about missing times in period:\n\nIf the start element is missing, the start of the period is not known. If the end element is missing, it means that the period is ongoing, or the start may be in the past, and the end date in the future, which means that period is expected/planned to end at the specified time\n\nThis seems to generally capture how I understand effective start and end dates to work, but we could also model the occurrence as a single Datetime if there's only an effective start date or only an effective end date.\n(https://www.hl7.org/fhir/servicerequest-definitions.html#ServiceRequest.occurrence_x_)", "author": "pmanko", "createdAt": "2020-02-27T23:30:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc3NjE1MQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "94ab5d13fc2f30c66890634fe04f02d5d0f1e7c8", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/94ab5d13fc2f30c66890634fe04f02d5d0f1e7c8", "message": "FM2-75 Addresses gaps for Lab Workflow in Task, ServiceRequest, and DiagnosticReport", "committedDate": "2020-02-27T22:29:04Z", "type": "forcePushed"}, {"oid": "bf2d13c038284cb39ea7bbac2a5b3689010ce861", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/bf2d13c038284cb39ea7bbac2a5b3689010ce861", "message": "FM2-75 Addresses gaps for Lab Workflow in Task, ServiceRequest, and DiagnosticReport", "committedDate": "2020-02-27T22:43:58Z", "type": "forcePushed"}, {"oid": "fad60a40e866b73ef9dcef10f3e9f36d2c1c27b5", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/fad60a40e866b73ef9dcef10f3e9f36d2c1c27b5", "message": "FM2-75 Addresses gaps for Lab Workflow in Task, ServiceRequest, and DiagnosticReport", "committedDate": "2020-02-28T06:13:31Z", "type": "forcePushed"}, {"oid": "f720dd6f3169130bf9fcd352a1707562040c2339", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/f720dd6f3169130bf9fcd352a1707562040c2339", "message": "FM2-75 Addresses gaps for Lab Workflow in Task, ServiceRequest, and DiagnosticReport", "committedDate": "2020-02-28T07:05:14Z", "type": "forcePushed"}, {"oid": "fee2983e1702b0d89447eee75b2d4b2a3169e045", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/fee2983e1702b0d89447eee75b2d4b2a3169e045", "message": "FM2-75 Addresses gaps for Lab Workflow in Task, ServiceRequest, and DiagnosticReport", "committedDate": "2020-02-28T07:20:14Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzIyODYyNg==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/77#discussion_r387228626", "bodyText": "Just a suggestion, but:\nreturn (Collection<FhirTask>) sessionFactory.getCurrentSession().createCriteria(FhirTask.class)\n    .createAlias(\"basedOnReferences\", \"bo\").add(\"bo.type\", clazz.getAnnotation(ResourceDef.class).name())\n    .add(eq(\"bo.reference\", uuid)).list();", "author": "ibacher", "createdAt": "2020-03-03T19:00:57Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirTaskDaoImpl.java", "diffHunk": "@@ -53,7 +62,53 @@ public FhirTask getTaskByUuid(String uuid) {\n \t\n \t@Override\n \tpublic Collection<FhirTask> getTasksByBasedOnUuid(Class<? extends DomainResource> clazz, String uuid) {\n-\t\treturn (Collection<FhirTask>) sessionFactory.getCurrentSession().createCriteria(FhirTask.class)\n-\t\t        .add(Restrictions.eq(\"basedOn\", clazz.getSimpleName() + \"/\" + uuid)).list();\n+\t\tCriteria criteria = sessionFactory.getCurrentSession().createCriteria(FhirTask.class, \"task\");", "originalCommit": "fee2983e1702b0d89447eee75b2d4b2a3169e045", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f86211e4ce1c3d84118e16a5bfa3349859be07ed", "chunk": "diff --git a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirTaskDaoImpl.java b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirTaskDaoImpl.java\nindex ade525b2..9c6025f9 100644\n--- a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirTaskDaoImpl.java\n+++ b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirTaskDaoImpl.java\n\n@@ -62,11 +63,19 @@ public class FhirTaskDaoImpl extends BaseDaoImpl implements FhirTaskDao {\n \t\n \t@Override\n \tpublic Collection<FhirTask> getTasksByBasedOnUuid(Class<? extends DomainResource> clazz, String uuid) {\n-\t\tCriteria criteria = sessionFactory.getCurrentSession().createCriteria(FhirTask.class, \"task\");\n-\t\tCriteria resourceCriteria = criteria.createCriteria(\"basedOnReferences\");\n-\t\tresourceCriteria.add(Restrictions.eq(\"reference\", uuid));\n-\t\t\n-\t\treturn criteria.list();\n+//\t\tCriteria criteria = sessionFactory.getCurrentSession().createCriteria(FhirTask.class, \"task\");\n+//\t\tCriteria resourceCriteria = criteria.createCriteria(\"basedOnReferences\");\n+//\t\tresourceCriteria.add(Restrictions.eq(\"reference\", uuid));\n+\n+\t\treturn (Collection<FhirTask>) sessionFactory.getCurrentSession()\n+\t\t\t\t.createCriteria(FhirTask.class)\n+\t\t\t\t.createAlias(\"basedOnReferences\", \"bo\")\n+\t\t\t\t.add(eq(\"bo.type\", clazz.getAnnotation(ResourceDef.class).name()))\n+\t\t\t\t.add(eq(\"bo.reference\", uuid))\n+\t\t\t\t.list();\n+\n+\n+\t\t// return criteria.list();\n \t}\n \t\n \t@Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzIyOTE0Nw==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/77#discussion_r387229147", "bodyText": "See above", "author": "ibacher", "createdAt": "2020-03-03T19:01:54Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirTaskDaoImpl.java", "diffHunk": "@@ -53,7 +62,53 @@ public FhirTask getTaskByUuid(String uuid) {\n \t\n \t@Override\n \tpublic Collection<FhirTask> getTasksByBasedOnUuid(Class<? extends DomainResource> clazz, String uuid) {\n-\t\treturn (Collection<FhirTask>) sessionFactory.getCurrentSession().createCriteria(FhirTask.class)\n-\t\t        .add(Restrictions.eq(\"basedOn\", clazz.getSimpleName() + \"/\" + uuid)).list();\n+\t\tCriteria criteria = sessionFactory.getCurrentSession().createCriteria(FhirTask.class, \"task\");\n+\t\tCriteria resourceCriteria = criteria.createCriteria(\"basedOnReferences\");\n+\t\tresourceCriteria.add(Restrictions.eq(\"reference\", uuid));\n+\t\t\n+\t\treturn criteria.list();\n+\t}\n+\t\n+\t@Override\n+\tpublic Collection<FhirTask> searchForTasks(ReferenceParam basedOnReference, ReferenceParam ownerReference,\n+\t        TokenOrListParam status, SortSpec sort) {\n+\t\t\n+\t\tCriteria criteria = sessionFactory.getCurrentSession().createCriteria(FhirTask.class);\n+\t\t\n+\t\t// TODO: Refactor with BaseDaoImpl search support\n+\t\t// TODO: Handle optional params\n+\t\t// Task.basedOn\n+\t\tif (!(basedOnReference == null || basedOnReference.getIdPart() == null\n+\t\t        || basedOnReference.getResourceType() == null)) {\n+\t\t\tCriteria basedOnCriteria = criteria.createCriteria(\"basedOnReferences\");", "originalCommit": "fee2983e1702b0d89447eee75b2d4b2a3169e045", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f86211e4ce1c3d84118e16a5bfa3349859be07ed", "chunk": "diff --git a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirTaskDaoImpl.java b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirTaskDaoImpl.java\nindex ade525b2..9c6025f9 100644\n--- a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirTaskDaoImpl.java\n+++ b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirTaskDaoImpl.java\n\n@@ -62,11 +63,19 @@ public class FhirTaskDaoImpl extends BaseDaoImpl implements FhirTaskDao {\n \t\n \t@Override\n \tpublic Collection<FhirTask> getTasksByBasedOnUuid(Class<? extends DomainResource> clazz, String uuid) {\n-\t\tCriteria criteria = sessionFactory.getCurrentSession().createCriteria(FhirTask.class, \"task\");\n-\t\tCriteria resourceCriteria = criteria.createCriteria(\"basedOnReferences\");\n-\t\tresourceCriteria.add(Restrictions.eq(\"reference\", uuid));\n-\t\t\n-\t\treturn criteria.list();\n+//\t\tCriteria criteria = sessionFactory.getCurrentSession().createCriteria(FhirTask.class, \"task\");\n+//\t\tCriteria resourceCriteria = criteria.createCriteria(\"basedOnReferences\");\n+//\t\tresourceCriteria.add(Restrictions.eq(\"reference\", uuid));\n+\n+\t\treturn (Collection<FhirTask>) sessionFactory.getCurrentSession()\n+\t\t\t\t.createCriteria(FhirTask.class)\n+\t\t\t\t.createAlias(\"basedOnReferences\", \"bo\")\n+\t\t\t\t.add(eq(\"bo.type\", clazz.getAnnotation(ResourceDef.class).name()))\n+\t\t\t\t.add(eq(\"bo.reference\", uuid))\n+\t\t\t\t.list();\n+\n+\n+\t\t// return criteria.list();\n \t}\n \t\n \t@Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzIyOTIyNA==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/77#discussion_r387229224", "bodyText": "See above", "author": "ibacher", "createdAt": "2020-03-03T19:02:03Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirTaskDaoImpl.java", "diffHunk": "@@ -53,7 +62,53 @@ public FhirTask getTaskByUuid(String uuid) {\n \t\n \t@Override\n \tpublic Collection<FhirTask> getTasksByBasedOnUuid(Class<? extends DomainResource> clazz, String uuid) {\n-\t\treturn (Collection<FhirTask>) sessionFactory.getCurrentSession().createCriteria(FhirTask.class)\n-\t\t        .add(Restrictions.eq(\"basedOn\", clazz.getSimpleName() + \"/\" + uuid)).list();\n+\t\tCriteria criteria = sessionFactory.getCurrentSession().createCriteria(FhirTask.class, \"task\");\n+\t\tCriteria resourceCriteria = criteria.createCriteria(\"basedOnReferences\");\n+\t\tresourceCriteria.add(Restrictions.eq(\"reference\", uuid));\n+\t\t\n+\t\treturn criteria.list();\n+\t}\n+\t\n+\t@Override\n+\tpublic Collection<FhirTask> searchForTasks(ReferenceParam basedOnReference, ReferenceParam ownerReference,\n+\t        TokenOrListParam status, SortSpec sort) {\n+\t\t\n+\t\tCriteria criteria = sessionFactory.getCurrentSession().createCriteria(FhirTask.class);\n+\t\t\n+\t\t// TODO: Refactor with BaseDaoImpl search support\n+\t\t// TODO: Handle optional params\n+\t\t// Task.basedOn\n+\t\tif (!(basedOnReference == null || basedOnReference.getIdPart() == null\n+\t\t        || basedOnReference.getResourceType() == null)) {\n+\t\t\tCriteria basedOnCriteria = criteria.createCriteria(\"basedOnReferences\");\n+\t\t\tbasedOnCriteria.add(Restrictions.eq(\"reference\", basedOnReference.getIdPart()));\n+\t\t\tbasedOnCriteria.add(Restrictions.eq(\"type\", basedOnReference.getResourceType()));\n+\t\t}\n+\t\t\n+\t\t// Task.owner\n+\t\tif (!(ownerReference == null || ownerReference.getIdPart() == null || ownerReference.getResourceType() == null)) {\n+\t\t\tCriteria ownerCriteria = criteria.createCriteria(\"ownerReference\");", "originalCommit": "fee2983e1702b0d89447eee75b2d4b2a3169e045", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f86211e4ce1c3d84118e16a5bfa3349859be07ed", "chunk": "diff --git a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirTaskDaoImpl.java b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirTaskDaoImpl.java\nindex ade525b2..9c6025f9 100644\n--- a/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirTaskDaoImpl.java\n+++ b/api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirTaskDaoImpl.java\n\n@@ -62,11 +63,19 @@ public class FhirTaskDaoImpl extends BaseDaoImpl implements FhirTaskDao {\n \t\n \t@Override\n \tpublic Collection<FhirTask> getTasksByBasedOnUuid(Class<? extends DomainResource> clazz, String uuid) {\n-\t\tCriteria criteria = sessionFactory.getCurrentSession().createCriteria(FhirTask.class, \"task\");\n-\t\tCriteria resourceCriteria = criteria.createCriteria(\"basedOnReferences\");\n-\t\tresourceCriteria.add(Restrictions.eq(\"reference\", uuid));\n-\t\t\n-\t\treturn criteria.list();\n+//\t\tCriteria criteria = sessionFactory.getCurrentSession().createCriteria(FhirTask.class, \"task\");\n+//\t\tCriteria resourceCriteria = criteria.createCriteria(\"basedOnReferences\");\n+//\t\tresourceCriteria.add(Restrictions.eq(\"reference\", uuid));\n+\n+\t\treturn (Collection<FhirTask>) sessionFactory.getCurrentSession()\n+\t\t\t\t.createCriteria(FhirTask.class)\n+\t\t\t\t.createAlias(\"basedOnReferences\", \"bo\")\n+\t\t\t\t.add(eq(\"bo.type\", clazz.getAnnotation(ResourceDef.class).name()))\n+\t\t\t\t.add(eq(\"bo.reference\", uuid))\n+\t\t\t\t.list();\n+\n+\n+\t\t// return criteria.list();\n \t}\n \t\n \t@Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzIzMDM1MQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/77#discussion_r387230351", "bodyText": "I'd use the full reference, e.g., Patient/00000000000 for the name.", "author": "ibacher", "createdAt": "2020-03-03T19:04:14Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/translators/impl/ReferenceTranslatorImpl.java", "diffHunk": "@@ -0,0 +1,64 @@\n+/*\n+ * This Source Code Form is subject to the terms of the Mozilla Public License,\n+ * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n+ * obtain one at http://mozilla.org/MPL/2.0/. OpenMRS is also distributed under\n+ * the terms of the Healthcare Disclaimer located at http://openmrs.org/license.\n+ *\n+ * Copyright (C) OpenMRS Inc. OpenMRS is a registered trademark and the OpenMRS\n+ * graphic logo is a trademark of OpenMRS Inc.\n+ */\n+package org.openmrs.module.fhir2.api.translators.impl;\n+\n+import lombok.AccessLevel;\n+import lombok.Setter;\n+import org.hl7.fhir.r4.model.Reference;\n+import org.openmrs.module.fhir2.FhirReference;\n+import org.openmrs.module.fhir2.api.translators.ReferenceTranslator;\n+import org.springframework.stereotype.Component;\n+\n+@Component\n+@Setter(AccessLevel.PACKAGE)\n+public class ReferenceTranslatorImpl implements ReferenceTranslator {\n+\t\n+\t@Override\n+\tpublic Reference toFhirResource(FhirReference openmrsTask) {\n+\t\tReference fhirReference = null;\n+\t\t\n+\t\tif (openmrsTask != null) {\n+\t\t\tfhirReference = new Reference();\n+\t\t\tfhirReference.setType(openmrsTask.getType());\n+\t\t\tfhirReference.setReference(openmrsTask.getReference());\n+\t\t}\n+\t\t\n+\t\treturn fhirReference;\n+\t}\n+\t\n+\t@Override\n+\tpublic FhirReference toOpenmrsType(Reference fhirReference) {\n+\t\tFhirReference openmrsReference = null;\n+\t\t\n+\t\tif (fhirReference != null) {\n+\t\t\topenmrsReference = new FhirReference();\n+\t\t\topenmrsReference.setType(fhirReference.getType());\n+\t\t\topenmrsReference.setReference(fhirReference.getReference());\n+\t\t\t// TODO figure out what to use for the non-nullable Name", "originalCommit": "fee2983e1702b0d89447eee75b2d4b2a3169e045", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f86211e4ce1c3d84118e16a5bfa3349859be07ed", "chunk": "diff --git a/api/src/main/java/org/openmrs/module/fhir2/api/translators/impl/ReferenceTranslatorImpl.java b/api/src/main/java/org/openmrs/module/fhir2/api/translators/impl/ReferenceTranslatorImpl.java\nindex 9c336cfd..ca9a9ae9 100644\n--- a/api/src/main/java/org/openmrs/module/fhir2/api/translators/impl/ReferenceTranslatorImpl.java\n+++ b/api/src/main/java/org/openmrs/module/fhir2/api/translators/impl/ReferenceTranslatorImpl.java\n\n@@ -41,8 +41,7 @@ public class ReferenceTranslatorImpl implements ReferenceTranslator {\n \t\t\topenmrsReference = new FhirReference();\n \t\t\topenmrsReference.setType(fhirReference.getType());\n \t\t\topenmrsReference.setReference(fhirReference.getReference());\n-\t\t\t// TODO figure out what to use for the non-nullable Name\n-\t\t\topenmrsReference.setName(\"Temp\");\n+\t\t\topenmrsReference.setName(fhirReference.getType()+\"/\"+fhirReference.getReference());\n \t\t}\n \t\t\n \t\treturn openmrsReference;\n"}}, {"oid": "f34ce84b9e8a66247b16a8f97a4c06b61bc39c83", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/f34ce84b9e8a66247b16a8f97a4c06b61bc39c83", "message": "FM2-75 Addresses gaps for Lab Workflow in Task, ServiceRequest, and DiagnosticReport", "committedDate": "2020-03-04T17:18:24Z", "type": "forcePushed"}, {"oid": "f86211e4ce1c3d84118e16a5bfa3349859be07ed", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/f86211e4ce1c3d84118e16a5bfa3349859be07ed", "message": "FM2-75 Addresses gaps for Lab Workflow in Task, ServiceRequest, and DiagnosticReport", "committedDate": "2020-03-04T18:59:04Z", "type": "forcePushed"}, {"oid": "2817be3fd11cd9b1977ccd2e94f7c753f7c703ca", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/2817be3fd11cd9b1977ccd2e94f7c753f7c703ca", "message": "FM2-75 Addresses gaps for Lab Workflow in Task, ServiceRequest, and DiagnosticReport", "committedDate": "2020-03-04T19:09:25Z", "type": "forcePushed"}, {"oid": "250bb0259dee6a0c09355b11857298c8a8fbd8aa", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/250bb0259dee6a0c09355b11857298c8a8fbd8aa", "message": "FM2-75 Addresses gaps for Lab Workflow in Task, ServiceRequest, and DiagnosticReport", "committedDate": "2020-03-04T19:56:33Z", "type": "forcePushed"}, {"oid": "d53598af052415deb207262db993da4ccb54568b", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/d53598af052415deb207262db993da4ccb54568b", "message": "FM2-75 Addresses gaps for Lab Workflow in Task, ServiceRequest, and DiagnosticReport", "committedDate": "2020-03-04T20:15:00Z", "type": "forcePushed"}, {"oid": "10b99b735f2e28aa4815be4235de6b1560fad432", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/10b99b735f2e28aa4815be4235de6b1560fad432", "message": "FM2-75 Addresses gaps for Lab Workflow in Task, ServiceRequest, and DiagnosticReport", "committedDate": "2020-03-05T00:23:53Z", "type": "forcePushed"}, {"oid": "1be445cf8bba680fd7f27ce18435e01cf000019e", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/1be445cf8bba680fd7f27ce18435e01cf000019e", "message": "FM2-75 Addresses gaps for Lab Workflow in Task, ServiceRequest, and DiagnosticReport", "committedDate": "2020-03-06T17:00:10Z", "type": "commit"}, {"oid": "1be445cf8bba680fd7f27ce18435e01cf000019e", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/1be445cf8bba680fd7f27ce18435e01cf000019e", "message": "FM2-75 Addresses gaps for Lab Workflow in Task, ServiceRequest, and DiagnosticReport", "committedDate": "2020-03-06T17:00:10Z", "type": "forcePushed"}]}