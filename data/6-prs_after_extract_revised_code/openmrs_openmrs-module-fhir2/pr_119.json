{"pr_number": 119, "pr_title": "Implementation of several parameters for Condition search (api-2.2)", "pr_createdAt": "2020-03-21T11:53:50Z", "pr_url": "https://github.com/openmrs/openmrs-module-fhir2/pull/119", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk4NzE3MQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/119#discussion_r395987171", "bodyText": "I will update this unit-test later (before merge); the problem is that the main input data file (FhirConditionDaoImplTest_initial_data.xml) has been changed while I was working on this PR and the change is fairly significant. I also needed to make changes in that file, so I need to figure out how the new save feature works and why this test fails with my version of the input data file.", "author": "bashir2", "createdAt": "2020-03-21T12:05:54Z", "path": "api-2.2/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirConditionDaoImpl_2_2Test.java", "diffHunk": "@@ -106,6 +267,7 @@ public void shouldSaveNewCondition() {\n \t\tassertThat(result.getUuid(), equalTo(CONDITION_UUID));\n \t}\n \t\n+\t/* TODO comment out and fix before submit, once the conflicts in the initial_data.xml file are resolved.", "originalCommit": "2c3a59e278afc3065232530d1abbb483750b7875", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njg4NTExNQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/119#discussion_r396885115", "bodyText": "This is resolved now.", "author": "bashir2", "createdAt": "2020-03-24T03:36:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk4NzE3MQ=="}], "type": "inlineReview", "revised_code": {"commit": "f34ade0f6397cbb7910943166988b3e23bc396c0", "chunk": "diff --git a/api-2.2/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirConditionDaoImpl_2_2Test.java b/api-2.2/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirConditionDaoImpl_2_2Test.java\nindex 0b453596..4688265a 100644\n--- a/api-2.2/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirConditionDaoImpl_2_2Test.java\n+++ b/api-2.2/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirConditionDaoImpl_2_2Test.java\n\n@@ -267,17 +272,16 @@ public class FhirConditionDaoImpl_2_2Test extends BaseModuleContextSensitiveTest\n \t\tassertThat(result.getUuid(), equalTo(CONDITION_UUID));\n \t}\n \t\n-\t/* TODO comment out and fix before submit, once the conflicts in the initial_data.xml file are resolved.\n \t@Test\n \tpublic void shouldReturnExistingConditionIfBothAreEquals() throws Exception {\n \t\tCondition condition = new Condition();\n-\t\tcondition.setConditionId(PATIENT_ID);\n+\t\tcondition.setConditionId(CONDITION_ID);\n \t\tcondition.setUuid(EXISTING_CONDITION_UUID);\n \t\tcondition.setPatient(patientService.getPatient(PATIENT_ID));\n \t\tcondition.setClinicalStatus(ConditionClinicalStatus.ACTIVE);\n \t\t\n \t\tSimpleDateFormat sdf = new SimpleDateFormat(\"yyyy-MM-dd HH:mm:ss\");\n-\t\tDate onsetDate = sdf.parse(\"2017-01-12 00:00:50\");\n+\t\tDate onsetDate = sdf.parse(\"2020-03-13 19:00:00\");\n \t\tcondition.setOnsetDate(onsetDate);\n \t\tcondition.setVerificationStatus(ConditionVerificationStatus.CONFIRMED);\n \t\t\n"}}, {"oid": "f34ade0f6397cbb7910943166988b3e23bc396c0", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/f34ade0f6397cbb7910943166988b3e23bc396c0", "message": "Implementation of several parameters for Condition search (api-2.2)\n\nautomatic formatting changes\n\nminor; missing @Override", "committedDate": "2020-03-24T03:22:28Z", "type": "forcePushed"}, {"oid": "2f68b7a4d0cbfc490948b33b5806c5c6209eb89a", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/2f68b7a4d0cbfc490948b33b5806c5c6209eb89a", "message": "Implementation of several parameters for Condition search (api-2.2)\n\nautomatic formatting changes\n\nminor; missing @Override", "committedDate": "2020-03-24T03:31:58Z", "type": "forcePushed"}, {"oid": "86d3df5f5bb1c53e1f231b9c8271452769e5a675", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/86d3df5f5bb1c53e1f231b9c8271452769e5a675", "message": "Implementation of several parameters for Condition search (api-2.2)", "committedDate": "2020-03-24T04:50:34Z", "type": "commit"}, {"oid": "86d3df5f5bb1c53e1f231b9c8271452769e5a675", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/86d3df5f5bb1c53e1f231b9c8271452769e5a675", "message": "Implementation of several parameters for Condition search (api-2.2)", "committedDate": "2020-03-24T04:50:34Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzE1MzY1Mg==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/119#discussion_r397153652", "bodyText": "This shouldn't be part of this commit", "author": "ibacher", "createdAt": "2020-03-24T13:32:31Z", "path": "api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirObservationDaoImplTest.java", "diffHunk": "@@ -247,7 +247,7 @@ public void searchForObs_shouldReturnObsByPatientGivenName() {\n \t\tpatient.setChain(Patient.SP_GIVEN);\n \t\t\n \t\tpatientReference.addValue(new ReferenceOrListParam().add(patient));\n-\t\t", "originalCommit": "86d3df5f5bb1c53e1f231b9c8271452769e5a675", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQwMjQ2Nw==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/119#discussion_r397402467", "bodyText": "Done; was a leftover of merge conflicts/squash.", "author": "bashir2", "createdAt": "2020-03-24T19:19:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzE1MzY1Mg=="}], "type": "inlineReview", "revised_code": {"commit": "df0788de7b99bbc97a6b3480f4175747b97643fd", "chunk": "diff --git a/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirObservationDaoImplTest.java b/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirObservationDaoImplTest.java\nindex f97bd53d..de75bc70 100644\n--- a/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirObservationDaoImplTest.java\n+++ b/api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirObservationDaoImplTest.java\n\n@@ -247,7 +247,7 @@ public class FhirObservationDaoImplTest extends BaseModuleContextSensitiveTest {\n \t\tpatient.setChain(Patient.SP_GIVEN);\n \t\t\n \t\tpatientReference.addValue(new ReferenceOrListParam().add(patient));\n-\n+\t\t\n \t\tCollection<Obs> results = dao.searchForObservations(null, patientReference, null, null);\n \t\t\n \t\tassertThat(results, notNullValue());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzE1Mzk0NQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/119#discussion_r397153945", "bodyText": "Just delete this instead of commenting it out.", "author": "ibacher", "createdAt": "2020-03-24T13:32:56Z", "path": "omod/src/main/java/org/openmrs/module/fhir2/providers/ConditionFhirResourceProvider.java", "diffHunk": "@@ -70,4 +80,21 @@ public Condition getConditionByUuid(@IdParam @NotNull IdType id) {\n \tpublic MethodOutcome createCondition(@ResourceParam Condition newCondition) {\n \t\treturn FhirServerUtils.buildCreate(conditionService.saveCondition(newCondition));\n \t}\n+\t\n+\t@Search\n+\t//@SuppressWarnings(\"unused\")", "originalCommit": "86d3df5f5bb1c53e1f231b9c8271452769e5a675", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQwMzEwOA==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/119#discussion_r397403108", "bodyText": "Other @Search methods have this so I was not sure if I have set my IDE properly or not (since I don't get the warning). If you don't mind, for now I uncommented it to be consistent but we can remove it from all @Search methods in another PR.", "author": "bashir2", "createdAt": "2020-03-24T19:20:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzE1Mzk0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzkwMjI5Mg==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/119#discussion_r397902292", "bodyText": "I think that's an artifact of the fact that we've been writing code backwards, i.e., tests after the fact, so that the methods look like they're unused. Unfortunately, I'm as guilty of that as the next person.", "author": "ibacher", "createdAt": "2020-03-25T14:34:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzE1Mzk0NQ=="}], "type": "inlineReview", "revised_code": {"commit": "df0788de7b99bbc97a6b3480f4175747b97643fd", "chunk": "diff --git a/omod/src/main/java/org/openmrs/module/fhir2/providers/ConditionFhirResourceProvider.java b/omod/src/main/java/org/openmrs/module/fhir2/providers/ConditionFhirResourceProvider.java\nindex fb001d40..16ca3e51 100644\n--- a/omod/src/main/java/org/openmrs/module/fhir2/providers/ConditionFhirResourceProvider.java\n+++ b/omod/src/main/java/org/openmrs/module/fhir2/providers/ConditionFhirResourceProvider.java\n\n@@ -82,7 +82,7 @@ public class ConditionFhirResourceProvider implements IResourceProvider {\n \t}\n \t\n \t@Search\n-\t//@SuppressWarnings(\"unused\")\n+\t@SuppressWarnings(\"unused\")\n \tpublic Bundle searchConditions(\n \t        @OptionalParam(name = Condition.SP_PATIENT, chainWhitelist = { \"\", Patient.SP_IDENTIFIER, Patient.SP_NAME,\n \t                Patient.SP_GIVEN, Patient.SP_FAMILY }) ReferenceAndListParam patientParam,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzE1NTM1MQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/119#discussion_r397155351", "bodyText": "I would use a DateRangeParam here. DateParam only expresses a single date. DateRangeParam can express a single date or (more obviously) a point that is between two dates / instants.", "author": "ibacher", "createdAt": "2020-03-24T13:35:02Z", "path": "omod/src/main/java/org/openmrs/module/fhir2/providers/ConditionFhirResourceProvider.java", "diffHunk": "@@ -70,4 +80,21 @@ public Condition getConditionByUuid(@IdParam @NotNull IdType id) {\n \tpublic MethodOutcome createCondition(@ResourceParam Condition newCondition) {\n \t\treturn FhirServerUtils.buildCreate(conditionService.saveCondition(newCondition));\n \t}\n+\t\n+\t@Search\n+\t//@SuppressWarnings(\"unused\")\n+\tpublic Bundle searchConditions(\n+\t        @OptionalParam(name = Condition.SP_PATIENT, chainWhitelist = { \"\", Patient.SP_IDENTIFIER, Patient.SP_NAME,\n+\t                Patient.SP_GIVEN, Patient.SP_FAMILY }) ReferenceAndListParam patientParam,\n+\t        @OptionalParam(name = Condition.SP_SUBJECT, chainWhitelist = { \"\", Patient.SP_IDENTIFIER, Patient.SP_NAME,\n+\t                Patient.SP_GIVEN, Patient.SP_FAMILY }) ReferenceAndListParam subjectParam,\n+\t        @OptionalParam(name = Condition.SP_CODE) TokenOrListParam code,\n+\t        @OptionalParam(name = Condition.SP_CLINICAL_STATUS) TokenOrListParam clinicalStatus,\n+\t        @OptionalParam(name = Condition.SP_ONSET_DATE) DateParam onsetDate,", "originalCommit": "86d3df5f5bb1c53e1f231b9c8271452769e5a675", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU5MzAzNg==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/119#discussion_r397593036", "bodyText": "Done.", "author": "bashir2", "createdAt": "2020-03-25T03:41:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzE1NTM1MQ=="}], "type": "inlineReview", "revised_code": {"commit": "df0788de7b99bbc97a6b3480f4175747b97643fd", "chunk": "diff --git a/omod/src/main/java/org/openmrs/module/fhir2/providers/ConditionFhirResourceProvider.java b/omod/src/main/java/org/openmrs/module/fhir2/providers/ConditionFhirResourceProvider.java\nindex fb001d40..16ca3e51 100644\n--- a/omod/src/main/java/org/openmrs/module/fhir2/providers/ConditionFhirResourceProvider.java\n+++ b/omod/src/main/java/org/openmrs/module/fhir2/providers/ConditionFhirResourceProvider.java\n\n@@ -82,7 +82,7 @@ public class ConditionFhirResourceProvider implements IResourceProvider {\n \t}\n \t\n \t@Search\n-\t//@SuppressWarnings(\"unused\")\n+\t@SuppressWarnings(\"unused\")\n \tpublic Bundle searchConditions(\n \t        @OptionalParam(name = Condition.SP_PATIENT, chainWhitelist = { \"\", Patient.SP_IDENTIFIER, Patient.SP_NAME,\n \t                Patient.SP_GIVEN, Patient.SP_FAMILY }) ReferenceAndListParam patientParam,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzE1OTAxMA==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/119#discussion_r397159010", "bodyText": "Is returning duplicated Conditions the desired outcome?\n\nShort version: no, we really shouldn't be getting duplicated conditions. Can you say more about why this is happening?", "author": "ibacher", "createdAt": "2020-03-24T13:40:15Z", "path": "api-2.2/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirConditionDaoImpl_2_2Test.java", "diffHunk": "@@ -90,14 +116,166 @@ public void shouldReturnNullWhenGetConditionByWrongUuid() {\n \t\tassertThat(condition, nullValue());\n \t}\n \t\n+\tpublic void searchForPatients_shouldReturnConditionByPatientUuid() {\n+\t\tReferenceParam patientReference = new ReferenceParam(\"\", PATIENT_UUID);\n+\t\tReferenceAndListParam patientList = new ReferenceAndListParam();\n+\t\tpatientList.addValue(new ReferenceOrListParam().add(patientReference));\n+\t\tCollection<Condition> results = dao.searchForConditions(patientList, null, null, null, null, null, null, null);\n+\t\t\n+\t\tassertThat(results, notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.size(), equalTo(3));\n+\t\tassertThat(results.iterator().next().getPatient().getUuid(), equalTo(PATIENT_UUID));\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForPatients_shouldReturnConditionByPatientGivenName() {\n+\t\tReferenceParam patientReference = new ReferenceParam(Patient.SP_GIVEN, PATIENT_GIVEN_NAME);\n+\t\tReferenceAndListParam patientList = new ReferenceAndListParam();\n+\t\tpatientList.addValue(new ReferenceOrListParam().add(patientReference));\n+\t\tCollection<Condition> results = dao.searchForConditions(patientList, null, null, null, null, null, null, null);\n+\t\t\n+\t\tassertThat(results, notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\t// TODO during review: Is returning duplicated Conditions the desired outcome?\n+\t\tassertThat(results.size(), equalTo(6));", "originalCommit": "86d3df5f5bb1c53e1f231b9c8271452769e5a675", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzYzODA3OA==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/119#discussion_r397638078", "bodyText": "I think what is happening is that for PATIENT_GIVEN_NAME (i.e., \"Horatio\") there are two person_name entries (see here) both with person_id=\"2\" and the same given_name. There are three conditions in the test file for this person_id and because there is a JOIN between person and person_name tables, the final result contains 6 rows; while in fact each real condition is repeated twice.", "author": "bashir2", "createdAt": "2020-03-25T06:47:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzE1OTAxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzkxMDA0MQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/119#discussion_r397910041", "bodyText": "Yep, that's a good point and probably out of scope for this ticket. I'll create a new ticket to resolve that issue. Small note on coding style, I prefer using the Hamcrest hasSize() method instead of size(), equalTo() as it results in a more meaningful error message when it fails.", "author": "ibacher", "createdAt": "2020-03-25T14:43:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzE1OTAxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODExNTY5Mw==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/119#discussion_r398115693", "bodyText": "Done.\nI also updated the TODO above to a note describing what is happening here.", "author": "bashir2", "createdAt": "2020-03-25T19:30:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzE1OTAxMA=="}], "type": "inlineReview", "revised_code": {"commit": "df0788de7b99bbc97a6b3480f4175747b97643fd", "chunk": "diff --git a/api-2.2/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirConditionDaoImpl_2_2Test.java b/api-2.2/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirConditionDaoImpl_2_2Test.java\nindex 86a7797b..15c71ae5 100644\n--- a/api-2.2/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirConditionDaoImpl_2_2Test.java\n+++ b/api-2.2/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirConditionDaoImpl_2_2Test.java\n\n@@ -142,6 +144,29 @@ public class FhirConditionDaoImpl_2_2Test extends BaseModuleContextSensitiveTest\n \t\tassertThat(results.iterator().next().getPatient().getGivenName(), equalTo(PATIENT_GIVEN_NAME));\n \t}\n \t\n+\t@Test\n+\tpublic void searchForPatients_shouldReturnConditionByPatientNotFoundName() {\n+\t\tReferenceParam patientReference = new ReferenceParam(Patient.SP_GIVEN, PATIENT_NOT_FOUND_NAME);\n+\t\tReferenceAndListParam patientList = new ReferenceAndListParam();\n+\t\tpatientList.addValue(new ReferenceOrListParam().add(patientReference));\n+\t\tCollection<Condition> results = dao.searchForConditions(patientList, null, null, null, null, null, null, null);\n+\t\t\n+\t\tassertThat(results, notNullValue());\n+\t\tassertThat(results, empty());\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForPatients_shouldReturnNoConditionByMultiplePatientGivenName() {\n+\t\tReferenceParam patientReference1 = new ReferenceParam(Patient.SP_GIVEN, PATIENT_GIVEN_NAME);\n+\t\tReferenceParam patientReference2 = new ReferenceParam(Patient.SP_GIVEN, ANOTHER_GIVEN_NAME);\n+\t\tReferenceAndListParam patientList = new ReferenceAndListParam();\n+\t\tpatientList.addValue(new ReferenceOrListParam().add(patientReference1).add(patientReference2));\n+\t\tCollection<Condition> results = dao.searchForConditions(patientList, null, null, null, null, null, null, null);\n+\t\t\n+\t\tassertThat(results, notNullValue());\n+\t\tassertThat(results, empty());\n+\t}\n+\t\n \t@Test\n \tpublic void searchForPatients_shouldReturnConditionByPatientFamilyName() {\n \t\tReferenceParam patientReference = new ReferenceParam(Patient.SP_FAMILY, PATIENT_FAMILY_NAME);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzE2MTA4Nw==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/119#discussion_r397161087", "bodyText": "Where does this CD41003 value come from?", "author": "ibacher", "createdAt": "2020-03-24T13:43:03Z", "path": "api-2.2/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirConditionDaoImpl_2_2Test.java", "diffHunk": "@@ -90,14 +116,166 @@ public void shouldReturnNullWhenGetConditionByWrongUuid() {\n \t\tassertThat(condition, nullValue());\n \t}\n \t\n+\tpublic void searchForPatients_shouldReturnConditionByPatientUuid() {\n+\t\tReferenceParam patientReference = new ReferenceParam(\"\", PATIENT_UUID);\n+\t\tReferenceAndListParam patientList = new ReferenceAndListParam();\n+\t\tpatientList.addValue(new ReferenceOrListParam().add(patientReference));\n+\t\tCollection<Condition> results = dao.searchForConditions(patientList, null, null, null, null, null, null, null);\n+\t\t\n+\t\tassertThat(results, notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.size(), equalTo(3));\n+\t\tassertThat(results.iterator().next().getPatient().getUuid(), equalTo(PATIENT_UUID));\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForPatients_shouldReturnConditionByPatientGivenName() {\n+\t\tReferenceParam patientReference = new ReferenceParam(Patient.SP_GIVEN, PATIENT_GIVEN_NAME);\n+\t\tReferenceAndListParam patientList = new ReferenceAndListParam();\n+\t\tpatientList.addValue(new ReferenceOrListParam().add(patientReference));\n+\t\tCollection<Condition> results = dao.searchForConditions(patientList, null, null, null, null, null, null, null);\n+\t\t\n+\t\tassertThat(results, notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\t// TODO during review: Is returning duplicated Conditions the desired outcome?\n+\t\tassertThat(results.size(), equalTo(6));\n+\t\tassertThat(results.iterator().next().getPatient().getGivenName(), equalTo(PATIENT_GIVEN_NAME));\n+\t}\n+\t\n \t@Test\n+\tpublic void searchForPatients_shouldReturnConditionByPatientFamilyName() {\n+\t\tReferenceParam patientReference = new ReferenceParam(Patient.SP_FAMILY, PATIENT_FAMILY_NAME);\n+\t\tReferenceAndListParam patientList = new ReferenceAndListParam();\n+\t\tpatientList.addValue(new ReferenceOrListParam().add(patientReference));\n+\t\tCollection<Condition> results = dao.searchForConditions(patientList, null, null, null, null, null, null, null);\n+\t\t\n+\t\tassertThat(results, notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.size(), equalTo(9));\n+\t\tassertThat(results.iterator().next().getPatient().getFamilyName(), equalTo(PATIENT_FAMILY_NAME));\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForPatients_shouldReturnConditionByPatientName() {\n+\t\tReferenceParam patientReference = new ReferenceParam(Patient.SP_NAME, PATIENT_PARTIAL_NAME);\n+\t\tReferenceAndListParam patientList = new ReferenceAndListParam();\n+\t\tpatientList.addValue(new ReferenceOrListParam().add(patientReference));\n+\t\tCollection<Condition> results = dao.searchForConditions(patientList, null, null, null, null, null, null, null);\n+\t\t\n+\t\tassertThat(results, notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.size(), equalTo(9));\n+\t\tassertThat(results.iterator().next().getPatient().getGivenName(), equalTo(PATIENT_GIVEN_NAME));\n+\t\tassertThat(results.iterator().next().getPatient().getFamilyName(), equalTo(PATIENT_FAMILY_NAME));\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForPatients_shouldReturnConditionBySubjectName() {\n+\t\tReferenceParam subjectReference = new ReferenceParam(Patient.SP_NAME, PATIENT_PARTIAL_NAME);\n+\t\tReferenceAndListParam subjectList = new ReferenceAndListParam();\n+\t\tsubjectList.addValue(new ReferenceOrListParam().add(subjectReference));\n+\t\tCollection<Condition> results = dao.searchForConditions(null, subjectList, null, null, null, null, null, null);\n+\t\t\n+\t\tassertThat(results, notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.size(), equalTo(9));\n+\t\tassertThat(results.iterator().next().getPatient().getGivenName(), equalTo(PATIENT_GIVEN_NAME));\n+\t\tassertThat(results.iterator().next().getPatient().getFamilyName(), equalTo(PATIENT_FAMILY_NAME));\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForPatients_shouldReturnConditionByOnsetDate() {\n+\t\tString testDate = \"2017-01-12\";\n+\t\t\n+\t\tDateParam onsetDate = new DateParam(\"eq\" + testDate);\n+\t\tCollection<Condition> results = dao.searchForConditions(null, null, null, null, onsetDate, null, null, null);\n+\t\t\n+\t\tassertThat(results, notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.size(), equalTo(3));\n+\t\tassertThat(results.iterator().next().getOnsetDate().toString(), startsWith(testDate));\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForPatients_shouldReturnConditionByRecordedDate() {\n+\t\tString testDate = \"2016-01-12\";\n+\t\t\n+\t\tDateParam recordedDate = new DateParam(\"eq\" + testDate);\n+\t\tCollection<Condition> results = dao.searchForConditions(null, null, null, null, null, null, recordedDate, null);\n+\t\t\n+\t\tassertThat(results, notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.size(), equalTo(1));\n+\t\tassertThat(results.iterator().next().getDateCreated().toString(), startsWith(testDate));\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForPatients_shouldReturnConditionByClinicalStatusActive() {\n+\t\tTokenOrListParam listParam = new TokenOrListParam();\n+\t\tlistParam.add(new TokenParam(\"active\"));\n+\t\tCollection<Condition> results = dao.searchForConditions(null, null, null, listParam, null, null, null, null);\n+\t\t\n+\t\tassertThat(results, notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.size(), equalTo(5));\n+\t\tassertThat(results.iterator().next().getClinicalStatus(), equalTo(ConditionClinicalStatus.ACTIVE));\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForPatients_shouldReturnConditionByClinicalStatusInactive() {\n+\t\tTokenOrListParam listParam = new TokenOrListParam();\n+\t\tlistParam.add(new TokenParam(\"inactive\"));\n+\t\tCollection<Condition> results = dao.searchForConditions(null, null, null, listParam, null, null, null, null);\n+\t\t\n+\t\tassertThat(results, notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.size(), equalTo(1));\n+\t\tassertThat(results.iterator().next().getClinicalStatus(), equalTo(ConditionClinicalStatus.INACTIVE));\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForPatients_shouldReturnConditionByClinicalStatusAll() {\n+\t\tTokenOrListParam listParam = new TokenOrListParam();\n+\t\tlistParam.add(new TokenParam(\"active\"));\n+\t\tlistParam.add(new TokenParam(\"inactive\"));\n+\t\tCollection<Condition> results = dao.searchForConditions(null, null, null, listParam, null, null, null, null);\n+\t\t\n+\t\tassertThat(results, notNullValue());\n+\t\tassertThat(results, not(empty()));\n+\t\tassertThat(results.size(), equalTo(6));\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForPatients_shouldReturnConditionByCode() {\n+\t\tTokenOrListParam listParam = new TokenOrListParam();\n+\t\tlistParam.add(new TokenParam(\"CD41003\")); // for concept_id=5497", "originalCommit": "86d3df5f5bb1c53e1f231b9c8271452769e5a675", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQwOTkzMQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/119#discussion_r397409931", "bodyText": "It comes from this line of standardTestDataset.xml, i.e., how concept_id of an OpenMRS condition is translated into a FHIR condition code according to ConditionTranslatorImpl_2_2.\nPlease note that with your suggestion of using handleResourceCode() the system part of a code token is now properly handled so I have added an additional line for fhir_concept_source in FhirConditionDaoImplTest_initial_data.xml; PTAL.", "author": "bashir2", "createdAt": "2020-03-24T19:32:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzE2MTA4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzkwMzEzMA==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/119#discussion_r397903130", "bodyText": "Thanks! I haven't looks through the standard dataset in a while, so I forgot about that.", "author": "ibacher", "createdAt": "2020-03-25T14:35:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzE2MTA4Nw=="}], "type": "inlineReview", "revised_code": {"commit": "df0788de7b99bbc97a6b3480f4175747b97643fd", "chunk": "diff --git a/api-2.2/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirConditionDaoImpl_2_2Test.java b/api-2.2/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirConditionDaoImpl_2_2Test.java\nindex 86a7797b..15c71ae5 100644\n--- a/api-2.2/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirConditionDaoImpl_2_2Test.java\n+++ b/api-2.2/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirConditionDaoImpl_2_2Test.java\n\n@@ -142,6 +144,29 @@ public class FhirConditionDaoImpl_2_2Test extends BaseModuleContextSensitiveTest\n \t\tassertThat(results.iterator().next().getPatient().getGivenName(), equalTo(PATIENT_GIVEN_NAME));\n \t}\n \t\n+\t@Test\n+\tpublic void searchForPatients_shouldReturnConditionByPatientNotFoundName() {\n+\t\tReferenceParam patientReference = new ReferenceParam(Patient.SP_GIVEN, PATIENT_NOT_FOUND_NAME);\n+\t\tReferenceAndListParam patientList = new ReferenceAndListParam();\n+\t\tpatientList.addValue(new ReferenceOrListParam().add(patientReference));\n+\t\tCollection<Condition> results = dao.searchForConditions(patientList, null, null, null, null, null, null, null);\n+\t\t\n+\t\tassertThat(results, notNullValue());\n+\t\tassertThat(results, empty());\n+\t}\n+\t\n+\t@Test\n+\tpublic void searchForPatients_shouldReturnNoConditionByMultiplePatientGivenName() {\n+\t\tReferenceParam patientReference1 = new ReferenceParam(Patient.SP_GIVEN, PATIENT_GIVEN_NAME);\n+\t\tReferenceParam patientReference2 = new ReferenceParam(Patient.SP_GIVEN, ANOTHER_GIVEN_NAME);\n+\t\tReferenceAndListParam patientList = new ReferenceAndListParam();\n+\t\tpatientList.addValue(new ReferenceOrListParam().add(patientReference1).add(patientReference2));\n+\t\tCollection<Condition> results = dao.searchForConditions(patientList, null, null, null, null, null, null, null);\n+\t\t\n+\t\tassertThat(results, notNullValue());\n+\t\tassertThat(results, empty());\n+\t}\n+\t\n \t@Test\n \tpublic void searchForPatients_shouldReturnConditionByPatientFamilyName() {\n \t\tReferenceParam patientReference = new ReferenceParam(Patient.SP_FAMILY, PATIENT_FAMILY_NAME);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzE2MzkzNg==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/119#discussion_r397163936", "bodyText": "We shouldn't be, since HISTORY_OF is not semantically equivalent to any of those values. Normally, I'd say we just add a custom valueset, but that obviously makes us non-conformant. I think we need to handle HISTORY_OF via an extension. Ugh...", "author": "ibacher", "createdAt": "2020-03-24T13:46:56Z", "path": "api-2.2/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirConditionDaoImpl_2_2.java", "diffHunk": "@@ -42,6 +52,47 @@ public Condition getConditionByUuid(String uuid) {\n \t\t        .uniqueResult();\n \t}\n \t\n+\tprivate ConditionClinicalStatus convertStatus(String status) {\n+\t\tif (\"active\".equalsIgnoreCase(status)) {\n+\t\t\treturn ConditionClinicalStatus.ACTIVE;\n+\t\t}\n+\t\tif (\"inactive\".equalsIgnoreCase(status)) {\n+\t\t\treturn ConditionClinicalStatus.INACTIVE;\n+\t\t}\n+\t\t// TODO during review: What value of the spec. should be mapped to HISTORY_OF?\n+\t\t// http://www.hl7.org/fhir/valueset-condition-clinical.html\n+\t\treturn ConditionClinicalStatus.HISTORY_OF;", "originalCommit": "86d3df5f5bb1c53e1f231b9c8271452769e5a675", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzI1Nzc3Ng==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/119#discussion_r397257776", "bodyText": "I see, so defining an extension seems beyond this PR. The HISTORY_OF option is not exposed in new versions of OpenMRS Ref App (judging from 2.10.0-SNAPSHOT); so maybe it is on its way to become deprecated?\nAnyways, the code in ConditionClinicalStatusTranslatorImpl_2_2 handles the same problem they way it is implemented here, i.e., it maps HISTORY_OF to a coding with the same text (which as you said is not standard conforming) and then maps it back to HISTORY_OF in the reverse translation. So I simply  updated the TODO here with a reference to that, WDYT?", "author": "bashir2", "createdAt": "2020-03-24T15:47:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzE2MzkzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzkxNDYwMg==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/119#discussion_r397914602", "bodyText": "Yeah, that's fine.\nI don't know whether it's on its way to being deprecated or not, but I hope so. Maybe I can propose that core adopts the second level values from the HL7 value set, since \"remission\" and \"resolved\" seem more semantically meaningful than just \"history of\".", "author": "ibacher", "createdAt": "2020-03-25T14:49:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzE2MzkzNg=="}], "type": "inlineReview", "revised_code": {"commit": "df0788de7b99bbc97a6b3480f4175747b97643fd", "chunk": "diff --git a/api-2.2/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirConditionDaoImpl_2_2.java b/api-2.2/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirConditionDaoImpl_2_2.java\nindex 18dac2d0..9524051a 100644\n--- a/api-2.2/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirConditionDaoImpl_2_2.java\n+++ b/api-2.2/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirConditionDaoImpl_2_2.java\n\n@@ -59,33 +59,30 @@ public class FhirConditionDaoImpl_2_2 extends BaseDaoImpl implements FhirConditi\n \t\tif (\"inactive\".equalsIgnoreCase(status)) {\n \t\t\treturn ConditionClinicalStatus.INACTIVE;\n \t\t}\n-\t\t// TODO during review: What value of the spec. should be mapped to HISTORY_OF?\n+\t\t// Note `history_of` is not a valid value in the FHIR spec:\n \t\t// http://www.hl7.org/fhir/valueset-condition-clinical.html\n+\t\t// We are simply following the logic implemented in `ConditionClinicalStatusTranslatorImpl_2_2`.\n \t\treturn ConditionClinicalStatus.HISTORY_OF;\n \t}\n \t\n \t@Override\n \tpublic Collection<Condition> searchForConditions(ReferenceAndListParam patientParam, ReferenceAndListParam subjectParam,\n-\t        TokenOrListParam code, TokenOrListParam clinicalStatus, DateParam onsetDate, QuantityParam onsetAge,\n-\t        DateParam recordedData, SortSpec sort) {\n+\t        TokenOrListParam code, TokenOrListParam clinicalStatus, DateRangeParam onsetDate, QuantityParam onsetAge,\n+\t        DateRangeParam recordedData, SortSpec sort) {\n \t\tCriteria criteria = sessionFactory.getCurrentSession().createCriteria(Condition.class);\n \t\t\n \t\thandlePatientReference(criteria, patientParam);\n-\t\t// TODO during review: Do we require a \":Patient\" modifier or a \"Patient/\" type for the \"subject\" search param?\n-\t\t// And do we want to support anything other than \"Patient\" under \"subject\" based searches (e.g., \"Group\")?\n-\t\thandlePatientReference(criteria, subjectParam);\n-\t\thandleDate(\"onsetDate\", onsetDate).ifPresent(criteria::add);\n+\t\tif (patientParam == null) {\n+\t\t\thandlePatientReference(criteria, subjectParam);\n+\t\t}\n+\t\thandleDateRange(\"onsetDate\", onsetDate).ifPresent(criteria::add);\n \t\t// TODO: Handle onsetAge as well.\n-\t\thandleDate(\"dateCreated\", recordedData).ifPresent(criteria::add);\n+\t\thandleDateRange(\"dateCreated\", recordedData).ifPresent(criteria::add);\n \t\thandleOrListParam(clinicalStatus,\n \t\t    tokenParam -> Optional.of(eq(\"clinicalStatus\", convertStatus(tokenParam.getValue())))).ifPresent(criteria::add);\n \t\tif (code != null) {\n-\t\t\t// TODO add support for code system as well (not just the code value), possibly using ConceptTranslator.\n \t\t\tcriteria.createAlias(\"condition.coded\", \"cd\");\n-\t\t\tcriteria.createAlias(\"cd.conceptMappings\", \"map\");\n-\t\t\tcriteria.createAlias(\"map.conceptReferenceTerm\", \"term\");\n-\t\t\thandleOrListParam(code, tokenParam -> Optional.of(eq(\"term.code\", tokenParam.getValue())))\n-\t\t\t        .ifPresent(criteria::add);\n+\t\t\thandleResourceCode(criteria, code, \"cd\", \"map\", \"term\");\n \t\t}\n \t\t\n \t\thandleSort(criteria, sort);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzE2NjUzOA==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/119#discussion_r397166538", "bodyText": "The patient search parameter is defined as Condition.subject.where(resolve() is Patient), i.e., if the patientParam is valid, we should not handle the subjectParam at all.\n\nDo we require a \":Patient\" modifier or a \"Patient/\" type for the \"subject\" search param?\n\nNo, but we should support these where present\n\nDo we want to support anything other than \"Patient\" under \"subject\" based searches (e.g., \"Group\")?\n\nWe currently haven't implemented the concept of \"Group\" in the OpenMRS FHIR module, so we needn't support it here.", "author": "ibacher", "createdAt": "2020-03-24T13:50:24Z", "path": "api-2.2/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirConditionDaoImpl_2_2.java", "diffHunk": "@@ -42,6 +52,47 @@ public Condition getConditionByUuid(String uuid) {\n \t\t        .uniqueResult();\n \t}\n \t\n+\tprivate ConditionClinicalStatus convertStatus(String status) {\n+\t\tif (\"active\".equalsIgnoreCase(status)) {\n+\t\t\treturn ConditionClinicalStatus.ACTIVE;\n+\t\t}\n+\t\tif (\"inactive\".equalsIgnoreCase(status)) {\n+\t\t\treturn ConditionClinicalStatus.INACTIVE;\n+\t\t}\n+\t\t// TODO during review: What value of the spec. should be mapped to HISTORY_OF?\n+\t\t// http://www.hl7.org/fhir/valueset-condition-clinical.html\n+\t\treturn ConditionClinicalStatus.HISTORY_OF;\n+\t}\n+\t\n+\t@Override\n+\tpublic Collection<Condition> searchForConditions(ReferenceAndListParam patientParam, ReferenceAndListParam subjectParam,\n+\t        TokenOrListParam code, TokenOrListParam clinicalStatus, DateParam onsetDate, QuantityParam onsetAge,\n+\t        DateParam recordedData, SortSpec sort) {\n+\t\tCriteria criteria = sessionFactory.getCurrentSession().createCriteria(Condition.class);\n+\t\t\n+\t\thandlePatientReference(criteria, patientParam);\n+\t\t// TODO during review: Do we require a \":Patient\" modifier or a \"Patient/\" type for the \"subject\" search param?\n+\t\t// And do we want to support anything other than \"Patient\" under \"subject\" based searches (e.g., \"Group\")?\n+\t\thandlePatientReference(criteria, subjectParam);", "originalCommit": "86d3df5f5bb1c53e1f231b9c8271452769e5a675", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzY3MzMyMg==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/119#discussion_r397673322", "bodyText": "Thanks for the clarifications; here is my interpretation (please let me know if I misunderstood what you said):\n\nIf patientParam is present, we do not process subjectParam (added a test for this case).\nOtherwise, we assume subject is referring to a Patient resource; i.e., we ignore the getResourceType() part of subjectParam entries but its presence will not cause any problems. IOW, subject:Patient.name=foo is equivalent to subject.name=foo but it is also equivalent to subject:Group.name=foo.\n\nSide note: I think there was a bug in handlePatientReference when ReferenceAndListParam had multiple of the same parameter (e.g., multiple patient.name) which I fixed and a corresponding test is added too; PTAL.", "author": "bashir2", "createdAt": "2020-03-25T08:18:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzE2NjUzOA=="}], "type": "inlineReview", "revised_code": {"commit": "df0788de7b99bbc97a6b3480f4175747b97643fd", "chunk": "diff --git a/api-2.2/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirConditionDaoImpl_2_2.java b/api-2.2/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirConditionDaoImpl_2_2.java\nindex 18dac2d0..9524051a 100644\n--- a/api-2.2/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirConditionDaoImpl_2_2.java\n+++ b/api-2.2/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirConditionDaoImpl_2_2.java\n\n@@ -59,33 +59,30 @@ public class FhirConditionDaoImpl_2_2 extends BaseDaoImpl implements FhirConditi\n \t\tif (\"inactive\".equalsIgnoreCase(status)) {\n \t\t\treturn ConditionClinicalStatus.INACTIVE;\n \t\t}\n-\t\t// TODO during review: What value of the spec. should be mapped to HISTORY_OF?\n+\t\t// Note `history_of` is not a valid value in the FHIR spec:\n \t\t// http://www.hl7.org/fhir/valueset-condition-clinical.html\n+\t\t// We are simply following the logic implemented in `ConditionClinicalStatusTranslatorImpl_2_2`.\n \t\treturn ConditionClinicalStatus.HISTORY_OF;\n \t}\n \t\n \t@Override\n \tpublic Collection<Condition> searchForConditions(ReferenceAndListParam patientParam, ReferenceAndListParam subjectParam,\n-\t        TokenOrListParam code, TokenOrListParam clinicalStatus, DateParam onsetDate, QuantityParam onsetAge,\n-\t        DateParam recordedData, SortSpec sort) {\n+\t        TokenOrListParam code, TokenOrListParam clinicalStatus, DateRangeParam onsetDate, QuantityParam onsetAge,\n+\t        DateRangeParam recordedData, SortSpec sort) {\n \t\tCriteria criteria = sessionFactory.getCurrentSession().createCriteria(Condition.class);\n \t\t\n \t\thandlePatientReference(criteria, patientParam);\n-\t\t// TODO during review: Do we require a \":Patient\" modifier or a \"Patient/\" type for the \"subject\" search param?\n-\t\t// And do we want to support anything other than \"Patient\" under \"subject\" based searches (e.g., \"Group\")?\n-\t\thandlePatientReference(criteria, subjectParam);\n-\t\thandleDate(\"onsetDate\", onsetDate).ifPresent(criteria::add);\n+\t\tif (patientParam == null) {\n+\t\t\thandlePatientReference(criteria, subjectParam);\n+\t\t}\n+\t\thandleDateRange(\"onsetDate\", onsetDate).ifPresent(criteria::add);\n \t\t// TODO: Handle onsetAge as well.\n-\t\thandleDate(\"dateCreated\", recordedData).ifPresent(criteria::add);\n+\t\thandleDateRange(\"dateCreated\", recordedData).ifPresent(criteria::add);\n \t\thandleOrListParam(clinicalStatus,\n \t\t    tokenParam -> Optional.of(eq(\"clinicalStatus\", convertStatus(tokenParam.getValue())))).ifPresent(criteria::add);\n \t\tif (code != null) {\n-\t\t\t// TODO add support for code system as well (not just the code value), possibly using ConceptTranslator.\n \t\t\tcriteria.createAlias(\"condition.coded\", \"cd\");\n-\t\t\tcriteria.createAlias(\"cd.conceptMappings\", \"map\");\n-\t\t\tcriteria.createAlias(\"map.conceptReferenceTerm\", \"term\");\n-\t\t\thandleOrListParam(code, tokenParam -> Optional.of(eq(\"term.code\", tokenParam.getValue())))\n-\t\t\t        .ifPresent(criteria::add);\n+\t\t\thandleResourceCode(criteria, code, \"cd\", \"map\", \"term\");\n \t\t}\n \t\t\n \t\thandleSort(criteria, sort);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzE2OTc2Mg==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/119#discussion_r397169762", "bodyText": "Use handleResourceCode() for this. We should give that function a more descriptive name... and some docs!", "author": "ibacher", "createdAt": "2020-03-24T13:54:36Z", "path": "api-2.2/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirConditionDaoImpl_2_2.java", "diffHunk": "@@ -42,6 +52,47 @@ public Condition getConditionByUuid(String uuid) {\n \t\t        .uniqueResult();\n \t}\n \t\n+\tprivate ConditionClinicalStatus convertStatus(String status) {\n+\t\tif (\"active\".equalsIgnoreCase(status)) {\n+\t\t\treturn ConditionClinicalStatus.ACTIVE;\n+\t\t}\n+\t\tif (\"inactive\".equalsIgnoreCase(status)) {\n+\t\t\treturn ConditionClinicalStatus.INACTIVE;\n+\t\t}\n+\t\t// TODO during review: What value of the spec. should be mapped to HISTORY_OF?\n+\t\t// http://www.hl7.org/fhir/valueset-condition-clinical.html\n+\t\treturn ConditionClinicalStatus.HISTORY_OF;\n+\t}\n+\t\n+\t@Override\n+\tpublic Collection<Condition> searchForConditions(ReferenceAndListParam patientParam, ReferenceAndListParam subjectParam,\n+\t        TokenOrListParam code, TokenOrListParam clinicalStatus, DateParam onsetDate, QuantityParam onsetAge,\n+\t        DateParam recordedData, SortSpec sort) {\n+\t\tCriteria criteria = sessionFactory.getCurrentSession().createCriteria(Condition.class);\n+\t\t\n+\t\thandlePatientReference(criteria, patientParam);\n+\t\t// TODO during review: Do we require a \":Patient\" modifier or a \"Patient/\" type for the \"subject\" search param?\n+\t\t// And do we want to support anything other than \"Patient\" under \"subject\" based searches (e.g., \"Group\")?\n+\t\thandlePatientReference(criteria, subjectParam);\n+\t\thandleDate(\"onsetDate\", onsetDate).ifPresent(criteria::add);\n+\t\t// TODO: Handle onsetAge as well.\n+\t\thandleDate(\"dateCreated\", recordedData).ifPresent(criteria::add);\n+\t\thandleOrListParam(clinicalStatus,\n+\t\t    tokenParam -> Optional.of(eq(\"clinicalStatus\", convertStatus(tokenParam.getValue())))).ifPresent(criteria::add);\n+\t\tif (code != null) {", "originalCommit": "86d3df5f5bb1c53e1f231b9c8271452769e5a675", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzYyNjk1OQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/119#discussion_r397626959", "bodyText": "Thanks for the suggestion; it took me a while to figure out the right query before, I wish I had noticed this :-)\nBTW, I think there was a bug in handleResourceCode(), in the case that system was provided, by assuming that conceptReferenceTermAlias is always crt (the actual bug was in generateSystemQuery). I fixed that too, PTAL.", "author": "bashir2", "createdAt": "2020-03-25T06:09:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzE2OTc2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzkxMTA4OA==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/119#discussion_r397911088", "bodyText": "Thanks! Yeah... generateSystemQuery() was written with some different assumptions. Thanks for fixing that.", "author": "ibacher", "createdAt": "2020-03-25T14:45:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzE2OTc2Mg=="}], "type": "inlineReview", "revised_code": {"commit": "df0788de7b99bbc97a6b3480f4175747b97643fd", "chunk": "diff --git a/api-2.2/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirConditionDaoImpl_2_2.java b/api-2.2/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirConditionDaoImpl_2_2.java\nindex 18dac2d0..9524051a 100644\n--- a/api-2.2/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirConditionDaoImpl_2_2.java\n+++ b/api-2.2/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirConditionDaoImpl_2_2.java\n\n@@ -59,33 +59,30 @@ public class FhirConditionDaoImpl_2_2 extends BaseDaoImpl implements FhirConditi\n \t\tif (\"inactive\".equalsIgnoreCase(status)) {\n \t\t\treturn ConditionClinicalStatus.INACTIVE;\n \t\t}\n-\t\t// TODO during review: What value of the spec. should be mapped to HISTORY_OF?\n+\t\t// Note `history_of` is not a valid value in the FHIR spec:\n \t\t// http://www.hl7.org/fhir/valueset-condition-clinical.html\n+\t\t// We are simply following the logic implemented in `ConditionClinicalStatusTranslatorImpl_2_2`.\n \t\treturn ConditionClinicalStatus.HISTORY_OF;\n \t}\n \t\n \t@Override\n \tpublic Collection<Condition> searchForConditions(ReferenceAndListParam patientParam, ReferenceAndListParam subjectParam,\n-\t        TokenOrListParam code, TokenOrListParam clinicalStatus, DateParam onsetDate, QuantityParam onsetAge,\n-\t        DateParam recordedData, SortSpec sort) {\n+\t        TokenOrListParam code, TokenOrListParam clinicalStatus, DateRangeParam onsetDate, QuantityParam onsetAge,\n+\t        DateRangeParam recordedData, SortSpec sort) {\n \t\tCriteria criteria = sessionFactory.getCurrentSession().createCriteria(Condition.class);\n \t\t\n \t\thandlePatientReference(criteria, patientParam);\n-\t\t// TODO during review: Do we require a \":Patient\" modifier or a \"Patient/\" type for the \"subject\" search param?\n-\t\t// And do we want to support anything other than \"Patient\" under \"subject\" based searches (e.g., \"Group\")?\n-\t\thandlePatientReference(criteria, subjectParam);\n-\t\thandleDate(\"onsetDate\", onsetDate).ifPresent(criteria::add);\n+\t\tif (patientParam == null) {\n+\t\t\thandlePatientReference(criteria, subjectParam);\n+\t\t}\n+\t\thandleDateRange(\"onsetDate\", onsetDate).ifPresent(criteria::add);\n \t\t// TODO: Handle onsetAge as well.\n-\t\thandleDate(\"dateCreated\", recordedData).ifPresent(criteria::add);\n+\t\thandleDateRange(\"dateCreated\", recordedData).ifPresent(criteria::add);\n \t\thandleOrListParam(clinicalStatus,\n \t\t    tokenParam -> Optional.of(eq(\"clinicalStatus\", convertStatus(tokenParam.getValue())))).ifPresent(criteria::add);\n \t\tif (code != null) {\n-\t\t\t// TODO add support for code system as well (not just the code value), possibly using ConceptTranslator.\n \t\t\tcriteria.createAlias(\"condition.coded\", \"cd\");\n-\t\t\tcriteria.createAlias(\"cd.conceptMappings\", \"map\");\n-\t\t\tcriteria.createAlias(\"map.conceptReferenceTerm\", \"term\");\n-\t\t\thandleOrListParam(code, tokenParam -> Optional.of(eq(\"term.code\", tokenParam.getValue())))\n-\t\t\t        .ifPresent(criteria::add);\n+\t\t\thandleResourceCode(criteria, code, \"cd\", \"map\", \"term\");\n \t\t}\n \t\t\n \t\thandleSort(criteria, sort);\n"}}, {"oid": "df0788de7b99bbc97a6b3480f4175747b97643fd", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/df0788de7b99bbc97a6b3480f4175747b97643fd", "message": "addressing first round of review comments", "committedDate": "2020-03-25T09:15:17Z", "type": "commit"}, {"oid": "649e0ebdfeba0a24f0c36a2db50dd7c5d627d78d", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/649e0ebdfeba0a24f0c36a2db50dd7c5d627d78d", "message": "2nd review round and more unit tests", "committedDate": "2020-03-25T20:08:16Z", "type": "commit"}, {"oid": "b29e7ac5873b32fd1d7ccf6009f005917b123d36", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/b29e7ac5873b32fd1d7ccf6009f005917b123d36", "message": "Merge branch 'master' into FM2-87", "committedDate": "2020-03-25T21:02:03Z", "type": "commit"}, {"oid": "b29e7ac5873b32fd1d7ccf6009f005917b123d36", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/b29e7ac5873b32fd1d7ccf6009f005917b123d36", "message": "Merge branch 'master' into FM2-87", "committedDate": "2020-03-25T21:02:03Z", "type": "forcePushed"}]}