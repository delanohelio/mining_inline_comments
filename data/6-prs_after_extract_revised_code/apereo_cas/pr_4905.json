{"pr_number": 4905, "pr_title": "Small enhancements to Syncope auth", "pr_createdAt": "2020-07-14T15:19:06Z", "pr_url": "https://github.com/apereo/cas/pull/4905", "timeline": [{"oid": "0f6cf5ea0696208e3b57cd1a6707890e4d4fd687", "url": "https://github.com/apereo/cas/commit/0f6cf5ea0696208e3b57cd1a6707890e4d4fd687", "message": "Small enhancements to Syncope auth", "committedDate": "2020-07-14T15:17:32Z", "type": "commit"}, {"oid": "f372180f6f3fef5a44826bf9f46c0e1236842d5d", "url": "https://github.com/apereo/cas/commit/f372180f6f3fef5a44826bf9f46c0e1236842d5d", "message": "Moving member visibility to public, for external refs", "committedDate": "2020-07-14T15:33:40Z", "type": "commit"}, {"oid": "2016e4a869bc8a57d00fc23a2eea2c058df92588", "url": "https://github.com/apereo/cas/commit/2016e4a869bc8a57d00fc23a2eea2c058df92588", "message": "Merge remote-tracking branch 'upstream/master' into SYNCOPE_AUTH_ENHANCEMENTS", "committedDate": "2020-07-15T06:32:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDg1NjQyNw==", "url": "https://github.com/apereo/cas/pull/4905#discussion_r454856427", "bodyText": "Since we are now making this public (and the ones below),\n\nYou should likely add a bit of Javadoc here. (Checkstyle is probably mad at this line already)\nIt would make better sense to me to rename these as ALLOWED_CLAIMS to stick with the accepted jargon though there is the getter below that cannot be changed. So, your call.", "author": "mmoayyed", "createdAt": "2020-07-15T07:44:19Z", "path": "support/cas-server-support-oidc-core/src/main/java/org/apereo/cas/oidc/claims/OidcAddressScopeAttributeReleasePolicy.java", "diffHunk": "@@ -17,11 +15,11 @@\n public class OidcAddressScopeAttributeReleasePolicy extends BaseOidcScopeAttributeReleasePolicy {\n     private static final long serialVersionUID = 1532960981124784595L;\n \n-    private List<String> allowedAttributes = Stream.of(\"address\").collect(Collectors.toList());\n+    public static final List<String> ALLOWED_ATTRIBUTES = List.of(\"address\");", "originalCommit": "2016e4a869bc8a57d00fc23a2eea2c058df92588", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "788bfec75dd2d9ca1032544c2a3e0a3d6bb46783", "chunk": "diff --git a/support/cas-server-support-oidc-core/src/main/java/org/apereo/cas/oidc/claims/OidcAddressScopeAttributeReleasePolicy.java b/support/cas-server-support-oidc-core/src/main/java/org/apereo/cas/oidc/claims/OidcAddressScopeAttributeReleasePolicy.java\nindex 49cbf666fd..5e0970c695 100644\n--- a/support/cas-server-support-oidc-core/src/main/java/org/apereo/cas/oidc/claims/OidcAddressScopeAttributeReleasePolicy.java\n+++ b/support/cas-server-support-oidc-core/src/main/java/org/apereo/cas/oidc/claims/OidcAddressScopeAttributeReleasePolicy.java\n\n@@ -15,11 +15,14 @@ import java.util.List;\n public class OidcAddressScopeAttributeReleasePolicy extends BaseOidcScopeAttributeReleasePolicy {\n     private static final long serialVersionUID = 1532960981124784595L;\n \n-    public static final List<String> ALLOWED_ATTRIBUTES = List.of(\"address\");\n+    /**\n+     * Claims allowed by this attribute release policy.\n+     */\n+    public static final List<String> ALLOWED_CLAIMS = List.of(\"address\");\n \n     public OidcAddressScopeAttributeReleasePolicy() {\n         super(OidcConstants.StandardScopes.ADDRESS.getScope());\n-        setAllowedAttributes(ALLOWED_ATTRIBUTES);\n+        setAllowedAttributes(ALLOWED_CLAIMS);\n     }\n \n     @JsonIgnore\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDg1NjkwOA==", "url": "https://github.com/apereo/cas/pull/4905#discussion_r454856908", "bodyText": "This is all excellent. For all new lines, you should additionally modify the related test for the handler to make sure these are covered.", "author": "mmoayyed", "createdAt": "2020-07-15T07:45:13Z", "path": "support/cas-server-support-syncope-authentication/src/main/java/org/apereo/cas/syncope/authentication/SyncopeAuthenticationHandler.java", "diffHunk": "@@ -124,14 +117,24 @@ public SyncopeAuthenticationHandler(final String name,\n \n         if (user.has(\"relationships\")) {\n             user.get(\"relationships\").forEach(r -> attributes.put(\n-                \"syncopeUserRelationships\" + r.get(\"type\").asText(),\n-                List.of(r.get(\"otherEndName\").asText())));\n+                    \"syncopeUserRelationships\" + r.get(\"type\").asText(),\n+                    List.of(r.get(\"otherEndName\").asText())));\n         }\n \n         if (user.has(\"plainAttrs\")) {\n             user.get(\"plainAttrs\").forEach(a -> attributes.put(\n-                \"syncopeUserAttr\" + a.get(\"schema\").asText(),\n-                MAPPER.convertValue(a.get(\"values\"), ArrayList.class)));\n+                    \"syncopeUserAttr_\" + a.get(\"schema\").asText(),\n+                    MAPPER.convertValue(a.get(\"values\"), ArrayList.class)));\n+        }\n+        if (user.has(\"derAttrs\")) {\n+            user.get(\"derAttrs\").forEach(a -> attributes.put(\n+                    \"syncopeUserAttr_\" + a.get(\"schema\").asText(),\n+                    MAPPER.convertValue(a.get(\"values\"), ArrayList.class)));\n+        }\n+        if (user.has(\"virAttrs\")) {\n+            user.get(\"virAttrs\").forEach(a -> attributes.put(\n+                    \"syncopeUserAttr_\" + a.get(\"schema\").asText(),\n+                    MAPPER.convertValue(a.get(\"values\"), ArrayList.class)));", "originalCommit": "2016e4a869bc8a57d00fc23a2eea2c058df92588", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "788bfec75dd2d9ca1032544c2a3e0a3d6bb46783", "url": "https://github.com/apereo/cas/commit/788bfec75dd2d9ca1032544c2a3e0a3d6bb46783", "message": "Addressing review comments", "committedDate": "2020-07-15T08:06:02Z", "type": "commit"}]}