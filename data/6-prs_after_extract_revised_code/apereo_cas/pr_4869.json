{"pr_number": 4869, "pr_title": "fix bean creation error and fix saml metadata resolver", "pr_createdAt": "2020-05-27T05:33:37Z", "pr_url": "https://github.com/apereo/cas/pull/4869", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDkyNTY4OA==", "url": "https://github.com/apereo/cas/pull/4869#discussion_r430925688", "bodyText": "This should follow the same approach as https://github.com/apereo/cas/blob/master/support/cas-server-support-saml-idp-metadata/src/main/java/org/apereo/cas/support/saml/services/idp/metadata/cache/resolver/UrlResourceMetadataResolver.java#L67-L69", "author": "mmoayyed", "createdAt": "2020-05-27T07:55:16Z", "path": "support/cas-server-support-saml-idp-metadata/src/main/java/org/apereo/cas/support/saml/services/idp/metadata/cache/resolver/JsonResourceMetadataResolver.java", "diffHunk": "@@ -60,7 +61,10 @@ public JsonResourceMetadataResolver(final SamlIdPProperties samlIdPProperties,\n             this.metadataTemplate = IOUtils.toString(inputStream, StandardCharsets.UTF_8);\n             val md = samlIdPProperties.getMetadata();\n             val location = SpringExpressionLanguageValueResolver.getInstance().resolve(md.getLocation());\n-            this.jsonResource = new FileSystemResource(new File(location, \"saml-sp-metadata.json\"));\n+            val normalizedLocation = location.startsWith(\"file:\") ? location : \"file:\" + location;\n+            val resourceLoader = new DefaultResourceLoader();\n+            val metadataDir = resourceLoader.getResource(normalizedLocation).getFile();\n+            this.jsonResource = new FileSystemResource(new File(metadataDir, \"saml-sp-metadata.json\"));", "originalCommit": "f8c4271c69130fce2ee79cf8ac474d5148d1d7f4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "abb90819fb8e16010d4e99b696942136702d3235", "chunk": "diff --git a/support/cas-server-support-saml-idp-metadata/src/main/java/org/apereo/cas/support/saml/services/idp/metadata/cache/resolver/JsonResourceMetadataResolver.java b/support/cas-server-support-saml-idp-metadata/src/main/java/org/apereo/cas/support/saml/services/idp/metadata/cache/resolver/JsonResourceMetadataResolver.java\nindex 02f4cf797f..d6e6f0fcb7 100644\n--- a/support/cas-server-support-saml-idp-metadata/src/main/java/org/apereo/cas/support/saml/services/idp/metadata/cache/resolver/JsonResourceMetadataResolver.java\n+++ b/support/cas-server-support-saml-idp-metadata/src/main/java/org/apereo/cas/support/saml/services/idp/metadata/cache/resolver/JsonResourceMetadataResolver.java\n\n@@ -61,9 +60,7 @@ public class JsonResourceMetadataResolver extends BaseSamlRegisteredServiceMetad\n             this.metadataTemplate = IOUtils.toString(inputStream, StandardCharsets.UTF_8);\n             val md = samlIdPProperties.getMetadata();\n             val location = SpringExpressionLanguageValueResolver.getInstance().resolve(md.getLocation());\n-            val normalizedLocation = location.startsWith(\"file:\") ? location : \"file:\" + location;\n-            val resourceLoader = new DefaultResourceLoader();\n-            val metadataDir = resourceLoader.getResource(normalizedLocation).getFile();\n+            val metadataDir = ResourceUtils.getRawResourceFrom(location).getFile();\n             this.jsonResource = new FileSystemResource(new File(metadataDir, \"saml-sp-metadata.json\"));\n             if (this.jsonResource.exists()) {\n                 this.metadataMap = readDecisionsFromJsonResource();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDkyNjAxOA==", "url": "https://github.com/apereo/cas/pull/4869#discussion_r430926018", "bodyText": "It would be best to actually set the property value to always make sure the test is accurate, in cas the default ever changes.", "author": "mmoayyed", "createdAt": "2020-05-27T07:55:48Z", "path": "support/cas-server-support-saml-idp-metadata/src/test/java/org/apereo/cas/support/saml/services/idp/metadata/cache/resolver/JsonResourceMetadataResolverTests.java", "diffHunk": "@@ -49,4 +50,14 @@ public void verifyResolverResolves() throws Exception {\n         val resolved = metadataResolver.resolveSingle(new CriteriaSet(new EntityIdCriterion(\"https://example.org/saml\")));\n         assertNotNull(resolved);\n     }\n+\n+    /**\n+     * Make sure default file:/etc/cas/saml URI is processed.\n+     */\n+    @Test\n+    public void verifyResolverResolvesWithFileUri() throws Exception {\n+        val props = new SamlIdPProperties();\n+        val resolver = new JsonResourceMetadataResolver(props, openSamlConfigBean);", "originalCommit": "f8c4271c69130fce2ee79cf8ac474d5148d1d7f4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "abb90819fb8e16010d4e99b696942136702d3235", "chunk": "diff --git a/support/cas-server-support-saml-idp-metadata/src/test/java/org/apereo/cas/support/saml/services/idp/metadata/cache/resolver/JsonResourceMetadataResolverTests.java b/support/cas-server-support-saml-idp-metadata/src/test/java/org/apereo/cas/support/saml/services/idp/metadata/cache/resolver/JsonResourceMetadataResolverTests.java\nindex 2479e3acb9..05734d89df 100644\n--- a/support/cas-server-support-saml-idp-metadata/src/test/java/org/apereo/cas/support/saml/services/idp/metadata/cache/resolver/JsonResourceMetadataResolverTests.java\n+++ b/support/cas-server-support-saml-idp-metadata/src/test/java/org/apereo/cas/support/saml/services/idp/metadata/cache/resolver/JsonResourceMetadataResolverTests.java\n\n@@ -52,11 +52,12 @@ public class JsonResourceMetadataResolverTests extends BaseSamlIdPServicesTests\n     }\n \n     /**\n-     * Make sure default file:/etc/cas/saml URI is processed.\n+     * Make sure default file:/etc/cas/saml URI syntax is parsed correctly.\n      */\n     @Test\n     public void verifyResolverResolvesWithFileUri() throws Exception {\n         val props = new SamlIdPProperties();\n+        props.getMetadata().setLocation(\"file:/etc/cas/saml\");\n         val resolver = new JsonResourceMetadataResolver(props, openSamlConfigBean);\n         assertNotNull(resolver);\n     }\n"}}, {"oid": "abb90819fb8e16010d4e99b696942136702d3235", "url": "https://github.com/apereo/cas/commit/abb90819fb8e16010d4e99b696942136702d3235", "message": "fix bean creation error by turning on proxying\n\nfix JsonResourceMetadataResolver so it handles defuault metadata\nlocation of file:/etc/cas/saml", "committedDate": "2020-05-27T13:04:46Z", "type": "commit"}, {"oid": "abb90819fb8e16010d4e99b696942136702d3235", "url": "https://github.com/apereo/cas/commit/abb90819fb8e16010d4e99b696942136702d3235", "message": "fix bean creation error by turning on proxying\n\nfix JsonResourceMetadataResolver so it handles defuault metadata\nlocation of file:/etc/cas/saml", "committedDate": "2020-05-27T13:04:46Z", "type": "forcePushed"}, {"oid": "6dba9956278c62db08add6e1010230df31a34bc5", "url": "https://github.com/apereo/cas/commit/6dba9956278c62db08add6e1010230df31a34bc5", "message": "Merge branch 'master' into ldapbeanfix2", "committedDate": "2020-05-27T18:35:51Z", "type": "commit"}]}