{"pr_number": 4692, "pr_title": "Password Management Token & Server/Client IP Address check", "pr_createdAt": "2020-02-12T21:50:46Z", "pr_url": "https://github.com/apereo/cas/pull/4692", "timeline": [{"oid": "e4d23deedd899af6ba2146b1212539998ceddbf4", "url": "https://github.com/apereo/cas/commit/e4d23deedd899af6ba2146b1212539998ceddbf4", "message": " Password Management Token : Add the capability to disable the check of the client/server ip address.", "committedDate": "2020-02-12T21:27:25Z", "type": "commit"}, {"oid": "a43f1d0473745f4def9a7ac2f40a41b72b361b8c", "url": "https://github.com/apereo/cas/commit/a43f1d0473745f4def9a7ac2f40a41b72b361b8c", "message": "Merge branch '6.1.x' into 6.1.x", "committedDate": "2020-02-13T02:37:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODY5ODg1MA==", "url": "https://github.com/apereo/cas/pull/4692#discussion_r378698850", "bodyText": "Rename to includeServerIpAddress or something similar", "author": "mmoayyed", "createdAt": "2020-02-13T07:55:32Z", "path": "api/cas-server-core-api-configuration-model/src/main/java/org/apereo/cas/configuration/model/support/pm/PasswordManagementProperties.java", "diffHunk": "@@ -266,6 +266,16 @@ public ForgotUsername() {\n          */\n         private boolean securityQuestionsEnabled = true;\n \n+        /**\n+         * Whether the Password Management Token will contain the server IP Address.\n+         */\n+        private boolean checkServerIpAddress = true;", "originalCommit": "a43f1d0473745f4def9a7ac2f40a41b72b361b8c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE2NjQxMA==", "url": "https://github.com/apereo/cas/pull/4692#discussion_r379166410", "bodyText": "Done", "author": "julienhuon", "createdAt": "2020-02-13T22:58:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODY5ODg1MA=="}], "type": "inlineReview", "revised_code": {"commit": "f07ac965b0a74e6c83c0613abaee6891cccd808d", "chunk": "diff --git a/api/cas-server-core-api-configuration-model/src/main/java/org/apereo/cas/configuration/model/support/pm/PasswordManagementProperties.java b/api/cas-server-core-api-configuration-model/src/main/java/org/apereo/cas/configuration/model/support/pm/PasswordManagementProperties.java\nindex 4b38878495..00607d1acc 100644\n--- a/api/cas-server-core-api-configuration-model/src/main/java/org/apereo/cas/configuration/model/support/pm/PasswordManagementProperties.java\n+++ b/api/cas-server-core-api-configuration-model/src/main/java/org/apereo/cas/configuration/model/support/pm/PasswordManagementProperties.java\n\n@@ -269,12 +269,12 @@ public class PasswordManagementProperties implements Serializable {\n         /**\n          * Whether the Password Management Token will contain the server IP Address.\n          */\n-        private boolean checkServerIpAddress = true;\n+        private boolean includeServerIpAddress = true;\n \n         /**\n          * Whether the Password Management Token will contain the client IP Address.\n          */\n-        private boolean checkClientIpAddress = true;\n+        private boolean includeClientIpAddress = true;\n \n         /**\n          * How long in minutes should the password expiration link remain valid.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODY5ODkyNg==", "url": "https://github.com/apereo/cas/pull/4692#discussion_r378698926", "bodyText": "Rename to includeClientIpAddress or something similar", "author": "mmoayyed", "createdAt": "2020-02-13T07:55:45Z", "path": "api/cas-server-core-api-configuration-model/src/main/java/org/apereo/cas/configuration/model/support/pm/PasswordManagementProperties.java", "diffHunk": "@@ -266,6 +266,16 @@ public ForgotUsername() {\n          */\n         private boolean securityQuestionsEnabled = true;\n \n+        /**\n+         * Whether the Password Management Token will contain the server IP Address.\n+         */\n+        private boolean checkServerIpAddress = true;\n+\n+        /**\n+         * Whether the Password Management Token will contain the client IP Address.\n+         */\n+        private boolean checkClientIpAddress = true;", "originalCommit": "a43f1d0473745f4def9a7ac2f40a41b72b361b8c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE2NjQ2MA==", "url": "https://github.com/apereo/cas/pull/4692#discussion_r379166460", "bodyText": "Done", "author": "julienhuon", "createdAt": "2020-02-13T22:58:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODY5ODkyNg=="}], "type": "inlineReview", "revised_code": {"commit": "f07ac965b0a74e6c83c0613abaee6891cccd808d", "chunk": "diff --git a/api/cas-server-core-api-configuration-model/src/main/java/org/apereo/cas/configuration/model/support/pm/PasswordManagementProperties.java b/api/cas-server-core-api-configuration-model/src/main/java/org/apereo/cas/configuration/model/support/pm/PasswordManagementProperties.java\nindex 4b38878495..00607d1acc 100644\n--- a/api/cas-server-core-api-configuration-model/src/main/java/org/apereo/cas/configuration/model/support/pm/PasswordManagementProperties.java\n+++ b/api/cas-server-core-api-configuration-model/src/main/java/org/apereo/cas/configuration/model/support/pm/PasswordManagementProperties.java\n\n@@ -269,12 +269,12 @@ public class PasswordManagementProperties implements Serializable {\n         /**\n          * Whether the Password Management Token will contain the server IP Address.\n          */\n-        private boolean checkServerIpAddress = true;\n+        private boolean includeServerIpAddress = true;\n \n         /**\n          * Whether the Password Management Token will contain the client IP Address.\n          */\n-        private boolean checkClientIpAddress = true;\n+        private boolean includeClientIpAddress = true;\n \n         /**\n          * How long in minutes should the password expiration link remain valid.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODY5OTA3NA==", "url": "https://github.com/apereo/cas/pull/4692#discussion_r378699074", "bodyText": "Extract properties.getRest() into a variable.", "author": "mmoayyed", "createdAt": "2020-02-13T07:56:08Z", "path": "support/cas-server-support-pm-core/src/main/java/org/apereo/cas/pm/BasePasswordManagementService.java", "diffHunk": "@@ -74,11 +74,11 @@ public String parseToken(final String token) {\n             }\n \n             val holder = ClientInfoHolder.getClientInfo();\n-            if (!claims.getStringClaimValue(\"origin\").equals(holder.getServerIpAddress())) {\n+            if (properties.getReset().isCheckServerIpAddress() && !claims.getStringClaimValue(\"origin\").equals(holder.getServerIpAddress())) {\n                 LOGGER.error(\"Token origin server IP address does not match CAS\");\n                 return null;\n             }\n-            if (!claims.getStringClaimValue(\"client\").equals(holder.getClientIpAddress())) {\n+            if (properties.getReset().isCheckClientIpAddress() && !claims.getStringClaimValue(\"client\").equals(holder.getClientIpAddress())) {\n                 LOGGER.error(\"Token client IP address does not match CAS\");", "originalCommit": "a43f1d0473745f4def9a7ac2f40a41b72b361b8c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE2NjQ4Mg==", "url": "https://github.com/apereo/cas/pull/4692#discussion_r379166482", "bodyText": "Done", "author": "julienhuon", "createdAt": "2020-02-13T22:58:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODY5OTA3NA=="}], "type": "inlineReview", "revised_code": {"commit": "f07ac965b0a74e6c83c0613abaee6891cccd808d", "chunk": "diff --git a/support/cas-server-support-pm-core/src/main/java/org/apereo/cas/pm/BasePasswordManagementService.java b/support/cas-server-support-pm-core/src/main/java/org/apereo/cas/pm/BasePasswordManagementService.java\nindex 32cb7ffc1a..691c2a5bc6 100644\n--- a/support/cas-server-support-pm-core/src/main/java/org/apereo/cas/pm/BasePasswordManagementService.java\n+++ b/support/cas-server-support-pm-core/src/main/java/org/apereo/cas/pm/BasePasswordManagementService.java\n\n@@ -74,11 +75,11 @@ public class BasePasswordManagementService implements PasswordManagementService\n             }\n \n             val holder = ClientInfoHolder.getClientInfo();\n-            if (properties.getReset().isCheckServerIpAddress() && !claims.getStringClaimValue(\"origin\").equals(holder.getServerIpAddress())) {\n+            if (resetProperties.isIncludeServerIpAddress() && !claims.getStringClaimValue(\"origin\").equals(holder.getServerIpAddress())) {\n                 LOGGER.error(\"Token origin server IP address does not match CAS\");\n                 return null;\n             }\n-            if (properties.getReset().isCheckClientIpAddress() && !claims.getStringClaimValue(\"client\").equals(holder.getClientIpAddress())) {\n+            if (resetProperties.isIncludeClientIpAddress() && !claims.getStringClaimValue(\"client\").equals(holder.getClientIpAddress())) {\n                 LOGGER.error(\"Token client IP address does not match CAS\");\n                 return null;\n             }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODY5OTE2Ng==", "url": "https://github.com/apereo/cas/pull/4692#discussion_r378699166", "bodyText": "Extract properties.getRest() into a variable.", "author": "mmoayyed", "createdAt": "2020-02-13T07:56:23Z", "path": "support/cas-server-support-pm-core/src/main/java/org/apereo/cas/pm/BasePasswordManagementService.java", "diffHunk": "@@ -110,8 +110,12 @@ public String createToken(final String to) {\n \n             val holder = ClientInfoHolder.getClientInfo();\n             if (holder != null) {\n-                claims.setStringClaim(\"origin\", holder.getServerIpAddress());\n-                claims.setStringClaim(\"client\", holder.getClientIpAddress());\n+                if (properties.getReset().isCheckServerIpAddress()) {\n+                    claims.setStringClaim(\"origin\", holder.getServerIpAddress());\n+                }\n+                if (properties.getReset().isCheckClientIpAddress()) {\n+                    claims.setStringClaim(\"client\", holder.getClientIpAddress());\n+                }", "originalCommit": "a43f1d0473745f4def9a7ac2f40a41b72b361b8c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE2NjUyMQ==", "url": "https://github.com/apereo/cas/pull/4692#discussion_r379166521", "bodyText": "Done", "author": "julienhuon", "createdAt": "2020-02-13T22:58:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODY5OTE2Ng=="}], "type": "inlineReview", "revised_code": {"commit": "f07ac965b0a74e6c83c0613abaee6891cccd808d", "chunk": "diff --git a/support/cas-server-support-pm-core/src/main/java/org/apereo/cas/pm/BasePasswordManagementService.java b/support/cas-server-support-pm-core/src/main/java/org/apereo/cas/pm/BasePasswordManagementService.java\nindex 32cb7ffc1a..691c2a5bc6 100644\n--- a/support/cas-server-support-pm-core/src/main/java/org/apereo/cas/pm/BasePasswordManagementService.java\n+++ b/support/cas-server-support-pm-core/src/main/java/org/apereo/cas/pm/BasePasswordManagementService.java\n\n@@ -102,18 +103,19 @@ public class BasePasswordManagementService implements PasswordManagementService\n         try {\n             val token = UUID.randomUUID().toString();\n             val claims = new JwtClaims();\n+            val resetProperties = properties.getReset();\n             claims.setJwtId(token);\n             claims.setIssuer(issuer);\n             claims.setAudience(issuer);\n-            claims.setExpirationTimeMinutesInTheFuture(properties.getReset().getExpirationMinutes());\n+            claims.setExpirationTimeMinutesInTheFuture(resetProperties.getExpirationMinutes());\n             claims.setIssuedAtToNow();\n \n             val holder = ClientInfoHolder.getClientInfo();\n             if (holder != null) {\n-                if (properties.getReset().isCheckServerIpAddress()) {\n+                if (resetProperties.isIncludeServerIpAddress()) {\n                     claims.setStringClaim(\"origin\", holder.getServerIpAddress());\n                 }\n-                if (properties.getReset().isCheckClientIpAddress()) {\n+                if (resetProperties.isIncludeClientIpAddress()) {\n                     claims.setStringClaim(\"client\", holder.getClientIpAddress());\n                 }\n             }\n"}}, {"oid": "41e4d91f7e50e9a4fbc39f588c3fdcaa2283bdd1", "url": "https://github.com/apereo/cas/commit/41e4d91f7e50e9a4fbc39f588c3fdcaa2283bdd1", "message": "Merge branch '6.1.x' into 6.1.x", "committedDate": "2020-02-13T08:36:59Z", "type": "commit"}, {"oid": "b2b4fb2b679bb34dcc995c8767e115fb928f1290", "url": "https://github.com/apereo/cas/commit/b2b4fb2b679bb34dcc995c8767e115fb928f1290", "message": "Merge branch '6.1.x' into 6.1.x", "committedDate": "2020-02-13T11:57:02Z", "type": "commit"}, {"oid": "69ca66b7d9b0e2dec742d8fa47ff8f69028123f7", "url": "https://github.com/apereo/cas/commit/69ca66b7d9b0e2dec742d8fa47ff8f69028123f7", "message": "Merge branch '6.1.x' into 6.1.x", "committedDate": "2020-02-13T13:27:02Z", "type": "commit"}, {"oid": "f958ea55ced8f6133f97ba9267b7b5d2b86f7a0a", "url": "https://github.com/apereo/cas/commit/f958ea55ced8f6133f97ba9267b7b5d2b86f7a0a", "message": "Merge branch '6.1.x' into 6.1.x", "committedDate": "2020-02-13T14:57:02Z", "type": "commit"}, {"oid": "f57072e09d4074840bfc79439cb0ec25241b7e87", "url": "https://github.com/apereo/cas/commit/f57072e09d4074840bfc79439cb0ec25241b7e87", "message": "Merge branch '6.1.x' into 6.1.x", "committedDate": "2020-02-13T16:27:02Z", "type": "commit"}, {"oid": "48dbfdcb53a203297cba56cd8f8915d71fb4414d", "url": "https://github.com/apereo/cas/commit/48dbfdcb53a203297cba56cd8f8915d71fb4414d", "message": "Merge branch '6.1.x' into 6.1.x", "committedDate": "2020-02-13T17:57:01Z", "type": "commit"}, {"oid": "fdfaa4814b0b879aea3700ff838b540340263140", "url": "https://github.com/apereo/cas/commit/fdfaa4814b0b879aea3700ff838b540340263140", "message": "Merge branch '6.1.x' into 6.1.x", "committedDate": "2020-02-13T19:27:03Z", "type": "commit"}, {"oid": "f07ac965b0a74e6c83c0613abaee6891cccd808d", "url": "https://github.com/apereo/cas/commit/f07ac965b0a74e6c83c0613abaee6891cccd808d", "message": "code improvement", "committedDate": "2020-02-13T22:57:15Z", "type": "commit"}, {"oid": "9e76aae022de7a52739f05f029334a869b5d3d91", "url": "https://github.com/apereo/cas/commit/9e76aae022de7a52739f05f029334a869b5d3d91", "message": "Merge branch '6.1.x' into 6.1.x", "committedDate": "2020-02-14T04:27:00Z", "type": "commit"}]}