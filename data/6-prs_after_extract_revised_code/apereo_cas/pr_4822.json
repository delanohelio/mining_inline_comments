{"pr_number": 4822, "pr_title": "improve ticket expiration policies - throttled timeout", "pr_createdAt": "2020-04-21T02:44:32Z", "pr_url": "https://github.com/apereo/cas/pull/4822", "timeline": [{"oid": "67bb6de442ab32650b76abbe75cafb9caff1b4cf", "url": "https://github.com/apereo/cas/commit/67bb6de442ab32650b76abbe75cafb9caff1b4cf", "message": "fixes throttled use expiration policy", "committedDate": "2020-04-20T17:52:38Z", "type": "commit"}, {"oid": "d7fa22ab9921a8d8d079e3d38d28c5d9d4bea885", "url": "https://github.com/apereo/cas/commit/d7fa22ab9921a8d8d079e3d38d28c5d9d4bea885", "message": "update unit tests", "committedDate": "2020-04-25T14:24:15Z", "type": "commit"}, {"oid": "e71ab05875616098f5f4cab1ddfb34afbfd0bd4f", "url": "https://github.com/apereo/cas/commit/e71ab05875616098f5f4cab1ddfb34afbfd0bd4f", "message": "code styling fixes", "committedDate": "2020-04-26T11:12:01Z", "type": "forcePushed"}, {"oid": "493fc520541e789d6ab3451a9a0a28d6c45df1a9", "url": "https://github.com/apereo/cas/commit/493fc520541e789d6ab3451a9a0a28d6c45df1a9", "message": "code styling fixes", "committedDate": "2020-04-27T08:31:36Z", "type": "commit"}, {"oid": "493fc520541e789d6ab3451a9a0a28d6c45df1a9", "url": "https://github.com/apereo/cas/commit/493fc520541e789d6ab3451a9a0a28d6c45df1a9", "message": "code styling fixes", "committedDate": "2020-04-27T08:31:36Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTgzNDkzOA==", "url": "https://github.com/apereo/cas/pull/4822#discussion_r415834938", "bodyText": "This should be removed as a class field; it will mess with serialization of objects.", "author": "mmoayyed", "createdAt": "2020-04-27T13:57:01Z", "path": "core/cas-server-core-tickets-api/src/main/java/org/apereo/cas/ticket/expiration/ThrottledUseAndTimeoutExpirationPolicy.java", "diffHunk": "@@ -43,6 +44,8 @@\n \n     private long timeInBetweenUsesInSeconds;\n \n+    private Clock clock = Clock.systemUTC();", "originalCommit": "493fc520541e789d6ab3451a9a0a28d6c45df1a9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTkwODIxNQ==", "url": "https://github.com/apereo/cas/pull/4822#discussion_r415908215", "bodyText": "Can we exclude this field from serialization? like Transient?", "author": "potato04", "createdAt": "2020-04-27T15:23:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTgzNDkzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjA0ODM0Mw==", "url": "https://github.com/apereo/cas/pull/4822#discussion_r416048343", "bodyText": "You could, but then you'll risk null-pointer-exceptions when the object is constructed back.\nAlso, it doesn't make sense to add a field only for it to be used in tests. If that is case, the test should be rewritten to not require an extra field.", "author": "mmoayyed", "createdAt": "2020-04-27T18:25:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTgzNDkzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQzMzg4OA==", "url": "https://github.com/apereo/cas/pull/4822#discussion_r416433888", "bodyText": "Reviewed this some more, and on second thought, should be fine. Thanks!", "author": "mmoayyed", "createdAt": "2020-04-28T08:36:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTgzNDkzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjU3OTE1Mw==", "url": "https://github.com/apereo/cas/pull/4822#discussion_r416579153", "bodyText": "Wow, thank you for your understanding!  How about moving the clock filed into the abstract expiration policy class AbstractCasExpirationPolicy?  so we can write better unit tests for other child policies.", "author": "potato04", "createdAt": "2020-04-28T12:40:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTgzNDkzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjU4NTU3Mg==", "url": "https://github.com/apereo/cas/pull/4822#discussion_r416585572", "bodyText": "Pleasure!\nImproving tests is always a big win in my book. So, yes! That would be a welcome change and I think perhaps with that, a number of Thread.sleep() calls can also be removed.\nKeep up the good work.", "author": "mmoayyed", "createdAt": "2020-04-28T12:50:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTgzNDkzOA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTgzNTMxNg==", "url": "https://github.com/apereo/cas/pull/4822#discussion_r415835316", "bodyText": "What's the difference between what exists and your change?", "author": "mmoayyed", "createdAt": "2020-04-27T13:57:33Z", "path": "core/cas-server-core-tickets-api/src/main/java/org/apereo/cas/ticket/expiration/ThrottledUseAndTimeoutExpirationPolicy.java", "diffHunk": "@@ -53,15 +56,13 @@ public ThrottledUseAndTimeoutExpirationPolicy(@JsonProperty(\"timeToLive\") final\n     public boolean isExpired(final TicketState ticketState) {\n         LOGGER.trace(\"Checking validity of ticket [{}]\", ticketState);\n         val lastTimeUsed = ticketState.getLastTimeUsed();\n-        val currentTime = ZonedDateTime.now(ZoneOffset.UTC);\n+        val currentTime = ZonedDateTime.now(clock);", "originalCommit": "493fc520541e789d6ab3451a9a0a28d6c45df1a9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTg4Nzk0Ng==", "url": "https://github.com/apereo/cas/pull/4822#discussion_r415887946", "bodyText": "After this modification, we can change the currentTime to any specified time in unit tests, and being able to check the expiration of TGT at 0.99s(should be valid) or 1s(should be expired) after last use, this can not be handled by Thread.sleep() method.", "author": "potato04", "createdAt": "2020-04-27T14:59:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTgzNTMxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTkxOTA3NA==", "url": "https://github.com/apereo/cas/pull/4822#discussion_r415919074", "bodyText": "Like this in Spring source code:\nhttps://github.com/spring-projects/spring-framework/blob/9277b470404ce1dce790fa82e684c9d8220940e7/spring-web/src/main/java/org/springframework/web/server/session/InMemoryWebSessionStore.java#L80-L93", "author": "potato04", "createdAt": "2020-04-27T15:36:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTgzNTMxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQzNDAzNA==", "url": "https://github.com/apereo/cas/pull/4822#discussion_r416434034", "bodyText": "Thanks for the reference.", "author": "mmoayyed", "createdAt": "2020-04-28T08:37:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTgzNTMxNg=="}], "type": "inlineReview", "revised_code": null}]}