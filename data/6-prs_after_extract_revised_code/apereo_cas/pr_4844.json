{"pr_number": 4844, "pr_title": "Fix ldap connection pool shut down - phase 1", "pr_createdAt": "2020-05-09T11:55:03Z", "pr_url": "https://github.com/apereo/cas/pull/4844", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk1MjA3Mw==", "url": "https://github.com/apereo/cas/pull/4844#discussion_r422952073", "bodyText": "Move out of the configuration class and into its own independent package.", "author": "mmoayyed", "createdAt": "2020-05-11T10:47:14Z", "path": "core/cas-server-core-util/src/main/java/org/apereo/cas/config/CasCoreUtilConfiguration.java", "diffHunk": "@@ -115,6 +125,68 @@ public SmsSender smsSender() {\n         return SmsSender.noOp();\n     }\n \n+    @Bean\n+    public BeanPostProcessor getDestroyPrototypeBeansPostProcessor() {\n+        return new DestroyPrototypeBeansPostProcessor();\n+    }\n+\n+    private static class DestroyPrototypeBeansPostProcessor implements BeanPostProcessor, DisposableBean, BeanFactoryAware {", "originalCommit": "c62239aaeb69bbe7331650ba69756f116fb0c62d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "762b5913f62ed82d810f55ff09b7637b50163671", "chunk": "diff --git a/core/cas-server-core-util/src/main/java/org/apereo/cas/config/CasCoreUtilConfiguration.java b/core/cas-server-core-util/src/main/java/org/apereo/cas/config/CasCoreUtilConfiguration.java\nindex 767201b3d9..e3f138d012 100644\n--- a/core/cas-server-core-util/src/main/java/org/apereo/cas/config/CasCoreUtilConfiguration.java\n+++ b/core/cas-server-core-util/src/main/java/org/apereo/cas/config/CasCoreUtilConfiguration.java\n\n@@ -125,68 +115,6 @@ public class CasCoreUtilConfiguration implements InitializingBean {\n         return SmsSender.noOp();\n     }\n \n-    @Bean\n-    public BeanPostProcessor getDestroyPrototypeBeansPostProcessor() {\n-        return new DestroyPrototypeBeansPostProcessor();\n-    }\n-\n-    private static class DestroyPrototypeBeansPostProcessor implements BeanPostProcessor, DisposableBean, BeanFactoryAware {\n-\n-        @Getter\n-        private static class BeanTuple {\n-            private String name;\n-            private DisposableBean bean;\n-\n-            BeanTuple(final String name, final DisposableBean bean) {\n-                this.name = name;\n-                this.bean = bean;\n-            }\n-        }\n-\n-        private final ArrayList<BeanTuple> prototypeBeans = new ArrayList<>();\n-\n-        private BeanFactory beanFactory;\n-\n-        @Override\n-        public void setBeanFactory(final BeanFactory beanFactory) throws BeansException {\n-            this.beanFactory = beanFactory;\n-        }\n-\n-        @Override\n-        public Object postProcessAfterInitialization(final Object bean, final String beanName)\n-                throws BeansException {\n-            try {\n-                if (bean instanceof DisposableBean && beanFactory.isPrototype(beanName)) {\n-                    LOGGER.debug(\"Registering prototype bean {}\", beanName);\n-                    synchronized (prototypeBeans) {\n-                        prototypeBeans.add(new BeanTuple(beanName, (DisposableBean) bean));\n-                    }\n-                }\n-            } catch (final NoSuchBeanDefinitionException e) {\n-                if (LOGGER.isTraceEnabled()) {\n-                    LOGGER.trace(\"Bean {} not found\", beanName);\n-                }\n-            }\n-\n-            return bean;\n-        }\n-\n-        @Override\n-        public void destroy() {\n-            LOGGER.debug(\"Destroying prototype beans\");\n-            synchronized (prototypeBeans) {\n-                prototypeBeans.forEach(beanTuple -> {\n-                    try {\n-                        LOGGER.debug(\"Destroying prototype bean {}\", beanTuple.getName());\n-                        beanTuple.getBean().destroy();\n-                    } catch (final Exception e) {\n-                        LOGGER.warn(\"Unable to dispose prototype bean {}: {}\", beanTuple.getName(), e.getMessage());\n-                    }\n-                });\n-            }\n-        }\n-    }\n-\n     /**\n      * It's important to invoke the {@link #casApplicationContextProvider()}\n      * method here forcefully and not rely on the {@link #applicationContext}.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk1MjIyMg==", "url": "https://github.com/apereo/cas/pull/4844#discussion_r422952222", "bodyText": "Rename bean to be consistent with everything else (there is no get)", "author": "mmoayyed", "createdAt": "2020-05-11T10:47:33Z", "path": "core/cas-server-core-util/src/main/java/org/apereo/cas/config/CasCoreUtilConfiguration.java", "diffHunk": "@@ -115,6 +125,68 @@ public SmsSender smsSender() {\n         return SmsSender.noOp();\n     }\n \n+    @Bean\n+    public BeanPostProcessor getDestroyPrototypeBeansPostProcessor() {", "originalCommit": "c62239aaeb69bbe7331650ba69756f116fb0c62d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "762b5913f62ed82d810f55ff09b7637b50163671", "chunk": "diff --git a/core/cas-server-core-util/src/main/java/org/apereo/cas/config/CasCoreUtilConfiguration.java b/core/cas-server-core-util/src/main/java/org/apereo/cas/config/CasCoreUtilConfiguration.java\nindex 767201b3d9..e3f138d012 100644\n--- a/core/cas-server-core-util/src/main/java/org/apereo/cas/config/CasCoreUtilConfiguration.java\n+++ b/core/cas-server-core-util/src/main/java/org/apereo/cas/config/CasCoreUtilConfiguration.java\n\n@@ -125,68 +115,6 @@ public class CasCoreUtilConfiguration implements InitializingBean {\n         return SmsSender.noOp();\n     }\n \n-    @Bean\n-    public BeanPostProcessor getDestroyPrototypeBeansPostProcessor() {\n-        return new DestroyPrototypeBeansPostProcessor();\n-    }\n-\n-    private static class DestroyPrototypeBeansPostProcessor implements BeanPostProcessor, DisposableBean, BeanFactoryAware {\n-\n-        @Getter\n-        private static class BeanTuple {\n-            private String name;\n-            private DisposableBean bean;\n-\n-            BeanTuple(final String name, final DisposableBean bean) {\n-                this.name = name;\n-                this.bean = bean;\n-            }\n-        }\n-\n-        private final ArrayList<BeanTuple> prototypeBeans = new ArrayList<>();\n-\n-        private BeanFactory beanFactory;\n-\n-        @Override\n-        public void setBeanFactory(final BeanFactory beanFactory) throws BeansException {\n-            this.beanFactory = beanFactory;\n-        }\n-\n-        @Override\n-        public Object postProcessAfterInitialization(final Object bean, final String beanName)\n-                throws BeansException {\n-            try {\n-                if (bean instanceof DisposableBean && beanFactory.isPrototype(beanName)) {\n-                    LOGGER.debug(\"Registering prototype bean {}\", beanName);\n-                    synchronized (prototypeBeans) {\n-                        prototypeBeans.add(new BeanTuple(beanName, (DisposableBean) bean));\n-                    }\n-                }\n-            } catch (final NoSuchBeanDefinitionException e) {\n-                if (LOGGER.isTraceEnabled()) {\n-                    LOGGER.trace(\"Bean {} not found\", beanName);\n-                }\n-            }\n-\n-            return bean;\n-        }\n-\n-        @Override\n-        public void destroy() {\n-            LOGGER.debug(\"Destroying prototype beans\");\n-            synchronized (prototypeBeans) {\n-                prototypeBeans.forEach(beanTuple -> {\n-                    try {\n-                        LOGGER.debug(\"Destroying prototype bean {}\", beanTuple.getName());\n-                        beanTuple.getBean().destroy();\n-                    } catch (final Exception e) {\n-                        LOGGER.warn(\"Unable to dispose prototype bean {}: {}\", beanTuple.getName(), e.getMessage());\n-                    }\n-                });\n-            }\n-        }\n-    }\n-\n     /**\n      * It's important to invoke the {@link #casApplicationContextProvider()}\n      * method here forcefully and not rely on the {@link #applicationContext}.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk1MjM4Mw==", "url": "https://github.com/apereo/cas/pull/4844#discussion_r422952383", "bodyText": "@RequiredArgsConstructor; make fields final.", "author": "mmoayyed", "createdAt": "2020-05-11T10:47:51Z", "path": "core/cas-server-core-util/src/main/java/org/apereo/cas/config/CasCoreUtilConfiguration.java", "diffHunk": "@@ -115,6 +125,68 @@ public SmsSender smsSender() {\n         return SmsSender.noOp();\n     }\n \n+    @Bean\n+    public BeanPostProcessor getDestroyPrototypeBeansPostProcessor() {\n+        return new DestroyPrototypeBeansPostProcessor();\n+    }\n+\n+    private static class DestroyPrototypeBeansPostProcessor implements BeanPostProcessor, DisposableBean, BeanFactoryAware {\n+\n+        @Getter\n+        private static class BeanTuple {", "originalCommit": "c62239aaeb69bbe7331650ba69756f116fb0c62d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "762b5913f62ed82d810f55ff09b7637b50163671", "chunk": "diff --git a/core/cas-server-core-util/src/main/java/org/apereo/cas/config/CasCoreUtilConfiguration.java b/core/cas-server-core-util/src/main/java/org/apereo/cas/config/CasCoreUtilConfiguration.java\nindex 767201b3d9..e3f138d012 100644\n--- a/core/cas-server-core-util/src/main/java/org/apereo/cas/config/CasCoreUtilConfiguration.java\n+++ b/core/cas-server-core-util/src/main/java/org/apereo/cas/config/CasCoreUtilConfiguration.java\n\n@@ -125,68 +115,6 @@ public class CasCoreUtilConfiguration implements InitializingBean {\n         return SmsSender.noOp();\n     }\n \n-    @Bean\n-    public BeanPostProcessor getDestroyPrototypeBeansPostProcessor() {\n-        return new DestroyPrototypeBeansPostProcessor();\n-    }\n-\n-    private static class DestroyPrototypeBeansPostProcessor implements BeanPostProcessor, DisposableBean, BeanFactoryAware {\n-\n-        @Getter\n-        private static class BeanTuple {\n-            private String name;\n-            private DisposableBean bean;\n-\n-            BeanTuple(final String name, final DisposableBean bean) {\n-                this.name = name;\n-                this.bean = bean;\n-            }\n-        }\n-\n-        private final ArrayList<BeanTuple> prototypeBeans = new ArrayList<>();\n-\n-        private BeanFactory beanFactory;\n-\n-        @Override\n-        public void setBeanFactory(final BeanFactory beanFactory) throws BeansException {\n-            this.beanFactory = beanFactory;\n-        }\n-\n-        @Override\n-        public Object postProcessAfterInitialization(final Object bean, final String beanName)\n-                throws BeansException {\n-            try {\n-                if (bean instanceof DisposableBean && beanFactory.isPrototype(beanName)) {\n-                    LOGGER.debug(\"Registering prototype bean {}\", beanName);\n-                    synchronized (prototypeBeans) {\n-                        prototypeBeans.add(new BeanTuple(beanName, (DisposableBean) bean));\n-                    }\n-                }\n-            } catch (final NoSuchBeanDefinitionException e) {\n-                if (LOGGER.isTraceEnabled()) {\n-                    LOGGER.trace(\"Bean {} not found\", beanName);\n-                }\n-            }\n-\n-            return bean;\n-        }\n-\n-        @Override\n-        public void destroy() {\n-            LOGGER.debug(\"Destroying prototype beans\");\n-            synchronized (prototypeBeans) {\n-                prototypeBeans.forEach(beanTuple -> {\n-                    try {\n-                        LOGGER.debug(\"Destroying prototype bean {}\", beanTuple.getName());\n-                        beanTuple.getBean().destroy();\n-                    } catch (final Exception e) {\n-                        LOGGER.warn(\"Unable to dispose prototype bean {}: {}\", beanTuple.getName(), e.getMessage());\n-                    }\n-                });\n-            }\n-        }\n-    }\n-\n     /**\n      * It's important to invoke the {@link #casApplicationContextProvider()}\n      * method here forcefully and not rely on the {@link #applicationContext}.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk1MjQ1MA==", "url": "https://github.com/apereo/cas/pull/4844#discussion_r422952450", "bodyText": "Remove", "author": "mmoayyed", "createdAt": "2020-05-11T10:47:58Z", "path": "core/cas-server-core-util/src/main/java/org/apereo/cas/config/CasCoreUtilConfiguration.java", "diffHunk": "@@ -115,6 +125,68 @@ public SmsSender smsSender() {\n         return SmsSender.noOp();\n     }\n \n+    @Bean\n+    public BeanPostProcessor getDestroyPrototypeBeansPostProcessor() {\n+        return new DestroyPrototypeBeansPostProcessor();\n+    }\n+\n+    private static class DestroyPrototypeBeansPostProcessor implements BeanPostProcessor, DisposableBean, BeanFactoryAware {\n+\n+        @Getter\n+        private static class BeanTuple {\n+            private String name;\n+            private DisposableBean bean;\n+\n+            BeanTuple(final String name, final DisposableBean bean) {\n+                this.name = name;\n+                this.bean = bean;\n+            }", "originalCommit": "c62239aaeb69bbe7331650ba69756f116fb0c62d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "762b5913f62ed82d810f55ff09b7637b50163671", "chunk": "diff --git a/core/cas-server-core-util/src/main/java/org/apereo/cas/config/CasCoreUtilConfiguration.java b/core/cas-server-core-util/src/main/java/org/apereo/cas/config/CasCoreUtilConfiguration.java\nindex 767201b3d9..e3f138d012 100644\n--- a/core/cas-server-core-util/src/main/java/org/apereo/cas/config/CasCoreUtilConfiguration.java\n+++ b/core/cas-server-core-util/src/main/java/org/apereo/cas/config/CasCoreUtilConfiguration.java\n\n@@ -125,68 +115,6 @@ public class CasCoreUtilConfiguration implements InitializingBean {\n         return SmsSender.noOp();\n     }\n \n-    @Bean\n-    public BeanPostProcessor getDestroyPrototypeBeansPostProcessor() {\n-        return new DestroyPrototypeBeansPostProcessor();\n-    }\n-\n-    private static class DestroyPrototypeBeansPostProcessor implements BeanPostProcessor, DisposableBean, BeanFactoryAware {\n-\n-        @Getter\n-        private static class BeanTuple {\n-            private String name;\n-            private DisposableBean bean;\n-\n-            BeanTuple(final String name, final DisposableBean bean) {\n-                this.name = name;\n-                this.bean = bean;\n-            }\n-        }\n-\n-        private final ArrayList<BeanTuple> prototypeBeans = new ArrayList<>();\n-\n-        private BeanFactory beanFactory;\n-\n-        @Override\n-        public void setBeanFactory(final BeanFactory beanFactory) throws BeansException {\n-            this.beanFactory = beanFactory;\n-        }\n-\n-        @Override\n-        public Object postProcessAfterInitialization(final Object bean, final String beanName)\n-                throws BeansException {\n-            try {\n-                if (bean instanceof DisposableBean && beanFactory.isPrototype(beanName)) {\n-                    LOGGER.debug(\"Registering prototype bean {}\", beanName);\n-                    synchronized (prototypeBeans) {\n-                        prototypeBeans.add(new BeanTuple(beanName, (DisposableBean) bean));\n-                    }\n-                }\n-            } catch (final NoSuchBeanDefinitionException e) {\n-                if (LOGGER.isTraceEnabled()) {\n-                    LOGGER.trace(\"Bean {} not found\", beanName);\n-                }\n-            }\n-\n-            return bean;\n-        }\n-\n-        @Override\n-        public void destroy() {\n-            LOGGER.debug(\"Destroying prototype beans\");\n-            synchronized (prototypeBeans) {\n-                prototypeBeans.forEach(beanTuple -> {\n-                    try {\n-                        LOGGER.debug(\"Destroying prototype bean {}\", beanTuple.getName());\n-                        beanTuple.getBean().destroy();\n-                    } catch (final Exception e) {\n-                        LOGGER.warn(\"Unable to dispose prototype bean {}: {}\", beanTuple.getName(), e.getMessage());\n-                    }\n-                });\n-            }\n-        }\n-    }\n-\n     /**\n      * It's important to invoke the {@link #casApplicationContextProvider()}\n      * method here forcefully and not rely on the {@link #applicationContext}.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk1MjYxMg==", "url": "https://github.com/apereo/cas/pull/4844#discussion_r422952612", "bodyText": "Pass the bean factory from the configuration class, and remove.", "author": "mmoayyed", "createdAt": "2020-05-11T10:48:17Z", "path": "core/cas-server-core-util/src/main/java/org/apereo/cas/config/CasCoreUtilConfiguration.java", "diffHunk": "@@ -115,6 +125,68 @@ public SmsSender smsSender() {\n         return SmsSender.noOp();\n     }\n \n+    @Bean\n+    public BeanPostProcessor getDestroyPrototypeBeansPostProcessor() {\n+        return new DestroyPrototypeBeansPostProcessor();\n+    }\n+\n+    private static class DestroyPrototypeBeansPostProcessor implements BeanPostProcessor, DisposableBean, BeanFactoryAware {\n+\n+        @Getter\n+        private static class BeanTuple {\n+            private String name;\n+            private DisposableBean bean;\n+\n+            BeanTuple(final String name, final DisposableBean bean) {\n+                this.name = name;\n+                this.bean = bean;\n+            }\n+        }\n+\n+        private final ArrayList<BeanTuple> prototypeBeans = new ArrayList<>();\n+\n+        private BeanFactory beanFactory;\n+\n+        @Override\n+        public void setBeanFactory(final BeanFactory beanFactory) throws BeansException {\n+            this.beanFactory = beanFactory;\n+        }", "originalCommit": "c62239aaeb69bbe7331650ba69756f116fb0c62d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "762b5913f62ed82d810f55ff09b7637b50163671", "chunk": "diff --git a/core/cas-server-core-util/src/main/java/org/apereo/cas/config/CasCoreUtilConfiguration.java b/core/cas-server-core-util/src/main/java/org/apereo/cas/config/CasCoreUtilConfiguration.java\nindex 767201b3d9..e3f138d012 100644\n--- a/core/cas-server-core-util/src/main/java/org/apereo/cas/config/CasCoreUtilConfiguration.java\n+++ b/core/cas-server-core-util/src/main/java/org/apereo/cas/config/CasCoreUtilConfiguration.java\n\n@@ -125,68 +115,6 @@ public class CasCoreUtilConfiguration implements InitializingBean {\n         return SmsSender.noOp();\n     }\n \n-    @Bean\n-    public BeanPostProcessor getDestroyPrototypeBeansPostProcessor() {\n-        return new DestroyPrototypeBeansPostProcessor();\n-    }\n-\n-    private static class DestroyPrototypeBeansPostProcessor implements BeanPostProcessor, DisposableBean, BeanFactoryAware {\n-\n-        @Getter\n-        private static class BeanTuple {\n-            private String name;\n-            private DisposableBean bean;\n-\n-            BeanTuple(final String name, final DisposableBean bean) {\n-                this.name = name;\n-                this.bean = bean;\n-            }\n-        }\n-\n-        private final ArrayList<BeanTuple> prototypeBeans = new ArrayList<>();\n-\n-        private BeanFactory beanFactory;\n-\n-        @Override\n-        public void setBeanFactory(final BeanFactory beanFactory) throws BeansException {\n-            this.beanFactory = beanFactory;\n-        }\n-\n-        @Override\n-        public Object postProcessAfterInitialization(final Object bean, final String beanName)\n-                throws BeansException {\n-            try {\n-                if (bean instanceof DisposableBean && beanFactory.isPrototype(beanName)) {\n-                    LOGGER.debug(\"Registering prototype bean {}\", beanName);\n-                    synchronized (prototypeBeans) {\n-                        prototypeBeans.add(new BeanTuple(beanName, (DisposableBean) bean));\n-                    }\n-                }\n-            } catch (final NoSuchBeanDefinitionException e) {\n-                if (LOGGER.isTraceEnabled()) {\n-                    LOGGER.trace(\"Bean {} not found\", beanName);\n-                }\n-            }\n-\n-            return bean;\n-        }\n-\n-        @Override\n-        public void destroy() {\n-            LOGGER.debug(\"Destroying prototype beans\");\n-            synchronized (prototypeBeans) {\n-                prototypeBeans.forEach(beanTuple -> {\n-                    try {\n-                        LOGGER.debug(\"Destroying prototype bean {}\", beanTuple.getName());\n-                        beanTuple.getBean().destroy();\n-                    } catch (final Exception e) {\n-                        LOGGER.warn(\"Unable to dispose prototype bean {}: {}\", beanTuple.getName(), e.getMessage());\n-                    }\n-                });\n-            }\n-        }\n-    }\n-\n     /**\n      * It's important to invoke the {@link #casApplicationContextProvider()}\n      * method here forcefully and not rely on the {@link #applicationContext}.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk1MjY2OA==", "url": "https://github.com/apereo/cas/pull/4844#discussion_r422952668", "bodyText": "Make final.", "author": "mmoayyed", "createdAt": "2020-05-11T10:48:22Z", "path": "core/cas-server-core-util/src/main/java/org/apereo/cas/config/CasCoreUtilConfiguration.java", "diffHunk": "@@ -115,6 +125,68 @@ public SmsSender smsSender() {\n         return SmsSender.noOp();\n     }\n \n+    @Bean\n+    public BeanPostProcessor getDestroyPrototypeBeansPostProcessor() {\n+        return new DestroyPrototypeBeansPostProcessor();\n+    }\n+\n+    private static class DestroyPrototypeBeansPostProcessor implements BeanPostProcessor, DisposableBean, BeanFactoryAware {\n+\n+        @Getter\n+        private static class BeanTuple {\n+            private String name;\n+            private DisposableBean bean;\n+\n+            BeanTuple(final String name, final DisposableBean bean) {\n+                this.name = name;\n+                this.bean = bean;\n+            }\n+        }\n+\n+        private final ArrayList<BeanTuple> prototypeBeans = new ArrayList<>();\n+\n+        private BeanFactory beanFactory;", "originalCommit": "c62239aaeb69bbe7331650ba69756f116fb0c62d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "762b5913f62ed82d810f55ff09b7637b50163671", "chunk": "diff --git a/core/cas-server-core-util/src/main/java/org/apereo/cas/config/CasCoreUtilConfiguration.java b/core/cas-server-core-util/src/main/java/org/apereo/cas/config/CasCoreUtilConfiguration.java\nindex 767201b3d9..e3f138d012 100644\n--- a/core/cas-server-core-util/src/main/java/org/apereo/cas/config/CasCoreUtilConfiguration.java\n+++ b/core/cas-server-core-util/src/main/java/org/apereo/cas/config/CasCoreUtilConfiguration.java\n\n@@ -125,68 +115,6 @@ public class CasCoreUtilConfiguration implements InitializingBean {\n         return SmsSender.noOp();\n     }\n \n-    @Bean\n-    public BeanPostProcessor getDestroyPrototypeBeansPostProcessor() {\n-        return new DestroyPrototypeBeansPostProcessor();\n-    }\n-\n-    private static class DestroyPrototypeBeansPostProcessor implements BeanPostProcessor, DisposableBean, BeanFactoryAware {\n-\n-        @Getter\n-        private static class BeanTuple {\n-            private String name;\n-            private DisposableBean bean;\n-\n-            BeanTuple(final String name, final DisposableBean bean) {\n-                this.name = name;\n-                this.bean = bean;\n-            }\n-        }\n-\n-        private final ArrayList<BeanTuple> prototypeBeans = new ArrayList<>();\n-\n-        private BeanFactory beanFactory;\n-\n-        @Override\n-        public void setBeanFactory(final BeanFactory beanFactory) throws BeansException {\n-            this.beanFactory = beanFactory;\n-        }\n-\n-        @Override\n-        public Object postProcessAfterInitialization(final Object bean, final String beanName)\n-                throws BeansException {\n-            try {\n-                if (bean instanceof DisposableBean && beanFactory.isPrototype(beanName)) {\n-                    LOGGER.debug(\"Registering prototype bean {}\", beanName);\n-                    synchronized (prototypeBeans) {\n-                        prototypeBeans.add(new BeanTuple(beanName, (DisposableBean) bean));\n-                    }\n-                }\n-            } catch (final NoSuchBeanDefinitionException e) {\n-                if (LOGGER.isTraceEnabled()) {\n-                    LOGGER.trace(\"Bean {} not found\", beanName);\n-                }\n-            }\n-\n-            return bean;\n-        }\n-\n-        @Override\n-        public void destroy() {\n-            LOGGER.debug(\"Destroying prototype beans\");\n-            synchronized (prototypeBeans) {\n-                prototypeBeans.forEach(beanTuple -> {\n-                    try {\n-                        LOGGER.debug(\"Destroying prototype bean {}\", beanTuple.getName());\n-                        beanTuple.getBean().destroy();\n-                    } catch (final Exception e) {\n-                        LOGGER.warn(\"Unable to dispose prototype bean {}: {}\", beanTuple.getName(), e.getMessage());\n-                    }\n-                });\n-            }\n-        }\n-    }\n-\n     /**\n      * It's important to invoke the {@link #casApplicationContextProvider()}\n      * method here forcefully and not rely on the {@link #applicationContext}.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk1Mjc1Ng==", "url": "https://github.com/apereo/cas/pull/4844#discussion_r422952756", "bodyText": "Left-hand size should always be interface type.", "author": "mmoayyed", "createdAt": "2020-05-11T10:48:34Z", "path": "core/cas-server-core-util/src/main/java/org/apereo/cas/config/CasCoreUtilConfiguration.java", "diffHunk": "@@ -115,6 +125,68 @@ public SmsSender smsSender() {\n         return SmsSender.noOp();\n     }\n \n+    @Bean\n+    public BeanPostProcessor getDestroyPrototypeBeansPostProcessor() {\n+        return new DestroyPrototypeBeansPostProcessor();\n+    }\n+\n+    private static class DestroyPrototypeBeansPostProcessor implements BeanPostProcessor, DisposableBean, BeanFactoryAware {\n+\n+        @Getter\n+        private static class BeanTuple {\n+            private String name;\n+            private DisposableBean bean;\n+\n+            BeanTuple(final String name, final DisposableBean bean) {\n+                this.name = name;\n+                this.bean = bean;\n+            }\n+        }\n+\n+        private final ArrayList<BeanTuple> prototypeBeans = new ArrayList<>();", "originalCommit": "c62239aaeb69bbe7331650ba69756f116fb0c62d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "762b5913f62ed82d810f55ff09b7637b50163671", "chunk": "diff --git a/core/cas-server-core-util/src/main/java/org/apereo/cas/config/CasCoreUtilConfiguration.java b/core/cas-server-core-util/src/main/java/org/apereo/cas/config/CasCoreUtilConfiguration.java\nindex 767201b3d9..e3f138d012 100644\n--- a/core/cas-server-core-util/src/main/java/org/apereo/cas/config/CasCoreUtilConfiguration.java\n+++ b/core/cas-server-core-util/src/main/java/org/apereo/cas/config/CasCoreUtilConfiguration.java\n\n@@ -125,68 +115,6 @@ public class CasCoreUtilConfiguration implements InitializingBean {\n         return SmsSender.noOp();\n     }\n \n-    @Bean\n-    public BeanPostProcessor getDestroyPrototypeBeansPostProcessor() {\n-        return new DestroyPrototypeBeansPostProcessor();\n-    }\n-\n-    private static class DestroyPrototypeBeansPostProcessor implements BeanPostProcessor, DisposableBean, BeanFactoryAware {\n-\n-        @Getter\n-        private static class BeanTuple {\n-            private String name;\n-            private DisposableBean bean;\n-\n-            BeanTuple(final String name, final DisposableBean bean) {\n-                this.name = name;\n-                this.bean = bean;\n-            }\n-        }\n-\n-        private final ArrayList<BeanTuple> prototypeBeans = new ArrayList<>();\n-\n-        private BeanFactory beanFactory;\n-\n-        @Override\n-        public void setBeanFactory(final BeanFactory beanFactory) throws BeansException {\n-            this.beanFactory = beanFactory;\n-        }\n-\n-        @Override\n-        public Object postProcessAfterInitialization(final Object bean, final String beanName)\n-                throws BeansException {\n-            try {\n-                if (bean instanceof DisposableBean && beanFactory.isPrototype(beanName)) {\n-                    LOGGER.debug(\"Registering prototype bean {}\", beanName);\n-                    synchronized (prototypeBeans) {\n-                        prototypeBeans.add(new BeanTuple(beanName, (DisposableBean) bean));\n-                    }\n-                }\n-            } catch (final NoSuchBeanDefinitionException e) {\n-                if (LOGGER.isTraceEnabled()) {\n-                    LOGGER.trace(\"Bean {} not found\", beanName);\n-                }\n-            }\n-\n-            return bean;\n-        }\n-\n-        @Override\n-        public void destroy() {\n-            LOGGER.debug(\"Destroying prototype beans\");\n-            synchronized (prototypeBeans) {\n-                prototypeBeans.forEach(beanTuple -> {\n-                    try {\n-                        LOGGER.debug(\"Destroying prototype bean {}\", beanTuple.getName());\n-                        beanTuple.getBean().destroy();\n-                    } catch (final Exception e) {\n-                        LOGGER.warn(\"Unable to dispose prototype bean {}: {}\", beanTuple.getName(), e.getMessage());\n-                    }\n-                });\n-            }\n-        }\n-    }\n-\n     /**\n      * It's important to invoke the {@link #casApplicationContextProvider()}\n      * method here forcefully and not rely on the {@link #applicationContext}.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk1NTMzNw==", "url": "https://github.com/apereo/cas/pull/4844#discussion_r422955337", "bodyText": "If this is turned into a proper bean, there is no need to mark it as prototype. Spring application lifecycle will take care of it?", "author": "mmoayyed", "createdAt": "2020-05-11T10:53:11Z", "path": "support/cas-server-support-ldap-monitor/src/main/java/org/apereo/cas/monitor/config/LdapMonitorConfiguration.java", "diffHunk": "@@ -35,6 +40,19 @@\n     @Autowired\n     private CasConfigurationProperties casProperties;\n \n+    @Autowired\n+    private ApplicationContext applicationContext;\n+\n+    @Bean(name = \"ldapMonitorConfigurationPooledLdapConnectionFactoryHealthIndicator\")\n+    @Scope(\"prototype\")\n+    public PooledLdapConnectionFactoryHealthIndicator pooledLdapConnectionFactoryHealthIndicator(\n+                                                      final Long maxWait,\n+                                                      final PooledConnectionFactory factory,\n+                                                      final ExecutorService executor,\n+                                                      final ConnectionValidator validator) {\n+        return new PooledLdapConnectionFactoryHealthIndicator(maxWait.longValue(), factory, executor, validator);\n+    }", "originalCommit": "c62239aaeb69bbe7331650ba69756f116fb0c62d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk3OTQyNw==", "url": "https://github.com/apereo/cas/pull/4844#discussion_r422979427", "bodyText": "The reason why I need a prototype bean is that I need parameterized multiple instances of same bean definitions. This is the intended use case of prototype bean.", "author": "leeyc0", "createdAt": "2020-05-11T11:40:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk1NTMzNw=="}], "type": "inlineReview", "revised_code": {"commit": "762b5913f62ed82d810f55ff09b7637b50163671", "chunk": "diff --git a/support/cas-server-support-ldap-monitor/src/main/java/org/apereo/cas/monitor/config/LdapMonitorConfiguration.java b/support/cas-server-support-ldap-monitor/src/main/java/org/apereo/cas/monitor/config/LdapMonitorConfiguration.java\nindex 379f485544..3324565205 100644\n--- a/support/cas-server-support-ldap-monitor/src/main/java/org/apereo/cas/monitor/config/LdapMonitorConfiguration.java\n+++ b/support/cas-server-support-ldap-monitor/src/main/java/org/apereo/cas/monitor/config/LdapMonitorConfiguration.java\n\n@@ -40,19 +35,6 @@ public class LdapMonitorConfiguration {\n     @Autowired\n     private CasConfigurationProperties casProperties;\n \n-    @Autowired\n-    private ApplicationContext applicationContext;\n-\n-    @Bean(name = \"ldapMonitorConfigurationPooledLdapConnectionFactoryHealthIndicator\")\n-    @Scope(\"prototype\")\n-    public PooledLdapConnectionFactoryHealthIndicator pooledLdapConnectionFactoryHealthIndicator(\n-                                                      final Long maxWait,\n-                                                      final PooledConnectionFactory factory,\n-                                                      final ExecutorService executor,\n-                                                      final ConnectionValidator validator) {\n-        return new PooledLdapConnectionFactoryHealthIndicator(maxWait.longValue(), factory, executor, validator);\n-    }\n-\n     @Bean\n     @ConditionalOnEnabledHealthIndicator(\"pooledLdapConnectionFactoryHealthIndicator\")\n     public CompositeHealthContributor pooledLdapConnectionFactoryHealthIndicator() {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk1NTY1NQ==", "url": "https://github.com/apereo/cas/pull/4844#discussion_r422955655", "bodyText": "Never use this.applicationContext.getBean() unless you absolutely have to (and you should not have to). Pass the bean instance or invoke it directly.", "author": "mmoayyed", "createdAt": "2020-05-11T10:53:47Z", "path": "support/cas-server-support-ldap-monitor/src/main/java/org/apereo/cas/monitor/config/LdapMonitorConfiguration.java", "diffHunk": "@@ -46,8 +64,11 @@ public CompositeHealthContributor pooledLdapConnectionFactoryHealthIndicator() {\n                 val executor = Beans.newThreadPoolExecutorFactoryBean(ldap.getPool());\n                 executor.afterPropertiesSet();\n                 val connectionFactory = LdapUtils.newLdaptivePooledConnectionFactory(ldap);\n-                val healthIndicator = new PooledLdapConnectionFactoryHealthIndicator(Beans.newDuration(ldap.getMaxWait()).toMillis(),\n-                    connectionFactory, executor.getObject(), new SearchConnectionValidator());\n+                val healthIndicator = (PooledLdapConnectionFactoryHealthIndicator) this.applicationContext.getBean(", "originalCommit": "c62239aaeb69bbe7331650ba69756f116fb0c62d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk4MDQ3OQ==", "url": "https://github.com/apereo/cas/pull/4844#discussion_r422980479", "bodyText": "See above. Prototype beans needs to be initialized using this.applicationContext.getBean(). Note ldaps.stream(). We need to get multiple parametrized instances.\nRef: https://stackoverflow.com/questions/22155832/spring-java-config-how-do-you-create-a-prototype-scoped-bean-with-runtime-argu", "author": "leeyc0", "createdAt": "2020-05-11T11:42:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk1NTY1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk4MTk0MA==", "url": "https://github.com/apereo/cas/pull/4844#discussion_r422981940", "bodyText": "I understand the solution, but this in its current format is not something I would be able to accept. It's inconsistent and/or confusing. It doesn't make sense os isn't maintainable to create a bean, only to mark it as prototype, to register it in the application context as @bean yet call getBean() only to be able to properly close it. Too many hidden jewels.", "author": "mmoayyed", "createdAt": "2020-05-11T11:46:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk1NTY1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk4MzUzNQ==", "url": "https://github.com/apereo/cas/pull/4844#discussion_r422983535", "bodyText": "Then in this case the only alternative solution would be defining a PooledLdapConnectionFactoryHealthIndicator factory bean to contain the resources that need to be closed and healthIndicator to get a PooledLdapConnectionFactoryHealthIndicator from the factory. A complete rewrite required.", "author": "leeyc0", "createdAt": "2020-05-11T11:49:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk1NTY1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk4NjU5NA==", "url": "https://github.com/apereo/cas/pull/4844#discussion_r422986594", "bodyText": "(Actually I only realized factory bean may be a more inituitive alternative solution after I wrote this PR...)", "author": "leeyc0", "createdAt": "2020-05-11T11:55:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk1NTY1NQ=="}], "type": "inlineReview", "revised_code": {"commit": "762b5913f62ed82d810f55ff09b7637b50163671", "chunk": "diff --git a/support/cas-server-support-ldap-monitor/src/main/java/org/apereo/cas/monitor/config/LdapMonitorConfiguration.java b/support/cas-server-support-ldap-monitor/src/main/java/org/apereo/cas/monitor/config/LdapMonitorConfiguration.java\nindex 379f485544..3324565205 100644\n--- a/support/cas-server-support-ldap-monitor/src/main/java/org/apereo/cas/monitor/config/LdapMonitorConfiguration.java\n+++ b/support/cas-server-support-ldap-monitor/src/main/java/org/apereo/cas/monitor/config/LdapMonitorConfiguration.java\n\n@@ -64,11 +46,8 @@ public class LdapMonitorConfiguration {\n                 val executor = Beans.newThreadPoolExecutorFactoryBean(ldap.getPool());\n                 executor.afterPropertiesSet();\n                 val connectionFactory = LdapUtils.newLdaptivePooledConnectionFactory(ldap);\n-                val healthIndicator = (PooledLdapConnectionFactoryHealthIndicator) this.applicationContext.getBean(\n-                    \"ldapMonitorConfigurationPooledLdapConnectionFactoryHealthIndicator\",\n-                    Long.valueOf(Beans.newDuration(ldap.getMaxWait()).toMillis()),\n-                    connectionFactory, executor.getObject(),\n-                    new SearchConnectionValidator());\n+                val healthIndicator = new PooledLdapConnectionFactoryHealthIndicator(Beans.newDuration(ldap.getMaxWait()).toMillis(),\n+                    connectionFactory, executor.getObject(), new SearchConnectionValidator());\n                 val name = StringUtils.defaultIfBlank(ldap.getName(), UUID.randomUUID().toString());\n                 return Pair.of(name, healthIndicator);\n             })\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk1NTg2NA==", "url": "https://github.com/apereo/cas/pull/4844#discussion_r422955864", "bodyText": "References to class in javadocs should be annotated with @link", "author": "mmoayyed", "createdAt": "2020-05-11T10:54:10Z", "path": "support/cas-server-support-ldap-monitor/src/main/java/org/apereo/cas/monitor/PooledLdapConnectionFactoryHealthIndicator.java", "diffHunk": "@@ -35,6 +35,16 @@ public PooledLdapConnectionFactoryHealthIndicator(final long maxWait,\n         this.validator = validator;\n     }\n \n+\n+    /**\n+     * Shuts down PooledLdapConnectionFactoryHealthIndicator.", "originalCommit": "c62239aaeb69bbe7331650ba69756f116fb0c62d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "762b5913f62ed82d810f55ff09b7637b50163671", "chunk": "diff --git a/support/cas-server-support-ldap-monitor/src/main/java/org/apereo/cas/monitor/PooledLdapConnectionFactoryHealthIndicator.java b/support/cas-server-support-ldap-monitor/src/main/java/org/apereo/cas/monitor/PooledLdapConnectionFactoryHealthIndicator.java\nindex 915a8a6f5b..5052ec362a 100644\n--- a/support/cas-server-support-ldap-monitor/src/main/java/org/apereo/cas/monitor/PooledLdapConnectionFactoryHealthIndicator.java\n+++ b/support/cas-server-support-ldap-monitor/src/main/java/org/apereo/cas/monitor/PooledLdapConnectionFactoryHealthIndicator.java\n\n@@ -36,9 +36,6 @@ public class PooledLdapConnectionFactoryHealthIndicator extends AbstractPoolHeal\n     }\n \n \n-    /**\n-     * Shuts down PooledLdapConnectionFactoryHealthIndicator.\n-     */\n     @Override\n     public void destroy() {\n         super.destroy();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk1NjI2Nw==", "url": "https://github.com/apereo/cas/pull/4844#discussion_r422956267", "bodyText": "Sometimes you're specifying javadocs and sometimes you're not. It's best to remove them all, as the javadocs in almost all such cases are redundant. If you do specify them, you need to be consistent everywhere in your patch.", "author": "mmoayyed", "createdAt": "2020-05-11T10:54:55Z", "path": "support/cas-server-support-consent-ldap/src/main/java/org/apereo/cas/consent/LdapConsentRepository.java", "diffHunk": "@@ -259,4 +260,9 @@ private LdapEntry readConsentEntry(final String principal) {\n         LOGGER.debug(\"Unable to read consent entries from LDAP via filter [{}]\", filter);\n         return new HashSet<>(0);\n     }\n+\n+    @Override", "originalCommit": "c62239aaeb69bbe7331650ba69756f116fb0c62d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk1NjY4Mw==", "url": "https://github.com/apereo/cas/pull/4844#discussion_r422956683", "bodyText": "Rewrite the bean and remove parameter passing.", "author": "mmoayyed", "createdAt": "2020-05-11T10:55:41Z", "path": "support/cas-server-support-ldap-monitor/src/main/java/org/apereo/cas/monitor/config/LdapMonitorConfiguration.java", "diffHunk": "@@ -35,6 +40,19 @@\n     @Autowired\n     private CasConfigurationProperties casProperties;\n \n+    @Autowired\n+    private ApplicationContext applicationContext;\n+\n+    @Bean(name = \"ldapMonitorConfigurationPooledLdapConnectionFactoryHealthIndicator\")\n+    @Scope(\"prototype\")\n+    public PooledLdapConnectionFactoryHealthIndicator pooledLdapConnectionFactoryHealthIndicator(\n+                                                      final Long maxWait,\n+                                                      final PooledConnectionFactory factory,\n+                                                      final ExecutorService executor,\n+                                                      final ConnectionValidator validator) {\n+        return new PooledLdapConnectionFactoryHealthIndicator(maxWait.longValue(), factory, executor, validator);\n+    }", "originalCommit": "c62239aaeb69bbe7331650ba69756f116fb0c62d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "762b5913f62ed82d810f55ff09b7637b50163671", "chunk": "diff --git a/support/cas-server-support-ldap-monitor/src/main/java/org/apereo/cas/monitor/config/LdapMonitorConfiguration.java b/support/cas-server-support-ldap-monitor/src/main/java/org/apereo/cas/monitor/config/LdapMonitorConfiguration.java\nindex 379f485544..3324565205 100644\n--- a/support/cas-server-support-ldap-monitor/src/main/java/org/apereo/cas/monitor/config/LdapMonitorConfiguration.java\n+++ b/support/cas-server-support-ldap-monitor/src/main/java/org/apereo/cas/monitor/config/LdapMonitorConfiguration.java\n\n@@ -40,19 +35,6 @@ public class LdapMonitorConfiguration {\n     @Autowired\n     private CasConfigurationProperties casProperties;\n \n-    @Autowired\n-    private ApplicationContext applicationContext;\n-\n-    @Bean(name = \"ldapMonitorConfigurationPooledLdapConnectionFactoryHealthIndicator\")\n-    @Scope(\"prototype\")\n-    public PooledLdapConnectionFactoryHealthIndicator pooledLdapConnectionFactoryHealthIndicator(\n-                                                      final Long maxWait,\n-                                                      final PooledConnectionFactory factory,\n-                                                      final ExecutorService executor,\n-                                                      final ConnectionValidator validator) {\n-        return new PooledLdapConnectionFactoryHealthIndicator(maxWait.longValue(), factory, executor, validator);\n-    }\n-\n     @Bean\n     @ConditionalOnEnabledHealthIndicator(\"pooledLdapConnectionFactoryHealthIndicator\")\n     public CompositeHealthContributor pooledLdapConnectionFactoryHealthIndicator() {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk1NzExNQ==", "url": "https://github.com/apereo/cas/pull/4844#discussion_r422957115", "bodyText": "authenticator.close() should be enough.", "author": "mmoayyed", "createdAt": "2020-05-11T10:56:35Z", "path": "support/cas-server-support-ldap/src/main/java/org/apereo/cas/authentication/LdapAuthenticationHandler.java", "diffHunk": "@@ -101,6 +105,18 @@ public LdapAuthenticationHandler(final String name, final ServicesManager servic\n         this.passwordPolicyHandlingStrategy = strategy;\n     }\n \n+    @Override\n+    public void destroy() {\n+        val authenticationHandler = (AbstractAuthenticationHandler) authenticator.getAuthenticationHandler();\n+        val dnResolver = (SearchDnResolver) authenticator.getDnResolver();\n+        val entryResolver = (AbstractSearchEntryResolver) authenticator.getEntryResolver();\n+        authenticationHandler.getConnectionFactory().close();\n+        dnResolver.getConnectionFactory().close();\n+        if (entryResolver != null) {\n+            entryResolver.getConnectionFactory().close();\n+        }\n+    }", "originalCommit": "c62239aaeb69bbe7331650ba69756f116fb0c62d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk3MjIyMg==", "url": "https://github.com/apereo/cas/pull/4844#discussion_r422972222", "bodyText": "No. There are three independent thread pools. as I figured out from LdapUtils.\nTake this as example\nhttps://github.com/apereo/cas/blob/master/support/cas-server-support-ldap-core/src/main/java/org/apereo/cas/util/LdapUtils.java#L607\nand follow the method getAuthenticatedOrAnonSearchAuthenticator(), it indeed creates three newLdaptiveConnectionFactory instances. So three close() is needed.", "author": "leeyc0", "createdAt": "2020-05-11T11:26:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk1NzExNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk3NTE2Nw==", "url": "https://github.com/apereo/cas/pull/4844#discussion_r422975167", "bodyText": "In that case, all of this code should be moved over to ldaptive. We should not have to travel down the hierarchy to close everything. This is not maintainable. authenticator.close()  should be enough, and the rest should be handled by ldaptive which would know what needs closing and how and in what order, etc.", "author": "mmoayyed", "createdAt": "2020-05-11T11:32:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk1NzExNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk3Njc5NQ==", "url": "https://github.com/apereo/cas/pull/4844#discussion_r422976795", "bodyText": "Pinging @dfish3r; What do you think?", "author": "mmoayyed", "createdAt": "2020-05-11T11:35:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk1NzExNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk3NzQ0NQ==", "url": "https://github.com/apereo/cas/pull/4844#discussion_r422977445", "bodyText": "What happens if, let's say, an ldap connection factory is shared between two beans and both try to dispose it on destroy events?\n\nI guess this is intended. As you asked before, it is possible (and completely reasonable) to share same ConnectionFactory to multiple objects, so only application knows when they can be closed.", "author": "leeyc0", "createdAt": "2020-05-11T11:36:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk1NzExNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzA1ODgyNQ==", "url": "https://github.com/apereo/cas/pull/4844#discussion_r423058825", "bodyText": "Pinging @dfish3r; What do you think?\n\nThis is such a common problem that I've added a close implementation in the latest snapshot.\nhttps://github.com/vt-middleware/ldaptive/blob/master/core/src/main/java/org/ldaptive/auth/Authenticator.java#L266\nSince authenticator components could be custom, close isn't a guarantee. However, if you're using supplied implementations it will work as desired. I imagine that's 99% of use cases so it's a method worth having.", "author": "dfish3r", "createdAt": "2020-05-11T13:57:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk1NzExNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzA2NTY3OA==", "url": "https://github.com/apereo/cas/pull/4844#discussion_r423065678", "bodyText": "So I would need to wait for a new snapshot version update to change these to authenticator.close()", "author": "leeyc0", "createdAt": "2020-05-11T14:07:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk1NzExNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzA4NDYyMA==", "url": "https://github.com/apereo/cas/pull/4844#discussion_r423084620", "bodyText": "authenticator.close() should be enough.\n\nBTW I actually misread the this comment before. I agree to use authenticator.close() if there is one.", "author": "leeyc0", "createdAt": "2020-05-11T14:33:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk1NzExNQ=="}], "type": "inlineReview", "revised_code": {"commit": "762b5913f62ed82d810f55ff09b7637b50163671", "chunk": "diff --git a/support/cas-server-support-ldap/src/main/java/org/apereo/cas/authentication/LdapAuthenticationHandler.java b/support/cas-server-support-ldap/src/main/java/org/apereo/cas/authentication/LdapAuthenticationHandler.java\nindex b02ebd22cd..5c01206fb7 100644\n--- a/support/cas-server-support-ldap/src/main/java/org/apereo/cas/authentication/LdapAuthenticationHandler.java\n+++ b/support/cas-server-support-ldap/src/main/java/org/apereo/cas/authentication/LdapAuthenticationHandler.java\n\n@@ -107,14 +104,7 @@ public class LdapAuthenticationHandler extends AbstractUsernamePasswordAuthentic\n \n     @Override\n     public void destroy() {\n-        val authenticationHandler = (AbstractAuthenticationHandler) authenticator.getAuthenticationHandler();\n-        val dnResolver = (SearchDnResolver) authenticator.getDnResolver();\n-        val entryResolver = (AbstractSearchEntryResolver) authenticator.getEntryResolver();\n-        authenticationHandler.getConnectionFactory().close();\n-        dnResolver.getConnectionFactory().close();\n-        if (entryResolver != null) {\n-            entryResolver.getConnectionFactory().close();\n-        }\n+        authenticator.close();\n     }\n \n     @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk1NzQ1MQ==", "url": "https://github.com/apereo/cas/pull/4844#discussion_r422957451", "bodyText": "If proper bean (and not an inner object) Spring should take care of it?", "author": "mmoayyed", "createdAt": "2020-05-11T10:57:12Z", "path": "support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapAuthenticationConfiguration.java", "diffHunk": "@@ -154,6 +155,16 @@ public PrincipalFactory ldapPrincipalFactory() {\n         return PrincipalFactoryUtils.newPrincipalFactory();\n     }\n \n+    @Bean(name = \"ldapAuthenticationConfigurationNewLdapAuthenticationHandler\")\n+    @Scope(\"prototype\")\n+    public LdapAuthenticationHandler newLdapAuthenticationHandler(final String name, final ServicesManager servicesManager,\n+                                     final PrincipalFactory principalFactory, final Integer order,\n+                                     final Authenticator authenticator,\n+                                     final AuthenticationPasswordPolicyHandlingStrategy strategy) {\n+        return new LdapAuthenticationHandler(name, servicesManager, principalFactory, order,\n+                                             authenticator, strategy);\n+    }\n+", "originalCommit": "c62239aaeb69bbe7331650ba69756f116fb0c62d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk4MDY0MA==", "url": "https://github.com/apereo/cas/pull/4844#discussion_r422980640", "bodyText": "See above", "author": "leeyc0", "createdAt": "2020-05-11T11:43:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk1NzQ1MQ=="}], "type": "inlineReview", "revised_code": {"commit": "762b5913f62ed82d810f55ff09b7637b50163671", "chunk": "diff --git a/support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapAuthenticationConfiguration.java b/support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapAuthenticationConfiguration.java\nindex cf77fbc2aa..e0b9e4069b 100644\n--- a/support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapAuthenticationConfiguration.java\n+++ b/support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapAuthenticationConfiguration.java\n\n@@ -155,16 +154,6 @@ public class LdapAuthenticationConfiguration {\n         return PrincipalFactoryUtils.newPrincipalFactory();\n     }\n \n-    @Bean(name = \"ldapAuthenticationConfigurationNewLdapAuthenticationHandler\")\n-    @Scope(\"prototype\")\n-    public LdapAuthenticationHandler newLdapAuthenticationHandler(final String name, final ServicesManager servicesManager,\n-                                     final PrincipalFactory principalFactory, final Integer order,\n-                                     final Authenticator authenticator,\n-                                     final AuthenticationPasswordPolicyHandlingStrategy strategy) {\n-        return new LdapAuthenticationHandler(name, servicesManager, principalFactory, order,\n-                                             authenticator, strategy);\n-    }\n-\n     @Bean\n     @RefreshScope\n     public Collection<AuthenticationHandler> ldapAuthenticationHandlers() {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk1NzU0Mg==", "url": "https://github.com/apereo/cas/pull/4844#discussion_r422957542", "bodyText": "Remove all parameter passing.", "author": "mmoayyed", "createdAt": "2020-05-11T10:57:22Z", "path": "support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapAuthenticationConfiguration.java", "diffHunk": "@@ -154,6 +155,16 @@ public PrincipalFactory ldapPrincipalFactory() {\n         return PrincipalFactoryUtils.newPrincipalFactory();\n     }\n \n+    @Bean(name = \"ldapAuthenticationConfigurationNewLdapAuthenticationHandler\")\n+    @Scope(\"prototype\")\n+    public LdapAuthenticationHandler newLdapAuthenticationHandler(final String name, final ServicesManager servicesManager,\n+                                     final PrincipalFactory principalFactory, final Integer order,\n+                                     final Authenticator authenticator,\n+                                     final AuthenticationPasswordPolicyHandlingStrategy strategy) {\n+        return new LdapAuthenticationHandler(name, servicesManager, principalFactory, order,\n+                                             authenticator, strategy);\n+    }\n+", "originalCommit": "c62239aaeb69bbe7331650ba69756f116fb0c62d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk4MDk1MQ==", "url": "https://github.com/apereo/cas/pull/4844#discussion_r422980951", "bodyText": "This is the intended use of prototype bean - parameterized multiple bean instances", "author": "leeyc0", "createdAt": "2020-05-11T11:43:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk1NzU0Mg=="}], "type": "inlineReview", "revised_code": {"commit": "762b5913f62ed82d810f55ff09b7637b50163671", "chunk": "diff --git a/support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapAuthenticationConfiguration.java b/support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapAuthenticationConfiguration.java\nindex cf77fbc2aa..e0b9e4069b 100644\n--- a/support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapAuthenticationConfiguration.java\n+++ b/support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapAuthenticationConfiguration.java\n\n@@ -155,16 +154,6 @@ public class LdapAuthenticationConfiguration {\n         return PrincipalFactoryUtils.newPrincipalFactory();\n     }\n \n-    @Bean(name = \"ldapAuthenticationConfigurationNewLdapAuthenticationHandler\")\n-    @Scope(\"prototype\")\n-    public LdapAuthenticationHandler newLdapAuthenticationHandler(final String name, final ServicesManager servicesManager,\n-                                     final PrincipalFactory principalFactory, final Integer order,\n-                                     final Authenticator authenticator,\n-                                     final AuthenticationPasswordPolicyHandlingStrategy strategy) {\n-        return new LdapAuthenticationHandler(name, servicesManager, principalFactory, order,\n-                                             authenticator, strategy);\n-    }\n-\n     @Bean\n     @RefreshScope\n     public Collection<AuthenticationHandler> ldapAuthenticationHandlers() {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk1NzY4MQ==", "url": "https://github.com/apereo/cas/pull/4844#discussion_r422957681", "bodyText": "Remove getBean references. Should never be used.", "author": "mmoayyed", "createdAt": "2020-05-11T10:57:39Z", "path": "support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapAuthenticationConfiguration.java", "diffHunk": "@@ -185,8 +196,9 @@ public PrincipalFactory ldapPrincipalFactory() {\n                 val strategy = createLdapPasswordPolicyHandlingStrategy(l);\n \n                 LOGGER.debug(\"Creating LDAP authentication handler for [{}]\", l.getLdapUrl());\n-                val handler = new LdapAuthenticationHandler(l.getName(),\n-                    servicesManager.getObject(), ldapPrincipalFactory(),\n+                val handler = (LdapAuthenticationHandler) applicationContext.getBean(\n+                    \"ldapAuthenticationConfigurationNewLdapAuthenticationHandler\",\n+                    l.getName(), servicesManager.getObject(), ldapPrincipalFactory(),\n                     l.getOrder(), authenticator, strategy);", "originalCommit": "c62239aaeb69bbe7331650ba69756f116fb0c62d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk4MTMxNg==", "url": "https://github.com/apereo/cas/pull/4844#discussion_r422981316", "bodyText": "This is prototype bean.", "author": "leeyc0", "createdAt": "2020-05-11T11:44:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk1NzY4MQ=="}], "type": "inlineReview", "revised_code": {"commit": "762b5913f62ed82d810f55ff09b7637b50163671", "chunk": "diff --git a/support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapAuthenticationConfiguration.java b/support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapAuthenticationConfiguration.java\nindex cf77fbc2aa..e0b9e4069b 100644\n--- a/support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapAuthenticationConfiguration.java\n+++ b/support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapAuthenticationConfiguration.java\n\n@@ -196,9 +185,8 @@ public class LdapAuthenticationConfiguration {\n                 val strategy = createLdapPasswordPolicyHandlingStrategy(l);\n \n                 LOGGER.debug(\"Creating LDAP authentication handler for [{}]\", l.getLdapUrl());\n-                val handler = (LdapAuthenticationHandler) applicationContext.getBean(\n-                    \"ldapAuthenticationConfigurationNewLdapAuthenticationHandler\",\n-                    l.getName(), servicesManager.getObject(), ldapPrincipalFactory(),\n+                val handler = new LdapAuthenticationHandler(l.getName(),\n+                    servicesManager.getObject(), ldapPrincipalFactory(),\n                     l.getOrder(), authenticator, strategy);\n                 handler.setCollectDnAttribute(l.isCollectDnAttribute());\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk1Nzg4Ng==", "url": "https://github.com/apereo/cas/pull/4844#discussion_r422957886", "bodyText": "Bean name should match method name, as it's done everywhere else unless there is good reason not to.", "author": "mmoayyed", "createdAt": "2020-05-11T10:58:01Z", "path": "support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapAuthenticationConfiguration.java", "diffHunk": "@@ -154,6 +155,16 @@ public PrincipalFactory ldapPrincipalFactory() {\n         return PrincipalFactoryUtils.newPrincipalFactory();\n     }\n \n+    @Bean(name = \"ldapAuthenticationConfigurationNewLdapAuthenticationHandler\")\n+    @Scope(\"prototype\")\n+    public LdapAuthenticationHandler newLdapAuthenticationHandler(final String name, final ServicesManager servicesManager,", "originalCommit": "c62239aaeb69bbe7331650ba69756f116fb0c62d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "762b5913f62ed82d810f55ff09b7637b50163671", "chunk": "diff --git a/support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapAuthenticationConfiguration.java b/support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapAuthenticationConfiguration.java\nindex cf77fbc2aa..e0b9e4069b 100644\n--- a/support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapAuthenticationConfiguration.java\n+++ b/support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapAuthenticationConfiguration.java\n\n@@ -155,16 +154,6 @@ public class LdapAuthenticationConfiguration {\n         return PrincipalFactoryUtils.newPrincipalFactory();\n     }\n \n-    @Bean(name = \"ldapAuthenticationConfigurationNewLdapAuthenticationHandler\")\n-    @Scope(\"prototype\")\n-    public LdapAuthenticationHandler newLdapAuthenticationHandler(final String name, final ServicesManager servicesManager,\n-                                     final PrincipalFactory principalFactory, final Integer order,\n-                                     final Authenticator authenticator,\n-                                     final AuthenticationPasswordPolicyHandlingStrategy strategy) {\n-        return new LdapAuthenticationHandler(name, servicesManager, principalFactory, order,\n-                                             authenticator, strategy);\n-    }\n-\n     @Bean\n     @RefreshScope\n     public Collection<AuthenticationHandler> ldapAuthenticationHandlers() {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk1Nzk2OA==", "url": "https://github.com/apereo/cas/pull/4844#discussion_r422957968", "bodyText": "Bean name should match method name, as it's done everywhere else unless there is good reason not to.", "author": "mmoayyed", "createdAt": "2020-05-11T10:58:11Z", "path": "support/cas-server-support-ldap-monitor/src/main/java/org/apereo/cas/monitor/config/LdapMonitorConfiguration.java", "diffHunk": "@@ -35,6 +40,19 @@\n     @Autowired\n     private CasConfigurationProperties casProperties;\n \n+    @Autowired\n+    private ApplicationContext applicationContext;\n+\n+    @Bean(name = \"ldapMonitorConfigurationPooledLdapConnectionFactoryHealthIndicator\")\n+    @Scope(\"prototype\")\n+    public PooledLdapConnectionFactoryHealthIndicator pooledLdapConnectionFactoryHealthIndicator(", "originalCommit": "c62239aaeb69bbe7331650ba69756f116fb0c62d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "762b5913f62ed82d810f55ff09b7637b50163671", "chunk": "diff --git a/support/cas-server-support-ldap-monitor/src/main/java/org/apereo/cas/monitor/config/LdapMonitorConfiguration.java b/support/cas-server-support-ldap-monitor/src/main/java/org/apereo/cas/monitor/config/LdapMonitorConfiguration.java\nindex 379f485544..3324565205 100644\n--- a/support/cas-server-support-ldap-monitor/src/main/java/org/apereo/cas/monitor/config/LdapMonitorConfiguration.java\n+++ b/support/cas-server-support-ldap-monitor/src/main/java/org/apereo/cas/monitor/config/LdapMonitorConfiguration.java\n\n@@ -40,19 +35,6 @@ public class LdapMonitorConfiguration {\n     @Autowired\n     private CasConfigurationProperties casProperties;\n \n-    @Autowired\n-    private ApplicationContext applicationContext;\n-\n-    @Bean(name = \"ldapMonitorConfigurationPooledLdapConnectionFactoryHealthIndicator\")\n-    @Scope(\"prototype\")\n-    public PooledLdapConnectionFactoryHealthIndicator pooledLdapConnectionFactoryHealthIndicator(\n-                                                      final Long maxWait,\n-                                                      final PooledConnectionFactory factory,\n-                                                      final ExecutorService executor,\n-                                                      final ConnectionValidator validator) {\n-        return new PooledLdapConnectionFactoryHealthIndicator(maxWait.longValue(), factory, executor, validator);\n-    }\n-\n     @Bean\n     @ConditionalOnEnabledHealthIndicator(\"pooledLdapConnectionFactoryHealthIndicator\")\n     public CompositeHealthContributor pooledLdapConnectionFactoryHealthIndicator() {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk1ODA5Nw==", "url": "https://github.com/apereo/cas/pull/4844#discussion_r422958097", "bodyText": "See above.", "author": "mmoayyed", "createdAt": "2020-05-11T10:58:26Z", "path": "support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapPasswordSynchronizationConfiguration.java", "diffHunk": "@@ -24,6 +27,16 @@\n     @Autowired\n     private CasConfigurationProperties casProperties;\n \n+    @Autowired\n+    private ApplicationContext applicationContext;\n+\n+    @Bean\n+    @Scope(\"prototype\")\n+    public LdapPasswordSynchronizationAuthenticationPostProcessor ldapPasswordSynchronizationAuthenticationPostProcessor(\n+            final AbstractLdapSearchProperties properties) {\n+        return new LdapPasswordSynchronizationAuthenticationPostProcessor(properties);\n+    }\n+", "originalCommit": "c62239aaeb69bbe7331650ba69756f116fb0c62d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk4MTU0Mw==", "url": "https://github.com/apereo/cas/pull/4844#discussion_r422981543", "bodyText": "Prototype bean is needed", "author": "leeyc0", "createdAt": "2020-05-11T11:45:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk1ODA5Nw=="}], "type": "inlineReview", "revised_code": {"commit": "762b5913f62ed82d810f55ff09b7637b50163671", "chunk": "diff --git a/support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapPasswordSynchronizationConfiguration.java b/support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapPasswordSynchronizationConfiguration.java\nindex adaeefa637..6a904fb592 100644\n--- a/support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapPasswordSynchronizationConfiguration.java\n+++ b/support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapPasswordSynchronizationConfiguration.java\n\n@@ -27,16 +24,6 @@ public class LdapPasswordSynchronizationConfiguration {\n     @Autowired\n     private CasConfigurationProperties casProperties;\n \n-    @Autowired\n-    private ApplicationContext applicationContext;\n-\n-    @Bean\n-    @Scope(\"prototype\")\n-    public LdapPasswordSynchronizationAuthenticationPostProcessor ldapPasswordSynchronizationAuthenticationPostProcessor(\n-            final AbstractLdapSearchProperties properties) {\n-        return new LdapPasswordSynchronizationAuthenticationPostProcessor(properties);\n-    }\n-\n     @ConditionalOnMissingBean(name = \"ldapPasswordSynchronizationAuthenticationEventExecutionPlanConfigurer\")\n     @Bean\n     public AuthenticationEventExecutionPlanConfigurer ldapPasswordSynchronizationAuthenticationEventExecutionPlanConfigurer() {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk1ODIxMg==", "url": "https://github.com/apereo/cas/pull/4844#discussion_r422958212", "bodyText": "See above.", "author": "mmoayyed", "createdAt": "2020-05-11T10:58:34Z", "path": "support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapPasswordSynchronizationConfiguration.java", "diffHunk": "@@ -32,7 +45,9 @@ public AuthenticationEventExecutionPlanConfigurer ldapPasswordSynchronizationAut\n             ldap.stream()\n                 .filter(LdapPasswordSynchronizationProperties::isEnabled)\n                 .forEach(instance ->\n-                    plan.registerAuthenticationPostProcessor(new LdapPasswordSynchronizationAuthenticationPostProcessor(instance)));\n+                    plan.registerAuthenticationPostProcessor(\n+                        this.applicationContext.getBean(LdapPasswordSynchronizationAuthenticationPostProcessor.class, instance))\n+                );", "originalCommit": "c62239aaeb69bbe7331650ba69756f116fb0c62d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk4MTU4NQ==", "url": "https://github.com/apereo/cas/pull/4844#discussion_r422981585", "bodyText": "Prototype bean is needed", "author": "leeyc0", "createdAt": "2020-05-11T11:45:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk1ODIxMg=="}], "type": "inlineReview", "revised_code": {"commit": "762b5913f62ed82d810f55ff09b7637b50163671", "chunk": "diff --git a/support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapPasswordSynchronizationConfiguration.java b/support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapPasswordSynchronizationConfiguration.java\nindex adaeefa637..6a904fb592 100644\n--- a/support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapPasswordSynchronizationConfiguration.java\n+++ b/support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapPasswordSynchronizationConfiguration.java\n\n@@ -45,9 +32,7 @@ public class LdapPasswordSynchronizationConfiguration {\n             ldap.stream()\n                 .filter(LdapPasswordSynchronizationProperties::isEnabled)\n                 .forEach(instance ->\n-                    plan.registerAuthenticationPostProcessor(\n-                        this.applicationContext.getBean(LdapPasswordSynchronizationAuthenticationPostProcessor.class, instance))\n-                );\n+                    plan.registerAuthenticationPostProcessor(new LdapPasswordSynchronizationAuthenticationPostProcessor(instance)));\n         };\n     }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzg1NTMxNg==", "url": "https://github.com/apereo/cas/pull/4844#discussion_r423855316", "bodyText": "Does the bean need to be public? If so, please mark it as so. Or more generally, specify the access keyword to be consistent and transparent.", "author": "mmoayyed", "createdAt": "2020-05-12T16:07:06Z", "path": "support/cas-server-support-ldap-monitor/src/main/java/org/apereo/cas/monitor/config/LdapMonitorConfiguration.java", "diffHunk": "@@ -36,16 +40,33 @@\n     private CasConfigurationProperties casProperties;\n \n     @Bean\n+    ListFactoryBean pooledLdapConnectionFactoryHealthIndicatorFactoryBean() {", "originalCommit": "cb96f46f64c965d1d5b4cc804b61209cad7b3760", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA4NTEzMA==", "url": "https://github.com/apereo/cas/pull/4844#discussion_r424085130", "bodyText": "Bean methods MUST be public, otherwise Spring will be unable to access the method to initialize this. This is an accidental mistake.", "author": "leeyc0", "createdAt": "2020-05-12T23:11:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzg1NTMxNg=="}], "type": "inlineReview", "revised_code": {"commit": "762b5913f62ed82d810f55ff09b7637b50163671", "chunk": "diff --git a/support/cas-server-support-ldap-monitor/src/main/java/org/apereo/cas/monitor/config/LdapMonitorConfiguration.java b/support/cas-server-support-ldap-monitor/src/main/java/org/apereo/cas/monitor/config/LdapMonitorConfiguration.java\nindex b6abd92351..3324565205 100644\n--- a/support/cas-server-support-ldap-monitor/src/main/java/org/apereo/cas/monitor/config/LdapMonitorConfiguration.java\n+++ b/support/cas-server-support-ldap-monitor/src/main/java/org/apereo/cas/monitor/config/LdapMonitorConfiguration.java\n\n@@ -40,25 +36,9 @@ public class LdapMonitorConfiguration {\n     private CasConfigurationProperties casProperties;\n \n     @Bean\n-    ListFactoryBean pooledLdapConnectionFactoryHealthIndicatorFactoryBean() {\n-        return new ListFactoryBean() {\n-            @Override\n-            protected void destroyInstance(final List list) {\n-                list.forEach(connectionFactory -> {\n-                    ((ConnectionFactory) connectionFactory).close();\n-                });\n-            }\n-        };\n-    }\n-\n-    @Bean\n-    @SneakyThrows\n-    @Autowired\n     @ConditionalOnEnabledHealthIndicator(\"pooledLdapConnectionFactoryHealthIndicator\")\n-    public CompositeHealthContributor pooledLdapConnectionFactoryHealthIndicator(\n-            final ListFactoryBean pooledLdapConnectionFactoryHealthIndicatorFactoryBean) {\n+    public CompositeHealthContributor pooledLdapConnectionFactoryHealthIndicator() {\n         val ldaps = casProperties.getMonitor().getLdap();\n-        val connectionFactoryList = pooledLdapConnectionFactoryHealthIndicatorFactoryBean.getObject();\n         val contributors = new LinkedHashMap<>(MAP_SIZE);\n         ldaps.stream()\n             .filter(LdapMonitorProperties::isEnabled)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzg1NTU2MQ==", "url": "https://github.com/apereo/cas/pull/4844#discussion_r423855561", "bodyText": "Specify a qualifier for the injected parameter by its name, to avoid conflicts in the future", "author": "mmoayyed", "createdAt": "2020-05-12T16:07:30Z", "path": "support/cas-server-support-ldap-monitor/src/main/java/org/apereo/cas/monitor/config/LdapMonitorConfiguration.java", "diffHunk": "@@ -36,16 +40,33 @@\n     private CasConfigurationProperties casProperties;\n \n     @Bean\n+    ListFactoryBean pooledLdapConnectionFactoryHealthIndicatorFactoryBean() {\n+        return new ListFactoryBean() {\n+            @Override\n+            protected void destroyInstance(final List list) {\n+                list.forEach(connectionFactory -> {\n+                    ((ConnectionFactory) connectionFactory).close();\n+                });\n+            }\n+        };\n+    }\n+\n+    @Bean\n+    @SneakyThrows\n+    @Autowired\n     @ConditionalOnEnabledHealthIndicator(\"pooledLdapConnectionFactoryHealthIndicator\")\n-    public CompositeHealthContributor pooledLdapConnectionFactoryHealthIndicator() {\n+    public CompositeHealthContributor pooledLdapConnectionFactoryHealthIndicator(\n+            final ListFactoryBean pooledLdapConnectionFactoryHealthIndicatorFactoryBean) {", "originalCommit": "cb96f46f64c965d1d5b4cc804b61209cad7b3760", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "762b5913f62ed82d810f55ff09b7637b50163671", "chunk": "diff --git a/support/cas-server-support-ldap-monitor/src/main/java/org/apereo/cas/monitor/config/LdapMonitorConfiguration.java b/support/cas-server-support-ldap-monitor/src/main/java/org/apereo/cas/monitor/config/LdapMonitorConfiguration.java\nindex b6abd92351..3324565205 100644\n--- a/support/cas-server-support-ldap-monitor/src/main/java/org/apereo/cas/monitor/config/LdapMonitorConfiguration.java\n+++ b/support/cas-server-support-ldap-monitor/src/main/java/org/apereo/cas/monitor/config/LdapMonitorConfiguration.java\n\n@@ -40,25 +36,9 @@ public class LdapMonitorConfiguration {\n     private CasConfigurationProperties casProperties;\n \n     @Bean\n-    ListFactoryBean pooledLdapConnectionFactoryHealthIndicatorFactoryBean() {\n-        return new ListFactoryBean() {\n-            @Override\n-            protected void destroyInstance(final List list) {\n-                list.forEach(connectionFactory -> {\n-                    ((ConnectionFactory) connectionFactory).close();\n-                });\n-            }\n-        };\n-    }\n-\n-    @Bean\n-    @SneakyThrows\n-    @Autowired\n     @ConditionalOnEnabledHealthIndicator(\"pooledLdapConnectionFactoryHealthIndicator\")\n-    public CompositeHealthContributor pooledLdapConnectionFactoryHealthIndicator(\n-            final ListFactoryBean pooledLdapConnectionFactoryHealthIndicatorFactoryBean) {\n+    public CompositeHealthContributor pooledLdapConnectionFactoryHealthIndicator() {\n         val ldaps = casProperties.getMonitor().getLdap();\n-        val connectionFactoryList = pooledLdapConnectionFactoryHealthIndicatorFactoryBean.getObject();\n         val contributors = new LinkedHashMap<>(MAP_SIZE);\n         ldaps.stream()\n             .filter(LdapMonitorProperties::isEnabled)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzg1NTgwNQ==", "url": "https://github.com/apereo/cas/pull/4844#discussion_r423855805", "bodyText": "Same sort of comments as above with access keywords and qualifiers.", "author": "mmoayyed", "createdAt": "2020-05-12T16:07:50Z", "path": "support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapAuthenticationConfiguration.java", "diffHunk": "@@ -154,9 +156,22 @@ public PrincipalFactory ldapPrincipalFactory() {\n         return PrincipalFactoryUtils.newPrincipalFactory();\n     }\n \n+    @Bean\n+    SetFactoryBean ldapAuthenticationHandlerFactoryBean() {\n+        return new SetFactoryBean() {\n+            @Override\n+            protected void destroyInstance(final Set set) {\n+                set.forEach(handler -> {\n+                    ((LdapAuthenticationHandler) handler).destroy();\n+                });\n+            }\n+        };\n+    }\n+\n     @Bean\n     @RefreshScope\n-    public Collection<AuthenticationHandler> ldapAuthenticationHandlers() {\n+    public Collection<AuthenticationHandler> ldapAuthenticationHandlers(\n+            final SetFactoryBean ldapAuthenticationHandlerFactoryBean) {\n         val handlers = new HashSet<AuthenticationHandler>();", "originalCommit": "cb96f46f64c965d1d5b4cc804b61209cad7b3760", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "762b5913f62ed82d810f55ff09b7637b50163671", "chunk": "diff --git a/support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapAuthenticationConfiguration.java b/support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapAuthenticationConfiguration.java\nindex 626c7420c3..e0b9e4069b 100644\n--- a/support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapAuthenticationConfiguration.java\n+++ b/support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapAuthenticationConfiguration.java\n\n@@ -156,22 +154,9 @@ public class LdapAuthenticationConfiguration {\n         return PrincipalFactoryUtils.newPrincipalFactory();\n     }\n \n-    @Bean\n-    SetFactoryBean ldapAuthenticationHandlerFactoryBean() {\n-        return new SetFactoryBean() {\n-            @Override\n-            protected void destroyInstance(final Set set) {\n-                set.forEach(handler -> {\n-                    ((LdapAuthenticationHandler) handler).destroy();\n-                });\n-            }\n-        };\n-    }\n-\n     @Bean\n     @RefreshScope\n-    public Collection<AuthenticationHandler> ldapAuthenticationHandlers(\n-            final SetFactoryBean ldapAuthenticationHandlerFactoryBean) {\n+    public Collection<AuthenticationHandler> ldapAuthenticationHandlers() {\n         val handlers = new HashSet<AuthenticationHandler>();\n \n         casProperties.getAuthn().getLdap()\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzg1NjQyMg==", "url": "https://github.com/apereo/cas/pull/4844#discussion_r423856422", "bodyText": "Can the cast here be more generic to use DisposableBean? Casting to a concrete impl might cause issues for extensions.", "author": "mmoayyed", "createdAt": "2020-05-12T16:08:46Z", "path": "support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapAuthenticationConfiguration.java", "diffHunk": "@@ -154,9 +156,22 @@ public PrincipalFactory ldapPrincipalFactory() {\n         return PrincipalFactoryUtils.newPrincipalFactory();\n     }\n \n+    @Bean\n+    SetFactoryBean ldapAuthenticationHandlerFactoryBean() {\n+        return new SetFactoryBean() {\n+            @Override\n+            protected void destroyInstance(final Set set) {\n+                set.forEach(handler -> {\n+                    ((LdapAuthenticationHandler) handler).destroy();", "originalCommit": "cb96f46f64c965d1d5b4cc804b61209cad7b3760", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA4NDg1Mg==", "url": "https://github.com/apereo/cas/pull/4844#discussion_r424084852", "bodyText": "No problem", "author": "leeyc0", "createdAt": "2020-05-12T23:10:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzg1NjQyMg=="}], "type": "inlineReview", "revised_code": {"commit": "762b5913f62ed82d810f55ff09b7637b50163671", "chunk": "diff --git a/support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapAuthenticationConfiguration.java b/support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapAuthenticationConfiguration.java\nindex 626c7420c3..e0b9e4069b 100644\n--- a/support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapAuthenticationConfiguration.java\n+++ b/support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapAuthenticationConfiguration.java\n\n@@ -156,22 +154,9 @@ public class LdapAuthenticationConfiguration {\n         return PrincipalFactoryUtils.newPrincipalFactory();\n     }\n \n-    @Bean\n-    SetFactoryBean ldapAuthenticationHandlerFactoryBean() {\n-        return new SetFactoryBean() {\n-            @Override\n-            protected void destroyInstance(final Set set) {\n-                set.forEach(handler -> {\n-                    ((LdapAuthenticationHandler) handler).destroy();\n-                });\n-            }\n-        };\n-    }\n-\n     @Bean\n     @RefreshScope\n-    public Collection<AuthenticationHandler> ldapAuthenticationHandlers(\n-            final SetFactoryBean ldapAuthenticationHandlerFactoryBean) {\n+    public Collection<AuthenticationHandler> ldapAuthenticationHandlers() {\n         val handlers = new HashSet<AuthenticationHandler>();\n \n         casProperties.getAuthn().getLdap()\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzg1NjY4Mg==", "url": "https://github.com/apereo/cas/pull/4844#discussion_r423856682", "bodyText": "Should also be reviewed per earlier comments.", "author": "mmoayyed", "createdAt": "2020-05-12T16:09:06Z", "path": "support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapPasswordSynchronizationConfiguration.java", "diffHunk": "@@ -24,15 +28,35 @@\n     @Autowired\n     private CasConfigurationProperties casProperties;\n \n+    @Bean\n+    @SneakyThrows\n+    ListFactoryBean ldapPasswordSynchronizationAuthenticationPostProcessorListFactoryBean() {\n+        return new ListFactoryBean() {\n+            @Override\n+            protected void destroyInstance(final List list) {\n+                list.forEach(postProcessor -> {\n+                    ((LdapPasswordSynchronizationAuthenticationPostProcessor) postProcessor).destroy();\n+                });\n+            }\n+        };\n+    }", "originalCommit": "cb96f46f64c965d1d5b4cc804b61209cad7b3760", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "762b5913f62ed82d810f55ff09b7637b50163671", "chunk": "diff --git a/support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapPasswordSynchronizationConfiguration.java b/support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapPasswordSynchronizationConfiguration.java\nindex 34ada1c464..6a904fb592 100644\n--- a/support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapPasswordSynchronizationConfiguration.java\n+++ b/support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapPasswordSynchronizationConfiguration.java\n\n@@ -28,35 +24,15 @@ public class LdapPasswordSynchronizationConfiguration {\n     @Autowired\n     private CasConfigurationProperties casProperties;\n \n-    @Bean\n-    @SneakyThrows\n-    ListFactoryBean ldapPasswordSynchronizationAuthenticationPostProcessorListFactoryBean() {\n-        return new ListFactoryBean() {\n-            @Override\n-            protected void destroyInstance(final List list) {\n-                list.forEach(postProcessor -> {\n-                    ((LdapPasswordSynchronizationAuthenticationPostProcessor) postProcessor).destroy();\n-                });\n-            }\n-        };\n-    }\n-\n     @ConditionalOnMissingBean(name = \"ldapPasswordSynchronizationAuthenticationEventExecutionPlanConfigurer\")\n     @Bean\n-    @SneakyThrows\n-    @Autowired\n-    public AuthenticationEventExecutionPlanConfigurer ldapPasswordSynchronizationAuthenticationEventExecutionPlanConfigurer(\n-            final ListFactoryBean ldapPasswordSynchronizationAuthenticationPostProcessorListFactoryBean) {\n-        val postProcessorList = ldapPasswordSynchronizationAuthenticationPostProcessorListFactoryBean.getObject();\n+    public AuthenticationEventExecutionPlanConfigurer ldapPasswordSynchronizationAuthenticationEventExecutionPlanConfigurer() {\n         return plan -> {\n             val ldap = casProperties.getAuthn().getPasswordSync().getLdap();\n             ldap.stream()\n                 .filter(LdapPasswordSynchronizationProperties::isEnabled)\n-                .forEach(instance -> {\n-                    val postProcessor = new LdapPasswordSynchronizationAuthenticationPostProcessor(instance);\n-                    postProcessorList.add(postProcessor);\n-                    plan.registerAuthenticationPostProcessor(postProcessor);\n-                });\n+                .forEach(instance ->\n+                    plan.registerAuthenticationPostProcessor(new LdapPasswordSynchronizationAuthenticationPostProcessor(instance)));\n         };\n     }\n }\n"}}, {"oid": "762b5913f62ed82d810f55ff09b7637b50163671", "url": "https://github.com/apereo/cas/commit/762b5913f62ed82d810f55ff09b7637b50163671", "message": "mark these as disposable bean", "committedDate": "2020-05-13T01:15:19Z", "type": "commit"}, {"oid": "3ed632641ca042f4ed86f02361c1b77a66d1b4f6", "url": "https://github.com/apereo/cas/commit/3ed632641ca042f4ed86f02361c1b77a66d1b4f6", "message": "add destroy() test", "committedDate": "2020-05-13T05:07:10Z", "type": "commit"}, {"oid": "7ec49ebe2ddd36d1079b8e117e1ccaef7693de7a", "url": "https://github.com/apereo/cas/commit/7ec49ebe2ddd36d1079b8e117e1ccaef7693de7a", "message": "using FactoryBean to store objects that need to be disposed", "committedDate": "2020-05-13T09:59:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDMzMzAyNg==", "url": "https://github.com/apereo/cas/pull/4844#discussion_r424333026", "bodyText": "Should be:\n @Qualifier(\"pooledLdapConnectionFactoryHealthIndicatorListFactoryBean\")\n final ListFactoryBean pooledLdapConnectionFactoryHealthIndicatorListFactoryBean\n\nThe parameter that is injected is qualified; not the bean itself.", "author": "mmoayyed", "createdAt": "2020-05-13T10:24:19Z", "path": "support/cas-server-support-ldap-monitor/src/main/java/org/apereo/cas/monitor/config/LdapMonitorConfiguration.java", "diffHunk": "@@ -36,16 +42,36 @@\n     private CasConfigurationProperties casProperties;\n \n     @Bean\n+    public ListFactoryBean pooledLdapConnectionFactoryHealthIndicatorListFactoryBean() {\n+        val list = new ListFactoryBean() {\n+            @Override\n+            protected void destroyInstance(final List list) {\n+                list.forEach(connectionFactory -> {\n+                    ((ConnectionFactory) connectionFactory).close();\n+                });\n+            }\n+        };\n+        list.setSourceList(new ArrayList());\n+        return list;\n+    }\n+\n+    @Bean\n+    @SneakyThrows\n+    @Autowired\n+    @Qualifier(\"pooledLdapConnectionFactoryHealthIndicatorListFactoryBean\")\n     @ConditionalOnEnabledHealthIndicator(\"pooledLdapConnectionFactoryHealthIndicator\")\n-    public CompositeHealthContributor pooledLdapConnectionFactoryHealthIndicator() {\n+    public CompositeHealthContributor pooledLdapConnectionFactoryHealthIndicator(\n+            final ListFactoryBean pooledLdapConnectionFactoryHealthIndicatorListFactoryBean) {", "originalCommit": "7ec49ebe2ddd36d1079b8e117e1ccaef7693de7a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c37aba84b245ed116ed6810b1ddf620ed32191bb", "chunk": "diff --git a/support/cas-server-support-ldap-monitor/src/main/java/org/apereo/cas/monitor/config/LdapMonitorConfiguration.java b/support/cas-server-support-ldap-monitor/src/main/java/org/apereo/cas/monitor/config/LdapMonitorConfiguration.java\nindex 96501ec1aa..f7cebdcf75 100644\n--- a/support/cas-server-support-ldap-monitor/src/main/java/org/apereo/cas/monitor/config/LdapMonitorConfiguration.java\n+++ b/support/cas-server-support-ldap-monitor/src/main/java/org/apereo/cas/monitor/config/LdapMonitorConfiguration.java\n\n@@ -46,21 +46,21 @@ public class LdapMonitorConfiguration {\n         val list = new ListFactoryBean() {\n             @Override\n             protected void destroyInstance(final List list) {\n-                list.forEach(connectionFactory -> {\n-                    ((ConnectionFactory) connectionFactory).close();\n-                });\n+                list.forEach(connectionFactory ->\n+                    ((ConnectionFactory) connectionFactory).close()\n+                );\n             }\n         };\n-        list.setSourceList(new ArrayList());\n+        list.setSourceList(new ArrayList<>());\n         return list;\n     }\n \n     @Bean\n     @SneakyThrows\n     @Autowired\n-    @Qualifier(\"pooledLdapConnectionFactoryHealthIndicatorListFactoryBean\")\n     @ConditionalOnEnabledHealthIndicator(\"pooledLdapConnectionFactoryHealthIndicator\")\n     public CompositeHealthContributor pooledLdapConnectionFactoryHealthIndicator(\n+            @Qualifier(\"pooledLdapConnectionFactoryHealthIndicatorListFactoryBean\")\n             final ListFactoryBean pooledLdapConnectionFactoryHealthIndicatorListFactoryBean) {\n         val ldaps = casProperties.getMonitor().getLdap();\n         val connectionFactoryList = pooledLdapConnectionFactoryHealthIndicatorListFactoryBean.getObject();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDMzMzI2MA==", "url": "https://github.com/apereo/cas/pull/4844#discussion_r424333260", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    list.setSourceList(new ArrayList());\n          \n          \n            \n                    list.setSourceList(new ArrayList<>());", "author": "mmoayyed", "createdAt": "2020-05-13T10:24:43Z", "path": "support/cas-server-support-ldap-monitor/src/main/java/org/apereo/cas/monitor/config/LdapMonitorConfiguration.java", "diffHunk": "@@ -36,16 +42,36 @@\n     private CasConfigurationProperties casProperties;\n \n     @Bean\n+    public ListFactoryBean pooledLdapConnectionFactoryHealthIndicatorListFactoryBean() {\n+        val list = new ListFactoryBean() {\n+            @Override\n+            protected void destroyInstance(final List list) {\n+                list.forEach(connectionFactory -> {\n+                    ((ConnectionFactory) connectionFactory).close();\n+                });\n+            }\n+        };\n+        list.setSourceList(new ArrayList());", "originalCommit": "7ec49ebe2ddd36d1079b8e117e1ccaef7693de7a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c37aba84b245ed116ed6810b1ddf620ed32191bb", "chunk": "diff --git a/support/cas-server-support-ldap-monitor/src/main/java/org/apereo/cas/monitor/config/LdapMonitorConfiguration.java b/support/cas-server-support-ldap-monitor/src/main/java/org/apereo/cas/monitor/config/LdapMonitorConfiguration.java\nindex 96501ec1aa..f7cebdcf75 100644\n--- a/support/cas-server-support-ldap-monitor/src/main/java/org/apereo/cas/monitor/config/LdapMonitorConfiguration.java\n+++ b/support/cas-server-support-ldap-monitor/src/main/java/org/apereo/cas/monitor/config/LdapMonitorConfiguration.java\n\n@@ -46,21 +46,21 @@ public class LdapMonitorConfiguration {\n         val list = new ListFactoryBean() {\n             @Override\n             protected void destroyInstance(final List list) {\n-                list.forEach(connectionFactory -> {\n-                    ((ConnectionFactory) connectionFactory).close();\n-                });\n+                list.forEach(connectionFactory ->\n+                    ((ConnectionFactory) connectionFactory).close()\n+                );\n             }\n         };\n-        list.setSourceList(new ArrayList());\n+        list.setSourceList(new ArrayList<>());\n         return list;\n     }\n \n     @Bean\n     @SneakyThrows\n     @Autowired\n-    @Qualifier(\"pooledLdapConnectionFactoryHealthIndicatorListFactoryBean\")\n     @ConditionalOnEnabledHealthIndicator(\"pooledLdapConnectionFactoryHealthIndicator\")\n     public CompositeHealthContributor pooledLdapConnectionFactoryHealthIndicator(\n+            @Qualifier(\"pooledLdapConnectionFactoryHealthIndicatorListFactoryBean\")\n             final ListFactoryBean pooledLdapConnectionFactoryHealthIndicatorListFactoryBean) {\n         val ldaps = casProperties.getMonitor().getLdap();\n         val connectionFactoryList = pooledLdapConnectionFactoryHealthIndicatorListFactoryBean.getObject();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDMzMzM5Mg==", "url": "https://github.com/apereo/cas/pull/4844#discussion_r424333392", "bodyText": "Can the {} be removed here? they seem unnecessary.", "author": "mmoayyed", "createdAt": "2020-05-13T10:24:56Z", "path": "support/cas-server-support-ldap-monitor/src/main/java/org/apereo/cas/monitor/config/LdapMonitorConfiguration.java", "diffHunk": "@@ -36,16 +42,36 @@\n     private CasConfigurationProperties casProperties;\n \n     @Bean\n+    public ListFactoryBean pooledLdapConnectionFactoryHealthIndicatorListFactoryBean() {\n+        val list = new ListFactoryBean() {\n+            @Override\n+            protected void destroyInstance(final List list) {\n+                list.forEach(connectionFactory -> {", "originalCommit": "7ec49ebe2ddd36d1079b8e117e1ccaef7693de7a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c37aba84b245ed116ed6810b1ddf620ed32191bb", "chunk": "diff --git a/support/cas-server-support-ldap-monitor/src/main/java/org/apereo/cas/monitor/config/LdapMonitorConfiguration.java b/support/cas-server-support-ldap-monitor/src/main/java/org/apereo/cas/monitor/config/LdapMonitorConfiguration.java\nindex 96501ec1aa..f7cebdcf75 100644\n--- a/support/cas-server-support-ldap-monitor/src/main/java/org/apereo/cas/monitor/config/LdapMonitorConfiguration.java\n+++ b/support/cas-server-support-ldap-monitor/src/main/java/org/apereo/cas/monitor/config/LdapMonitorConfiguration.java\n\n@@ -46,21 +46,21 @@ public class LdapMonitorConfiguration {\n         val list = new ListFactoryBean() {\n             @Override\n             protected void destroyInstance(final List list) {\n-                list.forEach(connectionFactory -> {\n-                    ((ConnectionFactory) connectionFactory).close();\n-                });\n+                list.forEach(connectionFactory ->\n+                    ((ConnectionFactory) connectionFactory).close()\n+                );\n             }\n         };\n-        list.setSourceList(new ArrayList());\n+        list.setSourceList(new ArrayList<>());\n         return list;\n     }\n \n     @Bean\n     @SneakyThrows\n     @Autowired\n-    @Qualifier(\"pooledLdapConnectionFactoryHealthIndicatorListFactoryBean\")\n     @ConditionalOnEnabledHealthIndicator(\"pooledLdapConnectionFactoryHealthIndicator\")\n     public CompositeHealthContributor pooledLdapConnectionFactoryHealthIndicator(\n+            @Qualifier(\"pooledLdapConnectionFactoryHealthIndicatorListFactoryBean\")\n             final ListFactoryBean pooledLdapConnectionFactoryHealthIndicatorListFactoryBean) {\n         val ldaps = casProperties.getMonitor().getLdap();\n         val connectionFactoryList = pooledLdapConnectionFactoryHealthIndicatorListFactoryBean.getObject();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDMzMzU4Ng==", "url": "https://github.com/apereo/cas/pull/4844#discussion_r424333586", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    bean.setSourceSet(new HashSet());\n          \n          \n            \n                    bean.setSourceSet(new HashSet<>());", "author": "mmoayyed", "createdAt": "2020-05-13T10:25:15Z", "path": "support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapAuthenticationConfiguration.java", "diffHunk": "@@ -155,8 +160,24 @@ public PrincipalFactory ldapPrincipalFactory() {\n     }\n \n     @Bean\n+    public SetFactoryBean ldapAuthenticationHandlerSetFactoryBean() {\n+        val bean = new SetFactoryBean() {\n+            @Override\n+            protected void destroyInstance(final Set set) {\n+                set.forEach(Unchecked.consumer(handler -> {\n+                    ((DisposableBean) handler).destroy();\n+                }));\n+            }\n+        };\n+        bean.setSourceSet(new HashSet());", "originalCommit": "7ec49ebe2ddd36d1079b8e117e1ccaef7693de7a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c37aba84b245ed116ed6810b1ddf620ed32191bb", "chunk": "diff --git a/support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapAuthenticationConfiguration.java b/support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapAuthenticationConfiguration.java\nindex 9616201be3..868a3cb931 100644\n--- a/support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapAuthenticationConfiguration.java\n+++ b/support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapAuthenticationConfiguration.java\n\n@@ -164,12 +164,12 @@ public class LdapAuthenticationConfiguration {\n         val bean = new SetFactoryBean() {\n             @Override\n             protected void destroyInstance(final Set set) {\n-                set.forEach(Unchecked.consumer(handler -> {\n-                    ((DisposableBean) handler).destroy();\n-                }));\n+                set.forEach(Unchecked.consumer(handler ->\n+                    ((DisposableBean) handler).destroy()\n+                ));\n             }\n         };\n-        bean.setSourceSet(new HashSet());\n+        bean.setSourceSet(new HashSet<>());\n         return bean;\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDMzMzY2MA==", "url": "https://github.com/apereo/cas/pull/4844#discussion_r424333660", "bodyText": "Remove {} ?", "author": "mmoayyed", "createdAt": "2020-05-13T10:25:24Z", "path": "support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapAuthenticationConfiguration.java", "diffHunk": "@@ -155,8 +160,24 @@ public PrincipalFactory ldapPrincipalFactory() {\n     }\n \n     @Bean\n+    public SetFactoryBean ldapAuthenticationHandlerSetFactoryBean() {\n+        val bean = new SetFactoryBean() {\n+            @Override\n+            protected void destroyInstance(final Set set) {\n+                set.forEach(Unchecked.consumer(handler -> {\n+                    ((DisposableBean) handler).destroy();\n+                }));", "originalCommit": "7ec49ebe2ddd36d1079b8e117e1ccaef7693de7a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c37aba84b245ed116ed6810b1ddf620ed32191bb", "chunk": "diff --git a/support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapAuthenticationConfiguration.java b/support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapAuthenticationConfiguration.java\nindex 9616201be3..868a3cb931 100644\n--- a/support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapAuthenticationConfiguration.java\n+++ b/support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapAuthenticationConfiguration.java\n\n@@ -164,12 +164,12 @@ public class LdapAuthenticationConfiguration {\n         val bean = new SetFactoryBean() {\n             @Override\n             protected void destroyInstance(final Set set) {\n-                set.forEach(Unchecked.consumer(handler -> {\n-                    ((DisposableBean) handler).destroy();\n-                }));\n+                set.forEach(Unchecked.consumer(handler ->\n+                    ((DisposableBean) handler).destroy()\n+                ));\n             }\n         };\n-        bean.setSourceSet(new HashSet());\n+        bean.setSourceSet(new HashSet<>());\n         return bean;\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDMzMzg3OA==", "url": "https://github.com/apereo/cas/pull/4844#discussion_r424333878", "bodyText": "Also should be qualified.", "author": "mmoayyed", "createdAt": "2020-05-13T10:25:47Z", "path": "support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapAuthenticationConfiguration.java", "diffHunk": "@@ -155,8 +160,24 @@ public PrincipalFactory ldapPrincipalFactory() {\n     }\n \n     @Bean\n+    public SetFactoryBean ldapAuthenticationHandlerSetFactoryBean() {\n+        val bean = new SetFactoryBean() {\n+            @Override\n+            protected void destroyInstance(final Set set) {\n+                set.forEach(Unchecked.consumer(handler -> {\n+                    ((DisposableBean) handler).destroy();\n+                }));\n+            }\n+        };\n+        bean.setSourceSet(new HashSet());\n+        return bean;\n+    }\n+\n+    @Bean\n+    @SneakyThrows\n     @RefreshScope\n-    public Collection<AuthenticationHandler> ldapAuthenticationHandlers() {\n+    public Collection<AuthenticationHandler> ldapAuthenticationHandlers(\n+            final SetFactoryBean ldapAuthenticationHandlerSetFactoryBean) {\n         val handlers = new HashSet<AuthenticationHandler>();", "originalCommit": "7ec49ebe2ddd36d1079b8e117e1ccaef7693de7a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c37aba84b245ed116ed6810b1ddf620ed32191bb", "chunk": "diff --git a/support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapAuthenticationConfiguration.java b/support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapAuthenticationConfiguration.java\nindex 9616201be3..868a3cb931 100644\n--- a/support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapAuthenticationConfiguration.java\n+++ b/support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapAuthenticationConfiguration.java\n\n@@ -164,12 +164,12 @@ public class LdapAuthenticationConfiguration {\n         val bean = new SetFactoryBean() {\n             @Override\n             protected void destroyInstance(final Set set) {\n-                set.forEach(Unchecked.consumer(handler -> {\n-                    ((DisposableBean) handler).destroy();\n-                }));\n+                set.forEach(Unchecked.consumer(handler ->\n+                    ((DisposableBean) handler).destroy()\n+                ));\n             }\n         };\n-        bean.setSourceSet(new HashSet());\n+        bean.setSourceSet(new HashSet<>());\n         return bean;\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDMzNDAxNg==", "url": "https://github.com/apereo/cas/pull/4844#discussion_r424334016", "bodyText": "please move the qualifier to the parameter", "author": "mmoayyed", "createdAt": "2020-05-13T10:26:03Z", "path": "support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapAuthenticationConfiguration.java", "diffHunk": "@@ -251,9 +273,12 @@ public PrincipalFactory ldapPrincipalFactory() {\n \n     @ConditionalOnMissingBean(name = \"ldapAuthenticationEventExecutionPlanConfigurer\")\n     @Bean\n+    @Autowired\n+    @Qualifier(\"ldapAuthenticationHandlerSetFactoryBean\")\n     @RefreshScope\n-    public AuthenticationEventExecutionPlanConfigurer ldapAuthenticationEventExecutionPlanConfigurer() {\n-        return plan -> ldapAuthenticationHandlers().forEach(handler -> {\n+    public AuthenticationEventExecutionPlanConfigurer ldapAuthenticationEventExecutionPlanConfigurer(\n+            final SetFactoryBean ldapAuthenticationHandlerSetFactoryBean) {", "originalCommit": "7ec49ebe2ddd36d1079b8e117e1ccaef7693de7a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c37aba84b245ed116ed6810b1ddf620ed32191bb", "chunk": "diff --git a/support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapAuthenticationConfiguration.java b/support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapAuthenticationConfiguration.java\nindex 9616201be3..868a3cb931 100644\n--- a/support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapAuthenticationConfiguration.java\n+++ b/support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapAuthenticationConfiguration.java\n\n@@ -274,9 +275,9 @@ public class LdapAuthenticationConfiguration {\n     @ConditionalOnMissingBean(name = \"ldapAuthenticationEventExecutionPlanConfigurer\")\n     @Bean\n     @Autowired\n-    @Qualifier(\"ldapAuthenticationHandlerSetFactoryBean\")\n     @RefreshScope\n     public AuthenticationEventExecutionPlanConfigurer ldapAuthenticationEventExecutionPlanConfigurer(\n+            @Qualifier(\"ldapAuthenticationHandlerSetFactoryBean\")\n             final SetFactoryBean ldapAuthenticationHandlerSetFactoryBean) {\n         return plan -> ldapAuthenticationHandlers(ldapAuthenticationHandlerSetFactoryBean).forEach(handler -> {\n             LOGGER.info(\"Registering LDAP authentication for [{}]\", handler.getName());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDMzNDEwNw==", "url": "https://github.com/apereo/cas/pull/4844#discussion_r424334107", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    bean.setSourceList(new ArrayList());\n          \n          \n            \n                    bean.setSourceList(new ArrayList<>());", "author": "mmoayyed", "createdAt": "2020-05-13T10:26:14Z", "path": "support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapPasswordSynchronizationConfiguration.java", "diffHunk": "@@ -24,15 +32,38 @@\n     @Autowired\n     private CasConfigurationProperties casProperties;\n \n+    @Bean\n+    @SneakyThrows\n+    public ListFactoryBean ldapPasswordSynchronizationAuthenticationPostProcessorListFactoryBean() {\n+        val bean = new ListFactoryBean() {\n+            @Override\n+            protected void destroyInstance(final List list) {\n+                list.forEach(Unchecked.consumer(postProcessor -> {\n+                    ((DisposableBean) postProcessor).destroy();\n+                }));\n+            }\n+        };\n+        bean.setSourceList(new ArrayList());", "originalCommit": "7ec49ebe2ddd36d1079b8e117e1ccaef7693de7a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c37aba84b245ed116ed6810b1ddf620ed32191bb", "chunk": "diff --git a/support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapPasswordSynchronizationConfiguration.java b/support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapPasswordSynchronizationConfiguration.java\nindex 78ec25d375..3ebebd9f72 100644\n--- a/support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapPasswordSynchronizationConfiguration.java\n+++ b/support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapPasswordSynchronizationConfiguration.java\n\n@@ -38,12 +38,12 @@ public class LdapPasswordSynchronizationConfiguration {\n         val bean = new ListFactoryBean() {\n             @Override\n             protected void destroyInstance(final List list) {\n-                list.forEach(Unchecked.consumer(postProcessor -> {\n-                    ((DisposableBean) postProcessor).destroy();\n-                }));\n+                list.forEach(Unchecked.consumer(postProcessor ->\n+                    ((DisposableBean) postProcessor).destroy()\n+                ));\n             }\n         };\n-        bean.setSourceList(new ArrayList());\n+        bean.setSourceList(new ArrayList<>());\n         return bean;\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDMzNDI2MA==", "url": "https://github.com/apereo/cas/pull/4844#discussion_r424334260", "bodyText": "Move qualifier to parameter.", "author": "mmoayyed", "createdAt": "2020-05-13T10:26:30Z", "path": "support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapPasswordSynchronizationConfiguration.java", "diffHunk": "@@ -24,15 +32,38 @@\n     @Autowired\n     private CasConfigurationProperties casProperties;\n \n+    @Bean\n+    @SneakyThrows\n+    public ListFactoryBean ldapPasswordSynchronizationAuthenticationPostProcessorListFactoryBean() {\n+        val bean = new ListFactoryBean() {\n+            @Override\n+            protected void destroyInstance(final List list) {\n+                list.forEach(Unchecked.consumer(postProcessor -> {\n+                    ((DisposableBean) postProcessor).destroy();\n+                }));\n+            }\n+        };\n+        bean.setSourceList(new ArrayList());\n+        return bean;\n+    }\n+\n     @ConditionalOnMissingBean(name = \"ldapPasswordSynchronizationAuthenticationEventExecutionPlanConfigurer\")\n     @Bean\n-    public AuthenticationEventExecutionPlanConfigurer ldapPasswordSynchronizationAuthenticationEventExecutionPlanConfigurer() {\n+    @SneakyThrows\n+    @Autowired\n+    @Qualifier(\"ldapPasswordSynchronizationAuthenticationPostProcessorListFactoryBean\")\n+    public AuthenticationEventExecutionPlanConfigurer ldapPasswordSynchronizationAuthenticationEventExecutionPlanConfigurer(\n+            final ListFactoryBean ldapPasswordSynchronizationAuthenticationPostProcessorListFactoryBean) {\n+        val postProcessorList = ldapPasswordSynchronizationAuthenticationPostProcessorListFactoryBean.getObject();", "originalCommit": "7ec49ebe2ddd36d1079b8e117e1ccaef7693de7a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c37aba84b245ed116ed6810b1ddf620ed32191bb", "chunk": "diff --git a/support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapPasswordSynchronizationConfiguration.java b/support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapPasswordSynchronizationConfiguration.java\nindex 78ec25d375..3ebebd9f72 100644\n--- a/support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapPasswordSynchronizationConfiguration.java\n+++ b/support/cas-server-support-ldap/src/main/java/org/apereo/cas/config/LdapPasswordSynchronizationConfiguration.java\n\n@@ -38,12 +38,12 @@ public class LdapPasswordSynchronizationConfiguration {\n         val bean = new ListFactoryBean() {\n             @Override\n             protected void destroyInstance(final List list) {\n-                list.forEach(Unchecked.consumer(postProcessor -> {\n-                    ((DisposableBean) postProcessor).destroy();\n-                }));\n+                list.forEach(Unchecked.consumer(postProcessor ->\n+                    ((DisposableBean) postProcessor).destroy()\n+                ));\n             }\n         };\n-        bean.setSourceList(new ArrayList());\n+        bean.setSourceList(new ArrayList<>());\n         return bean;\n     }\n \n"}}, {"oid": "c37aba84b245ed116ed6810b1ddf620ed32191bb", "url": "https://github.com/apereo/cas/commit/c37aba84b245ed116ed6810b1ddf620ed32191bb", "message": "misc code fixes", "committedDate": "2020-05-13T11:44:23Z", "type": "commit"}]}