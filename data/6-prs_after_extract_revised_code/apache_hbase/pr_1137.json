{"pr_number": 1137, "pr_title": "HBASE-23804: Fix default master addr hostname in master registry", "pr_createdAt": "2020-02-06T02:18:42Z", "pr_url": "https://github.com/apache/hbase/pull/1137", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTYxNzEwMw==", "url": "https://github.com/apache/hbase/pull/1137#discussion_r375617103", "bodyText": "Unused import?", "author": "ndimiduk", "createdAt": "2020-02-06T02:50:25Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/HMaster.java", "diffHunk": "@@ -20,6 +20,7 @@\n import static org.apache.hadoop.hbase.HConstants.DEFAULT_HBASE_SPLIT_COORDINATED_BY_ZK;\n import static org.apache.hadoop.hbase.HConstants.HBASE_MASTER_LOGCLEANER_PLUGINS;\n import static org.apache.hadoop.hbase.HConstants.HBASE_SPLIT_WAL_COORDINATED_BY_ZK;\n+import static org.apache.hadoop.hbase.HConstants.MASTER_HOSTNAME_KEY;", "originalCommit": "decf924469e85bedbb1388c2a3b618f2783d8616", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTg3MzUwNQ==", "url": "https://github.com/apache/hbase/pull/1137#discussion_r375873505", "bodyText": "Fixed.", "author": "bharathv", "createdAt": "2020-02-06T14:43:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTYxNzEwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjEwODg1Mg==", "url": "https://github.com/apache/hbase/pull/1137#discussion_r376108852", "bodyText": "Actually it is needed here, I moved it to HConstants, so have to explicitly import now.", "author": "bharathv", "createdAt": "2020-02-06T22:06:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTYxNzEwMw=="}], "type": "inlineReview", "revised_code": {"commit": "57b01e08d6e066616314dff37ff0db4a846a803e", "chunk": "diff --git a/hbase-server/src/main/java/org/apache/hadoop/hbase/master/HMaster.java b/hbase-server/src/main/java/org/apache/hadoop/hbase/master/HMaster.java\nindex 9f95e1a90f..76bd0a288a 100644\n--- a/hbase-server/src/main/java/org/apache/hadoop/hbase/master/HMaster.java\n+++ b/hbase-server/src/main/java/org/apache/hadoop/hbase/master/HMaster.java\n\n@@ -20,7 +20,7 @@ package org.apache.hadoop.hbase.master;\n import static org.apache.hadoop.hbase.HConstants.DEFAULT_HBASE_SPLIT_COORDINATED_BY_ZK;\n import static org.apache.hadoop.hbase.HConstants.HBASE_MASTER_LOGCLEANER_PLUGINS;\n import static org.apache.hadoop.hbase.HConstants.HBASE_SPLIT_WAL_COORDINATED_BY_ZK;\n-import static org.apache.hadoop.hbase.HConstants.MASTER_HOSTNAME_KEY;\n+import static org.apache.hadoop.hbase.util.DNS.MASTER_HOSTNAME_KEY;\n import com.google.protobuf.Descriptors;\n import com.google.protobuf.Service;\n import java.io.IOException;\n"}}, {"oid": "c221ce391a072a1f6c37b19a435ae945ce44c72f", "url": "https://github.com/apache/hbase/commit/c221ce391a072a1f6c37b19a435ae945ce44c72f", "message": "Revert \"HBASE-23779 Up the default fork count; make count relative to CPU count (#1108)\"\n\nThis reverts commit b49ec5807349ab566675063b8280611aea2dd681.", "committedDate": "2020-02-06T14:54:38Z", "type": "forcePushed"}, {"oid": "c98f426993e4303774ecdc166177fe598139a348", "url": "https://github.com/apache/hbase/commit/c98f426993e4303774ecdc166177fe598139a348", "message": "HBASE-23804: Fix default master addr hostname in master registry\n\nMaster rpc server end point doesn't bind to localhost's\nIP address by default. Instead, it looks up the hostname and\nbinds to the endpoint to which it resolves. MasterRegistry should\ndo the same when building the default server end point to talk to.", "committedDate": "2020-02-06T22:25:23Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjYyNDM2MQ==", "url": "https://github.com/apache/hbase/pull/1137#discussion_r376624361", "bodyText": "Since this is now in a more public space, and since we have more service types than just \"master\" and \"regionserver\", perhaps the boolean isMaster should become String serviceName.", "author": "ndimiduk", "createdAt": "2020-02-07T21:51:03Z", "path": "hbase-common/src/main/java/org/apache/hadoop/hbase/util/DNS.java", "diffHunk": "@@ -66,4 +68,24 @@ public static String getDefaultHost(String strInterface, String nameserver)\n       return org.apache.hadoop.net.DNS.getDefaultHost(strInterface, nameserver);\n     }\n   }\n+\n+  /**\n+   * Get the configured hostname for master/regionserver. Gets the default hostname if not specified\n+   * in the configuration.\n+   * @param conf Configuration to look up.\n+   * @param isMaster True if master hostname needs to be looked up and false for regionserver.\n+   */\n+  public static String getHostname(Configuration conf, boolean isMaster)", "originalCommit": "c98f426993e4303774ecdc166177fe598139a348", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc0MTk5OA==", "url": "https://github.com/apache/hbase/pull/1137#discussion_r376741998", "bodyText": "Done.", "author": "bharathv", "createdAt": "2020-02-08T23:47:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjYyNDM2MQ=="}], "type": "inlineReview", "revised_code": {"commit": "57b01e08d6e066616314dff37ff0db4a846a803e", "chunk": "diff --git a/hbase-common/src/main/java/org/apache/hadoop/hbase/util/DNS.java b/hbase-common/src/main/java/org/apache/hadoop/hbase/util/DNS.java\nindex 7520ce6555..2b4e1cbf02 100644\n--- a/hbase-common/src/main/java/org/apache/hadoop/hbase/util/DNS.java\n+++ b/hbase-common/src/main/java/org/apache/hadoop/hbase/util/DNS.java\n\n@@ -70,20 +93,28 @@ public final class DNS {\n   }\n \n   /**\n-   * Get the configured hostname for master/regionserver. Gets the default hostname if not specified\n+   * Get the configured hostname for a given ServerType. Gets the default hostname if not specified\n    * in the configuration.\n    * @param conf Configuration to look up.\n-   * @param isMaster True if master hostname needs to be looked up and false for regionserver.\n+   * @param serverType ServerType to look up in the configuration for overrides.\n    */\n-  public static String getHostname(Configuration conf, boolean isMaster)\n+  public static String getHostname(@NonNull Configuration conf, @NonNull ServerType serverType)\n       throws UnknownHostException {\n-    String hostname = conf.get(isMaster? HConstants.MASTER_HOSTNAME_KEY :\n-        HConstants.RS_HOSTNAME_KEY);\n+    String hostname;\n+    switch (serverType) {\n+      case MASTER:\n+        hostname = conf.get(MASTER_HOSTNAME_KEY);\n+        break;\n+      case REGIONSERVER:\n+        hostname = conf.get(RS_HOSTNAME_KEY);\n+        break;\n+      default:\n+        hostname = null;\n+    }\n     if (hostname == null || hostname.isEmpty()) {\n-      String masterOrRS = isMaster ? \"master\" : \"regionserver\";\n       return Strings.domainNamePointerToHostName(getDefaultHost(\n-          conf.get(\"hbase.\" + masterOrRS + \".dns.interface\", \"default\"),\n-          conf.get(\"hbase.\" + masterOrRS + \".dns.nameserver\", \"default\")));\n+          conf.get(\"hbase.\" + serverType.getName() + \".dns.interface\", \"default\"),\n+          conf.get(\"hbase.\" + serverType.getName() + \".dns.nameserver\", \"default\")));\n     } else {\n       return hostname;\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjYyNjgyNg==", "url": "https://github.com/apache/hbase/pull/1137#discussion_r376626826", "bodyText": "This method has a number of commits sprinkled into its recent history: HBASE-12954, HBASE-12956, HBASE-13481. They appear related to property binding to 0.0.0.0 and to a configuration with multiple IP's on a network interface. How do we test changes in this part of our code?", "author": "ndimiduk", "createdAt": "2020-02-07T21:57:41Z", "path": "hbase-common/src/main/java/org/apache/hadoop/hbase/util/DNS.java", "diffHunk": "@@ -66,4 +68,24 @@ public static String getDefaultHost(String strInterface, String nameserver)\n       return org.apache.hadoop.net.DNS.getDefaultHost(strInterface, nameserver);\n     }\n   }\n+\n+  /**\n+   * Get the configured hostname for master/regionserver. Gets the default hostname if not specified\n+   * in the configuration.\n+   * @param conf Configuration to look up.\n+   * @param isMaster True if master hostname needs to be looked up and false for regionserver.\n+   */\n+  public static String getHostname(Configuration conf, boolean isMaster)", "originalCommit": "c98f426993e4303774ecdc166177fe598139a348", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc0MjUwNQ==", "url": "https://github.com/apache/hbase/pull/1137#discussion_r376742505", "bodyText": "Think those patches have reasonable test coverage and I verified they pass for me locally. If we break something about binding to wildcard address, we should know it from the nightly failures I think (ex: testMiniClusterBindToWildcard).. (Not sure if I answered your question, did I get the question right?)", "author": "bharathv", "createdAt": "2020-02-09T00:00:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjYyNjgyNg=="}], "type": "inlineReview", "revised_code": {"commit": "57b01e08d6e066616314dff37ff0db4a846a803e", "chunk": "diff --git a/hbase-common/src/main/java/org/apache/hadoop/hbase/util/DNS.java b/hbase-common/src/main/java/org/apache/hadoop/hbase/util/DNS.java\nindex 7520ce6555..2b4e1cbf02 100644\n--- a/hbase-common/src/main/java/org/apache/hadoop/hbase/util/DNS.java\n+++ b/hbase-common/src/main/java/org/apache/hadoop/hbase/util/DNS.java\n\n@@ -70,20 +93,28 @@ public final class DNS {\n   }\n \n   /**\n-   * Get the configured hostname for master/regionserver. Gets the default hostname if not specified\n+   * Get the configured hostname for a given ServerType. Gets the default hostname if not specified\n    * in the configuration.\n    * @param conf Configuration to look up.\n-   * @param isMaster True if master hostname needs to be looked up and false for regionserver.\n+   * @param serverType ServerType to look up in the configuration for overrides.\n    */\n-  public static String getHostname(Configuration conf, boolean isMaster)\n+  public static String getHostname(@NonNull Configuration conf, @NonNull ServerType serverType)\n       throws UnknownHostException {\n-    String hostname = conf.get(isMaster? HConstants.MASTER_HOSTNAME_KEY :\n-        HConstants.RS_HOSTNAME_KEY);\n+    String hostname;\n+    switch (serverType) {\n+      case MASTER:\n+        hostname = conf.get(MASTER_HOSTNAME_KEY);\n+        break;\n+      case REGIONSERVER:\n+        hostname = conf.get(RS_HOSTNAME_KEY);\n+        break;\n+      default:\n+        hostname = null;\n+    }\n     if (hostname == null || hostname.isEmpty()) {\n-      String masterOrRS = isMaster ? \"master\" : \"regionserver\";\n       return Strings.domainNamePointerToHostName(getDefaultHost(\n-          conf.get(\"hbase.\" + masterOrRS + \".dns.interface\", \"default\"),\n-          conf.get(\"hbase.\" + masterOrRS + \".dns.nameserver\", \"default\")));\n+          conf.get(\"hbase.\" + serverType.getName() + \".dns.interface\", \"default\"),\n+          conf.get(\"hbase.\" + serverType.getName() + \".dns.nameserver\", \"default\")));\n     } else {\n       return hostname;\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjYyODkwNA==", "url": "https://github.com/apache/hbase/pull/1137#discussion_r376628904", "bodyText": "Head's up, this file is InterfaceAudience.Public, which means removals have to go through a full release deprecation cycle.\nFrom the sub-section titled \"Client API compatibility\" in the book:\n\nAn API needs to be deprecated for a whole major version before we will change/remove it.\n\nAn example: An API was deprecated in 2.0.1 and will be marked for deletion in 4.0.0. On the other hand, an API deprecated in 2.0.0 can be removed in 3.0.0.\n\n\nYou'll need to retain the hold field -- annotate it as deprecated and add a java doc explaining that the other method could be used in its place. You can file a follow-on ticket with a fixVersion of 4.0.0 as a task to delete the field once we get there (and maybe leave a TODO referencing that ticket).\nSadly this constant is a field not a method, which means we have no way to logging a WARN for clients who make use of it.", "author": "ndimiduk", "createdAt": "2020-02-07T22:03:41Z", "path": "hbase-common/src/main/java/org/apache/hadoop/hbase/HConstants.java", "diffHunk": "@@ -181,7 +181,11 @@\n   /** Configuration key for the list of master host:ports **/\n   public static final String MASTER_ADDRS_KEY = \"hbase.masters\";\n \n-  public static final String MASTER_ADDRS_DEFAULT =  \"localhost:\" + DEFAULT_MASTER_PORT;", "originalCommit": "c98f426993e4303774ecdc166177fe598139a348", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjY2OTIwMw==", "url": "https://github.com/apache/hbase/pull/1137#discussion_r376669203", "bodyText": "This was added by me in the feature branch. Technically this is not public yet. But I got what you are saying about client compatibility.", "author": "bharathv", "createdAt": "2020-02-08T00:44:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjYyODkwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM0MDY1Mg==", "url": "https://github.com/apache/hbase/pull/1137#discussion_r377340652", "bodyText": "Ah okay. Let's avoid adding any fields to HConstants on the feature branch if we can.", "author": "ndimiduk", "createdAt": "2020-02-10T21:57:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjYyODkwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM1NjYzNA==", "url": "https://github.com/apache/hbase/pull/1137#discussion_r377356634", "bodyText": "Ack.", "author": "bharathv", "createdAt": "2020-02-10T22:31:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjYyODkwNA=="}], "type": "inlineReview", "revised_code": {"commit": "57b01e08d6e066616314dff37ff0db4a846a803e", "chunk": "diff --git a/hbase-common/src/main/java/org/apache/hadoop/hbase/HConstants.java b/hbase-common/src/main/java/org/apache/hadoop/hbase/HConstants.java\nindex 27b8c3f36c..313fa6bc21 100644\n--- a/hbase-common/src/main/java/org/apache/hadoop/hbase/HConstants.java\n+++ b/hbase-common/src/main/java/org/apache/hadoop/hbase/HConstants.java\n\n@@ -181,12 +181,6 @@ public final class HConstants {\n   /** Configuration key for the list of master host:ports **/\n   public static final String MASTER_ADDRS_KEY = \"hbase.masters\";\n \n-  // key to the config parameter of server hostname\n-  // the specification of server hostname is optional. The hostname should be resolvable from\n-  // both master and region server\n-  public static final String RS_HOSTNAME_KEY = \"hbase.regionserver.hostname\";\n-  public static final String MASTER_HOSTNAME_KEY = \"hbase.master.hostname\";\n-\n   /** Full class name of the Zookeeper based connection registry implementation */\n   public static final String ZK_CONNECTION_REGISTRY_CLASS =\n       \"org.apache.hadoop.hbase.client.ZKConnectionRegistry\";\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjYzMTY0OQ==", "url": "https://github.com/apache/hbase/pull/1137#discussion_r376631649", "bodyText": "Don't add these here. In the book, they're considered \"expert\" configuration params (and the master version appears to not be documented at all).\nInstead, add them to the DNS class, from which they'll be used. Also, it's InterfaceAudience.Private so we have more maintenance/refactoring flexibility there. And don't lose their InterfaceAudience.LimitedPrivate annotations when you move them.", "author": "ndimiduk", "createdAt": "2020-02-07T22:11:52Z", "path": "hbase-common/src/main/java/org/apache/hadoop/hbase/HConstants.java", "diffHunk": "@@ -181,7 +181,11 @@\n   /** Configuration key for the list of master host:ports **/\n   public static final String MASTER_ADDRS_KEY = \"hbase.masters\";\n \n-  public static final String MASTER_ADDRS_DEFAULT =  \"localhost:\" + DEFAULT_MASTER_PORT;\n+  // key to the config parameter of server hostname\n+  // the specification of server hostname is optional. The hostname should be resolvable from\n+  // both master and region server\n+  public static final String RS_HOSTNAME_KEY = \"hbase.regionserver.hostname\";", "originalCommit": "c98f426993e4303774ecdc166177fe598139a348", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjY2OTUxOA==", "url": "https://github.com/apache/hbase/pull/1137#discussion_r376669518", "bodyText": "Gotcha, done.", "author": "bharathv", "createdAt": "2020-02-08T00:46:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjYzMTY0OQ=="}], "type": "inlineReview", "revised_code": {"commit": "57b01e08d6e066616314dff37ff0db4a846a803e", "chunk": "diff --git a/hbase-common/src/main/java/org/apache/hadoop/hbase/HConstants.java b/hbase-common/src/main/java/org/apache/hadoop/hbase/HConstants.java\nindex 27b8c3f36c..313fa6bc21 100644\n--- a/hbase-common/src/main/java/org/apache/hadoop/hbase/HConstants.java\n+++ b/hbase-common/src/main/java/org/apache/hadoop/hbase/HConstants.java\n\n@@ -181,12 +181,6 @@ public final class HConstants {\n   /** Configuration key for the list of master host:ports **/\n   public static final String MASTER_ADDRS_KEY = \"hbase.masters\";\n \n-  // key to the config parameter of server hostname\n-  // the specification of server hostname is optional. The hostname should be resolvable from\n-  // both master and region server\n-  public static final String RS_HOSTNAME_KEY = \"hbase.regionserver.hostname\";\n-  public static final String MASTER_HOSTNAME_KEY = \"hbase.master.hostname\";\n-\n   /** Full class name of the Zookeeper based connection registry implementation */\n   public static final String ZK_CONNECTION_REGISTRY_CLASS =\n       \"org.apache.hadoop.hbase.client.ZKConnectionRegistry\";\n"}}, {"oid": "57b01e08d6e066616314dff37ff0db4a846a803e", "url": "https://github.com/apache/hbase/commit/57b01e08d6e066616314dff37ff0db4a846a803e", "message": "HBASE-23804: Fix default master addr hostname in master registry\n\nMaster rpc server end point doesn't bind to localhost's\nIP address by default. Instead, it looks up the hostname and\nbinds to the endpoint to which it resolves. MasterRegistry should\ndo the same when building the default server end point to talk to.", "committedDate": "2020-02-09T01:02:18Z", "type": "forcePushed"}, {"oid": "e32a4ec5854fcd70750c406475f19f09539d7b94", "url": "https://github.com/apache/hbase/commit/e32a4ec5854fcd70750c406475f19f09539d7b94", "message": "HBASE-23804: Fix default master addr hostname in master registry\n\nMaster rpc server end point doesn't bind to localhost's\nIP address by default. Instead, it looks up the hostname and\nbinds to the endpoint to which it resolves. MasterRegistry should\ndo the same when building the default server end point to talk to.", "committedDate": "2020-02-09T01:29:16Z", "type": "commit"}, {"oid": "e32a4ec5854fcd70750c406475f19f09539d7b94", "url": "https://github.com/apache/hbase/commit/e32a4ec5854fcd70750c406475f19f09539d7b94", "message": "HBASE-23804: Fix default master addr hostname in master registry\n\nMaster rpc server end point doesn't bind to localhost's\nIP address by default. Instead, it looks up the hostname and\nbinds to the endpoint to which it resolves. MasterRegistry should\ndo the same when building the default server end point to talk to.", "committedDate": "2020-02-09T01:29:16Z", "type": "forcePushed"}]}