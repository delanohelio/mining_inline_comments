{"pr_number": 1012, "pr_title": "HBASE-21065 Try ROW_INDEX_V1 encoding on meta table (fix bloomfilters\u2026", "pr_createdAt": "2020-01-09T21:53:05Z", "pr_url": "https://github.com/apache/hbase/pull/1012", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTA1NjEyMA==", "url": "https://github.com/apache/hbase/pull/1012#discussion_r365056120", "bodyText": "Do we need the ROW_INDEX_V1 encoding on all CFs?", "author": "anoopsjohn", "createdAt": "2020-01-10T03:07:07Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/util/FSTableDescriptors.java", "diffHunk": "@@ -158,25 +158,22 @@ public static TableDescriptorBuilder createMetaTableDescriptorBuilder(final Conf\n         .setBlocksize(conf.getInt(HConstants.HBASE_META_BLOCK_SIZE,\n                 HConstants.DEFAULT_HBASE_META_BLOCK_SIZE))\n         .setScope(HConstants.REPLICATION_SCOPE_LOCAL)\n-        // Disable blooms for meta.  Needs work.  Seems to mess w/ getClosestOrBefore.\n-        .setBloomFilterType(BloomType.NONE)\n+        .setDataBlockEncoding(org.apache.hadoop.hbase.io.encoding.DataBlockEncoding.ROW_INDEX_V1)\n         .build())\n       .setColumnFamily(ColumnFamilyDescriptorBuilder.newBuilder(HConstants.TABLE_FAMILY)\n         .setMaxVersions(conf.getInt(HConstants.HBASE_META_VERSIONS,\n             HConstants.DEFAULT_HBASE_META_VERSIONS))\n         .setInMemory(true)\n         .setBlocksize(8 * 1024)\n         .setScope(HConstants.REPLICATION_SCOPE_LOCAL)\n-        // Disable blooms for meta.  Needs work.  Seems to mess w/ getClosestOrBefore.\n-        .setBloomFilterType(BloomType.NONE)\n+        .setDataBlockEncoding(org.apache.hadoop.hbase.io.encoding.DataBlockEncoding.ROW_INDEX_V1)", "originalCommit": "228b6d2364a4183922fc5d9218a7db6bb9c374c5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTEwMjg1OA==", "url": "https://github.com/apache/hbase/pull/1012#discussion_r365102858", "bodyText": "Dunno. Figured they all mostly random lookups so thought they'd all benefit.", "author": "saintstack", "createdAt": "2020-01-10T07:32:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTA1NjEyMA=="}], "type": "inlineReview", "revised_code": {"commit": "9e2d1f33f7e0494f9754d6cc80d52e5b30942829", "chunk": "diff --git a/hbase-server/src/main/java/org/apache/hadoop/hbase/util/FSTableDescriptors.java b/hbase-server/src/main/java/org/apache/hadoop/hbase/util/FSTableDescriptors.java\nindex 2659db15c9..1f22424fed 100644\n--- a/hbase-server/src/main/java/org/apache/hadoop/hbase/util/FSTableDescriptors.java\n+++ b/hbase-server/src/main/java/org/apache/hadoop/hbase/util/FSTableDescriptors.java\n\n@@ -158,7 +175,7 @@ public class FSTableDescriptors implements TableDescriptors {\n         .setBlocksize(conf.getInt(HConstants.HBASE_META_BLOCK_SIZE,\n                 HConstants.DEFAULT_HBASE_META_BLOCK_SIZE))\n         .setScope(HConstants.REPLICATION_SCOPE_LOCAL)\n-        .setDataBlockEncoding(org.apache.hadoop.hbase.io.encoding.DataBlockEncoding.ROW_INDEX_V1)\n+        .setBloomFilterType(BloomType.ROWCOL)\n         .build())\n       .setColumnFamily(ColumnFamilyDescriptorBuilder.newBuilder(HConstants.TABLE_FAMILY)\n         .setMaxVersions(conf.getInt(HConstants.HBASE_META_VERSIONS,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTA1NjMwMA==", "url": "https://github.com/apache/hbase/pull/1012#discussion_r365056300", "bodyText": "So we use ROW bloom which is the default. The above comment is no longer applies (or its equivalent API usage)", "author": "anoopsjohn", "createdAt": "2020-01-10T03:08:11Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/util/FSTableDescriptors.java", "diffHunk": "@@ -158,25 +158,22 @@ public static TableDescriptorBuilder createMetaTableDescriptorBuilder(final Conf\n         .setBlocksize(conf.getInt(HConstants.HBASE_META_BLOCK_SIZE,\n                 HConstants.DEFAULT_HBASE_META_BLOCK_SIZE))\n         .setScope(HConstants.REPLICATION_SCOPE_LOCAL)\n-        // Disable blooms for meta.  Needs work.  Seems to mess w/ getClosestOrBefore.\n-        .setBloomFilterType(BloomType.NONE)", "originalCommit": "228b6d2364a4183922fc5d9218a7db6bb9c374c5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTEwMzU4Mw==", "url": "https://github.com/apache/hbase/pull/1012#discussion_r365103583", "bodyText": "Do you mean this comment?\n     // Disable blooms for meta.  Needs work.  Seems to mess w/ getClosestOrBefore.", "author": "saintstack", "createdAt": "2020-01-10T07:35:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTA1NjMwMA=="}], "type": "inlineReview", "revised_code": {"commit": "9e2d1f33f7e0494f9754d6cc80d52e5b30942829", "chunk": "diff --git a/hbase-server/src/main/java/org/apache/hadoop/hbase/util/FSTableDescriptors.java b/hbase-server/src/main/java/org/apache/hadoop/hbase/util/FSTableDescriptors.java\nindex 2659db15c9..1f22424fed 100644\n--- a/hbase-server/src/main/java/org/apache/hadoop/hbase/util/FSTableDescriptors.java\n+++ b/hbase-server/src/main/java/org/apache/hadoop/hbase/util/FSTableDescriptors.java\n\n@@ -158,7 +175,7 @@ public class FSTableDescriptors implements TableDescriptors {\n         .setBlocksize(conf.getInt(HConstants.HBASE_META_BLOCK_SIZE,\n                 HConstants.DEFAULT_HBASE_META_BLOCK_SIZE))\n         .setScope(HConstants.REPLICATION_SCOPE_LOCAL)\n-        .setDataBlockEncoding(org.apache.hadoop.hbase.io.encoding.DataBlockEncoding.ROW_INDEX_V1)\n+        .setBloomFilterType(BloomType.ROWCOL)\n         .build())\n       .setColumnFamily(ColumnFamilyDescriptorBuilder.newBuilder(HConstants.TABLE_FAMILY)\n         .setMaxVersions(conf.getInt(HConstants.HBASE_META_VERSIONS,\n"}}, {"oid": "9e2d1f33f7e0494f9754d6cc80d52e5b30942829", "url": "https://github.com/apache/hbase/commit/9e2d1f33f7e0494f9754d6cc80d52e5b30942829", "message": "HBASE-21065 Try ROW_INDEX_V1 encoding on meta table (fix bloomfilters on meta while we are at it)", "committedDate": "2020-01-10T18:17:24Z", "type": "forcePushed"}, {"oid": "591985981cb3b4365ebf107635461fbf81d01f4e", "url": "https://github.com/apache/hbase/commit/591985981cb3b4365ebf107635461fbf81d01f4e", "message": "HBASE-21065 Try ROW_INDEX_V1 encoding on meta table (fix bloomfilters on meta while we are at it)", "committedDate": "2020-01-10T23:54:02Z", "type": "forcePushed"}, {"oid": "07330e7cd8b037d57cf83a528fb5f977fbd016a3", "url": "https://github.com/apache/hbase/commit/07330e7cd8b037d57cf83a528fb5f977fbd016a3", "message": "HBASE-21065 Try ROW_INDEX_V1 encoding on meta table (fix bloomfilters on meta while we are at it)\n\nEncoded don't have CellComparator to use.  Backfill the comparator.\nIdeally it'd be passed in FileContext or in FileInfo or in the encoding\ncontext, etc., but it isn't. For now, will pick up comparator using\ntablename which is in local context.\n\nM hbase-common/src/main/java/org/apache/hadoop/hbase/CellComparator.java\n Adds a new compareRows with default implementation that takes a ByteBuffer.\n\nM hbase-common/src/main/java/org/apache/hadoop/hbase/CellComparatorImpl.java\n Adds  implementation for meta of new compareRows method. Adds utility\n method for figuring comparator based off tablename.\n\nM hbase-common/src/main/java/org/apache/hadoop/hbase/io/encoding/AbstractDataBlockEncoder.java\n Allow that comparator passed may be null when caller doesn't know what\n to use. Figure out what to use if it is null and cache it for use.\n\nM hbase-common/src/main/java/org/apache/hadoop/hbase/io/encoding/HFileBlockDecodingContext.java\n Add getCellComparator\n\nM hbase-common/src/main/java/org/apache/hadoop/hbase/io/encoding/HFileBlockDefaultDecodingContext.java\nM hbase-common/src/main/java/org/apache/hadoop/hbase/io/encoding/HFileBlockDefaultEncodingContext.java\n Cache comparator.\n\nM hbase-common/src/main/java/org/apache/hadoop/hbase/io/encoding/RowIndexEncoderV1.java\nM hbase-common/src/main/java/org/apache/hadoop/hbase/io/encoding/RowIndexSeekerV1.java\n Use comparator from context rather than do own row compare.\n\nM hbase-server/src/main/java/org/apache/hadoop/hbase/util/FSTableDescriptors.java\n Hide initila creation of meta schema", "committedDate": "2020-01-17T08:01:17Z", "type": "forcePushed"}, {"oid": "09302ae285bdaca2e5d579ea23ad8c0639feab71", "url": "https://github.com/apache/hbase/commit/09302ae285bdaca2e5d579ea23ad8c0639feab71", "message": "HBASE-21065 Try ROW_INDEX_V1 encoding on meta table (fix bloomfilters\u2026\n\nSet encoding and blooms on meta as default. Also shutdown access to the\ninitial meta schema creating method; get from TableDescriptors if you\nneed access to schema or edit it as you would any other table if you\nwant to edit it.", "committedDate": "2020-01-17T21:53:51Z", "type": "forcePushed"}, {"oid": "c319eb8a8560a04472c85982fe4d17022811cab9", "url": "https://github.com/apache/hbase/commit/c319eb8a8560a04472c85982fe4d17022811cab9", "message": "HBASE-21065 Try ROW_INDEX_V1 encoding on meta table (fix bloomfilters\u2026\n\nSet encoding and blooms on meta as default. Also shutdown access to the\ninitial meta schema creating method; get from TableDescriptors if you\nneed access to schema or edit it as you would any other table if you\nwant to edit it.", "committedDate": "2020-01-18T06:02:49Z", "type": "forcePushed"}, {"oid": "0314b9e7135da5274fa0b721413a871e453321d6", "url": "https://github.com/apache/hbase/commit/0314b9e7135da5274fa0b721413a871e453321d6", "message": "HBASE-21065 Try ROW_INDEX_V1 encoding on meta table (fix bloomfilters\u2026\n\nSet encoding and blooms on meta as default. Also shutdown access to the\ninitial meta schema creating method; get from TableDescriptors if you\nneed access to schema or edit it as you would any other table if you\nwant to edit it.", "committedDate": "2020-01-18T15:18:41Z", "type": "forcePushed"}, {"oid": "0b2b69644c95528b15acf64ef9c6092e43a901e5", "url": "https://github.com/apache/hbase/commit/0b2b69644c95528b15acf64ef9c6092e43a901e5", "message": "HBASE-21065 Try ROW_INDEX_V1 encoding on meta table (fix bloomfilters\u2026\n\nSet encoding and blooms on meta as default. Also shutdown access to the\ninitial meta schema creating method; get from TableDescriptors if you\nneed access to schema or edit it as you would any other table if you\nwant to edit it.", "committedDate": "2020-01-23T04:53:24Z", "type": "commit"}, {"oid": "0b2b69644c95528b15acf64ef9c6092e43a901e5", "url": "https://github.com/apache/hbase/commit/0b2b69644c95528b15acf64ef9c6092e43a901e5", "message": "HBASE-21065 Try ROW_INDEX_V1 encoding on meta table (fix bloomfilters\u2026\n\nSet encoding and blooms on meta as default. Also shutdown access to the\ninitial meta schema creating method; get from TableDescriptors if you\nneed access to schema or edit it as you would any other table if you\nwant to edit it.", "committedDate": "2020-01-23T04:53:24Z", "type": "forcePushed"}]}