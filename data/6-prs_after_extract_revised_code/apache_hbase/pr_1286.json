{"pr_number": 1286, "pr_title": "HBASE-23977 : Resolve flakes present in TestSlowLogRecorder", "pr_createdAt": "2020-03-13T15:29:18Z", "pr_url": "https://github.com/apache/hbase/pull/1286", "timeline": [{"oid": "e0ecdae2d0416a53de084fadb5238f8fbb03ae17", "url": "https://github.com/apache/hbase/commit/e0ecdae2d0416a53de084fadb5238f8fbb03ae17", "message": "HBASE-23977 : Resolve flakes present in TestSlowLogRecorder", "committedDate": "2020-03-13T19:06:40Z", "type": "commit"}, {"oid": "e0ecdae2d0416a53de084fadb5238f8fbb03ae17", "url": "https://github.com/apache/hbase/commit/e0ecdae2d0416a53de084fadb5238f8fbb03ae17", "message": "HBASE-23977 : Resolve flakes present in TestSlowLogRecorder", "committedDate": "2020-03-13T19:06:40Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzM5MDU3Mw==", "url": "https://github.com/apache/hbase/pull/1286#discussion_r393390573", "bodyText": "nit: intermediate boolean values aren't necessary... just return foo && bar && baz.", "author": "ndimiduk", "createdAt": "2020-03-17T01:03:15Z", "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/slowlog/TestSlowLogRecorder.java", "diffHunk": "@@ -93,12 +91,14 @@ private static Configuration applySlowLogRecorderConf(int eventSize) {\n    * @param i index of ringbuffer logs\n    * @param j data value that was put on index i\n    * @param slowLogPayloads list of payload retrieved from {@link SlowLogRecorder}\n+   * @return if actual values are as per expectations\n    */\n-  private void confirmPayloadParams(int i, int j, List<SlowLogPayload> slowLogPayloads) {\n+  private boolean confirmPayloadParams(int i, int j, List<SlowLogPayload> slowLogPayloads) {\n \n-    Assert.assertEquals(slowLogPayloads.get(i).getClientAddress(), \"client_\" + j);\n-    Assert.assertEquals(slowLogPayloads.get(i).getUserName(), \"userName_\" + j);\n-    Assert.assertEquals(slowLogPayloads.get(i).getServerClass(), \"class_\" + j);\n+    boolean isClientExpected = slowLogPayloads.get(i).getClientAddress().equals(\"client_\" + j);", "originalCommit": "e0ecdae2d0416a53de084fadb5238f8fbb03ae17", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQ1ODQ0NQ==", "url": "https://github.com/apache/hbase/pull/1286#discussion_r393458445", "bodyText": "I agree but this is just for better readability. Should be fine to keep it this way?\nEspecially because statements are bit longer and hence these variables can help with better readability?", "author": "virajjasani", "createdAt": "2020-03-17T05:55:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzM5MDU3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTMyODU3MQ==", "url": "https://github.com/apache/hbase/pull/1286#discussion_r395328571", "bodyText": "It's a style consideration... not a strong concern. I find it easier to read if you did something like\nreturn doThingA()\n  && doThingB()\n  && doThingC();\nbecause in this case, there's no chance for any of them to be accidentally forgotten. Not as important here where there's only 3, but down below you do quite a few, so that's where I think it helps.", "author": "ndimiduk", "createdAt": "2020-03-19T21:25:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzM5MDU3Mw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzM5MTE1MA==", "url": "https://github.com/apache/hbase/pull/1286#discussion_r393391150", "bodyText": "I don't understand why these tests are executed within the timeout window. How does that make the tests more reliable?", "author": "ndimiduk", "createdAt": "2020-03-17T01:05:31Z", "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/slowlog/TestSlowLogRecorder.java", "diffHunk": "@@ -140,12 +141,16 @@ public void testOnlieSlowLogConsumption() throws Exception {\n     Assert.assertNotEquals(-1, HBASE_TESTING_UTILITY.waitFor(3000,\n       () -> slowLogRecorder.getSlowLogPayloads(request).size() == 7));\n \n-    slowLogPayloads = slowLogRecorder.getSlowLogPayloads(request);\n-\n-    Assert.assertEquals(slowLogPayloads.size(), 7);\n-    confirmPayloadParams(0, 7, slowLogPayloads);\n-    confirmPayloadParams(5, 2, slowLogPayloads);\n-    confirmPayloadParams(6, 1, slowLogPayloads);\n+    Assert.assertNotEquals(-1, HBASE_TESTING_UTILITY.waitFor(3000,\n+      () -> {\n+        List<SlowLogPayload> slowLogPayloadsList = slowLogRecorder.getSlowLogPayloads(request);\n+        Assert.assertEquals(slowLogPayloadsList.size(), 7);\n+        boolean b1 = confirmPayloadParams(0, 7, slowLogPayloadsList);", "originalCommit": "e0ecdae2d0416a53de084fadb5238f8fbb03ae17", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQ1OTYwMw==", "url": "https://github.com/apache/hbase/pull/1286#discussion_r393459603", "bodyText": "Since we are dealing with parallel processing and we are expecting consumer of ring buffer to get done with ordered events, but based on env, consumer might not be done by the time we expect ordered events present and hence we want to introduce time lag until we get that specific end result of expected ordered list of events in ring buffer. Sounds good @ndimiduk  ?", "author": "virajjasani", "createdAt": "2020-03-17T06:00:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzM5MTE1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDEyNjk5OQ==", "url": "https://github.com/apache/hbase/pull/1286#discussion_r394126999", "bodyText": "e.g if we send {1,2,3,4,5,6,7} to RingBuffer of size 8, then all of them are consumed in same order. Now if we send {8,9,10,11}, we expect final output from RingBuffer consumer to be {9,10,11,4,5,6,7,8}  (1,2,3 are overridden). However, the reason why we have flakes is because by the time we expect above output, consumer might not have consumed say 10 and 11 and hence actual output would be {9,2,3,4,5,6,7,8}. And hence the failures, so now with waitFor(), we wait until we get ordered output {9,10,11,4,5,6,7,8}, which is why we will wait for all of 8,9,10,11 to be consumed and put in the queue in correct order i.e. no flakes.", "author": "virajjasani", "createdAt": "2020-03-18T06:21:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzM5MTE1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTMzMDM5MQ==", "url": "https://github.com/apache/hbase/pull/1286#discussion_r395330391", "bodyText": "Oh, I see. So you're actually using waitFor as a retry mechanism. That's not how I imagined using it, but so long as those inner asserts don't interfere with the retry, I guess that's fine.\nWhat happens when the inner Assert.assertEquals(slowLogPayloadsList.size(), 7); throws? Does waitFor retry that, or does it simply fail? If the latter, the test is still flakey. I would loop until I have all the data and then perform the asserts at the end.", "author": "ndimiduk", "createdAt": "2020-03-19T21:29:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzM5MTE1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ1Mjg3MQ==", "url": "https://github.com/apache/hbase/pull/1286#discussion_r395452871", "bodyText": "oops, my bad, I missed Assert.assertEquals(slowLogPayloadsList.size(), 7);, this still makes it flakey as it fails. Let me take care of it in Addendum.\nThanks @ndimiduk", "author": "virajjasani", "createdAt": "2020-03-20T06:13:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzM5MTE1MA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzM5MTQzNQ==", "url": "https://github.com/apache/hbase/pull/1286#discussion_r393391435", "bodyText": "\ud83d\udc4d", "author": "ndimiduk", "createdAt": "2020-03-17T01:06:38Z", "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/slowlog/TestSlowLogRecorder.java", "diffHunk": "@@ -261,10 +287,12 @@ public void testOnlineSlowLogWithDefaultDisableConfig() throws Exception {\n       slowLogRecorder.addSlowLogPayload(rpcLogDetails);\n     }\n \n-    Uninterruptibles.sleepUninterruptibly(1, TimeUnit.SECONDS);", "originalCommit": "e0ecdae2d0416a53de084fadb5238f8fbb03ae17", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTMzMTEwMA==", "url": "https://github.com/apache/hbase/pull/1286#discussion_r395331100", "bodyText": "Yeah, so here's the example where all these intermediate variables make this hard to know it's correct on a quick glance. If it was a chain of return foo && bar && biz && ..., it's obvious that all components are considered.", "author": "ndimiduk", "createdAt": "2020-03-19T21:31:03Z", "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/slowlog/TestSlowLogRecorder.java", "diffHunk": "@@ -214,29 +234,35 @@ public void testOnlineSlowLogWithHighRecords() throws Exception {\n     Assert.assertNotEquals(-1, HBASE_TESTING_UTILITY.waitFor(3000,\n       () -> slowLogRecorder.getSlowLogPayloads(request).size() == 14));\n \n-    List<SlowLogPayload> slowLogPayloads = slowLogRecorder.getSlowLogPayloads(request);\n-    Assert.assertEquals(slowLogPayloads.size(), 14);\n-\n-    // confirm strict order of slow log payloads\n-    confirmPayloadParams(0, 154, slowLogPayloads);\n-    confirmPayloadParams(1, 153, slowLogPayloads);\n-    confirmPayloadParams(2, 152, slowLogPayloads);\n-    confirmPayloadParams(3, 151, slowLogPayloads);\n-    confirmPayloadParams(4, 150, slowLogPayloads);\n-    confirmPayloadParams(5, 149, slowLogPayloads);\n-    confirmPayloadParams(6, 148, slowLogPayloads);\n-    confirmPayloadParams(7, 147, slowLogPayloads);\n-    confirmPayloadParams(8, 146, slowLogPayloads);\n-    confirmPayloadParams(9, 145, slowLogPayloads);\n-    confirmPayloadParams(10, 144, slowLogPayloads);\n-    confirmPayloadParams(11, 143, slowLogPayloads);\n-    confirmPayloadParams(12, 142, slowLogPayloads);\n-    confirmPayloadParams(13, 141, slowLogPayloads);\n+    Assert.assertNotEquals(-1, HBASE_TESTING_UTILITY.waitFor(3000,\n+      () -> {\n+        List<SlowLogPayload> slowLogPayloads = slowLogRecorder.getSlowLogPayloads(request);\n+        boolean b1 = slowLogPayloads.size() == 14;\n+\n+        // confirm strict order of slow log payloads\n+        boolean b2 = confirmPayloadParams(0, 154, slowLogPayloads);\n+        boolean b3 = confirmPayloadParams(1, 153, slowLogPayloads);\n+        boolean b4 = confirmPayloadParams(2, 152, slowLogPayloads);\n+        boolean b5 = confirmPayloadParams(3, 151, slowLogPayloads);\n+        boolean b6 = confirmPayloadParams(4, 150, slowLogPayloads);\n+        boolean b7 = confirmPayloadParams(5, 149, slowLogPayloads);\n+        boolean b8 = confirmPayloadParams(6, 148, slowLogPayloads);\n+        boolean b9 = confirmPayloadParams(7, 147, slowLogPayloads);\n+        boolean b10 = confirmPayloadParams(8, 146, slowLogPayloads);\n+        boolean b11 = confirmPayloadParams(9, 145, slowLogPayloads);\n+        boolean b12 = confirmPayloadParams(10, 144, slowLogPayloads);\n+        boolean b13 = confirmPayloadParams(11, 143, slowLogPayloads);\n+        boolean b14 = confirmPayloadParams(12, 142, slowLogPayloads);\n+        boolean b15 = confirmPayloadParams(13, 141, slowLogPayloads);\n+        return b1 && b2 && b3 && b4 && b5 && b6 && b7 && b8 && b9 && b10 && b11", "originalCommit": "e0ecdae2d0416a53de084fadb5238f8fbb03ae17", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ1Mjk2Mw==", "url": "https://github.com/apache/hbase/pull/1286#discussion_r395452963", "bodyText": "yeah, makes sense, let me take it up. Thanks", "author": "virajjasani", "createdAt": "2020-03-20T06:14:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTMzMTEwMA=="}], "type": "inlineReview", "revised_code": null}]}