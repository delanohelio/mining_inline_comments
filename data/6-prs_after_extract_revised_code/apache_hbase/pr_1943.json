{"pr_number": 1943, "pr_title": "HBASE-24609 Move MetaTableAccessor out of hbase-client", "pr_createdAt": "2020-06-21T15:08:48Z", "pr_url": "https://github.com/apache/hbase/pull/1943", "timeline": [{"oid": "2e3705744aa48bcc23815c6cdfa43046c4af5197", "url": "https://github.com/apache/hbase/commit/2e3705744aa48bcc23815c6cdfa43046c4af5197", "message": "HBASE-24609 Move MetaTableAccessor out of hbase-client", "committedDate": "2020-06-22T02:21:34Z", "type": "forcePushed"}, {"oid": "24c11ebe2a3091138bb164b6ecb32fb59efaf954", "url": "https://github.com/apache/hbase/commit/24c11ebe2a3091138bb164b6ecb32fb59efaf954", "message": "HBASE-24609 Move MetaTableAccessor out of hbase-client", "committedDate": "2020-06-22T06:00:26Z", "type": "commit"}, {"oid": "24c11ebe2a3091138bb164b6ecb32fb59efaf954", "url": "https://github.com/apache/hbase/commit/24c11ebe2a3091138bb164b6ecb32fb59efaf954", "message": "HBASE-24609 Move MetaTableAccessor out of hbase-client", "committedDate": "2020-06-22T06:00:26Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDY4MjkzNw==", "url": "https://github.com/apache/hbase/pull/1943#discussion_r444682937", "bodyText": "replica_id is a integer? So it should only have [0-9]?", "author": "infraio", "createdAt": "2020-06-24T06:55:51Z", "path": "hbase-client/src/main/java/org/apache/hadoop/hbase/CatalogFamilyFormat.java", "diffHunk": "@@ -0,0 +1,349 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.hbase;\n+\n+import edu.umd.cs.findbugs.annotations.Nullable;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.NavigableMap;\n+import java.util.SortedMap;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+import org.apache.hadoop.hbase.client.RegionInfo;\n+import org.apache.hadoop.hbase.client.RegionInfoBuilder;\n+import org.apache.hadoop.hbase.client.RegionReplicaUtil;\n+import org.apache.hadoop.hbase.client.Result;\n+import org.apache.hadoop.hbase.client.TableState;\n+import org.apache.hadoop.hbase.exceptions.DeserializationException;\n+import org.apache.hadoop.hbase.util.Bytes;\n+import org.apache.yetus.audience.InterfaceAudience;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import org.apache.hbase.thirdparty.com.google.common.annotations.VisibleForTesting;\n+\n+/**\n+ * Helper class for generating/parsing\n+ * {@value org.apache.hadoop.hbase.HConstants#CATALOG_FAMILY_STR} family cells in meta table.\n+ * <p/>\n+ * The cells in catalog family are:\n+ *\n+ * <pre>\n+ * For each table range ('Region'), there is a single row, formatted as:\n+ * &lt;tableName&gt;,&lt;startKey&gt;,&lt;regionId&gt;,&lt;encodedRegionName&gt;.\n+ * This row is the serialized regionName of the default region replica.\n+ * Columns are:\n+ * info:regioninfo         => contains serialized HRI for the default region replica\n+ * info:server             => contains hostname:port (in string form) for the server hosting\n+ *                            the default regionInfo replica\n+ * info:server_&lt;replicaId&gt => contains hostname:port (in string form) for the server hosting\n+ *                                 the regionInfo replica with replicaId\n+ * info:serverstartcode    => contains server start code (in binary long form) for the server\n+ *                            hosting the default regionInfo replica\n+ * info:serverstartcode_&lt;replicaId&gt => contains server start code (in binary long form) for\n+ *                                          the server hosting the regionInfo replica with\n+ *                                          replicaId\n+ * info:seqnumDuringOpen   => contains seqNum (in binary long form) for the region at the time\n+ *                            the server opened the region with default replicaId\n+ * info:seqnumDuringOpen_&lt;replicaId&gt => contains seqNum (in binary long form) for the region\n+ *                                           at the time the server opened the region with\n+ *                                           replicaId\n+ * info:splitA             => contains a serialized HRI for the first daughter region if the\n+ *                            region is split\n+ * info:splitB             => contains a serialized HRI for the second daughter region if the\n+ *                            region is split\n+ * info:merge*             => contains a serialized HRI for a merge parent region. There will be two\n+ *                            or more of these columns in a row. A row that has these columns is\n+ *                            undergoing a merge and is the result of the merge. Columns listed\n+ *                            in marge* columns are the parents of this merged region. Example\n+ *                            columns: info:merge0001, info:merge0002. You make also see 'mergeA',\n+ *                            and 'mergeB'. This is old form replaced by the new format that allows\n+ *                            for more than two parents to be merged at a time.\n+ * </pre>\n+ */\n+@InterfaceAudience.Private\n+public class CatalogFamilyFormat {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(CatalogFamilyFormat.class);\n+\n+  /** A regex for parsing server columns from meta. See above javadoc for meta layout */\n+  private static final Pattern SERVER_COLUMN_PATTERN =\n+    Pattern.compile(\"^server(_[0-9a-fA-F]{4})?$\");", "originalCommit": "24c11ebe2a3091138bb164b6ecb32fb59efaf954", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDg4Njk2Mg==", "url": "https://github.com/apache/hbase/pull/1943#discussion_r444886962", "bodyText": "@InterfaceAudience.Private\nString REPLICA_ID_FORMAT = \"%04X\";\nI think it is in hex format?", "author": "Apache9", "createdAt": "2020-06-24T13:19:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDY4MjkzNw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI5OTI4OQ==", "url": "https://github.com/apache/hbase/pull/1943#discussion_r504299289", "bodyText": "Should this method be in ClientMTA altogether? Or you leave it here just to minimize code churn?", "author": "saintstack", "createdAt": "2020-10-13T22:41:02Z", "path": "hbase-balancer/src/main/java/org/apache/hadoop/hbase/MetaTableAccessor.java", "diffHunk": "@@ -193,8 +133,8 @@\n    * @param connection connection we're using\n    * @param visitor Visitor invoked against each row in regions family.\n    */\n-  public static void fullScanRegions(Connection connection, final Visitor visitor)\n-      throws IOException {\n+  public static void fullScanRegions(Connection connection,", "originalCommit": "24c11ebe2a3091138bb164b6ecb32fb59efaf954", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDMwMTA1Nw==", "url": "https://github.com/apache/hbase/pull/1943#discussion_r504301057", "bodyText": "Trying to figure the prinicipal to apply figuring when to put something in MTA and when to put it in CMTA? Thanks.", "author": "saintstack", "createdAt": "2020-10-13T22:45:56Z", "path": "hbase-balancer/src/main/java/org/apache/hadoop/hbase/MetaTableAccessor.java", "diffHunk": "@@ -2176,13 +1606,9 @@ private static void debugLogMutation(Mutation p) throws IOException {\n   }\n \n   private static Put addSequenceNum(Put p, long openSeqNum, int replicaId) throws IOException {\n-    return p.add(CellBuilderFactory.create(CellBuilderType.SHALLOW_COPY)\n-              .setRow(p.getRow())\n-              .setFamily(HConstants.CATALOG_FAMILY)\n-              .setQualifier(getSeqNumColumn(replicaId))\n-              .setTimestamp(p.getTimestamp())\n-              .setType(Type.Put)\n-              .setValue(Bytes.toBytes(openSeqNum))\n-              .build());\n+    return p.add(CellBuilderFactory.create(CellBuilderType.SHALLOW_COPY).setRow(p.getRow())\n+      .setFamily(HConstants.CATALOG_FAMILY)\n+      .setQualifier(CatalogFamilyFormat.getSeqNumColumn(replicaId)).setTimestamp(p.getTimestamp())\n+      .setType(Type.Put).setValue(Bytes.toBytes(openSeqNum)).build());\n   }\n }", "originalCommit": "24c11ebe2a3091138bb164b6ecb32fb59efaf954", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDMwMTc5NQ==", "url": "https://github.com/apache/hbase/pull/1943#discussion_r504301795", "bodyText": "Looks like could be package private?", "author": "saintstack", "createdAt": "2020-10-13T22:47:58Z", "path": "hbase-client/src/main/java/org/apache/hadoop/hbase/CatalogFamilyFormat.java", "diffHunk": "@@ -0,0 +1,349 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.hbase;\n+\n+import edu.umd.cs.findbugs.annotations.Nullable;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.NavigableMap;\n+import java.util.SortedMap;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+import org.apache.hadoop.hbase.client.RegionInfo;\n+import org.apache.hadoop.hbase.client.RegionInfoBuilder;\n+import org.apache.hadoop.hbase.client.RegionReplicaUtil;\n+import org.apache.hadoop.hbase.client.Result;\n+import org.apache.hadoop.hbase.client.TableState;\n+import org.apache.hadoop.hbase.exceptions.DeserializationException;\n+import org.apache.hadoop.hbase.util.Bytes;\n+import org.apache.yetus.audience.InterfaceAudience;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import org.apache.hbase.thirdparty.com.google.common.annotations.VisibleForTesting;\n+\n+/**\n+ * Helper class for generating/parsing\n+ * {@value org.apache.hadoop.hbase.HConstants#CATALOG_FAMILY_STR} family cells in meta table.\n+ * <p/>\n+ * The cells in catalog family are:\n+ *\n+ * <pre>\n+ * For each table range ('Region'), there is a single row, formatted as:\n+ * &lt;tableName&gt;,&lt;startKey&gt;,&lt;regionId&gt;,&lt;encodedRegionName&gt;.\n+ * This row is the serialized regionName of the default region replica.\n+ * Columns are:\n+ * info:regioninfo         => contains serialized HRI for the default region replica\n+ * info:server             => contains hostname:port (in string form) for the server hosting\n+ *                            the default regionInfo replica\n+ * info:server_&lt;replicaId&gt => contains hostname:port (in string form) for the server hosting\n+ *                                 the regionInfo replica with replicaId\n+ * info:serverstartcode    => contains server start code (in binary long form) for the server\n+ *                            hosting the default regionInfo replica\n+ * info:serverstartcode_&lt;replicaId&gt => contains server start code (in binary long form) for\n+ *                                          the server hosting the regionInfo replica with\n+ *                                          replicaId\n+ * info:seqnumDuringOpen   => contains seqNum (in binary long form) for the region at the time\n+ *                            the server opened the region with default replicaId\n+ * info:seqnumDuringOpen_&lt;replicaId&gt => contains seqNum (in binary long form) for the region\n+ *                                           at the time the server opened the region with\n+ *                                           replicaId\n+ * info:splitA             => contains a serialized HRI for the first daughter region if the\n+ *                            region is split\n+ * info:splitB             => contains a serialized HRI for the second daughter region if the\n+ *                            region is split\n+ * info:merge*             => contains a serialized HRI for a merge parent region. There will be two\n+ *                            or more of these columns in a row. A row that has these columns is\n+ *                            undergoing a merge and is the result of the merge. Columns listed\n+ *                            in marge* columns are the parents of this merged region. Example\n+ *                            columns: info:merge0001, info:merge0002. You make also see 'mergeA',\n+ *                            and 'mergeB'. This is old form replaced by the new format that allows\n+ *                            for more than two parents to be merged at a time.\n+ * </pre>\n+ */\n+@InterfaceAudience.Private\n+public class CatalogFamilyFormat {", "originalCommit": "24c11ebe2a3091138bb164b6ecb32fb59efaf954", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDMwMTkzOQ==", "url": "https://github.com/apache/hbase/pull/1943#discussion_r504301939", "bodyText": "Only for the 'info' CF?", "author": "saintstack", "createdAt": "2020-10-13T22:48:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDMwMTc5NQ=="}], "type": "inlineReview", "revised_code": null}]}