{"pr_number": 2657, "pr_title": "HBASE-25282 Remove processingServers in DeadServer as we can get this\u2026", "pr_createdAt": "2020-11-16T02:37:31Z", "pr_url": "https://github.com/apache/hbase/pull/2657", "timeline": [{"oid": "1552d2877e0233e817e034d929e360633c27072a", "url": "https://github.com/apache/hbase/commit/1552d2877e0233e817e034d929e360633c27072a", "message": "HBASE-25282 Remove processingServers in DeadServer as we can get this information by Procedure of master", "committedDate": "2020-11-16T02:54:10Z", "type": "commit"}, {"oid": "71b3b5e6be2fab78761ef34e230a01f4d83c96cc", "url": "https://github.com/apache/hbase/commit/71b3b5e6be2fab78761ef34e230a01f4d83c96cc", "message": "HBASE-25282 Remove processingServers in DeadServer as we can get this information by Procedure of master, again", "committedDate": "2020-11-16T02:54:20Z", "type": "commit"}, {"oid": "71b3b5e6be2fab78761ef34e230a01f4d83c96cc", "url": "https://github.com/apache/hbase/commit/71b3b5e6be2fab78761ef34e230a01f4d83c96cc", "message": "HBASE-25282 Remove processingServers in DeadServer as we can get this information by Procedure of master, again", "committedDate": "2020-11-16T02:54:20Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDgxMjE3OQ==", "url": "https://github.com/apache/hbase/pull/2657#discussion_r524812179", "bodyText": "Why this change?", "author": "infraio", "createdAt": "2020-11-17T00:48:19Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/MasterRpcServices.java", "diffHunk": "@@ -2440,6 +2440,12 @@ public ClearDeadServersResponse clearDeadServers(RpcController controller,\n         Set<Address> clearedServers = new HashSet<>();\n         for (HBaseProtos.ServerName pbServer : request.getServerNameList()) {\n           ServerName server = ProtobufUtil.toServerName(pbServer);\n+          final boolean deadInProcess = master.getServerManager().isDeadServersInProgress(server);", "originalCommit": "71b3b5e6be2fab78761ef34e230a01f4d83c96cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDk5NDM0OA==", "url": "https://github.com/apache/hbase/pull/2657#discussion_r524994348", "bodyText": "See code here\n\nWe need to check where region server with special server name is in processing, so i add such a method", "author": "yuqi1129", "createdAt": "2020-11-17T09:11:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDgxMjE3OQ=="}], "type": "inlineReview", "revised_code": {"commit": "bf60ce629972aaa0f08bd0d2d71af94d0e90f51b", "chunk": "diff --git a/hbase-server/src/main/java/org/apache/hadoop/hbase/master/MasterRpcServices.java b/hbase-server/src/main/java/org/apache/hadoop/hbase/master/MasterRpcServices.java\nindex 61dd390218..83fc5757c7 100644\n--- a/hbase-server/src/main/java/org/apache/hadoop/hbase/master/MasterRpcServices.java\n+++ b/hbase-server/src/main/java/org/apache/hadoop/hbase/master/MasterRpcServices.java\n\n@@ -2440,10 +2440,12 @@ public class MasterRpcServices extends RSRpcServices implements\n         Set<Address> clearedServers = new HashSet<>();\n         for (HBaseProtos.ServerName pbServer : request.getServerNameList()) {\n           ServerName server = ProtobufUtil.toServerName(pbServer);\n-          final boolean deadInProcess = master.getServerManager().isDeadServersInProgress(server);\n \n+          final boolean deadInProcess = master.getProcedures().stream().anyMatch(\n+            p -> (p instanceof ServerCrashProcedure)\n+              && ((ServerCrashProcedure) p).getServerName().equals(server));\n           if (!deadInProcess) {\n-            throw new RuntimeException(String.format(\"Dead server '%s' is not 'dead' in fact...\", server));\n+            throw new ServiceException(String.format(\"Dead server '%s' is not 'dead' in fact...\", server));\n           }\n \n           if (!deadServer.removeDeadServer(server)) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDgxMjMwNQ==", "url": "https://github.com/apache/hbase/pull/2657#discussion_r524812305", "bodyText": "Why add this method?", "author": "infraio", "createdAt": "2020-11-17T00:48:43Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/ServerManager.java", "diffHunk": "@@ -504,7 +506,21 @@ public DeadServer getDeadServers() {\n    * @return true if any RS are being processed as dead, false if not\n    */\n   public boolean areDeadServersInProgress() {\n-    return this.deadservers.areDeadServersInProgress();\n+    try {\n+      return master.getProcedures().stream().anyMatch(p -> p instanceof ServerCrashProcedure);\n+    } catch (IOException e) {\n+      throw new RuntimeException(e);\n+    }\n+  }\n+\n+  public boolean isDeadServersInProgress(ServerName serverName) {", "originalCommit": "71b3b5e6be2fab78761ef34e230a01f4d83c96cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDk5NDQ2MA==", "url": "https://github.com/apache/hbase/pull/2657#discussion_r524994460", "bodyText": "see above", "author": "yuqi1129", "createdAt": "2020-11-17T09:11:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDgxMjMwNQ=="}], "type": "inlineReview", "revised_code": {"commit": "bf60ce629972aaa0f08bd0d2d71af94d0e90f51b", "chunk": "diff --git a/hbase-server/src/main/java/org/apache/hadoop/hbase/master/ServerManager.java b/hbase-server/src/main/java/org/apache/hadoop/hbase/master/ServerManager.java\nindex d49dea6489..cd3ca6e039 100644\n--- a/hbase-server/src/main/java/org/apache/hadoop/hbase/master/ServerManager.java\n+++ b/hbase-server/src/main/java/org/apache/hadoop/hbase/master/ServerManager.java\n\n@@ -505,23 +505,9 @@ public class ServerManager {\n    * Checks if any dead servers are currently in progress.\n    * @return true if any RS are being processed as dead, false if not\n    */\n-  public boolean areDeadServersInProgress() {\n-    try {\n+  public boolean areDeadServersInProgress() throws IOException {\n       return master.getProcedures().stream().anyMatch(p -> p instanceof ServerCrashProcedure);\n-    } catch (IOException e) {\n-      throw new RuntimeException(e);\n-    }\n-  }\n-\n-  public boolean isDeadServersInProgress(ServerName serverName) {\n-    try {\n-      return master.getProcedures().stream().anyMatch(\n-        p -> (p instanceof ServerCrashProcedure)\n-          && ((ServerCrashProcedure) p).getServerName().equals(serverName));\n-    } catch (IOException e) {\n-      throw new RuntimeException(e);\n-    }\n-  }\n+ }\n \n   void letRegionServersShutdown() {\n     long previousLogTime = 0;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTYzNTI1MQ==", "url": "https://github.com/apache/hbase/pull/2657#discussion_r525635251", "bodyText": "You can filter the SCP here too? I thought no need to introduce new method. Please keep the code simple. Thanks.", "author": "infraio", "createdAt": "2020-11-18T01:28:07Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/MasterRpcServices.java", "diffHunk": "@@ -2440,6 +2440,12 @@ public ClearDeadServersResponse clearDeadServers(RpcController controller,\n         Set<Address> clearedServers = new HashSet<>();\n         for (HBaseProtos.ServerName pbServer : request.getServerNameList()) {\n           ServerName server = ProtobufUtil.toServerName(pbServer);\n+          final boolean deadInProcess = master.getServerManager().isDeadServersInProgress(server);\n+\n+          if (!deadInProcess) {\n+            throw new RuntimeException(String.format(\"Dead server '%s' is not 'dead' in fact...\", server));\n+          }\n+\n           if (!deadServer.removeDeadServer(server)) {", "originalCommit": "71b3b5e6be2fab78761ef34e230a01f4d83c96cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTc4NTU2NQ==", "url": "https://github.com/apache/hbase/pull/2657#discussion_r525785565", "bodyText": "OK, Thanks for your suggestion", "author": "yuqi1129", "createdAt": "2020-11-18T04:24:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTYzNTI1MQ=="}], "type": "inlineReview", "revised_code": {"commit": "bf60ce629972aaa0f08bd0d2d71af94d0e90f51b", "chunk": "diff --git a/hbase-server/src/main/java/org/apache/hadoop/hbase/master/MasterRpcServices.java b/hbase-server/src/main/java/org/apache/hadoop/hbase/master/MasterRpcServices.java\nindex 61dd390218..83fc5757c7 100644\n--- a/hbase-server/src/main/java/org/apache/hadoop/hbase/master/MasterRpcServices.java\n+++ b/hbase-server/src/main/java/org/apache/hadoop/hbase/master/MasterRpcServices.java\n\n@@ -2440,10 +2440,12 @@ public class MasterRpcServices extends RSRpcServices implements\n         Set<Address> clearedServers = new HashSet<>();\n         for (HBaseProtos.ServerName pbServer : request.getServerNameList()) {\n           ServerName server = ProtobufUtil.toServerName(pbServer);\n-          final boolean deadInProcess = master.getServerManager().isDeadServersInProgress(server);\n \n+          final boolean deadInProcess = master.getProcedures().stream().anyMatch(\n+            p -> (p instanceof ServerCrashProcedure)\n+              && ((ServerCrashProcedure) p).getServerName().equals(server));\n           if (!deadInProcess) {\n-            throw new RuntimeException(String.format(\"Dead server '%s' is not 'dead' in fact...\", server));\n+            throw new ServiceException(String.format(\"Dead server '%s' is not 'dead' in fact...\", server));\n           }\n \n           if (!deadServer.removeDeadServer(server)) {\n"}}, {"oid": "bf60ce629972aaa0f08bd0d2d71af94d0e90f51b", "url": "https://github.com/apache/hbase/commit/bf60ce629972aaa0f08bd0d2d71af94d0e90f51b", "message": "HBASE-25282 Remove processingServers in DeadServer as we can get this information by Procedure of master, fix discussion 1", "committedDate": "2020-11-18T07:21:24Z", "type": "commit"}, {"oid": "9613660c835c12a302ba635a4a01085c6d3fd735", "url": "https://github.com/apache/hbase/commit/9613660c835c12a302ba635a4a01085c6d3fd735", "message": "HBASE-25282 Remove processingServers in DeadServer as we can get this information by Procedure of master, fix discussion 2", "committedDate": "2020-11-18T07:23:05Z", "type": "commit"}, {"oid": "b29e0b71589f3d4a4c0e1186463afd8dedd31ba8", "url": "https://github.com/apache/hbase/commit/b29e0b71589f3d4a4c0e1186463afd8dedd31ba8", "message": "Merge branch 'master' of https://github.com/apache/hbase into 25282", "committedDate": "2020-11-23T02:11:38Z", "type": "commit"}, {"oid": "d9d4a480f6f9ed937df10f07674191a1af21ff34", "url": "https://github.com/apache/hbase/commit/d9d4a480f6f9ed937df10f07674191a1af21ff34", "message": "Merge branch '25282' of https://github.com/yuqi1129/hbase into 25282", "committedDate": "2020-11-23T02:26:50Z", "type": "commit"}, {"oid": "0b4669369da6d17d85ae8524d7e729cd400583ed", "url": "https://github.com/apache/hbase/commit/0b4669369da6d17d85ae8524d7e729cd400583ed", "message": "HBASE-25282 Remove processingServers in DeadServer as we can get this information by Procedure of master, again, fix ut", "committedDate": "2020-11-24T08:12:28Z", "type": "commit"}, {"oid": "e146b308919547b7d3bde3676978da49792ca174", "url": "https://github.com/apache/hbase/commit/e146b308919547b7d3bde3676978da49792ca174", "message": "Fix checkstyle problem", "committedDate": "2020-11-25T01:55:39Z", "type": "commit"}, {"oid": "95031fb720cab6296eaf1441065ae8580f98528b", "url": "https://github.com/apache/hbase/commit/95031fb720cab6296eaf1441065ae8580f98528b", "message": "Fix checkstyle problem again", "committedDate": "2020-11-25T01:57:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTg2MDU4Mg==", "url": "https://github.com/apache/hbase/pull/2657#discussion_r535860582", "bodyText": "These codes are not only set the server be dead, but also set it be processing.\nBut the changed codes only set it be dead.\nAs a result ,when calling ServerManager.expireServer() method, the server is firstly set be dead by moveFromOnlineToDeadServers(), but the SCP is submitted afterwards.\nSo this patch made a diff from the origin codes when calling ServerManager.areDeadServersInProgress(), because the new codes has a little delay time of submit and execute the SCP procedure.", "author": "sunhelly", "createdAt": "2020-12-04T06:12:35Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/DeadServer.java", "diffHunk": "@@ -96,29 +75,6 @@ synchronized boolean areDeadServersInProgress() {\n    */\n   synchronized void putIfAbsent(ServerName sn) {\n     this.deadServers.putIfAbsent(sn, EnvironmentEdgeManager.currentTime());\n-    processing(sn);\n-  }", "originalCommit": "95031fb720cab6296eaf1441065ae8580f98528b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjk5MjY1Mw==", "url": "https://github.com/apache/hbase/pull/2657#discussion_r536992653", "bodyText": "This test case should assert false, because the SCP has been done completely.", "author": "sunhelly", "createdAt": "2020-12-06T09:01:05Z", "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/master/TestDeadServer.java", "diffHunk": "@@ -104,15 +93,15 @@ public static void tearDownAfterClass() throws Exception {\n   }\n \n   @Test\n-  public void testCrashProcedureReplay() {\n+  public void testCrashProcedureReplay() throws IOException {\n     HMaster master = TEST_UTIL.getHBaseCluster().getMaster();\n     final ProcedureExecutor<MasterProcedureEnv> pExecutor = master.getMasterProcedureExecutor();\n     ServerCrashProcedure proc = new ServerCrashProcedure(\n       pExecutor.getEnvironment(), hostname123, false, false);\n \n     ProcedureTestingUtility.submitAndWait(pExecutor, proc);\n \n-    assertFalse(master.getServerManager().getDeadServers().areDeadServersInProgress());", "originalCommit": "95031fb720cab6296eaf1441065ae8580f98528b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjk5Mjg5NQ==", "url": "https://github.com/apache/hbase/pull/2657#discussion_r536992895", "bodyText": "@Apache9 @yuqi1129", "author": "sunhelly", "createdAt": "2020-12-06T09:02:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjk5MjY1Mw=="}], "type": "inlineReview", "revised_code": null}]}