{"pr_number": 1866, "pr_title": "HBASE-24517 AssignmentManager.start should add meta region to ServerS\u2026", "pr_createdAt": "2020-06-08T10:00:25Z", "pr_url": "https://github.com/apache/hbase/pull/1866", "timeline": [{"oid": "52ba9051b6a10651ca9ad2e988040748c276fab7", "url": "https://github.com/apache/hbase/commit/52ba9051b6a10651ca9ad2e988040748c276fab7", "message": "HBASE-24517 AssignmentManager.start should add meta region to ServerStateNode", "committedDate": "2020-06-08T09:59:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjYxOTc1Ng==", "url": "https://github.com/apache/hbase/pull/1866#discussion_r436619756", "bodyText": "Donot need lock because the master was started now? No other procedures runed at the same time?", "author": "infraio", "createdAt": "2020-06-08T11:11:09Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/assignment/AssignmentManager.java", "diffHunk": "@@ -231,17 +231,15 @@ public void start() throws IOException, KeeperException {\n       RegionState regionState = MetaTableLocator.getMetaRegionState(zkw);\n       RegionStateNode regionNode =\n         regionStates.getOrCreateRegionStateNode(RegionInfoBuilder.FIRST_META_REGIONINFO);\n-      regionNode.lock();", "originalCommit": "52ba9051b6a10651ca9ad2e988040748c276fab7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjYzOTI4Ng==", "url": "https://github.com/apache/hbase/pull/1866#discussion_r436639286", "bodyText": "No. As you said, no procedures yet and no concurrent call to this method either. The code is written by me but now I think adding the lock here will make people confusing, let's just remove it.", "author": "Apache9", "createdAt": "2020-06-08T11:55:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjYxOTc1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjk2NTAzMw==", "url": "https://github.com/apache/hbase/pull/1866#discussion_r436965033", "bodyText": "We need a note here? Normally, we want to lock RegionNode because we do not want concurrent modifications happening. I see this is happening early in startup so should be safe. I do notice that the RpcServer is up by the time we get to here but Master is not active yet so we can't get requests at this point?", "author": "saintstack", "createdAt": "2020-06-08T19:58:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjYxOTc1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA2NzA5OQ==", "url": "https://github.com/apache/hbase/pull/1866#discussion_r437067099", "bodyText": "no procedures yet and no concurrent call to this method\n\nNit: Add this comment here?", "author": "infraio", "createdAt": "2020-06-09T00:10:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjYxOTc1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzkzOTk3MA==", "url": "https://github.com/apache/hbase/pull/1866#discussion_r437939970", "bodyText": "Let me add comments. Missed this one.", "author": "Apache9", "createdAt": "2020-06-10T08:10:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjYxOTc1Ng=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjYyMDcwNA==", "url": "https://github.com/apache/hbase/pull/1866#discussion_r436620704", "bodyText": "Without this patch, the newRegions will not contains meta region?", "author": "infraio", "createdAt": "2020-06-08T11:13:24Z", "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/master/assignment/TestAssignmentManagerLoadMetaRegionState.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.hbase.master.assignment;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertTrue;\n+\n+import java.io.IOException;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Set;\n+import org.apache.hadoop.hbase.HBaseClassTestRule;\n+import org.apache.hadoop.hbase.HBaseTestingUtility;\n+import org.apache.hadoop.hbase.ServerName;\n+import org.apache.hadoop.hbase.client.RegionInfo;\n+import org.apache.hadoop.hbase.master.HMaster;\n+import org.apache.hadoop.hbase.testclassification.MasterTests;\n+import org.apache.hadoop.hbase.testclassification.MediumTests;\n+import org.junit.AfterClass;\n+import org.junit.BeforeClass;\n+import org.junit.ClassRule;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+\n+@Category({ MasterTests.class, MediumTests.class })\n+public class TestAssignmentManagerLoadMetaRegionState {\n+\n+  @ClassRule\n+  public static final HBaseClassTestRule CLASS_RULE =\n+    HBaseClassTestRule.forClass(TestAssignmentManagerLoadMetaRegionState.class);\n+\n+  private static final HBaseTestingUtility UTIL = new HBaseTestingUtility();\n+\n+  @BeforeClass\n+  public static void setUp() throws Exception {\n+    UTIL.startMiniCluster(1);\n+  }\n+\n+  @AfterClass\n+  public static void tearDown() throws IOException {\n+    UTIL.shutdownMiniCluster();\n+  }\n+\n+  @Test\n+  public void testRestart() throws InterruptedException, IOException {\n+    ServerName sn = UTIL.getMiniHBaseCluster().getRegionServer(0).getServerName();\n+    AssignmentManager am = UTIL.getMiniHBaseCluster().getMaster().getAssignmentManager();\n+    Set<RegionInfo> regions = new HashSet<>(am.getRegionsOnServer(sn));\n+\n+    UTIL.getMiniHBaseCluster().stopMaster(0).join();\n+    HMaster newMaster = UTIL.getMiniHBaseCluster().startMaster().getMaster();\n+    UTIL.waitFor(30000, () -> newMaster.isInitialized());\n+\n+    am = UTIL.getMiniHBaseCluster().getMaster().getAssignmentManager();\n+    List<RegionInfo> newRegions = am.getRegionsOnServer(sn);", "originalCommit": "52ba9051b6a10651ca9ad2e988040748c276fab7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjYzOTM3NQ==", "url": "https://github.com/apache/hbase/pull/1866#discussion_r436639375", "bodyText": "Exactly.", "author": "Apache9", "createdAt": "2020-06-08T11:55:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjYyMDcwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjk4MTMxMg==", "url": "https://github.com/apache/hbase/pull/1866#discussion_r436981312", "bodyText": "How does the lock interfere here?", "author": "saintstack", "createdAt": "2020-06-08T20:29:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjYyMDcwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzkzODI4Ng==", "url": "https://github.com/apache/hbase/pull/1866#discussion_r437938286", "bodyText": "The lock is not the problem. The problem is we forgot to call regionStates.addRegionToServer.", "author": "Apache9", "createdAt": "2020-06-10T08:07:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjYyMDcwNA=="}], "type": "inlineReview", "revised_code": null}]}