{"pr_number": 2809, "pr_title": "HBASE-25432:add security checks for setTableStateInMeta and fixMeta", "pr_createdAt": "2020-12-23T12:45:59Z", "pr_url": "https://github.com/apache/hbase/pull/2809", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODkyODYzNw==", "url": "https://github.com/apache/hbase/pull/2809#discussion_r548928637", "bodyText": "Please use try-with-resources to close the connection.", "author": "Apache9", "createdAt": "2020-12-26T01:13:25Z", "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/security/access/TestAccessController.java", "diffHunk": "@@ -379,6 +381,36 @@ public void testUnauthorizedStopMaster() throws Exception {\n         USER_GROUP_WRITE, USER_GROUP_CREATE);\n   }\n \n+  @Test\n+  public void testUnauthorizedSetTableStateInMeta() throws Exception {\n+    AccessTestAction action = new AccessTestAction() {\n+      @Override public Object run() throws Exception {\n+        Connection conn = ConnectionFactory.createConnection(TEST_UTIL.getConfiguration()) ;", "originalCommit": "2361c2b6e10f2b81d067e69062d04c5868dd5d3f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b8f3c8bc933824a41ad5632a85da9ce39db48b04", "chunk": "diff --git a/hbase-server/src/test/java/org/apache/hadoop/hbase/security/access/TestAccessController.java b/hbase-server/src/test/java/org/apache/hadoop/hbase/security/access/TestAccessController.java\nindex 2dc1c184db..7ab808cf18 100644\n--- a/hbase-server/src/test/java/org/apache/hadoop/hbase/security/access/TestAccessController.java\n+++ b/hbase-server/src/test/java/org/apache/hadoop/hbase/security/access/TestAccessController.java\n\n@@ -383,13 +383,12 @@ public class TestAccessController extends SecureTestUtil {\n \n   @Test\n   public void testUnauthorizedSetTableStateInMeta() throws Exception {\n-    AccessTestAction action = new AccessTestAction() {\n-      @Override public Object run() throws Exception {\n-        Connection conn = ConnectionFactory.createConnection(TEST_UTIL.getConfiguration()) ;\n-        Hbck hbck = conn.getHbck();\n+    AccessTestAction action = () -> {\n+      try(Connection conn = ConnectionFactory.createConnection(TEST_UTIL.getConfiguration());\n+        Hbck hbck = conn.getHbck()){\n         hbck.setTableStateInMeta(new TableState(TEST_TABLE, TableState.State.DISABLED));\n-        return null;\n       }\n+      return null;\n     };\n \n     verifyDenied(action, USER_CREATE, USER_OWNER, USER_RW, USER_RO, USER_NONE, USER_GROUP_READ,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODkyODY1Nw==", "url": "https://github.com/apache/hbase/pull/2809#discussion_r548928657", "bodyText": "Ditto.", "author": "Apache9", "createdAt": "2020-12-26T01:13:36Z", "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/security/access/TestAccessController.java", "diffHunk": "@@ -379,6 +381,36 @@ public void testUnauthorizedStopMaster() throws Exception {\n         USER_GROUP_WRITE, USER_GROUP_CREATE);\n   }\n \n+  @Test\n+  public void testUnauthorizedSetTableStateInMeta() throws Exception {\n+    AccessTestAction action = new AccessTestAction() {\n+      @Override public Object run() throws Exception {\n+        Connection conn = ConnectionFactory.createConnection(TEST_UTIL.getConfiguration()) ;\n+        Hbck hbck = conn.getHbck();\n+        hbck.setTableStateInMeta(new TableState(TEST_TABLE, TableState.State.DISABLED));\n+        return null;\n+      }\n+    };\n+\n+    verifyDenied(action, USER_CREATE, USER_OWNER, USER_RW, USER_RO, USER_NONE, USER_GROUP_READ,\n+        USER_GROUP_WRITE, USER_GROUP_CREATE);\n+  }\n+\n+  @Test\n+  public void testUnauthorizedFixMeta() throws Exception {\n+    AccessTestAction action = new AccessTestAction() {\n+      @Override public Object run() throws Exception {\n+        Connection conn = ConnectionFactory.createConnection(TEST_UTIL.getConfiguration()) ;", "originalCommit": "2361c2b6e10f2b81d067e69062d04c5868dd5d3f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b8f3c8bc933824a41ad5632a85da9ce39db48b04", "chunk": "diff --git a/hbase-server/src/test/java/org/apache/hadoop/hbase/security/access/TestAccessController.java b/hbase-server/src/test/java/org/apache/hadoop/hbase/security/access/TestAccessController.java\nindex 2dc1c184db..7ab808cf18 100644\n--- a/hbase-server/src/test/java/org/apache/hadoop/hbase/security/access/TestAccessController.java\n+++ b/hbase-server/src/test/java/org/apache/hadoop/hbase/security/access/TestAccessController.java\n\n@@ -383,13 +383,12 @@ public class TestAccessController extends SecureTestUtil {\n \n   @Test\n   public void testUnauthorizedSetTableStateInMeta() throws Exception {\n-    AccessTestAction action = new AccessTestAction() {\n-      @Override public Object run() throws Exception {\n-        Connection conn = ConnectionFactory.createConnection(TEST_UTIL.getConfiguration()) ;\n-        Hbck hbck = conn.getHbck();\n+    AccessTestAction action = () -> {\n+      try(Connection conn = ConnectionFactory.createConnection(TEST_UTIL.getConfiguration());\n+        Hbck hbck = conn.getHbck()){\n         hbck.setTableStateInMeta(new TableState(TEST_TABLE, TableState.State.DISABLED));\n-        return null;\n       }\n+      return null;\n     };\n \n     verifyDenied(action, USER_CREATE, USER_OWNER, USER_RW, USER_RO, USER_NONE, USER_GROUP_READ,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODk0NjQzMg==", "url": "https://github.com/apache/hbase/pull/2809#discussion_r548946432", "bodyText": "Let's use lambda here?\n    AccessTestAction action = () -> {\n...\n...\n...\n      return null;\n    };", "author": "virajjasani", "createdAt": "2020-12-26T05:36:24Z", "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/security/access/TestAccessController.java", "diffHunk": "@@ -379,6 +381,36 @@ public void testUnauthorizedStopMaster() throws Exception {\n         USER_GROUP_WRITE, USER_GROUP_CREATE);\n   }\n \n+  @Test\n+  public void testUnauthorizedSetTableStateInMeta() throws Exception {\n+    AccessTestAction action = new AccessTestAction() {\n+      @Override public Object run() throws Exception {", "originalCommit": "2361c2b6e10f2b81d067e69062d04c5868dd5d3f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b8f3c8bc933824a41ad5632a85da9ce39db48b04", "chunk": "diff --git a/hbase-server/src/test/java/org/apache/hadoop/hbase/security/access/TestAccessController.java b/hbase-server/src/test/java/org/apache/hadoop/hbase/security/access/TestAccessController.java\nindex 2dc1c184db..7ab808cf18 100644\n--- a/hbase-server/src/test/java/org/apache/hadoop/hbase/security/access/TestAccessController.java\n+++ b/hbase-server/src/test/java/org/apache/hadoop/hbase/security/access/TestAccessController.java\n\n@@ -383,13 +383,12 @@ public class TestAccessController extends SecureTestUtil {\n \n   @Test\n   public void testUnauthorizedSetTableStateInMeta() throws Exception {\n-    AccessTestAction action = new AccessTestAction() {\n-      @Override public Object run() throws Exception {\n-        Connection conn = ConnectionFactory.createConnection(TEST_UTIL.getConfiguration()) ;\n-        Hbck hbck = conn.getHbck();\n+    AccessTestAction action = () -> {\n+      try(Connection conn = ConnectionFactory.createConnection(TEST_UTIL.getConfiguration());\n+        Hbck hbck = conn.getHbck()){\n         hbck.setTableStateInMeta(new TableState(TEST_TABLE, TableState.State.DISABLED));\n-        return null;\n       }\n+      return null;\n     };\n \n     verifyDenied(action, USER_CREATE, USER_OWNER, USER_RW, USER_RO, USER_NONE, USER_GROUP_READ,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODk0NjQ2OQ==", "url": "https://github.com/apache/hbase/pull/2809#discussion_r548946469", "bodyText": "Same here", "author": "virajjasani", "createdAt": "2020-12-26T05:36:46Z", "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/security/access/TestAccessController.java", "diffHunk": "@@ -379,6 +381,36 @@ public void testUnauthorizedStopMaster() throws Exception {\n         USER_GROUP_WRITE, USER_GROUP_CREATE);\n   }\n \n+  @Test\n+  public void testUnauthorizedSetTableStateInMeta() throws Exception {\n+    AccessTestAction action = new AccessTestAction() {\n+      @Override public Object run() throws Exception {\n+        Connection conn = ConnectionFactory.createConnection(TEST_UTIL.getConfiguration()) ;\n+        Hbck hbck = conn.getHbck();\n+        hbck.setTableStateInMeta(new TableState(TEST_TABLE, TableState.State.DISABLED));\n+        return null;\n+      }\n+    };\n+\n+    verifyDenied(action, USER_CREATE, USER_OWNER, USER_RW, USER_RO, USER_NONE, USER_GROUP_READ,\n+        USER_GROUP_WRITE, USER_GROUP_CREATE);\n+  }\n+\n+  @Test\n+  public void testUnauthorizedFixMeta() throws Exception {\n+    AccessTestAction action = new AccessTestAction() {\n+      @Override public Object run() throws Exception {", "originalCommit": "2361c2b6e10f2b81d067e69062d04c5868dd5d3f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b8f3c8bc933824a41ad5632a85da9ce39db48b04", "chunk": "diff --git a/hbase-server/src/test/java/org/apache/hadoop/hbase/security/access/TestAccessController.java b/hbase-server/src/test/java/org/apache/hadoop/hbase/security/access/TestAccessController.java\nindex 2dc1c184db..7ab808cf18 100644\n--- a/hbase-server/src/test/java/org/apache/hadoop/hbase/security/access/TestAccessController.java\n+++ b/hbase-server/src/test/java/org/apache/hadoop/hbase/security/access/TestAccessController.java\n\n@@ -383,13 +383,12 @@ public class TestAccessController extends SecureTestUtil {\n \n   @Test\n   public void testUnauthorizedSetTableStateInMeta() throws Exception {\n-    AccessTestAction action = new AccessTestAction() {\n-      @Override public Object run() throws Exception {\n-        Connection conn = ConnectionFactory.createConnection(TEST_UTIL.getConfiguration()) ;\n-        Hbck hbck = conn.getHbck();\n+    AccessTestAction action = () -> {\n+      try(Connection conn = ConnectionFactory.createConnection(TEST_UTIL.getConfiguration());\n+        Hbck hbck = conn.getHbck()){\n         hbck.setTableStateInMeta(new TableState(TEST_TABLE, TableState.State.DISABLED));\n-        return null;\n       }\n+      return null;\n     };\n \n     verifyDenied(action, USER_CREATE, USER_OWNER, USER_RW, USER_RO, USER_NONE, USER_GROUP_READ,\n"}}, {"oid": "b8f3c8bc933824a41ad5632a85da9ce39db48b04", "url": "https://github.com/apache/hbase/commit/b8f3c8bc933824a41ad5632a85da9ce39db48b04", "message": "HBASE-25432:add security checks for setTableStateInMeta and fixMeta", "committedDate": "2020-12-27T07:07:07Z", "type": "commit"}]}