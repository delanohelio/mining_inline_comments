{"pr_number": 1027, "pr_title": "HBASE-23683 Make HBaseInterClusterReplicationEndpoint more extensible", "pr_createdAt": "2020-01-13T11:52:31Z", "pr_url": "https://github.com/apache/hbase/pull/1027", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTc3MjIwMg==", "url": "https://github.com/apache/hbase/pull/1027#discussion_r365772202", "bodyText": "This is wrong?  Should be ClusterConnectionFactory.createAsyncClusterConnection?", "author": "binlijin", "createdAt": "2020-01-13T12:12:57Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/HBaseInterClusterReplicationEndpoint.java", "diffHunk": "@@ -113,6 +113,14 @@\n   private boolean dropOnDeletedTables;\n   private boolean isSerial = false;\n \n+  protected Connection createConnection(Configuration conf) throws IOException {\n+    return ConnectionFactory.createConnection(conf);", "originalCommit": "9ac0150d497c91313bd221a5a6d5f9f538723ce0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTc4NDQwMg==", "url": "https://github.com/apache/hbase/pull/1027#discussion_r365784402", "bodyText": "Yeah, this was originally for a branch-2 based code. Had fixed it on the latest commit.", "author": "wchevreuil", "createdAt": "2020-01-13T12:45:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTc3MjIwMg=="}], "type": "inlineReview", "revised_code": {"commit": "fe498bbb0b85f7e2476a4c9271be812ba53e2d85", "chunk": "diff --git a/hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/HBaseInterClusterReplicationEndpoint.java b/hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/HBaseInterClusterReplicationEndpoint.java\nindex 002c8ba596..138765ac00 100644\n--- a/hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/HBaseInterClusterReplicationEndpoint.java\n+++ b/hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/HBaseInterClusterReplicationEndpoint.java\n\n@@ -113,8 +113,9 @@ public class HBaseInterClusterReplicationEndpoint extends HBaseReplicationEndpoi\n   private boolean dropOnDeletedTables;\n   private boolean isSerial = false;\n \n-  protected Connection createConnection(Configuration conf) throws IOException {\n-    return ConnectionFactory.createConnection(conf);\n+  protected AsyncClusterConnection createConnection(Configuration conf) throws IOException {\n+    return ClusterConnectionFactory.createAsyncClusterConnection(conf,\n+      null, User.getCurrent());\n   }\n \n   protected ReplicationSinkManager createReplicationSinkManager(AsyncClusterConnection conn) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTc3MjMyNQ==", "url": "https://github.com/apache/hbase/pull/1027#discussion_r365772325", "bodyText": "need to format the code", "author": "binlijin", "createdAt": "2020-01-13T12:13:18Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/HBaseInterClusterReplicationEndpoint.java", "diffHunk": "@@ -113,6 +113,14 @@\n   private boolean dropOnDeletedTables;\n   private boolean isSerial = false;\n \n+  protected Connection createConnection(Configuration conf) throws IOException {\n+    return ConnectionFactory.createConnection(conf);\n+  }\n+\n+  protected ReplicationSinkManager createReplicationSinkManager(AsyncClusterConnection conn) {\n+    return new ReplicationSinkManager(conn,this, this.conf);", "originalCommit": "9ac0150d497c91313bd221a5a6d5f9f538723ce0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTc4NTM1OA==", "url": "https://github.com/apache/hbase/pull/1027#discussion_r365785358", "bodyText": "Fixed on last commit.", "author": "wchevreuil", "createdAt": "2020-01-13T12:47:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTc3MjMyNQ=="}], "type": "inlineReview", "revised_code": {"commit": "fe498bbb0b85f7e2476a4c9271be812ba53e2d85", "chunk": "diff --git a/hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/HBaseInterClusterReplicationEndpoint.java b/hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/HBaseInterClusterReplicationEndpoint.java\nindex 002c8ba596..138765ac00 100644\n--- a/hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/HBaseInterClusterReplicationEndpoint.java\n+++ b/hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/HBaseInterClusterReplicationEndpoint.java\n\n@@ -113,8 +113,9 @@ public class HBaseInterClusterReplicationEndpoint extends HBaseReplicationEndpoi\n   private boolean dropOnDeletedTables;\n   private boolean isSerial = false;\n \n-  protected Connection createConnection(Configuration conf) throws IOException {\n-    return ConnectionFactory.createConnection(conf);\n+  protected AsyncClusterConnection createConnection(Configuration conf) throws IOException {\n+    return ClusterConnectionFactory.createAsyncClusterConnection(conf,\n+      null, User.getCurrent());\n   }\n \n   protected ReplicationSinkManager createReplicationSinkManager(AsyncClusterConnection conn) {\n"}}, {"oid": "fe498bbb0b85f7e2476a4c9271be812ba53e2d85", "url": "https://github.com/apache/hbase/commit/fe498bbb0b85f7e2476a4c9271be812ba53e2d85", "message": "HBASE-23683 Make HBaseInterClusterReplicationEndpoint more extensible\nDefines create methods for Connection and ReplicationSinkManager instances.", "committedDate": "2020-01-13T12:43:04Z", "type": "commit"}, {"oid": "fe498bbb0b85f7e2476a4c9271be812ba53e2d85", "url": "https://github.com/apache/hbase/commit/fe498bbb0b85f7e2476a4c9271be812ba53e2d85", "message": "HBASE-23683 Make HBaseInterClusterReplicationEndpoint more extensible\nDefines create methods for Connection and ReplicationSinkManager instances.", "committedDate": "2020-01-13T12:43:04Z", "type": "forcePushed"}, {"oid": "02498b7f182a93dd83134f2e4c07fad14ece3fb8", "url": "https://github.com/apache/hbase/commit/02498b7f182a93dd83134f2e4c07fad14ece3fb8", "message": "fixed spacing\n\nChange-Id: I0fe5b951a58fb6fe08b899a6805b870f1b3b9777", "committedDate": "2020-01-13T12:47:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTk5NDM2Mg==", "url": "https://github.com/apache/hbase/pull/1027#discussion_r365994362", "bodyText": "nit: redundant cast..", "author": "bharathv", "createdAt": "2020-01-13T19:47:08Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/HBaseInterClusterReplicationEndpoint.java", "diffHunk": "@@ -131,13 +140,12 @@ public void init(Context context) throws IOException {\n     // TODO: This connection is replication specific or we should make it particular to\n     // replication and make replication specific settings such as compression or codec to use\n     // passing Cells.\n-    this.conn =\n-      ClusterConnectionFactory.createAsyncClusterConnection(conf, null, User.getCurrent());\n+    this.conn = (AsyncClusterConnection) createConnection(this.conf);", "originalCommit": "02498b7f182a93dd83134f2e4c07fad14ece3fb8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "94a9456847a06cf0ddbcade12285dbd34c6d143d", "chunk": "diff --git a/hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/HBaseInterClusterReplicationEndpoint.java b/hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/HBaseInterClusterReplicationEndpoint.java\nindex 0dbb6513b1..6f1f8b379a 100644\n--- a/hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/HBaseInterClusterReplicationEndpoint.java\n+++ b/hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/HBaseInterClusterReplicationEndpoint.java\n\n@@ -140,7 +150,7 @@ public class HBaseInterClusterReplicationEndpoint extends HBaseReplicationEndpoi\n     // TODO: This connection is replication specific or we should make it particular to\n     // replication and make replication specific settings such as compression or codec to use\n     // passing Cells.\n-    this.conn = (AsyncClusterConnection) createConnection(this.conf);\n+    this.conn = createConnection(this.conf);\n     this.sleepForRetries =\n         this.conf.getLong(\"replication.source.sleepforretries\", 1000);\n     this.metrics = context.getMetrics();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTk5NDY0OA==", "url": "https://github.com/apache/hbase/pull/1027#discussion_r365994648", "bodyText": "nit: Add a quick comment why these exist as protected? Otherwise it can confuse the readers because the only callers in the source are in this class.", "author": "bharathv", "createdAt": "2020-01-13T19:47:48Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/HBaseInterClusterReplicationEndpoint.java", "diffHunk": "@@ -113,6 +113,15 @@\n   private boolean dropOnDeletedTables;\n   private boolean isSerial = false;\n \n+  protected AsyncClusterConnection createConnection(Configuration conf) throws IOException {", "originalCommit": "02498b7f182a93dd83134f2e4c07fad14ece3fb8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "94a9456847a06cf0ddbcade12285dbd34c6d143d", "chunk": "diff --git a/hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/HBaseInterClusterReplicationEndpoint.java b/hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/HBaseInterClusterReplicationEndpoint.java\nindex 0dbb6513b1..6f1f8b379a 100644\n--- a/hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/HBaseInterClusterReplicationEndpoint.java\n+++ b/hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/HBaseInterClusterReplicationEndpoint.java\n\n@@ -113,11 +113,21 @@ public class HBaseInterClusterReplicationEndpoint extends HBaseReplicationEndpoi\n   private boolean dropOnDeletedTables;\n   private boolean isSerial = false;\n \n+  /*\n+   * Some implementations of HBaseInterClusterReplicationEndpoint may require instantiate different\n+   * Connection implementations, or initialize it in a different way, so defining createConnection\n+   * as protected for possible overridings.\n+   */\n   protected AsyncClusterConnection createConnection(Configuration conf) throws IOException {\n     return ClusterConnectionFactory.createAsyncClusterConnection(conf,\n       null, User.getCurrent());\n   }\n \n+  /*\n+   * Some implementations of HBaseInterClusterReplicationEndpoint may require instantiate different\n+   * ReplicationSinkManager implementations, or initialize it in a different way,\n+   * so defining createReplicationSinkManager as protected for possible overridings.\n+   */\n   protected ReplicationSinkManager createReplicationSinkManager(AsyncClusterConnection conn) {\n     return new ReplicationSinkManager(conn, this, this.conf);\n   }\n"}}, {"oid": "94a9456847a06cf0ddbcade12285dbd34c6d143d", "url": "https://github.com/apache/hbase/commit/94a9456847a06cf0ddbcade12285dbd34c6d143d", "message": "Fixing latest round of nit reviews\n\nChange-Id: I156f5cc212666babcc644f24dd35d03634451963", "committedDate": "2020-01-14T13:20:00Z", "type": "commit"}]}