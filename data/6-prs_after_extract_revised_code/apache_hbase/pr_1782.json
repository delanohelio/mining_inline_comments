{"pr_number": 1782, "pr_title": "HBASE-24431 RSGroupInfo add configuration map to store something extra", "pr_createdAt": "2020-05-26T12:01:02Z", "pr_url": "https://github.com/apache/hbase/pull/1782", "timeline": [{"oid": "718af13d71c4850d53e9d66c8bfbb2ce818f5f76", "url": "https://github.com/apache/hbase/commit/718af13d71c4850d53e9d66c8bfbb2ce818f5f76", "message": "HBASE-24431 RSGroupInfo add configuration map to store something extra", "committedDate": "2020-05-29T03:10:20Z", "type": "forcePushed"}, {"oid": "980570e3f5e20d0c9157063a58103b3230c0f86f", "url": "https://github.com/apache/hbase/commit/980570e3f5e20d0c9157063a58103b3230c0f86f", "message": "HBASE-24431 RSGroupInfo add configuration map to store something extra", "committedDate": "2020-05-29T03:14:47Z", "type": "forcePushed"}, {"oid": "b12c1fafedd38b98418b2f7874639401dadeda7f", "url": "https://github.com/apache/hbase/commit/b12c1fafedd38b98418b2f7874639401dadeda7f", "message": "HBASE-24431 RSGroupInfo add configuration map to store something extra", "committedDate": "2020-06-05T11:00:17Z", "type": "forcePushed"}, {"oid": "16eb648a2ab1af6da3b75b9ba7bcba35c8772a6d", "url": "https://github.com/apache/hbase/commit/16eb648a2ab1af6da3b75b9ba7bcba35c8772a6d", "message": "HBASE-24431 RSGroupInfo add configuration map to store something extra", "committedDate": "2020-06-05T11:12:59Z", "type": "forcePushed"}, {"oid": "60b5a79ff5b286f89c4b3ced9e2dd919a3526279", "url": "https://github.com/apache/hbase/commit/60b5a79ff5b286f89c4b3ced9e2dd919a3526279", "message": "HBASE-24431 RSGroupInfo add configuration map to store something extra", "committedDate": "2020-06-08T02:10:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM1OTYyNw==", "url": "https://github.com/apache/hbase/pull/1782#discussion_r442359627", "bodyText": "TableDescriptor and ColumnFamiltyDescriptor have a similar requirement, but provide a richer interface for interacting with their maps. Consider providing similar?", "author": "ndimiduk", "createdAt": "2020-06-18T16:39:00Z", "path": "hbase-common/src/main/java/org/apache/hadoop/hbase/rsgroup/RSGroupInfo.java", "diffHunk": "@@ -114,6 +120,14 @@ public boolean removeServer(Address hostPort) {\n     return servers.remove(hostPort);\n   }\n \n+  public Map<String, String> getConfiguration() {\n+    return configuration;\n+  }\n+\n+  public void setConfiguration(Map<String, String> configuration) {\n+    this.configuration = configuration;\n+  }\n+", "originalCommit": "60b5a79ff5b286f89c4b3ced9e2dd919a3526279", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjYxMzE0Ng==", "url": "https://github.com/apache/hbase/pull/1782#discussion_r442613146", "bodyText": "You're right, it should be replaced with richer interface.I'll do it.", "author": "ddupg", "createdAt": "2020-06-19T03:34:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM1OTYyNw=="}], "type": "inlineReview", "revised_code": {"commit": "4828cf544576dcca3ea80a71517026a92f8b0d31", "chunk": "diff --git a/hbase-common/src/main/java/org/apache/hadoop/hbase/rsgroup/RSGroupInfo.java b/hbase-common/src/main/java/org/apache/hadoop/hbase/rsgroup/RSGroupInfo.java\nindex 01074a4815..d752f8d984 100644\n--- a/hbase-common/src/main/java/org/apache/hadoop/hbase/rsgroup/RSGroupInfo.java\n+++ b/hbase-common/src/main/java/org/apache/hadoop/hbase/rsgroup/RSGroupInfo.java\n\n@@ -120,12 +121,32 @@ public class RSGroupInfo {\n     return servers.remove(hostPort);\n   }\n \n+  /**\n+   * Getter for fetching an unmodifiable {@link #configuration} map.\n+   */\n   public Map<String, String> getConfiguration() {\n-    return configuration;\n+    // shallow pointer copy\n+    return Collections.unmodifiableMap(configuration);\n   }\n \n-  public void setConfiguration(Map<String, String> configuration) {\n-    this.configuration = configuration;\n+  /**\n+   * Setter for storing a configuration setting in {@link #configuration} map.\n+   * @param key Config key.\n+   * @param value String value. If null, removes the setting.\n+   */\n+  public void setConfiguration(String key, String value) {\n+    if (value == null) {\n+      removeConfiguration(key);\n+    } else {\n+      configuration.put(key, value);\n+    }\n+  }\n+\n+  /**\n+   * Remove a config setting represented by the key from the {@link #configuration} map\n+   */\n+  public void removeConfiguration(final String key) {\n+    configuration.remove(key);\n   }\n \n   /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM2MDcyOQ==", "url": "https://github.com/apache/hbase/pull/1782#discussion_r442360729", "bodyText": "Similar question about the interface allowing deeper access to the map.", "author": "ndimiduk", "createdAt": "2020-06-18T16:40:49Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/rsgroup/RSGroupInfoManager.java", "diffHunk": "@@ -114,4 +115,12 @@ static RSGroupInfoManager create(MasterServices master) throws IOException {\n    */\n   void renameRSGroup(String oldName, String newName) throws IOException;\n \n+  /**\n+   * Update RSGroup configuration\n+   * @param groupName the group name\n+   * @param configuration new configuration of the group name to be set\n+   * @throws IOException if a remote or network exception occurs\n+   */\n+  void updateRSGroupConfig(String groupName, Map<String, String> configuration) throws IOException;\n+", "originalCommit": "60b5a79ff5b286f89c4b3ced9e2dd919a3526279", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzEwNzcxMg==", "url": "https://github.com/apache/hbase/pull/1782#discussion_r443107712", "bodyText": "I've changed the methods accessing the map in RSGroupInfo.\n  public Map<String, String> getConfiguration() {\n    return Collections.unmodifiableMap(configuration);\n  }\n  public void setConfiguration(String key, String value) {\n    if (value == null) {\n      removeConfiguration(key);\n    } else {\n      configuration.put(key, value);\n    }\n  }\n  public void removeConfiguration(final String key) {\n    configuration.remove(key);\n  }\n\nand rewrote the impl of RSGroupInfoManagerImpl.updateRSGroupConfig.", "author": "ddupg", "createdAt": "2020-06-20T06:52:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM2MDcyOQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjY1NjgzOQ==", "url": "https://github.com/apache/hbase/pull/1782#discussion_r442656839", "bodyText": "Add one log here? Update from xxx to xxx?", "author": "infraio", "createdAt": "2020-06-19T06:34:37Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/rsgroup/RSGroupInfoManagerImpl.java", "diffHunk": "@@ -1244,4 +1244,11 @@ public synchronized void renameRSGroup(String oldName, String newName) throws IO\n     setRSGroup(updateTables, newName);\n   }\n \n+  @Override\n+  public synchronized void updateRSGroupConfig(String groupName, Map<String, String> configuration)\n+      throws IOException {\n+    RSGroupInfo rsGroupInfo = getRSGroupInfo(groupName);", "originalCommit": "60b5a79ff5b286f89c4b3ced9e2dd919a3526279", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzEwNzMwMg==", "url": "https://github.com/apache/hbase/pull/1782#discussion_r443107302", "bodyText": "Already loged in MaterRpcServices.updateRSGroupConfig like this\nLOG.info(\"{} update rsgroup {} configuration {}\", master.getClientIdAuditPrefix(), groupName,\n        configuration);", "author": "ddupg", "createdAt": "2020-06-20T06:44:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjY1NjgzOQ=="}], "type": "inlineReview", "revised_code": {"commit": "4828cf544576dcca3ea80a71517026a92f8b0d31", "chunk": "diff --git a/hbase-server/src/main/java/org/apache/hadoop/hbase/rsgroup/RSGroupInfoManagerImpl.java b/hbase-server/src/main/java/org/apache/hadoop/hbase/rsgroup/RSGroupInfoManagerImpl.java\nindex faaf001d62..1cb51cf38c 100644\n--- a/hbase-server/src/main/java/org/apache/hadoop/hbase/rsgroup/RSGroupInfoManagerImpl.java\n+++ b/hbase-server/src/main/java/org/apache/hadoop/hbase/rsgroup/RSGroupInfoManagerImpl.java\n\n@@ -1248,7 +1248,8 @@ final class RSGroupInfoManagerImpl implements RSGroupInfoManager {\n   public synchronized void updateRSGroupConfig(String groupName, Map<String, String> configuration)\n       throws IOException {\n     RSGroupInfo rsGroupInfo = getRSGroupInfo(groupName);\n-    rsGroupInfo.setConfiguration(configuration);\n+    rsGroupInfo.getConfiguration().forEach((k, v) -> rsGroupInfo.removeConfiguration(k));\n+    configuration.forEach((k, v) -> rsGroupInfo.setConfiguration(k, v));\n     flushConfig();\n   }\n }\n"}}, {"oid": "4828cf544576dcca3ea80a71517026a92f8b0d31", "url": "https://github.com/apache/hbase/commit/4828cf544576dcca3ea80a71517026a92f8b0d31", "message": "HBASE-24431 RSGroupInfo add configuration map to store something extra", "committedDate": "2020-06-20T06:29:27Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzIwMjUzMQ==", "url": "https://github.com/apache/hbase/pull/1782#discussion_r443202531", "bodyText": "We have a removeConfiguration so let's not allow null value here?", "author": "Apache9", "createdAt": "2020-06-21T09:52:47Z", "path": "hbase-common/src/main/java/org/apache/hadoop/hbase/rsgroup/RSGroupInfo.java", "diffHunk": "@@ -114,6 +121,34 @@ public boolean removeServer(Address hostPort) {\n     return servers.remove(hostPort);\n   }\n \n+  /**\n+   * Getter for fetching an unmodifiable {@link #configuration} map.\n+   */\n+  public Map<String, String> getConfiguration() {\n+    // shallow pointer copy\n+    return Collections.unmodifiableMap(configuration);\n+  }\n+\n+  /**\n+   * Setter for storing a configuration setting in {@link #configuration} map.\n+   * @param key Config key.\n+   * @param value String value. If null, removes the setting.\n+   */\n+  public void setConfiguration(String key, String value) {", "originalCommit": "4828cf544576dcca3ea80a71517026a92f8b0d31", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzIwNDcwMg==", "url": "https://github.com/apache/hbase/pull/1782#discussion_r443204702", "bodyText": "OK", "author": "ddupg", "createdAt": "2020-06-21T10:20:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzIwMjUzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzI4NDI3MQ==", "url": "https://github.com/apache/hbase/pull/1782#discussion_r443284271", "bodyText": "The implementation still accepts null value?", "author": "Apache9", "createdAt": "2020-06-22T01:56:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzIwMjUzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzI4Nzc2NA==", "url": "https://github.com/apache/hbase/pull/1782#discussion_r443287764", "bodyText": "Has thrown a exception when accepts null value, it isn't right? Also add a @NonNull annotation?", "author": "ddupg", "createdAt": "2020-06-22T02:16:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzIwMjUzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzI5MDM2Ng==", "url": "https://github.com/apache/hbase/pull/1782#discussion_r443290366", "bodyText": "Oh, you can just use Objects.requireNonNull. I see there is still a null check so do not look closely the line inside the if...", "author": "Apache9", "createdAt": "2020-06-22T02:30:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzIwMjUzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzMwMjk2OA==", "url": "https://github.com/apache/hbase/pull/1782#discussion_r443302968", "bodyText": "Right, replaced by Objects.requireNonNull.", "author": "ddupg", "createdAt": "2020-06-22T03:40:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzIwMjUzMQ=="}], "type": "inlineReview", "revised_code": {"commit": "9cf0c31897fadbd841e94f3158e7ec16ce9e1cd9", "chunk": "diff --git a/hbase-common/src/main/java/org/apache/hadoop/hbase/rsgroup/RSGroupInfo.java b/hbase-common/src/main/java/org/apache/hadoop/hbase/rsgroup/RSGroupInfo.java\nindex d752f8d984..3b35bc0af9 100644\n--- a/hbase-common/src/main/java/org/apache/hadoop/hbase/rsgroup/RSGroupInfo.java\n+++ b/hbase-common/src/main/java/org/apache/hadoop/hbase/rsgroup/RSGroupInfo.java\n\n@@ -132,11 +132,11 @@ public class RSGroupInfo {\n   /**\n    * Setter for storing a configuration setting in {@link #configuration} map.\n    * @param key Config key.\n-   * @param value String value. If null, removes the setting.\n+   * @param value String value.\n    */\n   public void setConfiguration(String key, String value) {\n     if (value == null) {\n-      removeConfiguration(key);\n+      throw new IllegalArgumentException(\"value is null\");\n     } else {\n       configuration.put(key, value);\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzIwMjUzNw==", "url": "https://github.com/apache/hbase/pull/1782#discussion_r443202537", "bodyText": "final?", "author": "Apache9", "createdAt": "2020-06-21T09:52:55Z", "path": "hbase-common/src/main/java/org/apache/hadoop/hbase/rsgroup/RSGroupInfo.java", "diffHunk": "@@ -46,6 +49,8 @@\n   @Deprecated\n   private final SortedSet<TableName> tables;\n \n+  private Map<String, String> configuration;", "originalCommit": "4828cf544576dcca3ea80a71517026a92f8b0d31", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzIwNDcxMA==", "url": "https://github.com/apache/hbase/pull/1782#discussion_r443204710", "bodyText": "OK", "author": "ddupg", "createdAt": "2020-06-21T10:20:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzIwMjUzNw=="}], "type": "inlineReview", "revised_code": {"commit": "9cf0c31897fadbd841e94f3158e7ec16ce9e1cd9", "chunk": "diff --git a/hbase-common/src/main/java/org/apache/hadoop/hbase/rsgroup/RSGroupInfo.java b/hbase-common/src/main/java/org/apache/hadoop/hbase/rsgroup/RSGroupInfo.java\nindex d752f8d984..3b35bc0af9 100644\n--- a/hbase-common/src/main/java/org/apache/hadoop/hbase/rsgroup/RSGroupInfo.java\n+++ b/hbase-common/src/main/java/org/apache/hadoop/hbase/rsgroup/RSGroupInfo.java\n\n@@ -49,7 +49,7 @@ public class RSGroupInfo {\n   @Deprecated\n   private final SortedSet<TableName> tables;\n \n-  private Map<String, String> configuration;\n+  private final Map<String, String> configuration;\n \n   public RSGroupInfo(String name) {\n     this(name, new TreeSet<Address>(), new TreeSet<TableName>());\n"}}, {"oid": "9cf0c31897fadbd841e94f3158e7ec16ce9e1cd9", "url": "https://github.com/apache/hbase/commit/9cf0c31897fadbd841e94f3158e7ec16ce9e1cd9", "message": "HBASE-24431 RSGroupInfo add configuration map to store something extra", "committedDate": "2020-06-21T10:24:28Z", "type": "forcePushed"}, {"oid": "1553c54c3d5ef9343946dd96e493675ca7039ff8", "url": "https://github.com/apache/hbase/commit/1553c54c3d5ef9343946dd96e493675ca7039ff8", "message": "HBASE-24431 RSGroupInfo add configuration map to store something extra", "committedDate": "2020-06-22T03:37:20Z", "type": "commit"}, {"oid": "1553c54c3d5ef9343946dd96e493675ca7039ff8", "url": "https://github.com/apache/hbase/commit/1553c54c3d5ef9343946dd96e493675ca7039ff8", "message": "HBASE-24431 RSGroupInfo add configuration map to store something extra", "committedDate": "2020-06-22T03:37:20Z", "type": "forcePushed"}]}