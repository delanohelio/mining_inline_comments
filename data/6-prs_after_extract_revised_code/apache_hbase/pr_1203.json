{"pr_number": 1203, "pr_title": "HBASE-23878 : Backport HBASE-22040 to branch-2.1", "pr_createdAt": "2020-02-24T23:39:52Z", "pr_url": "https://github.com/apache/hbase/pull/1203", "timeline": [{"oid": "7e236eca8ab87c1938f0a27d90329d1ad616a0ef", "url": "https://github.com/apache/hbase/commit/7e236eca8ab87c1938f0a27d90329d1ad616a0ef", "message": "HBASE-23878 : Backport HBASE-22040 to branch-2.1\n\nHBASE-22040 - Add mergeRegionsAsync with a List of region names method in AsyncAdmin", "committedDate": "2020-02-24T23:37:24Z", "type": "commit"}, {"oid": "13da56ca9dc1c3f709874b2f1a6543e0137afbc9", "url": "https://github.com/apache/hbase/commit/13da56ca9dc1c3f709874b2f1a6543e0137afbc9", "message": "Fix checkstyle", "committedDate": "2020-02-25T16:51:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU2MDA5Nw==", "url": "https://github.com/apache/hbase/pull/1203#discussion_r384560097", "bodyText": "this version number will need to be updated", "author": "busbey", "createdAt": "2020-02-26T15:18:32Z", "path": "hbase-client/src/main/java/org/apache/hadoop/hbase/client/Admin.java", "diffHunk": "@@ -1282,29 +1282,31 @@ void mergeRegions(byte[] nameOfRegionA, byte[] nameOfRegionB,\n \n   /**\n    * Merge two regions. Asynchronous operation.\n-   *\n    * @param nameOfRegionA encoded or full name of region a\n    * @param nameOfRegionB encoded or full name of region b\n-   * @param forcible <code>true</code> if do a compulsory merge, otherwise we will only merge\n-   *          two adjacent regions\n-   * @throws IOException\n+   * @param forcible <code>true</code> if do a compulsory merge, otherwise we will only merge two\n+   *          adjacent regions\n    */\n-  Future<Void> mergeRegionsAsync(\n-      byte[] nameOfRegionA,\n-      byte[] nameOfRegionB,\n-      boolean forcible) throws IOException;\n+  default Future<Void> mergeRegionsAsync(byte[] nameOfRegionA, byte[] nameOfRegionB,\n+      boolean forcible) throws IOException {\n+    byte[][] nameofRegionsToMerge = new byte[2][];\n+    nameofRegionsToMerge[0] = nameOfRegionA;\n+    nameofRegionsToMerge[1] = nameOfRegionB;\n+    return mergeRegionsAsync(nameofRegionsToMerge, forcible);\n+  }\n \n   /**\n    * Merge regions. Asynchronous operation.\n-   *\n+   * <p/>\n+   * You may get a {@code DoNotRetryIOException} if you pass more than two regions in but the master\n+   * does not support merging more than two regions. At least till 2.2.0, we still only support", "originalCommit": "13da56ca9dc1c3f709874b2f1a6543e0137afbc9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "991f882022e87dce669c0464e0defaab0005b30d", "chunk": "diff --git a/hbase-client/src/main/java/org/apache/hadoop/hbase/client/Admin.java b/hbase-client/src/main/java/org/apache/hadoop/hbase/client/Admin.java\nindex 66912bfbac..221935a42a 100644\n--- a/hbase-client/src/main/java/org/apache/hadoop/hbase/client/Admin.java\n+++ b/hbase-client/src/main/java/org/apache/hadoop/hbase/client/Admin.java\n\n@@ -1299,7 +1299,7 @@ public interface Admin extends Abortable, Closeable {\n    * Merge regions. Asynchronous operation.\n    * <p/>\n    * You may get a {@code DoNotRetryIOException} if you pass more than two regions in but the master\n-   * does not support merging more than two regions. At least till 2.2.0, we still only support\n+   * does not support merging more than two regions. At least till 2.1.10, we still only support\n    * merging two regions.\n    * @param nameofRegionsToMerge encoded or full name of daughter regions\n    * @param forcible <code>true</code> if do a compulsory merge, otherwise we will only merge\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU2NTA5MQ==", "url": "https://github.com/apache/hbase/pull/1203#discussion_r384565091", "bodyText": "this version number will need to be updated", "author": "busbey", "createdAt": "2020-02-26T15:25:30Z", "path": "hbase-client/src/main/java/org/apache/hadoop/hbase/client/AsyncAdmin.java", "diffHunk": "@@ -474,8 +475,22 @@\n    * @param forcible true if do a compulsory merge, otherwise we will only merge two adjacent\n    *          regions\n    */\n-  CompletableFuture<Void> mergeRegions(byte[] nameOfRegionA, byte[] nameOfRegionB,\n-      boolean forcible);\n+  default CompletableFuture<Void> mergeRegions(byte[] nameOfRegionA, byte[] nameOfRegionB,\n+      boolean forcible) {\n+    return mergeRegions(Arrays.asList(nameOfRegionA, nameOfRegionB), forcible);\n+  }\n+\n+  /**\n+   * Merge regions.\n+   * <p/>\n+   * You may get a {@code DoNotRetryIOException} if you pass more than two regions in but the master\n+   * does not support merging more than two regions. At least till 2.2.0, we still only support", "originalCommit": "13da56ca9dc1c3f709874b2f1a6543e0137afbc9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "991f882022e87dce669c0464e0defaab0005b30d", "chunk": "diff --git a/hbase-client/src/main/java/org/apache/hadoop/hbase/client/AsyncAdmin.java b/hbase-client/src/main/java/org/apache/hadoop/hbase/client/AsyncAdmin.java\nindex a66979058c..31e96e0cf3 100644\n--- a/hbase-client/src/main/java/org/apache/hadoop/hbase/client/AsyncAdmin.java\n+++ b/hbase-client/src/main/java/org/apache/hadoop/hbase/client/AsyncAdmin.java\n\n@@ -484,7 +484,7 @@ public interface AsyncAdmin {\n    * Merge regions.\n    * <p/>\n    * You may get a {@code DoNotRetryIOException} if you pass more than two regions in but the master\n-   * does not support merging more than two regions. At least till 2.2.0, we still only support\n+   * does not support merging more than two regions. At least till 2.1.10, we still only support\n    * merging two regions.\n    * @param nameOfRegionsToMerge encoded or full name of daughter regions\n    * @param forcible true if do a compulsory merge, otherwise we will only merge two adjacent\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU2NzA4NA==", "url": "https://github.com/apache/hbase/pull/1203#discussion_r384567084", "bodyText": "just to confirm my understanding, we're doing this ourselves instead of using Preconditions because guava doesn't have a version of Preconditions that will return a future?", "author": "busbey", "createdAt": "2020-02-26T15:28:04Z", "path": "hbase-client/src/main/java/org/apache/hadoop/hbase/client/RawAsyncHBaseAdmin.java", "diffHunk": "@@ -1185,41 +1184,41 @@ private void checkAndGetTableName(byte[] encodeRegionName, AtomicReference<Table\n   }\n \n   @Override\n-  public CompletableFuture<Void> mergeRegions(byte[] nameOfRegionA, byte[] nameOfRegionB,\n-      boolean forcible) {\n+  public CompletableFuture<Void> mergeRegions(List<byte[]> nameOfRegionsToMerge, boolean forcible) {\n+    if (nameOfRegionsToMerge.size() < 2) {", "originalCommit": "13da56ca9dc1c3f709874b2f1a6543e0137afbc9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTAxNzQ5Nw==", "url": "https://github.com/apache/hbase/pull/1203#discussion_r385017497", "bodyText": "I would think so too. Preconditions doesn't seem to have the capability to return a future object that we would need for these functions.", "author": "jatsakthi", "createdAt": "2020-02-27T09:50:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU2NzA4NA=="}], "type": "inlineReview", "revised_code": {"commit": "991f882022e87dce669c0464e0defaab0005b30d", "chunk": "diff --git a/hbase-client/src/main/java/org/apache/hadoop/hbase/client/RawAsyncHBaseAdmin.java b/hbase-client/src/main/java/org/apache/hadoop/hbase/client/RawAsyncHBaseAdmin.java\nindex 685a4fb1db..050e3d237e 100644\n--- a/hbase-client/src/main/java/org/apache/hadoop/hbase/client/RawAsyncHBaseAdmin.java\n+++ b/hbase-client/src/main/java/org/apache/hadoop/hbase/client/RawAsyncHBaseAdmin.java\n\n@@ -1208,17 +1208,18 @@ class RawAsyncHBaseAdmin implements AsyncAdmin {\n         return;\n       }\n \n-      addListener(this.<MergeTableRegionsRequest, MergeTableRegionsResponse>procedureCall(request,\n+      addListener(\n+        this.<MergeTableRegionsRequest, MergeTableRegionsResponse> procedureCall(request,\n           (s, c, req, done) -> s.mergeTableRegions(c, req, done), (resp) -> resp.getProcId(),\n-          new MergeTableRegionProcedureBiConsumer(tableName)), (ret, err2) -> {\n-        if (err2 != null) {\n-          future.completeExceptionally(err2);\n-        } else {\n-          future.complete(ret);\n-        }\n-      });\n+          new MergeTableRegionProcedureBiConsumer(tableName)),\n+        (ret, err2) -> {\n+          if (err2 != null) {\n+            future.completeExceptionally(err2);\n+          } else {\n+            future.complete(ret);\n+          }\n+        });\n     });\n-\n     return future;\n   }\n \n"}}, {"oid": "991f882022e87dce669c0464e0defaab0005b30d", "url": "https://github.com/apache/hbase/commit/991f882022e87dce669c0464e0defaab0005b30d", "message": "Fix checkstyle and versions", "committedDate": "2020-02-27T10:03:50Z", "type": "commit"}, {"oid": "991f882022e87dce669c0464e0defaab0005b30d", "url": "https://github.com/apache/hbase/commit/991f882022e87dce669c0464e0defaab0005b30d", "message": "Fix checkstyle and versions", "committedDate": "2020-02-27T10:03:50Z", "type": "forcePushed"}]}