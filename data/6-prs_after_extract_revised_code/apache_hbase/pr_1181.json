{"pr_number": 1181, "pr_title": "HBASE-23862 Fix flaky TestSnapshotFromMaster in 1.x versions", "pr_createdAt": "2020-02-18T07:01:05Z", "pr_url": "https://github.com/apache/hbase/pull/1181", "timeline": [{"oid": "3fb45e0e9c45271c4c2824b24514bf1b5c2c6d36", "url": "https://github.com/apache/hbase/commit/3fb45e0e9c45271c4c2824b24514bf1b5c2c6d36", "message": "HBASE-23658 Fix flaky TestSnapshotFromMaster (#998)\n\nSigned-off-by: Duo Zhang <zhangduo@apache.org>\n(cherry picked from commit e750d2c7af03bfcb85422077cf59ab4b1815cb12)", "committedDate": "2020-02-18T06:56:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDQ4OTYzMw==", "url": "https://github.com/apache/hbase/pull/1181#discussion_r380489633", "bodyText": "UTIL.waitFor(30000, () -> !master.getSnapshotManager().isTakingAnySnapshot());?", "author": "infraio", "createdAt": "2020-02-18T07:04:38Z", "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/master/cleaner/TestSnapshotFromMaster.java", "diffHunk": "@@ -530,8 +530,11 @@ public boolean evaluate() throws Exception {\n         return UTIL.getHBaseAdmin().listSnapshots(Pattern.compile(snapshotName)).size() == 1;\n       }\n     });\n-    assertTrue(master.getSnapshotManager().isTakingAnySnapshot());\n-    Thread.sleep(11 * 1000L);\n-    assertFalse(master.getSnapshotManager().isTakingAnySnapshot());\n+    UTIL.waitFor(30000, new Predicate<Exception>() {\n+      @Override\n+      public boolean evaluate() throws Exception {\n+        return UTIL.getHBaseAdmin().listSnapshots(Pattern.compile(snapshotName)).size() == 1;", "originalCommit": "3fb45e0e9c45271c4c2824b24514bf1b5c2c6d36", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9b39ec33dcb8da8df5e305bbece4fc8eaa47dfeb", "chunk": "diff --git a/hbase-server/src/test/java/org/apache/hadoop/hbase/master/cleaner/TestSnapshotFromMaster.java b/hbase-server/src/test/java/org/apache/hadoop/hbase/master/cleaner/TestSnapshotFromMaster.java\nindex b1ca65dc90..049f37d7f0 100644\n--- a/hbase-server/src/test/java/org/apache/hadoop/hbase/master/cleaner/TestSnapshotFromMaster.java\n+++ b/hbase-server/src/test/java/org/apache/hadoop/hbase/master/cleaner/TestSnapshotFromMaster.java\n\n@@ -533,7 +533,7 @@ public class TestSnapshotFromMaster {\n     UTIL.waitFor(30000, new Predicate<Exception>() {\n       @Override\n       public boolean evaluate() throws Exception {\n-        return UTIL.getHBaseAdmin().listSnapshots(Pattern.compile(snapshotName)).size() == 1;\n+        return master.getSnapshotManager().isTakingAnySnapshot();\n       }\n     });\n   }\n"}}, {"oid": "9b39ec33dcb8da8df5e305bbece4fc8eaa47dfeb", "url": "https://github.com/apache/hbase/commit/9b39ec33dcb8da8df5e305bbece4fc8eaa47dfeb", "message": "Fix the predicate", "committedDate": "2020-02-18T07:23:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTY1NTgzOA==", "url": "https://github.com/apache/hbase/pull/1181#discussion_r381655838", "bodyText": "Should add a \"!\" here? It is assertFalse before.", "author": "infraio", "createdAt": "2020-02-20T01:44:27Z", "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/master/cleaner/TestSnapshotFromMaster.java", "diffHunk": "@@ -530,8 +530,11 @@ public boolean evaluate() throws Exception {\n         return UTIL.getHBaseAdmin().listSnapshots(Pattern.compile(snapshotName)).size() == 1;\n       }\n     });\n-    assertTrue(master.getSnapshotManager().isTakingAnySnapshot());\n-    Thread.sleep(11 * 1000L);\n-    assertFalse(master.getSnapshotManager().isTakingAnySnapshot());\n+    UTIL.waitFor(30000, new Predicate<Exception>() {\n+      @Override\n+      public boolean evaluate() throws Exception {\n+        return master.getSnapshotManager().isTakingAnySnapshot();", "originalCommit": "9b39ec33dcb8da8df5e305bbece4fc8eaa47dfeb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTY3MTg0Ng==", "url": "https://github.com/apache/hbase/pull/1181#discussion_r381671846", "bodyText": "Oh right! My bad. Overlooked the condition.", "author": "jatsakthi", "createdAt": "2020-02-20T02:13:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTY1NTgzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTcwNjg4MA==", "url": "https://github.com/apache/hbase/pull/1181#discussion_r381706880", "bodyText": "Corrected.", "author": "jatsakthi", "createdAt": "2020-02-20T03:20:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTY1NTgzOA=="}], "type": "inlineReview", "revised_code": {"commit": "45886abf8e5ed7b30d4c349837d079c463bad2da", "chunk": "diff --git a/hbase-server/src/test/java/org/apache/hadoop/hbase/master/cleaner/TestSnapshotFromMaster.java b/hbase-server/src/test/java/org/apache/hadoop/hbase/master/cleaner/TestSnapshotFromMaster.java\nindex 049f37d7f0..fa97a0321f 100644\n--- a/hbase-server/src/test/java/org/apache/hadoop/hbase/master/cleaner/TestSnapshotFromMaster.java\n+++ b/hbase-server/src/test/java/org/apache/hadoop/hbase/master/cleaner/TestSnapshotFromMaster.java\n\n@@ -533,7 +533,7 @@ public class TestSnapshotFromMaster {\n     UTIL.waitFor(30000, new Predicate<Exception>() {\n       @Override\n       public boolean evaluate() throws Exception {\n-        return master.getSnapshotManager().isTakingAnySnapshot();\n+        return !master.getSnapshotManager().isTakingAnySnapshot();\n       }\n     });\n   }\n"}}, {"oid": "45886abf8e5ed7b30d4c349837d079c463bad2da", "url": "https://github.com/apache/hbase/commit/45886abf8e5ed7b30d4c349837d079c463bad2da", "message": "Fix the evaluate condition", "committedDate": "2020-02-20T03:18:51Z", "type": "commit"}]}