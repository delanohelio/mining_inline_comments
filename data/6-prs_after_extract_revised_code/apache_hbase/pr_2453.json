{"pr_number": 2453, "pr_title": "HBASE-24813 ReplicationSource should clear buffer usage on Replicatio\u2026", "pr_createdAt": "2020-09-24T10:29:49Z", "pr_url": "https://github.com/apache/hbase/pull/2453", "timeline": [{"oid": "cc195a6d512efbdee76f68eb70e145e97949295f", "url": "https://github.com/apache/hbase/commit/cc195a6d512efbdee76f68eb70e145e97949295f", "message": "HBASE-24813 ReplicationSource should clear buffer usage on ReplicationSourceManager upon termination", "committedDate": "2020-09-24T10:26:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzA0OTM3Mw==", "url": "https://github.com/apache/hbase/pull/2453#discussion_r497049373", "bodyText": "this should be using the environment to get the time I think? or is there not one accessible from here?", "author": "busbey", "createdAt": "2020-09-29T20:55:21Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSourceShipper.java", "diffHunk": "@@ -331,4 +333,53 @@ public boolean sleepForRetries(String msg, int sleepMultiplier) {\n     }\n     return sleepMultiplier < maxRetriesMultiplier;\n   }\n+\n+  /**\n+   * Attempts to properly update <code>ReplicationSourceManager.totalBufferUser</code>,\n+   * in case there were unprocessed entries batched by the reader to the shipper,\n+   * but the shipper didn't manage to ship those because the replication source is being terminated.\n+   * In that case, it iterates through the batched entries and decrease the pending\n+   * entries size from <code>ReplicationSourceManager.totalBufferUser</code>\n+   * <p/>\n+   * <b>NOTES</b>\n+   * 1) This method should only be called upon replication source termination.\n+   * It blocks waiting for both shipper and reader threads termination,\n+   * to make sure no race conditions\n+   * when updating <code>ReplicationSourceManager.totalBufferUser</code>.\n+   *\n+   * 2) It <b>does not</b> attempt to terminate reader and shipper threads. Those <b>must</b>\n+   * have been triggered interruption/termination prior to calling this method.\n+   */\n+  void clearWALEntryBatch() {\n+    long timeout = System.currentTimeMillis() + this.shipEditsTimeout;", "originalCommit": "cc195a6d512efbdee76f68eb70e145e97949295f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "7b7d80f2b9d6fd32bdba3ef4964a3bd4da815ddd", "chunk": "diff --git a/hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSourceShipper.java b/hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSourceShipper.java\nindex 827452fa69..5d56ec2b7a 100644\n--- a/hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSourceShipper.java\n+++ b/hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSourceShipper.java\n\n@@ -351,7 +353,7 @@ public class ReplicationSourceShipper extends Thread {\n    * have been triggered interruption/termination prior to calling this method.\n    */\n   void clearWALEntryBatch() {\n-    long timeout = System.currentTimeMillis() + this.shipEditsTimeout;\n+    long timeout = EnvironmentEdgeManager.currentTime() + this.shipEditsTimeout;\n     while(this.isAlive() || this.entryReader.isAlive()){\n       try {\n         if (System.currentTimeMillis() >= timeout) {\n"}}, {"oid": "7b7d80f2b9d6fd32bdba3ef4964a3bd4da815ddd", "url": "https://github.com/apache/hbase/commit/7b7d80f2b9d6fd32bdba3ef4964a3bd4da815ddd", "message": "Addressing latest suggestion from Sean", "committedDate": "2020-09-30T15:21:59Z", "type": "commit"}, {"oid": "2114d2698b7a2dc99a0f3e84497c83cdff4e5f35", "url": "https://github.com/apache/hbase/commit/2114d2698b7a2dc99a0f3e84497c83cdff4e5f35", "message": "Checkstyle", "committedDate": "2020-09-30T16:29:48Z", "type": "commit"}]}