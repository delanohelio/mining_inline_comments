{"pr_number": 1287, "pr_title": "HBASE-23983 Fixed Spotbugs complaint in RegionStates related to ignored return value", "pr_createdAt": "2020-03-14T00:37:23Z", "pr_url": "https://github.com/apache/hbase/pull/1287", "timeline": [{"oid": "802cd49896d1181fa8edd805eadb9068d2bc157f", "url": "https://github.com/apache/hbase/commit/802cd49896d1181fa8edd805eadb9068d2bc157f", "message": "HBASE-23983 Fixed Spotbugs complaint in RegionStates related to ignored return value", "committedDate": "2020-03-14T00:15:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU0NTA3NQ==", "url": "https://github.com/apache/hbase/pull/1287#discussion_r392545075", "bodyText": "This is not correct, if there is no value yet putIfAbsent will returns null...\nAnd here I think we could add an assert, that putIfAbsent should always return null, and then return the node above.", "author": "Apache9", "createdAt": "2020-03-14T01:35:45Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/assignment/RegionStates.java", "diffHunk": "@@ -130,8 +130,7 @@ RegionStateNode createRegionStateNode(RegionInfo regionInfo) {\n     synchronized (regionsMapLock) {\n       RegionStateNode node = regionsMap.computeIfAbsent(regionInfo.getRegionName(),\n         key -> new RegionStateNode(regionInfo, regionInTransition));\n-      encodedRegionsMap.putIfAbsent(regionInfo.getEncodedName(), node);\n-      return node;\n+      return encodedRegionsMap.putIfAbsent(regionInfo.getEncodedName(), node);", "originalCommit": "802cd49896d1181fa8edd805eadb9068d2bc157f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDc0NTg5NA==", "url": "https://github.com/apache/hbase/pull/1287#discussion_r394745894", "bodyText": "How about using put rather than putIfAbsent?\nBecause the value of encodedRegionsMap must always be the same as the valuesMap.\nI used putIfAbsent because I didn't want to put it all the time when encodedRegionsMap already had a value.\nI think compare the value of encodedRegionsMap and node and it to put only when different.\nRegionStateNode node = regionsMap.computeIfAbsent(regionInfo.getRegionName(),\n  key -> new RegionStateNode(regionInfo, regionInTransition));\nif (encodedRegionsMap.get(regionInfo.getEncodedName()) != node) {\n  encodedRegionsMap.put(regionInfo.getEncodedName(), node);\n}\nreturn node;\nI'm sorry to bother you.", "author": "mwkang", "createdAt": "2020-03-19T01:47:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU0NTA3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk4MDA2NA==", "url": "https://github.com/apache/hbase/pull/1287#discussion_r395980064", "bodyText": "I'm fine with using put, as there is a lock here...", "author": "Apache9", "createdAt": "2020-03-21T10:10:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU0NTA3NQ=="}], "type": "inlineReview", "revised_code": {"commit": "8713712012b8f02b67abd6490f3b636133062b1e", "chunk": "diff --git a/hbase-server/src/main/java/org/apache/hadoop/hbase/master/assignment/RegionStates.java b/hbase-server/src/main/java/org/apache/hadoop/hbase/master/assignment/RegionStates.java\nindex ce8afefed7..95c52cf093 100644\n--- a/hbase-server/src/main/java/org/apache/hadoop/hbase/master/assignment/RegionStates.java\n+++ b/hbase-server/src/main/java/org/apache/hadoop/hbase/master/assignment/RegionStates.java\n\n@@ -130,7 +130,12 @@ public class RegionStates {\n     synchronized (regionsMapLock) {\n       RegionStateNode node = regionsMap.computeIfAbsent(regionInfo.getRegionName(),\n         key -> new RegionStateNode(regionInfo, regionInTransition));\n-      return encodedRegionsMap.putIfAbsent(regionInfo.getEncodedName(), node);\n+\n+      if (encodedRegionsMap.get(regionInfo.getEncodedName()) != node) {\n+        encodedRegionsMap.put(regionInfo.getEncodedName(), node);\n+      }\n+\n+      return node;\n     }\n   }\n \n"}}, {"oid": "8713712012b8f02b67abd6490f3b636133062b1e", "url": "https://github.com/apache/hbase/commit/8713712012b8f02b67abd6490f3b636133062b1e", "message": "HBASE-23983 Incorporated PR feedback", "committedDate": "2020-03-22T17:47:54Z", "type": "commit"}]}