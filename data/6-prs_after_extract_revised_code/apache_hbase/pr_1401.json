{"pr_number": 1401, "pr_title": "HBASE-24075: Fix a race between master shutdown and metrics (re)init", "pr_createdAt": "2020-03-31T23:52:31Z", "pr_url": "https://github.com/apache/hbase/pull/1401", "timeline": [{"oid": "211b4bfbf91d78baed0eb4e83375a8d6fa6e89a3", "url": "https://github.com/apache/hbase/commit/211b4bfbf91d78baed0eb4e83375a8d6fa6e89a3", "message": "HBASE-24075: Fix a race between master shutdown and metrics (re)init\n\nJMXCacheBuster resets the metrics state at various points in time. These\nevents can potentially race with a master shutdown. When the master is\ntearing down, metrics initialization can touch a lot of unsafe state,\nfor example invalidated FS objects. To avoid this, this patch makes\nthe getMetrics() a no-op when the master is either stopped or in the\nprocess of shutting down. Additionally, getClusterId() when the server\nis shutting down is made a no-op.\n\nSimulating a test for this is a bit tricky but with the patch I don't\nlocally see the long stacktraces from the jira.\n\nSigned-off-by: Michael Stack <stack@apache.org>\n(cherry picked from commit 6f213e9d5a15afcc40b6562ab4898f913cec91eb)", "committedDate": "2020-03-31T23:48:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTM1NzQxNw==", "url": "https://github.com/apache/hbase/pull/1401#discussion_r401357417", "bodyText": "Great", "author": "saintstack", "createdAt": "2020-04-01T05:03:36Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/CachedClusterId.java", "diffHunk": "@@ -130,9 +134,12 @@ private void waitForFetchToFinish() throws InterruptedException {\n    * trying get from a clean cache.\n    *\n    * @return ClusterId by reading from FileSystem or null in any error case or cluster ID does\n-   *     not exist on the file system.\n+   *     not exist on the file system or if the server initiated a tear down.\n    */\n   public String getFromCacheOrFetch() {\n+    if (server.isStopping() || server.isStopped()) {", "originalCommit": "211b4bfbf91d78baed0eb4e83375a8d6fa6e89a3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTM1NzQ5OQ==", "url": "https://github.com/apache/hbase/pull/1401#discussion_r401357499", "bodyText": "isStopped is probably enough but this is fine.", "author": "saintstack", "createdAt": "2020-04-01T05:03:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTM1NzQxNw=="}], "type": "inlineReview", "revised_code": null}]}