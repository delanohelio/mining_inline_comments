{"pr_number": 1623, "pr_title": "HBASE-24302 Add an \"ignoreTimestamps\" option (defaulted to false) to \u2026", "pr_createdAt": "2020-05-01T18:56:58Z", "pr_url": "https://github.com/apache/hbase/pull/1623", "timeline": [{"oid": "1458027bdae381512c26d5d367a6715c9a6ae9c4", "url": "https://github.com/apache/hbase/commit/1458027bdae381512c26d5d367a6715c9a6ae9c4", "message": "HBASE-24302 Add an \"ignoreTimestamps\" option (defaulted to false) to HashTable/SyncTable tool\n\nChange-Id: Ifa886710189e5c1dd7b470c1df0119abf76eef30", "committedDate": "2020-05-01T18:51:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODcxMjgwNA==", "url": "https://github.com/apache/hbase/pull/1623#discussion_r418712804", "bodyText": "If you make timestamps a Pair, that would make this a little more terse (avoid the ability for the caller to give you a single timestamp, or three timestamps)", "author": "joshelser", "createdAt": "2020-05-01T20:01:12Z", "path": "hbase-mapreduce/src/test/java/org/apache/hadoop/hbase/mapreduce/TestSyncTable.java", "diffHunk": "@@ -463,26 +490,28 @@ private void writeTestData(TableName sourceTableName, TableName targetTableName)\n     int numRows = 100;\n     int sourceRegions = 10;\n     int targetRegions = 6;\n+    if (ArrayUtils.isEmpty(timestamps)) {", "originalCommit": "1458027bdae381512c26d5d367a6715c9a6ae9c4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODkzMzM5OA==", "url": "https://github.com/apache/hbase/pull/1623#discussion_r418933398", "bodyText": "Decided to use varargs so that I didn't need to change other existing methods already calling writeTestData.", "author": "wchevreuil", "createdAt": "2020-05-02T08:56:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODcxMjgwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTE0NDYzNw==", "url": "https://github.com/apache/hbase/pull/1623#discussion_r419144637", "bodyText": "Ok, sounds good.", "author": "joshelser", "createdAt": "2020-05-03T18:58:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODcxMjgwNA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "2fb5893a4613251b381c873b8e7d50f31e7d974b", "url": "https://github.com/apache/hbase/commit/2fb5893a4613251b381c873b8e7d50f31e7d974b", "message": "Added ignoreTimestamp options description to HashTable print instructions\n\nChange-Id: I68ee6dc9cb9128ba03377db0dc884560d14ccae2", "committedDate": "2020-05-02T09:12:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTA5OTQ3Mg==", "url": "https://github.com/apache/hbase/pull/1623#discussion_r419099472", "bodyText": "NIT, add spaces around the plus.", "author": "HorizonNet", "createdAt": "2020-05-03T12:52:11Z", "path": "hbase-mapreduce/src/test/java/org/apache/hadoop/hbase/mapreduce/TestSyncTable.java", "diffHunk": "@@ -426,18 +451,19 @@ private Counters syncTables(TableName sourceTableName, TableName targetTableName\n     return syncTable.counters;\n   }\n \n-  private void hashSourceTable(TableName sourceTableName, Path testDir) throws Exception {\n+  private void hashSourceTable(TableName sourceTableName, Path testDir, String... options)\n+      throws Exception {\n     int numHashFiles = 3;\n     long batchSize = 100;  // should be 2 batches per region\n     int scanBatch = 1;\n     HashTable hashTable = new HashTable(TEST_UTIL.getConfiguration());\n-    int code = hashTable.run(new String[] {\n-      \"--batchsize=\" + batchSize,\n-      \"--numhashfiles=\" + numHashFiles,\n-      \"--scanbatch=\" + scanBatch,\n-      sourceTableName.getNameAsString(),\n-      testDir.toString()\n-    });\n+    String[] args = Arrays.copyOf(options, options.length+5);\n+    args[options.length] = \"--batchsize=\" + batchSize;\n+    args[options.length+1] = \"--numhashfiles=\" + numHashFiles;", "originalCommit": "2fb5893a4613251b381c873b8e7d50f31e7d974b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTEwNTU5Ng==", "url": "https://github.com/apache/hbase/pull/1623#discussion_r419105596", "bodyText": "Indeed, fixed on latest commit.", "author": "wchevreuil", "createdAt": "2020-05-03T13:42:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTA5OTQ3Mg=="}], "type": "inlineReview", "revised_code": {"commit": "3e43c2f6bec57d0b44180efeea8be74d3df03171", "chunk": "diff --git a/hbase-mapreduce/src/test/java/org/apache/hadoop/hbase/mapreduce/TestSyncTable.java b/hbase-mapreduce/src/test/java/org/apache/hadoop/hbase/mapreduce/TestSyncTable.java\nindex 369c4cf8e3..9d5bae0d9f 100644\n--- a/hbase-mapreduce/src/test/java/org/apache/hadoop/hbase/mapreduce/TestSyncTable.java\n+++ b/hbase-mapreduce/src/test/java/org/apache/hadoop/hbase/mapreduce/TestSyncTable.java\n\n@@ -459,10 +459,10 @@ public class TestSyncTable {\n     HashTable hashTable = new HashTable(TEST_UTIL.getConfiguration());\n     String[] args = Arrays.copyOf(options, options.length+5);\n     args[options.length] = \"--batchsize=\" + batchSize;\n-    args[options.length+1] = \"--numhashfiles=\" + numHashFiles;\n-    args[options.length+2] = \"--scanbatch=\" + scanBatch;\n-    args[options.length+3] = sourceTableName.getNameAsString();\n-    args[options.length+4] = testDir.toString();\n+    args[options.length + 1] = \"--numhashfiles=\" + numHashFiles;\n+    args[options.length + 2] = \"--scanbatch=\" + scanBatch;\n+    args[options.length + 3] = sourceTableName.getNameAsString();\n+    args[options.length + 4] = testDir.toString();\n     int code = hashTable.run(args);\n     assertEquals(\"hash table job failed\", 0, code);\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTA5OTYwMQ==", "url": "https://github.com/apache/hbase/pull/1623#discussion_r419099601", "bodyText": "Seems to duplicate the if-branch above. Could be moved into a separate method.", "author": "HorizonNet", "createdAt": "2020-05-03T12:53:16Z", "path": "hbase-mapreduce/src/main/java/org/apache/hadoop/hbase/mapreduce/SyncTable.java", "diffHunk": "@@ -546,6 +567,19 @@ private boolean syncRowCells(Context context, byte[] rowKey, CellScanner sourceC\n               if (put == null) {\n                 put = new Put(rowKey);\n               }\n+              if (ignoreTimestamp) {", "originalCommit": "2fb5893a4613251b381c873b8e7d50f31e7d974b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTEwNTU3Mw==", "url": "https://github.com/apache/hbase/pull/1623#discussion_r419105573", "bodyText": "Indeed, fixed on latest commit.", "author": "wchevreuil", "createdAt": "2020-05-03T13:41:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTA5OTYwMQ=="}], "type": "inlineReview", "revised_code": {"commit": "3e43c2f6bec57d0b44180efeea8be74d3df03171", "chunk": "diff --git a/hbase-mapreduce/src/main/java/org/apache/hadoop/hbase/mapreduce/SyncTable.java b/hbase-mapreduce/src/main/java/org/apache/hadoop/hbase/mapreduce/SyncTable.java\nindex 9c329fd463..fff6620c55 100644\n--- a/hbase-mapreduce/src/main/java/org/apache/hadoop/hbase/mapreduce/SyncTable.java\n+++ b/hbase-mapreduce/src/main/java/org/apache/hadoop/hbase/mapreduce/SyncTable.java\n\n@@ -567,19 +572,7 @@ public class SyncTable extends Configured implements Tool {\n               if (put == null) {\n                 put = new Put(rowKey);\n               }\n-              if (ignoreTimestamp) {\n-                sourceCell = CellBuilderFactory.create(CellBuilderType.SHALLOW_COPY)\n-                  .setType(sourceCell.getType())\n-                  .setRow(sourceCell.getRowArray(),\n-                    sourceCell.getRowOffset(), sourceCell.getRowLength())\n-                  .setFamily(sourceCell.getFamilyArray(),\n-                    sourceCell.getFamilyOffset(), sourceCell.getFamilyLength())\n-                  .setQualifier(sourceCell.getQualifierArray(),\n-                    sourceCell.getQualifierOffset(), sourceCell.getQualifierLength())\n-                  .setTimestamp(System.currentTimeMillis())\n-                  .setValue(sourceCell.getValueArray(),\n-                    sourceCell.getValueOffset(), sourceCell.getValueLength()).build();\n-              }\n+              sourceCell = checkAndResetTimestamp(sourceCell);\n               put.add(sourceCell);\n             }\n           }\n"}}, {"oid": "3e43c2f6bec57d0b44180efeea8be74d3df03171", "url": "https://github.com/apache/hbase/commit/3e43c2f6bec57d0b44180efeea8be74d3df03171", "message": "addressing Jan's remarks\n\nChange-Id: Ibef3af7df61e1b53a4116b11ef1e29778302bf9a", "committedDate": "2020-05-03T13:40:58Z", "type": "commit"}]}