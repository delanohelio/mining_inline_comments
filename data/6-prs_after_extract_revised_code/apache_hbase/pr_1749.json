{"pr_number": 1749, "pr_title": "HBASE-24367 ScheduledChore log elapsed timespan in a human-friendly format", "pr_createdAt": "2020-05-20T20:54:54Z", "pr_url": "https://github.com/apache/hbase/pull/1749", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM5MDMzNw==", "url": "https://github.com/apache/hbase/pull/1749#discussion_r428390337", "bodyText": "log the start time, too? If the debug was enabled between execution, may get a wrong execution time?", "author": "infraio", "createdAt": "2020-05-21T01:03:07Z", "path": "hbase-common/src/main/java/org/apache/hadoop/hbase/ScheduledChore.java", "diffHunk": "@@ -183,18 +176,21 @@ public void run() {\n       if (LOG.isInfoEnabled()) LOG.info(\"Chore: \" + getName() + \" was stopped\");\n     } else {\n       try {\n+        // TODO: Histogram metrics per chore name.\n+        // For now, just measure and log if DEBUG level logging is enabled.\n+        long start = 0;\n+        if (LOG.isDebugEnabled()) {\n+          start = System.nanoTime();\n+        }\n         if (!initialChoreComplete) {\n           initialChoreComplete = initialChore();\n         } else {\n-          timeMeasurement.measure(() -> {\n             chore();\n-            return null;\n-          });\n-          if (LOG.isInfoEnabled() && (System.nanoTime() - lastLog > FIVE_MINUTES_IN_NANOS)) {\n-            LOG.info(\"{} average execution time: {} ns.\", getName(),\n-                (long)(timeMeasurement.getAverageTime()));\n-            lastLog = System.nanoTime();\n-          }\n+        }\n+        if (LOG.isDebugEnabled()) {\n+          long end = System.nanoTime();\n+          LOG.debug(\"{} execution time: {} ms.\", getName(),", "originalCommit": "068b54cae428b01f9e214e6ea66a0c0bc5a5ec75", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQxODM4Mg==", "url": "https://github.com/apache/hbase/pull/1749#discussion_r429418382", "bodyText": "Oh, fun edge case @infraio :) How about a check that start > 0 and only log in that case?", "author": "ndimiduk", "createdAt": "2020-05-22T19:22:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM5MDMzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQ1MjU2MA==", "url": "https://github.com/apache/hbase/pull/1749#discussion_r429452560", "bodyText": "Yes we can do that. Will update", "author": "apurtell", "createdAt": "2020-05-22T21:10:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM5MDMzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU2Mjg1NA==", "url": "https://github.com/apache/hbase/pull/1749#discussion_r435562854", "bodyText": "I was expecting to find something like if (LOG.isDebugEnabled() && start > 0) { here. Was this comment addressed elsewhere? Thanks.", "author": "ndimiduk", "createdAt": "2020-06-04T21:27:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM5MDMzNw=="}], "type": "inlineReview", "revised_code": {"commit": "555db026cfa5b91290e90861d2d42ea7511d6311", "chunk": "diff --git a/hbase-common/src/main/java/org/apache/hadoop/hbase/ScheduledChore.java b/hbase-common/src/main/java/org/apache/hadoop/hbase/ScheduledChore.java\nindex 9ac2e6aa4a..28af186ff6 100644\n--- a/hbase-common/src/main/java/org/apache/hadoop/hbase/ScheduledChore.java\n+++ b/hbase-common/src/main/java/org/apache/hadoop/hbase/ScheduledChore.java\n\n@@ -185,9 +185,9 @@ public abstract class ScheduledChore implements Runnable {\n         if (!initialChoreComplete) {\n           initialChoreComplete = initialChore();\n         } else {\n-            chore();\n+          chore();\n         }\n-        if (LOG.isDebugEnabled()) {\n+        if (LOG.isDebugEnabled() && start > 0) {\n           long end = System.nanoTime();\n           LOG.debug(\"{} execution time: {} ms.\", getName(),\n             TimeUnit.NANOSECONDS.toMillis(end - start));\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQxOTg0MA==", "url": "https://github.com/apache/hbase/pull/1749#discussion_r429419840", "bodyText": "A question of clarification. I think what you have is correct, but I'm asking anyway. We have EnvironmentEdgeManager, which abstracts a form of clock. System.nanoTime() is a different form of clock. Is there some case where we'd want the nanoTime to be abstracted behind EnvironmentEdgeManager? My understanding is no, we don't have such a use-case, because EnvironmentEdgeManager is for abstracting over a clock-time (a la java.time.Instant), while nanoTime is providing a timer for calculating a time duration, something that is abstract from a clock-time.", "author": "ndimiduk", "createdAt": "2020-05-22T19:26:09Z", "path": "hbase-common/src/main/java/org/apache/hadoop/hbase/ScheduledChore.java", "diffHunk": "@@ -183,18 +176,21 @@ public void run() {\n       if (LOG.isInfoEnabled()) LOG.info(\"Chore: \" + getName() + \" was stopped\");\n     } else {\n       try {\n+        // TODO: Histogram metrics per chore name.\n+        // For now, just measure and log if DEBUG level logging is enabled.\n+        long start = 0;\n+        if (LOG.isDebugEnabled()) {\n+          start = System.nanoTime();", "originalCommit": "068b54cae428b01f9e214e6ea66a0c0bc5a5ec75", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQ1MjczMg==", "url": "https://github.com/apache/hbase/pull/1749#discussion_r429452732", "bodyText": "We don't, but we could. Would be another scope of change I think.", "author": "apurtell", "createdAt": "2020-05-22T21:11:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQxOTg0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQ2NjE5OA==", "url": "https://github.com/apache/hbase/pull/1749#discussion_r429466198", "bodyText": "Yeah I was kind of caviler about the ifdebug guards. Will fix", "author": "apurtell", "createdAt": "2020-05-22T21:52:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQxOTg0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU2MjQ2OA==", "url": "https://github.com/apache/hbase/pull/1749#discussion_r435562468", "bodyText": "I'm not asking for a scope change, just clarifying my understanding.", "author": "ndimiduk", "createdAt": "2020-06-04T21:26:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQxOTg0MA=="}], "type": "inlineReview", "revised_code": {"commit": "555db026cfa5b91290e90861d2d42ea7511d6311", "chunk": "diff --git a/hbase-common/src/main/java/org/apache/hadoop/hbase/ScheduledChore.java b/hbase-common/src/main/java/org/apache/hadoop/hbase/ScheduledChore.java\nindex 9ac2e6aa4a..28af186ff6 100644\n--- a/hbase-common/src/main/java/org/apache/hadoop/hbase/ScheduledChore.java\n+++ b/hbase-common/src/main/java/org/apache/hadoop/hbase/ScheduledChore.java\n\n@@ -185,9 +185,9 @@ public abstract class ScheduledChore implements Runnable {\n         if (!initialChoreComplete) {\n           initialChoreComplete = initialChore();\n         } else {\n-            chore();\n+          chore();\n         }\n-        if (LOG.isDebugEnabled()) {\n+        if (LOG.isDebugEnabled() && start > 0) {\n           long end = System.nanoTime();\n           LOG.debug(\"{} execution time: {} ms.\", getName(),\n             TimeUnit.NANOSECONDS.toMillis(end - start));\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQyMDI4Mw==", "url": "https://github.com/apache/hbase/pull/1749#discussion_r429420283", "bodyText": "Do we want some duration threshold that triggers escalating the log level to info (or warn), as was done before?", "author": "ndimiduk", "createdAt": "2020-05-22T19:27:20Z", "path": "hbase-common/src/main/java/org/apache/hadoop/hbase/ScheduledChore.java", "diffHunk": "@@ -183,18 +176,21 @@ public void run() {\n       if (LOG.isInfoEnabled()) LOG.info(\"Chore: \" + getName() + \" was stopped\");\n     } else {\n       try {\n+        // TODO: Histogram metrics per chore name.\n+        // For now, just measure and log if DEBUG level logging is enabled.\n+        long start = 0;\n+        if (LOG.isDebugEnabled()) {\n+          start = System.nanoTime();\n+        }\n         if (!initialChoreComplete) {\n           initialChoreComplete = initialChore();\n         } else {\n-          timeMeasurement.measure(() -> {\n             chore();\n-            return null;\n-          });\n-          if (LOG.isInfoEnabled() && (System.nanoTime() - lastLog > FIVE_MINUTES_IN_NANOS)) {", "originalCommit": "068b54cae428b01f9e214e6ea66a0c0bc5a5ec75", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQ1MzE3OA==", "url": "https://github.com/apache/hbase/pull/1749#discussion_r429453178", "bodyText": "Not opposed to the idea at all, but it's going to depend on the chore, right?", "author": "apurtell", "createdAt": "2020-05-22T21:12:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQyMDI4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU2MjEzMA==", "url": "https://github.com/apache/hbase/pull/1749#discussion_r435562130", "bodyText": "yeah i think you're right. let's leave it for now.", "author": "ndimiduk", "createdAt": "2020-06-04T21:25:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQyMDI4Mw=="}], "type": "inlineReview", "revised_code": {"commit": "555db026cfa5b91290e90861d2d42ea7511d6311", "chunk": "diff --git a/hbase-common/src/main/java/org/apache/hadoop/hbase/ScheduledChore.java b/hbase-common/src/main/java/org/apache/hadoop/hbase/ScheduledChore.java\nindex 9ac2e6aa4a..28af186ff6 100644\n--- a/hbase-common/src/main/java/org/apache/hadoop/hbase/ScheduledChore.java\n+++ b/hbase-common/src/main/java/org/apache/hadoop/hbase/ScheduledChore.java\n\n@@ -185,9 +185,9 @@ public abstract class ScheduledChore implements Runnable {\n         if (!initialChoreComplete) {\n           initialChoreComplete = initialChore();\n         } else {\n-            chore();\n+          chore();\n         }\n-        if (LOG.isDebugEnabled()) {\n+        if (LOG.isDebugEnabled() && start > 0) {\n           long end = System.nanoTime();\n           LOG.debug(\"{} execution time: {} ms.\", getName(),\n             TimeUnit.NANOSECONDS.toMillis(end - start));\n"}}, {"oid": "414d4a88efd40bd2d358295885164ae80f53b077", "url": "https://github.com/apache/hbase/commit/414d4a88efd40bd2d358295885164ae80f53b077", "message": "HBASE-24367 ScheduledChore log elapsed timespan in a human-friendly format", "committedDate": "2020-06-04T00:40:45Z", "type": "forcePushed"}, {"oid": "555db026cfa5b91290e90861d2d42ea7511d6311", "url": "https://github.com/apache/hbase/commit/555db026cfa5b91290e90861d2d42ea7511d6311", "message": "HBASE-24367 ScheduledChore log elapsed timespan in a human-friendly format", "committedDate": "2020-06-05T17:24:48Z", "type": "commit"}, {"oid": "555db026cfa5b91290e90861d2d42ea7511d6311", "url": "https://github.com/apache/hbase/commit/555db026cfa5b91290e90861d2d42ea7511d6311", "message": "HBASE-24367 ScheduledChore log elapsed timespan in a human-friendly format", "committedDate": "2020-06-05T17:24:48Z", "type": "forcePushed"}]}