{"pr_number": 2543, "pr_title": "HBASE-25184 Move RegionLocationFinder to hbase-balancer", "pr_createdAt": "2020-10-14T10:39:13Z", "pr_url": "https://github.com/apache/hbase/pull/2543", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTAwMDk5MQ==", "url": "https://github.com/apache/hbase/pull/2543#discussion_r505000991", "bodyText": "Why is RegionLocationFinder in the balancer module?", "author": "saintstack", "createdAt": "2020-10-14T21:58:56Z", "path": "hbase-balancer/src/main/java/org/apache/hadoop/hbase/master/balancer/RegionLocationFinder.java", "diffHunk": "@@ -17,235 +17,186 @@\n  */\n package org.apache.hadoop.hbase.master.balancer;\n \n-import java.io.FileNotFoundException;\n import java.io.IOException;\n import java.util.ArrayList;\n import java.util.Collection;\n+import java.util.Collections;\n import java.util.HashMap;\n import java.util.List;\n+import java.util.Map;\n import java.util.concurrent.Callable;\n import java.util.concurrent.ExecutionException;\n import java.util.concurrent.Executors;\n import java.util.concurrent.TimeUnit;\n-import org.apache.hadoop.conf.Configuration;\n+import org.apache.hadoop.conf.Configured;\n import org.apache.hadoop.hbase.ClusterMetrics;\n import org.apache.hadoop.hbase.HDFSBlocksDistribution;\n import org.apache.hadoop.hbase.ServerName;\n import org.apache.hadoop.hbase.TableName;\n import org.apache.hadoop.hbase.client.RegionInfo;\n import org.apache.hadoop.hbase.client.TableDescriptor;\n-import org.apache.hadoop.hbase.master.MasterServices;\n-import org.apache.hadoop.hbase.master.assignment.AssignmentManager;\n-import org.apache.hadoop.hbase.regionserver.HRegion;\n import org.apache.hadoop.hbase.util.EnvironmentEdgeManager;\n import org.apache.yetus.audience.InterfaceAudience;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n+\n+import org.apache.hbase.thirdparty.com.google.common.annotations.VisibleForTesting;\n import org.apache.hbase.thirdparty.com.google.common.cache.CacheBuilder;\n import org.apache.hbase.thirdparty.com.google.common.cache.CacheLoader;\n import org.apache.hbase.thirdparty.com.google.common.cache.LoadingCache;\n-import org.apache.hbase.thirdparty.com.google.common.collect.Lists;\n import org.apache.hbase.thirdparty.com.google.common.util.concurrent.Futures;\n import org.apache.hbase.thirdparty.com.google.common.util.concurrent.ListenableFuture;\n import org.apache.hbase.thirdparty.com.google.common.util.concurrent.ListeningExecutorService;\n import org.apache.hbase.thirdparty.com.google.common.util.concurrent.MoreExecutors;\n import org.apache.hbase.thirdparty.com.google.common.util.concurrent.ThreadFactoryBuilder;\n \n /**\n- * This will find where data for a region is located in HDFS. It ranks\n- * {@link ServerName}'s by the size of the store files they are holding for a\n- * given region.\n- *\n+ * This will find where data for a region is located in HDFS. It ranks {@link ServerName}'s by the\n+ * size of the store files they are holding for a given region.\n  */\n @InterfaceAudience.Private\n-class RegionLocationFinder {\n+class RegionLocationFinder extends Configured {", "originalCommit": "e21cf5f71e1ecdabaa1db5bb580b021af0333287", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTExODA1Mw==", "url": "https://github.com/apache/hbase/pull/2543#discussion_r505118053", "bodyText": "Because I moved it here? The title of this issue is to move RegionLocationFinder to hbase-balancer module. Or you want to ask why it is under the balancer package? It is because that it is only used by balancer to calcuate the locality. It is a key of the master dependency. If we could move it into hbase-balancer, then it will be easier to move other classes into hbase-balancer module.", "author": "Apache9", "createdAt": "2020-10-15T01:53:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTAwMDk5MQ=="}], "type": "inlineReview", "revised_code": {"commit": "0f7f9e1e44fc97c99a08755784d2917d5b9de8d3", "chunk": "diff --git a/hbase-balancer/src/main/java/org/apache/hadoop/hbase/master/balancer/RegionLocationFinder.java b/hbase-balancer/src/main/java/org/apache/hadoop/hbase/master/balancer/RegionLocationFinder.java\nindex b6c7fdf14b..8d40445619 100644\n--- a/hbase-balancer/src/main/java/org/apache/hadoop/hbase/master/balancer/RegionLocationFinder.java\n+++ b/hbase-balancer/src/main/java/org/apache/hadoop/hbase/master/balancer/RegionLocationFinder.java\n\n@@ -17,6 +17,7 @@\n  */\n package org.apache.hadoop.hbase.master.balancer;\n \n+import com.google.errorprone.annotations.RestrictedApi;\n import java.io.IOException;\n import java.util.ArrayList;\n import java.util.Collection;\n"}}, {"oid": "0f7f9e1e44fc97c99a08755784d2917d5b9de8d3", "url": "https://github.com/apache/hbase/commit/0f7f9e1e44fc97c99a08755784d2917d5b9de8d3", "message": "HBASE-25184 Move RegionLocationFinder to hbase-balancer", "committedDate": "2021-03-06T01:38:55Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDg2ODQyMw==", "url": "https://github.com/apache/hbase/pull/2543#discussion_r594868423", "bodyText": "This comment is odd. Is BalanceService a good name for this? There is no start/stop of this Service?  There is not even a balance method in this BalanceService?", "author": "saintstack", "createdAt": "2021-03-16T05:19:18Z", "path": "hbase-balancer/src/main/java/org/apache/hadoop/hbase/master/balancer/BalancerService.java", "diffHunk": "@@ -0,0 +1,42 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.hbase.master.balancer;\n+\n+import java.io.IOException;\n+import java.util.List;\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.hadoop.hbase.HDFSBlocksDistribution;\n+import org.apache.hadoop.hbase.TableName;\n+import org.apache.hadoop.hbase.client.RegionInfo;\n+import org.apache.hadoop.hbase.client.TableDescriptor;\n+import org.apache.yetus.audience.InterfaceAudience;\n+\n+/**\n+ * This is the cluster we want to balance. It provides methods to let us get the information we", "originalCommit": "ec3e004d6bcc0ab56fbf883b48d60900c131b790", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a3d81fbd4a53b1e7f43ffb542accaffabfc74f8e", "chunk": "diff --git a/hbase-balancer/src/main/java/org/apache/hadoop/hbase/master/balancer/BalancerService.java b/hbase-balancer/src/main/java/org/apache/hadoop/hbase/master/balancer/ClusterInfoProvider.java\nsimilarity index 82%\nrename from hbase-balancer/src/main/java/org/apache/hadoop/hbase/master/balancer/BalancerService.java\nrename to hbase-balancer/src/main/java/org/apache/hadoop/hbase/master/balancer/ClusterInfoProvider.java\nindex 37723fb600..47247b144e 100644\n--- a/hbase-balancer/src/main/java/org/apache/hadoop/hbase/master/balancer/BalancerService.java\n+++ b/hbase-balancer/src/main/java/org/apache/hadoop/hbase/master/balancer/ClusterInfoProvider.java\n\n@@ -31,12 +31,25 @@ import org.apache.yetus.audience.InterfaceAudience;\n  * want.\n  */\n @InterfaceAudience.Private\n-public interface BalancerService {\n+public interface ClusterInfoProvider {\n \n+  /**\n+   * Get all the regions of this cluster.\n+   * <p/>\n+   * Used to refresh region block locations on HDFS.\n+   */\n   List<RegionInfo> getAssignedRegions();\n \n+  /**\n+   * Get the table descriptor for the given table.\n+   */\n   TableDescriptor getTableDescriptor(TableName tableName) throws IOException;\n \n+  /**\n+   * Compute the block distribution for the given region.\n+   * <p/>\n+   * Used to refresh region block locations on HDFS.\n+   */\n   HDFSBlocksDistribution computeHDFSBlocksDistribution(Configuration conf,\n     TableDescriptor tableDescriptor, RegionInfo regionInfo) throws IOException;\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDg3MTY0MA==", "url": "https://github.com/apache/hbase/pull/2543#discussion_r594871640", "bodyText": "I thought this class was about finding Region locations. Now I see it is about HDFS block locations per Region... something else altogether. Seems like the class is named incorrectly? Perhaps fix?  RegionHDFSBlockLocationsFinder?", "author": "saintstack", "createdAt": "2021-03-16T05:29:09Z", "path": "hbase-balancer/src/main/java/org/apache/hadoop/hbase/master/balancer/RegionLocationFinder.java", "diffHunk": "@@ -17,235 +17,187 @@\n  */\n package org.apache.hadoop.hbase.master.balancer;\n \n-import java.io.FileNotFoundException;\n+import com.google.errorprone.annotations.RestrictedApi;\n import java.io.IOException;\n import java.util.ArrayList;\n import java.util.Collection;\n+import java.util.Collections;\n import java.util.HashMap;\n import java.util.List;\n+import java.util.Map;\n import java.util.concurrent.Callable;\n import java.util.concurrent.ExecutionException;\n import java.util.concurrent.Executors;\n import java.util.concurrent.TimeUnit;\n-import org.apache.hadoop.conf.Configuration;\n+import org.apache.hadoop.conf.Configured;\n import org.apache.hadoop.hbase.ClusterMetrics;\n import org.apache.hadoop.hbase.HDFSBlocksDistribution;\n import org.apache.hadoop.hbase.ServerName;\n import org.apache.hadoop.hbase.TableName;\n import org.apache.hadoop.hbase.client.RegionInfo;\n import org.apache.hadoop.hbase.client.TableDescriptor;\n-import org.apache.hadoop.hbase.master.MasterServices;\n-import org.apache.hadoop.hbase.master.assignment.AssignmentManager;\n-import org.apache.hadoop.hbase.regionserver.HRegion;\n import org.apache.hadoop.hbase.util.EnvironmentEdgeManager;\n import org.apache.yetus.audience.InterfaceAudience;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n+\n import org.apache.hbase.thirdparty.com.google.common.cache.CacheBuilder;\n import org.apache.hbase.thirdparty.com.google.common.cache.CacheLoader;\n import org.apache.hbase.thirdparty.com.google.common.cache.LoadingCache;\n-import org.apache.hbase.thirdparty.com.google.common.collect.Lists;\n import org.apache.hbase.thirdparty.com.google.common.util.concurrent.Futures;\n import org.apache.hbase.thirdparty.com.google.common.util.concurrent.ListenableFuture;\n import org.apache.hbase.thirdparty.com.google.common.util.concurrent.ListeningExecutorService;\n import org.apache.hbase.thirdparty.com.google.common.util.concurrent.MoreExecutors;\n import org.apache.hbase.thirdparty.com.google.common.util.concurrent.ThreadFactoryBuilder;\n \n /**\n- * This will find where data for a region is located in HDFS. It ranks\n- * {@link ServerName}'s by the size of the store files they are holding for a\n- * given region.\n- *\n+ * This will find where data for a region is located in HDFS. It ranks {@link ServerName}'s by the\n+ * size of the store files they are holding for a given region.\n  */\n @InterfaceAudience.Private\n-class RegionLocationFinder {\n+class RegionLocationFinder extends Configured {", "originalCommit": "ec3e004d6bcc0ab56fbf883b48d60900c131b790", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDkyMzY5NQ==", "url": "https://github.com/apache/hbase/pull/2543#discussion_r594923695", "bodyText": "Agree. Let me change the name to better describe what the class wants to do.", "author": "Apache9", "createdAt": "2021-03-16T07:40:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDg3MTY0MA=="}], "type": "inlineReview", "revised_code": {"commit": "a3d81fbd4a53b1e7f43ffb542accaffabfc74f8e", "chunk": "diff --git a/hbase-balancer/src/main/java/org/apache/hadoop/hbase/master/balancer/RegionLocationFinder.java b/hbase-balancer/src/main/java/org/apache/hadoop/hbase/master/balancer/RegionHDFSBlockLocationFinder.java\nsimilarity index 95%\nrename from hbase-balancer/src/main/java/org/apache/hadoop/hbase/master/balancer/RegionLocationFinder.java\nrename to hbase-balancer/src/main/java/org/apache/hadoop/hbase/master/balancer/RegionHDFSBlockLocationFinder.java\nindex 8d40445619..87ab89d631 100644\n--- a/hbase-balancer/src/main/java/org/apache/hadoop/hbase/master/balancer/RegionLocationFinder.java\n+++ b/hbase-balancer/src/main/java/org/apache/hadoop/hbase/master/balancer/RegionHDFSBlockLocationFinder.java\n\n@@ -55,13 +55,13 @@ import org.apache.hbase.thirdparty.com.google.common.util.concurrent.ThreadFacto\n  * size of the store files they are holding for a given region.\n  */\n @InterfaceAudience.Private\n-class RegionLocationFinder extends Configured {\n-  private static final Logger LOG = LoggerFactory.getLogger(RegionLocationFinder.class);\n+class RegionHDFSBlockLocationFinder extends Configured {\n+  private static final Logger LOG = LoggerFactory.getLogger(RegionHDFSBlockLocationFinder.class);\n   private static final long CACHE_TIME = 240 * 60 * 1000;\n   private static final HDFSBlocksDistribution EMPTY_BLOCK_DISTRIBUTION =\n     new HDFSBlocksDistribution();\n   private volatile ClusterMetrics status;\n-  private volatile BalancerService service;\n+  private volatile ClusterInfoProvider provider;\n   private final ListeningExecutorService executor;\n   // Do not scheduleFullRefresh at master startup\n   private long lastFullRefresh = EnvironmentEdgeManager.currentTime();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDg4NTA3NQ==", "url": "https://github.com/apache/hbase/pull/2543#discussion_r594885075", "bodyText": "After reading whole patch I see that this is not a BalancerService but a subset of the MasterSerivces, those methods the Balancer can't do without.\nSuggest the class comment say that.\nThe getAssignedRegions is all assigned Regions on the cluster it seems? Add a bit of javadoc? Ditto for computeHDFSBlockDist...", "author": "saintstack", "createdAt": "2021-03-16T06:08:48Z", "path": "hbase-balancer/src/main/java/org/apache/hadoop/hbase/master/balancer/BalancerService.java", "diffHunk": "@@ -0,0 +1,42 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.hbase.master.balancer;\n+\n+import java.io.IOException;\n+import java.util.List;\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.hadoop.hbase.HDFSBlocksDistribution;\n+import org.apache.hadoop.hbase.TableName;\n+import org.apache.hadoop.hbase.client.RegionInfo;\n+import org.apache.hadoop.hbase.client.TableDescriptor;\n+import org.apache.yetus.audience.InterfaceAudience;\n+\n+/**\n+ * This is the cluster we want to balance. It provides methods to let us get the information we\n+ * want.\n+ */\n+@InterfaceAudience.Private\n+public interface BalancerService {\n+\n+  List<RegionInfo> getAssignedRegions();\n+\n+  TableDescriptor getTableDescriptor(TableName tableName) throws IOException;\n+\n+  HDFSBlocksDistribution computeHDFSBlocksDistribution(Configuration conf,\n+    TableDescriptor tableDescriptor, RegionInfo regionInfo) throws IOException;\n+}", "originalCommit": "ec3e004d6bcc0ab56fbf883b48d60900c131b790", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDkyNDM0Mw==", "url": "https://github.com/apache/hbase/pull/2543#discussion_r594924343", "bodyText": "It is used to provide information which will be used for balancer. So I agree that BalancerService is not a good name. Maybe ClusterInfoRetrivier or ClusterInfoProvider?", "author": "Apache9", "createdAt": "2021-03-16T07:42:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDg4NTA3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NjI1MzEwOA==", "url": "https://github.com/apache/hbase/pull/2543#discussion_r596253108", "bodyText": "+1 on *Provider... ClusterInfoProvider is good.", "author": "saintstack", "createdAt": "2021-03-17T17:48:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDg4NTA3NQ=="}], "type": "inlineReview", "revised_code": {"commit": "a3d81fbd4a53b1e7f43ffb542accaffabfc74f8e", "chunk": "diff --git a/hbase-balancer/src/main/java/org/apache/hadoop/hbase/master/balancer/BalancerService.java b/hbase-balancer/src/main/java/org/apache/hadoop/hbase/master/balancer/ClusterInfoProvider.java\nsimilarity index 82%\nrename from hbase-balancer/src/main/java/org/apache/hadoop/hbase/master/balancer/BalancerService.java\nrename to hbase-balancer/src/main/java/org/apache/hadoop/hbase/master/balancer/ClusterInfoProvider.java\nindex 37723fb600..47247b144e 100644\n--- a/hbase-balancer/src/main/java/org/apache/hadoop/hbase/master/balancer/BalancerService.java\n+++ b/hbase-balancer/src/main/java/org/apache/hadoop/hbase/master/balancer/ClusterInfoProvider.java\n\n@@ -31,12 +31,25 @@ import org.apache.yetus.audience.InterfaceAudience;\n  * want.\n  */\n @InterfaceAudience.Private\n-public interface BalancerService {\n+public interface ClusterInfoProvider {\n \n+  /**\n+   * Get all the regions of this cluster.\n+   * <p/>\n+   * Used to refresh region block locations on HDFS.\n+   */\n   List<RegionInfo> getAssignedRegions();\n \n+  /**\n+   * Get the table descriptor for the given table.\n+   */\n   TableDescriptor getTableDescriptor(TableName tableName) throws IOException;\n \n+  /**\n+   * Compute the block distribution for the given region.\n+   * <p/>\n+   * Used to refresh region block locations on HDFS.\n+   */\n   HDFSBlocksDistribution computeHDFSBlocksDistribution(Configuration conf,\n     TableDescriptor tableDescriptor, RegionInfo regionInfo) throws IOException;\n }\n"}}, {"oid": "a3d81fbd4a53b1e7f43ffb542accaffabfc74f8e", "url": "https://github.com/apache/hbase/commit/a3d81fbd4a53b1e7f43ffb542accaffabfc74f8e", "message": "HBASE-25184 Move RegionLocationFinder to hbase-balancer", "committedDate": "2021-03-19T15:32:03Z", "type": "forcePushed"}, {"oid": "436de4df682f38bd129363b387eacdaa4bcbe0bf", "url": "https://github.com/apache/hbase/commit/436de4df682f38bd129363b387eacdaa4bcbe0bf", "message": "HBASE-25184 Move RegionLocationFinder to hbase-balancer", "committedDate": "2021-03-20T01:51:50Z", "type": "commit"}, {"oid": "436de4df682f38bd129363b387eacdaa4bcbe0bf", "url": "https://github.com/apache/hbase/commit/436de4df682f38bd129363b387eacdaa4bcbe0bf", "message": "HBASE-25184 Move RegionLocationFinder to hbase-balancer", "committedDate": "2021-03-20T01:51:50Z", "type": "forcePushed"}]}