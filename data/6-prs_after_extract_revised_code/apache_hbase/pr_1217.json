{"pr_number": 1217, "pr_title": "HBASE-23891: Add an option to Actions to filter out meta RS", "pr_createdAt": "2020-02-27T14:30:46Z", "pr_url": "https://github.com/apache/hbase/pull/1217", "timeline": [{"oid": "4645db4eb1a7117b917e268f2cd3d6fc6ca1ba41", "url": "https://github.com/apache/hbase/commit/4645db4eb1a7117b917e268f2cd3d6fc6ca1ba41", "message": "HBASE-23891: Add an option to Actions to filter out meta RS\n\nmake skipping or killing meta RegionServer cofigurable for new actions", "committedDate": "2020-02-27T14:26:53Z", "type": "commit"}, {"oid": "4645db4eb1a7117b917e268f2cd3d6fc6ca1ba41", "url": "https://github.com/apache/hbase/commit/4645db4eb1a7117b917e268f2cd3d6fc6ca1ba41", "message": "HBASE-23891: Add an option to Actions to filter out meta RS\n\nmake skipping or killing meta RegionServer cofigurable for new actions", "committedDate": "2020-02-27T14:26:53Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTY1NDI2Mw==", "url": "https://github.com/apache/hbase/pull/1217#discussion_r385654263", "bodyText": "Could we move this to Action class, in order to avoid repeating it on different Action implementations? Just noticed we duplicate this in RollingBatchSuspendResumeRsAction.java.", "author": "wchevreuil", "createdAt": "2020-02-28T11:50:09Z", "path": "hbase-it/src/test/java/org/apache/hadoop/hbase/chaos/actions/GracefulRollingRestartRsAction.java", "diffHunk": "@@ -35,15 +35,23 @@\n public class GracefulRollingRestartRsAction extends RestartActionBaseAction {\n   private static final Logger LOG = LoggerFactory.getLogger(GracefulRollingRestartRsAction.class);\n \n-  public GracefulRollingRestartRsAction(long sleepTime) {\n+  private boolean killMetaRs;\n+\n+  public GracefulRollingRestartRsAction(long sleepTime, boolean killMetaRs) {\n     super(sleepTime);\n+    this.killMetaRs = killMetaRs;\n   }\n \n   @Override\n   public void perform() throws Exception {\n     LOG.info(\"Performing action: Rolling restarting non-master region servers\");\n     List<ServerName> selectedServers = selectServers();\n \n+    if(!killMetaRs){\n+      ServerName metaServer = cluster.getServerHoldingMeta();\n+      selectedServers.remove(metaServer);\n+    }\n+", "originalCommit": "4645db4eb1a7117b917e268f2cd3d6fc6ca1ba41", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f3dca98d355e6997c5b654177a79fa60ede923b3", "chunk": "diff --git a/hbase-it/src/test/java/org/apache/hadoop/hbase/chaos/actions/GracefulRollingRestartRsAction.java b/hbase-it/src/test/java/org/apache/hadoop/hbase/chaos/actions/GracefulRollingRestartRsAction.java\nindex bab9ec524c..82005bbbd4 100644\n--- a/hbase-it/src/test/java/org/apache/hadoop/hbase/chaos/actions/GracefulRollingRestartRsAction.java\n+++ b/hbase-it/src/test/java/org/apache/hadoop/hbase/chaos/actions/GracefulRollingRestartRsAction.java\n\n@@ -35,11 +35,8 @@ import org.slf4j.LoggerFactory;\n public class GracefulRollingRestartRsAction extends RestartActionBaseAction {\n   private static final Logger LOG = LoggerFactory.getLogger(GracefulRollingRestartRsAction.class);\n \n-  private boolean killMetaRs;\n-\n-  public GracefulRollingRestartRsAction(long sleepTime, boolean killMetaRs) {\n+  public GracefulRollingRestartRsAction(long sleepTime) {\n     super(sleepTime);\n-    this.killMetaRs = killMetaRs;\n   }\n \n   @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTY1NDM2Ng==", "url": "https://github.com/apache/hbase/pull/1217#discussion_r385654366", "bodyText": "See previous comment above.", "author": "wchevreuil", "createdAt": "2020-02-28T11:50:25Z", "path": "hbase-it/src/test/java/org/apache/hadoop/hbase/chaos/actions/RollingBatchSuspendResumeRsAction.java", "diffHunk": "@@ -64,6 +67,11 @@ public void perform() throws Exception {\n         (int) (ratio * 100)));\n     List<ServerName> selectedServers = selectServers();\n \n+    if(!killMetaRs){\n+      ServerName metaServer = cluster.getServerHoldingMeta();\n+      selectedServers.remove(metaServer);\n+    }", "originalCommit": "4645db4eb1a7117b917e268f2cd3d6fc6ca1ba41", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f3dca98d355e6997c5b654177a79fa60ede923b3", "chunk": "diff --git a/hbase-it/src/test/java/org/apache/hadoop/hbase/chaos/actions/RollingBatchSuspendResumeRsAction.java b/hbase-it/src/test/java/org/apache/hadoop/hbase/chaos/actions/RollingBatchSuspendResumeRsAction.java\nindex 28cb687551..d4ad3e40b5 100644\n--- a/hbase-it/src/test/java/org/apache/hadoop/hbase/chaos/actions/RollingBatchSuspendResumeRsAction.java\n+++ b/hbase-it/src/test/java/org/apache/hadoop/hbase/chaos/actions/RollingBatchSuspendResumeRsAction.java\n\n@@ -67,11 +64,6 @@ public class RollingBatchSuspendResumeRsAction extends Action {\n         (int) (ratio * 100)));\n     List<ServerName> selectedServers = selectServers();\n \n-    if(!killMetaRs){\n-      ServerName metaServer = cluster.getServerHoldingMeta();\n-      selectedServers.remove(metaServer);\n-    }\n-\n     Queue<ServerName> serversToBeSuspended = new LinkedList<>(selectedServers);\n     Queue<ServerName> suspendedServers = new LinkedList<>();\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTY1NjA5OA==", "url": "https://github.com/apache/hbase/pull/1217#discussion_r385656098", "bodyText": "Similar suggestion as done for the Actions. Can we move this to a common method in the parent class to avoid code repetition?", "author": "wchevreuil", "createdAt": "2020-02-28T11:55:01Z", "path": "hbase-it/src/test/java/org/apache/hadoop/hbase/chaos/factories/ServerAndDependenciesKillingMonkeyFactory.java", "diffHunk": "@@ -83,5 +84,8 @@ private void loadProperties() {\n     rollingBatchSuspendtRSRatio = Float.parseFloat(this.properties.getProperty(\n         MonkeyConstants.ROLLING_BATCH_SUSPEND_RS_RATIO,\n         MonkeyConstants.DEFAULT_ROLLING_BATCH_SUSPEND_RS_RATIO + \"\"));\n+    killMetaRs = Boolean.parseBoolean(this.properties.getProperty(\n+      MonkeyConstants.KILL_META_RS,\n+      MonkeyConstants.DEFAULT_KILL_META_RS + \"\"));", "originalCommit": "4645db4eb1a7117b917e268f2cd3d6fc6ca1ba41", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f3dca98d355e6997c5b654177a79fa60ede923b3", "chunk": "diff --git a/hbase-it/src/test/java/org/apache/hadoop/hbase/chaos/factories/ServerAndDependenciesKillingMonkeyFactory.java b/hbase-it/src/test/java/org/apache/hadoop/hbase/chaos/factories/ServerAndDependenciesKillingMonkeyFactory.java\nindex ed0855408a..676b04d3fe 100644\n--- a/hbase-it/src/test/java/org/apache/hadoop/hbase/chaos/factories/ServerAndDependenciesKillingMonkeyFactory.java\n+++ b/hbase-it/src/test/java/org/apache/hadoop/hbase/chaos/factories/ServerAndDependenciesKillingMonkeyFactory.java\n\n@@ -84,8 +84,5 @@ public class ServerAndDependenciesKillingMonkeyFactory extends MonkeyFactory {\n     rollingBatchSuspendtRSRatio = Float.parseFloat(this.properties.getProperty(\n         MonkeyConstants.ROLLING_BATCH_SUSPEND_RS_RATIO,\n         MonkeyConstants.DEFAULT_ROLLING_BATCH_SUSPEND_RS_RATIO + \"\"));\n-    killMetaRs = Boolean.parseBoolean(this.properties.getProperty(\n-      MonkeyConstants.KILL_META_RS,\n-      MonkeyConstants.DEFAULT_KILL_META_RS + \"\"));\n   }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTY1NjIwNQ==", "url": "https://github.com/apache/hbase/pull/1217#discussion_r385656205", "bodyText": "See previous comment.", "author": "wchevreuil", "createdAt": "2020-02-28T11:55:18Z", "path": "hbase-it/src/test/java/org/apache/hadoop/hbase/chaos/factories/ServerKillingMonkeyFactory.java", "diffHunk": "@@ -79,5 +80,8 @@ private void loadProperties() {\n     rollingBatchSuspendtRSRatio = Float.parseFloat(this.properties.getProperty(\n         MonkeyConstants.ROLLING_BATCH_SUSPEND_RS_RATIO,\n         MonkeyConstants.DEFAULT_ROLLING_BATCH_SUSPEND_RS_RATIO + \"\"));\n+    killMetaRs = Boolean.parseBoolean(this.properties.getProperty(\n+      MonkeyConstants.KILL_META_RS,\n+      MonkeyConstants.DEFAULT_KILL_META_RS + \"\"));", "originalCommit": "4645db4eb1a7117b917e268f2cd3d6fc6ca1ba41", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f3dca98d355e6997c5b654177a79fa60ede923b3", "chunk": "diff --git a/hbase-it/src/test/java/org/apache/hadoop/hbase/chaos/factories/ServerKillingMonkeyFactory.java b/hbase-it/src/test/java/org/apache/hadoop/hbase/chaos/factories/ServerKillingMonkeyFactory.java\nindex 106e6a9b7d..3240affb4b 100644\n--- a/hbase-it/src/test/java/org/apache/hadoop/hbase/chaos/factories/ServerKillingMonkeyFactory.java\n+++ b/hbase-it/src/test/java/org/apache/hadoop/hbase/chaos/factories/ServerKillingMonkeyFactory.java\n\n@@ -80,8 +80,5 @@ public class ServerKillingMonkeyFactory extends MonkeyFactory {\n     rollingBatchSuspendtRSRatio = Float.parseFloat(this.properties.getProperty(\n         MonkeyConstants.ROLLING_BATCH_SUSPEND_RS_RATIO,\n         MonkeyConstants.DEFAULT_ROLLING_BATCH_SUSPEND_RS_RATIO + \"\"));\n-    killMetaRs = Boolean.parseBoolean(this.properties.getProperty(\n-      MonkeyConstants.KILL_META_RS,\n-      MonkeyConstants.DEFAULT_KILL_META_RS + \"\"));\n   }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTY1NjMwOQ==", "url": "https://github.com/apache/hbase/pull/1217#discussion_r385656309", "bodyText": "See previous comment.", "author": "wchevreuil", "createdAt": "2020-02-28T11:55:34Z", "path": "hbase-it/src/test/java/org/apache/hadoop/hbase/chaos/factories/StressAssignmentManagerMonkeyFactory.java", "diffHunk": "@@ -110,5 +111,8 @@ private void loadProperties() {\n     rollingBatchSuspendtRSRatio = Float.parseFloat(this.properties.getProperty(\n         MonkeyConstants.ROLLING_BATCH_SUSPEND_RS_RATIO,\n         MonkeyConstants.DEFAULT_ROLLING_BATCH_SUSPEND_RS_RATIO + \"\"));\n+    killMetaRs = Boolean.parseBoolean(this.properties.getProperty(\n+      MonkeyConstants.KILL_META_RS,\n+      MonkeyConstants.DEFAULT_KILL_META_RS + \"\"));", "originalCommit": "4645db4eb1a7117b917e268f2cd3d6fc6ca1ba41", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f3dca98d355e6997c5b654177a79fa60ede923b3", "chunk": "diff --git a/hbase-it/src/test/java/org/apache/hadoop/hbase/chaos/factories/StressAssignmentManagerMonkeyFactory.java b/hbase-it/src/test/java/org/apache/hadoop/hbase/chaos/factories/StressAssignmentManagerMonkeyFactory.java\nindex 29ad07cd39..16d6b29cae 100644\n--- a/hbase-it/src/test/java/org/apache/hadoop/hbase/chaos/factories/StressAssignmentManagerMonkeyFactory.java\n+++ b/hbase-it/src/test/java/org/apache/hadoop/hbase/chaos/factories/StressAssignmentManagerMonkeyFactory.java\n\n@@ -111,8 +110,5 @@ public class StressAssignmentManagerMonkeyFactory extends MonkeyFactory {\n     rollingBatchSuspendtRSRatio = Float.parseFloat(this.properties.getProperty(\n         MonkeyConstants.ROLLING_BATCH_SUSPEND_RS_RATIO,\n         MonkeyConstants.DEFAULT_ROLLING_BATCH_SUSPEND_RS_RATIO + \"\"));\n-    killMetaRs = Boolean.parseBoolean(this.properties.getProperty(\n-      MonkeyConstants.KILL_META_RS,\n-      MonkeyConstants.DEFAULT_KILL_META_RS + \"\"));\n   }\n }\n"}}, {"oid": "f3dca98d355e6997c5b654177a79fa60ede923b3", "url": "https://github.com/apache/hbase/commit/f3dca98d355e6997c5b654177a79fa60ede923b3", "message": "HBASE-23891: Add an option to Actions to filter out meta RS\n\nRevert prev changes\nRework skipMetaRS into a generic solution that can remove the meta\nregion server from any server list independently of the action if\nrequired\nChange config handling to allow monkeyProps usage in Actions", "committedDate": "2020-03-05T14:06:06Z", "type": "commit"}, {"oid": "3b40fa8b026b81fc8f8622ba7902566c3ab4eead", "url": "https://github.com/apache/hbase/commit/3b40fa8b026b81fc8f8622ba7902566c3ab4eead", "message": "HBASE-23891: Add an option to Actions to filter out meta RS\n\ncheckstyle fixes", "committedDate": "2020-03-05T15:38:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM2Njk0MQ==", "url": "https://github.com/apache/hbase/pull/1217#discussion_r388366941", "bodyText": "nit: If we just overload the constructor on PolicyBasedChaosMonkey, then we don't need this extra change just to pass a null reference.", "author": "wchevreuil", "createdAt": "2020-03-05T15:26:44Z", "path": "hbase-it/src/test/java/org/apache/hadoop/hbase/IntegrationTestBackupRestore.java", "diffHunk": "@@ -139,7 +139,7 @@ public void tearDown() throws IOException {\n   public void setUpMonkey() throws Exception {\n     Policy p = new PeriodicRandomActionPolicy(sleepTime,\n       new RestartRandomRsExceptMetaAction(sleepTime));\n-    this.monkey = new PolicyBasedChaosMonkey(util, p);\n+    this.monkey = new PolicyBasedChaosMonkey(null, util, p);", "originalCommit": "f3dca98d355e6997c5b654177a79fa60ede923b3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQzODE2NA==", "url": "https://github.com/apache/hbase/pull/1217#discussion_r388438164", "bodyText": "You are right, I'll fix this.", "author": "BukrosSzabolcs", "createdAt": "2020-03-05T17:12:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM2Njk0MQ=="}], "type": "inlineReview", "revised_code": {"commit": "ddd39981b29baca832dfd1dd14be9338369412fc", "chunk": "diff --git a/hbase-it/src/test/java/org/apache/hadoop/hbase/IntegrationTestBackupRestore.java b/hbase-it/src/test/java/org/apache/hadoop/hbase/IntegrationTestBackupRestore.java\nindex 9908277212..ff6ae17e12 100644\n--- a/hbase-it/src/test/java/org/apache/hadoop/hbase/IntegrationTestBackupRestore.java\n+++ b/hbase-it/src/test/java/org/apache/hadoop/hbase/IntegrationTestBackupRestore.java\n\n@@ -139,7 +139,7 @@ public class IntegrationTestBackupRestore extends IntegrationTestBase {\n   public void setUpMonkey() throws Exception {\n     Policy p = new PeriodicRandomActionPolicy(sleepTime,\n       new RestartRandomRsExceptMetaAction(sleepTime));\n-    this.monkey = new PolicyBasedChaosMonkey(null, util, p);\n+    this.monkey = new PolicyBasedChaosMonkey(util, p);\n     startMonkey();\n   }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM2NzIwNw==", "url": "https://github.com/apache/hbase/pull/1217#discussion_r388367207", "bodyText": "See previous comment.", "author": "wchevreuil", "createdAt": "2020-03-05T15:27:11Z", "path": "hbase-it/src/test/java/org/apache/hadoop/hbase/IntegrationTestRegionReplicaPerf.java", "diffHunk": "@@ -195,7 +195,7 @@ public void setUpMonkey() throws Exception {\n     Policy p = new PeriodicRandomActionPolicy(sleepTime,\n       new RestartRandomRsExceptMetaAction(sleepTime),\n       new MoveRandomRegionOfTableAction(tableName));\n-    this.monkey = new PolicyBasedChaosMonkey(util, p);\n+    this.monkey = new PolicyBasedChaosMonkey(null, util, p);", "originalCommit": "f3dca98d355e6997c5b654177a79fa60ede923b3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ddd39981b29baca832dfd1dd14be9338369412fc", "chunk": "diff --git a/hbase-it/src/test/java/org/apache/hadoop/hbase/IntegrationTestRegionReplicaPerf.java b/hbase-it/src/test/java/org/apache/hadoop/hbase/IntegrationTestRegionReplicaPerf.java\nindex 1506d6aab0..7b00f124c4 100644\n--- a/hbase-it/src/test/java/org/apache/hadoop/hbase/IntegrationTestRegionReplicaPerf.java\n+++ b/hbase-it/src/test/java/org/apache/hadoop/hbase/IntegrationTestRegionReplicaPerf.java\n\n@@ -195,7 +195,7 @@ public class IntegrationTestRegionReplicaPerf extends IntegrationTestBase {\n     Policy p = new PeriodicRandomActionPolicy(sleepTime,\n       new RestartRandomRsExceptMetaAction(sleepTime),\n       new MoveRandomRegionOfTableAction(tableName));\n-    this.monkey = new PolicyBasedChaosMonkey(null, util, p);\n+    this.monkey = new PolicyBasedChaosMonkey(util, p);\n     // don't start monkey right away\n   }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM4NjM2NQ==", "url": "https://github.com/apache/hbase/pull/1217#discussion_r388386365", "bodyText": "Do we really need to specify extra properties when creating policy for all these factories? Otherwise, if this is just duo to the change in PolicyBasedChaosMonkey constructor, it would benefit from overloading the constructor there.", "author": "wchevreuil", "createdAt": "2020-03-05T15:55:06Z", "path": "hbase-it/src/test/java/org/apache/hadoop/hbase/chaos/factories/MobNoKillMonkeyFactory.java", "diffHunk": "@@ -75,7 +75,7 @@\n \n     Action[] actions4 = new Action[] { new DumpClusterStatusAction() };\n \n-    return new PolicyBasedChaosMonkey(util,\n+    return new PolicyBasedChaosMonkey(properties, util,", "originalCommit": "f3dca98d355e6997c5b654177a79fa60ede923b3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODgyNDc4MQ==", "url": "https://github.com/apache/hbase/pull/1217#discussion_r388824781", "bodyText": "I kind of had to. The issue was that Actions do not have access to these properties. This is the main reason we have this clutter in factories where we read the properties and pass them along to the actions in the action constructor, when it could have been an internal thing. So I looked for a way to get these properties to them. (It was a minor issue that Action.init could not use these properties and had to rely on the default values from the config. Passing it along fixed this too.) Anyway the best way to do this was through PolicyBasedChaosMonkey and PolicyContext. Technically I could have just created a setter on PolicyBasedChaosMonkey and leave the constructor alone and call the setter from IntegrationTestBase, but it felt like a bad practice to circumvent a factory.", "author": "BukrosSzabolcs", "createdAt": "2020-03-06T10:25:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM4NjM2NQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "ddd39981b29baca832dfd1dd14be9338369412fc", "url": "https://github.com/apache/hbase/commit/ddd39981b29baca832dfd1dd14be9338369412fc", "message": "HBASE-23891: Add an option to Actions to filter out meta RS\n\noverload the constructor to minimize changes", "committedDate": "2020-03-06T10:23:12Z", "type": "commit"}]}