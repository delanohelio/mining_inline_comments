{"pr_number": 1439, "pr_title": "HBASE-24121 [Authorization] ServiceAuthorizationManager isn't dynamically updatable. And it should be", "pr_createdAt": "2020-04-06T08:46:57Z", "pr_url": "https://github.com/apache/hbase/pull/1439", "timeline": [{"oid": "efc2e027f21c95ac74f3f526b2d3580771d62510", "url": "https://github.com/apache/hbase/commit/efc2e027f21c95ac74f3f526b2d3580771d62510", "message": "HBASE-24121 [Authorization] ServiceAuthorizationManager isn't dynamically updatable. And it should be.", "committedDate": "2020-04-06T08:45:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDI0Njg2Nw==", "url": "https://github.com/apache/hbase/pull/1439#discussion_r404246867", "bodyText": "Regarding thread-safety, do we need to synchronize on authManager while this happens? Otherwise authorize() requests and this init can race and can result in some weird authz results..", "author": "bharathv", "createdAt": "2020-04-06T17:00:12Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/ipc/RpcServer.java", "diffHunk": "@@ -313,6 +314,7 @@ public void onConfigurationChange(Configuration newConf) {\n     if (scheduler instanceof ConfigurationObserver) {\n       ((ConfigurationObserver) scheduler).onConfigurationChange(newConf);\n     }\n+    HBasePolicyProvider.init(newConf, authManager);", "originalCommit": "efc2e027f21c95ac74f3f526b2d3580771d62510", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY3ODc1OA==", "url": "https://github.com/apache/hbase/pull/1439#discussion_r404678758", "bodyText": "Fixed", "author": "Reidddddd", "createdAt": "2020-04-07T09:45:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDI0Njg2Nw=="}], "type": "inlineReview", "revised_code": {"commit": "02daa1541707536f523ffab34670f8d97844ef64", "chunk": "diff --git a/hbase-server/src/main/java/org/apache/hadoop/hbase/ipc/RpcServer.java b/hbase-server/src/main/java/org/apache/hadoop/hbase/ipc/RpcServer.java\nindex 271faed068..d9966ebc60 100644\n--- a/hbase-server/src/main/java/org/apache/hadoop/hbase/ipc/RpcServer.java\n+++ b/hbase-server/src/main/java/org/apache/hadoop/hbase/ipc/RpcServer.java\n\n@@ -314,7 +315,10 @@ public abstract class RpcServer implements RpcServerInterface,\n     if (scheduler instanceof ConfigurationObserver) {\n       ((ConfigurationObserver) scheduler).onConfigurationChange(newConf);\n     }\n-    HBasePolicyProvider.init(newConf, authManager);\n+    synchronized (authManager) {\n+      authManager.refresh(newConf, new HBasePolicyProvider());\n+    }\n+    ProxyUsers.refreshSuperUserGroupsConfiguration(newConf);\n   }\n \n   protected void initReconfigurable(Configuration confToLoad) {\n"}}, {"oid": "02daa1541707536f523ffab34670f8d97844ef64", "url": "https://github.com/apache/hbase/commit/02daa1541707536f523ffab34670f8d97844ef64", "message": "Address review comments", "committedDate": "2020-04-07T09:40:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTAyNDQwMQ==", "url": "https://github.com/apache/hbase/pull/1439#discussion_r405024401", "bodyText": "nit: Add a quick log that we are re-setting the authManager state, probably helps with debugging races later if any..", "author": "bharathv", "createdAt": "2020-04-07T18:30:11Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/ipc/RpcServer.java", "diffHunk": "@@ -313,6 +315,10 @@ public void onConfigurationChange(Configuration newConf) {\n     if (scheduler instanceof ConfigurationObserver) {\n       ((ConfigurationObserver) scheduler).onConfigurationChange(newConf);\n     }\n+    synchronized (authManager) {", "originalCommit": "02daa1541707536f523ffab34670f8d97844ef64", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "38881ae685f7553e95970b534adff28a19c83538", "chunk": "diff --git a/hbase-server/src/main/java/org/apache/hadoop/hbase/ipc/RpcServer.java b/hbase-server/src/main/java/org/apache/hadoop/hbase/ipc/RpcServer.java\nindex d9966ebc60..51b611d104 100644\n--- a/hbase-server/src/main/java/org/apache/hadoop/hbase/ipc/RpcServer.java\n+++ b/hbase-server/src/main/java/org/apache/hadoop/hbase/ipc/RpcServer.java\n\n@@ -315,10 +315,14 @@ public abstract class RpcServer implements RpcServerInterface,\n     if (scheduler instanceof ConfigurationObserver) {\n       ((ConfigurationObserver) scheduler).onConfigurationChange(newConf);\n     }\n+    // Make sure authManager will read hbase-policy file\n+    System.setProperty(\"hadoop.policy.file\", \"hbase-policy.xml\");\n     synchronized (authManager) {\n       authManager.refresh(newConf, new HBasePolicyProvider());\n     }\n+    LOG.info(\"Refreshed {} successfully\", System.getProperties(\"hadoop.policy.file\"));\n     ProxyUsers.refreshSuperUserGroupsConfiguration(newConf);\n+    LOG.info(\"Refreshed super and proxy users successfully\");\n   }\n \n   protected void initReconfigurable(Configuration confToLoad) {\n"}}, {"oid": "38881ae685f7553e95970b534adff28a19c83538", "url": "https://github.com/apache/hbase/commit/38881ae685f7553e95970b534adff28a19c83538", "message": "LOG.info for refreshing policy file", "committedDate": "2020-04-09T04:30:53Z", "type": "commit"}, {"oid": "bbadfdf5a9a7b1287196f8420ec46297cebaac53", "url": "https://github.com/apache/hbase/commit/bbadfdf5a9a7b1287196f8420ec46297cebaac53", "message": "Hard code log info", "committedDate": "2020-04-09T05:30:57Z", "type": "commit"}]}