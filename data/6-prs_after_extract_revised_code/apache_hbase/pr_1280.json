{"pr_number": 1280, "pr_title": "HBASE-23799 Make our core coprocessors use shaded protobuf", "pr_createdAt": "2020-03-12T09:03:58Z", "pr_url": "https://github.com/apache/hbase/pull/1280", "timeline": [{"oid": "817f3b8fb0fda9dfa5accc834e337613dd76103c", "url": "https://github.com/apache/hbase/commit/817f3b8fb0fda9dfa5accc834e337613dd76103c", "message": "HBASE-23799 Make our core coprocessors use shaded protobuf", "committedDate": "2020-03-13T01:00:42Z", "type": "forcePushed"}, {"oid": "2bc94eb847c755b0ddc2d2a6ef23f5d817356791", "url": "https://github.com/apache/hbase/commit/2bc94eb847c755b0ddc2d2a6ef23f5d817356791", "message": "HBASE-23799 Make our core coprocessors use shaded protobuf", "committedDate": "2020-03-13T10:11:15Z", "type": "forcePushed"}, {"oid": "5008cbf3bc8fe30916d22c4580506576a8c1b732", "url": "https://github.com/apache/hbase/commit/5008cbf3bc8fe30916d22c4580506576a8c1b732", "message": "HBASE-23799 Make our core coprocessors use shaded protobuf", "committedDate": "2020-03-13T15:55:18Z", "type": "commit"}, {"oid": "5008cbf3bc8fe30916d22c4580506576a8c1b732", "url": "https://github.com/apache/hbase/commit/5008cbf3bc8fe30916d22c4580506576a8c1b732", "message": "HBASE-23799 Make our core coprocessors use shaded protobuf", "committedDate": "2020-03-13T15:55:18Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzkwNjY5Ng==", "url": "https://github.com/apache/hbase/pull/1280#discussion_r393906696", "bodyText": "What about CPEPs? Will clients now need access to the hbase-shaded-protobuf jar?", "author": "saintstack", "createdAt": "2020-03-17T19:05:11Z", "path": "hbase-client/src/main/java/org/apache/hadoop/hbase/Coprocessor.java", "diffHunk": "@@ -21,11 +21,11 @@\n \n import java.io.IOException;\n import java.util.Collections;\n-\n-import com.google.protobuf.Service;\n import org.apache.yetus.audience.InterfaceAudience;\n import org.apache.yetus.audience.InterfaceStability;\n \n+import org.apache.hbase.thirdparty.com.google.protobuf.Service;\n+", "originalCommit": "5008cbf3bc8fe30916d22c4580506576a8c1b732", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTExOTA2NA==", "url": "https://github.com/apache/hbase/pull/1280#discussion_r395119064", "bodyText": "Yes.", "author": "Apache9", "createdAt": "2020-03-19T15:35:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzkwNjY5Ng=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzkwNzU0NA==", "url": "https://github.com/apache/hbase/pull/1280#discussion_r393907544", "bodyText": "Was this an oversight on our part? These should have been using the shaded versions all along?", "author": "saintstack", "createdAt": "2020-03-17T19:06:40Z", "path": "hbase-client/src/main/java/org/apache/hadoop/hbase/MetaTableAccessor.java", "diffHunk": "@@ -82,6 +77,12 @@\n import org.apache.hbase.thirdparty.com.google.common.annotations.VisibleForTesting;\n import org.apache.hbase.thirdparty.com.google.common.base.Throwables;\n \n+import org.apache.hadoop.hbase.shaded.protobuf.ProtobufUtil;\n+import org.apache.hadoop.hbase.shaded.protobuf.generated.ClientProtos;\n+import org.apache.hadoop.hbase.shaded.protobuf.generated.MultiRowMutationProtos.MultiRowMutationService;\n+import org.apache.hadoop.hbase.shaded.protobuf.generated.MultiRowMutationProtos.MutateRowsRequest;\n+import org.apache.hadoop.hbase.shaded.protobuf.generated.MultiRowMutationProtos.MutateRowsResponse;", "originalCommit": "5008cbf3bc8fe30916d22c4580506576a8c1b732", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTExODY0NQ==", "url": "https://github.com/apache/hbase/pull/1280#discussion_r395118645", "bodyText": "We have multiMutate in this class where we need to make use of MultiRowMutationEndpoint, it is a CPEP so we have to make use of com.google.protobuf instead of the shaded protobuf before this patch.", "author": "Apache9", "createdAt": "2020-03-19T15:34:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzkwNzU0NA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzkwNzYyNw==", "url": "https://github.com/apache/hbase/pull/1280#discussion_r393907627", "bodyText": "Ditto", "author": "saintstack", "createdAt": "2020-03-17T19:06:51Z", "path": "hbase-client/src/main/java/org/apache/hadoop/hbase/client/AdminOverAsyncAdmin.java", "diffHunk": "@@ -71,6 +65,13 @@\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n+import org.apache.hbase.thirdparty.com.google.protobuf.Descriptors.MethodDescriptor;\n+import org.apache.hbase.thirdparty.com.google.protobuf.Message;\n+import org.apache.hbase.thirdparty.com.google.protobuf.RpcCallback;\n+import org.apache.hbase.thirdparty.com.google.protobuf.RpcChannel;\n+import org.apache.hbase.thirdparty.com.google.protobuf.RpcController;\n+import org.apache.hbase.thirdparty.com.google.protobuf.ServiceException;", "originalCommit": "5008cbf3bc8fe30916d22c4580506576a8c1b732", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzkwODQ0Mg==", "url": "https://github.com/apache/hbase/pull/1280#discussion_r393908442", "bodyText": "Yeah, ditto. These are public classes. This stuff is used internally so should be fine just changing it... its just that hbase-shaded-protobuf needs to be on the CLASSPATH? I suppose it was anyways?", "author": "saintstack", "createdAt": "2020-03-17T19:08:28Z", "path": "hbase-client/src/main/java/org/apache/hadoop/hbase/client/AsyncTable.java", "diffHunk": "@@ -35,6 +34,7 @@\n import org.apache.yetus.audience.InterfaceAudience;\n \n import org.apache.hbase.thirdparty.com.google.common.base.Preconditions;\n+import org.apache.hbase.thirdparty.com.google.protobuf.RpcChannel;", "originalCommit": "5008cbf3bc8fe30916d22c4580506576a8c1b732", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTExOTY5NA==", "url": "https://github.com/apache/hbase/pull/1280#discussion_r395119694", "bodyText": "It has to be on the classpath, for normal read write we will make use of the shaded protobuf.", "author": "Apache9", "createdAt": "2020-03-19T15:36:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzkwODQ0Mg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAxNjIyMw==", "url": "https://github.com/apache/hbase/pull/1280#discussion_r394016223", "bodyText": "Good", "author": "saintstack", "createdAt": "2020-03-17T22:52:25Z", "path": "hbase-client/src/main/java/org/apache/hadoop/hbase/client/coprocessor/BigDecimalColumnInterpreter.java", "diffHunk": "@@ -124,7 +125,7 @@ public void initialize(EmptyMsg msg) {\n \n   private BigDecimalMsg getProtoForType(BigDecimal t) {\n     BigDecimalMsg.Builder builder = BigDecimalMsg.newBuilder();\n-    return builder.setBigdecimalMsg(ByteStringer.wrap(Bytes.toBytes(t))).build();\n+    return builder.setBigdecimalMsg(UnsafeByteOperations.unsafeWrap(Bytes.toBytes(t))).build();", "originalCommit": "5008cbf3bc8fe30916d22c4580506576a8c1b732", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA5NzYxMA==", "url": "https://github.com/apache/hbase/pull/1280#discussion_r394097610", "bodyText": "Did I write this comment?\nIn CPEP, there was copying from pb2.5 data structures to internal PB3 data structures -- so we could maintain pb2.5 as public interface but this seems to be something different.", "author": "saintstack", "createdAt": "2020-03-18T04:13:06Z", "path": "hbase-client/src/main/java/org/apache/hadoop/hbase/ipc/CoprocessorRpcUtils.java", "diffHunk": "@@ -87,53 +89,47 @@ public static CoprocessorServiceRequest getCoprocessorServiceRequest(\n   }\n \n   public static CoprocessorServiceRequest getCoprocessorServiceRequest(\n-      final Descriptors.MethodDescriptor method, final Message request, final byte [] row,\n-      final byte [] regionName) {\n-    return CoprocessorServiceRequest.newBuilder().setCall(\n-        getCoprocessorServiceCall(method, request, row)).\n-          setRegion(RequestConverter.buildRegionSpecifier(REGION_NAME, regionName)).build();\n+    final Descriptors.MethodDescriptor method, final Message request, final byte[] row,\n+    final byte[] regionName) {\n+    return CoprocessorServiceRequest.newBuilder()\n+      .setCall(getCoprocessorServiceCall(method, request, row))\n+      .setRegion(RequestConverter.buildRegionSpecifier(REGION_NAME, regionName)).build();\n   }\n \n-  private static CoprocessorServiceCall getCoprocessorServiceCall(\n-      final Descriptors.MethodDescriptor method, final Message request, final byte [] row) {\n+  private static CoprocessorServiceCall getCoprocessorServiceCall(final MethodDescriptor method,\n+    final Message request, final byte[] row) {\n     return CoprocessorServiceCall.newBuilder()\n-    .setRow(org.apache.hbase.thirdparty.com.google.protobuf.UnsafeByteOperations.unsafeWrap(row))\n-    .setServiceName(CoprocessorRpcUtils.getServiceName(method.getService()))\n-    .setMethodName(method.getName())\n-    // TODO!!!!! Come back here after!!!!! This is a double copy of the request if I read\n-    // it right copying from non-shaded to shaded version!!!!!! FIXXXXX!!!!!\n-    .setRequest(org.apache.hbase.thirdparty.com.google.protobuf.UnsafeByteOperations.\n-        unsafeWrap(request.toByteArray())).build();\n+      .setRow(org.apache.hbase.thirdparty.com.google.protobuf.UnsafeByteOperations.unsafeWrap(row))\n+      .setServiceName(CoprocessorRpcUtils.getServiceName(method.getService()))\n+      .setMethodName(method.getName())\n+      // TODO!!!!! Come back here after!!!!! This is a double copy of the request if I read\n+      // it right copying from non-shaded to shaded version!!!!!! FIXXXXX!!!!!", "originalCommit": "5008cbf3bc8fe30916d22c4580506576a8c1b732", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA5Nzg1Mg==", "url": "https://github.com/apache/hbase/pull/1280#discussion_r394097852", "bodyText": "Needed?", "author": "saintstack", "createdAt": "2020-03-18T04:14:09Z", "path": "hbase-client/src/main/java/org/apache/hadoop/hbase/security/token/ClientTokenUtil.java", "diffHunk": "@@ -69,7 +70,7 @@ private static void injectFault() throws ServiceException {\n       AsyncConnection conn) {\n     CompletableFuture<Token<AuthenticationTokenIdentifier>> future = new CompletableFuture<>();\n     if (injectedException != null) {\n-      future.completeExceptionally(injectedException);\n+      future.completeExceptionally(ProtobufUtil.handleRemoteException(injectedException));", "originalCommit": "5008cbf3bc8fe30916d22c4580506576a8c1b732", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA5ODk3Mg==", "url": "https://github.com/apache/hbase/pull/1280#discussion_r394098972", "bodyText": "Yeah, so client now has to have hbase-shaded-protobuf on its side and if we change internal pb version we could break the endpoint?\nRealistically, the pb3 should probably stay on-the-wire compat so should be concern till pb4 or until we decided we want our pbs to be schema v3 compat.", "author": "saintstack", "createdAt": "2020-03-18T04:19:14Z", "path": "hbase-endpoint/src/test/java/org/apache/hadoop/hbase/coprocessor/TestRegionServerCoprocessorEndpoint.java", "diffHunk": "@@ -20,22 +20,14 @@\n import static org.junit.Assert.assertEquals;\n import static org.junit.Assert.assertTrue;\n \n-import com.google.protobuf.RpcCallback;\n-import com.google.protobuf.RpcController;\n-import com.google.protobuf.Service;", "originalCommit": "5008cbf3bc8fe30916d22c4580506576a8c1b732", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTEyMDkxMA==", "url": "https://github.com/apache/hbase/pull/1280#discussion_r395120910", "bodyText": "In previous discussion the idea is to keep the protobuf version 'stable' for a whole major release.", "author": "Apache9", "createdAt": "2020-03-19T15:37:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA5ODk3Mg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA5OTkyNg==", "url": "https://github.com/apache/hbase/pull/1280#discussion_r394099926", "bodyText": "This class should be removed?", "author": "saintstack", "createdAt": "2020-03-18T04:23:35Z", "path": "hbase-rest/src/main/java/org/apache/hadoop/hbase/rest/client/RemoteHTable.java", "diffHunk": "@@ -77,6 +73,10 @@\n import org.slf4j.LoggerFactory;\n \n import org.apache.hbase.thirdparty.com.google.common.base.Preconditions;\n+import org.apache.hbase.thirdparty.com.google.protobuf.Descriptors;\n+import org.apache.hbase.thirdparty.com.google.protobuf.Message;\n+import org.apache.hbase.thirdparty.com.google.protobuf.Service;\n+import org.apache.hbase.thirdparty.com.google.protobuf.ServiceException;\n \n /**\n  * HTable interface to remote tables accessed via REST gateway", "originalCommit": "5008cbf3bc8fe30916d22c4580506576a8c1b732", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTEyMjE1OQ==", "url": "https://github.com/apache/hbase/pull/1280#discussion_r395122159", "bodyText": "No? It is the Table implementation for rest.", "author": "Apache9", "createdAt": "2020-03-19T15:39:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA5OTkyNg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDEwMDE4NA==", "url": "https://github.com/apache/hbase/pull/1280#discussion_r394100184", "bodyText": "What happens when an old CP impl tries to go against hbase3?", "author": "saintstack", "createdAt": "2020-03-18T04:24:58Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/MasterRpcServices.java", "diffHunk": "@@ -1985,21 +1985,20 @@ public SecurityCapabilitiesResponse getSecurityCapabilities(RpcController contro\n \n   /**\n    * Determines if there is a MasterCoprocessor deployed which implements\n-   * {@link org.apache.hadoop.hbase.protobuf.generated.AccessControlProtos.AccessControlService.Interface}.\n+   * {@link AccessControlService.Interface}.\n    */\n   boolean hasAccessControlServiceCoprocessor(MasterCoprocessorHost cpHost) {\n-    return checkCoprocessorWithService(\n-        cpHost.findCoprocessors(MasterCoprocessor.class), AccessControlService.Interface.class);\n+    return checkCoprocessorWithService(cpHost.findCoprocessors(MasterCoprocessor.class),\n+      AccessControlService.Interface.class);\n   }\n \n   /**\n    * Determines if there is a MasterCoprocessor deployed which implements\n-   * {@link org.apache.hadoop.hbase.protobuf.generated.VisibilityLabelsProtos.VisibilityLabelsService.Interface}.\n+   * {@link VisibilityLabelsService.Interface}.\n    */\n   boolean hasVisibilityLabelsServiceCoprocessor(MasterCoprocessorHost cpHost) {\n-    return checkCoprocessorWithService(\n-        cpHost.findCoprocessors(MasterCoprocessor.class),\n-        VisibilityLabelsService.Interface.class);\n+    return checkCoprocessorWithService(cpHost.findCoprocessors(MasterCoprocessor.class),\n+      VisibilityLabelsService.Interface.class);\n   }\n \n   /**", "originalCommit": "5008cbf3bc8fe30916d22c4580506576a8c1b732", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTEyMzgwOQ==", "url": "https://github.com/apache/hbase/pull/1280#discussion_r395123809", "bodyText": "if you use the CP client to talk to hbase3 then it should be fire, the shaded and non-shaded version are wire compatible, but the CPs at server side should be recompiled to make use of the shaded protobuf version. This maybe a bit difficult for users, we should tell user how to do the replacement on the generated protobuf classes.", "author": "Apache9", "createdAt": "2020-03-19T15:41:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDEwMDE4NA=="}], "type": "inlineReview", "revised_code": null}]}