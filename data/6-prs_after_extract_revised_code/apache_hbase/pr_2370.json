{"pr_number": 2370, "pr_title": "HBASE-25002 Create simple pattern matching query for retrieving metri\u2026", "pr_createdAt": "2020-09-09T10:01:39Z", "pr_url": "https://github.com/apache/hbase/pull/2370", "timeline": [{"oid": "ba783659c943dd1916568685aa0dab0b7a883403", "url": "https://github.com/apache/hbase/commit/ba783659c943dd1916568685aa0dab0b7a883403", "message": "HBASE-25002 Create simple pattern matching query for retrieving metrics matching the pattern", "committedDate": "2020-09-09T09:54:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjExNTczNw==", "url": "https://github.com/apache/hbase/pull/2370#discussion_r486115737", "bodyText": "Wanted this log level change?", "author": "anoopsjohn", "createdAt": "2020-09-10T07:13:39Z", "path": "hbase-http/src/main/java/org/apache/hadoop/hbase/util/JSONBean.java", "diffHunk": "@@ -125,11 +130,13 @@ public int write(MBeanServer mBeanServer, ObjectName qry, String attribute,\n    */\n   private static int write(JsonWriter writer, MBeanServer mBeanServer, ObjectName qry,\n       String attribute, boolean description) throws IOException {\n-    LOG.trace(\"Listing beans for \" + qry);\n+    LOG.debug(\"Listing beans for \" + qry);", "originalCommit": "ba783659c943dd1916568685aa0dab0b7a883403", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjEyNTc3OQ==", "url": "https://github.com/apache/hbase/pull/2370#discussion_r486125779", "bodyText": "I changed it so that later we can debug it to know what is the query. Generally setting debug level is what we do for debugging so I just changed it. I can revert it if needed.", "author": "ramkrish86", "createdAt": "2020-09-10T07:32:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjExNTczNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjIzNzU1NQ==", "url": "https://github.com/apache/hbase/pull/2370#discussion_r486237555", "bodyText": "Ok to change. Can u also change to use {} format log line. Anyways that will be nice to have", "author": "anoopsjohn", "createdAt": "2020-09-10T10:37:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjExNTczNw=="}], "type": "inlineReview", "revised_code": {"commit": "55f8e1795cd54f0bba3a0fd6733d5f6553316505", "chunk": "diff --git a/hbase-http/src/main/java/org/apache/hadoop/hbase/util/JSONBean.java b/hbase-http/src/main/java/org/apache/hadoop/hbase/util/JSONBean.java\nindex d116372443..112d624983 100644\n--- a/hbase-http/src/main/java/org/apache/hadoop/hbase/util/JSONBean.java\n+++ b/hbase-http/src/main/java/org/apache/hadoop/hbase/util/JSONBean.java\n\n@@ -135,8 +136,7 @@ public class JSONBean {\n     names = mBeanServer.queryNames(qry, null);\n     writer.name(\"beans\").beginArray();\n     Iterator<ObjectName> it = names.iterator();\n-    boolean pattern = false;\n-    String[] patternAttr = null;\n+    Pattern[] matchingPattern = null;\n     while (it.hasNext()) {\n       ObjectName oname = it.next();\n       MBeanInfo minfo;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjExODE5MQ==", "url": "https://github.com/apache/hbase/pull/2370#discussion_r486118191", "bodyText": "You can avoid this boolean. Just use String[] and check for null value and call diff write methods?", "author": "anoopsjohn", "createdAt": "2020-09-10T07:18:28Z", "path": "hbase-http/src/main/java/org/apache/hadoop/hbase/util/JSONBean.java", "diffHunk": "@@ -125,11 +130,13 @@ public int write(MBeanServer mBeanServer, ObjectName qry, String attribute,\n    */\n   private static int write(JsonWriter writer, MBeanServer mBeanServer, ObjectName qry,\n       String attribute, boolean description) throws IOException {\n-    LOG.trace(\"Listing beans for \" + qry);\n+    LOG.debug(\"Listing beans for \" + qry);\n     Set<ObjectName> names = null;\n     names = mBeanServer.queryNames(qry, null);\n     writer.name(\"beans\").beginArray();\n     Iterator<ObjectName> it = names.iterator();\n+    boolean pattern = false;", "originalCommit": "ba783659c943dd1916568685aa0dab0b7a883403", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjEyNjI1OQ==", "url": "https://github.com/apache/hbase/pull/2370#discussion_r486126259", "bodyText": "Ok", "author": "ramkrish86", "createdAt": "2020-09-10T07:33:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjExODE5MQ=="}], "type": "inlineReview", "revised_code": {"commit": "55f8e1795cd54f0bba3a0fd6733d5f6553316505", "chunk": "diff --git a/hbase-http/src/main/java/org/apache/hadoop/hbase/util/JSONBean.java b/hbase-http/src/main/java/org/apache/hadoop/hbase/util/JSONBean.java\nindex d116372443..112d624983 100644\n--- a/hbase-http/src/main/java/org/apache/hadoop/hbase/util/JSONBean.java\n+++ b/hbase-http/src/main/java/org/apache/hadoop/hbase/util/JSONBean.java\n\n@@ -135,8 +136,7 @@ public class JSONBean {\n     names = mBeanServer.queryNames(qry, null);\n     writer.name(\"beans\").beginArray();\n     Iterator<ObjectName> it = names.iterator();\n-    boolean pattern = false;\n-    String[] patternAttr = null;\n+    Pattern[] matchingPattern = null;\n     while (it.hasNext()) {\n       ObjectName oname = it.next();\n       MBeanInfo minfo;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjEyMDY2OQ==", "url": "https://github.com/apache/hbase/pull/2370#discussion_r486120669", "bodyText": "We are compiling this pattern for each and every MBean attribute.  This will be costly. we could have compiled the attribute and kept that in an Array at 1st step itself (instead of keeping the regex patterns in String[])", "author": "anoopsjohn", "createdAt": "2020-09-10T07:23:03Z", "path": "hbase-http/src/main/java/org/apache/hadoop/hbase/util/JSONBean.java", "diffHunk": "@@ -237,6 +267,22 @@ private static void writeAttribute(JsonWriter writer, MBeanServer mBeanServer, O\n     if (attName.indexOf(\"=\") >= 0 || attName.indexOf(\":\") >= 0 || attName.indexOf(\" \") >= 0) {\n       return;\n     }\n+\n+    if (pattern != null) {\n+      boolean matchFound = false;\n+      for (String patt : pattern) {\n+        Pattern compile = Pattern.compile(patt);", "originalCommit": "ba783659c943dd1916568685aa0dab0b7a883403", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjEyNjIxNw==", "url": "https://github.com/apache/hbase/pull/2370#discussion_r486126217", "bodyText": "Ya ok . I did not do it thinking we are not doing this thing much often. May be once a while. I can change it though.", "author": "ramkrish86", "createdAt": "2020-09-10T07:33:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjEyMDY2OQ=="}], "type": "inlineReview", "revised_code": {"commit": "55f8e1795cd54f0bba3a0fd6733d5f6553316505", "chunk": "diff --git a/hbase-http/src/main/java/org/apache/hadoop/hbase/util/JSONBean.java b/hbase-http/src/main/java/org/apache/hadoop/hbase/util/JSONBean.java\nindex d116372443..112d624983 100644\n--- a/hbase-http/src/main/java/org/apache/hadoop/hbase/util/JSONBean.java\n+++ b/hbase-http/src/main/java/org/apache/hadoop/hbase/util/JSONBean.java\n\n@@ -270,8 +274,7 @@ public class JSONBean {\n \n     if (pattern != null) {\n       boolean matchFound = false;\n-      for (String patt : pattern) {\n-        Pattern compile = Pattern.compile(patt);\n+      for (Pattern compile : pattern) {\n         // check if we have any match\n         if (compile.matcher(attName).find()) {\n           matchFound = true;\n"}}, {"oid": "55f8e1795cd54f0bba3a0fd6733d5f6553316505", "url": "https://github.com/apache/hbase/commit/55f8e1795cd54f0bba3a0fd6733d5f6553316505", "message": "Address review comments", "committedDate": "2020-09-10T07:41:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjIzODg5Mw==", "url": "https://github.com/apache/hbase/pull/2370#discussion_r486238893", "bodyText": "Infact u can see we dont need such if else, end of the day we call same writeAttribute which is having Pattern[] arg and we have null check there anyways.", "author": "anoopsjohn", "createdAt": "2020-09-10T10:40:32Z", "path": "hbase-http/src/main/java/org/apache/hadoop/hbase/util/JSONBean.java", "diffHunk": "@@ -216,7 +239,12 @@ private static int write(JsonWriter writer, MBeanServer mBeanServer, ObjectName\n       } else {\n         MBeanAttributeInfo[] attrs = minfo.getAttributes();\n         for (int i = 0; i < attrs.length; i++) {\n-          writeAttribute(writer, mBeanServer, oname, description, attrs[i]);\n+          if (matchingPattern != null) {", "originalCommit": "55f8e1795cd54f0bba3a0fd6733d5f6553316505", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "02bd4874545f693bf5fe44d4fe3c8338a8233152", "chunk": "diff --git a/hbase-http/src/main/java/org/apache/hadoop/hbase/util/JSONBean.java b/hbase-http/src/main/java/org/apache/hadoop/hbase/util/JSONBean.java\nindex 112d624983..7c79300455 100644\n--- a/hbase-http/src/main/java/org/apache/hadoop/hbase/util/JSONBean.java\n+++ b/hbase-http/src/main/java/org/apache/hadoop/hbase/util/JSONBean.java\n\n@@ -239,12 +239,7 @@ public class JSONBean {\n       } else {\n         MBeanAttributeInfo[] attrs = minfo.getAttributes();\n         for (int i = 0; i < attrs.length; i++) {\n-          if (matchingPattern != null) {\n-            writeAttribute(writer, mBeanServer, oname, description, attrs[i], matchingPattern);\n-          } else {\n-            writeAttribute(writer, mBeanServer, oname, description, attrs[i]);\n-          }\n-\n+          writeAttribute(writer, mBeanServer, oname, description, attrs[i], matchingPattern);\n         }\n       }\n       writer.endObject();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjIzODk4OA==", "url": "https://github.com/apache/hbase/pull/2370#discussion_r486238988", "bodyText": "Ya even this also not needed.", "author": "anoopsjohn", "createdAt": "2020-09-10T10:40:43Z", "path": "hbase-http/src/main/java/org/apache/hadoop/hbase/util/JSONBean.java", "diffHunk": "@@ -225,8 +253,14 @@ private static int write(JsonWriter writer, MBeanServer mBeanServer, ObjectName\n     return 0;\n   }\n \n+  private static void writeAttribute(final JsonWriter jg, final MBeanServer mBeanServer,", "originalCommit": "55f8e1795cd54f0bba3a0fd6733d5f6553316505", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "02bd4874545f693bf5fe44d4fe3c8338a8233152", "chunk": "diff --git a/hbase-http/src/main/java/org/apache/hadoop/hbase/util/JSONBean.java b/hbase-http/src/main/java/org/apache/hadoop/hbase/util/JSONBean.java\nindex 112d624983..7c79300455 100644\n--- a/hbase-http/src/main/java/org/apache/hadoop/hbase/util/JSONBean.java\n+++ b/hbase-http/src/main/java/org/apache/hadoop/hbase/util/JSONBean.java\n\n@@ -253,12 +248,6 @@ public class JSONBean {\n     return 0;\n   }\n \n-  private static void writeAttribute(final JsonWriter jg, final MBeanServer mBeanServer,\n-      ObjectName oname, final boolean description, final MBeanAttributeInfo attr)\n-      throws IOException {\n-    writeAttribute(jg, mBeanServer, oname, description, attr, null);\n-  }\n-\n   private static void writeAttribute(JsonWriter writer, MBeanServer mBeanServer, ObjectName oname,\n       boolean description, MBeanAttributeInfo attr, Pattern pattern[]) throws IOException {\n     if (!attr.isReadable()) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjI0MDEzMQ==", "url": "https://github.com/apache/hbase/pull/2370#discussion_r486240131", "bodyText": "Call its  pattern : patterns?", "author": "anoopsjohn", "createdAt": "2020-09-10T10:43:00Z", "path": "hbase-http/src/main/java/org/apache/hadoop/hbase/util/JSONBean.java", "diffHunk": "@@ -237,6 +271,21 @@ private static void writeAttribute(JsonWriter writer, MBeanServer mBeanServer, O\n     if (attName.indexOf(\"=\") >= 0 || attName.indexOf(\":\") >= 0 || attName.indexOf(\" \") >= 0) {\n       return;\n     }\n+\n+    if (pattern != null) {\n+      boolean matchFound = false;\n+      for (Pattern compile : pattern) {", "originalCommit": "55f8e1795cd54f0bba3a0fd6733d5f6553316505", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "02bd4874545f693bf5fe44d4fe3c8338a8233152", "url": "https://github.com/apache/hbase/commit/02bd4874545f693bf5fe44d4fe3c8338a8233152", "message": "Final set of comments addressed", "committedDate": "2020-09-10T16:36:22Z", "type": "commit"}, {"oid": "3e713f7ee526c87cb127cc50a48c21335bf96e30", "url": "https://github.com/apache/hbase/commit/3e713f7ee526c87cb127cc50a48c21335bf96e30", "message": "Address checkstyle comments", "committedDate": "2020-09-14T05:34:05Z", "type": "commit"}]}