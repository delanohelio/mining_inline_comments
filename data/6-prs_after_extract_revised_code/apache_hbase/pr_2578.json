{"pr_number": 2578, "pr_title": "HBASE-24768 Clear cached service kerberos ticket in case of SASL fail\u2026", "pr_createdAt": "2020-10-22T02:41:58Z", "pr_url": "https://github.com/apache/hbase/pull/2578", "timeline": [{"oid": "61fc88074569d3010ada9aa1d8de7604be69364c", "url": "https://github.com/apache/hbase/commit/61fc88074569d3010ada9aa1d8de7604be69364c", "message": "HBASE-24768 Clear cached service kerberos ticket in case of SASL failures thrown from server side", "committedDate": "2020-10-22T02:40:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA4ODc3NQ==", "url": "https://github.com/apache/hbase/pull/2578#discussion_r511088775", "bodyText": "Is there a reason this shouldn't default to 'true'? Otherwise we don't clear the cache and we should?", "author": "apurtell", "createdAt": "2020-10-23T19:05:57Z", "path": "hbase-client/src/main/java/org/apache/hadoop/hbase/ipc/RpcConnection.java", "diffHunk": "@@ -126,8 +136,13 @@ protected RpcConnection(Configuration conf, HashedWheelTimer timeoutTimer, Conne\n       LOG.debug(\"Use \" + authMethod + \" authentication for service \" + remoteId.serviceName\n           + \", sasl=\" + useSasl);\n     }\n+\n     reloginMaxBackoff = conf.getInt(\"hbase.security.relogin.maxbackoff\", 5000);\n     this.remoteId = remoteId;\n+\n+    forceReloginEnabled = conf.getBoolean(\"hbase.security.force.relogin.enabled\", false);", "originalCommit": "61fc88074569d3010ada9aa1d8de7604be69364c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTI0MTk0MA==", "url": "https://github.com/apache/hbase/pull/2578#discussion_r511241940", "bodyText": "Yeah, that's a good point. we can actually default it to true and since the default minimum time between is anyways 10 mins which matches with that of the time in UGI for non forceful logins", "author": "sguggilam", "createdAt": "2020-10-24T01:39:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA4ODc3NQ=="}], "type": "inlineReview", "revised_code": {"commit": "57ceb69e0c4deab90e7634e63a3ef7ceabb91229", "chunk": "diff --git a/hbase-client/src/main/java/org/apache/hadoop/hbase/ipc/RpcConnection.java b/hbase-client/src/main/java/org/apache/hadoop/hbase/ipc/RpcConnection.java\nindex 605b889a5c..d39013bd27 100644\n--- a/hbase-client/src/main/java/org/apache/hadoop/hbase/ipc/RpcConnection.java\n+++ b/hbase-client/src/main/java/org/apache/hadoop/hbase/ipc/RpcConnection.java\n\n@@ -137,12 +138,13 @@ abstract class RpcConnection {\n           + \", sasl=\" + useSasl);\n     }\n \n-    reloginMaxBackoff = conf.getInt(\"hbase.security.relogin.maxbackoff\", 5000);\n+    reloginMaxBackoff = conf.getInt(HConstants.HBASE_RELOGIN_MAXBACKOFF, 5000);\n     this.remoteId = remoteId;\n \n-    forceReloginEnabled = conf.getBoolean(\"hbase.security.force.relogin.enabled\", false);\n+    forceReloginEnabled = conf.getBoolean(HConstants.HBASE_FORCE_RELOGIN_ENABLED, true);\n     // Default minimum time between force relogin attempts is 10 minutes\n-    this.forceReloginBackoff = conf.getInt(\"hbase.security.force.relogin.backoff\", 10 * 60 * 1000);\n+    this.minTimeBeforeForceRelogin =\n+        conf.getInt(HConstants.HBASE_MINTIME_BEFORE_FORCE_RELOGIN, 10 * 60 * 1000);\n   }\n \n   private UserInformation getUserInfo(UserGroupInformation ugi) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA4OTk3NQ==", "url": "https://github.com/apache/hbase/pull/2578#discussion_r511089975", "bodyText": "Isn't this confusing now? Consider an operator or a tech writer looking at this code. What does \"maxbackoff\" mean? It's not the max time we would back off (5 seconds?) when now there is \"hbase.security.force.relogin.backoff\" at 600000 I assume milliseconds. These things need better naming, as an operator I have no clear idea what to do here.", "author": "apurtell", "createdAt": "2020-10-23T19:08:16Z", "path": "hbase-client/src/main/java/org/apache/hadoop/hbase/ipc/RpcConnection.java", "diffHunk": "@@ -126,8 +136,13 @@ protected RpcConnection(Configuration conf, HashedWheelTimer timeoutTimer, Conne\n       LOG.debug(\"Use \" + authMethod + \" authentication for service \" + remoteId.serviceName\n           + \", sasl=\" + useSasl);\n     }\n+\n     reloginMaxBackoff = conf.getInt(\"hbase.security.relogin.maxbackoff\", 5000);", "originalCommit": "61fc88074569d3010ada9aa1d8de7604be69364c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA5MTkzNg==", "url": "https://github.com/apache/hbase/pull/2578#discussion_r511091936", "bodyText": "While we are at it, please make these configuration keys string constants.", "author": "apurtell", "createdAt": "2020-10-23T19:10:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA4OTk3NQ=="}], "type": "inlineReview", "revised_code": {"commit": "57ceb69e0c4deab90e7634e63a3ef7ceabb91229", "chunk": "diff --git a/hbase-client/src/main/java/org/apache/hadoop/hbase/ipc/RpcConnection.java b/hbase-client/src/main/java/org/apache/hadoop/hbase/ipc/RpcConnection.java\nindex 605b889a5c..d39013bd27 100644\n--- a/hbase-client/src/main/java/org/apache/hadoop/hbase/ipc/RpcConnection.java\n+++ b/hbase-client/src/main/java/org/apache/hadoop/hbase/ipc/RpcConnection.java\n\n@@ -137,12 +138,13 @@ abstract class RpcConnection {\n           + \", sasl=\" + useSasl);\n     }\n \n-    reloginMaxBackoff = conf.getInt(\"hbase.security.relogin.maxbackoff\", 5000);\n+    reloginMaxBackoff = conf.getInt(HConstants.HBASE_RELOGIN_MAXBACKOFF, 5000);\n     this.remoteId = remoteId;\n \n-    forceReloginEnabled = conf.getBoolean(\"hbase.security.force.relogin.enabled\", false);\n+    forceReloginEnabled = conf.getBoolean(HConstants.HBASE_FORCE_RELOGIN_ENABLED, true);\n     // Default minimum time between force relogin attempts is 10 minutes\n-    this.forceReloginBackoff = conf.getInt(\"hbase.security.force.relogin.backoff\", 10 * 60 * 1000);\n+    this.minTimeBeforeForceRelogin =\n+        conf.getInt(HConstants.HBASE_MINTIME_BEFORE_FORCE_RELOGIN, 10 * 60 * 1000);\n   }\n \n   private UserInformation getUserInfo(UserGroupInformation ugi) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA5MDI3NQ==", "url": "https://github.com/apache/hbase/pull/2578#discussion_r511090275", "bodyText": "See above comment. These config names do not help an operator to know what to do at all.", "author": "apurtell", "createdAt": "2020-10-23T19:08:40Z", "path": "hbase-client/src/main/java/org/apache/hadoop/hbase/ipc/RpcConnection.java", "diffHunk": "@@ -126,8 +136,13 @@ protected RpcConnection(Configuration conf, HashedWheelTimer timeoutTimer, Conne\n       LOG.debug(\"Use \" + authMethod + \" authentication for service \" + remoteId.serviceName\n           + \", sasl=\" + useSasl);\n     }\n+\n     reloginMaxBackoff = conf.getInt(\"hbase.security.relogin.maxbackoff\", 5000);\n     this.remoteId = remoteId;\n+\n+    forceReloginEnabled = conf.getBoolean(\"hbase.security.force.relogin.enabled\", false);\n+    // Default minimum time between force relogin attempts is 10 minutes\n+    this.forceReloginBackoff = conf.getInt(\"hbase.security.force.relogin.backoff\", 10 * 60 * 1000);", "originalCommit": "61fc88074569d3010ada9aa1d8de7604be69364c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "57ceb69e0c4deab90e7634e63a3ef7ceabb91229", "chunk": "diff --git a/hbase-client/src/main/java/org/apache/hadoop/hbase/ipc/RpcConnection.java b/hbase-client/src/main/java/org/apache/hadoop/hbase/ipc/RpcConnection.java\nindex 605b889a5c..d39013bd27 100644\n--- a/hbase-client/src/main/java/org/apache/hadoop/hbase/ipc/RpcConnection.java\n+++ b/hbase-client/src/main/java/org/apache/hadoop/hbase/ipc/RpcConnection.java\n\n@@ -137,12 +138,13 @@ abstract class RpcConnection {\n           + \", sasl=\" + useSasl);\n     }\n \n-    reloginMaxBackoff = conf.getInt(\"hbase.security.relogin.maxbackoff\", 5000);\n+    reloginMaxBackoff = conf.getInt(HConstants.HBASE_RELOGIN_MAXBACKOFF, 5000);\n     this.remoteId = remoteId;\n \n-    forceReloginEnabled = conf.getBoolean(\"hbase.security.force.relogin.enabled\", false);\n+    forceReloginEnabled = conf.getBoolean(HConstants.HBASE_FORCE_RELOGIN_ENABLED, true);\n     // Default minimum time between force relogin attempts is 10 minutes\n-    this.forceReloginBackoff = conf.getInt(\"hbase.security.force.relogin.backoff\", 10 * 60 * 1000);\n+    this.minTimeBeforeForceRelogin =\n+        conf.getInt(HConstants.HBASE_MINTIME_BEFORE_FORCE_RELOGIN, 10 * 60 * 1000);\n   }\n \n   private UserInformation getUserInfo(UserGroupInformation ugi) {\n"}}, {"oid": "57ceb69e0c4deab90e7634e63a3ef7ceabb91229", "url": "https://github.com/apache/hbase/commit/57ceb69e0c4deab90e7634e63a3ef7ceabb91229", "message": "Better renaming of configuration key for force relogin attempts", "committedDate": "2020-10-26T20:50:28Z", "type": "commit"}]}