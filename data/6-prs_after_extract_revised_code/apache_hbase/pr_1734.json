{"pr_number": 1734, "pr_title": "HBASE-24376 MergeNormalizer is merging non-adjacent regions and causi\u2026", "pr_createdAt": "2020-05-18T19:22:05Z", "pr_url": "https://github.com/apache/hbase/pull/1734", "timeline": [{"oid": "056fcbbb48d6eb96af5bd8e6e2abc9290ed10e1a", "url": "https://github.com/apache/hbase/commit/056fcbbb48d6eb96af5bd8e6e2abc9290ed10e1a", "message": "HBASE-24376 MergeNormalizer is merging non-adjacent regions and causing region overlaps/holes.", "committedDate": "2020-05-18T20:02:55Z", "type": "forcePushed"}, {"oid": "2a22c5e7006527ded9269b16e168733643a52f4c", "url": "https://github.com/apache/hbase/commit/2a22c5e7006527ded9269b16e168733643a52f4c", "message": "HBASE-24376 MergeNormalizer is merging non-adjacent regions and causing region overlaps/holes.", "committedDate": "2020-05-18T20:34:01Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkwMDcxMg==", "url": "https://github.com/apache/hbase/pull/1734#discussion_r426900712", "bodyText": "Duh", "author": "saintstack", "createdAt": "2020-05-18T21:23:20Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/normalizer/AbstractRegionNormalizer.java", "diffHunk": "@@ -170,6 +170,8 @@ private static boolean skipForMerge(final RegionState state) {\n         + \"number of regions: {}\",\n       table, avgRegionSize, table, tableRegions.size());\n \n+    // Sorting based on RegionInfo.COMPARATOR.\n+    tableRegions.sort(RegionInfo.COMPARATOR);", "originalCommit": "2a22c5e7006527ded9269b16e168733643a52f4c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "0d78ebf2d4316f2c95489dfbe4caf433c507bba0", "chunk": "diff --git a/hbase-server/src/main/java/org/apache/hadoop/hbase/master/normalizer/AbstractRegionNormalizer.java b/hbase-server/src/main/java/org/apache/hadoop/hbase/master/normalizer/AbstractRegionNormalizer.java\nindex a4e2769f0e..8b17f77dc9 100644\n--- a/hbase-server/src/main/java/org/apache/hadoop/hbase/master/normalizer/AbstractRegionNormalizer.java\n+++ b/hbase-server/src/main/java/org/apache/hadoop/hbase/master/normalizer/AbstractRegionNormalizer.java\n\n@@ -170,7 +170,11 @@ public abstract class AbstractRegionNormalizer implements RegionNormalizer {\n         + \"number of regions: {}\",\n       table, avgRegionSize, table, tableRegions.size());\n \n-    // Sorting based on RegionInfo.COMPARATOR.\n+    // The list of regionInfo from getRegionsOfTable() is ordered by regionName.\n+    // regionName does not necessary guarantee the order by STARTKEY (let's say 'aa1', 'aa1!',\n+    // in order by regionName, it will be 'aa1!' followed by 'aa1').\n+    // This could result in normalizer merging non-adjacent regions into one and creates overlaps.\n+    // In order to avoid that, sort the list by RegionInfo.COMPARATOR.\n     tableRegions.sort(RegionInfo.COMPARATOR);\n     final List<NormalizationPlan> plans = new ArrayList<>();\n     for (int candidateIdx = 0; candidateIdx < tableRegions.size() - 1; candidateIdx++) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkwMDc5NQ==", "url": "https://github.com/apache/hbase/pull/1734#discussion_r426900795", "bodyText": "Great", "author": "saintstack", "createdAt": "2020-05-18T21:23:30Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/normalizer/MergeNormalizationPlan.java", "diffHunk": "@@ -69,8 +69,11 @@ public String toString() {\n   public void execute(Admin admin) {\n     LOG.info(\"Executing merging normalization plan: \" + this);\n     try {\n+      // Do not use force=true as corner cases can happen, non adjacent regions,\n+      // merge with a merged child region with no GC done yet, it is going to\n+      // cause all different issues.\n       admin.mergeRegionsAsync(firstRegion.getEncodedNameAsBytes(),\n-        secondRegion.getEncodedNameAsBytes(), true);\n+        secondRegion.getEncodedNameAsBytes(), false);", "originalCommit": "2a22c5e7006527ded9269b16e168733643a52f4c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzIzNTg5MA==", "url": "https://github.com/apache/hbase/pull/1734#discussion_r427235890", "bodyText": "Wondering if this is the only change required.", "author": "virajjasani", "createdAt": "2020-05-19T11:41:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkwMDc5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzM4MTY1OQ==", "url": "https://github.com/apache/hbase/pull/1734#discussion_r427381659", "bodyText": "Okk I just saw the conversation on why tableRegions.sort(RegionInfo.COMPARATOR) is required.", "author": "virajjasani", "createdAt": "2020-05-19T15:12:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkwMDc5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQzOTAxOQ==", "url": "https://github.com/apache/hbase/pull/1734#discussion_r427439019", "bodyText": "Yeah, I will put up more comments there.", "author": "huaxiangsun", "createdAt": "2020-05-19T16:32:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkwMDc5NQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkwNDg1OA==", "url": "https://github.com/apache/hbase/pull/1734#discussion_r426904858", "bodyText": "Can you please add the missing Javadoc?", "author": "HorizonNet", "createdAt": "2020-05-18T21:32:46Z", "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/HBaseTestingUtility.java", "diffHunk": "@@ -1519,6 +1519,17 @@ public Table createMultiRegionTable(TableName tableName, byte[][] families) thro\n     return createTable(tableName, families, KEYS_FOR_HBA_CREATE_TABLE);\n   }\n \n+  /**\n+   * Create a table with multiple regions.\n+   * @param tableName", "originalCommit": "2a22c5e7006527ded9269b16e168733643a52f4c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkwOTI0MQ==", "url": "https://github.com/apache/hbase/pull/1734#discussion_r426909241", "bodyText": "Will update the comments.", "author": "huaxiangsun", "createdAt": "2020-05-18T21:43:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkwNDg1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjk1NzMzMg==", "url": "https://github.com/apache/hbase/pull/1734#discussion_r426957332", "bodyText": "It is removed in the latest patch.", "author": "huaxiangsun", "createdAt": "2020-05-19T00:07:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkwNDg1OA=="}], "type": "inlineReview", "revised_code": {"commit": "6834afd4b7aa9aa4571c332c12ae6bb316840c73", "chunk": "diff --git a/hbase-server/src/test/java/org/apache/hadoop/hbase/HBaseTestingUtility.java b/hbase-server/src/test/java/org/apache/hadoop/hbase/HBaseTestingUtility.java\nindex 9f97178ce9..30a7841bba 100644\n--- a/hbase-server/src/test/java/org/apache/hadoop/hbase/HBaseTestingUtility.java\n+++ b/hbase-server/src/test/java/org/apache/hadoop/hbase/HBaseTestingUtility.java\n\n@@ -1519,17 +1519,6 @@ public class HBaseTestingUtility extends HBaseZKTestingUtility {\n     return createTable(tableName, families, KEYS_FOR_HBA_CREATE_TABLE);\n   }\n \n-  /**\n-   * Create a table with multiple regions.\n-   * @param tableName\n-   * @param families\n-   * @return A Table instance for the created table.\n-   * @throws IOException\n-   */\n-  public Table createMultiRegionTable(TableName tableName, byte[][] families, final byte[][]  keys) throws IOException {\n-    return createTable(tableName, families, keys);\n-  }\n-\n   /**\n    * Create a table.\n    * @param tableName\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkwNTExNg==", "url": "https://github.com/apache/hbase/pull/1734#discussion_r426905116", "bodyText": "What deprecations are needed here?", "author": "HorizonNet", "createdAt": "2020-05-18T21:33:20Z", "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/master/normalizer/TestSimpleRegionNormalizerOnCluster.java", "diffHunk": "@@ -179,6 +182,71 @@ void testRegionNormalizationSplitOnCluster(boolean limitedByQuota) throws Except\n     admin.deleteTable(TABLENAME);\n   }\n \n+  // This test is to make sure that normalizer is only going to merge adjacent regions.\n+  @Test\n+  @SuppressWarnings(\"deprecation\")", "originalCommit": "2a22c5e7006527ded9269b16e168733643a52f4c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkwOTA2Nw==", "url": "https://github.com/apache/hbase/pull/1734#discussion_r426909067", "bodyText": "There is no better way to copy families/values from an existing table descriptor, I tried to use a non-deprecated method, but ModifyableTableDescriptor(tableName, admin.getDescriptor(tableName)) is the best one, which is deprecated. It is important to keep all the parameters to keep previous written data.", "author": "huaxiangsun", "createdAt": "2020-05-18T21:42:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkwNTExNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkxODUxOQ==", "url": "https://github.com/apache/hbase/pull/1734#discussion_r426918519", "bodyText": "There's a new API you can use instead of this deprecated one. I think you want something like\n    final TableDescriptor td = TableDescriptorBuilder\n      .newBuilder(admin.getDescriptor(TABLENAME))\n      .setNormalizationEnabled(true)\n      .build();\n    admin.modifyTable(td);", "author": "ndimiduk", "createdAt": "2020-05-18T22:06:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkwNTExNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkyOTc0MQ==", "url": "https://github.com/apache/hbase/pull/1734#discussion_r426929741", "bodyText": "Ha, thank you, that is what I was looking for.", "author": "huaxiangsun", "createdAt": "2020-05-18T22:38:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkwNTExNg=="}], "type": "inlineReview", "revised_code": {"commit": "6834afd4b7aa9aa4571c332c12ae6bb316840c73", "chunk": "diff --git a/hbase-server/src/test/java/org/apache/hadoop/hbase/master/normalizer/TestSimpleRegionNormalizerOnCluster.java b/hbase-server/src/test/java/org/apache/hadoop/hbase/master/normalizer/TestSimpleRegionNormalizerOnCluster.java\nindex 343634b72c..cdd6f8393c 100644\n--- a/hbase-server/src/test/java/org/apache/hadoop/hbase/master/normalizer/TestSimpleRegionNormalizerOnCluster.java\n+++ b/hbase-server/src/test/java/org/apache/hadoop/hbase/master/normalizer/TestSimpleRegionNormalizerOnCluster.java\n\n@@ -184,7 +184,6 @@ public class TestSimpleRegionNormalizerOnCluster {\n \n   // This test is to make sure that normalizer is only going to merge adjacent regions.\n   @Test\n-  @SuppressWarnings(\"deprecation\")\n   public void testNormalizerCannotMergeNonAdjacentRegions() throws Exception {\n     final TableName tableName = TableName.valueOf(name.getMethodName());\n     MiniHBaseCluster cluster = TEST_UTIL.getHBaseCluster();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkxNTYzMw==", "url": "https://github.com/apache/hbase/pull/1734#discussion_r426915633", "bodyText": "This should be unnecessary. Why does the AssignmentManager not provide them in sorted order? I guess it doesn't hurt anything to check.. just seems redundant.", "author": "ndimiduk", "createdAt": "2020-05-18T21:59:07Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/normalizer/AbstractRegionNormalizer.java", "diffHunk": "@@ -170,6 +170,8 @@ private static boolean skipForMerge(final RegionState state) {\n         + \"number of regions: {}\",\n       table, avgRegionSize, table, tableRegions.size());\n \n+    // Sorting based on RegionInfo.COMPARATOR.\n+    tableRegions.sort(RegionInfo.COMPARATOR);", "originalCommit": "2a22c5e7006527ded9269b16e168733643a52f4c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkzMTQzMw==", "url": "https://github.com/apache/hbase/pull/1734#discussion_r426931433", "bodyText": "It does maintain a sort list, which is based on regionName (not like in branch-1, it is based on RegionInfo.COMPARATOR). With regionName, it will have out of order for STARTKEY. 'aa1' and 'aa1!' will have order of ('aa1!', 'aa1'), as 'aa1''s next byte is delimiter ','. The only place I checked for ordering based on STARTKEY is normalizer.", "author": "huaxiangsun", "createdAt": "2020-05-18T22:43:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkxNTYzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkzMzgzMw==", "url": "https://github.com/apache/hbase/pull/1734#discussion_r426933833", "bodyText": "Looking around branch-2.3, I think the normalizer is the only place where the region order has some assumed meaning.", "author": "ndimiduk", "createdAt": "2020-05-18T22:50:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkxNTYzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkzOTQ2OA==", "url": "https://github.com/apache/hbase/pull/1734#discussion_r426939468", "bodyText": "Yep, it exists in branch-2.2 as well.", "author": "huaxiangsun", "createdAt": "2020-05-18T23:06:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkxNTYzMw=="}], "type": "inlineReview", "revised_code": {"commit": "0d78ebf2d4316f2c95489dfbe4caf433c507bba0", "chunk": "diff --git a/hbase-server/src/main/java/org/apache/hadoop/hbase/master/normalizer/AbstractRegionNormalizer.java b/hbase-server/src/main/java/org/apache/hadoop/hbase/master/normalizer/AbstractRegionNormalizer.java\nindex a4e2769f0e..8b17f77dc9 100644\n--- a/hbase-server/src/main/java/org/apache/hadoop/hbase/master/normalizer/AbstractRegionNormalizer.java\n+++ b/hbase-server/src/main/java/org/apache/hadoop/hbase/master/normalizer/AbstractRegionNormalizer.java\n\n@@ -170,7 +170,11 @@ public abstract class AbstractRegionNormalizer implements RegionNormalizer {\n         + \"number of regions: {}\",\n       table, avgRegionSize, table, tableRegions.size());\n \n-    // Sorting based on RegionInfo.COMPARATOR.\n+    // The list of regionInfo from getRegionsOfTable() is ordered by regionName.\n+    // regionName does not necessary guarantee the order by STARTKEY (let's say 'aa1', 'aa1!',\n+    // in order by regionName, it will be 'aa1!' followed by 'aa1').\n+    // This could result in normalizer merging non-adjacent regions into one and creates overlaps.\n+    // In order to avoid that, sort the list by RegionInfo.COMPARATOR.\n     tableRegions.sort(RegionInfo.COMPARATOR);\n     final List<NormalizationPlan> plans = new ArrayList<>();\n     for (int candidateIdx = 0; candidateIdx < tableRegions.size() - 1; candidateIdx++) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkxNjMwMw==", "url": "https://github.com/apache/hbase/pull/1734#discussion_r426916303", "bodyText": "This method does nothing at all. Is it necessary? Does it help code readability so much that it's worth adding?", "author": "ndimiduk", "createdAt": "2020-05-18T22:00:53Z", "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/HBaseTestingUtility.java", "diffHunk": "@@ -1519,6 +1519,17 @@ public Table createMultiRegionTable(TableName tableName, byte[][] families) thro\n     return createTable(tableName, families, KEYS_FOR_HBA_CREATE_TABLE);\n   }\n \n+  /**\n+   * Create a table with multiple regions.\n+   * @param tableName\n+   * @param families\n+   * @return A Table instance for the created table.\n+   * @throws IOException\n+   */\n+  public Table createMultiRegionTable(TableName tableName, byte[][] families, final byte[][]  keys) throws IOException {", "originalCommit": "2a22c5e7006527ded9269b16e168733643a52f4c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkzMjE5Nw==", "url": "https://github.com/apache/hbase/pull/1734#discussion_r426932197", "bodyText": "I need an API which I can pass a set of keys (not predefined ones) so I can use it to test a specific set of split keys.", "author": "huaxiangsun", "createdAt": "2020-05-18T22:45:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkxNjMwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkzNDg5Mg==", "url": "https://github.com/apache/hbase/pull/1734#discussion_r426934892", "bodyText": "The underlying createTable(TableName, byte[][], byte[][]) is public. Why not call it directly, instead of making this wrapper?", "author": "ndimiduk", "createdAt": "2020-05-18T22:53:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkxNjMwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkzOTU4OA==", "url": "https://github.com/apache/hbase/pull/1734#discussion_r426939588", "bodyText": "thanks, will change to use this method.", "author": "huaxiangsun", "createdAt": "2020-05-18T23:06:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkxNjMwMw=="}], "type": "inlineReview", "revised_code": {"commit": "6834afd4b7aa9aa4571c332c12ae6bb316840c73", "chunk": "diff --git a/hbase-server/src/test/java/org/apache/hadoop/hbase/HBaseTestingUtility.java b/hbase-server/src/test/java/org/apache/hadoop/hbase/HBaseTestingUtility.java\nindex 9f97178ce9..30a7841bba 100644\n--- a/hbase-server/src/test/java/org/apache/hadoop/hbase/HBaseTestingUtility.java\n+++ b/hbase-server/src/test/java/org/apache/hadoop/hbase/HBaseTestingUtility.java\n\n@@ -1519,17 +1519,6 @@ public class HBaseTestingUtility extends HBaseZKTestingUtility {\n     return createTable(tableName, families, KEYS_FOR_HBA_CREATE_TABLE);\n   }\n \n-  /**\n-   * Create a table with multiple regions.\n-   * @param tableName\n-   * @param families\n-   * @return A Table instance for the created table.\n-   * @throws IOException\n-   */\n-  public Table createMultiRegionTable(TableName tableName, byte[][] families, final byte[][]  keys) throws IOException {\n-    return createTable(tableName, families, keys);\n-  }\n-\n   /**\n    * Create a table.\n    * @param tableName\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkxNjk2Mg==", "url": "https://github.com/apache/hbase/pull/1734#discussion_r426916962", "bodyText": "Is there a condition you can waitFor instead of a fixed sleep? These fixed sleeps lead to slow and flakey tests :(", "author": "ndimiduk", "createdAt": "2020-05-18T22:02:42Z", "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/master/normalizer/TestSimpleRegionNormalizerOnCluster.java", "diffHunk": "@@ -179,6 +182,71 @@ void testRegionNormalizationSplitOnCluster(boolean limitedByQuota) throws Except\n     admin.deleteTable(TABLENAME);\n   }\n \n+  // This test is to make sure that normalizer is only going to merge adjacent regions.\n+  @Test\n+  @SuppressWarnings(\"deprecation\")\n+  public void testNormalizerCannotMergeNonAdjacentRegions() throws Exception {\n+    final TableName tableName = TableName.valueOf(name.getMethodName());\n+    MiniHBaseCluster cluster = TEST_UTIL.getHBaseCluster();\n+    HMaster m = cluster.getMaster();\n+\n+    // create 5 regions with sizes to trigger merge of small regions\n+    final byte[][] keys = {\n+      Bytes.toBytes(\"aa\"),\n+      Bytes.toBytes(\"aa1\"),\n+      Bytes.toBytes(\"aa1!\"),\n+      Bytes.toBytes(\"aa2\")\n+    };\n+\n+    try (Table ht = TEST_UTIL.createMultiRegionTable(tableName, new byte[][]{FAMILYNAME}, keys)) {\n+      // Need to get sorted list of regions here, the order is\n+      // [, \"aa\"), [\"aa\", \"aa1\"), [\"aa1\", \"aa1!\"), [\"aa1!\", \"aa2\"), [\"aa2\", )\n+      List<HRegion> generatedRegions = TEST_UTIL.getHBaseCluster().getRegions(tableName);\n+      Collections.sort(generatedRegions, Comparator.comparing(HRegion::getRegionInfo, RegionInfo.COMPARATOR));\n+\n+      // Region [\"aa\", \"aa1\") and [\"aa1!\", \"aa2\") are not adjacent, they are not supposed to\n+      // merged.\n+      HRegion region = generatedRegions.get(0);\n+      generateTestData(region, 3);\n+      region.flush(true);\n+\n+      region = generatedRegions.get(1);\n+      generateTestData(region, 1);\n+      region.flush(true);\n+\n+      region = generatedRegions.get(2);\n+      generateTestData(region, 3);\n+      region.flush(true);\n+\n+      region = generatedRegions.get(3);\n+      generateTestData(region, 1);\n+      region.flush(true);\n+\n+      region = generatedRegions.get(4);\n+      generateTestData(region, 5);\n+      region.flush(true);\n+\n+      ModifyableTableDescriptor htd = new ModifyableTableDescriptor(tableName,\n+        admin.getDescriptor(tableName));\n+\n+      htd.setNormalizationEnabled(true);\n+      admin.modifyTable(htd);\n+\n+      admin.flush(tableName);\n+\n+      assertEquals(5, MetaTableAccessor.getRegionCount(TEST_UTIL.getConnection(), tableName));\n+\n+      Thread.sleep(5000); // to let region load to update", "originalCommit": "2a22c5e7006527ded9269b16e168733643a52f4c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkzMjM4NA==", "url": "https://github.com/apache/hbase/pull/1734#discussion_r426932384", "bodyText": "Let me check one, it is just copy and paste here from another test.", "author": "huaxiangsun", "createdAt": "2020-05-18T22:46:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkxNjk2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkzNTEwOA==", "url": "https://github.com/apache/hbase/pull/1734#discussion_r426935108", "bodyText": "Understood.", "author": "ndimiduk", "createdAt": "2020-05-18T22:54:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkxNjk2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjk1ODc0NQ==", "url": "https://github.com/apache/hbase/pull/1734#discussion_r426958745", "bodyText": "I went through the code. The logic is like this, every 3 seconds (default config), region servers send sever metrics to master and update the copy in master in-memory database, which is used by normalizer to calculate region sizes. We can (not) manually trigger a server metrics update from region server as the method is a protected one for testing in regionserver module. Even if it does a manual server metrics update from region server, it still needs to wait(sleep) until master finishes rpc processing. Will leave as it is unless there is something missing from my code reading, thanks.", "author": "huaxiangsun", "createdAt": "2020-05-19T00:12:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkxNjk2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzIzNjc1MQ==", "url": "https://github.com/apache/hbase/pull/1734#discussion_r427236751", "bodyText": "Maybe we can do manual server metrics update followed by sleep and then assert null plan?", "author": "virajjasani", "createdAt": "2020-05-19T11:43:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkxNjk2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQzODU2Nw==", "url": "https://github.com/apache/hbase/pull/1734#discussion_r427438567", "bodyText": "The manual server mtetrics update will need to expose the protected methods out of the module, and after that, there is still no way to guarantee the latest update is processed by master (sleep is still needed). I thought about it and gave up. It is mostly from testRegionNormalizationMergeOnCluster() and it never shows up in flaky test list, so it is ok here.", "author": "huaxiangsun", "createdAt": "2020-05-19T16:31:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkxNjk2Mg=="}], "type": "inlineReview", "revised_code": {"commit": "6834afd4b7aa9aa4571c332c12ae6bb316840c73", "chunk": "diff --git a/hbase-server/src/test/java/org/apache/hadoop/hbase/master/normalizer/TestSimpleRegionNormalizerOnCluster.java b/hbase-server/src/test/java/org/apache/hadoop/hbase/master/normalizer/TestSimpleRegionNormalizerOnCluster.java\nindex 343634b72c..cdd6f8393c 100644\n--- a/hbase-server/src/test/java/org/apache/hadoop/hbase/master/normalizer/TestSimpleRegionNormalizerOnCluster.java\n+++ b/hbase-server/src/test/java/org/apache/hadoop/hbase/master/normalizer/TestSimpleRegionNormalizerOnCluster.java\n\n@@ -184,7 +184,6 @@ public class TestSimpleRegionNormalizerOnCluster {\n \n   // This test is to make sure that normalizer is only going to merge adjacent regions.\n   @Test\n-  @SuppressWarnings(\"deprecation\")\n   public void testNormalizerCannotMergeNonAdjacentRegions() throws Exception {\n     final TableName tableName = TableName.valueOf(name.getMethodName());\n     MiniHBaseCluster cluster = TEST_UTIL.getHBaseCluster();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkxNzE1NA==", "url": "https://github.com/apache/hbase/pull/1734#discussion_r426917154", "bodyText": "I think this should be wrapped in if admin.exists(tableName), otherwise flakey test.", "author": "ndimiduk", "createdAt": "2020-05-18T22:03:15Z", "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/master/normalizer/TestSimpleRegionNormalizerOnCluster.java", "diffHunk": "@@ -179,6 +182,71 @@ void testRegionNormalizationSplitOnCluster(boolean limitedByQuota) throws Except\n     admin.deleteTable(TABLENAME);\n   }\n \n+  // This test is to make sure that normalizer is only going to merge adjacent regions.\n+  @Test\n+  @SuppressWarnings(\"deprecation\")\n+  public void testNormalizerCannotMergeNonAdjacentRegions() throws Exception {\n+    final TableName tableName = TableName.valueOf(name.getMethodName());\n+    MiniHBaseCluster cluster = TEST_UTIL.getHBaseCluster();\n+    HMaster m = cluster.getMaster();\n+\n+    // create 5 regions with sizes to trigger merge of small regions\n+    final byte[][] keys = {\n+      Bytes.toBytes(\"aa\"),\n+      Bytes.toBytes(\"aa1\"),\n+      Bytes.toBytes(\"aa1!\"),\n+      Bytes.toBytes(\"aa2\")\n+    };\n+\n+    try (Table ht = TEST_UTIL.createMultiRegionTable(tableName, new byte[][]{FAMILYNAME}, keys)) {\n+      // Need to get sorted list of regions here, the order is\n+      // [, \"aa\"), [\"aa\", \"aa1\"), [\"aa1\", \"aa1!\"), [\"aa1!\", \"aa2\"), [\"aa2\", )\n+      List<HRegion> generatedRegions = TEST_UTIL.getHBaseCluster().getRegions(tableName);\n+      Collections.sort(generatedRegions, Comparator.comparing(HRegion::getRegionInfo, RegionInfo.COMPARATOR));\n+\n+      // Region [\"aa\", \"aa1\") and [\"aa1!\", \"aa2\") are not adjacent, they are not supposed to\n+      // merged.\n+      HRegion region = generatedRegions.get(0);\n+      generateTestData(region, 3);\n+      region.flush(true);\n+\n+      region = generatedRegions.get(1);\n+      generateTestData(region, 1);\n+      region.flush(true);\n+\n+      region = generatedRegions.get(2);\n+      generateTestData(region, 3);\n+      region.flush(true);\n+\n+      region = generatedRegions.get(3);\n+      generateTestData(region, 1);\n+      region.flush(true);\n+\n+      region = generatedRegions.get(4);\n+      generateTestData(region, 5);\n+      region.flush(true);\n+\n+      ModifyableTableDescriptor htd = new ModifyableTableDescriptor(tableName,\n+        admin.getDescriptor(tableName));\n+\n+      htd.setNormalizationEnabled(true);\n+      admin.modifyTable(htd);\n+\n+      admin.flush(tableName);\n+\n+      assertEquals(5, MetaTableAccessor.getRegionCount(TEST_UTIL.getConnection(), tableName));\n+\n+      Thread.sleep(5000); // to let region load to update\n+\n+      // Compute the plan, no merge plan returned as they are not adjacent.\n+      final List<NormalizationPlan> plans = m.getRegionNormalizer().computePlanForTable(tableName);\n+      assertNull(plans);\n+    } finally {\n+      admin.disableTable(tableName);", "originalCommit": "2a22c5e7006527ded9269b16e168733643a52f4c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkzMjUxOQ==", "url": "https://github.com/apache/hbase/pull/1734#discussion_r426932519", "bodyText": "Will address it.", "author": "huaxiangsun", "createdAt": "2020-05-18T22:46:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkxNzE1NA=="}], "type": "inlineReview", "revised_code": {"commit": "6834afd4b7aa9aa4571c332c12ae6bb316840c73", "chunk": "diff --git a/hbase-server/src/test/java/org/apache/hadoop/hbase/master/normalizer/TestSimpleRegionNormalizerOnCluster.java b/hbase-server/src/test/java/org/apache/hadoop/hbase/master/normalizer/TestSimpleRegionNormalizerOnCluster.java\nindex 343634b72c..cdd6f8393c 100644\n--- a/hbase-server/src/test/java/org/apache/hadoop/hbase/master/normalizer/TestSimpleRegionNormalizerOnCluster.java\n+++ b/hbase-server/src/test/java/org/apache/hadoop/hbase/master/normalizer/TestSimpleRegionNormalizerOnCluster.java\n\n@@ -184,7 +184,6 @@ public class TestSimpleRegionNormalizerOnCluster {\n \n   // This test is to make sure that normalizer is only going to merge adjacent regions.\n   @Test\n-  @SuppressWarnings(\"deprecation\")\n   public void testNormalizerCannotMergeNonAdjacentRegions() throws Exception {\n     final TableName tableName = TableName.valueOf(name.getMethodName());\n     MiniHBaseCluster cluster = TEST_UTIL.getHBaseCluster();\n"}}, {"oid": "6834afd4b7aa9aa4571c332c12ae6bb316840c73", "url": "https://github.com/apache/hbase/commit/6834afd4b7aa9aa4571c332c12ae6bb316840c73", "message": "HBASE-24376 MergeNormalizer is merging non-adjacent regions and causing region overlaps/holes.", "committedDate": "2020-05-19T00:00:45Z", "type": "forcePushed"}, {"oid": "5bc4aec00a8870d56cc70ec5d17537a3e8033610", "url": "https://github.com/apache/hbase/commit/5bc4aec00a8870d56cc70ec5d17537a3e8033610", "message": "HBASE-24376 MergeNormalizer is merging non-adjacent regions and causing region overlaps/holes.", "committedDate": "2020-05-19T00:05:13Z", "type": "forcePushed"}, {"oid": "0d78ebf2d4316f2c95489dfbe4caf433c507bba0", "url": "https://github.com/apache/hbase/commit/0d78ebf2d4316f2c95489dfbe4caf433c507bba0", "message": "HBASE-24376 MergeNormalizer is merging non-adjacent regions and causing region overlaps/holes.", "committedDate": "2020-05-19T20:58:03Z", "type": "commit"}, {"oid": "0d78ebf2d4316f2c95489dfbe4caf433c507bba0", "url": "https://github.com/apache/hbase/commit/0d78ebf2d4316f2c95489dfbe4caf433c507bba0", "message": "HBASE-24376 MergeNormalizer is merging non-adjacent regions and causing region overlaps/holes.", "committedDate": "2020-05-19T20:58:03Z", "type": "forcePushed"}]}