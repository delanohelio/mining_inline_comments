{"pr_number": 1243, "pr_title": "HBASE-23944 The method setClusterLoad of SimpleLoadBalancer is incorr\u2026", "pr_createdAt": "2020-03-06T07:26:05Z", "pr_url": "https://github.com/apache/hbase/pull/1243", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODc1ODgwNw==", "url": "https://github.com/apache/hbase/pull/1243#discussion_r388758807", "bodyText": "Why change TreeMap to Map?", "author": "infraio", "createdAt": "2020-03-06T08:00:45Z", "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/master/balancer/BalancerTestBase.java", "diffHunk": "@@ -402,13 +402,13 @@ protected void updateLoad(final Map<ServerName, ServerAndLoad> map,\n     return servers;\n   }\n \n-  protected HashMap<TableName, TreeMap<ServerName, List<RegionInfo>>> mockClusterServersWithTables(Map<ServerName, List<RegionInfo>> clusterServers) {\n-    HashMap<TableName, TreeMap<ServerName, List<RegionInfo>>> result = new HashMap<>();\n+  protected Map<TableName, Map<ServerName, List<RegionInfo>>> mockClusterServersWithTables(Map<ServerName, List<RegionInfo>> clusterServers) {", "originalCommit": "2702fe87723c4efaa0554d186fc0efce738ff318", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODc2MjMxNQ==", "url": "https://github.com/apache/hbase/pull/1243#discussion_r388762315", "bodyText": "use the return value of method mockClusterServersWithTables as  clusterLoad\nthe extend feature of treeMap is no use , Map is enough", "author": "nyl3532016", "createdAt": "2020-03-06T08:11:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODc1ODgwNw=="}], "type": "inlineReview", "revised_code": {"commit": "0f744aff3fd15ce99423e3a68b051638f58820bd", "chunk": "diff --git a/hbase-server/src/test/java/org/apache/hadoop/hbase/master/balancer/BalancerTestBase.java b/hbase-server/src/test/java/org/apache/hadoop/hbase/master/balancer/BalancerTestBase.java\nindex 5aecfc7efa..0f6e51ebd5 100644\n--- a/hbase-server/src/test/java/org/apache/hadoop/hbase/master/balancer/BalancerTestBase.java\n+++ b/hbase-server/src/test/java/org/apache/hadoop/hbase/master/balancer/BalancerTestBase.java\n\n@@ -402,13 +402,13 @@ public class BalancerTestBase {\n     return servers;\n   }\n \n-  protected Map<TableName, Map<ServerName, List<RegionInfo>>> mockClusterServersWithTables(Map<ServerName, List<RegionInfo>> clusterServers) {\n-    Map<TableName, Map<ServerName, List<RegionInfo>>> result = new HashMap<>();\n+  protected HashMap<TableName, TreeMap<ServerName, List<RegionInfo>>> mockClusterServersWithTables(Map<ServerName, List<RegionInfo>> clusterServers) {\n+    HashMap<TableName, TreeMap<ServerName, List<RegionInfo>>> result = new HashMap<>();\n     for (Map.Entry<ServerName, List<RegionInfo>> entry : clusterServers.entrySet()) {\n       ServerName sal = entry.getKey();\n       List<RegionInfo> regions = entry.getValue();\n       for (RegionInfo hri : regions){\n-        Map<ServerName, List<RegionInfo>> servers = result.get(hri.getTable());\n+        TreeMap<ServerName, List<RegionInfo>> servers = result.get(hri.getTable());\n         if (servers == null) {\n           servers = new TreeMap<>();\n           result.put(hri.getTable(), servers);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODc1ODk1MA==", "url": "https://github.com/apache/hbase/pull/1243#discussion_r388758950", "bodyText": "The difference of results1 and clusterLoad is?", "author": "infraio", "createdAt": "2020-03-06T08:01:08Z", "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/master/balancer/TestDefaultLoadBalancer.java", "diffHunk": "@@ -171,20 +171,33 @@ public void testBalanceClusterOverall() throws Exception {\n    */\n   @Test\n   public void testImpactOfBalanceClusterOverall() throws Exception {\n+    testImpactOfBalanceClusterOverall(false);\n+  }\n+\n+  @Test\n+  public void testImpactOfBalanceClusterOverallWithTableClusterLoad() throws Exception {\n+    testImpactOfBalanceClusterOverall(true);\n+  }\n+\n+  private void testImpactOfBalanceClusterOverall(boolean useTableClusterLoad) throws Exception {\n     Map<TableName, Map<ServerName, List<RegionInfo>>> clusterLoad = new TreeMap<>();\n     Map<ServerName, List<RegionInfo>> clusterServers = mockUniformClusterServers(mockUniformCluster);\n     List<ServerAndLoad> clusterList = convertToList(clusterServers);\n     clusterLoad.put(TableName.valueOf(name.getMethodName()), clusterServers);\n     // use overall can achieve both table and cluster level balance\n-    HashMap<TableName, TreeMap<ServerName, List<RegionInfo>>> result1 = mockClusterServersWithTables(clusterServers);\n-    loadBalancer.setClusterLoad(clusterLoad);\n+    Map<TableName, Map<ServerName, List<RegionInfo>>> result1 = mockClusterServersWithTables(clusterServers);", "originalCommit": "2702fe87723c4efaa0554d186fc0efce738ff318", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODc2NjUzOA==", "url": "https://github.com/apache/hbase/pull/1243#discussion_r388766538", "bodyText": "clusterLoad's  value is map (server to all region on it , whatever region's table), clusterLoad's key is no use\nresults1's value is map(server to region ,the region only belong to the key table), results1's key is actual tableName\nin balance by table, we should use results1", "author": "nyl3532016", "createdAt": "2020-03-06T08:22:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODc1ODk1MA=="}], "type": "inlineReview", "revised_code": {"commit": "0f744aff3fd15ce99423e3a68b051638f58820bd", "chunk": "diff --git a/hbase-server/src/test/java/org/apache/hadoop/hbase/master/balancer/TestDefaultLoadBalancer.java b/hbase-server/src/test/java/org/apache/hadoop/hbase/master/balancer/TestDefaultLoadBalancer.java\nindex 6918f6e2bc..bad9781315 100644\n--- a/hbase-server/src/test/java/org/apache/hadoop/hbase/master/balancer/TestDefaultLoadBalancer.java\n+++ b/hbase-server/src/test/java/org/apache/hadoop/hbase/master/balancer/TestDefaultLoadBalancer.java\n\n@@ -175,25 +175,25 @@ public class TestDefaultLoadBalancer extends BalancerTestBase {\n   }\n \n   @Test\n-  public void testImpactOfBalanceClusterOverallWithTableClusterLoad() throws Exception {\n+  public void testImpactOfBalanceClusterOverallWithClusterLoadPerTable() throws Exception {\n     testImpactOfBalanceClusterOverall(true);\n   }\n \n-  private void testImpactOfBalanceClusterOverall(boolean useTableClusterLoad) throws Exception {\n+  private void testImpactOfBalanceClusterOverall(boolean useClusterLoadPerTable) throws Exception {\n     Map<TableName, Map<ServerName, List<RegionInfo>>> clusterLoad = new TreeMap<>();\n     Map<ServerName, List<RegionInfo>> clusterServers = mockUniformClusterServers(mockUniformCluster);\n     List<ServerAndLoad> clusterList = convertToList(clusterServers);\n     clusterLoad.put(TableName.valueOf(name.getMethodName()), clusterServers);\n     // use overall can achieve both table and cluster level balance\n-    Map<TableName, Map<ServerName, List<RegionInfo>>> result1 = mockClusterServersWithTables(clusterServers);\n-    if (useTableClusterLoad) {\n-      loadBalancer.setClusterLoad(result1);\n+    HashMap<TableName, TreeMap<ServerName, List<RegionInfo>>> clusterLoadPerTable = mockClusterServersWithTables(clusterServers);\n+    if (useClusterLoadPerTable) {\n+      loadBalancer.setClusterLoad((Map)clusterLoadPerTable);\n     } else {\n       loadBalancer.setClusterLoad(clusterLoad);\n     }\n     List<RegionPlan> clusterplans1 = new ArrayList<RegionPlan>();\n     List<Pair<TableName, Integer>> regionAmountList = new ArrayList<Pair<TableName, Integer>>();\n-    for (Map<ServerName, List<RegionInfo>> servers : result1.values()) {\n+    for (TreeMap<ServerName, List<RegionInfo>> servers : clusterLoadPerTable.values()) {\n       List<ServerAndLoad> list = convertToList(servers);\n       LOG.info(\"Mock Cluster : \" + printMock(list) + \" \" + printStats(list));\n       List<RegionPlan> partialplans = loadBalancer.balanceCluster(servers);\n"}}, {"oid": "0f744aff3fd15ce99423e3a68b051638f58820bd", "url": "https://github.com/apache/hbase/commit/0f744aff3fd15ce99423e3a68b051638f58820bd", "message": "HBASE-23944 The method setClusterLoad of SimpleLoadBalancer is incorrect when balance by table", "committedDate": "2020-03-07T01:11:05Z", "type": "commit"}, {"oid": "0f744aff3fd15ce99423e3a68b051638f58820bd", "url": "https://github.com/apache/hbase/commit/0f744aff3fd15ce99423e3a68b051638f58820bd", "message": "HBASE-23944 The method setClusterLoad of SimpleLoadBalancer is incorrect when balance by table", "committedDate": "2020-03-07T01:11:05Z", "type": "forcePushed"}]}