{"pr_number": 1881, "pr_title": "HBASE-24529 hbase.rs.evictblocksonclose is not honored when removing \u2026", "pr_createdAt": "2020-06-10T04:49:23Z", "pr_url": "https://github.com/apache/hbase/pull/1881", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODAyMjc0OQ==", "url": "https://github.com/apache/hbase/pull/1881#discussion_r438022749", "bodyText": "While closing the region, doing the evict caused delay in closure. But here are we seeing some impact because of this evict? This will happen in async way from the Discharger thread right? Just trying to understand.", "author": "anoopsjohn", "createdAt": "2020-06-10T10:28:54Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HStore.java", "diffHunk": "@@ -622,7 +622,8 @@ void setDataBlockEncoderInTest(HFileDataBlockEncoder blockEncoder) {\n       for (HStoreFile storeFile : results) {\n         if (compactedStoreFiles.contains(storeFile.getPath().getName())) {\n           LOG.warn(\"Clearing the compacted storefile {} from {}\", storeFile, this);\n-          storeFile.getReader().close(true);\n+          storeFile.getReader().close(storeFile.getCacheConf() != null ?", "originalCommit": "48bbd5afe6ae1abe270870fab8985f337f152183", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODEzNzAyMg==", "url": "https://github.com/apache/hbase/pull/1881#discussion_r438137022", "bodyText": "Thank you for reviewing this!\nYes, this will happen in async way from the Discharger thread. So looks like we don't need to change this line. I will revert this change. Thanks.", "author": "brfrn169", "createdAt": "2020-06-10T13:49:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODAyMjc0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODY2NzAzNw==", "url": "https://github.com/apache/hbase/pull/1881#discussion_r438667037", "bodyText": "Checking again.. Sorry my bad. I wanted to add this at other place but ended up here.  This is a call happening during region open. So you might want to keep ur change here.", "author": "anoopsjohn", "createdAt": "2020-06-11T09:43:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODAyMjc0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODY3MTU1NQ==", "url": "https://github.com/apache/hbase/pull/1881#discussion_r438671555", "bodyText": "Oh okay. I missed that, too.. Thank you for pointing it out.", "author": "brfrn169", "createdAt": "2020-06-11T09:51:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODAyMjc0OQ=="}], "type": "inlineReview", "revised_code": {"commit": "4ddb06ad7fe26e56d476a04ff4fa384bbac49d75", "chunk": "diff --git a/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HStore.java b/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HStore.java\nindex 5d8a430b10..e59b1dee5d 100644\n--- a/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HStore.java\n+++ b/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HStore.java\n\n@@ -622,8 +622,7 @@ public class HStore implements Store, HeapSize, StoreConfigInformation,\n       for (HStoreFile storeFile : results) {\n         if (compactedStoreFiles.contains(storeFile.getPath().getName())) {\n           LOG.warn(\"Clearing the compacted storefile {} from {}\", storeFile, this);\n-          storeFile.getReader().close(storeFile.getCacheConf() != null ?\n-            storeFile.getCacheConf().shouldEvictOnClose() : true);\n+          storeFile.getReader().close(true);\n           filesToRemove.add(storeFile);\n         }\n       }\n"}}, {"oid": "4ddb06ad7fe26e56d476a04ff4fa384bbac49d75", "url": "https://github.com/apache/hbase/commit/4ddb06ad7fe26e56d476a04ff4fa384bbac49d75", "message": "HBASE-24529 hbase.rs.evictblocksonclose is not honored when removing compacted files and closing the storefiles", "committedDate": "2020-06-10T13:50:48Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODY2OTM0Mg==", "url": "https://github.com/apache/hbase/pull/1881#discussion_r438669342", "bodyText": "This area will be getting called when we close a store as well as when the CompactionDischarger finds unreferenced compacted files..  CompactionDischarger  is working in an async way anyways.  But ya as per ur explanation, during close() we wanted to keep it this was as in patch.", "author": "anoopsjohn", "createdAt": "2020-06-11T09:47:18Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HStore.java", "diffHunk": "@@ -2741,7 +2741,8 @@ private void removeCompactedfiles(Collection<HStoreFile> compactedfiles)\n             LOG.trace(\"Closing and archiving the file {}\", file);\n             // Copy the file size before closing the reader\n             final long length = r.length();\n-            r.close(true);\n+            r.close(file.getCacheConf() != null ?", "originalCommit": "4ddb06ad7fe26e56d476a04ff4fa384bbac49d75", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTE5MzcwNw==", "url": "https://github.com/apache/hbase/pull/1881#discussion_r439193707", "bodyText": "Sorry I was not clear in above comment. My ask was this.\nThis is called from closeAndArchiveCompactedFiles() and HStore#close().\nThe former is called in an async way by the Discharger thread anyways.  When this area is called by that flow, we can preserve what is there today (Passing true).  Close time ya lets honor the config.  Sounds ok?\nIdeally speaking we should have handled whole these in another way. Within the Cache implementation, the evict by hfile would have been an async impl. So the caller wont get blocked.  But ya lets handle that in another jira.", "author": "anoopsjohn", "createdAt": "2020-06-12T03:57:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODY2OTM0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTIwNDA5NA==", "url": "https://github.com/apache/hbase/pull/1881#discussion_r439204094", "bodyText": "Thank you for the clarification. I understood that. Will change the patch according to your review. Thanks.", "author": "brfrn169", "createdAt": "2020-06-12T04:45:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODY2OTM0Mg=="}], "type": "inlineReview", "revised_code": {"commit": "8acc92640ff8995379fcabc6d2a9c720b48bc287", "chunk": "diff --git a/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HStore.java b/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HStore.java\nindex e59b1dee5d..3fbad6b7e2 100644\n--- a/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HStore.java\n+++ b/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HStore.java\n\n@@ -2741,8 +2745,7 @@ public class HStore implements Store, HeapSize, StoreConfigInformation,\n             LOG.trace(\"Closing and archiving the file {}\", file);\n             // Copy the file size before closing the reader\n             final long length = r.length();\n-            r.close(file.getCacheConf() != null ?\n-              file.getCacheConf().shouldEvictOnClose() : true);\n+            r.close(evictOnClose);\n             // Just close and return\n             filesToRemove.add(file);\n             // Only add the length if we successfully added the file to `filesToRemove`\n"}}, {"oid": "a4610b984d0e02062c022abce73b60aac376f708", "url": "https://github.com/apache/hbase/commit/a4610b984d0e02062c022abce73b60aac376f708", "message": "HBASE-24529 hbase.rs.evictblocksonclose is not honored when removing compacted files and closing the storefiles", "committedDate": "2020-06-11T09:55:31Z", "type": "forcePushed"}, {"oid": "8acc92640ff8995379fcabc6d2a9c720b48bc287", "url": "https://github.com/apache/hbase/commit/8acc92640ff8995379fcabc6d2a9c720b48bc287", "message": "HBASE-24529 hbase.rs.evictblocksonclose is not honored when removing compacted files and closing the storefiles", "committedDate": "2020-06-12T04:45:56Z", "type": "commit"}, {"oid": "8acc92640ff8995379fcabc6d2a9c720b48bc287", "url": "https://github.com/apache/hbase/commit/8acc92640ff8995379fcabc6d2a9c720b48bc287", "message": "HBASE-24529 hbase.rs.evictblocksonclose is not honored when removing compacted files and closing the storefiles", "committedDate": "2020-06-12T04:45:56Z", "type": "forcePushed"}]}