{"pr_number": 1905, "pr_title": "HBASE-24564: Make RS abort call idempotent", "pr_createdAt": "2020-06-15T21:56:29Z", "pr_url": "https://github.com/apache/hbase/pull/1905", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDUzNTg2Mw==", "url": "https://github.com/apache/hbase/pull/1905#discussion_r440535863", "bodyText": "An AtomicBoolean with CAS is enough?", "author": "Apache9", "createdAt": "2020-06-16T01:33:20Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegionServer.java", "diffHunk": "@@ -2475,13 +2475,21 @@ public RSRpcServices getRSRpcServices() {\n    */\n   @Override\n   public void abort(String reason, Throwable cause) {\n+    synchronized (this) {", "originalCommit": "c91e7036167e411178cb78ef0f98f0db9b18ef7d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDU0NzQ1MQ==", "url": "https://github.com/apache/hbase/pull/1905#discussion_r440547451", "bodyText": "Okay. Used synchronized to keep the changes minimal. But CAS is good too, changed it.", "author": "bharathv", "createdAt": "2020-06-16T02:17:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDUzNTg2Mw=="}], "type": "inlineReview", "revised_code": {"commit": "f6ed7c5e34ca37b311d8d4bcd03a7d9ce3dd1101", "chunk": "diff --git a/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegionServer.java b/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegionServer.java\nindex ebce68fa85..0b97c99a81 100644\n--- a/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegionServer.java\n+++ b/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegionServer.java\n\n@@ -2475,14 +2475,11 @@ public class HRegionServer extends Thread implements\n    */\n   @Override\n   public void abort(String reason, Throwable cause) {\n-    synchronized (this) {\n-      if (abortRequested) {\n-        // Abort already in progress, ignore the new request.\n-        LOG.debug(\n-            \"Abort already in progress. Ignoring the current request with reason: {}\", reason);\n-        return;\n-      }\n-      setAbortRequested();\n+    if (!setAbortRequested()) {\n+      // Abort already in progress, ignore the new request.\n+      LOG.debug(\n+          \"Abort already in progress. Ignoring the current request with reason: {}\", reason);\n+      return;\n     }\n     String msg = \"***** ABORTING region server \" + this + \": \" + reason + \" *****\";\n     if (cause != null) {\n"}}, {"oid": "f6ed7c5e34ca37b311d8d4bcd03a7d9ce3dd1101", "url": "https://github.com/apache/hbase/commit/f6ed7c5e34ca37b311d8d4bcd03a7d9ce3dd1101", "message": "HBASE-24564: Make RS abort call idempotent.\n\nSigned-off-by: Duo Zhang <zhangduo@apache.org>", "committedDate": "2020-06-16T04:42:28Z", "type": "commit"}, {"oid": "f6ed7c5e34ca37b311d8d4bcd03a7d9ce3dd1101", "url": "https://github.com/apache/hbase/commit/f6ed7c5e34ca37b311d8d4bcd03a7d9ce3dd1101", "message": "HBASE-24564: Make RS abort call idempotent.\n\nSigned-off-by: Duo Zhang <zhangduo@apache.org>", "committedDate": "2020-06-16T04:42:28Z", "type": "forcePushed"}]}