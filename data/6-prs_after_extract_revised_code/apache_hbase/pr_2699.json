{"pr_number": 2699, "pr_title": "HBASE-25287 Forgetting to unbuffer streams results in many CLOSE_WAIT\u2026", "pr_createdAt": "2020-11-24T06:18:20Z", "pr_url": "https://github.com/apache/hbase/pull/2699", "timeline": [{"oid": "0244b29cdfcef404bb1eb47673b258eaacb1dc8f", "url": "https://github.com/apache/hbase/commit/0244b29cdfcef404bb1eb47673b258eaacb1dc8f", "message": "HBASE-25287 Forgetting to unbuffer streams results in many CLOSE_WAIT sockets when loading files", "committedDate": "2020-11-26T03:01:38Z", "type": "forcePushed"}, {"oid": "f3d8072a4326aa34751f362e2e5a650f7edf673a", "url": "https://github.com/apache/hbase/commit/f3d8072a4326aa34751f362e2e5a650f7edf673a", "message": "HBASE-25287 Forgetting to unbuffer streams results in many CLOSE_WAIT sockets when loading files", "committedDate": "2020-11-26T06:10:20Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjAzNzM0Mg==", "url": "https://github.com/apache/hbase/pull/2699#discussion_r532037342", "bodyText": "Is it safe to unbuffer the input stream after it is closed?", "author": "Apache9", "createdAt": "2020-11-28T12:56:31Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/io/hfile/HFileInfo.java", "diffHunk": "@@ -359,24 +360,32 @@ public void initMetaAndIndex(HFile.Reader reader) throws IOException {\n     // Initialize an block iterator, and parse load-on-open blocks in the following.\n     blockIter = blockReader.blockRange(trailer.getLoadOnOpenDataOffset(),\n         context.getFileSize() - trailer.getTrailerSize());\n-    // Data index. We also read statistics about the block index written after\n-    // the root level.\n-    this.dataIndexReader = new HFileBlockIndex\n-        .CellBasedKeyBlockIndexReader(trailer.createComparator(), trailer.getNumDataIndexLevels());\n-    dataIndexReader.readMultiLevelIndexRoot(blockIter.nextBlockWithBlockType(BlockType.ROOT_INDEX),\n-        trailer.getDataIndexCount());\n-    reader.setDataBlockIndexReader(dataIndexReader);\n-    // Meta index.\n-    this.metaIndexReader = new HFileBlockIndex.ByteArrayKeyBlockIndexReader(1);\n-    metaIndexReader.readRootIndex(blockIter.nextBlockWithBlockType(BlockType.ROOT_INDEX),\n+    try {\n+      // Data index. We also read statistics about the block index written after\n+      // the root level.\n+      this.dataIndexReader =\n+        new HFileBlockIndex.CellBasedKeyBlockIndexReader(trailer.createComparator(), trailer.getNumDataIndexLevels());\n+      dataIndexReader\n+        .readMultiLevelIndexRoot(blockIter.nextBlockWithBlockType(BlockType.ROOT_INDEX), trailer.getDataIndexCount());\n+      reader.setDataBlockIndexReader(dataIndexReader);\n+      // Meta index.\n+      this.metaIndexReader = new HFileBlockIndex.ByteArrayKeyBlockIndexReader(1);\n+      metaIndexReader.readRootIndex(blockIter.nextBlockWithBlockType(BlockType.ROOT_INDEX),\n         trailer.getMetaIndexCount());\n-    reader.setMetaBlockIndexReader(metaIndexReader);\n-    loadMetaInfo(blockIter, hfileContext);\n-    reader.setDataBlockEncoder(HFileDataBlockEncoderImpl.createFromFileInfo(this));\n-    // Load-On-Open info\n-    HFileBlock b;\n-    while ((b = blockIter.nextBlock()) != null) {\n-      loadOnOpenBlocks.add(b);\n+      reader.setMetaBlockIndexReader(metaIndexReader);\n+      loadMetaInfo(blockIter, hfileContext);\n+      reader.setDataBlockEncoder(HFileDataBlockEncoderImpl.createFromFileInfo(this));\n+      // Load-On-Open info\n+      HFileBlock b;\n+      while ((b = blockIter.nextBlock()) != null) {\n+        loadOnOpenBlocks.add(b);\n+      }\n+    } catch (Throwable t) {\n+      IOUtils.closeQuietly(context.getInputStreamWrapper());\n+      throw new CorruptHFileException(\"Problem reading data index and meta index from file \"\n+        + context.getFilePath(), t);\n+    } finally {\n+      context.getInputStreamWrapper().unbuffer();", "originalCommit": "f3d8072a4326aa34751f362e2e5a650f7edf673a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjE4MDg2Mw==", "url": "https://github.com/apache/hbase/pull/2699#discussion_r532180863", "bodyText": "Thanks for reviewing, @Apache9 .\nIOUtils.closeQuietly just calls stream.close(), and does not set stream be null. stream=null is always explicitly called when needed. So I think context.getInputStreamWrapper.unbuffer will not throw NPE here. In unbuffer() method, it closes the bockReader when it is not null. As a result, unbuffer will not throws NPE eighter.\nI have made a UT to create a context and called IOUtils.closeQuietly followed bycontext.getInputStreamWrapper().unbuffer(), no exceptions occurred.\nThe try...cache..finally codes here is the same as those in HFile.createReader.\nIf it seems a little bit not graceful and ugly, adding a check of context.getInputStreamWrapper()!=null may be helpful?", "author": "sunhelly", "createdAt": "2020-11-29T09:23:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjAzNzM0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA3Njc2MA==", "url": "https://github.com/apache/hbase/pull/2699#discussion_r533076760", "bodyText": "I think it might be better to call context.getInputStreamWrapper().unbuffer() before catch sentences.\nAnd because DFSInputStream.close() uses the same logic as unbuffer() to close the blockReader by closeCurrentBlockReaders(), so it need not to call unbuffer() before IOUtils.closeQuietly(). PR has been updated.", "author": "sunhelly", "createdAt": "2020-12-01T05:10:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjAzNzM0Mg=="}], "type": "inlineReview", "revised_code": {"commit": "aa1f47ad6a7dd26e433aa5d3c9b76802bf4def52", "chunk": "diff --git a/hbase-server/src/main/java/org/apache/hadoop/hbase/io/hfile/HFileInfo.java b/hbase-server/src/main/java/org/apache/hadoop/hbase/io/hfile/HFileInfo.java\nindex 3b4ebf0d22..98ca184ea3 100644\n--- a/hbase-server/src/main/java/org/apache/hadoop/hbase/io/hfile/HFileInfo.java\n+++ b/hbase-server/src/main/java/org/apache/hadoop/hbase/io/hfile/HFileInfo.java\n\n@@ -380,12 +379,11 @@ public class HFileInfo implements SortedMap<byte[], byte[]> {\n       while ((b = blockIter.nextBlock()) != null) {\n         loadOnOpenBlocks.add(b);\n       }\n+      context.getInputStreamWrapper().unbuffer();\n     } catch (Throwable t) {\n       IOUtils.closeQuietly(context.getInputStreamWrapper());\n       throw new CorruptHFileException(\"Problem reading data index and meta index from file \"\n         + context.getFilePath(), t);\n-    } finally {\n-      context.getInputStreamWrapper().unbuffer();\n     }\n   }\n \n"}}, {"oid": "aa1f47ad6a7dd26e433aa5d3c9b76802bf4def52", "url": "https://github.com/apache/hbase/commit/aa1f47ad6a7dd26e433aa5d3c9b76802bf4def52", "message": "HBASE-25287 Forgetting to unbuffer streams results in many CLOSE_WAIT sockets when loading files", "committedDate": "2020-12-01T05:01:18Z", "type": "forcePushed"}, {"oid": "e5bedd779a55ee29122b1e81c30c5c60a1fa4ab0", "url": "https://github.com/apache/hbase/commit/e5bedd779a55ee29122b1e81c30c5c60a1fa4ab0", "message": "HBASE-25287 Forgetting to unbuffer streams results in many CLOSE_WAIT sockets when loading files", "committedDate": "2020-12-01T05:02:59Z", "type": "commit"}, {"oid": "e5bedd779a55ee29122b1e81c30c5c60a1fa4ab0", "url": "https://github.com/apache/hbase/commit/e5bedd779a55ee29122b1e81c30c5c60a1fa4ab0", "message": "HBASE-25287 Forgetting to unbuffer streams results in many CLOSE_WAIT sockets when loading files", "committedDate": "2020-12-01T05:02:59Z", "type": "forcePushed"}]}