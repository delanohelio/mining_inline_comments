{"pr_number": 2513, "pr_title": "HBASE-25164 Make ModifyTableProcedure support changing meta replica c\u2026", "pr_createdAt": "2020-10-08T14:34:59Z", "pr_url": "https://github.com/apache/hbase/pull/2513", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTg1NjM5Nw==", "url": "https://github.com/apache/hbase/pull/2513#discussion_r501856397", "bodyText": "Doc needs an edit. It has section on meta replicas how-to.", "author": "saintstack", "createdAt": "2020-10-08T16:32:42Z", "path": "hbase-common/src/main/java/org/apache/hadoop/hbase/HConstants.java", "diffHunk": "@@ -1131,7 +1131,20 @@\n   /** Conf key for enabling meta replication */\n   public static final String USE_META_REPLICAS = \"hbase.meta.replicas.use\";\n   public static final boolean DEFAULT_USE_META_REPLICAS = false;\n+\n+  /**\n+   * @deprecated Since 2.4.0, will be removed in 4.0.0. Please change the meta replicas number by\n+   *             altering meta table, i.e, set a new 'region replication' number and call\n+   *             modifyTable.\n+   */\n+  @Deprecated\n   public static final String META_REPLICAS_NUM = \"hbase.meta.replica.count\";\n+  /**\n+   * @deprecated Since 2.4.0, will be removed in 4.0.0. Please change the meta replicas number by\n+   *             altering meta table, i.e, set a new 'region replication' number and call\n+   *             modifyTable.\n+   */\n+  @Deprecated", "originalCommit": "1de3e5344dcf99fa14d9ecbb1dc84b21b8de7799", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTg2MTI4Mw==", "url": "https://github.com/apache/hbase/pull/2513#discussion_r501861283", "bodyText": "Grep hbase.meta.replica.count in the doc.", "author": "saintstack", "createdAt": "2020-10-08T16:40:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTg1NjM5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjcyMzA5NQ==", "url": "https://github.com/apache/hbase/pull/2513#discussion_r502723095", "bodyText": "Let me open a new issue to land the documentation change.", "author": "Apache9", "createdAt": "2020-10-10T00:43:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTg1NjM5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjcyMzI2OQ==", "url": "https://github.com/apache/hbase/pull/2513#discussion_r502723269", "bodyText": "https://issues.apache.org/jira/browse/HBASE-25169", "author": "Apache9", "createdAt": "2020-10-10T00:45:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTg1NjM5Nw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTg1OTg0Ng==", "url": "https://github.com/apache/hbase/pull/2513#discussion_r501859846", "bodyText": "Good", "author": "saintstack", "createdAt": "2020-10-08T16:38:13Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/HMaster.java", "diffHunk": "@@ -1093,6 +1091,39 @@ private void finishActiveMasterInitialization(MonitoredTask status) throws IOExc\n     this.assignmentManager.joinCluster();\n     // The below depends on hbase:meta being online.\n     this.tableStateManager.start();\n+\n+    // for migrating from a version without HBASE-25099, and also for honoring the configuration\n+    // first.\n+    if (conf.get(HConstants.META_REPLICAS_NUM) != null) {\n+      int replicasNumInConf =\n+        conf.getInt(HConstants.META_REPLICAS_NUM, HConstants.DEFAULT_META_REPLICA_NUM);\n+      TableDescriptor metaDesc = tableDescriptors.get(TableName.META_TABLE_NAME);\n+      if (metaDesc.getRegionReplication() != replicasNumInConf) {\n+        // it is possible that we already have some replicas before upgrading, so we must set the\n+        // region replication number in meta TableDescriptor directly first, without creating a\n+        // ModifyTableProcedure, otherwise it may cause a double assign for the meta replicas.\n+        int existingReplicasCount =\n+          assignmentManager.getRegionStates().getRegionsOfTable(TableName.META_TABLE_NAME).size();\n+        if (existingReplicasCount > metaDesc.getRegionReplication()) {\n+          LOG.info(\"Update replica count of hbase:meta from {}(in TableDescriptor)\" +\n+            \" to {}(existing ZNodes)\", metaDesc.getRegionReplication(), existingReplicasCount);\n+          metaDesc = TableDescriptorBuilder.newBuilder(metaDesc)\n+            .setRegionReplication(existingReplicasCount).build();\n+          tableDescriptors.update(metaDesc);\n+        }\n+        // check again, and issue a ModifyTableProcedure if needed\n+        if (metaDesc.getRegionReplication() != replicasNumInConf) {\n+          LOG.info(\n+            \"The {} config is {} while the replica count in TableDescriptor is {}\" +\n+              \" for hbase:meta, altering...\",\n+            HConstants.META_REPLICAS_NUM, replicasNumInConf, metaDesc.getRegionReplication());\n+          procedureExecutor.submitProcedure(new ModifyTableProcedure(\n+            procedureExecutor.getEnvironment(), TableDescriptorBuilder.newBuilder(metaDesc)\n+              .setRegionReplication(replicasNumInConf).build(),\n+            null, metaDesc, false));\n+        }\n+      }\n+    }", "originalCommit": "1de3e5344dcf99fa14d9ecbb1dc84b21b8de7799", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTg2MjA1NQ==", "url": "https://github.com/apache/hbase/pull/2513#discussion_r501862055", "bodyText": "We don't need this anymore?", "author": "saintstack", "createdAt": "2020-10-08T16:41:51Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/HMaster.java", "diffHunk": "@@ -1157,13 +1188,6 @@ private void finishActiveMasterInitialization(MonitoredTask status) throws IOExc\n     }\n \n     assignmentManager.checkIfShouldMoveSystemRegionAsync();\n-    status.setStatus(\"Assign meta replicas\");\n-    MasterMetaBootstrap metaBootstrap = createMetaBootstrap();\n-    try {\n-      metaBootstrap.assignMetaReplicas();\n-    } catch (IOException | KeeperException e){\n-      LOG.error(\"Assigning meta replica failed: \", e);\n-    }", "originalCommit": "1de3e5344dcf99fa14d9ecbb1dc84b21b8de7799", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjcyMjk4Mg==", "url": "https://github.com/apache/hbase/pull/2513#discussion_r502722982", "bodyText": "Yes, in general we do not need this any more. All the works should be done in MTP. The only exception is that we still need to be compatible with the old way so we have a special logic when starting master, to schedule a MTP if the META_REPLICA_NUM has been changed.", "author": "Apache9", "createdAt": "2020-10-10T00:42:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTg2MjA1NQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "82de2106bd85661fa892199ed0cf56161928f371", "url": "https://github.com/apache/hbase/commit/82de2106bd85661fa892199ed0cf56161928f371", "message": "HBASE-25164 Make ModifyTableProcedure support changing meta replica count", "committedDate": "2020-10-10T00:48:10Z", "type": "forcePushed"}, {"oid": "1890a051a2f42c74e289dcf70533d775a3315a47", "url": "https://github.com/apache/hbase/commit/1890a051a2f42c74e289dcf70533d775a3315a47", "message": "HBASE-25164 Make ModifyTableProcedure support changing meta replica count", "committedDate": "2020-10-10T09:01:22Z", "type": "commit"}, {"oid": "1890a051a2f42c74e289dcf70533d775a3315a47", "url": "https://github.com/apache/hbase/commit/1890a051a2f42c74e289dcf70533d775a3315a47", "message": "HBASE-25164 Make ModifyTableProcedure support changing meta replica count", "committedDate": "2020-10-10T09:01:22Z", "type": "forcePushed"}]}