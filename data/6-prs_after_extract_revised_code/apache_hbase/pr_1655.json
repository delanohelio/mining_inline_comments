{"pr_number": 1655, "pr_title": "HBASE-24321 - Add writable MinVersions and read-only Scan to coproc S\u2026", "pr_createdAt": "2020-05-05T16:29:39Z", "pr_url": "https://github.com/apache/hbase/pull/1655", "timeline": [{"oid": "d4e6bf0252a5c89c28c1426179feff634a1dae3c", "url": "https://github.com/apache/hbase/commit/d4e6bf0252a5c89c28c1426179feff634a1dae3c", "message": "HBASE-24321 - Add writable MinVersions and read-only Scan to coproc ScanOptions", "committedDate": "2020-05-05T16:27:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM1MjU0OA==", "url": "https://github.com/apache/hbase/pull/1655#discussion_r420352548", "bodyText": "The Scan constructor throws IOE now?? Not an issue for this patch, though", "author": "apurtell", "createdAt": "2020-05-05T19:26:21Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/CustomizedScanInfoBuilder.java", "diffHunk": "@@ -34,8 +36,18 @@\n \n   private KeepDeletedCells keepDeletedCells = null;\n \n+  private Integer minVersions;\n+\n+  private final Scan scan;\n+\n   public CustomizedScanInfoBuilder(ScanInfo scanInfo) {\n     this.scanInfo = scanInfo;\n+    this.scan = new Scan();\n+  }\n+  public CustomizedScanInfoBuilder(ScanInfo scanInfo, Scan scan) throws IOException {", "originalCommit": "d4e6bf0252a5c89c28c1426179feff634a1dae3c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM2ODgwNw==", "url": "https://github.com/apache/hbase/pull/1655#discussion_r420368807", "bodyText": "I was surprised too.", "author": "gjacoby126", "createdAt": "2020-05-05T19:56:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM1MjU0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ2MDY4MQ==", "url": "https://github.com/apache/hbase/pull/1655#discussion_r420460681", "bodyText": "Looks like the copy constructor for Scan has thrown IOException back since 2009, but the current code does not actually contain anything that throws it. Since I assume changing the signature is more trouble than it's worth, I just had to rethrow from the CustomizedScanInfoBuilder constructor and getScan() methods.", "author": "gjacoby126", "createdAt": "2020-05-05T23:10:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM1MjU0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ4OTg3Mw==", "url": "https://github.com/apache/hbase/pull/1655#discussion_r420489873", "bodyText": "Let's just catch the IOException in the code here and then throw an AssertionError to indicate this should not happen, and we can filed another issue to remove the IOException from throws.", "author": "Apache9", "createdAt": "2020-05-06T00:48:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM1MjU0OA=="}], "type": "inlineReview", "revised_code": {"commit": "38089de230448601763d0d4f59e254d9758df4f2", "chunk": "diff --git a/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/CustomizedScanInfoBuilder.java b/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/CustomizedScanInfoBuilder.java\nindex 7cce2244df..81a43c629a 100644\n--- a/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/CustomizedScanInfoBuilder.java\n+++ b/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/CustomizedScanInfoBuilder.java\n\n@@ -44,10 +44,14 @@ public class CustomizedScanInfoBuilder implements ScanOptions {\n     this.scanInfo = scanInfo;\n     this.scan = new Scan();\n   }\n-  public CustomizedScanInfoBuilder(ScanInfo scanInfo, Scan scan) throws IOException {\n+  public CustomizedScanInfoBuilder(ScanInfo scanInfo, Scan scan) {\n     this.scanInfo = scanInfo;\n     //copy the scan so no coproc using this ScanOptions can alter the \"real\" scan\n-    this.scan = new Scan(scan);\n+    try {\n+      this.scan = new Scan(scan);\n+    } catch (IOException e) {\n+      throw new AssertionError(\"Scan should not throw IOException\", e);\n+    }\n   }\n \n   @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM1Mzg1MQ==", "url": "https://github.com/apache/hbase/pull/1655#discussion_r420353851", "bodyText": "Changes made on the returned scan object will be effective and visible beyond the caller. Clone and return?", "author": "apurtell", "createdAt": "2020-05-05T19:28:48Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/CustomizedScanInfoBuilder.java", "diffHunk": "@@ -80,4 +93,19 @@ public KeepDeletedCells getKeepDeletedCells() {\n     return keepDeletedCells != null ? keepDeletedCells : scanInfo.getKeepDeletedCells();\n   }\n \n+  @Override\n+  public int getMinVersions() {\n+    return minVersions != null ? minVersions : scanInfo.getMinVersions();\n+  }\n+\n+  @Override\n+  public void setMinVersions(int minVersions) {\n+    this.minVersions = minVersions;\n+  }\n+\n+  @Override\n+  public Scan getScan() {\n+    return scan;", "originalCommit": "d4e6bf0252a5c89c28c1426179feff634a1dae3c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM1NTQ2NQ==", "url": "https://github.com/apache/hbase/pull/1655#discussion_r420355465", "bodyText": "I didn't check to see how much of Scan is immutable...", "author": "apurtell", "createdAt": "2020-05-05T19:31:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM1Mzg1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM3MDUxNQ==", "url": "https://github.com/apache/hbase/pull/1655#discussion_r420370515", "bodyText": "Scan is mostly mutable, I think. That's a good point -- the clone in the constructor will prevent changes from executing, but a caller could still mess up the state for future callers. I'll clone in the getter.", "author": "gjacoby126", "createdAt": "2020-05-05T19:59:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM1Mzg1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ2MDg1Ng==", "url": "https://github.com/apache/hbase/pull/1655#discussion_r420460856", "bodyText": "Done.", "author": "gjacoby126", "createdAt": "2020-05-05T23:11:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM1Mzg1MQ=="}], "type": "inlineReview", "revised_code": {"commit": "59cde3dc6eabd0d1b898f18d0c461b6602bd7082", "chunk": "diff --git a/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/CustomizedScanInfoBuilder.java b/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/CustomizedScanInfoBuilder.java\nindex 7cce2244df..4cdd85cd8e 100644\n--- a/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/CustomizedScanInfoBuilder.java\n+++ b/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/CustomizedScanInfoBuilder.java\n\n@@ -104,8 +104,8 @@ public class CustomizedScanInfoBuilder implements ScanOptions {\n   }\n \n   @Override\n-  public Scan getScan() {\n-    return scan;\n+  public Scan getScan() throws IOException {\n+    return new Scan(scan);\n   }\n \n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM1NDk2OQ==", "url": "https://github.com/apache/hbase/pull/1655#discussion_r420354969", "bodyText": "Nice additional tests.", "author": "apurtell", "createdAt": "2020-05-05T19:30:48Z", "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/coprocessor/TestRegionCoprocessorHost.java", "diffHunk": "@@ -74,4 +105,73 @@ public void testLoadDuplicateCoprocessor() throws Exception {\n     // Two duplicate coprocessors loaded\n     assertEquals(2, host.coprocEnvironments.size());\n   }\n-}\n\\ No newline at end of file\n+", "originalCommit": "d4e6bf0252a5c89c28c1426179feff634a1dae3c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "59cde3dc6eabd0d1b898f18d0c461b6602bd7082", "url": "https://github.com/apache/hbase/commit/59cde3dc6eabd0d1b898f18d0c461b6602bd7082", "message": "HBASE-24321 - Add writable MinVersions and read-only Scan to coproc ScanOptions", "committedDate": "2020-05-05T21:08:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ4OTA3Mw==", "url": "https://github.com/apache/hbase/pull/1655#discussion_r420489073", "bodyText": "I think this class is only used to test whether a specific CP method has been called? What is this used for?", "author": "Apache9", "createdAt": "2020-05-06T00:44:53Z", "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/coprocessor/SimpleRegionObserver.java", "diffHunk": "@@ -685,6 +687,40 @@ public StoreFileReader postStoreFileReaderOpen(ObserverContext<RegionCoprocessor\n     return reader;\n   }\n \n+  @Override\n+  public void preStoreScannerOpen(ObserverContext<RegionCoprocessorEnvironment> ctx,\n+    Store store, ScanOptions options) throws IOException {\n+    if (options.getScan().getTimeRange().isAllTime()) {", "originalCommit": "59cde3dc6eabd0d1b898f18d0c461b6602bd7082", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDUyMDU1OA==", "url": "https://github.com/apache/hbase/pull/1655#discussion_r420520558", "bodyText": "See TestRegionCoprocessorHost. It's used to test that the scanner coproc hooks are wired up correctly and can alter a ScanInfo.", "author": "gjacoby126", "createdAt": "2020-05-06T03:00:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ4OTA3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDUyMjk0OQ==", "url": "https://github.com/apache/hbase/pull/1655#discussion_r420522949", "bodyText": "OK, the rebuild of the ScanInfo is done in RegionCoprocessorHost, I used to thought it is done in HStore on some other places.", "author": "Apache9", "createdAt": "2020-05-06T03:12:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ4OTA3Mw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ5MTAwMA==", "url": "https://github.com/apache/hbase/pull/1655#discussion_r420491000", "bodyText": "Is this method still referenced? Just remove it?", "author": "Apache9", "createdAt": "2020-05-06T00:52:54Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/ScanInfo.java", "diffHunk": "@@ -174,8 +174,13 @@ public boolean isNewVersionBehavior() {\n    * Used for CP users for customizing max versions, ttl and keepDeletedCells.\n    */\n   ScanInfo customize(int maxVersions, long ttl, KeepDeletedCells keepDeletedCells) {", "originalCommit": "59cde3dc6eabd0d1b898f18d0c461b6602bd7082", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDUyMDg5OQ==", "url": "https://github.com/apache/hbase/pull/1655#discussion_r420520899", "bodyText": "It was used by a few tests: TestCompaction, TestDefaultCompaction, TestMajorCompaction.", "author": "gjacoby126", "createdAt": "2020-05-06T03:02:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ5MTAwMA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ5MTU1Mg==", "url": "https://github.com/apache/hbase/pull/1655#discussion_r420491552", "bodyText": "Please add a comment to say that the returned Scan object is only for reading, changing it will have no effect to the actual scan operation.\nAnd please modify the javadoc of this class to indicate that now we can also change min versions?", "author": "Apache9", "createdAt": "2020-05-06T00:55:03Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/ScanOptions.java", "diffHunk": "@@ -64,4 +66,10 @@ default void readAllVersions() {\n   void setKeepDeletedCells(KeepDeletedCells keepDeletedCells);\n \n   KeepDeletedCells getKeepDeletedCells();\n+\n+  int getMinVersions();\n+\n+  void setMinVersions(int minVersions);\n+\n+  Scan getScan() throws IOException;", "originalCommit": "59cde3dc6eabd0d1b898f18d0c461b6602bd7082", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDUyNzM5MQ==", "url": "https://github.com/apache/hbase/pull/1655#discussion_r420527391", "bodyText": "Done", "author": "gjacoby126", "createdAt": "2020-05-06T03:33:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ5MTU1Mg=="}], "type": "inlineReview", "revised_code": {"commit": "95f88022ba84fa679cd9a8e0cc5e85ad4eb3fa66", "chunk": "diff --git a/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/ScanOptions.java b/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/ScanOptions.java\nindex 57d1e8100c..24dcfe092e 100644\n--- a/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/ScanOptions.java\n+++ b/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/ScanOptions.java\n\n@@ -71,5 +71,8 @@ public interface ScanOptions {\n \n   void setMinVersions(int minVersions);\n \n-  Scan getScan() throws IOException;\n+  /**\n+   * Returns a read-only copy of the Scan object\n+   */\n+  Scan getScan();\n }\n"}}, {"oid": "38089de230448601763d0d4f59e254d9758df4f2", "url": "https://github.com/apache/hbase/commit/38089de230448601763d0d4f59e254d9758df4f2", "message": "HBASE-24321 - Add writable MinVersions and read-only Scan to coproc ScanOptions", "committedDate": "2020-05-06T03:22:29Z", "type": "commit"}, {"oid": "95f88022ba84fa679cd9a8e0cc5e85ad4eb3fa66", "url": "https://github.com/apache/hbase/commit/95f88022ba84fa679cd9a8e0cc5e85ad4eb3fa66", "message": "HBASE-24321 - Add writable MinVersions and read-only Scan to coproc ScanOptions", "committedDate": "2020-05-06T03:32:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDUyOTIzNw==", "url": "https://github.com/apache/hbase/pull/1655#discussion_r420529237", "bodyText": "The comment is a bit confusing as you are free to call the modification methods of the returned Scan object? So it is not 'read only'.\nMaybe better with \"The returned Scan object is just a copy, modifying it will have no effect, so treat it as read-only.\"\nOf course I'm not a native English speaker, so feel free to use your own word. Just show the meaning that 'you can modify, but no effect, so please do not modify'.", "author": "Apache9", "createdAt": "2020-05-06T03:42:40Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/ScanOptions.java", "diffHunk": "@@ -64,4 +66,13 @@ default void readAllVersions() {\n   void setKeepDeletedCells(KeepDeletedCells keepDeletedCells);\n \n   KeepDeletedCells getKeepDeletedCells();\n+\n+  int getMinVersions();\n+\n+  void setMinVersions(int minVersions);\n+\n+  /**\n+   * Returns a read-only copy of the Scan object", "originalCommit": "95f88022ba84fa679cd9a8e0cc5e85ad4eb3fa66", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDU2MTY2OA==", "url": "https://github.com/apache/hbase/pull/1655#discussion_r420561668", "bodyText": "Good point. Done.", "author": "gjacoby126", "createdAt": "2020-05-06T06:02:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDUyOTIzNw=="}], "type": "inlineReview", "revised_code": {"commit": "27c2f4ef969ce625af19001afa30fe61bb2f4fe1", "chunk": "diff --git a/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/ScanOptions.java b/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/ScanOptions.java\nindex 24dcfe092e..e81f3ce4b3 100644\n--- a/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/ScanOptions.java\n+++ b/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/ScanOptions.java\n\n@@ -72,7 +72,7 @@ public interface ScanOptions {\n   void setMinVersions(int minVersions);\n \n   /**\n-   * Returns a read-only copy of the Scan object\n+   * Returns a copy of the Scan object. Modifying it will have no effect.\n    */\n   Scan getScan();\n }\n"}}, {"oid": "27c2f4ef969ce625af19001afa30fe61bb2f4fe1", "url": "https://github.com/apache/hbase/commit/27c2f4ef969ce625af19001afa30fe61bb2f4fe1", "message": "HBASE-24321 - Add writable MinVersions and read-only Scan to coproc ScanOptions", "committedDate": "2020-05-06T06:01:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTA4MDM3Mg==", "url": "https://github.com/apache/hbase/pull/1655#discussion_r421080372", "bodyText": "Might be good at some point to have an unmodifiable subclass or wrapper of Scan, so that any modification would cause an error. (not in this PR, though)", "author": "lhofhansl", "createdAt": "2020-05-06T20:44:41Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/CustomizedScanInfoBuilder.java", "diffHunk": "@@ -80,4 +97,23 @@ public KeepDeletedCells getKeepDeletedCells() {\n     return keepDeletedCells != null ? keepDeletedCells : scanInfo.getKeepDeletedCells();\n   }\n \n+  @Override\n+  public int getMinVersions() {\n+    return minVersions != null ? minVersions : scanInfo.getMinVersions();\n+  }\n+\n+  @Override\n+  public void setMinVersions(int minVersions) {\n+    this.minVersions = minVersions;\n+  }\n+\n+  @Override\n+  public Scan getScan() {\n+    try {\n+      return new Scan(scan);", "originalCommit": "27c2f4ef969ce625af19001afa30fe61bb2f4fe1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjU5ODA1NQ==", "url": "https://github.com/apache/hbase/pull/1655#discussion_r422598055", "bodyText": "+1 to Immutable Scan wrapper with unmodifiable getters", "author": "virajjasani", "createdAt": "2020-05-10T06:54:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTA4MDM3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjYzMzk2OQ==", "url": "https://github.com/apache/hbase/pull/1655#discussion_r422633969", "bodyText": "+1..  That was something came to my mind too while reading the Jira desc. :-)", "author": "anoopsjohn", "createdAt": "2020-05-10T11:51:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTA4MDM3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjYzNDA3Ng==", "url": "https://github.com/apache/hbase/pull/1655#discussion_r422634076", "bodyText": "Already the scan object been cloned while setting in this class..  Every time with get also we need to clone?", "author": "anoopsjohn", "createdAt": "2020-05-10T11:52:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTA4MDM3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjY1NzYxMw==", "url": "https://github.com/apache/hbase/pull/1655#discussion_r422657613", "bodyText": "@anoopsjohn  In the original draft it was only cloned in the constructor. @apurtell pointed out that that meant that one coproc override could call getScan(), call a setter on the Scan, and that a subsequent override would see the modified Scan, so he asked me to fix that.", "author": "gjacoby126", "createdAt": "2020-05-10T15:06:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTA4MDM3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjY2Njk4OQ==", "url": "https://github.com/apache/hbase/pull/1655#discussion_r422666989", "bodyText": "Ok.  An ImmutableScan would have helped. Fine. As long as we dont have lets do this.", "author": "anoopsjohn", "createdAt": "2020-05-10T16:24:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTA4MDM3Mg=="}], "type": "inlineReview", "revised_code": null}]}