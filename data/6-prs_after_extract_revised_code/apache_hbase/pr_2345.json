{"pr_number": 2345, "pr_title": "HBASE-24974: Provide a flexibility to print only row key and filter for multiple tables in the WALPrettyPrinter", "pr_createdAt": "2020-09-03T05:03:45Z", "pr_url": "https://github.com/apache/hbase/pull/2345", "timeline": [{"oid": "3ecf4e3f5c78d95a9057c76902ac9c1c742364f5", "url": "https://github.com/apache/hbase/commit/3ecf4e3f5c78d95a9057c76902ac9c1c742364f5", "message": "HBASE-24974: Provide a flexibility to print only row key and filter for multiple tables in the WALPrettyPrinter", "committedDate": "2020-09-03T05:01:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjgxOTYzNw==", "url": "https://github.com/apache/hbase/pull/2345#discussion_r482819637", "bodyText": "nit: \"Only lof entries for these tables...\"", "author": "wchevreuil", "createdAt": "2020-09-03T08:58:27Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/wal/WALPrettyPrinter.java", "diffHunk": "@@ -147,11 +153,13 @@ public void setSequenceFilter(long sequence) {\n   }\n \n   /**\n-   * Sets the table filter. Only log entries for this table are printed.\n-   * @param table table name to set.\n+   * Sets the tables filter. Only log entries for these table are printed.", "originalCommit": "3ecf4e3f5c78d95a9057c76902ac9c1c742364f5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f7af39eaf5909e2307c8cf0637da051f809b24bf", "chunk": "diff --git a/hbase-server/src/main/java/org/apache/hadoop/hbase/wal/WALPrettyPrinter.java b/hbase-server/src/main/java/org/apache/hadoop/hbase/wal/WALPrettyPrinter.java\nindex 78a39c7ce9..43703b34ff 100644\n--- a/hbase-server/src/main/java/org/apache/hadoop/hbase/wal/WALPrettyPrinter.java\n+++ b/hbase-server/src/main/java/org/apache/hadoop/hbase/wal/WALPrettyPrinter.java\n\n@@ -153,13 +154,11 @@ public class WALPrettyPrinter {\n   }\n \n   /**\n-   * Sets the tables filter. Only log entries for these table are printed.\n-   * @param tableListWithDelimiter table names separated with comma.\n+   * Sets the tables filter. Only log entries for these tables are printed.\n+   * @param tablesWithDelimiter table names separated with comma.\n    */\n-  public void setTableFilter(String tableListWithDelimiter) {\n-    for (String table :  tableListWithDelimiter.split(\",\")) {\n-      tableList.add(table);\n-    }\n+  public void setTableFilter(String tablesWithDelimiter) {\n+    Collections.addAll(tableSet, tablesWithDelimiter.split(\",\"));\n   }\n   /**\n    * sets the region by which output will be filtered\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjgyNDgwNQ==", "url": "https://github.com/apache/hbase/pull/2345#discussion_r482824805", "bodyText": "nit: for clarity, shouldn't we name it as tableSet instead of tableList? Or maybe better to use List/ArrayList.", "author": "wchevreuil", "createdAt": "2020-09-03T09:06:28Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/wal/WALPrettyPrinter.java", "diffHunk": "@@ -79,9 +81,12 @@\n   private boolean outputJSON;\n   // The following enable filtering by sequence, region, and row, respectively\n   private long sequence;\n-  private String table;\n+\n+  // List of tables for filter\n+  private Set<String> tableList;", "originalCommit": "3ecf4e3f5c78d95a9057c76902ac9c1c742364f5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg1NzQxNg==", "url": "https://github.com/apache/hbase/pull/2345#discussion_r482857416", "bodyText": "+1, and this should be final too.", "author": "virajjasani", "createdAt": "2020-09-03T09:56:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjgyNDgwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzM2NTk1MA==", "url": "https://github.com/apache/hbase/pull/2345#discussion_r483365950", "bodyText": "I used Set since every WALEntry is going to search in the Set which is optimal for search.\nas @virajjasani  pointed out in another comment", "author": "sandeepvinayak", "createdAt": "2020-09-04T03:33:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjgyNDgwNQ=="}], "type": "inlineReview", "revised_code": {"commit": "f7af39eaf5909e2307c8cf0637da051f809b24bf", "chunk": "diff --git a/hbase-server/src/main/java/org/apache/hadoop/hbase/wal/WALPrettyPrinter.java b/hbase-server/src/main/java/org/apache/hadoop/hbase/wal/WALPrettyPrinter.java\nindex 78a39c7ce9..43703b34ff 100644\n--- a/hbase-server/src/main/java/org/apache/hadoop/hbase/wal/WALPrettyPrinter.java\n+++ b/hbase-server/src/main/java/org/apache/hadoop/hbase/wal/WALPrettyPrinter.java\n\n@@ -83,7 +84,7 @@ public class WALPrettyPrinter {\n   private long sequence;\n \n   // List of tables for filter\n-  private Set<String> tableList;\n+  private final Set<String> tableSet;\n   private String region;\n   private String row;\n   private boolean outputOnlyRowKey;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjgzMDM3OA==", "url": "https://github.com/apache/hbase/pull/2345#discussion_r482830378", "bodyText": "Is HashSet really needed here? Can this be a simple ArrayList?", "author": "wchevreuil", "createdAt": "2020-09-03T09:14:18Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/wal/WALPrettyPrinter.java", "diffHunk": "@@ -99,9 +104,10 @@ public WALPrettyPrinter() {\n     outputValues = false;\n     outputJSON = false;\n     sequence = -1;\n-    table = null;\n+    tableList = new HashSet<>();", "originalCommit": "3ecf4e3f5c78d95a9057c76902ac9c1c742364f5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f7af39eaf5909e2307c8cf0637da051f809b24bf", "chunk": "diff --git a/hbase-server/src/main/java/org/apache/hadoop/hbase/wal/WALPrettyPrinter.java b/hbase-server/src/main/java/org/apache/hadoop/hbase/wal/WALPrettyPrinter.java\nindex 78a39c7ce9..43703b34ff 100644\n--- a/hbase-server/src/main/java/org/apache/hadoop/hbase/wal/WALPrettyPrinter.java\n+++ b/hbase-server/src/main/java/org/apache/hadoop/hbase/wal/WALPrettyPrinter.java\n\n@@ -104,7 +105,7 @@ public class WALPrettyPrinter {\n     outputValues = false;\n     outputJSON = false;\n     sequence = -1;\n-    tableList = new HashSet<>();\n+    tableSet = new HashSet<>();\n     region = null;\n     row = null;\n     outputOnlyRowKey = false;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjgzMjcxMg==", "url": "https://github.com/apache/hbase/pull/2345#discussion_r482832712", "bodyText": "Let's be more direct: \"Prints only row keys\".", "author": "wchevreuil", "createdAt": "2020-09-03T09:18:09Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/wal/WALPrettyPrinter.java", "diffHunk": "@@ -391,6 +415,8 @@ public static void run(String[] args) throws IOException {\n         \"Region to filter by. Pass encoded region name; e.g. '9192caead6a5a20acb4454ffbc79fa14'\");\n     options.addOption(\"s\", \"sequence\", true,\n         \"Sequence to filter by. Pass sequence number.\");\n+    options.addOption(\"k\", \"outputOnlyRowKey\", false,\n+      \"If only row keys are required in output\");", "originalCommit": "3ecf4e3f5c78d95a9057c76902ac9c1c742364f5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f7af39eaf5909e2307c8cf0637da051f809b24bf", "chunk": "diff --git a/hbase-server/src/main/java/org/apache/hadoop/hbase/wal/WALPrettyPrinter.java b/hbase-server/src/main/java/org/apache/hadoop/hbase/wal/WALPrettyPrinter.java\nindex 78a39c7ce9..43703b34ff 100644\n--- a/hbase-server/src/main/java/org/apache/hadoop/hbase/wal/WALPrettyPrinter.java\n+++ b/hbase-server/src/main/java/org/apache/hadoop/hbase/wal/WALPrettyPrinter.java\n\n@@ -410,13 +409,14 @@ public class WALPrettyPrinter {\n     options.addOption(\"h\", \"help\", false, \"Output help message\");\n     options.addOption(\"j\", \"json\", false, \"Output JSON\");\n     options.addOption(\"p\", \"printvals\", false, \"Print values\");\n-    options.addOption(\"t\", \"table\", true, \"Table name to filter by.\");\n+    options.addOption(\"t\", \"tables\", true,\n+      \"Table names (comma separated) to filter by; eg: test1,test2,test3 \");\n     options.addOption(\"r\", \"region\", true,\n         \"Region to filter by. Pass encoded region name; e.g. '9192caead6a5a20acb4454ffbc79fa14'\");\n     options.addOption(\"s\", \"sequence\", true,\n         \"Sequence to filter by. Pass sequence number.\");\n     options.addOption(\"k\", \"outputOnlyRowKey\", false,\n-      \"If only row keys are required in output\");\n+      \"Print only row keys\");\n     options.addOption(\"w\", \"row\", true, \"Row to filter by. Pass row name.\");\n     options.addOption(\"g\", \"goto\", true, \"Position to seek to in the file\");\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg1NDUyNA==", "url": "https://github.com/apache/hbase/pull/2345#discussion_r482854524", "bodyText": "This can be replaced with:\n    Collections.addAll(tableList, tableListWithDelimiter.split(\",\"));", "author": "virajjasani", "createdAt": "2020-09-03T09:51:34Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/wal/WALPrettyPrinter.java", "diffHunk": "@@ -147,11 +153,13 @@ public void setSequenceFilter(long sequence) {\n   }\n \n   /**\n-   * Sets the table filter. Only log entries for this table are printed.\n-   * @param table table name to set.\n+   * Sets the tables filter. Only log entries for these table are printed.\n+   * @param tableListWithDelimiter table names separated with comma.\n    */\n-  public void setTableFilter(String table) {\n-    this.table = table;\n+  public void setTableFilter(String tableListWithDelimiter) {\n+    for (String table :  tableListWithDelimiter.split(\",\")) {\n+      tableList.add(table);\n+    }", "originalCommit": "3ecf4e3f5c78d95a9057c76902ac9c1c742364f5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f7af39eaf5909e2307c8cf0637da051f809b24bf", "chunk": "diff --git a/hbase-server/src/main/java/org/apache/hadoop/hbase/wal/WALPrettyPrinter.java b/hbase-server/src/main/java/org/apache/hadoop/hbase/wal/WALPrettyPrinter.java\nindex 78a39c7ce9..43703b34ff 100644\n--- a/hbase-server/src/main/java/org/apache/hadoop/hbase/wal/WALPrettyPrinter.java\n+++ b/hbase-server/src/main/java/org/apache/hadoop/hbase/wal/WALPrettyPrinter.java\n\n@@ -153,13 +154,11 @@ public class WALPrettyPrinter {\n   }\n \n   /**\n-   * Sets the tables filter. Only log entries for these table are printed.\n-   * @param tableListWithDelimiter table names separated with comma.\n+   * Sets the tables filter. Only log entries for these tables are printed.\n+   * @param tablesWithDelimiter table names separated with comma.\n    */\n-  public void setTableFilter(String tableListWithDelimiter) {\n-    for (String table :  tableListWithDelimiter.split(\",\")) {\n-      tableList.add(table);\n-    }\n+  public void setTableFilter(String tablesWithDelimiter) {\n+    Collections.addAll(tableSet, tablesWithDelimiter.split(\",\"));\n   }\n   /**\n    * sets the region by which output will be filtered\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg1NjM2MQ==", "url": "https://github.com/apache/hbase/pull/2345#discussion_r482856361", "bodyText": "Looks like this efficient search with contains() is the reason behind using Set instead of List.\nBtw, (TableName) is redundant cast here.", "author": "virajjasani", "createdAt": "2020-09-03T09:54:37Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/wal/WALPrettyPrinter.java", "diffHunk": "@@ -274,7 +289,8 @@ public void processFile(final Configuration conf, final Path p)\n         Map<String, Object> txn = key.toStringMap();\n         long writeTime = key.getWriteTime();\n         // check output filters\n-        if (table != null && !((TableName) txn.get(\"table\")).toString().equals(table)) {\n+        if (!tableList.isEmpty() &&\n+          !tableList.contains(((TableName) txn.get(\"table\")).toString())) {", "originalCommit": "3ecf4e3f5c78d95a9057c76902ac9c1c742364f5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f7af39eaf5909e2307c8cf0637da051f809b24bf", "chunk": "diff --git a/hbase-server/src/main/java/org/apache/hadoop/hbase/wal/WALPrettyPrinter.java b/hbase-server/src/main/java/org/apache/hadoop/hbase/wal/WALPrettyPrinter.java\nindex 78a39c7ce9..43703b34ff 100644\n--- a/hbase-server/src/main/java/org/apache/hadoop/hbase/wal/WALPrettyPrinter.java\n+++ b/hbase-server/src/main/java/org/apache/hadoop/hbase/wal/WALPrettyPrinter.java\n\n@@ -289,8 +288,8 @@ public class WALPrettyPrinter {\n         Map<String, Object> txn = key.toStringMap();\n         long writeTime = key.getWriteTime();\n         // check output filters\n-        if (!tableList.isEmpty() &&\n-          !tableList.contains(((TableName) txn.get(\"table\")).toString())) {\n+        if (!tableSet.isEmpty() &&\n+          !tableSet.contains(txn.get(\"table\").toString())) {\n           continue;\n         }\n         if (sequence >= 0 && ((Long) txn.get(\"sequence\")) != sequence) {\n"}}, {"oid": "f7af39eaf5909e2307c8cf0637da051f809b24bf", "url": "https://github.com/apache/hbase/commit/f7af39eaf5909e2307c8cf0637da051f809b24bf", "message": "Addressing comments", "committedDate": "2020-09-04T03:44:40Z", "type": "commit"}, {"oid": "ecb8cf32756553ba0b2b467f2d65efd1c4129ecc", "url": "https://github.com/apache/hbase/commit/ecb8cf32756553ba0b2b467f2d65efd1c4129ecc", "message": "fixing check-s", "committedDate": "2020-09-04T07:03:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzc3NDY0NQ==", "url": "https://github.com/apache/hbase/pull/2345#discussion_r483774645", "bodyText": "nit: I think the second condition covers the first one.", "author": "bharathv", "createdAt": "2020-09-04T18:01:47Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/wal/WALPrettyPrinter.java", "diffHunk": "@@ -274,7 +287,8 @@ public void processFile(final Configuration conf, final Path p)\n         Map<String, Object> txn = key.toStringMap();\n         long writeTime = key.getWriteTime();\n         // check output filters\n-        if (table != null && !((TableName) txn.get(\"table\")).toString().equals(table)) {\n+        if (!tableSet.isEmpty() &&", "originalCommit": "ecb8cf32756553ba0b2b467f2d65efd1c4129ecc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzgzNzkyNQ==", "url": "https://github.com/apache/hbase/pull/2345#discussion_r483837925", "bodyText": "I think we need the first one where we don't pass -t param and set is Empty. In that case, the second one will always skip all the tables. @bharathv", "author": "sandeepvinayak", "createdAt": "2020-09-04T20:48:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzc3NDY0NQ=="}], "type": "inlineReview", "revised_code": null}]}