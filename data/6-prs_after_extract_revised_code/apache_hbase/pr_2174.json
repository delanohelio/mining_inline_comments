{"pr_number": 2174, "pr_title": "HBASE-24794 hbase.rowlock.wait.duration should not be <= 0", "pr_createdAt": "2020-07-30T06:00:47Z", "pr_url": "https://github.com/apache/hbase/pull/2174", "timeline": [{"oid": "6bdce35efb512b712594573fafe811db0ae86684", "url": "https://github.com/apache/hbase/commit/6bdce35efb512b712594573fafe811db0ae86684", "message": "HBASE-24794 hbase.rowlock.wait.duration should not be <= 0", "committedDate": "2020-07-29T21:33:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjgwMDUzOA==", "url": "https://github.com/apache/hbase/pull/2174#discussion_r462800538", "bodyText": "nit: We are not expecting this condition for upgrade to 3.0.0 right? We can either roll this out to branch-2.2+ except master or we can remove behavior of hbase versions older than 1.4 from log msg at least in master branch to treat this as generic condition regardless of how HBase version<1.4 treated negative rowLockDuration. For branch-2.2+, log msg as is should be good (i.e behavior of hbase versions older than 1.4 suits well to branch-2.x).\nThought?", "author": "virajjasani", "createdAt": "2020-07-30T07:24:29Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java", "diffHunk": "@@ -793,8 +793,15 @@ public HRegion(final HRegionFileSystem fs, final WAL wal, final Configuration co\n       throw new IllegalArgumentException(MEMSTORE_FLUSH_PER_CHANGES + \" can not exceed \"\n           + MAX_FLUSH_PER_CHANGES);\n     }\n-    this.rowLockWaitDuration = conf.getInt(\"hbase.rowlock.wait.duration\",\n-                    DEFAULT_ROWLOCK_WAIT_DURATION);\n+    int tmpRowLockDuration = conf.getInt(\"hbase.rowlock.wait.duration\",\n+        DEFAULT_ROWLOCK_WAIT_DURATION);\n+    if (tmpRowLockDuration <= 0) {", "originalCommit": "6bdce35efb512b712594573fafe811db0ae86684", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk1MDEyMw==", "url": "https://github.com/apache/hbase/pull/2174#discussion_r462950123", "bodyText": "I dunno. If the reason we're treating it as 1ms, rather than e.g. refusing to open the region, is because in old hbase versions you could rely on this behavior then that's no less true in hbase 4 then in hbase 1.7.0.", "author": "busbey", "createdAt": "2020-07-30T12:09:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjgwMDUzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk1MTA0NQ==", "url": "https://github.com/apache/hbase/pull/2174#discussion_r462951045", "bodyText": "We could remove mention of the reasoning about old versions of hbase all the time though and just say we are doing it since not doing so will mean the region won't allow row locks?", "author": "busbey", "createdAt": "2020-07-30T12:11:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjgwMDUzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzAwMTU0NA==", "url": "https://github.com/apache/hbase/pull/2174#discussion_r463001544", "bodyText": "Sure, removing the mention of old HBase version behaviour sounds good \ud83d\udc4d\nBecause the logic of keeping negative value or 0 to 1 ms (quite low but still) is definitely required.", "author": "virajjasani", "createdAt": "2020-07-30T13:37:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjgwMDUzOA=="}], "type": "inlineReview", "revised_code": {"commit": "4e0f95dfcb4b419e9c2e8ccdc2cebb01eb30b1aa", "chunk": "diff --git a/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java b/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java\nindex b120a363e8..812411e955 100644\n--- a/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java\n+++ b/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java\n\n@@ -797,8 +797,7 @@ public class HRegion implements HeapSize, PropagatingConfigurationObserver, Regi\n         DEFAULT_ROWLOCK_WAIT_DURATION);\n     if (tmpRowLockDuration <= 0) {\n       LOG.info(\"Found hbase.rowlock.wait.duration set to {}. values <= 0 will cause all row \" +\n-          \"locking to fail. Treating it as 1ms to approximate behavior of hbase versions older \" +\n-          \"than 1.4.\", tmpRowLockDuration);\n+          \"locking to fail. Treating it as 1ms to avoid region failure.\", tmpRowLockDuration);\n       tmpRowLockDuration = 1;\n     }\n     this.rowLockWaitDuration = tmpRowLockDuration;\n"}}, {"oid": "4e0f95dfcb4b419e9c2e8ccdc2cebb01eb30b1aa", "url": "https://github.com/apache/hbase/commit/4e0f95dfcb4b419e9c2e8ccdc2cebb01eb30b1aa", "message": "HBASE-24794 addendum for better info message.", "committedDate": "2020-07-30T16:22:40Z", "type": "commit"}]}