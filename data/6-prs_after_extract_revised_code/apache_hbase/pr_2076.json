{"pr_number": 2076, "pr_title": "HBASE-24740 Enable journal logging for HBase snapshot operation", "pr_createdAt": "2020-07-16T00:37:32Z", "pr_url": "https://github.com/apache/hbase/pull/2076", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQ1OTg4Ng==", "url": "https://github.com/apache/hbase/pull/2076#discussion_r455459886", "bodyText": "branch-1 doesn't support parameterized logging, so wrap with LOG.isDebugEnabled() checks? Saves string construction when debug logging isn't enabled. (multiple places).", "author": "bharathv", "createdAt": "2020-07-16T01:41:49Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/snapshot/SnapshotManager.java", "diffHunk": "@@ -624,14 +623,16 @@ private void takeSnapshotInternal(SnapshotDescription snapshot) throws IOExcepti\n     AssignmentManager assignmentMgr = master.getAssignmentManager();\n     if (assignmentMgr.getTableStateManager().isTableState(snapshotTable,\n         ZooKeeperProtos.Table.State.ENABLED)) {\n-      LOG.debug(\"Table enabled, starting distributed snapshot.\");\n+      LOG.debug(\"Table enabled, starting distributed snapshot for \"", "originalCommit": "78356c875934b95421002b96299b933612116bd1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjEwNDgwOA==", "url": "https://github.com/apache/hbase/pull/2076#discussion_r456104808", "bodyText": "Makes sense , updated in latest patch", "author": "sguggilam", "createdAt": "2020-07-16T22:04:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQ1OTg4Ng=="}], "type": "inlineReview", "revised_code": {"commit": "d04b5783108048fb4f7232b9507dc203ca0b83fc", "chunk": "diff --git a/hbase-server/src/main/java/org/apache/hadoop/hbase/master/snapshot/SnapshotManager.java b/hbase-server/src/main/java/org/apache/hadoop/hbase/master/snapshot/SnapshotManager.java\nindex 66a68f9d9a..98018f07a4 100644\n--- a/hbase-server/src/main/java/org/apache/hadoop/hbase/master/snapshot/SnapshotManager.java\n+++ b/hbase-server/src/main/java/org/apache/hadoop/hbase/master/snapshot/SnapshotManager.java\n\n@@ -623,18 +623,26 @@ public class SnapshotManager extends MasterProcedureManager implements Stoppable\n     AssignmentManager assignmentMgr = master.getAssignmentManager();\n     if (assignmentMgr.getTableStateManager().isTableState(snapshotTable,\n         ZooKeeperProtos.Table.State.ENABLED)) {\n-      LOG.debug(\"Table enabled, starting distributed snapshot for \"\n-          + ClientSnapshotDescriptionUtils.toString(snapshot));\n+      if (LOG.isDebugEnabled()) {\n+        LOG.debug(\"Table enabled, starting distributed snapshot for \"\n+            + ClientSnapshotDescriptionUtils.toString(snapshot));\n+      }\n       snapshotEnabledTable(snapshot);\n-      LOG.debug(\"Started snapshot: \" + ClientSnapshotDescriptionUtils.toString(snapshot));\n+      if (LOG.isDebugEnabled()) {\n+        LOG.debug(\"Started snapshot: \" + ClientSnapshotDescriptionUtils.toString(snapshot));\n+      }\n     }\n     // For disabled table, snapshot is created by the master\n     else if (assignmentMgr.getTableStateManager().isTableState(snapshotTable,\n         ZooKeeperProtos.Table.State.DISABLED)) {\n+      if (LOG.isDebugEnabled()) {\n         LOG.debug(\"Table is disabled, running snapshot entirely on master \"\n             + ClientSnapshotDescriptionUtils.toString(snapshot));\n+      }\n       snapshotDisabledTable(snapshot);\n-      LOG.debug(\"Started snapshot: \" + ClientSnapshotDescriptionUtils.toString(snapshot));\n+      if (LOG.isDebugEnabled()) {\n+        LOG.debug(\"Started snapshot: \" + ClientSnapshotDescriptionUtils.toString(snapshot));\n+      }\n     } else {\n       LOG.error(\"Can't snapshot table '\" + snapshot.getTable()\n           + \"', isn't open or closed, we don't know what to do!\");\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQ2NTgzNA==", "url": "https://github.com/apache/hbase/pull/2076#discussion_r455465834", "bodyText": "Any reason to have a separate setter instead of passing it via create() ?", "author": "bharathv", "createdAt": "2020-07-16T02:03:27Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/snapshot/SnapshotManifest.java", "diffHunk": "@@ -343,6 +343,13 @@ private void load() throws IOException {\n     }\n   }\n \n+  /**\n+   * Sets the status task for monitoring all the subtasks for Snapshot operation\n+   */\n+  public void setMonitoredTask(MonitoredTask statusTask) {", "originalCommit": "78356c875934b95421002b96299b933612116bd1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY5NzY1NQ==", "url": "https://github.com/apache/hbase/pull/2076#discussion_r455697655", "bodyText": "Passing with create() sounds good, this class is anyways IA.Private, we can add new argument to public methods.", "author": "virajjasani", "createdAt": "2020-07-16T10:49:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQ2NTgzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjEwNDU2NQ==", "url": "https://github.com/apache/hbase/pull/2076#discussion_r456104565", "bodyText": "There are few other places where  create method is getting called in src and test classes. I just thought this would be easier for the callers to set the status as optional when needed instead of passing in to the create call where everyone has pass in null explicitly in the absence of task object.", "author": "sguggilam", "createdAt": "2020-07-16T22:04:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQ2NTgzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjI0ODgwMQ==", "url": "https://github.com/apache/hbase/pull/2076#discussion_r456248801", "bodyText": "It seems more straight to readers if we pass this in the create(). Also this class field can be final then. @sguggilam We can have two versions of create() I guess? The one supporting those call sites which do not need monitored task does not need to change.", "author": "liuml07", "createdAt": "2020-07-17T06:41:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQ2NTgzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQ4MDg1Mg==", "url": "https://github.com/apache/hbase/pull/2076#discussion_r456480852", "bodyText": "+1", "author": "virajjasani", "createdAt": "2020-07-17T14:33:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQ2NTgzNA=="}], "type": "inlineReview", "revised_code": {"commit": "1f6544aabbbdad41806e76df287cc97769c63a15", "chunk": "diff --git a/hbase-server/src/main/java/org/apache/hadoop/hbase/snapshot/SnapshotManifest.java b/hbase-server/src/main/java/org/apache/hadoop/hbase/snapshot/SnapshotManifest.java\nindex 655f1ad4c6..483433345f 100644\n--- a/hbase-server/src/main/java/org/apache/hadoop/hbase/snapshot/SnapshotManifest.java\n+++ b/hbase-server/src/main/java/org/apache/hadoop/hbase/snapshot/SnapshotManifest.java\n\n@@ -343,13 +350,6 @@ public final class SnapshotManifest {\n     }\n   }\n \n-  /**\n-   * Sets the status task for monitoring all the subtasks for Snapshot operation\n-   */\n-  public void setMonitoredTask(MonitoredTask statusTask) {\n-    this.statusTask = statusTask;\n-  }\n-\n   /**\n    * Get the current snapshot working dir\n    */\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTcwMjA2OA==", "url": "https://github.com/apache/hbase/pull/2076#discussion_r455702068", "bodyText": "looks like import reorder is due to formatter :)", "author": "virajjasani", "createdAt": "2020-07-16T10:57:57Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/snapshot/SnapshotManager.java", "diffHunk": "@@ -34,22 +37,21 @@\n import java.util.concurrent.TimeUnit;\n import java.util.concurrent.locks.ReadWriteLock;\n import java.util.concurrent.locks.ReentrantReadWriteLock;\n-\n import org.apache.commons.logging.Log;\n import org.apache.commons.logging.LogFactory;\n-import org.apache.hadoop.hbase.classification.InterfaceAudience;\n-import org.apache.hadoop.hbase.classification.InterfaceStability;\n import org.apache.hadoop.conf.Configuration;\n import org.apache.hadoop.fs.FSDataInputStream;\n import org.apache.hadoop.fs.FileStatus;\n import org.apache.hadoop.fs.FileSystem;\n import org.apache.hadoop.fs.Path;\n-import org.apache.hadoop.hbase.TableName;\n import org.apache.hadoop.hbase.HBaseInterfaceAudience;\n import org.apache.hadoop.hbase.HConstants;\n import org.apache.hadoop.hbase.HTableDescriptor;\n-import org.apache.hadoop.hbase.Stoppable;\n import org.apache.hadoop.hbase.MetaTableAccessor;\n+import org.apache.hadoop.hbase.Stoppable;\n+import org.apache.hadoop.hbase.TableName;\n+import org.apache.hadoop.hbase.classification.InterfaceAudience;\n+import org.apache.hadoop.hbase.classification.InterfaceStability;", "originalCommit": "78356c875934b95421002b96299b933612116bd1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "d04b5783108048fb4f7232b9507dc203ca0b83fc", "url": "https://github.com/apache/hbase/commit/d04b5783108048fb4f7232b9507dc203ca0b83fc", "message": "HBASE-24740 Enable journal logging for HBase snapshot operation", "committedDate": "2020-07-16T18:49:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjI1MTY1OQ==", "url": "https://github.com/apache/hbase/pull/2076#discussion_r456251659", "bodyText": "Is this required?", "author": "liuml07", "createdAt": "2020-07-17T06:48:51Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/monitoring/MonitoredTaskImpl.java", "diffHunk": "@@ -18,15 +18,13 @@\n  */\n package org.apache.hadoop.hbase.monitoring;\n \n-import org.apache.hadoop.hbase.classification.InterfaceAudience;\n-\n import java.io.IOException;\n import java.util.ArrayList;\n import java.util.Collections;\n import java.util.HashMap;\n import java.util.List;\n import java.util.Map;\n-\n+import org.apache.hadoop.hbase.classification.InterfaceAudience;", "originalCommit": "d04b5783108048fb4f7232b9507dc203ca0b83fc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQ4MTA4OA==", "url": "https://github.com/apache/hbase/pull/2076#discussion_r456481088", "bodyText": "This also looks formatter's doing.", "author": "virajjasani", "createdAt": "2020-07-17T14:33:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjI1MTY1OQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "1f6544aabbbdad41806e76df287cc97769c63a15", "url": "https://github.com/apache/hbase/commit/1f6544aabbbdad41806e76df287cc97769c63a15", "message": "review comments", "committedDate": "2020-07-17T17:02:24Z", "type": "commit"}]}