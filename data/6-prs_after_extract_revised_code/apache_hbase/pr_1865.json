{"pr_number": 1865, "pr_title": "HBASE-24117 Shutdown AssignmentManager before ProcedureExecutor may c\u2026", "pr_createdAt": "2020-06-08T09:25:38Z", "pr_url": "https://github.com/apache/hbase/pull/1865", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA1ODkxMA==", "url": "https://github.com/apache/hbase/pull/1865#discussion_r437058910", "bodyText": "Do you mean 'prior to other services'; i.e. before? If so, s/priority/prior/.", "author": "saintstack", "createdAt": "2020-06-08T23:40:31Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/HMaster.java", "diffHunk": "@@ -1530,6 +1530,11 @@ protected void stopServiceThreads() {\n \n     LOG.debug(\"Stopping service threads\");\n \n+    // stop procedure executor priority to other services such as server manager and assignment", "originalCommit": "fa2a0710daa4acfd6d2dbbd25fb3e74d92c66f32", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA1OTA1MA==", "url": "https://github.com/apache/hbase/pull/1865#discussion_r437059050", "bodyText": "Is this a synchronous call?", "author": "saintstack", "createdAt": "2020-06-08T23:40:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA1ODkxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA3NjkwOQ==", "url": "https://github.com/apache/hbase/pull/1865#discussion_r437076909", "bodyText": "It will wait until all the worker threads are quit.", "author": "Apache9", "createdAt": "2020-06-09T00:49:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA1ODkxMA=="}], "type": "inlineReview", "revised_code": {"commit": "3d3edebe4dafbe3297f101eac6201e1d0aaae107", "chunk": "diff --git a/hbase-server/src/main/java/org/apache/hadoop/hbase/master/HMaster.java b/hbase-server/src/main/java/org/apache/hadoop/hbase/master/HMaster.java\nindex d2a47e2c7a..0ae24c7d76 100644\n--- a/hbase-server/src/main/java/org/apache/hadoop/hbase/master/HMaster.java\n+++ b/hbase-server/src/main/java/org/apache/hadoop/hbase/master/HMaster.java\n\n@@ -1530,7 +1530,7 @@ public class HMaster extends HRegionServer implements MasterServices {\n \n     LOG.debug(\"Stopping service threads\");\n \n-    // stop procedure executor priority to other services such as server manager and assignment\n+    // stop procedure executor prior to other services such as server manager and assignment\n     // manager, as these services are important for some running procedures. See HBASE-24117 for\n     // example.\n     stopProcedureExecutor();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA1OTIxOQ==", "url": "https://github.com/apache/hbase/pull/1865#discussion_r437059219", "bodyText": "Good.", "author": "saintstack", "createdAt": "2020-06-08T23:41:30Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/procedure/ServerCrashProcedure.java", "diffHunk": "@@ -485,6 +486,12 @@ private void assignRegions(MasterProcedureEnv env, List<RegionInfo> regions) thr\n         // UPDATE: HBCKServerCrashProcedure overrides isMatchingRegionLocation; this check can get\n         // in the way of our clearing out 'Unknown Servers'.\n         if (!isMatchingRegionLocation(regionNode)) {\n+          // See HBASE-24117, though we have already changed the shutdown order, it is still worth\n+          // double checking here to confirm that we do not skip assignment incorrectly.\n+          if (!am.isRunning()) {", "originalCommit": "fa2a0710daa4acfd6d2dbbd25fb3e74d92c66f32", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "3d3edebe4dafbe3297f101eac6201e1d0aaae107", "url": "https://github.com/apache/hbase/commit/3d3edebe4dafbe3297f101eac6201e1d0aaae107", "message": "HBASE-24117 Shutdown AssignmentManager before ProcedureExecutor may cause SCP to accidentally skip assigning a region", "committedDate": "2020-06-09T02:00:02Z", "type": "commit"}, {"oid": "3d3edebe4dafbe3297f101eac6201e1d0aaae107", "url": "https://github.com/apache/hbase/commit/3d3edebe4dafbe3297f101eac6201e1d0aaae107", "message": "HBASE-24117 Shutdown AssignmentManager before ProcedureExecutor may cause SCP to accidentally skip assigning a region", "committedDate": "2020-06-09T02:00:02Z", "type": "forcePushed"}]}