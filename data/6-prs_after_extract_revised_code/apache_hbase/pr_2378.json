{"pr_number": 2378, "pr_title": "HBASE-24929 Introduce a special CellComparator for master local region", "pr_createdAt": "2020-09-10T14:23:46Z", "pr_url": "https://github.com/apache/hbase/pull/2378", "timeline": [{"oid": "35ebe6d5abf1de889346e9ba8f70c5b955a6509d", "url": "https://github.com/apache/hbase/commit/35ebe6d5abf1de889346e9ba8f70c5b955a6509d", "message": "HBASE-24929 Introduce a special CellComparator for master local region", "committedDate": "2020-09-11T07:23:46Z", "type": "forcePushed"}, {"oid": "7525a0b8cf305ddae51ec4970a6059a30e69b700", "url": "https://github.com/apache/hbase/commit/7525a0b8cf305ddae51ec4970a6059a30e69b700", "message": "HBASE-24929 Introduce a special CellComparator for master local region", "committedDate": "2020-09-14T03:31:25Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzY5ODc5NA==", "url": "https://github.com/apache/hbase/pull/2378#discussion_r487698794", "bodyText": "Why need to expose this config? This should be a internal thing?", "author": "infraio", "createdAt": "2020-09-14T07:17:10Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java", "diffHunk": "@@ -262,12 +264,9 @@\n     \"hbase.hregion.special.recovered.edits.dir\";\n \n   /**\n-   * Whether to use {@link MetaCellComparator} even if we are not meta region. Used when creating\n-   * master local region.\n+   * The {@link CellComparator} class we want to use. Used when creating master local region.\n    */\n-  public static final String USE_META_CELL_COMPARATOR = \"hbase.region.use.meta.cell.comparator\";\n-\n-  public static final boolean DEFAULT_USE_META_CELL_COMPARATOR = false;\n+  public static final String CELL_COMPARATOR_IMPL = \"hbase.region.cell.comparator.impl\";", "originalCommit": "7525a0b8cf305ddae51ec4970a6059a30e69b700", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzY5OTYyMQ==", "url": "https://github.com/apache/hbase/pull/2378#discussion_r487699621", "bodyText": "We need to set it in MasterRegion. And HRegion is IA.Private so no big problem?", "author": "Apache9", "createdAt": "2020-09-14T07:18:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzY5ODc5NA=="}], "type": "inlineReview", "revised_code": {"commit": "8bf07a992fe84540f899e756d0935211a24cd4b1", "chunk": "diff --git a/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java b/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java\nindex 99c777475d..ed0d2f5ed1 100644\n--- a/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java\n+++ b/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java\n\n@@ -264,9 +263,10 @@ public class HRegion implements HeapSize, PropagatingConfigurationObserver, Regi\n     \"hbase.hregion.special.recovered.edits.dir\";\n \n   /**\n-   * The {@link CellComparator} class we want to use. Used when creating master local region.\n+   * Whether to use {@link MasterRegionCellComparator}.\n    */\n-  public static final String CELL_COMPARATOR_IMPL = \"hbase.region.cell.comparator.impl\";\n+  public static final String USE_MASTER_REGION_CELL_COMPARATOR =\n+    \"hbase.region.use.master.region.cell.comparator\";\n \n   final AtomicBoolean closed = new AtomicBoolean(false);\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzY5ODkxNQ==", "url": "https://github.com/apache/hbase/pull/2378#discussion_r487698915", "bodyText": "Why this change?", "author": "infraio", "createdAt": "2020-09-14T07:17:28Z", "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/util/TestRegionMover2.java", "diffHunk": "@@ -116,7 +116,7 @@ public void testWithMergedRegions() throws Exception {\n       .collect(Collectors.toList());\n     RegionMover.RegionMoverBuilder rmBuilder =\n       new RegionMover.RegionMoverBuilder(rsName, TEST_UTIL.getConfiguration()).ack(true)\n-        .maxthreads(8);\n+        .maxthreads(2);", "originalCommit": "7525a0b8cf305ddae51ec4970a6059a30e69b700", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzcwMTE4OQ==", "url": "https://github.com/apache/hbase/pull/2378#discussion_r487701189", "bodyText": "It is because now when moving a region at master side, we need locate meta first so we will go to master to ask the location for meta again. Now we only have 3 master rpc handlers so it is easy to dead lock if we have more than 3 parallel move requests...\nAnyway, I've also changed this UT in #2392 and added comments to say this. Let me remove the modification in this PR.", "author": "Apache9", "createdAt": "2020-09-14T07:22:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzY5ODkxNQ=="}], "type": "inlineReview", "revised_code": {"commit": "8bf07a992fe84540f899e756d0935211a24cd4b1", "chunk": "diff --git a/hbase-server/src/test/java/org/apache/hadoop/hbase/util/TestRegionMover2.java b/hbase-server/src/test/java/org/apache/hadoop/hbase/util/TestRegionMover2.java\nindex aa945137ea..6007fd7b88 100644\n--- a/hbase-server/src/test/java/org/apache/hadoop/hbase/util/TestRegionMover2.java\n+++ b/hbase-server/src/test/java/org/apache/hadoop/hbase/util/TestRegionMover2.java\n\n@@ -116,7 +116,7 @@ public class TestRegionMover2 {\n       .collect(Collectors.toList());\n     RegionMover.RegionMoverBuilder rmBuilder =\n       new RegionMover.RegionMoverBuilder(rsName, TEST_UTIL.getConfiguration()).ack(true)\n-        .maxthreads(2);\n+        .maxthreads(8);\n     try (RegionMover rm = rmBuilder.build()) {\n       LOG.debug(\"Unloading {}\", regionServer.getServerName());\n       rm.unload();\n"}}, {"oid": "8bf07a992fe84540f899e756d0935211a24cd4b1", "url": "https://github.com/apache/hbase/commit/8bf07a992fe84540f899e756d0935211a24cd4b1", "message": "HBASE-24929 Introduce a special CellComparator for master local region", "committedDate": "2020-09-14T08:30:36Z", "type": "commit"}, {"oid": "8bf07a992fe84540f899e756d0935211a24cd4b1", "url": "https://github.com/apache/hbase/commit/8bf07a992fe84540f899e756d0935211a24cd4b1", "message": "HBASE-24929 Introduce a special CellComparator for master local region", "committedDate": "2020-09-14T08:30:36Z", "type": "forcePushed"}]}