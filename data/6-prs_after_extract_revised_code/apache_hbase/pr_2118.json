{"pr_number": 2118, "pr_title": "HBASE-24758 Avoid flooding replication source RSes logs when no sinks\u2026", "pr_createdAt": "2020-07-22T15:21:52Z", "pr_url": "https://github.com/apache/hbase/pull/2118", "timeline": [{"oid": "59372c7c05c49f322008310999dc81ea4f8e9944", "url": "https://github.com/apache/hbase/commit/59372c7c05c49f322008310999dc81ea4f8e9944", "message": "HBASE-24758 Avoid flooding replication source RSes logs when no sinks are available\n\nChange-Id: I642250ad3b9c958de93c7b34d5435c6523df4641", "committedDate": "2020-07-22T15:19:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkxNDYzMQ==", "url": "https://github.com/apache/hbase/pull/2118#discussion_r458914631", "bodyText": "nit, parameterized logging", "author": "joshelser", "createdAt": "2020-07-22T16:17:55Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/HBaseInterClusterReplicationEndpoint.java", "diffHunk": "@@ -513,8 +514,14 @@ public boolean replicate(ReplicateContext replicateContext) {\n \n     int numSinks = replicationSinkMgr.getNumSinks();\n     if (numSinks == 0) {\n-      LOG.warn(\"{} No replication sinks found, returning without replicating. \"\n-        + \"The source should retry with the same set of edits.\", logPeerId());\n+      if((System.currentTimeMillis() - lastSinkFetchTime) >= (maxRetriesMultiplier*1000)) {\n+        LOG.warn(\n+          \"No replication sinks found, returning without replicating. \"\n+            + \"The source should retry with the same set of edits. Not logging this again for \"\n+            + \"the next \" + maxRetriesMultiplier + \" seconds.\");", "originalCommit": "59372c7c05c49f322008310999dc81ea4f8e9944", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "22ba3628d461102f5ad40a27d2580a8f3d5bb8b1", "chunk": "diff --git a/hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/HBaseInterClusterReplicationEndpoint.java b/hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/HBaseInterClusterReplicationEndpoint.java\nindex 5ebd9b2fa5..6a407e2fd1 100644\n--- a/hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/HBaseInterClusterReplicationEndpoint.java\n+++ b/hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/HBaseInterClusterReplicationEndpoint.java\n\n@@ -518,7 +519,7 @@ public class HBaseInterClusterReplicationEndpoint extends HBaseReplicationEndpoi\n         LOG.warn(\n           \"No replication sinks found, returning without replicating. \"\n             + \"The source should retry with the same set of edits. Not logging this again for \"\n-            + \"the next \" + maxRetriesMultiplier + \" seconds.\");\n+            + \"the next {} seconds.\", maxRetriesMultiplier);\n         lastSinkFetchTime = System.currentTimeMillis();\n       }\n       sleepForRetries(\"No sinks available at peer\", sleepMultiplier);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkxNjYwNg==", "url": "https://github.com/apache/hbase/pull/2118#discussion_r458916606", "bodyText": "JVM will initialize this to zero which is of consequence to the log message (will make sure that you get the LOG.warn the first time).\nExplicitly initialize it here so with a comment so we know that?", "author": "joshelser", "createdAt": "2020-07-22T16:20:50Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/HBaseInterClusterReplicationEndpoint.java", "diffHunk": "@@ -127,6 +127,7 @@\n   private boolean dropOnDeletedTables;\n   private boolean dropOnDeletedColumnFamilies;\n   private boolean isSerial = false;\n+  private long lastSinkFetchTime;", "originalCommit": "59372c7c05c49f322008310999dc81ea4f8e9944", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkyMTk0NA==", "url": "https://github.com/apache/hbase/pull/2118#discussion_r458921944", "bodyText": "+1", "author": "virajjasani", "createdAt": "2020-07-22T16:26:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkxNjYwNg=="}], "type": "inlineReview", "revised_code": {"commit": "22ba3628d461102f5ad40a27d2580a8f3d5bb8b1", "chunk": "diff --git a/hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/HBaseInterClusterReplicationEndpoint.java b/hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/HBaseInterClusterReplicationEndpoint.java\nindex 5ebd9b2fa5..6a407e2fd1 100644\n--- a/hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/HBaseInterClusterReplicationEndpoint.java\n+++ b/hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/HBaseInterClusterReplicationEndpoint.java\n\n@@ -127,7 +127,8 @@ public class HBaseInterClusterReplicationEndpoint extends HBaseReplicationEndpoi\n   private boolean dropOnDeletedTables;\n   private boolean dropOnDeletedColumnFamilies;\n   private boolean isSerial = false;\n-  private long lastSinkFetchTime;\n+  //Initialising as 0 to guarantee at least one logging message\n+  private long lastSinkFetchTime = 0;\n \n   /*\n    * Some implementations of HBaseInterClusterReplicationEndpoint may require instantiate different\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkxNzAyMA==", "url": "https://github.com/apache/hbase/pull/2118#discussion_r458917020", "bodyText": "Might it be helpful to include which peer (in the case that we have multiple) here?", "author": "joshelser", "createdAt": "2020-07-22T16:21:25Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/HBaseInterClusterReplicationEndpoint.java", "diffHunk": "@@ -513,8 +514,14 @@ public boolean replicate(ReplicateContext replicateContext) {\n \n     int numSinks = replicationSinkMgr.getNumSinks();\n     if (numSinks == 0) {\n-      LOG.warn(\"{} No replication sinks found, returning without replicating. \"\n-        + \"The source should retry with the same set of edits.\", logPeerId());\n+      if((System.currentTimeMillis() - lastSinkFetchTime) >= (maxRetriesMultiplier*1000)) {\n+        LOG.warn(\n+          \"No replication sinks found, returning without replicating. \"\n+            + \"The source should retry with the same set of edits. Not logging this again for \"\n+            + \"the next \" + maxRetriesMultiplier + \" seconds.\");\n+        lastSinkFetchTime = System.currentTimeMillis();\n+      }\n+      sleepForRetries(\"No sinks available at peer\", sleepMultiplier);", "originalCommit": "59372c7c05c49f322008310999dc81ea4f8e9944", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU3MDIxMA==", "url": "https://github.com/apache/hbase/pull/2118#discussion_r459570210", "bodyText": "peer id is already been logged inside sleepForRetries method.", "author": "wchevreuil", "createdAt": "2020-07-23T16:18:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkxNzAyMA=="}], "type": "inlineReview", "revised_code": {"commit": "22ba3628d461102f5ad40a27d2580a8f3d5bb8b1", "chunk": "diff --git a/hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/HBaseInterClusterReplicationEndpoint.java b/hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/HBaseInterClusterReplicationEndpoint.java\nindex 5ebd9b2fa5..6a407e2fd1 100644\n--- a/hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/HBaseInterClusterReplicationEndpoint.java\n+++ b/hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/HBaseInterClusterReplicationEndpoint.java\n\n@@ -518,7 +519,7 @@ public class HBaseInterClusterReplicationEndpoint extends HBaseReplicationEndpoi\n         LOG.warn(\n           \"No replication sinks found, returning without replicating. \"\n             + \"The source should retry with the same set of edits. Not logging this again for \"\n-            + \"the next \" + maxRetriesMultiplier + \" seconds.\");\n+            + \"the next {} seconds.\", maxRetriesMultiplier);\n         lastSinkFetchTime = System.currentTimeMillis();\n       }\n       sleepForRetries(\"No sinks available at peer\", sleepMultiplier);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkyMDYzOQ==", "url": "https://github.com/apache/hbase/pull/2118#discussion_r458920639", "bodyText": "Doesn't look like HBaseReplicationEndpoint ever returns null. Guarding against custom endpoint implementations?\nWe should expose getRegionServers on a base-class or interface and explicitly say that we expect a non-null answer. Follow-on..\nIf easy, this would be good to write a quick unit test to cover this method.", "author": "joshelser", "createdAt": "2020-07-22T16:24:54Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSinkManager.java", "diffHunk": "@@ -150,9 +151,14 @@ public synchronized void reportSinkSuccess(SinkPeer sinkPeer) {\n    */\n   public synchronized void chooseSinks() {\n     List<ServerName> slaveAddresses = endpoint.getRegionServers();\n-    Collections.shuffle(slaveAddresses, ThreadLocalRandom.current());\n-    int numSinks = (int) Math.ceil(slaveAddresses.size() * ratio);\n-    sinks = slaveAddresses.subList(0, numSinks);\n+    if(slaveAddresses==null){", "originalCommit": "59372c7c05c49f322008310999dc81ea4f8e9944", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU3MjA4Mw==", "url": "https://github.com/apache/hbase/pull/2118#discussion_r459572083", "bodyText": "Doesn't look like HBaseReplicationEndpoint ever returns null. Guarding against custom endpoint implementations?\n\nYeah, that's indeed the case.\n\nWe should expose getRegionServers on a base-class or interface and explicitly say that we expect a non-null answer. Follow-on..\nIf easy, this would be good to write a quick unit test to cover this method.\n\nSo we can leave getRegionServers at HBaseReplicationEndpoint, emphasize it should never return null. I'm not sure a UT for this would be effective, though. Custom implementations of HBaseReplicationEndpoint returning null would still blow it at runtime.\n\nSo maybe we can safely log warning for if(slaveAddresses.size()==0) ?\n\nYeah, can just leave that.", "author": "wchevreuil", "createdAt": "2020-07-23T16:21:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkyMDYzOQ=="}], "type": "inlineReview", "revised_code": {"commit": "22ba3628d461102f5ad40a27d2580a8f3d5bb8b1", "chunk": "diff --git a/hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSinkManager.java b/hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSinkManager.java\nindex 2771083c0e..62b7799351 100644\n--- a/hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSinkManager.java\n+++ b/hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSinkManager.java\n\n@@ -151,14 +151,12 @@ public class ReplicationSinkManager {\n    */\n   public synchronized void chooseSinks() {\n     List<ServerName> slaveAddresses = endpoint.getRegionServers();\n-    if(slaveAddresses==null){\n+    if(slaveAddresses.isEmpty()){\n       LOG.warn(\"No sinks available at peer. Will not be able to replicate\");\n-      sinks = new ArrayList<ServerName>();\n-    } else {\n-      Collections.shuffle(slaveAddresses, ThreadLocalRandom.current());\n-      int numSinks = (int) Math.ceil(slaveAddresses.size() * ratio);\n-      sinks = slaveAddresses.subList(0, numSinks);\n     }\n+    Collections.shuffle(slaveAddresses, ThreadLocalRandom.current());\n+    int numSinks = (int) Math.ceil(slaveAddresses.size() * ratio);\n+    sinks = slaveAddresses.subList(0, numSinks);\n     lastUpdateToPeers = System.currentTimeMillis();\n     badReportCounts.clear();\n   }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkyMDY0NA==", "url": "https://github.com/apache/hbase/pull/2118#discussion_r458920644", "bodyText": "Further down in setRegionServers(fetchSlavesAddresses(this.getZkw())), fetchSlavesAddresses()is not returning null, but empty list. So maybe we can safely log warning for if(slaveAddresses.size()==0) ?", "author": "virajjasani", "createdAt": "2020-07-22T16:24:54Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSinkManager.java", "diffHunk": "@@ -150,9 +151,14 @@ public synchronized void reportSinkSuccess(SinkPeer sinkPeer) {\n    */\n   public synchronized void chooseSinks() {\n     List<ServerName> slaveAddresses = endpoint.getRegionServers();", "originalCommit": "59372c7c05c49f322008310999dc81ea4f8e9944", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "22ba3628d461102f5ad40a27d2580a8f3d5bb8b1", "chunk": "diff --git a/hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSinkManager.java b/hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSinkManager.java\nindex 2771083c0e..62b7799351 100644\n--- a/hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSinkManager.java\n+++ b/hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSinkManager.java\n\n@@ -151,14 +151,12 @@ public class ReplicationSinkManager {\n    */\n   public synchronized void chooseSinks() {\n     List<ServerName> slaveAddresses = endpoint.getRegionServers();\n-    if(slaveAddresses==null){\n+    if(slaveAddresses.isEmpty()){\n       LOG.warn(\"No sinks available at peer. Will not be able to replicate\");\n-      sinks = new ArrayList<ServerName>();\n-    } else {\n-      Collections.shuffle(slaveAddresses, ThreadLocalRandom.current());\n-      int numSinks = (int) Math.ceil(slaveAddresses.size() * ratio);\n-      sinks = slaveAddresses.subList(0, numSinks);\n     }\n+    Collections.shuffle(slaveAddresses, ThreadLocalRandom.current());\n+    int numSinks = (int) Math.ceil(slaveAddresses.size() * ratio);\n+    sinks = slaveAddresses.subList(0, numSinks);\n     lastUpdateToPeers = System.currentTimeMillis();\n     badReportCounts.clear();\n   }\n"}}, {"oid": "22ba3628d461102f5ad40a27d2580a8f3d5bb8b1", "url": "https://github.com/apache/hbase/commit/22ba3628d461102f5ad40a27d2580a8f3d5bb8b1", "message": "Addressing review comments\n\nChange-Id: I275a01a090472bf9dcf95f89db4407021f778151", "committedDate": "2020-07-23T16:35:19Z", "type": "commit"}, {"oid": "b9e7b74a2a8bfc2528631b45315c6a70c397a969", "url": "https://github.com/apache/hbase/commit/b9e7b74a2a8bfc2528631b45315c6a70c397a969", "message": "addressing last checkstyle issue\n\nChange-Id: I7e8b07e6215451bd288523b7c07e0104e90dcdd9", "committedDate": "2020-07-24T09:20:18Z", "type": "commit"}]}