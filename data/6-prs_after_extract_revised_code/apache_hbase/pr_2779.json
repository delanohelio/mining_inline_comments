{"pr_number": 2779, "pr_title": "HBASE-23340 hmaster /hbase/replication/rs session expired (hbase repl\u2026", "pr_createdAt": "2020-12-15T04:33:51Z", "pr_url": "https://github.com/apache/hbase/pull/2779", "timeline": [{"oid": "151101e8db9468420f521f892c0b07cb089ef365", "url": "https://github.com/apache/hbase/commit/151101e8db9468420f521f892c0b07cb089ef365", "message": "HBASE-23340 hmaster /hbase/replication/rs session expired (hbase replication default value is true, we don't use ) causes logcleaner can not clean oldWALs, which resulits in oldWALs too large (more than 2TB)", "committedDate": "2020-12-19T01:25:04Z", "type": "commit"}, {"oid": "151101e8db9468420f521f892c0b07cb089ef365", "url": "https://github.com/apache/hbase/commit/151101e8db9468420f521f892c0b07cb089ef365", "message": "HBASE-23340 hmaster /hbase/replication/rs session expired (hbase replication default value is true, we don't use ) causes logcleaner can not clean oldWALs, which resulits in oldWALs too large (more than 2TB)", "committedDate": "2020-12-19T01:25:04Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzE1NTI4Mg==", "url": "https://github.com/apache/hbase/pull/2779#discussion_r553155282", "bodyText": "Better set this flag to true by default, and in the below if (zkw == null), set it to false. Without any other assumptions, it is possible that HMaster.getZooKeeper returns null and we will create a new ZKWatcher but shareZK is false then we will not close it...", "author": "Apache9", "createdAt": "2021-01-07T07:37:19Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/master/ReplicationLogCleaner.java", "diffHunk": "@@ -92,12 +96,20 @@ public boolean apply(FileStatus file) {\n   }\n \n   @Override\n-  public void setConf(Configuration config) {\n-    // Make my own Configuration.  Then I'll have my own connection to zk that\n-    // I can close myself when comes time.\n-    Configuration conf = new Configuration(config);\n+  public void init(Map<String, Object> params) {\n+    super.init(params);\n     try {\n-      setConf(conf, new ZKWatcher(conf, \"replicationLogCleaner\", null));\n+      if (MapUtils.isNotEmpty(params)) {\n+        Object master = params.get(HMaster.MASTER);\n+        if (master != null && master instanceof HMaster) {\n+          zkw = ((HMaster) master).getZooKeeper();\n+          shareZK = true;", "originalCommit": "151101e8db9468420f521f892c0b07cb089ef365", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzE3MjI1Nw==", "url": "https://github.com/apache/hbase/pull/2779#discussion_r553172257", "bodyText": "yes\uff0cit is better. But it is impossible that HMaster.getZooKeeper returns null\uff0cand if zk of hmaster is null, master must be abort.", "author": "cuibo01", "createdAt": "2021-01-07T08:20:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzE1NTI4Mg=="}], "type": "inlineReview", "revised_code": null}]}