{"pr_number": 2011, "pr_title": "HBASE-24664 Some changing of split region by overall region size rath\u2026", "pr_createdAt": "2020-07-02T06:13:37Z", "pr_url": "https://github.com/apache/hbase/pull/2011", "timeline": [{"oid": "ef3265964398566ea069a2fc951a26a624af7d8b", "url": "https://github.com/apache/hbase/commit/ef3265964398566ea069a2fc951a26a624af7d8b", "message": "HBASE-24664 Some changing of split region by overall region size rather than only one store size", "committedDate": "2020-07-02T06:09:48Z", "type": "commit"}, {"oid": "79c682c220611299f9fef620529e7d1dd2c83572", "url": "https://github.com/apache/hbase/commit/79c682c220611299f9fef620529e7d1dd2c83572", "message": "fix checkstyle issue", "committedDate": "2020-07-02T07:23:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDEzOTg4OA==", "url": "https://github.com/apache/hbase/pull/2011#discussion_r450139888", "bodyText": "Move this check to the for loops inside isExceedSize, so that we don't have to do do an extra iteration for all stores again in case none returns false for canSplit.", "author": "wchevreuil", "createdAt": "2020-07-06T10:49:08Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/ConstantSizeRegionSplitPolicy.java", "diffHunk": "@@ -68,22 +76,14 @@ protected void configureForRegion(HRegion region) {\n \n   @Override\n   protected boolean shouldSplit() {\n-    boolean foundABigStore = false;\n-\n+    // If any of the stores is unable to split (eg they contain reference files)\n+    // then don't split\n     for (HStore store : region.getStores()) {\n-      // If any of the stores are unable to split (eg they contain reference files)\n-      // then don't split\n-      if ((!store.canSplit())) {\n+      if (!store.canSplit()) {", "originalCommit": "79c682c220611299f9fef620529e7d1dd2c83572", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU4Mzk4Mw==", "url": "https://github.com/apache/hbase/pull/2011#discussion_r450583983", "bodyText": "I moved the canSplit checking to the front purposely, it has benefits below.\n\nMake the logic more clear.\nIf can not split, then we do not need to get tableRegionsCount and sizeToCheck in IncreasingToUpperBoundRegionSplitPolicy, and also avoid other comparsion in loop too.", "author": "bsglz", "createdAt": "2020-07-07T02:56:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDEzOTg4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc1ODAwOA==", "url": "https://github.com/apache/hbase/pull/2011#discussion_r450758008", "bodyText": "Make the logic more clear.\nIf can not split, then we do not need to get tableRegionsCount and sizeToCheck in IncreasingToUpperBoundRegionSplitPolicy, and also avoid other comparsion in loop too.\n\nThat's a problem for IncreasingToUpperBoundRegionSplitPolicy. We shouldn't penalise a parent class because of subclasses implementation specifics. And you are already overriding this method on IncreasingToUpperBoundRegionSplitPolicy to do the extra loop anyways, so why keep this extra, needless loop here?", "author": "wchevreuil", "createdAt": "2020-07-07T10:14:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDEzOTg4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDg0Mjk0OA==", "url": "https://github.com/apache/hbase/pull/2011#discussion_r450842948", "bodyText": "Although IncreasingToUpperBoundRegionSplitPolicy override the shouldSplit, but does not override isExceedSize.\nIMO, even if there is only ConstantSizeRegionSplitPolicy, the ref check should be precondition of size check, since if any store has ref file, all stores are no need to check size, especially the loop is cheap here.", "author": "bsglz", "createdAt": "2020-07-07T12:57:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDEzOTg4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjU5MjQ1Nw==", "url": "https://github.com/apache/hbase/pull/2011#discussion_r452592457", "bodyText": "@wchevreuil  WDYT?", "author": "bsglz", "createdAt": "2020-07-10T02:42:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDEzOTg4OA=="}], "type": "inlineReview", "revised_code": {"commit": "61ff63ea7dbdda9f66c04181a906b32b9cab3aa4", "chunk": "diff --git a/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/ConstantSizeRegionSplitPolicy.java b/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/ConstantSizeRegionSplitPolicy.java\nindex ecc52c1670..129135f050 100644\n--- a/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/ConstantSizeRegionSplitPolicy.java\n+++ b/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/ConstantSizeRegionSplitPolicy.java\n\n@@ -76,14 +76,10 @@ public class ConstantSizeRegionSplitPolicy extends RegionSplitPolicy {\n \n   @Override\n   protected boolean shouldSplit() {\n-    // If any of the stores is unable to split (eg they contain reference files)\n-    // then don't split\n-    for (HStore store : region.getStores()) {\n-      if (!store.canSplit()) {\n-        return false;\n-      }\n+    if (!canSplit()) {\n+      return false;\n     }\n-    return isExceedSize(desiredMaxFileSize, \"\");\n+    return isExceedSize(desiredMaxFileSize);\n   }\n \n   long getDesiredMaxFileSize() {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDE1MDg3NA==", "url": "https://github.com/apache/hbase/pull/2011#discussion_r450150874", "bodyText": "We should just return this comparison and let each caller decide how to log it? That would discard the need for having an extra param just for the sake of logging.", "author": "wchevreuil", "createdAt": "2020-07-06T11:12:43Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/ConstantSizeRegionSplitPolicy.java", "diffHunk": "@@ -94,4 +94,33 @@ long getDesiredMaxFileSize() {\n   public boolean positiveJitterRate() {\n     return this.jitterRate > 0;\n   }\n+\n+  /**\n+   * @return true if region size exceed the sizeToCheck\n+   */\n+  protected boolean isExceedSize(long sizeToCheck, String extraLogStr) {\n+    if (overallHregionFiles) {\n+      long sumSize = 0;\n+      for (HStore store : region.getStores()) {\n+        sumSize += store.getSize();\n+      }\n+      if (sumSize > sizeToCheck) {", "originalCommit": "79c682c220611299f9fef620529e7d1dd2c83572", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU4Nzc0Mg==", "url": "https://github.com/apache/hbase/pull/2011#discussion_r450587742", "bodyText": "The extraLogStr exactly seems a bit strange, but there are several variables used by logging which calculated inside isExceedSize, if we want remove extraLogStr, I think there are some other ways.\n\nUse a map as param instead of extraLogStr.\nChange the return value from boolean to other obj such as map.\nMake the logging more simpler.\n\nI prefer the current way, WDYT?\nThanks. @wchevreuil", "author": "bsglz", "createdAt": "2020-07-07T03:11:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDE1MDg3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc1Nzc0Ng==", "url": "https://github.com/apache/hbase/pull/2011#discussion_r450757746", "bodyText": "We are breaking isolation and cohesion principles, this method should log only the info it has locally, without requiring any additional param just for logging. The additional info available in eventual callers should then be logged by those callers, not passed through as params, here I suggest the log to be only:\nLOG.debug(\"ShouldSplit because region size is big enough \" + \"size={}, sizeToCheck={}\", StringUtils.humanSize(sumSize), StringUtils.humanSize(sizeToCheck))\nThen on IncreasingToUpperBoundRegionSplitPolicy you log the extra info on an additional debug message:\nLOG.debug(regionsWithCommonTable={}\", tableRegionsCount)", "author": "wchevreuil", "createdAt": "2020-07-07T10:14:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDE1MDg3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDg0NjI1Mg==", "url": "https://github.com/apache/hbase/pull/2011#discussion_r450846252", "bodyText": "Yeah, i am agree with you, will fix later.\nThanks.", "author": "bsglz", "createdAt": "2020-07-07T13:02:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDE1MDg3NA=="}], "type": "inlineReview", "revised_code": {"commit": "61ff63ea7dbdda9f66c04181a906b32b9cab3aa4", "chunk": "diff --git a/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/ConstantSizeRegionSplitPolicy.java b/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/ConstantSizeRegionSplitPolicy.java\nindex ecc52c1670..129135f050 100644\n--- a/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/ConstantSizeRegionSplitPolicy.java\n+++ b/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/ConstantSizeRegionSplitPolicy.java\n\n@@ -98,7 +94,7 @@ public class ConstantSizeRegionSplitPolicy extends RegionSplitPolicy {\n   /**\n    * @return true if region size exceed the sizeToCheck\n    */\n-  protected boolean isExceedSize(long sizeToCheck, String extraLogStr) {\n+  protected boolean isExceedSize(long sizeToCheck) {\n     if (overallHregionFiles) {\n       long sumSize = 0;\n       for (HStore store : region.getStores()) {\n"}}, {"oid": "61ff63ea7dbdda9f66c04181a906b32b9cab3aa4", "url": "https://github.com/apache/hbase/commit/61ff63ea7dbdda9f66c04181a906b32b9cab3aa4", "message": "1.remove extraLogStr param; 2.use parent's canSplit", "committedDate": "2020-07-07T13:11:15Z", "type": "commit"}, {"oid": "735f67f0b0e24abd65898ff8948648af3f402e5f", "url": "https://github.com/apache/hbase/commit/735f67f0b0e24abd65898ff8948648af3f402e5f", "message": "fix compile error", "committedDate": "2020-07-07T15:03:35Z", "type": "commit"}, {"oid": "c632a556bba6aea231e19ee09f9f8dba979bdd4b", "url": "https://github.com/apache/hbase/commit/c632a556bba6aea231e19ee09f9f8dba979bdd4b", "message": "fix ut failure", "committedDate": "2020-07-08T02:06:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzMxMzY4NQ==", "url": "https://github.com/apache/hbase/pull/2011#discussion_r453313685", "bodyText": "Should we use 'hregion' or 'region'? I'm not sure, just ask.", "author": "Apache9", "createdAt": "2020-07-12T13:00:07Z", "path": "hbase-common/src/main/java/org/apache/hadoop/hbase/HConstants.java", "diffHunk": "@@ -382,6 +382,13 @@\n   /** Default maximum file size */\n   public static final long DEFAULT_MAX_FILE_SIZE = 10 * 1024 * 1024 * 1024L;\n \n+  /** Conf key for if we should sum overall region files size when check to split */\n+  public static final String OVERALL_HREGION_FILES =", "originalCommit": "c632a556bba6aea231e19ee09f9f8dba979bdd4b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM5OTQ5OQ==", "url": "https://github.com/apache/hbase/pull/2011#discussion_r453399499", "bodyText": "I used region first, and changed to hregion when i saw the surround usage such as \"HREGION_COMPACTIONDIR_NAME\".", "author": "bsglz", "createdAt": "2020-07-13T02:08:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzMxMzY4NQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzMxMzgxNA==", "url": "https://github.com/apache/hbase/pull/2011#discussion_r453313814", "bodyText": "overallHRegionFiles? The 'R' should be upper case.", "author": "Apache9", "createdAt": "2020-07-12T13:01:13Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/ConstantSizeRegionSplitPolicy.java", "diffHunk": "@@ -38,10 +41,13 @@\n  */\n @InterfaceAudience.LimitedPrivate(HBaseInterfaceAudience.CONFIG)\n public class ConstantSizeRegionSplitPolicy extends RegionSplitPolicy {\n+  private static final Logger LOG =\n+    LoggerFactory.getLogger(ConstantSizeRegionSplitPolicy.class);\n   private static final Random RANDOM = new Random();\n \n   private long desiredMaxFileSize;\n   private double jitterRate;\n+  protected boolean overallHregionFiles;", "originalCommit": "c632a556bba6aea231e19ee09f9f8dba979bdd4b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM5OTcxMA==", "url": "https://github.com/apache/hbase/pull/2011#discussion_r453399710", "bodyText": "Will fix.", "author": "bsglz", "createdAt": "2020-07-13T02:10:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzMxMzgxNA=="}], "type": "inlineReview", "revised_code": {"commit": "c7b8fd1286bc5ed1ed1d8c7d99f928a14afbf6df", "chunk": "diff --git a/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/ConstantSizeRegionSplitPolicy.java b/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/ConstantSizeRegionSplitPolicy.java\nindex 129135f050..5ffd96021f 100644\n--- a/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/ConstantSizeRegionSplitPolicy.java\n+++ b/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/ConstantSizeRegionSplitPolicy.java\n\n@@ -47,7 +47,7 @@ public class ConstantSizeRegionSplitPolicy extends RegionSplitPolicy {\n \n   private long desiredMaxFileSize;\n   private double jitterRate;\n-  protected boolean overallHregionFiles;\n+  protected boolean overallHRegionFiles;\n \n   @Override\n   protected void configureForRegion(HRegion region) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzMxNDA1NQ==", "url": "https://github.com/apache/hbase/pull/2011#discussion_r453314055", "bodyText": "Should we make this method final? I think it is used to be called by sub classes, not to be overridden?", "author": "Apache9", "createdAt": "2020-07-12T13:03:29Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/ConstantSizeRegionSplitPolicy.java", "diffHunk": "@@ -94,4 +90,33 @@ long getDesiredMaxFileSize() {\n   public boolean positiveJitterRate() {\n     return this.jitterRate > 0;\n   }\n+\n+  /**\n+   * @return true if region size exceed the sizeToCheck\n+   */\n+  protected boolean isExceedSize(long sizeToCheck) {", "originalCommit": "c632a556bba6aea231e19ee09f9f8dba979bdd4b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM5OTg2NQ==", "url": "https://github.com/apache/hbase/pull/2011#discussion_r453399865", "bodyText": "Will fix.", "author": "bsglz", "createdAt": "2020-07-13T02:10:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzMxNDA1NQ=="}], "type": "inlineReview", "revised_code": {"commit": "c7b8fd1286bc5ed1ed1d8c7d99f928a14afbf6df", "chunk": "diff --git a/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/ConstantSizeRegionSplitPolicy.java b/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/ConstantSizeRegionSplitPolicy.java\nindex 129135f050..5ffd96021f 100644\n--- a/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/ConstantSizeRegionSplitPolicy.java\n+++ b/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/ConstantSizeRegionSplitPolicy.java\n\n@@ -94,8 +94,8 @@ public class ConstantSizeRegionSplitPolicy extends RegionSplitPolicy {\n   /**\n    * @return true if region size exceed the sizeToCheck\n    */\n-  protected boolean isExceedSize(long sizeToCheck) {\n-    if (overallHregionFiles) {\n+  protected final boolean isExceedSize(long sizeToCheck) {\n+    if (overallHRegionFiles) {\n       long sumSize = 0;\n       for (HStore store : region.getStores()) {\n         sumSize += store.getSize();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzMxNDM4Ng==", "url": "https://github.com/apache/hbase/pull/2011#discussion_r453314386", "bodyText": "This is an interesting change. Is behavior still the same?", "author": "Apache9", "createdAt": "2020-07-12T13:06:23Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/RegionSplitPolicy.java", "diffHunk": "@@ -75,7 +75,7 @@ protected void configureForRegion(HRegion region) {\n    */\n   protected boolean canSplit() {\n     return !region.getRegionInfo().isMetaRegion() && region.isAvailable() &&\n-      !region.hasReferences();\n+      region.getStores().stream().allMatch(HStore::canSplit);", "originalCommit": "c632a556bba6aea231e19ee09f9f8dba979bdd4b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQwMTY3MQ==", "url": "https://github.com/apache/hbase/pull/2011#discussion_r453401671", "bodyText": "Yeah, I think they are equivalent.\nThanks.", "author": "bsglz", "createdAt": "2020-07-13T02:20:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzMxNDM4Ng=="}], "type": "inlineReview", "revised_code": null}, {"oid": "c7b8fd1286bc5ed1ed1d8c7d99f928a14afbf6df", "url": "https://github.com/apache/hbase/commit/c7b8fd1286bc5ed1ed1d8c7d99f928a14afbf6df", "message": "fix review issue", "committedDate": "2020-07-13T02:21:24Z", "type": "commit"}]}