{"pr_number": 2179, "pr_title": "HBASE-24694 Support flush a single column family of table", "pr_createdAt": "2020-07-31T07:07:38Z", "pr_url": "https://github.com/apache/hbase/pull/2179", "timeline": [{"oid": "0a1b0aca673c49d1cf5b91fa9881d8c412598220", "url": "https://github.com/apache/hbase/commit/0a1b0aca673c49d1cf5b91fa9881d8c412598220", "message": "HBASE-24694 Support flush a single column family of table", "committedDate": "2020-07-31T07:05:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzUwNTIwMQ==", "url": "https://github.com/apache/hbase/pull/2179#discussion_r463505201", "bodyText": "Nit: It's better to be more specific when debugging: \"About to flush family {} on all regions for table {}\"", "author": "wchevreuil", "createdAt": "2020-07-31T09:27:42Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/procedure/flush/FlushTableSubprocedure.java", "diffHunk": "@@ -88,11 +95,15 @@ private void flushRegions() throws ForeignException {\n       throw new IllegalStateException(\"Attempting to flush \"\n           + table + \" but we currently have outstanding tasks\");\n     }\n-\n+    List<byte[]> families = null;\n+    if (family != null) {\n+      LOG.debug(\"Flush regions with specified family:{}\", family);", "originalCommit": "0a1b0aca673c49d1cf5b91fa9881d8c412598220", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzkyODE1OA==", "url": "https://github.com/apache/hbase/pull/2179#discussion_r463928158", "bodyText": "Will fix, thanks.", "author": "bsglz", "createdAt": "2020-08-01T06:05:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzUwNTIwMQ=="}], "type": "inlineReview", "revised_code": {"commit": "898b8ee225c1a47ca1cb93c54229234b1584e76e", "chunk": "diff --git a/hbase-server/src/main/java/org/apache/hadoop/hbase/procedure/flush/FlushTableSubprocedure.java b/hbase-server/src/main/java/org/apache/hadoop/hbase/procedure/flush/FlushTableSubprocedure.java\nindex c0e1a95dcd..d124039524 100644\n--- a/hbase-server/src/main/java/org/apache/hadoop/hbase/procedure/flush/FlushTableSubprocedure.java\n+++ b/hbase-server/src/main/java/org/apache/hadoop/hbase/procedure/flush/FlushTableSubprocedure.java\n\n@@ -97,7 +101,7 @@ public class FlushTableSubprocedure extends Subprocedure {\n     }\n     List<byte[]> families = null;\n     if (family != null) {\n-      LOG.debug(\"Flush regions with specified family:{}\", family);\n+      LOG.debug(\"About to flush family {} on all regions for table {}\", family, table);\n       families = Arrays.asList(Bytes.toBytes(family));\n     }\n     // Add all hfiles already existing in region.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzUwNzgxOQ==", "url": "https://github.com/apache/hbase/pull/2179#discussion_r463507819", "bodyText": "We should explain better how this overloaded version differs from flush(TableName tableName).", "author": "wchevreuil", "createdAt": "2020-07-31T09:33:07Z", "path": "hbase-client/src/main/java/org/apache/hadoop/hbase/client/Admin.java", "diffHunk": "@@ -513,6 +513,15 @@ default void modifyColumnFamily(TableName tableName, ColumnFamilyDescriptor colu\n    */\n   void flush(TableName tableName) throws IOException;\n \n+  /**\n+   * Flush a table. Synchronous operation.", "originalCommit": "0a1b0aca673c49d1cf5b91fa9881d8c412598220", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzkyODkyMg==", "url": "https://github.com/apache/hbase/pull/2179#discussion_r463928922", "bodyText": "Will fix.", "author": "bsglz", "createdAt": "2020-08-01T06:16:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzUwNzgxOQ=="}], "type": "inlineReview", "revised_code": {"commit": "898b8ee225c1a47ca1cb93c54229234b1584e76e", "chunk": "diff --git a/hbase-client/src/main/java/org/apache/hadoop/hbase/client/Admin.java b/hbase-client/src/main/java/org/apache/hadoop/hbase/client/Admin.java\nindex 3ffd6c4c2c..466432e3ba 100644\n--- a/hbase-client/src/main/java/org/apache/hadoop/hbase/client/Admin.java\n+++ b/hbase-client/src/main/java/org/apache/hadoop/hbase/client/Admin.java\n\n@@ -514,7 +514,7 @@ public interface Admin extends Abortable, Closeable {\n   void flush(TableName tableName) throws IOException;\n \n   /**\n-   * Flush a table. Synchronous operation.\n+   * Flush a table with specified column family. Synchronous operation.\n    *\n    * @param tableName table to flush\n    * @param columnFamily column family within a table\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzUwODE2MA==", "url": "https://github.com/apache/hbase/pull/2179#discussion_r463508160", "bodyText": "We should explain better how this overloaded version differs from flush(TableName tableName).", "author": "wchevreuil", "createdAt": "2020-07-31T09:33:53Z", "path": "hbase-client/src/main/java/org/apache/hadoop/hbase/client/AsyncAdmin.java", "diffHunk": "@@ -302,6 +302,13 @@\n    */\n   CompletableFuture<Void> flush(TableName tableName);\n \n+  /**\n+   * Flush a table.", "originalCommit": "0a1b0aca673c49d1cf5b91fa9881d8c412598220", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzkyOTQ3OA==", "url": "https://github.com/apache/hbase/pull/2179#discussion_r463929478", "bodyText": "Will fix.", "author": "bsglz", "createdAt": "2020-08-01T06:23:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzUwODE2MA=="}], "type": "inlineReview", "revised_code": {"commit": "898b8ee225c1a47ca1cb93c54229234b1584e76e", "chunk": "diff --git a/hbase-client/src/main/java/org/apache/hadoop/hbase/client/AsyncAdmin.java b/hbase-client/src/main/java/org/apache/hadoop/hbase/client/AsyncAdmin.java\nindex eb4acb4334..7826bdd397 100644\n--- a/hbase-client/src/main/java/org/apache/hadoop/hbase/client/AsyncAdmin.java\n+++ b/hbase-client/src/main/java/org/apache/hadoop/hbase/client/AsyncAdmin.java\n\n@@ -303,7 +303,7 @@ public interface AsyncAdmin {\n   CompletableFuture<Void> flush(TableName tableName);\n \n   /**\n-   * Flush a table.\n+   * Flush a table with specified column family.\n    * @param tableName table to flush\n    * @param columnFamily column family within a table\n    */\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzUxNDMyNQ==", "url": "https://github.com/apache/hbase/pull/2179#discussion_r463514325", "bodyText": "Can this affect the other versions that don't specify any families, like flush(TableName tableName)? Because region.flush(true), internally, loads all families before delegating to flushcache(List<byte[]> families, boolean writeFlushRequestWalMarker, FlushLifeCycleTracker tracker), but it doesn't seem we are doing this now.", "author": "wchevreuil", "createdAt": "2020-07-31T09:46:34Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/procedure/flush/FlushTableSubprocedure.java", "diffHunk": "@@ -65,7 +72,7 @@ public Void call() throws Exception {\n       region.startRegionOperation();\n       try {\n         LOG.debug(\"Flush region \" + region.toString() + \" started...\");\n-        region.flush(true);\n+        region.flushcache(families, false, FlushLifeCycleTracker.DUMMY);", "originalCommit": "0a1b0aca673c49d1cf5b91fa9881d8c412598220", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzkyOTYzMA==", "url": "https://github.com/apache/hbase/pull/2179#discussion_r463929630", "bodyText": "You are right, it indeed affect, will fix.\nThanks.", "author": "bsglz", "createdAt": "2020-08-01T06:25:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzUxNDMyNQ=="}], "type": "inlineReview", "revised_code": {"commit": "898b8ee225c1a47ca1cb93c54229234b1584e76e", "chunk": "diff --git a/hbase-server/src/main/java/org/apache/hadoop/hbase/procedure/flush/FlushTableSubprocedure.java b/hbase-server/src/main/java/org/apache/hadoop/hbase/procedure/flush/FlushTableSubprocedure.java\nindex c0e1a95dcd..d124039524 100644\n--- a/hbase-server/src/main/java/org/apache/hadoop/hbase/procedure/flush/FlushTableSubprocedure.java\n+++ b/hbase-server/src/main/java/org/apache/hadoop/hbase/procedure/flush/FlushTableSubprocedure.java\n\n@@ -72,7 +72,11 @@ public class FlushTableSubprocedure extends Subprocedure {\n       region.startRegionOperation();\n       try {\n         LOG.debug(\"Flush region \" + region.toString() + \" started...\");\n-        region.flushcache(families, false, FlushLifeCycleTracker.DUMMY);\n+        if (families == null) {\n+          region.flush(true);\n+        } else {\n+          region.flushcache(families, false, FlushLifeCycleTracker.DUMMY);\n+        }\n         // TODO: flush result is not checked?\n       } finally {\n         LOG.debug(\"Closing region operation on \" + region);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzUxNjE1Mw==", "url": "https://github.com/apache/hbase/pull/2179#discussion_r463516153", "bodyText": "Will it always be non null even when we don't specify any family?", "author": "wchevreuil", "createdAt": "2020-07-31T09:50:22Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/procedure/flush/RegionServerFlushTableProcedureManager.java", "diffHunk": "@@ -183,8 +185,17 @@ public Subprocedure buildSubprocedure(String table) {\n \n     @Override\n     public Subprocedure buildSubprocedure(String name, byte[] data) {\n+      String family = null;\n+      if (data.length > 0) {", "originalCommit": "0a1b0aca673c49d1cf5b91fa9881d8c412598220", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzkyOTkxOA==", "url": "https://github.com/apache/hbase/pull/2179#discussion_r463929918", "bodyText": "Currently it is true, since we only set an empty array before this issue.", "author": "bsglz", "createdAt": "2020-08-01T06:28:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzUxNjE1Mw=="}], "type": "inlineReview", "revised_code": {"commit": "898b8ee225c1a47ca1cb93c54229234b1584e76e", "chunk": "diff --git a/hbase-server/src/main/java/org/apache/hadoop/hbase/procedure/flush/RegionServerFlushTableProcedureManager.java b/hbase-server/src/main/java/org/apache/hadoop/hbase/procedure/flush/RegionServerFlushTableProcedureManager.java\nindex 5ee5855ebd..e05ca1eb7b 100644\n--- a/hbase-server/src/main/java/org/apache/hadoop/hbase/procedure/flush/RegionServerFlushTableProcedureManager.java\n+++ b/hbase-server/src/main/java/org/apache/hadoop/hbase/procedure/flush/RegionServerFlushTableProcedureManager.java\n\n@@ -186,6 +186,8 @@ public class RegionServerFlushTableProcedureManager extends RegionServerProcedur\n     @Override\n     public Subprocedure buildSubprocedure(String name, byte[] data) {\n       String family = null;\n+      // Currently we do not put other data except family, so it is ok to\n+      // judge by length that if family was specified\n       if (data.length > 0) {\n         try {\n           HBaseProtos.NameStringPair nsp = HBaseProtos.NameStringPair.parseFrom(data);\n"}}, {"oid": "898b8ee225c1a47ca1cb93c54229234b1584e76e", "url": "https://github.com/apache/hbase/commit/898b8ee225c1a47ca1cb93c54229234b1584e76e", "message": "fix review issue", "committedDate": "2020-08-01T09:01:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTczNDE3Mw==", "url": "https://github.com/apache/hbase/pull/2179#discussion_r465734173", "bodyText": "Let's not leave any room for confusion: Flush the specified column family stores on all regions of the passed table. This runs as a synchronous operation.", "author": "wchevreuil", "createdAt": "2020-08-05T13:40:37Z", "path": "hbase-client/src/main/java/org/apache/hadoop/hbase/client/Admin.java", "diffHunk": "@@ -513,6 +513,15 @@ default void modifyColumnFamily(TableName tableName, ColumnFamilyDescriptor colu\n    */\n   void flush(TableName tableName) throws IOException;\n \n+  /**\n+   * Flush a table with specified column family. Synchronous operation.", "originalCommit": "898b8ee225c1a47ca1cb93c54229234b1584e76e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTc0NzE2Ng==", "url": "https://github.com/apache/hbase/pull/2179#discussion_r465747166", "bodyText": "Will fix later.\nThanks.", "author": "bsglz", "createdAt": "2020-08-05T13:59:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTczNDE3Mw=="}], "type": "inlineReview", "revised_code": {"commit": "97c948a47332bdf6a5e8b17b5e10f6ac557942cf", "chunk": "diff --git a/hbase-client/src/main/java/org/apache/hadoop/hbase/client/Admin.java b/hbase-client/src/main/java/org/apache/hadoop/hbase/client/Admin.java\nindex 466432e3ba..155f0249da 100644\n--- a/hbase-client/src/main/java/org/apache/hadoop/hbase/client/Admin.java\n+++ b/hbase-client/src/main/java/org/apache/hadoop/hbase/client/Admin.java\n\n@@ -514,7 +514,8 @@ public interface Admin extends Abortable, Closeable {\n   void flush(TableName tableName) throws IOException;\n \n   /**\n-   * Flush a table with specified column family. Synchronous operation.\n+   * Flush the specified column family stores on all regions of the passed table.\n+   * This runs as a synchronous operation.\n    *\n    * @param tableName table to flush\n    * @param columnFamily column family within a table\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTczNDUyNA==", "url": "https://github.com/apache/hbase/pull/2179#discussion_r465734524", "bodyText": "Similar to above.", "author": "wchevreuil", "createdAt": "2020-08-05T13:41:08Z", "path": "hbase-client/src/main/java/org/apache/hadoop/hbase/client/AsyncAdmin.java", "diffHunk": "@@ -302,6 +302,13 @@\n    */\n   CompletableFuture<Void> flush(TableName tableName);\n \n+  /**\n+   * Flush a table with specified column family.", "originalCommit": "898b8ee225c1a47ca1cb93c54229234b1584e76e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTc0NzM0NA==", "url": "https://github.com/apache/hbase/pull/2179#discussion_r465747344", "bodyText": "Will fix later.\nThanks.", "author": "bsglz", "createdAt": "2020-08-05T13:59:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTczNDUyNA=="}], "type": "inlineReview", "revised_code": {"commit": "97c948a47332bdf6a5e8b17b5e10f6ac557942cf", "chunk": "diff --git a/hbase-client/src/main/java/org/apache/hadoop/hbase/client/AsyncAdmin.java b/hbase-client/src/main/java/org/apache/hadoop/hbase/client/AsyncAdmin.java\nindex 7826bdd397..336903d42e 100644\n--- a/hbase-client/src/main/java/org/apache/hadoop/hbase/client/AsyncAdmin.java\n+++ b/hbase-client/src/main/java/org/apache/hadoop/hbase/client/AsyncAdmin.java\n\n@@ -303,7 +303,8 @@ public interface AsyncAdmin {\n   CompletableFuture<Void> flush(TableName tableName);\n \n   /**\n-   * Flush a table with specified column family.\n+   * Flush the specified column family stores on all regions of the passed table.\n+   * This runs as a synchronous operation.\n    * @param tableName table to flush\n    * @param columnFamily column family within a table\n    */\n"}}, {"oid": "97c948a47332bdf6a5e8b17b5e10f6ac557942cf", "url": "https://github.com/apache/hbase/commit/97c948a47332bdf6a5e8b17b5e10f6ac557942cf", "message": "fix review issue", "committedDate": "2020-08-05T14:07:34Z", "type": "commit"}]}