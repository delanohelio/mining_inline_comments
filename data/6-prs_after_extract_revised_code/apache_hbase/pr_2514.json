{"pr_number": 2514, "pr_title": "HBASE-25166 MobFileCompactionChore is closing the master's shared clu\u2026", "pr_createdAt": "2020-10-08T18:26:06Z", "pr_url": "https://github.com/apache/hbase/pull/2514", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTkzMDUwOQ==", "url": "https://github.com/apache/hbase/pull/2514#discussion_r501930509", "bodyText": "I feel like we've run into this a few times recently.\nAny thoughts about whether it's a good idea to make the ShortCircuitingClusterConnection not close itself (unless we can know that we're in the process of shutting down)?", "author": "joshelser", "createdAt": "2020-10-08T18:32:14Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/mob/MobFileCompactionChore.java", "diffHunk": "@@ -84,10 +84,10 @@ public MobFileCompactionChore(Configuration conf, int batchSize) {\n   protected void chore() {\n \n     boolean reported = false;\n-\n-    try (Connection conn = master.getConnection();\n-        Admin admin = conn.getAdmin();) {\n-\n+    Admin admin = null;\n+    try {\n+      Connection conn = master.getConnection();", "originalCommit": "30b50200e654299960bf8be46af6e88e09e4b795", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTk0OTU2OA==", "url": "https://github.com/apache/hbase/pull/2514#discussion_r501949568", "bodyText": "like have it log a debug/info for someone trying to call the normal close but don't do it, then have inShutdownClose to actually close? that sounds like a good idea for a follow-on?", "author": "busbey", "createdAt": "2020-10-08T19:05:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTkzMDUwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTk1ODI0Nw==", "url": "https://github.com/apache/hbase/pull/2514#discussion_r501958247", "bodyText": "that sounds like a good idea for a follow-on?\n\nFine to think about as follow-on. Just wanted to ask the question while it was fresh :D", "author": "joshelser", "createdAt": "2020-10-08T19:20:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTkzMDUwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjExMjczMg==", "url": "https://github.com/apache/hbase/pull/2514#discussion_r502112732", "bodyText": "yes, we should guard-rail the internal connection (in master or RS) from being closed by any shared services by probably wrapping it with SharedConnection which throws an exception when close() is called out (the same way we share it with users through coprocessor ). I'll raise another JIRA for it.\nThanks guys for the ideas and review.", "author": "ankitsinghal", "createdAt": "2020-10-09T01:08:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTkzMDUwOQ=="}], "type": "inlineReview", "revised_code": {"commit": "317258499d8f351535bf66752f23901dfa26116f", "chunk": "diff --git a/hbase-server/src/main/java/org/apache/hadoop/hbase/mob/MobFileCompactionChore.java b/hbase-server/src/main/java/org/apache/hadoop/hbase/mob/MobFileCompactionChore.java\nindex ff9ce460bd..dd5d2898ea 100644\n--- a/hbase-server/src/main/java/org/apache/hadoop/hbase/mob/MobFileCompactionChore.java\n+++ b/hbase-server/src/main/java/org/apache/hadoop/hbase/mob/MobFileCompactionChore.java\n\n@@ -84,10 +83,8 @@ public class MobFileCompactionChore extends ScheduledChore {\n   protected void chore() {\n \n     boolean reported = false;\n-    Admin admin = null;\n-    try {\n-      Connection conn = master.getConnection();\n-      admin = conn.getAdmin();\n+\n+    try (Admin admin = master.getConnection().getAdmin()) {\n       TableDescriptors htds = master.getTableDescriptors();\n       Map<String, TableDescriptor> map = htds.getAll();\n       for (TableDescriptor htd : map.values()) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTk1NTY2MA==", "url": "https://github.com/apache/hbase/pull/2514#discussion_r501955660", "bodyText": "Can we just use try with resources on the Admin object? Do we actually use the Connection at all?", "author": "busbey", "createdAt": "2020-10-08T19:16:07Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/mob/MobFileCompactionChore.java", "diffHunk": "@@ -84,10 +84,10 @@ public MobFileCompactionChore(Configuration conf, int batchSize) {\n   protected void chore() {\n \n     boolean reported = false;\n-\n-    try (Connection conn = master.getConnection();\n-        Admin admin = conn.getAdmin();) {\n-\n+    Admin admin = null;\n+    try {", "originalCommit": "30b50200e654299960bf8be46af6e88e09e4b795", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjExMjgwMQ==", "url": "https://github.com/apache/hbase/pull/2514#discussion_r502112801", "bodyText": "Done", "author": "ankitsinghal", "createdAt": "2020-10-09T01:08:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTk1NTY2MA=="}], "type": "inlineReview", "revised_code": {"commit": "317258499d8f351535bf66752f23901dfa26116f", "chunk": "diff --git a/hbase-server/src/main/java/org/apache/hadoop/hbase/mob/MobFileCompactionChore.java b/hbase-server/src/main/java/org/apache/hadoop/hbase/mob/MobFileCompactionChore.java\nindex ff9ce460bd..dd5d2898ea 100644\n--- a/hbase-server/src/main/java/org/apache/hadoop/hbase/mob/MobFileCompactionChore.java\n+++ b/hbase-server/src/main/java/org/apache/hadoop/hbase/mob/MobFileCompactionChore.java\n\n@@ -84,10 +83,8 @@ public class MobFileCompactionChore extends ScheduledChore {\n   protected void chore() {\n \n     boolean reported = false;\n-    Admin admin = null;\n-    try {\n-      Connection conn = master.getConnection();\n-      admin = conn.getAdmin();\n+\n+    try (Admin admin = master.getConnection().getAdmin()) {\n       TableDescriptors htds = master.getTableDescriptors();\n       Map<String, TableDescriptor> map = htds.getAll();\n       for (TableDescriptor htd : map.values()) {\n"}}, {"oid": "317258499d8f351535bf66752f23901dfa26116f", "url": "https://github.com/apache/hbase/commit/317258499d8f351535bf66752f23901dfa26116f", "message": "HBASE-25166 MobFileCompactionChore is closing the master's shared cluster connection", "committedDate": "2020-10-19T17:44:22Z", "type": "commit"}, {"oid": "317258499d8f351535bf66752f23901dfa26116f", "url": "https://github.com/apache/hbase/commit/317258499d8f351535bf66752f23901dfa26116f", "message": "HBASE-25166 MobFileCompactionChore is closing the master's shared cluster connection", "committedDate": "2020-10-19T17:44:22Z", "type": "forcePushed"}]}