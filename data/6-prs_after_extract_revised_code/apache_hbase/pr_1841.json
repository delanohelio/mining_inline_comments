{"pr_number": 1841, "pr_title": "HBASE-24208 Remove RS entry from zk draining servers node after RS been stopped", "pr_createdAt": "2020-06-03T08:59:49Z", "pr_url": "https://github.com/apache/hbase/pull/1841", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDYwNDQ5OA==", "url": "https://github.com/apache/hbase/pull/1841#discussion_r434604498", "bodyText": "LOG.warn(\"Error deleting the znode for draining server {}\", serverName.getServerName(), e) providing stacktrace will be better?", "author": "virajjasani", "createdAt": "2020-06-03T14:20:17Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/ServerManager.java", "diffHunk": "@@ -586,6 +588,15 @@ synchronized long expireServer(final ServerName serverName, boolean force) {\n     }\n     moveFromOnlineToDeadServers(serverName);\n \n+    // If server is in draining mode, remove corresponding znode\n+    String drainingZnode = ZNodePaths.joinZNode(zkw.getZNodePaths().drainingZNode,\n+      serverName.getServerName());\n+    try {\n+      ZKUtil.deleteNodeFailSilent(zkw, drainingZnode);\n+    } catch (KeeperException e) {\n+      LOG.warn(\"Error deleting the znode for draining server \" + drainingZnode);", "originalCommit": "476400374e804eee2a4fb4c6b0f3b285fecde1f7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTAyODA0OA==", "url": "https://github.com/apache/hbase/pull/1841#discussion_r435028048", "bodyText": "fixed, thx", "author": "gkanade", "createdAt": "2020-06-04T06:49:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDYwNDQ5OA=="}], "type": "inlineReview", "revised_code": {"commit": "46531e9f9b4dd0840408eb1cbbc828ee1cb7c6c3", "chunk": "diff --git a/hbase-server/src/main/java/org/apache/hadoop/hbase/master/ServerManager.java b/hbase-server/src/main/java/org/apache/hadoop/hbase/master/ServerManager.java\nindex 31bb4af76c..f4d5616571 100644\n--- a/hbase-server/src/main/java/org/apache/hadoop/hbase/master/ServerManager.java\n+++ b/hbase-server/src/main/java/org/apache/hadoop/hbase/master/ServerManager.java\n\n@@ -589,12 +588,12 @@ public class ServerManager {\n     moveFromOnlineToDeadServers(serverName);\n \n     // If server is in draining mode, remove corresponding znode\n-    String drainingZnode = ZNodePaths.joinZNode(zkw.getZNodePaths().drainingZNode,\n+    String drainingZnode = ZNodePaths.joinZNode(master.getZooKeeper().getZNodePaths().drainingZNode,\n       serverName.getServerName());\n     try {\n-      ZKUtil.deleteNodeFailSilent(zkw, drainingZnode);\n+      ZKUtil.deleteNodeFailSilent(master.getZooKeeper(), drainingZnode);\n     } catch (KeeperException e) {\n-      LOG.warn(\"Error deleting the znode for draining server \" + drainingZnode);\n+      LOG.warn(\"Error deleting the draining znode for stopping server \" +  serverName.getServerName(), e);\n     }\n     \n     // If cluster is going down, yes, servers are going to be expiring; don't\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDYwNTAyMA==", "url": "https://github.com/apache/hbase/pull/1841#discussion_r434605020", "bodyText": "MediumTests should be good here.", "author": "virajjasani", "createdAt": "2020-06-03T14:20:58Z", "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestDecommissionStopAdminApi.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.hbase.client;\n+\n+import static org.apache.hadoop.hbase.util.Threads.sleep;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertTrue;\n+\n+import java.util.ArrayList;\n+import java.util.EnumSet;\n+import java.util.List;\n+import org.apache.hadoop.hbase.ClusterMetrics;\n+import org.apache.hadoop.hbase.HBaseClassTestRule;\n+import org.apache.hadoop.hbase.HBaseTestingUtility;\n+import org.apache.hadoop.hbase.ServerName;\n+import org.apache.hadoop.hbase.TableName;\n+import org.apache.hadoop.hbase.testclassification.ClientTests;\n+import org.apache.hadoop.hbase.testclassification.LargeTests;\n+import org.junit.Before;\n+import org.junit.ClassRule;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+@Category({ LargeTests.class, ClientTests.class })", "originalCommit": "476400374e804eee2a4fb4c6b0f3b285fecde1f7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTAyODA4Mw==", "url": "https://github.com/apache/hbase/pull/1841#discussion_r435028083", "bodyText": "done thx", "author": "gkanade", "createdAt": "2020-06-04T06:49:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDYwNTAyMA=="}], "type": "inlineReview", "revised_code": {"commit": "46531e9f9b4dd0840408eb1cbbc828ee1cb7c6c3", "chunk": "diff --git a/hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestDecommissionStopAdminApi.java b/hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestAdmin4.java\nsimilarity index 70%\nrename from hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestDecommissionStopAdminApi.java\nrename to hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestAdmin4.java\nindex 898e23ea5c..da3b381956 100644\n--- a/hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestDecommissionStopAdminApi.java\n+++ b/hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestAdmin4.java\n\n@@ -17,33 +17,30 @@\n  */\n package org.apache.hadoop.hbase.client;\n \n-import static org.apache.hadoop.hbase.util.Threads.sleep;\n-import static org.junit.Assert.assertEquals;\n-import static org.junit.Assert.assertTrue;\n+import static org.junit.Assert.*;\n \n import java.util.ArrayList;\n import java.util.EnumSet;\n import java.util.List;\n import org.apache.hadoop.hbase.ClusterMetrics;\n import org.apache.hadoop.hbase.HBaseClassTestRule;\n-import org.apache.hadoop.hbase.HBaseTestingUtility;\n import org.apache.hadoop.hbase.ServerName;\n-import org.apache.hadoop.hbase.TableName;\n import org.apache.hadoop.hbase.testclassification.ClientTests;\n-import org.apache.hadoop.hbase.testclassification.LargeTests;\n-import org.junit.Before;\n+import org.apache.hadoop.hbase.testclassification.MediumTests;\n+import org.apache.hadoop.hbase.zookeeper.ZKUtil;\n+import org.apache.hadoop.hbase.zookeeper.ZKWatcher;\n+import org.apache.hadoop.hbase.zookeeper.ZNodePaths;\n import org.junit.ClassRule;\n import org.junit.Test;\n import org.junit.experimental.categories.Category;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n-@Category({ LargeTests.class, ClientTests.class })\n-public class TestDecommissionStopAdminApi extends TestAdminBase{\n+@Category({ MediumTests.class, ClientTests.class })\n+public class TestAdmin4 extends TestAdminBase{\n   @ClassRule\n-  public static final HBaseClassTestRule CLASS_RULE = HBaseClassTestRule.forClass(TestDecommissionStopAdminApi.class);\n-\n-  private static final Logger LOG = LoggerFactory.getLogger(TestDecommissionStopAdminApi.class);\n+  public static final HBaseClassTestRule CLASS_RULE =\n+    HBaseClassTestRule.forClass(TestAdmin4.class);\n \n   // For HBASE-24208\n   @Test\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDYwNzM5Mw==", "url": "https://github.com/apache/hbase/pull/1841#discussion_r434607393", "bodyText": "We can include this inline directly on L591: ZNodePaths.joinZNode(master.getZooKeeper().getZNodePaths().drainingZNode....\nBecause for below 2 return statements, this just turns out to be redundant statement.", "author": "virajjasani", "createdAt": "2020-06-03T14:23:59Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/ServerManager.java", "diffHunk": "@@ -573,6 +574,7 @@ public synchronized long expireServer(final ServerName serverName) {\n   }\n \n   synchronized long expireServer(final ServerName serverName, boolean force) {\n+    ZKWatcher zkw = master.getZooKeeper();", "originalCommit": "476400374e804eee2a4fb4c6b0f3b285fecde1f7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTAyODE0MQ==", "url": "https://github.com/apache/hbase/pull/1841#discussion_r435028141", "bodyText": "done thx", "author": "gkanade", "createdAt": "2020-06-04T06:49:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDYwNzM5Mw=="}], "type": "inlineReview", "revised_code": {"commit": "46531e9f9b4dd0840408eb1cbbc828ee1cb7c6c3", "chunk": "diff --git a/hbase-server/src/main/java/org/apache/hadoop/hbase/master/ServerManager.java b/hbase-server/src/main/java/org/apache/hadoop/hbase/master/ServerManager.java\nindex 31bb4af76c..f4d5616571 100644\n--- a/hbase-server/src/main/java/org/apache/hadoop/hbase/master/ServerManager.java\n+++ b/hbase-server/src/main/java/org/apache/hadoop/hbase/master/ServerManager.java\n\n@@ -574,7 +574,6 @@ public class ServerManager {\n   }\n \n   synchronized long expireServer(final ServerName serverName, boolean force) {\n-    ZKWatcher zkw = master.getZooKeeper();\n     // THIS server is going down... can't handle our own expiration.\n     if (serverName.equals(master.getServerName())) {\n       if (!(master.isAborted() || master.isStopped())) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTAzMDgzMg==", "url": "https://github.com/apache/hbase/pull/1841#discussion_r435030832", "bodyText": "The line is exceeding 100 chars. Not sure why build didn't catch this as checkstyle issue. Anyways, you can bring it to 2 lines.", "author": "virajjasani", "createdAt": "2020-06-04T06:55:21Z", "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestDecommissionStopAdminApi.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.hbase.client;\n+\n+import static org.apache.hadoop.hbase.util.Threads.sleep;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertTrue;\n+\n+import java.util.ArrayList;\n+import java.util.EnumSet;\n+import java.util.List;\n+import org.apache.hadoop.hbase.ClusterMetrics;\n+import org.apache.hadoop.hbase.HBaseClassTestRule;\n+import org.apache.hadoop.hbase.HBaseTestingUtility;\n+import org.apache.hadoop.hbase.ServerName;\n+import org.apache.hadoop.hbase.TableName;\n+import org.apache.hadoop.hbase.testclassification.ClientTests;\n+import org.apache.hadoop.hbase.testclassification.MediumTests;\n+import org.junit.Before;\n+import org.junit.ClassRule;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+@Category({ MediumTests.class, ClientTests.class })\n+public class TestDecommissionStopAdminApi extends TestAdminBase{\n+  @ClassRule\n+  public static final HBaseClassTestRule CLASS_RULE = HBaseClassTestRule.forClass(TestDecommissionStopAdminApi.class);", "originalCommit": "e523a13c48701c862ed04a0ede28f256a49c4dc6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTEzMDA3Mw==", "url": "https://github.com/apache/hbase/pull/1841#discussion_r435130073", "bodyText": "fixed", "author": "gkanade", "createdAt": "2020-06-04T09:49:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTAzMDgzMg=="}], "type": "inlineReview", "revised_code": {"commit": "46531e9f9b4dd0840408eb1cbbc828ee1cb7c6c3", "chunk": "diff --git a/hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestDecommissionStopAdminApi.java b/hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestAdmin4.java\nsimilarity index 74%\nrename from hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestDecommissionStopAdminApi.java\nrename to hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestAdmin4.java\nindex 5d508a6b78..da3b381956 100644\n--- a/hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestDecommissionStopAdminApi.java\n+++ b/hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestAdmin4.java\n\n@@ -17,21 +17,19 @@\n  */\n package org.apache.hadoop.hbase.client;\n \n-import static org.apache.hadoop.hbase.util.Threads.sleep;\n-import static org.junit.Assert.assertEquals;\n-import static org.junit.Assert.assertTrue;\n+import static org.junit.Assert.*;\n \n import java.util.ArrayList;\n import java.util.EnumSet;\n import java.util.List;\n import org.apache.hadoop.hbase.ClusterMetrics;\n import org.apache.hadoop.hbase.HBaseClassTestRule;\n-import org.apache.hadoop.hbase.HBaseTestingUtility;\n import org.apache.hadoop.hbase.ServerName;\n-import org.apache.hadoop.hbase.TableName;\n import org.apache.hadoop.hbase.testclassification.ClientTests;\n import org.apache.hadoop.hbase.testclassification.MediumTests;\n-import org.junit.Before;\n+import org.apache.hadoop.hbase.zookeeper.ZKUtil;\n+import org.apache.hadoop.hbase.zookeeper.ZKWatcher;\n+import org.apache.hadoop.hbase.zookeeper.ZNodePaths;\n import org.junit.ClassRule;\n import org.junit.Test;\n import org.junit.experimental.categories.Category;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTAzMDk5Ng==", "url": "https://github.com/apache/hbase/pull/1841#discussion_r435030996", "bodyText": "Can be removed", "author": "virajjasani", "createdAt": "2020-06-04T06:55:43Z", "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestDecommissionStopAdminApi.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.hbase.client;\n+\n+import static org.apache.hadoop.hbase.util.Threads.sleep;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertTrue;\n+\n+import java.util.ArrayList;\n+import java.util.EnumSet;\n+import java.util.List;\n+import org.apache.hadoop.hbase.ClusterMetrics;\n+import org.apache.hadoop.hbase.HBaseClassTestRule;\n+import org.apache.hadoop.hbase.HBaseTestingUtility;\n+import org.apache.hadoop.hbase.ServerName;\n+import org.apache.hadoop.hbase.TableName;\n+import org.apache.hadoop.hbase.testclassification.ClientTests;\n+import org.apache.hadoop.hbase.testclassification.MediumTests;\n+import org.junit.Before;\n+import org.junit.ClassRule;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+@Category({ MediumTests.class, ClientTests.class })\n+public class TestDecommissionStopAdminApi extends TestAdminBase{\n+  @ClassRule\n+  public static final HBaseClassTestRule CLASS_RULE = HBaseClassTestRule.forClass(TestDecommissionStopAdminApi.class);\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(TestDecommissionStopAdminApi.class);", "originalCommit": "e523a13c48701c862ed04a0ede28f256a49c4dc6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTEyOTk3NQ==", "url": "https://github.com/apache/hbase/pull/1841#discussion_r435129975", "bodyText": "done", "author": "gkanade", "createdAt": "2020-06-04T09:48:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTAzMDk5Ng=="}], "type": "inlineReview", "revised_code": {"commit": "46531e9f9b4dd0840408eb1cbbc828ee1cb7c6c3", "chunk": "diff --git a/hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestDecommissionStopAdminApi.java b/hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestAdmin4.java\nsimilarity index 74%\nrename from hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestDecommissionStopAdminApi.java\nrename to hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestAdmin4.java\nindex 5d508a6b78..da3b381956 100644\n--- a/hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestDecommissionStopAdminApi.java\n+++ b/hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestAdmin4.java\n\n@@ -17,21 +17,19 @@\n  */\n package org.apache.hadoop.hbase.client;\n \n-import static org.apache.hadoop.hbase.util.Threads.sleep;\n-import static org.junit.Assert.assertEquals;\n-import static org.junit.Assert.assertTrue;\n+import static org.junit.Assert.*;\n \n import java.util.ArrayList;\n import java.util.EnumSet;\n import java.util.List;\n import org.apache.hadoop.hbase.ClusterMetrics;\n import org.apache.hadoop.hbase.HBaseClassTestRule;\n-import org.apache.hadoop.hbase.HBaseTestingUtility;\n import org.apache.hadoop.hbase.ServerName;\n-import org.apache.hadoop.hbase.TableName;\n import org.apache.hadoop.hbase.testclassification.ClientTests;\n import org.apache.hadoop.hbase.testclassification.MediumTests;\n-import org.junit.Before;\n+import org.apache.hadoop.hbase.zookeeper.ZKUtil;\n+import org.apache.hadoop.hbase.zookeeper.ZKWatcher;\n+import org.apache.hadoop.hbase.zookeeper.ZNodePaths;\n import org.junit.ClassRule;\n import org.junit.Test;\n import org.junit.experimental.categories.Category;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTAzMjQyNA==", "url": "https://github.com/apache/hbase/pull/1841#discussion_r435032424", "bodyText": "Instead of relying on sleep (which usually results in flaky tests, works maybe 90% times, and 10% remains flaky), we can use Waiter.wait():\nSomething like this maybe:\n    assertNotEquals(\"Error message...xyz...\", -1,\n      TEST_UTIL.waitFor(1000, () -> ADMIN.listDecommissionedRegionServers().isEmpty()));\n\nBasically Waiter keeps executing the code until it has successfully returned true from the Predicate. If it can't even after timeout, it will return -1.", "author": "virajjasani", "createdAt": "2020-06-04T06:58:39Z", "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestDecommissionStopAdminApi.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.hbase.client;\n+\n+import static org.apache.hadoop.hbase.util.Threads.sleep;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertTrue;\n+\n+import java.util.ArrayList;\n+import java.util.EnumSet;\n+import java.util.List;\n+import org.apache.hadoop.hbase.ClusterMetrics;\n+import org.apache.hadoop.hbase.HBaseClassTestRule;\n+import org.apache.hadoop.hbase.HBaseTestingUtility;\n+import org.apache.hadoop.hbase.ServerName;\n+import org.apache.hadoop.hbase.TableName;\n+import org.apache.hadoop.hbase.testclassification.ClientTests;\n+import org.apache.hadoop.hbase.testclassification.MediumTests;\n+import org.junit.Before;\n+import org.junit.ClassRule;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+@Category({ MediumTests.class, ClientTests.class })\n+public class TestDecommissionStopAdminApi extends TestAdminBase{\n+  @ClassRule\n+  public static final HBaseClassTestRule CLASS_RULE = HBaseClassTestRule.forClass(TestDecommissionStopAdminApi.class);\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(TestDecommissionStopAdminApi.class);\n+\n+  // For HBASE-24208\n+  @Test\n+  public void testDecommissionAndStopRegionServers() throws Exception {\n+    List<ServerName> decommissionedRegionServers = ADMIN.listDecommissionedRegionServers();\n+    assertTrue(decommissionedRegionServers.isEmpty());\n+\n+    ArrayList<ServerName> clusterRegionServers =\n+      new ArrayList<>(ADMIN.getClusterMetrics(EnumSet.of(ClusterMetrics.Option.LIVE_SERVERS))\n+        .getLiveServerMetrics().keySet());\n+\n+    List<ServerName> serversToDecommission = new ArrayList<ServerName>();\n+    serversToDecommission.add(clusterRegionServers.get(0));\n+\n+    // Decommission\n+    ADMIN.decommissionRegionServers(serversToDecommission, true);\n+    assertEquals(1, ADMIN.listDecommissionedRegionServers().size());\n+\n+    // Stop decommissioned region server and verify it is removed from draining znode\n+    ServerName serverName = serversToDecommission.get(0);\n+    ADMIN.stopRegionServer(serverName.getHostname()+\":\"+serverName.getPort());\n+    sleep(1000);\n+    assertTrue(ADMIN.listDecommissionedRegionServers().isEmpty());", "originalCommit": "e523a13c48701c862ed04a0ede28f256a49c4dc6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTEyOTg4Mg==", "url": "https://github.com/apache/hbase/pull/1841#discussion_r435129882", "bodyText": "done", "author": "gkanade", "createdAt": "2020-06-04T09:48:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTAzMjQyNA=="}], "type": "inlineReview", "revised_code": {"commit": "46531e9f9b4dd0840408eb1cbbc828ee1cb7c6c3", "chunk": "diff --git a/hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestDecommissionStopAdminApi.java b/hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestAdmin4.java\nsimilarity index 74%\nrename from hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestDecommissionStopAdminApi.java\nrename to hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestAdmin4.java\nindex 5d508a6b78..da3b381956 100644\n--- a/hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestDecommissionStopAdminApi.java\n+++ b/hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestAdmin4.java\n\n@@ -17,21 +17,19 @@\n  */\n package org.apache.hadoop.hbase.client;\n \n-import static org.apache.hadoop.hbase.util.Threads.sleep;\n-import static org.junit.Assert.assertEquals;\n-import static org.junit.Assert.assertTrue;\n+import static org.junit.Assert.*;\n \n import java.util.ArrayList;\n import java.util.EnumSet;\n import java.util.List;\n import org.apache.hadoop.hbase.ClusterMetrics;\n import org.apache.hadoop.hbase.HBaseClassTestRule;\n-import org.apache.hadoop.hbase.HBaseTestingUtility;\n import org.apache.hadoop.hbase.ServerName;\n-import org.apache.hadoop.hbase.TableName;\n import org.apache.hadoop.hbase.testclassification.ClientTests;\n import org.apache.hadoop.hbase.testclassification.MediumTests;\n-import org.junit.Before;\n+import org.apache.hadoop.hbase.zookeeper.ZKUtil;\n+import org.apache.hadoop.hbase.zookeeper.ZKWatcher;\n+import org.apache.hadoop.hbase.zookeeper.ZNodePaths;\n import org.junit.ClassRule;\n import org.junit.Test;\n import org.junit.experimental.categories.Category;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTAzNTM1Ng==", "url": "https://github.com/apache/hbase/pull/1841#discussion_r435035356", "bodyText": "Btw, we can put testDecommissionAndStopRegionServers() in TestAdmin2 or TestAdmin3. They are already LargeTests and have good no of Admin tests. However, keeping this test in separate file is also good. Maybe we can rename this class to TestAdmin4? This way, new Admin tests can be written in this class going forward.", "author": "virajjasani", "createdAt": "2020-06-04T07:04:42Z", "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestDecommissionStopAdminApi.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.hbase.client;\n+\n+import static org.apache.hadoop.hbase.util.Threads.sleep;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertTrue;\n+\n+import java.util.ArrayList;\n+import java.util.EnumSet;\n+import java.util.List;\n+import org.apache.hadoop.hbase.ClusterMetrics;\n+import org.apache.hadoop.hbase.HBaseClassTestRule;\n+import org.apache.hadoop.hbase.HBaseTestingUtility;\n+import org.apache.hadoop.hbase.ServerName;\n+import org.apache.hadoop.hbase.TableName;\n+import org.apache.hadoop.hbase.testclassification.ClientTests;\n+import org.apache.hadoop.hbase.testclassification.MediumTests;\n+import org.junit.Before;\n+import org.junit.ClassRule;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+@Category({ MediumTests.class, ClientTests.class })\n+public class TestDecommissionStopAdminApi extends TestAdminBase{", "originalCommit": "e523a13c48701c862ed04a0ede28f256a49c4dc6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTEyOTc5NQ==", "url": "https://github.com/apache/hbase/pull/1841#discussion_r435129795", "bodyText": "done", "author": "gkanade", "createdAt": "2020-06-04T09:48:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTAzNTM1Ng=="}], "type": "inlineReview", "revised_code": {"commit": "46531e9f9b4dd0840408eb1cbbc828ee1cb7c6c3", "chunk": "diff --git a/hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestDecommissionStopAdminApi.java b/hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestAdmin4.java\nsimilarity index 74%\nrename from hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestDecommissionStopAdminApi.java\nrename to hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestAdmin4.java\nindex 5d508a6b78..da3b381956 100644\n--- a/hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestDecommissionStopAdminApi.java\n+++ b/hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestAdmin4.java\n\n@@ -17,21 +17,19 @@\n  */\n package org.apache.hadoop.hbase.client;\n \n-import static org.apache.hadoop.hbase.util.Threads.sleep;\n-import static org.junit.Assert.assertEquals;\n-import static org.junit.Assert.assertTrue;\n+import static org.junit.Assert.*;\n \n import java.util.ArrayList;\n import java.util.EnumSet;\n import java.util.List;\n import org.apache.hadoop.hbase.ClusterMetrics;\n import org.apache.hadoop.hbase.HBaseClassTestRule;\n-import org.apache.hadoop.hbase.HBaseTestingUtility;\n import org.apache.hadoop.hbase.ServerName;\n-import org.apache.hadoop.hbase.TableName;\n import org.apache.hadoop.hbase.testclassification.ClientTests;\n import org.apache.hadoop.hbase.testclassification.MediumTests;\n-import org.junit.Before;\n+import org.apache.hadoop.hbase.zookeeper.ZKUtil;\n+import org.apache.hadoop.hbase.zookeeper.ZKWatcher;\n+import org.apache.hadoop.hbase.zookeeper.ZNodePaths;\n import org.junit.ClassRule;\n import org.junit.Test;\n import org.junit.experimental.categories.Category;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTAzNjQzMw==", "url": "https://github.com/apache/hbase/pull/1841#discussion_r435036433", "bodyText": "Before, TableName and HBaseTestingUtility are unused imports.", "author": "virajjasani", "createdAt": "2020-06-04T07:07:07Z", "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestDecommissionStopAdminApi.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.hbase.client;\n+\n+import static org.apache.hadoop.hbase.util.Threads.sleep;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertTrue;\n+\n+import java.util.ArrayList;\n+import java.util.EnumSet;\n+import java.util.List;\n+import org.apache.hadoop.hbase.ClusterMetrics;\n+import org.apache.hadoop.hbase.HBaseClassTestRule;\n+import org.apache.hadoop.hbase.HBaseTestingUtility;\n+import org.apache.hadoop.hbase.ServerName;\n+import org.apache.hadoop.hbase.TableName;\n+import org.apache.hadoop.hbase.testclassification.ClientTests;\n+import org.apache.hadoop.hbase.testclassification.MediumTests;\n+import org.junit.Before;", "originalCommit": "e523a13c48701c862ed04a0ede28f256a49c4dc6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTEyOTYzOA==", "url": "https://github.com/apache/hbase/pull/1841#discussion_r435129638", "bodyText": "removed", "author": "gkanade", "createdAt": "2020-06-04T09:48:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTAzNjQzMw=="}], "type": "inlineReview", "revised_code": {"commit": "46531e9f9b4dd0840408eb1cbbc828ee1cb7c6c3", "chunk": "diff --git a/hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestDecommissionStopAdminApi.java b/hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestAdmin4.java\nsimilarity index 74%\nrename from hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestDecommissionStopAdminApi.java\nrename to hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestAdmin4.java\nindex 5d508a6b78..da3b381956 100644\n--- a/hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestDecommissionStopAdminApi.java\n+++ b/hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestAdmin4.java\n\n@@ -17,21 +17,19 @@\n  */\n package org.apache.hadoop.hbase.client;\n \n-import static org.apache.hadoop.hbase.util.Threads.sleep;\n-import static org.junit.Assert.assertEquals;\n-import static org.junit.Assert.assertTrue;\n+import static org.junit.Assert.*;\n \n import java.util.ArrayList;\n import java.util.EnumSet;\n import java.util.List;\n import org.apache.hadoop.hbase.ClusterMetrics;\n import org.apache.hadoop.hbase.HBaseClassTestRule;\n-import org.apache.hadoop.hbase.HBaseTestingUtility;\n import org.apache.hadoop.hbase.ServerName;\n-import org.apache.hadoop.hbase.TableName;\n import org.apache.hadoop.hbase.testclassification.ClientTests;\n import org.apache.hadoop.hbase.testclassification.MediumTests;\n-import org.junit.Before;\n+import org.apache.hadoop.hbase.zookeeper.ZKUtil;\n+import org.apache.hadoop.hbase.zookeeper.ZKWatcher;\n+import org.apache.hadoop.hbase.zookeeper.ZNodePaths;\n import org.junit.ClassRule;\n import org.junit.Test;\n import org.junit.experimental.categories.Category;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ0NTk3NA==", "url": "https://github.com/apache/hbase/pull/1841#discussion_r435445974", "bodyText": "The build is failing:\n[ERROR] /home/jenkins/jenkins-slave/workspace/Base-PreCommit-GitHub-PR_PR-1841@2/yetus-jdk11-hadoop3-check/src/hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestAdmin4.java:[63,16] no suitable method found for waitFor(int,boolean)\n\nOh, seems like lambda expression is missing:\n    assertNotEquals(\"RS not removed from decommissioned list\", -1,\n      TEST_UTIL.waitFor(1000, () -> ADMIN.listDecommissionedRegionServers().isEmpty()));", "author": "virajjasani", "createdAt": "2020-06-04T18:00:11Z", "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestAdmin4.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.hbase.client;\n+\n+import static org.junit.Assert.*;\n+\n+import java.util.ArrayList;\n+import java.util.EnumSet;\n+import java.util.List;\n+import org.apache.hadoop.hbase.ClusterMetrics;\n+import org.apache.hadoop.hbase.HBaseClassTestRule;\n+import org.apache.hadoop.hbase.ServerName;\n+import org.apache.hadoop.hbase.testclassification.ClientTests;\n+import org.apache.hadoop.hbase.testclassification.MediumTests;\n+import org.junit.ClassRule;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+@Category({ MediumTests.class, ClientTests.class })\n+public class TestAdmin4 extends TestAdminBase{\n+  @ClassRule\n+  public static final HBaseClassTestRule CLASS_RULE =\n+    HBaseClassTestRule.forClass(TestAdmin4.class);\n+\n+  // For HBASE-24208\n+  @Test\n+  public void testDecommissionAndStopRegionServers() throws Exception {\n+    List<ServerName> decommissionedRegionServers = ADMIN.listDecommissionedRegionServers();\n+    assertTrue(decommissionedRegionServers.isEmpty());\n+\n+    ArrayList<ServerName> clusterRegionServers =\n+      new ArrayList<>(ADMIN.getClusterMetrics(EnumSet.of(ClusterMetrics.Option.LIVE_SERVERS))\n+        .getLiveServerMetrics().keySet());\n+\n+    List<ServerName> serversToDecommission = new ArrayList<ServerName>();\n+    serversToDecommission.add(clusterRegionServers.get(0));\n+\n+    // Decommission\n+    ADMIN.decommissionRegionServers(serversToDecommission, true);\n+    assertEquals(1, ADMIN.listDecommissionedRegionServers().size());\n+\n+    // Stop decommissioned region server and verify it is removed from draining znode\n+    ServerName serverName = serversToDecommission.get(0);\n+    ADMIN.stopRegionServer(serverName.getHostname()+\":\"+serverName.getPort());\n+    assertNotEquals(\"RS not removed from decommissioned list\", -1,\n+      TEST_UTIL.waitFor(1000, ADMIN.listDecommissionedRegionServers().isEmpty()));", "originalCommit": "6b18c796d67244b2747d8c6998b639fa02d85a6b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTY5Nzc0NQ==", "url": "https://github.com/apache/hbase/pull/1841#discussion_r435697745", "bodyText": "sorry about that, this should address it. will wait for another build", "author": "gkanade", "createdAt": "2020-06-05T05:29:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ0NTk3NA=="}], "type": "inlineReview", "revised_code": {"commit": "46531e9f9b4dd0840408eb1cbbc828ee1cb7c6c3", "chunk": "diff --git a/hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestAdmin4.java b/hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestAdmin4.java\nindex 252d203d40..da3b381956 100644\n--- a/hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestAdmin4.java\n+++ b/hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestAdmin4.java\n\n@@ -27,6 +27,9 @@ import org.apache.hadoop.hbase.HBaseClassTestRule;\n import org.apache.hadoop.hbase.ServerName;\n import org.apache.hadoop.hbase.testclassification.ClientTests;\n import org.apache.hadoop.hbase.testclassification.MediumTests;\n+import org.apache.hadoop.hbase.zookeeper.ZKUtil;\n+import org.apache.hadoop.hbase.zookeeper.ZKWatcher;\n+import org.apache.hadoop.hbase.zookeeper.ZNodePaths;\n import org.junit.ClassRule;\n import org.junit.Test;\n import org.junit.experimental.categories.Category;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk2MTU0Ng==", "url": "https://github.com/apache/hbase/pull/1841#discussion_r435961546", "bodyText": "Can u change the log to say \"Error deleting the draining znode for stopping server \"+ serverName", "author": "anoopsjohn", "createdAt": "2020-06-05T14:31:21Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/ServerManager.java", "diffHunk": "@@ -586,6 +587,15 @@ synchronized long expireServer(final ServerName serverName, boolean force) {\n     }\n     moveFromOnlineToDeadServers(serverName);\n \n+    // If server is in draining mode, remove corresponding znode\n+    String drainingZnode = ZNodePaths.joinZNode(master.getZooKeeper().getZNodePaths().drainingZNode,\n+      serverName.getServerName());\n+    try {\n+      ZKUtil.deleteNodeFailSilent(master.getZooKeeper(), drainingZnode);\n+    } catch (KeeperException e) {\n+      LOG.warn(\"Error deleting the znode for draining server \" +  serverName.getServerName(), e);", "originalCommit": "03b18066e88c329accb7477470bac131d0276701", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "46531e9f9b4dd0840408eb1cbbc828ee1cb7c6c3", "chunk": "diff --git a/hbase-server/src/main/java/org/apache/hadoop/hbase/master/ServerManager.java b/hbase-server/src/main/java/org/apache/hadoop/hbase/master/ServerManager.java\nindex bde211aa64..f4d5616571 100644\n--- a/hbase-server/src/main/java/org/apache/hadoop/hbase/master/ServerManager.java\n+++ b/hbase-server/src/main/java/org/apache/hadoop/hbase/master/ServerManager.java\n\n@@ -593,7 +593,7 @@ public class ServerManager {\n     try {\n       ZKUtil.deleteNodeFailSilent(master.getZooKeeper(), drainingZnode);\n     } catch (KeeperException e) {\n-      LOG.warn(\"Error deleting the znode for draining server \" +  serverName.getServerName(), e);\n+      LOG.warn(\"Error deleting the draining znode for stopping server \" +  serverName.getServerName(), e);\n     }\n     \n     // If cluster is going down, yes, servers are going to be expiring; don't\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk2NTI5MA==", "url": "https://github.com/apache/hbase/pull/1841#discussion_r435965290", "bodyText": "Cant we use Admin#getRegionServers(boolean excludeDecommissionedRS) API directly here?", "author": "anoopsjohn", "createdAt": "2020-06-05T14:37:23Z", "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestAdmin4.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.hbase.client;\n+\n+import static org.junit.Assert.*;\n+\n+import java.util.ArrayList;\n+import java.util.EnumSet;\n+import java.util.List;\n+import org.apache.hadoop.hbase.ClusterMetrics;\n+import org.apache.hadoop.hbase.HBaseClassTestRule;\n+import org.apache.hadoop.hbase.ServerName;\n+import org.apache.hadoop.hbase.testclassification.ClientTests;\n+import org.apache.hadoop.hbase.testclassification.MediumTests;\n+import org.junit.ClassRule;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+@Category({ MediumTests.class, ClientTests.class })\n+public class TestAdmin4 extends TestAdminBase{\n+  @ClassRule\n+  public static final HBaseClassTestRule CLASS_RULE =\n+    HBaseClassTestRule.forClass(TestAdmin4.class);\n+\n+  // For HBASE-24208\n+  @Test\n+  public void testDecommissionAndStopRegionServers() throws Exception {\n+    List<ServerName> decommissionedRegionServers = ADMIN.listDecommissionedRegionServers();\n+    assertTrue(decommissionedRegionServers.isEmpty());\n+\n+    ArrayList<ServerName> clusterRegionServers =", "originalCommit": "03b18066e88c329accb7477470bac131d0276701", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "46531e9f9b4dd0840408eb1cbbc828ee1cb7c6c3", "chunk": "diff --git a/hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestAdmin4.java b/hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestAdmin4.java\nindex fe6fa587b5..da3b381956 100644\n--- a/hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestAdmin4.java\n+++ b/hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestAdmin4.java\n\n@@ -27,6 +27,9 @@ import org.apache.hadoop.hbase.HBaseClassTestRule;\n import org.apache.hadoop.hbase.ServerName;\n import org.apache.hadoop.hbase.testclassification.ClientTests;\n import org.apache.hadoop.hbase.testclassification.MediumTests;\n+import org.apache.hadoop.hbase.zookeeper.ZKUtil;\n+import org.apache.hadoop.hbase.zookeeper.ZKWatcher;\n+import org.apache.hadoop.hbase.zookeeper.ZNodePaths;\n import org.junit.ClassRule;\n import org.junit.Test;\n import org.junit.experimental.categories.Category;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk2NzA5OA==", "url": "https://github.com/apache/hbase/pull/1841#discussion_r435967098", "bodyText": "This asserts only the decommissionedRSs list maintained in the HM side.  Pls add assert with checking the zk path also. We need to make sure the stop call actually deleted that zk path also.", "author": "anoopsjohn", "createdAt": "2020-06-05T14:40:10Z", "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestAdmin4.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.hbase.client;\n+\n+import static org.junit.Assert.*;\n+\n+import java.util.ArrayList;\n+import java.util.EnumSet;\n+import java.util.List;\n+import org.apache.hadoop.hbase.ClusterMetrics;\n+import org.apache.hadoop.hbase.HBaseClassTestRule;\n+import org.apache.hadoop.hbase.ServerName;\n+import org.apache.hadoop.hbase.testclassification.ClientTests;\n+import org.apache.hadoop.hbase.testclassification.MediumTests;\n+import org.junit.ClassRule;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+@Category({ MediumTests.class, ClientTests.class })\n+public class TestAdmin4 extends TestAdminBase{\n+  @ClassRule\n+  public static final HBaseClassTestRule CLASS_RULE =\n+    HBaseClassTestRule.forClass(TestAdmin4.class);\n+\n+  // For HBASE-24208\n+  @Test\n+  public void testDecommissionAndStopRegionServers() throws Exception {\n+    List<ServerName> decommissionedRegionServers = ADMIN.listDecommissionedRegionServers();\n+    assertTrue(decommissionedRegionServers.isEmpty());\n+\n+    ArrayList<ServerName> clusterRegionServers =\n+      new ArrayList<>(ADMIN.getClusterMetrics(EnumSet.of(ClusterMetrics.Option.LIVE_SERVERS))\n+        .getLiveServerMetrics().keySet());\n+\n+    List<ServerName> serversToDecommission = new ArrayList<ServerName>();\n+    serversToDecommission.add(clusterRegionServers.get(0));\n+\n+    // Decommission\n+    ADMIN.decommissionRegionServers(serversToDecommission, true);\n+    assertEquals(1, ADMIN.listDecommissionedRegionServers().size());\n+\n+    // Stop decommissioned region server and verify it is removed from draining znode\n+    ServerName serverName = serversToDecommission.get(0);\n+    ADMIN.stopRegionServer(serverName.getHostname()+\":\"+serverName.getPort());\n+    assertNotEquals(\"RS not removed from decommissioned list\", -1,\n+      TEST_UTIL.waitFor(1000, () -> ADMIN.listDecommissionedRegionServers().isEmpty()));", "originalCommit": "03b18066e88c329accb7477470bac131d0276701", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI3Mzc2OQ==", "url": "https://github.com/apache/hbase/pull/1841#discussion_r436273769", "bodyText": "done", "author": "gkanade", "createdAt": "2020-06-06T14:38:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk2NzA5OA=="}], "type": "inlineReview", "revised_code": {"commit": "46531e9f9b4dd0840408eb1cbbc828ee1cb7c6c3", "chunk": "diff --git a/hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestAdmin4.java b/hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestAdmin4.java\nindex fe6fa587b5..da3b381956 100644\n--- a/hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestAdmin4.java\n+++ b/hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestAdmin4.java\n\n@@ -27,6 +27,9 @@ import org.apache.hadoop.hbase.HBaseClassTestRule;\n import org.apache.hadoop.hbase.ServerName;\n import org.apache.hadoop.hbase.testclassification.ClientTests;\n import org.apache.hadoop.hbase.testclassification.MediumTests;\n+import org.apache.hadoop.hbase.zookeeper.ZKUtil;\n+import org.apache.hadoop.hbase.zookeeper.ZKWatcher;\n+import org.apache.hadoop.hbase.zookeeper.ZNodePaths;\n import org.junit.ClassRule;\n import org.junit.Test;\n import org.junit.experimental.categories.Category;\n"}}, {"oid": "46531e9f9b4dd0840408eb1cbbc828ee1cb7c6c3", "url": "https://github.com/apache/hbase/commit/46531e9f9b4dd0840408eb1cbbc828ee1cb7c6c3", "message": "Addressed PR comments", "committedDate": "2020-06-06T14:37:00Z", "type": "forcePushed"}, {"oid": "09f2d9b961b886be198091d5e3a72b44b009c197", "url": "https://github.com/apache/hbase/commit/09f2d9b961b886be198091d5e3a72b44b009c197", "message": "remove draining server znode if present", "committedDate": "2020-06-08T06:34:45Z", "type": "forcePushed"}, {"oid": "6176450df448adcd6901ded10294bc4fed12064b", "url": "https://github.com/apache/hbase/commit/6176450df448adcd6901ded10294bc4fed12064b", "message": "remove draining server znode if present", "committedDate": "2020-06-08T08:35:22Z", "type": "commit"}, {"oid": "6176450df448adcd6901ded10294bc4fed12064b", "url": "https://github.com/apache/hbase/commit/6176450df448adcd6901ded10294bc4fed12064b", "message": "remove draining server znode if present", "committedDate": "2020-06-08T08:35:22Z", "type": "forcePushed"}]}