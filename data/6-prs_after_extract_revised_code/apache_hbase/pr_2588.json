{"pr_number": 2588, "pr_title": "HBASE-25220 Backport HBASE-24246 Miscellaneous hbck2 fixMeta bulk merge fixes: better logging around merges/overlap-fixing, 'HBCK Report' overlap listing, and configuration", "pr_createdAt": "2020-10-26T14:19:43Z", "pr_url": "https://github.com/apache/hbase/pull/2588", "timeline": [{"oid": "cecca2cf9701354c1f4e00198a31341f50a726ac", "url": "https://github.com/apache/hbase/commit/cecca2cf9701354c1f4e00198a31341f50a726ac", "message": "HBASE-25220 Backport HBASE-24246 Miscellaneous hbck2 fixMeta bulk merge fixes: better logging around merges/overlap-fixing, 'HBCK Report' overlap listing, and configuration\n\nIncludes addendum\n\nhbase-server/src/main/java/org/apache/hadoop/hbase/master/HMaster.java\n Fix weird brackets around each region name when logging.\n\nhbase-server/src/main/java/org/apache/hadoop/hbase/master/MetaFixer.java\n  Log when we hit the max merge limit. Also up limit to 64.\n\nhbase-server/src/main/java/org/apache/hadoop/hbase/master/assignment/MergeTableRegionsProcedure.java\n Make logs make more sense to operator.\n\nhbase-server/src/main/resources/hbase-webapps/master/hbck.jsp\n Make RegionName show when you mouseover so long names don't mess up\n display of holes and overlaps.\n\nAddress Mingliang Liu liuml07 feedback\n\nSigned-off-by: Peter Somogyi <psomogyi@apache.org>\nSigned-off-by: Mingliang Liu <liuml07@apache.org>\n\n Addendum to address minor feedback on text", "committedDate": "2020-10-26T14:17:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjE5NjAwNA==", "url": "https://github.com/apache/hbase/pull/2588#discussion_r512196004", "bodyText": "Good", "author": "saintstack", "createdAt": "2020-10-26T18:55:19Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/MetaFixer.java", "diffHunk": "@@ -247,6 +247,10 @@ void fixOverlaps(CatalogJanitor.Report report) throws IOException {\n       if (regionInfoWithlargestEndKey != null) {\n         if (!isOverlap(regionInfoWithlargestEndKey, pair) ||\n             currentMergeSet.size() >= maxMergeCount) {\n+          // Log when we cut-off-merge because we hit the configured maximum merge limit.\n+          if (currentMergeSet.size() >= maxMergeCount) {\n+            LOG.warn(\"Ran into maximum-at-a-time merges limit={}\", maxMergeCount);", "originalCommit": "cecca2cf9701354c1f4e00198a31341f50a726ac", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjE5NjUzMQ==", "url": "https://github.com/apache/hbase/pull/2588#discussion_r512196531", "bodyText": "nit: we need the ' characters? we don't usually do this?", "author": "saintstack", "createdAt": "2020-10-26T18:56:12Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/assignment/MergeTableRegionsProcedure.java", "diffHunk": "@@ -135,8 +134,8 @@ private static void checkRegionsToMerge(MasterProcedureEnv env, final RegionInfo\n           throw new MergeRegionException(msg);\n         }\n         if (!force && !ri.isAdjacent(previous) && !ri.isOverlap(previous)) {\n-          String msg = \"Unable to merge non-adjacent or non-overlapping regions \" +\n-              previous.getShortNameToLog() + \", \" + ri.getShortNameToLog() + \" when force=false\";\n+          String msg = \"Unable to merge non-adjacent or non-overlapping regions '\" +\n+              previous.getShortNameToLog() + \"', '\" + ri.getShortNameToLog() + \"' when force=false\";", "originalCommit": "cecca2cf9701354c1f4e00198a31341f50a726ac", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjIxNjAxOQ==", "url": "https://github.com/apache/hbase/pull/2588#discussion_r512216019", "bodyText": "This is a clean cherry-pick of your commit to master, the ' character was part of the original commit. \ud83d\ude42  It was not pushed to branch-2.2 at that time I found this as a nice improvement.", "author": "petersomogyi", "createdAt": "2020-10-26T19:30:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjE5NjUzMQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjE5Njc1Ng==", "url": "https://github.com/apache/hbase/pull/2588#discussion_r512196756", "bodyText": "Good", "author": "saintstack", "createdAt": "2020-10-26T18:56:35Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/assignment/MergeTableRegionsProcedure.java", "diffHunk": "@@ -479,16 +478,20 @@ private boolean prepareMergeRegion(final MasterProcedureEnv env) throws IOExcept\n     for (RegionInfo ri: this.regionsToMerge) {\n       if (!catalogJanitor.cleanMergeQualifier(ri)) {\n         String msg = \"Skip merging \" + RegionInfo.getShortNameToLog(regionsToMerge) +\n-            \", because parent \" + RegionInfo.getShortNameToLog(ri) + \" has a merge qualifier\";\n+            \", because a parent, \" + RegionInfo.getShortNameToLog(ri) + \", has a merge qualifier \" +\n+          \"(if a 'merge column' in parent, it was recently merged but still has outstanding \" +\n+          \"references to its parents that must be cleared before it can participate in merge -- \" +\n+          \"major compact it to hurry clearing of its references)\";", "originalCommit": "cecca2cf9701354c1f4e00198a31341f50a726ac", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}