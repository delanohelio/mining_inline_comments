{"pr_number": 2419, "pr_title": "HBASE-25050 - We initialize Filesystems more than once.", "pr_createdAt": "2020-09-18T14:23:16Z", "pr_url": "https://github.com/apache/hbase/pull/2419", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDk5NTM5NA==", "url": "https://github.com/apache/hbase/pull/2419#discussion_r490995394", "bodyText": "where else do we do the initialize?", "author": "busbey", "createdAt": "2020-09-18T14:38:46Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/fs/HFileSystem.java", "diffHunk": "@@ -85,8 +85,6 @@ public HFileSystem(Configuration conf, boolean useHBaseChecksum)\n     this.fs = FileSystem.get(conf);\n     this.useHBaseChecksum = useHBaseChecksum;\n \n-    fs.initialize(getDefaultUri(conf), conf);\n-", "originalCommit": "29cac230b871f03edb819074ff97c33f1df9182e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDk5NjI4Nw==", "url": "https://github.com/apache/hbase/pull/2419#discussion_r490996287", "bodyText": "I'm presuming we need to do it once. I get that Filesystem.get should be caching and giving us back the same FileSystem in multiple HFileSystem constructions.\nSide note, why are we making multiple instances of HFileSystem?", "author": "busbey", "createdAt": "2020-09-18T14:40:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDk5NTM5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDk5ODY3MQ==", "url": "https://github.com/apache/hbase/pull/2419#discussion_r490998671", "bodyText": "@busbey\nThanks for having a look. Yes the FileSystem.get is giving us the same instance of the Filesystem and always does an intialize also. .So we doing another initialize() is actually creating all member variables more than once. We have seen in our FS impl we have some thread pools - all those are getting created more than once.", "author": "ramkrish86", "createdAt": "2020-09-18T14:43:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDk5NTM5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTAwMDU2Mw==", "url": "https://github.com/apache/hbase/pull/2419#discussion_r491000563", "bodyText": "`  private static FileSystem createFileSystem(URI uri, Configuration conf\n) throws IOException {\nClass<?> clazz = getFileSystemClass(uri.getScheme(), conf);\n\nif (clazz == null) {\n\n  throw new IOException(\"No FileSystem for scheme: \" + uri.getScheme());\n\n}\n\nFileSystem fs = (FileSystem)ReflectionUtils.newInstance(clazz, conf);\n\nfs.initialize(uri, conf);\n\nreturn fs;\n\n}`\nThis is what happens inside FileSystem.get()", "author": "ramkrish86", "createdAt": "2020-09-18T14:46:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDk5NTM5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTAxNDcwMg==", "url": "https://github.com/apache/hbase/pull/2419#discussion_r491014702", "bodyText": "looking at the source and javadocs for hadoop versions we use, I think we should remove this line as you have done and then also replace line 85 with\n this.fs = FileSystem.get(getDefaultUri(conf), conf);\n\nbecause the javadocs for that version of get make clear that initialize will have already been called on whatever is returned. the get method we're using now is ambiguous about it.", "author": "busbey", "createdAt": "2020-09-18T15:08:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDk5NTM5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTgxNTI2OA==", "url": "https://github.com/apache/hbase/pull/2419#discussion_r491815268", "bodyText": "Sure @busbey we can change it. but pls do remember that this get() call - what ever flavor of the FS#get() we do, we have already done a call to the FS#get even before we do the HFileSystem creation.\n`public static Path getWALRootDir(final Configuration c) throws IOException {\nPath p = new Path(c.get(HBASE_WAL_DIR, c.get(HConstants.HBASE_DIR)));\n\nif (!isValidWALRootDir(p, c)) {\n\n  return getRootDir(c);\n\n}\n\nFileSystem fs = p.getFileSystem(c);\n\nreturn p.makeQualified(fs.getUri(), fs.getWorkingDirectory());\n\n}\n`\nwhen we do p.getFileSystem() we have inited the file system.", "author": "ramkrish86", "createdAt": "2020-09-21T06:28:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDk5NTM5NA=="}], "type": "inlineReview", "revised_code": {"commit": "09101c70ca3f219aad3034f530f292d4b260db27", "chunk": "diff --git a/hbase-server/src/main/java/org/apache/hadoop/hbase/fs/HFileSystem.java b/hbase-server/src/main/java/org/apache/hadoop/hbase/fs/HFileSystem.java\nindex 234a5da93a..d74f91671a 100644\n--- a/hbase-server/src/main/java/org/apache/hadoop/hbase/fs/HFileSystem.java\n+++ b/hbase-server/src/main/java/org/apache/hadoop/hbase/fs/HFileSystem.java\n\n@@ -82,7 +82,7 @@ public class HFileSystem extends FilterFileSystem {\n     // Create the default filesystem with checksum verification switched on.\n     // By default, any operation to this FilterFileSystem occurs on\n     // the underlying filesystem that has checksums switched on.\n-    this.fs = FileSystem.get(conf);\n+    this.fs = FileSystem.get(getDefaultUri(conf), conf);\n     this.useHBaseChecksum = useHBaseChecksum;\n \n     // disable checksum verification for local fileSystem, see HBASE-11218\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk0NTg0Nw==", "url": "https://github.com/apache/hbase/pull/2419#discussion_r506945847", "bodyText": "Mind explaining a bit why we need this change? And also add it to the comment above? And I also see later we all change to use URI instead of Path. What is the reason?", "author": "Apache9", "createdAt": "2020-10-17T13:55:51Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/fs/HFileSystem.java", "diffHunk": "@@ -82,11 +82,9 @@ public HFileSystem(Configuration conf, boolean useHBaseChecksum)\n     // Create the default filesystem with checksum verification switched on.\n     // By default, any operation to this FilterFileSystem occurs on\n     // the underlying filesystem that has checksums switched on.\n-    this.fs = FileSystem.get(conf);\n+    this.fs = FileSystem.get(getDefaultUri(conf), conf);", "originalCommit": "08934cbaf0d8d731154aa9cea0064925b1572955", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzQ3MTU0NQ==", "url": "https://github.com/apache/hbase/pull/2419#discussion_r507471545", "bodyText": "The background of this PR is that - in a normal case where we have root.dir and wal.dir set on different FS, the WAL FS is getting initialized 2 times. Those places are\npublic static Path getWALRootDir(final Configuration c) throws IOException { Path p = new Path(c.get(HBASE_WAL_DIR, c.get(HConstants.HBASE_DIR))); if (!isValidWALRootDir(p, c)) { return getRootDir(c); } FileSystem fs = p.getFileSystem(c); return p.makeQualified(fs.getUri(), fs.getWorkingDirectory()); }\nSo before even we create the HFileSystem from HRS#initializeFileSystem we tend to get the WAL's path but there we do p.getFileSystem() to get the URI and the path. That is where the filesytem gets inited without even we intentionally doing it.\nNow before this patch -  We had\nFileSystem.get(conf);  &\nfs.initialize()\nSo the file system that was already created and inited was once again getting initialized(). So there were two instances of the FS.\nSo the first thing to be done is remove the fs.initialize() and only do FileSystem.get() but the other flavour of\nFileSystem.get(URI, conf) has a clear javadoc saying that if the FS is already created we will just return the Fs or we will initialize and then return the FS. Hence the API was changed.\nBut the other change to pass URI is to avoid the unintentional init of the FS from a Util method. What we need is a URI which we set it with fs.defaultFS. So for doing that we just extract the URI from the path and set it to the fs.defaultFS. So the subsequent code in FS.get(URI, conf) can really do the actual init that we are interested in.\n@Apache9  - Hope the above clarifies. Let me know if you need further details.", "author": "ramkrish86", "createdAt": "2020-10-19T05:21:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk0NTg0Nw=="}], "type": "inlineReview", "revised_code": {"commit": "1c2e1229d4ea3fad6d4546462bcfdd8d0adfd748", "chunk": "diff --git a/hbase-server/src/main/java/org/apache/hadoop/hbase/fs/HFileSystem.java b/hbase-server/src/main/java/org/apache/hadoop/hbase/fs/HFileSystem.java\nindex d74f91671a..234a5da93a 100644\n--- a/hbase-server/src/main/java/org/apache/hadoop/hbase/fs/HFileSystem.java\n+++ b/hbase-server/src/main/java/org/apache/hadoop/hbase/fs/HFileSystem.java\n\n@@ -82,7 +82,7 @@ public class HFileSystem extends FilterFileSystem {\n     // Create the default filesystem with checksum verification switched on.\n     // By default, any operation to this FilterFileSystem occurs on\n     // the underlying filesystem that has checksums switched on.\n-    this.fs = FileSystem.get(getDefaultUri(conf), conf);\n+    this.fs = FileSystem.get(conf);\n     this.useHBaseChecksum = useHBaseChecksum;\n \n     // disable checksum verification for local fileSystem, see HBASE-11218\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODcwOTg0Mw==", "url": "https://github.com/apache/hbase/pull/2419#discussion_r508709843", "bodyText": "To Duo's request, add in something like:\n// We take pains to funnel all of our FileSystem instantiation through this call to ensure\n// we never need to call FS.initialize ourself so that we do not have to track any state to\n// avoid calling initialize more than once.", "author": "busbey", "createdAt": "2020-10-20T17:27:28Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/fs/HFileSystem.java", "diffHunk": "@@ -82,7 +82,10 @@ public HFileSystem(Configuration conf, boolean useHBaseChecksum)\n     // Create the default filesystem with checksum verification switched on.\n     // By default, any operation to this FilterFileSystem occurs on\n     // the underlying filesystem that has checksums switched on.\n-    this.fs = FileSystem.get(conf);\n+    // This FS#get(URI, conf) clearly indicates in the javadoc that if the FS is\n+    // not created it will initialize the FS and return that created FS. If it is\n+    // already created it will just return the FS that was already created.", "originalCommit": "342517b54d323acb5106a5c92dfdbdd829e3ec93", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTI1NDA1Mg==", "url": "https://github.com/apache/hbase/pull/2419#discussion_r529254052", "bodyText": "Sure let me add them and commit it.", "author": "ramkrish86", "createdAt": "2020-11-24T07:27:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODcwOTg0Mw=="}], "type": "inlineReview", "revised_code": {"commit": "1c2e1229d4ea3fad6d4546462bcfdd8d0adfd748", "chunk": "diff --git a/hbase-server/src/main/java/org/apache/hadoop/hbase/fs/HFileSystem.java b/hbase-server/src/main/java/org/apache/hadoop/hbase/fs/HFileSystem.java\nindex 4d28602195..234a5da93a 100644\n--- a/hbase-server/src/main/java/org/apache/hadoop/hbase/fs/HFileSystem.java\n+++ b/hbase-server/src/main/java/org/apache/hadoop/hbase/fs/HFileSystem.java\n\n@@ -82,10 +82,7 @@ public class HFileSystem extends FilterFileSystem {\n     // Create the default filesystem with checksum verification switched on.\n     // By default, any operation to this FilterFileSystem occurs on\n     // the underlying filesystem that has checksums switched on.\n-    // This FS#get(URI, conf) clearly indicates in the javadoc that if the FS is\n-    // not created it will initialize the FS and return that created FS. If it is\n-    // already created it will just return the FS that was already created.\n-    this.fs = FileSystem.get(getDefaultUri(conf), conf);\n+    this.fs = FileSystem.get(conf);\n     this.useHBaseChecksum = useHBaseChecksum;\n \n     // disable checksum verification for local fileSystem, see HBASE-11218\n"}}, {"oid": "1c2e1229d4ea3fad6d4546462bcfdd8d0adfd748", "url": "https://github.com/apache/hbase/commit/1c2e1229d4ea3fad6d4546462bcfdd8d0adfd748", "message": "HBASE-25050 - We initialize Filesystems more than once.", "committedDate": "2020-11-24T09:46:54Z", "type": "commit"}, {"oid": "09101c70ca3f219aad3034f530f292d4b260db27", "url": "https://github.com/apache/hbase/commit/09101c70ca3f219aad3034f530f292d4b260db27", "message": "Ensuring that calling the FS#get() will only ensure FS init.", "committedDate": "2020-11-24T09:46:54Z", "type": "commit"}, {"oid": "04005ce99e76d7dfcc92343dc2cfd8e283ad1014", "url": "https://github.com/apache/hbase/commit/04005ce99e76d7dfcc92343dc2cfd8e283ad1014", "message": "Fix for testfailures. We should pass the entire path and no the scheme\nalone", "committedDate": "2020-11-24T09:46:54Z", "type": "commit"}, {"oid": "3fec3a499b958158d069265d357c854452ead2d8", "url": "https://github.com/apache/hbase/commit/3fec3a499b958158d069265d357c854452ead2d8", "message": "Cases where we don't have a scheme for the URI", "committedDate": "2020-11-24T09:46:54Z", "type": "commit"}, {"oid": "e07afe1a21660c31c495daea17ec142e8d57103e", "url": "https://github.com/apache/hbase/commit/e07afe1a21660c31c495daea17ec142e8d57103e", "message": "Address review comments", "committedDate": "2020-11-24T09:46:54Z", "type": "commit"}, {"oid": "ef08ccd262a5dbbf6d16b958da3ade3ce79c4e85", "url": "https://github.com/apache/hbase/commit/ef08ccd262a5dbbf6d16b958da3ade3ce79c4e85", "message": "Add some comments on why FS#get(URI, conf) is getting used", "committedDate": "2020-11-24T09:46:54Z", "type": "commit"}, {"oid": "6c7238e9349d7cc7ba0595d035c46ef7aec75e33", "url": "https://github.com/apache/hbase/commit/6c7238e9349d7cc7ba0595d035c46ef7aec75e33", "message": "Adding the comment as per Sean's review", "committedDate": "2020-11-24T09:51:45Z", "type": "commit"}, {"oid": "6c7238e9349d7cc7ba0595d035c46ef7aec75e33", "url": "https://github.com/apache/hbase/commit/6c7238e9349d7cc7ba0595d035c46ef7aec75e33", "message": "Adding the comment as per Sean's review", "committedDate": "2020-11-24T09:51:45Z", "type": "forcePushed"}]}