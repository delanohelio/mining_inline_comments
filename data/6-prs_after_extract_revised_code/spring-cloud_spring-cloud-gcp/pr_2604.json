{"pr_number": 2604, "pr_title": "Fix auditing when running through DatastoreTemplate.performTransaction", "pr_createdAt": "2020-11-30T16:29:58Z", "pr_url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2604", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc2OTk1Nw==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2604#discussion_r532769957", "bodyText": "I see mock setup all done in datastoreTemplate(). Would it make sense to move it there?", "author": "meltsufin", "createdAt": "2020-11-30T17:26:32Z", "path": "spring-cloud-gcp-data-datastore/src/test/java/org/springframework/cloud/gcp/data/datastore/core/DatastoreTemplateAuditingTests.java", "diffHunk": "@@ -82,6 +84,20 @@ public void testModifiedPrevProperties() {\n \t\tthis.datastoreTemplate.saveAll(Collections.singletonList(testEntity));\n \t}\n \n+\t@Test\n+\tpublic void testInTransaction() {\n+\t\twhen(datastore.runInTransaction(any()))", "originalCommit": "fb40156407d388982494b445a5195920569f5941", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc4ODExNA==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2604#discussion_r532788114", "bodyText": "Personally, I prefer keeping the specific setup where it's actually used, and Mockito could complain about unnecessary setup in the other tests, depending on its configuration. However, I've tested moving the code and it works, so Mockito is not in strict mode and the code can be arranged however you prefer.", "author": "fpavageau", "createdAt": "2020-11-30T17:53:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc2OTk1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjgzODA0Nw==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2604#discussion_r532838047", "bodyText": "I don't feel strongly either way. I'm also not sure it's good that the verification is outside the test method, but that's a problem for another time. :)", "author": "meltsufin", "createdAt": "2020-11-30T19:16:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc2OTk1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjkyNTkyMQ==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2604#discussion_r532925921", "bodyText": "OK, I think I'll leave it that way then, not specifying every possible behavior for all the tests.\nI agree the verification in an Answer is brittle, which is when I first ran the test, without the added behavior on the mock, it passed: the Datastore.put() method was never called! We could extract an assertion method which would use an ArgumentCaptor to verify the call and its parameter, instead. However it's not the only occurence in the project of assertions in Answers, so just fixing this one instance probably doesn't really make sense.", "author": "fpavageau", "createdAt": "2020-11-30T21:49:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc2OTk1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjkyNjY1OA==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2604#discussion_r532926658", "bodyText": "Yeah, no need to address that here.", "author": "meltsufin", "createdAt": "2020-11-30T21:51:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc2OTk1Nw=="}], "type": "inlineReview", "revised_code": null}, {"oid": "278d09cf68d2ad8d0224b1ae905352fb5f59800b", "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/278d09cf68d2ad8d0224b1ae905352fb5f59800b", "message": "Fix auditing when running through DatastoreTemplate.performTransaction\n\nThe new `DatastoreTemplate` instance should have the same\n`ApplicationEventPublisher` as the original one, so that `AuditingHandler`\ncan be called.", "committedDate": "2020-11-30T21:19:56Z", "type": "commit"}, {"oid": "278d09cf68d2ad8d0224b1ae905352fb5f59800b", "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/278d09cf68d2ad8d0224b1ae905352fb5f59800b", "message": "Fix auditing when running through DatastoreTemplate.performTransaction\n\nThe new `DatastoreTemplate` instance should have the same\n`ApplicationEventPublisher` as the original one, so that `AuditingHandler`\ncan be called.", "committedDate": "2020-11-30T21:19:56Z", "type": "forcePushed"}]}