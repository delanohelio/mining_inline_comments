{"pr_number": 2290, "pr_title": "Support Extra Propagation Fields with Trace", "pr_createdAt": "2020-03-27T15:30:47Z", "pr_url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2290", "timeline": [{"oid": "6f555df412e9a6895c990926e29f0fd184e44854", "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/6f555df412e9a6895c990926e29f0fd184e44854", "message": "Support Extra Propagation Fields with Trace\n\nProviding a Trace Propagation Factory Builder instead of just the Factory,\nwhile allows us to rely on the `TraceAutoConfiguration.sleuthPropagation()`\nrather than completely skipping it.\n\nFixes: #2268.", "committedDate": "2020-03-27T15:25:23Z", "type": "commit"}, {"oid": "11ae661d1be236db89c8170e8b7f3ab1f0582506", "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/11ae661d1be236db89c8170e8b7f3ab1f0582506", "message": "Update dependencies", "committedDate": "2020-05-12T20:21:31Z", "type": "commit"}, {"oid": "b8df1343d2b6c7911a3eb6111f49bcf922623e6d", "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/b8df1343d2b6c7911a3eb6111f49bcf922623e6d", "message": "Merge branch 'master' into trace-extra-fields", "committedDate": "2020-05-12T20:24:41Z", "type": "commit"}, {"oid": "43908d85e8edf01ca36dce415e0fbdf4c93b7b11", "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/43908d85e8edf01ca36dce415e0fbdf4c93b7b11", "message": "undo unrelated version updates", "committedDate": "2020-05-12T21:01:38Z", "type": "commit"}, {"oid": "81302d56765f4a85f8477ee5b8a561e3f8d20305", "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/81302d56765f4a85f8477ee5b8a561e3f8d20305", "message": "Remove sampler auto-config", "committedDate": "2020-05-18T22:11:58Z", "type": "commit"}, {"oid": "90e2f9f800d918f16326a3c2ee27e22ade116b94", "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/90e2f9f800d918f16326a3c2ee27e22ade116b94", "message": "temporarily add HexCodec", "committedDate": "2020-05-18T22:12:28Z", "type": "commit"}, {"oid": "1fd018d20a145ed6b42ed876836a8b1f1e3c78a9", "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/1fd018d20a145ed6b42ed876836a8b1f1e3c78a9", "message": "switch to BaggagePropagation", "committedDate": "2020-05-18T22:24:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjk3MDQwOA==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2290#discussion_r426970408", "bodyText": "right here will change with 0.17 we should use the correct brave.propagation package and add a comment that the underlying B3Propagation.Factory needs to be configured differently for sleuth 3.0\nThis can be a TODO I suppose as 3.0 isn't final anyway", "author": "codefromthecrypt", "createdAt": "2020-05-19T00:57:27Z", "path": "spring-cloud-gcp-autoconfigure/src/main/java/org/springframework/cloud/gcp/autoconfigure/trace/StackdriverTraceAutoConfiguration.java", "diffHunk": "@@ -221,8 +218,8 @@ public Sender stackdriverSender(GcpTraceProperties traceProperties,\n \n \t@Bean\n \t@ConditionalOnMissingBean\n-\tpublic Propagation.Factory stackdriverPropagation() {\n-\t\treturn StackdriverTracePropagation.FACTORY;\n+\tpublic BaggagePropagation.FactoryBuilder baggagePropagationFactoryBuilder() {\n+\t\treturn BaggagePropagation.newFactoryBuilder(StackdriverTracePropagation.FACTORY);", "originalCommit": "1fd018d20a145ed6b42ed876836a8b1f1e3c78a9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzMxMzQ3Mg==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2290#discussion_r427313472", "bodyText": "Do you mean that the B3Propagation.Factory would be configured differently in zipkin-gcp, because we're not configuring it here?", "author": "meltsufin", "createdAt": "2020-05-19T13:44:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjk3MDQwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY2NTE3NQ==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2290#discussion_r427665175", "bodyText": "I mean what we are overriding will be different configuration 2.2.x vs 3.0.x. Until we some annotation or otherwise to indicate the \"real trace format\" factory vs the wrapped one, this project will have to build differently for 2.2.x vs 3.0 or have some logic etc. @spencergibb mentioned maybe we can change 3.0 to use the @Primary annotation. Will think about it. Anyway, this is fine for 2.2.x", "author": "codefromthecrypt", "createdAt": "2020-05-19T23:55:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjk3MDQwOA=="}], "type": "inlineReview", "revised_code": {"commit": "5ad71b86d9467e4b172053cbe9c6a3a9dd392ea6", "chunk": "diff --git a/spring-cloud-gcp-autoconfigure/src/main/java/org/springframework/cloud/gcp/autoconfigure/trace/StackdriverTraceAutoConfiguration.java b/spring-cloud-gcp-autoconfigure/src/main/java/org/springframework/cloud/gcp/autoconfigure/trace/StackdriverTraceAutoConfiguration.java\nindex 8150b03c..49e1ddd6 100644\n--- a/spring-cloud-gcp-autoconfigure/src/main/java/org/springframework/cloud/gcp/autoconfigure/trace/StackdriverTraceAutoConfiguration.java\n+++ b/spring-cloud-gcp-autoconfigure/src/main/java/org/springframework/cloud/gcp/autoconfigure/trace/StackdriverTraceAutoConfiguration.java\n\n@@ -219,7 +220,8 @@ public class StackdriverTraceAutoConfiguration {\n \t@Bean\n \t@ConditionalOnMissingBean\n \tpublic BaggagePropagation.FactoryBuilder baggagePropagationFactoryBuilder() {\n-\t\treturn BaggagePropagation.newFactoryBuilder(StackdriverTracePropagation.FACTORY);\n+\t\treturn BaggagePropagation.newFactoryBuilder(StackdriverTracePropagation.newFactory(\n+\t\t\t\tB3Propagation.newFactoryBuilder().injectFormat(B3Propagation.Format.MULTI).build()));\n \t}\n \n \t@PreDestroy\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjk3MDcxMg==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2290#discussion_r426970712", "bodyText": "as this is src/test ... maybe just use Long.whatever? HexCodec is mostly for performance", "author": "codefromthecrypt", "createdAt": "2020-05-19T00:58:37Z", "path": "spring-cloud-gcp-samples/spring-cloud-gcp-trace-sample/src/test/java/brave/internal/HexCodec.java", "diffHunk": "@@ -0,0 +1,112 @@\n+/*\n+ * Copyright 2013-2020 The OpenZipkin Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package brave.internal;\n+\n+// code originally imported from zipkin.Util\n+public final class HexCodec {", "originalCommit": "1fd018d20a145ed6b42ed876836a8b1f1e3c78a9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzMxMjQ4Ng==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2290#discussion_r427312486", "bodyText": "I will remove this class altogether, since you've added it in 0.17.0.", "author": "meltsufin", "createdAt": "2020-05-19T13:43:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjk3MDcxMg=="}], "type": "inlineReview", "revised_code": {"commit": "5ad71b86d9467e4b172053cbe9c6a3a9dd392ea6", "chunk": "diff --git a/spring-cloud-gcp-samples/spring-cloud-gcp-trace-sample/src/test/java/brave/internal/HexCodec.java b/spring-cloud-gcp-samples/spring-cloud-gcp-trace-sample/src/test/java/brave/internal/HexCodec.java\ndeleted file mode 100644\nindex 5eb6d6a6..00000000\n--- a/spring-cloud-gcp-samples/spring-cloud-gcp-trace-sample/src/test/java/brave/internal/HexCodec.java\n+++ /dev/null\n\n@@ -1,112 +0,0 @@\n-/*\n- * Copyright 2013-2020 The OpenZipkin Authors\n- *\n- * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n- * in compliance with the License. You may obtain a copy of the License at\n- *\n- * http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing, software distributed under the License\n- * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n- * or implied. See the License for the specific language governing permissions and limitations under\n- * the License.\n- */\n-package brave.internal;\n-\n-// code originally imported from zipkin.Util\n-public final class HexCodec {\n-\n-\t/**\n-\t * Parses a 1 to 32 character lower-hex string with no prefix into an unsigned long, tossing any\n-\t * bits higher than 64.\n-\t */\n-\tpublic static long lowerHexToUnsignedLong(CharSequence lowerHex) {\n-\t\tint length = lowerHex.length();\n-\t\tif (length < 1 || length > 32) throw isntLowerHexLong(lowerHex);\n-\n-\t\t// trim off any high bits\n-\t\tint beginIndex = length > 16 ? length - 16 : 0;\n-\n-\t\treturn lowerHexToUnsignedLong(lowerHex, beginIndex);\n-\t}\n-\n-\t/**\n-\t * Parses a 16 character lower-hex string with no prefix into an unsigned long, starting at the\n-\t * specified index.\n-\t *\n-\t * <p>This reads a trace context a sequence potentially larger than the format. The use-case is\n-\t * reducing garbage, by re-using the input {@code value} across multiple parse operations.\n-\t *\n-\t * @param value the sequence that contains a lower-hex encoded unsigned long.\n-\t * @param beginIndex the inclusive begin index: {@linkplain CharSequence#charAt(int) index} of the\n-\t * first lower-hex character representing the unsigned long.\n-\t */\n-\tpublic static long lowerHexToUnsignedLong(CharSequence value, int beginIndex) {\n-\t\tint endIndex = Math.min(beginIndex + 16, value.length());\n-\t\tlong result = lenientLowerHexToUnsignedLong(value, beginIndex, endIndex);\n-\t\tif (result == 0) throw isntLowerHexLong(value);\n-\t\treturn result;\n-\t}\n-\n-\t/**\n-\t * Like {@link #lowerHexToUnsignedLong(CharSequence, int)}, but returns zero on invalid input.\n-\t *\n-\t * @param value the sequence that contains a lower-hex encoded unsigned long.\n-\t * @param beginIndex the inclusive begin index: {@linkplain CharSequence#charAt(int) index} of the\n-\t * first lower-hex character representing the unsigned long.\n-\t * @param endIndex the exclusive end index: {@linkplain CharSequence#charAt(int) index}\n-\t * <em>after</em> the last lower-hex character representing the unsigned long.\n-\t */\n-\tpublic static long lenientLowerHexToUnsignedLong(CharSequence value, int beginIndex,\n-\t\t\tint endIndex) {\n-\t\tlong result = 0;\n-\t\tint pos = beginIndex;\n-\t\twhile (pos < endIndex) {\n-\t\t\tchar c = value.charAt(pos++);\n-\t\t\tresult <<= 4;\n-\t\t\tif (c >= '0' && c <= '9') {\n-\t\t\t\tresult |= c - '0';\n-\t\t\t} else if (c >= 'a' && c <= 'f') {\n-\t\t\t\tresult |= c - 'a' + 10;\n-\t\t\t} else {\n-\t\t\t\treturn 0;\n-\t\t\t}\n-\t\t}\n-\t\treturn result;\n-\t}\n-\n-\tstatic NumberFormatException isntLowerHexLong(CharSequence lowerHex) {\n-\t\tthrow new NumberFormatException(\n-\t\t\t\tlowerHex + \" should be a 1 to 32 character lower-hex string with no prefix\");\n-\t}\n-\n-\t/** Inspired by {@code okio.Buffer.writeLong} */\n-\tpublic static String toLowerHex(long v) {\n-\t\tchar[] data = RecyclableBuffers.parseBuffer();\n-\t\twriteHexLong(data, 0, v);\n-\t\treturn new String(data, 0, 16);\n-\t}\n-\n-\t/** Inspired by {@code okio.Buffer.writeLong} */\n-\tpublic static void writeHexLong(char[] data, int pos, long v) {\n-\t\twriteHexByte(data, pos + 0, (byte) ((v >>> 56L) & 0xff));\n-\t\twriteHexByte(data, pos + 2, (byte) ((v >>> 48L) & 0xff));\n-\t\twriteHexByte(data, pos + 4, (byte) ((v >>> 40L) & 0xff));\n-\t\twriteHexByte(data, pos + 6, (byte) ((v >>> 32L) & 0xff));\n-\t\twriteHexByte(data, pos + 8, (byte) ((v >>> 24L) & 0xff));\n-\t\twriteHexByte(data, pos + 10, (byte) ((v >>> 16L) & 0xff));\n-\t\twriteHexByte(data, pos + 12, (byte) ((v >>> 8L) & 0xff));\n-\t\twriteHexByte(data, pos + 14, (byte) (v & 0xff));\n-\t}\n-\n-\tstatic final char[] HEX_DIGITS =\n-\t\t\t{'0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'a', 'b', 'c', 'd', 'e', 'f'};\n-\n-\tstatic void writeHexByte(char[] data, int pos, byte b) {\n-\t\tdata[pos + 0] = HEX_DIGITS[(b >> 4) & 0xf];\n-\t\tdata[pos + 1] = HEX_DIGITS[b & 0xf];\n-\t}\n-\n-\tHexCodec() {\n-\t}\n-}\n\\ No newline at end of file\n"}}, {"oid": "5ad71b86d9467e4b172053cbe9c6a3a9dd392ea6", "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/5ad71b86d9467e4b172053cbe9c6a3a9dd392ea6", "message": "upgrade to zipkin-gcp 0.17.0", "committedDate": "2020-05-19T14:00:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzMyNjM4NA==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2290#discussion_r427326384", "bodyText": "@adriancole I'm not sure if I have to pass in this B3Propagation, or it will be auto-configured like before.", "author": "meltsufin", "createdAt": "2020-05-19T14:03:00Z", "path": "spring-cloud-gcp-autoconfigure/src/main/java/org/springframework/cloud/gcp/autoconfigure/trace/StackdriverTraceAutoConfiguration.java", "diffHunk": "@@ -221,8 +219,9 @@ public Sender stackdriverSender(GcpTraceProperties traceProperties,\n \n \t@Bean\n \t@ConditionalOnMissingBean\n-\tpublic Propagation.Factory stackdriverPropagation() {\n-\t\treturn StackdriverTracePropagation.FACTORY;\n+\tpublic BaggagePropagation.FactoryBuilder baggagePropagationFactoryBuilder() {\n+\t\treturn BaggagePropagation.newFactoryBuilder(StackdriverTracePropagation.newFactory(\n+\t\t\t\tB3Propagation.newFactoryBuilder().injectFormat(B3Propagation.Format.MULTI).build()));", "originalCommit": "5ad71b86d9467e4b172053cbe9c6a3a9dd392ea6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY2NTU5Nw==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2290#discussion_r427665597", "bodyText": "we don't have a way to pass this yet. so this is good enough for 2.2.x", "author": "codefromthecrypt", "createdAt": "2020-05-19T23:56:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzMyNjM4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY4MTc1Mw==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2290#discussion_r427681753", "bodyText": "Thanks!", "author": "meltsufin", "createdAt": "2020-05-20T00:53:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzMyNjM4NA=="}], "type": "inlineReview", "revised_code": null}]}