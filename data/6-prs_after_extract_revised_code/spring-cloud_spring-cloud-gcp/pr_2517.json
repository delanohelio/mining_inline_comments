{"pr_number": 2517, "pr_title": "Adding support to autoconfigure Cloud SQL ipTypes", "pr_createdAt": "2020-09-10T21:09:27Z", "pr_url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2517", "timeline": [{"oid": "c0a3770379dfda9264f37c2ee49d000355591a13", "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/c0a3770379dfda9264f37c2ee49d000355591a13", "message": "Adding support to autoconfigure Cloud SQL ipTypes", "committedDate": "2020-09-09T10:32:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjczMTkxMg==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2517#discussion_r486731912", "bodyText": "Have you considered putting this logic into DefaultCloudSqlJdbcInfoProvider instead?\nThat class is specifically designed for creating the JDBC URL string.", "author": "meltsufin", "createdAt": "2020-09-11T02:10:42Z", "path": "spring-cloud-gcp-autoconfigure/src/main/java/org/springframework/cloud/gcp/autoconfigure/sql/GcpCloudSqlAutoConfiguration.java", "diffHunk": "@@ -161,7 +162,11 @@ public DataSourceProperties cloudSqlDataSourceProperties(\n \t\t\t\tLOGGER.warn(\"Ignoring provided spring.datasource.url. Overwriting it based on the \" +\n \t\t\t\t\t\t\"spring.cloud.gcp.sql.instance-connection-name.\");\n \t\t\t}\n-\t\t\tproperties.setUrl(cloudSqlJdbcInfoProvider.getJdbcUrl());\n+\t\t\tString jdbcUrl = cloudSqlJdbcInfoProvider.getJdbcUrl();\n+\t\t\tif (StringUtils.hasText(gcpCloudSqlProperties.getIpTypes())) {\n+\t\t\t\tjdbcUrl = String.format(jdbcUrl + \"&ipTypes=%s\", gcpCloudSqlProperties.getIpTypes());", "originalCommit": "c0a3770379dfda9264f37c2ee49d000355591a13", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjgyMDU0OQ==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2517#discussion_r486820549", "bodyText": "No. I remember that I looked at patching the jdbcUrlTemplate in DatabaseType, but I didn't have the GcpCloudSqlProperties there. I must have overlooked DefaultCloudSqlJdbcInfoProvider.\nCode moved.", "author": "ohardeng", "createdAt": "2020-09-11T07:15:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjczMTkxMg=="}], "type": "inlineReview", "revised_code": {"commit": "234b8e1faf6db2ac38a7ce9101fa58ac9a28c188", "chunk": "diff --git a/spring-cloud-gcp-autoconfigure/src/main/java/org/springframework/cloud/gcp/autoconfigure/sql/GcpCloudSqlAutoConfiguration.java b/spring-cloud-gcp-autoconfigure/src/main/java/org/springframework/cloud/gcp/autoconfigure/sql/GcpCloudSqlAutoConfiguration.java\nindex 5545a844..d5d2bdd0 100644\n--- a/spring-cloud-gcp-autoconfigure/src/main/java/org/springframework/cloud/gcp/autoconfigure/sql/GcpCloudSqlAutoConfiguration.java\n+++ b/spring-cloud-gcp-autoconfigure/src/main/java/org/springframework/cloud/gcp/autoconfigure/sql/GcpCloudSqlAutoConfiguration.java\n\n@@ -162,11 +161,7 @@ public abstract class GcpCloudSqlAutoConfiguration { //NOSONAR squid:S1610 must\n \t\t\t\tLOGGER.warn(\"Ignoring provided spring.datasource.url. Overwriting it based on the \" +\n \t\t\t\t\t\t\"spring.cloud.gcp.sql.instance-connection-name.\");\n \t\t\t}\n-\t\t\tString jdbcUrl = cloudSqlJdbcInfoProvider.getJdbcUrl();\n-\t\t\tif (StringUtils.hasText(gcpCloudSqlProperties.getIpTypes())) {\n-\t\t\t\tjdbcUrl = String.format(jdbcUrl + \"&ipTypes=%s\", gcpCloudSqlProperties.getIpTypes());\n-\t\t\t}\n-\t\t\tproperties.setUrl(jdbcUrl);\n+\t\t\tproperties.setUrl(cloudSqlJdbcInfoProvider.getJdbcUrl());\n \n \t\t\tif (gcpCloudSqlProperties.getCredentials().getEncodedKey() != null) {\n \t\t\t\tsetCredentialsEncodedKeyProperty(gcpCloudSqlProperties);\n"}}, {"oid": "234b8e1faf6db2ac38a7ce9101fa58ac9a28c188", "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/234b8e1faf6db2ac38a7ce9101fa58ac9a28c188", "message": "Fixing PR comments ...\n\n* Moving implementation to DefaultCloudSqlJdbcInfoProvider\n* Adding Cloud SQL Socket Factory default ipTypes to documentation", "committedDate": "2020-09-11T07:10:54Z", "type": "commit"}, {"oid": "4f310696ae509dbc2b32d3811eaabe7812f645ca", "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/4f310696ae509dbc2b32d3811eaabe7812f645ca", "message": "Update docs/src/main/asciidoc/sql.adoc", "committedDate": "2020-09-11T18:53:18Z", "type": "commit"}]}