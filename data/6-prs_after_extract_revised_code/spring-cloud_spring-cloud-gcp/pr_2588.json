{"pr_number": 2588, "pr_title": "(Cherrypick) Allow for manually specifying BigQuery table schema", "pr_createdAt": "2020-11-10T21:19:47Z", "pr_url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2588", "timeline": [{"oid": "67a0ab06f2425dcfbb98ed3249f0c6e56a94ca23", "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/67a0ab06f2425dcfbb98ed3249f0c6e56a94ca23", "message": "Allow for manually specifying BigQuery table schema (#108)\n\nRelates to https://github.com/spring-cloud/spring-cloud-gcp/issues/2576\n\n(cherry picked from commit 283cd16effa144262c57846e55c6a6169ba0dbc1)", "committedDate": "2020-11-10T21:16:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTM1NDY5NA==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2588#discussion_r521354694", "bodyText": "Is it possible that concurrent tests would mean this executor pool has size > 1? Is there something more meaningfully checked in the queue item?", "author": "ttomsu", "createdAt": "2020-11-11T13:23:44Z", "path": "spring-cloud-gcp-bigquery/src/test/java/org/springframework/cloud/gcp/bigquery/integration/outbound/BigQueryFileMessageHandlerIntegrationTests.java", "diffHunk": "@@ -85,6 +89,46 @@ public void setup() {\n \t\tthis.bigquery.delete(TableId.of(DATASET_NAME, TABLE_NAME));\n \t}\n \n+\t@Test\n+\tpublic void testLoadFileWithSchema() throws InterruptedException, ExecutionException {\n+\t\tSchema schema = Schema.of(\n+\t\t\t\tField.newBuilder(\"CountyId\", StandardSQLTypeName.STRING).setMode(Mode.NULLABLE).build(),\n+\t\t\t\tField.newBuilder(\"State\", StandardSQLTypeName.STRING).setMode(Mode.NULLABLE).build(),\n+\t\t\t\tField.newBuilder(\"County\", StandardSQLTypeName.STRING).setMode(Mode.NULLABLE).build()\n+\t\t);\n+\n+\t\tHashMap<String, Object> messageHeaders = new HashMap<>();\n+\t\tmessageHeaders.put(BigQuerySpringMessageHeaders.TABLE_NAME, TABLE_NAME);\n+\t\tmessageHeaders.put(BigQuerySpringMessageHeaders.FORMAT_OPTIONS, FormatOptions.csv());\n+\t\tmessageHeaders.put(BigQuerySpringMessageHeaders.TABLE_SCHEMA, schema);\n+\n+\t\tMessage<File> message = MessageBuilder.createMessage(\n+\t\t\t\tnew File(\"src/test/resources/data.csv\"),\n+\t\t\t\tnew MessageHeaders(messageHeaders));\n+\n+\t\tListenableFuture<Job> jobFuture =\n+\t\t\t\t(ListenableFuture<Job>) this.messageHandler.handleRequestMessage(message);\n+\n+\t\t// Assert that a BigQuery polling task is scheduled successfully.\n+\t\tawait().atMost(Duration.FIVE_SECONDS)\n+\t\t\t\t.untilAsserted(\n+\t\t\t\t\t\t() -> assertThat(\n+\t\t\t\t\t\t\t\tthis.taskScheduler.getScheduledThreadPoolExecutor().getQueue()).hasSize(1));", "originalCommit": "67a0ab06f2425dcfbb98ed3249f0c6e56a94ca23", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTU0MjM5MA==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2588#discussion_r521542390", "bodyText": "Hmm as long as the tests in this file are not concurrent it should be okay. It should not interfere with any other tests run in other files since the pool is not shared.\nYeah the purpose of the check is just to verify a new Runnable was created in the task scheduler. Doesn't seem to be anything deeper I can verify about the object though.", "author": "dzou", "createdAt": "2020-11-11T18:02:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTM1NDY5NA=="}], "type": "inlineReview", "revised_code": null}]}