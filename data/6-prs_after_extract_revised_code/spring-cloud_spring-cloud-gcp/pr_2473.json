{"pr_number": 2473, "pr_title": "Control sync/async publish in Spring Cloud Stream binder", "pr_createdAt": "2020-07-22T18:53:36Z", "pr_url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2473", "timeline": [{"oid": "d4e3f14904b60b45ab5eb8f379a180163225e919", "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/d4e3f14904b60b45ab5eb8f379a180163225e919", "message": "add property to control sync/async publish", "committedDate": "2020-07-22T18:41:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA0NzE3OA==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2473#discussion_r459047178", "bodyText": "While uninitialized defaults to false for boolean, it might be nice to just have sync = false to be explicit on the defaults", "author": "dzou", "createdAt": "2020-07-22T19:57:49Z", "path": "spring-cloud-gcp-pubsub-stream-binder/src/main/java/org/springframework/cloud/gcp/stream/binder/pubsub/properties/PubSubProducerProperties.java", "diffHunk": "@@ -24,4 +24,13 @@\n  * @author Chengyuan Zhao\n  */\n public class PubSubProducerProperties extends PubSubCommonProperties {\n+\tprivate boolean sync;", "originalCommit": "d4e3f14904b60b45ab5eb8f379a180163225e919", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA5MzI1NQ==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2473#discussion_r459093255", "bodyText": "Will do.", "author": "elefeint", "createdAt": "2020-07-22T21:26:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA0NzE3OA=="}], "type": "inlineReview", "revised_code": {"commit": "6427799b33ef7e7d87141d7f2462215a04192f68", "chunk": "diff --git a/spring-cloud-gcp-pubsub-stream-binder/src/main/java/org/springframework/cloud/gcp/stream/binder/pubsub/properties/PubSubProducerProperties.java b/spring-cloud-gcp-pubsub-stream-binder/src/main/java/org/springframework/cloud/gcp/stream/binder/pubsub/properties/PubSubProducerProperties.java\nindex 9b9b7269..48bf89bd 100644\n--- a/spring-cloud-gcp-pubsub-stream-binder/src/main/java/org/springframework/cloud/gcp/stream/binder/pubsub/properties/PubSubProducerProperties.java\n+++ b/spring-cloud-gcp-pubsub-stream-binder/src/main/java/org/springframework/cloud/gcp/stream/binder/pubsub/properties/PubSubProducerProperties.java\n\n@@ -22,9 +22,10 @@ package org.springframework.cloud.gcp.stream.binder.pubsub.properties;\n  * @author Jo\u00e3o Andr\u00e9 Martins\n  * @author Daniel Zou\n  * @author Chengyuan Zhao\n+ * @author Elena Felder\n  */\n public class PubSubProducerProperties extends PubSubCommonProperties {\n-\tprivate boolean sync;\n+\tprivate boolean sync = false;\n \n \tpublic boolean isSync() {\n \t\treturn sync;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA0OTcxNQ==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2473#discussion_r459049715", "bodyText": "If it's possible, I think it would be better to set the property via spring.cloud.stream.gcp.pubsub.default.producer.sync rather than set the setting through the property class directly. Mainly to verify that spring.cloud.stream.gcp.pubsub.default.producer.sync is indeed the correct format of the property name (as I am not sure what the correct form is myself).", "author": "dzou", "createdAt": "2020-07-22T20:02:23Z", "path": "spring-cloud-gcp-pubsub-stream-binder/src/test/java/org/springframework/cloud/gcp/stream/binder/pubsub/PubSubMessageChannelBinderTests.java", "diffHunk": "@@ -71,4 +94,25 @@ public void testAfterUnbindConsumer() {\n \t\tverify(this.channelProvisioner).afterUnbindConsumer(this.consumerDestination);\n \t}\n \n+\t@Test\n+\tpublic void producerSyncPropertyFalseByDefault() {", "originalCommit": "d4e3f14904b60b45ab5eb8f379a180163225e919", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA5MzIwMQ==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2473#discussion_r459093201", "bodyText": "Yes, I've been getting increasingly uncomfortable with the amount of mocking in this test. I'll either move this into an integration test, or turn this test into a light integration test with only a mocked pubsub template.", "author": "elefeint", "createdAt": "2020-07-22T21:26:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA0OTcxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTgwNjM3NA==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2473#discussion_r459806374", "bodyText": "This is the best I could do without testing SCS implementation details. There is still one mocked transition from our properties into a SCS wrapper, but at least it tests the property mapping correctly.", "author": "elefeint", "createdAt": "2020-07-24T01:00:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA0OTcxNQ=="}], "type": "inlineReview", "revised_code": {"commit": "1c4c8500f4f20dbf00d0a6c23c14f94f630030db", "chunk": "diff --git a/spring-cloud-gcp-pubsub-stream-binder/src/test/java/org/springframework/cloud/gcp/stream/binder/pubsub/PubSubMessageChannelBinderTests.java b/spring-cloud-gcp-pubsub-stream-binder/src/test/java/org/springframework/cloud/gcp/stream/binder/pubsub/PubSubMessageChannelBinderTests.java\nindex 64743c2c..21c3935a 100644\n--- a/spring-cloud-gcp-pubsub-stream-binder/src/test/java/org/springframework/cloud/gcp/stream/binder/pubsub/PubSubMessageChannelBinderTests.java\n+++ b/spring-cloud-gcp-pubsub-stream-binder/src/test/java/org/springframework/cloud/gcp/stream/binder/pubsub/PubSubMessageChannelBinderTests.java\n\n@@ -96,23 +101,35 @@ public class PubSubMessageChannelBinderTests {\n \n \t@Test\n \tpublic void producerSyncPropertyFalseByDefault() {\n-\t\tPubSubProducerProperties props = new PubSubProducerProperties();\n-\t\twhen(mockProducerProperties.getExtension()).thenReturn(props);\n-\n-\t\tPubSubMessageHandler messageHandler =\n-\t\t\t\t(PubSubMessageHandler) this.binder.createProducerMessageHandler(mockProducerDestination, mockProducerProperties, mockErrorChannel);\n-\t\tassertThat(messageHandler.isSync()).isFalse();\n+\t\tbaseContext\n+\t\t\t\t.run(ctx -> {\n+\t\t\t\t\tPubSubMessageChannelBinder binder = ctx.getBean(PubSubMessageChannelBinder.class);\n+\n+\t\t\t\t\tPubSubExtendedBindingProperties props = ctx.getBean(\"pubSubExtendedBindingProperties\", PubSubExtendedBindingProperties.class);\n+\t\t\t\t\tPubSubMessageHandler messageHandler = (PubSubMessageHandler) binder.createProducerMessageHandler(\n+\t\t\t\t\t\t\tproducerDestination,\n+\t\t\t\t\t\t\tnew ExtendedProducerProperties<>(props.getExtendedProducerProperties(\"test\")),\n+\t\t\t\t\t\t\terrorChannel\n+\t\t\t\t\t);\n+\t\t\t\t\tassertThat(messageHandler.isSync()).isFalse();\n+\t\t\t\t});\n \t}\n \n \t@Test\n \tpublic void producerSyncPropertyPropagatesToMessageHandler() {\n-\t\tPubSubProducerProperties props = new PubSubProducerProperties();\n-\t\tprops.setSync(true);\n-\t\twhen(mockProducerProperties.getExtension()).thenReturn(props);\n-\n-\t\tPubSubMessageHandler messageHandler =\n-\t\t\t\t(PubSubMessageHandler) this.binder.createProducerMessageHandler(mockProducerDestination, mockProducerProperties, mockErrorChannel);\n-\t\tassertThat(messageHandler.isSync()).isTrue();\n+\t\tbaseContext\n+\t\t\t\t.withPropertyValues(\"spring.cloud.stream.gcp.pubsub.default.producer.sync=true\")\n+\t\t\t\t.run(ctx -> {\n+\t\t\t\t\tPubSubMessageChannelBinder binder = ctx.getBean(PubSubMessageChannelBinder.class);\n+\n+\t\t\t\t\tPubSubExtendedBindingProperties props = ctx.getBean(\"pubSubExtendedBindingProperties\", PubSubExtendedBindingProperties.class);\n+\t\t\t\t\tPubSubMessageHandler messageHandler = (PubSubMessageHandler) binder.createProducerMessageHandler(\n+\t\t\t\t\t\t\tproducerDestination,\n+\t\t\t\t\t\t\tnew ExtendedProducerProperties<>(props.getExtendedProducerProperties(\"test\")),\n+\t\t\t\t\t\t\terrorChannel\n+\t\t\t\t\t);\n+\t\t\t\t\tassertThat(messageHandler.isSync()).isTrue();\n+\t\t\t\t});\n \t}\n \n }\n"}}, {"oid": "6427799b33ef7e7d87141d7f2462215a04192f68", "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/6427799b33ef7e7d87141d7f2462215a04192f68", "message": "set explicit default false value for sync property", "committedDate": "2020-07-23T22:59:03Z", "type": "commit"}, {"oid": "1c4c8500f4f20dbf00d0a6c23c14f94f630030db", "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/1c4c8500f4f20dbf00d0a6c23c14f94f630030db", "message": "update test to be closer to reality", "committedDate": "2020-07-24T00:59:06Z", "type": "commit"}]}