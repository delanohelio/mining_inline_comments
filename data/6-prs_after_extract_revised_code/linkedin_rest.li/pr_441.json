{"pr_number": 441, "pr_title": "Encoding performance improvements", "pr_createdAt": "2020-10-10T08:42:01Z", "pr_url": "https://github.com/linkedin/rest.li/pull/441", "timeline": [{"oid": "cd16fcc5296379af1ef6899ec7f3884543b681ae", "url": "https://github.com/linkedin/rest.li/commit/cd16fcc5296379af1ef6899ec7f3884543b681ae", "message": "Performance improvements\n\nGet rid of DataComplexIdentitySet. Instead implement cycle check using placeholder booleans on DataMap and DataList\nUse LinkedList instead of ArrayList to avoid resizing if multiple datatemplates wrap a map since we anyways iterate linearly\nAvoid unnecessary number conversion when using input coercers", "committedDate": "2020-10-10T09:01:46Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjc3NTA0OQ==", "url": "https://github.com/linkedin/rest.li/pull/441#discussion_r502775049", "bodyText": "We have to be careful with this change. This would fail if a DataMap is traversed in multiple threads concurrently. I'm sure there are apps that do concurrent traversals. This might even happen within the context of a single request also.\nAlso, this might happen more often in tests sharing a common test input and run in parallel.\nI was thinking we should keep the existing algo, and provide a config for services to disable the cycle check (or use a count based check)", "author": "karthikbalasub", "createdAt": "2020-10-10T10:27:41Z", "path": "data/src/main/java/com/linkedin/data/Data.java", "diffHunk": "@@ -372,18 +353,27 @@ private static void traverse(Object obj, TraverseCallback callback,\n         }\n         else\n         {\n-          checkForCyclesAndAdd(map, ancestorSet, pathList);\n-          callback.startMap(map);\n-          Iterable<Map.Entry<String, Object>> orderedEntrySet = callback.orderMap(map);\n-          for (Map.Entry<String, Object> entry : orderedEntrySet)\n+          try\n+          {\n+            if (map._isTraversing)\n+            {\n+              throw new IOException(\"Cycle detected.\");\n+            }\n+\n+            map._isTraversing = true;", "originalCommit": "cd16fcc5296379af1ef6899ec7f3884543b681ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjg1NTY4MQ==", "url": "https://github.com/linkedin/rest.li/pull/441#discussion_r502855681", "bodyText": "I updated the existing algo to use ThreadLocal to get around your concern. It will still be faster than using an identityset.\nI also added an API to customize the cycle checker.", "author": "karthikrg", "createdAt": "2020-10-11T02:25:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjc3NTA0OQ=="}], "type": "inlineReview", "revised_code": {"commit": "304b8fba5216e168057c10250ec35b5e65975df0", "chunk": "diff --git a/data/src/main/java/com/linkedin/data/Data.java b/data/src/main/java/com/linkedin/data/Data.java\nindex 2150e7f5b..e4379ddb7 100644\n--- a/data/src/main/java/com/linkedin/data/Data.java\n+++ b/data/src/main/java/com/linkedin/data/Data.java\n\n@@ -355,24 +473,19 @@ public class Data\n         {\n           try\n           {\n-            if (map._isTraversing)\n-            {\n-              throw new IOException(\"Cycle detected.\");\n-            }\n-\n-            map._isTraversing = true;\n+            cycleChecker.startMap(map);\n             callback.startMap(map);\n             Iterable<Map.Entry<String, Object>> orderedEntrySet = callback.orderMap(map);\n             for (Map.Entry<String, Object> entry : orderedEntrySet)\n             {\n               callback.key(entry.getKey());\n-              traverse(entry.getValue(), callback);\n+              traverse(entry.getValue(), callback, cycleChecker);\n             }\n             callback.endMap();\n           }\n           finally\n           {\n-            map._isTraversing = false;\n+            cycleChecker.endMap(map);\n           }\n         }\n         return;\n"}}, {"oid": "304b8fba5216e168057c10250ec35b5e65975df0", "url": "https://github.com/linkedin/rest.li/commit/304b8fba5216e168057c10250ec35b5e65975df0", "message": "Performance improvements\n\nGet rid of DataComplexIdentitySet. Instead implement default cycle check using placeholder ThreadLocal instances on DataMap and DataList\nProvide an API to customize the default cycle checker\nUse LinkedList instead of ArrayList to avoid resizing if multiple datatemplates wrap a map since we anyways iterate linearly\nAvoid unnecessary number conversion when using input coercers", "committedDate": "2020-10-11T02:22:26Z", "type": "forcePushed"}, {"oid": "b7304ab5611758b381a8a3585461f33690e3f039", "url": "https://github.com/linkedin/rest.li/commit/b7304ab5611758b381a8a3585461f33690e3f039", "message": "Performance improvements\n\nGet rid of DataComplexIdentitySet. Instead implement default cycle check using placeholder ThreadLocal instances on DataMap and DataList\nProvide an API to customize the default cycle checker\nUse LinkedList instead of ArrayList to avoid resizing if multiple datatemplates wrap a map since we anyways iterate linearly\nAvoid unnecessary number conversion when using input coercers", "committedDate": "2020-10-11T02:28:02Z", "type": "forcePushed"}, {"oid": "f5bd240c08e2961cc98821192ead287a13435d6e", "url": "https://github.com/linkedin/rest.li/commit/f5bd240c08e2961cc98821192ead287a13435d6e", "message": "Performance improvements\n\nGet rid of DataComplexIdentitySet. Instead implement default cycle check using placeholder ThreadLocal instances on DataMap and DataList\nProvide an API to customize the default cycle checker\nUse LinkedList instead of ArrayList to avoid resizing if multiple datatemplates wrap a map since we anyways iterate linearly\nAvoid unnecessary number conversion when using input coercers", "committedDate": "2020-10-11T02:29:03Z", "type": "forcePushed"}, {"oid": "d7ed3fbfbed0a204be57addba3615013935da4c1", "url": "https://github.com/linkedin/rest.li/commit/d7ed3fbfbed0a204be57addba3615013935da4c1", "message": "Performance improvements\n\nGet rid of DataComplexIdentitySet. Instead implement default cycle check using placeholder ThreadLocal instances on DataMap and DataList\nProvide an API to customize the default cycle checker\nUse LinkedList instead of ArrayList to avoid resizing if multiple datatemplates wrap a map since we anyways iterate linearly\nAvoid unnecessary number conversion when using input coercers", "committedDate": "2020-10-11T19:22:34Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzEwNzIwNg==", "url": "https://github.com/linkedin/rest.li/pull/441#discussion_r503107206", "bodyText": "typo: supplier", "author": "karthikbalasub", "createdAt": "2020-10-12T07:59:48Z", "path": "data/src/main/java/com/linkedin/data/Data.java", "diffHunk": "@@ -103,6 +104,37 @@\n  */\n public class Data\n {\n+  /**\n+   * Placeholder object populated inside {@link DataList#_isTraversing} or {@link DataMap#_isTraversing} by the\n+   * default implementation of {@link CycleChecker} to indicate that the given {@link DataList} or {@link DataMap}\n+   * is being traversed.\n+   */\n+  private static final Object TRAVERSAL_INDICATOR = new Object();\n+\n+  /**\n+   * Supplier for cycle checker used when traversing instances using a {@link Data.TraverseCallback}. Applications can\n+   * choose to replace this with a supplier vending custom implementations, at their own risk of ensuring correctness.\n+   */\n+  private static Supplier<CycleChecker> CYCLE_CHECKER_SUPPLIER = DefaultCycleChecker::new;\n+\n+  /**\n+   * Override the default cycle checker supplier. Applications using this assume responsibility for correctness of their\n+   * {@link CycleChecker} implementations provided by this supplierr.", "originalCommit": "d7ed3fbfbed0a204be57addba3615013935da4c1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "163429c450227e8f72a7b471ab17246d3641f1ec", "chunk": "diff --git a/data/src/main/java/com/linkedin/data/Data.java b/data/src/main/java/com/linkedin/data/Data.java\nindex 1cefc7999..eee1d8281 100644\n--- a/data/src/main/java/com/linkedin/data/Data.java\n+++ b/data/src/main/java/com/linkedin/data/Data.java\n\n@@ -119,7 +119,7 @@ public class Data\n \n   /**\n    * Override the default cycle checker supplier. Applications using this assume responsibility for correctness of their\n-   * {@link CycleChecker} implementations provided by this supplierr.\n+   * {@link CycleChecker} implementations provided by this supplier.\n    *\n    * @param supplier The cycle checker supplier to use. Should not be null.\n    *\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzEwODEwOQ==", "url": "https://github.com/linkedin/rest.li/pull/441#discussion_r503108109", "bodyText": "nit: space between DataMap} to", "author": "karthikbalasub", "createdAt": "2020-10-12T08:01:14Z", "path": "data/src/main/java/com/linkedin/data/Data.java", "diffHunk": "@@ -130,6 +162,89 @@\n     TYPE_MAP.put(ByteString.class, (byte) 9);\n   }\n \n+  /**\n+   * Interface to be implemented by cycle checkers.\n+   */\n+  public interface CycleChecker\n+  {\n+    /**\n+     * Invoked when the start of {@link DataMap} is traversed.\n+     *\n+     * @param map provides the {@link DataMap}to be traversed.", "originalCommit": "d7ed3fbfbed0a204be57addba3615013935da4c1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "163429c450227e8f72a7b471ab17246d3641f1ec", "chunk": "diff --git a/data/src/main/java/com/linkedin/data/Data.java b/data/src/main/java/com/linkedin/data/Data.java\nindex 1cefc7999..eee1d8281 100644\n--- a/data/src/main/java/com/linkedin/data/Data.java\n+++ b/data/src/main/java/com/linkedin/data/Data.java\n\n@@ -170,7 +170,7 @@ public class Data\n     /**\n      * Invoked when the start of {@link DataMap} is traversed.\n      *\n-     * @param map provides the {@link DataMap}to be traversed.\n+     * @param map provides the {@link DataMap} to be traversed.\n      *\n      * @throws IOException If a cycle was detected when processing this.\n      */\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzEwODQ0MA==", "url": "https://github.com/linkedin/rest.li/pull/441#discussion_r503108440", "bodyText": "{@link DataMap} that ended traversal.", "author": "karthikbalasub", "createdAt": "2020-10-12T08:01:48Z", "path": "data/src/main/java/com/linkedin/data/Data.java", "diffHunk": "@@ -130,6 +162,89 @@\n     TYPE_MAP.put(ByteString.class, (byte) 9);\n   }\n \n+  /**\n+   * Interface to be implemented by cycle checkers.\n+   */\n+  public interface CycleChecker\n+  {\n+    /**\n+     * Invoked when the start of {@link DataMap} is traversed.\n+     *\n+     * @param map provides the {@link DataMap}to be traversed.\n+     *\n+     * @throws IOException If a cycle was detected when processing this.\n+     */\n+    void startMap(DataMap map) throws IOException;\n+\n+    /**\n+     * Invoked when the end of {@link DataMap} is traversed.\n+     *\n+     * @param map provides the {@link DataMap}to be traversed.", "originalCommit": "d7ed3fbfbed0a204be57addba3615013935da4c1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "163429c450227e8f72a7b471ab17246d3641f1ec", "chunk": "diff --git a/data/src/main/java/com/linkedin/data/Data.java b/data/src/main/java/com/linkedin/data/Data.java\nindex 1cefc7999..eee1d8281 100644\n--- a/data/src/main/java/com/linkedin/data/Data.java\n+++ b/data/src/main/java/com/linkedin/data/Data.java\n\n@@ -170,7 +170,7 @@ public class Data\n     /**\n      * Invoked when the start of {@link DataMap} is traversed.\n      *\n-     * @param map provides the {@link DataMap}to be traversed.\n+     * @param map provides the {@link DataMap} to be traversed.\n      *\n      * @throws IOException If a cycle was detected when processing this.\n      */\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzEwODYxNg==", "url": "https://github.com/linkedin/rest.li/pull/441#discussion_r503108616", "bodyText": "{@link DataList} that ended traversal.", "author": "karthikbalasub", "createdAt": "2020-10-12T08:02:07Z", "path": "data/src/main/java/com/linkedin/data/Data.java", "diffHunk": "@@ -130,6 +162,89 @@\n     TYPE_MAP.put(ByteString.class, (byte) 9);\n   }\n \n+  /**\n+   * Interface to be implemented by cycle checkers.\n+   */\n+  public interface CycleChecker\n+  {\n+    /**\n+     * Invoked when the start of {@link DataMap} is traversed.\n+     *\n+     * @param map provides the {@link DataMap}to be traversed.\n+     *\n+     * @throws IOException If a cycle was detected when processing this.\n+     */\n+    void startMap(DataMap map) throws IOException;\n+\n+    /**\n+     * Invoked when the end of {@link DataMap} is traversed.\n+     *\n+     * @param map provides the {@link DataMap}to be traversed.\n+     *\n+     * @throws IOException If a cycle was detected when processing this.\n+     */\n+    void endMap(DataMap map) throws IOException;\n+\n+    /**\n+     * Invoked when the start of {@link DataList} is traversed.\n+     *\n+     * @param list provides the {@link DataList}to be traversed.\n+     *\n+     * @throws IOException If a cycle was detected when processing this.\n+     */\n+    void startList(DataList list) throws IOException;\n+\n+    /**\n+     * Invoked when the end of {@link DataList} is traversed.\n+     *\n+     * @param list provides the {@link DataList}to be traversed.", "originalCommit": "d7ed3fbfbed0a204be57addba3615013935da4c1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "163429c450227e8f72a7b471ab17246d3641f1ec", "chunk": "diff --git a/data/src/main/java/com/linkedin/data/Data.java b/data/src/main/java/com/linkedin/data/Data.java\nindex 1cefc7999..eee1d8281 100644\n--- a/data/src/main/java/com/linkedin/data/Data.java\n+++ b/data/src/main/java/com/linkedin/data/Data.java\n\n@@ -170,7 +170,7 @@ public class Data\n     /**\n      * Invoked when the start of {@link DataMap} is traversed.\n      *\n-     * @param map provides the {@link DataMap}to be traversed.\n+     * @param map provides the {@link DataMap} to be traversed.\n      *\n      * @throws IOException If a cycle was detected when processing this.\n      */\n"}}, {"oid": "163429c450227e8f72a7b471ab17246d3641f1ec", "url": "https://github.com/linkedin/rest.li/commit/163429c450227e8f72a7b471ab17246d3641f1ec", "message": "Performance improvements\n\nGet rid of DataComplexIdentitySet. Instead implement default cycle check using placeholder ThreadLocal instances on DataMap and DataList\nProvide an API to customize the default cycle checker\nUse LinkedList instead of ArrayList to avoid resizing if multiple datatemplates wrap a map since we anyways iterate linearly\nAvoid unnecessary number conversion when using input coercers", "committedDate": "2020-10-12T17:44:15Z", "type": "commit"}, {"oid": "163429c450227e8f72a7b471ab17246d3641f1ec", "url": "https://github.com/linkedin/rest.li/commit/163429c450227e8f72a7b471ab17246d3641f1ec", "message": "Performance improvements\n\nGet rid of DataComplexIdentitySet. Instead implement default cycle check using placeholder ThreadLocal instances on DataMap and DataList\nProvide an API to customize the default cycle checker\nUse LinkedList instead of ArrayList to avoid resizing if multiple datatemplates wrap a map since we anyways iterate linearly\nAvoid unnecessary number conversion when using input coercers", "committedDate": "2020-10-12T17:44:15Z", "type": "forcePushed"}]}