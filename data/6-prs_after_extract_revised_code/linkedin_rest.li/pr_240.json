{"pr_number": 240, "pr_title": "Feature/zk batch with jitter", "pr_createdAt": "2020-03-27T22:14:29Z", "pr_url": "https://github.com/linkedin/rest.li/pull/240", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDUxODAwNQ==", "url": "https://github.com/linkedin/rest.li/pull/240#discussion_r400518005", "bodyText": "the config name (readWindowMs) is not self-identified. Can we have a more descriptive name (eg zookeeperReadWindowMs)?", "author": "cx-super", "createdAt": "2020-03-30T21:55:13Z", "path": "d2/src/main/java/com/linkedin/d2/balancer/D2ClientConfig.java", "diffHunk": "@@ -71,6 +72,7 @@\n   int retryLimit = DEAULT_RETRY_LIMIT;\n   boolean warmUp = false;\n   int warmUpTimeoutSeconds = WarmUpLoadBalancer.DEFAULT_SEND_REQUESTS_TIMEOUT_SECONDS;\n+  int readWindowMs = ZooKeeperStore.DEFAULT_READ_WINDOW_MS;", "originalCommit": "f55f3da0c4b8f90446b1d2ffcaadc6a48c4d2000", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU1Mzg5Ng==", "url": "https://github.com/linkedin/rest.li/pull/240#discussion_r400553896", "bodyText": "Thanks. Will rename this with the suggested name", "author": "nizarm", "createdAt": "2020-03-30T23:26:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDUxODAwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU5OTk0NQ==", "url": "https://github.com/linkedin/rest.li/pull/240#discussion_r400599945", "bodyText": "@ChaoLinkedIn  - Refactored all the variable names to zookeeperReadWindowMs and updated the pull request branch with the commit", "author": "nizarm", "createdAt": "2020-03-31T02:06:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDUxODAwNQ=="}], "type": "inlineReview", "revised_code": {"commit": "d0587855b73cbf6868a5d3a83674bd1475aa17d9", "chunk": "diff --git a/d2/src/main/java/com/linkedin/d2/balancer/D2ClientConfig.java b/d2/src/main/java/com/linkedin/d2/balancer/D2ClientConfig.java\nindex b1e593485..ccc113e71 100644\n--- a/d2/src/main/java/com/linkedin/d2/balancer/D2ClientConfig.java\n+++ b/d2/src/main/java/com/linkedin/d2/balancer/D2ClientConfig.java\n\n@@ -72,7 +72,7 @@ public class D2ClientConfig\n   int retryLimit = DEAULT_RETRY_LIMIT;\n   boolean warmUp = false;\n   int warmUpTimeoutSeconds = WarmUpLoadBalancer.DEFAULT_SEND_REQUESTS_TIMEOUT_SECONDS;\n-  int readWindowMs = ZooKeeperStore.DEFAULT_READ_WINDOW_MS;\n+  int zookeeperReadWindowMs = ZooKeeperStore.DEFAULT_READ_WINDOW_MS;\n   int warmUpConcurrentRequests = WarmUpLoadBalancer.DEFAULT_CONCURRENT_REQUESTS;\n   DownstreamServicesFetcher downstreamServicesFetcher = null;\n   boolean backupRequestsEnabled = true;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDUyMTU0Nw==", "url": "https://github.com/linkedin/rest.li/pull/240#discussion_r400521547", "bodyText": "So the delay is in the range of [midPoint, readWindowMs] -- why not [0, readWindowMs]? There is no need to explicitly add latency for the calls.", "author": "cx-super", "createdAt": "2020-03-30T22:02:57Z", "path": "d2/src/main/java/com/linkedin/d2/discovery/stores/zk/ZooKeeperEphemeralStore.java", "diffHunk": "@@ -610,7 +638,19 @@ public void processResult(int rc, String path, Object ctx, Stat stat)\n     protected void processWatch(String propertyName, WatchedEvent event)\n     {\n       // Reset the watch\n-      _zk.getChildren(getPath(propertyName), this, this, false);\n+      if (_readWindowMs > 0 && _executorService != null)\n+      {\n+        // Delay setting the watch based on configured _readWindowMs\n+        int midPoint = _readWindowMs / 2;\n+        int delay = midPoint + ThreadLocalRandom.current().nextInt(midPoint);", "originalCommit": "f55f3da0c4b8f90446b1d2ffcaadc6a48c4d2000", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU1NDYyOQ==", "url": "https://github.com/linkedin/rest.li/pull/240#discussion_r400554629", "bodyText": "The purpose of adding the delay is to reduce the number of reads as discussed in the design document. This will help us to reduce a lot of unwanted watch updates by delaying within the acceptable threshold. Please check the design document and let me know you still have concerns with this approach.", "author": "nizarm", "createdAt": "2020-03-30T23:28:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDUyMTU0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTc4Nzk2NA==", "url": "https://github.com/linkedin/rest.li/pull/240#discussion_r401787964", "bodyText": "Thanks for the clarification. Reviewed the doc and agree there should be a delay.", "author": "cx-super", "createdAt": "2020-04-01T17:30:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDUyMTU0Nw=="}], "type": "inlineReview", "revised_code": {"commit": "d0587855b73cbf6868a5d3a83674bd1475aa17d9", "chunk": "diff --git a/d2/src/main/java/com/linkedin/d2/discovery/stores/zk/ZooKeeperEphemeralStore.java b/d2/src/main/java/com/linkedin/d2/discovery/stores/zk/ZooKeeperEphemeralStore.java\nindex fe232869f..04ac61f28 100644\n--- a/d2/src/main/java/com/linkedin/d2/discovery/stores/zk/ZooKeeperEphemeralStore.java\n+++ b/d2/src/main/java/com/linkedin/d2/discovery/stores/zk/ZooKeeperEphemeralStore.java\n\n@@ -638,10 +637,10 @@ public class ZooKeeperEphemeralStore<T> extends ZooKeeperStore<T>\n     protected void processWatch(String propertyName, WatchedEvent event)\n     {\n       // Reset the watch\n-      if (_readWindowMs > 0 && _executorService != null)\n+      if (_zookeeperReadWindowMs > 0 && _executorService != null)\n       {\n         // Delay setting the watch based on configured _readWindowMs\n-        int midPoint = _readWindowMs / 2;\n+        int midPoint = _zookeeperReadWindowMs / 2;\n         int delay = midPoint + ThreadLocalRandom.current().nextInt(midPoint);\n         _executorService.schedule(() -> _zk.getChildren(getPath(propertyName), this, this, false),\n             delay, TimeUnit.MILLISECONDS);\n"}}, {"oid": "a7aa674a2c2028c947b2fde72118a8616b439432", "url": "https://github.com/linkedin/rest.li/commit/a7aa674a2c2028c947b2fde72118a8616b439432", "message": "Zookeeper Read Batching with Jitter", "committedDate": "2020-03-31T01:33:47Z", "type": "commit"}, {"oid": "d2b8bb96c51918475cd6d1543efa123e4fdc25b6", "url": "https://github.com/linkedin/rest.li/commit/d2b8bb96c51918475cd6d1543efa123e4fdc25b6", "message": "Update the config parameters in LastSeenLoadBalancer", "committedDate": "2020-03-31T01:33:47Z", "type": "commit"}, {"oid": "d0587855b73cbf6868a5d3a83674bd1475aa17d9", "url": "https://github.com/linkedin/rest.li/commit/d0587855b73cbf6868a5d3a83674bd1475aa17d9", "message": "Iterate with Chao review comments", "committedDate": "2020-03-31T01:33:47Z", "type": "commit"}, {"oid": "d0587855b73cbf6868a5d3a83674bd1475aa17d9", "url": "https://github.com/linkedin/rest.li/commit/d0587855b73cbf6868a5d3a83674bd1475aa17d9", "message": "Iterate with Chao review comments", "committedDate": "2020-03-31T01:33:47Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ5NzI3MQ==", "url": "https://github.com/linkedin/rest.li/pull/240#discussion_r402497271", "bodyText": "any reason not to use Timespan? for easier tweaking in the future and better readability.", "author": "bohhyang", "createdAt": "2020-04-02T17:42:16Z", "path": "d2/src/main/java/com/linkedin/d2/discovery/stores/zk/ZooKeeperStore.java", "diffHunk": "@@ -42,8 +42,9 @@\n     PropertyEventPublisher<T>,\n     PropertyStore<T>\n {\n-  private static final Logger           _log =\n-                                                 LoggerFactory.getLogger(ZooKeeperStore.class);\n+  private static final Logger           _log = LoggerFactory.getLogger(ZooKeeperStore.class);\n+\n+  public static final int DEFAULT_READ_WINDOW_MS = -1; //disabled by default", "originalCommit": "d0587855b73cbf6868a5d3a83674bd1475aa17d9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI0MzEyMQ==", "url": "https://github.com/linkedin/rest.li/pull/240#discussion_r405243121", "bodyText": "If you see the use of the read window in processWatch function - we are using this to randomize setting the watch. So we may not be able to leverage the TimeSpan here and it may introduce unwanted conversion back to int in processWatch to randomize.", "author": "nizarm", "createdAt": "2020-04-08T03:52:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ5NzI3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY0MDg4OQ==", "url": "https://github.com/linkedin/rest.li/pull/240#discussion_r405640889", "bodyText": "could the function \"getDurationInMilliseconds\" in Timespan work for getting a long in milliseconds for the calculation?", "author": "bohhyang", "createdAt": "2020-04-08T16:07:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ5NzI3MQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjczMjczNQ==", "url": "https://github.com/linkedin/rest.li/pull/240#discussion_r402732735", "bodyText": "just for my understanding, which config is this executor service coming from? where is it defined?", "author": "bohhyang", "createdAt": "2020-04-03T04:38:59Z", "path": "d2/src/main/java/com/linkedin/d2/balancer/LastSeenBalancerWithFacilitiesFactory.java", "diffHunk": "@@ -73,15 +75,21 @@ public LoadBalancerWithFacilities create(D2ClientConfig config)\n     }\n \n     // init all the stores\n-    LastSeenZKStore<ClusterProperties> lsClusterStore = getClusterPropertiesLastSeenZKStore(config, zkPersistentConnection, d2ClientJmxManager);\n+    LastSeenZKStore<ClusterProperties> lsClusterStore =\n+      getClusterPropertiesLastSeenZKStore(config, zkPersistentConnection, d2ClientJmxManager,\n+                                          config._executorService, config.zookeeperReadWindowMs);", "originalCommit": "d0587855b73cbf6868a5d3a83674bd1475aa17d9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI0MzY5Ng==", "url": "https://github.com/linkedin/rest.li/pull/240#discussion_r405243696", "bodyText": "This is coming from R2SchedulerFactory in container", "author": "nizarm", "createdAt": "2020-04-08T03:55:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjczMjczNQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "d9c9e9fe4d25b9a38025befc6e966d1f18f48e2e", "url": "https://github.com/linkedin/rest.li/commit/d9c9e9fe4d25b9a38025befc6e966d1f18f48e2e", "message": "Merge branch 'master' into feature/ZKBatchWithJitter", "committedDate": "2020-04-08T22:02:01Z", "type": "commit"}]}