{"pr_number": 179, "pr_title": "fix template exception while request build init for custom response types", "pr_createdAt": "2020-02-20T00:56:28Z", "pr_url": "https://github.com/linkedin/rest.li/pull/179", "timeline": [{"oid": "a086b71acb35ef1a346c5cf66a839ad7763ac173", "url": "https://github.com/linkedin/rest.li/commit/a086b71acb35ef1a346c5cf66a839ad7763ac173", "message": "fix template runtime exception while request build init for custom response types", "committedDate": "2020-02-20T00:52:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTYzNzk0MA==", "url": "https://github.com/linkedin/rest.li/pull/179#discussion_r381637940", "bodyText": "Why do you need the non primitive class check?", "author": "karthikbalasub", "createdAt": "2020-02-20T01:13:09Z", "path": "restli-common/src/main/java/com/linkedin/restli/common/TypeSpec.java", "diffHunk": "@@ -67,7 +68,11 @@ public TypeSpec(Class<T> type)\n   private static DataSchema backfillSchemaIfPossible(Class<?> type)\n   {\n     // These are all the classes used for type specs that are \"schema-less\".\n-    if(type == CompoundKey.class || type == ComplexResourceKey.class || type == Void.class) return null;\n+    if (type == CompoundKey.class || type == ComplexResourceKey.class || type == Void.class\n+        || (!DataSchemaUtil.isPrimitiveClass(type) && DataTemplateUtil.hasCoercer(type)))", "originalCommit": "a086b71acb35ef1a346c5cf66a839ad7763ac173", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTY3NDg3NA==", "url": "https://github.com/linkedin/rest.li/pull/179#discussion_r381674874", "bodyText": "there are data schemas available for primitives and coercers also registers primitives", "author": "aman1309", "createdAt": "2020-02-20T02:18:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTYzNzk0MA=="}], "type": "inlineReview", "revised_code": {"commit": "3cad4e0c7dcfa20cca9e8499a8e0de206883130d", "chunk": "diff --git a/restli-common/src/main/java/com/linkedin/restli/common/TypeSpec.java b/restli-common/src/main/java/com/linkedin/restli/common/TypeSpec.java\nindex f6d8ea51e..92f7c9761 100644\n--- a/restli-common/src/main/java/com/linkedin/restli/common/TypeSpec.java\n+++ b/restli-common/src/main/java/com/linkedin/restli/common/TypeSpec.java\n\n@@ -69,7 +70,7 @@ public class TypeSpec<T>\n   {\n     // These are all the classes used for type specs that are \"schema-less\".\n     if (type == CompoundKey.class || type == ComplexResourceKey.class || type == Void.class\n-        || (!DataSchemaUtil.isPrimitiveClass(type) && DataTemplateUtil.hasCoercer(type)))\n+        || Custom.isCustomType(type))\n     {\n       return null;\n     }\n"}}, {"oid": "fabf871f9e30ca714414cba9e525a69c976e9066", "url": "https://github.com/linkedin/rest.li/commit/fabf871f9e30ca714414cba9e525a69c976e9066", "message": "Address karthik comment to use resource spec to get response schema", "committedDate": "2020-02-20T04:02:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjE3MTI0NA==", "url": "https://github.com/linkedin/rest.li/pull/179#discussion_r382171244", "bodyText": "This is not loading from resourespec?", "author": "karthikbalasub", "createdAt": "2020-02-20T18:13:15Z", "path": "restli-client/src/main/java/com/linkedin/restli/client/ActionRequestBuilder.java", "diffHunk": "@@ -193,7 +195,10 @@ public ActionRequestBuilder(String baseUriTemplate, TypeSpec<V> elementType, Res\n     if (_resourceSpec.getRequestMetadata(_name) == null) // old builder code in use\n     {\n       requestDataSchema = DynamicRecordMetadata.buildSchema(_name, _actionParams.keySet());\n-\n+      if (_elementType == null)\n+      {\n+        _elementType = new TypeSpec<>(_elementClass);", "originalCommit": "fabf871f9e30ca714414cba9e525a69c976e9066", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjE3MjI4NQ==", "url": "https://github.com/linkedin/rest.li/pull/179#discussion_r382172285", "bodyText": "this is old request builder code where spec doesn't have that info. see the else part", "author": "aman1309", "createdAt": "2020-02-20T18:15:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjE3MTI0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjE5OTM0MQ==", "url": "https://github.com/linkedin/rest.li/pull/179#discussion_r382199341", "bodyText": "Ah, didn't notice that.", "author": "karthikbalasub", "createdAt": "2020-02-20T19:07:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjE3MTI0NA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI0NTg4Mw==", "url": "https://github.com/linkedin/rest.li/pull/179#discussion_r382245883", "bodyText": "Why don't you just keep track of registered custom classes in Custom.java? I think that would be simpler", "author": "evanw555", "createdAt": "2020-02-20T20:41:47Z", "path": "restli-common/src/main/java/com/linkedin/restli/common/TypeSpec.java", "diffHunk": "@@ -67,7 +68,11 @@ public TypeSpec(Class<T> type)\n   private static DataSchema backfillSchemaIfPossible(Class<?> type)\n   {\n     // These are all the classes used for type specs that are \"schema-less\".\n-    if(type == CompoundKey.class || type == ComplexResourceKey.class || type == Void.class) return null;\n+    if (type == CompoundKey.class || type == ComplexResourceKey.class || type == Void.class\n+        || (!DataSchemaUtil.isPrimitiveClass(type) && DataTemplateUtil.hasCoercer(type)))", "originalCommit": "fabf871f9e30ca714414cba9e525a69c976e9066", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI1NjAwMQ==", "url": "https://github.com/linkedin/rest.li/pull/179#discussion_r382256001", "bodyText": "we could do that but didn't see much value for adding another map when this can be achieved using existing ones. Also, since coercers are only for customs, so felt like doing it this way. Let me know if you see any issue with this.", "author": "aman1309", "createdAt": "2020-02-20T21:01:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI0NTg4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI2NTAxMQ==", "url": "https://github.com/linkedin/rest.li/pull/179#discussion_r382265011", "bodyText": "true, though I feel like this can be more abstracted. What if you created a new helper method (e.g. DataTemplateUtil#isCustomType(Class<?>) which itself checks the coercers and does the logic to exclude primitives. It doesn't make sense to me that this consumer method needs to know that primitives also have coercers, it just wants to know if a type is a custom typeref/custom type/whatever.", "author": "evanw555", "createdAt": "2020-02-20T21:22:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI0NTg4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI2NTkwOQ==", "url": "https://github.com/linkedin/rest.li/pull/179#discussion_r382265909", "bodyText": "Another alternative is to create the helper method as Custom#isCustomType(Class<?>), since it may not be appropriate for DataTemplateUtil to have a sense of what is \"custom\" and what isn't.", "author": "evanw555", "createdAt": "2020-02-20T21:24:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI0NTg4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI3NTgxNA==", "url": "https://github.com/linkedin/rest.li/pull/179#discussion_r382275814", "bodyText": "done", "author": "aman1309", "createdAt": "2020-02-20T21:47:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI0NTg4Mw=="}], "type": "inlineReview", "revised_code": {"commit": "3cad4e0c7dcfa20cca9e8499a8e0de206883130d", "chunk": "diff --git a/restli-common/src/main/java/com/linkedin/restli/common/TypeSpec.java b/restli-common/src/main/java/com/linkedin/restli/common/TypeSpec.java\nindex f6d8ea51e..92f7c9761 100644\n--- a/restli-common/src/main/java/com/linkedin/restli/common/TypeSpec.java\n+++ b/restli-common/src/main/java/com/linkedin/restli/common/TypeSpec.java\n\n@@ -69,7 +70,7 @@ public class TypeSpec<T>\n   {\n     // These are all the classes used for type specs that are \"schema-less\".\n     if (type == CompoundKey.class || type == ComplexResourceKey.class || type == Void.class\n-        || (!DataSchemaUtil.isPrimitiveClass(type) && DataTemplateUtil.hasCoercer(type)))\n+        || Custom.isCustomType(type))\n     {\n       return null;\n     }\n"}}, {"oid": "3cad4e0c7dcfa20cca9e8499a8e0de206883130d", "url": "https://github.com/linkedin/rest.li/commit/3cad4e0c7dcfa20cca9e8499a8e0de206883130d", "message": "abstract custom type identification to Custom.java and use it in typespec", "committedDate": "2020-02-20T21:46:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjMyNjg5NA==", "url": "https://github.com/linkedin/rest.li/pull/179#discussion_r382326894", "bodyText": "Thinking about this now. How will this behave for enums? You should test this. It looks like the Enum type has a coercer, yet it's not in the \"primitives\" mapping. Would this method return true?", "author": "evanw555", "createdAt": "2020-02-20T23:57:52Z", "path": "data/src/main/java/com/linkedin/data/template/Custom.java", "diffHunk": "@@ -149,4 +151,16 @@ public static void initializeCustomClass(Class<?> customClass)\n   {\n     DataTemplateUtil.initializeClass(customClass);\n   }\n+\n+  /**\n+   * Return whether the input class is a Custom type or not\n+   * uses coercer map to identify as each custom type must register a coercer excluding the primitive types.\n+   *\n+   * @param clazz is the class to check.\n+   * @return true if an object of the input class is a Custom type.\n+   */\n+  public static boolean isCustomType(Class<?> clazz)\n+  {\n+    return !DataSchemaUtil.isPrimitiveClass(clazz) && DataTemplateUtil.hasCoercer(clazz);", "originalCommit": "3cad4e0c7dcfa20cca9e8499a8e0de206883130d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM2MDc1OA==", "url": "https://github.com/linkedin/rest.li/pull/179#discussion_r382360758", "bodyText": "removed the changes from typespec as its anyway legacy code and not needed for fix as it handled in action request builder change.", "author": "aman1309", "createdAt": "2020-02-21T02:03:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjMyNjg5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM3NTQzMw==", "url": "https://github.com/linkedin/rest.li/pull/179#discussion_r382375433", "bodyText": "Did you check this wouldn't be needed for other places that use TypeSpec? I think it would still be good to have the check in TypeSpec as fallback. It doesn't hurt to be extra safe?", "author": "karthikbalasub", "createdAt": "2020-02-21T03:05:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjMyNjg5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjQwODQxMg==", "url": "https://github.com/linkedin/rest.li/pull/179#discussion_r382408412", "bodyText": "will take it as a separate PR since adding multiple checks like primitive and enum didn't seem right.\nAlso, BatchRequests are build in a same way which would affect the performance but other places the class is constant.", "author": "aman1309", "createdAt": "2020-02-21T05:51:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjMyNjg5NA=="}], "type": "inlineReview", "revised_code": {"commit": "564041aef98047f084f47118a0a621bfab8e6f40", "chunk": "diff --git a/data/src/main/java/com/linkedin/data/template/Custom.java b/data/src/main/java/com/linkedin/data/template/Custom.java\nindex 9a4bf0a29..4fad00404 100644\n--- a/data/src/main/java/com/linkedin/data/template/Custom.java\n+++ b/data/src/main/java/com/linkedin/data/template/Custom.java\n\n@@ -151,16 +148,4 @@ public class Custom\n   {\n     DataTemplateUtil.initializeClass(customClass);\n   }\n-\n-  /**\n-   * Return whether the input class is a Custom type or not\n-   * uses coercer map to identify as each custom type must register a coercer excluding the primitive types.\n-   *\n-   * @param clazz is the class to check.\n-   * @return true if an object of the input class is a Custom type.\n-   */\n-  public static boolean isCustomType(Class<?> clazz)\n-  {\n-    return !DataSchemaUtil.isPrimitiveClass(clazz) && DataTemplateUtil.hasCoercer(clazz);\n-  }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjMyNzI1Mg==", "url": "https://github.com/linkedin/rest.li/pull/179#discussion_r382327252", "bodyText": "I suggest renaming to isCustomClass to be consistent with the other methods in this class. Update the Javadoc to explain that this method checks if a given class is registered as a custom Java binding.", "author": "evanw555", "createdAt": "2020-02-20T23:59:03Z", "path": "data/src/main/java/com/linkedin/data/template/Custom.java", "diffHunk": "@@ -149,4 +151,16 @@ public static void initializeCustomClass(Class<?> customClass)\n   {\n     DataTemplateUtil.initializeClass(customClass);\n   }\n+\n+  /**\n+   * Return whether the input class is a Custom type or not\n+   * uses coercer map to identify as each custom type must register a coercer excluding the primitive types.\n+   *\n+   * @param clazz is the class to check.\n+   * @return true if an object of the input class is a Custom type.\n+   */\n+  public static boolean isCustomType(Class<?> clazz)", "originalCommit": "3cad4e0c7dcfa20cca9e8499a8e0de206883130d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM2MDU3Nw==", "url": "https://github.com/linkedin/rest.li/pull/179#discussion_r382360577", "bodyText": "removed the changes", "author": "aman1309", "createdAt": "2020-02-21T02:02:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjMyNzI1Mg=="}], "type": "inlineReview", "revised_code": {"commit": "564041aef98047f084f47118a0a621bfab8e6f40", "chunk": "diff --git a/data/src/main/java/com/linkedin/data/template/Custom.java b/data/src/main/java/com/linkedin/data/template/Custom.java\nindex 9a4bf0a29..4fad00404 100644\n--- a/data/src/main/java/com/linkedin/data/template/Custom.java\n+++ b/data/src/main/java/com/linkedin/data/template/Custom.java\n\n@@ -151,16 +148,4 @@ public class Custom\n   {\n     DataTemplateUtil.initializeClass(customClass);\n   }\n-\n-  /**\n-   * Return whether the input class is a Custom type or not\n-   * uses coercer map to identify as each custom type must register a coercer excluding the primitive types.\n-   *\n-   * @param clazz is the class to check.\n-   * @return true if an object of the input class is a Custom type.\n-   */\n-  public static boolean isCustomType(Class<?> clazz)\n-  {\n-    return !DataSchemaUtil.isPrimitiveClass(clazz) && DataTemplateUtil.hasCoercer(clazz);\n-  }\n }\n"}}, {"oid": "564041aef98047f084f47118a0a621bfab8e6f40", "url": "https://github.com/linkedin/rest.li/commit/564041aef98047f084f47118a0a621bfab8e6f40", "message": "remove custom type check for typespec, not needed for fix", "committedDate": "2020-02-21T01:59:42Z", "type": "commit"}, {"oid": "e67ba3e87d0b6e1b6de096ecf194117db70bcdcf", "url": "https://github.com/linkedin/rest.li/commit/e67ba3e87d0b6e1b6de096ecf194117db70bcdcf", "message": "Merge branch 'master' into fix", "committedDate": "2020-02-26T22:40:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg5ODIzNQ==", "url": "https://github.com/linkedin/rest.li/pull/179#discussion_r384898235", "bodyText": "Why are we lazily loading this class-level field in this method? Wouldn't it make more sense to just do so in the constructor?", "author": "evanw555", "createdAt": "2020-02-27T03:41:28Z", "path": "restli-client/src/main/java/com/linkedin/restli/client/ActionRequestBuilder.java", "diffHunk": "@@ -193,7 +195,10 @@ public ActionRequestBuilder(String baseUriTemplate, TypeSpec<V> elementType, Res\n     if (_resourceSpec.getRequestMetadata(_name) == null) // old builder code in use\n     {\n       requestDataSchema = DynamicRecordMetadata.buildSchema(_name, _actionParams.keySet());\n-\n+      if (_elementType == null)\n+      {\n+        _elementType = new TypeSpec<>(_elementClass);", "originalCommit": "e67ba3e87d0b6e1b6de096ecf194117db70bcdcf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI4OTI3Nw==", "url": "https://github.com/linkedin/rest.li/pull/179#discussion_r385289277", "bodyText": "yeah, we have to since this is required for legacy flow only when there were no resourcespec generated. Also, It should be fine since this is builder class not the actual one.", "author": "aman1309", "createdAt": "2020-02-27T18:24:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg5ODIzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTM4ODM4OQ==", "url": "https://github.com/linkedin/rest.li/pull/179#discussion_r385388389", "bodyText": "Ok, then why isn't it a local variable? It's not clean to have a class-level field which is only initialized and read in one particular method.", "author": "evanw555", "createdAt": "2020-02-27T21:43:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg5ODIzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTM5MjYwMA==", "url": "https://github.com/linkedin/rest.li/pull/179#discussion_r385392600", "bodyText": "because with another constructor we accept typespec directly so that we don't have to extract the schema from the class using reflection which is a costly thing", "author": "aman1309", "createdAt": "2020-02-27T21:52:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg5ODIzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTM5NDA5NA==", "url": "https://github.com/linkedin/rest.li/pull/179#discussion_r385394094", "bodyText": "Nevermind", "author": "evanw555", "createdAt": "2020-02-27T21:55:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg5ODIzNQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "519079f3556f273b73cdf73c09046a9dabf23d60", "url": "https://github.com/linkedin/rest.li/commit/519079f3556f273b73cdf73c09046a9dabf23d60", "message": "Merge branch 'master' into fix", "committedDate": "2020-02-27T18:24:24Z", "type": "commit"}, {"oid": "d7f2541346fae8676d0b3160f24d8f9146817303", "url": "https://github.com/linkedin/rest.li/commit/d7f2541346fae8676d0b3160f24d8f9146817303", "message": "Merge branch 'master' into fix", "committedDate": "2020-02-28T00:06:52Z", "type": "commit"}, {"oid": "355c80ea3d157464f4babce655f91c8e482ca144", "url": "https://github.com/linkedin/rest.li/commit/355c80ea3d157464f4babce655f91c8e482ca144", "message": "Empty commit to trigger build", "committedDate": "2020-02-28T00:10:41Z", "type": "commit"}]}