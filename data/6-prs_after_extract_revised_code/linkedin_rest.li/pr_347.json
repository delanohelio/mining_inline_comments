{"pr_number": 347, "pr_title": "D2 relative strategy integration test", "pr_createdAt": "2020-07-14T20:45:51Z", "pr_url": "https://github.com/linkedin/rest.li/pull/347", "timeline": [{"oid": "00109d4b4ad670dd054f4d71d349de8851f41b4e", "url": "https://github.com/linkedin/rest.li/commit/00109d4b4ad670dd054f4d71d349de8851f41b4e", "message": "D2 relative strategy integration test", "committedDate": "2020-07-14T21:34:08Z", "type": "commit"}, {"oid": "00109d4b4ad670dd054f4d71d349de8851f41b4e", "url": "https://github.com/linkedin/rest.li/commit/00109d4b4ad670dd054f4d71d349de8851f41b4e", "message": "D2 relative strategy integration test", "committedDate": "2020-07-14T21:34:08Z", "type": "forcePushed"}, {"oid": "f7e6bf9819f5b37567dc6b0203094d4cb3d4baaa", "url": "https://github.com/linkedin/rest.li/commit/f7e6bf9819f5b37567dc6b0203094d4cb3d4baaa", "message": "Minor java doc change", "committedDate": "2020-07-14T21:39:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk3NzI3MQ==", "url": "https://github.com/linkedin/rest.li/pull/347#discussion_r458977271", "bodyText": "Wrap with Collections.unmodifiableMap", "author": "cx-super", "createdAt": "2020-07-22T17:53:58Z", "path": "d2/src/main/java/com/linkedin/d2/balancer/strategies/relative/RelativeLoadBalancerTestHelper.java", "diffHunk": "@@ -0,0 +1,39 @@\n+/*\n+   Copyright (c) 2020 LinkedIn Corp.\n+\n+   Licensed under the Apache License, Version 2.0 (the \"License\");\n+   you may not use this file except in compliance with the License.\n+   You may obtain a copy of the License at\n+\n+       http://www.apache.org/licenses/LICENSE-2.0\n+\n+   Unless required by applicable law or agreed to in writing, software\n+   distributed under the License is distributed on an \"AS IS\" BASIS,\n+   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+   See the License for the specific language governing permissions and\n+   limitations under the License.\n+*/\n+\n+package com.linkedin.d2.balancer.strategies.relative;\n+\n+import java.net.URI;\n+import java.util.Map;\n+\n+\n+/**\n+ * The helper class for {@link RelativeLoadBalancerStrategy} related tests\n+ */\n+public class RelativeLoadBalancerTestHelper {\n+\n+  /**\n+   * Get points map for a given partition\n+   *\n+   * @param strategy The object of the strategy\n+   * @param partitionId The id of the partition\n+   * @return The points map\n+   */\n+  public static Map<URI, Integer> getPointsMap(RelativeLoadBalancerStrategy strategy, int partitionId)\n+  {\n+    return strategy.getPointsMap(partitionId);", "originalCommit": "f7e6bf9819f5b37567dc6b0203094d4cb3d4baaa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAxMTA3OA==", "url": "https://github.com/linkedin/rest.li/pull/347#discussion_r459011078", "bodyText": "Sure.\nAlso replying to the facilities question here: the new relative load balancer is not an actual \"load balancer\" in the implementation, it is just a new strategy, it still uses the existing SimpleLoadBalancer, and I don't think simpleLoadBalancer extends Facilities, but LastSeenLoadBalancer does, and it uses the SimpleLoadBalancer internally.", "author": "rachelhanhan", "createdAt": "2020-07-22T18:51:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk3NzI3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAxNjQzOA==", "url": "https://github.com/linkedin/rest.li/pull/347#discussion_r459016438", "bodyText": "ok", "author": "cx-super", "createdAt": "2020-07-22T19:00:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk3NzI3MQ=="}], "type": "inlineReview", "revised_code": {"commit": "1d4c263975dc9a37abddc518633b0ef1fff6050b", "chunk": "diff --git a/d2/src/main/java/com/linkedin/d2/balancer/strategies/relative/RelativeLoadBalancerTestHelper.java b/d2/src/main/java/com/linkedin/d2/balancer/strategies/relative/RelativeLoadBalancerTestHelper.java\nindex fb0c8ae44..c6305efb5 100644\n--- a/d2/src/main/java/com/linkedin/d2/balancer/strategies/relative/RelativeLoadBalancerTestHelper.java\n+++ b/d2/src/main/java/com/linkedin/d2/balancer/strategies/relative/RelativeLoadBalancerTestHelper.java\n\n@@ -17,6 +17,7 @@\n package com.linkedin.d2.balancer.strategies.relative;\n \n import java.net.URI;\n+import java.util.Collections;\n import java.util.Map;\n \n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk3ODQ2NA==", "url": "https://github.com/linkedin/rest.li/pull/347#discussion_r458978464", "bodyText": "We should have an interface to expose pointsMap (not only for testing) because we'll have MBean to expose the values to inGraphs.", "author": "cx-super", "createdAt": "2020-07-22T17:56:03Z", "path": "d2/src/main/java/com/linkedin/d2/balancer/strategies/relative/RelativeLoadBalancerTestHelper.java", "diffHunk": "@@ -0,0 +1,39 @@\n+/*\n+   Copyright (c) 2020 LinkedIn Corp.\n+\n+   Licensed under the Apache License, Version 2.0 (the \"License\");\n+   you may not use this file except in compliance with the License.\n+   You may obtain a copy of the License at\n+\n+       http://www.apache.org/licenses/LICENSE-2.0\n+\n+   Unless required by applicable law or agreed to in writing, software\n+   distributed under the License is distributed on an \"AS IS\" BASIS,\n+   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+   See the License for the specific language governing permissions and\n+   limitations under the License.\n+*/\n+\n+package com.linkedin.d2.balancer.strategies.relative;\n+\n+import java.net.URI;\n+import java.util.Map;\n+\n+\n+/**\n+ * The helper class for {@link RelativeLoadBalancerStrategy} related tests\n+ */\n+public class RelativeLoadBalancerTestHelper {\n+\n+  /**\n+   * Get points map for a given partition\n+   *\n+   * @param strategy The object of the strategy\n+   * @param partitionId The id of the partition\n+   * @return The points map\n+   */\n+  public static Map<URI, Integer> getPointsMap(RelativeLoadBalancerStrategy strategy, int partitionId)", "originalCommit": "f7e6bf9819f5b37567dc6b0203094d4cb3d4baaa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAwODczMw==", "url": "https://github.com/linkedin/rest.li/pull/347#discussion_r459008733", "bodyText": "I'm actually thinking about if the points are really meaningful to be collected in the inGraph, for now I prefer not adding points into the inGraph any more, simply because I did not see much value to give the total points of a ring. I started a doc to add some new monitors: https://docs.google.com/document/d/19DpiTNuzXpdSaK-kYPRYg9RJenxJfuIy5zYX_l_1gtA/edit#heading=h.r3ucjtwt0vl4, I will spend some time discuss with you and other folks on the inGraphs to be added.\nIf this is only for testing, I don't want to expose it as an interface.", "author": "rachelhanhan", "createdAt": "2020-07-22T18:47:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk3ODQ2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAyMTQyNQ==", "url": "https://github.com/linkedin/rest.li/pull/347#discussion_r459021425", "bodyText": "If you want to remove this one, it'll still be good to have something to replace.\nThe total points can reflect the internal state changes that we do not necessarily see just from the latency ingraphs. For example, we can see if the client degrades some hosts, or if the servers never got out of slowStart state. Just looking into error rate or latency will not get your idea. Also note that ingraphs has the granularity of 1 min, while d2 update state update every 5s. Some times the difference can reflect some minor changes.", "author": "cx-super", "createdAt": "2020-07-22T19:09:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk3ODQ2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAzODAzMQ==", "url": "https://github.com/linkedin/rest.li/pull/347#discussion_r459038031", "bodyText": "I'm thinking about adding the number of unhealthy hosts (any host that has health score < 1 would count) in the inGraph.\nPreviously it uses total points in hash ring, which does not tell how many hosts have total points less than 100, the total points just does not make sense to me. We can also discuss more about this offline.", "author": "rachelhanhan", "createdAt": "2020-07-22T19:40:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk3ODQ2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA3OTg4MQ==", "url": "https://github.com/linkedin/rest.li/pull/347#discussion_r459079881", "bodyText": "Number of unhealthy hosts are good, but it cannot reflect how fast the servers are changing (degrade/recover). You may consider to add those metrics as well.", "author": "cx-super", "createdAt": "2020-07-22T20:59:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk3ODQ2NA=="}], "type": "inlineReview", "revised_code": {"commit": "1d4c263975dc9a37abddc518633b0ef1fff6050b", "chunk": "diff --git a/d2/src/main/java/com/linkedin/d2/balancer/strategies/relative/RelativeLoadBalancerTestHelper.java b/d2/src/main/java/com/linkedin/d2/balancer/strategies/relative/RelativeLoadBalancerTestHelper.java\nindex fb0c8ae44..c6305efb5 100644\n--- a/d2/src/main/java/com/linkedin/d2/balancer/strategies/relative/RelativeLoadBalancerTestHelper.java\n+++ b/d2/src/main/java/com/linkedin/d2/balancer/strategies/relative/RelativeLoadBalancerTestHelper.java\n\n@@ -17,6 +17,7 @@\n package com.linkedin.d2.balancer.strategies.relative;\n \n import java.net.URI;\n+import java.util.Collections;\n import java.util.Map;\n \n \n"}}, {"oid": "1d4c263975dc9a37abddc518633b0ef1fff6050b", "url": "https://github.com/linkedin/rest.li/commit/1d4c263975dc9a37abddc518633b0ef1fff6050b", "message": "Use unmodified map for point map", "committedDate": "2020-07-23T05:26:16Z", "type": "commit"}]}