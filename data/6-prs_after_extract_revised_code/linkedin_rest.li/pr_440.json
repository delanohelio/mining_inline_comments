{"pr_number": 440, "pr_title": "Adding dark response validation metrics", "pr_createdAt": "2020-10-07T02:53:58Z", "pr_url": "https://github.com/linkedin/rest.li/pull/440", "timeline": [{"oid": "1ef412f3c11400c3529d744a289eaf450a2da519", "url": "https://github.com/linkedin/rest.li/commit/1ef412f3c11400c3529d744a289eaf450a2da519", "message": "[darkcluster] Adding identical traffic multiplier strategy", "committedDate": "2020-07-30T21:19:20Z", "type": "commit"}, {"oid": "ee09c898fb75b9cfb3e7e2a0e061b69fc222465c", "url": "https://github.com/linkedin/rest.li/commit/ee09c898fb75b9cfb3e7e2a0e061b69fc222465c", "message": "[darkcluster] Adding identical traffic multiplier strategy", "committedDate": "2020-07-31T01:32:25Z", "type": "commit"}, {"oid": "0fe84dba85315eebaa989fd306766499e86911d1", "url": "https://github.com/linkedin/rest.li/commit/0fe84dba85315eebaa989fd306766499e86911d1", "message": "Add gradle property to skip generateRestModel task (#362)", "committedDate": "2020-08-04T17:21:10Z", "type": "commit"}, {"oid": "9916eab00528bf26af5e84c660b59c69eca91c97", "url": "https://github.com/linkedin/rest.li/commit/9916eab00528bf26af5e84c660b59c69eca91c97", "message": "Implement support for always projecting fields by name. (#358)\n\n* Release 29.4.7", "committedDate": "2020-08-04T17:23:08Z", "type": "commit"}, {"oid": "3f3559a3f61d657a5e0c43e9b16d92f8729a1816", "url": "https://github.com/linkedin/rest.li/commit/3f3559a3f61d657a5e0c43e9b16d92f8729a1816", "message": "[darkcluster] Adding identical traffic multiplier strategy", "committedDate": "2020-08-04T17:24:19Z", "type": "commit"}, {"oid": "090f1a9d810a3830c080454a3e0679aafa9618a6", "url": "https://github.com/linkedin/rest.li/commit/090f1a9d810a3830c080454a3e0679aafa9618a6", "message": "[darkcluster] Adding identical traffic multiplier strategy", "committedDate": "2020-08-04T17:24:20Z", "type": "commit"}, {"oid": "901639b8d7689081f4b846fad4cca3b1169b49aa", "url": "https://github.com/linkedin/rest.li/commit/901639b8d7689081f4b846fad4cca3b1169b49aa", "message": "Merge remote-tracking branch 'upstream/master' into master", "committedDate": "2020-08-04T17:30:13Z", "type": "commit"}, {"oid": "ac220fac4a770d80a82262d068694eb9de03ea0e", "url": "https://github.com/linkedin/rest.li/commit/ac220fac4a770d80a82262d068694eb9de03ea0e", "message": "Merge remote-tracking branch 'upstream/master' into master", "committedDate": "2020-08-04T17:38:42Z", "type": "commit"}, {"oid": "40b11c3f232affd887d9a0d569d0b8c7f776703b", "url": "https://github.com/linkedin/rest.li/commit/40b11c3f232affd887d9a0d569d0b8c7f776703b", "message": "Merge branch 'master' of github.com:srikrish-19/rest.li into master", "committedDate": "2020-08-04T17:44:04Z", "type": "commit"}, {"oid": "4e48e44c9f91bad387d4015710168692110fd25b", "url": "https://github.com/linkedin/rest.li/commit/4e48e44c9f91bad387d4015710168692110fd25b", "message": "Merge branch 'master' of github.com:srikrish-19/rest.li into master", "committedDate": "2020-08-04T18:17:29Z", "type": "commit"}, {"oid": "9cc3957d0d6d8100cdb4c57d9a3a4c5ea8fe8e79", "url": "https://github.com/linkedin/rest.li/commit/9cc3957d0d6d8100cdb4c57d9a3a4c5ea8fe8e79", "message": "darkcluster - identical traffic multiplier: Adding the formula for avg # of dark requests", "committedDate": "2020-08-04T18:17:39Z", "type": "commit"}, {"oid": "478fa28e9a7acdc45c314e26fd751d614aad0eab", "url": "https://github.com/linkedin/rest.li/commit/478fa28e9a7acdc45c314e26fd751d614aad0eab", "message": "Merge branch 'master' of github.com:srikrish-19/rest.li into master", "committedDate": "2020-08-04T18:18:37Z", "type": "commit"}, {"oid": "d60568b5a6d391cdf1fcec170de90951e8eaf263", "url": "https://github.com/linkedin/rest.li/commit/d60568b5a6d391cdf1fcec170de90951e8eaf263", "message": "updating changelog", "committedDate": "2020-08-04T21:30:20Z", "type": "commit"}, {"oid": "96a843e233e6479da2b7d9ac3d5ee628f7027b9a", "url": "https://github.com/linkedin/rest.li/commit/96a843e233e6479da2b7d9ac3d5ee628f7027b9a", "message": "Merge remote-tracking branch 'upstream/master' into master", "committedDate": "2020-08-07T18:41:09Z", "type": "commit"}, {"oid": "23ab8d1e639966f926fc42ec138c872a4590ba44", "url": "https://github.com/linkedin/rest.li/commit/23ab8d1e639966f926fc42ec138c872a4590ba44", "message": "Merge remote-tracking branch 'upstream/master' into master", "committedDate": "2020-08-20T17:59:59Z", "type": "commit"}, {"oid": "fe25d7edd334e783f377a260353c9fd8884dc05c", "url": "https://github.com/linkedin/rest.li/commit/fe25d7edd334e783f377a260353c9fd8884dc05c", "message": "Adding ability to let users determine if a request should be dispatched to dark clusters", "committedDate": "2020-08-20T19:20:01Z", "type": "commit"}, {"oid": "7e8a0fb518c32a56354ff100cf9e01345ceb64ae", "url": "https://github.com/linkedin/rest.li/commit/7e8a0fb518c32a56354ff100cf9e01345ceb64ae", "message": "adding some documentation", "committedDate": "2020-08-20T19:29:36Z", "type": "commit"}, {"oid": "3d9d91cc81cfba7ade08afa8d42ad2992abde6ca", "url": "https://github.com/linkedin/rest.li/commit/3d9d91cc81cfba7ade08afa8d42ad2992abde6ca", "message": "Updating changelog", "committedDate": "2020-08-20T19:34:29Z", "type": "commit"}, {"oid": "b862a5d635bf16266893973d68cdfa4fb8308960", "url": "https://github.com/linkedin/rest.li/commit/b862a5d635bf16266893973d68cdfa4fb8308960", "message": "moving interface to api package", "committedDate": "2020-08-20T19:36:32Z", "type": "commit"}, {"oid": "e2979ef6238f5884a2054c272984b79687aba790", "url": "https://github.com/linkedin/rest.li/commit/e2979ef6238f5884a2054c272984b79687aba790", "message": "Fixing dhoa's comments", "committedDate": "2020-08-20T19:53:10Z", "type": "commit"}, {"oid": "4957ee5bd9d84c12557f6f4dffa42c9541efca3e", "url": "https://github.com/linkedin/rest.li/commit/4957ee5bd9d84c12557f6f4dffa42c9541efca3e", "message": "Fixing changelog", "committedDate": "2020-08-20T20:01:31Z", "type": "commit"}, {"oid": "db040d13f9d440fe62f179ad95ce9268a665e3da", "url": "https://github.com/linkedin/rest.li/commit/db040d13f9d440fe62f179ad95ce9268a665e3da", "message": "Merge remote-tracking branch 'upstream/master' into master", "committedDate": "2020-10-06T01:41:57Z", "type": "commit"}, {"oid": "b854d54cd1ee42f5014bd313ca2291eac0fd0ef2", "url": "https://github.com/linkedin/rest.li/commit/b854d54cd1ee42f5014bd313ca2291eac0fd0ef2", "message": "Adding dark cluster response validation metrics", "committedDate": "2020-10-07T02:47:05Z", "type": "commit"}, {"oid": "25bf26a6767c49ac72f997bf7b939e2b94659015", "url": "https://github.com/linkedin/rest.li/commit/25bf26a6767c49ac72f997bf7b939e2b94659015", "message": "Merge remote-tracking branch 'upstream/master' into master", "committedDate": "2020-10-07T02:48:35Z", "type": "commit"}, {"oid": "dfab0a776f576e8ca77bd000b555667f1f762583", "url": "https://github.com/linkedin/rest.li/commit/dfab0a776f576e8ca77bd000b555667f1f762583", "message": "Update changelog for dark cluster response validation metrics", "committedDate": "2020-10-07T02:51:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDcxNDQyNw==", "url": "https://github.com/linkedin/rest.li/pull/440#discussion_r500714427", "bodyText": "The documentation in rest.li should be generic, because this is open source. So, for instance, instead of \"It will be a combination of hostname and instanceId\" say something like \"For example, it can be a combination of the hostname and an instance identifier\".", "author": "davidhoa", "createdAt": "2020-10-07T03:18:46Z", "path": "darkcluster/src/main/java/com/linkedin/darkcluster/api/ResponseValidationMetricsHeader.java", "diffHunk": "@@ -0,0 +1,122 @@\n+package com.linkedin.darkcluster.api;\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import java.io.IOException;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+\n+/**\n+ * This represents the response validation metrics sent to dark clusters in the form of a request header\n+ * This header stores two fields:\n+ * 1) source: uniquely identifying the instance of the application running on a dispatcher. It will be a combination of hostname and instanceId (i000, i001...)", "originalCommit": "dfab0a776f576e8ca77bd000b555667f1f762583", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3943d1b60fc4a2c655863a81c4d5eb06ba83effc", "chunk": "diff --git a/darkcluster/src/main/java/com/linkedin/darkcluster/api/ResponseValidationMetricsHeader.java b/darkcluster/src/main/java/com/linkedin/darkcluster/api/ResponseValidationMetricsHeader.java\nindex 035536c77..222070ede 100644\n--- a/darkcluster/src/main/java/com/linkedin/darkcluster/api/ResponseValidationMetricsHeader.java\n+++ b/darkcluster/src/main/java/com/linkedin/darkcluster/api/ResponseValidationMetricsHeader.java\n\n@@ -12,7 +12,7 @@ import java.util.Objects;\n /**\n  * This represents the response validation metrics sent to dark clusters in the form of a request header\n  * This header stores two fields:\n- * 1) source: uniquely identifying the instance of the application running on a dispatcher. It will be a combination of hostname and instanceId (i000, i001...)\n+ * 1) source: uniquely identifying the instance of the application running on a dispatcher. For eg: combination of hostname and instance identifier\n  * 2) metrics: the metrics collected so far on the dispatcher\n  * 3) timestamp: when the metrics were updated\n  */\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDcxNTU3Nw==", "url": "https://github.com/linkedin/rest.li/pull/440#discussion_r500715577", "bodyText": "move this to the api package and directory.", "author": "davidhoa", "createdAt": "2020-10-07T03:23:54Z", "path": "darkcluster/src/main/java/com/linkedin/darkcluster/impl/DarkClusterConstants.java", "diffHunk": "@@ -0,0 +1,11 @@\n+package com.linkedin.darkcluster.impl;", "originalCommit": "dfab0a776f576e8ca77bd000b555667f1f762583", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3943d1b60fc4a2c655863a81c4d5eb06ba83effc", "chunk": "diff --git a/darkcluster/src/main/java/com/linkedin/darkcluster/impl/DarkClusterConstants.java b/darkcluster/src/main/java/com/linkedin/darkcluster/api/DarkClusterConstants.java\nsimilarity index 84%\nrename from darkcluster/src/main/java/com/linkedin/darkcluster/impl/DarkClusterConstants.java\nrename to darkcluster/src/main/java/com/linkedin/darkcluster/api/DarkClusterConstants.java\nindex 67a066398..786840aa0 100644\n--- a/darkcluster/src/main/java/com/linkedin/darkcluster/impl/DarkClusterConstants.java\n+++ b/darkcluster/src/main/java/com/linkedin/darkcluster/api/DarkClusterConstants.java\n\n@@ -1,4 +1,4 @@\n-package com.linkedin.darkcluster.impl;\n+package com.linkedin.darkcluster.api;\n \n /**\n  * constants for dark cluster\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDcxNjIxOQ==", "url": "https://github.com/linkedin/rest.li/pull/440#discussion_r500716219", "bodyText": "can you try to add an argument to the rewriteRequest to add the header(s)? Otherwise we are producing intermediate garbage by creating the request and then throwing it away after copying it to create another request.", "author": "davidhoa", "createdAt": "2020-10-07T03:26:34Z", "path": "darkcluster/src/main/java/com/linkedin/darkcluster/impl/DarkClusterManagerImpl.java", "diffHunk": "@@ -102,9 +128,10 @@ public boolean handleDarkRequest(RestRequest originalRequest, RequestContext ori\n         for (String darkClusterName : configMap.keySet())\n         {\n           RestRequest newD2Request = rewriteRequest(reqCopy, darkClusterName);\n+          RestRequest d2RequestWithHeaders = addDarkRequestHeaders(darkClusterName, newD2Request);", "originalCommit": "dfab0a776f576e8ca77bd000b555667f1f762583", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3943d1b60fc4a2c655863a81c4d5eb06ba83effc", "chunk": "diff --git a/darkcluster/src/main/java/com/linkedin/darkcluster/impl/DarkClusterManagerImpl.java b/darkcluster/src/main/java/com/linkedin/darkcluster/impl/DarkClusterManagerImpl.java\nindex 7aec0afc9..5aedeef82 100644\n--- a/darkcluster/src/main/java/com/linkedin/darkcluster/impl/DarkClusterManagerImpl.java\n+++ b/darkcluster/src/main/java/com/linkedin/darkcluster/impl/DarkClusterManagerImpl.java\n\n@@ -128,10 +128,9 @@ public class DarkClusterManagerImpl implements DarkClusterManager\n         for (String darkClusterName : configMap.keySet())\n         {\n           RestRequest newD2Request = rewriteRequest(reqCopy, darkClusterName);\n-          RestRequest d2RequestWithHeaders = addDarkRequestHeaders(darkClusterName, newD2Request);\n           // now find the strategy appropriate for each dark cluster\n           DarkClusterStrategy strategy = _darkClusterStrategyFactory.get(darkClusterName);\n-          darkRequestSent = strategy.handleRequest(reqCopy, d2RequestWithHeaders, newRequestContext);\n+          darkRequestSent = strategy.handleRequest(reqCopy, newD2Request, newRequestContext);\n         }\n \n       }\n"}}, {"oid": "3943d1b60fc4a2c655863a81c4d5eb06ba83effc", "url": "https://github.com/linkedin/rest.li/commit/3943d1b60fc4a2c655863a81c4d5eb06ba83effc", "message": "Fixing @dhoa's comments", "committedDate": "2020-10-07T15:55:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTE5MTU4Ng==", "url": "https://github.com/linkedin/rest.li/pull/440#discussion_r501191586", "bodyText": "this is good, but lets also add a sentence saying why this is a useful feature to have. Something like:\n\"This allows response comparison metrics about a dark cluster to be displayed (via a monitoring/graphing system) with all other system metrics in a dark cluster host. These response comparison metrics are not specific to this dark cluster host, but that should be sufficient for most cases, and further granularity can be achieved by having separate dark clusters.", "author": "davidhoa", "createdAt": "2020-10-07T17:35:58Z", "path": "darkcluster/src/main/java/com/linkedin/darkcluster/api/DarkClusterResponseValidationMetricsCollector.java", "diffHunk": "@@ -0,0 +1,24 @@\n+package com.linkedin.darkcluster.api;\n+\n+import java.util.Map;\n+\n+/**\n+ * Collector of incoming response validation metrics from dispatchers.\n+ * This is meant to be called on the dark cluster hosts where the request headers containing response validation metrics are read.\n+ * A dark cluster host may receive metrics from multiple dispatchers and this interface defines method for collecting these\n+ * incoming metrics.", "originalCommit": "3943d1b60fc4a2c655863a81c4d5eb06ba83effc", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6ceaa1852358b1e8ee73bc6f3a0b5ee632d0a203", "chunk": "diff --git a/darkcluster/src/main/java/com/linkedin/darkcluster/api/DarkClusterResponseValidationMetricsCollector.java b/darkcluster/src/main/java/com/linkedin/darkcluster/api/DarkClusterResponseValidationMetricsCollector.java\nindex 0afbb38dd..85aa35922 100644\n--- a/darkcluster/src/main/java/com/linkedin/darkcluster/api/DarkClusterResponseValidationMetricsCollector.java\n+++ b/darkcluster/src/main/java/com/linkedin/darkcluster/api/DarkClusterResponseValidationMetricsCollector.java\n\n@@ -3,7 +3,11 @@ package com.linkedin.darkcluster.api;\n import java.util.Map;\n \n /**\n- * Collector of incoming response validation metrics from dispatchers.\n+ * Collector of incoming response validation metrics from dispatchers. This allows response comparison metrics about a dark cluster\n+ * to be displayed (via a monitoring/graphing system) with all other system metrics in a dark cluster host.\n+ * These response comparison metrics are not specific to this dark cluster host, but that should be sufficient for most cases,\n+ * and further granularity can be achieved by having separate dark clusters.\n+ *\n  * This is meant to be called on the dark cluster hosts where the request headers containing response validation metrics are read.\n  * A dark cluster host may receive metrics from multiple dispatchers and this interface defines method for collecting these\n  * incoming metrics.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTE5MzU0Mg==", "url": "https://github.com/linkedin/rest.li/pull/440#discussion_r501193542", "bodyText": "check for null in the constructor. If null,  have a no-op/default implementation, so you don't need to check for null later. or, if appropriate, add the Nonnull annotations.", "author": "davidhoa", "createdAt": "2020-10-07T17:39:14Z", "path": "darkcluster/src/main/java/com/linkedin/darkcluster/filter/DarkClusterResponseValidationMetricsReaderFilter.java", "diffHunk": "@@ -0,0 +1,56 @@\n+package com.linkedin.darkcluster.filter;\n+\n+import com.linkedin.darkcluster.api.DarkClusterResponseValidationMetricsCollector;\n+import com.linkedin.darkcluster.api.ResponseValidationMetricsHeader;\n+import com.linkedin.darkcluster.api.DarkClusterConstants;\n+import com.linkedin.r2.filter.NextFilter;\n+import com.linkedin.r2.filter.message.rest.RestFilter;\n+import com.linkedin.r2.message.RequestContext;\n+import com.linkedin.r2.message.rest.RestRequest;\n+import com.linkedin.r2.message.rest.RestResponse;\n+import java.util.Map;\n+import java.util.concurrent.ExecutorService;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+\n+/**\n+ * A filter that is to be enabled only in a dark cluster that is meant to handle response validation metrics\n+ * sent from source\n+ */\n+public class DarkClusterResponseValidationMetricsReaderFilter implements RestFilter {\n+  private final DarkClusterResponseValidationMetricsCollector _metricsCollector;\n+  private final ExecutorService _executorService;\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(DarkClusterResponseValidationMetricsReaderFilter.class);\n+\n+  public DarkClusterResponseValidationMetricsReaderFilter(\n+      DarkClusterResponseValidationMetricsCollector metricsCollector,\n+      ExecutorService executorService) {\n+    _metricsCollector = metricsCollector;", "originalCommit": "3943d1b60fc4a2c655863a81c4d5eb06ba83effc", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6ceaa1852358b1e8ee73bc6f3a0b5ee632d0a203", "chunk": "diff --git a/darkcluster/src/main/java/com/linkedin/darkcluster/filter/DarkClusterResponseValidationMetricsReaderFilter.java b/darkcluster/src/main/java/com/linkedin/darkcluster/filter/DarkClusterResponseValidationMetricsReaderFilter.java\nindex 2316d1fe4..e7d8863b2 100644\n--- a/darkcluster/src/main/java/com/linkedin/darkcluster/filter/DarkClusterResponseValidationMetricsReaderFilter.java\n+++ b/darkcluster/src/main/java/com/linkedin/darkcluster/filter/DarkClusterResponseValidationMetricsReaderFilter.java\n\n@@ -10,6 +10,7 @@ import com.linkedin.r2.message.rest.RestRequest;\n import com.linkedin.r2.message.rest.RestResponse;\n import java.util.Map;\n import java.util.concurrent.ExecutorService;\n+import javax.annotation.Nonnull;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTE5NDU0MA==", "url": "https://github.com/linkedin/rest.li/pull/440#discussion_r501194540", "bodyText": "same here, maybe add Nonnull annotation?", "author": "davidhoa", "createdAt": "2020-10-07T17:40:50Z", "path": "darkcluster/src/main/java/com/linkedin/darkcluster/impl/DarkResponseMetricsHeaderGenerator.java", "diffHunk": "@@ -0,0 +1,56 @@\n+package com.linkedin.darkcluster.impl;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.linkedin.darkcluster.api.DarkClusterConstants;\n+import com.linkedin.darkcluster.api.DarkRequestHeaderGenerator;\n+import com.linkedin.darkcluster.api.DispatcherResponseValidationMetricsHolder;\n+import com.linkedin.darkcluster.api.ResponseValidationMetricsHeader;\n+import java.util.Optional;\n+import java.util.function.Supplier;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+\n+/**\n+ * Impl of {@link DarkRequestHeaderGenerator} for generating headers for dark cluster response validation metrics.\n+ * The header value consists of the serialized form of the validation metrics which the dark cluster can consume.\n+ */\n+public class DarkResponseMetricsHeaderGenerator implements DarkRequestHeaderGenerator {\n+  private final DispatcherResponseValidationMetricsHolder _metricsHolder;\n+  private final Supplier<String> _sourceSupplier;\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(DarkRequestHeaderGenerator.class);\n+\n+  /**\n+   * @param metricsHolder  impl of {@link DispatcherResponseValidationMetricsHolder} to return the metrics aggregated so far\n+   *                       in the dispatcher\n+   * @param sourceSupplier a supplier of source identifier that can uniquely identify a dispatcher instance sending out\n+   *                       validation metrics\n+   */\n+  public DarkResponseMetricsHeaderGenerator(DispatcherResponseValidationMetricsHolder metricsHolder,\n+      Supplier<String> sourceSupplier) {\n+    _metricsHolder = metricsHolder;", "originalCommit": "3943d1b60fc4a2c655863a81c4d5eb06ba83effc", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6ceaa1852358b1e8ee73bc6f3a0b5ee632d0a203", "chunk": "diff --git a/darkcluster/src/main/java/com/linkedin/darkcluster/impl/DarkResponseMetricsHeaderGenerator.java b/darkcluster/src/main/java/com/linkedin/darkcluster/impl/DarkResponseMetricsHeaderGenerator.java\nindex bd23f2d72..b84088612 100644\n--- a/darkcluster/src/main/java/com/linkedin/darkcluster/impl/DarkResponseMetricsHeaderGenerator.java\n+++ b/darkcluster/src/main/java/com/linkedin/darkcluster/impl/DarkResponseMetricsHeaderGenerator.java\n\n@@ -7,6 +7,7 @@ import com.linkedin.darkcluster.api.DispatcherResponseValidationMetricsHolder;\n import com.linkedin.darkcluster.api.ResponseValidationMetricsHeader;\n import java.util.Optional;\n import java.util.function.Supplier;\n+import javax.annotation.Nonnull;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTE5NDkzMA==", "url": "https://github.com/linkedin/rest.li/pull/440#discussion_r501194930", "bodyText": "nonnull on clock.", "author": "davidhoa", "createdAt": "2020-10-07T17:41:30Z", "path": "darkcluster/src/main/java/com/linkedin/darkcluster/impl/DarkResponseValidationMetricsCollectorImpl.java", "diffHunk": "@@ -0,0 +1,228 @@\n+package com.linkedin.darkcluster.impl;\n+\n+import com.linkedin.darkcluster.api.DarkClusterResponseValidationMetricsCollector;\n+import com.linkedin.darkcluster.api.ResponseValidationMetricsHeader;\n+import java.util.Collection;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.locks.Lock;\n+import java.util.concurrent.locks.ReentrantLock;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import com.linkedin.util.clock.Clock;\n+\n+\n+/**\n+ * This is executed on dark cluster where it collects metrics from multiple sources by maintaining an in-memory map of sources to metrics.\n+ * It has two responsibilities:\n+ * 1. Populate the in-memory map with the metrics from incoming request headers. This will be an async call where multiple\n+ * threads may try to aggregate metrics as and when there are incoming dark requests. This ensures that we do not double\n+ * count metrics from the same source.\n+ * 2. A single threaded getter to retrieve the aggregated metrics from across all sources. This is single threaded to ensure\n+ * that the consumer of metrics is always called synchronously so that the consumer receives metrics that are increasing\n+ * monotonically. This is all the more important if the consumer emits ingraph metrics (most consumers use this to emit to ingraphs)\n+ * as counters where counters are meant to be increasing monotonically.\n+ */\n+public class DarkResponseValidationMetricsCollectorImpl implements DarkClusterResponseValidationMetricsCollector {\n+  /**\n+   * this is a a map of source -> metrics where metrics is a map of metric name -> metric value\n+   * Example: host1 -> ((success_count -> 10, failure_count -> 1), 12345L)\n+   */\n+  private final Map<String, Long> _defaultBucketMetrics = new ConcurrentHashMap<>();\n+  private final Map<String, Lock> _sourceLockMap = new ConcurrentHashMap<>();\n+  private final Map<String, MetricsInternal> _internalMetricsMap = new ConcurrentHashMap<>();\n+  private final Object _defaultBucketLock = new Object();\n+  private final Clock _clock;\n+  private final long _collectionFrequencyInMillis;\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(DarkResponseValidationMetricsCollectorImpl.class);\n+\n+  public DarkResponseValidationMetricsCollectorImpl(Clock clock, long collectionFrequencyInMillis) {", "originalCommit": "3943d1b60fc4a2c655863a81c4d5eb06ba83effc", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6ceaa1852358b1e8ee73bc6f3a0b5ee632d0a203", "chunk": "diff --git a/darkcluster/src/main/java/com/linkedin/darkcluster/impl/DarkResponseValidationMetricsCollectorImpl.java b/darkcluster/src/main/java/com/linkedin/darkcluster/impl/DarkResponseValidationMetricsCollectorImpl.java\nindex 32614da34..6cffa80d9 100644\n--- a/darkcluster/src/main/java/com/linkedin/darkcluster/impl/DarkResponseValidationMetricsCollectorImpl.java\n+++ b/darkcluster/src/main/java/com/linkedin/darkcluster/impl/DarkResponseValidationMetricsCollectorImpl.java\n\n@@ -10,6 +10,7 @@ import java.util.concurrent.locks.Lock;\n import java.util.concurrent.locks.ReentrantLock;\n import java.util.stream.Collectors;\n import java.util.stream.Stream;\n+import javax.annotation.Nonnull;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n import com.linkedin.util.clock.Clock;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTE5NTUzNQ==", "url": "https://github.com/linkedin/rest.li/pull/440#discussion_r501195535", "bodyText": "ditto.", "author": "davidhoa", "createdAt": "2020-10-07T17:42:29Z", "path": "darkcluster/src/main/java/com/linkedin/darkcluster/impl/DispatcherResponseValidationMetricsHolderImpl.java", "diffHunk": "@@ -0,0 +1,89 @@\n+package com.linkedin.darkcluster.impl;\n+\n+import com.linkedin.darkcluster.api.DispatcherResponseValidationMetricsHolder;\n+import com.linkedin.darkcluster.api.ResponseValidationMetricsHeader;\n+import java.util.Map;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ConcurrentMap;\n+import java.util.concurrent.atomic.LongAdder;\n+import java.util.function.Function;\n+import java.util.stream.Collectors;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import com.linkedin.util.clock.Clock;\n+\n+\n+/**\n+ * Impl of {@link DispatcherResponseValidationMetricsHolder} which uses in-memory map to store response validation metrics for each\n+ * dark cluster. These metrics are essentially counters which are added up as and when response validation is done.\n+ * This is an object that lives through the course of application's life cycle, incrementing validation metrics over time.\n+ */\n+public class DispatcherResponseValidationMetricsHolderImpl implements DispatcherResponseValidationMetricsHolder {\n+  /**\n+   * this is a a map of dark cluster -> metrics where metrics is a map of metric name -> metric value\n+   * Example: dark_cluster1 -> (success_count -> 10, failure_count -> 1)\n+   */\n+  private final ConcurrentMap<String, ConcurrentMap<String, LongAdder>> _darkClusterToMetricsMap = new ConcurrentHashMap<>();\n+  private final Clock _clock;\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(DispatcherResponseValidationMetricsHolderImpl.class);\n+\n+  public DispatcherResponseValidationMetricsHolderImpl(Clock clock) {", "originalCommit": "3943d1b60fc4a2c655863a81c4d5eb06ba83effc", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6ceaa1852358b1e8ee73bc6f3a0b5ee632d0a203", "chunk": "diff --git a/darkcluster/src/main/java/com/linkedin/darkcluster/impl/DispatcherResponseValidationMetricsHolderImpl.java b/darkcluster/src/main/java/com/linkedin/darkcluster/impl/DispatcherResponseValidationMetricsHolderImpl.java\nindex eca37f594..7aac4e0a5 100644\n--- a/darkcluster/src/main/java/com/linkedin/darkcluster/impl/DispatcherResponseValidationMetricsHolderImpl.java\n+++ b/darkcluster/src/main/java/com/linkedin/darkcluster/impl/DispatcherResponseValidationMetricsHolderImpl.java\n\n@@ -8,6 +8,7 @@ import java.util.concurrent.ConcurrentMap;\n import java.util.concurrent.atomic.LongAdder;\n import java.util.function.Function;\n import java.util.stream.Collectors;\n+import javax.annotation.Nonnull;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n import com.linkedin.util.clock.Clock;\n"}}, {"oid": "6ceaa1852358b1e8ee73bc6f3a0b5ee632d0a203", "url": "https://github.com/linkedin/rest.li/commit/6ceaa1852358b1e8ee73bc6f3a0b5ee632d0a203", "message": "Adding nonnull annotations", "committedDate": "2020-10-07T21:54:21Z", "type": "commit"}, {"oid": "5770d5de25623b45fc047f00b73db99e81491265", "url": "https://github.com/linkedin/rest.li/commit/5770d5de25623b45fc047f00b73db99e81491265", "message": "Adding nonnull annotations", "committedDate": "2020-10-07T23:14:02Z", "type": "commit"}, {"oid": "13f5a943ec62a0780e640875af4e35c2662cd329", "url": "https://github.com/linkedin/rest.li/commit/13f5a943ec62a0780e640875af4e35c2662cd329", "message": "Changing docs", "committedDate": "2020-10-07T23:14:46Z", "type": "commit"}, {"oid": "6ce0872642c44c4633e0ae354d297e128b12b01f", "url": "https://github.com/linkedin/rest.li/commit/6ce0872642c44c4633e0ae354d297e128b12b01f", "message": "Merge branch 'master' of github.com:srikrish-19/rest.li into master", "committedDate": "2020-10-07T23:15:14Z", "type": "commit"}, {"oid": "55a637e5971a9634a8095e2d1246315090f6702a", "url": "https://github.com/linkedin/rest.li/commit/55a637e5971a9634a8095e2d1246315090f6702a", "message": "fixing UTs", "committedDate": "2020-10-08T00:06:27Z", "type": "commit"}]}