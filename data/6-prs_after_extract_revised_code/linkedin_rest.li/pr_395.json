{"pr_number": 395, "pr_title": "Fix an issue where NullPointerException is raised when excluded hosts hint is not set at retry", "pr_createdAt": "2020-08-26T22:01:31Z", "pr_url": "https://github.com/linkedin/rest.li/pull/395", "timeline": [{"oid": "1b31d8abfe38454fcbea8835c7a2162215b5f0b9", "url": "https://github.com/linkedin/rest.li/commit/1b31d8abfe38454fcbea8835c7a2162215b5f0b9", "message": "NullPointerException is thrown when excluded hosts hint is not set at retry", "committedDate": "2020-08-26T21:55:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzY5NjkxNQ==", "url": "https://github.com/linkedin/rest.li/pull/395#discussion_r477696915", "bodyText": "How about \"Excluded hosts hint for retry is not set or is empty. This failed request will not be retried.\" ?", "author": "nizarm", "createdAt": "2020-08-26T23:45:18Z", "path": "d2/src/main/java/com/linkedin/d2/balancer/clients/RetryClient.java", "diffHunk": "@@ -225,16 +225,23 @@ public void onError(Throwable e)\n         if (targetHostUri == null)\n         {\n           Set<URI> exclusionSet = ExcludedHostHints.getRequestContextExcludedHosts(_context);\n-          int attempts = exclusionSet.size();\n-          if (attempts <= _limit)\n+          if (exclusionSet == null || exclusionSet.isEmpty())\n           {\n-            LOG.warn(\"A retriable exception happens. Going to retry. This is attempt {}. Current exclusion set: \",\n-                attempts, \". Current exclusion set: \" + exclusionSet);\n-            retry = doRetryRequest(_request, _context);\n+            LOG.warn(\"Excluded hosts hint for retry is not set or is empty. This request will fail.\");", "originalCommit": "1b31d8abfe38454fcbea8835c7a2162215b5f0b9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Nzc4MDE3OA==", "url": "https://github.com/linkedin/rest.li/pull/395#discussion_r477780178", "bodyText": "Sure, it's clearer.", "author": "rickzx", "createdAt": "2020-08-27T00:33:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzY5NjkxNQ=="}], "type": "inlineReview", "revised_code": {"commit": "b4f05b92c6edc42ae0ac55c50e8c1fb2ecb5c0be", "chunk": "diff --git a/d2/src/main/java/com/linkedin/d2/balancer/clients/RetryClient.java b/d2/src/main/java/com/linkedin/d2/balancer/clients/RetryClient.java\nindex 684dc3bb8..db351488e 100644\n--- a/d2/src/main/java/com/linkedin/d2/balancer/clients/RetryClient.java\n+++ b/d2/src/main/java/com/linkedin/d2/balancer/clients/RetryClient.java\n\n@@ -227,7 +227,7 @@ public class RetryClient extends D2ClientDelegator\n           Set<URI> exclusionSet = ExcludedHostHints.getRequestContextExcludedHosts(_context);\n           if (exclusionSet == null || exclusionSet.isEmpty())\n           {\n-            LOG.warn(\"Excluded hosts hint for retry is not set or is empty. This request will fail.\");\n+            LOG.warn(\"Excluded hosts hint for retry is not set or is empty. This failed request will not be retried.\");\n           }\n           else\n           {\n"}}, {"oid": "b4f05b92c6edc42ae0ac55c50e8c1fb2ecb5c0be", "url": "https://github.com/linkedin/rest.li/commit/b4f05b92c6edc42ae0ac55c50e8c1fb2ecb5c0be", "message": "Change the log warning message when exclude host hints is not set", "committedDate": "2020-08-27T00:34:42Z", "type": "commit"}, {"oid": "479f73cc86c1ca846ee991b66617a96613685454", "url": "https://github.com/linkedin/rest.li/commit/479f73cc86c1ca846ee991b66617a96613685454", "message": "Merge branch 'master' into bugfix/retry_client_NPE", "committedDate": "2020-08-27T18:55:07Z", "type": "commit"}, {"oid": "21590e54e1c1cff5c15e0c9041c2ba7670e66241", "url": "https://github.com/linkedin/rest.li/commit/21590e54e1c1cff5c15e0c9041c2ba7670e66241", "message": "Merge branch 'master' into bugfix/retry_client_NPE", "committedDate": "2020-08-28T17:54:16Z", "type": "commit"}, {"oid": "e83b313eef2feda51f5d8b8c6d284658b56492ec", "url": "https://github.com/linkedin/rest.li/commit/e83b313eef2feda51f5d8b8c6d284658b56492ec", "message": "Update changelog", "committedDate": "2020-08-28T19:17:28Z", "type": "commit"}]}