{"pr_number": 403, "pr_title": "Update ExtensionSchemaValidationCmdLineApp with more validations", "pr_createdAt": "2020-09-02T19:48:12Z", "pr_url": "https://github.com/linkedin/rest.li/pull/403", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc2NzIzNw==", "url": "https://github.com/linkedin/rest.li/pull/403#discussion_r482767237", "bodyText": "Maybe give some hint in the beginning, just like the previous parseexception, so when see the log, we know clearly this is from extension schema validator", "author": "BrianPin", "createdAt": "2020-09-03T07:32:40Z", "path": "restli-tools/src/main/java/com/linkedin/restli/tools/data/ExtensionSchemaValidationCmdLineApp.java", "diffHunk": "@@ -112,44 +124,58 @@ public static void main(String[] args) throws Exception\n       _logger.error(\"Invalid arguments: \" + e.getMessage());\n       System.exit(1);\n     }\n+    catch (InvalidExtensionSchemaException e)\n+    {\n+      _logger.error(e.getMessage());", "originalCommit": "5dd0f2141815cda3f211ff3f69279a87ed6e476c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzI5MzgyMw==", "url": "https://github.com/linkedin/rest.li/pull/403#discussion_r483293823", "bodyText": "Fixed", "author": "nickibi", "createdAt": "2020-09-03T22:50:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc2NzIzNw=="}], "type": "inlineReview", "revised_code": {"commit": "72e486df73bcbd731af883758e4a5b79a1b19059", "chunk": "diff --git a/restli-tools/src/main/java/com/linkedin/restli/tools/data/ExtensionSchemaValidationCmdLineApp.java b/restli-tools/src/main/java/com/linkedin/restli/tools/data/ExtensionSchemaValidationCmdLineApp.java\nindex e44d31b29..f4c903c81 100644\n--- a/restli-tools/src/main/java/com/linkedin/restli/tools/data/ExtensionSchemaValidationCmdLineApp.java\n+++ b/restli-tools/src/main/java/com/linkedin/restli/tools/data/ExtensionSchemaValidationCmdLineApp.java\n\n@@ -126,7 +126,7 @@ public class ExtensionSchemaValidationCmdLineApp\n     }\n     catch (InvalidExtensionSchemaException e)\n     {\n-      _logger.error(e.getMessage());\n+      _logger.error(\"Invalid extension schema: \" + e.getMessage());\n       System.exit(1);\n     }\n   }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc2ODQxMg==", "url": "https://github.com/linkedin/rest.li/pull/403#discussion_r482768412", "bodyText": "new line", "author": "BrianPin", "createdAt": "2020-09-03T07:34:53Z", "path": "restli-tools/src/main/java/com/linkedin/restli/tools/data/ExtensionSchemaValidationCmdLineApp.java", "diffHunk": "@@ -179,48 +205,101 @@ private static void checkExtensionSchemaFields(List<RecordDataSchema.Field> exte\n       {\n         if (!(dataElement instanceof DataMap))\n         {\n-          _logger.error(\"Extension schema annotation is not a datamap!\");\n-          System.exit(1);\n+          throw new InvalidExtensionSchemaException(\"Extension schema annotation is not a datamap!\");\n         }\n         DataSchema extensionSchemaAnnotationSchema = new ExtensionSchemaAnnotation().schema();\n         ValidationResult result = ValidateDataAgainstSchema.validate(dataElement, extensionSchemaAnnotationSchema, validationOptions);\n         if (!result.isValid())\n         {\n-          _logger.error(\"Extension schema annotation is not valid: \" + result.getMessages());\n-          System.exit(1);\n+          throw new InvalidExtensionSchemaException(\"Extension schema annotation is not valid: \" + result.getMessages());\n         }\n       }\n+      catch (InvalidExtensionSchemaException e)\n+      {\n+        throw e;\n+      }\n       catch (Exception e)\n       {\n         _logger.error(\"Error while checking extension schema field annotation: \" + e.getMessage());\n         System.exit(1);\n       }\n+      checkExtensionSchemaFieldSchema(field.getType(), properties);\n     }\n   }\n \n-  private static void checkExtensionSchemaFieldSchema(DataSchema fieldSchema)\n+  private static void checkExtensionSchemaFieldSchema(DataSchema fieldSchema, Map<String, Object> extensionAnnotations)\n+      throws InvalidExtensionSchemaException\n   {\n-    if (!isAnnotatedWithResourceKey(fieldSchema) && !arrayAndItemIsAnnotatedWithResourceKey(fieldSchema))\n+    checkExtensionSchemaFieldSchemaType(fieldSchema);\n+    if (!isAnnotatedWithResourceKey(fieldSchema, extensionAnnotations) && !arrayAndItemIsAnnotatedWithResourceKey(fieldSchema, extensionAnnotations))\n     {\n-        _logger.error(\"Field schema: [{}] is not annotated with 'resourceKey'\", fieldSchema.toString());\n-        System.exit(1);\n+       throw new InvalidExtensionSchemaException(\"Field schema: \" + fieldSchema.toString() + \" is not annotated with 'resourceKey'\");\n     }\n   }\n \n-  private static boolean arrayAndItemIsAnnotatedWithResourceKey(DataSchema schema)\n+  private static void checkExtensionSchemaFieldSchemaType(DataSchema fieldSchema)\n+      throws InvalidExtensionSchemaException\n+  {\n+    if (fieldSchema.getType() == DataSchema.Type.ARRAY) {", "originalCommit": "5dd0f2141815cda3f211ff3f69279a87ed6e476c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzI5Mzg4Ng==", "url": "https://github.com/linkedin/rest.li/pull/403#discussion_r483293886", "bodyText": "Fixed", "author": "nickibi", "createdAt": "2020-09-03T22:50:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc2ODQxMg=="}], "type": "inlineReview", "revised_code": {"commit": "72e486df73bcbd731af883758e4a5b79a1b19059", "chunk": "diff --git a/restli-tools/src/main/java/com/linkedin/restli/tools/data/ExtensionSchemaValidationCmdLineApp.java b/restli-tools/src/main/java/com/linkedin/restli/tools/data/ExtensionSchemaValidationCmdLineApp.java\nindex e44d31b29..f4c903c81 100644\n--- a/restli-tools/src/main/java/com/linkedin/restli/tools/data/ExtensionSchemaValidationCmdLineApp.java\n+++ b/restli-tools/src/main/java/com/linkedin/restli/tools/data/ExtensionSchemaValidationCmdLineApp.java\n\n@@ -240,7 +240,8 @@ public class ExtensionSchemaValidationCmdLineApp\n   private static void checkExtensionSchemaFieldSchemaType(DataSchema fieldSchema)\n       throws InvalidExtensionSchemaException\n   {\n-    if (fieldSchema.getType() == DataSchema.Type.ARRAY) {\n+    if (fieldSchema.getType() == DataSchema.Type.ARRAY)\n+    {\n       fieldSchema = ((ArrayDataSchema) fieldSchema).getItems();\n     }\n     if (fieldSchema.getType() != DataSchema.Type.TYPEREF)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc3MDU5Mw==", "url": "https://github.com/linkedin/rest.li/pull/403#discussion_r482770593", "bodyText": "new line", "author": "BrianPin", "createdAt": "2020-09-03T07:38:21Z", "path": "restli-tools/src/test/java/com/linkedin/restli/tools/data/TestExtensionSchemaValidationCmdLineApp.java", "diffHunk": "@@ -0,0 +1,98 @@\n+/*\n+   Copyright (c) 2020 LinkedIn Corp.\n+\n+   Licensed under the Apache License, Version 2.0 (the \"License\");\n+   you may not use this file except in compliance with the License.\n+   You may obtain a copy of the License at\n+\n+       http://www.apache.org/licenses/LICENSE-2.0\n+\n+   Unless required by applicable law or agreed to in writing, software\n+   distributed under the License is distributed on an \"AS IS\" BASIS,\n+   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+   See the License for the specific language governing permissions and\n+   limitations under the License.\n+*/\n+package com.linkedin.restli.tools.data;\n+\n+import java.io.File;\n+\n+import org.testng.Assert;\n+import org.testng.annotations.DataProvider;\n+import org.testng.annotations.Test;\n+\n+\n+public class TestExtensionSchemaValidationCmdLineApp {", "originalCommit": "5dd0f2141815cda3f211ff3f69279a87ed6e476c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzI5NDA2NA==", "url": "https://github.com/linkedin/rest.li/pull/403#discussion_r483294064", "bodyText": "Fixed", "author": "nickibi", "createdAt": "2020-09-03T22:51:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc3MDU5Mw=="}], "type": "inlineReview", "revised_code": {"commit": "72e486df73bcbd731af883758e4a5b79a1b19059", "chunk": "diff --git a/restli-tools/src/test/java/com/linkedin/restli/tools/data/TestExtensionSchemaValidationCmdLineApp.java b/restli-tools/src/test/java/com/linkedin/restli/tools/data/TestExtensionSchemaValidationCmdLineApp.java\nindex 678e0293c..f58d05fd8 100644\n--- a/restli-tools/src/test/java/com/linkedin/restli/tools/data/TestExtensionSchemaValidationCmdLineApp.java\n+++ b/restli-tools/src/test/java/com/linkedin/restli/tools/data/TestExtensionSchemaValidationCmdLineApp.java\n\n@@ -22,7 +22,8 @@ import org.testng.annotations.DataProvider;\n import org.testng.annotations.Test;\n \n \n-public class TestExtensionSchemaValidationCmdLineApp {\n+public class TestExtensionSchemaValidationCmdLineApp\n+{\n   private String testDir = System.getProperty(\"testDir\", new File(\"src/test\").getAbsolutePath());\n   private String testPegasusDir = testDir + File.separator + \"pegasus\";\n   private String testExtensionDir = testDir + File.separator + \"extensions\";\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzIwNjAyMg==", "url": "https://github.com/linkedin/rest.li/pull/403#discussion_r483206022", "bodyText": "Rephrasing suggestions for clarity:\n\nI don't understand what this means. What is a validate schema? Is this supposed to say valid schema?\nMakes sense. (nit: replace hyphen - with colon :)\nI would use a definite article like can only include the base schema to imply that there is only one base schema for an extension.\nWhat does it mean to be annotation by a namespace? Does this mean to say all field annotation keys must be in the extension namespace? (nit: be careful of the distinction between \"should\" and \"must\")\nIt would be more accurate to say that the annotations \"must conform to {@link ExtensionSchemaAnnotation}\" (nit: be careful of the distinction between \"should\" and \"must\")\nMakes sense.\nSimilar comment as in bullet 4.\nClarify which resourceKey annotation. Corresponding to what? (nit: remove the hyphen -)\n\nAlso, in the text at the top, nit: to validate extension schema -> to validate extension schemas", "author": "evanw555", "createdAt": "2020-09-03T19:27:35Z", "path": "restli-tools/src/main/java/com/linkedin/restli/tools/data/ExtensionSchemaValidationCmdLineApp.java", "diffHunk": "@@ -53,9 +58,13 @@\n /**\n  * This class is used to validate extension schema, the validation covers following parts:", "originalCommit": "5dd0f2141815cda3f211ff3f69279a87ed6e476c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzI5Mzc4MA==", "url": "https://github.com/linkedin/rest.li/pull/403#discussion_r483293780", "bodyText": "Fixed", "author": "nickibi", "createdAt": "2020-09-03T22:50:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzIwNjAyMg=="}], "type": "inlineReview", "revised_code": {"commit": "72e486df73bcbd731af883758e4a5b79a1b19059", "chunk": "diff --git a/restli-tools/src/main/java/com/linkedin/restli/tools/data/ExtensionSchemaValidationCmdLineApp.java b/restli-tools/src/main/java/com/linkedin/restli/tools/data/ExtensionSchemaValidationCmdLineApp.java\nindex e44d31b29..f4c903c81 100644\n--- a/restli-tools/src/main/java/com/linkedin/restli/tools/data/ExtensionSchemaValidationCmdLineApp.java\n+++ b/restli-tools/src/main/java/com/linkedin/restli/tools/data/ExtensionSchemaValidationCmdLineApp.java\n\n@@ -56,15 +56,15 @@ import org.slf4j.LoggerFactory;\n \n \n /**\n- * This class is used to validate extension schema, the validation covers following parts:\n- * 1. The extension schema is a validate schema.\n- * 2. The extension schema name has to follow the naming convention - <baseSchemaName> + \"Extensions\"\n- * 3. The extension schema can only include base schema\n- * 4. The extension schema's fields should only be annotated by \"extension\" namespace.\n- * 5. The extension schema's fields annotations should be {@link ExtensionSchemaAnnotation}.\n+ * This class is used to validate extension schemas, the validation covers following parts:\n+ * 1. The extension schema is a valid schema.\n+ * 2. The extension schema name has to follow the naming convention: <baseSchemaName> + \"Extensions\"\n+ * 3. The extension schema can only include the base schema.\n+ * 4. The extension schema all field annotation keys must be in the \"extension\" namespace\n+ * 5. The extension schema's fields annotations must conform to {@link ExtensionSchemaAnnotation}.\n  * 6. The extension schema's fields can only be Typeref or array of Typeref\n- * 7. The extension schema's field's schema only be annotated by \"resourceKey\" namespace.\n- * 8. The extension schema's field's annotation - versionSuffix value has to match the versionSuffix value in \"resourceKey\" annotation.\n+ * 7. The extension schema all field schemas' annotation keys must be in the \"resourceKey\" namespace.\n+ * 8. The extension schema's field annotation versionSuffix value has to match the versionSuffix value in \"resourceKey\" annotation on the field schema.\n  *\n  *\n  * @author Yingjie Bi\n"}}, {"oid": "72e486df73bcbd731af883758e4a5b79a1b19059", "url": "https://github.com/linkedin/rest.li/commit/72e486df73bcbd731af883758e4a5b79a1b19059", "message": "Update ExtensionSchemaValidationCmdLineApp with more validations", "committedDate": "2020-09-03T22:49:06Z", "type": "forcePushed"}, {"oid": "850bcf5dd7b621c2586c83fab4eca3189e872f95", "url": "https://github.com/linkedin/rest.li/commit/850bcf5dd7b621c2586c83fab4eca3189e872f95", "message": "Update ExtensionSchemaValidationCmdLineApp with more validations", "committedDate": "2020-09-04T03:52:26Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ5NDUzMA==", "url": "https://github.com/linkedin/rest.li/pull/403#discussion_r483494530", "bodyText": "move this outside the loop", "author": "karthikbalasub", "createdAt": "2020-09-04T09:14:31Z", "path": "restli-tools/src/main/java/com/linkedin/restli/tools/data/ExtensionSchemaValidationCmdLineApp.java", "diffHunk": "@@ -112,44 +124,58 @@ public static void main(String[] args) throws Exception\n       _logger.error(\"Invalid arguments: \" + e.getMessage());\n       System.exit(1);\n     }\n+    catch (InvalidExtensionSchemaException e)\n+    {\n+      _logger.error(\"Invalid extension schema: \" + e.getMessage());\n+      System.exit(1);\n+    }\n   }\n \n-  private static void parseAndValidateExtensionSchemas(String resolverPath, File inputDir) throws IOException\n-  {\n-    // Parse each extension schema and validate it\n-    Iterator<File> iterator = FileUtils.iterateFiles(inputDir, new String[]{PDL}, true);\n-    while(iterator.hasNext())\n-    {\n-      File inputFile = iterator.next();\n-      DataSchemaResolver resolver = MultiFormatDataSchemaResolver.withBuiltinFormats(resolverPath);\n-      PdlSchemaParser parser = new PdlSchemaParser(resolver);\n-      parser.parse(new FileInputStream(inputFile));\n-      if (parser.hasError())\n-      {\n-        _logger.error(parser.errorMessage());\n-        System.exit(1);\n-      }\n+ static void parseAndValidateExtensionSchemas(String resolverPath, File inputDir)\n+     throws IOException, InvalidExtensionSchemaException\n+ {\n+   // Parse each extension schema and validate it\n+   Iterator<File> iterator = FileUtils.iterateFiles(inputDir, new String[]{PDL}, true);\n+   while (iterator.hasNext())\n+   {\n+     File inputFile = iterator.next();\n+     DataSchemaResolver resolver = MultiFormatDataSchemaResolver.withBuiltinFormats(resolverPath);", "originalCommit": "850bcf5dd7b621c2586c83fab4eca3189e872f95", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzc3Nzk5NQ==", "url": "https://github.com/linkedin/rest.li/pull/403#discussion_r483777995", "bodyText": "Fixed", "author": "nickibi", "createdAt": "2020-09-04T18:09:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ5NDUzMA=="}], "type": "inlineReview", "revised_code": {"commit": "e9b6784da8238161abf398bec0e0aa8e50da0cf9", "chunk": "diff --git a/restli-tools/src/main/java/com/linkedin/restli/tools/data/ExtensionSchemaValidationCmdLineApp.java b/restli-tools/src/main/java/com/linkedin/restli/tools/data/ExtensionSchemaValidationCmdLineApp.java\nindex 8bddb8976..8d779a8ec 100644\n--- a/restli-tools/src/main/java/com/linkedin/restli/tools/data/ExtensionSchemaValidationCmdLineApp.java\n+++ b/restli-tools/src/main/java/com/linkedin/restli/tools/data/ExtensionSchemaValidationCmdLineApp.java\n\n@@ -136,10 +136,10 @@ public class ExtensionSchemaValidationCmdLineApp\n  {\n    // Parse each extension schema and validate it\n    Iterator<File> iterator = FileUtils.iterateFiles(inputDir, new String[]{PDL}, true);\n+   DataSchemaResolver resolver = MultiFormatDataSchemaResolver.withBuiltinFormats(resolverPath);\n    while (iterator.hasNext())\n    {\n      File inputFile = iterator.next();\n-     DataSchemaResolver resolver = MultiFormatDataSchemaResolver.withBuiltinFormats(resolverPath);\n      PdlSchemaParser parser = new PdlSchemaParser(resolver);\n      parser.parse(new FileInputStream(inputFile));\n      if (parser.hasError())\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ5NjAzMg==", "url": "https://github.com/linkedin/rest.li/pull/403#discussion_r483496032", "bodyText": "This error message might be misleading for Arrays a it would say the Array schema is missing annotation, whereas the correct message is for the array item's type.\nI think you can inline the logic in checkExtensionSchemaFieldSchemaType here, and then just use the modified fieldSchema to call isAnnotatedWithResourceKey\nYou can delete arrayAndItemIsAnnotatedWithResourceKey\nyou should also consider in-lining isAnnotatedWithResourceKey logic. It is odd that at some places you are throwing exception and some methods return boolean.", "author": "karthikbalasub", "createdAt": "2020-09-04T09:17:14Z", "path": "restli-tools/src/main/java/com/linkedin/restli/tools/data/ExtensionSchemaValidationCmdLineApp.java", "diffHunk": "@@ -179,48 +205,102 @@ private static void checkExtensionSchemaFields(List<RecordDataSchema.Field> exte\n       {\n         if (!(dataElement instanceof DataMap))\n         {\n-          _logger.error(\"Extension schema annotation is not a datamap!\");\n-          System.exit(1);\n+          throw new InvalidExtensionSchemaException(\"Extension schema annotation is not a datamap!\");\n         }\n         DataSchema extensionSchemaAnnotationSchema = new ExtensionSchemaAnnotation().schema();\n         ValidationResult result = ValidateDataAgainstSchema.validate(dataElement, extensionSchemaAnnotationSchema, validationOptions);\n         if (!result.isValid())\n         {\n-          _logger.error(\"Extension schema annotation is not valid: \" + result.getMessages());\n-          System.exit(1);\n+          throw new InvalidExtensionSchemaException(\"Extension schema annotation is not valid: \" + result.getMessages());\n         }\n       }\n+      catch (InvalidExtensionSchemaException e)\n+      {\n+        throw e;\n+      }\n       catch (Exception e)\n       {\n         _logger.error(\"Error while checking extension schema field annotation: \" + e.getMessage());\n         System.exit(1);\n       }\n+      checkExtensionSchemaFieldSchema(field.getType(), properties);\n     }\n   }\n \n-  private static void checkExtensionSchemaFieldSchema(DataSchema fieldSchema)\n+  private static void checkExtensionSchemaFieldSchema(DataSchema fieldSchema, Map<String, Object> extensionAnnotations)\n+      throws InvalidExtensionSchemaException\n   {\n-    if (!isAnnotatedWithResourceKey(fieldSchema) && !arrayAndItemIsAnnotatedWithResourceKey(fieldSchema))\n+    checkExtensionSchemaFieldSchemaType(fieldSchema);\n+    if (!isAnnotatedWithResourceKey(fieldSchema, extensionAnnotations) && !arrayAndItemIsAnnotatedWithResourceKey(fieldSchema, extensionAnnotations))\n     {\n-        _logger.error(\"Field schema: [{}] is not annotated with 'resourceKey'\", fieldSchema.toString());\n-        System.exit(1);\n+       throw new InvalidExtensionSchemaException(\"Field schema: \" + fieldSchema.toString() + \" is not annotated with 'resourceKey'\");", "originalCommit": "850bcf5dd7b621c2586c83fab4eca3189e872f95", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzc3ODA4OA==", "url": "https://github.com/linkedin/rest.li/pull/403#discussion_r483778088", "bodyText": "Updated the code based on the suggestion.", "author": "nickibi", "createdAt": "2020-09-04T18:10:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ5NjAzMg=="}], "type": "inlineReview", "revised_code": {"commit": "e9b6784da8238161abf398bec0e0aa8e50da0cf9", "chunk": "diff --git a/restli-tools/src/main/java/com/linkedin/restli/tools/data/ExtensionSchemaValidationCmdLineApp.java b/restli-tools/src/main/java/com/linkedin/restli/tools/data/ExtensionSchemaValidationCmdLineApp.java\nindex 8bddb8976..8d779a8ec 100644\n--- a/restli-tools/src/main/java/com/linkedin/restli/tools/data/ExtensionSchemaValidationCmdLineApp.java\n+++ b/restli-tools/src/main/java/com/linkedin/restli/tools/data/ExtensionSchemaValidationCmdLineApp.java\n\n@@ -230,14 +230,11 @@ public class ExtensionSchemaValidationCmdLineApp\n   private static void checkExtensionSchemaFieldSchema(DataSchema fieldSchema, Map<String, Object> extensionAnnotations)\n       throws InvalidExtensionSchemaException\n   {\n-    checkExtensionSchemaFieldSchemaType(fieldSchema);\n-    if (!isAnnotatedWithResourceKey(fieldSchema, extensionAnnotations) && !arrayAndItemIsAnnotatedWithResourceKey(fieldSchema, extensionAnnotations))\n-    {\n-       throw new InvalidExtensionSchemaException(\"Field schema: \" + fieldSchema.toString() + \" is not annotated with 'resourceKey'\");\n-    }\n+\n+    checkExtensionSchemaFieldSchemaType(fieldSchema, extensionAnnotations);\n   }\n \n-  private static void checkExtensionSchemaFieldSchemaType(DataSchema fieldSchema)\n+  private static void checkExtensionSchemaFieldSchemaType(DataSchema fieldSchema, Map<String, Object> extensionAnnotations)\n       throws InvalidExtensionSchemaException\n   {\n     if (fieldSchema.getType() == DataSchema.Type.ARRAY)\n"}}, {"oid": "e9b6784da8238161abf398bec0e0aa8e50da0cf9", "url": "https://github.com/linkedin/rest.li/commit/e9b6784da8238161abf398bec0e0aa8e50da0cf9", "message": "Update ExtensionSchemaValidationCmdLineApp with more validations", "committedDate": "2020-09-04T18:08:30Z", "type": "forcePushed"}, {"oid": "09fcd201d32496a6a7bc6af02388f183715294d0", "url": "https://github.com/linkedin/rest.li/commit/09fcd201d32496a6a7bc6af02388f183715294d0", "message": "Update ExtensionSchemaValidationCmdLineApp with more validations", "committedDate": "2020-09-04T21:33:53Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzc5OTIyNg==", "url": "https://github.com/linkedin/rest.li/pull/403#discussion_r483799226", "bodyText": "remove this method?", "author": "karthikbalasub", "createdAt": "2020-09-04T19:01:40Z", "path": "restli-tools/src/main/java/com/linkedin/restli/tools/data/ExtensionSchemaValidationCmdLineApp.java", "diffHunk": "@@ -179,48 +205,91 @@ private static void checkExtensionSchemaFields(List<RecordDataSchema.Field> exte\n       {\n         if (!(dataElement instanceof DataMap))\n         {\n-          _logger.error(\"Extension schema annotation is not a datamap!\");\n-          System.exit(1);\n+          throw new InvalidExtensionSchemaException(\"Extension schema annotation is not a datamap!\");\n         }\n         DataSchema extensionSchemaAnnotationSchema = new ExtensionSchemaAnnotation().schema();\n         ValidationResult result = ValidateDataAgainstSchema.validate(dataElement, extensionSchemaAnnotationSchema, validationOptions);\n         if (!result.isValid())\n         {\n-          _logger.error(\"Extension schema annotation is not valid: \" + result.getMessages());\n-          System.exit(1);\n+          throw new InvalidExtensionSchemaException(\"Extension schema annotation is not valid: \" + result.getMessages());\n         }\n       }\n+      catch (InvalidExtensionSchemaException e)\n+      {\n+        throw e;\n+      }\n       catch (Exception e)\n       {\n         _logger.error(\"Error while checking extension schema field annotation: \" + e.getMessage());\n         System.exit(1);\n       }\n+      checkExtensionSchemaFieldSchema(field.getType(), properties);\n     }\n   }\n \n-  private static void checkExtensionSchemaFieldSchema(DataSchema fieldSchema)\n+  private static void checkExtensionSchemaFieldSchema(DataSchema fieldSchema, Map<String, Object> extensionAnnotations)\n+      throws InvalidExtensionSchemaException\n   {\n-    if (!isAnnotatedWithResourceKey(fieldSchema) && !arrayAndItemIsAnnotatedWithResourceKey(fieldSchema))\n+\n+    checkExtensionSchemaFieldSchemaType(fieldSchema, extensionAnnotations);\n+  }", "originalCommit": "e9b6784da8238161abf398bec0e0aa8e50da0cf9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg2MDkxOA==", "url": "https://github.com/linkedin/rest.li/pull/403#discussion_r483860918", "bodyText": "removed", "author": "nickibi", "createdAt": "2020-09-04T21:58:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzc5OTIyNg=="}], "type": "inlineReview", "revised_code": {"commit": "28b5c95f82f578ec5177974c12888cf27b4ace6c", "chunk": "diff --git a/restli-tools/src/main/java/com/linkedin/restli/tools/data/ExtensionSchemaValidationCmdLineApp.java b/restli-tools/src/main/java/com/linkedin/restli/tools/data/ExtensionSchemaValidationCmdLineApp.java\nindex 8d779a8ec..d62daca73 100644\n--- a/restli-tools/src/main/java/com/linkedin/restli/tools/data/ExtensionSchemaValidationCmdLineApp.java\n+++ b/restli-tools/src/main/java/com/linkedin/restli/tools/data/ExtensionSchemaValidationCmdLineApp.java\n\n@@ -230,22 +230,15 @@ public class ExtensionSchemaValidationCmdLineApp\n   private static void checkExtensionSchemaFieldSchema(DataSchema fieldSchema, Map<String, Object> extensionAnnotations)\n       throws InvalidExtensionSchemaException\n   {\n-\n-    checkExtensionSchemaFieldSchemaType(fieldSchema, extensionAnnotations);\n-  }\n-\n-  private static void checkExtensionSchemaFieldSchemaType(DataSchema fieldSchema, Map<String, Object> extensionAnnotations)\n-      throws InvalidExtensionSchemaException\n-  {\n-    if (fieldSchema.getType() == DataSchema.Type.ARRAY)\n-    {\n-      fieldSchema = ((ArrayDataSchema) fieldSchema).getItems();\n-    }\n-    if (fieldSchema.getType() != DataSchema.Type.TYPEREF)\n-    {\n-      throw new InvalidExtensionSchemaException(\"Field schema: '\" + fieldSchema.toString() + \"' is not a TypeRef type.\");\n-    }\n-    isAnnotatedWithResourceKey(fieldSchema, extensionAnnotations);\n+      if (fieldSchema.getType() == DataSchema.Type.ARRAY)\n+      {\n+        fieldSchema = ((ArrayDataSchema) fieldSchema).getItems();\n+      }\n+      if (fieldSchema.getType() != DataSchema.Type.TYPEREF)\n+      {\n+        throw new InvalidExtensionSchemaException(\"Field schema: '\" + fieldSchema.toString() + \"' is not a TypeRef type.\");\n+      }\n+      isAnnotatedWithResourceKey(fieldSchema, extensionAnnotations);\n   }\n \n   private static void isAnnotatedWithResourceKey(DataSchema fieldSchema, Map<String, Object> extensionAnnotations)\n"}}, {"oid": "28b5c95f82f578ec5177974c12888cf27b4ace6c", "url": "https://github.com/linkedin/rest.li/commit/28b5c95f82f578ec5177974c12888cf27b4ace6c", "message": "Update ExtensionSchemaValidationCmdLineApp with more validations", "committedDate": "2020-09-04T21:57:04Z", "type": "forcePushed"}, {"oid": "a10d4a5c10b621e90707663eac3a71b256e70b0e", "url": "https://github.com/linkedin/rest.li/commit/a10d4a5c10b621e90707663eac3a71b256e70b0e", "message": "Update ExtensionSchemaValidationCmdLineApp with more validations", "committedDate": "2020-09-04T22:59:15Z", "type": "commit"}, {"oid": "a10d4a5c10b621e90707663eac3a71b256e70b0e", "url": "https://github.com/linkedin/rest.li/commit/a10d4a5c10b621e90707663eac3a71b256e70b0e", "message": "Update ExtensionSchemaValidationCmdLineApp with more validations", "committedDate": "2020-09-04T22:59:15Z", "type": "forcePushed"}]}