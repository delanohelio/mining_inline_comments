{"pr_number": 413, "pr_title": "Remove final from nested generated classes.", "pr_createdAt": "2020-09-09T03:22:32Z", "pr_url": "https://github.com/linkedin/rest.li/pull/413", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTMzODY1MQ==", "url": "https://github.com/linkedin/rest.li/pull/413#discussion_r485338651", "bodyText": "Is this safe?\nI remember that when I removed finality of DataMap a bunch of stuff failed subtly because of == class comparison checks instead of instanceof. I suspect similar issues (that are even harder to track) may exist with these classes.", "author": "karthikrg", "createdAt": "2020-09-09T04:59:18Z", "path": "generator/src/main/java/com/linkedin/pegasus/generator/TemplateSpecGenerator.java", "diffHunk": "@@ -792,7 +792,7 @@ private ClassInfo classInfoForUnnamed(ClassTemplateSpec enclosingClass, String n\n         // enclosingClass flag indicates whether a class is nested or not.\n         classTemplateSpec.setEnclosingClass(enclosingClass);\n         classTemplateSpec.setClassName(classInfo.name);\n-        classTemplateSpec.setModifiers(ModifierSpec.PUBLIC, ModifierSpec.STATIC, ModifierSpec.FINAL);\n+        classTemplateSpec.setModifiers(ModifierSpec.PUBLIC, ModifierSpec.STATIC);", "originalCommit": "c9f81f78f3ca7b58b9fa397acab4f6e04db2ebda", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTQwODE3Nw==", "url": "https://github.com/linkedin/rest.li/pull/413#discussion_r485408177", "bodyText": "good point, RecordTemplate::putWrapped expects the object's class to be same as the generated class. So you can't put an object created by extending the generated class in a record (or other generated types).\nHowever, the code-gen already generates non-final classes for Arrays, Maps and Typerefs (including union typerefs). So I think this PR is not changing the behavior that much.", "author": "karthikbalasub", "createdAt": "2020-09-09T07:49:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTMzODY1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTQyNDAyOA==", "url": "https://github.com/linkedin/rest.li/pull/413#discussion_r485424028", "bodyText": "Agree with Karthik B said.\nDo we have enough existing tests to test the safety of this change?", "author": "junchuanwang", "createdAt": "2020-09-09T08:16:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTMzODY1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTcwNjA0MA==", "url": "https://github.com/linkedin/rest.li/pull/413#discussion_r485706040", "bodyText": "Thank you for pointing this out.\nThe reason this is safe and no tests fail is because nothing in rest.li relies on subclassing these types. This only enables subclassing, which is safe in some use cases and not in others.\nI have a separate question regarding the class equality checks. I've run into them a few times before. Do you know what the reason is for making them?", "author": "tjni", "createdAt": "2020-09-09T15:32:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTMzODY1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg3NDY2NQ==", "url": "https://github.com/linkedin/rest.li/pull/413#discussion_r485874665", "bodyText": "Not sure why the original authors used class equality. One reason could be performance?\nAlso, for equals implementation atleast, using class equality ensures symmetry. See the discussion here: https://stackoverflow.com/questions/596462/any-reason-to-prefer-getclass-over-instanceof-when-generating-equals", "author": "karthikbalasub", "createdAt": "2020-09-09T19:45:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTMzODY1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjA0OTk3NA==", "url": "https://github.com/linkedin/rest.li/pull/413#discussion_r486049974", "bodyText": "Performance doesn't feel like a reason because it involves an extra check, which at best is optimized away by the JIT compiler but otherwise requires more work. What I'm referring to is snippets like:\nprotected Object unwrap(E object) throws ClassCastException\n{\n  ArgumentUtil.notNull(object, \"object\");\n  if (object.getClass() == _elementClass)\n  {\n    return object.data();\n  }\n  else\n  {\n    throw new ClassCastException(\"Input \" + object + \" should be a \" + _elementClass.getName());\n  }\n}\n\nThe point about equals is a good one. I need to think about it some more and will raise a separate conversation if enlightenment happens.", "author": "tjni", "createdAt": "2020-09-10T04:05:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTMzODY1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjA1ODAzMA==", "url": "https://github.com/linkedin/rest.li/pull/413#discussion_r486058030", "bodyText": "It all depends on equals semantics. If we want equals across the class hierarchy, then both should use instanceof and compare using some other mechanism. Symmetry is still possible.\nPerformance is not the reason. Some of it is just some implicit assumptions made by authors about the impossibility of subclassing (since PDSC/PDL never really supported inheritance)", "author": "karthikrg", "createdAt": "2020-09-10T04:37:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTMzODY1MQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "e3b701b8cd42359bc108e81f594a91f2902696a9", "url": "https://github.com/linkedin/rest.li/commit/e3b701b8cd42359bc108e81f594a91f2902696a9", "message": "Remove final from nested generated classes.\n\nThis enables certain techniques that use subclassing to work, such as\nsome using CGLib to intercept method calls.", "committedDate": "2020-09-09T15:57:48Z", "type": "forcePushed"}, {"oid": "87fe93d892c8c8400f8cc93089f99917d10f5d23", "url": "https://github.com/linkedin/rest.li/commit/87fe93d892c8c8400f8cc93089f99917d10f5d23", "message": "Remove final from nested generated classes.\n\nThis enables certain techniques that use subclassing to work, such as\nsome using CGLib to intercept method calls.", "committedDate": "2020-09-17T18:35:40Z", "type": "commit"}, {"oid": "87fe93d892c8c8400f8cc93089f99917d10f5d23", "url": "https://github.com/linkedin/rest.li/commit/87fe93d892c8c8400f8cc93089f99917d10f5d23", "message": "Remove final from nested generated classes.\n\nThis enables certain techniques that use subclassing to work, such as\nsome using CGLib to intercept method calls.", "committedDate": "2020-09-17T18:35:40Z", "type": "forcePushed"}]}