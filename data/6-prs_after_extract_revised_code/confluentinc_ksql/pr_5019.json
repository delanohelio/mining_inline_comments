{"pr_number": 5019, "pr_title": "fix: improve handling of NULLs", "pr_createdAt": "2020-04-07T15:22:21Z", "pr_url": "https://github.com/confluentinc/ksql/pull/5019", "timeline": [{"oid": "1a1153bb9b3dc464be86924acad2d7a75f6d5d5d", "url": "https://github.com/confluentinc/ksql/commit/1a1153bb9b3dc464be86924acad2d7a75f6d5d5d", "message": "fix: improve handling of NULLs\n\nfixes: #4912 and may other bugs around use of NULL.\n\nfixes a few issues with NULLs in ksqlDB. You can now:\n\n - insert NULL values using `INSERT INTO`, for example `INSERT INTO foo VALUES (NULL, NULL);`, including use of `ARRAY`, `MAP` & `STRUCT` constructors with `NULL`s.\n - create MAPs with null keys and values, for example `MAP('k0' := NULL, CAST(NULL AS STRING) := 10)`.  (At least one key needs to be non-null or CAST so that ksqlDB can determine the schema of the map).\n - CAST NULL to any type, including the complex types `ARRAY`, `MAP` and `STRUCT`.\n\nAlso, better error messages, on:\n\n - Pull query on NULL key.  Previously, blew up for non-string keys.\n - Pull query with non-literal expression for the key. Previously blew up.", "committedDate": "2020-04-07T15:18:00Z", "type": "commit"}, {"oid": "841c804dbb8aa722093bda3290f2f68302644ea4", "url": "https://github.com/confluentinc/ksql/commit/841c804dbb8aa722093bda3290f2f68302644ea4", "message": "chore: remove unused code", "committedDate": "2020-04-07T15:22:48Z", "type": "commit"}, {"oid": "5d22ed7eb91bba8607f8873ff4c0cdcdda41d062", "url": "https://github.com/confluentinc/ksql/commit/5d22ed7eb91bba8607f8873ff4c0cdcdda41d062", "message": "test: tests", "committedDate": "2020-04-07T15:23:38Z", "type": "commit"}, {"oid": "c0d8792d9d7d95d64f3bb075acdc2fdaee4ded55", "url": "https://github.com/confluentinc/ksql/commit/c0d8792d9d7d95d64f3bb075acdc2fdaee4ded55", "message": "test: historical plans", "committedDate": "2020-04-07T15:23:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDkwMTAyMw==", "url": "https://github.com/confluentinc/ksql/pull/5019#discussion_r404901023", "bodyText": "This avoids any compiling of code etc to handle a NULL literal.", "author": "big-andy-coates", "createdAt": "2020-04-07T15:28:26Z", "path": "ksqldb-engine/src/main/java/io/confluent/ksql/engine/InsertValuesExecutor.java", "diffHunk": "@@ -588,8 +589,13 @@ protected Object visitExpression(final Expression expression, final Void context\n                     fieldName,\n                     valueSqlType,\n                     value));\n+          })\n+          .orElse(null);\n+    }\n \n-          });\n+    @Override\n+    public Object visitNullLiteral(final NullLiteral node, final Void context) {", "originalCommit": "1a1153bb9b3dc464be86924acad2d7a75f6d5d5d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDkwMTU4NQ==", "url": "https://github.com/confluentinc/ksql/pull/5019#discussion_r404901585", "bodyText": "This avoids an NPE.  If not called the return value is left at the default Object, which is fine for nulls.", "author": "big-andy-coates", "createdAt": "2020-04-07T15:29:08Z", "path": "ksqldb-execution/src/main/java/io/confluent/ksql/execution/codegen/CodeGenRunner.java", "diffHunk": "@@ -112,7 +112,10 @@ public ExpressionMetadata buildCodeGenFromParseTree(\n       final SqlType expressionType = expressionTypeManager\n           .getExpressionSqlType(expression);\n \n-      ee.setExpressionType(SQL_TO_JAVA_TYPE_CONVERTER.toJavaType(expressionType));\n+      if (expressionType != null) {\n+        // expressionType can be null if expression is NULL.\n+        ee.setExpressionType(SQL_TO_JAVA_TYPE_CONVERTER.toJavaType(expressionType));\n+      }", "originalCommit": "1a1153bb9b3dc464be86924acad2d7a75f6d5d5d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "746e65dd5e02cc7c56ccbd54d6727aaa878f5338", "chunk": "diff --git a/ksqldb-execution/src/main/java/io/confluent/ksql/execution/codegen/CodeGenRunner.java b/ksqldb-execution/src/main/java/io/confluent/ksql/execution/codegen/CodeGenRunner.java\nindex 8f6b300ea5..a7fbd11954 100644\n--- a/ksqldb-execution/src/main/java/io/confluent/ksql/execution/codegen/CodeGenRunner.java\n+++ b/ksqldb-execution/src/main/java/io/confluent/ksql/execution/codegen/CodeGenRunner.java\n\n@@ -112,11 +112,13 @@ public class CodeGenRunner {\n       final SqlType expressionType = expressionTypeManager\n           .getExpressionSqlType(expression);\n \n-      if (expressionType != null) {\n+      if (expressionType == null) {\n         // expressionType can be null if expression is NULL.\n-        ee.setExpressionType(SQL_TO_JAVA_TYPE_CONVERTER.toJavaType(expressionType));\n+        throw new KsqlException(\"NULL expression not supported\");\n       }\n \n+      ee.setExpressionType(SQL_TO_JAVA_TYPE_CONVERTER.toJavaType(expressionType));\n+\n       ee.cook(javaCode);\n \n       return new ExpressionMetadata(\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDkwMTkyMA==", "url": "https://github.com/confluentinc/ksql/pull/5019#discussion_r404901920", "bodyText": "Switch to a new builder type that won't throw on null keys or values.", "author": "big-andy-coates", "createdAt": "2020-04-07T15:29:36Z", "path": "ksqldb-execution/src/main/java/io/confluent/ksql/execution/codegen/SqlToJavaVisitor.java", "diffHunk": "@@ -834,7 +836,9 @@ private String buildSupplierCode(final String typeString, final String code) {\n         final CreateMapExpression exp,\n         final Void context\n     ) {\n-      final StringBuilder map = new StringBuilder(\"ImmutableMap.builder()\");\n+      final StringBuilder map = new StringBuilder(\"new MapBuilder(\");\n+      map.append(exp.getMap().size());\n+      map.append((')'));", "originalCommit": "1a1153bb9b3dc464be86924acad2d7a75f6d5d5d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDkwMzY0OA==", "url": "https://github.com/confluentinc/ksql/pull/5019#discussion_r404903648", "bodyText": "getCast no longer calls sqlType.supportsCast as it is this the getCast method that determines which casts are supported and which are not. Hence supportsCast is superfluous and likely to get out of date with what this method supports.", "author": "big-andy-coates", "createdAt": "2020-04-07T15:31:46Z", "path": "ksqldb-execution/src/main/java/io/confluent/ksql/execution/codegen/SqlToJavaVisitor.java", "diffHunk": "@@ -925,27 +929,25 @@ private CastVisitor() {\n     }\n \n     static Pair<String, SqlType> getCast(final Pair<String, SqlType> expr, final SqlType sqlType) {\n-      if (!sqlType.supportsCast()) {\n-        throw new KsqlFunctionException(\n-            \"Only casts to primitive types and decimal are supported: \" + sqlType);\n-      }\n-\n-      final SqlType rightSchema = expr.getRight();\n-      if (sqlType.equals(rightSchema) || rightSchema == null) {\n+      final SqlType sourceType = expr.getRight();\n+      if (sourceType == null || sqlType.equals(sourceType)) {\n+        // sourceType is null if source is SQL NULL\n         return new Pair<>(expr.getLeft(), sqlType);\n       }\n \n-      return CASTERS.getOrDefault(\n-          sqlType.baseType(),\n-          (e, t, r) -> {\n-            throw new KsqlException(\"Invalid cast operation: \" + t);\n-          }\n-      )\n-          .cast(expr, sqlType, sqlType);\n+      return CASTERS.getOrDefault(sqlType.baseType(), CastVisitor::unsupportedCast)\n+          .cast(expr, sqlType);\n+    }", "originalCommit": "1a1153bb9b3dc464be86924acad2d7a75f6d5d5d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDkwNDM2Ng==", "url": "https://github.com/confluentinc/ksql/pull/5019#discussion_r404904366", "bodyText": "note: these methods were always called with the same param for returnType and sqlType: removed the duplication.", "author": "big-andy-coates", "createdAt": "2020-04-07T15:32:39Z", "path": "ksqldb-execution/src/main/java/io/confluent/ksql/execution/codegen/SqlToJavaVisitor.java", "diffHunk": "@@ -1003,13 +1005,13 @@ private CastVisitor() {\n     }\n \n     private static Pair<String, SqlType> castDecimal(\n-        final Pair<String, SqlType> expr, final SqlType sqltype, final SqlType returnType\n+        final Pair<String, SqlType> expr, final SqlType returnType\n     ) {\n-      if (!(sqltype instanceof SqlDecimal)) {\n-        throw new KsqlException(\"Expected decimal type: \" + sqltype);\n+      if (!(returnType instanceof SqlDecimal)) {\n+        throw new KsqlException(\"Expected decimal type: \" + returnType);", "originalCommit": "1a1153bb9b3dc464be86924acad2d7a75f6d5d5d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDkwNDcyNA==", "url": "https://github.com/confluentinc/ksql/pull/5019#discussion_r404904724", "bodyText": "Builder of maps with nulls", "author": "big-andy-coates", "createdAt": "2020-04-07T15:33:05Z", "path": "ksqldb-execution/src/main/java/io/confluent/ksql/execution/codegen/helpers/MapBuilder.java", "diffHunk": "@@ -0,0 +1,42 @@\n+/*\n+ * Copyright 2020 Confluent Inc.\n+ *\n+ * Licensed under the Confluent Community License (the \"License\"; you may not use\n+ * this file except in compliance with the License. You may obtain a copy of the\n+ * License at\n+ *\n+ * http://www.confluent.io/confluent-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OF ANY KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package io.confluent.ksql.execution.codegen.helpers;\n+\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+/**\n+ * Used to construct maps using the builder pattern. Note that we cannot use {@link\n+ * com.google.common.collect.ImmutableMap} because it does not accept null values.\n+ */\n+public class MapBuilder {", "originalCommit": "1a1153bb9b3dc464be86924acad2d7a75f6d5d5d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDkwNjE1Mw==", "url": "https://github.com/confluentinc/ksql/pull/5019#discussion_r404906153", "bodyText": "Removed this as its not needed.  It's getCast in SqlToJavaVisitor that determines what casts are supported.  Removing this check just means it fails, with the same error, slightly later in flow.", "author": "big-andy-coates", "createdAt": "2020-04-07T15:34:54Z", "path": "ksqldb-execution/src/main/java/io/confluent/ksql/execution/util/ExpressionTypeManager.java", "diffHunk": "@@ -146,13 +145,7 @@ public Void visitNotExpression(\n \n     @Override\n     public Void visitCast(final Cast node, final ExpressionTypeContext expressionTypeContext) {\n-      final SqlType sqlType = node.getType().getSqlType();\n-      if (!sqlType.supportsCast()) {\n-        throw new KsqlFunctionException(\"Only casts to primitive types or decimals \"\n-            + \"are supported: \" + sqlType);\n-      }\n-\n-      expressionTypeContext.setSqlType(sqlType);\n+      expressionTypeContext.setSqlType(node.getType().getSqlType());", "originalCommit": "1a1153bb9b3dc464be86924acad2d7a75f6d5d5d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDkwNzYzMw==", "url": "https://github.com/confluentinc/ksql/pull/5019#discussion_r404907633", "bodyText": "refactored to allow coerce to return a successful coercion with a no value result, i.e. coercion of nulls.  Previous return value would not differentiate between a failure and 'no value'", "author": "big-andy-coates", "createdAt": "2020-04-07T15:36:52Z", "path": "ksqldb-parser/src/main/java/io/confluent/ksql/schema/ksql/DefaultSqlValueCoercer.java", "diffHunk": "@@ -37,28 +37,33 @@\n \n   INSTANCE;\n \n-  private static final Map<SqlBaseType, BiFunction<Number, SqlType, Optional<Number>>> UPCASTER =\n-      ImmutableMap.<SqlBaseType, BiFunction<Number, SqlType, Optional<Number>>>builder()\n-          .put(SqlBaseType.INTEGER, (num, type) -> Optional.of(num.intValue()))\n-          .put(SqlBaseType.BIGINT, (num, type) -> Optional.of(num.longValue()))\n-          .put(SqlBaseType.DOUBLE, (num, type) -> Optional.of(num.doubleValue()))\n+  private static final Map<SqlBaseType, BiFunction<Number, SqlType, Result>> UPCASTER =\n+      ImmutableMap.<SqlBaseType, BiFunction<Number, SqlType, Result>>builder()\n+          .put(SqlBaseType.INTEGER, (num, type) -> Result.of(num.intValue()))\n+          .put(SqlBaseType.BIGINT, (num, type) -> Result.of(num.longValue()))\n+          .put(SqlBaseType.DOUBLE, (num, type) -> Result.of(num.doubleValue()))\n           .put(SqlBaseType.DECIMAL, (num, type) -> {\n             try {\n-              return Optional.ofNullable(\n+              return Result.of(\n                   DecimalUtil.ensureFit(\n                       new BigDecimal(String.format(\"%s\", num)),\n                       (SqlDecimal) type));\n             } catch (final Exception e) {\n-              return Optional.empty();\n+              return Result.failure();\n             }\n           }).build();\n \n   @Override\n-  public Optional<?> coerce(final Object value, final SqlType targetType) {\n+  public Result coerce(final Object value, final SqlType targetType) {", "originalCommit": "1a1153bb9b3dc464be86924acad2d7a75f6d5d5d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDkyMzg2MQ==", "url": "https://github.com/confluentinc/ksql/pull/5019#discussion_r404923861", "bodyText": "look mar, null handling!", "author": "big-andy-coates", "createdAt": "2020-04-07T15:57:58Z", "path": "ksqldb-parser/src/main/java/io/confluent/ksql/schema/ksql/DefaultSqlValueCoercer.java", "diffHunk": "@@ -37,28 +37,33 @@\n \n   INSTANCE;\n \n-  private static final Map<SqlBaseType, BiFunction<Number, SqlType, Optional<Number>>> UPCASTER =\n-      ImmutableMap.<SqlBaseType, BiFunction<Number, SqlType, Optional<Number>>>builder()\n-          .put(SqlBaseType.INTEGER, (num, type) -> Optional.of(num.intValue()))\n-          .put(SqlBaseType.BIGINT, (num, type) -> Optional.of(num.longValue()))\n-          .put(SqlBaseType.DOUBLE, (num, type) -> Optional.of(num.doubleValue()))\n+  private static final Map<SqlBaseType, BiFunction<Number, SqlType, Result>> UPCASTER =\n+      ImmutableMap.<SqlBaseType, BiFunction<Number, SqlType, Result>>builder()\n+          .put(SqlBaseType.INTEGER, (num, type) -> Result.of(num.intValue()))\n+          .put(SqlBaseType.BIGINT, (num, type) -> Result.of(num.longValue()))\n+          .put(SqlBaseType.DOUBLE, (num, type) -> Result.of(num.doubleValue()))\n           .put(SqlBaseType.DECIMAL, (num, type) -> {\n             try {\n-              return Optional.ofNullable(\n+              return Result.of(\n                   DecimalUtil.ensureFit(\n                       new BigDecimal(String.format(\"%s\", num)),\n                       (SqlDecimal) type));\n             } catch (final Exception e) {\n-              return Optional.empty();\n+              return Result.failure();\n             }\n           }).build();\n \n   @Override\n-  public Optional<?> coerce(final Object value, final SqlType targetType) {\n+  public Result coerce(final Object value, final SqlType targetType) {\n     return doCoerce(value, targetType);\n   }\n \n-  private static Optional<?> doCoerce(final Object value, final SqlType targetType) {\n+  private static Result doCoerce(final Object value, final SqlType targetType) {\n+    if (value == null) {\n+      // NULL can be cast to any type:\n+      return Result.nullResult();\n+    }", "originalCommit": "1a1153bb9b3dc464be86924acad2d7a75f6d5d5d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDkyNTY4MQ==", "url": "https://github.com/confluentinc/ksql/pull/5019#discussion_r404925681", "bodyText": "As above, this change in return value is to allow callers to differentiate between:\n\nthe coercion failed. Previously this returned Optional.empty and now returns Result.failed.\nthe coercion succeeded and the result was null. Previously, this threw an NPE and now returns Result.nullResult.\n\nNormal results where previously Optional.of(whateva) and are now Result.of(whateva).", "author": "big-andy-coates", "createdAt": "2020-04-07T16:00:26Z", "path": "ksqldb-parser/src/main/java/io/confluent/ksql/schema/ksql/SqlValueCoercer.java", "diffHunk": "@@ -26,11 +28,71 @@\n   /**\n    * Coerce the supplied {@code value} to the supplied {@code sqlType}.\n    *\n-   * <p>Complex SQL types are not supported, (yet).\n-   *\n    * @param value the value to try to coerce.\n    * @param targetSchema the target SQL type.\n-   * @return the coerced value if the value could be coerced, {@link Optional#empty()} otherwise.\n+   * @return the Result of the coercion.\n    */\n-  Optional<?> coerce(Object value, SqlType targetSchema);\n+  Result coerce(Object value, SqlType targetSchema);", "originalCommit": "1a1153bb9b3dc464be86924acad2d7a75f6d5d5d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDkzMDM5Mw==", "url": "https://github.com/confluentinc/ksql/pull/5019#discussion_r404930393", "bodyText": "Catches errors on pull queries.\n\nfirst one catches comparison of ROWKEY to non-literal, e.g. a udf call, or some other expression. Previously this would blow up with class cast exception.\nsecond one catches comparison with NULL.  For STRING keys this previously returned some weird streams error and for non-STRING keys some confusing error about not being able to coerce a STRING to the required key type. (NullLiteral returns \"null\" from getValue for some weird reason).", "author": "big-andy-coates", "createdAt": "2020-04-07T16:06:36Z", "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/execution/PullQueryExecutor.java", "diffHunk": "@@ -564,8 +565,15 @@ private static Object extractKeyWhereClause(\n     }\n \n     final Expression other = getNonColumnRefSide(comparison);\n-    final Object right = ((Literal) other).getValue();\n+    if (!(other instanceof Literal)) {\n+      throw new KsqlException(\"Ony comparison to literals is currently supported: \" + comparison);\n+    }\n \n+    if (other instanceof NullLiteral) {\n+      throw new KsqlException(\"Primary key columns can not be NULL: \" + comparison);\n+    }", "originalCommit": "1a1153bb9b3dc464be86924acad2d7a75f6d5d5d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "2028a47dc628eefea415204d8a4c09f006eed869", "url": "https://github.com/confluentinc/ksql/commit/2028a47dc628eefea415204d8a4c09f006eed869", "message": "Merge branch 'master' into nulls", "committedDate": "2020-04-07T16:26:34Z", "type": "commit"}, {"oid": "746e65dd5e02cc7c56ccbd54d6727aaa878f5338", "url": "https://github.com/confluentinc/ksql/commit/746e65dd5e02cc7c56ccbd54d6727aaa878f5338", "message": "chore: fix spot bugs", "committedDate": "2020-04-07T17:06:43Z", "type": "commit"}, {"oid": "f6a4144fc84d90d5f968cdb975cdc42b88d9c088", "url": "https://github.com/confluentinc/ksql/commit/f6a4144fc84d90d5f968cdb975cdc42b88d9c088", "message": "Merge branch 'master' into nulls", "committedDate": "2020-04-14T11:10:29Z", "type": "commit"}]}