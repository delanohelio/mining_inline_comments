{"pr_number": 5059, "pr_title": "fix: Make sure internal client is configured for TLS", "pr_createdAt": "2020-04-14T13:07:19Z", "pr_url": "https://github.com/confluentinc/ksql/pull/5059", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI5NDk2NA==", "url": "https://github.com/confluentinc/ksql/pull/5059#discussion_r408294964", "bodyText": "is there any reason we ignore the non-string properties? (should we be calling toString on them?)", "author": "agavra", "createdAt": "2020-04-14T17:02:52Z", "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/services/DefaultKsqlClient.java", "diffHunk": "@@ -154,4 +161,15 @@ private static HttpClientOptions createClientOptions() {\n     return new HttpClientOptions().setMaxPoolSize(100);\n   }\n \n+  private static Map<String, String> toClientProps(final KsqlConfig ksqlConfig) {\n+    final Map<String, String> clientProps = new HashMap<>();\n+    for (Map.Entry<String, Object> entry : ksqlConfig.originals().entrySet()) {\n+      if (entry.getValue() instanceof String) {", "originalCommit": "a61e3cbf590a4ca01ff17ea4daafd44546f0952a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM2NjEyNg==", "url": "https://github.com/confluentinc/ksql/pull/5059#discussion_r408366126", "bodyText": "we're really only interested in the ssl config values which are all strings I think.", "author": "purplefox", "createdAt": "2020-04-14T19:00:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI5NDk2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQyMzE0NQ==", "url": "https://github.com/confluentinc/ksql/pull/5059#discussion_r408423145", "bodyText": "I'm worried that assumption is a little brittle, at a minimum can we add a comment explaining that?", "author": "agavra", "createdAt": "2020-04-14T20:43:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI5NDk2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY1ODQxMw==", "url": "https://github.com/confluentinc/ksql/pull/5059#discussion_r408658413", "bodyText": "Ok, I'll toString the value :)", "author": "purplefox", "createdAt": "2020-04-15T08:09:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI5NDk2NA=="}], "type": "inlineReview", "revised_code": {"commit": "16b3aae62b74a9d189993fd24bc3cd93164cee75", "chunk": "diff --git a/ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/services/DefaultKsqlClient.java b/ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/services/DefaultKsqlClient.java\nindex 13eb1bd456..288bc972b9 100644\n--- a/ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/services/DefaultKsqlClient.java\n+++ b/ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/services/DefaultKsqlClient.java\n\n@@ -164,9 +164,7 @@ final class DefaultKsqlClient implements SimpleKsqlClient {\n   private static Map<String, String> toClientProps(final KsqlConfig ksqlConfig) {\n     final Map<String, String> clientProps = new HashMap<>();\n     for (Map.Entry<String, Object> entry : ksqlConfig.originals().entrySet()) {\n-      if (entry.getValue() instanceof String) {\n-        clientProps.put(entry.getKey(), (String) entry.getValue());\n-      }\n+      clientProps.put(entry.getKey(), entry.getValue().toString());\n     }\n     return clientProps;\n   }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODUwMzE0NA==", "url": "https://github.com/confluentinc/ksql/pull/5059#discussion_r408503144", "bodyText": "What's the purpose of having both a TLS and a non-TLS listener? Can we just have the TLS listener?", "author": "vcrfxia", "createdAt": "2020-04-14T23:58:24Z", "path": "ksqldb-rest-app/src/test/java/io/confluent/ksql/rest/integration/ShowQueriesMultiNodeWithTlsFunctionalTest.java", "diffHunk": "@@ -0,0 +1,119 @@\n+/*\n+ * Copyright 2020 Confluent Inc.\n+ *\n+ * Licensed under the Confluent Community License (the \"License\"; you may not use\n+ * this file except in compliance with the License. You may obtain a copy of the\n+ * License at\n+ *\n+ * http://www.confluent.io/confluent-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OF ANY KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package io.confluent.ksql.rest.integration;\n+\n+import static io.confluent.ksql.test.util.AssertEventually.assertThatEventually;\n+import static org.hamcrest.Matchers.is;\n+\n+import io.confluent.common.utils.IntegrationTest;\n+import io.confluent.ksql.integration.IntegrationTestHarness;\n+import io.confluent.ksql.integration.Retry;\n+import io.confluent.ksql.rest.entity.KsqlEntity;\n+import io.confluent.ksql.rest.entity.Queries;\n+import io.confluent.ksql.rest.entity.RunningQuery;\n+import io.confluent.ksql.rest.server.KsqlRestConfig;\n+import io.confluent.ksql.rest.server.TestKsqlRestApp;\n+import io.confluent.ksql.serde.FormatFactory;\n+import io.confluent.ksql.test.util.secure.ServerKeyStore;\n+import io.confluent.ksql.util.PageViewDataProvider;\n+import java.util.List;\n+import java.util.concurrent.TimeUnit;\n+import java.util.function.Supplier;\n+import kafka.zookeeper.ZooKeeperClientException;\n+import org.junit.BeforeClass;\n+import org.junit.ClassRule;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+import org.junit.rules.RuleChain;\n+\n+@Category({IntegrationTest.class})\n+public class ShowQueriesMultiNodeWithTlsFunctionalTest {\n+\n+  private static final PageViewDataProvider PAGE_VIEWS_PROVIDER = new PageViewDataProvider();\n+  private static final String PAGE_VIEW_TOPIC = PAGE_VIEWS_PROVIDER.topicName();\n+  private static final String PAGE_VIEW_STREAM = PAGE_VIEWS_PROVIDER.kstreamName();\n+  private static final IntegrationTestHarness TEST_HARNESS = IntegrationTestHarness.build();\n+  private static final TestKsqlRestApp REST_APP_0 = TestKsqlRestApp\n+      .builder(TEST_HARNESS::kafkaBootstrapServers)\n+      .withProperty(KsqlRestConfig.LISTENERS_CONFIG,\n+          \"http://localhost:8088,https://localhost:8089\")", "originalCommit": "a61e3cbf590a4ca01ff17ea4daafd44546f0952a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY1NjQ0OA==", "url": "https://github.com/confluentinc/ksql/pull/5059#discussion_r408656448", "bodyText": "I think in many cases users will have both listeners, so this validates that the right listener is used in this case.", "author": "purplefox", "createdAt": "2020-04-15T08:06:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODUwMzE0NA=="}], "type": "inlineReview", "revised_code": {"commit": "89f0457cac6ea849c5d92e7f0ec373ae8d2be8b7", "chunk": "diff --git a/ksqldb-rest-app/src/test/java/io/confluent/ksql/rest/integration/ShowQueriesMultiNodeWithTlsFunctionalTest.java b/ksqldb-rest-app/src/test/java/io/confluent/ksql/rest/integration/ShowQueriesMultiNodeWithTlsFunctionalTest.java\nindex 53886128b6..521cf69e20 100644\n--- a/ksqldb-rest-app/src/test/java/io/confluent/ksql/rest/integration/ShowQueriesMultiNodeWithTlsFunctionalTest.java\n+++ b/ksqldb-rest-app/src/test/java/io/confluent/ksql/rest/integration/ShowQueriesMultiNodeWithTlsFunctionalTest.java\n\n@@ -52,6 +52,7 @@ public class ShowQueriesMultiNodeWithTlsFunctionalTest {\n           \"http://localhost:8088,https://localhost:8089\")\n       .withProperty(KsqlRestConfig.ADVERTISED_LISTENER_CONFIG, \"https://localhost:8089\")\n       .withProperties(ServerKeyStore.keyStoreProps())\n+      .withEnabledKsqlClient()\n       .build();\n   private static final TestKsqlRestApp REST_APP_1 = TestKsqlRestApp\n       .builder(TEST_HARNESS::kafkaBootstrapServers)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODUwMzUxMQ==", "url": "https://github.com/confluentinc/ksql/pull/5059#discussion_r408503511", "bodyText": "Not directly related to this PR, but is it common practice to ignore exceptions on close? I would've expected to at least log the exception?", "author": "vcrfxia", "createdAt": "2020-04-14T23:59:28Z", "path": "ksqldb-rest-client/src/main/java/io/confluent/ksql/rest/client/KsqlClient.java", "diffHunk": "@@ -43,75 +42,42 @@\n     JsonMapper.INSTANCE.mapper.registerModule(new KsqlTypesDeserializationModule(false));\n   }\n \n-  public static final String DISABLE_HOSTNAME_VERIFICATION_PROP_NAME\n-      = \"ksql.client.disable.hostname.verification\";\n-  public static final String TLS_ENABLED_PROP_NAME = \"ksql.client.enable.tls\";\n-\n   private final Vertx vertx;\n-  private final HttpClient httpClient;\n+  private final HttpClient httpNonTlsClient;\n+  private final HttpClient httpTlsClient;\n   private final LocalProperties localProperties;\n   private final Optional<String> basicAuthHeader;\n-  private final boolean isTls;\n \n   public KsqlClient(\n       final Map<String, String> clientProps,\n       final Optional<BasicCredentials> credentials,\n       final LocalProperties localProperties,\n       final HttpClientOptions httpClientOptions\n   ) {\n-    this(Vertx.vertx(), clientProps, credentials, localProperties, httpClientOptions);\n-  }\n-\n-  @VisibleForTesting\n-  KsqlClient(\n-      final HttpClient httpClient,\n-      final boolean isTls,\n-      final Optional<BasicCredentials> credentials,\n-      final LocalProperties localProperties\n-  ) {\n-    this(null, httpClient, isTls, credentials, localProperties);\n-  }\n-\n-  private KsqlClient(\n-      final Vertx vertx,\n-      final HttpClient httpClient,\n-      final boolean isTls,\n-      final Optional<BasicCredentials> credentials,\n-      final LocalProperties localProperties\n-  ) {\n-    this.vertx = vertx;\n-    this.httpClient = Objects.requireNonNull(httpClient, \"httpClient\");\n-    this.isTls = isTls;\n+    this.vertx = Vertx.vertx();\n     this.basicAuthHeader = createBasicAuthHeader(\n         Objects.requireNonNull(credentials, \"credentials\"));\n     this.localProperties = Objects.requireNonNull(localProperties, \"localProperties\");\n-  }\n-\n-  private KsqlClient(\n-      final Vertx vertx,\n-      final Map<String, String> clientProps,\n-      final Optional<BasicCredentials> credentials,\n-      final LocalProperties localProperties,\n-      final HttpClientOptions httpClientOptions\n-  ) {\n-    this(vertx, createHttpClient(vertx, clientProps, httpClientOptions), httpClientOptions.isSsl(),\n-        credentials, localProperties);\n+    this.httpNonTlsClient = createHttpClient(vertx, clientProps, httpClientOptions, false);\n+    this.httpTlsClient = createHttpClient(vertx, clientProps, httpClientOptions, true);\n   }\n \n   public KsqlTarget target(final URI server) {\n     final boolean isUriTls = server.getScheme().equalsIgnoreCase(\"https\");\n-    if (isTls != isUriTls) {\n-      throw new KsqlRestClientException(\"Cannot make request with scheme \" + server.getScheme()\n-          + \" as client is configured \" + (isTls ? \"with\" : \"without\") + \" tls\");\n-    }\n-    return new KsqlTarget(httpClient,\n+    final HttpClient client = isUriTls ? httpTlsClient : httpNonTlsClient;\n+    return new KsqlTarget(client,\n         SocketAddress.inetSocketAddress(server.getPort(), server.getHost()), localProperties,\n         basicAuthHeader);\n   }\n \n   public void close() {\n     try {\n-      httpClient.close();\n+      httpTlsClient.close();\n+    } catch (Exception ignore) {\n+      // Ignore", "originalCommit": "a61e3cbf590a4ca01ff17ea4daafd44546f0952a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY1NzEwMg==", "url": "https://github.com/confluentinc/ksql/pull/5059#discussion_r408657102", "bodyText": "It's a pretty common approach if you want a clean close.", "author": "purplefox", "createdAt": "2020-04-15T08:07:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODUwMzUxMQ=="}], "type": "inlineReview", "revised_code": {"commit": "b74644155adc46c31bc00082382f459127240bcc", "chunk": "diff --git a/ksqldb-rest-client/src/main/java/io/confluent/ksql/rest/client/KsqlClient.java b/ksqldb-rest-client/src/main/java/io/confluent/ksql/rest/client/KsqlClient.java\nindex 98157fc323..c52bdee8dd 100644\n--- a/ksqldb-rest-client/src/main/java/io/confluent/ksql/rest/client/KsqlClient.java\n+++ b/ksqldb-rest-client/src/main/java/io/confluent/ksql/rest/client/KsqlClient.java\n\n@@ -37,9 +36,7 @@ import org.apache.kafka.common.config.SslConfigs;\n public final class KsqlClient implements AutoCloseable {\n \n   static {\n-    JsonMapper.INSTANCE.mapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);\n-    JsonMapper.INSTANCE.mapper.configure(DeserializationFeature.FAIL_ON_NULL_FOR_PRIMITIVES, false);\n-    JsonMapper.INSTANCE.mapper.registerModule(new KsqlTypesDeserializationModule(false));\n+    ApiJsonMapper.INSTANCE.get().registerModule(new KsqlTypesDeserializationModule(false));\n   }\n \n   private final Vertx vertx;\n"}}, {"oid": "16b3aae62b74a9d189993fd24bc3cd93164cee75", "url": "https://github.com/confluentinc/ksql/commit/16b3aae62b74a9d189993fd24bc3cd93164cee75", "message": "tostring on config values", "committedDate": "2020-04-15T08:09:09Z", "type": "forcePushed"}, {"oid": "b74644155adc46c31bc00082382f459127240bcc", "url": "https://github.com/confluentinc/ksql/commit/b74644155adc46c31bc00082382f459127240bcc", "message": "Fixed merge", "committedDate": "2020-04-15T11:42:15Z", "type": "commit"}, {"oid": "b5eafd5d7bcb1376af7300c4601282594c9ff3ac", "url": "https://github.com/confluentinc/ksql/commit/b5eafd5d7bcb1376af7300c4601282594c9ff3ac", "message": "findbugs and checkstyle", "committedDate": "2020-04-15T11:42:33Z", "type": "commit"}, {"oid": "f45fc9739042c81f58736775e9162aa1e6a6b29a", "url": "https://github.com/confluentinc/ksql/commit/f45fc9739042c81f58736775e9162aa1e6a6b29a", "message": "small tweak", "committedDate": "2020-04-15T11:42:33Z", "type": "commit"}, {"oid": "889fd612de5e948f129754d1761f194da60fd4ae", "url": "https://github.com/confluentinc/ksql/commit/889fd612de5e948f129754d1761f194da60fd4ae", "message": "tostring on config values", "committedDate": "2020-04-15T11:42:33Z", "type": "commit"}, {"oid": "75a12d6cd13ce02f7f35feed077f00c8cae62a3b", "url": "https://github.com/confluentinc/ksql/commit/75a12d6cd13ce02f7f35feed077f00c8cae62a3b", "message": "try and fix flaky test", "committedDate": "2020-04-15T11:42:33Z", "type": "commit"}, {"oid": "89f0457cac6ea849c5d92e7f0ec373ae8d2be8b7", "url": "https://github.com/confluentinc/ksql/commit/89f0457cac6ea849c5d92e7f0ec373ae8d2be8b7", "message": "Fixed test", "committedDate": "2020-04-15T11:42:34Z", "type": "commit"}, {"oid": "89f0457cac6ea849c5d92e7f0ec373ae8d2be8b7", "url": "https://github.com/confluentinc/ksql/commit/89f0457cac6ea849c5d92e7f0ec373ae8d2be8b7", "message": "Fixed test", "committedDate": "2020-04-15T11:42:34Z", "type": "forcePushed"}]}