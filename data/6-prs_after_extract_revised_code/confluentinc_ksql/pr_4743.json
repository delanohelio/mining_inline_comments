{"pr_number": 4743, "pr_title": "fix: make CLI unit-tests platform independent", "pr_createdAt": "2020-03-09T18:17:48Z", "pr_url": "https://github.com/confluentinc/ksql/pull/4743", "timeline": [{"oid": "4fcf39e3beae5990e0df0e9936ee9cf62d005c21", "url": "https://github.com/confluentinc/ksql/commit/4fcf39e3beae5990e0df0e9936ee9cf62d005c21", "message": "further test fixes. more tedious than expected", "committedDate": "2020-03-07T00:34:15Z", "type": "commit"}, {"oid": "c3eb6ed9f14c18dbe45a3a1f8c325d70eb8da87c", "url": "https://github.com/confluentinc/ksql/commit/c3eb6ed9f14c18dbe45a3a1f8c325d70eb8da87c", "message": "rebase from master", "committedDate": "2020-03-09T20:22:15Z", "type": "commit"}, {"oid": "4b94da6e6b23c587423f25f9c709e3e0c3cad5bf", "url": "https://github.com/confluentinc/ksql/commit/4b94da6e6b23c587423f25f9c709e3e0c3cad5bf", "message": "merging", "committedDate": "2020-03-09T20:27:06Z", "type": "commit"}, {"oid": "f5666f83311678fc95bd48a9729198e0bcccc9ca", "url": "https://github.com/confluentinc/ksql/commit/f5666f83311678fc95bd48a9729198e0bcccc9ca", "message": "add blank line after static imports", "committedDate": "2020-03-10T07:32:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDIxMzIzMA==", "url": "https://github.com/confluentinc/ksql/pull/4743#discussion_r390213230", "bodyText": "Taken at face value, the old code looked more cross-platform independent. Would you mind explaining the workings behind this change?", "author": "big-andy-coates", "createdAt": "2020-03-10T10:16:16Z", "path": "ksql-cli/src/main/java/io/confluent/ksql/cli/console/CommentStripper.java", "diffHunk": "@@ -98,7 +98,7 @@ private String strip() {\n     private String trimComment(final int partStart) {\n       final String part = line.substring(partStart, pos - 1).trim();\n \n-      final int newLine = line.indexOf(System.lineSeparator(), pos + 1);\n+      final int newLine = line.indexOf(\"\\n\", pos + 1);", "originalCommit": "f5666f83311678fc95bd48a9729198e0bcccc9ca", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMxNzU3Mw==", "url": "https://github.com/confluentinc/ksql/pull/4743#discussion_r391317573", "bodyText": "Yeah, this was the most PITA part of the whole fix, and the only place i think where i changed the code-under-test rather than the test code itself.  IIRC, after debugging deeper than anyone should ever have to into the nested and repeated calls of the various parser classes, it's the case that this code only ever gets passed the output of an invocation of a JLine parser, which has already normalized the embedded line feeds to \\n.\nNote that there's confusion in the code about the meaning of variables called \"line\" - sometimes it's \"a string of characters delimited by a newline\", as you might intuit, and sometimes \"a logical line, maybe containing embedded newlines which we sometimes want to retain and sometimes don't, delimited by the line termination character (the ; we use to indicate end-of-sql-statement)\".", "author": "blueedgenick", "createdAt": "2020-03-11T22:59:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDIxMzIzMA=="}], "type": "inlineReview", "revised_code": {"commit": "29245054b5a8b27a83df902f31ea9b1ca2a9659f", "chunk": "diff --git a/ksql-cli/src/main/java/io/confluent/ksql/cli/console/CommentStripper.java b/ksql-cli/src/main/java/io/confluent/ksql/cli/console/CommentStripper.java\ndeleted file mode 100644\nindex 92f2c52c2b..0000000000\n--- a/ksql-cli/src/main/java/io/confluent/ksql/cli/console/CommentStripper.java\n+++ /dev/null\n\n@@ -1,111 +0,0 @@\n-/*\n- * Copyright 2018 Confluent Inc.\n- *\n- * Licensed under the Confluent Community License (the \"License\"); you may not use\n- * this file except in compliance with the License.  You may obtain a copy of the\n- * License at\n- *\n- * http://www.confluent.io/confluent-community-license\n- *\n- * Unless required by applicable law or agreed to in writing, software\n- * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n- * WARRANTIES OF ANY KIND, either express or implied.  See the License for the\n- * specific language governing permissions and limitations under the License.\n- */\n-\n-package io.confluent.ksql.cli.console;\n-\n-/**\n- * Strips single line comments of the end of a line.\n- *\n- * <p>i.e. anything following an unquoted {@code --}.\n- */\n-final class CommentStripper {\n-\n-  private static final char NONE = 'x';\n-\n-  private CommentStripper() {\n-  }\n-\n-  static String strip(final String line) {\n-    return new Parser(line).parse();\n-  }\n-\n-  private static final class Parser {\n-    private final String line;\n-    private int pos;\n-\n-    private Parser(final String line) {\n-      this.line = line;\n-      this.pos = 0;\n-    }\n-\n-    private String parse() {\n-      final String firstPart = strip();\n-      if (done()) {\n-        // Early out if contains no comments part way through:\n-        return firstPart;\n-      }\n-\n-      final StringBuilder builder = new StringBuilder(line.length());\n-      builder.append(firstPart);\n-      while (!done()) {\n-        builder.append(strip());\n-      }\n-      return builder.toString();\n-    }\n-\n-    private boolean done() {\n-      return pos == line.length();\n-    }\n-\n-    private String strip() {\n-      final int start = pos;\n-      char lastChar = NONE;\n-      char lastQuote = NONE;\n-      for (; pos != line.length(); ++pos) {\n-        final char c = line.charAt(pos);\n-\n-        switch (c) {\n-          case '`':\n-          case '\\'':\n-          case '\"':\n-            if (lastQuote == c) {\n-              // Matching pair:\n-              lastQuote = NONE;\n-            } else if (lastQuote == NONE) {\n-              lastQuote = c;\n-            }\n-            break;\n-\n-          case '-':\n-            if (lastChar == '-' && lastQuote == NONE) {\n-              // Found unquoted comment marker:\n-              return trimComment(start);\n-            }\n-            break;\n-\n-          default:\n-            break;\n-        }\n-\n-        lastChar = c;\n-      }\n-\n-      return line.substring(start);\n-    }\n-\n-    private String trimComment(final int partStart) {\n-      final String part = line.substring(partStart, pos - 1).trim();\n-\n-      final int newLine = line.indexOf(\"\\n\", pos + 1);\n-      if (newLine == -1) {\n-        pos = line.length();\n-      } else {\n-        pos = newLine;\n-      }\n-\n-      return part;\n-    }\n-  }\n-}\n"}}, {"oid": "29245054b5a8b27a83df902f31ea9b1ca2a9659f", "url": "https://github.com/confluentinc/ksql/commit/29245054b5a8b27a83df902f31ea9b1ca2a9659f", "message": "chore: rename modules and artfiacts to prefix ksqldb- (#4428)", "committedDate": "2020-03-10T21:41:30Z", "type": "commit"}, {"oid": "2e153e4d5b331ab8f92e13ca13f2e60016a9fc9c", "url": "https://github.com/confluentinc/ksql/commit/2e153e4d5b331ab8f92e13ca13f2e60016a9fc9c", "message": "build: rename debian build files", "committedDate": "2020-03-11T01:11:49Z", "type": "commit"}, {"oid": "e6379895d1661f551d7225a8c70fb46a030913ef", "url": "https://github.com/confluentinc/ksql/commit/e6379895d1661f551d7225a8c70fb46a030913ef", "message": "Set Confluent to 5.3.3, Kafka to 5.3.3.", "committedDate": "2020-03-11T14:57:15Z", "type": "commit"}, {"oid": "954cff98077f98746be40ec6650296b2328e34d0", "url": "https://github.com/confluentinc/ksql/commit/954cff98077f98746be40ec6650296b2328e34d0", "message": "build: rename artifacts and modules to prefix ksqldb-", "committedDate": "2020-03-11T15:55:37Z", "type": "commit"}, {"oid": "af9f5f04d7f010a941d2d0e71e9b11537516a955", "url": "https://github.com/confluentinc/ksql/commit/af9f5f04d7f010a941d2d0e71e9b11537516a955", "message": "docs: update ARRAY and MAP docs (#4753)", "committedDate": "2020-03-11T19:09:05Z", "type": "commit"}, {"oid": "6d6b0a9eac3fb468cfe4e4637d4053c8745e7aef", "url": "https://github.com/confluentinc/ksql/commit/6d6b0a9eac3fb468cfe4e4637d4053c8745e7aef", "message": "Merge branch '5.5.x'", "committedDate": "2020-03-11T23:09:07Z", "type": "commit"}, {"oid": "975183d25dae0d055228730bd68e37271cd8483e", "url": "https://github.com/confluentinc/ksql/commit/975183d25dae0d055228730bd68e37271cd8483e", "message": "fix directory test", "committedDate": "2020-03-11T23:09:52Z", "type": "commit"}, {"oid": "3e242ee4fd74a0daf1e404c7abb9cf52f95c4cd8", "url": "https://github.com/confluentinc/ksql/commit/3e242ee4fd74a0daf1e404c7abb9cf52f95c4cd8", "message": "Merge branch '5.5.x'", "committedDate": "2020-03-11T23:13:35Z", "type": "commit"}, {"oid": "62dc5d39d97c3697937308a4f3a6f9361e6229e6", "url": "https://github.com/confluentinc/ksql/commit/62dc5d39d97c3697937308a4f3a6f9361e6229e6", "message": "build: disable -Werror compiler argument in tests (#4759)", "committedDate": "2020-03-12T18:42:48Z", "type": "commit"}, {"oid": "fbe92f0a0d0ca760ff0af89dc7743707bcbf6121", "url": "https://github.com/confluentinc/ksql/commit/fbe92f0a0d0ca760ff0af89dc7743707bcbf6121", "message": "Merge branch 5.1.x into 5.2.x", "committedDate": "2020-03-12T18:50:00Z", "type": "commit"}, {"oid": "3606dc1bffe6c225abdf7d7d587f55f8cbbb585b", "url": "https://github.com/confluentinc/ksql/commit/3606dc1bffe6c225abdf7d7d587f55f8cbbb585b", "message": "Merge branch '5.2.x' into 5.3.x", "committedDate": "2020-03-12T21:04:05Z", "type": "commit"}, {"oid": "288be4faa38ae3399264479e6a4bd88fdfabe99a", "url": "https://github.com/confluentinc/ksql/commit/288be4faa38ae3399264479e6a4bd88fdfabe99a", "message": "Merge branch '5.3.x' into 5.4.x", "committedDate": "2020-03-12T22:44:32Z", "type": "commit"}, {"oid": "8693f1db96847e1590d6b726088f25c7474daac3", "url": "https://github.com/confluentinc/ksql/commit/8693f1db96847e1590d6b726088f25c7474daac3", "message": "docs: add links to Troubleshooting KSQL blog posts (DOCS-3642) (#4762)", "committedDate": "2020-03-12T23:01:16Z", "type": "commit"}, {"oid": "8711006a3e04cc83e62fcb636b779cfac178b782", "url": "https://github.com/confluentinc/ksql/commit/8711006a3e04cc83e62fcb636b779cfac178b782", "message": "docs: add new topic on processing guarantees (KSQL-3721) (#4761)\n\n* docs: add new topic on processing guarantees (KSQL-3721)\r\n\r\n* docs: add example Docker env for EOS setting", "committedDate": "2020-03-13T00:08:05Z", "type": "commit"}, {"oid": "1f2d643e58fb2854ca713fb10717edb2d3c56658", "url": "https://github.com/confluentinc/ksql/commit/1f2d643e58fb2854ca713fb10717edb2d3c56658", "message": "docs: add note about EOS semantics (KSQL-3721) (#4765)", "committedDate": "2020-03-13T00:16:03Z", "type": "commit"}, {"oid": "1ebe5552ad69fc845bdb41d953ca363ab7aedd0d", "url": "https://github.com/confluentinc/ksql/commit/1ebe5552ad69fc845bdb41d953ca363ab7aedd0d", "message": "Fix broken 5.3.x (#4764)\n\n* fix: building\r\n\r\n* more params\r\n\r\n* its alive", "committedDate": "2020-03-13T02:28:55Z", "type": "commit"}, {"oid": "78ba44bbc4f3d93ef6c924b08525b9f5ed19aaa5", "url": "https://github.com/confluentinc/ksql/commit/78ba44bbc4f3d93ef6c924b08525b9f5ed19aaa5", "message": "Merge branch '5.3.x' into 5.4.x", "committedDate": "2020-03-13T03:20:38Z", "type": "commit"}, {"oid": "6f45803713a3e0697533487aa4c43ddbb0a762d1", "url": "https://github.com/confluentinc/ksql/commit/6f45803713a3e0697533487aa4c43ddbb0a762d1", "message": "fix: build (#4767)", "committedDate": "2020-03-13T05:22:19Z", "type": "commit"}, {"oid": "a599a27d257958c932091e45340d016e6d568897", "url": "https://github.com/confluentinc/ksql/commit/a599a27d257958c932091e45340d016e6d568897", "message": "Merge branch '5.4.x' into 5.5.x", "committedDate": "2020-03-13T06:14:39Z", "type": "commit"}, {"oid": "612ce3c3898eeffe21ac1672fef384c66e5ed8d3", "url": "https://github.com/confluentinc/ksql/commit/612ce3c3898eeffe21ac1672fef384c66e5ed8d3", "message": "Merge branch '5.5.x'", "committedDate": "2020-03-13T06:15:59Z", "type": "commit"}, {"oid": "d87b97d0b9807c340a26610124fabc9a5a799f3d", "url": "https://github.com/confluentinc/ksql/commit/d87b97d0b9807c340a26610124fabc9a5a799f3d", "message": "fix: fix the half-fixed json decimal tests (#4768)\n\nOne of our serializers has a fix for correctly formatting decimals,\r\nthe other one doesnt. So update the json test cases to reflect this", "committedDate": "2020-03-13T17:11:31Z", "type": "commit"}, {"oid": "683ec4117e8b9dec3e90adb2e328ecfea10b72f0", "url": "https://github.com/confluentinc/ksql/commit/683ec4117e8b9dec3e90adb2e328ecfea10b72f0", "message": "Merge branch '5.3.3-post' into 5.4.0-post", "committedDate": "2020-03-13T17:21:20Z", "type": "commit"}, {"oid": "223e3d6585e5f78d392d32af4796101c7edbb23e", "url": "https://github.com/confluentinc/ksql/commit/223e3d6585e5f78d392d32af4796101c7edbb23e", "message": "Merge branch '5.4.0-post' into 5.4.1-post", "committedDate": "2020-03-13T17:21:30Z", "type": "commit"}, {"oid": "f3313bc823448046f1028f2006375531ee9246f1", "url": "https://github.com/confluentinc/ksql/commit/f3313bc823448046f1028f2006375531ee9246f1", "message": "Merge branch '5.3.3-post' into 5.3.x", "committedDate": "2020-03-13T17:21:35Z", "type": "commit"}, {"oid": "e9906069749494aafa045efdc2fb58d597913029", "url": "https://github.com/confluentinc/ksql/commit/e9906069749494aafa045efdc2fb58d597913029", "message": "Merge branch '5.4.1-post' into 5.4.x", "committedDate": "2020-03-13T17:21:42Z", "type": "commit"}, {"oid": "a46f6d591fc2bd8c3b444298dc9bcafb94d2c007", "url": "https://github.com/confluentinc/ksql/commit/a46f6d591fc2bd8c3b444298dc9bcafb94d2c007", "message": "Merge branch '5.3.x' into 5.4.x", "committedDate": "2020-03-13T17:21:48Z", "type": "commit"}, {"oid": "723ee0e422338c520ccdc462c46202188e0f2db7", "url": "https://github.com/confluentinc/ksql/commit/723ee0e422338c520ccdc462c46202188e0f2db7", "message": "Merge branch '5.4.x' into 5.5.x", "committedDate": "2020-03-13T17:21:55Z", "type": "commit"}, {"oid": "56be25b3dde4270269b88e89194b287d7f185f60", "url": "https://github.com/confluentinc/ksql/commit/56be25b3dde4270269b88e89194b287d7f185f60", "message": "Merge branch '5.5.x'", "committedDate": "2020-03-13T17:22:01Z", "type": "commit"}, {"oid": "4e8e601f7398380d9f39965c417b2fc32a7d2c89", "url": "https://github.com/confluentinc/ksql/commit/4e8e601f7398380d9f39965c417b2fc32a7d2c89", "message": "fix: fix test compile goal (#4769)", "committedDate": "2020-03-13T17:34:26Z", "type": "commit"}, {"oid": "d01a647687194f7a114203ed77a13267f17dfeb9", "url": "https://github.com/confluentinc/ksql/commit/d01a647687194f7a114203ed77a13267f17dfeb9", "message": "Merge branch '5.2.x' into 5.3.x", "committedDate": "2020-03-13T19:05:47Z", "type": "commit"}, {"oid": "2a8f1e2e0f196a3ddf86d7f3a07c228bca3486a3", "url": "https://github.com/confluentinc/ksql/commit/2a8f1e2e0f196a3ddf86d7f3a07c228bca3486a3", "message": "Merge branch '5.3.x' into 5.4.x", "committedDate": "2020-03-13T19:05:57Z", "type": "commit"}, {"oid": "039fd5b772acd8c4d8f2ce69cba64b396fc13b4a", "url": "https://github.com/confluentinc/ksql/commit/039fd5b772acd8c4d8f2ce69cba64b396fc13b4a", "message": "Merge branch '5.4.x' into 5.5.x", "committedDate": "2020-03-13T19:06:08Z", "type": "commit"}, {"oid": "7bf5c120c7128d4825f74fc7e691ef2c68c6911b", "url": "https://github.com/confluentinc/ksql/commit/7bf5c120c7128d4825f74fc7e691ef2c68c6911b", "message": "Merge branch '5.5.x'", "committedDate": "2020-03-13T19:06:16Z", "type": "commit"}, {"oid": "91529da964f4ccc6be84d76ed0d28457e89a18c2", "url": "https://github.com/confluentinc/ksql/commit/91529da964f4ccc6be84d76ed0d28457e89a18c2", "message": "further test fixes. more tedious than expected", "committedDate": "2020-03-13T23:10:24Z", "type": "commit"}, {"oid": "3b7118d5f22c310d1d5b1ed4e71aa713792c849f", "url": "https://github.com/confluentinc/ksql/commit/3b7118d5f22c310d1d5b1ed4e71aa713792c849f", "message": "add blank line after static imports", "committedDate": "2020-03-13T23:14:16Z", "type": "commit"}, {"oid": "f685279e468daf893ceadf4905cd450524f60149", "url": "https://github.com/confluentinc/ksql/commit/f685279e468daf893ceadf4905cd450524f60149", "message": "fix directory test", "committedDate": "2020-03-13T23:14:16Z", "type": "commit"}, {"oid": "7e7c41b181d3bf0aa426d1d4225a75daf58bb36d", "url": "https://github.com/confluentinc/ksql/commit/7e7c41b181d3bf0aa426d1d4225a75daf58bb36d", "message": "cleanup", "committedDate": "2020-03-13T23:18:08Z", "type": "commit"}, {"oid": "4589324ed6228ac1c4d72b8ea129c5aab5de2d0f", "url": "https://github.com/confluentinc/ksql/commit/4589324ed6228ac1c4d72b8ea129c5aab5de2d0f", "message": "oops on rebase of one test", "committedDate": "2020-03-13T23:46:49Z", "type": "commit"}]}