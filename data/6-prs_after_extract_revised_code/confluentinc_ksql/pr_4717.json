{"pr_number": 4717, "pr_title": "fix: create schemas at topic creation", "pr_createdAt": "2020-03-05T22:53:45Z", "pr_url": "https://github.com/confluentinc/ksql/pull/4717", "timeline": [{"oid": "fe23730e722a6d3f1d9cfac1480f76d12d882123", "url": "https://github.com/confluentinc/ksql/commit/fe23730e722a6d3f1d9cfac1480f76d12d882123", "message": "fix: create schemas at topic creation", "committedDate": "2020-03-06T01:12:28Z", "type": "forcePushed"}, {"oid": "0f0b1f5f9f7aaa6627bfa2a3cdb8866669bad932", "url": "https://github.com/confluentinc/ksql/commit/0f0b1f5f9f7aaa6627bfa2a3cdb8866669bad932", "message": "fix: create schemas at topic creation", "committedDate": "2020-03-06T17:52:50Z", "type": "commit"}, {"oid": "0f0b1f5f9f7aaa6627bfa2a3cdb8866669bad932", "url": "https://github.com/confluentinc/ksql/commit/0f0b1f5f9f7aaa6627bfa2a3cdb8866669bad932", "message": "fix: create schemas at topic creation", "committedDate": "2020-03-06T17:52:50Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTcyMjQ0MA==", "url": "https://github.com/confluentinc/ksql/pull/4717#discussion_r389722440", "bodyText": "I don't think we should make this public.  It's an internal impl detail of the engine and should IMHO remain that way.\nIf you just parse, prepare + execute the query against a sandbox of the engine, (as the rest api normally does), then you'll get back a query, and you can get the schema from that query.\nYes, this is executing some bits we don't need. But it maintains better decoupling in the code IMHO.\nIf we really want to expose logical plans, then we should expose them through the engine.", "author": "big-andy-coates", "createdAt": "2020-03-09T14:24:29Z", "path": "ksql-engine/src/main/java/io/confluent/ksql/engine/QueryEngine.java", "diffHunk": "@@ -42,7 +42,7 @@\n import org.slf4j.LoggerFactory;\n \n // CHECKSTYLE_RULES.OFF: ClassDataAbstractionCoupling\n-class QueryEngine {\n+public class QueryEngine {", "originalCommit": "0f0b1f5f9f7aaa6627bfa2a3cdb8866669bad932", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTgxMzE2OA==", "url": "https://github.com/confluentinc/ksql/pull/4717#discussion_r389813168", "bodyText": "I'm happy with your suggestion and will do that.", "author": "agavra", "createdAt": "2020-03-09T16:37:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTcyMjQ0MA=="}], "type": "inlineReview", "revised_code": {"commit": "313c30fd1b58c4d8471d153ecc9645961d5059a6", "chunk": "diff --git a/ksql-engine/src/main/java/io/confluent/ksql/engine/QueryEngine.java b/ksql-engine/src/main/java/io/confluent/ksql/engine/QueryEngine.java\nindex 549a854c74..841e8125d1 100644\n--- a/ksql-engine/src/main/java/io/confluent/ksql/engine/QueryEngine.java\n+++ b/ksql-engine/src/main/java/io/confluent/ksql/engine/QueryEngine.java\n\n@@ -42,7 +42,7 @@ import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n // CHECKSTYLE_RULES.OFF: ClassDataAbstractionCoupling\n-public class QueryEngine {\n+class QueryEngine {\n   // CHECKSTYLE_RULES.ON: ClassDataAbstractionCoupling\n \n   private static final Logger LOG = LoggerFactory.getLogger(QueryEngine.class);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTcyMzA4MQ==", "url": "https://github.com/confluentinc/ksql/pull/4717#discussion_r389723081", "bodyText": "I'd personally handle this as a separate injector.  Keep this injector focused on topic creation.\nI can see that topic creation is related to schema creation - but the injectors are chained anyway.", "author": "big-andy-coates", "createdAt": "2020-03-09T14:25:27Z", "path": "ksql-engine/src/main/java/io/confluent/ksql/topic/TopicCreateInjector.java", "diffHunk": "@@ -53,18 +63,25 @@\n \n   private final KafkaTopicClient topicClient;\n   private final MetaStore metaStore;\n+  private final SchemaRegistryClient srClient;", "originalCommit": "0f0b1f5f9f7aaa6627bfa2a3cdb8866669bad932", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTgxNDI3NQ==", "url": "https://github.com/confluentinc/ksql/pull/4717#discussion_r389814275", "bodyText": "At first I had tried doing that and now I can't remember why I didn't end up going that route. I'll go ahead and do that.", "author": "agavra", "createdAt": "2020-03-09T16:39:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTcyMzA4MQ=="}], "type": "inlineReview", "revised_code": {"commit": "313c30fd1b58c4d8471d153ecc9645961d5059a6", "chunk": "diff --git a/ksql-engine/src/main/java/io/confluent/ksql/topic/TopicCreateInjector.java b/ksql-engine/src/main/java/io/confluent/ksql/topic/TopicCreateInjector.java\nindex cc3b094a9c..b6f897be55 100644\n--- a/ksql-engine/src/main/java/io/confluent/ksql/topic/TopicCreateInjector.java\n+++ b/ksql-engine/src/main/java/io/confluent/ksql/topic/TopicCreateInjector.java\n\n@@ -63,25 +53,18 @@ public class TopicCreateInjector implements Injector {\n \n   private final KafkaTopicClient topicClient;\n   private final MetaStore metaStore;\n-  private final SchemaRegistryClient srClient;\n \n   public TopicCreateInjector(\n       final KsqlExecutionContext executionContext,\n       final ServiceContext serviceContext\n   ) {\n-    this(\n-        serviceContext.getTopicClient(),\n-        serviceContext.getSchemaRegistryClient(),\n-        executionContext.getMetaStore()\n-    );\n+    this(serviceContext.getTopicClient(), executionContext.getMetaStore());\n   }\n \n   TopicCreateInjector(\n       final KafkaTopicClient topicClient,\n-      final SchemaRegistryClient schemaRegistryClient,\n       final MetaStore metaStore) {\n     this.topicClient = Objects.requireNonNull(topicClient, \"topicClient\");\n-    this.srClient = Objects.requireNonNull(schemaRegistryClient, \"schemaRegistryClient\");\n     this.metaStore = Objects.requireNonNull(metaStore, \"metaStore\");\n   }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTcyNzAzMg==", "url": "https://github.com/confluentinc/ksql/pull/4717#discussion_r389727032", "bodyText": "I think this is missing some tests around what happens if schema registration fails...", "author": "big-andy-coates", "createdAt": "2020-03-09T14:31:03Z", "path": "ksql-engine/src/test/java/io/confluent/ksql/topic/TopicCreateInjectorTest.java", "diffHunk": "@@ -425,6 +440,74 @@ public void shouldCreateMissingTopicWithDefaultCleanupPolicyForWindowedTables()\n         ImmutableMap.of());\n   }\n \n+  @Test\n+  public void shouldNotRegisterSchemaIfSchemaRegistryIsDisabled() {\n+    // Given:\n+    config = new KsqlConfig(ImmutableMap.of());\n+    givenStatement(\"CREATE STREAM x (f1 VARCHAR) WITH(kafka_topic='expectedName', value_format='AVRO', partitions=1);\");\n+    when(builder.build()).thenReturn(new TopicProperties(\"expectedName\", 10, (short) 10));\n+\n+    // When:\n+    injector.inject(statement, builder);\n+\n+    // Then:\n+    verifyNoMoreInteractions(schemaRegistryClient);\n+  }", "originalCommit": "0f0b1f5f9f7aaa6627bfa2a3cdb8866669bad932", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "313c30fd1b58c4d8471d153ecc9645961d5059a6", "chunk": "diff --git a/ksql-engine/src/test/java/io/confluent/ksql/topic/TopicCreateInjectorTest.java b/ksql-engine/src/test/java/io/confluent/ksql/topic/TopicCreateInjectorTest.java\nindex fb29dfb7cb..1dd436b5d2 100644\n--- a/ksql-engine/src/test/java/io/confluent/ksql/topic/TopicCreateInjectorTest.java\n+++ b/ksql-engine/src/test/java/io/confluent/ksql/topic/TopicCreateInjectorTest.java\n\n@@ -440,74 +425,6 @@ public class TopicCreateInjectorTest {\n         ImmutableMap.of());\n   }\n \n-  @Test\n-  public void shouldNotRegisterSchemaIfSchemaRegistryIsDisabled() {\n-    // Given:\n-    config = new KsqlConfig(ImmutableMap.of());\n-    givenStatement(\"CREATE STREAM x (f1 VARCHAR) WITH(kafka_topic='expectedName', value_format='AVRO', partitions=1);\");\n-    when(builder.build()).thenReturn(new TopicProperties(\"expectedName\", 10, (short) 10));\n-\n-    // When:\n-    injector.inject(statement, builder);\n-\n-    // Then:\n-    verifyNoMoreInteractions(schemaRegistryClient);\n-  }\n-\n-  @Test\n-  public void shouldNotRegisterSchemaForSchemaRegistryDisabledFormatCreateSource() {\n-    // Given:\n-    givenStatement(\"CREATE STREAM x (f1 VARCHAR) WITH(kafka_topic='expectedName', value_format='DELIMITED', partitions=1);\");\n-    when(builder.build()).thenReturn(new TopicProperties(\"expectedName\", 10, (short) 10));\n-\n-    // When:\n-    injector.inject(statement, builder);\n-\n-    // Then:\n-    verifyNoMoreInteractions(schemaRegistryClient);\n-  }\n-\n-  @Test\n-  public void shouldRegisterSchemaForSchemaRegistryEnabledFormatCreateSource()\n-      throws IOException, RestClientException {\n-    // Given:\n-    givenStatement(\"CREATE STREAM x (f1 VARCHAR) WITH (kafka_topic='expectedName', value_format='AVRO', partitions=1);\");\n-    when(builder.build()).thenReturn(new TopicProperties(\"expectedName\", 10, (short) 10));\n-\n-    // When:\n-    injector.inject(statement, builder);\n-\n-    // Then:\n-    verify(schemaRegistryClient).register(\"expectedName-value\", AVRO_SCHEMA);\n-  }\n-\n-  @Test\n-  public void shouldNotRegisterSchemaForSchemaRegistryDisabledFormatCreateAsSelect() {\n-    // Given:\n-    givenStatement(\"CREATE STREAM x WITH(value_format='DELIMITED') AS SELECT * FROM SOURCE;\");\n-    when(builder.build()).thenReturn(new TopicProperties(\"expectedName\", 10, (short) 10));\n-\n-    // When:\n-    injector.inject(statement, builder);\n-\n-    // Then:\n-    verifyNoMoreInteractions(schemaRegistryClient);\n-  }\n-\n-  @Test\n-  public void shouldRegisterSchemaForSchemaRegistryEnabledFormatCreateAsSelect()\n-      throws IOException, RestClientException {\n-    // Given:\n-    givenStatement(\"CREATE STREAM x WITH(value_format='AVRO') AS SELECT * FROM SOURCE;\");\n-    when(builder.build()).thenReturn(new TopicProperties(\"expectedName\", 10, (short) 10));\n-\n-    // When:\n-    injector.inject(statement, builder);\n-\n-    // Then:\n-    verify(schemaRegistryClient).register(\"expectedName-value\", AVRO_SCHEMA);\n-  }\n-\n   @Test\n   public void shouldHaveSuperUsefulErrorMessageIfCreateWithNoPartitions() {\n     // Given:\n"}}, {"oid": "313c30fd1b58c4d8471d153ecc9645961d5059a6", "url": "https://github.com/confluentinc/ksql/commit/313c30fd1b58c4d8471d153ecc9645961d5059a6", "message": "refactor: apply andys requested changes", "committedDate": "2020-03-09T18:56:12Z", "type": "commit"}, {"oid": "4970d0634b22dcc16f42514c1e79882b6bb5f174", "url": "https://github.com/confluentinc/ksql/commit/4970d0634b22dcc16f42514c1e79882b6bb5f174", "message": "chore: uncomment sr url", "committedDate": "2020-03-10T22:25:51Z", "type": "commit"}]}