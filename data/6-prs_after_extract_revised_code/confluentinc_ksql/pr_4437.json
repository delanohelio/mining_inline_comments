{"pr_number": 4437, "pr_title": "refactor: introduce Format interface", "pr_createdAt": "2020-02-04T20:10:34Z", "pr_url": "https://github.com/confluentinc/ksql/pull/4437", "timeline": [{"oid": "5ca39a67e1c491ea5a1e46837a2020ad35f8ec50", "url": "https://github.com/confluentinc/ksql/commit/5ca39a67e1c491ea5a1e46837a2020ad35f8ec50", "message": "refactor: introduce Format interface", "committedDate": "2020-02-04T21:21:18Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDkxOTEyNw==", "url": "https://github.com/confluentinc/ksql/pull/4437#discussion_r374919127", "bodyText": "We're adding a abstract base class just to overload toString?   Yuck! Just call name() rather than use toString().\nThis is even more true considering we're to support pluggable formats: we can't rely on other people correctly overloading toString, so we shouldn't rely on it.", "author": "big-andy-coates", "createdAt": "2020-02-04T20:59:10Z", "path": "ksql-serde/src/main/java/io/confluent/ksql/serde/AbstractFormat.java", "diffHunk": "@@ -0,0 +1,24 @@\n+/*\n+ * Copyright 2020 Confluent Inc.\n+ *\n+ * Licensed under the Confluent Community License (the \"License\"; you may not use\n+ * this file except in compliance with the License. You may obtain a copy of the\n+ * License at\n+ *\n+ * http://www.confluent.io/confluent-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OF ANY KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package io.confluent.ksql.serde;\n+\n+public abstract class AbstractFormat implements Format {\n+\n+  @Override\n+  public String toString() {\n+    return name();\n+  }", "originalCommit": "8309e29721baa09aa3ea64661143cbdf4268a32d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "4ce59863a1245487d271a9cf4ca51759c9e1557f", "chunk": "diff --git a/ksql-serde/src/main/java/io/confluent/ksql/serde/AbstractFormat.java b/ksql-serde/src/main/java/io/confluent/ksql/serde/AbstractFormat.java\ndeleted file mode 100644\nindex 3c217ab9cb..0000000000\n--- a/ksql-serde/src/main/java/io/confluent/ksql/serde/AbstractFormat.java\n+++ /dev/null\n\n@@ -1,24 +0,0 @@\n-/*\n- * Copyright 2020 Confluent Inc.\n- *\n- * Licensed under the Confluent Community License (the \"License\"; you may not use\n- * this file except in compliance with the License. You may obtain a copy of the\n- * License at\n- *\n- * http://www.confluent.io/confluent-community-license\n- *\n- * Unless required by applicable law or agreed to in writing, software\n- * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n- * WARRANTIES OF ANY KIND, either express or implied.  See the License for the\n- * specific language governing permissions and limitations under the License.\n- */\n-\n-package io.confluent.ksql.serde;\n-\n-public abstract class AbstractFormat implements Format {\n-\n-  @Override\n-  public String toString() {\n-    return name();\n-  }\n-}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDkxOTUwOQ==", "url": "https://github.com/confluentinc/ksql/pull/4437#discussion_r374919509", "bodyText": "Document if its case sensitive?", "author": "big-andy-coates", "createdAt": "2020-02-04T20:59:52Z", "path": "ksql-serde/src/main/java/io/confluent/ksql/serde/Format.java", "diffHunk": "@@ -15,69 +15,29 @@\n \n package io.confluent.ksql.serde;\n \n-import com.google.common.collect.ImmutableSet;\n import com.google.common.collect.Sets;\n import com.google.common.collect.Sets.SetView;\n-import io.confluent.ksql.serde.avro.KsqlAvroSerdeFactory;\n-import io.confluent.ksql.serde.delimited.KsqlDelimitedSerdeFactory;\n-import io.confluent.ksql.serde.json.KsqlJsonSerdeFactory;\n-import io.confluent.ksql.serde.kafka.KafkaSerdeFactory;\n-import io.confluent.ksql.util.KsqlConstants;\n import io.confluent.ksql.util.KsqlException;\n import java.util.Map;\n-import java.util.Optional;\n import java.util.Set;\n \n-public enum Format {\n-\n-  JSON(true, ImmutableSet.of(), ImmutableSet.of()) {\n-    @Override\n-    public KsqlSerdeFactory getSerdeFactory(final FormatInfo info) {\n-      return new KsqlJsonSerdeFactory();\n-    }\n-  },\n-\n-  AVRO(true, ImmutableSet.of(FormatInfo.FULL_SCHEMA_NAME), ImmutableSet.of()) {\n-    @Override\n-    public KsqlSerdeFactory getSerdeFactory(final FormatInfo info) {\n-      final String schemaFullName = info.getProperties()\n-          .getOrDefault(FormatInfo.FULL_SCHEMA_NAME, KsqlConstants.DEFAULT_AVRO_SCHEMA_FULL_NAME);\n-\n-      return new KsqlAvroSerdeFactory(schemaFullName);\n-    }\n-  },\n-\n-  DELIMITED(false, ImmutableSet.of(FormatInfo.DELIMITER), ImmutableSet.of(FormatInfo.DELIMITER)) {\n-    @Override\n-    public KsqlSerdeFactory getSerdeFactory(final FormatInfo info) {\n-      return new KsqlDelimitedSerdeFactory(\n-          Optional.ofNullable(\n-              info.getProperties().get(FormatInfo.DELIMITER)\n-          ).map(Delimiter::parse)\n-      );\n-    }\n-  },\n-\n-  KAFKA(false, ImmutableSet.of(), ImmutableSet.of()) {\n-    @Override\n-    public KsqlSerdeFactory getSerdeFactory(final FormatInfo info) {\n-      return new KafkaSerdeFactory();\n-    }\n-  };\n-\n-  private final boolean supportsUnwrapping;\n-  private final Set<String> validConfigs;\n-  private final Set<String> inheritableProperties;\n+/**\n+ * A {@code Format} is a serialization specification of a Kafka topic\n+ * in ksqlDB. The builtin formats are specified in the {@link Formats}\n+ * class.\n+ */\n+public interface Format {\n \n-  Format(\n-      final boolean supportsUnwrapping,\n-      final Set<String> validConfigs,\n-      final Set<String> inheritableProperties\n-  ) {\n-    this.supportsUnwrapping = supportsUnwrapping;\n-    this.validConfigs = validConfigs;\n-    this.inheritableProperties = inheritableProperties;\n-  }\n+  /**\n+   * The name of the {@code Format} specification. If this format supports\n+   * Confluent Schema Registry integration (either builtin or custom via the\n+   * {@code ParsedSchema} plugin support), this should match the value returned\n+   * by {@link io.confluent.kafka.schemaregistry.ParsedSchema#name}.\n+   *\n+   * @return the name of this Format\n+   * @see #supportsSchemaInference()\n+   */\n+  String name();", "originalCommit": "8309e29721baa09aa3ea64661143cbdf4268a32d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5ca39a67e1c491ea5a1e46837a2020ad35f8ec50", "chunk": "diff --git a/ksql-serde/src/main/java/io/confluent/ksql/serde/Format.java b/ksql-serde/src/main/java/io/confluent/ksql/serde/Format.java\nindex fd9e15b680..92640b9b8c 100644\n--- a/ksql-serde/src/main/java/io/confluent/ksql/serde/Format.java\n+++ b/ksql-serde/src/main/java/io/confluent/ksql/serde/Format.java\n\n@@ -35,7 +35,6 @@ public interface Format {\n    * by {@link io.confluent.kafka.schemaregistry.ParsedSchema#name}.\n    *\n    * @return the name of this Format\n-   * @see #supportsSchemaInference()\n    */\n   String name();\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDkyMTQ0MQ==", "url": "https://github.com/confluentinc/ksql/pull/4437#discussion_r374921441", "bodyText": "Having written this code I now know that this should be the other way around, i.e. it should be supportsWrapping, which effectively means 'it supports wrapping multiple columns into fields of some anonymous outer object', e.g. like a JSON object or a Protobuf message.\nUnfortunately, I've never found the time to flip this.  But it would clean up some nasties in the code.\nIf we're making this a public API then I'd flip this first.", "author": "big-andy-coates", "createdAt": "2020-02-04T21:03:57Z", "path": "ksql-serde/src/main/java/io/confluent/ksql/serde/Format.java", "diffHunk": "@@ -86,18 +46,37 @@ public KsqlSerdeFactory getSerdeFactory(final FormatInfo info) {\n    *\n    * @return whether or not this format supports unwrapping\n    */\n-  public boolean supportsUnwrapping() {\n-    return supportsUnwrapping;\n+  default boolean supportsUnwrapping() {\n+    return false;", "originalCommit": "8309e29721baa09aa3ea64661143cbdf4268a32d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5ca39a67e1c491ea5a1e46837a2020ad35f8ec50", "chunk": "diff --git a/ksql-serde/src/main/java/io/confluent/ksql/serde/Format.java b/ksql-serde/src/main/java/io/confluent/ksql/serde/Format.java\nindex fd9e15b680..92640b9b8c 100644\n--- a/ksql-serde/src/main/java/io/confluent/ksql/serde/Format.java\n+++ b/ksql-serde/src/main/java/io/confluent/ksql/serde/Format.java\n\n@@ -50,19 +49,6 @@ public interface Format {\n     return false;\n   }\n \n-  /**\n-   * Whether or not this format can infer the schema without supplying the\n-   * table elements in the {@code CREATE} clause. If it does, it is necessary\n-   * that the {@link #name()} is identical to the name specified in the corresponding\n-   * {@link io.confluent.kafka.schemaregistry.ParsedSchema#name}\n-   *\n-   * @return {@code true} if this {@code Format} supports schema inference\n-   *         through Confluent Schema Registry.\n-   */\n-  default boolean supportsSchemaInference() {\n-    return false;\n-  }\n-\n   /**\n    * If the format accepts custom properties in the WITH clause of the statement,\n    * then this will take the properties and validate the key-value pairs.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDkyMTgyNg==", "url": "https://github.com/confluentinc/ksql/pull/4437#discussion_r374921826", "bodyText": "Can we add a @PublicApi annotation and mark this with it, (and any others you can think of, e.g. UDF family of stuff).\n(Separate PR, obvs).", "author": "big-andy-coates", "createdAt": "2020-02-04T21:04:49Z", "path": "ksql-serde/src/main/java/io/confluent/ksql/serde/Format.java", "diffHunk": "@@ -15,69 +15,29 @@\n \n package io.confluent.ksql.serde;\n \n-import com.google.common.collect.ImmutableSet;\n import com.google.common.collect.Sets;\n import com.google.common.collect.Sets.SetView;\n-import io.confluent.ksql.serde.avro.KsqlAvroSerdeFactory;\n-import io.confluent.ksql.serde.delimited.KsqlDelimitedSerdeFactory;\n-import io.confluent.ksql.serde.json.KsqlJsonSerdeFactory;\n-import io.confluent.ksql.serde.kafka.KafkaSerdeFactory;\n-import io.confluent.ksql.util.KsqlConstants;\n import io.confluent.ksql.util.KsqlException;\n import java.util.Map;\n-import java.util.Optional;\n import java.util.Set;\n \n-public enum Format {\n-\n-  JSON(true, ImmutableSet.of(), ImmutableSet.of()) {\n-    @Override\n-    public KsqlSerdeFactory getSerdeFactory(final FormatInfo info) {\n-      return new KsqlJsonSerdeFactory();\n-    }\n-  },\n-\n-  AVRO(true, ImmutableSet.of(FormatInfo.FULL_SCHEMA_NAME), ImmutableSet.of()) {\n-    @Override\n-    public KsqlSerdeFactory getSerdeFactory(final FormatInfo info) {\n-      final String schemaFullName = info.getProperties()\n-          .getOrDefault(FormatInfo.FULL_SCHEMA_NAME, KsqlConstants.DEFAULT_AVRO_SCHEMA_FULL_NAME);\n-\n-      return new KsqlAvroSerdeFactory(schemaFullName);\n-    }\n-  },\n-\n-  DELIMITED(false, ImmutableSet.of(FormatInfo.DELIMITER), ImmutableSet.of(FormatInfo.DELIMITER)) {\n-    @Override\n-    public KsqlSerdeFactory getSerdeFactory(final FormatInfo info) {\n-      return new KsqlDelimitedSerdeFactory(\n-          Optional.ofNullable(\n-              info.getProperties().get(FormatInfo.DELIMITER)\n-          ).map(Delimiter::parse)\n-      );\n-    }\n-  },\n-\n-  KAFKA(false, ImmutableSet.of(), ImmutableSet.of()) {\n-    @Override\n-    public KsqlSerdeFactory getSerdeFactory(final FormatInfo info) {\n-      return new KafkaSerdeFactory();\n-    }\n-  };\n-\n-  private final boolean supportsUnwrapping;\n-  private final Set<String> validConfigs;\n-  private final Set<String> inheritableProperties;\n+/**\n+ * A {@code Format} is a serialization specification of a Kafka topic\n+ * in ksqlDB. The builtin formats are specified in the {@link Formats}\n+ * class.\n+ */\n+public interface Format {", "originalCommit": "8309e29721baa09aa3ea64661143cbdf4268a32d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDk1MDc4Mg==", "url": "https://github.com/confluentinc/ksql/pull/4437#discussion_r374950782", "bodyText": "#4439 - it isn't public quite yet, but I'll make sure to create some sort of annotation for this and the others", "author": "agavra", "createdAt": "2020-02-04T22:07:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDkyMTgyNg=="}], "type": "inlineReview", "revised_code": {"commit": "5ca39a67e1c491ea5a1e46837a2020ad35f8ec50", "chunk": "diff --git a/ksql-serde/src/main/java/io/confluent/ksql/serde/Format.java b/ksql-serde/src/main/java/io/confluent/ksql/serde/Format.java\nindex fd9e15b680..92640b9b8c 100644\n--- a/ksql-serde/src/main/java/io/confluent/ksql/serde/Format.java\n+++ b/ksql-serde/src/main/java/io/confluent/ksql/serde/Format.java\n\n@@ -35,7 +35,6 @@ public interface Format {\n    * by {@link io.confluent.kafka.schemaregistry.ParsedSchema#name}.\n    *\n    * @return the name of this Format\n-   * @see #supportsSchemaInference()\n    */\n   String name();\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDkyMjAyMQ==", "url": "https://github.com/confluentinc/ksql/pull/4437#discussion_r374922021", "bodyText": "nice :D", "author": "big-andy-coates", "createdAt": "2020-02-04T21:05:16Z", "path": "ksql-serde/src/main/java/io/confluent/ksql/serde/Format.java", "diffHunk": "@@ -86,18 +46,37 @@ public KsqlSerdeFactory getSerdeFactory(final FormatInfo info) {\n    *\n    * @return whether or not this format supports unwrapping\n    */\n-  public boolean supportsUnwrapping() {\n-    return supportsUnwrapping;\n+  default boolean supportsUnwrapping() {\n+    return false;\n   }\n \n   /**\n+   * Whether or not this format can infer the schema without supplying the\n+   * table elements in the {@code CREATE} clause. If it does, it is necessary\n+   * that the {@link #name()} is identical to the name specified in the corresponding\n+   * {@link io.confluent.kafka.schemaregistry.ParsedSchema#name}\n+   *\n+   * @return {@code true} if this {@code Format} supports schema inference\n+   *         through Confluent Schema Registry.\n+   */\n+  default boolean supportsSchemaInference() {", "originalCommit": "8309e29721baa09aa3ea64661143cbdf4268a32d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5ca39a67e1c491ea5a1e46837a2020ad35f8ec50", "chunk": "diff --git a/ksql-serde/src/main/java/io/confluent/ksql/serde/Format.java b/ksql-serde/src/main/java/io/confluent/ksql/serde/Format.java\nindex fd9e15b680..92640b9b8c 100644\n--- a/ksql-serde/src/main/java/io/confluent/ksql/serde/Format.java\n+++ b/ksql-serde/src/main/java/io/confluent/ksql/serde/Format.java\n\n@@ -50,19 +49,6 @@ public interface Format {\n     return false;\n   }\n \n-  /**\n-   * Whether or not this format can infer the schema without supplying the\n-   * table elements in the {@code CREATE} clause. If it does, it is necessary\n-   * that the {@link #name()} is identical to the name specified in the corresponding\n-   * {@link io.confluent.kafka.schemaregistry.ParsedSchema#name}\n-   *\n-   * @return {@code true} if this {@code Format} supports schema inference\n-   *         through Confluent Schema Registry.\n-   */\n-  default boolean supportsSchemaInference() {\n-    return false;\n-  }\n-\n   /**\n    * If the format accepts custom properties in the WITH clause of the statement,\n    * then this will take the properties and validate the key-value pairs.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDkyMjMxMw==", "url": "https://github.com/confluentinc/ksql/pull/4437#discussion_r374922313", "bodyText": "default to empty set?", "author": "big-andy-coates", "createdAt": "2020-02-04T21:05:48Z", "path": "ksql-serde/src/main/java/io/confluent/ksql/serde/Format.java", "diffHunk": "@@ -107,6 +86,16 @@ public void validateProperties(final Map<String, String> properties) {\n     });\n   }\n \n+  /**\n+   * If the format accepts custom properties in the WITH clause of the statement,\n+   * this method dictates which property keys are valid keys. This is used in\n+   * conjunction with {@link #validateProperties(Map)} to ensure that the format\n+   * configuration is valid.\n+   *\n+   * @return a set of valid property names\n+   */\n+  Set<String> getSupportedProperties();", "originalCommit": "8309e29721baa09aa3ea64661143cbdf4268a32d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDk1OTc3NA==", "url": "https://github.com/confluentinc/ksql/pull/4437#discussion_r374959774", "bodyText": "I was debating this or forcing people to implement it - I'm happy defaulting to empty set.", "author": "agavra", "createdAt": "2020-02-04T22:29:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDkyMjMxMw=="}], "type": "inlineReview", "revised_code": {"commit": "4ce59863a1245487d271a9cf4ca51759c9e1557f", "chunk": "diff --git a/ksql-serde/src/main/java/io/confluent/ksql/serde/Format.java b/ksql-serde/src/main/java/io/confluent/ksql/serde/Format.java\nindex fd9e15b680..d207ce3ac2 100644\n--- a/ksql-serde/src/main/java/io/confluent/ksql/serde/Format.java\n+++ b/ksql-serde/src/main/java/io/confluent/ksql/serde/Format.java\n\n@@ -94,12 +99,14 @@ public interface Format {\n    *\n    * @return a set of valid property names\n    */\n-  Set<String> getSupportedProperties();\n+  default Set<String> getSupportedProperties() {\n+    return ImmutableSet.of();\n+  }\n \n   /**\n    * Specifies the set of \"inheritable\" properties - these properties will\n    * persist across streams and tables if a sink is created from a source\n-   * of the same type and does not explicitly overwrite the property.\n+   * of the same format and does not explicitly overwrite the property.\n    *\n    * <p>For example, if a stream with format {@code DELIMITED} was created\n    * with {@code VALUE_DELIMITER='x'}, any {@code DELIMITED} sinks that are\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDkyMzE3MA==", "url": "https://github.com/confluentinc/ksql/pull/4437#discussion_r374923170", "bodyText": "nit: on the javadoc\n\nSpecifies the set of \"inheritable\" properties - these properties will persist across streams and tables if a sink is created from a source of the same type and does not explicitly overwrite the property.\n\nDon't really know what 'source of the same type' means.  Do you mean the sink has the same format?", "author": "big-andy-coates", "createdAt": "2020-02-04T21:07:39Z", "path": "ksql-serde/src/main/java/io/confluent/ksql/serde/Format.java", "diffHunk": "@@ -117,25 +106,18 @@ public void validateProperties(final Map<String, String> properties) {\n    * created with that stream as its source will also have the same delimiter\n    * value of {@code x}</p>\n    *\n+   * <p>The default implementation of this method assumes that all of the\n+   * supported properties are inheritable.</p>\n+   *\n    * @return the set of properties that are considered \"inheritable\"\n    */\n-  public Set<String> getInheritableProperties() {\n-    return inheritableProperties;\n+  default Set<String> getInheritableProperties() {", "originalCommit": "8309e29721baa09aa3ea64661143cbdf4268a32d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDk2MDIwNg==", "url": "https://github.com/confluentinc/ksql/pull/4437#discussion_r374960206", "bodyText": "yes - updated the javadoc to clarify this (hopefully)", "author": "agavra", "createdAt": "2020-02-04T22:30:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDkyMzE3MA=="}], "type": "inlineReview", "revised_code": {"commit": "4ce59863a1245487d271a9cf4ca51759c9e1557f", "chunk": "diff --git a/ksql-serde/src/main/java/io/confluent/ksql/serde/Format.java b/ksql-serde/src/main/java/io/confluent/ksql/serde/Format.java\nindex fd9e15b680..d207ce3ac2 100644\n--- a/ksql-serde/src/main/java/io/confluent/ksql/serde/Format.java\n+++ b/ksql-serde/src/main/java/io/confluent/ksql/serde/Format.java\n\n@@ -94,12 +99,14 @@ public interface Format {\n    *\n    * @return a set of valid property names\n    */\n-  Set<String> getSupportedProperties();\n+  default Set<String> getSupportedProperties() {\n+    return ImmutableSet.of();\n+  }\n \n   /**\n    * Specifies the set of \"inheritable\" properties - these properties will\n    * persist across streams and tables if a sink is created from a source\n-   * of the same type and does not explicitly overwrite the property.\n+   * of the same format and does not explicitly overwrite the property.\n    *\n    * <p>For example, if a stream with format {@code DELIMITED} was created\n    * with {@code VALUE_DELIMITER='x'}, any {@code DELIMITED} sinks that are\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDkyNjIxMQ==", "url": "https://github.com/confluentinc/ksql/pull/4437#discussion_r374926211", "bodyText": "If KsqlSerdeFactory is going to become part of our public API then we should give it some love to make it more extensible, e.g.:\n\nRather than passing config and SR clients as params, pass them via a Context object, which allows us to add more things to it later without needing to change the signature.\nConsider removing KSqlConfig from the method sigs completely, as this is specific to our serde classes. Instead, pluggable formats can implement Configurable if they need config.  (We should limit what config is passed to 3rd party formats just like we do for UDFs e.g. we shouldn't be passing all config that may contain secrets etc).\nmove the type checking version of createSerde out of the interface.", "author": "big-andy-coates", "createdAt": "2020-02-04T21:14:07Z", "path": "ksql-serde/src/main/java/io/confluent/ksql/serde/Format.java", "diffHunk": "@@ -117,25 +106,18 @@ public void validateProperties(final Map<String, String> properties) {\n    * created with that stream as its source will also have the same delimiter\n    * value of {@code x}</p>\n    *\n+   * <p>The default implementation of this method assumes that all of the\n+   * supported properties are inheritable.</p>\n+   *\n    * @return the set of properties that are considered \"inheritable\"\n    */\n-  public Set<String> getInheritableProperties() {\n-    return inheritableProperties;\n+  default Set<String> getInheritableProperties() {\n+    return getSupportedProperties();\n   }\n \n   /**\n    * @param info the info containing information required for generating the factory\n    * @return a {@code KsqlSerdeFactory} that generates serdes for the given format\n    */\n-  public abstract KsqlSerdeFactory getSerdeFactory(FormatInfo info);\n-\n-  public static Format of(final FormatInfo value) {\n-    try {\n-      final Format format = valueOf(value.getFormat().toUpperCase());\n-      format.validateProperties(value.getProperties());\n-      return format;\n-    } catch (final IllegalArgumentException e) {\n-      throw new KsqlException(\"Unknown format: \" + value.getFormat());\n-    }\n-  }\n+  KsqlSerdeFactory getSerdeFactory(FormatInfo info);", "originalCommit": "8309e29721baa09aa3ea64661143cbdf4268a32d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDk2MjUxNg==", "url": "https://github.com/confluentinc/ksql/pull/4437#discussion_r374962516", "bodyText": "#4441", "author": "agavra", "createdAt": "2020-02-04T22:35:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDkyNjIxMQ=="}], "type": "inlineReview", "revised_code": {"commit": "4ce59863a1245487d271a9cf4ca51759c9e1557f", "chunk": "diff --git a/ksql-serde/src/main/java/io/confluent/ksql/serde/Format.java b/ksql-serde/src/main/java/io/confluent/ksql/serde/Format.java\nindex fd9e15b680..d207ce3ac2 100644\n--- a/ksql-serde/src/main/java/io/confluent/ksql/serde/Format.java\n+++ b/ksql-serde/src/main/java/io/confluent/ksql/serde/Format.java\n\n@@ -94,12 +99,14 @@ public interface Format {\n    *\n    * @return a set of valid property names\n    */\n-  Set<String> getSupportedProperties();\n+  default Set<String> getSupportedProperties() {\n+    return ImmutableSet.of();\n+  }\n \n   /**\n    * Specifies the set of \"inheritable\" properties - these properties will\n    * persist across streams and tables if a sink is created from a source\n-   * of the same type and does not explicitly overwrite the property.\n+   * of the same format and does not explicitly overwrite the property.\n    *\n    * <p>For example, if a stream with format {@code DELIMITED} was created\n    * with {@code VALUE_DELIMITER='x'}, any {@code DELIMITED} sinks that are\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDkyNjU1NA==", "url": "https://github.com/confluentinc/ksql/pull/4437#discussion_r374926554", "bodyText": "I take it this will grow to be a class that knows about all formats in time?", "author": "big-andy-coates", "createdAt": "2020-02-04T21:14:53Z", "path": "ksql-serde/src/main/java/io/confluent/ksql/serde/Formats.java", "diffHunk": "@@ -0,0 +1,59 @@\n+/*\n+ * Copyright 2019 Confluent Inc.\n+ *\n+ * Licensed under the Confluent Community License (the \"License\"); you may not use\n+ * this file except in compliance with the License.  You may obtain a copy of the\n+ * License at\n+ *\n+ * http://www.confluent.io/confluent-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OF ANY KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package io.confluent.ksql.serde;\n+\n+import io.confluent.ksql.serde.avro.AvroFormat;\n+import io.confluent.ksql.serde.delimited.DelimitedFormat;\n+import io.confluent.ksql.serde.json.JsonFormat;\n+import io.confluent.ksql.serde.kafka.KafkaFormat;\n+import io.confluent.ksql.util.KsqlException;\n+\n+/**\n+ * A class containing the builtin supported formats in ksqlDB.\n+ */\n+public final class Formats {", "originalCommit": "8309e29721baa09aa3ea64661143cbdf4268a32d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDk2MzA0OA==", "url": "https://github.com/confluentinc/ksql/pull/4437#discussion_r374963048", "bodyText": "This will know about only builtin formats - I haven't figured out exactly how we're going to do the factory (whether it be annotation/classpath based or configuring a plugin in config and packaging jars). At the point when that mechanism is worked out this class will probably be removed and we'll dogfood that mechanism with all format classes", "author": "agavra", "createdAt": "2020-02-04T22:36:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDkyNjU1NA=="}], "type": "inlineReview", "revised_code": {"commit": "4ce59863a1245487d271a9cf4ca51759c9e1557f", "chunk": "diff --git a/ksql-serde/src/main/java/io/confluent/ksql/serde/Formats.java b/ksql-serde/src/main/java/io/confluent/ksql/serde/FormatFactory.java\nsimilarity index 96%\nrename from ksql-serde/src/main/java/io/confluent/ksql/serde/Formats.java\nrename to ksql-serde/src/main/java/io/confluent/ksql/serde/FormatFactory.java\nindex 076ab5dc32..6f8448d55d 100644\n--- a/ksql-serde/src/main/java/io/confluent/ksql/serde/Formats.java\n+++ b/ksql-serde/src/main/java/io/confluent/ksql/serde/FormatFactory.java\n\n@@ -24,14 +24,14 @@ import io.confluent.ksql.util.KsqlException;\n /**\n  * A class containing the builtin supported formats in ksqlDB.\n  */\n-public final class Formats {\n+public final class FormatFactory {\n \n   public static final Format AVRO       = new AvroFormat();\n   public static final Format JSON       = new JsonFormat();\n   public static final Format KAFKA      = new KafkaFormat();\n   public static final Format DELIMITED  = new DelimitedFormat();\n \n-  private Formats() { }\n+  private FormatFactory() { }\n \n   /**\n    * @param formatInfo the format specification\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDkzMjcwNw==", "url": "https://github.com/confluentinc/ksql/pull/4437#discussion_r374932707", "bodyText": "Humm... just looked at how VALUE_AVRO_SCHEMA_FULL_NAME in the WITH clause is wired up to this. (Same for DELIMITED).\nThinking...\n\nRemember that we'll have key variants of these at some point soon.  I think what's there will work, i.e. we'll have to change CreateSourceAsProperties.getFormatProperties() to getValueFormatProperties() or something. Maybe if you plan ahead for key formats you may get a better long term design.  No biggie though.\nVALUE_AVRO_SCHEMA_FULL_NAME should urgently be renamed to VALUE_SCHEMA_FULL_NAME is we're soon to have Json or Protobuf schema names in there.\nCreateSourceAsProperties codifies the mapping from VALUE_AVRO_SCHEMA_FULL_NAME to fullSchemaName.  That works fine for our built in ones, but how would other formats expose their properties in the WITH clause?  Maybe the property names exposed by the formats should match the names used in the WITH clause, (with optional VALUE_ or KEY_ prefixes).", "author": "big-andy-coates", "createdAt": "2020-02-04T21:28:07Z", "path": "ksql-serde/src/main/java/io/confluent/ksql/serde/avro/AvroFormat.java", "diffHunk": "@@ -0,0 +1,59 @@\n+/*\n+ * Copyright 2020 Confluent Inc.\n+ *\n+ * Licensed under the Confluent Community License (the \"License\"; you may not use\n+ * this file except in compliance with the License. You may obtain a copy of the\n+ * License at\n+ *\n+ * http://www.confluent.io/confluent-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OF ANY KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package io.confluent.ksql.serde.avro;\n+\n+import com.google.common.collect.ImmutableSet;\n+import io.confluent.kafka.schemaregistry.avro.AvroSchema;\n+import io.confluent.ksql.serde.AbstractFormat;\n+import io.confluent.ksql.serde.FormatInfo;\n+import io.confluent.ksql.serde.KsqlSerdeFactory;\n+import io.confluent.ksql.util.KsqlConstants;\n+import java.util.Set;\n+\n+public final class AvroFormat extends AbstractFormat {\n+\n+  public static final String FULL_SCHEMA_NAME = \"fullSchemaName\";", "originalCommit": "5ca39a67e1c491ea5a1e46837a2020ad35f8ec50", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDk2NDQzNQ==", "url": "https://github.com/confluentinc/ksql/pull/4437#discussion_r374964435", "bodyText": "good point, haven't thought this through much but IMO the Formats should be agnostic of key/value formats (if they are supposed to behave differently, then they should be two different formats)\nyup, will definitely do that :)\nmy intention going forward was to ditch this mapping from whats in the WITH clause to what is used internally and have them stick to what's in the with clause. I'll create a ticket describing this", "author": "agavra", "createdAt": "2020-02-04T22:39:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDkzMjcwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDk2Njc2MQ==", "url": "https://github.com/confluentinc/ksql/pull/4437#discussion_r374966761", "bodyText": "#4444", "author": "agavra", "createdAt": "2020-02-04T22:45:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDkzMjcwNw=="}], "type": "inlineReview", "revised_code": {"commit": "4ce59863a1245487d271a9cf4ca51759c9e1557f", "chunk": "diff --git a/ksql-serde/src/main/java/io/confluent/ksql/serde/avro/AvroFormat.java b/ksql-serde/src/main/java/io/confluent/ksql/serde/avro/AvroFormat.java\nindex 46261383f0..b704ca7319 100644\n--- a/ksql-serde/src/main/java/io/confluent/ksql/serde/avro/AvroFormat.java\n+++ b/ksql-serde/src/main/java/io/confluent/ksql/serde/avro/AvroFormat.java\n\n@@ -17,13 +17,13 @@ package io.confluent.ksql.serde.avro;\n \n import com.google.common.collect.ImmutableSet;\n import io.confluent.kafka.schemaregistry.avro.AvroSchema;\n-import io.confluent.ksql.serde.AbstractFormat;\n+import io.confluent.ksql.serde.Format;\n import io.confluent.ksql.serde.FormatInfo;\n import io.confluent.ksql.serde.KsqlSerdeFactory;\n import io.confluent.ksql.util.KsqlConstants;\n import java.util.Set;\n \n-public final class AvroFormat extends AbstractFormat {\n+public final class AvroFormat implements Format {\n \n   public static final String FULL_SCHEMA_NAME = \"fullSchemaName\";\n   public static final String NAME = AvroSchema.TYPE;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDkzODI2NQ==", "url": "https://github.com/confluentinc/ksql/pull/4437#discussion_r374938265", "bodyText": "hummm... nasty name clash... can we rename one? e.g. PlanFormats? Or make your Formats something like FormatFactory?", "author": "big-andy-coates", "createdAt": "2020-02-04T21:40:33Z", "path": "ksql-engine/src/test/java/io/confluent/ksql/structured/SchemaKGroupedStreamTest.java", "diffHunk": "@@ -178,7 +177,7 @@ public void shouldBuildStepForWindowedAggregate() {\n             ExecutionStepFactory.streamWindowedAggregate(\n                 queryContext,\n                 schemaGroupedStream.getSourceStep(),\n-                Formats.of(expected, valueFormat, SerdeOption.none()),\n+                io.confluent.ksql.execution.plan.Formats.of(expected, valueFormat, SerdeOption.none()),", "originalCommit": "5ca39a67e1c491ea5a1e46837a2020ad35f8ec50", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDk2NzIyOQ==", "url": "https://github.com/confluentinc/ksql/pull/4437#discussion_r374967229", "bodyText": "renamed mine to FormatFactory because the other is in the serialized plan", "author": "agavra", "createdAt": "2020-02-04T22:46:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDkzODI2NQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "4ce59863a1245487d271a9cf4ca51759c9e1557f", "url": "https://github.com/confluentinc/ksql/commit/4ce59863a1245487d271a9cf4ca51759c9e1557f", "message": "refactor: introduce Format interface", "committedDate": "2020-02-04T22:50:24Z", "type": "forcePushed"}, {"oid": "fb33bfc96c26d678ef35adc8336dec471cb53ace", "url": "https://github.com/confluentinc/ksql/commit/fb33bfc96c26d678ef35adc8336dec471cb53ace", "message": "refactor: introduce Format interface", "committedDate": "2020-02-05T00:47:05Z", "type": "forcePushed"}, {"oid": "5f93260273f5cc21ecd831c66ce586cd3c501e43", "url": "https://github.com/confluentinc/ksql/commit/5f93260273f5cc21ecd831c66ce586cd3c501e43", "message": "refactor: introduce Format interface", "committedDate": "2020-02-05T17:03:16Z", "type": "commit"}, {"oid": "5f93260273f5cc21ecd831c66ce586cd3c501e43", "url": "https://github.com/confluentinc/ksql/commit/5f93260273f5cc21ecd831c66ce586cd3c501e43", "message": "refactor: introduce Format interface", "committedDate": "2020-02-05T17:03:16Z", "type": "forcePushed"}]}