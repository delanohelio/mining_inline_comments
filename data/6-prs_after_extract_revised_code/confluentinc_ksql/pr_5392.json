{"pr_number": 5392, "pr_title": "feat: Pull Queries: QPS check utilizes internal API flag to determine if forwarded", "pr_createdAt": "2020-05-18T19:08:09Z", "pr_url": "https://github.com/confluentinc/ksql/pull/5392", "timeline": [{"oid": "8bcf6312cb3c2b07ddd21c18c31f8b381fc455f3", "url": "https://github.com/confluentinc/ksql/commit/8bcf6312cb3c2b07ddd21c18c31f8b381fc455f3", "message": "feat: For Pull Query QPS check trust internal API if used", "committedDate": "2020-05-18T19:01:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg1NDQ1Nw==", "url": "https://github.com/confluentinc/ksql/pull/5392#discussion_r426854457", "bodyText": "In which scenarios would isInternalRequest not be available? Don't we want these two variables (skipForwardRequest and  isInternalRequest) to always either both be true or both be false? Which makes me question whether we need both.", "author": "vpapavas", "createdAt": "2020-05-18T19:43:52Z", "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/execution/PullQueryExecutor.java", "diffHunk": "@@ -178,7 +179,11 @@ public TableRowsEntity execute(\n     try {\n       final RoutingOptions routingOptions = new ConfigRoutingOptions(\n           statement.getConfig(), statement.getConfigOverrides(), statement.getRequestProperties());\n-      final boolean isAlreadyForwarded = routingOptions.skipForwardRequest();\n+      // If internal listeners are in use, we require the request to come from that listener to\n+      // treat it as having been forwarded.\n+      final boolean isAlreadyForwarded = routingOptions.skipForwardRequest() &&\n+          // Trust the forward request option if isInternalRequest isn't available.\n+          isInternalRequest.orElse(true);", "originalCommit": "8bcf6312cb3c2b07ddd21c18c31f8b381fc455f3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg3NTQxNw==", "url": "https://github.com/confluentinc/ksql/pull/5392#discussion_r426875417", "bodyText": "isInternalRequest wouldn't be available when the internal listener functionality is not enabled, so we still would want skipForwardRequest in that case where it's running in a trusted setting and still wants to know to only forward the request once.  But yes, you're right that they aim to infer the identical thing -- that this request is forwarded rather than from the end user.", "author": "AlanConfluent", "createdAt": "2020-05-18T20:27:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg1NDQ1Nw=="}], "type": "inlineReview", "revised_code": {"commit": "16c385b16398cbe891503d86a7060b0319aae738", "chunk": "diff --git a/ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/execution/PullQueryExecutor.java b/ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/execution/PullQueryExecutor.java\nindex c03b5e27d4..6a247127a5 100644\n--- a/ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/execution/PullQueryExecutor.java\n+++ b/ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/execution/PullQueryExecutor.java\n\n@@ -181,9 +181,9 @@ public final class PullQueryExecutor {\n           statement.getConfig(), statement.getConfigOverrides(), statement.getRequestProperties());\n       // If internal listeners are in use, we require the request to come from that listener to\n       // treat it as having been forwarded.\n-      final boolean isAlreadyForwarded = routingOptions.skipForwardRequest() &&\n+      final boolean isAlreadyForwarded = routingOptions.skipForwardRequest()\n           // Trust the forward request option if isInternalRequest isn't available.\n-          isInternalRequest.orElse(true);\n+          && isInternalRequest.orElse(true);\n \n       // Only check the rate limit at the forwarding host\n       if (!isAlreadyForwarded) {\n"}}, {"oid": "40f8de1b5f413da22b57873fc85bfc0a0e0b733d", "url": "https://github.com/confluentinc/ksql/commit/40f8de1b5f413da22b57873fc85bfc0a0e0b733d", "message": "For APIs that are only client facing, hardcoded internal as false", "committedDate": "2020-05-18T20:14:02Z", "type": "commit"}, {"oid": "16c385b16398cbe891503d86a7060b0319aae738", "url": "https://github.com/confluentinc/ksql/commit/16c385b16398cbe891503d86a7060b0319aae738", "message": "Fixes style", "committedDate": "2020-05-18T20:17:56Z", "type": "commit"}, {"oid": "e9263c93a45572d3327647a3d970465701227d2a", "url": "https://github.com/confluentinc/ksql/commit/e9263c93a45572d3327647a3d970465701227d2a", "message": "Fix tests", "committedDate": "2020-05-19T23:10:36Z", "type": "commit"}]}