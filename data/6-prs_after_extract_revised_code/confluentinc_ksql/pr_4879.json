{"pr_number": 4879, "pr_title": "refactor: correct optionals and remove empties from query plans", "pr_createdAt": "2020-03-24T10:16:57Z", "pr_url": "https://github.com/confluentinc/ksql/pull/4879", "timeline": [{"oid": "acd906d61000811296192820b7a7b7fcc609c64b", "url": "https://github.com/confluentinc/ksql/commit/acd906d61000811296192820b7a7b7fcc609c64b", "message": "refactor: correct optionals and remove empties from query plans\n\nThis commit cleans up some properties that are marked both `required` and of type `Optional`, and others that are collections that are `required` but can be empty, in the types used to create ksqlDB's execution plans.\n\nThese changes remove a lot of noise from the plans, e.g. properties set to `null` or to empty collections `[]` and `{}`.\n\nThe saved historical plans have not be re-written. These changes will only be applied going forward and are backwards compatible.", "committedDate": "2020-03-24T10:16:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA0MTM2Mg==", "url": "https://github.com/confluentinc/ksql/pull/4879#discussion_r397041362", "bodyText": "Removed include = As.PROPERTY as that's the default.", "author": "big-andy-coates", "createdAt": "2020-03-24T10:17:38Z", "path": "ksqldb-engine/src/main/java/io/confluent/ksql/engine/KsqlPlan.java", "diffHunk": "@@ -18,18 +18,15 @@\n import com.fasterxml.jackson.annotation.JsonSubTypes;\n import com.fasterxml.jackson.annotation.JsonSubTypes.Type;\n import com.fasterxml.jackson.annotation.JsonTypeInfo;\n-import com.fasterxml.jackson.annotation.JsonTypeInfo.As;\n import io.confluent.ksql.execution.ddl.commands.DdlCommand;\n import java.util.Optional;\n \n-@JsonTypeInfo(\n-    use = JsonTypeInfo.Id.NAME,\n-    include = As.PROPERTY\n-)\n+@JsonTypeInfo(use = JsonTypeInfo.Id.NAME)", "originalCommit": "acd906d61000811296192820b7a7b7fcc609c64b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA0MTgwOQ==", "url": "https://github.com/confluentinc/ksql/pull/4879#discussion_r397041809", "bodyText": "This configures Jackson to exclude null, Optional.empty() and empty collections when serializing.", "author": "big-andy-coates", "createdAt": "2020-03-24T10:18:24Z", "path": "ksqldb-engine/src/main/java/io/confluent/ksql/execution/json/PlanJsonMapper.java", "diffHunk": "@@ -45,6 +46,7 @@ public static ObjectMapper create() {\n     mapper.enable(DeserializationFeature.FAIL_ON_NULL_FOR_PRIMITIVES);\n     mapper.enable(DeserializationFeature.FAIL_ON_NULL_CREATOR_PROPERTIES);\n     mapper.enable(DeserializationFeature.FAIL_ON_INVALID_SUBTYPE);\n+    mapper.setSerializationInclusion(Include.NON_EMPTY);", "originalCommit": "acd906d61000811296192820b7a7b7fcc609c64b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA0MTg1Ng==", "url": "https://github.com/confluentinc/ksql/pull/4879#discussion_r397041856", "bodyText": "Removed include = As.PROPERTY as that's the default.", "author": "big-andy-coates", "createdAt": "2020-03-24T10:18:28Z", "path": "ksqldb-execution/src/main/java/io/confluent/ksql/execution/plan/ExecutionStep.java", "diffHunk": "@@ -18,14 +18,10 @@\n import com.fasterxml.jackson.annotation.JsonSubTypes;\n import com.fasterxml.jackson.annotation.JsonSubTypes.Type;\n import com.fasterxml.jackson.annotation.JsonTypeInfo;\n-import com.fasterxml.jackson.annotation.JsonTypeInfo.As;\n import com.google.errorprone.annotations.Immutable;\n import java.util.List;\n \n-@JsonTypeInfo(\n-    use = JsonTypeInfo.Id.NAME,\n-    include = As.PROPERTY\n-)\n+@JsonTypeInfo(use = JsonTypeInfo.Id.NAME)", "originalCommit": "acd906d61000811296192820b7a7b7fcc609c64b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA0MjM0NQ==", "url": "https://github.com/confluentinc/ksql/pull/4879#discussion_r397042345", "bodyText": "Removed required as its acceptable for this set to be empty, (it generally is).\nWhen empty, it is no longer serialized to the JSON, hence it is now Optional.", "author": "big-andy-coates", "createdAt": "2020-03-24T10:19:22Z", "path": "ksqldb-execution/src/main/java/io/confluent/ksql/execution/plan/Formats.java", "diffHunk": "@@ -35,10 +36,13 @@\n   public Formats(\n       @JsonProperty(value = \"keyFormat\", required = true) final FormatInfo keyFormat,\n       @JsonProperty(value = \"valueFormat\", required = true) final FormatInfo valueFormat,\n-      @JsonProperty(value = \"options\", required = true) final Set<SerdeOption> options) {\n+      @JsonProperty(value = \"options\") final Optional<Set<SerdeOption>> options", "originalCommit": "acd906d61000811296192820b7a7b7fcc609c64b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA0MjYzNA==", "url": "https://github.com/confluentinc/ksql/pull/4879#discussion_r397042634", "bodyText": "No longer required, as set on the ObjectMapper.", "author": "big-andy-coates", "createdAt": "2020-03-24T10:19:52Z", "path": "ksqldb-execution/src/main/java/io/confluent/ksql/execution/plan/StreamSink.java", "diffHunk": "@@ -24,7 +22,6 @@\n import java.util.Objects;\n import java.util.Optional;\n \n-@JsonInclude(Include.NON_ABSENT)", "originalCommit": "acd906d61000811296192820b7a7b7fcc609c64b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA0MjY5MA==", "url": "https://github.com/confluentinc/ksql/pull/4879#discussion_r397042690", "bodyText": "No longer required, as set on the ObjectMapper.", "author": "big-andy-coates", "createdAt": "2020-03-24T10:19:58Z", "path": "ksqldb-execution/src/main/java/io/confluent/ksql/execution/plan/TableSink.java", "diffHunk": "@@ -25,7 +23,6 @@\n import java.util.Objects;\n import java.util.Optional;\n \n-@JsonInclude(Include.NON_ABSENT)", "originalCommit": "acd906d61000811296192820b7a7b7fcc609c64b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA0Mjk3MQ==", "url": "https://github.com/confluentinc/ksql/pull/4879#discussion_r397042971", "bodyText": "Moved all 'PlannedXXXXXinto the existingplanned` package.", "author": "big-andy-coates", "createdAt": "2020-03-24T10:20:27Z", "path": "ksqldb-functional-tests/src/test/java/io/confluent/ksql/test/planned/PlannedTestGeneratorTest.java", "diffHunk": "@@ -13,10 +13,9 @@\n  * specific language governing permissions and limitations under the License.\n  */\n \n-package io.confluent.ksql.test;\n+package io.confluent.ksql.test.planned;", "originalCommit": "acd906d61000811296192820b7a7b7fcc609c64b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA0MzcwOA==", "url": "https://github.com/confluentinc/ksql/pull/4879#discussion_r397043708", "bodyText": "Inlined these as it means:\n\nDon't need to add new accessors here when new accessors are added to either TestCaseSpecNode or TestCasePlanNode, i.e. cleaner, more stable API.\nMakes it easier to access TestCaseSpecNode or TestCasePlanNode from the rewriter code.", "author": "big-andy-coates", "createdAt": "2020-03-24T10:21:46Z", "path": "ksqldb-functional-tests/src/test/java/io/confluent/ksql/test/planned/TestCasePlan.java", "diffHunk": "@@ -56,43 +57,15 @@\n     this.topology = Objects.requireNonNull(topology, \"topology\");\n   }\n \n-  public List<KsqlPlan> getPlan() {\n-    return planNode.getPlan();\n-  }\n-\n-  public long getTimestamp() {\n-    return specNode.getTimestamp();\n-  }\n-\n-  public Map<String, String> getConfigs() {\n-    return planNode.getConfigs();\n-  }\n-\n-  public Map<String, String> getSchemas() {\n-    return specNode.getSchemas();\n-  }\n-", "originalCommit": "acd906d61000811296192820b7a7b7fcc609c64b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "f22445c5c8e227dff5d2813f0621b17fe0b35355", "url": "https://github.com/confluentinc/ksql/commit/f22445c5c8e227dff5d2813f0621b17fe0b35355", "message": "chore: fix tests by ALWAYS including config values", "committedDate": "2020-03-24T12:30:25Z", "type": "commit"}, {"oid": "82cd2a1ee344cedd30a772e3f3a7b1a5bbe6b856", "url": "https://github.com/confluentinc/ksql/commit/82cd2a1ee344cedd30a772e3f3a7b1a5bbe6b856", "message": "chore: fix tests", "committedDate": "2020-03-26T01:11:11Z", "type": "commit"}, {"oid": "32dd3834b2de57ac328ebf7b8918fd8a27aac8be", "url": "https://github.com/confluentinc/ksql/commit/32dd3834b2de57ac328ebf7b8918fd8a27aac8be", "message": "chore: fix tests", "committedDate": "2020-03-26T11:11:48Z", "type": "commit"}, {"oid": "3365427ef1b013cd4690b3e931dcd421450eedca", "url": "https://github.com/confluentinc/ksql/commit/3365427ef1b013cd4690b3e931dcd421450eedca", "message": "Merge branch 'master' into query_planbs", "committedDate": "2020-03-26T16:29:05Z", "type": "commit"}, {"oid": "43391d1ad06dbe40b561b3b64e6c6ba7f9c7665a", "url": "https://github.com/confluentinc/ksql/commit/43391d1ad06dbe40b561b3b64e6c6ba7f9c7665a", "message": "chore: merge from master", "committedDate": "2020-03-26T16:29:35Z", "type": "commit"}]}