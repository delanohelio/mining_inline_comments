{"pr_number": 5150, "pr_title": "feat: klip-14 - rowtime as pseduocolumn", "pr_createdAt": "2020-04-23T11:22:47Z", "pr_url": "https://github.com/confluentinc/ksql/pull/5150", "timeline": [{"oid": "f238ac395cb182a46a07ab3655e4772d29a643c1", "url": "https://github.com/confluentinc/ksql/commit/f238ac395cb182a46a07ab3655e4772d29a643c1", "message": "feat: ROWTIME as psuedo column\n\nfixes: https://github.com/confluentinc/ksql/issues/3734\n\nimplements [KLIP 14 - ROWTIME as Pseudocolumn](https://github.com/confluentinc/ksql/blob/master/design-proposals/klip-14-rowtime-as-pseudocolumn.md)\n\nBREAKING CHANGE:\n\nSelect star, i.e. `select *`, no longer expands to include `ROWTIME` column(s). Instead, `ROWTIME` is only included in the results of queries if explicitly included in the projection, e.g. `select rowtime, *`.\n\nThis only affects new statements. Any view previously created via a `CREATE STREAM AS SELECT` or `CREATE TABLE AS SELECT` statement is unaffected.", "committedDate": "2020-04-23T11:18:22Z", "type": "commit"}, {"oid": "0cbeadea42566d0b78632c8e6eca401290394da3", "url": "https://github.com/confluentinc/ksql/commit/0cbeadea42566d0b78632c8e6eca401290394da3", "message": "tests: test changes", "committedDate": "2020-04-23T11:19:03Z", "type": "commit"}, {"oid": "e085d77473c62ed6b3f97d89fc7f033213def010", "url": "https://github.com/confluentinc/ksql/commit/e085d77473c62ed6b3f97d89fc7f033213def010", "message": "test: historical test plans", "committedDate": "2020-04-23T11:19:18Z", "type": "commit"}, {"oid": "f7335f3dc44734d1300e5ca26b2959c370b40829", "url": "https://github.com/confluentinc/ksql/commit/f7335f3dc44734d1300e5ca26b2959c370b40829", "message": "docs: doc updates", "committedDate": "2020-04-23T11:19:28Z", "type": "commit"}, {"oid": "53c1d989df40e84e7ee3646017e93cfbfc98c450", "url": "https://github.com/confluentinc/ksql/commit/53c1d989df40e84e7ee3646017e93cfbfc98c450", "message": "docs: klip update", "committedDate": "2020-04-23T11:20:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzczMzY0MA==", "url": "https://github.com/confluentinc/ksql/pull/5150#discussion_r413733640", "bodyText": "Kept SYSTEM around for now, so that using a later CLI with old server doesn't result in a deserialization error.\nNot strictly necessary, but simple to do.", "author": "big-andy-coates", "createdAt": "2020-04-23T11:23:49Z", "path": "ksqldb-rest-model/src/main/java/io/confluent/ksql/rest/entity/FieldInfo.java", "diffHunk": "@@ -30,7 +30,8 @@\n public class FieldInfo {\n \n   public enum FieldType {\n-    SYSTEM, KEY\n+    SYSTEM, // To be removed in the future. 0.9 saw this value no longer used.", "originalCommit": "f238ac395cb182a46a07ab3655e4772d29a643c1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzczMzg3Mw==", "url": "https://github.com/confluentinc/ksql/pull/5150#discussion_r413733873", "bodyText": "This filters ROWTIME from the schema returned by DESCRIBE etc.", "author": "big-andy-coates", "createdAt": "2020-04-23T11:24:13Z", "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/util/EntityUtil.java", "diffHunk": "@@ -39,6 +40,7 @@ private EntityUtil() {\n \n   public static List<FieldInfo> buildSourceSchemaEntity(final LogicalSchema schema) {\n     final List<FieldInfo> allFields = schema.columns().stream()\n+        .filter(f -> f.namespace() != Namespace.META)", "originalCommit": "f238ac395cb182a46a07ab3655e4772d29a643c1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzczNDEwOQ==", "url": "https://github.com/confluentinc/ksql/pull/5150#discussion_r413734109", "bodyText": "These changes remove ROWTIME from pull queries that use select *.", "author": "big-andy-coates", "createdAt": "2020-04-23T11:24:39Z", "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/entity/TableRowsEntityFactory.java", "diffHunk": "@@ -55,7 +55,6 @@ public static LogicalSchema buildSchema(\n     }\n \n     return builder\n-        .valueColumns(schema.metadata())", "originalCommit": "f238ac395cb182a46a07ab3655e4772d29a643c1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzczNDQ0NQ==", "url": "https://github.com/confluentinc/ksql/pull/5150#discussion_r413734445", "bodyText": "This change excludes ROWTIME from push / persistent queries that use * in the projection.", "author": "big-andy-coates", "createdAt": "2020-04-23T11:25:17Z", "path": "ksqldb-engine/src/main/java/io/confluent/ksql/planner/plan/DataSourceNode.java", "diffHunk": "@@ -140,19 +139,26 @@ private static LogicalSchema buildSchema(final DataSource dataSource) {\n         .withMetaAndKeyColsInValue(dataSource.getKsqlTopic().getKeyFormat().isWindowed());\n   }\n \n+  @SuppressWarnings(\"UnstableApiUsage\")\n   private static Stream<ColumnName> orderColumns(\n       final List<Column> columns,\n       final LogicalSchema schema\n   ) {\n-    // When doing a `select *` system and key columns should be at the front of the column list\n+    // When doing a `select *` key columns should be at the front of the column list\n     // but are added at the back during processing for performance reasons.\n     // Switch them around here:\n-    final Map<Boolean, List<Column>> partitioned = columns.stream().collect(Collectors\n-        .groupingBy(c -> SchemaUtil.isSystemColumn(c.name()) || schema.isKeyColumn(c.name())));\n+    final Stream<Column> keys = columns.stream()\n+        .filter(c -> schema.isKeyColumn(c.name()));\n \n-    final List<Column> all = partitioned.get(true);\n-    all.addAll(partitioned.get(false));\n-    return all.stream().map(Column::name);\n+    final Stream<Column> windowBounds = columns.stream()\n+        .filter(c -> SchemaUtil.isWindowBound(c.name()));\n+\n+    final Stream<Column> values = columns.stream()\n+        .filter(c -> !SchemaUtil.isWindowBound(c.name()))\n+        .filter(c -> !schema.isKeyColumn(c.name()))\n+        .filter(c -> !schema.isMetaColumn(c.name()));\n+\n+    return Streams.concat(keys, windowBounds, values).map(Column::name);", "originalCommit": "f238ac395cb182a46a07ab3655e4772d29a643c1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "d9fcca7e2a1578b2ab10039f44bacaf54dd43799", "url": "https://github.com/confluentinc/ksql/commit/d9fcca7e2a1578b2ab10039f44bacaf54dd43799", "message": "chore: merge from master\n\nConflicting files\nksqldb-rest-app/src/test/java/io/confluent/ksql/rest/server/resources/streaming/WebSocketSubscriberTest.java", "committedDate": "2020-04-23T11:27:06Z", "type": "commit"}, {"oid": "9046e358382c9b763a170765d75ae517410d53b7", "url": "https://github.com/confluentinc/ksql/commit/9046e358382c9b763a170765d75ae517410d53b7", "message": "chore: merge from master\n\nConflicting files\nksqldb-engine/src/test/java/io/confluent/ksql/planner/plan/DataSourceNodeTest.java", "committedDate": "2020-04-23T20:16:54Z", "type": "commit"}, {"oid": "1987092164ba09a43eb3aa3a64953d4dd93aa830", "url": "https://github.com/confluentinc/ksql/commit/1987092164ba09a43eb3aa3a64953d4dd93aa830", "message": "Merge branch 'master' into drop_rowtime_from_select_star", "committedDate": "2020-04-23T22:32:57Z", "type": "commit"}, {"oid": "9e757893d9270192ab3b32c216ad8dd8e2de207f", "url": "https://github.com/confluentinc/ksql/commit/9e757893d9270192ab3b32c216ad8dd8e2de207f", "message": "chore: fix compiler warning", "committedDate": "2020-04-23T22:36:04Z", "type": "commit"}]}