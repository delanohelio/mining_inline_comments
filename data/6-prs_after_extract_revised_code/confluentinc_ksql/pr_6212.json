{"pr_number": 6212, "pr_title": "test: extend serde benchmark to include all formats and key serde", "pr_createdAt": "2020-09-16T12:03:15Z", "pr_url": "https://github.com/confluentinc/ksql/pull/6212", "timeline": [{"oid": "df26f163996ff65780ecfdcbbf9841864d857a96", "url": "https://github.com/confluentinc/ksql/commit/df26f163996ff65780ecfdcbbf9841864d857a96", "message": "test: extend serde benchmark to include all formats and key serde\n\nfixes: https://github.com/confluentinc/ksql/issues/6211\n\nEnhances the serde benchmarks beyond just testing `AVRO` and `JSON` formats via the `GenericRowSerde` to include `KAFKA`, `DELIMITED` and `PROTOBUF` formats and test key serde via the `GenericKeySerde`.\n\n```\nBenchmark                                (params)  Mode  Cnt  Score   Error  Units\nSerdeBenchmark.deserialize   single-key/Delimited  avgt    2  2.784          us/op\nSerdeBenchmark.deserialize       single-key/Kafka  avgt    2  0.045          us/op\nSerdeBenchmark.deserialize        single-key/JSON  avgt    2  0.200          us/op\nSerdeBenchmark.deserialize        single-key/Avro  avgt    2  0.550          us/op\nSerdeBenchmark.deserialize  impressions/Delimited  avgt    2  2.840          us/op\nSerdeBenchmark.deserialize   impressions/Protobuf  avgt    2  1.928          us/op\nSerdeBenchmark.deserialize       impressions/JSON  avgt    2  1.218          us/op\nSerdeBenchmark.deserialize       impressions/Avro  avgt    2  1.474          us/op\nSerdeBenchmark.deserialize       metrics/Protobuf  avgt    2  5.259          us/op\nSerdeBenchmark.deserialize           metrics/JSON  avgt    2  5.687          us/op\nSerdeBenchmark.deserialize           metrics/Avro  avgt    2  4.674          us/op\nSerdeBenchmark.serialize     single-key/Delimited  avgt    2  0.200          us/op\nSerdeBenchmark.serialize         single-key/Kafka  avgt    2  0.010          us/op\nSerdeBenchmark.serialize          single-key/JSON  avgt    2  0.170          us/op\nSerdeBenchmark.serialize          single-key/Avro  avgt    2  0.245          us/op\nSerdeBenchmark.serialize    impressions/Delimited  avgt    2  0.521          us/op\nSerdeBenchmark.serialize     impressions/Protobuf  avgt    2  1.471          us/op\nSerdeBenchmark.serialize         impressions/JSON  avgt    2  0.683          us/op\nSerdeBenchmark.serialize         impressions/Avro  avgt    2  1.374          us/op\nSerdeBenchmark.serialize         metrics/Protobuf  avgt    2  6.321          us/op\nSerdeBenchmark.serialize             metrics/JSON  avgt    2  3.336          us/op\nSerdeBenchmark.serialize             metrics/Avro  avgt    2  5.179          us/op\n```", "committedDate": "2020-09-16T12:01:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTU5OTQ2Mg==", "url": "https://github.com/confluentinc/ksql/pull/6212#discussion_r489599462", "bodyText": "The separator is / and you have |.  Also, shouldn't be <schema-name/<format-name> ?", "author": "spena", "createdAt": "2020-09-16T17:20:41Z", "path": "ksqldb-benchmark/src/main/java/io/confluent/ksql/benchmark/SerdeBenchmark.java", "diffHunk": "@@ -79,100 +82,166 @@\n   private static final String SCHEMA_FILE_SUFFIX = \".avro\";\n   private static final String TOPIC_NAME = \"serde_benchmark\";\n \n-  @State(Scope.Thread)\n-  public static class SchemaAndGenericRowState {\n-    LogicalSchema schema;\n-    GenericRow row;\n+  private static final String IMPRESSIONS_SCHEMA = \"impressions\";\n+  private static final String METRICS_SCHEMA = \"metrics\";\n+  private static final String SINGLE_KEY_SCHEMA = \"single-key\";\n \n-    @Param({\"impressions\", \"metrics\"})\n-    public String schemaName;\n+  private static final String SEPARATOR = \"/\";\n \n-    @Setup(Level.Iteration)\n-    public void setUp() throws Exception {\n-      final Generator generator = new Generator(getSchemaStream(), new Random());\n+  private static final String JSON_FORMAT = \"JSON\";\n+  private static final String AVRO_FORMAT = \"Avro\";\n+  private static final String PROTOBUF_FORMAT = \"Protobuf\";\n+  private static final String DELIMITED_FORMAT = \"Delimited\";\n+  private static final String KAFKA_FORMAT = \"Kafka\";\n \n-      // choose arbitrary key\n-      final String key = generator.schema().getFields().get(0).name();\n+  private static final class Params {\n \n-      final RowGenerator rowGenerator = new RowGenerator(generator, key, Optional.empty());\n+    final String schemaName;\n+    final String formatName;\n+\n+    static Params parse(final String text) {\n+      final String[] parts = text.split(SEPARATOR);\n+      if (parts.length != 2) {\n+        throw new IllegalArgumentException(\"Param should be in form \"\n+            + \"'<format-name>|<schema-name>', got: \" + text);", "originalCommit": "df26f163996ff65780ecfdcbbf9841864d857a96", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDEwMzg1Mg==", "url": "https://github.com/confluentinc/ksql/pull/6212#discussion_r490103852", "bodyText": "Good catch. Thanks!", "author": "big-andy-coates", "createdAt": "2020-09-17T09:29:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTU5OTQ2Mg=="}], "type": "inlineReview", "revised_code": {"commit": "06814cd25252db78e6e73b077bea9bbf8beb40d8", "chunk": "diff --git a/ksqldb-benchmark/src/main/java/io/confluent/ksql/benchmark/SerdeBenchmark.java b/ksqldb-benchmark/src/main/java/io/confluent/ksql/benchmark/SerdeBenchmark.java\nindex a345784e34..e9142a7617 100644\n--- a/ksqldb-benchmark/src/main/java/io/confluent/ksql/benchmark/SerdeBenchmark.java\n+++ b/ksqldb-benchmark/src/main/java/io/confluent/ksql/benchmark/SerdeBenchmark.java\n\n@@ -103,7 +103,7 @@ public class SerdeBenchmark {\n       final String[] parts = text.split(SEPARATOR);\n       if (parts.length != 2) {\n         throw new IllegalArgumentException(\"Param should be in form \"\n-            + \"'<format-name>|<schema-name>', got: \" + text);\n+            + \"'<format-name>\" + SEPARATOR + \"<schema-name>', got: \" + text);\n       }\n \n       return new Params(parts[0], parts[1]);\n"}}, {"oid": "06814cd25252db78e6e73b077bea9bbf8beb40d8", "url": "https://github.com/confluentinc/ksql/commit/06814cd25252db78e6e73b077bea9bbf8beb40d8", "message": "Update SerdeBenchmark.java", "committedDate": "2020-09-17T09:28:54Z", "type": "commit"}]}