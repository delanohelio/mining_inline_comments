{"pr_number": 4944, "pr_title": "feat: CORS support for Vert.x based ksqlDB", "pr_createdAt": "2020-03-31T08:06:43Z", "pr_url": "https://github.com/confluentinc/ksql/pull/4944", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE2MjI0OQ==", "url": "https://github.com/confluentinc/ksql/pull/4944#discussion_r401162249", "bodyText": "nit: KsqlCorsHandler", "author": "rodesai", "createdAt": "2020-03-31T19:30:51Z", "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/api/server/KSqlCorsHandler.java", "diffHunk": "@@ -0,0 +1,105 @@\n+/*\n+ * Copyright 2020 Confluent Inc.\n+ *\n+ * Licensed under the Confluent Community License (the \"License\"); you may not use\n+ * this file except in compliance with the License.  You may obtain a copy of the\n+ * License at\n+ *\n+ * http://www.confluent.io/confluent-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OF ANY KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package io.confluent.ksql.api.server;\n+\n+import io.vertx.core.Handler;\n+import io.vertx.core.http.HttpMethod;\n+import io.vertx.ext.web.Router;\n+import io.vertx.ext.web.RoutingContext;\n+import io.vertx.ext.web.handler.CorsHandler;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.LinkedHashSet;\n+import java.util.List;\n+import java.util.Set;\n+\n+public class KSqlCorsHandler implements Handler<RoutingContext> {", "originalCommit": "940a2e3aa3de49f584a2c1b68a7fac89dac8d878", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTU4MzM0NA==", "url": "https://github.com/confluentinc/ksql/pull/4944#discussion_r401583344", "bodyText": "ack", "author": "purplefox", "createdAt": "2020-04-01T12:40:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE2MjI0OQ=="}], "type": "inlineReview", "revised_code": {"commit": "475bda2cb20af78bd972feb20a246307109e27a1", "chunk": "diff --git a/ksqldb-rest-app/src/main/java/io/confluent/ksql/api/server/KSqlCorsHandler.java b/ksqldb-rest-app/src/main/java/io/confluent/ksql/api/server/KsqlCorsHandler.java\nsimilarity index 70%\nrename from ksqldb-rest-app/src/main/java/io/confluent/ksql/api/server/KSqlCorsHandler.java\nrename to ksqldb-rest-app/src/main/java/io/confluent/ksql/api/server/KsqlCorsHandler.java\nindex 40b1530f12..1d1fb554f7 100644\n--- a/ksqldb-rest-app/src/main/java/io/confluent/ksql/api/server/KSqlCorsHandler.java\n+++ b/ksqldb-rest-app/src/main/java/io/confluent/ksql/api/server/KsqlCorsHandler.java\n\n@@ -20,22 +20,19 @@ import io.vertx.core.http.HttpMethod;\n import io.vertx.ext.web.Router;\n import io.vertx.ext.web.RoutingContext;\n import io.vertx.ext.web.handler.CorsHandler;\n-import java.util.ArrayList;\n import java.util.Arrays;\n-import java.util.LinkedHashSet;\n+import java.util.Collections;\n+import java.util.HashSet;\n import java.util.List;\n import java.util.Set;\n+import java.util.stream.Collectors;\n \n-public class KSqlCorsHandler implements Handler<RoutingContext> {\n+public class KsqlCorsHandler implements Handler<RoutingContext> {\n \n   private static final List<String> DEFAULT_ALLOWED_METHODS = Arrays.asList(\"GET\", \"POST\", \"HEAD\");\n   private static final List<String> DEFAULT_ALLOWED_HEADERS = Arrays\n       .asList(\"X-Requested-With\", \"Content-Type\", \"Accept\", \"Origin\");\n-  public static final List<String> EXCLUDED_PATH_PREFIXES = new ArrayList<>();\n-\n-  static {\n-    EXCLUDED_PATH_PREFIXES.add(\"/ws/\");\n-  }\n+  private static final List<String> EXCLUDED_PATH_PREFIXES = Collections.singletonList(\"/ws/\");\n \n   static void setupCorsHandler(final Server server, final Router router) {\n     final ApiServerConfig apiServerConfig = server.getConfig();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE2NjA2MQ==", "url": "https://github.com/confluentinc/ksql/pull/4944#discussion_r401166061", "bodyText": "nit: put \"wibble.com\" and \"/query-stream\" in constants?", "author": "rodesai", "createdAt": "2020-03-31T19:38:05Z", "path": "ksqldb-rest-app/src/test/java/io/confluent/ksql/api/CorsTest.java", "diffHunk": "@@ -0,0 +1,289 @@\n+/*\n+ * Copyright 2020 Confluent Inc.\n+ *\n+ * Licensed under the Confluent Community License (the \"License\"); you may not use\n+ * this file except in compliance with the License.  You may obtain a copy of the\n+ * License at\n+ *\n+ * http://www.confluent.io/confluent-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OF ANY KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package io.confluent.ksql.api;\n+\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.Matchers.is;\n+import static org.hamcrest.Matchers.nullValue;\n+\n+import io.confluent.ksql.api.server.ApiServerConfig;\n+import io.confluent.ksql.api.server.KSqlCorsHandler;\n+import io.confluent.ksql.util.VertxCompletableFuture;\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.Vertx;\n+import io.vertx.core.buffer.Buffer;\n+import io.vertx.core.http.HttpMethod;\n+import io.vertx.core.json.JsonObject;\n+import io.vertx.ext.web.client.HttpResponse;\n+import java.util.HashMap;\n+import java.util.Map;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+public class CorsTest extends BaseApiTest {\n+\n+  private Map<String, Object> config = new HashMap<>();\n+\n+  private static final String ACCESS_CONTROL_ALLOW_ORIGIN_HEADER = \"Access-Control-Allow-Origin\";\n+  private static final String ACCESS_CONTROL_ALLOW_METHODS_HEADER = \"Access-Control-Allow-Methods\";\n+  private static final String ACCESS_CONTROL_ALLOW_HEADERS_HEADER = \"Access-Control-Allow-Headers\";\n+  private static final String ACCESS_CONTROL_ALLOW_CREDENTIALS_HEADER = \"Access-Control-Allow-Credentials\";\n+\n+  private static final String ACCESS_CONTROL_REQUEST_METHOD_HEADER = \"Access-Control-Request-Method\";\n+\n+  private static final String DEFAULT_ACCESS_CONTROL_ALLOW_HEADERS = \"X-Requested-With,Content-Type,Accept,Origin\";\n+  private static final String DEFAULT_ACCESS_CONTROL_ALLOW_METHODS = \"GET,POST,HEAD\";\n+\n+  @Before\n+  public void setUp() {\n+\n+    vertx = Vertx.vertx();\n+    vertx.exceptionHandler(t -> log.error(\"Unhandled exception in Vert.x\", t));\n+\n+    testEndpoints = new TestEndpoints();\n+    setDefaultRowGenerator();\n+  }\n+\n+  @After\n+  public void tearDown() {\n+    stopClient();\n+    stopServer();\n+    if (vertx != null) {\n+      vertx.close();\n+    }\n+  }\n+\n+  @Test\n+  public void shouldNotBeCorsResponseIfNoCorsConfigured() throws Exception {\n+\n+    // Given:\n+    init();\n+\n+    // When\n+    HttpResponse<Buffer> response = sendCorsRequest(HttpMethod.POST, \"wibble.com\");\n+\n+    // Then:\n+    assertThat(response.statusCode(), is(200));\n+    assertThat(response.getHeader(ACCESS_CONTROL_ALLOW_ORIGIN_HEADER), is(nullValue()));\n+    assertThat(response.getHeader(ACCESS_CONTROL_ALLOW_METHODS_HEADER), is(nullValue()));\n+    assertThat(response.getHeader(ACCESS_CONTROL_ALLOW_HEADERS_HEADER), is(nullValue()));\n+  }\n+\n+  @Test\n+  public void shouldExcludePath() throws Exception {\n+\n+    // Given:\n+    init();\n+    config.put(ApiServerConfig.CORS_ALLOWED_ORIGINS, \"wibble.com\");\n+    KSqlCorsHandler.EXCLUDED_PATH_PREFIXES.add(\"/query-stream\");", "originalCommit": "940a2e3aa3de49f584a2c1b68a7fac89dac8d878", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTU4NDQzMQ==", "url": "https://github.com/confluentinc/ksql/pull/4944#discussion_r401584431", "bodyText": "ack", "author": "purplefox", "createdAt": "2020-04-01T12:42:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE2NjA2MQ=="}], "type": "inlineReview", "revised_code": {"commit": "475bda2cb20af78bd972feb20a246307109e27a1", "chunk": "diff --git a/ksqldb-rest-app/src/test/java/io/confluent/ksql/api/CorsTest.java b/ksqldb-rest-app/src/test/java/io/confluent/ksql/api/CorsTest.java\nindex 54c508739d..bdd115d422 100644\n--- a/ksqldb-rest-app/src/test/java/io/confluent/ksql/api/CorsTest.java\n+++ b/ksqldb-rest-app/src/test/java/io/confluent/ksql/api/CorsTest.java\n\n@@ -20,7 +20,6 @@ import static org.hamcrest.Matchers.is;\n import static org.hamcrest.Matchers.nullValue;\n \n import io.confluent.ksql.api.server.ApiServerConfig;\n-import io.confluent.ksql.api.server.KSqlCorsHandler;\n import io.confluent.ksql.util.VertxCompletableFuture;\n import io.vertx.core.MultiMap;\n import io.vertx.core.Vertx;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI4ODMwMA==", "url": "https://github.com/confluentinc/ksql/pull/4944#discussion_r401288300", "bodyText": "These defaults are coming from the Jetty defaults, right? Are they really additive like this? My interpretation of the docs was that these default values are used if the methods or headers are not explicitly supplied, but if something explicit is supplied then the defaults are ignored.\nOtherwise the default of * for the allowed origins doesn't make sense.", "author": "vcrfxia", "createdAt": "2020-04-01T00:21:44Z", "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/api/server/KSqlCorsHandler.java", "diffHunk": "@@ -0,0 +1,101 @@\n+/*\n+ * Copyright 2020 Confluent Inc.\n+ *\n+ * Licensed under the Confluent Community License (the \"License\"); you may not use\n+ * this file except in compliance with the License.  You may obtain a copy of the\n+ * License at\n+ *\n+ * http://www.confluent.io/confluent-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OF ANY KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package io.confluent.ksql.api.server;\n+\n+import io.vertx.core.Handler;\n+import io.vertx.core.http.HttpMethod;\n+import io.vertx.ext.web.Router;\n+import io.vertx.ext.web.RoutingContext;\n+import io.vertx.ext.web.handler.CorsHandler;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.LinkedHashSet;\n+import java.util.List;\n+import java.util.Set;\n+\n+public class KSqlCorsHandler implements Handler<RoutingContext> {\n+\n+  private static final List<String> DEFAULT_ALLOWED_METHODS = Arrays.asList(\"GET\", \"POST\", \"HEAD\");\n+  private static final List<String> DEFAULT_ALLOWED_HEADERS = Arrays\n+      .asList(\"X-Requested-With\", \"Content-Type\", \"Accept\", \"Origin\");\n+  private static final List<String> EXCLUDED_PATH_PREFIXES = Collections.singletonList(\"/ws/\");\n+\n+  static void setupCorsHandler(final Server server, final Router router) {\n+    final ApiServerConfig apiServerConfig = server.getConfig();\n+    final String allowedOrigins = apiServerConfig\n+        .getString(ApiServerConfig.CORS_ALLOWED_ORIGINS);\n+    if (allowedOrigins.trim().isEmpty()) {\n+      return;\n+    }\n+    final String convertedPattern = convertAllowedOrigin(allowedOrigins);\n+    final CorsHandler corsHandler = CorsHandler.create(convertedPattern);\n+    final List<String> allowedMethods = apiServerConfig\n+        .getList(ApiServerConfig.CORS_ALLOWED_METHODS);\n+    final Set<String> allowedMethodsSet = new LinkedHashSet<>(allowedMethods);\n+    allowedMethodsSet.addAll(DEFAULT_ALLOWED_METHODS);", "originalCommit": "5861a6b2b04399a2e716805dce227aca489b4e1d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTU4MTI3Mg==", "url": "https://github.com/confluentinc/ksql/pull/4944#discussion_r401581272", "bodyText": "Ack", "author": "purplefox", "createdAt": "2020-04-01T12:37:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI4ODMwMA=="}], "type": "inlineReview", "revised_code": {"commit": "475bda2cb20af78bd972feb20a246307109e27a1", "chunk": "diff --git a/ksqldb-rest-app/src/main/java/io/confluent/ksql/api/server/KSqlCorsHandler.java b/ksqldb-rest-app/src/main/java/io/confluent/ksql/api/server/KsqlCorsHandler.java\nsimilarity index 74%\nrename from ksqldb-rest-app/src/main/java/io/confluent/ksql/api/server/KSqlCorsHandler.java\nrename to ksqldb-rest-app/src/main/java/io/confluent/ksql/api/server/KsqlCorsHandler.java\nindex ec13400a62..1d1fb554f7 100644\n--- a/ksqldb-rest-app/src/main/java/io/confluent/ksql/api/server/KSqlCorsHandler.java\n+++ b/ksqldb-rest-app/src/main/java/io/confluent/ksql/api/server/KsqlCorsHandler.java\n\n@@ -22,11 +22,12 @@ import io.vertx.ext.web.RoutingContext;\n import io.vertx.ext.web.handler.CorsHandler;\n import java.util.Arrays;\n import java.util.Collections;\n-import java.util.LinkedHashSet;\n+import java.util.HashSet;\n import java.util.List;\n import java.util.Set;\n+import java.util.stream.Collectors;\n \n-public class KSqlCorsHandler implements Handler<RoutingContext> {\n+public class KsqlCorsHandler implements Handler<RoutingContext> {\n \n   private static final List<String> DEFAULT_ALLOWED_METHODS = Arrays.asList(\"GET\", \"POST\", \"HEAD\");\n   private static final List<String> DEFAULT_ALLOWED_HEADERS = Arrays\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI4ODY4NA==", "url": "https://github.com/confluentinc/ksql/pull/4944#discussion_r401288684", "bodyText": "Was the intention behind this to implement the Jetty default of * for allowed origins? I don't think returning early is valid because even if the allowed origins check succeeds, we should still perform the method and header checks.", "author": "vcrfxia", "createdAt": "2020-04-01T00:23:09Z", "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/api/server/KSqlCorsHandler.java", "diffHunk": "@@ -0,0 +1,101 @@\n+/*\n+ * Copyright 2020 Confluent Inc.\n+ *\n+ * Licensed under the Confluent Community License (the \"License\"); you may not use\n+ * this file except in compliance with the License.  You may obtain a copy of the\n+ * License at\n+ *\n+ * http://www.confluent.io/confluent-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OF ANY KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package io.confluent.ksql.api.server;\n+\n+import io.vertx.core.Handler;\n+import io.vertx.core.http.HttpMethod;\n+import io.vertx.ext.web.Router;\n+import io.vertx.ext.web.RoutingContext;\n+import io.vertx.ext.web.handler.CorsHandler;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.LinkedHashSet;\n+import java.util.List;\n+import java.util.Set;\n+\n+public class KSqlCorsHandler implements Handler<RoutingContext> {\n+\n+  private static final List<String> DEFAULT_ALLOWED_METHODS = Arrays.asList(\"GET\", \"POST\", \"HEAD\");\n+  private static final List<String> DEFAULT_ALLOWED_HEADERS = Arrays\n+      .asList(\"X-Requested-With\", \"Content-Type\", \"Accept\", \"Origin\");\n+  private static final List<String> EXCLUDED_PATH_PREFIXES = Collections.singletonList(\"/ws/\");\n+\n+  static void setupCorsHandler(final Server server, final Router router) {\n+    final ApiServerConfig apiServerConfig = server.getConfig();\n+    final String allowedOrigins = apiServerConfig\n+        .getString(ApiServerConfig.CORS_ALLOWED_ORIGINS);\n+    if (allowedOrigins.trim().isEmpty()) {", "originalCommit": "5861a6b2b04399a2e716805dce227aca489b4e1d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTU4MjE3OA==", "url": "https://github.com/confluentinc/ksql/pull/4944#discussion_r401582178", "bodyText": "No, this means no cors handler is configured (the default).", "author": "purplefox", "createdAt": "2020-04-01T12:38:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI4ODY4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTcwMjMzNw==", "url": "https://github.com/confluentinc/ksql/pull/4944#discussion_r401702337", "bodyText": "Ah I see, the way rest-utils determines if CORS should be enabled or not is based on whether this config is empty or not. This behavior makes sense then.", "author": "vcrfxia", "createdAt": "2020-04-01T15:25:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI4ODY4NA=="}], "type": "inlineReview", "revised_code": {"commit": "475bda2cb20af78bd972feb20a246307109e27a1", "chunk": "diff --git a/ksqldb-rest-app/src/main/java/io/confluent/ksql/api/server/KSqlCorsHandler.java b/ksqldb-rest-app/src/main/java/io/confluent/ksql/api/server/KsqlCorsHandler.java\nsimilarity index 74%\nrename from ksqldb-rest-app/src/main/java/io/confluent/ksql/api/server/KSqlCorsHandler.java\nrename to ksqldb-rest-app/src/main/java/io/confluent/ksql/api/server/KsqlCorsHandler.java\nindex ec13400a62..1d1fb554f7 100644\n--- a/ksqldb-rest-app/src/main/java/io/confluent/ksql/api/server/KSqlCorsHandler.java\n+++ b/ksqldb-rest-app/src/main/java/io/confluent/ksql/api/server/KsqlCorsHandler.java\n\n@@ -22,11 +22,12 @@ import io.vertx.ext.web.RoutingContext;\n import io.vertx.ext.web.handler.CorsHandler;\n import java.util.Arrays;\n import java.util.Collections;\n-import java.util.LinkedHashSet;\n+import java.util.HashSet;\n import java.util.List;\n import java.util.Set;\n+import java.util.stream.Collectors;\n \n-public class KSqlCorsHandler implements Handler<RoutingContext> {\n+public class KsqlCorsHandler implements Handler<RoutingContext> {\n \n   private static final List<String> DEFAULT_ALLOWED_METHODS = Arrays.asList(\"GET\", \"POST\", \"HEAD\");\n   private static final List<String> DEFAULT_ALLOWED_HEADERS = Arrays\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI4ODkzNw==", "url": "https://github.com/confluentinc/ksql/pull/4944#discussion_r401288937", "bodyText": "nit:\ncorsHandler.allowedHeaders(allowedHeadersSet);\n\nrather than iterating through the set and adding each individually?", "author": "vcrfxia", "createdAt": "2020-04-01T00:24:01Z", "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/api/server/KSqlCorsHandler.java", "diffHunk": "@@ -0,0 +1,101 @@\n+/*\n+ * Copyright 2020 Confluent Inc.\n+ *\n+ * Licensed under the Confluent Community License (the \"License\"); you may not use\n+ * this file except in compliance with the License.  You may obtain a copy of the\n+ * License at\n+ *\n+ * http://www.confluent.io/confluent-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OF ANY KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package io.confluent.ksql.api.server;\n+\n+import io.vertx.core.Handler;\n+import io.vertx.core.http.HttpMethod;\n+import io.vertx.ext.web.Router;\n+import io.vertx.ext.web.RoutingContext;\n+import io.vertx.ext.web.handler.CorsHandler;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.LinkedHashSet;\n+import java.util.List;\n+import java.util.Set;\n+\n+public class KSqlCorsHandler implements Handler<RoutingContext> {\n+\n+  private static final List<String> DEFAULT_ALLOWED_METHODS = Arrays.asList(\"GET\", \"POST\", \"HEAD\");\n+  private static final List<String> DEFAULT_ALLOWED_HEADERS = Arrays\n+      .asList(\"X-Requested-With\", \"Content-Type\", \"Accept\", \"Origin\");\n+  private static final List<String> EXCLUDED_PATH_PREFIXES = Collections.singletonList(\"/ws/\");\n+\n+  static void setupCorsHandler(final Server server, final Router router) {\n+    final ApiServerConfig apiServerConfig = server.getConfig();\n+    final String allowedOrigins = apiServerConfig\n+        .getString(ApiServerConfig.CORS_ALLOWED_ORIGINS);\n+    if (allowedOrigins.trim().isEmpty()) {\n+      return;\n+    }\n+    final String convertedPattern = convertAllowedOrigin(allowedOrigins);\n+    final CorsHandler corsHandler = CorsHandler.create(convertedPattern);\n+    final List<String> allowedMethods = apiServerConfig\n+        .getList(ApiServerConfig.CORS_ALLOWED_METHODS);\n+    final Set<String> allowedMethodsSet = new LinkedHashSet<>(allowedMethods);\n+    allowedMethodsSet.addAll(DEFAULT_ALLOWED_METHODS);\n+    for (String allowedMethod : allowedMethodsSet) {\n+      corsHandler.allowedMethod(HttpMethod.valueOf(allowedMethod.toUpperCase()));\n+    }\n+\n+    final List<String> allowedHeaders = apiServerConfig\n+        .getList(ApiServerConfig.CORS_ALLOWED_HEADERS);\n+    final Set<String> allowedHeadersSet = new LinkedHashSet<>(allowedHeaders);\n+    allowedHeadersSet.addAll(DEFAULT_ALLOWED_HEADERS);\n+    for (String allowedHeader : allowedHeadersSet) {\n+      corsHandler.allowedHeader(allowedHeader);", "originalCommit": "5861a6b2b04399a2e716805dce227aca489b4e1d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTU4MjMwMA==", "url": "https://github.com/confluentinc/ksql/pull/4944#discussion_r401582300", "bodyText": "ack", "author": "purplefox", "createdAt": "2020-04-01T12:39:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI4ODkzNw=="}], "type": "inlineReview", "revised_code": {"commit": "475bda2cb20af78bd972feb20a246307109e27a1", "chunk": "diff --git a/ksqldb-rest-app/src/main/java/io/confluent/ksql/api/server/KSqlCorsHandler.java b/ksqldb-rest-app/src/main/java/io/confluent/ksql/api/server/KsqlCorsHandler.java\nsimilarity index 74%\nrename from ksqldb-rest-app/src/main/java/io/confluent/ksql/api/server/KSqlCorsHandler.java\nrename to ksqldb-rest-app/src/main/java/io/confluent/ksql/api/server/KsqlCorsHandler.java\nindex ec13400a62..1d1fb554f7 100644\n--- a/ksqldb-rest-app/src/main/java/io/confluent/ksql/api/server/KSqlCorsHandler.java\n+++ b/ksqldb-rest-app/src/main/java/io/confluent/ksql/api/server/KsqlCorsHandler.java\n\n@@ -22,11 +22,12 @@ import io.vertx.ext.web.RoutingContext;\n import io.vertx.ext.web.handler.CorsHandler;\n import java.util.Arrays;\n import java.util.Collections;\n-import java.util.LinkedHashSet;\n+import java.util.HashSet;\n import java.util.List;\n import java.util.Set;\n+import java.util.stream.Collectors;\n \n-public class KSqlCorsHandler implements Handler<RoutingContext> {\n+public class KsqlCorsHandler implements Handler<RoutingContext> {\n \n   private static final List<String> DEFAULT_ALLOWED_METHODS = Arrays.asList(\"GET\", \"POST\", \"HEAD\");\n   private static final List<String> DEFAULT_ALLOWED_HEADERS = Arrays\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI4OTExNA==", "url": "https://github.com/confluentinc/ksql/pull/4944#discussion_r401289114", "bodyText": "Do we need to override this method? The implementation looks the same as that of the superclass.", "author": "vcrfxia", "createdAt": "2020-04-01T00:24:35Z", "path": "ksqldb-rest-app/src/test/java/io/confluent/ksql/api/CorsTest.java", "diffHunk": "@@ -0,0 +1,300 @@\n+/*\n+ * Copyright 2020 Confluent Inc.\n+ *\n+ * Licensed under the Confluent Community License (the \"License\"); you may not use\n+ * this file except in compliance with the License.  You may obtain a copy of the\n+ * License at\n+ *\n+ * http://www.confluent.io/confluent-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OF ANY KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package io.confluent.ksql.api;\n+\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.Matchers.is;\n+import static org.hamcrest.Matchers.nullValue;\n+\n+import io.confluent.ksql.api.server.ApiServerConfig;\n+import io.confluent.ksql.util.VertxCompletableFuture;\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.Vertx;\n+import io.vertx.core.buffer.Buffer;\n+import io.vertx.core.http.HttpMethod;\n+import io.vertx.core.json.JsonObject;\n+import io.vertx.ext.web.client.HttpResponse;\n+import java.util.HashMap;\n+import java.util.Map;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+public class CorsTest extends BaseApiTest {\n+\n+  private Map<String, Object> config = new HashMap<>();\n+\n+  private static final String ACCESS_CONTROL_ALLOW_ORIGIN_HEADER = \"Access-Control-Allow-Origin\";\n+  private static final String ACCESS_CONTROL_ALLOW_METHODS_HEADER = \"Access-Control-Allow-Methods\";\n+  private static final String ACCESS_CONTROL_ALLOW_HEADERS_HEADER = \"Access-Control-Allow-Headers\";\n+  private static final String ACCESS_CONTROL_ALLOW_CREDENTIALS_HEADER = \"Access-Control-Allow-Credentials\";\n+\n+  private static final String ACCESS_CONTROL_REQUEST_METHOD_HEADER = \"Access-Control-Request-Method\";\n+\n+  private static final String DEFAULT_ACCESS_CONTROL_ALLOW_HEADERS = \"X-Requested-With,Content-Type,Accept,Origin\";\n+  private static final String DEFAULT_ACCESS_CONTROL_ALLOW_METHODS = \"GET,POST,HEAD\";\n+\n+  @Before\n+  public void setUp() {\n+\n+    vertx = Vertx.vertx();\n+    vertx.exceptionHandler(t -> log.error(\"Unhandled exception in Vert.x\", t));\n+\n+    testEndpoints = new TestEndpoints();\n+    setDefaultRowGenerator();\n+  }\n+\n+  @After\n+  public void tearDown() {", "originalCommit": "5861a6b2b04399a2e716805dce227aca489b4e1d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTU4Mjc2Mg==", "url": "https://github.com/confluentinc/ksql/pull/4944#discussion_r401582762", "bodyText": "ack", "author": "purplefox", "createdAt": "2020-04-01T12:39:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI4OTExNA=="}], "type": "inlineReview", "revised_code": {"commit": "475bda2cb20af78bd972feb20a246307109e27a1", "chunk": "diff --git a/ksqldb-rest-app/src/test/java/io/confluent/ksql/api/CorsTest.java b/ksqldb-rest-app/src/test/java/io/confluent/ksql/api/CorsTest.java\nindex cb75a64177..bdd115d422 100644\n--- a/ksqldb-rest-app/src/test/java/io/confluent/ksql/api/CorsTest.java\n+++ b/ksqldb-rest-app/src/test/java/io/confluent/ksql/api/CorsTest.java\n\n@@ -27,9 +27,11 @@ import io.vertx.core.buffer.Buffer;\n import io.vertx.core.http.HttpMethod;\n import io.vertx.core.json.JsonObject;\n import io.vertx.ext.web.client.HttpResponse;\n+import java.util.Arrays;\n import java.util.HashMap;\n+import java.util.HashSet;\n import java.util.Map;\n-import org.junit.After;\n+import java.util.Set;\n import org.junit.Before;\n import org.junit.Test;\n \n"}}, {"oid": "475bda2cb20af78bd972feb20a246307109e27a1", "url": "https://github.com/confluentinc/ksql/commit/475bda2cb20af78bd972feb20a246307109e27a1", "message": "Updates after review", "committedDate": "2020-04-01T12:44:56Z", "type": "forcePushed"}, {"oid": "150070df81b29ee7f6477e10447746b8e3a13cc0", "url": "https://github.com/confluentinc/ksql/commit/150070df81b29ee7f6477e10447746b8e3a13cc0", "message": "Updates after review", "committedDate": "2020-04-08T13:45:31Z", "type": "forcePushed"}, {"oid": "5ce157500c54ca9fa331420c8b710af6c536e5db", "url": "https://github.com/confluentinc/ksql/commit/5ce157500c54ca9fa331420c8b710af6c536e5db", "message": "cors handler", "committedDate": "2020-04-15T07:24:29Z", "type": "commit"}, {"oid": "265efa2de7c1015cba2f2d8158512503846b4199", "url": "https://github.com/confluentinc/ksql/commit/265efa2de7c1015cba2f2d8158512503846b4199", "message": "removed access to EXCLUDED_PATH_PREFIXES", "committedDate": "2020-04-15T07:24:29Z", "type": "commit"}, {"oid": "39d683177c8b0ce03b19abe5d5083c238e6e87fa", "url": "https://github.com/confluentinc/ksql/commit/39d683177c8b0ce03b19abe5d5083c238e6e87fa", "message": "Updates after review", "committedDate": "2020-04-15T07:24:29Z", "type": "commit"}, {"oid": "39d683177c8b0ce03b19abe5d5083c238e6e87fa", "url": "https://github.com/confluentinc/ksql/commit/39d683177c8b0ce03b19abe5d5083c238e6e87fa", "message": "Updates after review", "committedDate": "2020-04-15T07:24:29Z", "type": "forcePushed"}]}