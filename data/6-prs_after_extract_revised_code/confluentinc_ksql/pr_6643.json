{"pr_number": 6643, "pr_title": "chore: emit metrics with ksql.service.id in metrics tag", "pr_createdAt": "2020-11-19T04:34:28Z", "pr_url": "https://github.com/confluentinc/ksql/pull/6643", "timeline": [{"oid": "8c5d8dcf2370a5026b6a13ab46a176dfef14909b", "url": "https://github.com/confluentinc/ksql/commit/8c5d8dcf2370a5026b6a13ab46a176dfef14909b", "message": "chore: emit metrics with ksql.service.id in metrics tag", "committedDate": "2020-11-19T18:32:10Z", "type": "forcePushed"}, {"oid": "2f46f423dcfd74451f08fe68bf03e85d900aa3d3", "url": "https://github.com/confluentinc/ksql/commit/2f46f423dcfd74451f08fe68bf03e85d900aa3d3", "message": "update tag with underscores instead of .", "committedDate": "2020-11-30T17:45:14Z", "type": "forcePushed"}, {"oid": "a224b6f5a82ea8a5e4d6a8bd1a929bd158e8b2df", "url": "https://github.com/confluentinc/ksql/commit/a224b6f5a82ea8a5e4d6a8bd1a929bd158e8b2df", "message": "chore: emit metrics with ksql.service.id in metrics tag", "committedDate": "2020-11-30T17:47:20Z", "type": "commit"}, {"oid": "de1c557de0b7e93fa49851ca3f783769c9c574a2", "url": "https://github.com/confluentinc/ksql/commit/de1c557de0b7e93fa49851ca3f783769c9c574a2", "message": "update tag with underscores instead of .", "committedDate": "2020-11-30T17:47:27Z", "type": "commit"}, {"oid": "de1c557de0b7e93fa49851ca3f783769c9c574a2", "url": "https://github.com/confluentinc/ksql/commit/de1c557de0b7e93fa49851ca3f783769c9c574a2", "message": "update tag with underscores instead of .", "committedDate": "2020-11-30T17:47:27Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDUyMzYyOQ==", "url": "https://github.com/confluentinc/ksql/pull/6643#discussion_r534523629", "bodyText": "Why are we changing the name and group for legacy metric here?", "author": "harinirajendran", "createdAt": "2020-12-02T22:26:46Z", "path": "ksqldb-engine/src/main/java/io/confluent/ksql/internal/KsqlEngineMetrics.java", "diffHunk": "@@ -298,15 +307,19 @@ private void configureMetric(\n       final KsqlMetric metric) {\n     // legacy\n     sensor.add(\n-        metrics.metricName(ksqlServiceId + metric.name(), metricGroupName, metric.description()),\n+        metrics.metricName(\n+            metric.name(),", "originalCommit": "de1c557de0b7e93fa49851ca3f783769c9c574a2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDUzOTIwNg==", "url": "https://github.com/confluentinc/ksql/pull/6643#discussion_r534539206", "bodyText": "In master there are currently 2 sets of metrics, legacy ones with the service id in the metric name and \"new\" metrics with the service id in the metric group name. The legacy ones are from a while ago and we should be able to remove them now, so now the metrics with the service id in the metric group name are considered legacy and the metrics with the service id in the metric tag is \"new\"", "author": "stevenpyzhang", "createdAt": "2020-12-02T22:58:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDUyMzYyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDUzOTk1OQ==", "url": "https://github.com/confluentinc/ksql/pull/6643#discussion_r534539959", "bodyText": "Ah I see! Gotcha.. Thanks @stevenpyzhang", "author": "harinirajendran", "createdAt": "2020-12-02T23:00:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDUyMzYyOQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDUyNDAxMA==", "url": "https://github.com/confluentinc/ksql/pull/6643#discussion_r534524010", "bodyText": "Why are we changing the name and group for legacy metric here?", "author": "harinirajendran", "createdAt": "2020-12-02T22:27:31Z", "path": "ksqldb-engine/src/main/java/io/confluent/ksql/internal/KsqlEngineMetrics.java", "diffHunk": "@@ -346,16 +359,16 @@ private void configureNumActiveQueriesForGivenState(\n     final String name = state + \"-queries\";\n     // legacy\n     configureGaugeForState(\n-        ksqlServiceId + metricGroupName + \"-\" + name,\n-        metricGroupName,\n-        Collections.emptyMap(),\n+        name,\n+        ksqlServiceIdLegacyPrefix + metricGroupName,", "originalCommit": "de1c557de0b7e93fa49851ca3f783769c9c574a2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzY2NTc2OQ==", "url": "https://github.com/confluentinc/ksql/pull/6643#discussion_r537665769", "bodyText": "Could this be more efficient as it does 1 copy instead of 2?.\nthis.newCustomMetricsTags = ImmutableMap.<String, String>builder()\n       .putAll(customMetricsTags)\n       .put(KsqlConstants.KSQL_SERVICE_ID_METRICS_TAG, ksqlEngine.getServiceId())\n       .build();", "author": "spena", "createdAt": "2020-12-07T16:56:30Z", "path": "ksqldb-engine/src/main/java/io/confluent/ksql/internal/KsqlEngineMetrics.java", "diffHunk": "@@ -88,13 +92,18 @@ public KsqlEngineMetrics(\n       final Optional<KsqlMetricsExtension> metricsExtension\n   ) {\n     this.ksqlEngine = ksqlEngine;\n-    this.ksqlServiceId = ReservedInternalTopics.KSQL_INTERNAL_TOPIC_PREFIX\n+    this.ksqlServiceIdLegacyPrefix = ReservedInternalTopics.KSQL_INTERNAL_TOPIC_PREFIX\n         + ksqlEngine.getServiceId();\n+    this.ksqlServicePrefix = ReservedInternalTopics.CONFLUENT_PREFIX;\n     this.sensors = new ArrayList<>();\n     this.countMetrics = new ArrayList<>();\n     this.metricGroupPrefix = Objects.requireNonNull(metricGroupPrefix, \"metricGroupPrefix\");\n     this.metricGroupName = metricGroupPrefix + METRIC_GROUP_POST_FIX;\n     this.customMetricsTags = customMetricsTags;\n+\n+    final Map<String, String> metricsTags = new HashMap<>(customMetricsTags);\n+    metricsTags.put(KsqlConstants.KSQL_SERVICE_ID_METRICS_TAG, ksqlEngine.getServiceId());\n+    this.newCustomMetricsTags = ImmutableMap.copyOf(metricsTags);", "originalCommit": "de1c557de0b7e93fa49851ca3f783769c9c574a2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzgwODgzMw==", "url": "https://github.com/confluentinc/ksql/pull/6643#discussion_r537808833", "bodyText": "done", "author": "stevenpyzhang", "createdAt": "2020-12-07T20:26:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzY2NTc2OQ=="}], "type": "inlineReview", "revised_code": {"commit": "532630c933c7d832e529ddaabb10be57a79eb929", "chunk": "diff --git a/ksqldb-engine/src/main/java/io/confluent/ksql/internal/KsqlEngineMetrics.java b/ksqldb-engine/src/main/java/io/confluent/ksql/internal/KsqlEngineMetrics.java\nindex 3a2c3d4b7c..3d2713da9f 100644\n--- a/ksqldb-engine/src/main/java/io/confluent/ksql/internal/KsqlEngineMetrics.java\n+++ b/ksqldb-engine/src/main/java/io/confluent/ksql/internal/KsqlEngineMetrics.java\n\n@@ -101,9 +100,10 @@ public class KsqlEngineMetrics implements Closeable {\n     this.metricGroupName = metricGroupPrefix + METRIC_GROUP_POST_FIX;\n     this.customMetricsTags = customMetricsTags;\n \n-    final Map<String, String> metricsTags = new HashMap<>(customMetricsTags);\n-    metricsTags.put(KsqlConstants.KSQL_SERVICE_ID_METRICS_TAG, ksqlEngine.getServiceId());\n-    this.newCustomMetricsTags = ImmutableMap.copyOf(metricsTags);\n+    this.newCustomMetricsTags = ImmutableMap.<String, String>builder()\n+        .putAll(customMetricsTags)\n+        .put(KsqlConstants.KSQL_SERVICE_ID_METRICS_TAG, ksqlEngine.getServiceId())\n+        .build();\n     this.metricsExtension = metricsExtension;\n \n     this.metrics = metrics;\n"}}, {"oid": "532630c933c7d832e529ddaabb10be57a79eb929", "url": "https://github.com/confluentinc/ksql/commit/532630c933c7d832e529ddaabb10be57a79eb929", "message": "minor update", "committedDate": "2020-12-07T21:10:41Z", "type": "commit"}, {"oid": "532630c933c7d832e529ddaabb10be57a79eb929", "url": "https://github.com/confluentinc/ksql/commit/532630c933c7d832e529ddaabb10be57a79eb929", "message": "minor update", "committedDate": "2020-12-07T21:10:41Z", "type": "forcePushed"}]}