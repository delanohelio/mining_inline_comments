{"pr_number": 4814, "pr_title": "feat: use describeTopics() for Kafka healtcheck probe", "pr_createdAt": "2020-03-18T16:13:25Z", "pr_url": "https://github.com/confluentinc/ksql/pull/4814", "timeline": [{"oid": "76d8381e3b66ca8786849eaaf4fff6830ab1cb7b", "url": "https://github.com/confluentinc/ksql/commit/76d8381e3b66ca8786849eaaf4fff6830ab1cb7b", "message": "feat: use describeTopics() for Kafka healtcheck probe", "committedDate": "2020-03-18T23:53:44Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDcwNTM3OA==", "url": "https://github.com/confluentinc/ksql/pull/4814#discussion_r394705378", "bodyText": "@rodesai @vcrfxia If Kafka is not available, this get() will wait for a couple of minutes. Do you think we should have a lower timeout? configurable timeout for healthchecks? or the default 2-3 mins is good?", "author": "spena", "createdAt": "2020-03-18T23:56:18Z", "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/healthcheck/HealthCheckAgent.java", "diffHunk": "@@ -82,13 +94,47 @@ public String getName() {\n     }\n \n     @Override\n-    public HealthCheckResponseDetail check(\n-        final SimpleKsqlClient ksqlClient,\n-        final URI serverEndpoint\n-    ) {\n+    public HealthCheckResponseDetail check(final HealthCheckAgent healthCheckAgent) {\n       final RestResponse<KsqlEntityList> response =\n-          ksqlClient.makeKsqlRequest(serverEndpoint, ksqlStatement);\n+          healthCheckAgent.ksqlClient\n+              .makeKsqlRequest(healthCheckAgent.serverEndpoint, ksqlStatement);\n       return new HealthCheckResponseDetail(response.isSuccessful());\n     }\n   }\n+\n+  private static class KafkaBrokerCheck implements Check {\n+    private final String name;\n+\n+    KafkaBrokerCheck(final String name) {\n+      this.name = Objects.requireNonNull(name, \"name\");\n+    }\n+\n+    @Override\n+    public String getName() {\n+      return name;\n+    }\n+\n+    @SuppressFBWarnings(\"RV_RETURN_VALUE_IGNORED_NO_SIDE_EFFECT\")\n+    @Override\n+    public HealthCheckResponseDetail check(final HealthCheckAgent healthCheckAgent) {\n+      final String commandTopic = ReservedInternalTopics.commandTopic(healthCheckAgent.ksqlConfig);\n+      boolean isHealthy;\n+\n+      try {\n+        healthCheckAgent.serviceContext\n+            .getAdminClient()\n+            .describeTopics(Collections.singletonList(commandTopic))\n+            .all()\n+            .get();", "originalCommit": "76d8381e3b66ca8786849eaaf4fff6830ab1cb7b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDgzMTkzMA==", "url": "https://github.com/confluentinc/ksql/pull/4814#discussion_r394831930", "bodyText": "I think that we should use a shorter timeout here. The healthcheck runs every 30 seconds, so that seems appropriate as a timeout value.", "author": "rodesai", "createdAt": "2020-03-19T07:25:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDcwNTM3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY4NDgwNg==", "url": "https://github.com/confluentinc/ksql/pull/4814#discussion_r395684806", "bodyText": "Done. I set a timeout to 30s", "author": "spena", "createdAt": "2020-03-20T14:45:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDcwNTM3OA=="}], "type": "inlineReview", "revised_code": {"commit": "3d7cbf6b7fd0ff4d91c89b91dc4dd3f70dba4d24", "chunk": "diff --git a/ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/healthcheck/HealthCheckAgent.java b/ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/healthcheck/HealthCheckAgent.java\nindex 7844a8c412..37344282cc 100644\n--- a/ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/healthcheck/HealthCheckAgent.java\n+++ b/ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/healthcheck/HealthCheckAgent.java\n\n@@ -103,6 +105,8 @@ public class HealthCheckAgent {\n   }\n \n   private static class KafkaBrokerCheck implements Check {\n+    private static final int DESCRIBE_TOPICS_TIMEOUT_MS = 30000;\n+\n     private final String name;\n \n     KafkaBrokerCheck(final String name) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDUzMDUyNA==", "url": "https://github.com/confluentinc/ksql/pull/4814#discussion_r394530524", "bodyText": "@spena somehow I accidentally deleted your comment: \"I marked authorization errors as healthy, but I am unsure if that is a desired result in this situation for healthcheck.\"\nI think this is fine - it makes sense to be defensive against a user misconfiguring acls.", "author": "rodesai", "createdAt": "2020-03-18T17:45:20Z", "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/healthcheck/HealthCheckAgent.java", "diffHunk": "@@ -82,13 +94,46 @@ public String getName() {\n     }\n \n     @Override\n-    public HealthCheckResponseDetail check(\n-        final SimpleKsqlClient ksqlClient,\n-        final URI serverEndpoint\n-    ) {\n+    public HealthCheckResponseDetail check(final HealthCheckAgent healthCheckAgent) {\n       final RestResponse<KsqlEntityList> response =\n-          ksqlClient.makeKsqlRequest(serverEndpoint, ksqlStatement);\n+          healthCheckAgent.ksqlClient\n+              .makeKsqlRequest(healthCheckAgent.serverEndpoint, ksqlStatement);\n       return new HealthCheckResponseDetail(response.isSuccessful());\n     }\n   }\n+\n+  private static class KafkaBrokerCheck implements Check {\n+    private final String name;\n+\n+    KafkaBrokerCheck(final String name) {\n+      this.name = Objects.requireNonNull(name, \"name\");\n+    }\n+\n+    @Override\n+    public String getName() {\n+      return name;\n+    }\n+\n+    @SuppressFBWarnings(\"RV_RETURN_VALUE_IGNORED_NO_SIDE_EFFECT\")\n+    @Override\n+    public HealthCheckResponseDetail check(final HealthCheckAgent healthCheckAgent) {\n+      final String commandTopic = ReservedInternalTopics.commandTopic(healthCheckAgent.ksqlConfig);\n+      boolean isHealthy;\n+\n+      try {\n+        healthCheckAgent.serviceContext\n+            .getAdminClient()\n+            .describeTopics(Collections.singletonList(commandTopic))\n+            .values();\n+\n+        isHealthy = true;\n+      } catch (final KsqlTopicAuthorizationException e) {\n+        isHealthy = true;", "originalCommit": "1fe896fded87d1b4165e642b061d5a9847a7fea1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "76d8381e3b66ca8786849eaaf4fff6830ab1cb7b", "chunk": "diff --git a/ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/healthcheck/HealthCheckAgent.java b/ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/healthcheck/HealthCheckAgent.java\nindex f3f6757d91..7844a8c412 100644\n--- a/ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/healthcheck/HealthCheckAgent.java\n+++ b/ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/healthcheck/HealthCheckAgent.java\n\n@@ -124,7 +124,8 @@ public class HealthCheckAgent {\n         healthCheckAgent.serviceContext\n             .getAdminClient()\n             .describeTopics(Collections.singletonList(commandTopic))\n-            .values();\n+            .all()\n+            .get();\n \n         isHealthy = true;\n       } catch (final KsqlTopicAuthorizationException e) {\n"}}, {"oid": "3d7cbf6b7fd0ff4d91c89b91dc4dd3f70dba4d24", "url": "https://github.com/confluentinc/ksql/commit/3d7cbf6b7fd0ff4d91c89b91dc4dd3f70dba4d24", "message": "fix: set timeout to 30s when describing topics", "committedDate": "2020-03-20T14:45:19Z", "type": "forcePushed"}, {"oid": "c0b0130ac0213c593ed4845bd3443850e0a72498", "url": "https://github.com/confluentinc/ksql/commit/c0b0130ac0213c593ed4845bd3443850e0a72498", "message": "fix: set timeout to 30s when describing topics", "committedDate": "2020-03-20T15:18:15Z", "type": "forcePushed"}, {"oid": "3f4926ef48db02c0cabef45c2d31e45ef8765df7", "url": "https://github.com/confluentinc/ksql/commit/3f4926ef48db02c0cabef45c2d31e45ef8765df7", "message": "fix: set timeout to 30s when describing topics", "committedDate": "2020-03-20T16:01:41Z", "type": "forcePushed"}, {"oid": "81a49c6d605f4bebb4937c790f2357f8971c0579", "url": "https://github.com/confluentinc/ksql/commit/81a49c6d605f4bebb4937c790f2357f8971c0579", "message": "feat: use describeTopics() for Kafka healtcheck probe", "committedDate": "2020-03-20T18:19:08Z", "type": "commit"}, {"oid": "b3be5b6ad6f1657860e2d0fd0cead24470b7404f", "url": "https://github.com/confluentinc/ksql/commit/b3be5b6ad6f1657860e2d0fd0cead24470b7404f", "message": "fix: set timeout to 30s when describing topics", "committedDate": "2020-03-20T18:19:09Z", "type": "commit"}, {"oid": "b3be5b6ad6f1657860e2d0fd0cead24470b7404f", "url": "https://github.com/confluentinc/ksql/commit/b3be5b6ad6f1657860e2d0fd0cead24470b7404f", "message": "fix: set timeout to 30s when describing topics", "committedDate": "2020-03-20T18:19:09Z", "type": "forcePushed"}]}