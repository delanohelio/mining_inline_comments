{"pr_number": 6392, "pr_title": "chore: partition by null should set key format to NONE", "pr_createdAt": "2020-10-09T13:05:55Z", "pr_url": "https://github.com/confluentinc/ksql/pull/6392", "timeline": [{"oid": "d5ea7d17c581cd988cc8cee9b00a76dd0d530021", "url": "https://github.com/confluentinc/ksql/commit/d5ea7d17c581cd988cc8cee9b00a76dd0d530021", "message": "chore: partition by null should set key format to NONE\n\nfixes: https://github.com/confluentinc/ksql/issues/6391", "committedDate": "2020-10-09T13:05:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUyNzc0MQ==", "url": "https://github.com/confluentinc/ksql/pull/6392#discussion_r502527741", "bodyText": "did you mean to return here?", "author": "agavra", "createdAt": "2020-10-09T15:59:04Z", "path": "ksqldb-engine/src/main/java/io/confluent/ksql/analyzer/Analyzer.java", "diffHunk": "@@ -189,6 +191,30 @@ private void analyzeNonStdOutSink(final Sink sink) {\n           .setInto(Into.newSink(sink.getName(), topicName, windowInfo, keyFmtInfo, valueFmtInfo));\n     }\n \n+    private FormatInfo buildKeyFormatInfo(\n+        final Optional<String> explicitFormat,\n+        final Map<String, String> formatProperties,\n+        final FormatInfo sourceFormat\n+    ) {\n+      final boolean partitioningByNull = analysis.getPartitionBy()\n+          .map(pb -> pb.getExpression() instanceof NullLiteral)\n+          .orElse(false);\n+\n+      if (partitioningByNull) {\n+        final boolean nonNoneExplicitFormat = explicitFormat\n+            .map(fmt -> !fmt.equalsIgnoreCase(NoneFormat.NAME))\n+            .orElse(false);\n+\n+        if (nonNoneExplicitFormat) {\n+          throw new KsqlException(\"Key format specified for stream without key columns.\");\n+        }\n+\n+        FormatInfo.of(NoneFormat.NAME);", "originalCommit": "d5ea7d17c581cd988cc8cee9b00a76dd0d530021", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzIyOTY1NQ==", "url": "https://github.com/confluentinc/ksql/pull/6392#discussion_r503229655", "bodyText": "Yup!", "author": "big-andy-coates", "createdAt": "2020-10-12T11:27:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUyNzc0MQ=="}], "type": "inlineReview", "revised_code": {"commit": "68c16ba5b72267dc4834b108f84685d70ae7905d", "chunk": "diff --git a/ksqldb-engine/src/main/java/io/confluent/ksql/analyzer/Analyzer.java b/ksqldb-engine/src/main/java/io/confluent/ksql/analyzer/Analyzer.java\nindex b03d7d836a..6b03b6cf6d 100644\n--- a/ksqldb-engine/src/main/java/io/confluent/ksql/analyzer/Analyzer.java\n+++ b/ksqldb-engine/src/main/java/io/confluent/ksql/analyzer/Analyzer.java\n\n@@ -209,7 +209,7 @@ class Analyzer {\n           throw new KsqlException(\"Key format specified for stream without key columns.\");\n         }\n \n-        FormatInfo.of(NoneFormat.NAME);\n+        return FormatInfo.of(NoneFormat.NAME);\n       }\n \n       return buildFormatInfo(explicitFormat, formatProperties, sourceFormat);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUyODE1NQ==", "url": "https://github.com/confluentinc/ksql/pull/6392#discussion_r502528155", "bodyText": "why is this an error? can't I have null keys with non-NONE formats?", "author": "agavra", "createdAt": "2020-10-09T15:59:43Z", "path": "ksqldb-engine/src/main/java/io/confluent/ksql/analyzer/Analyzer.java", "diffHunk": "@@ -189,6 +191,30 @@ private void analyzeNonStdOutSink(final Sink sink) {\n           .setInto(Into.newSink(sink.getName(), topicName, windowInfo, keyFmtInfo, valueFmtInfo));\n     }\n \n+    private FormatInfo buildKeyFormatInfo(\n+        final Optional<String> explicitFormat,\n+        final Map<String, String> formatProperties,\n+        final FormatInfo sourceFormat\n+    ) {\n+      final boolean partitioningByNull = analysis.getPartitionBy()\n+          .map(pb -> pb.getExpression() instanceof NullLiteral)\n+          .orElse(false);\n+\n+      if (partitioningByNull) {\n+        final boolean nonNoneExplicitFormat = explicitFormat\n+            .map(fmt -> !fmt.equalsIgnoreCase(NoneFormat.NAME))\n+            .orElse(false);\n+\n+        if (nonNoneExplicitFormat) {\n+          throw new KsqlException(\"Key format specified for stream without key columns.\");", "originalCommit": "d5ea7d17c581cd988cc8cee9b00a76dd0d530021", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzIyOTUzNA==", "url": "https://github.com/confluentinc/ksql/pull/6392#discussion_r503229534", "bodyText": "If the key format supports schema inference then it's going to blow up later when trying to build the schema for the key.", "author": "big-andy-coates", "createdAt": "2020-10-12T11:26:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUyODE1NQ=="}], "type": "inlineReview", "revised_code": {"commit": "68c16ba5b72267dc4834b108f84685d70ae7905d", "chunk": "diff --git a/ksqldb-engine/src/main/java/io/confluent/ksql/analyzer/Analyzer.java b/ksqldb-engine/src/main/java/io/confluent/ksql/analyzer/Analyzer.java\nindex b03d7d836a..6b03b6cf6d 100644\n--- a/ksqldb-engine/src/main/java/io/confluent/ksql/analyzer/Analyzer.java\n+++ b/ksqldb-engine/src/main/java/io/confluent/ksql/analyzer/Analyzer.java\n\n@@ -209,7 +209,7 @@ class Analyzer {\n           throw new KsqlException(\"Key format specified for stream without key columns.\");\n         }\n \n-        FormatInfo.of(NoneFormat.NAME);\n+        return FormatInfo.of(NoneFormat.NAME);\n       }\n \n       return buildFormatInfo(explicitFormat, formatProperties, sourceFormat);\n"}}, {"oid": "188841abead7a427d1f44abb816d3554962f9082", "url": "https://github.com/confluentinc/ksql/commit/188841abead7a427d1f44abb816d3554962f9082", "message": "Merge branch 'master' into partition_by_null", "committedDate": "2020-10-12T11:24:49Z", "type": "commit"}, {"oid": "cc628e7cf2253e7f9fccbf0f75aba0017684b332", "url": "https://github.com/confluentinc/ksql/commit/cc628e7cf2253e7f9fccbf0f75aba0017684b332", "message": "Merge branch 'master' into partition_by_null", "committedDate": "2020-10-12T20:13:39Z", "type": "commit"}, {"oid": "68c16ba5b72267dc4834b108f84685d70ae7905d", "url": "https://github.com/confluentinc/ksql/commit/68c16ba5b72267dc4834b108f84685d70ae7905d", "message": "chore: requested changes", "committedDate": "2020-10-12T20:19:29Z", "type": "commit"}, {"oid": "ef75343d900eb075f0e0634a3ae3c570e2caed20", "url": "https://github.com/confluentinc/ksql/commit/ef75343d900eb075f0e0634a3ae3c570e2caed20", "message": "test: historic plans", "committedDate": "2020-10-13T09:57:52Z", "type": "commit"}, {"oid": "3b37e68d97acd89cb3735ea9dce475843cbcc630", "url": "https://github.com/confluentinc/ksql/commit/3b37e68d97acd89cb3735ea9dce475843cbcc630", "message": "Merge branch 'master' into partition_by_null", "committedDate": "2020-10-13T09:58:14Z", "type": "commit"}]}