{"pr_number": 6240, "pr_title": "feat: surface error to user when command topic deleted while server running", "pr_createdAt": "2020-09-16T23:16:18Z", "pr_url": "https://github.com/confluentinc/ksql/pull/6240", "timeline": [{"oid": "3f33250f2dbed4370eb0ee4514f5be9f4555d5e7", "url": "https://github.com/confluentinc/ksql/commit/3f33250f2dbed4370eb0ee4514f5be9f4555d5e7", "message": "feat: surface error to user when command topic deleted while server running", "committedDate": "2020-09-17T18:12:24Z", "type": "forcePushed"}, {"oid": "39235d4ee23b29fcf6b79bb7d2f82eba4f21c2ec", "url": "https://github.com/confluentinc/ksql/commit/39235d4ee23b29fcf6b79bb7d2f82eba4f21c2ec", "message": "feat: surface error to user when command topic deleted while server running", "committedDate": "2020-09-18T21:19:47Z", "type": "forcePushed"}, {"oid": "059b68f6a0f7e58865dce0009bcb2b4c3a3af958", "url": "https://github.com/confluentinc/ksql/commit/059b68f6a0f7e58865dce0009bcb2b4c3a3af958", "message": "feat: surface error to user when command topic deleted while server running", "committedDate": "2020-09-18T21:21:01Z", "type": "forcePushed"}, {"oid": "2e06bfc99fa013c42da60acbf6e6c0d1c7d759b4", "url": "https://github.com/confluentinc/ksql/commit/2e06bfc99fa013c42da60acbf6e6c0d1c7d759b4", "message": "test commit", "committedDate": "2020-09-21T04:56:49Z", "type": "commit"}, {"oid": "53a47a9a48ad3aa544a908ebb4b26ced31b8385b", "url": "https://github.com/confluentinc/ksql/commit/53a47a9a48ad3aa544a908ebb4b26ced31b8385b", "message": "refactor", "committedDate": "2020-09-21T04:56:50Z", "type": "commit"}, {"oid": "085317d3dff1f386e8f1260716d0a2e6abd343b2", "url": "https://github.com/confluentinc/ksql/commit/085317d3dff1f386e8f1260716d0a2e6abd343b2", "message": "test commit", "committedDate": "2020-09-21T04:57:40Z", "type": "commit"}, {"oid": "deb88e15c93f03161dccbd45bc424d17fbe05f0f", "url": "https://github.com/confluentinc/ksql/commit/deb88e15c93f03161dccbd45bc424d17fbe05f0f", "message": "refactor", "committedDate": "2020-09-21T04:57:40Z", "type": "commit"}, {"oid": "04bf50f4fb7a371f61abf983aaadde99dcd918a2", "url": "https://github.com/confluentinc/ksql/commit/04bf50f4fb7a371f61abf983aaadde99dcd918a2", "message": "feat: surface error to user when command topic deleted while server running", "committedDate": "2020-09-21T04:57:41Z", "type": "commit"}, {"oid": "04bf50f4fb7a371f61abf983aaadde99dcd918a2", "url": "https://github.com/confluentinc/ksql/commit/04bf50f4fb7a371f61abf983aaadde99dcd918a2", "message": "feat: surface error to user when command topic deleted while server running", "committedDate": "2020-09-21T04:57:41Z", "type": "forcePushed"}, {"oid": "98e60fad32c9fee69d48c3033851d83f01d6b5f6", "url": "https://github.com/confluentinc/ksql/commit/98e60fad32c9fee69d48c3033851d83f01d6b5f6", "message": "feedback", "committedDate": "2020-09-21T21:26:19Z", "type": "commit"}, {"oid": "6e8a7e23fb4593c05af86d1809b6389b37a660af", "url": "https://github.com/confluentinc/ksql/commit/6e8a7e23fb4593c05af86d1809b6389b37a660af", "message": "refactor logic in CommandRunner", "committedDate": "2020-09-21T22:33:42Z", "type": "commit"}, {"oid": "7f1cbfa9f6c2bf1247cf029317fc0ba8c774360e", "url": "https://github.com/confluentinc/ksql/commit/7f1cbfa9f6c2bf1247cf029317fc0ba8c774360e", "message": "Merge branch 'fail-backup-corruption' into command-topic-deleted", "committedDate": "2020-09-21T22:59:45Z", "type": "commit"}, {"oid": "f63c88c8e5192d66805852980ae1a4c74bb5b4ab", "url": "https://github.com/confluentinc/ksql/commit/f63c88c8e5192d66805852980ae1a4c74bb5b4ab", "message": "Merge branch 'master' into command-topic-deleted", "committedDate": "2020-09-22T00:23:31Z", "type": "commit"}, {"oid": "2d66b3173fc168da504ab20d9eeb48203c5647aa", "url": "https://github.com/confluentinc/ksql/commit/2d66b3173fc168da504ab20d9eeb48203c5647aa", "message": "Merge branch 'master' into command-topic-deleted", "committedDate": "2020-09-22T20:21:16Z", "type": "commit"}, {"oid": "2d66b3173fc168da504ab20d9eeb48203c5647aa", "url": "https://github.com/confluentinc/ksql/commit/2d66b3173fc168da504ab20d9eeb48203c5647aa", "message": "Merge branch 'master' into command-topic-deleted", "committedDate": "2020-09-22T20:21:16Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzAyNjU3Mw==", "url": "https://github.com/confluentinc/ksql/pull/6240#discussion_r493026573", "bodyText": "I remember a discussion on the design doc indicated that maybe we don't want to differentiate between corrupted and deleted. What was the decision on that? (also good to document it here for posterity)", "author": "agavra", "createdAt": "2020-09-22T20:52:40Z", "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/computation/CommandRunner.java", "diffHunk": "@@ -91,8 +96,9 @@\n \n   public enum CommandRunnerDegradedReason {\n     NONE(errors -> \"\"),\n-    CORRUPTED(Errors:: commandRunnerDegradedBackupCorruptedErrorMessage),\n-    INCOMPATIBLE_COMMAND(Errors:: commandRunnerDegradedIncompatibleCommandsErrorMessage);\n+    CORRUPTED(Errors::commandRunnerDegradedBackupCorruptedErrorMessage),\n+    INCOMPATIBLE_COMMAND(Errors::commandRunnerDegradedIncompatibleCommandsErrorMessage),\n+    COMMAND_TOPIC_DELETED(Errors::commandRunnerDegradedCommandTopicDeletedErrorMessage);", "originalCommit": "2d66b3173fc168da504ab20d9eeb48203c5647aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzAzNDUzNA==", "url": "https://github.com/confluentinc/ksql/pull/6240#discussion_r493034534", "bodyText": "I think the main reason is right now, backups are optional, so if backups aren't enabled, then it wouldn't really make sense to have the degraded reason be CORRUPTED.", "author": "stevenpyzhang", "createdAt": "2020-09-22T21:08:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzAyNjU3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzIxOTk4MQ==", "url": "https://github.com/confluentinc/ksql/pull/6240#discussion_r493219981", "bodyText": "After talking it over with Rohan a bit more, I've combined CORRUPTED and COMMAND_TOPIC_DELETED into CORRUPTED. The COMMAND_TOPIC_DELETED could show up as CORRUPTED after a restart and having different states for the same external action (deleting the command topic) is strange.\nI've made the error message returned from the API generic enough so it address both the backup corruption and the command topic deleted/modified case\nThe server has detected corruption in the command topic due to modifications performed on it. DDL statements will not be processed any further.\nIf a backup of the command topic is available, restore the command topic using the backup file.\nA server restart is required to restore full functionality", "author": "stevenpyzhang", "createdAt": "2020-09-23T06:10:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzAyNjU3Mw=="}], "type": "inlineReview", "revised_code": {"commit": "1ec87c075a61ef906bd12b387217de12f45f2cef", "chunk": "diff --git a/ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/computation/CommandRunner.java b/ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/computation/CommandRunner.java\nindex 9968b6599a..55f546aa5b 100644\n--- a/ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/computation/CommandRunner.java\n+++ b/ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/computation/CommandRunner.java\n\n@@ -98,7 +98,8 @@ public class CommandRunner implements Closeable {\n     NONE(errors -> \"\"),\n     CORRUPTED(Errors::commandRunnerDegradedBackupCorruptedErrorMessage),\n     INCOMPATIBLE_COMMAND(Errors::commandRunnerDegradedIncompatibleCommandsErrorMessage),\n-    COMMAND_TOPIC_DELETED(Errors::commandRunnerDegradedCommandTopicDeletedErrorMessage);\n+    COMMAND_TOPIC_DELETED_OR_MODIFIED(\n+        Errors::commandRunnerDegradedCommandTopicDeletedModifiedErrorMessage);\n \n     private final Function<Errors, String> msgFactory;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzAzMTE2OA==", "url": "https://github.com/confluentinc/ksql/pull/6240#discussion_r493031168", "bodyText": "we can save this for another PR, but I think it makes sense to have this method return some status then to set a ton of flags and check them in the main loop", "author": "agavra", "createdAt": "2020-09-22T21:01:09Z", "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/computation/CommandRunner.java", "diffHunk": "@@ -289,6 +302,9 @@ void fetchAndRunCommands() {\n     lastPollTime.set(clock.instant());\n     final List<QueuedCommand> commands = commandStore.getNewCommands(NEW_CMDS_TIMEOUT);\n     if (commands.isEmpty()) {\n+      if (!commandTopicExists.get()) {\n+        commandTopicDeleted = true;", "originalCommit": "2d66b3173fc168da504ab20d9eeb48203c5647aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzA0NzQ0MQ==", "url": "https://github.com/confluentinc/ksql/pull/6240#discussion_r493047441", "bodyText": "I'll file a follow up issue for that refactoring improvement.", "author": "stevenpyzhang", "createdAt": "2020-09-22T21:35:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzAzMTE2OA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzAzMTU1NQ==", "url": "https://github.com/confluentinc/ksql/pull/6240#discussion_r493031555", "bodyText": "does offset reset always mean command topic deleted? it could mean the retention was configured incorrectly perhaps?", "author": "agavra", "createdAt": "2020-09-22T21:01:57Z", "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/computation/CommandRunner.java", "diffHunk": "@@ -437,6 +460,13 @@ public void run() {\n         if (!closed) {\n           throw wue;\n         }\n+      } catch (final OffsetOutOfRangeException e) {\n+        LOG.warn(\"The command topic offset was reset. CommandRunner thread exiting.\");\n+        state = new Status(\n+            CommandRunnerStatus.DEGRADED,\n+            CommandRunnerDegradedReason.COMMAND_TOPIC_DELETED", "originalCommit": "2d66b3173fc168da504ab20d9eeb48203c5647aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzA0NzcyOQ==", "url": "https://github.com/confluentinc/ksql/pull/6240#discussion_r493047729", "bodyText": "Every time we start up the server, we'd check/override the command topic properties such that the retention.ms=-1 although I guess it is possible for the user themselves to override the retention config on the command topic which could trigger this. I can enhance the error message so that it mentions the degraded state is a result of the command topic being deleted or the configurations being modified for it\nThe REASON can be updated to COMMAND_TOPIC_DELETED_OR_MODIFIED", "author": "stevenpyzhang", "createdAt": "2020-09-22T21:36:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzAzMTU1NQ=="}], "type": "inlineReview", "revised_code": {"commit": "1ec87c075a61ef906bd12b387217de12f45f2cef", "chunk": "diff --git a/ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/computation/CommandRunner.java b/ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/computation/CommandRunner.java\nindex 9968b6599a..55f546aa5b 100644\n--- a/ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/computation/CommandRunner.java\n+++ b/ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/computation/CommandRunner.java\n\n@@ -464,7 +465,7 @@ public class CommandRunner implements Closeable {\n         LOG.warn(\"The command topic offset was reset. CommandRunner thread exiting.\");\n         state = new Status(\n             CommandRunnerStatus.DEGRADED,\n-            CommandRunnerDegradedReason.COMMAND_TOPIC_DELETED\n+            CommandRunnerDegradedReason.COMMAND_TOPIC_DELETED_OR_MODIFIED\n         );\n         closeEarly();\n       } finally {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzAzMTc2Mw==", "url": "https://github.com/confluentinc/ksql/pull/6240#discussion_r493031763", "bodyText": "missing @Test annotation?", "author": "agavra", "createdAt": "2020-09-22T21:02:26Z", "path": "ksqldb-rest-app/src/test/java/io/confluent/ksql/rest/server/computation/CommandRunnerTest.java", "diffHunk": "@@ -524,6 +549,25 @@ public void shouldCloseEarlyWhenSerializationExceptionInFetch() throws Exception\n     inOrder.verify(commandStore).close();\n   }\n \n+  public void shouldCloseEarlyWhenOffsetOutOfRangeException() throws Exception {", "originalCommit": "2d66b3173fc168da504ab20d9eeb48203c5647aa", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1ec87c075a61ef906bd12b387217de12f45f2cef", "chunk": "diff --git a/ksqldb-rest-app/src/test/java/io/confluent/ksql/rest/server/computation/CommandRunnerTest.java b/ksqldb-rest-app/src/test/java/io/confluent/ksql/rest/server/computation/CommandRunnerTest.java\nindex 8e0add7787..ebc0cf1301 100644\n--- a/ksqldb-rest-app/src/test/java/io/confluent/ksql/rest/server/computation/CommandRunnerTest.java\n+++ b/ksqldb-rest-app/src/test/java/io/confluent/ksql/rest/server/computation/CommandRunnerTest.java\n\n@@ -549,6 +551,7 @@ public class CommandRunnerTest {\n     inOrder.verify(commandStore).close();\n   }\n \n+  @Test\n   public void shouldCloseEarlyWhenOffsetOutOfRangeException() throws Exception {\n     // Given:\n     when(commandStore.getNewCommands(any()))\n"}}, {"oid": "1ec87c075a61ef906bd12b387217de12f45f2cef", "url": "https://github.com/confluentinc/ksql/commit/1ec87c075a61ef906bd12b387217de12f45f2cef", "message": "update error messages", "committedDate": "2020-09-22T21:48:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzA4MTc3MA==", "url": "https://github.com/confluentinc/ksql/pull/6240#discussion_r493081770", "bodyText": "How is this different than corrupted? We're leaking an implementation detail of how we detect corruption here. The underlying condition is the same - the command topic isn't in the state that the system expects.", "author": "rodesai", "createdAt": "2020-09-22T23:06:07Z", "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/computation/CommandRunner.java", "diffHunk": "@@ -91,8 +96,10 @@\n \n   public enum CommandRunnerDegradedReason {\n     NONE(errors -> \"\"),\n-    CORRUPTED(Errors:: commandRunnerDegradedBackupCorruptedErrorMessage),\n-    INCOMPATIBLE_COMMAND(Errors:: commandRunnerDegradedIncompatibleCommandsErrorMessage);\n+    CORRUPTED(Errors::commandRunnerDegradedBackupCorruptedErrorMessage),\n+    INCOMPATIBLE_COMMAND(Errors::commandRunnerDegradedIncompatibleCommandsErrorMessage),\n+    COMMAND_TOPIC_DELETED_OR_MODIFIED(", "originalCommit": "1ec87c075a61ef906bd12b387217de12f45f2cef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzE5OTc2Nw==", "url": "https://github.com/confluentinc/ksql/pull/6240#discussion_r493199767", "bodyText": "I've combined the two now.", "author": "stevenpyzhang", "createdAt": "2020-09-23T05:06:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzA4MTc3MA=="}], "type": "inlineReview", "revised_code": {"commit": "0368e77d39ca15908756509d2cc4e5c0efa7fbd3", "chunk": "diff --git a/ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/computation/CommandRunner.java b/ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/computation/CommandRunner.java\nindex 55f546aa5b..0bb68edced 100644\n--- a/ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/computation/CommandRunner.java\n+++ b/ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/computation/CommandRunner.java\n\n@@ -96,10 +96,8 @@ public class CommandRunner implements Closeable {\n \n   public enum CommandRunnerDegradedReason {\n     NONE(errors -> \"\"),\n-    CORRUPTED(Errors::commandRunnerDegradedBackupCorruptedErrorMessage),\n-    INCOMPATIBLE_COMMAND(Errors::commandRunnerDegradedIncompatibleCommandsErrorMessage),\n-    COMMAND_TOPIC_DELETED_OR_MODIFIED(\n-        Errors::commandRunnerDegradedCommandTopicDeletedModifiedErrorMessage);\n+    CORRUPTED(Errors::commandRunnerDegradedCorruptedErrorMessage),\n+    INCOMPATIBLE_COMMAND(Errors::commandRunnerDegradedIncompatibleCommandsErrorMessage);\n \n     private final Function<Errors, String> msgFactory;\n \n"}}, {"oid": "0368e77d39ca15908756509d2cc4e5c0efa7fbd3", "url": "https://github.com/confluentinc/ksql/commit/0368e77d39ca15908756509d2cc4e5c0efa7fbd3", "message": "combine corrupted and command topic missing degraded reason", "committedDate": "2020-09-23T04:55:32Z", "type": "commit"}, {"oid": "0368e77d39ca15908756509d2cc4e5c0efa7fbd3", "url": "https://github.com/confluentinc/ksql/commit/0368e77d39ca15908756509d2cc4e5c0efa7fbd3", "message": "combine corrupted and command topic missing degraded reason", "committedDate": "2020-09-23T04:55:32Z", "type": "forcePushed"}]}