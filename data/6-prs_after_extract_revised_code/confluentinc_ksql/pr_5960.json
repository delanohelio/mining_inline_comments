{"pr_number": 5960, "pr_title": "fix: NPE when udf metrics enabled", "pr_createdAt": "2020-08-06T19:00:46Z", "pr_url": "https://github.com/confluentinc/ksql/pull/5960", "timeline": [{"oid": "c2081bfe6dbd3ea38258833e0ae71bf6ee664e60", "url": "https://github.com/confluentinc/ksql/commit/c2081bfe6dbd3ea38258833e0ae71bf6ee664e60", "message": "fix: NPE when udf metrics enabled\n\nfixes: https://github.com/confluentinc/ksql/issues/5890\n\nFixes an NPE thrown when the second instance of a UDAF is initialized. The NPE was being thrown due to a bug in the code that failed to initialise the sensor fields in the `UdafAggregateFunction` class if the sensor already existed.\n\nThe commit also refactors the code used to add function invocation metrics such that all three function types: UDF, UDTF and UDAF, use the same function to register metrics.\n\nUnit tests added to ensure this single code path doesn't throw an NPE or return null on the subsequent invocation.\n\nAlso added `ksql.udf.collect.metrics` metric to the server config file, so users are more likely to be able to find it and try it out.\n\nMoved UDTF functions out of the `ksql-udf` group and into `ksql-udtf` group. Having them in the former was another bug.", "committedDate": "2020-08-06T18:59:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY1MTY4Mg==", "url": "https://github.com/confluentinc/ksql/pull/5960#discussion_r466651682", "bodyText": "there's a race here that is possible here where two calls for the same metrics.getSensor(sensorName) don't find the sensor and they both end up registering the extra metrics. I don't know of a good way around it...", "author": "agavra", "createdAt": "2020-08-06T19:55:38Z", "path": "ksqldb-engine/src/main/java/io/confluent/ksql/function/FunctionMetrics.java", "diffHunk": "@@ -0,0 +1,108 @@\n+/*\n+ * Copyright 2020 Confluent Inc.\n+ *\n+ * Licensed under the Confluent Community License (the \"License\"); you may not use\n+ * this file except in compliance with the License.  You may obtain a copy of the\n+ * License at\n+ *\n+ * http://www.confluent.io/confluent-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OF ANY KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package io.confluent.ksql.function;\n+\n+import java.util.Optional;\n+import java.util.concurrent.TimeUnit;\n+import java.util.function.BiFunction;\n+import org.apache.kafka.common.MetricName;\n+import org.apache.kafka.common.metrics.Metrics;\n+import org.apache.kafka.common.metrics.Sensor;\n+import org.apache.kafka.common.metrics.stats.Avg;\n+import org.apache.kafka.common.metrics.stats.Max;\n+import org.apache.kafka.common.metrics.stats.Rate;\n+import org.apache.kafka.common.metrics.stats.WindowedCount;\n+\n+public final class FunctionMetrics {\n+\n+  static final String AVG_DESC = \"Average time for invocations of the %s\";\n+  static final String MAX_DESC = \"Max time for invocations of the %s\";\n+  static final String COUNT_DESC = \"Total number of invocations of the %s\";\n+  static final String RATE_DESC = \"The rate of invocations (invocations per second) of the %s\";\n+\n+  private FunctionMetrics() {\n+  }\n+\n+  /**\n+   * Gets an existing invocation sensor, or creates one if needed.\n+   *\n+   * <p>Sensor created with avg, max, count and rate metrics.\n+   *\n+   * @param metrics the metrics service.\n+   * @param sensorName the name of the sensor\n+   * @param groupName the name of the group\n+   * @param functionDescription the description of the function.\n+   */\n+  public static void initInvocationSensor(\n+      final Optional<Metrics> metrics,\n+      final String sensorName,\n+      final String groupName,\n+      final String functionDescription\n+  ) {\n+    metrics.ifPresent(m -> getInvocationSensor(m, sensorName, groupName, functionDescription));\n+  }\n+\n+  /**\n+   * Gets an existing invocation sensor, or creates one if needed.\n+   *\n+   * <p>Sensor created with avg, max, count and rate metrics.\n+   *\n+   * @param metrics the metrics service.\n+   * @param sensorName the name of the sensor\n+   * @param groupName the name of the group\n+   * @param functionDescription the description of the function.\n+   */\n+  public static Sensor getInvocationSensor(\n+      final Metrics metrics,\n+      final String sensorName,\n+      final String groupName,\n+      final String functionDescription\n+  ) {\n+    final Sensor existing = metrics.getSensor(sensorName);\n+    if (existing != null) {\n+      return existing;\n+    }\n+\n+    final Sensor newSensor = metrics.sensor(sensorName);", "originalCommit": "c2081bfe6dbd3ea38258833e0ae71bf6ee664e60", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzEwNzMxNA==", "url": "https://github.com/confluentinc/ksql/pull/5960#discussion_r467107314", "bodyText": "Yeah I know, but I was just fixing the NPE and being lazy ;). Fixed it.", "author": "big-andy-coates", "createdAt": "2020-08-07T15:20:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY1MTY4Mg=="}], "type": "inlineReview", "revised_code": {"commit": "6f9180a41b9b6d1c571d7aa7fd5e20948b39471c", "chunk": "diff --git a/ksqldb-engine/src/main/java/io/confluent/ksql/function/FunctionMetrics.java b/ksqldb-engine/src/main/java/io/confluent/ksql/function/FunctionMetrics.java\nindex a2690bd070..08ce96c990 100644\n--- a/ksqldb-engine/src/main/java/io/confluent/ksql/function/FunctionMetrics.java\n+++ b/ksqldb-engine/src/main/java/io/confluent/ksql/function/FunctionMetrics.java\n\n@@ -71,38 +71,36 @@ public final class FunctionMetrics {\n       final String groupName,\n       final String functionDescription\n   ) {\n-    final Sensor existing = metrics.getSensor(sensorName);\n-    if (existing != null) {\n-      return existing;\n+    final Sensor sensor = metrics.sensor(sensorName);\n+    if (sensor.hasMetrics()) {\n+      return sensor;\n     }\n \n-    final Sensor newSensor = metrics.sensor(sensorName);\n-\n     final BiFunction<String, String, MetricName> metricNamer = (suffix, descPattern) -> {\n       final String description = String.format(descPattern, functionDescription);\n       return metrics.metricName(sensorName + \"-\" + suffix, groupName, description);\n     };\n \n-    newSensor.add(\n+    sensor.add(\n         metricNamer.apply(\"avg\", AVG_DESC),\n         new Avg()\n     );\n \n-    newSensor.add(\n+    sensor.add(\n         metricNamer.apply(\"max\", MAX_DESC),\n         new Max()\n     );\n \n-    newSensor.add(\n+    sensor.add(\n         metricNamer.apply(\"count\", COUNT_DESC),\n         new WindowedCount()\n     );\n \n-    newSensor.add(\n+    sensor.add(\n         metricNamer.apply(\"rate\", RATE_DESC),\n         new Rate(TimeUnit.SECONDS, new WindowedCount())\n     );\n \n-    return newSensor;\n+    return sensor;\n   }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY1Mjg2Ng==", "url": "https://github.com/confluentinc/ksql/pull/5960#discussion_r466652866", "bodyText": "if anyone was relying on the old metrics, their alerts for udtfs will break with this change. probably ok as I'd be shocked if anyone was actually writing their own UDTFs and using metrics on them at this point but something to call out \ud83d\ude09", "author": "agavra", "createdAt": "2020-08-06T19:58:07Z", "path": "ksqldb-engine/src/main/java/io/confluent/ksql/function/UdtfLoader.java", "diffHunk": "@@ -67,7 +68,8 @@ public void loadUdtfFromClass(\n     }\n     final String functionName = udtfDescriptionAnnotation.name();\n     final String sensorName = \"ksql-udtf-\" + functionName;\n-    FunctionLoaderUtils.addSensor(sensorName, functionName, metrics);\n+\n+    FunctionMetrics.initInvocationSensor(metrics, sensorName, \"ksql-udtf\", functionName + \" udtf\");", "originalCommit": "c2081bfe6dbd3ea38258833e0ae71bf6ee664e60", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzEwMDk5NQ==", "url": "https://github.com/confluentinc/ksql/pull/5960#discussion_r467100995", "bodyText": "Yeah, I'm aware, but ... meh.  turning metrics on caused an NPE, so likely no one is using them, and better to change it now.", "author": "big-andy-coates", "createdAt": "2020-08-07T15:09:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY1Mjg2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzEwMTE4MQ==", "url": "https://github.com/confluentinc/ksql/pull/5960#discussion_r467101181", "bodyText": "As mentioned in the description, I see this as a bug fix.", "author": "big-andy-coates", "createdAt": "2020-08-07T15:10:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY1Mjg2Ng=="}], "type": "inlineReview", "revised_code": null}, {"oid": "6f9180a41b9b6d1c571d7aa7fd5e20948b39471c", "url": "https://github.com/confluentinc/ksql/commit/6f9180a41b9b6d1c571d7aa7fd5e20948b39471c", "message": "chore: fix race condition", "committedDate": "2020-08-07T15:20:33Z", "type": "commit"}]}