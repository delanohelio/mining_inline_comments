{"pr_number": 1467, "pr_title": "Fix/kw41/worker consistency check", "pr_createdAt": "2020-12-02T16:41:05Z", "pr_url": "https://github.com/bakdata/conquery/pull/1467", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDg5ODk0OA==", "url": "https://github.com/bakdata/conquery/pull/1467#discussion_r534898948", "bodyText": "Dann wenigstens als implNote", "author": "awildturtok", "createdAt": "2020-12-03T08:22:02Z", "path": "backend/src/main/java/com/bakdata/conquery/io/xodus/stores/CachedStore.java", "diffHunk": "@@ -32,7 +32,6 @@ public void add(KEY key, VALUE value) throws JSONException {\n \n \t@Override\n \tpublic VALUE get(KEY key) {\n-\t\t// TODO: 08.01.2020 fk: This assumes that all values have been read at some point!", "originalCommit": "c4ab28ec806a8e7300f1d5e2dee85552e5b83e3a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTAyMzk5Ng==", "url": "https://github.com/bakdata/conquery/pull/1467#discussion_r535023996", "bodyText": "Das hatte ich ausversehen gel\u00f6scht, weil ich da rum gespielt hatte. Ich mache es wieder rein", "author": "thoniTUB", "createdAt": "2020-12-03T09:48:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDg5ODk0OA=="}], "type": "inlineReview", "revised_code": {"commit": "74cba01010fee162c22ab0f4950ba97d552459bc", "chunk": "diff --git a/backend/src/main/java/com/bakdata/conquery/io/xodus/stores/CachedStore.java b/backend/src/main/java/com/bakdata/conquery/io/xodus/stores/CachedStore.java\nindex 427a3f70e..3b03a46e2 100644\n--- a/backend/src/main/java/com/bakdata/conquery/io/xodus/stores/CachedStore.java\n+++ b/backend/src/main/java/com/bakdata/conquery/io/xodus/stores/CachedStore.java\n\n@@ -32,6 +32,7 @@ public class CachedStore<KEY, VALUE> implements Store<KEY, VALUE> {\n \n \t@Override\n \tpublic VALUE get(KEY key) {\n+\t\t// TODO: 08.01.2020 fk: This assumes that all values have been read at some point!\n \t\treturn cache.get(key);\n \t}\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDkwMzU4Ng==", "url": "https://github.com/bakdata/conquery/pull/1467#discussion_r534903586", "bodyText": "der Name ist falsch; du kannst damit ja alles vergleichen?", "author": "awildturtok", "createdAt": "2020-12-03T08:24:43Z", "path": "backend/src/main/java/com/bakdata/conquery/models/messages/namespaces/specific/ReportConsistency.java", "diffHunk": "@@ -0,0 +1,78 @@\n+package com.bakdata.conquery.models.messages.namespaces.specific;\n+\n+import com.bakdata.conquery.io.cps.CPSType;\n+import com.bakdata.conquery.models.datasets.Import;\n+import com.bakdata.conquery.models.identifiable.ids.IId;\n+import com.bakdata.conquery.models.identifiable.ids.specific.BucketId;\n+import com.bakdata.conquery.models.identifiable.ids.specific.ImportId;\n+import com.bakdata.conquery.models.identifiable.ids.specific.WorkerId;\n+import com.bakdata.conquery.models.messages.namespaces.NamespaceMessage;\n+import com.bakdata.conquery.models.messages.namespaces.NamespacedMessage;\n+import com.bakdata.conquery.models.worker.Namespace;\n+import com.google.common.collect.Sets;\n+import lombok.*;\n+import lombok.extern.slf4j.Slf4j;\n+\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * Compares the the ids of imports and buckets of a {@link com.bakdata.conquery.models.worker.Worker} with the those\n+ * the {@link com.bakdata.conquery.commands.ManagerNode} assumed the Worker to have and reports an error if there are\n+ * inconsistencies.\n+ */\n+@CPSType(id=\"REPORT_CONSISTENCY\", base= NamespacedMessage.class)\n+@AllArgsConstructor\n+@NoArgsConstructor\n+@Setter\n+@Getter\n+@Slf4j\n+public class ReportConsistency extends NamespaceMessage {\n+\n+    private WorkerId workerId;\n+    // Set default here because an empty set send by the worker is not set (it is null) after deserialization\n+    private Set<ImportId> workerImports = Set.of();\n+    private Set<BucketId> workerBuckets = Set.of();\n+\n+\n+    @Override\n+    public void react(Namespace context) throws Exception {\n+        Set<ImportId> managerImports = context.getStorage().getAllImports().stream().map(Import::getId).collect(Collectors.toSet());\n+\n+        Set<BucketId> assignedWorkerBuckets = context.getBucketsForWorker(workerId);\n+\n+        boolean importsOkay = isImportsConsistent(\"Imports\", managerImports, workerImports, workerId);\n+        boolean bucketsOkay = isImportsConsistent(\"Buckets\", assignedWorkerBuckets, workerBuckets, workerId);\n+\n+        log.trace(\"Imports on worker[{}}: {}\", workerId, workerImports);\n+        log.trace(\"Buckets on worker[{}}: {}\", workerId, workerBuckets);\n+\n+        if (importsOkay && bucketsOkay) {\n+            log.info(\"Consistency check was successful\");\n+            return;\n+        }\n+        throw new IllegalStateException(\"Detected inconsistency between manager and worker [\" + workerId + \"]\");\n+    }\n+\n+    private static <ID extends IId<?>> boolean isImportsConsistent(String typeName, @NonNull Set<ID> managerIds, @NonNull Set<ID> workerIds, WorkerId workerId) {", "originalCommit": "c4ab28ec806a8e7300f1d5e2dee85552e5b83e3a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTAyNTUyOQ==", "url": "https://github.com/bakdata/conquery/pull/1467#discussion_r535025529", "bodyText": "Ah danke, hatte es erst speziell f\u00fcr imports gemacht", "author": "thoniTUB", "createdAt": "2020-12-03T09:50:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDkwMzU4Ng=="}], "type": "inlineReview", "revised_code": {"commit": "74cba01010fee162c22ab0f4950ba97d552459bc", "chunk": "diff --git a/backend/src/main/java/com/bakdata/conquery/models/messages/namespaces/specific/ReportConsistency.java b/backend/src/main/java/com/bakdata/conquery/models/messages/namespaces/specific/ReportConsistency.java\ndeleted file mode 100644\nindex ca87bd0e4..000000000\n--- a/backend/src/main/java/com/bakdata/conquery/models/messages/namespaces/specific/ReportConsistency.java\n+++ /dev/null\n\n@@ -1,78 +0,0 @@\n-package com.bakdata.conquery.models.messages.namespaces.specific;\n-\n-import com.bakdata.conquery.io.cps.CPSType;\n-import com.bakdata.conquery.models.datasets.Import;\n-import com.bakdata.conquery.models.identifiable.ids.IId;\n-import com.bakdata.conquery.models.identifiable.ids.specific.BucketId;\n-import com.bakdata.conquery.models.identifiable.ids.specific.ImportId;\n-import com.bakdata.conquery.models.identifiable.ids.specific.WorkerId;\n-import com.bakdata.conquery.models.messages.namespaces.NamespaceMessage;\n-import com.bakdata.conquery.models.messages.namespaces.NamespacedMessage;\n-import com.bakdata.conquery.models.worker.Namespace;\n-import com.google.common.collect.Sets;\n-import lombok.*;\n-import lombok.extern.slf4j.Slf4j;\n-\n-import java.util.Set;\n-import java.util.stream.Collectors;\n-\n-/**\n- * Compares the the ids of imports and buckets of a {@link com.bakdata.conquery.models.worker.Worker} with the those\n- * the {@link com.bakdata.conquery.commands.ManagerNode} assumed the Worker to have and reports an error if there are\n- * inconsistencies.\n- */\n-@CPSType(id=\"REPORT_CONSISTENCY\", base= NamespacedMessage.class)\n-@AllArgsConstructor\n-@NoArgsConstructor\n-@Setter\n-@Getter\n-@Slf4j\n-public class ReportConsistency extends NamespaceMessage {\n-\n-    private WorkerId workerId;\n-    // Set default here because an empty set send by the worker is not set (it is null) after deserialization\n-    private Set<ImportId> workerImports = Set.of();\n-    private Set<BucketId> workerBuckets = Set.of();\n-\n-\n-    @Override\n-    public void react(Namespace context) throws Exception {\n-        Set<ImportId> managerImports = context.getStorage().getAllImports().stream().map(Import::getId).collect(Collectors.toSet());\n-\n-        Set<BucketId> assignedWorkerBuckets = context.getBucketsForWorker(workerId);\n-\n-        boolean importsOkay = isImportsConsistent(\"Imports\", managerImports, workerImports, workerId);\n-        boolean bucketsOkay = isImportsConsistent(\"Buckets\", assignedWorkerBuckets, workerBuckets, workerId);\n-\n-        log.trace(\"Imports on worker[{}}: {}\", workerId, workerImports);\n-        log.trace(\"Buckets on worker[{}}: {}\", workerId, workerBuckets);\n-\n-        if (importsOkay && bucketsOkay) {\n-            log.info(\"Consistency check was successful\");\n-            return;\n-        }\n-        throw new IllegalStateException(\"Detected inconsistency between manager and worker [\" + workerId + \"]\");\n-    }\n-\n-    private static <ID extends IId<?>> boolean isImportsConsistent(String typeName, @NonNull Set<ID> managerIds, @NonNull Set<ID> workerIds, WorkerId workerId) {\n-        Sets.SetView<ID> notInWorker = Sets.difference(managerIds, workerIds);\n-        Sets.SetView<ID> notInManager = Sets.difference(workerIds, managerIds);\n-\n-        if (notInWorker.isEmpty() && notInManager.isEmpty()) {\n-            log.info(\"{} of worker {} are consistent with the imports of the manager.\", typeName, workerId);\n-            return true;\n-        }\n-\n-        StringBuilder sb = new StringBuilder();\n-        sb.append(\"Found inconsistencies for\").append(typeName).append(\":\\n\");\n-        for( ID difference : notInWorker) {\n-            sb.append(\"\\t[\").append(difference).append(\"] is not present on the worker but on the manager [\").append(workerId).append(\"].\\n\");\n-        }\n-        for( ID difference : notInManager) {\n-            sb.append(\"\\t[\").append(difference).append(\"] is not present on the manager but on the worker [\").append(workerId).append(\"].\\n\");\n-        }\n-\n-        log.error(sb.toString());\n-        return false;\n-    }\n-}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDkwNTI5NA==", "url": "https://github.com/bakdata/conquery/pull/1467#discussion_r534905294", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    sb.append(\"Found inconsistencies for\").append(typeName).append(\":\\n\");\n          \n          \n            \n                    sb.append(\"Found inconsistencies for \").append(typeName).append(\":\\n\");", "author": "awildturtok", "createdAt": "2020-12-03T08:25:39Z", "path": "backend/src/main/java/com/bakdata/conquery/models/messages/namespaces/specific/ReportConsistency.java", "diffHunk": "@@ -0,0 +1,78 @@\n+package com.bakdata.conquery.models.messages.namespaces.specific;\n+\n+import com.bakdata.conquery.io.cps.CPSType;\n+import com.bakdata.conquery.models.datasets.Import;\n+import com.bakdata.conquery.models.identifiable.ids.IId;\n+import com.bakdata.conquery.models.identifiable.ids.specific.BucketId;\n+import com.bakdata.conquery.models.identifiable.ids.specific.ImportId;\n+import com.bakdata.conquery.models.identifiable.ids.specific.WorkerId;\n+import com.bakdata.conquery.models.messages.namespaces.NamespaceMessage;\n+import com.bakdata.conquery.models.messages.namespaces.NamespacedMessage;\n+import com.bakdata.conquery.models.worker.Namespace;\n+import com.google.common.collect.Sets;\n+import lombok.*;\n+import lombok.extern.slf4j.Slf4j;\n+\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * Compares the the ids of imports and buckets of a {@link com.bakdata.conquery.models.worker.Worker} with the those\n+ * the {@link com.bakdata.conquery.commands.ManagerNode} assumed the Worker to have and reports an error if there are\n+ * inconsistencies.\n+ */\n+@CPSType(id=\"REPORT_CONSISTENCY\", base= NamespacedMessage.class)\n+@AllArgsConstructor\n+@NoArgsConstructor\n+@Setter\n+@Getter\n+@Slf4j\n+public class ReportConsistency extends NamespaceMessage {\n+\n+    private WorkerId workerId;\n+    // Set default here because an empty set send by the worker is not set (it is null) after deserialization\n+    private Set<ImportId> workerImports = Set.of();\n+    private Set<BucketId> workerBuckets = Set.of();\n+\n+\n+    @Override\n+    public void react(Namespace context) throws Exception {\n+        Set<ImportId> managerImports = context.getStorage().getAllImports().stream().map(Import::getId).collect(Collectors.toSet());\n+\n+        Set<BucketId> assignedWorkerBuckets = context.getBucketsForWorker(workerId);\n+\n+        boolean importsOkay = isImportsConsistent(\"Imports\", managerImports, workerImports, workerId);\n+        boolean bucketsOkay = isImportsConsistent(\"Buckets\", assignedWorkerBuckets, workerBuckets, workerId);\n+\n+        log.trace(\"Imports on worker[{}}: {}\", workerId, workerImports);\n+        log.trace(\"Buckets on worker[{}}: {}\", workerId, workerBuckets);\n+\n+        if (importsOkay && bucketsOkay) {\n+            log.info(\"Consistency check was successful\");\n+            return;\n+        }\n+        throw new IllegalStateException(\"Detected inconsistency between manager and worker [\" + workerId + \"]\");\n+    }\n+\n+    private static <ID extends IId<?>> boolean isImportsConsistent(String typeName, @NonNull Set<ID> managerIds, @NonNull Set<ID> workerIds, WorkerId workerId) {\n+        Sets.SetView<ID> notInWorker = Sets.difference(managerIds, workerIds);\n+        Sets.SetView<ID> notInManager = Sets.difference(workerIds, managerIds);\n+\n+        if (notInWorker.isEmpty() && notInManager.isEmpty()) {\n+            log.info(\"{} of worker {} are consistent with the imports of the manager.\", typeName, workerId);\n+            return true;\n+        }\n+\n+        StringBuilder sb = new StringBuilder();\n+        sb.append(\"Found inconsistencies for\").append(typeName).append(\":\\n\");", "originalCommit": "c4ab28ec806a8e7300f1d5e2dee85552e5b83e3a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "74cba01010fee162c22ab0f4950ba97d552459bc", "chunk": "diff --git a/backend/src/main/java/com/bakdata/conquery/models/messages/namespaces/specific/ReportConsistency.java b/backend/src/main/java/com/bakdata/conquery/models/messages/namespaces/specific/ReportConsistency.java\ndeleted file mode 100644\nindex ca87bd0e4..000000000\n--- a/backend/src/main/java/com/bakdata/conquery/models/messages/namespaces/specific/ReportConsistency.java\n+++ /dev/null\n\n@@ -1,78 +0,0 @@\n-package com.bakdata.conquery.models.messages.namespaces.specific;\n-\n-import com.bakdata.conquery.io.cps.CPSType;\n-import com.bakdata.conquery.models.datasets.Import;\n-import com.bakdata.conquery.models.identifiable.ids.IId;\n-import com.bakdata.conquery.models.identifiable.ids.specific.BucketId;\n-import com.bakdata.conquery.models.identifiable.ids.specific.ImportId;\n-import com.bakdata.conquery.models.identifiable.ids.specific.WorkerId;\n-import com.bakdata.conquery.models.messages.namespaces.NamespaceMessage;\n-import com.bakdata.conquery.models.messages.namespaces.NamespacedMessage;\n-import com.bakdata.conquery.models.worker.Namespace;\n-import com.google.common.collect.Sets;\n-import lombok.*;\n-import lombok.extern.slf4j.Slf4j;\n-\n-import java.util.Set;\n-import java.util.stream.Collectors;\n-\n-/**\n- * Compares the the ids of imports and buckets of a {@link com.bakdata.conquery.models.worker.Worker} with the those\n- * the {@link com.bakdata.conquery.commands.ManagerNode} assumed the Worker to have and reports an error if there are\n- * inconsistencies.\n- */\n-@CPSType(id=\"REPORT_CONSISTENCY\", base= NamespacedMessage.class)\n-@AllArgsConstructor\n-@NoArgsConstructor\n-@Setter\n-@Getter\n-@Slf4j\n-public class ReportConsistency extends NamespaceMessage {\n-\n-    private WorkerId workerId;\n-    // Set default here because an empty set send by the worker is not set (it is null) after deserialization\n-    private Set<ImportId> workerImports = Set.of();\n-    private Set<BucketId> workerBuckets = Set.of();\n-\n-\n-    @Override\n-    public void react(Namespace context) throws Exception {\n-        Set<ImportId> managerImports = context.getStorage().getAllImports().stream().map(Import::getId).collect(Collectors.toSet());\n-\n-        Set<BucketId> assignedWorkerBuckets = context.getBucketsForWorker(workerId);\n-\n-        boolean importsOkay = isImportsConsistent(\"Imports\", managerImports, workerImports, workerId);\n-        boolean bucketsOkay = isImportsConsistent(\"Buckets\", assignedWorkerBuckets, workerBuckets, workerId);\n-\n-        log.trace(\"Imports on worker[{}}: {}\", workerId, workerImports);\n-        log.trace(\"Buckets on worker[{}}: {}\", workerId, workerBuckets);\n-\n-        if (importsOkay && bucketsOkay) {\n-            log.info(\"Consistency check was successful\");\n-            return;\n-        }\n-        throw new IllegalStateException(\"Detected inconsistency between manager and worker [\" + workerId + \"]\");\n-    }\n-\n-    private static <ID extends IId<?>> boolean isImportsConsistent(String typeName, @NonNull Set<ID> managerIds, @NonNull Set<ID> workerIds, WorkerId workerId) {\n-        Sets.SetView<ID> notInWorker = Sets.difference(managerIds, workerIds);\n-        Sets.SetView<ID> notInManager = Sets.difference(workerIds, managerIds);\n-\n-        if (notInWorker.isEmpty() && notInManager.isEmpty()) {\n-            log.info(\"{} of worker {} are consistent with the imports of the manager.\", typeName, workerId);\n-            return true;\n-        }\n-\n-        StringBuilder sb = new StringBuilder();\n-        sb.append(\"Found inconsistencies for\").append(typeName).append(\":\\n\");\n-        for( ID difference : notInWorker) {\n-            sb.append(\"\\t[\").append(difference).append(\"] is not present on the worker but on the manager [\").append(workerId).append(\"].\\n\");\n-        }\n-        for( ID difference : notInManager) {\n-            sb.append(\"\\t[\").append(difference).append(\"] is not present on the manager but on the worker [\").append(workerId).append(\"].\\n\");\n-        }\n-\n-        log.error(sb.toString());\n-        return false;\n-    }\n-}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDkwODAwMA==", "url": "https://github.com/bakdata/conquery/pull/1467#discussion_r534908000", "bodyText": "Ich wei\u00df, dass du das bevorzugst StringBuilder zu benutzen, und dann auf einmal zu loggen, das Problem ist dann aber, dass nicht alle Zeilen prependet sind mit ERROR, was ich sehr praktisch finde in less / grep", "author": "awildturtok", "createdAt": "2020-12-03T08:27:07Z", "path": "backend/src/main/java/com/bakdata/conquery/models/messages/namespaces/specific/ReportConsistency.java", "diffHunk": "@@ -0,0 +1,78 @@\n+package com.bakdata.conquery.models.messages.namespaces.specific;\n+\n+import com.bakdata.conquery.io.cps.CPSType;\n+import com.bakdata.conquery.models.datasets.Import;\n+import com.bakdata.conquery.models.identifiable.ids.IId;\n+import com.bakdata.conquery.models.identifiable.ids.specific.BucketId;\n+import com.bakdata.conquery.models.identifiable.ids.specific.ImportId;\n+import com.bakdata.conquery.models.identifiable.ids.specific.WorkerId;\n+import com.bakdata.conquery.models.messages.namespaces.NamespaceMessage;\n+import com.bakdata.conquery.models.messages.namespaces.NamespacedMessage;\n+import com.bakdata.conquery.models.worker.Namespace;\n+import com.google.common.collect.Sets;\n+import lombok.*;\n+import lombok.extern.slf4j.Slf4j;\n+\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * Compares the the ids of imports and buckets of a {@link com.bakdata.conquery.models.worker.Worker} with the those\n+ * the {@link com.bakdata.conquery.commands.ManagerNode} assumed the Worker to have and reports an error if there are\n+ * inconsistencies.\n+ */\n+@CPSType(id=\"REPORT_CONSISTENCY\", base= NamespacedMessage.class)\n+@AllArgsConstructor\n+@NoArgsConstructor\n+@Setter\n+@Getter\n+@Slf4j\n+public class ReportConsistency extends NamespaceMessage {\n+\n+    private WorkerId workerId;\n+    // Set default here because an empty set send by the worker is not set (it is null) after deserialization\n+    private Set<ImportId> workerImports = Set.of();\n+    private Set<BucketId> workerBuckets = Set.of();\n+\n+\n+    @Override\n+    public void react(Namespace context) throws Exception {\n+        Set<ImportId> managerImports = context.getStorage().getAllImports().stream().map(Import::getId).collect(Collectors.toSet());\n+\n+        Set<BucketId> assignedWorkerBuckets = context.getBucketsForWorker(workerId);\n+\n+        boolean importsOkay = isImportsConsistent(\"Imports\", managerImports, workerImports, workerId);\n+        boolean bucketsOkay = isImportsConsistent(\"Buckets\", assignedWorkerBuckets, workerBuckets, workerId);\n+\n+        log.trace(\"Imports on worker[{}}: {}\", workerId, workerImports);\n+        log.trace(\"Buckets on worker[{}}: {}\", workerId, workerBuckets);\n+\n+        if (importsOkay && bucketsOkay) {\n+            log.info(\"Consistency check was successful\");\n+            return;\n+        }\n+        throw new IllegalStateException(\"Detected inconsistency between manager and worker [\" + workerId + \"]\");\n+    }\n+\n+    private static <ID extends IId<?>> boolean isImportsConsistent(String typeName, @NonNull Set<ID> managerIds, @NonNull Set<ID> workerIds, WorkerId workerId) {\n+        Sets.SetView<ID> notInWorker = Sets.difference(managerIds, workerIds);\n+        Sets.SetView<ID> notInManager = Sets.difference(workerIds, managerIds);\n+\n+        if (notInWorker.isEmpty() && notInManager.isEmpty()) {\n+            log.info(\"{} of worker {} are consistent with the imports of the manager.\", typeName, workerId);\n+            return true;\n+        }\n+\n+        StringBuilder sb = new StringBuilder();\n+        sb.append(\"Found inconsistencies for\").append(typeName).append(\":\\n\");\n+        for( ID difference : notInWorker) {\n+            sb.append(\"\\t[\").append(difference).append(\"] is not present on the worker but on the manager [\").append(workerId).append(\"].\\n\");\n+        }\n+        for( ID difference : notInManager) {\n+            sb.append(\"\\t[\").append(difference).append(\"] is not present on the manager but on the worker [\").append(workerId).append(\"].\\n\");\n+        }\n+\n+        log.error(sb.toString());", "originalCommit": "c4ab28ec806a8e7300f1d5e2dee85552e5b83e3a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTAzMDkxNQ==", "url": "https://github.com/bakdata/conquery/pull/1467#discussion_r535030915", "bodyText": "Kann ich verstehen. Da das aber als report gedacht ist m\u00f6chte ich alles an einem Platz haben um nicht zu \u00fcbersehen", "author": "thoniTUB", "createdAt": "2020-12-03T09:54:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDkwODAwMA=="}], "type": "inlineReview", "revised_code": {"commit": "74cba01010fee162c22ab0f4950ba97d552459bc", "chunk": "diff --git a/backend/src/main/java/com/bakdata/conquery/models/messages/namespaces/specific/ReportConsistency.java b/backend/src/main/java/com/bakdata/conquery/models/messages/namespaces/specific/ReportConsistency.java\ndeleted file mode 100644\nindex ca87bd0e4..000000000\n--- a/backend/src/main/java/com/bakdata/conquery/models/messages/namespaces/specific/ReportConsistency.java\n+++ /dev/null\n\n@@ -1,78 +0,0 @@\n-package com.bakdata.conquery.models.messages.namespaces.specific;\n-\n-import com.bakdata.conquery.io.cps.CPSType;\n-import com.bakdata.conquery.models.datasets.Import;\n-import com.bakdata.conquery.models.identifiable.ids.IId;\n-import com.bakdata.conquery.models.identifiable.ids.specific.BucketId;\n-import com.bakdata.conquery.models.identifiable.ids.specific.ImportId;\n-import com.bakdata.conquery.models.identifiable.ids.specific.WorkerId;\n-import com.bakdata.conquery.models.messages.namespaces.NamespaceMessage;\n-import com.bakdata.conquery.models.messages.namespaces.NamespacedMessage;\n-import com.bakdata.conquery.models.worker.Namespace;\n-import com.google.common.collect.Sets;\n-import lombok.*;\n-import lombok.extern.slf4j.Slf4j;\n-\n-import java.util.Set;\n-import java.util.stream.Collectors;\n-\n-/**\n- * Compares the the ids of imports and buckets of a {@link com.bakdata.conquery.models.worker.Worker} with the those\n- * the {@link com.bakdata.conquery.commands.ManagerNode} assumed the Worker to have and reports an error if there are\n- * inconsistencies.\n- */\n-@CPSType(id=\"REPORT_CONSISTENCY\", base= NamespacedMessage.class)\n-@AllArgsConstructor\n-@NoArgsConstructor\n-@Setter\n-@Getter\n-@Slf4j\n-public class ReportConsistency extends NamespaceMessage {\n-\n-    private WorkerId workerId;\n-    // Set default here because an empty set send by the worker is not set (it is null) after deserialization\n-    private Set<ImportId> workerImports = Set.of();\n-    private Set<BucketId> workerBuckets = Set.of();\n-\n-\n-    @Override\n-    public void react(Namespace context) throws Exception {\n-        Set<ImportId> managerImports = context.getStorage().getAllImports().stream().map(Import::getId).collect(Collectors.toSet());\n-\n-        Set<BucketId> assignedWorkerBuckets = context.getBucketsForWorker(workerId);\n-\n-        boolean importsOkay = isImportsConsistent(\"Imports\", managerImports, workerImports, workerId);\n-        boolean bucketsOkay = isImportsConsistent(\"Buckets\", assignedWorkerBuckets, workerBuckets, workerId);\n-\n-        log.trace(\"Imports on worker[{}}: {}\", workerId, workerImports);\n-        log.trace(\"Buckets on worker[{}}: {}\", workerId, workerBuckets);\n-\n-        if (importsOkay && bucketsOkay) {\n-            log.info(\"Consistency check was successful\");\n-            return;\n-        }\n-        throw new IllegalStateException(\"Detected inconsistency between manager and worker [\" + workerId + \"]\");\n-    }\n-\n-    private static <ID extends IId<?>> boolean isImportsConsistent(String typeName, @NonNull Set<ID> managerIds, @NonNull Set<ID> workerIds, WorkerId workerId) {\n-        Sets.SetView<ID> notInWorker = Sets.difference(managerIds, workerIds);\n-        Sets.SetView<ID> notInManager = Sets.difference(workerIds, managerIds);\n-\n-        if (notInWorker.isEmpty() && notInManager.isEmpty()) {\n-            log.info(\"{} of worker {} are consistent with the imports of the manager.\", typeName, workerId);\n-            return true;\n-        }\n-\n-        StringBuilder sb = new StringBuilder();\n-        sb.append(\"Found inconsistencies for\").append(typeName).append(\":\\n\");\n-        for( ID difference : notInWorker) {\n-            sb.append(\"\\t[\").append(difference).append(\"] is not present on the worker but on the manager [\").append(workerId).append(\"].\\n\");\n-        }\n-        for( ID difference : notInManager) {\n-            sb.append(\"\\t[\").append(difference).append(\"] is not present on the manager but on the worker [\").append(workerId).append(\"].\\n\");\n-        }\n-\n-        log.error(sb.toString());\n-        return false;\n-    }\n-}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDkxMzAyMw==", "url": "https://github.com/bakdata/conquery/pull/1467#discussion_r534913023", "bodyText": "Kannst du einen Task machen, der das hier abschickt? Dann kann man das von au\u00dfen steuern", "author": "awildturtok", "createdAt": "2020-12-03T08:29:53Z", "path": "backend/src/main/java/com/bakdata/conquery/models/messages/network/specific/RegisterWorker.java", "diffHunk": "@@ -37,6 +38,9 @@ public void react(ManagerNodeNetworkContext context) throws Exception {\n \n \t\tinfo.setConnectedShardNode(node);\n \t\tcontext.getNamespaces().register(node, info);\n+\n+\t\t// Request consistency report\n+\t\tcontext.getNamespaces().getWorkers().get(info.getId()).send(new RequestConsistency());", "originalCommit": "c4ab28ec806a8e7300f1d5e2dee85552e5b83e3a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDkyMjI4Mw==", "url": "https://github.com/bakdata/conquery/pull/1467#discussion_r534922283", "bodyText": "ahja", "author": "awildturtok", "createdAt": "2020-12-03T08:35:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDkxMzAyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDkyMjQyNA==", "url": "https://github.com/bakdata/conquery/pull/1467#discussion_r534922424", "bodyText": "see below", "author": "awildturtok", "createdAt": "2020-12-03T08:35:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDkxMzAyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTAyOTAwMQ==", "url": "https://github.com/bakdata/conquery/pull/1467#discussion_r535029001", "bodyText": "Den Task gibt es schon", "author": "thoniTUB", "createdAt": "2020-12-03T09:53:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDkxMzAyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTAzNjg2MQ==", "url": "https://github.com/bakdata/conquery/pull/1467#discussion_r535036861", "bodyText": "backend/src/main/java/com/bakdata/conquery/tasks/ReportConsistencyTask.java", "author": "thoniTUB", "createdAt": "2020-12-03T09:59:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDkxMzAyMw=="}], "type": "inlineReview", "revised_code": {"commit": "74cba01010fee162c22ab0f4950ba97d552459bc", "chunk": "diff --git a/backend/src/main/java/com/bakdata/conquery/models/messages/network/specific/RegisterWorker.java b/backend/src/main/java/com/bakdata/conquery/models/messages/network/specific/RegisterWorker.java\nindex c3b1ed490..90f979c35 100644\n--- a/backend/src/main/java/com/bakdata/conquery/models/messages/network/specific/RegisterWorker.java\n+++ b/backend/src/main/java/com/bakdata/conquery/models/messages/network/specific/RegisterWorker.java\n\n@@ -38,9 +37,6 @@ public class RegisterWorker extends MessageToManagerNode {\n \n \t\tinfo.setConnectedShardNode(node);\n \t\tcontext.getNamespaces().register(node, info);\n-\n-\t\t// Request consistency report\n-\t\tcontext.getNamespaces().getWorkers().get(info.getId()).send(new RequestConsistency());\n \t}\n \n \t/**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDkyMTM1Nw==", "url": "https://github.com/bakdata/conquery/pull/1467#discussion_r534921357", "bodyText": "wenn du einen AllArgsConstructor machst, brauchst du den Setter nicht", "author": "awildturtok", "createdAt": "2020-12-03T08:34:47Z", "path": "backend/src/main/java/com/bakdata/conquery/models/worker/WorkerToBucketsMap.java", "diffHunk": "@@ -0,0 +1,28 @@\n+package com.bakdata.conquery.models.worker;\n+\n+import com.bakdata.conquery.models.identifiable.ids.specific.BucketId;\n+import com.bakdata.conquery.models.identifiable.ids.specific.WorkerId;\n+import lombok.AccessLevel;\n+import lombok.Getter;\n+import lombok.NonNull;\n+import lombok.Setter;\n+\n+import java.util.*;\n+\n+@Getter\n+@Setter\n+public class WorkerToBucketsMap {\n+    private Map<WorkerId, Set<BucketId>> map = new HashMap<>();", "originalCommit": "c4ab28ec806a8e7300f1d5e2dee85552e5b83e3a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDkyMTgwNg==", "url": "https://github.com/bakdata/conquery/pull/1467#discussion_r534921806", "bodyText": "Und der Getter k\u00f6nnte auch komisch sein?", "author": "awildturtok", "createdAt": "2020-12-03T08:35:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDkyMTM1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTAzNTEyNg==", "url": "https://github.com/bakdata/conquery/pull/1467#discussion_r535035126", "bodyText": "Okay ich habe es annotiert:\n@AllArgsConstructor(onConstructor = @__({@JsonCreator}))\n@NoArgsConstructor\n@Getter", "author": "thoniTUB", "createdAt": "2020-12-03T09:58:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDkyMTM1Nw=="}], "type": "inlineReview", "revised_code": {"commit": "74cba01010fee162c22ab0f4950ba97d552459bc", "chunk": "diff --git a/backend/src/main/java/com/bakdata/conquery/models/worker/WorkerToBucketsMap.java b/backend/src/main/java/com/bakdata/conquery/models/worker/WorkerToBucketsMap.java\ndeleted file mode 100644\nindex 7d6b89d10..000000000\n--- a/backend/src/main/java/com/bakdata/conquery/models/worker/WorkerToBucketsMap.java\n+++ /dev/null\n\n@@ -1,28 +0,0 @@\n-package com.bakdata.conquery.models.worker;\n-\n-import com.bakdata.conquery.models.identifiable.ids.specific.BucketId;\n-import com.bakdata.conquery.models.identifiable.ids.specific.WorkerId;\n-import lombok.AccessLevel;\n-import lombok.Getter;\n-import lombok.NonNull;\n-import lombok.Setter;\n-\n-import java.util.*;\n-\n-@Getter\n-@Setter\n-public class WorkerToBucketsMap {\n-    private Map<WorkerId, Set<BucketId>> map = new HashMap<>();\n-\n-    public Set<BucketId> getBucketsForWorker(WorkerId workerId) {\n-        Set<BucketId> buckets = map.get(workerId);\n-        if (buckets != null) {\n-            return buckets;\n-        }\n-        return Collections.emptySet();\n-    }\n-\n-    public synchronized void addBucketForWorker(@NonNull WorkerId id, @NonNull Set<BucketId> bucketIds) {\n-        map.computeIfAbsent(id, k -> new HashSet<>()).addAll(bucketIds);\n-    }\n-}\n"}}, {"oid": "74cba01010fee162c22ab0f4950ba97d552459bc", "url": "https://github.com/bakdata/conquery/commit/74cba01010fee162c22ab0f4950ba97d552459bc", "message": "wip consistency messages", "committedDate": "2020-12-03T09:03:31Z", "type": "commit"}, {"oid": "b7bbd32e021964355ec35bfd26ce0eea7e97ebbb", "url": "https://github.com/bakdata/conquery/commit/b7bbd32e021964355ec35bfd26ce0eea7e97ebbb", "message": "check import consistency", "committedDate": "2020-12-03T09:03:31Z", "type": "commit"}, {"oid": "a9e5111bd08664fe532d40872691fa8dd2445d8a", "url": "https://github.com/bakdata/conquery/commit/a9e5111bd08664fe532d40872691fa8dd2445d8a", "message": "adds task for consistency report", "committedDate": "2020-12-03T09:03:32Z", "type": "commit"}, {"oid": "ae7556c119b0334c1a653db806a817f7b788b2d7", "url": "https://github.com/bakdata/conquery/commit/ae7556c119b0334c1a653db806a817f7b788b2d7", "message": "gather bucket ids", "committedDate": "2020-12-03T09:03:33Z", "type": "commit"}, {"oid": "b8dd974372acc30bfb22e0483c8c2ce9ef7bd3b4", "url": "https://github.com/bakdata/conquery/commit/b8dd974372acc30bfb22e0483c8c2ce9ef7bd3b4", "message": "adds consistency check for buckets", "committedDate": "2020-12-03T09:03:35Z", "type": "commit"}, {"oid": "3265e348b33b4dcf9b9b3e94b64b5f1af47efc0a", "url": "https://github.com/bakdata/conquery/commit/3265e348b33b4dcf9b9b3e94b64b5f1af47efc0a", "message": "fix NPE", "committedDate": "2020-12-03T09:03:35Z", "type": "commit"}, {"oid": "89887e2bc76fa34e543ea7d68ec30b52507561b6", "url": "https://github.com/bakdata/conquery/commit/89887e2bc76fa34e543ea7d68ec30b52507561b6", "message": "fix typo", "committedDate": "2020-12-03T09:03:36Z", "type": "commit"}, {"oid": "e90547a52b77092a76151fdef47227fb1285efbe", "url": "https://github.com/bakdata/conquery/commit/e90547a52b77092a76151fdef47227fb1285efbe", "message": "changed store type for worker to buckets map.", "committedDate": "2020-12-03T09:03:37Z", "type": "commit"}, {"oid": "820b17766447b1babc09b1b3f32cb8a9da300153", "url": "https://github.com/bakdata/conquery/commit/820b17766447b1babc09b1b3f32cb8a9da300153", "message": "adds missing flag check for buckets", "committedDate": "2020-12-03T09:03:39Z", "type": "commit"}, {"oid": "da228f8d49d8e29d941177e57f475e0677ce366a", "url": "https://github.com/bakdata/conquery/commit/da228f8d49d8e29d941177e57f475e0677ce366a", "message": "adds doku", "committedDate": "2020-12-03T09:03:42Z", "type": "commit"}, {"oid": "e27f861eca5f053f21c8a8ab2a75f7d7636667ae", "url": "https://github.com/bakdata/conquery/commit/e27f861eca5f053f21c8a8ab2a75f7d7636667ae", "message": "adds import remove logic to consistency report", "committedDate": "2020-12-03T09:03:46Z", "type": "commit"}, {"oid": "e27f861eca5f053f21c8a8ab2a75f7d7636667ae", "url": "https://github.com/bakdata/conquery/commit/e27f861eca5f053f21c8a8ab2a75f7d7636667ae", "message": "adds import remove logic to consistency report", "committedDate": "2020-12-03T09:03:46Z", "type": "forcePushed"}, {"oid": "5fea4207c0e3c9c8d3add9f97433329e10373a5f", "url": "https://github.com/bakdata/conquery/commit/5fea4207c0e3c9c8d3add9f97433329e10373a5f", "message": "review changes", "committedDate": "2020-12-03T10:08:36Z", "type": "commit"}]}