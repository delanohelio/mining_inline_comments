{"pr_number": 1394, "pr_title": "Feature/index for buckets", "pr_createdAt": "2020-10-15T16:14:23Z", "pr_url": "https://github.com/bakdata/conquery/pull/1394", "timeline": [{"oid": "1cb376f44e27e64d669f8eed67314ae35609a38d", "url": "https://github.com/bakdata/conquery/commit/1cb376f44e27e64d669f8eed67314ae35609a38d", "message": "Maintain index for Buckets", "committedDate": "2020-10-15T14:32:31Z", "type": "commit"}, {"oid": "18107137267836c118d66692c6e34c88b1d76f9f", "url": "https://github.com/bakdata/conquery/commit/18107137267836c118d66692c6e34c88b1d76f9f", "message": "cleanup datastructures", "committedDate": "2020-10-15T15:43:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzY4MDUwOQ==", "url": "https://github.com/bakdata/conquery/pull/1394#discussion_r507680509", "bodyText": "Map Map List. HolyMoly.\nIch w\u00fcrde es eher tableToBuckets nennen, damit es klarer ist, was hier gemappt wird", "author": "thoniTUB", "createdAt": "2020-10-19T11:44:23Z", "path": "backend/src/main/java/com/bakdata/conquery/models/events/BucketManager.java", "diffHunk": "@@ -58,11 +59,19 @@\n \t * Connector -> Bucket -> [CBlock]\n \t */\n \tprivate final Map<ConnectorId, Int2ObjectMap<List<CBlock>>> connectorCBlocks;\n-\t\n+\n+\t/**\n+\t * Table -> BucketN -> [Buckets]\n+\t */\n+\tprivate final Map<TableId, Int2ObjectMap<List<Bucket>>> bucketTables;\n+\n \tpublic static BucketManager create(Worker worker, WorkerStorage storage) {\n \t\tInt2ObjectMap<Entity> entities = new Int2ObjectAVLTreeMap<>();\n \t\tMap<ConnectorId, Int2ObjectMap<List<CBlock>>> connectorCBlocks = new HashMap<>(150);\n-\t\t\n+\t\tMap<TableId, Int2ObjectMap<List<Bucket>>> bucketTables = new HashMap<>();", "originalCommit": "18107137267836c118d66692c6e34c88b1d76f9f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzY4NTExNw==", "url": "https://github.com/bakdata/conquery/pull/1394#discussion_r507685117", "bodyText": "connectorCBlocks auch im Namen angleichen", "author": "thoniTUB", "createdAt": "2020-10-19T11:53:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzY4MDUwOQ=="}], "type": "inlineReview", "revised_code": {"commit": "a86677557833c8439acb72311a3fca5faae47856", "chunk": "diff --git a/backend/src/main/java/com/bakdata/conquery/models/events/BucketManager.java b/backend/src/main/java/com/bakdata/conquery/models/events/BucketManager.java\nindex 336e1194d..f8b97602c 100644\n--- a/backend/src/main/java/com/bakdata/conquery/models/events/BucketManager.java\n+++ b/backend/src/main/java/com/bakdata/conquery/models/events/BucketManager.java\n\n@@ -58,17 +58,17 @@ public class BucketManager {\n \t/**\n \t * Connector -> Bucket -> [CBlock]\n \t */\n-\tprivate final Map<ConnectorId, Int2ObjectMap<List<CBlock>>> connectorCBlocks;\n+\tprivate final Map<ConnectorId, Int2ObjectMap<List<CBlock>>> connectorToCblocks;\n \n \t/**\n \t * Table -> BucketN -> [Buckets]\n \t */\n-\tprivate final Map<TableId, Int2ObjectMap<List<Bucket>>> bucketTables;\n+\tprivate final Map<TableId, Int2ObjectMap<List<Bucket>>> tableToBuckets;\n \n \tpublic static BucketManager create(Worker worker, WorkerStorage storage) {\n \t\tInt2ObjectMap<Entity> entities = new Int2ObjectAVLTreeMap<>();\n \t\tMap<ConnectorId, Int2ObjectMap<List<CBlock>>> connectorCBlocks = new HashMap<>(150);\n-\t\tMap<TableId, Int2ObjectMap<List<Bucket>>> bucketTables = new HashMap<>();\n+\t\tMap<TableId, Int2ObjectMap<List<Bucket>>> tableBuckets = new HashMap<>();\n \n \n \n"}}, {"oid": "45d51a1ef8b0b1ca8c3aa8123d0e7521b0d80181", "url": "https://github.com/bakdata/conquery/commit/45d51a1ef8b0b1ca8c3aa8123d0e7521b0d80181", "message": "Fix Bug, where Worker did not delete Import from Storage", "committedDate": "2020-10-19T12:26:39Z", "type": "commit"}, {"oid": "a109673c9d4aab1f566191840a6c776ee965f17c", "url": "https://github.com/bakdata/conquery/commit/a109673c9d4aab1f566191840a6c776ee965f17c", "message": "cleanup BucketManager", "committedDate": "2020-10-19T12:26:48Z", "type": "commit"}, {"oid": "a86677557833c8439acb72311a3fca5faae47856", "url": "https://github.com/bakdata/conquery/commit/a86677557833c8439acb72311a3fca5faae47856", "message": "update names", "committedDate": "2020-10-19T13:02:28Z", "type": "commit"}, {"oid": "7bb76ece00ae1f4d42e9622f8d75526270cc518c", "url": "https://github.com/bakdata/conquery/commit/7bb76ece00ae1f4d42e9622f8d75526270cc518c", "message": "cleanup code", "committedDate": "2020-10-19T13:05:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODI0NjgyNw==", "url": "https://github.com/bakdata/conquery/pull/1394#discussion_r508246827", "bodyText": "Musst du hier nicht auch getOrDefault nehmen?", "author": "thoniTUB", "createdAt": "2020-10-20T06:45:18Z", "path": "backend/src/main/java/com/bakdata/conquery/models/events/BucketManager.java", "diffHunk": "@@ -236,13 +245,23 @@ private void deregisterBucket(Bucket bucket) {\n \t\t\t\tentities.remove(entityId);\n \t\t\t}\n \t\t}\n+\n+\t\ttableToBuckets.getOrDefault(bucket.getImp().getTable(), Int2ObjectMaps.emptyMap())\n+\t\t\t\t\t  .get(bucket.getBucket())", "originalCommit": "7bb76ece00ae1f4d42e9622f8d75526270cc518c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTAzNzc3Nw==", "url": "https://github.com/bakdata/conquery/pull/1394#discussion_r509037777", "bodyText": "@awildturtok No comment? \ud83e\udd14", "author": "thoniTUB", "createdAt": "2020-10-21T07:08:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODI0NjgyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTA1NDYxMQ==", "url": "https://github.com/bakdata/conquery/pull/1394#discussion_r509054611", "bodyText": "hab ich das nicht behoben? strange sorry", "author": "awildturtok", "createdAt": "2020-10-21T07:37:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODI0NjgyNw=="}], "type": "inlineReview", "revised_code": {"commit": "89a892ca06e9eaba26720b5c8c4122ba0b4541d3", "chunk": "diff --git a/backend/src/main/java/com/bakdata/conquery/models/events/BucketManager.java b/backend/src/main/java/com/bakdata/conquery/models/events/BucketManager.java\nindex b1af8bb75..f5b7eac45 100644\n--- a/backend/src/main/java/com/bakdata/conquery/models/events/BucketManager.java\n+++ b/backend/src/main/java/com/bakdata/conquery/models/events/BucketManager.java\n\n@@ -238,43 +235,21 @@ public class BucketManager {\n \t\tfor (int entityId : bucket) {\n \t\t\tfinal Entity entity = entities.get(entityId);\n \n-\t\t\tif(entity == null)\n+\t\t\tif (entity == null) {\n \t\t\t\tcontinue;\n+\t\t\t}\n \n-\t\t\tif(isEntityEmpty(entity)) {\n+\t\t\tif (isEntityEmpty(entity)) {\n \t\t\t\tentities.remove(entityId);\n \t\t\t}\n \t\t}\n \n \t\ttableToBuckets.getOrDefault(bucket.getImp().getTable(), Int2ObjectMaps.emptyMap())\n-\t\t\t\t\t  .get(bucket.getBucket())\n+\t\t\t\t\t  .getOrDefault(bucket.getBucket(), Collections.emptyList())\n \t\t\t\t\t  .removeIf(bkt -> bkt.getId().equals(bucket.getId()));\n \n \t}\n \n-\tprivate void deregisterCBlock(CBlockId cBlockId) {\n-\t\tBucket bucket = storage.getBucket(cBlockId.getBucket());\n-\t\tif (bucket == null) {\n-\t\t\tthrow new NoSuchElementException(\"Could not find an element called '\"+cBlockId.getBucket()+\"'\");\n-\t\t}\n-\n-\t\tconnectorToCblocks.getOrDefault(cBlockId.getConnector(), Int2ObjectMaps.emptyMap())\n-\t\t\t\t\t\t  .get(cBlockId.getBucket().getBucket())\n-\t\t\t\t\t\t  .removeIf(cblock -> cblock.getId().equals(cBlockId));\n-\n-\t\tfor (int entityId : bucket) {\n-\t\t\tfinal Entity entity = entities.get(entityId);\n-\n-\t\t\tif(entity == null)\n-\t\t\t\tcontinue;\n-\n-\t\t\t//TODO Verify that this is enough.\n-\t\t\tif(isEntityEmpty(entity)) {\n-\t\t\t\tentities.remove(entityId);\n-\t\t\t}\n-\t\t}\n-\t}\n-\n \tpublic void removeBucket(BucketId bucketId) {\n \t\tBucket bucket = storage.getBucket(bucketId);\n \t\tif (bucket == null) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODI0NzA5Mw==", "url": "https://github.com/bakdata/conquery/pull/1394#discussion_r508247093", "bodyText": "genauso wie hier getOrDefault?", "author": "thoniTUB", "createdAt": "2020-10-20T06:45:53Z", "path": "backend/src/main/java/com/bakdata/conquery/models/events/BucketManager.java", "diffHunk": "@@ -236,13 +245,23 @@ private void deregisterBucket(Bucket bucket) {\n \t\t\t\tentities.remove(entityId);\n \t\t\t}\n \t\t}\n+\n+\t\ttableToBuckets.getOrDefault(bucket.getImp().getTable(), Int2ObjectMaps.emptyMap())\n+\t\t\t\t\t  .get(bucket.getBucket())\n+\t\t\t\t\t  .removeIf(bkt -> bkt.getId().equals(bucket.getId()));\n+\n \t}\n \n \tprivate void deregisterCBlock(CBlockId cBlockId) {\n \t\tBucket bucket = storage.getBucket(cBlockId.getBucket());\n \t\tif (bucket == null) {\n \t\t\tthrow new NoSuchElementException(\"Could not find an element called '\"+cBlockId.getBucket()+\"'\");\n \t\t}\n+\n+\t\tconnectorToCblocks.getOrDefault(cBlockId.getConnector(), Int2ObjectMaps.emptyMap())\n+\t\t\t\t\t\t  .get(cBlockId.getBucket().getBucket())", "originalCommit": "7bb76ece00ae1f4d42e9622f8d75526270cc518c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "89a892ca06e9eaba26720b5c8c4122ba0b4541d3", "chunk": "diff --git a/backend/src/main/java/com/bakdata/conquery/models/events/BucketManager.java b/backend/src/main/java/com/bakdata/conquery/models/events/BucketManager.java\nindex b1af8bb75..f5b7eac45 100644\n--- a/backend/src/main/java/com/bakdata/conquery/models/events/BucketManager.java\n+++ b/backend/src/main/java/com/bakdata/conquery/models/events/BucketManager.java\n\n@@ -238,43 +235,21 @@ public class BucketManager {\n \t\tfor (int entityId : bucket) {\n \t\t\tfinal Entity entity = entities.get(entityId);\n \n-\t\t\tif(entity == null)\n+\t\t\tif (entity == null) {\n \t\t\t\tcontinue;\n+\t\t\t}\n \n-\t\t\tif(isEntityEmpty(entity)) {\n+\t\t\tif (isEntityEmpty(entity)) {\n \t\t\t\tentities.remove(entityId);\n \t\t\t}\n \t\t}\n \n \t\ttableToBuckets.getOrDefault(bucket.getImp().getTable(), Int2ObjectMaps.emptyMap())\n-\t\t\t\t\t  .get(bucket.getBucket())\n+\t\t\t\t\t  .getOrDefault(bucket.getBucket(), Collections.emptyList())\n \t\t\t\t\t  .removeIf(bkt -> bkt.getId().equals(bucket.getId()));\n \n \t}\n \n-\tprivate void deregisterCBlock(CBlockId cBlockId) {\n-\t\tBucket bucket = storage.getBucket(cBlockId.getBucket());\n-\t\tif (bucket == null) {\n-\t\t\tthrow new NoSuchElementException(\"Could not find an element called '\"+cBlockId.getBucket()+\"'\");\n-\t\t}\n-\n-\t\tconnectorToCblocks.getOrDefault(cBlockId.getConnector(), Int2ObjectMaps.emptyMap())\n-\t\t\t\t\t\t  .get(cBlockId.getBucket().getBucket())\n-\t\t\t\t\t\t  .removeIf(cblock -> cblock.getId().equals(cBlockId));\n-\n-\t\tfor (int entityId : bucket) {\n-\t\t\tfinal Entity entity = entities.get(entityId);\n-\n-\t\t\tif(entity == null)\n-\t\t\t\tcontinue;\n-\n-\t\t\t//TODO Verify that this is enough.\n-\t\t\tif(isEntityEmpty(entity)) {\n-\t\t\t\tentities.remove(entityId);\n-\t\t\t}\n-\t\t}\n-\t}\n-\n \tpublic void removeBucket(BucketId bucketId) {\n \t\tBucket bucket = storage.getBucket(bucketId);\n \t\tif (bucket == null) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODI1MDQ2MA==", "url": "https://github.com/bakdata/conquery/pull/1394#discussion_r508250460", "bodyText": "Ouh, hatte ich das vergessen? Das sollte dann nochin den KW41 rein.\nIch wurde das L\u00f6schen aus dem Storage in dem Bucketmanager machen. Und da erst die Buckets und Concepts auf r\u00e4umen und dann erst aus dem Storage l\u00f6schen.", "author": "thoniTUB", "createdAt": "2020-10-20T06:53:06Z", "path": "backend/src/main/java/com/bakdata/conquery/models/worker/Worker.java", "diffHunk": "@@ -164,6 +164,7 @@ public void addImport(Import imp) {\n \t}\n \n \tpublic void removeImport(ImportId importId) {\n+\t\tstorage.removeImport(importId);", "originalCommit": "7bb76ece00ae1f4d42e9622f8d75526270cc518c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "7bb76ece00ae1f4d42e9622f8d75526270cc518c", "url": "https://github.com/bakdata/conquery/commit/7bb76ece00ae1f4d42e9622f8d75526270cc518c", "message": "cleanup code", "committedDate": "2020-10-19T13:05:44Z", "type": "forcePushed"}, {"oid": "6913906542c66bf39a2f958bfd3ff38e9829f4dc", "url": "https://github.com/bakdata/conquery/commit/6913906542c66bf39a2f958bfd3ff38e9829f4dc", "message": "Merge branch 'develop' into feature/index-for-buckets", "committedDate": "2020-10-20T13:12:23Z", "type": "commit"}, {"oid": "89a892ca06e9eaba26720b5c8c4122ba0b4541d3", "url": "https://github.com/bakdata/conquery/commit/89a892ca06e9eaba26720b5c8c4122ba0b4541d3", "message": "refactor CBlocks Index to better represent outgoing API", "committedDate": "2020-10-21T07:46:44Z", "type": "commit"}, {"oid": "08c453357c88d094c14d0338101843a55923ee17", "url": "https://github.com/bakdata/conquery/commit/08c453357c88d094c14d0338101843a55923ee17", "message": "Merge branch 'develop' into feature/index-for-buckets", "committedDate": "2020-10-21T08:25:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTA5MjI2Nw==", "url": "https://github.com/bakdata/conquery/pull/1394#discussion_r509092267", "bodyText": "Hier ist irgendwie ein merge kaputt gegangen und das sollte eigentlich nicht kompilieren, oder wo nimmt er requiredBuckets her?", "author": "thoniTUB", "createdAt": "2020-10-21T08:34:55Z", "path": "backend/src/main/java/com/bakdata/conquery/models/events/BucketManager.java", "diffHunk": "@@ -53,30 +52,84 @@\n \tprivate final Worker worker;\n \t@Getter\n \tprivate final Int2ObjectMap<Entity> entities;\n-\t\n+\n+\t/**\n+\t * Connector -> Bucket -> [BucketId -> CBlock]\n+\t */\n+\tprivate final Map<ConnectorId, Int2ObjectMap<Map<BucketId, CBlock>>> connectorToCblocks;\n+\n \t/**\n-\t * Connector -> Bucket -> [CBlock]\n+\t * Table -> BucketN -> [Buckets]\n \t */\n-\tprivate final Map<ConnectorId, Int2ObjectMap<List<CBlock>>> connectorCBlocks;\n-\t\n+\tprivate final Map<TableId, Int2ObjectMap<List<Bucket>>> tableToBuckets;\n+\n \tpublic static BucketManager create(Worker worker, WorkerStorage storage) {\n \t\tInt2ObjectMap<Entity> entities = new Int2ObjectAVLTreeMap<>();\n-\t\tMap<ConnectorId, Int2ObjectMap<List<CBlock>>> connectorCBlocks = new HashMap<>(150);\n+\t\tMap<ConnectorId, Int2ObjectMap<Map<BucketId, CBlock>>> connectorCBlocks = new HashMap<>();\n+\t\tMap<TableId, Int2ObjectMap<List<Bucket>>> tableBuckets = new HashMap<>();\n+\n+\n \t\t\n+\t\tlog.trace(\"Trying to load these buckets: {}\", requiredBuckets);\n \t\tIntArraySet assignedBucketNumbers = worker.getInfo().getIncludedBuckets();\n \t\tlog.trace(\"Trying to load these buckets that map to: {}\", assignedBucketNumbers);\n \t\tfor (Bucket bucket : storage.getAllBuckets()) {\n \t\t\tif(!assignedBucketNumbers.contains(bucket.getBucket())) {\n \t\t\t\tlog.warn(\"Found Bucket[{}] in Storage that does not belong to this Worker according to the Worker information.\", bucket.getId());\n \t\t\t}\n-\t\t\tregisterBucket(bucket, entities, storage);\n+\t\t\tregisterBucket(bucket, entities, storage, tableBuckets);\n+\t\t}\n+\t\tif (!requiredBuckets.isEmpty()) {\n+\t\t\tlog.warn(\"Not all required Buckets were loaded from the storage. Missing Buckets: {}\", requiredBuckets);\n \t\t}\n \n+\n \t\tfor (CBlock cBlock : storage.getAllCBlocks()) {", "originalCommit": "08c453357c88d094c14d0338101843a55923ee17", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5a4c6d79d847bbf5de4655cf8e41620cd2aa014a", "chunk": "diff --git a/backend/src/main/java/com/bakdata/conquery/models/events/BucketManager.java b/backend/src/main/java/com/bakdata/conquery/models/events/BucketManager.java\nindex 0744d22b8..550fec28b 100644\n--- a/backend/src/main/java/com/bakdata/conquery/models/events/BucketManager.java\n+++ b/backend/src/main/java/com/bakdata/conquery/models/events/BucketManager.java\n\n@@ -54,6 +54,8 @@ public class BucketManager {\n \tprivate final Int2ObjectMap<Entity> entities;\n \n \t/**\n+\t * The final Map is the way the APIs expect the data to be delivered.\n+\t *\n \t * Connector -> Bucket -> [BucketId -> CBlock]\n \t */\n \tprivate final Map<ConnectorId, Int2ObjectMap<Map<BucketId, CBlock>>> connectorToCblocks;\n"}}, {"oid": "5a4c6d79d847bbf5de4655cf8e41620cd2aa014a", "url": "https://github.com/bakdata/conquery/commit/5a4c6d79d847bbf5de4655cf8e41620cd2aa014a", "message": "fix merge error", "committedDate": "2020-10-21T09:20:42Z", "type": "commit"}, {"oid": "1f5fe39578f295d3075a41d2dc250119e61281eb", "url": "https://github.com/bakdata/conquery/commit/1f5fe39578f295d3075a41d2dc250119e61281eb", "message": "Merge branch 'develop' into feature/index-for-buckets", "committedDate": "2020-11-10T09:40:09Z", "type": "commit"}]}