{"pr_number": 1273, "pr_title": "Load storages in parallel", "pr_createdAt": "2020-07-15T14:27:12Z", "pr_url": "https://github.com/bakdata/conquery/pull/1273", "timeline": [{"oid": "a7fd0be7c63a61353b615a62f6bb9309d61ea0f5", "url": "https://github.com/bakdata/conquery/commit/a7fd0be7c63a61353b615a62f6bb9309d61ea0f5", "message": "Revert \"revert parallel loading\"\n\nThis reverts commit 93b260c5", "committedDate": "2020-06-26T15:19:42Z", "type": "commit"}, {"oid": "83bc24df53ff2cd240cfb5b8fe2a612d35593801", "url": "https://github.com/bakdata/conquery/commit/83bc24df53ff2cd240cfb5b8fe2a612d35593801", "message": "load datasets in parallel", "committedDate": "2020-06-26T15:21:05Z", "type": "commit"}, {"oid": "8b2d2510dbb2eb8b1be0fbb19443d127b931a86b", "url": "https://github.com/bakdata/conquery/commit/8b2d2510dbb2eb8b1be0fbb19443d127b931a86b", "message": "Merge branch 'develop' into feature/parallel-storage-loading-PARKED\n\n# Conflicts:\n#\tbackend/src/main/java/com/bakdata/conquery/commands/SlaveCommand.java", "committedDate": "2020-07-14T09:48:14Z", "type": "commit"}, {"oid": "5a0dc0d14ea1ee136b646876ea9461ffa4ff7e85", "url": "https://github.com/bakdata/conquery/commit/5a0dc0d14ea1ee136b646876ea9461ffa4ff7e85", "message": "merge changes", "committedDate": "2020-07-14T09:52:33Z", "type": "commit"}, {"oid": "f93b14522c58b1acc3c9f27b9269611d7fd79ed0", "url": "https://github.com/bakdata/conquery/commit/f93b14522c58b1acc3c9f27b9269611d7fd79ed0", "message": "add await for loaders", "committedDate": "2020-07-14T10:23:15Z", "type": "commit"}, {"oid": "f9531708711cc6cb7450abde6929b206de95f9a7", "url": "https://github.com/bakdata/conquery/commit/f9531708711cc6cb7450abde6929b206de95f9a7", "message": "fix output of Namespaces", "committedDate": "2020-07-14T10:25:29Z", "type": "commit"}, {"oid": "117b9986799bc2bc91e524231b56097b0a0532a7", "url": "https://github.com/bakdata/conquery/commit/117b9986799bc2bc91e524231b56097b0a0532a7", "message": "proper await", "committedDate": "2020-07-14T10:33:41Z", "type": "commit"}, {"oid": "06db68f86cd968bc03749d0929e9b1facc6b60db", "url": "https://github.com/bakdata/conquery/commit/06db68f86cd968bc03749d0929e9b1facc6b60db", "message": "Don't use singleton PROGRESS_BAR", "committedDate": "2020-07-14T12:27:49Z", "type": "commit"}, {"oid": "01cb48c3f512d37bf851f2092915b40564d1959c", "url": "https://github.com/bakdata/conquery/commit/01cb48c3f512d37bf851f2092915b40564d1959c", "message": "more debugging", "committedDate": "2020-07-14T12:52:06Z", "type": "commit"}, {"oid": "448d6e76e35f52c73d92bff04871a8e1bcd5ebf7", "url": "https://github.com/bakdata/conquery/commit/448d6e76e35f52c73d92bff04871a8e1bcd5ebf7", "message": "add name of loaded dictionaries to debug output", "committedDate": "2020-07-14T12:58:55Z", "type": "commit"}, {"oid": "b8ce29d3a7dea454e2a48983592127979c384066", "url": "https://github.com/bakdata/conquery/commit/b8ce29d3a7dea454e2a48983592127979c384066", "message": "some more verbose logging", "committedDate": "2020-07-14T13:28:04Z", "type": "commit"}, {"oid": "c06af68f0f417e3cdaf5e59dd6c16930fa790543", "url": "https://github.com/bakdata/conquery/commit/c06af68f0f417e3cdaf5e59dd6c16930fa790543", "message": "rework of WorkerStorageImpl loading", "committedDate": "2020-07-14T14:12:19Z", "type": "commit"}, {"oid": "6c3888705b8431df1123500f27722278392ea0de", "url": "https://github.com/bakdata/conquery/commit/6c3888705b8431df1123500f27722278392ea0de", "message": "some wip fumbling", "committedDate": "2020-07-14T16:00:20Z", "type": "commit"}, {"oid": "aaa02ff9568be281b821c25f7cb54614da6b0094", "url": "https://github.com/bakdata/conquery/commit/aaa02ff9568be281b821c25f7cb54614da6b0094", "message": "where am i coming from?", "committedDate": "2020-07-14T16:16:15Z", "type": "commit"}, {"oid": "83407426beda90c2078b2ecf370b6b893f13f9d8", "url": "https://github.com/bakdata/conquery/commit/83407426beda90c2078b2ecf370b6b893f13f9d8", "message": "more logging", "committedDate": "2020-07-14T16:30:00Z", "type": "commit"}, {"oid": "7ea87a9e19f20979f84ff15d12003fcbd2ef77b8", "url": "https://github.com/bakdata/conquery/commit/7ea87a9e19f20979f84ff15d12003fcbd2ef77b8", "message": "don't load dicts in job.", "committedDate": "2020-07-15T06:22:17Z", "type": "commit"}, {"oid": "2d0952e4577af9921ada7f2bb1a039cec1078dc9", "url": "https://github.com/bakdata/conquery/commit/2d0952e4577af9921ada7f2bb1a039cec1078dc9", "message": "fail if not all loaders have finished", "committedDate": "2020-07-15T09:44:48Z", "type": "commit"}, {"oid": "0f3b744d4f23d2b2133dd5fef34407f6920291ea", "url": "https://github.com/bakdata/conquery/commit/0f3b744d4f23d2b2133dd5fef34407f6920291ea", "message": "More markers for origin", "committedDate": "2020-07-15T10:26:59Z", "type": "commit"}, {"oid": "5042c2a9d672e3c24f80a6f9e7640535a01b338b", "url": "https://github.com/bakdata/conquery/commit/5042c2a9d672e3c24f80a6f9e7640535a01b338b", "message": "what state is the thread in?", "committedDate": "2020-07-15T14:46:26Z", "type": "commit"}, {"oid": "15abc1ff0a571df6cd7aedce995a96938d7aa886", "url": "https://github.com/bakdata/conquery/commit/15abc1ff0a571df6cd7aedce995a96938d7aa886", "message": "... and where?", "committedDate": "2020-07-15T14:56:32Z", "type": "commit"}, {"oid": "4bb025a52a12e418294ec7ef834d6f07c6526cde", "url": "https://github.com/bakdata/conquery/commit/4bb025a52a12e418294ec7ef834d6f07c6526cde", "message": "more detailed logging", "committedDate": "2020-07-15T15:05:21Z", "type": "commit"}, {"oid": "a7bee7f44486fb89e6178ff9678d2913dd4ebefd", "url": "https://github.com/bakdata/conquery/commit/a7bee7f44486fb89e6178ff9678d2913dd4ebefd", "message": "they are waiting for more work, why?", "committedDate": "2020-07-15T15:12:15Z", "type": "commit"}, {"oid": "774d14d2ef219ce6bc8a759dee2309b0029f0615", "url": "https://github.com/bakdata/conquery/commit/774d14d2ef219ce6bc8a759dee2309b0029f0615", "message": "Remove some logging.", "committedDate": "2020-07-15T15:35:06Z", "type": "commit"}, {"oid": "1eecadc11e65b180746290d3b67bbc97a8a2572d", "url": "https://github.com/bakdata/conquery/commit/1eecadc11e65b180746290d3b67bbc97a8a2572d", "message": "undo parallel storage loading but parallelize loading at Worker level", "committedDate": "2020-07-16T14:29:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjI2MjQ0MQ==", "url": "https://github.com/bakdata/conquery/pull/1273#discussion_r456262441", "bodyText": "Die Wartezeit unterscheidet sich vom Master", "author": "thoniTUB", "createdAt": "2020-07-17T07:16:30Z", "path": "backend/src/main/java/com/bakdata/conquery/commands/SlaveCommand.java", "diffHunk": "@@ -73,52 +75,63 @@ protected void run(Environment environment, Namespace namespace, ConqueryConfig\n \t\tsynchronized (environment) {\n \t\t\tenvironment.lifecycle().manage(this);\n \t\t\tvalidator = environment.getValidator();\n-\t\t\t\n+\n \t\t\tscheduler = environment\n-\t\t\t\t.lifecycle()\n-\t\t\t\t.scheduledExecutorService(\"Scheduled Messages\")\n-\t\t\t\t.build();\n+\t\t\t\t\t\t\t\t.lifecycle()\n+\t\t\t\t\t\t\t\t.scheduledExecutorService(\"Scheduled Messages\")\n+\t\t\t\t\t\t\t\t.build();\n \t\t}\n-\t\t\n+\n \t\tscheduler.scheduleAtFixedRate(this::reportJobManagerStatus, 30, 1, TimeUnit.SECONDS);\n \n \t\tthis.config = config;\n \n-\t\tif(config.getStorage().getDirectory().mkdirs()){\n+\t\tif (config.getStorage().getDirectory().mkdirs()) {\n \t\t\tlog.warn(\"Had to create Storage Dir at `{}`\", config.getStorage().getDirectory());\n \t\t}\n \n-\t\tworkers = new Workers(config.getQueries().getExecutionPool(),  config.getStorage().getNThreads());\n+\t\tworkers = new Workers(config.getQueries().getExecutionPool(), config.getStorage().getNThreads());\n+\t\tExecutorService loaders = Executors.newFixedThreadPool(config.getStorage().getNThreads());\n+\n \n \t\tFile storageDir = config.getStorage().getDirectory();\n-\t\tfor(File directory : storageDir.listFiles((file, name) -> name.startsWith(\"worker_\"))) {\n+\t\tfor (File directory : storageDir.listFiles((file, name) -> name.startsWith(\"worker_\"))) {\n \n-\t\t\tWorkerStorage workerStorage = WorkerStorage.tryLoad(validator, config.getStorage(), directory);\n-\t\t\tif (workerStorage == null) {\n-\t\t\t\tlog.warn(\"No valid WorkerStorage found in {}\",directory);\n-\t\t\t\tcontinue;\n-\t\t\t}\n+\t\t\tloaders.submit(() -> {\n+\t\t\t\tConqueryMDC.setLocation(directory.toString());\n \n-\t\t\tworkers.createWorker(\n-\t\t\t\t\tworkerStorage.getWorker(),\n-\t\t\t\t\tworkerStorage\n-\t\t\t);\n-\t\t}\n+\t\t\t\tWorkerStorage workerStorage = WorkerStorage.tryLoad(validator, config.getStorage(), directory);\n+\t\t\t\tif (workerStorage == null) {\n+\t\t\t\t\tlog.warn(\"No valid WorkerStorage found.\");\n+\t\t\t\t\treturn;\n+\t\t\t\t}\n+\n+\t\t\t\tworkers.createWorker(\n+\t\t\t\t\t\tworkerStorage.getWorker(),\n+\t\t\t\t\t\tworkerStorage\n+\t\t\t\t);\n \n+\t\t\t\tConqueryMDC.clearLocation();\n+\t\t\t});\n+\t\t}\n \n+\t\tloaders.shutdown();\n+\t\twhile (!loaders.awaitTermination(30, TimeUnit.SECONDS)) {", "originalCommit": "1eecadc11e65b180746290d3b67bbc97a8a2572d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "fa2cfe2579e308076641aa8161e69c692c0c54c8", "chunk": "diff --git a/backend/src/main/java/com/bakdata/conquery/commands/SlaveCommand.java b/backend/src/main/java/com/bakdata/conquery/commands/SlaveCommand.java\nindex 4dfc9b54b..cfff760dc 100644\n--- a/backend/src/main/java/com/bakdata/conquery/commands/SlaveCommand.java\n+++ b/backend/src/main/java/com/bakdata/conquery/commands/SlaveCommand.java\n\n@@ -116,7 +116,7 @@ public class SlaveCommand extends ConqueryCommand implements IoHandler, Managed\n \t\t}\n \n \t\tloaders.shutdown();\n-\t\twhile (!loaders.awaitTermination(30, TimeUnit.SECONDS)) {\n+\t\twhile (!loaders.awaitTermination(1, TimeUnit.MINUTES)) {\n \t\t\tlog.debug(\"Waiting for Workers to load. {} are already finished.\", workers.getWorkers().size());\n \t\t}\n \n"}}, {"oid": "49474b4610cf1fdadc768c2aa560317b597f0ce9", "url": "https://github.com/bakdata/conquery/commit/49474b4610cf1fdadc768c2aa560317b597f0ce9", "message": "Merge branch 'develop' into feature/parallel-storage-loading-PARKED", "committedDate": "2020-07-17T07:40:50Z", "type": "commit"}, {"oid": "fa2cfe2579e308076641aa8161e69c692c0c54c8", "url": "https://github.com/bakdata/conquery/commit/fa2cfe2579e308076641aa8161e69c692c0c54c8", "message": "Make awaiting time same on all nodes", "committedDate": "2020-07-17T07:47:37Z", "type": "commit"}]}