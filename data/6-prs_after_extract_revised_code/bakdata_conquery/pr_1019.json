{"pr_number": 1019, "pr_title": "SourceSearch is tracked in SlowJobQueue", "pr_createdAt": "2020-02-06T13:29:08Z", "pr_url": "https://github.com/bakdata/conquery/pull/1019", "timeline": [{"oid": "c51d6ace568eedcae292ee5b23cd3100afcf1a71", "url": "https://github.com/bakdata/conquery/commit/c51d6ace568eedcae292ee5b23cd3100afcf1a71", "message": "fix usage of search init in tests", "committedDate": "2020-02-06T13:18:48Z", "type": "commit"}, {"oid": "a19e8507ff4dc193916eb0adff295e66674d8909", "url": "https://github.com/bakdata/conquery/commit/a19e8507ff4dc193916eb0adff295e66674d8909", "message": "Merge branch 'develop' into feature/create-search-in-jobqueue", "committedDate": "2020-02-06T13:29:16Z", "type": "commit"}, {"oid": "2c2a308823062b1190359fb8aa9f1f8ef8419bed", "url": "https://github.com/bakdata/conquery/commit/2c2a308823062b1190359fb8aa9f1f8ef8419bed", "message": "Update FilterSearch.java", "committedDate": "2020-02-06T14:22:04Z", "type": "commit"}, {"oid": "96399354f9da2115d9811db364307fbb964b689a", "url": "https://github.com/bakdata/conquery/commit/96399354f9da2115d9811db364307fbb964b689a", "message": "remove most common usage of ImmutableSet, and move to HashSet. As the former is very slow", "committedDate": "2020-02-06T14:49:04Z", "type": "commit"}, {"oid": "e9995b57373f20a1401e5fde8e1c0e670ab73dfe", "url": "https://github.com/bakdata/conquery/commit/e9995b57373f20a1401e5fde8e1c0e670ab73dfe", "message": "Merge branch 'feature/create-search-in-jobqueue' of https://github.com/bakdata/conquery into feature/create-search-in-jobqueue", "committedDate": "2020-02-06T15:16:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk5MzA1Ng==", "url": "https://github.com/bakdata/conquery/pull/1019#discussion_r376993056", "bodyText": "doku", "author": "awildturtok", "createdAt": "2020-02-10T10:57:19Z", "path": "backend/src/main/java/com/bakdata/conquery/apiv1/FilterSearch.java", "diffHunk": "@@ -83,18 +83,13 @@ public double score(String candidate, String keyword) {\n \n \tprivate static Map<String, QuickSearch<FilterSearchItem>> search = new HashMap<>();\n \n-\tpublic static ExecutorService init(Namespaces namespaces, Collection<Dataset> datasets) {\n-\t\tExecutorService executor = Executors.newSingleThreadExecutor();\n-\n+\tpublic static void init(Namespaces namespaces, Collection<Dataset> datasets, JobManager jobManager) {", "originalCommit": "e9995b57373f20a1401e5fde8e1c0e670ab73dfe", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "84c95f7505fc36e7ff0fe5a325f0efe825cd8f1d", "chunk": "diff --git a/backend/src/main/java/com/bakdata/conquery/apiv1/FilterSearch.java b/backend/src/main/java/com/bakdata/conquery/apiv1/FilterSearch.java\nindex c76a5069e..bede941c5 100644\n--- a/backend/src/main/java/com/bakdata/conquery/apiv1/FilterSearch.java\n+++ b/backend/src/main/java/com/bakdata/conquery/apiv1/FilterSearch.java\n\n@@ -83,15 +83,22 @@ public class FilterSearch {\n \n \tprivate static Map<String, QuickSearch<FilterSearchItem>> search = new HashMap<>();\n \n-\tpublic static void init(Namespaces namespaces, Collection<Dataset> datasets, JobManager jobManager) {\n+\t/**\n+\t * Scan all SelectFilters and submit {@link SimpleJob}s to create interactive searches for them.\n+\t */\n+\tpublic static void updateSearch(Namespaces namespaces, Collection<Dataset> datasets, JobManager jobManager) {\n \t\tdatasets.stream()\n \t\t\t\t.flatMap(ds -> namespaces.get(ds.getId()).getStorage().getAllConcepts().stream())\n \t\t\t\t.flatMap(c -> c.getConnectors().stream())\n \t\t\t\t.flatMap(co -> co.collectAllFilters().stream())\n-\t\t\t\t.filter(f -> f instanceof AbstractSelectFilter && f.getTemplate() != null)\n+\t\t\t\t.filter(f -> f instanceof AbstractSelectFilter && ((AbstractSelectFilter<?>) f).getTemplate() != null)\n \t\t\t\t.forEach(f -> jobManager.addFastJob(new SimpleJob(String.format(\"SourceSearch[%s]\", f.getId()), () -> createSourceSearch(((AbstractSelectFilter<?>) f)))));\n \t}\n \n+\t/***\n+\t * Create interactive Search for the selected filter based on its Template.\n+\t * @param filter\n+\t */\n \tpublic static void createSourceSearch(AbstractSelectFilter<?> filter) {\n \t\tFilterTemplate template = filter.getTemplate();\n \n"}}, {"oid": "84c95f7505fc36e7ff0fe5a325f0efe825cd8f1d", "url": "https://github.com/bakdata/conquery/commit/84c95f7505fc36e7ff0fe5a325f0efe825cd8f1d", "message": "Move Template from Filter to AbstractSelectFilter and add documentation for FilterSearch", "committedDate": "2020-02-10T13:31:46Z", "type": "commit"}, {"oid": "f518615fdce638de2876a1578f10034b6f1aba64", "url": "https://github.com/bakdata/conquery/commit/f518615fdce638de2876a1578f10034b6f1aba64", "message": "Merge 84c95f7505fc36e7ff0fe5a325f0efe825cd8f1d into 9872fa08fe592ab056d17542a02786b9a8105a3c", "committedDate": "2020-02-10T13:31:58Z", "type": "commit"}, {"oid": "4ba1fee101b6abb7a13416adf6254062fc143fa7", "url": "https://github.com/bakdata/conquery/commit/4ba1fee101b6abb7a13416adf6254062fc143fa7", "message": "automatic update to docs", "committedDate": "2020-02-10T13:34:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA2ODA2Mw==", "url": "https://github.com/bakdata/conquery/pull/1019#discussion_r377068063", "bodyText": "addFastJob -> Der PR titel sagt, dass der Bau der Suche ein SlowJob sein sollte.", "author": "thoniTUB", "createdAt": "2020-02-10T13:41:32Z", "path": "backend/src/main/java/com/bakdata/conquery/apiv1/FilterSearch.java", "diffHunk": "@@ -83,20 +83,22 @@ public double score(String candidate, String keyword) {\n \n \tprivate static Map<String, QuickSearch<FilterSearchItem>> search = new HashMap<>();\n \n-\tpublic static ExecutorService init(Namespaces namespaces, Collection<Dataset> datasets) {\n-\t\tExecutorService executor = Executors.newSingleThreadExecutor();\n-\n+\t/**\n+\t * Scan all SelectFilters and submit {@link SimpleJob}s to create interactive searches for them.\n+\t */\n+\tpublic static void updateSearch(Namespaces namespaces, Collection<Dataset> datasets, JobManager jobManager) {\n \t\tdatasets.stream()\n \t\t\t\t.flatMap(ds -> namespaces.get(ds.getId()).getStorage().getAllConcepts().stream())\n \t\t\t\t.flatMap(c -> c.getConnectors().stream())\n \t\t\t\t.flatMap(co -> co.collectAllFilters().stream())\n-\t\t\t\t.filter(f -> f instanceof AbstractSelectFilter && f.getTemplate() != null)\n-\t\t\t\t.forEach(f -> executor.submit(() -> createSourceSearch(((AbstractSelectFilter<?>) f))));\n-\n-\t\texecutor.shutdown();\n-\t\treturn executor;\n+\t\t\t\t.filter(f -> f instanceof AbstractSelectFilter && ((AbstractSelectFilter<?>) f).getTemplate() != null)\n+\t\t\t\t.forEach(f -> jobManager.addFastJob(new SimpleJob(String.format(\"SourceSearch[%s]\", f.getId()), () -> createSourceSearch(((AbstractSelectFilter<?>) f)))));", "originalCommit": "4ba1fee101b6abb7a13416adf6254062fc143fa7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA2OTc3OQ==", "url": "https://github.com/bakdata/conquery/pull/1019#discussion_r377069779", "bodyText": "Ich w\u00fcrde noch im Stream casten\n\t\t\t\t.map(AbstractSelectFilter.class::cast)\n\t\t\t\t.forEach(f -> jobManager.addFastJob(new SimpleJob(String.format(\"SourceSearch[%s]\", f.getId()), () -> createSourceSearch(( f))));", "author": "thoniTUB", "createdAt": "2020-02-10T13:44:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA2ODA2Mw=="}], "type": "inlineReview", "revised_code": {"commit": "7943f3a853dabbffc22dcb4ae357d869a290272f", "chunk": "diff --git a/backend/src/main/java/com/bakdata/conquery/apiv1/FilterSearch.java b/backend/src/main/java/com/bakdata/conquery/apiv1/FilterSearch.java\nindex bede941c5..0ca17504f 100644\n--- a/backend/src/main/java/com/bakdata/conquery/apiv1/FilterSearch.java\n+++ b/backend/src/main/java/com/bakdata/conquery/apiv1/FilterSearch.java\n\n@@ -92,7 +92,8 @@ public class FilterSearch {\n \t\t\t\t.flatMap(c -> c.getConnectors().stream())\n \t\t\t\t.flatMap(co -> co.collectAllFilters().stream())\n \t\t\t\t.filter(f -> f instanceof AbstractSelectFilter && ((AbstractSelectFilter<?>) f).getTemplate() != null)\n-\t\t\t\t.forEach(f -> jobManager.addFastJob(new SimpleJob(String.format(\"SourceSearch[%s]\", f.getId()), () -> createSourceSearch(((AbstractSelectFilter<?>) f)))));\n+\t\t\t\t.map(AbstractSelectFilter.class::cast)\n+\t\t\t\t.forEach(f -> jobManager.addSlowJob(new SimpleJob(String.format(\"SourceSearch[%s]\", f.getId()), () -> createSourceSearch(f))));\n \t}\n \n \t/***\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA3MTczNg==", "url": "https://github.com/bakdata/conquery/pull/1019#discussion_r377071736", "bodyText": "dann kann der Kommentar auch weg ;)", "author": "thoniTUB", "createdAt": "2020-02-10T13:48:05Z", "path": "backend/src/main/java/com/bakdata/conquery/models/concepts/filters/Filter.java", "diffHunk": "@@ -35,7 +32,6 @@\n \t@JsonBackReference\n \tprivate Connector connector;\n \t// TODO: 20.11.2019 Move to AbstractSelectFilter", "originalCommit": "4ba1fee101b6abb7a13416adf6254062fc143fa7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "07c366debac228ab48de243344241d9c6c5224a6", "chunk": "diff --git a/backend/src/main/java/com/bakdata/conquery/models/concepts/filters/Filter.java b/backend/src/main/java/com/bakdata/conquery/models/concepts/filters/Filter.java\nindex 6a7438a17..b07b12047 100644\n--- a/backend/src/main/java/com/bakdata/conquery/models/concepts/filters/Filter.java\n+++ b/backend/src/main/java/com/bakdata/conquery/models/concepts/filters/Filter.java\n\n@@ -31,7 +31,6 @@ public abstract class Filter<FE_TYPE> extends Labeled<FilterId> {\n \tprivate String description;\n \t@JsonBackReference\n \tprivate Connector connector;\n-\t// TODO: 20.11.2019 Move to AbstractSelectFilter\n \tprivate String pattern;\n \tprivate Boolean allowDropFile;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA3ODAzMg==", "url": "https://github.com/bakdata/conquery/pull/1019#discussion_r377078032", "bodyText": "Die Zeile k\u00f6nntest du nach  AbstractSelectFilter#configureFrontend verschieben. Die Funktion wird nach diesem Builder aufgerufen.", "author": "thoniTUB", "createdAt": "2020-02-10T13:59:20Z", "path": "backend/src/main/java/com/bakdata/conquery/models/concepts/FrontEndConceptBuilder.java", "diffHunk": "@@ -209,7 +210,7 @@ public static FEFilter createFilter(Filter<?> filter) {\n \t\t\t.unit(filter.getUnit())\n \t\t\t.allowDropFile(filter.getAllowDropFile())\n \t\t\t.pattern(filter.getPattern())\n-\t\t\t.template(filter.getTemplate())\n+\t\t\t.template(filter instanceof AbstractSelectFilter ? ((AbstractSelectFilter<?>) filter).getTemplate() : null)", "originalCommit": "4ba1fee101b6abb7a13416adf6254062fc143fa7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "07c366debac228ab48de243344241d9c6c5224a6", "chunk": "diff --git a/backend/src/main/java/com/bakdata/conquery/models/concepts/FrontEndConceptBuilder.java b/backend/src/main/java/com/bakdata/conquery/models/concepts/FrontEndConceptBuilder.java\nindex 9bfd01be6..465746e6f 100644\n--- a/backend/src/main/java/com/bakdata/conquery/models/concepts/FrontEndConceptBuilder.java\n+++ b/backend/src/main/java/com/bakdata/conquery/models/concepts/FrontEndConceptBuilder.java\n\n@@ -210,7 +209,6 @@ public class FrontEndConceptBuilder {\n \t\t\t.unit(filter.getUnit())\n \t\t\t.allowDropFile(filter.getAllowDropFile())\n \t\t\t.pattern(filter.getPattern())\n-\t\t\t.template(filter instanceof AbstractSelectFilter ? ((AbstractSelectFilter<?>) filter).getTemplate() : null)\n \t\t\t.build();\n \t\ttry {\n \t\t\tfilter.configureFrontend(f);\n"}}, {"oid": "7943f3a853dabbffc22dcb4ae357d869a290272f", "url": "https://github.com/bakdata/conquery/commit/7943f3a853dabbffc22dcb4ae357d869a290272f", "message": "Fixed adding to fast Jobs even though it's a slow Job", "committedDate": "2020-02-10T14:25:53Z", "type": "commit"}, {"oid": "07c366debac228ab48de243344241d9c6c5224a6", "url": "https://github.com/bakdata/conquery/commit/07c366debac228ab48de243344241d9c6c5224a6", "message": "Code Style fixes", "committedDate": "2020-02-10T14:27:15Z", "type": "commit"}, {"oid": "feea9cfa7714d016ae63a1716abe2c96f9e18a1b", "url": "https://github.com/bakdata/conquery/commit/feea9cfa7714d016ae63a1716abe2c96f9e18a1b", "message": "Merge branch 'develop' into feature/create-search-in-jobqueue", "committedDate": "2020-02-10T14:39:32Z", "type": "commit"}]}