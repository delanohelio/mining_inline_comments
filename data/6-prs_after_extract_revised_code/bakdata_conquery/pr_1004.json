{"pr_number": 1004, "pr_title": "Synchronize on bucket assignment and creation", "pr_createdAt": "2020-01-27T08:44:03Z", "pr_url": "https://github.com/bakdata/conquery/pull/1004", "timeline": [{"oid": "136fbe68491f68ddabeca06a4aefd82502fcd3a4", "url": "https://github.com/bakdata/conquery/commit/136fbe68491f68ddabeca06a4aefd82502fcd3a4", "message": "unwind creation of buckets in ImportJob.createMappings. Completely avoids duplicate creation.", "committedDate": "2020-01-27T08:42:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY1ODc4OQ==", "url": "https://github.com/bakdata/conquery/pull/1004#discussion_r371658789", "bodyText": "Hast du hiermit noch etwas vor?", "author": "thoniTUB", "createdAt": "2020-01-28T08:21:25Z", "path": "backend/src/main/java/com/bakdata/conquery/models/jobs/ImportJob.java", "diffHunk": "@@ -95,13 +95,24 @@ public void execute() throws JSONException {\n \n \t\t\t//partition the new IDs between the slaves\n \t\t\tlog.debug(\"\\tpartition new IDs\");\n-\t\t\tfor (int bucket : primaryMapping.getNewBuckets()) {\n-\t\t\t\tnamespace.addResponsibility(bucket);\n+\n+\t\t\t// Allocate a responsibility for all yet unassigned buckets.\n+\t\t\tsynchronized (namespace) {\n+\t\t\t\tfor (int bucket : primaryMapping.getUsedBuckets()) {\n+\t\t\t\t\tif (namespace.getResponsibleWorkerForBucket(bucket) != null) {\n+\t\t\t\t\t\tcontinue;\n+\t\t\t\t\t}\n+\n+\t\t\t\t\tnamespace.addResponsibility(bucket);\n+\t\t\t\t}\n \t\t\t}\n+\n \t\t\tfor (WorkerInformation w : namespace.getWorkers()) {\n \t\t\t\tw.send(new UpdateWorkerBucket(w));\n \t\t\t}\n-\t\t\tnamespace.updateWorkerMap();\n+\n+\t\t\tsynchronized (namespace) {", "originalCommit": "136fbe68491f68ddabeca06a4aefd82502fcd3a4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9a50d36c7722e86ecc3408bcd7a42b1c1bf14cc1", "chunk": "diff --git a/backend/src/main/java/com/bakdata/conquery/models/jobs/ImportJob.java b/backend/src/main/java/com/bakdata/conquery/models/jobs/ImportJob.java\nindex 58f928397..c3374ba4b 100644\n--- a/backend/src/main/java/com/bakdata/conquery/models/jobs/ImportJob.java\n+++ b/backend/src/main/java/com/bakdata/conquery/models/jobs/ImportJob.java\n\n@@ -93,7 +93,7 @@ public class ImportJob extends Job {\n \t\t\tthis.progressReporter.report(1);\n \t\t\tDictionaryMapping primaryMapping = header.getPrimaryColumn().getValueMapping();\n \n-\t\t\t//partition the new IDs between the slaves\n+\t\t\t// Distribute the new IDs between the slaves\n \t\t\tlog.debug(\"\\tpartition new IDs\");\n \n \t\t\t// Allocate a responsibility for all yet unassigned buckets.\n"}}, {"oid": "9a50d36c7722e86ecc3408bcd7a42b1c1bf14cc1", "url": "https://github.com/bakdata/conquery/commit/9a50d36c7722e86ecc3408bcd7a42b1c1bf14cc1", "message": "cleanup", "committedDate": "2020-01-28T14:02:00Z", "type": "commit"}, {"oid": "91a7bbb56690284ee6d2d4c997a5c1adf31ae6e1", "url": "https://github.com/bakdata/conquery/commit/91a7bbb56690284ee6d2d4c997a5c1adf31ae6e1", "message": "Merge branch 'develop' into feature/synchronize-on-bucket-assignment", "committedDate": "2020-02-03T13:54:52Z", "type": "commit"}, {"oid": "6f158c8703522ff07b9d68677e7ad6edf2ddb710", "url": "https://github.com/bakdata/conquery/commit/6f158c8703522ff07b9d68677e7ad6edf2ddb710", "message": "Update Namespace.java", "committedDate": "2020-02-04T16:16:25Z", "type": "commit"}, {"oid": "d9114cbd2e7a49580a927f51dd8be47b13046051", "url": "https://github.com/bakdata/conquery/commit/d9114cbd2e7a49580a927f51dd8be47b13046051", "message": "Update Namespace.java", "committedDate": "2020-02-04T16:18:17Z", "type": "commit"}]}