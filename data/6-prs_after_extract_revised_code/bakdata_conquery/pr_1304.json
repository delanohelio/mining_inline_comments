{"pr_number": 1304, "pr_title": "fix incomplete shutdown", "pr_createdAt": "2020-07-29T09:41:20Z", "pr_url": "https://github.com/bakdata/conquery/pull/1304", "timeline": [{"oid": "79eaaf3058213bca2df73e913710973b603020b0", "url": "https://github.com/bakdata/conquery/commit/79eaaf3058213bca2df73e913710973b603020b0", "message": "adds missing close of jobmanager in worker", "committedDate": "2020-07-29T07:53:16Z", "type": "commit"}, {"oid": "7e991f7fada263ddfbfa63314d5dcd18ab4e1206", "url": "https://github.com/bakdata/conquery/commit/7e991f7fada263ddfbfa63314d5dcd18ab4e1206", "message": "cleanup closing of resources", "committedDate": "2020-07-29T07:54:17Z", "type": "commit"}, {"oid": "7fbb161a15f316696e210c639e5254fac7c174af", "url": "https://github.com/bakdata/conquery/commit/7fbb161a15f316696e210c639e5254fac7c174af", "message": "cleanup worker creation", "committedDate": "2020-07-29T09:32:42Z", "type": "commit"}, {"oid": "c6d8172a8d0adfbeb3c5e8fc75c0b18e9cff87e9", "url": "https://github.com/bakdata/conquery/commit/c6d8172a8d0adfbeb3c5e8fc75c0b18e9cff87e9", "message": "format code", "committedDate": "2020-07-29T09:46:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjg5NzE3MQ==", "url": "https://github.com/bakdata/conquery/pull/1304#discussion_r462897171", "bodyText": "createWorkerName wo ist die Methode definiert?", "author": "awildturtok", "createdAt": "2020-07-30T10:17:06Z", "path": "backend/src/main/java/com/bakdata/conquery/models/messages/network/specific/AddWorker.java", "diffHunk": "@@ -31,18 +29,15 @@ public void react(Slave context) throws Exception {\n \t\tConqueryConfig config = context.getConfig();\n \t\tFile dir = createWorkerName(context);\n \t\tWorkerInformation info = new WorkerInformation();\n-\t\tinfo.setDataset(dataset.getId());\n+\t\tinfo.setDataset(dataset);\n \t\tinfo.setIncludedBuckets(new IntArrayList());\n \t\tinfo.setName(dir.getName());\n-\t\tWorkerStorage workerStorage = new WorkerStorageImpl(context.getValidator(), config.getStorage(), dir);\n-\t\tworkerStorage.loadData();\n-\t\tworkerStorage.updateDataset(dataset);\n \n \n-\t\tWorker worker = context.getWorkers().createWorker(info, workerStorage);\n+\t\tWorker worker = context.getWorkers().createWorker(info, config.getStorage(), createWorkerName(context), context.getValidator());", "originalCommit": "c6d8172a8d0adfbeb3c5e8fc75c0b18e9cff87e9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDIzOTgyMQ==", "url": "https://github.com/bakdata/conquery/pull/1304#discussion_r464239821", "bodyText": "Die ist in Workers definiert", "author": "thoniTUB", "createdAt": "2020-08-03T07:29:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjg5NzE3MQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjg5NzU2NQ==", "url": "https://github.com/bakdata/conquery/pull/1304#discussion_r462897565", "bodyText": "Ui! Das ist ein bug!", "author": "awildturtok", "createdAt": "2020-07-30T10:17:51Z", "path": "backend/src/main/java/com/bakdata/conquery/models/worker/Namespaces.java", "diffHunk": "@@ -88,7 +89,7 @@ public synchronized void register(SlaveInformation slave, WorkerInformation info\n \t\t\tworkers.add(info);\n \t\t}\n \n-\t\tNamespace ns = datasets.get(info.getDataset());\n+\t\tNamespace ns = datasets.get(info.getDataset().getId());", "originalCommit": "c6d8172a8d0adfbeb3c5e8fc75c0b18e9cff87e9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjg5NzYwMg==", "url": "https://github.com/bakdata/conquery/pull/1304#discussion_r462897602", "bodyText": "gewesen", "author": "awildturtok", "createdAt": "2020-07-30T10:17:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjg5NzU2NQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjkwMzM3NA==", "url": "https://github.com/bakdata/conquery/pull/1304#discussion_r462903374", "bodyText": "ist das einfach nur tryLoad umbenannt?", "author": "awildturtok", "createdAt": "2020-07-30T10:29:34Z", "path": "backend/src/main/java/com/bakdata/conquery/models/worker/Worker.java", "diffHunk": "@@ -34,14 +45,42 @@\n \t@Getter\n \tprivate final ExecutorService executorService;\n \t\n-\tpublic Worker(WorkerInformation info, JobManager jobManager, WorkerStorage storage, QueryExecutor queryExecutor, ExecutorService executorService) {\n-\t\tthis.info = info;\n-\t\tthis.jobManager = jobManager;\n-\t\tthis.storage = storage;\n-\t\tthis.executorService = executorService;\n-\t\tBucketManager bucketManager = new BucketManager(jobManager, storage, info);\n-\t\tstorage.setBucketManager(bucketManager);\n-\t\tthis.queryExecutor = queryExecutor;\n+\t\n+\tpublic Worker(\n+\t\t@NonNull ThreadPoolDefinition queryThreadPoolDefinition,\n+\t\t@NonNull ExecutorService executorService,\n+\t\t@NonNull WorkerStorage storage\n+\t\t) {\n+\t\tthis(\n+\t\t\tnew JobManager(storage.getWorker().getName()),\n+\t\t\tstorage,\n+\t\t\tnew QueryExecutor(queryThreadPoolDefinition.createService(\"QueryExecutor %d\")),\n+\t\t\tstorage.getWorker(),\n+\t\t\texecutorService);\n+\t\t\n+\t\tstorage.setBucketManager(new BucketManager(this.jobManager, this.storage, this.info));\n+\t\t\n+\t}\n+\t\n+\tpublic static Worker newWorker(", "originalCommit": "c6d8172a8d0adfbeb3c5e8fc75c0b18e9cff87e9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDI0MTc5NA==", "url": "https://github.com/bakdata/conquery/pull/1304#discussion_r464241794", "bodyText": "Tryload l\u00e4d nur den Storage. Ich benutze es hier aber genau anders rum: um zu checken ob der storage f\u00fcr den neuen Worker noch nicht existier, denn dann ist alles gut.", "author": "thoniTUB", "createdAt": "2020-08-03T07:34:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjkwMzM3NA=="}], "type": "inlineReview", "revised_code": null}]}