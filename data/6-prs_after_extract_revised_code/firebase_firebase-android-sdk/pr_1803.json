{"pr_number": 1803, "pr_title": "Migrate reflective encoder to `FieldDescriptor`.", "pr_createdAt": "2020-07-22T16:04:55Z", "pr_url": "https://github.com/firebase/firebase-android-sdk/pull/1803", "timeline": [{"oid": "a8e77c601fd38ea672a841a3dc560552ffe7c344", "url": "https://github.com/firebase/firebase-android-sdk/commit/a8e77c601fd38ea672a841a3dc560552ffe7c344", "message": "Migrate reflective encoder to `FieldDescriptor`.\n\nThe change also adds support for `@ExtraProperty`s and `@Ignore`.", "committedDate": "2020-07-22T16:04:27Z", "type": "commit"}, {"oid": "d3f2757a702b06676e040562cf2bff6e9e5ba991", "url": "https://github.com/firebase/firebase-android-sdk/commit/d3f2757a702b06676e040562cf2bff6e9e5ba991", "message": "Fix errorprone warnings.", "committedDate": "2020-07-22T16:16:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk3NTUwMA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1803#discussion_r458975500", "bodyText": "wondering what would be the use case of LinkedHashMap?  are we going to assume the decoded json order to be associated with its getter methods?", "author": "James201311", "createdAt": "2020-07-22T17:51:17Z", "path": "encoders/firebase-encoders-reflective/src/main/java/com/google/firebase/encoders/reflective/ReflectiveObjectEncoderProvider.java", "diffHunk": "@@ -63,26 +68,48 @@ public void encode(@Nullable Object obj, @NonNull ObjectEncoderContext ctx) thro\n   @NonNull\n   @Override\n   public <T> ObjectEncoder<T> get(@NonNull Class<T> type) {\n-    Map<String, EncodingDescriptor> fields = new HashMap<>();\n+    Map<FieldDescriptor, EncodingDescriptor> fields = new LinkedHashMap<>();", "originalCommit": "d3f2757a702b06676e040562cf2bff6e9e5ba991", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk4Njg2Mg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1803#discussion_r458986862", "bodyText": "oops, that was not intended. removed", "author": "vkryachko", "createdAt": "2020-07-22T18:09:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk3NTUwMA=="}], "type": "inlineReview", "revised_code": {"commit": "cb7ca841c90c7f23f39ce19dfe976e84ea2339cd", "chunk": "diff --git a/encoders/firebase-encoders-reflective/src/main/java/com/google/firebase/encoders/reflective/ReflectiveObjectEncoderProvider.java b/encoders/firebase-encoders-reflective/src/main/java/com/google/firebase/encoders/reflective/ReflectiveObjectEncoderProvider.java\nindex 5b569edd..e6568700 100644\n--- a/encoders/firebase-encoders-reflective/src/main/java/com/google/firebase/encoders/reflective/ReflectiveObjectEncoderProvider.java\n+++ b/encoders/firebase-encoders-reflective/src/main/java/com/google/firebase/encoders/reflective/ReflectiveObjectEncoderProvider.java\n\n@@ -68,7 +68,7 @@ final class ReflectiveObjectEncoderProvider implements ObjectEncoderProvider {\n   @NonNull\n   @Override\n   public <T> ObjectEncoder<T> get(@NonNull Class<T> type) {\n-    Map<FieldDescriptor, EncodingDescriptor> fields = new LinkedHashMap<>();\n+    Map<FieldDescriptor, EncodingDescriptor> fields = new HashMap<>();\n     for (Method method : type.getMethods()) {\n       if (method.isAnnotationPresent(Encodable.Ignore.class)) {\n         continue;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk3Njc4Mw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1803#discussion_r458976783", "bodyText": "if we have Annotation Processor implemented, should we just check the annotation type is registered? in that case, we may not need ExtraProperty?", "author": "James201311", "createdAt": "2020-07-22T17:53:16Z", "path": "encoders/firebase-encoders-reflective/src/main/java/com/google/firebase/encoders/reflective/ReflectiveObjectEncoderProvider.java", "diffHunk": "@@ -63,26 +68,48 @@ public void encode(@Nullable Object obj, @NonNull ObjectEncoderContext ctx) thro\n   @NonNull\n   @Override\n   public <T> ObjectEncoder<T> get(@NonNull Class<T> type) {\n-    Map<String, EncodingDescriptor> fields = new HashMap<>();\n+    Map<FieldDescriptor, EncodingDescriptor> fields = new LinkedHashMap<>();\n     for (Method method : type.getMethods()) {\n       if (method.isAnnotationPresent(Encodable.Ignore.class)) {\n         continue;\n       }\n \n       Encodable.Field fieldAnnotation = method.getAnnotation(Encodable.Field.class);\n-      String getter = toGetterName(method, fieldAnnotation);\n-      if (getter != null) {\n-        method.setAccessible(true);\n-        fields.put(\n-            getter,\n-            new EncodingDescriptor(fieldAnnotation != null && fieldAnnotation.inline(), method));\n+      FieldDescriptor descriptor = toFieldDescriptor(method, fieldAnnotation);\n+      if (descriptor == null) {\n+        continue;\n       }\n+      method.setAccessible(true);\n+\n+      fields.put(\n+          descriptor,\n+          new EncodingDescriptor(fieldAnnotation != null && fieldAnnotation.inline(), method));\n     }\n     @SuppressWarnings(\"unchecked\")\n     ObjectEncoder<T> encoder = (ObjectEncoder<T>) new ReflectiveObjectEncoderImpl(fields);\n     return encoder;\n   }\n \n+  @Nullable\n+  private static FieldDescriptor toFieldDescriptor(Method method, Encodable.Field fieldAnnotation) {\n+    if (method.getAnnotation(Encodable.Ignore.class) != null) {\n+      return null;\n+    }\n+\n+    String name = toGetterName(method, fieldAnnotation);\n+    if (name == null) {\n+      return null;\n+    }\n+    FieldDescriptor.Builder builder = FieldDescriptor.builder(name);\n+    for (Annotation annotation : method.getAnnotations()) {\n+      if (!annotation.annotationType().isAnnotationPresent(ExtraProperty.class)) {", "originalCommit": "d3f2757a702b06676e040562cf2bff6e9e5ba991", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk4NjY1Mg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1803#discussion_r458986652", "bodyText": "we still need ExtraProperty for the code-gen decoders as at compile time we don't yet know what annotations will be registered at runtime.\nAdditionally, having this encoder implementation make assumptions about the environment it is running it would increase coupling to that environment, not something we want.\nAlso note that this encoder is a singleton and it caches information about types, so it can be run by differently configured encoder contexts.", "author": "vkryachko", "createdAt": "2020-07-22T18:09:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk3Njc4Mw=="}], "type": "inlineReview", "revised_code": {"commit": "cb7ca841c90c7f23f39ce19dfe976e84ea2339cd", "chunk": "diff --git a/encoders/firebase-encoders-reflective/src/main/java/com/google/firebase/encoders/reflective/ReflectiveObjectEncoderProvider.java b/encoders/firebase-encoders-reflective/src/main/java/com/google/firebase/encoders/reflective/ReflectiveObjectEncoderProvider.java\nindex 5b569edd..e6568700 100644\n--- a/encoders/firebase-encoders-reflective/src/main/java/com/google/firebase/encoders/reflective/ReflectiveObjectEncoderProvider.java\n+++ b/encoders/firebase-encoders-reflective/src/main/java/com/google/firebase/encoders/reflective/ReflectiveObjectEncoderProvider.java\n\n@@ -68,7 +68,7 @@ final class ReflectiveObjectEncoderProvider implements ObjectEncoderProvider {\n   @NonNull\n   @Override\n   public <T> ObjectEncoder<T> get(@NonNull Class<T> type) {\n-    Map<FieldDescriptor, EncodingDescriptor> fields = new LinkedHashMap<>();\n+    Map<FieldDescriptor, EncodingDescriptor> fields = new HashMap<>();\n     for (Method method : type.getMethods()) {\n       if (method.isAnnotationPresent(Encodable.Ignore.class)) {\n         continue;\n"}}, {"oid": "cb7ca841c90c7f23f39ce19dfe976e84ea2339cd", "url": "https://github.com/firebase/firebase-android-sdk/commit/cb7ca841c90c7f23f39ce19dfe976e84ea2339cd", "message": "Address comments.", "committedDate": "2020-07-22T18:09:29Z", "type": "commit"}]}