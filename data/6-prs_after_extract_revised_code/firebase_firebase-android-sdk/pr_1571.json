{"pr_number": 1571, "pr_title": "Cache FID to avoid multiple disk reads.", "pr_createdAt": "2020-05-18T23:33:47Z", "pr_url": "https://github.com/firebase/firebase-android-sdk/pull/1571", "timeline": [{"oid": "1d8aa168d4ce54e3c7e4dfe595a3361bdb088d4f", "url": "https://github.com/firebase/firebase-android-sdk/commit/1d8aa168d4ce54e3c7e4dfe595a3361bdb088d4f", "message": "Cache FID to avoid multiple disk reads.", "committedDate": "2020-05-18T23:32:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjk1MDkxMQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1571#discussion_r426950911", "bodyText": "please add a comment here, example:\n/** FID of this FirebaseInstallations instance. Cached after the first successful read from local storage. */", "author": "andirayo", "createdAt": "2020-05-18T23:44:50Z", "path": "firebase-installations/src/main/java/com/google/firebase/installations/FirebaseInstallations.java", "diffHunk": "@@ -68,6 +68,8 @@\n   private final ExecutorService backgroundExecutor;\n   private final ExecutorService networkExecutor;\n \n+  private String cachedFid = null;", "originalCommit": "1d8aa168d4ce54e3c7e4dfe595a3361bdb088d4f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3c974c49849006bf0500283b7bb8bf77ef7f3c5a", "chunk": "diff --git a/firebase-installations/src/main/java/com/google/firebase/installations/FirebaseInstallations.java b/firebase-installations/src/main/java/com/google/firebase/installations/FirebaseInstallations.java\nindex 4f5f69e1..c9c3676f 100644\n--- a/firebase-installations/src/main/java/com/google/firebase/installations/FirebaseInstallations.java\n+++ b/firebase-installations/src/main/java/com/google/firebase/installations/FirebaseInstallations.java\n\n@@ -67,7 +67,8 @@ public class FirebaseInstallations implements FirebaseInstallationsApi {\n   private final Object lock = new Object();\n   private final ExecutorService backgroundExecutor;\n   private final ExecutorService networkExecutor;\n-\n+  /* FID of this Firebase Installations instance. Cached after successfully registering and\n+  persisting the FID locally. NOTE: cachedFid resets if FID is deleted.*/\n   private String cachedFid = null;\n \n   @GuardedBy(\"lock\")\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjk1MTY2OA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1571#discussion_r426951668", "bodyText": "Do this as first line of #doGetId().", "author": "andirayo", "createdAt": "2020-05-18T23:47:28Z", "path": "firebase-installations/src/main/java/com/google/firebase/installations/FirebaseInstallations.java", "diffHunk": "@@ -215,7 +217,11 @@ String getName() {\n   public Task<String> getId() {\n     preConditionChecks();\n     TaskCompletionSource<String> taskCompletionSource = new TaskCompletionSource<>();\n-    taskCompletionSource.trySetResult(doGetId());\n+    if (cachedFid != null) {\n+      taskCompletionSource.trySetResult(cachedFid);\n+    } else {", "originalCommit": "1d8aa168d4ce54e3c7e4dfe595a3361bdb088d4f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3c974c49849006bf0500283b7bb8bf77ef7f3c5a", "chunk": "diff --git a/firebase-installations/src/main/java/com/google/firebase/installations/FirebaseInstallations.java b/firebase-installations/src/main/java/com/google/firebase/installations/FirebaseInstallations.java\nindex 4f5f69e1..c9c3676f 100644\n--- a/firebase-installations/src/main/java/com/google/firebase/installations/FirebaseInstallations.java\n+++ b/firebase-installations/src/main/java/com/google/firebase/installations/FirebaseInstallations.java\n\n@@ -217,11 +218,7 @@ public class FirebaseInstallations implements FirebaseInstallationsApi {\n   public Task<String> getId() {\n     preConditionChecks();\n     TaskCompletionSource<String> taskCompletionSource = new TaskCompletionSource<>();\n-    if (cachedFid != null) {\n-      taskCompletionSource.trySetResult(cachedFid);\n-    } else {\n-      taskCompletionSource.trySetResult(doGetId());\n-    }\n+    taskCompletionSource.trySetResult(doGetId());\n     return taskCompletionSource.getTask();\n   }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjk1MjY0OA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1571#discussion_r426952648", "bodyText": "I recommend to remove this and only set cachedFid when you successfully read from SharedPrefs.\nYour solution is probably better because 1 less read of SharedPrefs, but potentially more error cases.", "author": "andirayo", "createdAt": "2020-05-18T23:50:48Z", "path": "firebase-installations/src/main/java/com/google/firebase/installations/FirebaseInstallations.java", "diffHunk": "@@ -454,6 +460,7 @@ private PersistedInstallationEntry registerFidWithServer(PersistedInstallationEn\n \n     switch (response.getResponseCode()) {\n       case OK:\n+        cachedFid = response.getFid();", "originalCommit": "1d8aa168d4ce54e3c7e4dfe595a3361bdb088d4f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3c974c49849006bf0500283b7bb8bf77ef7f3c5a", "chunk": "diff --git a/firebase-installations/src/main/java/com/google/firebase/installations/FirebaseInstallations.java b/firebase-installations/src/main/java/com/google/firebase/installations/FirebaseInstallations.java\nindex 4f5f69e1..c9c3676f 100644\n--- a/firebase-installations/src/main/java/com/google/firebase/installations/FirebaseInstallations.java\n+++ b/firebase-installations/src/main/java/com/google/firebase/installations/FirebaseInstallations.java\n\n@@ -460,7 +465,6 @@ public class FirebaseInstallations implements FirebaseInstallationsApi {\n \n     switch (response.getResponseCode()) {\n       case OK:\n-        cachedFid = response.getFid();\n         return prefs.withRegisteredFid(\n             response.getFid(),\n             response.getRefreshToken(),\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjk1Mjg3Mg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1571#discussion_r426952872", "bodyText": "I recommend making this the first line of this method.\nThat way, if something goes wrong somewhere we have made sure to clear the cache.\nWorst case we have 1 unnecessary disk read.", "author": "andirayo", "createdAt": "2020-05-18T23:51:38Z", "path": "firebase-installations/src/main/java/com/google/firebase/installations/FirebaseInstallations.java", "diffHunk": "@@ -519,7 +527,7 @@ private Void deleteFirebaseInstallationId() throws FirebaseInstallationsExceptio\n             \"Failed to delete a Firebase Installation.\", Status.BAD_CONFIG);\n       }\n     }\n-\n+    cachedFid = null;", "originalCommit": "1d8aa168d4ce54e3c7e4dfe595a3361bdb088d4f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3c974c49849006bf0500283b7bb8bf77ef7f3c5a", "chunk": "diff --git a/firebase-installations/src/main/java/com/google/firebase/installations/FirebaseInstallations.java b/firebase-installations/src/main/java/com/google/firebase/installations/FirebaseInstallations.java\nindex 4f5f69e1..c9c3676f 100644\n--- a/firebase-installations/src/main/java/com/google/firebase/installations/FirebaseInstallations.java\n+++ b/firebase-installations/src/main/java/com/google/firebase/installations/FirebaseInstallations.java\n\n@@ -527,7 +532,6 @@ public class FirebaseInstallations implements FirebaseInstallationsApi {\n             \"Failed to delete a Firebase Installation.\", Status.BAD_CONFIG);\n       }\n     }\n-    cachedFid = null;\n     insertOrUpdatePrefs(entry.withNoGeneratedFid());\n     return null;\n   }\n"}}, {"oid": "3c974c49849006bf0500283b7bb8bf77ef7f3c5a", "url": "https://github.com/firebase/firebase-android-sdk/commit/3c974c49849006bf0500283b7bb8bf77ef7f3c5a", "message": "Addressing Rayo's comments.", "committedDate": "2020-05-19T17:39:11Z", "type": "commit"}]}