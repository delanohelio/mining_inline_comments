{"pr_number": 2087, "pr_title": "Query get API for RTDB", "pr_createdAt": "2020-10-21T21:17:37Z", "pr_url": "https://github.com/firebase/firebase-android-sdk/pull/2087", "timeline": [{"oid": "0d52495d037b5b2645c7e8b6578a198bd5e6df5c", "url": "https://github.com/firebase/firebase-android-sdk/commit/0d52495d037b5b2645c7e8b6578a198bd5e6df5c", "message": "Implement get for RTDB queries", "committedDate": "2020-10-20T19:23:49Z", "type": "commit"}, {"oid": "7e795724fcdc6dd9703498c02a56e118a533d71d", "url": "https://github.com/firebase/firebase-android-sdk/commit/7e795724fcdc6dd9703498c02a56e118a533d71d", "message": "more get tests", "committedDate": "2020-10-21T18:26:09Z", "type": "commit"}, {"oid": "a0c1f6cd83b291dd0044f22872939c6bb016acdc", "url": "https://github.com/firebase/firebase-android-sdk/commit/a0c1f6cd83b291dd0044f22872939c6bb016acdc", "message": "scheduleNow", "committedDate": "2020-10-23T20:29:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjg3NTI1OQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2087#discussion_r512875259", "bodyText": "Nit: Drop the exclamation mark.\nBut my larger question is why we are offline here. Is this because we kick off going online only after this API call finishes (like we discussed before)?", "author": "schmidt-sebastian", "createdAt": "2020-10-27T17:12:46Z", "path": "firebase-database/src/androidTest/java/com/google/firebase/database/QueryTest.java", "diffHunk": "@@ -3401,6 +3406,101 @@ public void onComplete(DatabaseError error, DatabaseReference ref) {\n     IntegrationTestHelpers.waitFor(semaphore);\n   }\n \n+  @Test\n+  public void emptyQueryGet() throws DatabaseException, InterruptedException {\n+    DatabaseReference node = IntegrationTestHelpers.getRandomNode();\n+    DatabaseConfig cfg = IntegrationTestHelpers.newTestConfig();\n+    final Semaphore semaphore = new Semaphore(0);\n+    node.get()\n+        .addOnCompleteListener(\n+            new OnCompleteListener<DataSnapshot>() {\n+              @Override\n+              public void onComplete(@NonNull Task<DataSnapshot> task) {\n+                assertTrue(task.isSuccessful());\n+                assertNotNull(task.getException());\n+                assertEquals(task.getException().getMessage(), \"Client offline with empty cache!\");", "originalCommit": "a0c1f6cd83b291dd0044f22872939c6bb016acdc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE1MDExMQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2087#discussion_r516150111", "bodyText": "That is a mistake, this test should never be offline.", "author": "IanWyszynski", "createdAt": "2020-11-02T17:45:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjg3NTI1OQ=="}], "type": "inlineReview", "revised_code": {"commit": "9ffee19e584396034ba26c682622655eb40b00cc", "chunk": "diff --git a/firebase-database/src/androidTest/java/com/google/firebase/database/QueryTest.java b/firebase-database/src/androidTest/java/com/google/firebase/database/QueryTest.java\nindex bfc66d0c..516ca8ad 100644\n--- a/firebase-database/src/androidTest/java/com/google/firebase/database/QueryTest.java\n+++ b/firebase-database/src/androidTest/java/com/google/firebase/database/QueryTest.java\n\n@@ -3406,99 +3408,170 @@ public class QueryTest {\n     IntegrationTestHelpers.waitFor(semaphore);\n   }\n \n+  private static FirebaseApp appForDatabaseUrl(String url, String name) {\n+    return FirebaseApp.initializeApp(\n+        InstrumentationRegistry.getInstrumentation().getTargetContext(),\n+        new FirebaseOptions.Builder()\n+            .setApplicationId(\"appid\")\n+            .setApiKey(\"apikey\")\n+            .setDatabaseUrl(url)\n+            .build(),\n+        name);\n+  }\n+\n   @Test\n   public void emptyQueryGet() throws DatabaseException, InterruptedException {\n-    DatabaseReference node = IntegrationTestHelpers.getRandomNode();\n-    DatabaseConfig cfg = IntegrationTestHelpers.newTestConfig();\n-    final Semaphore semaphore = new Semaphore(0);\n-    node.get()\n-        .addOnCompleteListener(\n-            new OnCompleteListener<DataSnapshot>() {\n-              @Override\n-              public void onComplete(@NonNull Task<DataSnapshot> task) {\n-                assertTrue(task.isSuccessful());\n-                assertNotNull(task.getException());\n-                assertEquals(task.getException().getMessage(), \"Client offline with empty cache!\");\n-                semaphore.release();\n-              }\n-            });\n-    IntegrationTestHelpers.waitFor(semaphore);\n+    FirebaseApp app =\n+        appForDatabaseUrl(IntegrationTestValues.getAltNamespace(), UUID.randomUUID().toString());\n+    FirebaseDatabase db = FirebaseDatabase.getInstance(app);\n+    db.useEmulator(\"10.0.2.2\", 9000);\n+    DatabaseReference node = db.getReference();\n+    try {\n+      Tasks.await(node.get());\n+    } catch (ExecutionException e) {\n+      assertEquals(e.getCause().getMessage(), \"Client is offline\");\n+      return;\n+    }\n+    fail();\n   }\n \n   @Test\n-  public void offlineQueryGet() throws DatabaseException {\n+  public void offlineQueryGet() throws DatabaseException, InterruptedException {\n+    FirebaseApp app =\n+        appForDatabaseUrl(IntegrationTestValues.getAltNamespace(), UUID.randomUUID().toString());\n+    FirebaseDatabase db = FirebaseDatabase.getInstance(app);\n+    db.useEmulator(\"10.0.2.2\", 9000);\n+    DatabaseReference node = db.getReference();\n     DatabaseConfig cfg = IntegrationTestHelpers.newTestConfig();\n     IntegrationTestHelpers.goOffline(cfg);\n-    DatabaseReference node = IntegrationTestHelpers.getRandomNode();\n-    node.get()\n-        .addOnCompleteListener(\n-            new OnCompleteListener<DataSnapshot>() {\n-              @Override\n-              public void onComplete(@NonNull Task<DataSnapshot> task) {\n-                Log.d(\"QueryTest\", \"offlineQueryGet onCompleteListener running.\");\n-                assertFalse(task.isSuccessful());\n-                assertNotNull(task.getException());\n-                assertEquals(task.getException().getMessage(), \"Client offline with empty cache!\");\n-              }\n-            });\n+    try {\n+      Tasks.await(node.get());\n+    } catch (ExecutionException e) {\n+      assertEquals(e.getCause().getMessage(), \"Client is offline\");\n+      return;\n+    }\n+    fail();\n   }\n \n   @Test\n   public void getQueryBasic() throws DatabaseException, InterruptedException {\n-    DatabaseReference ref = IntegrationTestHelpers.getRandomNode();\n+    FirebaseApp app =\n+        appForDatabaseUrl(IntegrationTestValues.getAltNamespace(), UUID.randomUUID().toString());\n+    FirebaseDatabase db = FirebaseDatabase.getInstance(app);\n+    db.useEmulator(\"10.0.2.2\", 9000);\n+    DatabaseReference node = db.getReference();\n     final Semaphore semaphore = new Semaphore(0);\n-    ref.setValue(42)\n-        .continueWithTask(\n-            new Continuation<Void, Task<DataSnapshot>>() {\n-              @Override\n-              public Task<DataSnapshot> then(@NonNull Task<Void> task) throws Exception {\n-                assertTrue(task.isSuccessful());\n-                return ref.get()\n-                    .addOnCompleteListener(\n-                        new OnCompleteListener<DataSnapshot>() {\n-                          @Override\n-                          public void onComplete(@NonNull Task<DataSnapshot> task) {\n-                            assertTrue(task.isSuccessful());\n-                            DataSnapshot snap = task.getResult();\n-                            assertNotNull(snap);\n-                            assertEquals(42, snap.getValue());\n-                            semaphore.release();\n-                          }\n-                        });\n-              }\n-            });\n-    IntegrationTestHelpers.waitFor(semaphore);\n+    try {\n+      Tasks.await(node.setValue(42));\n+      assertEquals(42L, Tasks.await(node.get()).getValue());\n+    } catch (ExecutionException e) {\n+      fail();\n+    }\n   }\n \n   @Test\n   public void getQueryCached()\n       throws DatabaseException, InterruptedException, TimeoutException, TestFailure {\n-    DatabaseReference ref = IntegrationTestHelpers.getRandomNode();\n+    FirebaseApp app =\n+        appForDatabaseUrl(IntegrationTestValues.getAltNamespace(), UUID.randomUUID().toString());\n+    FirebaseDatabase db = FirebaseDatabase.getInstance(app);\n+    db.useEmulator(\"10.0.2.2\", 9000);\n+    DatabaseReference ref = db.getReference();\n     DatabaseConfig cfg = IntegrationTestHelpers.newTestConfig();\n     ReadFuture future = ReadFuture.untilNonNull(ref);\n     ref.setValue(42);\n-    assertEquals(42, future.waitForLastValue());\n+    assertEquals(42L, future.waitForLastValue());\n     IntegrationTestHelpers.goOffline(cfg);\n+    try {\n+      assertEquals(42L, Tasks.await(ref.get()).getValue());\n+    } catch (ExecutionException e) {\n+      fail();\n+    }\n+  }\n+\n+  @Test\n+  public void getQueryHitsCacheWhenOffline()\n+      throws InterruptedException, ExecutionException, TimeoutException, TestFailure {\n+    FirebaseApp readerApp =\n+        appForDatabaseUrl(IntegrationTestValues.getNamespace(), UUID.randomUUID().toString());\n+    FirebaseApp writerApp =\n+        appForDatabaseUrl(IntegrationTestValues.getNamespace(), UUID.randomUUID().toString());\n+    FirebaseDatabase readerDb = FirebaseDatabase.getInstance(readerApp);\n+    FirebaseDatabase writerDb = FirebaseDatabase.getInstance(writerApp);\n+    readerDb.useEmulator(\"10.0.2.2\", 9000);\n+    writerDb.useEmulator(\"10.0.2.2\", 9000);\n+    DatabaseReference reader = readerDb.getReference(\"/foo\");\n+    DatabaseReference writer = writerDb.getReference(\"/foo\");\n+\n+    WriteFuture write = new WriteFuture(writer, 42L);\n+    assertNull(write.timedGet());\n+\n     final Semaphore semaphore = new Semaphore(0);\n-    ref.get()\n-        .addOnCompleteListener(\n-            new OnCompleteListener<DataSnapshot>() {\n-              @Override\n-              public void onComplete(@NonNull Task<DataSnapshot> task) {\n-                assertTrue(task.isSuccessful());\n-                DataSnapshot snapshot = task.getResult();\n-                assertNotNull(snapshot);\n-                assertEquals(42, snapshot.getValue());\n-                semaphore.release();\n-              }\n-            });\n+    reader.addValueEventListener(\n+        new ValueEventListener() {\n+          @Override\n+          public void onDataChange(@NonNull DataSnapshot snapshot) {\n+            if (Objects.requireNonNull(snapshot.getValue()).equals(42L)) {\n+              semaphore.release();\n+            }\n+          }\n+\n+          @Override\n+          public void onCancelled(@NonNull DatabaseError error) {}\n+        });\n     IntegrationTestHelpers.waitFor(semaphore);\n+    reader.getDatabase().goOffline();\n+    try {\n+      DataSnapshot snapshot = Tasks.await(reader.get());\n+      assertEquals(42L, snapshot.getValue());\n+    } catch (ExecutionException e) {\n+      fail();\n+    }\n   }\n \n   @Test\n-  public void getQuerySkipsCache() throws DatabaseException {\n-    DatabaseReference ref = IntegrationTestHelpers.getRandomNode();\n-    DatabaseConfig cfg = IntegrationTestHelpers.newTestConfig();\n+  public void getQuerySkipsCacheWhenOnline()\n+      throws DatabaseException, InterruptedException, ExecutionException, TestFailure,\n+          TimeoutException {\n+    FirebaseApp readerApp =\n+        appForDatabaseUrl(IntegrationTestValues.getNamespace(), UUID.randomUUID().toString());\n+    FirebaseApp writerApp =\n+        appForDatabaseUrl(IntegrationTestValues.getNamespace(), UUID.randomUUID().toString());\n+    FirebaseDatabase readerDb = FirebaseDatabase.getInstance(readerApp);\n+    FirebaseDatabase writerDb = FirebaseDatabase.getInstance(writerApp);\n+    readerDb.useEmulator(\"10.0.2.2\", 9000);\n+    writerDb.useEmulator(\"10.0.2.2\", 9000);\n+    DatabaseReference reader = readerDb.getReference();\n+    DatabaseReference writer = writerDb.getReference();\n+\n+    reader.addValueEventListener(\n+        new ValueEventListener() {\n+          @Override\n+          public void onDataChange(@NonNull DataSnapshot snapshot) {}\n+\n+          @Override\n+          public void onCancelled(@NonNull DatabaseError error) {}\n+        });\n+\n+    WriteFuture write = new WriteFuture(writer, 42L);\n+    assertNull(write.timedGet());\n+\n+    final Semaphore semaphore = new Semaphore(0);\n+\n+    try {\n+      assertEquals(42L, Tasks.await(reader.get()).getValue());\n+    } catch (ExecutionException e) {\n+      fail();\n+    }\n+\n+    write = new WriteFuture(writer, 43L);\n+    assertNull(write.timedGet());\n+\n+    try {\n+      assertEquals(43L, Tasks.await(reader.get()).getValue());\n+    } catch (ExecutionException e) {\n+      fail();\n+    }\n   }\n \n   @Test\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjg3NjY1NA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2087#discussion_r512876654", "bodyText": "FWIW, you can just do:\ntry {\nDataSnapshot snap = node.get().get();\nfail(...);\n} catch (ExcecutionException e) {\n...\n}\n\nOptional... especially since I just remembered that this might not work since it may block the UI thread that is running the test.", "author": "schmidt-sebastian", "createdAt": "2020-10-27T17:14:49Z", "path": "firebase-database/src/androidTest/java/com/google/firebase/database/QueryTest.java", "diffHunk": "@@ -3401,6 +3406,101 @@ public void onComplete(DatabaseError error, DatabaseReference ref) {\n     IntegrationTestHelpers.waitFor(semaphore);\n   }\n \n+  @Test\n+  public void emptyQueryGet() throws DatabaseException, InterruptedException {\n+    DatabaseReference node = IntegrationTestHelpers.getRandomNode();\n+    DatabaseConfig cfg = IntegrationTestHelpers.newTestConfig();\n+    final Semaphore semaphore = new Semaphore(0);\n+    node.get()", "originalCommit": "a0c1f6cd83b291dd0044f22872939c6bb016acdc", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9ffee19e584396034ba26c682622655eb40b00cc", "chunk": "diff --git a/firebase-database/src/androidTest/java/com/google/firebase/database/QueryTest.java b/firebase-database/src/androidTest/java/com/google/firebase/database/QueryTest.java\nindex bfc66d0c..516ca8ad 100644\n--- a/firebase-database/src/androidTest/java/com/google/firebase/database/QueryTest.java\n+++ b/firebase-database/src/androidTest/java/com/google/firebase/database/QueryTest.java\n\n@@ -3406,99 +3408,170 @@ public class QueryTest {\n     IntegrationTestHelpers.waitFor(semaphore);\n   }\n \n+  private static FirebaseApp appForDatabaseUrl(String url, String name) {\n+    return FirebaseApp.initializeApp(\n+        InstrumentationRegistry.getInstrumentation().getTargetContext(),\n+        new FirebaseOptions.Builder()\n+            .setApplicationId(\"appid\")\n+            .setApiKey(\"apikey\")\n+            .setDatabaseUrl(url)\n+            .build(),\n+        name);\n+  }\n+\n   @Test\n   public void emptyQueryGet() throws DatabaseException, InterruptedException {\n-    DatabaseReference node = IntegrationTestHelpers.getRandomNode();\n-    DatabaseConfig cfg = IntegrationTestHelpers.newTestConfig();\n-    final Semaphore semaphore = new Semaphore(0);\n-    node.get()\n-        .addOnCompleteListener(\n-            new OnCompleteListener<DataSnapshot>() {\n-              @Override\n-              public void onComplete(@NonNull Task<DataSnapshot> task) {\n-                assertTrue(task.isSuccessful());\n-                assertNotNull(task.getException());\n-                assertEquals(task.getException().getMessage(), \"Client offline with empty cache!\");\n-                semaphore.release();\n-              }\n-            });\n-    IntegrationTestHelpers.waitFor(semaphore);\n+    FirebaseApp app =\n+        appForDatabaseUrl(IntegrationTestValues.getAltNamespace(), UUID.randomUUID().toString());\n+    FirebaseDatabase db = FirebaseDatabase.getInstance(app);\n+    db.useEmulator(\"10.0.2.2\", 9000);\n+    DatabaseReference node = db.getReference();\n+    try {\n+      Tasks.await(node.get());\n+    } catch (ExecutionException e) {\n+      assertEquals(e.getCause().getMessage(), \"Client is offline\");\n+      return;\n+    }\n+    fail();\n   }\n \n   @Test\n-  public void offlineQueryGet() throws DatabaseException {\n+  public void offlineQueryGet() throws DatabaseException, InterruptedException {\n+    FirebaseApp app =\n+        appForDatabaseUrl(IntegrationTestValues.getAltNamespace(), UUID.randomUUID().toString());\n+    FirebaseDatabase db = FirebaseDatabase.getInstance(app);\n+    db.useEmulator(\"10.0.2.2\", 9000);\n+    DatabaseReference node = db.getReference();\n     DatabaseConfig cfg = IntegrationTestHelpers.newTestConfig();\n     IntegrationTestHelpers.goOffline(cfg);\n-    DatabaseReference node = IntegrationTestHelpers.getRandomNode();\n-    node.get()\n-        .addOnCompleteListener(\n-            new OnCompleteListener<DataSnapshot>() {\n-              @Override\n-              public void onComplete(@NonNull Task<DataSnapshot> task) {\n-                Log.d(\"QueryTest\", \"offlineQueryGet onCompleteListener running.\");\n-                assertFalse(task.isSuccessful());\n-                assertNotNull(task.getException());\n-                assertEquals(task.getException().getMessage(), \"Client offline with empty cache!\");\n-              }\n-            });\n+    try {\n+      Tasks.await(node.get());\n+    } catch (ExecutionException e) {\n+      assertEquals(e.getCause().getMessage(), \"Client is offline\");\n+      return;\n+    }\n+    fail();\n   }\n \n   @Test\n   public void getQueryBasic() throws DatabaseException, InterruptedException {\n-    DatabaseReference ref = IntegrationTestHelpers.getRandomNode();\n+    FirebaseApp app =\n+        appForDatabaseUrl(IntegrationTestValues.getAltNamespace(), UUID.randomUUID().toString());\n+    FirebaseDatabase db = FirebaseDatabase.getInstance(app);\n+    db.useEmulator(\"10.0.2.2\", 9000);\n+    DatabaseReference node = db.getReference();\n     final Semaphore semaphore = new Semaphore(0);\n-    ref.setValue(42)\n-        .continueWithTask(\n-            new Continuation<Void, Task<DataSnapshot>>() {\n-              @Override\n-              public Task<DataSnapshot> then(@NonNull Task<Void> task) throws Exception {\n-                assertTrue(task.isSuccessful());\n-                return ref.get()\n-                    .addOnCompleteListener(\n-                        new OnCompleteListener<DataSnapshot>() {\n-                          @Override\n-                          public void onComplete(@NonNull Task<DataSnapshot> task) {\n-                            assertTrue(task.isSuccessful());\n-                            DataSnapshot snap = task.getResult();\n-                            assertNotNull(snap);\n-                            assertEquals(42, snap.getValue());\n-                            semaphore.release();\n-                          }\n-                        });\n-              }\n-            });\n-    IntegrationTestHelpers.waitFor(semaphore);\n+    try {\n+      Tasks.await(node.setValue(42));\n+      assertEquals(42L, Tasks.await(node.get()).getValue());\n+    } catch (ExecutionException e) {\n+      fail();\n+    }\n   }\n \n   @Test\n   public void getQueryCached()\n       throws DatabaseException, InterruptedException, TimeoutException, TestFailure {\n-    DatabaseReference ref = IntegrationTestHelpers.getRandomNode();\n+    FirebaseApp app =\n+        appForDatabaseUrl(IntegrationTestValues.getAltNamespace(), UUID.randomUUID().toString());\n+    FirebaseDatabase db = FirebaseDatabase.getInstance(app);\n+    db.useEmulator(\"10.0.2.2\", 9000);\n+    DatabaseReference ref = db.getReference();\n     DatabaseConfig cfg = IntegrationTestHelpers.newTestConfig();\n     ReadFuture future = ReadFuture.untilNonNull(ref);\n     ref.setValue(42);\n-    assertEquals(42, future.waitForLastValue());\n+    assertEquals(42L, future.waitForLastValue());\n     IntegrationTestHelpers.goOffline(cfg);\n+    try {\n+      assertEquals(42L, Tasks.await(ref.get()).getValue());\n+    } catch (ExecutionException e) {\n+      fail();\n+    }\n+  }\n+\n+  @Test\n+  public void getQueryHitsCacheWhenOffline()\n+      throws InterruptedException, ExecutionException, TimeoutException, TestFailure {\n+    FirebaseApp readerApp =\n+        appForDatabaseUrl(IntegrationTestValues.getNamespace(), UUID.randomUUID().toString());\n+    FirebaseApp writerApp =\n+        appForDatabaseUrl(IntegrationTestValues.getNamespace(), UUID.randomUUID().toString());\n+    FirebaseDatabase readerDb = FirebaseDatabase.getInstance(readerApp);\n+    FirebaseDatabase writerDb = FirebaseDatabase.getInstance(writerApp);\n+    readerDb.useEmulator(\"10.0.2.2\", 9000);\n+    writerDb.useEmulator(\"10.0.2.2\", 9000);\n+    DatabaseReference reader = readerDb.getReference(\"/foo\");\n+    DatabaseReference writer = writerDb.getReference(\"/foo\");\n+\n+    WriteFuture write = new WriteFuture(writer, 42L);\n+    assertNull(write.timedGet());\n+\n     final Semaphore semaphore = new Semaphore(0);\n-    ref.get()\n-        .addOnCompleteListener(\n-            new OnCompleteListener<DataSnapshot>() {\n-              @Override\n-              public void onComplete(@NonNull Task<DataSnapshot> task) {\n-                assertTrue(task.isSuccessful());\n-                DataSnapshot snapshot = task.getResult();\n-                assertNotNull(snapshot);\n-                assertEquals(42, snapshot.getValue());\n-                semaphore.release();\n-              }\n-            });\n+    reader.addValueEventListener(\n+        new ValueEventListener() {\n+          @Override\n+          public void onDataChange(@NonNull DataSnapshot snapshot) {\n+            if (Objects.requireNonNull(snapshot.getValue()).equals(42L)) {\n+              semaphore.release();\n+            }\n+          }\n+\n+          @Override\n+          public void onCancelled(@NonNull DatabaseError error) {}\n+        });\n     IntegrationTestHelpers.waitFor(semaphore);\n+    reader.getDatabase().goOffline();\n+    try {\n+      DataSnapshot snapshot = Tasks.await(reader.get());\n+      assertEquals(42L, snapshot.getValue());\n+    } catch (ExecutionException e) {\n+      fail();\n+    }\n   }\n \n   @Test\n-  public void getQuerySkipsCache() throws DatabaseException {\n-    DatabaseReference ref = IntegrationTestHelpers.getRandomNode();\n-    DatabaseConfig cfg = IntegrationTestHelpers.newTestConfig();\n+  public void getQuerySkipsCacheWhenOnline()\n+      throws DatabaseException, InterruptedException, ExecutionException, TestFailure,\n+          TimeoutException {\n+    FirebaseApp readerApp =\n+        appForDatabaseUrl(IntegrationTestValues.getNamespace(), UUID.randomUUID().toString());\n+    FirebaseApp writerApp =\n+        appForDatabaseUrl(IntegrationTestValues.getNamespace(), UUID.randomUUID().toString());\n+    FirebaseDatabase readerDb = FirebaseDatabase.getInstance(readerApp);\n+    FirebaseDatabase writerDb = FirebaseDatabase.getInstance(writerApp);\n+    readerDb.useEmulator(\"10.0.2.2\", 9000);\n+    writerDb.useEmulator(\"10.0.2.2\", 9000);\n+    DatabaseReference reader = readerDb.getReference();\n+    DatabaseReference writer = writerDb.getReference();\n+\n+    reader.addValueEventListener(\n+        new ValueEventListener() {\n+          @Override\n+          public void onDataChange(@NonNull DataSnapshot snapshot) {}\n+\n+          @Override\n+          public void onCancelled(@NonNull DatabaseError error) {}\n+        });\n+\n+    WriteFuture write = new WriteFuture(writer, 42L);\n+    assertNull(write.timedGet());\n+\n+    final Semaphore semaphore = new Semaphore(0);\n+\n+    try {\n+      assertEquals(42L, Tasks.await(reader.get()).getValue());\n+    } catch (ExecutionException e) {\n+      fail();\n+    }\n+\n+    write = new WriteFuture(writer, 43L);\n+    assertNull(write.timedGet());\n+\n+    try {\n+      assertEquals(43L, Tasks.await(reader.get()).getValue());\n+    } catch (ExecutionException e) {\n+      fail();\n+    }\n   }\n \n   @Test\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjg3OTQ3Mw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2087#discussion_r512879473", "bodyText": "If calling .get() works for these tests, this could be as simple as\nref.setValue(42).get() followed by ref.get().get().", "author": "schmidt-sebastian", "createdAt": "2020-10-27T17:19:03Z", "path": "firebase-database/src/androidTest/java/com/google/firebase/database/QueryTest.java", "diffHunk": "@@ -3401,6 +3406,101 @@ public void onComplete(DatabaseError error, DatabaseReference ref) {\n     IntegrationTestHelpers.waitFor(semaphore);\n   }\n \n+  @Test\n+  public void emptyQueryGet() throws DatabaseException, InterruptedException {\n+    DatabaseReference node = IntegrationTestHelpers.getRandomNode();\n+    DatabaseConfig cfg = IntegrationTestHelpers.newTestConfig();\n+    final Semaphore semaphore = new Semaphore(0);\n+    node.get()\n+        .addOnCompleteListener(\n+            new OnCompleteListener<DataSnapshot>() {\n+              @Override\n+              public void onComplete(@NonNull Task<DataSnapshot> task) {\n+                assertTrue(task.isSuccessful());\n+                assertNotNull(task.getException());\n+                assertEquals(task.getException().getMessage(), \"Client offline with empty cache!\");\n+                semaphore.release();\n+              }\n+            });\n+    IntegrationTestHelpers.waitFor(semaphore);\n+  }\n+\n+  @Test\n+  public void offlineQueryGet() throws DatabaseException {\n+    DatabaseConfig cfg = IntegrationTestHelpers.newTestConfig();\n+    IntegrationTestHelpers.goOffline(cfg);\n+    DatabaseReference node = IntegrationTestHelpers.getRandomNode();\n+    node.get()\n+        .addOnCompleteListener(\n+            new OnCompleteListener<DataSnapshot>() {\n+              @Override\n+              public void onComplete(@NonNull Task<DataSnapshot> task) {\n+                Log.d(\"QueryTest\", \"offlineQueryGet onCompleteListener running.\");\n+                assertFalse(task.isSuccessful());\n+                assertNotNull(task.getException());\n+                assertEquals(task.getException().getMessage(), \"Client offline with empty cache!\");\n+              }\n+            });\n+  }\n+\n+  @Test\n+  public void getQueryBasic() throws DatabaseException, InterruptedException {\n+    DatabaseReference ref = IntegrationTestHelpers.getRandomNode();\n+    final Semaphore semaphore = new Semaphore(0);\n+    ref.setValue(42)", "originalCommit": "a0c1f6cd83b291dd0044f22872939c6bb016acdc", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9ffee19e584396034ba26c682622655eb40b00cc", "chunk": "diff --git a/firebase-database/src/androidTest/java/com/google/firebase/database/QueryTest.java b/firebase-database/src/androidTest/java/com/google/firebase/database/QueryTest.java\nindex bfc66d0c..516ca8ad 100644\n--- a/firebase-database/src/androidTest/java/com/google/firebase/database/QueryTest.java\n+++ b/firebase-database/src/androidTest/java/com/google/firebase/database/QueryTest.java\n\n@@ -3406,99 +3408,170 @@ public class QueryTest {\n     IntegrationTestHelpers.waitFor(semaphore);\n   }\n \n+  private static FirebaseApp appForDatabaseUrl(String url, String name) {\n+    return FirebaseApp.initializeApp(\n+        InstrumentationRegistry.getInstrumentation().getTargetContext(),\n+        new FirebaseOptions.Builder()\n+            .setApplicationId(\"appid\")\n+            .setApiKey(\"apikey\")\n+            .setDatabaseUrl(url)\n+            .build(),\n+        name);\n+  }\n+\n   @Test\n   public void emptyQueryGet() throws DatabaseException, InterruptedException {\n-    DatabaseReference node = IntegrationTestHelpers.getRandomNode();\n-    DatabaseConfig cfg = IntegrationTestHelpers.newTestConfig();\n-    final Semaphore semaphore = new Semaphore(0);\n-    node.get()\n-        .addOnCompleteListener(\n-            new OnCompleteListener<DataSnapshot>() {\n-              @Override\n-              public void onComplete(@NonNull Task<DataSnapshot> task) {\n-                assertTrue(task.isSuccessful());\n-                assertNotNull(task.getException());\n-                assertEquals(task.getException().getMessage(), \"Client offline with empty cache!\");\n-                semaphore.release();\n-              }\n-            });\n-    IntegrationTestHelpers.waitFor(semaphore);\n+    FirebaseApp app =\n+        appForDatabaseUrl(IntegrationTestValues.getAltNamespace(), UUID.randomUUID().toString());\n+    FirebaseDatabase db = FirebaseDatabase.getInstance(app);\n+    db.useEmulator(\"10.0.2.2\", 9000);\n+    DatabaseReference node = db.getReference();\n+    try {\n+      Tasks.await(node.get());\n+    } catch (ExecutionException e) {\n+      assertEquals(e.getCause().getMessage(), \"Client is offline\");\n+      return;\n+    }\n+    fail();\n   }\n \n   @Test\n-  public void offlineQueryGet() throws DatabaseException {\n+  public void offlineQueryGet() throws DatabaseException, InterruptedException {\n+    FirebaseApp app =\n+        appForDatabaseUrl(IntegrationTestValues.getAltNamespace(), UUID.randomUUID().toString());\n+    FirebaseDatabase db = FirebaseDatabase.getInstance(app);\n+    db.useEmulator(\"10.0.2.2\", 9000);\n+    DatabaseReference node = db.getReference();\n     DatabaseConfig cfg = IntegrationTestHelpers.newTestConfig();\n     IntegrationTestHelpers.goOffline(cfg);\n-    DatabaseReference node = IntegrationTestHelpers.getRandomNode();\n-    node.get()\n-        .addOnCompleteListener(\n-            new OnCompleteListener<DataSnapshot>() {\n-              @Override\n-              public void onComplete(@NonNull Task<DataSnapshot> task) {\n-                Log.d(\"QueryTest\", \"offlineQueryGet onCompleteListener running.\");\n-                assertFalse(task.isSuccessful());\n-                assertNotNull(task.getException());\n-                assertEquals(task.getException().getMessage(), \"Client offline with empty cache!\");\n-              }\n-            });\n+    try {\n+      Tasks.await(node.get());\n+    } catch (ExecutionException e) {\n+      assertEquals(e.getCause().getMessage(), \"Client is offline\");\n+      return;\n+    }\n+    fail();\n   }\n \n   @Test\n   public void getQueryBasic() throws DatabaseException, InterruptedException {\n-    DatabaseReference ref = IntegrationTestHelpers.getRandomNode();\n+    FirebaseApp app =\n+        appForDatabaseUrl(IntegrationTestValues.getAltNamespace(), UUID.randomUUID().toString());\n+    FirebaseDatabase db = FirebaseDatabase.getInstance(app);\n+    db.useEmulator(\"10.0.2.2\", 9000);\n+    DatabaseReference node = db.getReference();\n     final Semaphore semaphore = new Semaphore(0);\n-    ref.setValue(42)\n-        .continueWithTask(\n-            new Continuation<Void, Task<DataSnapshot>>() {\n-              @Override\n-              public Task<DataSnapshot> then(@NonNull Task<Void> task) throws Exception {\n-                assertTrue(task.isSuccessful());\n-                return ref.get()\n-                    .addOnCompleteListener(\n-                        new OnCompleteListener<DataSnapshot>() {\n-                          @Override\n-                          public void onComplete(@NonNull Task<DataSnapshot> task) {\n-                            assertTrue(task.isSuccessful());\n-                            DataSnapshot snap = task.getResult();\n-                            assertNotNull(snap);\n-                            assertEquals(42, snap.getValue());\n-                            semaphore.release();\n-                          }\n-                        });\n-              }\n-            });\n-    IntegrationTestHelpers.waitFor(semaphore);\n+    try {\n+      Tasks.await(node.setValue(42));\n+      assertEquals(42L, Tasks.await(node.get()).getValue());\n+    } catch (ExecutionException e) {\n+      fail();\n+    }\n   }\n \n   @Test\n   public void getQueryCached()\n       throws DatabaseException, InterruptedException, TimeoutException, TestFailure {\n-    DatabaseReference ref = IntegrationTestHelpers.getRandomNode();\n+    FirebaseApp app =\n+        appForDatabaseUrl(IntegrationTestValues.getAltNamespace(), UUID.randomUUID().toString());\n+    FirebaseDatabase db = FirebaseDatabase.getInstance(app);\n+    db.useEmulator(\"10.0.2.2\", 9000);\n+    DatabaseReference ref = db.getReference();\n     DatabaseConfig cfg = IntegrationTestHelpers.newTestConfig();\n     ReadFuture future = ReadFuture.untilNonNull(ref);\n     ref.setValue(42);\n-    assertEquals(42, future.waitForLastValue());\n+    assertEquals(42L, future.waitForLastValue());\n     IntegrationTestHelpers.goOffline(cfg);\n+    try {\n+      assertEquals(42L, Tasks.await(ref.get()).getValue());\n+    } catch (ExecutionException e) {\n+      fail();\n+    }\n+  }\n+\n+  @Test\n+  public void getQueryHitsCacheWhenOffline()\n+      throws InterruptedException, ExecutionException, TimeoutException, TestFailure {\n+    FirebaseApp readerApp =\n+        appForDatabaseUrl(IntegrationTestValues.getNamespace(), UUID.randomUUID().toString());\n+    FirebaseApp writerApp =\n+        appForDatabaseUrl(IntegrationTestValues.getNamespace(), UUID.randomUUID().toString());\n+    FirebaseDatabase readerDb = FirebaseDatabase.getInstance(readerApp);\n+    FirebaseDatabase writerDb = FirebaseDatabase.getInstance(writerApp);\n+    readerDb.useEmulator(\"10.0.2.2\", 9000);\n+    writerDb.useEmulator(\"10.0.2.2\", 9000);\n+    DatabaseReference reader = readerDb.getReference(\"/foo\");\n+    DatabaseReference writer = writerDb.getReference(\"/foo\");\n+\n+    WriteFuture write = new WriteFuture(writer, 42L);\n+    assertNull(write.timedGet());\n+\n     final Semaphore semaphore = new Semaphore(0);\n-    ref.get()\n-        .addOnCompleteListener(\n-            new OnCompleteListener<DataSnapshot>() {\n-              @Override\n-              public void onComplete(@NonNull Task<DataSnapshot> task) {\n-                assertTrue(task.isSuccessful());\n-                DataSnapshot snapshot = task.getResult();\n-                assertNotNull(snapshot);\n-                assertEquals(42, snapshot.getValue());\n-                semaphore.release();\n-              }\n-            });\n+    reader.addValueEventListener(\n+        new ValueEventListener() {\n+          @Override\n+          public void onDataChange(@NonNull DataSnapshot snapshot) {\n+            if (Objects.requireNonNull(snapshot.getValue()).equals(42L)) {\n+              semaphore.release();\n+            }\n+          }\n+\n+          @Override\n+          public void onCancelled(@NonNull DatabaseError error) {}\n+        });\n     IntegrationTestHelpers.waitFor(semaphore);\n+    reader.getDatabase().goOffline();\n+    try {\n+      DataSnapshot snapshot = Tasks.await(reader.get());\n+      assertEquals(42L, snapshot.getValue());\n+    } catch (ExecutionException e) {\n+      fail();\n+    }\n   }\n \n   @Test\n-  public void getQuerySkipsCache() throws DatabaseException {\n-    DatabaseReference ref = IntegrationTestHelpers.getRandomNode();\n-    DatabaseConfig cfg = IntegrationTestHelpers.newTestConfig();\n+  public void getQuerySkipsCacheWhenOnline()\n+      throws DatabaseException, InterruptedException, ExecutionException, TestFailure,\n+          TimeoutException {\n+    FirebaseApp readerApp =\n+        appForDatabaseUrl(IntegrationTestValues.getNamespace(), UUID.randomUUID().toString());\n+    FirebaseApp writerApp =\n+        appForDatabaseUrl(IntegrationTestValues.getNamespace(), UUID.randomUUID().toString());\n+    FirebaseDatabase readerDb = FirebaseDatabase.getInstance(readerApp);\n+    FirebaseDatabase writerDb = FirebaseDatabase.getInstance(writerApp);\n+    readerDb.useEmulator(\"10.0.2.2\", 9000);\n+    writerDb.useEmulator(\"10.0.2.2\", 9000);\n+    DatabaseReference reader = readerDb.getReference();\n+    DatabaseReference writer = writerDb.getReference();\n+\n+    reader.addValueEventListener(\n+        new ValueEventListener() {\n+          @Override\n+          public void onDataChange(@NonNull DataSnapshot snapshot) {}\n+\n+          @Override\n+          public void onCancelled(@NonNull DatabaseError error) {}\n+        });\n+\n+    WriteFuture write = new WriteFuture(writer, 42L);\n+    assertNull(write.timedGet());\n+\n+    final Semaphore semaphore = new Semaphore(0);\n+\n+    try {\n+      assertEquals(42L, Tasks.await(reader.get()).getValue());\n+    } catch (ExecutionException e) {\n+      fail();\n+    }\n+\n+    write = new WriteFuture(writer, 43L);\n+    assertNull(write.timedGet());\n+\n+    try {\n+      assertEquals(43L, Tasks.await(reader.get()).getValue());\n+    } catch (ExecutionException e) {\n+      fail();\n+    }\n   }\n \n   @Test\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjg4MDMwMw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2087#discussion_r512880303", "bodyText": "Please drop exclamation mark as this is user facing. Maybe make this \"Client is offline\".", "author": "schmidt-sebastian", "createdAt": "2020-10-27T17:20:12Z", "path": "firebase-database/src/main/java/com/google/firebase/database/connection/PersistentConnectionImpl.java", "diffHunk": "@@ -344,6 +346,21 @@ public void listen(\n     doIdleCheck();\n   }\n \n+  @Override\n+  public Task<Object> get(List<String> path, Map<String, Object> queryParams) {\n+    QuerySpec query = new QuerySpec(path, queryParams);\n+    TaskCompletionSource<Object> source = new TaskCompletionSource<>();\n+    Task<Object> task;\n+    if (connected()) {\n+      task = sendGet(query, source);\n+    } else {\n+      source.setException(new Exception(\"Client offline!\"));", "originalCommit": "a0c1f6cd83b291dd0044f22872939c6bb016acdc", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9ffee19e584396034ba26c682622655eb40b00cc", "chunk": "diff --git a/firebase-database/src/main/java/com/google/firebase/database/connection/PersistentConnectionImpl.java b/firebase-database/src/main/java/com/google/firebase/database/connection/PersistentConnectionImpl.java\nindex 67acb8b6..f85323a0 100644\n--- a/firebase-database/src/main/java/com/google/firebase/database/connection/PersistentConnectionImpl.java\n+++ b/firebase-database/src/main/java/com/google/firebase/database/connection/PersistentConnectionImpl.java\n\n@@ -354,7 +355,7 @@ public class PersistentConnectionImpl implements Connection.Delegate, Persistent\n     if (connected()) {\n       task = sendGet(query, source);\n     } else {\n-      source.setException(new Exception(\"Client offline!\"));\n+      source.setException(new Exception(\"Client is offline\"));\n       task = source.getTask();\n     }\n     doIdleCheck();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjg4MTM1OA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2087#discussion_r512881358", "bodyText": "Please also port the logging changes from JS.", "author": "schmidt-sebastian", "createdAt": "2020-10-27T17:21:43Z", "path": "firebase-database/src/main/java/com/google/firebase/database/core/Repo.java", "diffHunk": "@@ -462,6 +467,37 @@ public void onRequestResult(String optErrorCode, String optErrorMessage) {\n     this.rerunTransactions(affectedPath);\n   }\n \n+  public Task<DataSnapshot> getValue(Query query) {\n+    return connection\n+        .get(query.getPath().asList(), query.getSpec().getParams().getWireProtocolParams())\n+        .continueWithTask(\n+            new Continuation<Object, Task<DataSnapshot>>() {\n+              @Override\n+              public Task<DataSnapshot> then(@NonNull Task<Object> task) throws Exception {\n+                TaskCompletionSource<DataSnapshot> source = new TaskCompletionSource<>();\n+                if (!task.isSuccessful()) {\n+                  Node cached =\n+                      serverSyncTree.calcCompleteEventCache(query.getPath(), new ArrayList<>());\n+                  if (cached.isEmpty()) {\n+                    source.setException(new Exception(\"Client offline with empty cache!\"));", "originalCommit": "a0c1f6cd83b291dd0044f22872939c6bb016acdc", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9ffee19e584396034ba26c682622655eb40b00cc", "chunk": "diff --git a/firebase-database/src/main/java/com/google/firebase/database/core/Repo.java b/firebase-database/src/main/java/com/google/firebase/database/core/Repo.java\nindex 08238b42..39cf4d85 100644\n--- a/firebase-database/src/main/java/com/google/firebase/database/core/Repo.java\n+++ b/firebase-database/src/main/java/com/google/firebase/database/core/Repo.java\n\n@@ -468,34 +468,48 @@ public class Repo implements PersistentConnection.Delegate {\n   }\n \n   public Task<DataSnapshot> getValue(Query query) {\n-    return connection\n-        .get(query.getPath().asList(), query.getSpec().getParams().getWireProtocolParams())\n-        .continueWithTask(\n-            new Continuation<Object, Task<DataSnapshot>>() {\n-              @Override\n-              public Task<DataSnapshot> then(@NonNull Task<Object> task) throws Exception {\n-                TaskCompletionSource<DataSnapshot> source = new TaskCompletionSource<>();\n-                if (!task.isSuccessful()) {\n-                  Node cached =\n-                      serverSyncTree.calcCompleteEventCache(query.getPath(), new ArrayList<>());\n-                  if (cached.isEmpty()) {\n-                    source.setException(new Exception(\"Client offline with empty cache!\"));\n-                  } else {\n-                    source.setResult(\n-                        InternalHelpers.createDataSnapshot(\n-                            query.getRef(), IndexedNode.from(cached, query.getSpec().getIndex())));\n-                  }\n-                } else {\n-                  Node serverNode = NodeUtilities.NodeFromJSON(task.getResult());\n-                  postEvents(serverSyncTree.applyServerOverwrite(query.getPath(), serverNode));\n-                  source.setResult(\n-                      InternalHelpers.createDataSnapshot(\n-                          query.getRef(),\n-                          IndexedNode.from(serverNode, query.getSpec().getIndex())));\n-                }\n-                return source.getTask();\n-              }\n-            });\n+    TaskCompletionSource<DataSnapshot> source = new TaskCompletionSource<>();\n+    this.scheduleNow(\n+        new Runnable() {\n+          @Override\n+          public void run() {\n+            connection\n+                .get(query.getPath().asList(), query.getSpec().getParams().getWireProtocolParams())\n+                .addOnCompleteListener(\n+                    new OnCompleteListener<Object>() {\n+                      @Override\n+                      public void onComplete(@NonNull Task<Object> task) {\n+                        if (!task.isSuccessful()) {\n+                          operationLogger.info(\n+                              \"get for query \"\n+                                  + query.getPath()\n+                                  + \" falling back to cache after error: \"\n+                                  + task.getException().getMessage());\n+                          Node cached =\n+                              serverSyncTree.calcCompleteEventCache(\n+                                  query.getPath(), new ArrayList<>());\n+                          if (cached.isEmpty()) {\n+                            source.setException(task.getException());\n+                          } else {\n+                            source.setResult(\n+                                InternalHelpers.createDataSnapshot(\n+                                    query.getRef(),\n+                                    IndexedNode.from(cached, query.getSpec().getIndex())));\n+                          }\n+                          return;\n+                        }\n+                        Node serverNode = NodeUtilities.NodeFromJSON(task.getResult());\n+                        postEvents(\n+                            serverSyncTree.applyServerOverwrite(query.getPath(), serverNode));\n+                        source.setResult(\n+                            InternalHelpers.createDataSnapshot(\n+                                query.getRef(),\n+                                IndexedNode.from(serverNode, query.getSpec().getIndex())));\n+                      }\n+                    });\n+          }\n+        });\n+    return source.getTask();\n   }\n \n   public void updateChildren(\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjg4MjI5MA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2087#discussion_r512882290", "bodyText": "Do we need to special case 404 as well and treat it as a successful response?", "author": "schmidt-sebastian", "createdAt": "2020-10-27T17:22:53Z", "path": "firebase-database/src/main/java/com/google/firebase/database/connection/PersistentConnectionImpl.java", "diffHunk": "@@ -1049,6 +1066,32 @@ public void onResponse(Map<String, Object> response) {\n         });\n   }\n \n+  private Task<Object> sendGet(final QuerySpec query, TaskCompletionSource<Object> source) {\n+    Map<String, Object> request = new HashMap<String, Object>();\n+    request.put(REQUEST_PATH, ConnectionUtils.pathToString(query.path));\n+    request.put(REQUEST_QUERIES, query.queryParams);\n+    sendAction(\n+        REQUEST_ACTION_QUERY,\n+        request,\n+        new ConnectionRequestCallback() {\n+          @Override\n+          public void onResponse(Map<String, Object> response) {\n+            String status = (String) response.get(REQUEST_STATUS);\n+            if (status.equals(\"ok\")) {", "originalCommit": "a0c1f6cd83b291dd0044f22872939c6bb016acdc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjEzODc3Mw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2087#discussion_r516138773", "bodyText": "We would return null if no data matches the query.", "author": "IanWyszynski", "createdAt": "2020-11-02T17:27:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjg4MjI5MA=="}], "type": "inlineReview", "revised_code": {"commit": "9ffee19e584396034ba26c682622655eb40b00cc", "chunk": "diff --git a/firebase-database/src/main/java/com/google/firebase/database/connection/PersistentConnectionImpl.java b/firebase-database/src/main/java/com/google/firebase/database/connection/PersistentConnectionImpl.java\nindex 67acb8b6..f85323a0 100644\n--- a/firebase-database/src/main/java/com/google/firebase/database/connection/PersistentConnectionImpl.java\n+++ b/firebase-database/src/main/java/com/google/firebase/database/connection/PersistentConnectionImpl.java\n\n@@ -1071,18 +1072,15 @@ public class PersistentConnectionImpl implements Connection.Delegate, Persistent\n     request.put(REQUEST_PATH, ConnectionUtils.pathToString(query.path));\n     request.put(REQUEST_QUERIES, query.queryParams);\n     sendAction(\n-        REQUEST_ACTION_QUERY,\n+        REQUEST_ACTION_GET,\n         request,\n         new ConnectionRequestCallback() {\n           @Override\n           public void onResponse(Map<String, Object> response) {\n             String status = (String) response.get(REQUEST_STATUS);\n             if (status.equals(\"ok\")) {\n-              String pathString = (String) response.get(SERVER_DATA_UPDATE_PATH);\n-              List<String> path = ConnectionUtils.stringToPath(pathString);\n               Object body = response.get(SERVER_DATA_UPDATE_BODY);\n-              Long tagNumber = ConnectionUtils.longFromObject(response.get(SERVER_DATA_TAG));\n-              delegate.onDataUpdate(path, body, /*isMerge=*/ false, /*tagNumber=*/ tagNumber);\n+              delegate.onDataUpdate(query.path, body, /*isMerge=*/ false, /*tagNumber=*/ null);\n               source.setResult(body);\n             } else {\n               source.setException(new Exception((String) response.get(SERVER_DATA_UPDATE_BODY)));\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjg4MjgxNQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2087#discussion_r512882815", "bodyText": "Does this need to be added to the Web PR?", "author": "schmidt-sebastian", "createdAt": "2020-10-27T17:23:31Z", "path": "firebase-database/src/main/java/com/google/firebase/database/connection/PersistentConnectionImpl.java", "diffHunk": "@@ -1049,6 +1066,32 @@ public void onResponse(Map<String, Object> response) {\n         });\n   }\n \n+  private Task<Object> sendGet(final QuerySpec query, TaskCompletionSource<Object> source) {\n+    Map<String, Object> request = new HashMap<String, Object>();\n+    request.put(REQUEST_PATH, ConnectionUtils.pathToString(query.path));\n+    request.put(REQUEST_QUERIES, query.queryParams);\n+    sendAction(\n+        REQUEST_ACTION_QUERY,\n+        request,\n+        new ConnectionRequestCallback() {\n+          @Override\n+          public void onResponse(Map<String, Object> response) {\n+            String status = (String) response.get(REQUEST_STATUS);\n+            if (status.equals(\"ok\")) {\n+              String pathString = (String) response.get(SERVER_DATA_UPDATE_PATH);\n+              List<String> path = ConnectionUtils.stringToPath(pathString);\n+              Object body = response.get(SERVER_DATA_UPDATE_BODY);\n+              Long tagNumber = ConnectionUtils.longFromObject(response.get(SERVER_DATA_TAG));", "originalCommit": "a0c1f6cd83b291dd0044f22872939c6bb016acdc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjEyMjU0MA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2087#discussion_r516122540", "bodyText": "No I think this was a mistake in this PR. Gets won't send tags.", "author": "IanWyszynski", "createdAt": "2020-11-02T17:07:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjg4MjgxNQ=="}], "type": "inlineReview", "revised_code": {"commit": "9ffee19e584396034ba26c682622655eb40b00cc", "chunk": "diff --git a/firebase-database/src/main/java/com/google/firebase/database/connection/PersistentConnectionImpl.java b/firebase-database/src/main/java/com/google/firebase/database/connection/PersistentConnectionImpl.java\nindex 67acb8b6..f85323a0 100644\n--- a/firebase-database/src/main/java/com/google/firebase/database/connection/PersistentConnectionImpl.java\n+++ b/firebase-database/src/main/java/com/google/firebase/database/connection/PersistentConnectionImpl.java\n\n@@ -1071,18 +1072,15 @@ public class PersistentConnectionImpl implements Connection.Delegate, Persistent\n     request.put(REQUEST_PATH, ConnectionUtils.pathToString(query.path));\n     request.put(REQUEST_QUERIES, query.queryParams);\n     sendAction(\n-        REQUEST_ACTION_QUERY,\n+        REQUEST_ACTION_GET,\n         request,\n         new ConnectionRequestCallback() {\n           @Override\n           public void onResponse(Map<String, Object> response) {\n             String status = (String) response.get(REQUEST_STATUS);\n             if (status.equals(\"ok\")) {\n-              String pathString = (String) response.get(SERVER_DATA_UPDATE_PATH);\n-              List<String> path = ConnectionUtils.stringToPath(pathString);\n               Object body = response.get(SERVER_DATA_UPDATE_BODY);\n-              Long tagNumber = ConnectionUtils.longFromObject(response.get(SERVER_DATA_TAG));\n-              delegate.onDataUpdate(path, body, /*isMerge=*/ false, /*tagNumber=*/ tagNumber);\n+              delegate.onDataUpdate(query.path, body, /*isMerge=*/ false, /*tagNumber=*/ null);\n               source.setResult(body);\n             } else {\n               source.setException(new Exception((String) response.get(SERVER_DATA_UPDATE_BODY)));\n"}}, {"oid": "9ffee19e584396034ba26c682622655eb40b00cc", "url": "https://github.com/firebase/firebase-android-sdk/commit/9ffee19e584396034ba26c682622655eb40b00cc", "message": "cleanup tests + review feedback", "committedDate": "2020-11-02T19:15:52Z", "type": "commit"}, {"oid": "1ee7f2110b84e516f755f5d5f246ce860c38027e", "url": "https://github.com/firebase/firebase-android-sdk/commit/1ee7f2110b84e516f755f5d5f246ce860c38027e", "message": "empty line", "committedDate": "2020-11-02T19:17:47Z", "type": "commit"}, {"oid": "a10a11eee9e058f7f4e8a1fcc26146959cbab8e8", "url": "https://github.com/firebase/firebase-android-sdk/commit/a10a11eee9e058f7f4e8a1fcc26146959cbab8e8", "message": "more test cleanup", "committedDate": "2020-11-03T02:50:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjgzMjM5NA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2087#discussion_r516832394", "bodyText": "I am not sure what the intent of these 5 lines is. It seems like the test would be the same without them?", "author": "schmidt-sebastian", "createdAt": "2020-11-03T17:20:14Z", "path": "firebase-database/src/androidTest/java/com/google/firebase/database/QueryTest.java", "diffHunk": "@@ -3401,6 +3407,140 @@ public void onComplete(DatabaseError error, DatabaseReference ref) {\n     IntegrationTestHelpers.waitFor(semaphore);\n   }\n \n+  private static FirebaseApp appForDatabaseUrl(String url, String name) {\n+    return FirebaseApp.initializeApp(\n+        InstrumentationRegistry.getInstrumentation().getTargetContext(),\n+        new FirebaseOptions.Builder()\n+            .setApplicationId(\"appid\")\n+            .setApiKey(\"apikey\")\n+            .setDatabaseUrl(url)\n+            .build(),\n+        name);\n+  }\n+\n+  @Test\n+  public void emptyQueryGet() throws DatabaseException, InterruptedException {\n+    FirebaseApp app =\n+        appForDatabaseUrl(IntegrationTestValues.getNamespace(), UUID.randomUUID().toString());\n+    FirebaseDatabase db = FirebaseDatabase.getInstance(app);\n+    try {\n+      Tasks.await(db.getReference(\"dummy/\").setValue(42L));\n+      assertNull(Tasks.await(db.getReference(\"null/\").get()).getValue());\n+    } catch (ExecutionException e) {\n+      fail(e.getMessage());\n+    }\n+  }\n+\n+  @Test\n+  public void offlineQueryGet() throws DatabaseException, InterruptedException {\n+    FirebaseApp app =\n+        appForDatabaseUrl(IntegrationTestValues.getNamespace(), UUID.randomUUID().toString());\n+    FirebaseDatabase db = FirebaseDatabase.getInstance(app);\n+    DatabaseReference node = db.getReference();\n+    try {\n+      Tasks.await(node.setValue(42L));\n+    } catch (ExecutionException e) {\n+      fail();\n+    }", "originalCommit": "a10a11eee9e058f7f4e8a1fcc26146959cbab8e8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f55197738e97383d4516ceb88cd71c9d5992c98d", "chunk": "diff --git a/firebase-database/src/androidTest/java/com/google/firebase/database/QueryTest.java b/firebase-database/src/androidTest/java/com/google/firebase/database/QueryTest.java\nindex b4219c0b..43558d02 100644\n--- a/firebase-database/src/androidTest/java/com/google/firebase/database/QueryTest.java\n+++ b/firebase-database/src/androidTest/java/com/google/firebase/database/QueryTest.java\n\n@@ -3424,8 +3424,7 @@ public class QueryTest {\n         appForDatabaseUrl(IntegrationTestValues.getNamespace(), UUID.randomUUID().toString());\n     FirebaseDatabase db = FirebaseDatabase.getInstance(app);\n     try {\n-      Tasks.await(db.getReference(\"dummy/\").setValue(42L));\n-      assertNull(Tasks.await(db.getReference(\"null/\").get()).getValue());\n+      assertNull(Tasks.await(db.getReference(UUID.randomUUID().toString()).get()).getValue());\n     } catch (ExecutionException e) {\n       fail(e.getMessage());\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjg0MTkxOQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2087#discussion_r516841919", "bodyText": "You can just add ExecutionException to throws.", "author": "schmidt-sebastian", "createdAt": "2020-11-03T17:35:24Z", "path": "firebase-database/src/androidTest/java/com/google/firebase/database/QueryTest.java", "diffHunk": "@@ -3401,6 +3407,140 @@ public void onComplete(DatabaseError error, DatabaseReference ref) {\n     IntegrationTestHelpers.waitFor(semaphore);\n   }\n \n+  private static FirebaseApp appForDatabaseUrl(String url, String name) {\n+    return FirebaseApp.initializeApp(\n+        InstrumentationRegistry.getInstrumentation().getTargetContext(),\n+        new FirebaseOptions.Builder()\n+            .setApplicationId(\"appid\")\n+            .setApiKey(\"apikey\")\n+            .setDatabaseUrl(url)\n+            .build(),\n+        name);\n+  }\n+\n+  @Test\n+  public void emptyQueryGet() throws DatabaseException, InterruptedException {\n+    FirebaseApp app =\n+        appForDatabaseUrl(IntegrationTestValues.getNamespace(), UUID.randomUUID().toString());\n+    FirebaseDatabase db = FirebaseDatabase.getInstance(app);\n+    try {\n+      Tasks.await(db.getReference(\"dummy/\").setValue(42L));\n+      assertNull(Tasks.await(db.getReference(\"null/\").get()).getValue());\n+    } catch (ExecutionException e) {\n+      fail(e.getMessage());\n+    }\n+  }\n+\n+  @Test\n+  public void offlineQueryGet() throws DatabaseException, InterruptedException {\n+    FirebaseApp app =\n+        appForDatabaseUrl(IntegrationTestValues.getNamespace(), UUID.randomUUID().toString());\n+    FirebaseDatabase db = FirebaseDatabase.getInstance(app);\n+    DatabaseReference node = db.getReference();\n+    try {\n+      Tasks.await(node.setValue(42L));\n+    } catch (ExecutionException e) {\n+      fail();\n+    }\n+    db.goOffline();\n+    try {\n+      Tasks.await(node.get());\n+    } catch (ExecutionException e) {\n+      assertEquals(e.getCause().getMessage(), \"Client is offline\");\n+      return;\n+    }\n+    fail(\"Client get succeeded even though offline.\");\n+  }\n+\n+  @Test\n+  public void getQueryBasic() throws DatabaseException, InterruptedException {\n+    FirebaseApp app =\n+        appForDatabaseUrl(IntegrationTestValues.getNamespace(), UUID.randomUUID().toString());\n+    FirebaseDatabase db = FirebaseDatabase.getInstance(app);\n+    DatabaseReference node = db.getReference();\n+    try {\n+      Tasks.await(node.setValue(42));\n+      assertEquals(42L, Tasks.await(node.get()).getValue());\n+    } catch (ExecutionException e) {\n+      fail(e.getMessage());", "originalCommit": "a10a11eee9e058f7f4e8a1fcc26146959cbab8e8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f55197738e97383d4516ceb88cd71c9d5992c98d", "chunk": "diff --git a/firebase-database/src/androidTest/java/com/google/firebase/database/QueryTest.java b/firebase-database/src/androidTest/java/com/google/firebase/database/QueryTest.java\nindex b4219c0b..43558d02 100644\n--- a/firebase-database/src/androidTest/java/com/google/firebase/database/QueryTest.java\n+++ b/firebase-database/src/androidTest/java/com/google/firebase/database/QueryTest.java\n\n@@ -3424,8 +3424,7 @@ public class QueryTest {\n         appForDatabaseUrl(IntegrationTestValues.getNamespace(), UUID.randomUUID().toString());\n     FirebaseDatabase db = FirebaseDatabase.getInstance(app);\n     try {\n-      Tasks.await(db.getReference(\"dummy/\").setValue(42L));\n-      assertNull(Tasks.await(db.getReference(\"null/\").get()).getValue());\n+      assertNull(Tasks.await(db.getReference(UUID.randomUUID().toString()).get()).getValue());\n     } catch (ExecutionException e) {\n       fail(e.getMessage());\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjg0MjIwNQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2087#discussion_r516842205", "bodyText": "You can just add ExecutionException to throws.", "author": "schmidt-sebastian", "createdAt": "2020-11-03T17:35:53Z", "path": "firebase-database/src/androidTest/java/com/google/firebase/database/QueryTest.java", "diffHunk": "@@ -3401,6 +3407,140 @@ public void onComplete(DatabaseError error, DatabaseReference ref) {\n     IntegrationTestHelpers.waitFor(semaphore);\n   }\n \n+  private static FirebaseApp appForDatabaseUrl(String url, String name) {\n+    return FirebaseApp.initializeApp(\n+        InstrumentationRegistry.getInstrumentation().getTargetContext(),\n+        new FirebaseOptions.Builder()\n+            .setApplicationId(\"appid\")\n+            .setApiKey(\"apikey\")\n+            .setDatabaseUrl(url)\n+            .build(),\n+        name);\n+  }\n+\n+  @Test\n+  public void emptyQueryGet() throws DatabaseException, InterruptedException {\n+    FirebaseApp app =\n+        appForDatabaseUrl(IntegrationTestValues.getNamespace(), UUID.randomUUID().toString());\n+    FirebaseDatabase db = FirebaseDatabase.getInstance(app);\n+    try {\n+      Tasks.await(db.getReference(\"dummy/\").setValue(42L));\n+      assertNull(Tasks.await(db.getReference(\"null/\").get()).getValue());\n+    } catch (ExecutionException e) {\n+      fail(e.getMessage());\n+    }\n+  }\n+\n+  @Test\n+  public void offlineQueryGet() throws DatabaseException, InterruptedException {\n+    FirebaseApp app =\n+        appForDatabaseUrl(IntegrationTestValues.getNamespace(), UUID.randomUUID().toString());\n+    FirebaseDatabase db = FirebaseDatabase.getInstance(app);\n+    DatabaseReference node = db.getReference();\n+    try {\n+      Tasks.await(node.setValue(42L));\n+    } catch (ExecutionException e) {\n+      fail();\n+    }\n+    db.goOffline();\n+    try {\n+      Tasks.await(node.get());\n+    } catch (ExecutionException e) {\n+      assertEquals(e.getCause().getMessage(), \"Client is offline\");\n+      return;\n+    }\n+    fail(\"Client get succeeded even though offline.\");\n+  }\n+\n+  @Test\n+  public void getQueryBasic() throws DatabaseException, InterruptedException {\n+    FirebaseApp app =\n+        appForDatabaseUrl(IntegrationTestValues.getNamespace(), UUID.randomUUID().toString());\n+    FirebaseDatabase db = FirebaseDatabase.getInstance(app);\n+    DatabaseReference node = db.getReference();\n+    try {\n+      Tasks.await(node.setValue(42));\n+      assertEquals(42L, Tasks.await(node.get()).getValue());\n+    } catch (ExecutionException e) {\n+      fail(e.getMessage());\n+    }\n+  }\n+\n+  @Test\n+  public void getQueryCached()\n+      throws DatabaseException, InterruptedException, TimeoutException, TestFailure {\n+    FirebaseApp app =\n+        appForDatabaseUrl(IntegrationTestValues.getAltNamespace(), UUID.randomUUID().toString());\n+    FirebaseDatabase db = FirebaseDatabase.getInstance(app);\n+    DatabaseReference ref = db.getReference();\n+    final Semaphore semaphore = new Semaphore(0);\n+    ValueEventListener listener =\n+        new ValueEventListener() {\n+          @Override\n+          public void onDataChange(@NonNull DataSnapshot snapshot) {\n+            if (snapshot.getValue() != null && snapshot.getValue().equals(42L)) {\n+              semaphore.release();\n+            }\n+          }\n+\n+          @Override\n+          public void onCancelled(@NonNull DatabaseError error) {}\n+        };\n+    ref.addValueEventListener(listener);\n+    ref.setValue(42L);\n+    IntegrationTestHelpers.waitFor(semaphore);\n+    db.goOffline();\n+    try {\n+      // Since we still have a listener on `ref`, the 42L should be cached here.\n+      assertEquals(42L, Tasks.await(ref.get()).getValue());\n+    } catch (ExecutionException e) {\n+      fail(e.getMessage());", "originalCommit": "a10a11eee9e058f7f4e8a1fcc26146959cbab8e8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f55197738e97383d4516ceb88cd71c9d5992c98d", "chunk": "diff --git a/firebase-database/src/androidTest/java/com/google/firebase/database/QueryTest.java b/firebase-database/src/androidTest/java/com/google/firebase/database/QueryTest.java\nindex b4219c0b..43558d02 100644\n--- a/firebase-database/src/androidTest/java/com/google/firebase/database/QueryTest.java\n+++ b/firebase-database/src/androidTest/java/com/google/firebase/database/QueryTest.java\n\n@@ -3424,8 +3424,7 @@ public class QueryTest {\n         appForDatabaseUrl(IntegrationTestValues.getNamespace(), UUID.randomUUID().toString());\n     FirebaseDatabase db = FirebaseDatabase.getInstance(app);\n     try {\n-      Tasks.await(db.getReference(\"dummy/\").setValue(42L));\n-      assertNull(Tasks.await(db.getReference(\"null/\").get()).getValue());\n+      assertNull(Tasks.await(db.getReference(UUID.randomUUID().toString()).get()).getValue());\n     } catch (ExecutionException e) {\n       fail(e.getMessage());\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjg0MzExOQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2087#discussion_r516843119", "bodyText": "Maybe s/semaphore/readerSemphore", "author": "schmidt-sebastian", "createdAt": "2020-11-03T17:37:29Z", "path": "firebase-database/src/androidTest/java/com/google/firebase/database/QueryTest.java", "diffHunk": "@@ -3401,6 +3407,140 @@ public void onComplete(DatabaseError error, DatabaseReference ref) {\n     IntegrationTestHelpers.waitFor(semaphore);\n   }\n \n+  private static FirebaseApp appForDatabaseUrl(String url, String name) {\n+    return FirebaseApp.initializeApp(\n+        InstrumentationRegistry.getInstrumentation().getTargetContext(),\n+        new FirebaseOptions.Builder()\n+            .setApplicationId(\"appid\")\n+            .setApiKey(\"apikey\")\n+            .setDatabaseUrl(url)\n+            .build(),\n+        name);\n+  }\n+\n+  @Test\n+  public void emptyQueryGet() throws DatabaseException, InterruptedException {\n+    FirebaseApp app =\n+        appForDatabaseUrl(IntegrationTestValues.getNamespace(), UUID.randomUUID().toString());\n+    FirebaseDatabase db = FirebaseDatabase.getInstance(app);\n+    try {\n+      Tasks.await(db.getReference(\"dummy/\").setValue(42L));\n+      assertNull(Tasks.await(db.getReference(\"null/\").get()).getValue());\n+    } catch (ExecutionException e) {\n+      fail(e.getMessage());\n+    }\n+  }\n+\n+  @Test\n+  public void offlineQueryGet() throws DatabaseException, InterruptedException {\n+    FirebaseApp app =\n+        appForDatabaseUrl(IntegrationTestValues.getNamespace(), UUID.randomUUID().toString());\n+    FirebaseDatabase db = FirebaseDatabase.getInstance(app);\n+    DatabaseReference node = db.getReference();\n+    try {\n+      Tasks.await(node.setValue(42L));\n+    } catch (ExecutionException e) {\n+      fail();\n+    }\n+    db.goOffline();\n+    try {\n+      Tasks.await(node.get());\n+    } catch (ExecutionException e) {\n+      assertEquals(e.getCause().getMessage(), \"Client is offline\");\n+      return;\n+    }\n+    fail(\"Client get succeeded even though offline.\");\n+  }\n+\n+  @Test\n+  public void getQueryBasic() throws DatabaseException, InterruptedException {\n+    FirebaseApp app =\n+        appForDatabaseUrl(IntegrationTestValues.getNamespace(), UUID.randomUUID().toString());\n+    FirebaseDatabase db = FirebaseDatabase.getInstance(app);\n+    DatabaseReference node = db.getReference();\n+    try {\n+      Tasks.await(node.setValue(42));\n+      assertEquals(42L, Tasks.await(node.get()).getValue());\n+    } catch (ExecutionException e) {\n+      fail(e.getMessage());\n+    }\n+  }\n+\n+  @Test\n+  public void getQueryCached()\n+      throws DatabaseException, InterruptedException, TimeoutException, TestFailure {\n+    FirebaseApp app =\n+        appForDatabaseUrl(IntegrationTestValues.getAltNamespace(), UUID.randomUUID().toString());\n+    FirebaseDatabase db = FirebaseDatabase.getInstance(app);\n+    DatabaseReference ref = db.getReference();\n+    final Semaphore semaphore = new Semaphore(0);\n+    ValueEventListener listener =\n+        new ValueEventListener() {\n+          @Override\n+          public void onDataChange(@NonNull DataSnapshot snapshot) {\n+            if (snapshot.getValue() != null && snapshot.getValue().equals(42L)) {\n+              semaphore.release();\n+            }\n+          }\n+\n+          @Override\n+          public void onCancelled(@NonNull DatabaseError error) {}\n+        };\n+    ref.addValueEventListener(listener);\n+    ref.setValue(42L);\n+    IntegrationTestHelpers.waitFor(semaphore);\n+    db.goOffline();\n+    try {\n+      // Since we still have a listener on `ref`, the 42L should be cached here.\n+      assertEquals(42L, Tasks.await(ref.get()).getValue());\n+    } catch (ExecutionException e) {\n+      fail(e.getMessage());\n+    } finally {\n+      ref.removeEventListener(listener);\n+    }\n+  }\n+\n+  @Test\n+  public void getQuerySkipsCacheWhenOnline()\n+      throws DatabaseException, InterruptedException, ExecutionException, TestFailure,\n+          TimeoutException {\n+    FirebaseApp readerApp =\n+        appForDatabaseUrl(IntegrationTestValues.getNamespace(), UUID.randomUUID().toString());\n+    FirebaseApp writerApp =\n+        appForDatabaseUrl(IntegrationTestValues.getNamespace(), UUID.randomUUID().toString());\n+    FirebaseDatabase readerDb = FirebaseDatabase.getInstance(readerApp);\n+    FirebaseDatabase writerDb = FirebaseDatabase.getInstance(writerApp);\n+    DatabaseReference reader = readerDb.getReference();\n+    DatabaseReference writer = writerDb.getReference();\n+\n+    final Semaphore semaphore = new Semaphore(0);", "originalCommit": "a10a11eee9e058f7f4e8a1fcc26146959cbab8e8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f55197738e97383d4516ceb88cd71c9d5992c98d", "chunk": "diff --git a/firebase-database/src/androidTest/java/com/google/firebase/database/QueryTest.java b/firebase-database/src/androidTest/java/com/google/firebase/database/QueryTest.java\nindex b4219c0b..43558d02 100644\n--- a/firebase-database/src/androidTest/java/com/google/firebase/database/QueryTest.java\n+++ b/firebase-database/src/androidTest/java/com/google/firebase/database/QueryTest.java\n\n@@ -3424,8 +3424,7 @@ public class QueryTest {\n         appForDatabaseUrl(IntegrationTestValues.getNamespace(), UUID.randomUUID().toString());\n     FirebaseDatabase db = FirebaseDatabase.getInstance(app);\n     try {\n-      Tasks.await(db.getReference(\"dummy/\").setValue(42L));\n-      assertNull(Tasks.await(db.getReference(\"null/\").get()).getValue());\n+      assertNull(Tasks.await(db.getReference(UUID.randomUUID().toString()).get()).getValue());\n     } catch (ExecutionException e) {\n       fail(e.getMessage());\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjg0MzU3OQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2087#discussion_r516843579", "bodyText": "Did you consider using ReadFuture to simplify this setup?", "author": "schmidt-sebastian", "createdAt": "2020-11-03T17:38:11Z", "path": "firebase-database/src/androidTest/java/com/google/firebase/database/QueryTest.java", "diffHunk": "@@ -3401,6 +3407,140 @@ public void onComplete(DatabaseError error, DatabaseReference ref) {\n     IntegrationTestHelpers.waitFor(semaphore);\n   }\n \n+  private static FirebaseApp appForDatabaseUrl(String url, String name) {\n+    return FirebaseApp.initializeApp(\n+        InstrumentationRegistry.getInstrumentation().getTargetContext(),\n+        new FirebaseOptions.Builder()\n+            .setApplicationId(\"appid\")\n+            .setApiKey(\"apikey\")\n+            .setDatabaseUrl(url)\n+            .build(),\n+        name);\n+  }\n+\n+  @Test\n+  public void emptyQueryGet() throws DatabaseException, InterruptedException {\n+    FirebaseApp app =\n+        appForDatabaseUrl(IntegrationTestValues.getNamespace(), UUID.randomUUID().toString());\n+    FirebaseDatabase db = FirebaseDatabase.getInstance(app);\n+    try {\n+      Tasks.await(db.getReference(\"dummy/\").setValue(42L));\n+      assertNull(Tasks.await(db.getReference(\"null/\").get()).getValue());\n+    } catch (ExecutionException e) {\n+      fail(e.getMessage());\n+    }\n+  }\n+\n+  @Test\n+  public void offlineQueryGet() throws DatabaseException, InterruptedException {\n+    FirebaseApp app =\n+        appForDatabaseUrl(IntegrationTestValues.getNamespace(), UUID.randomUUID().toString());\n+    FirebaseDatabase db = FirebaseDatabase.getInstance(app);\n+    DatabaseReference node = db.getReference();\n+    try {\n+      Tasks.await(node.setValue(42L));\n+    } catch (ExecutionException e) {\n+      fail();\n+    }\n+    db.goOffline();\n+    try {\n+      Tasks.await(node.get());\n+    } catch (ExecutionException e) {\n+      assertEquals(e.getCause().getMessage(), \"Client is offline\");\n+      return;\n+    }\n+    fail(\"Client get succeeded even though offline.\");\n+  }\n+\n+  @Test\n+  public void getQueryBasic() throws DatabaseException, InterruptedException {\n+    FirebaseApp app =\n+        appForDatabaseUrl(IntegrationTestValues.getNamespace(), UUID.randomUUID().toString());\n+    FirebaseDatabase db = FirebaseDatabase.getInstance(app);\n+    DatabaseReference node = db.getReference();\n+    try {\n+      Tasks.await(node.setValue(42));\n+      assertEquals(42L, Tasks.await(node.get()).getValue());\n+    } catch (ExecutionException e) {\n+      fail(e.getMessage());\n+    }\n+  }\n+\n+  @Test\n+  public void getQueryCached()\n+      throws DatabaseException, InterruptedException, TimeoutException, TestFailure {\n+    FirebaseApp app =\n+        appForDatabaseUrl(IntegrationTestValues.getAltNamespace(), UUID.randomUUID().toString());\n+    FirebaseDatabase db = FirebaseDatabase.getInstance(app);\n+    DatabaseReference ref = db.getReference();\n+    final Semaphore semaphore = new Semaphore(0);\n+    ValueEventListener listener =\n+        new ValueEventListener() {\n+          @Override\n+          public void onDataChange(@NonNull DataSnapshot snapshot) {\n+            if (snapshot.getValue() != null && snapshot.getValue().equals(42L)) {\n+              semaphore.release();\n+            }\n+          }\n+\n+          @Override\n+          public void onCancelled(@NonNull DatabaseError error) {}\n+        };", "originalCommit": "a10a11eee9e058f7f4e8a1fcc26146959cbab8e8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzAyMTYxMw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2087#discussion_r517021613", "bodyText": "After talking offline, this is not possible since we need to run line 3489 and 3490.", "author": "schmidt-sebastian", "createdAt": "2020-11-03T23:49:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjg0MzU3OQ=="}], "type": "inlineReview", "revised_code": {"commit": "f55197738e97383d4516ceb88cd71c9d5992c98d", "chunk": "diff --git a/firebase-database/src/androidTest/java/com/google/firebase/database/QueryTest.java b/firebase-database/src/androidTest/java/com/google/firebase/database/QueryTest.java\nindex b4219c0b..43558d02 100644\n--- a/firebase-database/src/androidTest/java/com/google/firebase/database/QueryTest.java\n+++ b/firebase-database/src/androidTest/java/com/google/firebase/database/QueryTest.java\n\n@@ -3424,8 +3424,7 @@ public class QueryTest {\n         appForDatabaseUrl(IntegrationTestValues.getNamespace(), UUID.randomUUID().toString());\n     FirebaseDatabase db = FirebaseDatabase.getInstance(app);\n     try {\n-      Tasks.await(db.getReference(\"dummy/\").setValue(42L));\n-      assertNull(Tasks.await(db.getReference(\"null/\").get()).getValue());\n+      assertNull(Tasks.await(db.getReference(UUID.randomUUID().toString()).get()).getValue());\n     } catch (ExecutionException e) {\n       fail(e.getMessage());\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjg0NzU4Mw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2087#discussion_r516847583", "bodyText": "Our implementation should also go online without this write. Right now, this test throws \"Client is offline\" without the previous write. We need to wait until the client goes online and then return the result.", "author": "schmidt-sebastian", "createdAt": "2020-11-03T17:44:53Z", "path": "firebase-database/src/androidTest/java/com/google/firebase/database/QueryTest.java", "diffHunk": "@@ -3401,6 +3407,140 @@ public void onComplete(DatabaseError error, DatabaseReference ref) {\n     IntegrationTestHelpers.waitFor(semaphore);\n   }\n \n+  private static FirebaseApp appForDatabaseUrl(String url, String name) {\n+    return FirebaseApp.initializeApp(\n+        InstrumentationRegistry.getInstrumentation().getTargetContext(),\n+        new FirebaseOptions.Builder()\n+            .setApplicationId(\"appid\")\n+            .setApiKey(\"apikey\")\n+            .setDatabaseUrl(url)\n+            .build(),\n+        name);\n+  }\n+\n+  @Test\n+  public void emptyQueryGet() throws DatabaseException, InterruptedException {\n+    FirebaseApp app =\n+        appForDatabaseUrl(IntegrationTestValues.getNamespace(), UUID.randomUUID().toString());\n+    FirebaseDatabase db = FirebaseDatabase.getInstance(app);\n+    try {\n+      Tasks.await(db.getReference(\"dummy/\").setValue(42L));", "originalCommit": "a10a11eee9e058f7f4e8a1fcc26146959cbab8e8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f55197738e97383d4516ceb88cd71c9d5992c98d", "chunk": "diff --git a/firebase-database/src/androidTest/java/com/google/firebase/database/QueryTest.java b/firebase-database/src/androidTest/java/com/google/firebase/database/QueryTest.java\nindex b4219c0b..43558d02 100644\n--- a/firebase-database/src/androidTest/java/com/google/firebase/database/QueryTest.java\n+++ b/firebase-database/src/androidTest/java/com/google/firebase/database/QueryTest.java\n\n@@ -3424,8 +3424,7 @@ public class QueryTest {\n         appForDatabaseUrl(IntegrationTestValues.getNamespace(), UUID.randomUUID().toString());\n     FirebaseDatabase db = FirebaseDatabase.getInstance(app);\n     try {\n-      Tasks.await(db.getReference(\"dummy/\").setValue(42L));\n-      assertNull(Tasks.await(db.getReference(\"null/\").get()).getValue());\n+      assertNull(Tasks.await(db.getReference(UUID.randomUUID().toString()).get()).getValue());\n     } catch (ExecutionException e) {\n       fail(e.getMessage());\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjg2NjA2Ng==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2087#discussion_r516866066", "bodyText": "Please also add a test that shows the the value is still cached even when there are no remaining listeners. The SDK should keep up to 10 MB of least recently used data. For this to work, you have to track the query via the persistence manager. See here: \n  \n    \n      firebase-android-sdk/firebase-database/src/main/java/com/google/firebase/database/core/SyncTree.java\n    \n    \n         Line 505\n      in\n      d920962\n    \n    \n    \n    \n\n        \n          \n           persistenceManager.setQueryActive(query);", "author": "schmidt-sebastian", "createdAt": "2020-11-03T18:16:18Z", "path": "firebase-database/src/androidTest/java/com/google/firebase/database/QueryTest.java", "diffHunk": "@@ -3401,6 +3407,140 @@ public void onComplete(DatabaseError error, DatabaseReference ref) {\n     IntegrationTestHelpers.waitFor(semaphore);\n   }\n \n+  private static FirebaseApp appForDatabaseUrl(String url, String name) {\n+    return FirebaseApp.initializeApp(\n+        InstrumentationRegistry.getInstrumentation().getTargetContext(),\n+        new FirebaseOptions.Builder()\n+            .setApplicationId(\"appid\")\n+            .setApiKey(\"apikey\")\n+            .setDatabaseUrl(url)\n+            .build(),\n+        name);\n+  }\n+\n+  @Test\n+  public void emptyQueryGet() throws DatabaseException, InterruptedException {\n+    FirebaseApp app =\n+        appForDatabaseUrl(IntegrationTestValues.getNamespace(), UUID.randomUUID().toString());\n+    FirebaseDatabase db = FirebaseDatabase.getInstance(app);\n+    try {\n+      Tasks.await(db.getReference(\"dummy/\").setValue(42L));\n+      assertNull(Tasks.await(db.getReference(\"null/\").get()).getValue());\n+    } catch (ExecutionException e) {\n+      fail(e.getMessage());\n+    }\n+  }\n+\n+  @Test\n+  public void offlineQueryGet() throws DatabaseException, InterruptedException {\n+    FirebaseApp app =\n+        appForDatabaseUrl(IntegrationTestValues.getNamespace(), UUID.randomUUID().toString());\n+    FirebaseDatabase db = FirebaseDatabase.getInstance(app);\n+    DatabaseReference node = db.getReference();\n+    try {\n+      Tasks.await(node.setValue(42L));\n+    } catch (ExecutionException e) {\n+      fail();\n+    }\n+    db.goOffline();\n+    try {\n+      Tasks.await(node.get());\n+    } catch (ExecutionException e) {\n+      assertEquals(e.getCause().getMessage(), \"Client is offline\");\n+      return;\n+    }\n+    fail(\"Client get succeeded even though offline.\");\n+  }\n+\n+  @Test\n+  public void getQueryBasic() throws DatabaseException, InterruptedException {\n+    FirebaseApp app =\n+        appForDatabaseUrl(IntegrationTestValues.getNamespace(), UUID.randomUUID().toString());\n+    FirebaseDatabase db = FirebaseDatabase.getInstance(app);\n+    DatabaseReference node = db.getReference();\n+    try {\n+      Tasks.await(node.setValue(42));\n+      assertEquals(42L, Tasks.await(node.get()).getValue());\n+    } catch (ExecutionException e) {\n+      fail(e.getMessage());\n+    }\n+  }\n+\n+  @Test\n+  public void getQueryCached()\n+      throws DatabaseException, InterruptedException, TimeoutException, TestFailure {\n+    FirebaseApp app =\n+        appForDatabaseUrl(IntegrationTestValues.getAltNamespace(), UUID.randomUUID().toString());\n+    FirebaseDatabase db = FirebaseDatabase.getInstance(app);\n+    DatabaseReference ref = db.getReference();\n+    final Semaphore semaphore = new Semaphore(0);\n+    ValueEventListener listener =\n+        new ValueEventListener() {\n+          @Override\n+          public void onDataChange(@NonNull DataSnapshot snapshot) {\n+            if (snapshot.getValue() != null && snapshot.getValue().equals(42L)) {\n+              semaphore.release();\n+            }\n+          }\n+\n+          @Override\n+          public void onCancelled(@NonNull DatabaseError error) {}\n+        };\n+    ref.addValueEventListener(listener);\n+    ref.setValue(42L);\n+    IntegrationTestHelpers.waitFor(semaphore);\n+    db.goOffline();\n+    try {\n+      // Since we still have a listener on `ref`, the 42L should be cached here.\n+      assertEquals(42L, Tasks.await(ref.get()).getValue());\n+    } catch (ExecutionException e) {\n+      fail(e.getMessage());\n+    } finally {\n+      ref.removeEventListener(listener);\n+    }", "originalCommit": "a10a11eee9e058f7f4e8a1fcc26146959cbab8e8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f55197738e97383d4516ceb88cd71c9d5992c98d", "chunk": "diff --git a/firebase-database/src/androidTest/java/com/google/firebase/database/QueryTest.java b/firebase-database/src/androidTest/java/com/google/firebase/database/QueryTest.java\nindex b4219c0b..43558d02 100644\n--- a/firebase-database/src/androidTest/java/com/google/firebase/database/QueryTest.java\n+++ b/firebase-database/src/androidTest/java/com/google/firebase/database/QueryTest.java\n\n@@ -3424,8 +3424,7 @@ public class QueryTest {\n         appForDatabaseUrl(IntegrationTestValues.getNamespace(), UUID.randomUUID().toString());\n     FirebaseDatabase db = FirebaseDatabase.getInstance(app);\n     try {\n-      Tasks.await(db.getReference(\"dummy/\").setValue(42L));\n-      assertNull(Tasks.await(db.getReference(\"null/\").get()).getValue());\n+      assertNull(Tasks.await(db.getReference(UUID.randomUUID().toString()).get()).getValue());\n     } catch (ExecutionException e) {\n       fail(e.getMessage());\n     }\n"}}, {"oid": "f55197738e97383d4516ceb88cd71c9d5992c98d", "url": "https://github.com/firebase/firebase-android-sdk/commit/f55197738e97383d4516ceb88cd71c9d5992c98d", "message": "Review feedback, connected check", "committedDate": "2020-11-03T23:59:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI0NDM1OQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2087#discussion_r518244359", "bodyText": "I think this catch can be removed.", "author": "schmidt-sebastian", "createdAt": "2020-11-05T17:48:36Z", "path": "firebase-database/src/androidTest/java/com/google/firebase/database/QueryTest.java", "diffHunk": "@@ -3401,6 +3407,165 @@ public void onComplete(DatabaseError error, DatabaseReference ref) {\n     IntegrationTestHelpers.waitFor(semaphore);\n   }\n \n+  private static FirebaseApp appForDatabaseUrl(String url, String name) {\n+    return FirebaseApp.initializeApp(\n+        InstrumentationRegistry.getInstrumentation().getTargetContext(),\n+        new FirebaseOptions.Builder()\n+            .setApplicationId(\"appid\")\n+            .setApiKey(\"apikey\")\n+            .setDatabaseUrl(url)\n+            .build(),\n+        name);\n+  }\n+\n+  @Test\n+  public void emptyQueryGet() throws DatabaseException, InterruptedException {\n+    FirebaseApp app =\n+        appForDatabaseUrl(IntegrationTestValues.getNamespace(), UUID.randomUUID().toString());\n+    FirebaseDatabase db = FirebaseDatabase.getInstance(app);\n+    try {\n+      assertNull(Tasks.await(db.getReference(UUID.randomUUID().toString()).get()).getValue());\n+    } catch (ExecutionException e) {\n+      fail(e.getMessage());\n+    }", "originalCommit": "f55197738e97383d4516ceb88cd71c9d5992c98d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "33308ddee83da3d250be3ead0435c82f63b9324e", "chunk": "diff --git a/firebase-database/src/androidTest/java/com/google/firebase/database/QueryTest.java b/firebase-database/src/androidTest/java/com/google/firebase/database/QueryTest.java\nindex 43558d02..e3dc3ec6 100644\n--- a/firebase-database/src/androidTest/java/com/google/firebase/database/QueryTest.java\n+++ b/firebase-database/src/androidTest/java/com/google/firebase/database/QueryTest.java\n\n@@ -3419,15 +3419,11 @@ public class QueryTest {\n   }\n \n   @Test\n-  public void emptyQueryGet() throws DatabaseException, InterruptedException {\n+  public void emptyQueryGet() throws DatabaseException, InterruptedException, ExecutionException {\n     FirebaseApp app =\n         appForDatabaseUrl(IntegrationTestValues.getNamespace(), UUID.randomUUID().toString());\n     FirebaseDatabase db = FirebaseDatabase.getInstance(app);\n-    try {\n-      assertNull(Tasks.await(db.getReference(UUID.randomUUID().toString()).get()).getValue());\n-    } catch (ExecutionException e) {\n-      fail(e.getMessage());\n-    }\n+    assertNull(Tasks.await(db.getReference(UUID.randomUUID().toString()).get()).getValue());\n   }\n \n   @Test\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI0NzM1OQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2087#discussion_r518247359", "bodyText": "This catch can be removed.", "author": "schmidt-sebastian", "createdAt": "2020-11-05T17:53:16Z", "path": "firebase-database/src/androidTest/java/com/google/firebase/database/QueryTest.java", "diffHunk": "@@ -3401,6 +3407,165 @@ public void onComplete(DatabaseError error, DatabaseReference ref) {\n     IntegrationTestHelpers.waitFor(semaphore);\n   }\n \n+  private static FirebaseApp appForDatabaseUrl(String url, String name) {\n+    return FirebaseApp.initializeApp(\n+        InstrumentationRegistry.getInstrumentation().getTargetContext(),\n+        new FirebaseOptions.Builder()\n+            .setApplicationId(\"appid\")\n+            .setApiKey(\"apikey\")\n+            .setDatabaseUrl(url)\n+            .build(),\n+        name);\n+  }\n+\n+  @Test\n+  public void emptyQueryGet() throws DatabaseException, InterruptedException {\n+    FirebaseApp app =\n+        appForDatabaseUrl(IntegrationTestValues.getNamespace(), UUID.randomUUID().toString());\n+    FirebaseDatabase db = FirebaseDatabase.getInstance(app);\n+    try {\n+      assertNull(Tasks.await(db.getReference(UUID.randomUUID().toString()).get()).getValue());\n+    } catch (ExecutionException e) {\n+      fail(e.getMessage());\n+    }\n+  }\n+\n+  @Test\n+  public void offlineQueryGet() throws DatabaseException, InterruptedException {\n+    FirebaseApp app =\n+        appForDatabaseUrl(IntegrationTestValues.getNamespace(), UUID.randomUUID().toString());\n+    FirebaseDatabase db = FirebaseDatabase.getInstance(app);\n+    db.setLogLevel(Logger.Level.DEBUG);\n+    DatabaseReference node = db.getReference();\n+    db.goOffline();\n+    try {\n+      Tasks.await(node.get());\n+    } catch (ExecutionException e) {\n+      assertEquals(e.getCause().getMessage(), \"Client is offline\");\n+      return;\n+    }\n+    fail(\"Client get succeeded even though offline.\");\n+  }\n+\n+  @Test\n+  public void getQueryBasic() throws DatabaseException, InterruptedException, ExecutionException {\n+    FirebaseApp app =\n+        appForDatabaseUrl(IntegrationTestValues.getNamespace(), UUID.randomUUID().toString());\n+    FirebaseDatabase db = FirebaseDatabase.getInstance(app);\n+    DatabaseReference node = db.getReference();\n+    Tasks.await(node.setValue(42));\n+    assertEquals(42L, Tasks.await(node.get()).getValue());\n+  }\n+\n+  @Test\n+  public void getQueryCached()\n+      throws DatabaseException, InterruptedException, TimeoutException, TestFailure,\n+          ExecutionException {\n+    FirebaseApp app =\n+        appForDatabaseUrl(IntegrationTestValues.getAltNamespace(), UUID.randomUUID().toString());\n+    FirebaseDatabase db = FirebaseDatabase.getInstance(app);\n+    DatabaseReference ref = db.getReference();\n+    final Semaphore semaphore = new Semaphore(0);\n+    ValueEventListener listener =\n+        new ValueEventListener() {\n+          @Override\n+          public void onDataChange(@NonNull DataSnapshot snapshot) {\n+            if (snapshot.getValue() != null && snapshot.getValue().equals(42L)) {\n+              semaphore.release();\n+            }\n+          }\n+\n+          @Override\n+          public void onCancelled(@NonNull DatabaseError error) {}\n+        };\n+    ref.addValueEventListener(listener);\n+    ref.setValue(42L);\n+    IntegrationTestHelpers.waitFor(semaphore);\n+    db.goOffline();\n+    try {\n+      // Since we still have a listener on `ref`, the 42L should be cached here.\n+      assertEquals(42L, Tasks.await(ref.get()).getValue());\n+    } finally {\n+      ref.removeEventListener(listener);\n+    }\n+  }\n+\n+  @Test\n+  public void getRetrievesLatestServerValue()\n+      throws DatabaseException, InterruptedException, ExecutionException, TestFailure,\n+          TimeoutException {\n+    FirebaseApp readerApp =\n+        appForDatabaseUrl(IntegrationTestValues.getNamespace(), UUID.randomUUID().toString());\n+    FirebaseApp writerApp =\n+        appForDatabaseUrl(IntegrationTestValues.getNamespace(), UUID.randomUUID().toString());\n+    FirebaseDatabase readerDb = FirebaseDatabase.getInstance(readerApp);\n+    FirebaseDatabase writerDb = FirebaseDatabase.getInstance(writerApp);\n+    DatabaseReference reader = readerDb.getReference();\n+    DatabaseReference writer = writerDb.getReference();\n+\n+    final Semaphore readerSemaphore = new Semaphore(0);\n+    reader.addValueEventListener(\n+        new ValueEventListener() {\n+          @Override\n+          public void onDataChange(@NonNull DataSnapshot snapshot) {\n+            if (snapshot.getValue() != null && snapshot.getValue().equals(42L)) {\n+              readerSemaphore.release();\n+            }\n+          }\n+\n+          @Override\n+          public void onCancelled(@NonNull DatabaseError error) {}\n+        });\n+\n+    WriteFuture write = new WriteFuture(writer, 42L);\n+    assertNull(write.timedGet());\n+    IntegrationTestHelpers.waitFor(readerSemaphore);\n+\n+    write = new WriteFuture(writer, 43L);\n+    assertNull(write.timedGet());\n+\n+    try {\n+      assertEquals(43L, Tasks.await(reader.get()).getValue());\n+    } catch (ExecutionException e) {\n+      fail(e.getMessage());\n+    }", "originalCommit": "f55197738e97383d4516ceb88cd71c9d5992c98d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "33308ddee83da3d250be3ead0435c82f63b9324e", "chunk": "diff --git a/firebase-database/src/androidTest/java/com/google/firebase/database/QueryTest.java b/firebase-database/src/androidTest/java/com/google/firebase/database/QueryTest.java\nindex 43558d02..e3dc3ec6 100644\n--- a/firebase-database/src/androidTest/java/com/google/firebase/database/QueryTest.java\n+++ b/firebase-database/src/androidTest/java/com/google/firebase/database/QueryTest.java\n\n@@ -3419,15 +3419,11 @@ public class QueryTest {\n   }\n \n   @Test\n-  public void emptyQueryGet() throws DatabaseException, InterruptedException {\n+  public void emptyQueryGet() throws DatabaseException, InterruptedException, ExecutionException {\n     FirebaseApp app =\n         appForDatabaseUrl(IntegrationTestValues.getNamespace(), UUID.randomUUID().toString());\n     FirebaseDatabase db = FirebaseDatabase.getInstance(app);\n-    try {\n-      assertNull(Tasks.await(db.getReference(UUID.randomUUID().toString()).get()).getValue());\n-    } catch (ExecutionException e) {\n-      fail(e.getMessage());\n-    }\n+    assertNull(Tasks.await(db.getReference(UUID.randomUUID().toString()).get()).getValue());\n   }\n \n   @Test\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI2MDY3NA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2087#discussion_r518260674", "bodyText": "I think my comment earlier wasn't applicable... but it does seem that this is now a ReadFuture.", "author": "schmidt-sebastian", "createdAt": "2020-11-05T18:10:05Z", "path": "firebase-database/src/androidTest/java/com/google/firebase/database/QueryTest.java", "diffHunk": "@@ -3401,6 +3407,165 @@ public void onComplete(DatabaseError error, DatabaseReference ref) {\n     IntegrationTestHelpers.waitFor(semaphore);\n   }\n \n+  private static FirebaseApp appForDatabaseUrl(String url, String name) {\n+    return FirebaseApp.initializeApp(\n+        InstrumentationRegistry.getInstrumentation().getTargetContext(),\n+        new FirebaseOptions.Builder()\n+            .setApplicationId(\"appid\")\n+            .setApiKey(\"apikey\")\n+            .setDatabaseUrl(url)\n+            .build(),\n+        name);\n+  }\n+\n+  @Test\n+  public void emptyQueryGet() throws DatabaseException, InterruptedException {\n+    FirebaseApp app =\n+        appForDatabaseUrl(IntegrationTestValues.getNamespace(), UUID.randomUUID().toString());\n+    FirebaseDatabase db = FirebaseDatabase.getInstance(app);\n+    try {\n+      assertNull(Tasks.await(db.getReference(UUID.randomUUID().toString()).get()).getValue());\n+    } catch (ExecutionException e) {\n+      fail(e.getMessage());\n+    }\n+  }\n+\n+  @Test\n+  public void offlineQueryGet() throws DatabaseException, InterruptedException {\n+    FirebaseApp app =\n+        appForDatabaseUrl(IntegrationTestValues.getNamespace(), UUID.randomUUID().toString());\n+    FirebaseDatabase db = FirebaseDatabase.getInstance(app);\n+    db.setLogLevel(Logger.Level.DEBUG);\n+    DatabaseReference node = db.getReference();\n+    db.goOffline();\n+    try {\n+      Tasks.await(node.get());\n+    } catch (ExecutionException e) {\n+      assertEquals(e.getCause().getMessage(), \"Client is offline\");\n+      return;\n+    }\n+    fail(\"Client get succeeded even though offline.\");\n+  }\n+\n+  @Test\n+  public void getQueryBasic() throws DatabaseException, InterruptedException, ExecutionException {\n+    FirebaseApp app =\n+        appForDatabaseUrl(IntegrationTestValues.getNamespace(), UUID.randomUUID().toString());\n+    FirebaseDatabase db = FirebaseDatabase.getInstance(app);\n+    DatabaseReference node = db.getReference();\n+    Tasks.await(node.setValue(42));\n+    assertEquals(42L, Tasks.await(node.get()).getValue());\n+  }\n+\n+  @Test\n+  public void getQueryCached()\n+      throws DatabaseException, InterruptedException, TimeoutException, TestFailure,\n+          ExecutionException {\n+    FirebaseApp app =\n+        appForDatabaseUrl(IntegrationTestValues.getAltNamespace(), UUID.randomUUID().toString());\n+    FirebaseDatabase db = FirebaseDatabase.getInstance(app);\n+    DatabaseReference ref = db.getReference();\n+    final Semaphore semaphore = new Semaphore(0);\n+    ValueEventListener listener =\n+        new ValueEventListener() {\n+          @Override\n+          public void onDataChange(@NonNull DataSnapshot snapshot) {\n+            if (snapshot.getValue() != null && snapshot.getValue().equals(42L)) {\n+              semaphore.release();\n+            }\n+          }\n+\n+          @Override\n+          public void onCancelled(@NonNull DatabaseError error) {}\n+        };\n+    ref.addValueEventListener(listener);\n+    ref.setValue(42L);\n+    IntegrationTestHelpers.waitFor(semaphore);\n+    db.goOffline();\n+    try {\n+      // Since we still have a listener on `ref`, the 42L should be cached here.\n+      assertEquals(42L, Tasks.await(ref.get()).getValue());\n+    } finally {\n+      ref.removeEventListener(listener);\n+    }\n+  }\n+\n+  @Test\n+  public void getRetrievesLatestServerValue()\n+      throws DatabaseException, InterruptedException, ExecutionException, TestFailure,\n+          TimeoutException {\n+    FirebaseApp readerApp =\n+        appForDatabaseUrl(IntegrationTestValues.getNamespace(), UUID.randomUUID().toString());\n+    FirebaseApp writerApp =\n+        appForDatabaseUrl(IntegrationTestValues.getNamespace(), UUID.randomUUID().toString());\n+    FirebaseDatabase readerDb = FirebaseDatabase.getInstance(readerApp);\n+    FirebaseDatabase writerDb = FirebaseDatabase.getInstance(writerApp);\n+    DatabaseReference reader = readerDb.getReference();\n+    DatabaseReference writer = writerDb.getReference();\n+\n+    final Semaphore readerSemaphore = new Semaphore(0);\n+    reader.addValueEventListener(\n+        new ValueEventListener() {\n+          @Override\n+          public void onDataChange(@NonNull DataSnapshot snapshot) {\n+            if (snapshot.getValue() != null && snapshot.getValue().equals(42L)) {\n+              readerSemaphore.release();\n+            }\n+          }\n+\n+          @Override\n+          public void onCancelled(@NonNull DatabaseError error) {}\n+        });\n+\n+    WriteFuture write = new WriteFuture(writer, 42L);\n+    assertNull(write.timedGet());\n+    IntegrationTestHelpers.waitFor(readerSemaphore);\n+\n+    write = new WriteFuture(writer, 43L);\n+    assertNull(write.timedGet());\n+\n+    try {\n+      assertEquals(43L, Tasks.await(reader.get()).getValue());\n+    } catch (ExecutionException e) {\n+      fail(e.getMessage());\n+    }\n+  }\n+\n+  @Test\n+  public void getUpdatesPersistenceCacheWhenEnabled()\n+      throws DatabaseException, InterruptedException, ExecutionException, TestFailure,\n+          TimeoutException {\n+    FirebaseApp readerApp =\n+        appForDatabaseUrl(IntegrationTestValues.getNamespace(), UUID.randomUUID().toString());\n+    FirebaseApp writerApp =\n+        appForDatabaseUrl(IntegrationTestValues.getNamespace(), UUID.randomUUID().toString());\n+    FirebaseDatabase readerDb = FirebaseDatabase.getInstance(readerApp);\n+    readerDb.setPersistenceEnabled(true);\n+    FirebaseDatabase writerDb = FirebaseDatabase.getInstance(writerApp);\n+    DatabaseReference reader = readerDb.getReference();\n+    DatabaseReference writer = writerDb.getReference();\n+\n+    assertNull(new WriteFuture(writer, 42L).timedGet());\n+    assertEquals(42L, Tasks.await(reader.get()).getValue());\n+\n+    readerDb.goOffline();\n+\n+    Semaphore semaphore = new Semaphore(0);\n+    reader.addListenerForSingleValueEvent(\n+        new ValueEventListener() {\n+          @Override\n+          public void onDataChange(@NonNull DataSnapshot snapshot) {\n+            if (snapshot.getValue() != null && snapshot.getValue().equals(42L)) {\n+              semaphore.release();\n+            }\n+          }\n+\n+          @Override\n+          public void onCancelled(@NonNull DatabaseError error) {}\n+        });\n+    IntegrationTestHelpers.waitFor(semaphore);", "originalCommit": "f55197738e97383d4516ceb88cd71c9d5992c98d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "33308ddee83da3d250be3ead0435c82f63b9324e", "chunk": "diff --git a/firebase-database/src/androidTest/java/com/google/firebase/database/QueryTest.java b/firebase-database/src/androidTest/java/com/google/firebase/database/QueryTest.java\nindex 43558d02..e3dc3ec6 100644\n--- a/firebase-database/src/androidTest/java/com/google/firebase/database/QueryTest.java\n+++ b/firebase-database/src/androidTest/java/com/google/firebase/database/QueryTest.java\n\n@@ -3419,15 +3419,11 @@ public class QueryTest {\n   }\n \n   @Test\n-  public void emptyQueryGet() throws DatabaseException, InterruptedException {\n+  public void emptyQueryGet() throws DatabaseException, InterruptedException, ExecutionException {\n     FirebaseApp app =\n         appForDatabaseUrl(IntegrationTestValues.getNamespace(), UUID.randomUUID().toString());\n     FirebaseDatabase db = FirebaseDatabase.getInstance(app);\n-    try {\n-      assertNull(Tasks.await(db.getReference(UUID.randomUUID().toString()).get()).getValue());\n-    } catch (ExecutionException e) {\n-      fail(e.getMessage());\n-    }\n+    assertNull(Tasks.await(db.getReference(UUID.randomUUID().toString()).get()).getValue());\n   }\n \n   @Test\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI2ODYwMg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2087#discussion_r518268602", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private Map<String, Object> request;\n          \n          \n            \n                private ConnectionRequestCallback onComplete;\n          \n          \n            \n                private String action;\n          \n          \n            \n                private AtomicBoolean sent;\n          \n          \n            \n                private final Map<String, Object> request;\n          \n          \n            \n                private final ConnectionRequestCallback onComplete;\n          \n          \n            \n                private final String action;\n          \n          \n            \n                private final AtomicBoolean sent;", "author": "schmidt-sebastian", "createdAt": "2020-11-05T18:23:42Z", "path": "firebase-database/src/main/java/com/google/firebase/database/connection/PersistentConnectionImpl.java", "diffHunk": "@@ -109,6 +113,41 @@ public String toString() {\n     }\n   }\n \n+  private static class OutstandingGet {\n+    private Map<String, Object> request;\n+    private ConnectionRequestCallback onComplete;\n+    private String action;\n+    private AtomicBoolean sent;", "originalCommit": "f55197738e97383d4516ceb88cd71c9d5992c98d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "33308ddee83da3d250be3ead0435c82f63b9324e", "chunk": "diff --git a/firebase-database/src/main/java/com/google/firebase/database/connection/PersistentConnectionImpl.java b/firebase-database/src/main/java/com/google/firebase/database/connection/PersistentConnectionImpl.java\nindex 180a6ce9..5b1b0f57 100644\n--- a/firebase-database/src/main/java/com/google/firebase/database/connection/PersistentConnectionImpl.java\n+++ b/firebase-database/src/main/java/com/google/firebase/database/connection/PersistentConnectionImpl.java\n\n@@ -114,17 +113,17 @@ public class PersistentConnectionImpl implements Connection.Delegate, Persistent\n   }\n \n   private static class OutstandingGet {\n-    private Map<String, Object> request;\n-    private ConnectionRequestCallback onComplete;\n-    private String action;\n-    private AtomicBoolean sent;\n+    private final Map<String, Object> request;\n+    private final ConnectionRequestCallback onComplete;\n+    private final String action;\n+    private boolean sent;\n \n     private OutstandingGet(\n         String action, Map<String, Object> request, ConnectionRequestCallback onComplete) {\n       this.action = action;\n       this.request = request;\n       this.onComplete = onComplete;\n-      this.sent = new AtomicBoolean(false);\n+      this.sent = false;\n     }\n \n     private String getAction() {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI3MjM4Mg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2087#discussion_r518272382", "bodyText": "This method seems unused.", "author": "schmidt-sebastian", "createdAt": "2020-11-05T18:29:59Z", "path": "firebase-database/src/main/java/com/google/firebase/database/connection/PersistentConnectionImpl.java", "diffHunk": "@@ -109,6 +113,41 @@ public String toString() {\n     }\n   }\n \n+  private static class OutstandingGet {\n+    private Map<String, Object> request;\n+    private ConnectionRequestCallback onComplete;\n+    private String action;\n+    private AtomicBoolean sent;\n+\n+    private OutstandingGet(\n+        String action, Map<String, Object> request, ConnectionRequestCallback onComplete) {\n+      this.action = action;\n+      this.request = request;\n+      this.onComplete = onComplete;\n+      this.sent = new AtomicBoolean(false);\n+    }\n+\n+    private String getAction() {\n+      return action;\n+    }\n+\n+    private ConnectionRequestCallback getOnComplete() {\n+      return onComplete;\n+    }\n+\n+    private Map<String, Object> getRequest() {\n+      return request;\n+    }\n+\n+    private boolean markSent() {\n+      return sent.compareAndSet(false, true);\n+    }\n+\n+    private boolean wasSent() {\n+      return sent.get();\n+    }", "originalCommit": "f55197738e97383d4516ceb88cd71c9d5992c98d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "33308ddee83da3d250be3ead0435c82f63b9324e", "chunk": "diff --git a/firebase-database/src/main/java/com/google/firebase/database/connection/PersistentConnectionImpl.java b/firebase-database/src/main/java/com/google/firebase/database/connection/PersistentConnectionImpl.java\nindex 180a6ce9..5b1b0f57 100644\n--- a/firebase-database/src/main/java/com/google/firebase/database/connection/PersistentConnectionImpl.java\n+++ b/firebase-database/src/main/java/com/google/firebase/database/connection/PersistentConnectionImpl.java\n\n@@ -114,17 +113,17 @@ public class PersistentConnectionImpl implements Connection.Delegate, Persistent\n   }\n \n   private static class OutstandingGet {\n-    private Map<String, Object> request;\n-    private ConnectionRequestCallback onComplete;\n-    private String action;\n-    private AtomicBoolean sent;\n+    private final Map<String, Object> request;\n+    private final ConnectionRequestCallback onComplete;\n+    private final String action;\n+    private boolean sent;\n \n     private OutstandingGet(\n         String action, Map<String, Object> request, ConnectionRequestCallback onComplete) {\n       this.action = action;\n       this.request = request;\n       this.onComplete = onComplete;\n-      this.sent = new AtomicBoolean(false);\n+      this.sent = false;\n     }\n \n     private String getAction() {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI3ODkxMA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2087#discussion_r518278910", "bodyText": "It took me a while to wade through all the callsites, but it seems like executorService is single-threaded and the is responsible for all access to outstandingGets. This means that markSent doesn't need to use an AtomicBoolean.", "author": "schmidt-sebastian", "createdAt": "2020-11-05T18:41:16Z", "path": "firebase-database/src/main/java/com/google/firebase/database/connection/PersistentConnectionImpl.java", "diffHunk": "@@ -344,6 +388,64 @@ public void listen(\n     doIdleCheck();\n   }\n \n+  @Override\n+  public Task<Object> get(List<String> path, Map<String, Object> queryParams) {\n+    QuerySpec query = new QuerySpec(path, queryParams);\n+    TaskCompletionSource<Object> source = new TaskCompletionSource<>();\n+\n+    long readId = this.readCounter++;\n+\n+    Map<String, Object> request = new HashMap<String, Object>();\n+    request.put(REQUEST_PATH, ConnectionUtils.pathToString(query.path));\n+    request.put(REQUEST_QUERIES, query.queryParams);\n+\n+    outstandingGets.put(\n+        readId,\n+        new OutstandingGet(\n+            REQUEST_ACTION_GET,\n+            request,\n+            new ConnectionRequestCallback() {\n+              @Override\n+              public void onResponse(Map<String, Object> response) {\n+                String status = (String) response.get(REQUEST_STATUS);\n+                if (status.equals(\"ok\")) {\n+                  Object body = response.get(SERVER_DATA_UPDATE_BODY);\n+                  delegate.onDataUpdate(query.path, body, /*isMerge=*/ false, /*tagNumber=*/ null);\n+                  source.setResult(body);\n+                } else {\n+                  source.setException(\n+                      new Exception((String) response.get(SERVER_DATA_UPDATE_BODY)));\n+                }\n+              }\n+            }));\n+\n+    if (!connected()) {\n+      executorService.schedule(\n+          new Runnable() {\n+            @Override\n+            public void run() {\n+              OutstandingGet get = outstandingGets.get(readId);\n+              if (get == null || !get.markSent()) {", "originalCommit": "f55197738e97383d4516ceb88cd71c9d5992c98d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "33308ddee83da3d250be3ead0435c82f63b9324e", "chunk": "diff --git a/firebase-database/src/main/java/com/google/firebase/database/connection/PersistentConnectionImpl.java b/firebase-database/src/main/java/com/google/firebase/database/connection/PersistentConnectionImpl.java\nindex 180a6ce9..5b1b0f57 100644\n--- a/firebase-database/src/main/java/com/google/firebase/database/connection/PersistentConnectionImpl.java\n+++ b/firebase-database/src/main/java/com/google/firebase/database/connection/PersistentConnectionImpl.java\n\n@@ -399,8 +399,7 @@ public class PersistentConnectionImpl implements Connection.Delegate, Persistent\n     request.put(REQUEST_PATH, ConnectionUtils.pathToString(query.path));\n     request.put(REQUEST_QUERIES, query.queryParams);\n \n-    outstandingGets.put(\n-        readId,\n+    OutstandingGet outstandingGet =\n         new OutstandingGet(\n             REQUEST_ACTION_GET,\n             request,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI4MDQxNA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2087#discussion_r518280414", "bodyText": "This should only ever be hit when cancelled, or not?", "author": "schmidt-sebastian", "createdAt": "2020-11-05T18:43:55Z", "path": "firebase-database/src/main/java/com/google/firebase/database/connection/PersistentConnectionImpl.java", "diffHunk": "@@ -1049,6 +1162,34 @@ public void onResponse(Map<String, Object> response) {\n         });\n   }\n \n+  private void sendGet(final Long readId) {\n+    hardAssert(canSendReads(), \"sendGet called when we can't send gets\");\n+    OutstandingGet get = outstandingGets.get(readId);\n+    if (!get.markSent()) {\n+      if (logger.logsDebug()) {\n+        logger.debug(\"get\" + readId + \" already sent or cancelled, ignoring.\");", "originalCommit": "f55197738e97383d4516ceb88cd71c9d5992c98d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "33308ddee83da3d250be3ead0435c82f63b9324e", "chunk": "diff --git a/firebase-database/src/main/java/com/google/firebase/database/connection/PersistentConnectionImpl.java b/firebase-database/src/main/java/com/google/firebase/database/connection/PersistentConnectionImpl.java\nindex 180a6ce9..5b1b0f57 100644\n--- a/firebase-database/src/main/java/com/google/firebase/database/connection/PersistentConnectionImpl.java\n+++ b/firebase-database/src/main/java/com/google/firebase/database/connection/PersistentConnectionImpl.java\n\n@@ -1167,7 +1167,7 @@ public class PersistentConnectionImpl implements Connection.Delegate, Persistent\n     OutstandingGet get = outstandingGets.get(readId);\n     if (!get.markSent()) {\n       if (logger.logsDebug()) {\n-        logger.debug(\"get\" + readId + \" already sent or cancelled, ignoring.\");\n+        logger.debug(\"get\" + readId + \" cancelled, ignoring.\");\n         return;\n       }\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI4MDc0MQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2087#discussion_r518280741", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        } else {\n          \n          \n            \n                          if (logger.logsDebug())\n          \n          \n            \n                            logger.debug(\n          \n          \n            \n                                \"Ignoring on complete for get \" + readId + \" because it was removed already.\");\n          \n          \n            \n                        }\n          \n          \n            \n                        } else if (logger.logsDebug()) {\n          \n          \n            \n                            logger.debug(\n          \n          \n            \n                                \"Ignoring on complete for get \" + readId + \" because it was removed already.\");\n          \n          \n            \n                        }", "author": "schmidt-sebastian", "createdAt": "2020-11-05T18:44:29Z", "path": "firebase-database/src/main/java/com/google/firebase/database/connection/PersistentConnectionImpl.java", "diffHunk": "@@ -1049,6 +1162,34 @@ public void onResponse(Map<String, Object> response) {\n         });\n   }\n \n+  private void sendGet(final Long readId) {\n+    hardAssert(canSendReads(), \"sendGet called when we can't send gets\");\n+    OutstandingGet get = outstandingGets.get(readId);\n+    if (!get.markSent()) {\n+      if (logger.logsDebug()) {\n+        logger.debug(\"get\" + readId + \" already sent or cancelled, ignoring.\");\n+        return;\n+      }\n+    }\n+    sendAction(\n+        get.getAction(),\n+        get.getRequest(),\n+        new ConnectionRequestCallback() {\n+          @Override\n+          public void onResponse(Map<String, Object> response) {\n+            OutstandingGet currentGet = outstandingGets.get(readId);\n+            if (currentGet == get) {\n+              outstandingGets.remove(readId);\n+              get.getOnComplete().onResponse(response);\n+            } else {\n+              if (logger.logsDebug())\n+                logger.debug(\n+                    \"Ignoring on complete for get \" + readId + \" because it was removed already.\");\n+            }", "originalCommit": "f55197738e97383d4516ceb88cd71c9d5992c98d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "33308ddee83da3d250be3ead0435c82f63b9324e", "chunk": "diff --git a/firebase-database/src/main/java/com/google/firebase/database/connection/PersistentConnectionImpl.java b/firebase-database/src/main/java/com/google/firebase/database/connection/PersistentConnectionImpl.java\nindex 180a6ce9..5b1b0f57 100644\n--- a/firebase-database/src/main/java/com/google/firebase/database/connection/PersistentConnectionImpl.java\n+++ b/firebase-database/src/main/java/com/google/firebase/database/connection/PersistentConnectionImpl.java\n\n@@ -1167,7 +1167,7 @@ public class PersistentConnectionImpl implements Connection.Delegate, Persistent\n     OutstandingGet get = outstandingGets.get(readId);\n     if (!get.markSent()) {\n       if (logger.logsDebug()) {\n-        logger.debug(\"get\" + readId + \" already sent or cancelled, ignoring.\");\n+        logger.debug(\"get\" + readId + \" cancelled, ignoring.\");\n         return;\n       }\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI4MTU0Nw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2087#discussion_r518281547", "bodyText": "Can this be done in the OnCompletedListener?", "author": "schmidt-sebastian", "createdAt": "2020-11-05T18:45:50Z", "path": "firebase-database/src/main/java/com/google/firebase/database/core/Repo.java", "diffHunk": "@@ -462,6 +468,61 @@ public void onRequestResult(String optErrorCode, String optErrorMessage) {\n     this.rerunTransactions(affectedPath);\n   }\n \n+  public Task<DataSnapshot> getValue(Query query) {\n+    TaskCompletionSource<DataSnapshot> source = new TaskCompletionSource<>();\n+    this.scheduleNow(\n+        new Runnable() {\n+          @Override\n+          public void run() {\n+            serverSyncTree.setQueryActive(query.getSpec());\n+            connection\n+                .get(query.getPath().asList(), query.getSpec().getParams().getWireProtocolParams())\n+                .addOnCompleteListener(\n+                    new OnCompleteListener<Object>() {\n+                      @Override\n+                      public void onComplete(@NonNull Task<Object> task) {\n+                        if (!task.isSuccessful()) {\n+                          operationLogger.info(\n+                              \"get for query \"\n+                                  + query.getPath()\n+                                  + \" falling back to cache after error: \"\n+                                  + task.getException().getMessage());\n+                          Node cached =\n+                              serverSyncTree.calcCompleteEventCache(\n+                                  query.getPath(), new ArrayList<>());\n+                          if (cached.isEmpty()) {\n+                            source.setException(task.getException());\n+                          } else {\n+                            source.setResult(\n+                                InternalHelpers.createDataSnapshot(\n+                                    query.getRef(),\n+                                    IndexedNode.from(cached, query.getSpec().getIndex())));\n+                          }\n+                        } else {\n+                          Node serverNode = NodeUtilities.NodeFromJSON(task.getResult());\n+                          postEvents(\n+                              serverSyncTree.applyServerOverwrite(query.getPath(), serverNode));\n+                          source.setResult(\n+                              InternalHelpers.createDataSnapshot(\n+                                  query.getRef(),\n+                                  IndexedNode.from(serverNode, query.getSpec().getIndex())));\n+                        }\n+                      }\n+                    });\n+          }\n+        });\n+    return source\n+        .getTask()\n+        .continueWithTask(\n+            new Continuation<DataSnapshot, Task<DataSnapshot>>() {\n+              @Override\n+              public Task<DataSnapshot> then(@NonNull Task<DataSnapshot> task) throws Exception {\n+                serverSyncTree.setQueryInactive(query.getSpec());", "originalCommit": "f55197738e97383d4516ceb88cd71c9d5992c98d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "33308ddee83da3d250be3ead0435c82f63b9324e", "chunk": "diff --git a/firebase-database/src/main/java/com/google/firebase/database/core/Repo.java b/firebase-database/src/main/java/com/google/firebase/database/core/Repo.java\nindex 5ad426ec..117780a9 100644\n--- a/firebase-database/src/main/java/com/google/firebase/database/core/Repo.java\n+++ b/firebase-database/src/main/java/com/google/firebase/database/core/Repo.java\n\n@@ -513,12 +512,11 @@ public class Repo implements PersistentConnection.Delegate {\n         });\n     return source\n         .getTask()\n-        .continueWithTask(\n-            new Continuation<DataSnapshot, Task<DataSnapshot>>() {\n+        .addOnCompleteListener(\n+            new OnCompleteListener<DataSnapshot>() {\n               @Override\n-              public Task<DataSnapshot> then(@NonNull Task<DataSnapshot> task) throws Exception {\n+              public void onComplete(@NonNull Task<DataSnapshot> task) {\n                 serverSyncTree.setQueryInactive(query.getSpec());\n-                return task;\n               }\n             });\n   }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI4MTc0MQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2087#discussion_r518281741", "bodyText": "This is much easier than I thought it would be. Thanks for figuring this out.", "author": "schmidt-sebastian", "createdAt": "2020-11-05T18:46:13Z", "path": "firebase-database/src/main/java/com/google/firebase/database/core/SyncTree.java", "diffHunk": "@@ -454,6 +454,28 @@ public boolean isEmpty() {\n         });\n   }\n \n+  public void setQueryActive(QuerySpec query) {\n+    persistenceManager.runInTransaction(\n+        new Callable<Void>() {\n+          @Override\n+          public Void call() {\n+            persistenceManager.setQueryActive(query);\n+            return null;\n+          }\n+        });\n+  }\n+\n+  public void setQueryInactive(QuerySpec query) {\n+    persistenceManager.runInTransaction(\n+        new Callable<Void>() {\n+          @Override\n+          public Void call() {\n+            persistenceManager.setQueryInactive(query);\n+            return null;\n+          }\n+        });\n+  }", "originalCommit": "f55197738e97383d4516ceb88cd71c9d5992c98d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "33308ddee83da3d250be3ead0435c82f63b9324e", "url": "https://github.com/firebase/firebase-android-sdk/commit/33308ddee83da3d250be3ead0435c82f63b9324e", "message": "more review feedback", "committedDate": "2020-11-11T23:38:52Z", "type": "commit"}, {"oid": "33fdaa0d91c56e164c6a6fa43332224f08f575f6", "url": "https://github.com/firebase/firebase-android-sdk/commit/33fdaa0d91c56e164c6a6fa43332224f08f575f6", "message": "comment + remove action from outstanding get", "committedDate": "2020-11-12T00:50:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjUzMTcxMw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2087#discussion_r522531713", "bodyText": "Looks like we can inline prev and drop the this..\nThis function should probably also have a short comment on what the return type is - or a more descriptive name.", "author": "schmidt-sebastian", "createdAt": "2020-11-13T00:45:23Z", "path": "firebase-database/src/main/java/com/google/firebase/database/connection/PersistentConnectionImpl.java", "diffHunk": "@@ -140,11 +139,12 @@ private ConnectionRequestCallback getOnComplete() {\n     }\n \n     private boolean markSent() {\n-      return sent.compareAndSet(false, true);\n-    }\n-\n-    private boolean wasSent() {\n-      return sent.get();\n+      boolean prev = sent;\n+      if (prev) {\n+        return false;\n+      }\n+      this.sent = true;\n+      return true;", "originalCommit": "33308ddee83da3d250be3ead0435c82f63b9324e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "7a8e35214a878341aca97a4c1df3c4fd98b3a694", "chunk": "diff --git a/firebase-database/src/main/java/com/google/firebase/database/connection/PersistentConnectionImpl.java b/firebase-database/src/main/java/com/google/firebase/database/connection/PersistentConnectionImpl.java\nindex 5b1b0f57..404d1294 100644\n--- a/firebase-database/src/main/java/com/google/firebase/database/connection/PersistentConnectionImpl.java\n+++ b/firebase-database/src/main/java/com/google/firebase/database/connection/PersistentConnectionImpl.java\n\n@@ -138,12 +132,16 @@ public class PersistentConnectionImpl implements Connection.Delegate, Persistent\n       return request;\n     }\n \n+    /**\n+     * Mark this OutstandingGet as sent. Essentially compare-and-set on the `sent` member.\n+     *\n+     * @return true if the OustandingGet wasn't already sent, false if it was.\n+     */\n     private boolean markSent() {\n-      boolean prev = sent;\n-      if (prev) {\n+      if (sent) {\n         return false;\n       }\n-      this.sent = true;\n+      sent = true;\n       return true;\n     }\n   }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjUzNDYwOA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2087#discussion_r522534608", "bodyText": "Could we just use outstandingGet here rather than retrieve it from the list?", "author": "schmidt-sebastian", "createdAt": "2020-11-13T00:49:06Z", "path": "firebase-database/src/main/java/com/google/firebase/database/connection/PersistentConnectionImpl.java", "diffHunk": "@@ -417,15 +416,16 @@ public void onResponse(Map<String, Object> response) {\n                       new Exception((String) response.get(SERVER_DATA_UPDATE_BODY)));\n                 }\n               }\n-            }));\n+            });\n+    outstandingGets.put(readId, outstandingGet);\n \n     if (!connected()) {\n       executorService.schedule(\n           new Runnable() {\n             @Override\n             public void run() {\n               OutstandingGet get = outstandingGets.get(readId);\n-              if (get == null || !get.markSent()) {\n+              if (get == null || get != outstandingGet || !get.markSent()) {", "originalCommit": "33308ddee83da3d250be3ead0435c82f63b9324e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "7a8e35214a878341aca97a4c1df3c4fd98b3a694", "chunk": "diff --git a/firebase-database/src/main/java/com/google/firebase/database/connection/PersistentConnectionImpl.java b/firebase-database/src/main/java/com/google/firebase/database/connection/PersistentConnectionImpl.java\nindex 5b1b0f57..404d1294 100644\n--- a/firebase-database/src/main/java/com/google/firebase/database/connection/PersistentConnectionImpl.java\n+++ b/firebase-database/src/main/java/com/google/firebase/database/connection/PersistentConnectionImpl.java\n\n@@ -424,8 +422,7 @@ public class PersistentConnectionImpl implements Connection.Delegate, Persistent\n           new Runnable() {\n             @Override\n             public void run() {\n-              OutstandingGet get = outstandingGets.get(readId);\n-              if (get == null || get != outstandingGet || !get.markSent()) {\n+              if (!outstandingGet.markSent()) {\n                 return;\n               }\n               if (logger.logsDebug()) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzEyMDcxOA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2087#discussion_r523120718", "bodyText": "Please remove", "author": "schmidt-sebastian", "createdAt": "2020-11-13T17:44:40Z", "path": "firebase-database/src/androidTest/java/com/google/firebase/database/QueryTest.java", "diffHunk": "@@ -3401,6 +3407,145 @@ public void onComplete(DatabaseError error, DatabaseReference ref) {\n     IntegrationTestHelpers.waitFor(semaphore);\n   }\n \n+  private static FirebaseApp appForDatabaseUrl(String url, String name) {\n+    return FirebaseApp.initializeApp(\n+        InstrumentationRegistry.getInstrumentation().getTargetContext(),\n+        new FirebaseOptions.Builder()\n+            .setApplicationId(\"appid\")\n+            .setApiKey(\"apikey\")\n+            .setDatabaseUrl(url)\n+            .build(),\n+        name);\n+  }\n+\n+  @Test\n+  public void emptyQueryGet() throws DatabaseException, InterruptedException, ExecutionException {\n+    FirebaseApp app =\n+        appForDatabaseUrl(IntegrationTestValues.getNamespace(), UUID.randomUUID().toString());\n+    FirebaseDatabase db = FirebaseDatabase.getInstance(app);\n+    assertNull(Tasks.await(db.getReference(UUID.randomUUID().toString()).get()).getValue());\n+  }\n+\n+  @Test\n+  public void offlineQueryGet() throws DatabaseException, InterruptedException {\n+    FirebaseApp app =\n+        appForDatabaseUrl(IntegrationTestValues.getNamespace(), UUID.randomUUID().toString());\n+    FirebaseDatabase db = FirebaseDatabase.getInstance(app);\n+    db.setLogLevel(Logger.Level.DEBUG);", "originalCommit": "33fdaa0d91c56e164c6a6fa43332224f08f575f6", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "7a8e35214a878341aca97a4c1df3c4fd98b3a694", "chunk": "diff --git a/firebase-database/src/androidTest/java/com/google/firebase/database/QueryTest.java b/firebase-database/src/androidTest/java/com/google/firebase/database/QueryTest.java\nindex e3dc3ec6..ef3a55c9 100644\n--- a/firebase-database/src/androidTest/java/com/google/firebase/database/QueryTest.java\n+++ b/firebase-database/src/androidTest/java/com/google/firebase/database/QueryTest.java\n\n@@ -3431,7 +3431,6 @@ public class QueryTest {\n     FirebaseApp app =\n         appForDatabaseUrl(IntegrationTestValues.getNamespace(), UUID.randomUUID().toString());\n     FirebaseDatabase db = FirebaseDatabase.getInstance(app);\n-    db.setLogLevel(Logger.Level.DEBUG);\n     DatabaseReference node = db.getReference();\n     db.goOffline();\n     try {\n"}}, {"oid": "7a8e35214a878341aca97a4c1df3c4fd98b3a694", "url": "https://github.com/firebase/firebase-android-sdk/commit/7a8e35214a878341aca97a4c1df3c4fd98b3a694", "message": "cleanup", "committedDate": "2020-11-13T20:43:57Z", "type": "commit"}]}