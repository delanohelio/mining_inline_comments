{"pr_number": 1336, "pr_title": "Consolidate remaining 'core' classes into 'internal/common'", "pr_createdAt": "2020-03-10T19:39:54Z", "pr_url": "https://github.com/firebase/firebase-android-sdk/pull/1336", "timeline": [{"oid": "80de9ee10a51b471604952a5fbdf7917344d83b5", "url": "https://github.com/firebase/firebase-android-sdk/commit/80de9ee10a51b471604952a5fbdf7917344d83b5", "message": "Move remaining 'core' classes to internal/common", "committedDate": "2020-03-10T19:24:31Z", "type": "commit"}, {"oid": "5610b7116de356bdab5e273ee904b12c80ea8db5", "url": "https://github.com/firebase/firebase-android-sdk/commit/5610b7116de356bdab5e273ee904b12c80ea8db5", "message": "Reduce unnecessary class visibility", "committedDate": "2020-03-10T19:35:58Z", "type": "commit"}, {"oid": "c8ac55919cdd7b41e6b6fc932db60d69b7351504", "url": "https://github.com/firebase/firebase-android-sdk/commit/c8ac55919cdd7b41e6b6fc932db60d69b7351504", "message": "Formatting", "committedDate": "2020-03-10T19:38:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDU2ODUzNQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1336#discussion_r390568535", "bodyText": "Thread.sleep behaviors are not ideal in tests because it can slow your overall test suite. Are there any alternative ways we could do this (e.g., abstract / mock more systems, or loop and check for state existing within some time bounds, and exit early if state becomes present?", "author": "jakeouellette", "createdAt": "2020-03-10T19:46:16Z", "path": "firebase-crashlytics/src/androidTest/java/com/google/firebase/crashlytics/internal/common/CommonUtilsTest.java", "diffHunk": "@@ -288,6 +295,71 @@ public void testResolveBuildId_bothIds() throws Exception {\n         });\n   }\n \n+  public void testCapFileCount() throws Exception {\n+    final Context context = getContext();\n+\n+    final File testDir = new File(context.getFilesDir(), \"trim_test\");\n+    testDir.mkdirs();\n+    // make sure the directory is empty. Doesn't recurse into subdirs, but that's OK since\n+    // we're only using this directory for this test and we won't create any subdirs.\n+    for (File f : testDir.listFiles()) {\n+      if (f.isFile()) {\n+        f.delete();\n+      }\n+    }\n+\n+    final int maxFiles = 4;\n+    // create a bunch of non-cls files that don't match the capFileCount\n+    for (int i = 0; i < maxFiles + 2; ++i) {\n+      new File(testDir, \"whatever\" + i + \".blah\").createNewFile();\n+    }\n+    assertEquals(maxFiles + 2, testDir.listFiles().length);\n+    final FilenameFilter clsFilter = CrashlyticsController.SESSION_FILE_FILTER;\n+    // This should have no effect - nothing matches the filter yet\n+    Utils.capFileCount(\n+        testDir, clsFilter, maxFiles, CrashlyticsController.SMALLEST_FILE_NAME_FIRST);\n+    assertEquals(maxFiles + 2, testDir.listFiles().length);\n+\n+    // create two groups of empty crash files. The first set will be deleted after the 2nd\n+    // is created and trim is invoked.\n+    final Set<File> oldFiles = new HashSet<File>();\n+    for (int i = 0; i < maxFiles; ++i) {\n+      oldFiles.add(createEmptyClsFile(testDir));\n+\n+      // This should have no effect - we're not over the limit\n+      Utils.capFileCount(\n+          testDir, clsFilter, maxFiles, CrashlyticsController.SMALLEST_FILE_NAME_FIRST);\n+      assertEquals(oldFiles.size(), testDir.listFiles(clsFilter).length);\n+    }\n+    // The filesystem only has 1sec precision, so we need to sleep long enough that\n+    // the timestamps in the 2nd set of files are later than the ones in the first.\n+    Thread.sleep(1500);", "originalCommit": "c8ac55919cdd7b41e6b6fc932db60d69b7351504", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "71b6bca4e1cef46d54e1d853f9ca8ea7f6517cd6", "url": "https://github.com/firebase/firebase-android-sdk/commit/71b6bca4e1cef46d54e1d853f9ca8ea7f6517cd6", "message": "Fix test", "committedDate": "2020-03-10T19:59:59Z", "type": "commit"}]}