{"pr_number": 1323, "pr_title": "Simplify finalizing native reports", "pr_createdAt": "2020-03-06T18:59:28Z", "pr_url": "https://github.com/firebase/firebase-android-sdk/pull/1323", "timeline": [{"oid": "3d7cce192defdc89417e49dc5b6c7d419832fde3", "url": "https://github.com/firebase/firebase-android-sdk/commit/3d7cce192defdc89417e49dc5b6c7d419832fde3", "message": "Simplify finalizing native reports\n\nCollapse finalizing previous native report into existing session\nfinalize operation.", "committedDate": "2020-03-06T18:58:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTA4Nzc2NQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1323#discussion_r389087765", "bodyText": "can you add some justification for why this is an else if? why do we only do native stuff if includeCurrent = false? Why do we not do it if includeCurrent = false?", "author": "jakeouellette", "createdAt": "2020-03-06T19:07:25Z", "path": "firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/core/CrashlyticsController.java", "diffHunk": "@@ -858,6 +858,9 @@ private void doCloseSessions(int maxCustomExceptionEvents, boolean includeCurren\n \n     if (includeCurrent) {\n       reportingCoordinator.onEndSession();\n+    } else if (nativeComponent.hasCrashDataForSession(mostRecentSessionIdToClose)) {", "originalCommit": "3d7cce192defdc89417e49dc5b6c7d419832fde3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE1MjAwMg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1323#discussion_r389152002", "bodyText": "Yeah, this is one of those \"the code needs more cleaning\" issues. includeCurrent implies this is being run at Java crash time. We only want to run this code for the startup-time initialize.", "author": "mrwillis21", "createdAt": "2020-03-06T21:26:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTA4Nzc2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE3MjMyMA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1323#discussion_r389172320", "bodyText": "Added a comment.", "author": "mrwillis21", "createdAt": "2020-03-06T22:20:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTA4Nzc2NQ=="}], "type": "inlineReview", "revised_code": {"commit": "717df0056d48d92b74169ba097ae630258dda0d2", "chunk": "diff --git a/firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/core/CrashlyticsController.java b/firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/core/CrashlyticsController.java\nindex 48492820b..23f9bb081 100644\n--- a/firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/core/CrashlyticsController.java\n+++ b/firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/core/CrashlyticsController.java\n\n@@ -859,8 +859,13 @@ class CrashlyticsController {\n     if (includeCurrent) {\n       reportingCoordinator.onEndSession();\n     } else if (nativeComponent.hasCrashDataForSession(mostRecentSessionIdToClose)) {\n+      // We only finalize the current session if it's a Java crash, so only finalize native crash\n+      // data when we aren't including current.\n       finalizePreviousNativeSession(mostRecentSessionIdToClose);\n-      nativeComponent.finalizeSession(mostRecentSessionIdToClose);\n+      if (!nativeComponent.finalizeSession(mostRecentSessionIdToClose)) {\n+        Logger.getLogger()\n+            .d(Logger.TAG, \"Could not finalize native session: \" + mostRecentSessionIdToClose);\n+      }\n     }\n \n     closeOpenSessions(sessionBeginFiles, offset, maxCustomExceptionEvents);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTA4ODcyOQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1323#discussion_r389088729", "bodyText": "before we were returning a boolean and logging based on it, do we need to do an equivalent?", "author": "jakeouellette", "createdAt": "2020-03-06T19:09:30Z", "path": "firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/core/CrashlyticsController.java", "diffHunk": "@@ -858,6 +858,9 @@ private void doCloseSessions(int maxCustomExceptionEvents, boolean includeCurren\n \n     if (includeCurrent) {\n       reportingCoordinator.onEndSession();\n+    } else if (nativeComponent.hasCrashDataForSession(mostRecentSessionIdToClose)) {\n+      finalizePreviousNativeSession(mostRecentSessionIdToClose);\n+      nativeComponent.finalizeSession(mostRecentSessionIdToClose);", "originalCommit": "3d7cce192defdc89417e49dc5b6c7d419832fde3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE1MjUxMQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1323#discussion_r389152511", "bodyText": "Yeah, no harm in that.", "author": "mrwillis21", "createdAt": "2020-03-06T21:27:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTA4ODcyOQ=="}], "type": "inlineReview", "revised_code": {"commit": "717df0056d48d92b74169ba097ae630258dda0d2", "chunk": "diff --git a/firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/core/CrashlyticsController.java b/firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/core/CrashlyticsController.java\nindex 48492820b..23f9bb081 100644\n--- a/firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/core/CrashlyticsController.java\n+++ b/firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/core/CrashlyticsController.java\n\n@@ -859,8 +859,13 @@ class CrashlyticsController {\n     if (includeCurrent) {\n       reportingCoordinator.onEndSession();\n     } else if (nativeComponent.hasCrashDataForSession(mostRecentSessionIdToClose)) {\n+      // We only finalize the current session if it's a Java crash, so only finalize native crash\n+      // data when we aren't including current.\n       finalizePreviousNativeSession(mostRecentSessionIdToClose);\n-      nativeComponent.finalizeSession(mostRecentSessionIdToClose);\n+      if (!nativeComponent.finalizeSession(mostRecentSessionIdToClose)) {\n+        Logger.getLogger()\n+            .d(Logger.TAG, \"Could not finalize native session: \" + mostRecentSessionIdToClose);\n+      }\n     }\n \n     closeOpenSessions(sessionBeginFiles, offset, maxCustomExceptionEvents);\n"}}, {"oid": "717df0056d48d92b74169ba097ae630258dda0d2", "url": "https://github.com/firebase/firebase-android-sdk/commit/717df0056d48d92b74169ba097ae630258dda0d2", "message": "Feedback", "committedDate": "2020-03-06T22:00:48Z", "type": "commit"}, {"oid": "c7153175780df858375c4bbace253888a733f5f6", "url": "https://github.com/firebase/firebase-android-sdk/commit/c7153175780df858375c4bbace253888a733f5f6", "message": "Merge master", "committedDate": "2020-03-06T22:08:14Z", "type": "commit"}, {"oid": "2fbc2692457d1b245f3f704d28210ee5672cc77b", "url": "https://github.com/firebase/firebase-android-sdk/commit/2fbc2692457d1b245f3f704d28210ee5672cc77b", "message": "Formatting", "committedDate": "2020-03-06T22:38:52Z", "type": "commit"}]}