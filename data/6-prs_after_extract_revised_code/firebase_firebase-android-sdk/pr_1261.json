{"pr_number": 1261, "pr_title": "Add captured logs to Crashlytics reports", "pr_createdAt": "2020-02-20T17:43:46Z", "pr_url": "https://github.com/firebase/firebase-android-sdk/pull/1261", "timeline": [{"oid": "54681a53b513e3cfd8693aa7d6e241f92004a847", "url": "https://github.com/firebase/firebase-android-sdk/commit/54681a53b513e3cfd8693aa7d6e241f92004a847", "message": "Add captured logs to Crashlytics reports", "committedDate": "2020-02-20T17:43:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI4NDk4Mw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1261#discussion_r382284983", "bodyText": "This makes sense, but I want to talk out a naming thing that is going on here: You designed this manager as a \"listener\" as events. onBeginSession, onFatalEvent, onEndSession all make sense to me as lifecycle events because they're outside of the operation of this collaborator, and crashlytics is acting as listener of them. onLog (and to some degree,onNonFatalEvent) are a little different because the user explicitly calls it, right? In this case, we're not listening to a log occuring, we're listening to the app logging the information. I find it a little weird that onLog results in logging, but \ud83e\udd37\u200d\u2642 I can't really think of a different way to name this.", "author": "jakeouellette", "createdAt": "2020-02-20T22:07:19Z", "path": "firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/internal/common/FirebaseCrashlyticsReportManager.java", "diffHunk": "@@ -75,6 +80,11 @@ public void onNonFatalEvent(Throwable event, Thread thread) {\n     onEvent(event, thread, EVENT_TYPE_LOGGED, false);\n   }\n \n+  @Override\n+  public void onLog(long timestamp, String log) {", "originalCommit": "54681a53b513e3cfd8693aa7d6e241f92004a847", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI4OTE3Mg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1261#discussion_r382289172", "bodyText": "In my mind, the \"event\" happening here is a \"user requests a log to be written\" event, which is one event that can happen during the lifecycle of a session. (I'm pretty certain I'm going to rename the interface to SessionLifecycleEvents, as it happens).\nSimilar to a \"button press\" event, it's user-initiated, but still an event.", "author": "mrwillis21", "createdAt": "2020-02-20T22:17:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI4NDk4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI5NDgwOA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1261#discussion_r382294808", "bodyText": "It isn't the end user requesting that log though, it's likely some internal collaborator class. If you were implementing the code for onButtonPress, you would probably have code in a controller that called a class with a method that looked like sendForm(...), not one that looked like onFormSent(...) The collaborator is requesting the sendForm action being taken, in that example. The expectation is a form gets sent.\nI think the lifecycle idea works for session start / session ends, because you're abstracting away the meaning of them, but if we're planning to add lots of methods like onCustomKeys(...) it makes me wonder how much the lifecycle naming works.", "author": "jakeouellette", "createdAt": "2020-02-20T22:30:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI4NDk4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjMwNTU5OA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1261#discussion_r382305598", "bodyText": "Talked about this offline, decided there's a good opportunity for some better interfacing here, but we'll break that out in a separate PR.", "author": "mrwillis21", "createdAt": "2020-02-20T22:57:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI4NDk4Mw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI4NTYxNQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1261#discussion_r382285615", "bodyText": "out of curiosity, what's the threading model of the method this code is in? is it always on a single thread?", "author": "jakeouellette", "createdAt": "2020-02-20T22:08:46Z", "path": "firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/internal/common/FirebaseCrashlyticsReportManager.java", "diffHunk": "@@ -99,19 +109,31 @@ private void onEvent(\n       Throwable event, Thread thread, String eventType, boolean includeAllThreads) {\n     final long timestamp = currentTimeProvider.getCurrentTimeMillis() / 1000;\n \n-    final CrashlyticsReport.Session.Event capturedEvent =\n-        dataCapture.captureEventData(\n-            event,\n-            thread,\n-            eventType,\n-            timestamp,\n-            EVENT_THREAD_IMPORTANCE,\n-            MAX_CHAINED_EXCEPTION_DEPTH,\n-            includeAllThreads);\n-\n     final boolean isHighPriority = eventType.equals(EVENT_TYPE_CRASH);\n \n-    reportPersistence.persistEvent(capturedEvent, currentSessionId, isHighPriority);\n+    CrashlyticsReport.Session.Event.Builder eventBuilder =\n+        dataCapture\n+            .captureEventData(\n+                event,\n+                thread,\n+                eventType,\n+                timestamp,\n+                EVENT_THREAD_IMPORTANCE,\n+                MAX_CHAINED_EXCEPTION_DEPTH,\n+                includeAllThreads)\n+            .toBuilder();\n+\n+    final String content = logFileManager.getLogString();", "originalCommit": "54681a53b513e3cfd8693aa7d6e241f92004a847", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI4ODA0MQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1261#discussion_r382288041", "bodyText": "For now, yes. It's all synchronous. My goal is to push threading as far out to the callers as possible.", "author": "mrwillis21", "createdAt": "2020-02-20T22:14:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI4NTYxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI5MzQ0OQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1261#discussion_r382293449", "bodyText": "That is, it isn't intended to be thread-safe (yet).", "author": "mrwillis21", "createdAt": "2020-02-20T22:27:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI4NTYxNQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI4NjI2Mg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1261#discussion_r382286262", "bodyText": "I'm not sure I understand why this is null", "author": "jakeouellette", "createdAt": "2020-02-20T22:10:15Z", "path": "firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/internal/log/LogFileManager.java", "diffHunk": "@@ -142,6 +146,11 @@ public void writeToLog(long timestamp, String msg) {}\n       return null;\n     }\n \n+    @Override\n+    public String getLogAsString() {\n+      return null;", "originalCommit": "54681a53b513e3cfd8693aa7d6e241f92004a847", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI4OTQxMA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1261#discussion_r382289410", "bodyText": "Look at the context - this is a no-op implementation.", "author": "mrwillis21", "createdAt": "2020-02-20T22:17:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI4NjI2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI5NTc2Ng==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1261#discussion_r382295766", "bodyText": "ahh, should it be returning \"\" then? (Same story with the bytes one -- should it be returning an empty array?) (Should we document the expected outputs in the FileLogStore interface?)", "author": "jakeouellette", "createdAt": "2020-02-20T22:32:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI4NjI2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjMwNTgzMQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1261#discussion_r382305831", "bodyText": "Good opportunities for improvement. I'll add a TODO nullability annotation.", "author": "mrwillis21", "createdAt": "2020-02-20T22:57:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI4NjI2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjMwNjkzMA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1261#discussion_r382306930", "bodyText": "Also, to answer your question, no - the intent is that null means there is no data, separate from a potentially empty log line \"\".", "author": "mrwillis21", "createdAt": "2020-02-20T23:00:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI4NjI2Mg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI4Njk4NA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1261#discussion_r382286984", "bodyText": "Can we add a comment as to why this is a TODO?", "author": "jakeouellette", "createdAt": "2020-02-20T22:11:55Z", "path": "firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/internal/model/CrashlyticsReport.java", "diffHunk": "@@ -84,6 +84,13 @@ public static Builder builder() {\n   @NonNull\n   public abstract Session getSession();\n \n+  // TODO", "originalCommit": "54681a53b513e3cfd8693aa7d6e241f92004a847", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI4OTU0Nw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1261#discussion_r382289547", "bodyText": "Because we haven't implemented NDK yet. I'll add that to the TODO.", "author": "mrwillis21", "createdAt": "2020-02-20T22:18:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI4Njk4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI5NTgxMg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1261#discussion_r382295812", "bodyText": "\ud83d\udc4d", "author": "jakeouellette", "createdAt": "2020-02-20T22:32:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI4Njk4NA=="}], "type": "inlineReview", "revised_code": {"commit": "7d45c71ad8b58b5cccd8221804f080ee26e55954", "chunk": "diff --git a/firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/internal/model/CrashlyticsReport.java b/firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/internal/model/CrashlyticsReport.java\nindex 5071b080..a23dd280 100644\n--- a/firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/internal/model/CrashlyticsReport.java\n+++ b/firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/internal/model/CrashlyticsReport.java\n\n@@ -84,7 +84,7 @@ public abstract class CrashlyticsReport {\n   @NonNull\n   public abstract Session getSession();\n \n-  // TODO\n+  // TODO: Add back once NDK data is ready to be serialized\n   // @Nullable\n   // public abstract byte[] getNdkPayload();\n \n"}}, {"oid": "7d45c71ad8b58b5cccd8221804f080ee26e55954", "url": "https://github.com/firebase/firebase-android-sdk/commit/7d45c71ad8b58b5cccd8221804f080ee26e55954", "message": "Feedback", "committedDate": "2020-02-20T23:03:28Z", "type": "commit"}]}