{"pr_number": 1205, "pr_title": "Migrate transforms to use Values", "pr_createdAt": "2020-02-05T19:21:27Z", "pr_url": "https://github.com/firebase/firebase-android-sdk/pull/1205", "timeline": [{"oid": "1602062c2763abaf2a77a4fd2067ae26e6c96965", "url": "https://github.com/firebase/firebase-android-sdk/commit/1602062c2763abaf2a77a4fd2067ae26e6c96965", "message": "Protobuf-backed FieldValues", "committedDate": "2020-02-04T04:03:55Z", "type": "commit"}, {"oid": "804a1b7a9d0304f13a394b2f46054f2409c52b37", "url": "https://github.com/firebase/firebase-android-sdk/commit/804a1b7a9d0304f13a394b2f46054f2409c52b37", "message": "Merge branch 'mrschmidt/rewritefieldvalue' into mrschmidt/final", "committedDate": "2020-02-04T21:39:54Z", "type": "commit"}, {"oid": "3d5d7c2570b34f0797602f6dd46e407232b3bf8b", "url": "https://github.com/firebase/firebase-android-sdk/commit/3d5d7c2570b34f0797602f6dd46e407232b3bf8b", "message": "Merge branch 'mrschmidt/rewritefieldvalue' into mrschmidt/final", "committedDate": "2020-02-04T23:44:07Z", "type": "commit"}, {"oid": "120ca33e5a7299151357ae0e70c8b23acfe6b9b9", "url": "https://github.com/firebase/firebase-android-sdk/commit/120ca33e5a7299151357ae0e70c8b23acfe6b9b9", "message": "Feedback", "committedDate": "2020-02-05T19:01:41Z", "type": "commit"}, {"oid": "82c0095659aa83194049693f1336af2864ce5287", "url": "https://github.com/firebase/firebase-android-sdk/commit/82c0095659aa83194049693f1336af2864ce5287", "message": "Update test-only variable", "committedDate": "2020-02-05T19:03:43Z", "type": "commit"}, {"oid": "98953a323513bbc0ef685ab9ca1ee9b9d98ee091", "url": "https://github.com/firebase/firebase-android-sdk/commit/98953a323513bbc0ef685ab9ca1ee9b9d98ee091", "message": "Add ProtoValues.contains()", "committedDate": "2020-02-05T19:34:33Z", "type": "commit"}, {"oid": "940a268825130e3c4c7609d8975d7c428f071f32", "url": "https://github.com/firebase/firebase-android-sdk/commit/940a268825130e3c4c7609d8975d7c428f071f32", "message": "Migrate ArrayTransforms to use Values", "committedDate": "2020-02-05T19:42:37Z", "type": "commit"}, {"oid": "940a268825130e3c4c7609d8975d7c428f071f32", "url": "https://github.com/firebase/firebase-android-sdk/commit/940a268825130e3c4c7609d8975d7c428f071f32", "message": "Migrate ArrayTransforms to use Values", "committedDate": "2020-02-05T19:42:37Z", "type": "forcePushed"}, {"oid": "7ea5b3737b23638bb99bcb032893674414c18895", "url": "https://github.com/firebase/firebase-android-sdk/commit/7ea5b3737b23638bb99bcb032893674414c18895", "message": "Migrate TransformResult to use Value", "committedDate": "2020-02-05T20:21:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTU3NTc0NQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1205#discussion_r375575745", "bodyText": "It seems like this should go the other way: call ObjectValue.getFieldProto(path) here and then have getField above wrap the result of getFieldProto.", "author": "wilhuff", "createdAt": "2020-02-06T00:00:06Z", "path": "firebase-firestore/src/main/java/com/google/firebase/firestore/model/Document.java", "diffHunk": "@@ -66,6 +67,11 @@ public ObjectValue getData() {\n     return objectValue.get(path);\n   }\n \n+  public @Nullable Value getFieldProto(FieldPath path) {\n+    FieldValue fieldValue = getField(path);", "originalCommit": "7ea5b3737b23638bb99bcb032893674414c18895", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTU5MDA5Mg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1205#discussion_r375590092", "bodyText": "ObjectValue.getFieldProto() does not yet exist (but it probably should).\nThat being said, this will go away with #1207, which will drop the FieldValue version altogether.", "author": "schmidt-sebastian", "createdAt": "2020-02-06T00:53:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTU3NTc0NQ=="}], "type": "inlineReview", "revised_code": {"commit": "baf650e876d47b345418466f40e36f3b97912801", "chunk": "diff --git a/firebase-firestore/src/main/java/com/google/firebase/firestore/model/Document.java b/firebase-firestore/src/main/java/com/google/firebase/firestore/model/Document.java\nindex eb656d52..3a302758 100644\n--- a/firebase-firestore/src/main/java/com/google/firebase/firestore/model/Document.java\n+++ b/firebase-firestore/src/main/java/com/google/firebase/firestore/model/Document.java\n\n@@ -67,11 +66,6 @@ public final class Document extends MaybeDocument {\n     return objectValue.get(path);\n   }\n \n-  public @Nullable Value getFieldProto(FieldPath path) {\n-    FieldValue fieldValue = getField(path);\n-    return fieldValue != null ? fieldValue.getProto() : null;\n-  }\n-\n   public boolean hasLocalMutations() {\n     return documentState.equals(DocumentState.LOCAL_MUTATIONS);\n   }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTU3NjY3Nw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1205#discussion_r375576677", "bodyText": "These could be in ProtoValues along with isNumber and isArray.", "author": "wilhuff", "createdAt": "2020-02-06T00:03:22Z", "path": "firebase-firestore/src/main/java/com/google/firebase/firestore/model/mutation/NumericIncrementTransformOperation.java", "diffHunk": "@@ -120,4 +121,12 @@ private long operandAsLong() {\n               + operand.getClass().getCanonicalName());\n     }\n   }\n+\n+  private boolean isInteger(@Nullable Value value) {", "originalCommit": "7ea5b3737b23638bb99bcb032893674414c18895", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTU5MDg2NQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1205#discussion_r375590865", "bodyText": "Done.", "author": "schmidt-sebastian", "createdAt": "2020-02-06T00:56:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTU3NjY3Nw=="}], "type": "inlineReview", "revised_code": {"commit": "13e01c89451b123d4bfee2e51e6adef782f1b102", "chunk": "diff --git a/firebase-firestore/src/main/java/com/google/firebase/firestore/model/mutation/NumericIncrementTransformOperation.java b/firebase-firestore/src/main/java/com/google/firebase/firestore/model/mutation/NumericIncrementTransformOperation.java\nindex 445c0fa2..d921ce3b 100644\n--- a/firebase-firestore/src/main/java/com/google/firebase/firestore/model/mutation/NumericIncrementTransformOperation.java\n+++ b/firebase-firestore/src/main/java/com/google/firebase/firestore/model/mutation/NumericIncrementTransformOperation.java\n\n@@ -121,12 +123,4 @@ public class NumericIncrementTransformOperation implements TransformOperation {\n               + operand.getClass().getCanonicalName());\n     }\n   }\n-\n-  private boolean isInteger(@Nullable Value value) {\n-    return value != null && value.getValueTypeCase() == Value.ValueTypeCase.INTEGER_VALUE;\n-  }\n-\n-  private boolean isDouble(@Nullable Value value) {\n-    return value != null && value.getValueTypeCase() == Value.ValueTypeCase.DOUBLE_VALUE;\n-  }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTU3ODE5NA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1205#discussion_r375578194", "bodyText": "Having Values in the production code would again benefit this code, making it less verbose to do this everywhere we do it.", "author": "wilhuff", "createdAt": "2020-02-06T00:08:51Z", "path": "firebase-firestore/src/main/java/com/google/firebase/firestore/model/mutation/NumericIncrementTransformOperation.java", "diffHunk": "@@ -37,29 +39,28 @@ public NumericIncrementTransformOperation(NumberValue operand) {\n   }\n \n   @Override\n-  public FieldValue applyToLocalView(@Nullable FieldValue previousValue, Timestamp localWriteTime) {\n-    NumberValue baseValue = computeBaseValue(previousValue);\n+  public Value applyToLocalView(@Nullable Value previousValue, Timestamp localWriteTime) {\n+    Value baseValue = computeBaseValue(previousValue);\n \n     // Return an integer value only if the previous value and the operand is an integer.\n-    if (baseValue instanceof IntegerValue && operand instanceof IntegerValue) {\n-      long sum = safeIncrement(((IntegerValue) baseValue).getIntegerValue(), operandAsLong());\n-      return IntegerValue.valueOf(sum);\n-    } else if (baseValue instanceof IntegerValue) {\n-      double sum = ((IntegerValue) baseValue).getIntegerValue() + operandAsDouble();\n-      return DoubleValue.valueOf(sum);\n+    if (isInteger(baseValue) && operand instanceof IntegerValue) {\n+      long sum = safeIncrement(baseValue.getIntegerValue(), operandAsLong());\n+      return Value.newBuilder().setIntegerValue(sum).build();", "originalCommit": "7ea5b3737b23638bb99bcb032893674414c18895", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTU5MDM5NQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1205#discussion_r375590395", "bodyText": "The Value conversion is now only available in UserDataReader, which is directly called from tests. The base branch for this PR removes the Values class.", "author": "schmidt-sebastian", "createdAt": "2020-02-06T00:54:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTU3ODE5NA=="}], "type": "inlineReview", "revised_code": {"commit": "baf650e876d47b345418466f40e36f3b97912801", "chunk": "diff --git a/firebase-firestore/src/main/java/com/google/firebase/firestore/model/mutation/NumericIncrementTransformOperation.java b/firebase-firestore/src/main/java/com/google/firebase/firestore/model/mutation/NumericIncrementTransformOperation.java\nindex 445c0fa2..ed5717bb 100644\n--- a/firebase-firestore/src/main/java/com/google/firebase/firestore/model/mutation/NumericIncrementTransformOperation.java\n+++ b/firebase-firestore/src/main/java/com/google/firebase/firestore/model/mutation/NumericIncrementTransformOperation.java\n\n@@ -39,28 +37,29 @@ public class NumericIncrementTransformOperation implements TransformOperation {\n   }\n \n   @Override\n-  public Value applyToLocalView(@Nullable Value previousValue, Timestamp localWriteTime) {\n-    Value baseValue = computeBaseValue(previousValue);\n+  public FieldValue applyToLocalView(@Nullable FieldValue previousValue, Timestamp localWriteTime) {\n+    NumberValue baseValue = computeBaseValue(previousValue);\n \n     // Return an integer value only if the previous value and the operand is an integer.\n-    if (isInteger(baseValue) && operand instanceof IntegerValue) {\n-      long sum = safeIncrement(baseValue.getIntegerValue(), operandAsLong());\n-      return Value.newBuilder().setIntegerValue(sum).build();\n-    } else if (isInteger(baseValue)) {\n-      double sum = baseValue.getIntegerValue() + operandAsDouble();\n-      return Value.newBuilder().setDoubleValue(sum).build();\n+    if (baseValue instanceof IntegerValue && operand instanceof IntegerValue) {\n+      long sum = safeIncrement(((IntegerValue) baseValue).getIntegerValue(), operandAsLong());\n+      return IntegerValue.valueOf(sum);\n+    } else if (baseValue instanceof IntegerValue) {\n+      double sum = ((IntegerValue) baseValue).getIntegerValue() + operandAsDouble();\n+      return DoubleValue.valueOf(sum);\n     } else {\n       hardAssert(\n-          isDouble(baseValue),\n+          baseValue instanceof DoubleValue,\n           \"Expected NumberValue to be of type DoubleValue, but was \",\n           previousValue.getClass().getCanonicalName());\n-      double sum = baseValue.getDoubleValue() + operandAsDouble();\n-      return Value.newBuilder().setDoubleValue(sum).build();\n+      double sum = ((DoubleValue) baseValue).getDoubleValue() + operandAsDouble();\n+      return DoubleValue.valueOf(sum);\n     }\n   }\n \n   @Override\n-  public Value applyToRemoteDocument(@Nullable Value previousValue, Value transformResult) {\n+  public FieldValue applyToRemoteDocument(\n+      @Nullable FieldValue previousValue, FieldValue transformResult) {\n     return transformResult;\n   }\n \n"}}, {"oid": "13e01c89451b123d4bfee2e51e6adef782f1b102", "url": "https://github.com/firebase/firebase-android-sdk/commit/13e01c89451b123d4bfee2e51e6adef782f1b102", "message": "Review", "committedDate": "2020-02-06T00:56:21Z", "type": "commit"}, {"oid": "baf650e876d47b345418466f40e36f3b97912801", "url": "https://github.com/firebase/firebase-android-sdk/commit/baf650e876d47b345418466f40e36f3b97912801", "message": "Merge branch 'mrschmidt/rewritefieldvalue' into mrschmidt/final", "committedDate": "2020-02-06T01:54:45Z", "type": "commit"}, {"oid": "aa7b3ec782537107693ce98d405190397e8c610f", "url": "https://github.com/firebase/firebase-android-sdk/commit/aa7b3ec782537107693ce98d405190397e8c610f", "message": "Merge branch 'mrschmidt/final' into mrschmidt/migratevalues", "committedDate": "2020-02-06T01:54:57Z", "type": "commit"}]}