{"pr_number": 1310, "pr_title": "Crashlytics Analytics Connector realtime fixes", "pr_createdAt": "2020-03-03T20:09:42Z", "pr_url": "https://github.com/firebase/firebase-android-sdk/pull/1310", "timeline": [{"oid": "a24cfa9e0398375bb2ccd6c8a0690c9138d2f700", "url": "https://github.com/firebase/firebase-android-sdk/commit/a24cfa9e0398375bb2ccd6c8a0690c9138d2f700", "message": "Crashlytics Analytics Connector realtime fixes\n\nRefactor the Breadcrumbs receiver to listen for app exception events,\nwhich enables us to block app shutdown until we've confirmed that\nFirebase Analytics has received the app exception event.\n\nBecause Firebase Analytics serializes events asynchronously, it was possible\n(and in fact quite common) for the defaultUncaughtExceptionHandler to close\nthe app BEFORE Firebase Analytics was finished writing the app exception event\nto disk, which ultimately caused the event to be lost. Now Crashlytics waits\nfor the FA listener to fire with an app exception event before shutting down.\n\nThe 2000ms timeout was chosen somewhat arbitrarily; in practice the callback\nis received within 100ms or so, and it does not block at all if Firebase\nAnalytics is not present.", "committedDate": "2020-03-03T20:05:46Z", "type": "commit"}, {"oid": "31ee949598316e6d21d83349d4927c3965564ae6", "url": "https://github.com/firebase/firebase-android-sdk/commit/31ee949598316e6d21d83349d4927c3965564ae6", "message": "Merge branch 'master' into crash-analytics-realtime", "committedDate": "2020-03-03T21:51:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMwODEzNA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1310#discussion_r387308134", "bodyText": "Can we make the 2000 a constant?", "author": "mrwillis21", "createdAt": "2020-03-03T21:37:03Z", "path": "firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/core/CrashlyticsController.java", "diffHunk": "@@ -1748,26 +1752,84 @@ private void sendSessionReports(AppSettingsData appSettings, boolean dataCollect\n     }\n   }\n \n-  private void recordFatalFirebaseEvent(long timestamp) {\n-    if (firebaseCrashExists()) {\n+  /**\n+   * Helper class that listens for Crashlytics origin events from FA and provides a method to block\n+   * while waiting for a Crash event to occur. The implementation assumes there can be at most ONE\n+   * app exception event being processed and waited upon at a time.\n+   */\n+  private static class BlockingCrashEventListener\n+      implements AnalyticsReceiver.CrashlyticsOriginEventListener {\n+\n+    private final CountDownLatch eventLatch = new CountDownLatch(1);\n+\n+    public void awaitEvent() throws InterruptedException {\n       Logger.getLogger()\n-          .d(Logger.TAG, \"Skipping logging Crashlytics event to Firebase, FirebaseCrash exists\");\n-      return;\n+          .d(Logger.TAG, \"Background thread awaiting crash event callback from FA...\");\n+\n+      if (eventLatch.await(2000, TimeUnit.MILLISECONDS)) {", "originalCommit": "a24cfa9e0398375bb2ccd6c8a0690c9138d2f700", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "aab386de3259ad406702c77556fb813fed863fbd", "chunk": "diff --git a/firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/core/CrashlyticsController.java b/firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/core/CrashlyticsController.java\nindex 9ba531dc..bed61d64 100644\n--- a/firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/core/CrashlyticsController.java\n+++ b/firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/core/CrashlyticsController.java\n\n@@ -1759,25 +1816,26 @@ class CrashlyticsController {\n    */\n   private static class BlockingCrashEventListener\n       implements AnalyticsReceiver.CrashlyticsOriginEventListener {\n+    private static final int APP_EXCEPTION_CALLBACK_TIMEOUT_MS = 2000;\n \n     private final CountDownLatch eventLatch = new CountDownLatch(1);\n \n     public void awaitEvent() throws InterruptedException {\n       Logger.getLogger()\n-          .d(Logger.TAG, \"Background thread awaiting crash event callback from FA...\");\n+          .d(Logger.TAG, \"Background thread awaiting app exception callback from FA...\");\n \n-      if (eventLatch.await(2000, TimeUnit.MILLISECONDS)) {\n-        Logger.getLogger().d(Logger.TAG, \"Crash event callback received from FA listener.\");\n+      if (eventLatch.await(APP_EXCEPTION_CALLBACK_TIMEOUT_MS, TimeUnit.MILLISECONDS)) {\n+        Logger.getLogger().d(Logger.TAG, \"App exception callback received from FA listener.\");\n       } else {\n         Logger.getLogger()\n             .d(\n                 Logger.TAG,\n-                \"Timeout exceeded while awaiting crash event callback from FA listener.\");\n+                \"Timeout exceeded while awaiting app exception callback from FA listener.\");\n       }\n     }\n \n     @Override\n-    public void onCrashOriginEvent(int id, Bundle extras) {\n+    public void onCrashlyticsOriginEvent(int id, Bundle extras) {\n       String eventName = extras.getString(AnalyticsConnectorReceiver.EVENT_NAME_KEY);\n       if (AnalyticsConnectorReceiver.APP_EXCEPTION_EVENT_NAME.equals(eventName)) {\n         eventLatch.countDown();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMwODY5Mw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1310#discussion_r387308693", "bodyText": "Should this be onClxOrigin?", "author": "mrwillis21", "createdAt": "2020-03-03T21:38:08Z", "path": "firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/core/CrashlyticsController.java", "diffHunk": "@@ -1748,26 +1752,84 @@ private void sendSessionReports(AppSettingsData appSettings, boolean dataCollect\n     }\n   }\n \n-  private void recordFatalFirebaseEvent(long timestamp) {\n-    if (firebaseCrashExists()) {\n+  /**\n+   * Helper class that listens for Crashlytics origin events from FA and provides a method to block\n+   * while waiting for a Crash event to occur. The implementation assumes there can be at most ONE\n+   * app exception event being processed and waited upon at a time.\n+   */\n+  private static class BlockingCrashEventListener\n+      implements AnalyticsReceiver.CrashlyticsOriginEventListener {\n+\n+    private final CountDownLatch eventLatch = new CountDownLatch(1);\n+\n+    public void awaitEvent() throws InterruptedException {\n       Logger.getLogger()\n-          .d(Logger.TAG, \"Skipping logging Crashlytics event to Firebase, FirebaseCrash exists\");\n-      return;\n+          .d(Logger.TAG, \"Background thread awaiting crash event callback from FA...\");\n+\n+      if (eventLatch.await(2000, TimeUnit.MILLISECONDS)) {\n+        Logger.getLogger().d(Logger.TAG, \"Crash event callback received from FA listener.\");\n+      } else {\n+        Logger.getLogger()\n+            .d(\n+                Logger.TAG,\n+                \"Timeout exceeded while awaiting crash event callback from FA listener.\");\n+      }\n     }\n \n-    if (analyticsConnector != null) {\n-      Logger.getLogger().d(Logger.TAG, \"Logging Crashlytics event to Firebase\");\n-      final Bundle params = new Bundle();\n-      params.putInt(FIREBASE_CRASH_TYPE, FIREBASE_CRASH_TYPE_FATAL);\n-      params.putLong(FIREBASE_TIMESTAMP, timestamp);\n-      analyticsConnector.logEvent(\n-          FIREBASE_ANALYTICS_ORIGIN_CRASHLYTICS, FIREBASE_APPLICATION_EXCEPTION, params);\n-    } else {\n-      Logger.getLogger()\n-          .d(Logger.TAG, \"Skipping logging Crashlytics event to Firebase, no Firebase Analytics\");\n+    @Override\n+    public void onCrashOriginEvent(int id, Bundle extras) {", "originalCommit": "a24cfa9e0398375bb2ccd6c8a0690c9138d2f700", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMzNzY2NA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1310#discussion_r387337664", "bodyText": "Probably onCrashlyticsOrigin. cls is an implementation detail. I'll update.", "author": "mrichards", "createdAt": "2020-03-03T22:38:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMwODY5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzM0MTg1Mg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1310#discussion_r387341852", "bodyText": "\ud83d\udc4d", "author": "mrwillis21", "createdAt": "2020-03-03T22:48:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMwODY5Mw=="}], "type": "inlineReview", "revised_code": {"commit": "aab386de3259ad406702c77556fb813fed863fbd", "chunk": "diff --git a/firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/core/CrashlyticsController.java b/firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/core/CrashlyticsController.java\nindex 9ba531dc..bed61d64 100644\n--- a/firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/core/CrashlyticsController.java\n+++ b/firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/core/CrashlyticsController.java\n\n@@ -1759,25 +1816,26 @@ class CrashlyticsController {\n    */\n   private static class BlockingCrashEventListener\n       implements AnalyticsReceiver.CrashlyticsOriginEventListener {\n+    private static final int APP_EXCEPTION_CALLBACK_TIMEOUT_MS = 2000;\n \n     private final CountDownLatch eventLatch = new CountDownLatch(1);\n \n     public void awaitEvent() throws InterruptedException {\n       Logger.getLogger()\n-          .d(Logger.TAG, \"Background thread awaiting crash event callback from FA...\");\n+          .d(Logger.TAG, \"Background thread awaiting app exception callback from FA...\");\n \n-      if (eventLatch.await(2000, TimeUnit.MILLISECONDS)) {\n-        Logger.getLogger().d(Logger.TAG, \"Crash event callback received from FA listener.\");\n+      if (eventLatch.await(APP_EXCEPTION_CALLBACK_TIMEOUT_MS, TimeUnit.MILLISECONDS)) {\n+        Logger.getLogger().d(Logger.TAG, \"App exception callback received from FA listener.\");\n       } else {\n         Logger.getLogger()\n             .d(\n                 Logger.TAG,\n-                \"Timeout exceeded while awaiting crash event callback from FA listener.\");\n+                \"Timeout exceeded while awaiting app exception callback from FA listener.\");\n       }\n     }\n \n     @Override\n-    public void onCrashOriginEvent(int id, Bundle extras) {\n+    public void onCrashlyticsOriginEvent(int id, Bundle extras) {\n       String eventName = extras.getString(AnalyticsConnectorReceiver.EVENT_NAME_KEY);\n       if (AnalyticsConnectorReceiver.APP_EXCEPTION_EVENT_NAME.equals(eventName)) {\n         eventLatch.countDown();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMwOTMzNg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1310#discussion_r387309336", "bodyText": "Just to be technically correct \ud83e\udd13 might be worth calling this app_exception event callback", "author": "mrwillis21", "createdAt": "2020-03-03T21:39:25Z", "path": "firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/core/CrashlyticsController.java", "diffHunk": "@@ -1748,26 +1752,84 @@ private void sendSessionReports(AppSettingsData appSettings, boolean dataCollect\n     }\n   }\n \n-  private void recordFatalFirebaseEvent(long timestamp) {\n-    if (firebaseCrashExists()) {\n+  /**\n+   * Helper class that listens for Crashlytics origin events from FA and provides a method to block\n+   * while waiting for a Crash event to occur. The implementation assumes there can be at most ONE\n+   * app exception event being processed and waited upon at a time.\n+   */\n+  private static class BlockingCrashEventListener\n+      implements AnalyticsReceiver.CrashlyticsOriginEventListener {\n+\n+    private final CountDownLatch eventLatch = new CountDownLatch(1);\n+\n+    public void awaitEvent() throws InterruptedException {\n       Logger.getLogger()\n-          .d(Logger.TAG, \"Skipping logging Crashlytics event to Firebase, FirebaseCrash exists\");\n-      return;\n+          .d(Logger.TAG, \"Background thread awaiting crash event callback from FA...\");\n+\n+      if (eventLatch.await(2000, TimeUnit.MILLISECONDS)) {\n+        Logger.getLogger().d(Logger.TAG, \"Crash event callback received from FA listener.\");", "originalCommit": "a24cfa9e0398375bb2ccd6c8a0690c9138d2f700", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "aab386de3259ad406702c77556fb813fed863fbd", "chunk": "diff --git a/firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/core/CrashlyticsController.java b/firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/core/CrashlyticsController.java\nindex 9ba531dc..bed61d64 100644\n--- a/firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/core/CrashlyticsController.java\n+++ b/firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/core/CrashlyticsController.java\n\n@@ -1759,25 +1816,26 @@ class CrashlyticsController {\n    */\n   private static class BlockingCrashEventListener\n       implements AnalyticsReceiver.CrashlyticsOriginEventListener {\n+    private static final int APP_EXCEPTION_CALLBACK_TIMEOUT_MS = 2000;\n \n     private final CountDownLatch eventLatch = new CountDownLatch(1);\n \n     public void awaitEvent() throws InterruptedException {\n       Logger.getLogger()\n-          .d(Logger.TAG, \"Background thread awaiting crash event callback from FA...\");\n+          .d(Logger.TAG, \"Background thread awaiting app exception callback from FA...\");\n \n-      if (eventLatch.await(2000, TimeUnit.MILLISECONDS)) {\n-        Logger.getLogger().d(Logger.TAG, \"Crash event callback received from FA listener.\");\n+      if (eventLatch.await(APP_EXCEPTION_CALLBACK_TIMEOUT_MS, TimeUnit.MILLISECONDS)) {\n+        Logger.getLogger().d(Logger.TAG, \"App exception callback received from FA listener.\");\n       } else {\n         Logger.getLogger()\n             .d(\n                 Logger.TAG,\n-                \"Timeout exceeded while awaiting crash event callback from FA listener.\");\n+                \"Timeout exceeded while awaiting app exception callback from FA listener.\");\n       }\n     }\n \n     @Override\n-    public void onCrashOriginEvent(int id, Bundle extras) {\n+    public void onCrashlyticsOriginEvent(int id, Bundle extras) {\n       String eventName = extras.getString(AnalyticsConnectorReceiver.EVENT_NAME_KEY);\n       if (AnalyticsConnectorReceiver.APP_EXCEPTION_EVENT_NAME.equals(eventName)) {\n         eventLatch.countDown();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMxNjIwNg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1310#discussion_r387316206", "bodyText": "Definitely thought this was a 1 for a minute and got very confused.", "author": "mrwillis21", "createdAt": "2020-03-03T21:52:54Z", "path": "firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/internal/analytics/AnalyticsConnectorReceiver.java", "diffHunk": "@@ -75,14 +77,23 @@ public void unregister() {\n     }\n   }\n \n+  @Override\n+  public void setCrashlyticsOriginEventListener(@Nullable CrashlyticsOriginEventListener l) {\n+    this.crashOriginEventListener = l;", "originalCommit": "31ee949598316e6d21d83349d4927c3965564ae6", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "aab386de3259ad406702c77556fb813fed863fbd", "chunk": "diff --git a/firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/internal/analytics/AnalyticsConnectorReceiver.java b/firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/internal/analytics/AnalyticsConnectorReceiver.java\nindex e7af3784..0bdfc5ad 100644\n--- a/firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/internal/analytics/AnalyticsConnectorReceiver.java\n+++ b/firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/internal/analytics/AnalyticsConnectorReceiver.java\n\n@@ -78,8 +78,8 @@ public class AnalyticsConnectorReceiver implements AnalyticsConnectorListener, A\n   }\n \n   @Override\n-  public void setCrashlyticsOriginEventListener(@Nullable CrashlyticsOriginEventListener l) {\n-    this.crashOriginEventListener = l;\n+  public void setCrashlyticsOriginEventListener(@Nullable CrashlyticsOriginEventListener listener) {\n+    this.crashOriginEventListener = listener;\n   }\n \n   @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMxNzkzOA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1310#discussion_r387317938", "bodyText": "Stylistic point: if you use the null object pattern here, and swap in a no-op implementation whenever null is passed in the setter above, you'll only have to null-check in the setter, rather than on every event.", "author": "mrwillis21", "createdAt": "2020-03-03T21:56:21Z", "path": "firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/internal/analytics/AnalyticsConnectorReceiver.java", "diffHunk": "@@ -91,11 +102,22 @@ public void onMessageTriggered(int id, @Nullable Bundle extras) {\n       params = new Bundle();\n     }\n \n-    try {\n-      final String serializedEvent = BREADCRUMB_PREFIX + serializeEvent(name, params);\n-      breadcrumbHandler.dropBreadcrumb(serializedEvent);\n-    } catch (JSONException e) {\n-      Logger.getLogger().w(Logger.TAG, \"Unable to serialize Firebase Analytics event.\");\n+    final String origin = params.getString(EVENT_ORIGIN_KEY);\n+    if (CRASH_ORIGIN.equals(origin)) {\n+      if (crashOriginEventListener != null) {", "originalCommit": "31ee949598316e6d21d83349d4927c3965564ae6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzM3MTY1MA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1310#discussion_r387371650", "bodyText": "Funny enough, this was another reason why I was considering Set of listeners instead of just the single one. The empty loop would no-op.\nI don't love the no object pattern as I find it confusing when it appears an event should be firing but there's no response anywhere. How  strongly do you feel about it in this particular place?", "author": "mrichards", "createdAt": "2020-03-04T00:15:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMxNzkzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzM3MzA5Nw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1310#discussion_r387373097", "bodyText": "Not strong enough to have you change it now. :) Just a pattern I happen to prefer that would reduce the number of times this conditional is triggered.", "author": "mrwillis21", "createdAt": "2020-03-04T00:20:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMxNzkzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzM3MzI0Ng==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1310#discussion_r387373246", "bodyText": "In practice, though, this really should only happen once per session.", "author": "mrwillis21", "createdAt": "2020-03-04T00:21:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMxNzkzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQwMDgyMQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1310#discussion_r387400821", "bodyText": "After a little synchronous chat: we settled on this being a relatively inconsequential matter of opinion and we're leaving it as-is.", "author": "mrichards", "createdAt": "2020-03-04T01:30:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMxNzkzOA=="}], "type": "inlineReview", "revised_code": {"commit": "aab386de3259ad406702c77556fb813fed863fbd", "chunk": "diff --git a/firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/internal/analytics/AnalyticsConnectorReceiver.java b/firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/internal/analytics/AnalyticsConnectorReceiver.java\nindex e7af3784..0bdfc5ad 100644\n--- a/firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/internal/analytics/AnalyticsConnectorReceiver.java\n+++ b/firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/internal/analytics/AnalyticsConnectorReceiver.java\n\n@@ -105,7 +105,7 @@ public class AnalyticsConnectorReceiver implements AnalyticsConnectorListener, A\n     final String origin = params.getString(EVENT_ORIGIN_KEY);\n     if (CRASH_ORIGIN.equals(origin)) {\n       if (crashOriginEventListener != null) {\n-        crashOriginEventListener.onCrashOriginEvent(id, extras);\n+        crashOriginEventListener.onCrashlyticsOriginEvent(id, extras);\n       }\n     } else { // Drop breadcrumbs for all named events which did not originate from Crashlytics\n       final String name = extras.getString(EVENT_NAME_KEY);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMxODMxOA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1310#discussion_r387318318", "bodyText": "Would be great if we could pull these two paths out into named functions.", "author": "mrwillis21", "createdAt": "2020-03-03T21:57:08Z", "path": "firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/internal/analytics/AnalyticsConnectorReceiver.java", "diffHunk": "@@ -91,11 +102,22 @@ public void onMessageTriggered(int id, @Nullable Bundle extras) {\n       params = new Bundle();\n     }\n \n-    try {\n-      final String serializedEvent = BREADCRUMB_PREFIX + serializeEvent(name, params);\n-      breadcrumbHandler.dropBreadcrumb(serializedEvent);\n-    } catch (JSONException e) {\n-      Logger.getLogger().w(Logger.TAG, \"Unable to serialize Firebase Analytics event.\");\n+    final String origin = params.getString(EVENT_ORIGIN_KEY);\n+    if (CRASH_ORIGIN.equals(origin)) {\n+      if (crashOriginEventListener != null) {\n+        crashOriginEventListener.onCrashOriginEvent(id, extras);\n+      }\n+    } else { // Drop breadcrumbs for all named events which did not originate from Crashlytics\n+      final String name = extras.getString(EVENT_NAME_KEY);", "originalCommit": "31ee949598316e6d21d83349d4927c3965564ae6", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "aab386de3259ad406702c77556fb813fed863fbd", "chunk": "diff --git a/firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/internal/analytics/AnalyticsConnectorReceiver.java b/firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/internal/analytics/AnalyticsConnectorReceiver.java\nindex e7af3784..0bdfc5ad 100644\n--- a/firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/internal/analytics/AnalyticsConnectorReceiver.java\n+++ b/firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/internal/analytics/AnalyticsConnectorReceiver.java\n\n@@ -105,7 +105,7 @@ public class AnalyticsConnectorReceiver implements AnalyticsConnectorListener, A\n     final String origin = params.getString(EVENT_ORIGIN_KEY);\n     if (CRASH_ORIGIN.equals(origin)) {\n       if (crashOriginEventListener != null) {\n-        crashOriginEventListener.onCrashOriginEvent(id, extras);\n+        crashOriginEventListener.onCrashlyticsOriginEvent(id, extras);\n       }\n     } else { // Drop breadcrumbs for all named events which did not originate from Crashlytics\n       final String name = extras.getString(EVENT_NAME_KEY);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMyMDU5NA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1310#discussion_r387320594", "bodyText": "As mentioned in chat, if you used a TaskCompletionSource instead of a countdown latch above, returned its Task from this method, and just resolved the task (via the completion source) in onCrashOriginEvent, you could simplify a lot of what's downstream.\n\nYou wouldn't need the extra Tasks.call with its own executor down below because this would just become part of the task chain already in the exception handler.\nYou wouldn't need the extra 2-second timeout here because the timeout would be handled by the exception handler task chain's timeout.", "author": "mrwillis21", "createdAt": "2020-03-03T22:01:41Z", "path": "firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/core/CrashlyticsController.java", "diffHunk": "@@ -1805,26 +1809,84 @@ private void sendSessionReports(AppSettingsData appSettings, boolean dataCollect\n     }\n   }\n \n-  private void recordFatalFirebaseEvent(long timestamp) {\n-    if (firebaseCrashExists()) {\n+  /**\n+   * Helper class that listens for Crashlytics origin events from FA and provides a method to block\n+   * while waiting for a Crash event to occur. The implementation assumes there can be at most ONE\n+   * app exception event being processed and waited upon at a time.\n+   */\n+  private static class BlockingCrashEventListener\n+      implements AnalyticsReceiver.CrashlyticsOriginEventListener {\n+\n+    private final CountDownLatch eventLatch = new CountDownLatch(1);\n+\n+    public void awaitEvent() throws InterruptedException {", "originalCommit": "31ee949598316e6d21d83349d4927c3965564ae6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQwMTI4OA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1310#discussion_r387401288", "bodyText": "(Going to do this on a future PR. See previous comment.)", "author": "mrichards", "createdAt": "2020-03-04T01:31:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMyMDU5NA=="}], "type": "inlineReview", "revised_code": {"commit": "aab386de3259ad406702c77556fb813fed863fbd", "chunk": "diff --git a/firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/core/CrashlyticsController.java b/firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/core/CrashlyticsController.java\nindex a225c15f..bed61d64 100644\n--- a/firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/core/CrashlyticsController.java\n+++ b/firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/core/CrashlyticsController.java\n\n@@ -1816,25 +1816,26 @@ class CrashlyticsController {\n    */\n   private static class BlockingCrashEventListener\n       implements AnalyticsReceiver.CrashlyticsOriginEventListener {\n+    private static final int APP_EXCEPTION_CALLBACK_TIMEOUT_MS = 2000;\n \n     private final CountDownLatch eventLatch = new CountDownLatch(1);\n \n     public void awaitEvent() throws InterruptedException {\n       Logger.getLogger()\n-          .d(Logger.TAG, \"Background thread awaiting crash event callback from FA...\");\n+          .d(Logger.TAG, \"Background thread awaiting app exception callback from FA...\");\n \n-      if (eventLatch.await(2000, TimeUnit.MILLISECONDS)) {\n-        Logger.getLogger().d(Logger.TAG, \"Crash event callback received from FA listener.\");\n+      if (eventLatch.await(APP_EXCEPTION_CALLBACK_TIMEOUT_MS, TimeUnit.MILLISECONDS)) {\n+        Logger.getLogger().d(Logger.TAG, \"App exception callback received from FA listener.\");\n       } else {\n         Logger.getLogger()\n             .d(\n                 Logger.TAG,\n-                \"Timeout exceeded while awaiting crash event callback from FA listener.\");\n+                \"Timeout exceeded while awaiting app exception callback from FA listener.\");\n       }\n     }\n \n     @Override\n-    public void onCrashOriginEvent(int id, Bundle extras) {\n+    public void onCrashlyticsOriginEvent(int id, Bundle extras) {\n       String eventName = extras.getString(AnalyticsConnectorReceiver.EVENT_NAME_KEY);\n       if (AnalyticsConnectorReceiver.APP_EXCEPTION_EVENT_NAME.equals(eventName)) {\n         eventLatch.countDown();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMyMjM2MQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1310#discussion_r387322361", "bodyText": "If this returned a task (as mentioned above), you could remove the extra Tasks.call above and turn this method (recordFatalFirebaseEvent) into a synchronous call (which still returns this task), then just chain the return value in the uncaught exception handler the same way.", "author": "mrwillis21", "createdAt": "2020-03-03T22:05:09Z", "path": "firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/core/CrashlyticsController.java", "diffHunk": "@@ -1805,26 +1809,84 @@ private void sendSessionReports(AppSettingsData appSettings, boolean dataCollect\n     }\n   }\n \n-  private void recordFatalFirebaseEvent(long timestamp) {\n-    if (firebaseCrashExists()) {\n+  /**\n+   * Helper class that listens for Crashlytics origin events from FA and provides a method to block\n+   * while waiting for a Crash event to occur. The implementation assumes there can be at most ONE\n+   * app exception event being processed and waited upon at a time.\n+   */\n+  private static class BlockingCrashEventListener\n+      implements AnalyticsReceiver.CrashlyticsOriginEventListener {\n+\n+    private final CountDownLatch eventLatch = new CountDownLatch(1);\n+\n+    public void awaitEvent() throws InterruptedException {\n       Logger.getLogger()\n-          .d(Logger.TAG, \"Skipping logging Crashlytics event to Firebase, FirebaseCrash exists\");\n-      return;\n+          .d(Logger.TAG, \"Background thread awaiting crash event callback from FA...\");\n+\n+      if (eventLatch.await(2000, TimeUnit.MILLISECONDS)) {\n+        Logger.getLogger().d(Logger.TAG, \"Crash event callback received from FA listener.\");\n+      } else {\n+        Logger.getLogger()\n+            .d(\n+                Logger.TAG,\n+                \"Timeout exceeded while awaiting crash event callback from FA listener.\");\n+      }\n     }\n \n-    if (analyticsConnector != null) {\n-      Logger.getLogger().d(Logger.TAG, \"Logging Crashlytics event to Firebase\");\n-      final Bundle params = new Bundle();\n-      params.putInt(FIREBASE_CRASH_TYPE, FIREBASE_CRASH_TYPE_FATAL);\n-      params.putLong(FIREBASE_TIMESTAMP, timestamp);\n-      analyticsConnector.logEvent(\n-          FIREBASE_ANALYTICS_ORIGIN_CRASHLYTICS, FIREBASE_APPLICATION_EXCEPTION, params);\n-    } else {\n-      Logger.getLogger()\n-          .d(Logger.TAG, \"Skipping logging Crashlytics event to Firebase, no Firebase Analytics\");\n+    @Override\n+    public void onCrashOriginEvent(int id, Bundle extras) {\n+      String eventName = extras.getString(AnalyticsConnectorReceiver.EVENT_NAME_KEY);\n+      if (AnalyticsConnectorReceiver.APP_EXCEPTION_EVENT_NAME.equals(eventName)) {\n+        eventLatch.countDown();\n+      }\n     }\n   }\n \n+  /**\n+   * Send an App Exception event to Firebase Analytics. FA records the event asynchronously, so this\n+   * method returns a Task in case the caller wants to verify that the event was recorded by FA and\n+   * will not be lost.\n+   */\n+  private Task<Void> recordFatalFirebaseEvent(long timestamp) {\n+    final ThreadPoolExecutor executor = new ScheduledThreadPoolExecutor(1);\n+    return Tasks.call(\n+        executor,\n+        new Callable<Void>() {\n+          @Override\n+          public Void call() throws Exception {\n+            if (firebaseCrashExists()) {\n+              Logger.getLogger()\n+                  .d(\n+                      Logger.TAG,\n+                      \"Skipping logging Crashlytics event to Firebase, FirebaseCrash exists\");\n+              return null;\n+            }\n+            if (analyticsConnector == null) {\n+              Logger.getLogger()\n+                  .d(\n+                      Logger.TAG,\n+                      \"Skipping logging Crashlytics event to Firebase, no Firebase Analytics\");\n+              return null;\n+            }\n+            final BlockingCrashEventListener blockingListener = new BlockingCrashEventListener();\n+            analyticsReceiver.setCrashlyticsOriginEventListener(blockingListener);\n+\n+            Logger.getLogger().d(Logger.TAG, \"Logging Crashlytics event to Firebase\");\n+            final Bundle params = new Bundle();\n+            params.putInt(FIREBASE_CRASH_TYPE, FIREBASE_CRASH_TYPE_FATAL);\n+            params.putLong(FIREBASE_TIMESTAMP, timestamp);\n+\n+            analyticsConnector.logEvent(\n+                FIREBASE_ANALYTICS_ORIGIN_CRASHLYTICS, FIREBASE_APPLICATION_EXCEPTION, params);\n+\n+            blockingListener.awaitEvent();", "originalCommit": "31ee949598316e6d21d83349d4927c3965564ae6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQwMTE1NQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1310#discussion_r387401155", "bodyText": "We both like this idea and will do this in a subsequent refactor, since it is going to require more extensive validation than we have time for before the next release. It mostly improves readability and not performance.", "author": "mrichards", "createdAt": "2020-03-04T01:31:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMyMjM2MQ=="}], "type": "inlineReview", "revised_code": {"commit": "aab386de3259ad406702c77556fb813fed863fbd", "chunk": "diff --git a/firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/core/CrashlyticsController.java b/firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/core/CrashlyticsController.java\nindex a225c15f..bed61d64 100644\n--- a/firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/core/CrashlyticsController.java\n+++ b/firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/core/CrashlyticsController.java\n\n@@ -1816,25 +1816,26 @@ class CrashlyticsController {\n    */\n   private static class BlockingCrashEventListener\n       implements AnalyticsReceiver.CrashlyticsOriginEventListener {\n+    private static final int APP_EXCEPTION_CALLBACK_TIMEOUT_MS = 2000;\n \n     private final CountDownLatch eventLatch = new CountDownLatch(1);\n \n     public void awaitEvent() throws InterruptedException {\n       Logger.getLogger()\n-          .d(Logger.TAG, \"Background thread awaiting crash event callback from FA...\");\n+          .d(Logger.TAG, \"Background thread awaiting app exception callback from FA...\");\n \n-      if (eventLatch.await(2000, TimeUnit.MILLISECONDS)) {\n-        Logger.getLogger().d(Logger.TAG, \"Crash event callback received from FA listener.\");\n+      if (eventLatch.await(APP_EXCEPTION_CALLBACK_TIMEOUT_MS, TimeUnit.MILLISECONDS)) {\n+        Logger.getLogger().d(Logger.TAG, \"App exception callback received from FA listener.\");\n       } else {\n         Logger.getLogger()\n             .d(\n                 Logger.TAG,\n-                \"Timeout exceeded while awaiting crash event callback from FA listener.\");\n+                \"Timeout exceeded while awaiting app exception callback from FA listener.\");\n       }\n     }\n \n     @Override\n-    public void onCrashOriginEvent(int id, Bundle extras) {\n+    public void onCrashlyticsOriginEvent(int id, Bundle extras) {\n       String eventName = extras.getString(AnalyticsConnectorReceiver.EVENT_NAME_KEY);\n       if (AnalyticsConnectorReceiver.APP_EXCEPTION_EVENT_NAME.equals(eventName)) {\n         eventLatch.countDown();\n"}}, {"oid": "aab386de3259ad406702c77556fb813fed863fbd", "url": "https://github.com/firebase/firebase-android-sdk/commit/aab386de3259ad406702c77556fb813fed863fbd", "message": "Address minor PR comments", "committedDate": "2020-03-04T00:28:39Z", "type": "commit"}, {"oid": "8cf87cd937eb81dad28d2a7f9dadb186daf10d5a", "url": "https://github.com/firebase/firebase-android-sdk/commit/8cf87cd937eb81dad28d2a7f9dadb186daf10d5a", "message": "Fixed minor readability nits", "committedDate": "2020-03-04T00:43:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzM4Mzk2NA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1310#discussion_r387383964", "bodyText": "nit: the \"fire\" prefix is... slightly overloaded in this codebase.", "author": "mrwillis21", "createdAt": "2020-03-04T00:55:56Z", "path": "firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/internal/analytics/AnalyticsConnectorReceiver.java", "diffHunk": "@@ -91,6 +102,25 @@ public void onMessageTriggered(int id, @Nullable Bundle extras) {\n       params = new Bundle();\n     }\n \n+    final String origin = params.getString(EVENT_ORIGIN_KEY);\n+    if (CRASHLYTICS_ORIGIN.equals(origin)) {\n+      fireCrashlyticsOriginEvent(id, extras);", "originalCommit": "8cf87cd937eb81dad28d2a7f9dadb186daf10d5a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQwMDUyOQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1310#discussion_r387400529", "bodyText": "\ud83d\udd25\ud83d\udd25\ud83d\udd25 Whatever do you mean? \ud83d\udd25\ud83d\udd25\ud83d\udd25", "author": "mrichards", "createdAt": "2020-03-04T01:29:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzM4Mzk2NA=="}], "type": "inlineReview", "revised_code": {"commit": "055999c36f39caed58994e22d40ef87166d2a7d7", "chunk": "diff --git a/firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/internal/analytics/AnalyticsConnectorReceiver.java b/firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/internal/analytics/AnalyticsConnectorReceiver.java\nindex ce7ef017..35bf9be7 100644\n--- a/firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/internal/analytics/AnalyticsConnectorReceiver.java\n+++ b/firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/internal/analytics/AnalyticsConnectorReceiver.java\n\n@@ -104,23 +104,23 @@ public class AnalyticsConnectorReceiver implements AnalyticsConnectorListener, A\n \n     final String origin = params.getString(EVENT_ORIGIN_KEY);\n     if (CRASHLYTICS_ORIGIN.equals(origin)) {\n-      fireCrashlyticsOriginEvent(id, extras);\n+      dispatchCrashlyticsOriginEvent(id, extras);\n     } else {\n       // Drop breadcrumbs for all named events which did not originate from Crashlytics\n       final String name = extras.getString(EVENT_NAME_KEY);\n       if (name != null) {\n-        fireBreadcrumbEvent(name, params);\n+        dispatchBreadcrumbEvent(name, params);\n       }\n     }\n   }\n \n-  private void fireCrashlyticsOriginEvent(int id, @Nullable Bundle extras) {\n+  private void dispatchCrashlyticsOriginEvent(int id, @Nullable Bundle extras) {\n     if (crashOriginEventListener != null) {\n       crashOriginEventListener.onCrashlyticsOriginEvent(id, extras);\n     }\n   }\n \n-  private void fireBreadcrumbEvent(String name, Bundle params) {\n+  private void dispatchBreadcrumbEvent(String name, Bundle params) {\n     try {\n       final String serializedEvent = BREADCRUMB_PREFIX + serializeEvent(name, params);\n       breadcrumbHandler.dropBreadcrumb(serializedEvent);\n"}}, {"oid": "055999c36f39caed58994e22d40ef87166d2a7d7", "url": "https://github.com/firebase/firebase-android-sdk/commit/055999c36f39caed58994e22d40ef87166d2a7d7", "message": "One more nit.", "committedDate": "2020-03-04T01:50:53Z", "type": "commit"}]}