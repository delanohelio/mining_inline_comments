{"pr_number": 1207, "pr_title": "Drop remaining primitive FieldValue types", "pr_createdAt": "2020-02-06T00:03:01Z", "pr_url": "https://github.com/firebase/firebase-android-sdk/pull/1207", "timeline": [{"oid": "1602062c2763abaf2a77a4fd2067ae26e6c96965", "url": "https://github.com/firebase/firebase-android-sdk/commit/1602062c2763abaf2a77a4fd2067ae26e6c96965", "message": "Protobuf-backed FieldValues", "committedDate": "2020-02-04T04:03:55Z", "type": "commit"}, {"oid": "804a1b7a9d0304f13a394b2f46054f2409c52b37", "url": "https://github.com/firebase/firebase-android-sdk/commit/804a1b7a9d0304f13a394b2f46054f2409c52b37", "message": "Merge branch 'mrschmidt/rewritefieldvalue' into mrschmidt/final", "committedDate": "2020-02-04T21:39:54Z", "type": "commit"}, {"oid": "3d5d7c2570b34f0797602f6dd46e407232b3bf8b", "url": "https://github.com/firebase/firebase-android-sdk/commit/3d5d7c2570b34f0797602f6dd46e407232b3bf8b", "message": "Merge branch 'mrschmidt/rewritefieldvalue' into mrschmidt/final", "committedDate": "2020-02-04T23:44:07Z", "type": "commit"}, {"oid": "120ca33e5a7299151357ae0e70c8b23acfe6b9b9", "url": "https://github.com/firebase/firebase-android-sdk/commit/120ca33e5a7299151357ae0e70c8b23acfe6b9b9", "message": "Feedback", "committedDate": "2020-02-05T19:01:41Z", "type": "commit"}, {"oid": "82c0095659aa83194049693f1336af2864ce5287", "url": "https://github.com/firebase/firebase-android-sdk/commit/82c0095659aa83194049693f1336af2864ce5287", "message": "Update test-only variable", "committedDate": "2020-02-05T19:03:43Z", "type": "commit"}, {"oid": "98953a323513bbc0ef685ab9ca1ee9b9d98ee091", "url": "https://github.com/firebase/firebase-android-sdk/commit/98953a323513bbc0ef685ab9ca1ee9b9d98ee091", "message": "Add ProtoValues.contains()", "committedDate": "2020-02-05T19:34:33Z", "type": "commit"}, {"oid": "940a268825130e3c4c7609d8975d7c428f071f32", "url": "https://github.com/firebase/firebase-android-sdk/commit/940a268825130e3c4c7609d8975d7c428f071f32", "message": "Migrate ArrayTransforms to use Values", "committedDate": "2020-02-05T19:42:37Z", "type": "commit"}, {"oid": "7ea5b3737b23638bb99bcb032893674414c18895", "url": "https://github.com/firebase/firebase-android-sdk/commit/7ea5b3737b23638bb99bcb032893674414c18895", "message": "Migrate TransformResult to use Value", "committedDate": "2020-02-05T20:21:48Z", "type": "commit"}, {"oid": "637838b4497561644308d0eee7c3cedaee1a182d", "url": "https://github.com/firebase/firebase-android-sdk/commit/637838b4497561644308d0eee7c3cedaee1a182d", "message": "Drop Array, Reference, Number, Integer and DoubleValue", "committedDate": "2020-02-05T23:15:14Z", "type": "commit"}, {"oid": "522db2fd28c09a9030c4ea002fcd5856bfa9c895", "url": "https://github.com/firebase/firebase-android-sdk/commit/522db2fd28c09a9030c4ea002fcd5856bfa9c895", "message": "Drop remaining primitive FieldValue types", "committedDate": "2020-02-06T00:06:22Z", "type": "commit"}, {"oid": "522db2fd28c09a9030c4ea002fcd5856bfa9c895", "url": "https://github.com/firebase/firebase-android-sdk/commit/522db2fd28c09a9030c4ea002fcd5856bfa9c895", "message": "Drop remaining primitive FieldValue types", "committedDate": "2020-02-06T00:06:22Z", "type": "forcePushed"}, {"oid": "b5cc99840698f8fb2e799495fdd478ea1013bd04", "url": "https://github.com/firebase/firebase-android-sdk/commit/b5cc99840698f8fb2e799495fdd478ea1013bd04", "message": "Fix Kotlin", "committedDate": "2020-02-06T00:10:43Z", "type": "commit"}, {"oid": "9f87db1fb30b3663489fd095c08fb41350d0c2ea", "url": "https://github.com/firebase/firebase-android-sdk/commit/9f87db1fb30b3663489fd095c08fb41350d0c2ea", "message": "Merge branch 'mrschmidt/droparray' into mrschmidt/droprest", "committedDate": "2020-02-06T00:11:06Z", "type": "commit"}, {"oid": "162f0715043961e3fd1057a583230095276fb487", "url": "https://github.com/firebase/firebase-android-sdk/commit/162f0715043961e3fd1057a583230095276fb487", "message": "More Kotlin fixes", "committedDate": "2020-02-06T00:27:20Z", "type": "commit"}, {"oid": "3d2eadd560d77157a91cc2b416525fa52f06c016", "url": "https://github.com/firebase/firebase-android-sdk/commit/3d2eadd560d77157a91cc2b416525fa52f06c016", "message": "Merge branch 'mrschmidt/droparray' into mrschmidt/droprest", "committedDate": "2020-02-06T00:27:46Z", "type": "commit"}, {"oid": "13e01c89451b123d4bfee2e51e6adef782f1b102", "url": "https://github.com/firebase/firebase-android-sdk/commit/13e01c89451b123d4bfee2e51e6adef782f1b102", "message": "Review", "committedDate": "2020-02-06T00:56:21Z", "type": "commit"}, {"oid": "baf650e876d47b345418466f40e36f3b97912801", "url": "https://github.com/firebase/firebase-android-sdk/commit/baf650e876d47b345418466f40e36f3b97912801", "message": "Merge branch 'mrschmidt/rewritefieldvalue' into mrschmidt/final", "committedDate": "2020-02-06T01:54:45Z", "type": "commit"}, {"oid": "aa7b3ec782537107693ce98d405190397e8c610f", "url": "https://github.com/firebase/firebase-android-sdk/commit/aa7b3ec782537107693ce98d405190397e8c610f", "message": "Merge branch 'mrschmidt/final' into mrschmidt/migratevalues", "committedDate": "2020-02-06T01:54:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTYxNDIyNg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1207#discussion_r375614226", "bodyText": "public methods that return private values make little sense. typeOrder should either be private or these constants should be public.", "author": "wilhuff", "createdAt": "2020-02-06T02:36:56Z", "path": "firebase-firestore/src/main/java/com/google/firebase/firestore/model/value/ProtoValues.java", "diffHunk": "@@ -41,34 +41,47 @@\n   public static final Value NULL_VALUE =\n       Value.newBuilder().setNullValue(NullValue.NULL_VALUE).build();\n \n+  /** The order of types in Firestore; this order is defined by the backend. */\n+  private static final int TYPE_ORDER_NULL = 0;", "originalCommit": "3d2eadd560d77157a91cc2b416525fa52f06c016", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjAyNjYxOA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1207#discussion_r376026618", "bodyText": "Made them public.", "author": "schmidt-sebastian", "createdAt": "2020-02-06T19:09:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTYxNDIyNg=="}], "type": "inlineReview", "revised_code": {"commit": "774598a7f912b8558e50109d7822b9bf421f717c", "chunk": "diff --git a/firebase-firestore/src/main/java/com/google/firebase/firestore/model/value/ProtoValues.java b/firebase-firestore/src/main/java/com/google/firebase/firestore/model/value/ProtoValues.java\nindex 4e74487c8..08c697175 100644\n--- a/firebase-firestore/src/main/java/com/google/firebase/firestore/model/value/ProtoValues.java\n+++ b/firebase-firestore/src/main/java/com/google/firebase/firestore/model/value/ProtoValues.java\n\n@@ -41,47 +41,34 @@ public class ProtoValues {\n   public static final Value NULL_VALUE =\n       Value.newBuilder().setNullValue(NullValue.NULL_VALUE).build();\n \n-  /** The order of types in Firestore; this order is defined by the backend. */\n-  private static final int TYPE_ORDER_NULL = 0;\n-\n-  private static final int TYPE_ORDER_BOOLEAN = 1;\n-  private static final int TYPE_ORDER_NUMBER = 2;\n-  private static final int TYPE_ORDER_TIMESTAMP = 3;\n-  private static final int TYPE_ORDER_STRING = 4;\n-  private static final int TYPE_ORDER_BLOB = 5;\n-  private static final int TYPE_ORDER_REFERENCE = 6;\n-  private static final int TYPE_ORDER_GEOPOINT = 7;\n-  private static final int TYPE_ORDER_ARRAY = 8;\n-  private static final int TYPE_ORDER_MAP = 9;\n-\n   /** Returns the backend's type order of the given Value type. */\n   public static int typeOrder(Value value) {\n     switch (value.getValueTypeCase()) {\n       case NULL_VALUE:\n-        return TYPE_ORDER_NULL;\n+        return FieldValue.TYPE_ORDER_NULL;\n       case BOOLEAN_VALUE:\n-        return TYPE_ORDER_BOOLEAN;\n+        return FieldValue.TYPE_ORDER_BOOLEAN;\n       case INTEGER_VALUE:\n-        return TYPE_ORDER_NUMBER;\n+        return FieldValue.TYPE_ORDER_NUMBER;\n       case DOUBLE_VALUE:\n-        return TYPE_ORDER_NUMBER;\n+        return FieldValue.TYPE_ORDER_NUMBER;\n       case TIMESTAMP_VALUE:\n-        return TYPE_ORDER_TIMESTAMP;\n+        return FieldValue.TYPE_ORDER_TIMESTAMP;\n       case STRING_VALUE:\n-        return TYPE_ORDER_STRING;\n+        return FieldValue.TYPE_ORDER_STRING;\n       case BYTES_VALUE:\n-        return TYPE_ORDER_BLOB;\n+        return FieldValue.TYPE_ORDER_BLOB;\n       case REFERENCE_VALUE:\n-        return TYPE_ORDER_REFERENCE;\n+        return FieldValue.TYPE_ORDER_REFERENCE;\n       case GEO_POINT_VALUE:\n-        return TYPE_ORDER_GEOPOINT;\n+        return FieldValue.TYPE_ORDER_GEOPOINT;\n       case ARRAY_VALUE:\n-        return TYPE_ORDER_ARRAY;\n+        return FieldValue.TYPE_ORDER_ARRAY;\n       case MAP_VALUE:\n         if (ServerTimestampValue.isServerTimestamp(value)) {\n-          return TYPE_ORDER_TIMESTAMP;\n+          return FieldValue.TYPE_ORDER_TIMESTAMP;\n         }\n-        return TYPE_ORDER_MAP;\n+        return FieldValue.TYPE_ORDER_OBJECT;\n       default:\n         throw fail(\"Invalid value type: \" + value.getValueTypeCase());\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTYxNDY1Ng==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1207#discussion_r375614656", "bodyText": "JUnit tends to put the expected value as the first argument. Consider reversing these to match.", "author": "wilhuff", "createdAt": "2020-02-06T02:38:37Z", "path": "firebase-firestore/src/test/java/com/google/firebase/firestore/UserDataWriterTest.java", "diffHunk": "@@ -291,4 +287,8 @@ public void testRejectsJavaArrays() {\n   private Object convertValue(FieldValue value) {\n     return writer.convertValue(value.getProto());\n   }\n+\n+  private void assertValueType(FieldValue value, Value.ValueTypeCase booleanValue) {", "originalCommit": "3d2eadd560d77157a91cc2b416525fa52f06c016", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjAyNjk3NA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1207#discussion_r376026974", "bodyText": "Changed this. Note that I have a similar helper for canonical IDs, which I kept the same as the callsites look much cleaner in reverse argument order.", "author": "schmidt-sebastian", "createdAt": "2020-02-06T19:09:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTYxNDY1Ng=="}], "type": "inlineReview", "revised_code": {"commit": "774598a7f912b8558e50109d7822b9bf421f717c", "chunk": "diff --git a/firebase-firestore/src/test/java/com/google/firebase/firestore/UserDataWriterTest.java b/firebase-firestore/src/test/java/com/google/firebase/firestore/UserDataWriterTest.java\nindex b0af552d9..e42a05051 100644\n--- a/firebase-firestore/src/test/java/com/google/firebase/firestore/UserDataWriterTest.java\n+++ b/firebase-firestore/src/test/java/com/google/firebase/firestore/UserDataWriterTest.java\n\n@@ -287,8 +291,4 @@ public class UserDataWriterTest {\n   private Object convertValue(FieldValue value) {\n     return writer.convertValue(value.getProto());\n   }\n-\n-  private void assertValueType(FieldValue value, Value.ValueTypeCase booleanValue) {\n-    assertEquals(booleanValue, value.getProto().getValueTypeCase());\n-  }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTYxNDkzOA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1207#discussion_r375614938", "bodyText": "Optional: You could chain these (ObjectValue expected = newBuilder.set.set.build())", "author": "wilhuff", "createdAt": "2020-02-06T02:39:57Z", "path": "firebase-firestore/src/test/java/com/google/firebase/firestore/UserDataWriterTest.java", "diffHunk": "@@ -259,12 +257,10 @@ private static ObjectValue fromMap(Object... entries) {\n   @Test\n   public void testConvertsNestedObjects() {\n     FieldValue actual = wrapObject(\"a\", map(\"b\", map(\"c\", \"foo\"), \"d\", true));\n-    ObjectValue expected =\n-        fromMap(\n-            \"a\",\n-            fromMap(\n-                \"b\", fromMap(\"c\", StringValue.valueOf(\"foo\")), \"d\", BooleanValue.valueOf(true)));\n-    assertEquals(expected, actual);\n+    ObjectValue.Builder expected = ObjectValue.newBuilder();\n+    expected.set(field(\"a.b.c\"), valueOf(\"foo\"));", "originalCommit": "3d2eadd560d77157a91cc2b416525fa52f06c016", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjAyNzI2NA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1207#discussion_r376027264", "bodyText": "It felt cleaner to spread these assignments over multiple lines. Kept as is.", "author": "schmidt-sebastian", "createdAt": "2020-02-06T19:10:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTYxNDkzOA=="}], "type": "inlineReview", "revised_code": {"commit": "774598a7f912b8558e50109d7822b9bf421f717c", "chunk": "diff --git a/firebase-firestore/src/test/java/com/google/firebase/firestore/UserDataWriterTest.java b/firebase-firestore/src/test/java/com/google/firebase/firestore/UserDataWriterTest.java\nindex b0af552d9..e42a05051 100644\n--- a/firebase-firestore/src/test/java/com/google/firebase/firestore/UserDataWriterTest.java\n+++ b/firebase-firestore/src/test/java/com/google/firebase/firestore/UserDataWriterTest.java\n\n@@ -257,10 +259,12 @@ public class UserDataWriterTest {\n   @Test\n   public void testConvertsNestedObjects() {\n     FieldValue actual = wrapObject(\"a\", map(\"b\", map(\"c\", \"foo\"), \"d\", true));\n-    ObjectValue.Builder expected = ObjectValue.newBuilder();\n-    expected.set(field(\"a.b.c\"), valueOf(\"foo\"));\n-    expected.set(field(\"a.d\"), valueOf(true));\n-    assertEquals(expected.build(), actual);\n+    ObjectValue expected =\n+        fromMap(\n+            \"a\",\n+            fromMap(\n+                \"b\", fromMap(\"c\", StringValue.valueOf(\"foo\")), \"d\", BooleanValue.valueOf(true)));\n+    assertEquals(expected, actual);\n   }\n \n   @Test\n"}}, {"oid": "774598a7f912b8558e50109d7822b9bf421f717c", "url": "https://github.com/firebase/firebase-android-sdk/commit/774598a7f912b8558e50109d7822b9bf421f717c", "message": "Feedback", "committedDate": "2020-02-06T05:07:07Z", "type": "commit"}, {"oid": "490c924d4d77d91fa861f5cf7d6b7629808949a3", "url": "https://github.com/firebase/firebase-android-sdk/commit/490c924d4d77d91fa861f5cf7d6b7629808949a3", "message": "Make FieldValue package-private", "committedDate": "2020-02-06T05:11:08Z", "type": "commit"}, {"oid": "0abdfb1698347c81beed67ba720b9003d7766dd4", "url": "https://github.com/firebase/firebase-android-sdk/commit/0abdfb1698347c81beed67ba720b9003d7766dd4", "message": "Merge branch 'mrschmidt/migratevalues' into mrschmidt/droparray", "committedDate": "2020-02-06T05:11:24Z", "type": "commit"}, {"oid": "6ef7289eeae1ab4b2e421294929e675556fe1d68", "url": "https://github.com/firebase/firebase-android-sdk/commit/6ef7289eeae1ab4b2e421294929e675556fe1d68", "message": "Merge", "committedDate": "2020-02-06T05:17:36Z", "type": "commit"}, {"oid": "3f2efb491b872ea597d7df12a4dffe951eab4424", "url": "https://github.com/firebase/firebase-android-sdk/commit/3f2efb491b872ea597d7df12a4dffe951eab4424", "message": "Merge", "committedDate": "2020-02-06T19:04:45Z", "type": "commit"}, {"oid": "067c43ebb5ab391b95e55c1d1c584a9c127658d6", "url": "https://github.com/firebase/firebase-android-sdk/commit/067c43ebb5ab391b95e55c1d1c584a9c127658d6", "message": "Merge", "committedDate": "2020-02-06T19:05:15Z", "type": "commit"}, {"oid": "585ce2ab9c9563010bba1cbb3b253d2f53bb22ce", "url": "https://github.com/firebase/firebase-android-sdk/commit/585ce2ab9c9563010bba1cbb3b253d2f53bb22ce", "message": "Review", "committedDate": "2020-02-06T19:10:53Z", "type": "commit"}, {"oid": "9ab4f2c0df32dcafb96368f6d83b2233b6400a94", "url": "https://github.com/firebase/firebase-android-sdk/commit/9ab4f2c0df32dcafb96368f6d83b2233b6400a94", "message": "Fix Kotlin", "committedDate": "2020-02-06T19:29:58Z", "type": "commit"}, {"oid": "2ce8a22e6cc87742910ddfd7e17ddde5480d0c87", "url": "https://github.com/firebase/firebase-android-sdk/commit/2ce8a22e6cc87742910ddfd7e17ddde5480d0c87", "message": "Fix Kotlin", "committedDate": "2020-02-06T21:40:58Z", "type": "commit"}, {"oid": "2ce8a22e6cc87742910ddfd7e17ddde5480d0c87", "url": "https://github.com/firebase/firebase-android-sdk/commit/2ce8a22e6cc87742910ddfd7e17ddde5480d0c87", "message": "Fix Kotlin", "committedDate": "2020-02-06T21:40:58Z", "type": "forcePushed"}]}