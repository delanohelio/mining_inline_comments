{"pr_number": 1349, "pr_title": "Nudge customers to update if on an old Firebase Analytics", "pr_createdAt": "2020-03-13T14:38:15Z", "pr_url": "https://github.com/firebase/firebase-android-sdk/pull/1349", "timeline": [{"oid": "83a8bbcecc7a231c27fad1d74b74f51cb69784af", "url": "https://github.com/firebase/firebase-android-sdk/commit/83a8bbcecc7a231c27fad1d74b74f51cb69784af", "message": "Nudge customers to update if on an old Firebase Analytics\n\nWe can infer the customer is on an outdated version of FA\nif we cannot attach a listener with the \"clx\" origin. If\nthat is the case, use the old \"crash\" origin and write a\nlogcat warning with a nudge to upgrade.", "committedDate": "2020-03-13T14:34:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI2ODM5NA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1349#discussion_r392268394", "bodyText": "I'm going to coordinate with the Analytics team on the specific wording, which is likely to change. I created the PR to get feedback on the general approach; don't worry about the warning message just yet.", "author": "mrichards", "createdAt": "2020-03-13T14:39:09Z", "path": "firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/internal/analytics/AnalyticsConnectorReceiver.java", "diffHunk": "@@ -66,6 +67,29 @@ public boolean register() {\n     analyticsConnectorHandle =\n         analyticsConnector.registerAnalyticsConnectorListener(CRASHLYTICS_ORIGIN, this);\n \n+    if (analyticsConnectorHandle == null) {\n+      Logger.getLogger()\n+          .d(\n+              \"Could not register AnalyticsConnectorListener with origin \"\n+                  + \"\\\"\"\n+                  + CRASHLYTICS_ORIGIN\n+                  + \"\\\"\");\n+      // Older versions of FA don't support CRASHLYTICS_ORIGIN. We can try using the old Firebase\n+      // Crash Reporting origin\n+      analyticsConnectorHandle =\n+          analyticsConnector.registerAnalyticsConnectorListener(LEGACY_CRASH_ORIGIN, this);\n+\n+      // If FA allows us to connect with the legacy origin, but not the new one, nudge customers\n+      // to update their FA version.\n+      if (analyticsConnectorHandle != null) {\n+        Logger.getLogger()\n+            .w(\n+                \"Outdated version of Firebase Analytics detected. For improved \"", "originalCommit": "83a8bbcecc7a231c27fad1d74b74f51cb69784af", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "604916a8454d3a77d9f80e56a7341dc8ca2e7492", "chunk": "diff --git a/firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/internal/analytics/AnalyticsConnectorReceiver.java b/firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/internal/analytics/AnalyticsConnectorReceiver.java\nindex 1ee20521c..7c04d8589 100644\n--- a/firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/internal/analytics/AnalyticsConnectorReceiver.java\n+++ b/firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/internal/analytics/AnalyticsConnectorReceiver.java\n\n@@ -69,11 +69,7 @@ public class AnalyticsConnectorReceiver implements AnalyticsConnectorListener, A\n \n     if (analyticsConnectorHandle == null) {\n       Logger.getLogger()\n-          .d(\n-              \"Could not register AnalyticsConnectorListener with origin \"\n-                  + \"\\\"\"\n-                  + CRASHLYTICS_ORIGIN\n-                  + \"\\\"\");\n+          .d(\"Could not register AnalyticsConnectorListener with Crashlytics origin.\");\n       // Older versions of FA don't support CRASHLYTICS_ORIGIN. We can try using the old Firebase\n       // Crash Reporting origin\n       analyticsConnectorHandle =\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMwNjc0Nw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1349#discussion_r392306747", "bodyText": "I don't think we want to expose this implementation detail to the user. Maybe something more generic like \"Could not register analytics connector with Crashlytics origin\"?", "author": "mrwillis21", "createdAt": "2020-03-13T15:40:55Z", "path": "firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/internal/analytics/AnalyticsConnectorReceiver.java", "diffHunk": "@@ -66,6 +67,29 @@ public boolean register() {\n     analyticsConnectorHandle =\n         analyticsConnector.registerAnalyticsConnectorListener(CRASHLYTICS_ORIGIN, this);\n \n+    if (analyticsConnectorHandle == null) {\n+      Logger.getLogger()\n+          .d(\n+              \"Could not register AnalyticsConnectorListener with origin \"\n+                  + \"\\\"\"\n+                  + CRASHLYTICS_ORIGIN", "originalCommit": "83a8bbcecc7a231c27fad1d74b74f51cb69784af", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjM3MjU4Ng==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1349#discussion_r392372586", "bodyText": "Sure, NBD. In general I'm not opposed to exposing inconsequential (to the customer) implementation details in debug logs, but it doesn't really matter what the message is here, so long as we know how to interpret it. :)", "author": "mrichards", "createdAt": "2020-03-13T17:32:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMwNjc0Nw=="}], "type": "inlineReview", "revised_code": {"commit": "604916a8454d3a77d9f80e56a7341dc8ca2e7492", "chunk": "diff --git a/firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/internal/analytics/AnalyticsConnectorReceiver.java b/firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/internal/analytics/AnalyticsConnectorReceiver.java\nindex 1ee20521c..7c04d8589 100644\n--- a/firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/internal/analytics/AnalyticsConnectorReceiver.java\n+++ b/firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/internal/analytics/AnalyticsConnectorReceiver.java\n\n@@ -69,11 +69,7 @@ public class AnalyticsConnectorReceiver implements AnalyticsConnectorListener, A\n \n     if (analyticsConnectorHandle == null) {\n       Logger.getLogger()\n-          .d(\n-              \"Could not register AnalyticsConnectorListener with origin \"\n-                  + \"\\\"\"\n-                  + CRASHLYTICS_ORIGIN\n-                  + \"\\\"\");\n+          .d(\"Could not register AnalyticsConnectorListener with Crashlytics origin.\");\n       // Older versions of FA don't support CRASHLYTICS_ORIGIN. We can try using the old Firebase\n       // Crash Reporting origin\n       analyticsConnectorHandle =\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMwNzM5MQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1349#discussion_r392307391", "bodyText": "Would it be worth consolidating this with the return value below?", "author": "mrwillis21", "createdAt": "2020-03-13T15:41:55Z", "path": "firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/internal/analytics/AnalyticsConnectorReceiver.java", "diffHunk": "@@ -66,6 +67,29 @@ public boolean register() {\n     analyticsConnectorHandle =\n         analyticsConnector.registerAnalyticsConnectorListener(CRASHLYTICS_ORIGIN, this);\n \n+    if (analyticsConnectorHandle == null) {\n+      Logger.getLogger()\n+          .d(\n+              \"Could not register AnalyticsConnectorListener with origin \"\n+                  + \"\\\"\"\n+                  + CRASHLYTICS_ORIGIN\n+                  + \"\\\"\");\n+      // Older versions of FA don't support CRASHLYTICS_ORIGIN. We can try using the old Firebase\n+      // Crash Reporting origin\n+      analyticsConnectorHandle =\n+          analyticsConnector.registerAnalyticsConnectorListener(LEGACY_CRASH_ORIGIN, this);\n+\n+      // If FA allows us to connect with the legacy origin, but not the new one, nudge customers\n+      // to update their FA version.\n+      if (analyticsConnectorHandle != null) {", "originalCommit": "83a8bbcecc7a231c27fad1d74b74f51cb69784af", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjM3NDE0Mw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1349#discussion_r392374143", "bodyText": "I couldn't come up with a way to do that which helped readability and the performance impact is so close to nil that it isn't worth optimizing. We could have fewer null checks but we'd need to sprinkle return statements throughout the method. So I (mildly) prefer it as-is.", "author": "mrichards", "createdAt": "2020-03-13T17:35:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMwNzM5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzAyNzcwMQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1349#discussion_r393027701", "bodyText": "\ud83d\udc4d", "author": "mrwillis21", "createdAt": "2020-03-16T13:37:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMwNzM5MQ=="}], "type": "inlineReview", "revised_code": {"commit": "604916a8454d3a77d9f80e56a7341dc8ca2e7492", "chunk": "diff --git a/firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/internal/analytics/AnalyticsConnectorReceiver.java b/firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/internal/analytics/AnalyticsConnectorReceiver.java\nindex 1ee20521c..7c04d8589 100644\n--- a/firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/internal/analytics/AnalyticsConnectorReceiver.java\n+++ b/firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/internal/analytics/AnalyticsConnectorReceiver.java\n\n@@ -69,11 +69,7 @@ public class AnalyticsConnectorReceiver implements AnalyticsConnectorListener, A\n \n     if (analyticsConnectorHandle == null) {\n       Logger.getLogger()\n-          .d(\n-              \"Could not register AnalyticsConnectorListener with origin \"\n-                  + \"\\\"\"\n-                  + CRASHLYTICS_ORIGIN\n-                  + \"\\\"\");\n+          .d(\"Could not register AnalyticsConnectorListener with Crashlytics origin.\");\n       // Older versions of FA don't support CRASHLYTICS_ORIGIN. We can try using the old Firebase\n       // Crash Reporting origin\n       analyticsConnectorHandle =\n"}}, {"oid": "604916a8454d3a77d9f80e56a7341dc8ca2e7492", "url": "https://github.com/firebase/firebase-android-sdk/commit/604916a8454d3a77d9f80e56a7341dc8ca2e7492", "message": "Minor logging output improvements", "committedDate": "2020-03-13T18:15:19Z", "type": "commit"}]}