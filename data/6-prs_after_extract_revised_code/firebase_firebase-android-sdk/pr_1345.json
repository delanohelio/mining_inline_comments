{"pr_number": 1345, "pr_title": "Improving FISServiceClient by closing all acquired connection resources", "pr_createdAt": "2020-03-11T23:29:55Z", "pr_url": "https://github.com/firebase/firebase-android-sdk/pull/1345", "timeline": [{"oid": "4283a2bb3b4434510e061a0d9c4b080595658c2a", "url": "https://github.com/firebase/firebase-android-sdk/commit/4283a2bb3b4434510e061a0d9c4b080595658c2a", "message": "Dropping guava and appcompat dependency from FIS SDK.", "committedDate": "2020-02-06T17:59:09Z", "type": "commit"}, {"oid": "984884cd6f9a90a8172d0957bd13e68e3f06db2f", "url": "https://github.com/firebase/firebase-android-sdk/commit/984884cd6f9a90a8172d0957bd13e68e3f06db2f", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-02-06T18:16:08Z", "type": "commit"}, {"oid": "a82387701d2549bb5fc3b5dc2530a83ed0680d02", "url": "https://github.com/firebase/firebase-android-sdk/commit/a82387701d2549bb5fc3b5dc2530a83ed0680d02", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-02-11T18:58:16Z", "type": "commit"}, {"oid": "afcb14c913c8dedd87faf6b71fdc7dd4384a6c39", "url": "https://github.com/firebase/firebase-android-sdk/commit/afcb14c913c8dedd87faf6b71fdc7dd4384a6c39", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-02-13T23:37:48Z", "type": "commit"}, {"oid": "5574e30b8e3f6c9d09bfca149a6f7853c4141d25", "url": "https://github.com/firebase/firebase-android-sdk/commit/5574e30b8e3f6c9d09bfca149a6f7853c4141d25", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-03-05T16:49:33Z", "type": "commit"}, {"oid": "a5dd4dc54f2b7941ffe4b5cd76b6c8ab5764f7a1", "url": "https://github.com/firebase/firebase-android-sdk/commit/a5dd4dc54f2b7941ffe4b5cd76b6c8ab5764f7a1", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-03-09T16:31:08Z", "type": "commit"}, {"oid": "45312e68fe8516dc4d48a2bfdb422f5023c1241b", "url": "https://github.com/firebase/firebase-android-sdk/commit/45312e68fe8516dc4d48a2bfdb422f5023c1241b", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-03-10T18:13:59Z", "type": "commit"}, {"oid": "f0be4fa07222c687044f66d8cb2859e156611896", "url": "https://github.com/firebase/firebase-android-sdk/commit/f0be4fa07222c687044f66d8cb2859e156611896", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-03-10T21:55:48Z", "type": "commit"}, {"oid": "ac0397ba816265b24da3eca4645761a37d4b46b6", "url": "https://github.com/firebase/firebase-android-sdk/commit/ac0397ba816265b24da3eca4645761a37d4b46b6", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-03-11T18:14:18Z", "type": "commit"}, {"oid": "cd91b1d9617c5f3ae00016f38eeb10df8da9f176", "url": "https://github.com/firebase/firebase-android-sdk/commit/cd91b1d9617c5f3ae00016f38eeb10df8da9f176", "message": "Improving FISServiceClient by closing acquired connection resources and\nremoving code duplication.", "committedDate": "2020-03-11T23:25:18Z", "type": "commit"}, {"oid": "43b3e31f3efb027e2eaba45ff03acb4b2ed0dc18", "url": "https://github.com/firebase/firebase-android-sdk/commit/43b3e31f3efb027e2eaba45ff03acb4b2ed0dc18", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk into fisCode", "committedDate": "2020-03-11T23:26:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTc5NTA3NQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1345#discussion_r391795075", "bodyText": "Just you think that it is in any situation possible for #getInputStream to return NULL, please catch a NPE here too.\nAlso I would recommend to call the IOException variable \"ignored\".", "author": "andirayo", "createdAt": "2020-03-12T17:55:39Z", "path": "firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java", "diffHunk": "@@ -167,6 +167,11 @@ public InstallationResponse createFirebaseInstallation(\n         return InstallationResponse.builder().setResponseCode(ResponseCode.BAD_CONFIG).build();\n       } finally {\n         httpURLConnection.disconnect();\n+        try {\n+          httpURLConnection.getInputStream().close();\n+        } catch (IOException unused) {", "originalCommit": "43b3e31f3efb027e2eaba45ff03acb4b2ed0dc18", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMwMTI4MA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1345#discussion_r404301280", "bodyText": "Removed this as we dont have any open input streams at this point. It was just an experiement.", "author": "ankitaj224", "createdAt": "2020-04-06T18:29:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTc5NTA3NQ=="}], "type": "inlineReview", "revised_code": {"commit": "fc1a0a2335c0ba18ec0e7e6283330c717644e2c8", "chunk": "diff --git a/firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java b/firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java\nindex 7fa6510c..1ea38d59 100644\n--- a/firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java\n+++ b/firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java\n\n@@ -167,11 +170,6 @@ public class FirebaseInstallationServiceClient {\n         return InstallationResponse.builder().setResponseCode(ResponseCode.BAD_CONFIG).build();\n       } finally {\n         httpURLConnection.disconnect();\n-        try {\n-          httpURLConnection.getInputStream().close();\n-        } catch (IOException unused) {\n-\n-        }\n       }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTc5NzM4Ng==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1345#discussion_r391797386", "bodyText": "This is maybe beside the point of this PR, but I was wondering this before:\nWhy are these parameters HttpUrlConnections?\nThe only method you call on them is #getOutputStream() right?\nThus, they should be UrlConnection instances, I think.", "author": "andirayo", "createdAt": "2020-03-12T17:59:38Z", "path": "firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java", "diffHunk": "@@ -176,20 +181,23 @@ public InstallationResponse createFirebaseInstallation(\n   private void writeFIDCreateRequestBodyToOutputStream(\n       HttpURLConnection httpURLConnection, @NonNull String fid, @NonNull String appId)\n       throws IOException {\n-    OutputStream outputStream = httpURLConnection.getOutputStream();\n-    if (outputStream == null) {\n-      throw new IOException(\n-          \"Cannot send CreateInstallation request to FIS. No OutputStream available.\");\n-    }\n-\n-    GZIPOutputStream gzipOutputStream = new GZIPOutputStream(outputStream);\n     try {\n-      gzipOutputStream.write(\n-          buildCreateFirebaseInstallationRequestBody(fid, appId).toString().getBytes(\"UTF-8\"));\n+      writeRequestBodyToOutputStream(\n+          httpURLConnection, buildCreateFirebaseInstallationRequestBody(fid, appId));\n     } catch (JSONException e) {\n       throw new IllegalStateException(e);\n-    } finally {\n-      gzipOutputStream.close();\n+    }\n+  }\n+\n+  private static void writeRequestBodyToOutputStream(\n+      HttpURLConnection httpURLConnection, JSONObject jsonObject) throws IOException {", "originalCommit": "43b3e31f3efb027e2eaba45ff03acb4b2ed0dc18", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMwMDI1NQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1345#discussion_r404300255", "bodyText": "Done.", "author": "ankitaj224", "createdAt": "2020-04-06T18:27:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTc5NzM4Ng=="}], "type": "inlineReview", "revised_code": {"commit": "fc1a0a2335c0ba18ec0e7e6283330c717644e2c8", "chunk": "diff --git a/firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java b/firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java\nindex 7fa6510c..1ea38d59 100644\n--- a/firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java\n+++ b/firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java\n\n@@ -183,20 +181,24 @@ public class FirebaseInstallationServiceClient {\n       throws IOException {\n     try {\n       writeRequestBodyToOutputStream(\n-          httpURLConnection, buildCreateFirebaseInstallationRequestBody(fid, appId));\n+          httpURLConnection, getJsonBytes(buildCreateFirebaseInstallationRequestBody(fid, appId)));\n     } catch (JSONException e) {\n       throw new IllegalStateException(e);\n     }\n   }\n \n-  private static void writeRequestBodyToOutputStream(\n-      HttpURLConnection httpURLConnection, JSONObject jsonObject) throws IOException {\n-    try (OutputStream outputStream = httpURLConnection.getOutputStream()) {\n+  private static byte[] getJsonBytes(JSONObject jsonObject) throws UnsupportedEncodingException {\n+    return jsonObject.toString().getBytes(\"UTF-8\");\n+  }\n+\n+  private static void writeRequestBodyToOutputStream(URLConnection urlConnection, byte[] jsonBytes)\n+      throws IOException {\n+    try (OutputStream outputStream = urlConnection.getOutputStream()) {\n       if (outputStream == null) {\n         throw new IOException(\"Cannot send request to FIS servers. No OutputStream available.\");\n       }\n       try (GZIPOutputStream gzipOutputStream = new GZIPOutputStream(outputStream)) {\n-        gzipOutputStream.write(jsonObject.toString().getBytes(\"UTF-8\"));\n+        gzipOutputStream.write(jsonBytes);\n       }\n     }\n   }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTgwMDQ5NA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1345#discussion_r391800494", "bodyText": "I'm not too familiar with this pattern.\nAre OutputStreams always AutoCloseable?", "author": "andirayo", "createdAt": "2020-03-12T18:05:20Z", "path": "firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java", "diffHunk": "@@ -176,20 +181,23 @@ public InstallationResponse createFirebaseInstallation(\n   private void writeFIDCreateRequestBodyToOutputStream(\n       HttpURLConnection httpURLConnection, @NonNull String fid, @NonNull String appId)\n       throws IOException {\n-    OutputStream outputStream = httpURLConnection.getOutputStream();\n-    if (outputStream == null) {\n-      throw new IOException(\n-          \"Cannot send CreateInstallation request to FIS. No OutputStream available.\");\n-    }\n-\n-    GZIPOutputStream gzipOutputStream = new GZIPOutputStream(outputStream);\n     try {\n-      gzipOutputStream.write(\n-          buildCreateFirebaseInstallationRequestBody(fid, appId).toString().getBytes(\"UTF-8\"));\n+      writeRequestBodyToOutputStream(\n+          httpURLConnection, buildCreateFirebaseInstallationRequestBody(fid, appId));\n     } catch (JSONException e) {\n       throw new IllegalStateException(e);\n-    } finally {\n-      gzipOutputStream.close();\n+    }\n+  }\n+\n+  private static void writeRequestBodyToOutputStream(\n+      HttpURLConnection httpURLConnection, JSONObject jsonObject) throws IOException {\n+    try (OutputStream outputStream = httpURLConnection.getOutputStream()) {", "originalCommit": "43b3e31f3efb027e2eaba45ff03acb4b2ed0dc18", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDI5OTg0MQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1345#discussion_r404299841", "bodyText": "That's right. OutputStream implements Closeable", "author": "ankitaj224", "createdAt": "2020-04-06T18:27:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTgwMDQ5NA=="}], "type": "inlineReview", "revised_code": {"commit": "fc1a0a2335c0ba18ec0e7e6283330c717644e2c8", "chunk": "diff --git a/firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java b/firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java\nindex 7fa6510c..1ea38d59 100644\n--- a/firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java\n+++ b/firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java\n\n@@ -183,20 +181,24 @@ public class FirebaseInstallationServiceClient {\n       throws IOException {\n     try {\n       writeRequestBodyToOutputStream(\n-          httpURLConnection, buildCreateFirebaseInstallationRequestBody(fid, appId));\n+          httpURLConnection, getJsonBytes(buildCreateFirebaseInstallationRequestBody(fid, appId)));\n     } catch (JSONException e) {\n       throw new IllegalStateException(e);\n     }\n   }\n \n-  private static void writeRequestBodyToOutputStream(\n-      HttpURLConnection httpURLConnection, JSONObject jsonObject) throws IOException {\n-    try (OutputStream outputStream = httpURLConnection.getOutputStream()) {\n+  private static byte[] getJsonBytes(JSONObject jsonObject) throws UnsupportedEncodingException {\n+    return jsonObject.toString().getBytes(\"UTF-8\");\n+  }\n+\n+  private static void writeRequestBodyToOutputStream(URLConnection urlConnection, byte[] jsonBytes)\n+      throws IOException {\n+    try (OutputStream outputStream = urlConnection.getOutputStream()) {\n       if (outputStream == null) {\n         throw new IOException(\"Cannot send request to FIS servers. No OutputStream available.\");\n       }\n       try (GZIPOutputStream gzipOutputStream = new GZIPOutputStream(outputStream)) {\n-        gzipOutputStream.write(jsonObject.toString().getBytes(\"UTF-8\"));\n+        gzipOutputStream.write(jsonBytes);\n       }\n     }\n   }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTgwMzA0Nw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1345#discussion_r391803047", "bodyText": "Please move the calls to .toString().getBytes(\"UTF-8\") outside of this method.\nThis method should have one \"single responsibility\":\nWriting some content to a stream (and not do transformations on that content).\n===============\nIf you want to remove code duplication for these methods,\nyou should name this method appropriately, example\"\n#writeJsonToOpenConnection()\nEven better would be to create a new method with the above name\nwhich does the transformation and then calls this existing method that writes to the given UrlConnection.", "author": "andirayo", "createdAt": "2020-03-12T18:09:59Z", "path": "firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java", "diffHunk": "@@ -176,20 +181,23 @@ public InstallationResponse createFirebaseInstallation(\n   private void writeFIDCreateRequestBodyToOutputStream(\n       HttpURLConnection httpURLConnection, @NonNull String fid, @NonNull String appId)\n       throws IOException {\n-    OutputStream outputStream = httpURLConnection.getOutputStream();\n-    if (outputStream == null) {\n-      throw new IOException(\n-          \"Cannot send CreateInstallation request to FIS. No OutputStream available.\");\n-    }\n-\n-    GZIPOutputStream gzipOutputStream = new GZIPOutputStream(outputStream);\n     try {\n-      gzipOutputStream.write(\n-          buildCreateFirebaseInstallationRequestBody(fid, appId).toString().getBytes(\"UTF-8\"));\n+      writeRequestBodyToOutputStream(\n+          httpURLConnection, buildCreateFirebaseInstallationRequestBody(fid, appId));\n     } catch (JSONException e) {\n       throw new IllegalStateException(e);\n-    } finally {\n-      gzipOutputStream.close();\n+    }\n+  }\n+\n+  private static void writeRequestBodyToOutputStream(\n+      HttpURLConnection httpURLConnection, JSONObject jsonObject) throws IOException {\n+    try (OutputStream outputStream = httpURLConnection.getOutputStream()) {\n+      if (outputStream == null) {\n+        throw new IOException(\"Cannot send request to FIS servers. No OutputStream available.\");\n+      }\n+      try (GZIPOutputStream gzipOutputStream = new GZIPOutputStream(outputStream)) {\n+        gzipOutputStream.write(jsonObject.toString().getBytes(\"UTF-8\"));", "originalCommit": "43b3e31f3efb027e2eaba45ff03acb4b2ed0dc18", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMwMDA0NA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1345#discussion_r404300044", "bodyText": "Done.", "author": "ankitaj224", "createdAt": "2020-04-06T18:27:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTgwMzA0Nw=="}], "type": "inlineReview", "revised_code": {"commit": "fc1a0a2335c0ba18ec0e7e6283330c717644e2c8", "chunk": "diff --git a/firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java b/firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java\nindex 7fa6510c..1ea38d59 100644\n--- a/firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java\n+++ b/firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java\n\n@@ -183,20 +181,24 @@ public class FirebaseInstallationServiceClient {\n       throws IOException {\n     try {\n       writeRequestBodyToOutputStream(\n-          httpURLConnection, buildCreateFirebaseInstallationRequestBody(fid, appId));\n+          httpURLConnection, getJsonBytes(buildCreateFirebaseInstallationRequestBody(fid, appId)));\n     } catch (JSONException e) {\n       throw new IllegalStateException(e);\n     }\n   }\n \n-  private static void writeRequestBodyToOutputStream(\n-      HttpURLConnection httpURLConnection, JSONObject jsonObject) throws IOException {\n-    try (OutputStream outputStream = httpURLConnection.getOutputStream()) {\n+  private static byte[] getJsonBytes(JSONObject jsonObject) throws UnsupportedEncodingException {\n+    return jsonObject.toString().getBytes(\"UTF-8\");\n+  }\n+\n+  private static void writeRequestBodyToOutputStream(URLConnection urlConnection, byte[] jsonBytes)\n+      throws IOException {\n+    try (OutputStream outputStream = urlConnection.getOutputStream()) {\n       if (outputStream == null) {\n         throw new IOException(\"Cannot send request to FIS servers. No OutputStream available.\");\n       }\n       try (GZIPOutputStream gzipOutputStream = new GZIPOutputStream(outputStream)) {\n-        gzipOutputStream.write(jsonObject.toString().getBytes(\"UTF-8\"));\n+        gzipOutputStream.write(jsonBytes);\n       }\n     }\n   }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTgwMzE2Nw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1345#discussion_r391803167", "bodyText": "String content instead of JSONObject jsonObject", "author": "andirayo", "createdAt": "2020-03-12T18:10:13Z", "path": "firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java", "diffHunk": "@@ -176,20 +181,23 @@ public InstallationResponse createFirebaseInstallation(\n   private void writeFIDCreateRequestBodyToOutputStream(\n       HttpURLConnection httpURLConnection, @NonNull String fid, @NonNull String appId)\n       throws IOException {\n-    OutputStream outputStream = httpURLConnection.getOutputStream();\n-    if (outputStream == null) {\n-      throw new IOException(\n-          \"Cannot send CreateInstallation request to FIS. No OutputStream available.\");\n-    }\n-\n-    GZIPOutputStream gzipOutputStream = new GZIPOutputStream(outputStream);\n     try {\n-      gzipOutputStream.write(\n-          buildCreateFirebaseInstallationRequestBody(fid, appId).toString().getBytes(\"UTF-8\"));\n+      writeRequestBodyToOutputStream(\n+          httpURLConnection, buildCreateFirebaseInstallationRequestBody(fid, appId));\n     } catch (JSONException e) {\n       throw new IllegalStateException(e);\n-    } finally {\n-      gzipOutputStream.close();\n+    }\n+  }\n+\n+  private static void writeRequestBodyToOutputStream(\n+      HttpURLConnection httpURLConnection, JSONObject jsonObject) throws IOException {", "originalCommit": "43b3e31f3efb027e2eaba45ff03acb4b2ed0dc18", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "fc1a0a2335c0ba18ec0e7e6283330c717644e2c8", "chunk": "diff --git a/firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java b/firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java\nindex 7fa6510c..1ea38d59 100644\n--- a/firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java\n+++ b/firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java\n\n@@ -183,20 +181,24 @@ public class FirebaseInstallationServiceClient {\n       throws IOException {\n     try {\n       writeRequestBodyToOutputStream(\n-          httpURLConnection, buildCreateFirebaseInstallationRequestBody(fid, appId));\n+          httpURLConnection, getJsonBytes(buildCreateFirebaseInstallationRequestBody(fid, appId)));\n     } catch (JSONException e) {\n       throw new IllegalStateException(e);\n     }\n   }\n \n-  private static void writeRequestBodyToOutputStream(\n-      HttpURLConnection httpURLConnection, JSONObject jsonObject) throws IOException {\n-    try (OutputStream outputStream = httpURLConnection.getOutputStream()) {\n+  private static byte[] getJsonBytes(JSONObject jsonObject) throws UnsupportedEncodingException {\n+    return jsonObject.toString().getBytes(\"UTF-8\");\n+  }\n+\n+  private static void writeRequestBodyToOutputStream(URLConnection urlConnection, byte[] jsonBytes)\n+      throws IOException {\n+    try (OutputStream outputStream = urlConnection.getOutputStream()) {\n       if (outputStream == null) {\n         throw new IOException(\"Cannot send request to FIS servers. No OutputStream available.\");\n       }\n       try (GZIPOutputStream gzipOutputStream = new GZIPOutputStream(outputStream)) {\n-        gzipOutputStream.write(jsonObject.toString().getBytes(\"UTF-8\"));\n+        gzipOutputStream.write(jsonBytes);\n       }\n     }\n   }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTgwNTYzNA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1345#discussion_r391805634", "bodyText": "in a future CL we should probably remove this code duplication", "author": "andirayo", "createdAt": "2020-03-12T18:14:56Z", "path": "firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java", "diffHunk": "@@ -401,13 +406,14 @@ private InstallationResponse readCreateResponse(HttpURLConnection conn) throws I\n     }\n     reader.endObject();\n     reader.close();\n-\n+    inputStream.close();\n     return builder.setResponseCode(ResponseCode.OK).build();\n   }\n \n   // Read the response from the generateAuthToken FirebaseInstallation API.\n   private TokenResult readGenerateAuthTokenResponse(HttpURLConnection conn) throws IOException {\n-    JsonReader reader = new JsonReader(new InputStreamReader(conn.getInputStream(), UTF_8));\n+    InputStream inputStream = conn.getInputStream();\n+    JsonReader reader = new JsonReader(new InputStreamReader(inputStream, UTF_8));", "originalCommit": "43b3e31f3efb027e2eaba45ff03acb4b2ed0dc18", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDI5OTM1NA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1345#discussion_r404299354", "bodyText": "Ack.", "author": "ankitaj224", "createdAt": "2020-04-06T18:26:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTgwNTYzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMxMDYxNw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1345#discussion_r404310617", "bodyText": "Saw this again. Happy to chat offline.", "author": "andirayo", "createdAt": "2020-04-06T18:45:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTgwNTYzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTAxOTc1Ng==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1345#discussion_r405019756", "bodyText": "We can discuss offline and if there are changes, they will be part of another PR.", "author": "ankitaj224", "createdAt": "2020-04-07T18:22:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTgwNTYzNA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "d0fa125654fb4d05e5eda5516ffc382c76790df1", "url": "https://github.com/firebase/firebase-android-sdk/commit/d0fa125654fb4d05e5eda5516ffc382c76790df1", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk into fisCode", "committedDate": "2020-04-06T01:59:59Z", "type": "commit"}, {"oid": "dd8f3feefa61738922d943e7112e2a32a6be87cd", "url": "https://github.com/firebase/firebase-android-sdk/commit/dd8f3feefa61738922d943e7112e2a32a6be87cd", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk into fisCode", "committedDate": "2020-04-06T18:05:59Z", "type": "commit"}, {"oid": "fc1a0a2335c0ba18ec0e7e6283330c717644e2c8", "url": "https://github.com/firebase/firebase-android-sdk/commit/fc1a0a2335c0ba18ec0e7e6283330c717644e2c8", "message": "Addressing Rayo's comments.", "committedDate": "2020-04-06T18:30:39Z", "type": "commit"}, {"oid": "55ca644b143ff6ff7bdfdc607473b66f7cea165b", "url": "https://github.com/firebase/firebase-android-sdk/commit/55ca644b143ff6ff7bdfdc607473b66f7cea165b", "message": "Minor fix.", "committedDate": "2020-04-06T18:31:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMwNjE3NQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1345#discussion_r404306175", "bodyText": "Probably this is not an issue, but I just want to make sure that we are not running into an issue here:\nIf outputStream is NULL this will not cause an error when Java is trying to close the stream, right?\nDid you test this?", "author": "andirayo", "createdAt": "2020-04-06T18:37:32Z", "path": "firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java", "diffHunk": "@@ -177,20 +180,27 @@ public InstallationResponse createFirebaseInstallation(\n   private void writeFIDCreateRequestBodyToOutputStream(\n       HttpURLConnection httpURLConnection, @NonNull String fid, @NonNull String appId)\n       throws IOException {\n-    OutputStream outputStream = httpURLConnection.getOutputStream();\n-    if (outputStream == null) {\n-      throw new IOException(\n-          \"Cannot send CreateInstallation request to FIS. No OutputStream available.\");\n-    }\n-\n-    GZIPOutputStream gzipOutputStream = new GZIPOutputStream(outputStream);\n     try {\n-      gzipOutputStream.write(\n-          buildCreateFirebaseInstallationRequestBody(fid, appId).toString().getBytes(\"UTF-8\"));\n+      writeRequestBodyToOutputStream(\n+          httpURLConnection, getJsonBytes(buildCreateFirebaseInstallationRequestBody(fid, appId)));\n     } catch (JSONException e) {\n       throw new IllegalStateException(e);\n-    } finally {\n-      gzipOutputStream.close();\n+    }\n+  }\n+\n+  private static byte[] getJsonBytes(JSONObject jsonObject) throws UnsupportedEncodingException {\n+    return jsonObject.toString().getBytes(\"UTF-8\");\n+  }\n+\n+  private static void writeRequestBodyToOutputStream(URLConnection urlConnection, byte[] jsonBytes)\n+      throws IOException {\n+    try (OutputStream outputStream = urlConnection.getOutputStream()) {", "originalCommit": "55ca644b143ff6ff7bdfdc607473b66f7cea165b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bffe96393fe24cec068d42b5bf650becd7deac9a", "chunk": "diff --git a/firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java b/firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java\nindex f76de398..68bf4a0d 100644\n--- a/firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java\n+++ b/firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java\n\n@@ -180,15 +179,19 @@ public class FirebaseInstallationServiceClient {\n   private void writeFIDCreateRequestBodyToOutputStream(\n       HttpURLConnection httpURLConnection, @NonNull String fid, @NonNull String appId)\n       throws IOException {\n-    try {\n-      writeRequestBodyToOutputStream(\n-          httpURLConnection, getJsonBytes(buildCreateFirebaseInstallationRequestBody(fid, appId)));\n-    } catch (JSONException e) {\n-      throw new IllegalStateException(e);\n-    }\n+    writeRequestBodyToOutputStream(\n+        httpURLConnection, getJsonBytes(buildCreateFirebaseInstallationRequestBody(fid, appId)));\n   }\n \n-  private static byte[] getJsonBytes(JSONObject jsonObject) throws UnsupportedEncodingException {\n+  /**\n+   * Encodes {@link JSONObject} String representation into a sequence of bytes using the UTF-8\n+   * charset.\n+   *\n+   * @return The resulting byte array.\n+   * @throws java.io.UnsupportedEncodingException A type of {@link IOException}, if the named\n+   *     charset is not supported.\n+   */\n+  private static byte[] getJsonBytes(JSONObject jsonObject) throws IOException {\n     return jsonObject.toString().getBytes(\"UTF-8\");\n   }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMwODI5Ng==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1345#discussion_r404308296", "bodyText": "I wonder if this creates more confusion than clarity. What do you think?\nMaybe it's better to just say throws IOException and explain in the JavaDoc (or even an inline comment) that it is a UnsupportedEncodingException?", "author": "andirayo", "createdAt": "2020-04-06T18:41:13Z", "path": "firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java", "diffHunk": "@@ -177,20 +180,27 @@ public InstallationResponse createFirebaseInstallation(\n   private void writeFIDCreateRequestBodyToOutputStream(\n       HttpURLConnection httpURLConnection, @NonNull String fid, @NonNull String appId)\n       throws IOException {\n-    OutputStream outputStream = httpURLConnection.getOutputStream();\n-    if (outputStream == null) {\n-      throw new IOException(\n-          \"Cannot send CreateInstallation request to FIS. No OutputStream available.\");\n-    }\n-\n-    GZIPOutputStream gzipOutputStream = new GZIPOutputStream(outputStream);\n     try {\n-      gzipOutputStream.write(\n-          buildCreateFirebaseInstallationRequestBody(fid, appId).toString().getBytes(\"UTF-8\"));\n+      writeRequestBodyToOutputStream(\n+          httpURLConnection, getJsonBytes(buildCreateFirebaseInstallationRequestBody(fid, appId)));\n     } catch (JSONException e) {\n       throw new IllegalStateException(e);\n-    } finally {\n-      gzipOutputStream.close();\n+    }\n+  }\n+\n+  private static byte[] getJsonBytes(JSONObject jsonObject) throws UnsupportedEncodingException {", "originalCommit": "55ca644b143ff6ff7bdfdc607473b66f7cea165b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA5MTUwMA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1345#discussion_r405091500", "bodyText": "Done.", "author": "ankitaj224", "createdAt": "2020-04-07T20:27:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMwODI5Ng=="}], "type": "inlineReview", "revised_code": {"commit": "bffe96393fe24cec068d42b5bf650becd7deac9a", "chunk": "diff --git a/firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java b/firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java\nindex f76de398..68bf4a0d 100644\n--- a/firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java\n+++ b/firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java\n\n@@ -180,15 +179,19 @@ public class FirebaseInstallationServiceClient {\n   private void writeFIDCreateRequestBodyToOutputStream(\n       HttpURLConnection httpURLConnection, @NonNull String fid, @NonNull String appId)\n       throws IOException {\n-    try {\n-      writeRequestBodyToOutputStream(\n-          httpURLConnection, getJsonBytes(buildCreateFirebaseInstallationRequestBody(fid, appId)));\n-    } catch (JSONException e) {\n-      throw new IllegalStateException(e);\n-    }\n+    writeRequestBodyToOutputStream(\n+        httpURLConnection, getJsonBytes(buildCreateFirebaseInstallationRequestBody(fid, appId)));\n   }\n \n-  private static byte[] getJsonBytes(JSONObject jsonObject) throws UnsupportedEncodingException {\n+  /**\n+   * Encodes {@link JSONObject} String representation into a sequence of bytes using the UTF-8\n+   * charset.\n+   *\n+   * @return The resulting byte array.\n+   * @throws java.io.UnsupportedEncodingException A type of {@link IOException}, if the named\n+   *     charset is not supported.\n+   */\n+  private static byte[] getJsonBytes(JSONObject jsonObject) throws IOException {\n     return jsonObject.toString().getBytes(\"UTF-8\");\n   }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMxMDAyNw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1345#discussion_r404310027", "bodyText": "Where is the JSONException thrown? How about catching this JSONException where it is thrown and throw an IllegalStateException instead. That way this method even becomes cleaner and we have less code duplication (of catching this exception).\nIf you do, please add in JavaDoc of this comment that it might throw an IllegalStateException in case there is a problem with the JSON.", "author": "andirayo", "createdAt": "2020-04-06T18:44:09Z", "path": "firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java", "diffHunk": "@@ -177,20 +180,27 @@ public InstallationResponse createFirebaseInstallation(\n   private void writeFIDCreateRequestBodyToOutputStream(\n       HttpURLConnection httpURLConnection, @NonNull String fid, @NonNull String appId)\n       throws IOException {\n-    OutputStream outputStream = httpURLConnection.getOutputStream();\n-    if (outputStream == null) {\n-      throw new IOException(\n-          \"Cannot send CreateInstallation request to FIS. No OutputStream available.\");\n-    }\n-\n-    GZIPOutputStream gzipOutputStream = new GZIPOutputStream(outputStream);\n     try {\n-      gzipOutputStream.write(\n-          buildCreateFirebaseInstallationRequestBody(fid, appId).toString().getBytes(\"UTF-8\"));\n+      writeRequestBodyToOutputStream(\n+          httpURLConnection, getJsonBytes(buildCreateFirebaseInstallationRequestBody(fid, appId)));\n     } catch (JSONException e) {\n       throw new IllegalStateException(e);", "originalCommit": "55ca644b143ff6ff7bdfdc607473b66f7cea165b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA5MTQzMA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1345#discussion_r405091430", "bodyText": "Done.", "author": "ankitaj224", "createdAt": "2020-04-07T20:27:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMxMDAyNw=="}], "type": "inlineReview", "revised_code": {"commit": "bffe96393fe24cec068d42b5bf650becd7deac9a", "chunk": "diff --git a/firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java b/firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java\nindex f76de398..68bf4a0d 100644\n--- a/firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java\n+++ b/firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java\n\n@@ -180,15 +179,19 @@ public class FirebaseInstallationServiceClient {\n   private void writeFIDCreateRequestBodyToOutputStream(\n       HttpURLConnection httpURLConnection, @NonNull String fid, @NonNull String appId)\n       throws IOException {\n-    try {\n-      writeRequestBodyToOutputStream(\n-          httpURLConnection, getJsonBytes(buildCreateFirebaseInstallationRequestBody(fid, appId)));\n-    } catch (JSONException e) {\n-      throw new IllegalStateException(e);\n-    }\n+    writeRequestBodyToOutputStream(\n+        httpURLConnection, getJsonBytes(buildCreateFirebaseInstallationRequestBody(fid, appId)));\n   }\n \n-  private static byte[] getJsonBytes(JSONObject jsonObject) throws UnsupportedEncodingException {\n+  /**\n+   * Encodes {@link JSONObject} String representation into a sequence of bytes using the UTF-8\n+   * charset.\n+   *\n+   * @return The resulting byte array.\n+   * @throws java.io.UnsupportedEncodingException A type of {@link IOException}, if the named\n+   *     charset is not supported.\n+   */\n+  private static byte[] getJsonBytes(JSONObject jsonObject) throws IOException {\n     return jsonObject.toString().getBytes(\"UTF-8\");\n   }\n \n"}}, {"oid": "bffe96393fe24cec068d42b5bf650becd7deac9a", "url": "https://github.com/firebase/firebase-android-sdk/commit/bffe96393fe24cec068d42b5bf650becd7deac9a", "message": "Adding javadocs and cleaning the exceptions", "committedDate": "2020-04-07T20:27:01Z", "type": "commit"}]}