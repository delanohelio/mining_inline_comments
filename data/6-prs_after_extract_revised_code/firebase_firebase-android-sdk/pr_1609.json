{"pr_number": 1609, "pr_title": "Avoid throwing explcit IOExceptions.", "pr_createdAt": "2020-06-01T20:35:28Z", "pr_url": "https://github.com/firebase/firebase-android-sdk/pull/1609", "timeline": [{"oid": "4283a2bb3b4434510e061a0d9c4b080595658c2a", "url": "https://github.com/firebase/firebase-android-sdk/commit/4283a2bb3b4434510e061a0d9c4b080595658c2a", "message": "Dropping guava and appcompat dependency from FIS SDK.", "committedDate": "2020-02-06T17:59:09Z", "type": "commit"}, {"oid": "984884cd6f9a90a8172d0957bd13e68e3f06db2f", "url": "https://github.com/firebase/firebase-android-sdk/commit/984884cd6f9a90a8172d0957bd13e68e3f06db2f", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-02-06T18:16:08Z", "type": "commit"}, {"oid": "a82387701d2549bb5fc3b5dc2530a83ed0680d02", "url": "https://github.com/firebase/firebase-android-sdk/commit/a82387701d2549bb5fc3b5dc2530a83ed0680d02", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-02-11T18:58:16Z", "type": "commit"}, {"oid": "afcb14c913c8dedd87faf6b71fdc7dd4384a6c39", "url": "https://github.com/firebase/firebase-android-sdk/commit/afcb14c913c8dedd87faf6b71fdc7dd4384a6c39", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-02-13T23:37:48Z", "type": "commit"}, {"oid": "5574e30b8e3f6c9d09bfca149a6f7853c4141d25", "url": "https://github.com/firebase/firebase-android-sdk/commit/5574e30b8e3f6c9d09bfca149a6f7853c4141d25", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-03-05T16:49:33Z", "type": "commit"}, {"oid": "a5dd4dc54f2b7941ffe4b5cd76b6c8ab5764f7a1", "url": "https://github.com/firebase/firebase-android-sdk/commit/a5dd4dc54f2b7941ffe4b5cd76b6c8ab5764f7a1", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-03-09T16:31:08Z", "type": "commit"}, {"oid": "45312e68fe8516dc4d48a2bfdb422f5023c1241b", "url": "https://github.com/firebase/firebase-android-sdk/commit/45312e68fe8516dc4d48a2bfdb422f5023c1241b", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-03-10T18:13:59Z", "type": "commit"}, {"oid": "f0be4fa07222c687044f66d8cb2859e156611896", "url": "https://github.com/firebase/firebase-android-sdk/commit/f0be4fa07222c687044f66d8cb2859e156611896", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-03-10T21:55:48Z", "type": "commit"}, {"oid": "ac0397ba816265b24da3eca4645761a37d4b46b6", "url": "https://github.com/firebase/firebase-android-sdk/commit/ac0397ba816265b24da3eca4645761a37d4b46b6", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-03-11T18:14:18Z", "type": "commit"}, {"oid": "8f6b46e3346cad5d3a4128ad1316e9e0831c0a2b", "url": "https://github.com/firebase/firebase-android-sdk/commit/8f6b46e3346cad5d3a4128ad1316e9e0831c0a2b", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-03-12T19:40:52Z", "type": "commit"}, {"oid": "686a998ab40a6c855d81b30f7686ef20aef1713c", "url": "https://github.com/firebase/firebase-android-sdk/commit/686a998ab40a6c855d81b30f7686ef20aef1713c", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-03-16T17:31:01Z", "type": "commit"}, {"oid": "3bf7c24892fc6d66b4b33cb943ac2fe9e3e11598", "url": "https://github.com/firebase/firebase-android-sdk/commit/3bf7c24892fc6d66b4b33cb943ac2fe9e3e11598", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-03-18T21:05:27Z", "type": "commit"}, {"oid": "07ff7ddc966270c28df8d123ef95e63a9f058494", "url": "https://github.com/firebase/firebase-android-sdk/commit/07ff7ddc966270c28df8d123ef95e63a9f058494", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-03-30T21:58:00Z", "type": "commit"}, {"oid": "f982f2d752d3567a1164b6f3bb00a1dfc601ab91", "url": "https://github.com/firebase/firebase-android-sdk/commit/f982f2d752d3567a1164b6f3bb00a1dfc601ab91", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-03-31T22:05:19Z", "type": "commit"}, {"oid": "672526aca799c55e7f83aaa0f08c7e698be388ed", "url": "https://github.com/firebase/firebase-android-sdk/commit/672526aca799c55e7f83aaa0f08c7e698be388ed", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-04-05T05:34:09Z", "type": "commit"}, {"oid": "1adf4a2621f9367521f806ea893770921713e49f", "url": "https://github.com/firebase/firebase-android-sdk/commit/1adf4a2621f9367521f806ea893770921713e49f", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-04-07T20:56:39Z", "type": "commit"}, {"oid": "4435ed00d6c6d59ae1dd2442e034c75873bf8ed8", "url": "https://github.com/firebase/firebase-android-sdk/commit/4435ed00d6c6d59ae1dd2442e034c75873bf8ed8", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-04-10T21:22:37Z", "type": "commit"}, {"oid": "99f1f827dac599f04bd69eea5a49c1596eadf49a", "url": "https://github.com/firebase/firebase-android-sdk/commit/99f1f827dac599f04bd69eea5a49c1596eadf49a", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-04-13T22:51:18Z", "type": "commit"}, {"oid": "08d91f888d6ce2f18b5fdf6ef20936c9bc7974c2", "url": "https://github.com/firebase/firebase-android-sdk/commit/08d91f888d6ce2f18b5fdf6ef20936c9bc7974c2", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-05-01T16:39:27Z", "type": "commit"}, {"oid": "747598f42b4fc9fa882b8feb3e8c8d1b652739ec", "url": "https://github.com/firebase/firebase-android-sdk/commit/747598f42b4fc9fa882b8feb3e8c8d1b652739ec", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-05-01T18:36:33Z", "type": "commit"}, {"oid": "28cc955fd37c7127dd30ccdcee326328e32b499d", "url": "https://github.com/firebase/firebase-android-sdk/commit/28cc955fd37c7127dd30ccdcee326328e32b499d", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-05-05T22:00:57Z", "type": "commit"}, {"oid": "519ae71d474bab8a8483f2b5269d53f1536e107d", "url": "https://github.com/firebase/firebase-android-sdk/commit/519ae71d474bab8a8483f2b5269d53f1536e107d", "message": "Fix OverlappingFileLockException.\n\nAccess the data shared by multiple threads only after acquiring cross-process and multi-thread safe locks.", "committedDate": "2020-05-08T17:37:48Z", "type": "commit"}, {"oid": "98e0e25dfa3de3310fd68207622af5d02e1a4f1d", "url": "https://github.com/firebase/firebase-android-sdk/commit/98e0e25dfa3de3310fd68207622af5d02e1a4f1d", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-05-08T17:38:10Z", "type": "commit"}, {"oid": "cba321b43380cb858bc362889c9a75b088763238", "url": "https://github.com/firebase/firebase-android-sdk/commit/cba321b43380cb858bc362889c9a75b088763238", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-05-08T22:18:10Z", "type": "commit"}, {"oid": "28598b0c6d552f653e4d55cc181a1df960552814", "url": "https://github.com/firebase/firebase-android-sdk/commit/28598b0c6d552f653e4d55cc181a1df960552814", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-05-12T22:29:04Z", "type": "commit"}, {"oid": "9519e70f23f1d3e80515b1af8c3ffc8076dcf0ba", "url": "https://github.com/firebase/firebase-android-sdk/commit/9519e70f23f1d3e80515b1af8c3ffc8076dcf0ba", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-05-18T16:54:47Z", "type": "commit"}, {"oid": "a0580da2df9df45c5339ad2e14013be172cb7fcf", "url": "https://github.com/firebase/firebase-android-sdk/commit/a0580da2df9df45c5339ad2e14013be172cb7fcf", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-05-20T17:14:08Z", "type": "commit"}, {"oid": "5ff30b5409381cbbca90710e120c68078f9e6556", "url": "https://github.com/firebase/firebase-android-sdk/commit/5ff30b5409381cbbca90710e120c68078f9e6556", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-05-29T17:12:19Z", "type": "commit"}, {"oid": "e445fd3432512309527208a2a192ed1abd3e74ed", "url": "https://github.com/firebase/firebase-android-sdk/commit/e445fd3432512309527208a2a192ed1abd3e74ed", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-06-01T17:56:37Z", "type": "commit"}, {"oid": "6ddee387374f596854ab374ca56afa54944f4ad1", "url": "https://github.com/firebase/firebase-android-sdk/commit/6ddee387374f596854ab374ca56afa54944f4ad1", "message": "Avoid throwing explcit IOExceptions.\n\nAlso, handle slow network connection issues by retrying and back off.", "committedDate": "2020-06-01T20:32:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQ3NTUzMA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1609#discussion_r433475530", "bodyText": "Can we just throw 1 exception type here?\nOr where happens the unification (of exception types) for users?", "author": "andirayo", "createdAt": "2020-06-01T20:37:19Z", "path": "firebase-installations/src/main/java/com/google/firebase/installations/FirebaseInstallations.java", "diffHunk": "@@ -444,7 +444,7 @@ private String readExistingIidOrCreateFid(PersistedInstallationEntry prefs) {\n \n   /** Registers the created Fid with FIS servers and update the persisted state. */\n   private PersistedInstallationEntry registerFidWithServer(PersistedInstallationEntry prefs)\n-      throws IOException {\n+      throws FirebaseInstallationsException, IOException {", "originalCommit": "6ddee387374f596854ab374ca56afa54944f4ad1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0fc20e98252107559d4158ed40764bc684e3a41", "chunk": "diff --git a/firebase-installations/src/main/java/com/google/firebase/installations/FirebaseInstallations.java b/firebase-installations/src/main/java/com/google/firebase/installations/FirebaseInstallations.java\nindex 6ae6ffe3e..bbfb9b5d7 100644\n--- a/firebase-installations/src/main/java/com/google/firebase/installations/FirebaseInstallations.java\n+++ b/firebase-installations/src/main/java/com/google/firebase/installations/FirebaseInstallations.java\n\n@@ -444,7 +443,7 @@ public class FirebaseInstallations implements FirebaseInstallationsApi {\n \n   /** Registers the created Fid with FIS servers and update the persisted state. */\n   private PersistedInstallationEntry registerFidWithServer(PersistedInstallationEntry prefs)\n-      throws FirebaseInstallationsException, IOException {\n+      throws FirebaseInstallationsException {\n \n     // Note: Default value of instanceIdMigrationAuth: null\n     String iidToken = null;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQ3NjY1MA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1609#discussion_r433476650", "bodyText": "Why do we catch FirebaseException here?\na) Do we ever use any Exception type other than FirebaseInstallationsException?\nIf yes: why? If no: I recommend to check for FirebaseInstallationsException here.\nb) Why do we catch FirebaseInstallationsException?\ncatching and rethrowing the same exception is an antipattern.\nCan we not just leave the FirebaseInstallationsException as is?", "author": "andirayo", "createdAt": "2020-06-01T20:39:39Z", "path": "firebase-installations/src/main/java/com/google/firebase/installations/FirebaseInstallations.java", "diffHunk": "@@ -527,7 +532,7 @@ private Void deleteFirebaseInstallationId() throws FirebaseInstallationsExceptio\n             /*projectID= */ getProjectIdentifier(),\n             /*refreshToken= */ entry.getRefreshToken());\n \n-      } catch (FirebaseException exception) {\n+      } catch (FirebaseException | IOException exception) {", "originalCommit": "6ddee387374f596854ab374ca56afa54944f4ad1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUyNzQwOQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1609#discussion_r433527409", "bodyText": "Update to check only FirebaseInstallationsException.\nAgreed on the anti-pattern. Updated the code to remove this code.\nI don't know the reason why we had this anti-pattern behavior before.", "author": "ankitaj224", "createdAt": "2020-06-01T22:41:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQ3NjY1MA=="}], "type": "inlineReview", "revised_code": {"commit": "e0fc20e98252107559d4158ed40764bc684e3a41", "chunk": "diff --git a/firebase-installations/src/main/java/com/google/firebase/installations/FirebaseInstallations.java b/firebase-installations/src/main/java/com/google/firebase/installations/FirebaseInstallations.java\nindex 6ae6ffe3e..bbfb9b5d7 100644\n--- a/firebase-installations/src/main/java/com/google/firebase/installations/FirebaseInstallations.java\n+++ b/firebase-installations/src/main/java/com/google/firebase/installations/FirebaseInstallations.java\n\n@@ -532,7 +530,7 @@ public class FirebaseInstallations implements FirebaseInstallationsApi {\n             /*projectID= */ getProjectIdentifier(),\n             /*refreshToken= */ entry.getRefreshToken());\n \n-      } catch (FirebaseException | IOException exception) {\n+      } catch (FirebaseInstallationsException exception) {\n         throw new FirebaseInstallationsException(\n             \"Failed to delete a Firebase Installation.\", Status.BAD_CONFIG);\n       }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQ3Nzc4MQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1609#discussion_r433477781", "bodyText": "What \"backoff\" are you referring to?\nExponential backoff?\nIf this is a public comment, I think I would either omit this addition or frame it like this:\n\"This is a most likely due to a transient condition and may be corrected by retrying. We recommend exponential backoff when retrying requests.\"", "author": "andirayo", "createdAt": "2020-06-01T20:41:53Z", "path": "firebase-installations/src/main/java/com/google/firebase/installations/FirebaseInstallationsException.java", "diffHunk": "@@ -29,6 +29,11 @@\n      * Project.\n      */\n     BAD_CONFIG,\n+    /**\n+     * The service is currently unavailable. This is a most likely a transient condition and may be\n+     * corrected by retrying with a backoff.", "originalCommit": "6ddee387374f596854ab374ca56afa54944f4ad1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0fc20e98252107559d4158ed40764bc684e3a41", "chunk": "diff --git a/firebase-installations/src/main/java/com/google/firebase/installations/FirebaseInstallationsException.java b/firebase-installations/src/main/java/com/google/firebase/installations/FirebaseInstallationsException.java\nindex 114a34190..e11ff4b80 100644\n--- a/firebase-installations/src/main/java/com/google/firebase/installations/FirebaseInstallationsException.java\n+++ b/firebase-installations/src/main/java/com/google/firebase/installations/FirebaseInstallationsException.java\n\n@@ -29,9 +29,10 @@ public class FirebaseInstallationsException extends FirebaseException {\n      * Project.\n      */\n     BAD_CONFIG,\n+\n     /**\n-     * The service is currently unavailable. This is a most likely a transient condition and may be\n-     * corrected by retrying with a backoff.\n+     * The service is currently unavailable. This is a most likely due to a transient condition and\n+     * may be corrected by retrying. We recommend exponential backoff when retrying requests.\"\n      */\n     UNAVAILABLE,\n   }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQ3ODI1Nw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1609#discussion_r433478257", "bodyText": "Why are we still throwing IOException?\nCan we get around this and only throw 1 exception type?\nSee comment below.", "author": "andirayo", "createdAt": "2020-06-01T20:42:47Z", "path": "firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java", "diffHunk": "@@ -138,7 +138,7 @@ public InstallationResponse createFirebaseInstallation(\n       @NonNull String projectID,\n       @NonNull String appId,\n       @Nullable String iidToken)\n-      throws IOException {\n+      throws FirebaseInstallationsException, IOException {", "originalCommit": "6ddee387374f596854ab374ca56afa54944f4ad1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0fc20e98252107559d4158ed40764bc684e3a41", "chunk": "diff --git a/firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java b/firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java\nindex 2e35eb282..08e97f93f 100644\n--- a/firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java\n+++ b/firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java\n\n@@ -138,16 +138,10 @@ public class FirebaseInstallationServiceClient {\n       @NonNull String projectID,\n       @NonNull String appId,\n       @Nullable String iidToken)\n-      throws FirebaseInstallationsException, IOException {\n+      throws FirebaseInstallationsException {\n     String resourceName = String.format(CREATE_REQUEST_RESOURCE_NAME_FORMAT, projectID);\n     int retryCount = 0;\n-    URL url =\n-        new URL(\n-            String.format(\n-                \"https://%s/%s/%s\",\n-                FIREBASE_INSTALLATIONS_API_DOMAIN,\n-                FIREBASE_INSTALLATIONS_API_VERSION,\n-                resourceName));\n+    URL url = getURL(resourceName);\n     while (retryCount <= MAX_RETRIES) {\n       HttpURLConnection httpURLConnection = openHttpURLConnection(url, apiKey);\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQ3ODUyMg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1609#discussion_r433478522", "bodyText": "If we catch and ignore IOException here, can we remove IOException from the method interface?", "author": "andirayo", "createdAt": "2020-06-01T20:43:15Z", "path": "firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java", "diffHunk": "@@ -179,12 +179,16 @@ public InstallationResponse createFirebaseInstallation(\n \n         // Return empty installation response with BAD_CONFIG response code after max retries\n         return InstallationResponse.builder().setResponseCode(ResponseCode.BAD_CONFIG).build();\n+      } catch (IOException ignored) {\n+        retryCount++;\n       } finally {\n         httpURLConnection.disconnect();", "originalCommit": "6ddee387374f596854ab374ca56afa54944f4ad1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQ3ODg3NA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1609#discussion_r433478874", "bodyText": "Same question as before.\nBtw, just as a comment, no action item for this PR: quite a bit of code duplication going on here.", "author": "andirayo", "createdAt": "2020-06-01T20:43:57Z", "path": "firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java", "diffHunk": "@@ -352,7 +360,7 @@ public TokenResult generateAuthToken(\n       @NonNull String fid,\n       @NonNull String projectID,\n       @NonNull String refreshToken)\n-      throws IOException {\n+      throws FirebaseInstallationsException, IOException {", "originalCommit": "6ddee387374f596854ab374ca56afa54944f4ad1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUxNzM2MA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1609#discussion_r433517360", "bodyText": "I will address the code duplication in another PR. Updated the exception handling.  PTAL. Thanks", "author": "ankitaj224", "createdAt": "2020-06-01T22:11:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQ3ODg3NA=="}], "type": "inlineReview", "revised_code": {"commit": "e0fc20e98252107559d4158ed40764bc684e3a41", "chunk": "diff --git a/firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java b/firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java\nindex 2e35eb282..08e97f93f 100644\n--- a/firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java\n+++ b/firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java\n\n@@ -360,17 +359,11 @@ public class FirebaseInstallationServiceClient {\n       @NonNull String fid,\n       @NonNull String projectID,\n       @NonNull String refreshToken)\n-      throws FirebaseInstallationsException, IOException {\n+      throws FirebaseInstallationsException {\n     String resourceName =\n         String.format(GENERATE_AUTH_TOKEN_REQUEST_RESOURCE_NAME_FORMAT, projectID, fid);\n     int retryCount = 0;\n-    URL url =\n-        new URL(\n-            String.format(\n-                \"https://%s/%s/%s\",\n-                FIREBASE_INSTALLATIONS_API_DOMAIN,\n-                FIREBASE_INSTALLATIONS_API_VERSION,\n-                resourceName));\n+    URL url = getURL(resourceName);\n     while (retryCount <= MAX_RETRIES) {\n       HttpURLConnection httpURLConnection = openHttpURLConnection(url, apiKey);\n       try {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQ3OTMwOA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1609#discussion_r433479308", "bodyText": "is it maybe enough to wrap this line with the try-catch block?\nMaybe it gives more clarity about what can go wrong here.", "author": "andirayo", "createdAt": "2020-06-01T20:44:46Z", "path": "firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java", "diffHunk": "@@ -407,27 +419,37 @@ private static void logBadConfigError() {\n             + \" initializing Firebase.\");\n   }\n \n-  private HttpURLConnection openHttpURLConnection(URL url, String apiKey) throws IOException {\n-    HttpURLConnection httpURLConnection = (HttpURLConnection) url.openConnection();\n-    httpURLConnection.setConnectTimeout(NETWORK_TIMEOUT_MILLIS);\n-    httpURLConnection.setUseCaches(false);\n-    httpURLConnection.setReadTimeout(NETWORK_TIMEOUT_MILLIS);\n-    httpURLConnection.addRequestProperty(CONTENT_TYPE_HEADER_KEY, JSON_CONTENT_TYPE);\n-    httpURLConnection.addRequestProperty(ACCEPT_HEADER_KEY, JSON_CONTENT_TYPE);\n-    httpURLConnection.addRequestProperty(CONTENT_ENCODING_HEADER_KEY, GZIP_CONTENT_ENCODING);\n-    httpURLConnection.addRequestProperty(CACHE_CONTROL_HEADER_KEY, CACHE_CONTROL_DIRECTIVE);\n-    httpURLConnection.addRequestProperty(X_ANDROID_PACKAGE_HEADER_KEY, context.getPackageName());\n-    if (heartbeatInfo != null && userAgentPublisher != null) {\n-      HeartBeat heartbeat = heartbeatInfo.getHeartBeatCode(FIREBASE_INSTALLATIONS_ID_HEARTBEAT_TAG);\n-      if (heartbeat != HeartBeat.NONE) {\n-        httpURLConnection.addRequestProperty(USER_AGENT_HEADER, userAgentPublisher.getUserAgent());\n-        httpURLConnection.addRequestProperty(\n-            HEART_BEAT_HEADER, Integer.toString(heartbeat.getCode()));\n+  private HttpURLConnection openHttpURLConnection(URL url, String apiKey)\n+      throws FirebaseInstallationsException {\n+    try {\n+      HttpURLConnection httpURLConnection = (HttpURLConnection) url.openConnection();", "originalCommit": "6ddee387374f596854ab374ca56afa54944f4ad1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUxNzA2Mg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1609#discussion_r433517062", "bodyText": "Done.", "author": "ankitaj224", "createdAt": "2020-06-01T22:10:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQ3OTMwOA=="}], "type": "inlineReview", "revised_code": {"commit": "e0fc20e98252107559d4158ed40764bc684e3a41", "chunk": "diff --git a/firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java b/firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java\nindex 2e35eb282..08e97f93f 100644\n--- a/firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java\n+++ b/firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java\n\n@@ -421,35 +414,33 @@ public class FirebaseInstallationServiceClient {\n \n   private HttpURLConnection openHttpURLConnection(URL url, String apiKey)\n       throws FirebaseInstallationsException {\n+    HttpURLConnection httpURLConnection;\n     try {\n-      HttpURLConnection httpURLConnection = (HttpURLConnection) url.openConnection();\n-      httpURLConnection.setConnectTimeout(NETWORK_TIMEOUT_MILLIS);\n-      httpURLConnection.setUseCaches(false);\n-      httpURLConnection.setReadTimeout(NETWORK_TIMEOUT_MILLIS);\n-      httpURLConnection.addRequestProperty(CONTENT_TYPE_HEADER_KEY, JSON_CONTENT_TYPE);\n-      httpURLConnection.addRequestProperty(ACCEPT_HEADER_KEY, JSON_CONTENT_TYPE);\n-      httpURLConnection.addRequestProperty(CONTENT_ENCODING_HEADER_KEY, GZIP_CONTENT_ENCODING);\n-      httpURLConnection.addRequestProperty(CACHE_CONTROL_HEADER_KEY, CACHE_CONTROL_DIRECTIVE);\n-      httpURLConnection.addRequestProperty(X_ANDROID_PACKAGE_HEADER_KEY, context.getPackageName());\n-      if (heartbeatInfo != null && userAgentPublisher != null) {\n-        HeartBeat heartbeat =\n-            heartbeatInfo.getHeartBeatCode(FIREBASE_INSTALLATIONS_ID_HEARTBEAT_TAG);\n-        if (heartbeat != HeartBeat.NONE) {\n-          httpURLConnection.addRequestProperty(\n-              USER_AGENT_HEADER, userAgentPublisher.getUserAgent());\n-          httpURLConnection.addRequestProperty(\n-              HEART_BEAT_HEADER, Integer.toString(heartbeat.getCode()));\n-        }\n-      }\n-      httpURLConnection.addRequestProperty(\n-          X_ANDROID_CERT_HEADER_KEY, getFingerprintHashForPackage());\n-      httpURLConnection.addRequestProperty(API_KEY_HEADER, apiKey);\n-      return httpURLConnection;\n+      httpURLConnection = (HttpURLConnection) url.openConnection();\n     } catch (IOException ignored) {\n       throw new FirebaseInstallationsException(\n           \"Firebase Installations Service is unavailable. Please try again later.\",\n           Status.UNAVAILABLE);\n     }\n+    httpURLConnection.setConnectTimeout(NETWORK_TIMEOUT_MILLIS);\n+    httpURLConnection.setUseCaches(false);\n+    httpURLConnection.setReadTimeout(NETWORK_TIMEOUT_MILLIS);\n+    httpURLConnection.addRequestProperty(CONTENT_TYPE_HEADER_KEY, JSON_CONTENT_TYPE);\n+    httpURLConnection.addRequestProperty(ACCEPT_HEADER_KEY, JSON_CONTENT_TYPE);\n+    httpURLConnection.addRequestProperty(CONTENT_ENCODING_HEADER_KEY, GZIP_CONTENT_ENCODING);\n+    httpURLConnection.addRequestProperty(CACHE_CONTROL_HEADER_KEY, CACHE_CONTROL_DIRECTIVE);\n+    httpURLConnection.addRequestProperty(X_ANDROID_PACKAGE_HEADER_KEY, context.getPackageName());\n+    if (heartbeatInfo != null && userAgentPublisher != null) {\n+      HeartBeat heartbeat = heartbeatInfo.getHeartBeatCode(FIREBASE_INSTALLATIONS_ID_HEARTBEAT_TAG);\n+      if (heartbeat != HeartBeat.NONE) {\n+        httpURLConnection.addRequestProperty(USER_AGENT_HEADER, userAgentPublisher.getUserAgent());\n+        httpURLConnection.addRequestProperty(\n+            HEART_BEAT_HEADER, Integer.toString(heartbeat.getCode()));\n+      }\n+    }\n+    httpURLConnection.addRequestProperty(X_ANDROID_CERT_HEADER_KEY, getFingerprintHashForPackage());\n+    httpURLConnection.addRequestProperty(API_KEY_HEADER, apiKey);\n+    return httpURLConnection;\n   }\n \n   // Read the response from the createFirebaseInstallation API.\n"}}, {"oid": "e0fc20e98252107559d4158ed40764bc684e3a41", "url": "https://github.com/firebase/firebase-android-sdk/commit/e0fc20e98252107559d4158ed40764bc684e3a41", "message": "Addressing rayo's comments", "committedDate": "2020-06-01T22:09:50Z", "type": "commit"}, {"oid": "0eb7d6d4f0e7bcd85ba5296fafecd6b969ffbf8f", "url": "https://github.com/firebase/firebase-android-sdk/commit/0eb7d6d4f0e7bcd85ba5296fafecd6b969ffbf8f", "message": "Fixing Delete Api", "committedDate": "2020-06-01T22:38:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU3NzE2OA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1609#discussion_r433577168", "bodyText": "Why are you casting this URLConnection?\nAre you using methods that are specific to HttpURLConnection?\nIf not, I strongly recommend programming against the interface rather than the implementation.", "author": "andirayo", "createdAt": "2020-06-02T01:46:34Z", "path": "firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java", "diffHunk": "@@ -407,8 +412,16 @@ private static void logBadConfigError() {\n             + \" initializing Firebase.\");\n   }\n \n-  private HttpURLConnection openHttpURLConnection(URL url, String apiKey) throws IOException {\n-    HttpURLConnection httpURLConnection = (HttpURLConnection) url.openConnection();\n+  private HttpURLConnection openHttpURLConnection(URL url, String apiKey)\n+      throws FirebaseInstallationsException {\n+    HttpURLConnection httpURLConnection;\n+    try {\n+      httpURLConnection = (HttpURLConnection) url.openConnection();", "originalCommit": "0eb7d6d4f0e7bcd85ba5296fafecd6b969ffbf8f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDIxODU3MA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1609#discussion_r434218570", "bodyText": "Yes, I am using methods specific to HttpURLConnection", "author": "ankitaj224", "createdAt": "2020-06-02T22:54:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU3NzE2OA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU3ODAwMg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1609#discussion_r433578002", "bodyText": "+1 for adding this method!\nAn idea for a different name (feel free to ignore):\n#getFullyQualifiedRequestUri\n#getFullyQualifiedApiEndpoint", "author": "andirayo", "createdAt": "2020-06-02T01:49:58Z", "path": "firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java", "diffHunk": "@@ -321,12 +313,27 @@ public void deleteFirebaseInstallation(\n \n         throw new FirebaseInstallationsException(\n             \"Bad config while trying to delete FID\", Status.BAD_CONFIG);\n+      } catch (IOException ignored) {\n+        retryCount++;\n       } finally {\n         httpURLConnection.disconnect();\n       }\n     }\n \n-    throw new IOException();\n+    throw new FirebaseInstallationsException(\n+        \"Firebase Installations Service is unavailable. Please try again later.\",\n+        Status.UNAVAILABLE);\n+  }\n+\n+  private URL getURL(String resourceName) throws FirebaseInstallationsException {", "originalCommit": "0eb7d6d4f0e7bcd85ba5296fafecd6b969ffbf8f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "7941a347eced2aafc7adefdd655c3d0fbd0f98b0", "chunk": "diff --git a/firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java b/firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java\nindex 08e97f93f..2775cf564 100644\n--- a/firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java\n+++ b/firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java\n\n@@ -325,7 +325,8 @@ public class FirebaseInstallationServiceClient {\n         Status.UNAVAILABLE);\n   }\n \n-  private URL getURL(String resourceName) throws FirebaseInstallationsException {\n+  private URL getFullyQualifiedRequestUri(String resourceName)\n+      throws FirebaseInstallationsException {\n     try {\n       return new URL(\n           String.format(\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU3ODI0OQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1609#discussion_r433578249", "bodyText": "This seems to be a pretty dramatic error.\nHow about we add some message here, e.g.\n\"Unexpected internal error while creating request URI.\"\nI don't know.\nFeel free to ignore.", "author": "andirayo", "createdAt": "2020-06-02T01:50:54Z", "path": "firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java", "diffHunk": "@@ -321,12 +313,27 @@ public void deleteFirebaseInstallation(\n \n         throw new FirebaseInstallationsException(\n             \"Bad config while trying to delete FID\", Status.BAD_CONFIG);\n+      } catch (IOException ignored) {\n+        retryCount++;\n       } finally {\n         httpURLConnection.disconnect();\n       }\n     }\n \n-    throw new IOException();\n+    throw new FirebaseInstallationsException(\n+        \"Firebase Installations Service is unavailable. Please try again later.\",\n+        Status.UNAVAILABLE);\n+  }\n+\n+  private URL getURL(String resourceName) throws FirebaseInstallationsException {\n+    try {\n+      return new URL(\n+          String.format(\n+              \"https://%s/%s/%s\",\n+              FIREBASE_INSTALLATIONS_API_DOMAIN, FIREBASE_INSTALLATIONS_API_VERSION, resourceName));\n+    } catch (MalformedURLException e) {\n+      throw new FirebaseInstallationsException(e.getMessage(), Status.UNAVAILABLE);", "originalCommit": "0eb7d6d4f0e7bcd85ba5296fafecd6b969ffbf8f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "7941a347eced2aafc7adefdd655c3d0fbd0f98b0", "chunk": "diff --git a/firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java b/firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java\nindex 08e97f93f..2775cf564 100644\n--- a/firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java\n+++ b/firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java\n\n@@ -325,7 +325,8 @@ public class FirebaseInstallationServiceClient {\n         Status.UNAVAILABLE);\n   }\n \n-  private URL getURL(String resourceName) throws FirebaseInstallationsException {\n+  private URL getFullyQualifiedRequestUri(String resourceName)\n+      throws FirebaseInstallationsException {\n     try {\n       return new URL(\n           String.format(\n"}}, {"oid": "7941a347eced2aafc7adefdd655c3d0fbd0f98b0", "url": "https://github.com/firebase/firebase-android-sdk/commit/7941a347eced2aafc7adefdd655c3d0fbd0f98b0", "message": "Fixing method name", "committedDate": "2020-06-02T22:23:18Z", "type": "commit"}, {"oid": "882836eafedf66b95dafa99e89b07166643d0bfb", "url": "https://github.com/firebase/firebase-android-sdk/commit/882836eafedf66b95dafa99e89b07166643d0bfb", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk into ioExceptionFis", "committedDate": "2020-06-02T22:23:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc5MDIxOQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1609#discussion_r434790219", "bodyText": "extra quote?", "author": "ciarand", "createdAt": "2020-06-03T19:05:02Z", "path": "firebase-installations/src/main/java/com/google/firebase/installations/FirebaseInstallationsException.java", "diffHunk": "@@ -29,6 +29,12 @@\n      * Project.\n      */\n     BAD_CONFIG,\n+\n+    /**\n+     * The service is currently unavailable. This is a most likely due to a transient condition and\n+     * may be corrected by retrying. We recommend exponential backoff when retrying requests.\"", "originalCommit": "882836eafedf66b95dafa99e89b07166643d0bfb", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}