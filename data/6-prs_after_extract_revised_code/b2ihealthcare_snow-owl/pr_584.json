{"pr_number": 584, "pr_title": "SO-4100: Extra concept non-current member fix", "pr_createdAt": "2020-06-10T13:00:39Z", "pr_url": "https://github.com/b2ihealthcare/snow-owl/pull/584", "timeline": [{"oid": "3f89dafcc871fcd75f4ca5330533caddb0ea9077", "url": "https://github.com/b2ihealthcare/snow-owl/commit/3f89dafcc871fcd75f4ca5330533caddb0ea9077", "message": "SO-4100:Check if description already exists...\n\n...in Description Inactivation Indicator refset to not create duplicate\nmembers", "committedDate": "2020-06-10T12:32:30Z", "type": "commit"}, {"oid": "61003c8552676e12fe5690cdd31186ee27c83b4b", "url": "https://github.com/b2ihealthcare/snow-owl/commit/61003c8552676e12fe5690cdd31186ee27c83b4b", "message": "Merge remote-tracking branch 'origin/7.x' into SO-4100-extra-concept-non-current-member-fix", "committedDate": "2020-06-10T12:40:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQwODcyMQ==", "url": "https://github.com/b2ihealthcare/snow-owl/pull/584#discussion_r438408721", "bodyText": "Do we actually need all indicators when there is an inactivated Concept? This can be really costly.\nI suggest limiting the number of loaded indicators to the actually used set (descriptions of inactivated concepts and only active inactivation members).\nAlso, any duplicates that are present in the dataset will be omitted by the code, since this HashMap can only reference a single member by the referenced component, while a referenced component can have more than one indicator (active, inactive, potential duplicates).", "author": "cmark", "createdAt": "2020-06-10T21:06:49Z", "path": "snomed/com.b2international.snowowl.snomed.datastore/src/com/b2international/snowowl/snomed/datastore/index/change/ComponentInactivationChangeProcessor.java", "diffHunk": "@@ -83,6 +84,14 @@ public void process(StagingArea staging, RevisionSearcher searcher) throws IOExc\n \t\t\t\tchangedMembersByReferencedComponentId.put(((SnomedRefSetMemberIndexEntry) diff.newRevision).getReferencedComponentId(), diff);\n \t\t\t});\n \t\t\t\n+\t\t\tMap<String, SnomedRefSetMemberIndexEntry> refSetMembers = Maps.newHashMap();\n+\t\t\tfor (Hits<SnomedRefSetMemberIndexEntry> hits : searcher.scroll(Query.select(SnomedRefSetMemberIndexEntry.class) ", "originalCommit": "61003c8552676e12fe5690cdd31186ee27c83b4b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5d384670da16537549609426788b0b0db3b60da5", "chunk": "diff --git a/snomed/com.b2international.snowowl.snomed.datastore/src/com/b2international/snowowl/snomed/datastore/index/change/ComponentInactivationChangeProcessor.java b/snomed/com.b2international.snowowl.snomed.datastore/src/com/b2international/snowowl/snomed/datastore/index/change/ComponentInactivationChangeProcessor.java\nindex aa5b20f70f..aa272c9535 100644\n--- a/snomed/com.b2international.snowowl.snomed.datastore/src/com/b2international/snowowl/snomed/datastore/index/change/ComponentInactivationChangeProcessor.java\n+++ b/snomed/com.b2international.snowowl.snomed.datastore/src/com/b2international/snowowl/snomed/datastore/index/change/ComponentInactivationChangeProcessor.java\n\n@@ -84,7 +85,7 @@ final class ComponentInactivationChangeProcessor extends ChangeSetProcessorBase\n \t\t\t\tchangedMembersByReferencedComponentId.put(((SnomedRefSetMemberIndexEntry) diff.newRevision).getReferencedComponentId(), diff);\n \t\t\t});\n \t\t\t\n-\t\t\tMap<String, SnomedRefSetMemberIndexEntry> refSetMembers = Maps.newHashMap();\n+\t\t\tMultimap<String, SnomedRefSetMemberIndexEntry> refSetMembers = HashMultimap.create();\n \t\t\tfor (Hits<SnomedRefSetMemberIndexEntry> hits : searcher.scroll(Query.select(SnomedRefSetMemberIndexEntry.class) \n \t\t\t\t\t\t.from(SnomedRefSetMemberIndexEntry.class)\n \t\t\t\t\t\t.where(SnomedRefSetMemberIndexEntry.Expressions.referenceSetId(Concepts.REFSET_DESCRIPTION_INACTIVITY_INDICATOR))\n"}}, {"oid": "5d384670da16537549609426788b0b0db3b60da5", "url": "https://github.com/b2ihealthcare/snow-owl/commit/5d384670da16537549609426788b0b0db3b60da5", "message": "SO-4100: Use multimap for refSetMembers", "committedDate": "2020-06-11T12:20:02Z", "type": "commit"}, {"oid": "727ba5b062beb26b381e090a33545e0f1935c508", "url": "https://github.com/b2ihealthcare/snow-owl/commit/727ba5b062beb26b381e090a33545e0f1935c508", "message": "SO-4100: Filter for active members and members...\n\n...with Concept non-current inactivation indicator", "committedDate": "2020-06-11T12:29:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA3ODc0OQ==", "url": "https://github.com/b2ihealthcare/snow-owl/pull/584#discussion_r440078749", "bodyText": "Can we restrict the number loaded members to just the necessary set of members?\nHow about restricting to the actually read values, descriptions in the transaction?", "author": "cmark", "createdAt": "2020-06-15T10:25:20Z", "path": "snomed/com.b2international.snowowl.snomed.datastore/src/com/b2international/snowowl/snomed/datastore/index/change/ComponentInactivationChangeProcessor.java", "diffHunk": "@@ -83,6 +85,21 @@ public void process(StagingArea staging, RevisionSearcher searcher) throws IOExc\n \t\t\t\tchangedMembersByReferencedComponentId.put(((SnomedRefSetMemberIndexEntry) diff.newRevision).getReferencedComponentId(), diff);\n \t\t\t});\n \t\t\t\n+\t\t\tfinal ImmutableSet<String> valueIds = ImmutableSet.of(Concepts.CONCEPT_NON_CURRENT);\n+\t\t\tfinal Expression expression = Expressions.builder()\n+\t\t\t\t\t.filter(SnomedRefSetMemberIndexEntry.Expressions.referenceSetId(Concepts.REFSET_DESCRIPTION_INACTIVITY_INDICATOR))", "originalCommit": "727ba5b062beb26b381e090a33545e0f1935c508", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "27b145ec4ab29b6c850cc6068fefe600907e06a4", "chunk": "diff --git a/snomed/com.b2international.snowowl.snomed.datastore/src/com/b2international/snowowl/snomed/datastore/index/change/ComponentInactivationChangeProcessor.java b/snomed/com.b2international.snowowl.snomed.datastore/src/com/b2international/snowowl/snomed/datastore/index/change/ComponentInactivationChangeProcessor.java\nindex ea7dc65d0f..6082787d26 100644\n--- a/snomed/com.b2international.snowowl.snomed.datastore/src/com/b2international/snowowl/snomed/datastore/index/change/ComponentInactivationChangeProcessor.java\n+++ b/snomed/com.b2international.snowowl.snomed.datastore/src/com/b2international/snowowl/snomed/datastore/index/change/ComponentInactivationChangeProcessor.java\n\n@@ -86,10 +87,12 @@ final class ComponentInactivationChangeProcessor extends ChangeSetProcessorBase\n \t\t\t});\n \t\t\t\n \t\t\tfinal ImmutableSet<String> valueIds = ImmutableSet.of(Concepts.CONCEPT_NON_CURRENT);\n+\t\t\tfinal ImmutableSet<Short> descriptionTypeReferencedComponent = ImmutableSet.of(SnomedTerminologyComponentConstants.DESCRIPTION_NUMBER);\n \t\t\tfinal Expression expression = Expressions.builder()\n \t\t\t\t\t.filter(SnomedRefSetMemberIndexEntry.Expressions.referenceSetId(Concepts.REFSET_DESCRIPTION_INACTIVITY_INDICATOR))\n \t\t\t\t\t.filter(SnomedRefSetMemberIndexEntry.Expressions.active())\n \t\t\t\t\t.filter(SnomedRefSetMemberIndexEntry.Expressions.valueIds(valueIds))\n+\t\t\t\t\t.filter(SnomedRefSetMemberIndexEntry.Expressions.referencedComponentTypes(descriptionTypeReferencedComponent))\n \t\t\t\t\t.build();\n \t\t\t\n \t\t\tMultimap<String, SnomedRefSetMemberIndexEntry> refSetMembers = HashMultimap.create();\n"}}, {"oid": "27b145ec4ab29b6c850cc6068fefe600907e06a4", "url": "https://github.com/b2ihealthcare/snow-owl/commit/27b145ec4ab29b6c850cc6068fefe600907e06a4", "message": "SO-4100: Add filter for description type...\n\n...referenced component", "committedDate": "2020-06-15T13:02:39Z", "type": "commit"}, {"oid": "db5b9e282224603eef012d849cf5c90ff00cbd42", "url": "https://github.com/b2ihealthcare/snow-owl/commit/db5b9e282224603eef012d849cf5c90ff00cbd42", "message": "SO-4100: Remove filter", "committedDate": "2020-06-15T13:08:12Z", "type": "commit"}, {"oid": "328a632e15e3e88500c3b6d82c2b8b414f7c244d", "url": "https://github.com/b2ihealthcare/snow-owl/commit/328a632e15e3e88500c3b6d82c2b8b414f7c244d", "message": "SO-4100: Add filter by referencedComponentIds", "committedDate": "2020-06-16T07:36:04Z", "type": "commit"}, {"oid": "29b3d2c4ffc47fa9687a8265b49299269003c5ed", "url": "https://github.com/b2ihealthcare/snow-owl/commit/29b3d2c4ffc47fa9687a8265b49299269003c5ed", "message": "SO-4100: extract inactivation/reactivation test cases to another class", "committedDate": "2020-06-16T13:39:34Z", "type": "commit"}, {"oid": "0eef8c95397f2feb015a24da10d25e9a47ec542b", "url": "https://github.com/b2ihealthcare/snow-owl/commit/0eef8c95397f2feb015a24da10d25e9a47ec542b", "message": "SO-4100: add description status/indicator checks to inactivation tests", "committedDate": "2020-06-16T14:04:28Z", "type": "commit"}, {"oid": "fdbe58bee81b99bcf6c7a26bad5812c8560bd217", "url": "https://github.com/b2ihealthcare/snow-owl/commit/fdbe58bee81b99bcf6c7a26bad5812c8560bd217", "message": "SO-4100 #resolve", "committedDate": "2020-06-16T17:04:39Z", "type": "commit"}]}