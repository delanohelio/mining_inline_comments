{"pr_number": 690, "pr_title": "Configurable bulk commits", "pr_createdAt": "2020-10-11T10:44:40Z", "pr_url": "https://github.com/b2ihealthcare/snow-owl/pull/690", "timeline": [{"oid": "f6624b0846d3981ba2b7834c1c492915450723f3", "url": "https://github.com/b2ihealthcare/snow-owl/commit/f6624b0846d3981ba2b7834c1c492915450723f3", "message": "[index] make bulk commits configurable", "committedDate": "2020-10-11T10:40:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzEzNTM5OQ==", "url": "https://github.com/b2ihealthcare/snow-owl/pull/690#discussion_r503135399", "bodyText": "I'm wondering if we should go a under the posted limit, in case the final request size goes over 10 MB with some overhead not accounted for. \ud83e\udd14\nFor future reference: https://docs.aws.amazon.com/elasticsearch-service/latest/developerguide/aes-limits.html#network-limits", "author": "apeteri", "createdAt": "2020-10-12T08:45:55Z", "path": "commons/com.b2international.index/src/com/b2international/index/IndexClientFactory.java", "diffHunk": "@@ -158,6 +168,10 @@\n \t * The default cluster.name value for embedded nodes and tcp based clients.\n \t */\n \tString DEFAULT_CLUSTER_NAME = \"elastic-snowowl\";\n+\t\n+\tint DEFAULT_BULK_ACTIONS_SIZE = 10_000;\n+\t\t\t\n+\tint DEFAULT_BULK_ACTIONS_SIZE_IN_MB = 10;", "originalCommit": "f6624b0846d3981ba2b7834c1c492915450723f3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzIyMjM5Mw==", "url": "https://github.com/b2ihealthcare/snow-owl/pull/690#discussion_r503222393", "bodyText": "BulkProcessor should handle that well, I think.\nAlso, the smallest AWS ES instance limit is 10 MiB, which is 10.048576\u00a0MB.\nIf we limit ourselves to 10 MB by default, that should be less than the AWS 10 MiB limit.", "author": "cmark", "createdAt": "2020-10-12T11:13:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzEzNTM5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzIzMjkwNg==", "url": "https://github.com/b2ihealthcare/snow-owl/pull/690#discussion_r503232906", "bodyText": "After a quick discussion, we have decided to set the limit to 9 MB by default to allow a bit of headroom for other parts in the HTTP request.", "author": "cmark", "createdAt": "2020-10-12T11:33:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzEzNTM5OQ=="}], "type": "inlineReview", "revised_code": {"commit": "6f183b7ce9f10020c558e9d34800abdce6815ac8", "chunk": "diff --git a/commons/com.b2international.index/src/com/b2international/index/IndexClientFactory.java b/commons/com.b2international.index/src/com/b2international/index/IndexClientFactory.java\nindex 841d67459d..56630a11e8 100644\n--- a/commons/com.b2international.index/src/com/b2international/index/IndexClientFactory.java\n+++ b/commons/com.b2international.index/src/com/b2international/index/IndexClientFactory.java\n\n@@ -169,9 +169,15 @@ public interface IndexClientFactory {\n \t */\n \tString DEFAULT_CLUSTER_NAME = \"elastic-snowowl\";\n \t\n+\t/**\n+\t * Default number of bulk action items to send in a single outgoing bulk request.\n+\t */\n \tint DEFAULT_BULK_ACTIONS_SIZE = 10_000;\n-\t\t\t\n-\tint DEFAULT_BULK_ACTIONS_SIZE_IN_MB = 10;\n+\t\n+\t/**\n+\t * Default size in megabytes to limit all outgoing bulk requests.\n+\t */\n+\tint DEFAULT_BULK_ACTIONS_SIZE_IN_MB = 9;\n \n \t/**\n \t * Create a new {@link IndexClient} with the given name.\n"}}, {"oid": "6f183b7ce9f10020c558e9d34800abdce6815ac8", "url": "https://github.com/b2ihealthcare/snow-owl/commit/6f183b7ce9f10020c558e9d34800abdce6815ac8", "message": "[index] set default outgoing bulk size to 9 MB", "committedDate": "2020-10-12T11:37:37Z", "type": "commit"}]}