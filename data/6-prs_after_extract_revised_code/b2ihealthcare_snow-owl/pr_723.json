{"pr_number": 723, "pr_title": "Fix default doc sorting issues", "pr_createdAt": "2020-11-27T13:58:09Z", "pr_url": "https://github.com/b2ihealthcare/snow-owl/pull/723", "timeline": [{"oid": "2249b3c0ed9d3c14520613681719e010d6a49c3b", "url": "https://github.com/b2ihealthcare/snow-owl/commit/2249b3c0ed9d3c14520613681719e010d6a49c3b", "message": "[index] fix _doc sorting issues\n\nUsing _doc is only allowed when using ES scroll paging API.\nFor searchAfter based paging and standard searches we will fall back to\nthe current ID field configured in the mapping or if none found to the\n_id which is deprecated in ES 7.x and will be removed from Snow Owl as\nsoon as Elasticsearch removes it (probably in 8.0).", "committedDate": "2020-11-27T13:53:44Z", "type": "commit"}, {"oid": "bbd24973e04eb3a84fe521511fc97bba6c4c39cb", "url": "https://github.com/b2ihealthcare/snow-owl/commit/bbd24973e04eb3a84fe521511fc97bba6c4c39cb", "message": "[core] where possible use the ID annotation instead of relying to _id", "committedDate": "2020-11-27T13:55:02Z", "type": "commit"}, {"oid": "115153c77c045a897e204c5e6033583c20987774", "url": "https://github.com/b2ihealthcare/snow-owl/commit/115153c77c045a897e204c5e6033583c20987774", "message": "[index] add ID annotation to all documents that can support it\n\nReport any other mapping that does not define its own ID field.", "committedDate": "2020-11-27T14:16:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTY0MDg0OQ==", "url": "https://github.com/b2ihealthcare/snow-owl/pull/723#discussion_r531640849", "bodyText": "Please add the fall-through marker back; it is hard to spot the absence of a break statement, sometimes even with the comment present \ud83d\ude04\ud83d\udc53", "author": "apeteri", "createdAt": "2020-11-27T14:44:48Z", "path": "commons/com.b2international.index/src/com/b2international/index/es/EsDocumentSearcher.java", "diffHunk": "@@ -397,8 +396,14 @@ private void addSort(DocumentMapping mapping, SearchSourceBuilder reqSource, Sor\n \t\t\t\t\t// XXX: default order for scores is *descending*\n \t\t\t\t\treqSource.sort(SortBuilders.scoreSort().order(sortOrder)); \n \t\t\t\t\tbreak;\n-\t\t\t\tcase DocumentMapping._DOC: //$FALL-THROUGH$\n-\t\t\t\t\tfield = DocumentMapping._DOC;\n+\t\t\t\tcase \"_default\":", "originalCommit": "115153c77c045a897e204c5e6033583c20987774", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "31a8d7e3593cd7e5d46c4d52a21f5447ef24f412", "chunk": "diff --git a/commons/com.b2international.index/src/com/b2international/index/es/EsDocumentSearcher.java b/commons/com.b2international.index/src/com/b2international/index/es/EsDocumentSearcher.java\nindex 92910d7585..e3b81f5392 100644\n--- a/commons/com.b2international.index/src/com/b2international/index/es/EsDocumentSearcher.java\n+++ b/commons/com.b2international.index/src/com/b2international/index/es/EsDocumentSearcher.java\n\n@@ -396,7 +396,7 @@ public class EsDocumentSearcher implements Searcher {\n \t\t\t\t\t// XXX: default order for scores is *descending*\n \t\t\t\t\treqSource.sort(SortBuilders.scoreSort().order(sortOrder)); \n \t\t\t\t\tbreak;\n-\t\t\t\tcase \"_default\":\n+\t\t\t\tcase \"_default\": //$FALL-THROUGH$\n \t\t\t\t\tif (liveScroll) {\n \t\t\t\t\t\t// for live scrolls use the document ID field as tiebreaker\n \t\t\t\t\t\tfield = mapping.getIdField();\n"}}, {"oid": "31a8d7e3593cd7e5d46c4d52a21f5447ef24f412", "url": "https://github.com/b2ihealthcare/snow-owl/commit/31a8d7e3593cd7e5d46c4d52a21f5447ef24f412", "message": "[index] add back //$FALL-THROUGH$ marker", "committedDate": "2020-11-27T15:03:39Z", "type": "commit"}]}