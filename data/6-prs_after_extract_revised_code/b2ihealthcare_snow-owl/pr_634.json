{"pr_number": 634, "pr_title": "SO-4202: fix merge performance issue when merging huge amount of changes into a branch", "pr_createdAt": "2020-08-11T20:19:25Z", "pr_url": "https://github.com/b2ihealthcare/snow-owl/pull/634", "timeline": [{"oid": "c772dadab2bf95a3c9e1f5332e7aa5952ad635df", "url": "https://github.com/b2ihealthcare/snow-owl/commit/c772dadab2bf95a3c9e1f5332e7aa5952ad635df", "message": "SO-4202: load commits in batches of 20 to reduce memory constraint...\n\n...when comparing changes between to branches with large result sets", "committedDate": "2020-08-06T16:27:55Z", "type": "commit"}, {"oid": "08cdb4d51648bdfe17eee038b051224b8f722ba4", "url": "https://github.com/b2ihealthcare/snow-owl/commit/08cdb4d51648bdfe17eee038b051224b8f722ba4", "message": "SO-4202: replace String.format with String.join...\n\n...in ObjectId and RevisionCompareDetail to improve performance of\ncompare and merge processes.", "committedDate": "2020-08-06T16:28:42Z", "type": "commit"}, {"oid": "6ffe6b83545d8315b6cb6865514981aca538f087", "url": "https://github.com/b2ihealthcare/snow-owl/commit/6ffe6b83545d8315b6cb6865514981aca538f087", "message": "SO-4202: unrelated String.format replacements, cleanups", "committedDate": "2020-08-06T19:30:22Z", "type": "commit"}, {"oid": "b2b8e5e2de9977240c1a87c222f75e1fe01405be", "url": "https://github.com/b2ihealthcare/snow-owl/commit/b2b8e5e2de9977240c1a87c222f75e1fe01405be", "message": "Merge remote-tracking branch 'origin/7.x' into issue/SO-4202-merge_performance_issue", "committedDate": "2020-08-11T17:41:00Z", "type": "commit"}, {"oid": "7b41cdc8dd81e236afff1c1938625c74dbf68ec9", "url": "https://github.com/b2ihealthcare/snow-owl/commit/7b41cdc8dd81e236afff1c1938625c74dbf68ec9", "message": "SO-4202 #resolve\n\nFix merge performance issue when merging huge amount of changes from a\nbranch into another (speed up conflict detection).", "committedDate": "2020-08-11T20:18:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA4MDA4MA==", "url": "https://github.com/b2ihealthcare/snow-owl/pull/634#discussion_r469080080", "bodyText": "This is now a separator, not a String template. Please rename the constant", "author": "apeteri", "createdAt": "2020-08-12T08:06:02Z", "path": "commons/com.b2international.index/src/com/b2international/index/revision/RevisionCompareDetail.java", "diffHunk": "@@ -27,6 +27,8 @@\n  */\n public final class RevisionCompareDetail {\n \n+\tprivate static final String PROPERTY_CHANGE_KEY_TEMPLATE = \"_\";", "originalCommit": "7b41cdc8dd81e236afff1c1938625c74dbf68ec9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "212d20a9563fb8d19c94b5225efe4f7c378d3325", "chunk": "diff --git a/commons/com.b2international.index/src/com/b2international/index/revision/RevisionCompareDetail.java b/commons/com.b2international.index/src/com/b2international/index/revision/RevisionCompareDetail.java\nindex b2b76fb964..8dd18dfe23 100644\n--- a/commons/com.b2international.index/src/com/b2international/index/revision/RevisionCompareDetail.java\n+++ b/commons/com.b2international.index/src/com/b2international/index/revision/RevisionCompareDetail.java\n\n@@ -27,7 +27,7 @@ import com.google.common.base.Strings;\n  */\n public final class RevisionCompareDetail {\n \n-\tprivate static final String PROPERTY_CHANGE_KEY_TEMPLATE = \"_\";\n+\tprivate static final String PROPERTY_CHANGE_KEY_SEPARATOR = \"_\";\n \t\n \t// commit details\n \tprivate final String author;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA4MDc5OA==", "url": "https://github.com/b2ihealthcare/snow-owl/pull/634#discussion_r469080798", "bodyText": "The property also has a @JsonIgnore annotation.", "author": "apeteri", "createdAt": "2020-08-12T08:07:30Z", "path": "commons/com.b2international.index/src/com/b2international/index/revision/RevisionCompareDetail.java", "diffHunk": "@@ -40,6 +42,9 @@\n \tprivate final String fromValue;\n \tprivate final String value;\n \t\n+\t@JsonIgnore", "originalCommit": "7b41cdc8dd81e236afff1c1938625c74dbf68ec9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA5MjUzOA==", "url": "https://github.com/b2ihealthcare/snow-owl/pull/634#discussion_r469092538", "bodyText": "It no longer seems to be necessary to consume Map entries here \ud83e\udd14 We're not doing anything with any leftover entries in sourcePropertyChanges (or indirectly via sourcePropertyChangesByObject).", "author": "apeteri", "createdAt": "2020-08-12T08:26:50Z", "path": "commons/com.b2international.index/src/com/b2international/index/revision/StagingArea.java", "diffHunk": "@@ -673,43 +673,41 @@ void merge(RevisionBranchRef fromRef, RevisionBranchRef toRef, boolean squash, R\n \t\t\t// then handle changed vs. changed with the conflict processor\n \t\t\tSet<String> changedInSourceAndTargetIds = Sets.intersection(changedRevisionIdsToMerge, changedRevisionIdsToCheck);\n \t\t\tif (!changedInSourceAndTargetIds.isEmpty()) {\n+\t\t\t\tfinal Map<String, Map<String, RevisionCompareDetail>> sourcePropertyChangesByObject = indexPropertyChangesByObject(fromChangeDetails);\n+\t\t\t\tfinal Map<String, Map<String, RevisionCompareDetail>> targetPropertyChangesByObject = indexPropertyChangesByObject(toChangeDetails);\n \t\t\t\tfor (String changedInSourceAndTargetId : changedInSourceAndTargetIds) {\n-\t\t\t\t\tMap<String, RevisionCompareDetail> sourcePropertyChanges = fromChangeDetails.stream()\n-\t\t\t\t\t\t\t.filter(detail -> detail.getObject().id().equals(changedInSourceAndTargetId))\n-\t\t\t\t\t\t\t.filter(detail -> !detail.isComponentChange())\n-\t\t\t\t\t\t\t.collect(Collectors.toMap(RevisionCompareDetail::getProperty, d -> d));\n-\t\t\t\t\tMap<String, RevisionCompareDetail> targetPropertyChanges = toChangeDetails.stream()\n-\t\t\t\t\t\t\t.filter(detail -> detail.getObject().id().equals(changedInSourceAndTargetId))\n-\t\t\t\t\t\t\t.filter(detail -> !detail.isComponentChange())\n-\t\t\t\t\t\t\t.collect(Collectors.toMap(RevisionCompareDetail::getProperty, d -> d));\n+\t\t\t\t\tfinal Map<String, RevisionCompareDetail> sourcePropertyChanges = sourcePropertyChangesByObject.get(changedInSourceAndTargetId);\n+\t\t\t\t\tfinal Map<String, RevisionCompareDetail> targetPropertyChanges = targetPropertyChangesByObject.get(changedInSourceAndTargetId);\n \t\t\t\t\t\n-\t\t\t\t\tfor (Entry<String, RevisionCompareDetail> sourceChange : Iterables.consumingIterable(sourcePropertyChanges.entrySet())) {\n-\t\t\t\t\t\tfinal RevisionPropertyDiff sourceChangeDiff = new RevisionPropertyDiff(sourceChange.getValue().getProperty(), sourceChange.getValue().getFromValue(), sourceChange.getValue().getValue());\n-\t\t\t\t\t\tfinal RevisionCompareDetail targetPropertyChange = targetPropertyChanges.remove(sourceChange.getKey());\n-\t\t\t\t\t\tif (targetPropertyChange == null) {\n-\t\t\t\t\t\t\t// this property did not change in target, just apply directly on the target object via\n-\t\t\t\t\t\t\tif (!propertyUpdatesToApply.containsKey(type)) {\n-\t\t\t\t\t\t\t\tpropertyUpdatesToApply.put(type, HashMultimap.create());\n-\t\t\t\t\t\t\t}\n-\t\t\t\t\t\t\tpropertyUpdatesToApply.get(type).put(changedInSourceAndTargetId, sourceChangeDiff);\n-\t\t\t\t\t\t\tfromChangeSet.removeChanged(type, changedInSourceAndTargetId);\n-\t\t\t\t\t\t} else {\n-\t\t\t\t\t\t\tRevisionPropertyDiff targetChangeDiff = new RevisionPropertyDiff(targetPropertyChange.getProperty(), targetPropertyChange.getFromValue(), targetPropertyChange.getValue());\n-\t\t\t\t\t\t\t// changed on both sides, ask conflict processor to resolve the issue or raise conflict error\n-\t\t\t\t\t\t\tRevisionPropertyDiff resolution = conflictProcessor.handleChangedInSourceAndTarget(\n-\t\t\t\t\t\t\t\tchangedInSourceAndTargetId, \n-\t\t\t\t\t\t\t\tsourceChangeDiff,\n-\t\t\t\t\t\t\t\ttargetChangeDiff\n-\t\t\t\t\t\t\t);\n-\t\t\t\t\t\t\tif (resolution == null) {\n-\t\t\t\t\t\t\t\tconflicts.add(new ChangedInSourceAndTargetConflict(sourceChange.getValue().getObject(), sourceChangeDiff.convert(conflictProcessor), targetChangeDiff.convert(conflictProcessor)));\n-\t\t\t\t\t\t\t} else {\n+\t\t\t\t\tif (sourcePropertyChanges != null) {\n+\t\t\t\t\t\tfor (Entry<String, RevisionCompareDetail> sourceChange : Iterables.consumingIterable(sourcePropertyChanges.entrySet())) {", "originalCommit": "7b41cdc8dd81e236afff1c1938625c74dbf68ec9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "eec619581107d6fc8947cecbc5521a70100ae4c0", "chunk": "diff --git a/commons/com.b2international.index/src/com/b2international/index/revision/StagingArea.java b/commons/com.b2international.index/src/com/b2international/index/revision/StagingArea.java\nindex 7caebf7255..46656df605 100644\n--- a/commons/com.b2international.index/src/com/b2international/index/revision/StagingArea.java\n+++ b/commons/com.b2international.index/src/com/b2international/index/revision/StagingArea.java\n\n@@ -676,13 +676,18 @@ public final class StagingArea {\n \t\t\t\tfinal Map<String, Map<String, RevisionCompareDetail>> sourcePropertyChangesByObject = indexPropertyChangesByObject(fromChangeDetails);\n \t\t\t\tfinal Map<String, Map<String, RevisionCompareDetail>> targetPropertyChangesByObject = indexPropertyChangesByObject(toChangeDetails);\n \t\t\t\tfor (String changedInSourceAndTargetId : changedInSourceAndTargetIds) {\n-\t\t\t\t\tfinal Map<String, RevisionCompareDetail> sourcePropertyChanges = sourcePropertyChangesByObject.get(changedInSourceAndTargetId);\n-\t\t\t\t\tfinal Map<String, RevisionCompareDetail> targetPropertyChanges = targetPropertyChangesByObject.get(changedInSourceAndTargetId);\n+\t\t\t\t\t// take the prop changes from both paths\n+\t\t\t\t\tfinal Map<String, RevisionCompareDetail> sourcePropertyChanges = sourcePropertyChangesByObject.remove(changedInSourceAndTargetId);\n+\t\t\t\t\tfinal Map<String, RevisionCompareDetail> targetPropertyChanges = targetPropertyChangesByObject.remove(changedInSourceAndTargetId);\n \t\t\t\t\t\n \t\t\t\t\tif (sourcePropertyChanges != null) {\n-\t\t\t\t\t\tfor (Entry<String, RevisionCompareDetail> sourceChange : Iterables.consumingIterable(sourcePropertyChanges.entrySet())) {\n-\t\t\t\t\t\t\tfinal RevisionPropertyDiff sourceChangeDiff = new RevisionPropertyDiff(sourceChange.getValue().getProperty(), sourceChange.getValue().getFromValue(), sourceChange.getValue().getValue());\n-\t\t\t\t\t\t\tfinal RevisionCompareDetail targetPropertyChange = targetPropertyChanges.remove(sourceChange.getKey());\n+\t\t\t\t\t\tfor (Entry<String, RevisionCompareDetail> sourceChange : sourcePropertyChanges.entrySet()) {\n+\t\t\t\t\t\t\tfinal String changedProperty = sourceChange.getKey();\n+\t\t\t\t\t\t\tfinal RevisionCompareDetail sourcePropertyChange = sourceChange.getValue();\n+\t\t\t\t\t\t\t\n+\t\t\t\t\t\t\tfinal RevisionPropertyDiff sourceChangeDiff = new RevisionPropertyDiff(changedProperty, sourcePropertyChange.getFromValue(), sourcePropertyChange.getValue());\n+\t\t\t\t\t\t\tfinal RevisionCompareDetail targetPropertyChange = targetPropertyChanges.get(changedProperty);\n+\t\t\t\t\t\t\t\n \t\t\t\t\t\t\tif (targetPropertyChange == null) {\n \t\t\t\t\t\t\t\t// this property did not change in target, just apply directly on the target object via\n \t\t\t\t\t\t\t\tif (!propertyUpdatesToApply.containsKey(type)) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA5NDE0Mg==", "url": "https://github.com/b2ihealthcare/snow-owl/pull/634#discussion_r469094142", "bodyText": "Same here.", "author": "apeteri", "createdAt": "2020-08-12T08:29:39Z", "path": "commons/com.b2international.index/src/com/b2international/index/revision/StagingArea.java", "diffHunk": "@@ -673,43 +673,41 @@ void merge(RevisionBranchRef fromRef, RevisionBranchRef toRef, boolean squash, R\n \t\t\t// then handle changed vs. changed with the conflict processor\n \t\t\tSet<String> changedInSourceAndTargetIds = Sets.intersection(changedRevisionIdsToMerge, changedRevisionIdsToCheck);\n \t\t\tif (!changedInSourceAndTargetIds.isEmpty()) {\n+\t\t\t\tfinal Map<String, Map<String, RevisionCompareDetail>> sourcePropertyChangesByObject = indexPropertyChangesByObject(fromChangeDetails);\n+\t\t\t\tfinal Map<String, Map<String, RevisionCompareDetail>> targetPropertyChangesByObject = indexPropertyChangesByObject(toChangeDetails);\n \t\t\t\tfor (String changedInSourceAndTargetId : changedInSourceAndTargetIds) {\n-\t\t\t\t\tMap<String, RevisionCompareDetail> sourcePropertyChanges = fromChangeDetails.stream()\n-\t\t\t\t\t\t\t.filter(detail -> detail.getObject().id().equals(changedInSourceAndTargetId))\n-\t\t\t\t\t\t\t.filter(detail -> !detail.isComponentChange())\n-\t\t\t\t\t\t\t.collect(Collectors.toMap(RevisionCompareDetail::getProperty, d -> d));\n-\t\t\t\t\tMap<String, RevisionCompareDetail> targetPropertyChanges = toChangeDetails.stream()\n-\t\t\t\t\t\t\t.filter(detail -> detail.getObject().id().equals(changedInSourceAndTargetId))\n-\t\t\t\t\t\t\t.filter(detail -> !detail.isComponentChange())\n-\t\t\t\t\t\t\t.collect(Collectors.toMap(RevisionCompareDetail::getProperty, d -> d));\n+\t\t\t\t\tfinal Map<String, RevisionCompareDetail> sourcePropertyChanges = sourcePropertyChangesByObject.get(changedInSourceAndTargetId);\n+\t\t\t\t\tfinal Map<String, RevisionCompareDetail> targetPropertyChanges = targetPropertyChangesByObject.get(changedInSourceAndTargetId);\n \t\t\t\t\t\n-\t\t\t\t\tfor (Entry<String, RevisionCompareDetail> sourceChange : Iterables.consumingIterable(sourcePropertyChanges.entrySet())) {\n-\t\t\t\t\t\tfinal RevisionPropertyDiff sourceChangeDiff = new RevisionPropertyDiff(sourceChange.getValue().getProperty(), sourceChange.getValue().getFromValue(), sourceChange.getValue().getValue());\n-\t\t\t\t\t\tfinal RevisionCompareDetail targetPropertyChange = targetPropertyChanges.remove(sourceChange.getKey());\n-\t\t\t\t\t\tif (targetPropertyChange == null) {\n-\t\t\t\t\t\t\t// this property did not change in target, just apply directly on the target object via\n-\t\t\t\t\t\t\tif (!propertyUpdatesToApply.containsKey(type)) {\n-\t\t\t\t\t\t\t\tpropertyUpdatesToApply.put(type, HashMultimap.create());\n-\t\t\t\t\t\t\t}\n-\t\t\t\t\t\t\tpropertyUpdatesToApply.get(type).put(changedInSourceAndTargetId, sourceChangeDiff);\n-\t\t\t\t\t\t\tfromChangeSet.removeChanged(type, changedInSourceAndTargetId);\n-\t\t\t\t\t\t} else {\n-\t\t\t\t\t\t\tRevisionPropertyDiff targetChangeDiff = new RevisionPropertyDiff(targetPropertyChange.getProperty(), targetPropertyChange.getFromValue(), targetPropertyChange.getValue());\n-\t\t\t\t\t\t\t// changed on both sides, ask conflict processor to resolve the issue or raise conflict error\n-\t\t\t\t\t\t\tRevisionPropertyDiff resolution = conflictProcessor.handleChangedInSourceAndTarget(\n-\t\t\t\t\t\t\t\tchangedInSourceAndTargetId, \n-\t\t\t\t\t\t\t\tsourceChangeDiff,\n-\t\t\t\t\t\t\t\ttargetChangeDiff\n-\t\t\t\t\t\t\t);\n-\t\t\t\t\t\t\tif (resolution == null) {\n-\t\t\t\t\t\t\t\tconflicts.add(new ChangedInSourceAndTargetConflict(sourceChange.getValue().getObject(), sourceChangeDiff.convert(conflictProcessor), targetChangeDiff.convert(conflictProcessor)));\n-\t\t\t\t\t\t\t} else {\n+\t\t\t\t\tif (sourcePropertyChanges != null) {\n+\t\t\t\t\t\tfor (Entry<String, RevisionCompareDetail> sourceChange : Iterables.consumingIterable(sourcePropertyChanges.entrySet())) {\n+\t\t\t\t\t\t\tfinal RevisionPropertyDiff sourceChangeDiff = new RevisionPropertyDiff(sourceChange.getValue().getProperty(), sourceChange.getValue().getFromValue(), sourceChange.getValue().getValue());\n+\t\t\t\t\t\t\tfinal RevisionCompareDetail targetPropertyChange = targetPropertyChanges.remove(sourceChange.getKey());", "originalCommit": "7b41cdc8dd81e236afff1c1938625c74dbf68ec9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "eec619581107d6fc8947cecbc5521a70100ae4c0", "chunk": "diff --git a/commons/com.b2international.index/src/com/b2international/index/revision/StagingArea.java b/commons/com.b2international.index/src/com/b2international/index/revision/StagingArea.java\nindex 7caebf7255..46656df605 100644\n--- a/commons/com.b2international.index/src/com/b2international/index/revision/StagingArea.java\n+++ b/commons/com.b2international.index/src/com/b2international/index/revision/StagingArea.java\n\n@@ -676,13 +676,18 @@ public final class StagingArea {\n \t\t\t\tfinal Map<String, Map<String, RevisionCompareDetail>> sourcePropertyChangesByObject = indexPropertyChangesByObject(fromChangeDetails);\n \t\t\t\tfinal Map<String, Map<String, RevisionCompareDetail>> targetPropertyChangesByObject = indexPropertyChangesByObject(toChangeDetails);\n \t\t\t\tfor (String changedInSourceAndTargetId : changedInSourceAndTargetIds) {\n-\t\t\t\t\tfinal Map<String, RevisionCompareDetail> sourcePropertyChanges = sourcePropertyChangesByObject.get(changedInSourceAndTargetId);\n-\t\t\t\t\tfinal Map<String, RevisionCompareDetail> targetPropertyChanges = targetPropertyChangesByObject.get(changedInSourceAndTargetId);\n+\t\t\t\t\t// take the prop changes from both paths\n+\t\t\t\t\tfinal Map<String, RevisionCompareDetail> sourcePropertyChanges = sourcePropertyChangesByObject.remove(changedInSourceAndTargetId);\n+\t\t\t\t\tfinal Map<String, RevisionCompareDetail> targetPropertyChanges = targetPropertyChangesByObject.remove(changedInSourceAndTargetId);\n \t\t\t\t\t\n \t\t\t\t\tif (sourcePropertyChanges != null) {\n-\t\t\t\t\t\tfor (Entry<String, RevisionCompareDetail> sourceChange : Iterables.consumingIterable(sourcePropertyChanges.entrySet())) {\n-\t\t\t\t\t\t\tfinal RevisionPropertyDiff sourceChangeDiff = new RevisionPropertyDiff(sourceChange.getValue().getProperty(), sourceChange.getValue().getFromValue(), sourceChange.getValue().getValue());\n-\t\t\t\t\t\t\tfinal RevisionCompareDetail targetPropertyChange = targetPropertyChanges.remove(sourceChange.getKey());\n+\t\t\t\t\t\tfor (Entry<String, RevisionCompareDetail> sourceChange : sourcePropertyChanges.entrySet()) {\n+\t\t\t\t\t\t\tfinal String changedProperty = sourceChange.getKey();\n+\t\t\t\t\t\t\tfinal RevisionCompareDetail sourcePropertyChange = sourceChange.getValue();\n+\t\t\t\t\t\t\t\n+\t\t\t\t\t\t\tfinal RevisionPropertyDiff sourceChangeDiff = new RevisionPropertyDiff(changedProperty, sourcePropertyChange.getFromValue(), sourcePropertyChange.getValue());\n+\t\t\t\t\t\t\tfinal RevisionCompareDetail targetPropertyChange = targetPropertyChanges.get(changedProperty);\n+\t\t\t\t\t\t\t\n \t\t\t\t\t\t\tif (targetPropertyChange == null) {\n \t\t\t\t\t\t\t\t// this property did not change in target, just apply directly on the target object via\n \t\t\t\t\t\t\t\tif (!propertyUpdatesToApply.containsKey(type)) {\n"}}, {"oid": "eec619581107d6fc8947cecbc5521a70100ae4c0", "url": "https://github.com/b2ihealthcare/snow-owl/commit/eec619581107d6fc8947cecbc5521a70100ae4c0", "message": "SO-4202: make property conflict detection algorithm more readable\n\nRemove source,target prop change Maps from byObject Map before checking\nfor conflicts to slowly release allocated memory.", "committedDate": "2020-08-12T08:58:06Z", "type": "commit"}, {"oid": "212d20a9563fb8d19c94b5225efe4f7c378d3325", "url": "https://github.com/b2ihealthcare/snow-owl/commit/212d20a9563fb8d19c94b5225efe4f7c378d3325", "message": "SO-4202: rename constant to SEPARATOR", "committedDate": "2020-08-12T08:58:43Z", "type": "commit"}, {"oid": "a98d2de53b7149d7c8867a39120c4f2f2dd2dd4d", "url": "https://github.com/b2ihealthcare/snow-owl/commit/a98d2de53b7149d7c8867a39120c4f2f2dd2dd4d", "message": "SO-4202: use `String.join()` in RevisionIndex.toRevisionRange", "committedDate": "2020-08-12T09:03:36Z", "type": "commit"}]}