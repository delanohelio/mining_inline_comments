{"pr_number": 637, "pr_title": "SO-4219: Comparing large sets times out", "pr_createdAt": "2020-08-14T13:16:44Z", "pr_url": "https://github.com/b2ihealthcare/snow-owl/pull/637", "timeline": [{"oid": "ccc55ea4032c8cd6991ccb38da42c6de1e580889", "url": "https://github.com/b2ihealthcare/snow-owl/commit/ccc55ea4032c8cd6991ccb38da42c6de1e580889", "message": "SO-4219: enhance performance of creating mappings from reference sets", "committedDate": "2020-08-14T13:12:44Z", "type": "commit"}, {"oid": "125e3ba71e5982972f566a74677bd62ce721c437", "url": "https://github.com/b2ihealthcare/snow-owl/commit/125e3ba71e5982972f566a74677bd62ce721c437", "message": "SO-4219: change compare logic for better performance", "committedDate": "2020-08-14T13:14:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDk2NjYzMA==", "url": "https://github.com/b2ihealthcare/snow-owl/pull/637#discussion_r470966630", "bodyText": "Missing all() or explicit setLimit call.", "author": "cmark", "createdAt": "2020-08-15T11:11:02Z", "path": "snomed/com.b2international.snowowl.snomed.datastore/src/com/b2international/snowowl/snomed/datastore/request/SnomedConceptMapSearchRequestEvaluator.java", "diffHunk": "@@ -61,36 +62,41 @@\n \t@Override\n \tpublic ConceptMapMappings evaluate(CodeSystemURI uri, BranchContext context, Options search) {\n \t\tSnomedReferenceSetMembers referenceSetMembers = fetchRefsetMembers(uri, context, search);\n-\t\treturn toCollectionResource(referenceSetMembers, uri, context);\n+\t\treturn toCollectionResource(referenceSetMembers, uri, context, search);\n \t}\n \n-\tprivate ConceptMapMappings toCollectionResource(SnomedReferenceSetMembers referenceSetMembers, CodeSystemURI uri, BranchContext context) {\n+\tprivate ConceptMapMappings toCollectionResource(SnomedReferenceSetMembers referenceSetMembers, CodeSystemURI uri, BranchContext context, Options search) {\n+\t\tMap<String, ComponentURI> targetComponentMap = getTargetComponentMap(context, search);\n \t\tList<ConceptMapMapping> mappings = referenceSetMembers.stream()\n \t\t\t\t.filter(m -> SnomedTerminologyComponentConstants.CONCEPT_NUMBER == m.getReferencedComponent().getTerminologyComponentId())\n-\t\t\t\t.map(m -> toMapping(m, uri, getTargetComponentURI(context, m.getReferenceSetId())))\n+\t\t\t\t.map(m -> {\n+\t\t\t\t\treturn toMapping(m, uri, targetComponentMap.get(m.getReferenceSetId()));\n+\t\t\t\t})\n \t\t\t\t.collect(Collectors.toList());\n \t\t\n \t\tif (!mappings.isEmpty()) {\n-\t\t\tSet<String> targetComponentURIs = mappings.stream().map(ConceptMapMapping::getTargetComponentURI).map(ComponentURI::identifier).collect(Collectors.toSet());\n-\t\t\t\n-\t\t\tMap<String, Concept> mapTargetsById = CodeSystemRequests.prepareSearchConcepts()\n-\t\t\t\t.filterByIds(targetComponentURIs)\n-\t\t\t\t.build(mappings.stream().findFirst().get().getTargetComponentURI().codeSystemUri())\n-\t\t\t\t.execute(context.service(IEventBus.class))\n-\t\t\t\t.getSync(5, TimeUnit.MINUTES)\n-\t\t\t\t.stream()\n-\t\t\t\t.collect(Collectors.toMap(Concept::getId, c -> c));\n-\t\t\t\n-\t\t\tmappings = mappings.stream().map(mapping -> {\n-\t\t\t\tfinal String mapTarget = mapping.getTargetComponentURI().identifier();\n-\t\t\t\tif (mapTargetsById.containsKey(mapTarget)) {\n-\t\t\t\t\treturn mapping.toBuilder()\n-\t\t\t\t\t\t.targetTerm(mapTargetsById.get(mapTarget).getTerm())\n-\t\t\t\t\t\t.build();\n-\t\t\t\t} else {\n-\t\t\t\t\treturn mapping;\n-\t\t\t\t}\n-\t\t\t}).collect(Collectors.toList());\n+\t\t\tSet<String> targetIds = mappings.stream().map(ConceptMapMapping::getTargetComponentURI).map(ComponentURI::identifier).collect(Collectors.toSet());\n+\t\t\tString codeSystem = mappings.stream().findFirst().get().getTargetComponentURI().codeSystem();\n+\n+\t\t\tif (!ComponentURI.UNSPECIFIED.codeSystem().equals(codeSystem)) {\n+\t\t\t\tMap<String, Concept> mapTargetsById = CodeSystemRequests.prepareSearchConcepts()\n+\t\t\t\t\t\t.filterByIds(targetIds)", "originalCommit": "125e3ba71e5982972f566a74677bd62ce721c437", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTI1MTk1Mw==", "url": "https://github.com/b2ihealthcare/snow-owl/pull/637#discussion_r471251953", "bodyText": "Done", "author": "molnarlaura", "createdAt": "2020-08-17T06:15:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDk2NjYzMA=="}], "type": "inlineReview", "revised_code": {"commit": "8b5bc23faa91b861e6fad569ce40c853e3908371", "chunk": "diff --git a/snomed/com.b2international.snowowl.snomed.datastore/src/com/b2international/snowowl/snomed/datastore/request/SnomedConceptMapSearchRequestEvaluator.java b/snomed/com.b2international.snowowl.snomed.datastore/src/com/b2international/snowowl/snomed/datastore/request/SnomedConceptMapSearchRequestEvaluator.java\nindex ff9900d27d..e7a8065457 100644\n--- a/snomed/com.b2international.snowowl.snomed.datastore/src/com/b2international/snowowl/snomed/datastore/request/SnomedConceptMapSearchRequestEvaluator.java\n+++ b/snomed/com.b2international.snowowl.snomed.datastore/src/com/b2international/snowowl/snomed/datastore/request/SnomedConceptMapSearchRequestEvaluator.java\n\n@@ -81,6 +81,7 @@ public final class SnomedConceptMapSearchRequestEvaluator implements ConceptMapM\n \t\t\tif (!ComponentURI.UNSPECIFIED.codeSystem().equals(codeSystem)) {\n \t\t\t\tMap<String, Concept> mapTargetsById = CodeSystemRequests.prepareSearchConcepts()\n \t\t\t\t\t\t.filterByIds(targetIds)\n+\t\t\t\t\t\t.all()\n \t\t\t\t\t\t.build(CodeSystemURI.head(codeSystem))\n \t\t\t\t\t\t.execute(context.service(IEventBus.class))\n \t\t\t\t\t\t.getSync(5, TimeUnit.MINUTES)\n"}}, {"oid": "8b5bc23faa91b861e6fad569ce40c853e3908371", "url": "https://github.com/b2ihealthcare/snow-owl/commit/8b5bc23faa91b861e6fad569ce40c853e3908371", "message": "SO-4219: request all concepts", "committedDate": "2020-08-17T06:14:44Z", "type": "commit"}]}