{"pr_number": 728, "pr_title": "Add isLeader check for Leader only events", "pr_createdAt": "2020-07-13T22:15:04Z", "pr_url": "https://github.com/linkedin/brooklin/pull/728", "timeline": [{"oid": "c31cd4a15cc8dd69b0a653dbe4201de934ea6d65", "url": "https://github.com/linkedin/brooklin/commit/c31cd4a15cc8dd69b0a653dbe4201de934ea6d65", "message": "Merge pull request #1 from linkedin/master\n\nPull latest", "committedDate": "2019-11-18T20:06:44Z", "type": "commit"}, {"oid": "0f3c87f2f3770e1488eb5c76468f50ac2b1e99f7", "url": "https://github.com/linkedin/brooklin/commit/0f3c87f2f3770e1488eb5c76468f50ac2b1e99f7", "message": "Merge branch 'master' of github.com:linkedin/brooklin", "committedDate": "2020-05-11T20:40:50Z", "type": "commit"}, {"oid": "4572ee158147a9cfee8b68fdef2e4d79245ef243", "url": "https://github.com/linkedin/brooklin/commit/4572ee158147a9cfee8b68fdef2e4d79245ef243", "message": "Merge branch 'master' of github.com:linkedin/brooklin", "committedDate": "2020-07-02T20:20:37Z", "type": "commit"}, {"oid": "e93964fe1e0be60e0e3194d71c06069033e4b216", "url": "https://github.com/linkedin/brooklin/commit/e93964fe1e0be60e0e3194d71c06069033e4b216", "message": "Add isLeader check for Leader only events", "committedDate": "2020-07-13T22:03:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQyNTYyMQ==", "url": "https://github.com/linkedin/brooklin/pull/728#discussion_r455425621", "bodyText": "Instead of repeating this check in multiple handle methods, I think it would be better to have just a single check in handleEvent(). This would also allow us to identify all leader-only events by looking at that one method.\nI suggest caching _adapter.isLeader() in a local instead of calling it twice to avoid situations where the value of the underlying variable might have changed between the two calls.", "author": "ahmedahamid", "createdAt": "2020-07-15T23:39:19Z", "path": "datastream-server/src/main/java/com/linkedin/datastream/server/Coordinator.java", "diffHunk": "@@ -777,6 +777,10 @@ private boolean isDeletingOrExpired(Datastream stream) {\n    * either. Also, expired streams are excluded from any future task assignments.\n    */\n   private void handleDatastreamAddOrDelete() {\n+    if (!_adapter.isLeader()) {\n+      _log.warn(\"skipping handleDatastreamAddOrDelete isLeader {}\", _adapter.isLeader());\n+      return;\n+    }", "originalCommit": "e93964fe1e0be60e0e3194d71c06069033e4b216", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTk1NjI3OQ==", "url": "https://github.com/linkedin/brooklin/pull/728#discussion_r455956279", "bodyText": "done.", "author": "vmaheshw", "createdAt": "2020-07-16T17:35:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQyNTYyMQ=="}], "type": "inlineReview", "revised_code": {"commit": "aada93492b910d1a22becad6008793e1c5d2457f", "chunk": "diff --git a/datastream-server/src/main/java/com/linkedin/datastream/server/Coordinator.java b/datastream-server/src/main/java/com/linkedin/datastream/server/Coordinator.java\nindex 2859570c..88860ae2 100644\n--- a/datastream-server/src/main/java/com/linkedin/datastream/server/Coordinator.java\n+++ b/datastream-server/src/main/java/com/linkedin/datastream/server/Coordinator.java\n\n@@ -777,10 +793,6 @@ public class Coordinator implements ZkAdapter.ZkAdapterListener, MetricsAware {\n    * either. Also, expired streams are excluded from any future task assignments.\n    */\n   private void handleDatastreamAddOrDelete() {\n-    if (!_adapter.isLeader()) {\n-      _log.warn(\"skipping handleDatastreamAddOrDelete isLeader {}\", _adapter.isLeader());\n-      return;\n-    }\n     boolean shouldRetry = false;\n \n     // Get the list of all datastreams\n"}}, {"oid": "aada93492b910d1a22becad6008793e1c5d2457f", "url": "https://github.com/linkedin/brooklin/commit/aada93492b910d1a22becad6008793e1c5d2457f", "message": "Address Review Comments", "committedDate": "2020-07-16T17:24:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE0MjU4Mw==", "url": "https://github.com/linkedin/brooklin/pull/728#discussion_r456142583", "bodyText": "nit: I think this'd be more intuitive/straightforward if expressed as:\nif (isLeaderEvent(event) && !isLeader) {\n  _log.info(...);\n  return;\n}", "author": "ahmedahamid", "createdAt": "2020-07-16T23:57:40Z", "path": "datastream-server/src/main/java/com/linkedin/datastream/server/Coordinator.java", "diffHunk": "@@ -663,7 +663,11 @@ private void assignSerdes(DatastreamTaskImpl datastreamTask) {\n \n   protected synchronized void handleEvent(CoordinatorEvent event) {\n     _log.info(\"START: Handle event \" + event.getType() + \", Instance: \" + _adapter.getInstanceName());\n-\n+    boolean isLeader = _adapter.isLeader();\n+    if (skipLeaderEvent(event.getType(), isLeader)) {", "originalCommit": "aada93492b910d1a22becad6008793e1c5d2457f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE2OTYwNg==", "url": "https://github.com/linkedin/brooklin/pull/728#discussion_r456169606", "bodyText": "done", "author": "vmaheshw", "createdAt": "2020-07-17T01:35:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE0MjU4Mw=="}], "type": "inlineReview", "revised_code": {"commit": "ee92d426cca3112406806f4a39b4f524562abac0", "chunk": "diff --git a/datastream-server/src/main/java/com/linkedin/datastream/server/Coordinator.java b/datastream-server/src/main/java/com/linkedin/datastream/server/Coordinator.java\nindex 88860ae2..d85c8d78 100644\n--- a/datastream-server/src/main/java/com/linkedin/datastream/server/Coordinator.java\n+++ b/datastream-server/src/main/java/com/linkedin/datastream/server/Coordinator.java\n\n@@ -664,7 +664,7 @@ public class Coordinator implements ZkAdapter.ZkAdapterListener, MetricsAware {\n   protected synchronized void handleEvent(CoordinatorEvent event) {\n     _log.info(\"START: Handle event \" + event.getType() + \", Instance: \" + _adapter.getInstanceName());\n     boolean isLeader = _adapter.isLeader();\n-    if (skipLeaderEvent(event.getType(), isLeader)) {\n+    if (!isLeader && isLeaderEvent(event.getType())) {\n       _log.info(\"Skipping event {} isLeader {}\", event.getType(), isLeader);\n       return;\n     }\n"}}, {"oid": "ee92d426cca3112406806f4a39b4f524562abac0", "url": "https://github.com/linkedin/brooklin/commit/ee92d426cca3112406806f4a39b4f524562abac0", "message": "Address review comments", "committedDate": "2020-07-17T01:30:13Z", "type": "commit"}]}