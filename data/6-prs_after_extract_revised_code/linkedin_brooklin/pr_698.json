{"pr_number": 698, "pr_title": "Update ArithmeticException to IllegalArgumentException in StickyPartitionAssignmentStrategy.", "pr_createdAt": "2020-04-07T00:02:45Z", "pr_url": "https://github.com/linkedin/brooklin/pull/698", "timeline": [{"oid": "c31cd4a15cc8dd69b0a653dbe4201de934ea6d65", "url": "https://github.com/linkedin/brooklin/commit/c31cd4a15cc8dd69b0a653dbe4201de934ea6d65", "message": "Merge pull request #1 from linkedin/master\n\nPull latest", "committedDate": "2019-11-18T20:06:44Z", "type": "commit"}, {"oid": "699a6326b1c6cf4525a5f9c12f8b36eeb490da01", "url": "https://github.com/linkedin/brooklin/commit/699a6326b1c6cf4525a5f9c12f8b36eeb490da01", "message": "Merge branch 'master' of github.com:linkedin/brooklin into HEAD", "committedDate": "2020-04-06T22:34:40Z", "type": "commit"}, {"oid": "0ec357e954d1e0bb436583ebb9ef6efa66cacef7", "url": "https://github.com/linkedin/brooklin/commit/0ec357e954d1e0bb436583ebb9ef6efa66cacef7", "message": "Fix arithmetic exception in StickyPartitionAssignmentStrategy", "committedDate": "2020-04-06T23:59:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk0ODU5OA==", "url": "https://github.com/linkedin/brooklin/pull/698#discussion_r404948598", "bodyText": "can we use lang3?", "author": "somandal", "createdAt": "2020-04-07T16:31:46Z", "path": "datastream-server/src/main/java/com/linkedin/datastream/server/assignment/StickyPartitionAssignmentStrategy.java", "diffHunk": "@@ -16,6 +16,7 @@\n import java.util.concurrent.atomic.AtomicInteger;\n import java.util.stream.Collectors;\n \n+import org.apache.commons.lang.Validate;", "originalCommit": "0ec357e954d1e0bb436583ebb9ef6efa66cacef7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "840fa183363a81a9b1b15c71228eb2ac3ece434f", "chunk": "diff --git a/datastream-server/src/main/java/com/linkedin/datastream/server/assignment/StickyPartitionAssignmentStrategy.java b/datastream-server/src/main/java/com/linkedin/datastream/server/assignment/StickyPartitionAssignmentStrategy.java\nindex 09b02a71..11870d61 100644\n--- a/datastream-server/src/main/java/com/linkedin/datastream/server/assignment/StickyPartitionAssignmentStrategy.java\n+++ b/datastream-server/src/main/java/com/linkedin/datastream/server/assignment/StickyPartitionAssignmentStrategy.java\n\n@@ -16,7 +16,7 @@ import java.util.Set;\n import java.util.concurrent.atomic.AtomicInteger;\n import java.util.stream.Collectors;\n \n-import org.apache.commons.lang.Validate;\n+import org.apache.commons.lang3.Validate;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk0OTM4NQ==", "url": "https://github.com/linkedin/brooklin/pull/698#discussion_r404949385", "bodyText": "just curious, do we know why currentAssignment size was 0? I know saw this happen once on ZK session expiry and looked like the ZKClient was null (had the fix Justin made)", "author": "somandal", "createdAt": "2020-04-07T16:32:57Z", "path": "datastream-server/src/main/java/com/linkedin/datastream/server/assignment/StickyPartitionAssignmentStrategy.java", "diffHunk": "@@ -67,6 +68,8 @@ public StickyPartitionAssignmentStrategy(Optional<Integer> maxTasks, Optional<In\n \n     LOG.info(\"old partition assignment info, assignment: {}\", currentAssignment);\n \n+    Validate.isTrue(currentAssignment.size() > 0, \"Zero tasks assigned. Retry leader assignment.\");", "originalCommit": "0ec357e954d1e0bb436583ebb9ef6efa66cacef7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk1MDM0Nw==", "url": "https://github.com/linkedin/brooklin/pull/698#discussion_r404950347", "bodyText": "Also the log message, can we change it to: \"Retry leader partition assignment\"?", "author": "somandal", "createdAt": "2020-04-07T16:34:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk0OTM4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgwMTgyOQ==", "url": "https://github.com/linkedin/brooklin/pull/698#discussion_r405801829", "bodyText": "Unfortunately, I don't have the logs to confirm why. I thought it is still a good fix irrespective of the cause.", "author": "vmaheshw", "createdAt": "2020-04-08T20:42:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk0OTM4NQ=="}], "type": "inlineReview", "revised_code": {"commit": "840fa183363a81a9b1b15c71228eb2ac3ece434f", "chunk": "diff --git a/datastream-server/src/main/java/com/linkedin/datastream/server/assignment/StickyPartitionAssignmentStrategy.java b/datastream-server/src/main/java/com/linkedin/datastream/server/assignment/StickyPartitionAssignmentStrategy.java\nindex 09b02a71..11870d61 100644\n--- a/datastream-server/src/main/java/com/linkedin/datastream/server/assignment/StickyPartitionAssignmentStrategy.java\n+++ b/datastream-server/src/main/java/com/linkedin/datastream/server/assignment/StickyPartitionAssignmentStrategy.java\n\n@@ -68,7 +68,8 @@ public class StickyPartitionAssignmentStrategy extends StickyMulticastStrategy {\n \n     LOG.info(\"old partition assignment info, assignment: {}\", currentAssignment);\n \n-    Validate.isTrue(currentAssignment.size() > 0, \"Zero tasks assigned. Retry leader assignment.\");\n+    Validate.isTrue(currentAssignment.size() > 0,\n+        \"Zero tasks assigned. Retry leader partition assignment.\");\n \n     String dgName = datastreamPartitions.getDatastreamGroup().getName();\n \n"}}, {"oid": "840fa183363a81a9b1b15c71228eb2ac3ece434f", "url": "https://github.com/linkedin/brooklin/commit/840fa183363a81a9b1b15c71228eb2ac3ece434f", "message": "Address Review Comments", "committedDate": "2020-04-08T20:40:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjk1NDAxNA==", "url": "https://github.com/linkedin/brooklin/pull/698#discussion_r406954014", "bodyText": "Isn't this going to raise IllegalArgumentException since for whatever reason we are seeing it be 0? Not sure I understand what the change set out to achieve. Throw a more appropriate exception?", "author": "DEEPTHIKORAT", "createdAt": "2020-04-10T21:36:27Z", "path": "datastream-server/src/main/java/com/linkedin/datastream/server/assignment/StickyPartitionAssignmentStrategy.java", "diffHunk": "@@ -67,6 +68,9 @@ public StickyPartitionAssignmentStrategy(Optional<Integer> maxTasks, Optional<In\n \n     LOG.info(\"old partition assignment info, assignment: {}\", currentAssignment);\n \n+    Validate.isTrue(currentAssignment.size() > 0,", "originalCommit": "840fa183363a81a9b1b15c71228eb2ac3ece434f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjk5MDg5NQ==", "url": "https://github.com/linkedin/brooklin/pull/698#discussion_r406990895", "bodyText": "I feel IllegalArgumentException is appropriate for this api. This change is to not do the assignment if total assignments are zero and redo leader assignment.", "author": "vmaheshw", "createdAt": "2020-04-11T00:17:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjk1NDAxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjk5MTQwMg==", "url": "https://github.com/linkedin/brooklin/pull/698#discussion_r406991402", "bodyText": "Just to clarify, the behavior of this this won't change right, just the type of exception thrown? Even before this change, an exception would be thrown and the assignment retried?", "author": "somandal", "createdAt": "2020-04-11T00:20:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjk1NDAxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjk5MTY1Nw==", "url": "https://github.com/linkedin/brooklin/pull/698#discussion_r406991657", "bodyText": "Yes, Just Arithmetic Exception is something we want to avoid.", "author": "vmaheshw", "createdAt": "2020-04-11T00:22:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjk1NDAxNA=="}], "type": "inlineReview", "revised_code": null}]}