{"pr_number": 685, "pr_title": " Verify/Clean orphan tasks under connector in zookeeper by leader coordinator", "pr_createdAt": "2020-02-14T22:34:12Z", "pr_url": "https://github.com/linkedin/brooklin/pull/685", "timeline": [{"oid": "c31cd4a15cc8dd69b0a653dbe4201de934ea6d65", "url": "https://github.com/linkedin/brooklin/commit/c31cd4a15cc8dd69b0a653dbe4201de934ea6d65", "message": "Merge pull request #1 from linkedin/master\n\nPull latest", "committedDate": "2019-11-18T20:06:44Z", "type": "commit"}, {"oid": "ea601106044c12d556139cb3ab37f6d3e05b90bb", "url": "https://github.com/linkedin/brooklin/commit/ea601106044c12d556139cb3ab37f6d3e05b90bb", "message": "Merge branch 'master' of github.com:linkedin/brooklin into HEAD", "committedDate": "2020-02-11T23:52:17Z", "type": "commit"}, {"oid": "3588deb6266ebdcedb8cc8c890589de184abb967", "url": "https://github.com/linkedin/brooklin/commit/3588deb6266ebdcedb8cc8c890589de184abb967", "message": "Verify/Clean orphan tasks under connector in zookeeper by leader coordinator", "committedDate": "2020-02-14T22:24:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY3NzI5NQ==", "url": "https://github.com/linkedin/brooklin/pull/685#discussion_r379677295", "bodyText": "Just a clarifying question: Any reason this shouldn't be done as part of cleaning up dead tasks in the original LEADER_DO_ASSIGNMENT event? Might be a good idea to add clear documentation around why this should only be performed afterwards.", "author": "somandal", "createdAt": "2020-02-14T22:42:11Z", "path": "datastream-server/src/main/java/com/linkedin/datastream/server/zk/ZkAdapter.java", "diffHunk": "@@ -875,6 +890,44 @@ public void cleanupOldUnusedTasks(Map<String, Set<DatastreamTask>> previousAssig\n     unusedTasks.forEach(t -> deleteConnectorTask(t.getConnectorType(), t.getDatastreamTaskName()));\n   }\n \n+  /**\n+   * Remove orphan connector task nodes which are not assigned to any instance (live or pause).\n+   *\n+   * NOTE: this should only be called after the valid tasks have been\n+   * reassigned or become safe to discard per strategy requirement.\n+   * This can be a costly operation. So, it should be call once the leader get elected and has finished\n+   * the assignment and cleaned up dead Tasks. Ideally, we should not find anything in this check to clean up.", "originalCommit": "3588deb6266ebdcedb8cc8c890589de184abb967", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjMxMzY2OQ==", "url": "https://github.com/linkedin/brooklin/pull/685#discussion_r382313669", "bodyText": "Updated the comment as well. get all children of /cluster/connector is a very costly operation. So, it should not be done very frequently.", "author": "vmaheshw", "createdAt": "2020-02-20T23:20:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY3NzI5NQ=="}], "type": "inlineReview", "revised_code": {"commit": "80b37469f0b0f91fb94fb54cadbfa578b857e5f3", "chunk": "diff --git a/datastream-server/src/main/java/com/linkedin/datastream/server/zk/ZkAdapter.java b/datastream-server/src/main/java/com/linkedin/datastream/server/zk/ZkAdapter.java\nindex 295a5c57..6d97e08b 100644\n--- a/datastream-server/src/main/java/com/linkedin/datastream/server/zk/ZkAdapter.java\n+++ b/datastream-server/src/main/java/com/linkedin/datastream/server/zk/ZkAdapter.java\n\n@@ -891,18 +891,20 @@ public class ZkAdapter {\n   }\n \n   /**\n-   * Remove orphan connector task nodes which are not assigned to any instance (live or pause).\n+   * Remove orphan connector task nodes which are not assigned to any instance (live or paused).\n    *\n-   * NOTE: this should only be called after the valid tasks have been\n-   * reassigned or become safe to discard per strategy requirement.\n-   * This can be a costly operation. So, it should be call once the leader get elected and has finished\n-   * the assignment and cleaned up dead Tasks. Ideally, we should not find anything in this check to clean up.\n-   * @param cleanUpOrphanTasksInConnector Boolean whether orphan tasks should be removed from zookeeper or just print\n-   *                                      warning logs.\n+   * NOTE: this should be called after the valid tasks have been reassigned or become safe to discard per\n+   * strategy requirement.\n+   * This is a costly operation which involves getting all children of /cluster/connectors from Zookeeper. So,\n+   * it should be called only once the leader gets\n+   * elected and has finished the assignment and cleaned up dead\n+   * Tasks. Ideally, we should not find anything in this check to clean up.\n+   * @param cleanUpOrphanTasksInConnector Boolean whether orphan tasks should be removed from zookeeper or just\n+   *                                      print warning logs.\n    */\n-  public void cleanUpOrphanConnectorTasks(boolean cleanUpOrphanTasksInConnector) {\n+  public int cleanUpOrphanConnectorTasks(boolean cleanUpOrphanTasksInConnector) {\n     if (!_isLeader) {\n-      return;\n+      return 0;\n     }\n \n     Map<String, Set<DatastreamTask>> assignmentsByInstance = getAllAssignedDatastreamTasks();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTM5MDE5NQ==", "url": "https://github.com/linkedin/brooklin/pull/685#discussion_r381390195", "bodyText": "I remember reading this at some point and thinking I am going to see this in this the logs somewhere and assume something bad happened, and that exactly happened yesterday. Awesome that you fixed it.", "author": "DEEPTHIKORAT", "createdAt": "2020-02-19T16:29:33Z", "path": "datastream-server/src/main/java/com/linkedin/datastream/server/zk/ZkAdapter.java", "diffHunk": "@@ -1222,9 +1275,10 @@ public ZkBackedLiveInstanceListProvider() {\n       List<String> liveInstances = new ArrayList<>();\n       for (String n : nodes) {\n         String hostname = _zkclient.ensureReadData(KeyBuilder.liveInstance(_cluster, n));\n-        if (hostname != null) {\n+        if (hostname == null) {", "originalCommit": "3588deb6266ebdcedb8cc8c890589de184abb967", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTM5MDY3Nw==", "url": "https://github.com/linkedin/brooklin/pull/685#discussion_r381390677", "bodyText": "typo: live or paused", "author": "DEEPTHIKORAT", "createdAt": "2020-02-19T16:30:20Z", "path": "datastream-server/src/main/java/com/linkedin/datastream/server/zk/ZkAdapter.java", "diffHunk": "@@ -875,6 +890,44 @@ public void cleanupOldUnusedTasks(Map<String, Set<DatastreamTask>> previousAssig\n     unusedTasks.forEach(t -> deleteConnectorTask(t.getConnectorType(), t.getDatastreamTaskName()));\n   }\n \n+  /**\n+   * Remove orphan connector task nodes which are not assigned to any instance (live or pause).", "originalCommit": "3588deb6266ebdcedb8cc8c890589de184abb967", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "80b37469f0b0f91fb94fb54cadbfa578b857e5f3", "chunk": "diff --git a/datastream-server/src/main/java/com/linkedin/datastream/server/zk/ZkAdapter.java b/datastream-server/src/main/java/com/linkedin/datastream/server/zk/ZkAdapter.java\nindex 295a5c57..6d97e08b 100644\n--- a/datastream-server/src/main/java/com/linkedin/datastream/server/zk/ZkAdapter.java\n+++ b/datastream-server/src/main/java/com/linkedin/datastream/server/zk/ZkAdapter.java\n\n@@ -891,18 +891,20 @@ public class ZkAdapter {\n   }\n \n   /**\n-   * Remove orphan connector task nodes which are not assigned to any instance (live or pause).\n+   * Remove orphan connector task nodes which are not assigned to any instance (live or paused).\n    *\n-   * NOTE: this should only be called after the valid tasks have been\n-   * reassigned or become safe to discard per strategy requirement.\n-   * This can be a costly operation. So, it should be call once the leader get elected and has finished\n-   * the assignment and cleaned up dead Tasks. Ideally, we should not find anything in this check to clean up.\n-   * @param cleanUpOrphanTasksInConnector Boolean whether orphan tasks should be removed from zookeeper or just print\n-   *                                      warning logs.\n+   * NOTE: this should be called after the valid tasks have been reassigned or become safe to discard per\n+   * strategy requirement.\n+   * This is a costly operation which involves getting all children of /cluster/connectors from Zookeeper. So,\n+   * it should be called only once the leader gets\n+   * elected and has finished the assignment and cleaned up dead\n+   * Tasks. Ideally, we should not find anything in this check to clean up.\n+   * @param cleanUpOrphanTasksInConnector Boolean whether orphan tasks should be removed from zookeeper or just\n+   *                                      print warning logs.\n    */\n-  public void cleanUpOrphanConnectorTasks(boolean cleanUpOrphanTasksInConnector) {\n+  public int cleanUpOrphanConnectorTasks(boolean cleanUpOrphanTasksInConnector) {\n     if (!_isLeader) {\n-      return;\n+      return 0;\n     }\n \n     Map<String, Set<DatastreamTask>> assignmentsByInstance = getAllAssignedDatastreamTasks();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTM5MTIwMQ==", "url": "https://github.com/linkedin/brooklin/pull/685#discussion_r381391201", "bodyText": "nit: Can you format the comment lines to be of approximately the same length?", "author": "DEEPTHIKORAT", "createdAt": "2020-02-19T16:31:09Z", "path": "datastream-server/src/main/java/com/linkedin/datastream/server/zk/ZkAdapter.java", "diffHunk": "@@ -875,6 +890,44 @@ public void cleanupOldUnusedTasks(Map<String, Set<DatastreamTask>> previousAssig\n     unusedTasks.forEach(t -> deleteConnectorTask(t.getConnectorType(), t.getDatastreamTaskName()));\n   }\n \n+  /**\n+   * Remove orphan connector task nodes which are not assigned to any instance (live or pause).\n+   *\n+   * NOTE: this should only be called after the valid tasks have been", "originalCommit": "3588deb6266ebdcedb8cc8c890589de184abb967", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "80b37469f0b0f91fb94fb54cadbfa578b857e5f3", "chunk": "diff --git a/datastream-server/src/main/java/com/linkedin/datastream/server/zk/ZkAdapter.java b/datastream-server/src/main/java/com/linkedin/datastream/server/zk/ZkAdapter.java\nindex 295a5c57..6d97e08b 100644\n--- a/datastream-server/src/main/java/com/linkedin/datastream/server/zk/ZkAdapter.java\n+++ b/datastream-server/src/main/java/com/linkedin/datastream/server/zk/ZkAdapter.java\n\n@@ -891,18 +891,20 @@ public class ZkAdapter {\n   }\n \n   /**\n-   * Remove orphan connector task nodes which are not assigned to any instance (live or pause).\n+   * Remove orphan connector task nodes which are not assigned to any instance (live or paused).\n    *\n-   * NOTE: this should only be called after the valid tasks have been\n-   * reassigned or become safe to discard per strategy requirement.\n-   * This can be a costly operation. So, it should be call once the leader get elected and has finished\n-   * the assignment and cleaned up dead Tasks. Ideally, we should not find anything in this check to clean up.\n-   * @param cleanUpOrphanTasksInConnector Boolean whether orphan tasks should be removed from zookeeper or just print\n-   *                                      warning logs.\n+   * NOTE: this should be called after the valid tasks have been reassigned or become safe to discard per\n+   * strategy requirement.\n+   * This is a costly operation which involves getting all children of /cluster/connectors from Zookeeper. So,\n+   * it should be called only once the leader gets\n+   * elected and has finished the assignment and cleaned up dead\n+   * Tasks. Ideally, we should not find anything in this check to clean up.\n+   * @param cleanUpOrphanTasksInConnector Boolean whether orphan tasks should be removed from zookeeper or just\n+   *                                      print warning logs.\n    */\n-  public void cleanUpOrphanConnectorTasks(boolean cleanUpOrphanTasksInConnector) {\n+  public int cleanUpOrphanConnectorTasks(boolean cleanUpOrphanTasksInConnector) {\n     if (!_isLeader) {\n-      return;\n+      return 0;\n     }\n \n     Map<String, Set<DatastreamTask>> assignmentsByInstance = getAllAssignedDatastreamTasks();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTM5MjYwNw==", "url": "https://github.com/linkedin/brooklin/pull/685#discussion_r381392607", "bodyText": "nit: typos:\n\nshould be called; 2. leader gets elected", "author": "DEEPTHIKORAT", "createdAt": "2020-02-19T16:33:12Z", "path": "datastream-server/src/main/java/com/linkedin/datastream/server/zk/ZkAdapter.java", "diffHunk": "@@ -875,6 +890,44 @@ public void cleanupOldUnusedTasks(Map<String, Set<DatastreamTask>> previousAssig\n     unusedTasks.forEach(t -> deleteConnectorTask(t.getConnectorType(), t.getDatastreamTaskName()));\n   }\n \n+  /**\n+   * Remove orphan connector task nodes which are not assigned to any instance (live or pause).\n+   *\n+   * NOTE: this should only be called after the valid tasks have been\n+   * reassigned or become safe to discard per strategy requirement.\n+   * This can be a costly operation. So, it should be call once the leader get elected and has finished", "originalCommit": "3588deb6266ebdcedb8cc8c890589de184abb967", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "80b37469f0b0f91fb94fb54cadbfa578b857e5f3", "chunk": "diff --git a/datastream-server/src/main/java/com/linkedin/datastream/server/zk/ZkAdapter.java b/datastream-server/src/main/java/com/linkedin/datastream/server/zk/ZkAdapter.java\nindex 295a5c57..6d97e08b 100644\n--- a/datastream-server/src/main/java/com/linkedin/datastream/server/zk/ZkAdapter.java\n+++ b/datastream-server/src/main/java/com/linkedin/datastream/server/zk/ZkAdapter.java\n\n@@ -891,18 +891,20 @@ public class ZkAdapter {\n   }\n \n   /**\n-   * Remove orphan connector task nodes which are not assigned to any instance (live or pause).\n+   * Remove orphan connector task nodes which are not assigned to any instance (live or paused).\n    *\n-   * NOTE: this should only be called after the valid tasks have been\n-   * reassigned or become safe to discard per strategy requirement.\n-   * This can be a costly operation. So, it should be call once the leader get elected and has finished\n-   * the assignment and cleaned up dead Tasks. Ideally, we should not find anything in this check to clean up.\n-   * @param cleanUpOrphanTasksInConnector Boolean whether orphan tasks should be removed from zookeeper or just print\n-   *                                      warning logs.\n+   * NOTE: this should be called after the valid tasks have been reassigned or become safe to discard per\n+   * strategy requirement.\n+   * This is a costly operation which involves getting all children of /cluster/connectors from Zookeeper. So,\n+   * it should be called only once the leader gets\n+   * elected and has finished the assignment and cleaned up dead\n+   * Tasks. Ideally, we should not find anything in this check to clean up.\n+   * @param cleanUpOrphanTasksInConnector Boolean whether orphan tasks should be removed from zookeeper or just\n+   *                                      print warning logs.\n    */\n-  public void cleanUpOrphanConnectorTasks(boolean cleanUpOrphanTasksInConnector) {\n+  public int cleanUpOrphanConnectorTasks(boolean cleanUpOrphanTasksInConnector) {\n     if (!_isLeader) {\n-      return;\n+      return 0;\n     }\n \n     Map<String, Set<DatastreamTask>> assignmentsByInstance = getAllAssignedDatastreamTasks();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQ1MDY3MQ==", "url": "https://github.com/linkedin/brooklin/pull/685#discussion_r381450671", "bodyText": "Can we add a metric for this so we can monitor it?", "author": "DEEPTHIKORAT", "createdAt": "2020-02-19T18:07:51Z", "path": "datastream-server/src/main/java/com/linkedin/datastream/server/zk/ZkAdapter.java", "diffHunk": "@@ -875,6 +890,44 @@ public void cleanupOldUnusedTasks(Map<String, Set<DatastreamTask>> previousAssig\n     unusedTasks.forEach(t -> deleteConnectorTask(t.getConnectorType(), t.getDatastreamTaskName()));\n   }\n \n+  /**\n+   * Remove orphan connector task nodes which are not assigned to any instance (live or pause).\n+   *\n+   * NOTE: this should only be called after the valid tasks have been\n+   * reassigned or become safe to discard per strategy requirement.\n+   * This can be a costly operation. So, it should be call once the leader get elected and has finished\n+   * the assignment and cleaned up dead Tasks. Ideally, we should not find anything in this check to clean up.\n+   * @param cleanUpOrphanTasksInConnector Boolean whether orphan tasks should be removed from zookeeper or just print\n+   *                                      warning logs.\n+   */\n+  public void cleanUpOrphanConnectorTasks(boolean cleanUpOrphanTasksInConnector) {\n+    if (!_isLeader) {\n+      return;\n+    }\n+\n+    Map<String, Set<DatastreamTask>> assignmentsByInstance = getAllAssignedDatastreamTasks();\n+\n+    Set<DatastreamTask> validTasks =\n+        assignmentsByInstance.values().stream().flatMap(Collection::stream).collect(Collectors.toSet());\n+\n+    List<String> allConnectors = getAllConnectors();\n+    for (String connector : allConnectors) {\n+      Set<String> connectorTaskList = getConnectorTasks(connector);\n+\n+      connectorTaskList.removeAll(validTasks.stream()\n+          .filter(x -> x.getConnectorType().equals(connector))\n+          .map(DatastreamTask::getDatastreamTaskName)\n+          .collect(Collectors.toSet()));\n+\n+      if (connectorTaskList.size() > 0) {\n+        LOG.warn(\"Found orphan tasks: {} in connector: {}\", connectorTaskList, connector);", "originalCommit": "3588deb6266ebdcedb8cc8c890589de184abb967", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "80b37469f0b0f91fb94fb54cadbfa578b857e5f3", "chunk": "diff --git a/datastream-server/src/main/java/com/linkedin/datastream/server/zk/ZkAdapter.java b/datastream-server/src/main/java/com/linkedin/datastream/server/zk/ZkAdapter.java\nindex 295a5c57..6d97e08b 100644\n--- a/datastream-server/src/main/java/com/linkedin/datastream/server/zk/ZkAdapter.java\n+++ b/datastream-server/src/main/java/com/linkedin/datastream/server/zk/ZkAdapter.java\n\n@@ -891,18 +891,20 @@ public class ZkAdapter {\n   }\n \n   /**\n-   * Remove orphan connector task nodes which are not assigned to any instance (live or pause).\n+   * Remove orphan connector task nodes which are not assigned to any instance (live or paused).\n    *\n-   * NOTE: this should only be called after the valid tasks have been\n-   * reassigned or become safe to discard per strategy requirement.\n-   * This can be a costly operation. So, it should be call once the leader get elected and has finished\n-   * the assignment and cleaned up dead Tasks. Ideally, we should not find anything in this check to clean up.\n-   * @param cleanUpOrphanTasksInConnector Boolean whether orphan tasks should be removed from zookeeper or just print\n-   *                                      warning logs.\n+   * NOTE: this should be called after the valid tasks have been reassigned or become safe to discard per\n+   * strategy requirement.\n+   * This is a costly operation which involves getting all children of /cluster/connectors from Zookeeper. So,\n+   * it should be called only once the leader gets\n+   * elected and has finished the assignment and cleaned up dead\n+   * Tasks. Ideally, we should not find anything in this check to clean up.\n+   * @param cleanUpOrphanTasksInConnector Boolean whether orphan tasks should be removed from zookeeper or just\n+   *                                      print warning logs.\n    */\n-  public void cleanUpOrphanConnectorTasks(boolean cleanUpOrphanTasksInConnector) {\n+  public int cleanUpOrphanConnectorTasks(boolean cleanUpOrphanTasksInConnector) {\n     if (!_isLeader) {\n-      return;\n+      return 0;\n     }\n \n     Map<String, Set<DatastreamTask>> assignmentsByInstance = getAllAssignedDatastreamTasks();\n"}}, {"oid": "80b37469f0b0f91fb94fb54cadbfa578b857e5f3", "url": "https://github.com/linkedin/brooklin/commit/80b37469f0b0f91fb94fb54cadbfa578b857e5f3", "message": "Add Metrics for orphanConnectorTasks and minor fixes", "committedDate": "2020-02-20T23:45:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjY3MDU4OQ==", "url": "https://github.com/linkedin/brooklin/pull/685#discussion_r382670589", "bodyText": "should we test with false first after updateInstanceAssignments and see 2 left as well?", "author": "DEEPTHIKORAT", "createdAt": "2020-02-21T16:13:44Z", "path": "datastream-server/src/test/java/com/linkedin/datastream/server/zk/TestZkAdapter.java", "diffHunk": "@@ -759,6 +759,26 @@ public void testDeleteTasksWithPrefix() {\n     List<String> leftOverTasks = zkClient.getChildren(KeyBuilder.connector(testCluster, connectorType));\n     Assert.assertEquals(leftOverTasks.size(), 2);\n \n+    adapter.cleanUpOrphanConnectorTasks(false);\n+\n+    leftOverTasks = zkClient.getChildren(KeyBuilder.connector(testCluster, connectorType));\n+    Assert.assertEquals(leftOverTasks.size(), 2);\n+\n+    adapter.cleanUpOrphanConnectorTasks(true);\n+\n+    leftOverTasks = zkClient.getChildren(KeyBuilder.connector(testCluster, connectorType));\n+    Assert.assertEquals(leftOverTasks.size(), 2);\n+\n+    updateInstanceAssignment(adapter, adapter.getInstanceName(), new ArrayList<DatastreamTask>());\n+\n+    leftOverTasks = zkClient.getChildren(KeyBuilder.connector(testCluster, connectorType));\n+    Assert.assertEquals(leftOverTasks.size(), 2);\n+\n+    adapter.cleanUpOrphanConnectorTasks(true);", "originalCommit": "3588deb6266ebdcedb8cc8c890589de184abb967", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjc1MDk4MA==", "url": "https://github.com/linkedin/brooklin/pull/685#discussion_r382750980", "bodyText": "Done.", "author": "vmaheshw", "createdAt": "2020-02-21T18:58:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjY3MDU4OQ=="}], "type": "inlineReview", "revised_code": {"commit": "c983e969c54e65157200cfd4bd9f377cce1746d8", "chunk": "diff --git a/datastream-server/src/test/java/com/linkedin/datastream/server/zk/TestZkAdapter.java b/datastream-server/src/test/java/com/linkedin/datastream/server/zk/TestZkAdapter.java\nindex c717a5c0..114c376c 100644\n--- a/datastream-server/src/test/java/com/linkedin/datastream/server/zk/TestZkAdapter.java\n+++ b/datastream-server/src/test/java/com/linkedin/datastream/server/zk/TestZkAdapter.java\n\n@@ -774,6 +774,11 @@ public class TestZkAdapter {\n     leftOverTasks = zkClient.getChildren(KeyBuilder.connector(testCluster, connectorType));\n     Assert.assertEquals(leftOverTasks.size(), 2);\n \n+    adapter.cleanUpOrphanConnectorTasks(false);\n+\n+    leftOverTasks = zkClient.getChildren(KeyBuilder.connector(testCluster, connectorType));\n+    Assert.assertEquals(leftOverTasks.size(), 2);\n+\n     adapter.cleanUpOrphanConnectorTasks(true);\n \n     leftOverTasks = zkClient.getChildren(KeyBuilder.connector(testCluster, connectorType));\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjY3NzY5MQ==", "url": "https://github.com/linkedin/brooklin/pull/685#discussion_r382677691", "bodyText": "It's really hard to come up with a name for this.. not happy with this because it suggests action with DO but doesnt specify the action. I am unable to come up with any better though. Will post if I do.", "author": "DEEPTHIKORAT", "createdAt": "2020-02-21T16:26:16Z", "path": "datastream-server/src/main/java/com/linkedin/datastream/server/Coordinator.java", "diffHunk": "@@ -722,6 +732,10 @@ protected synchronized void handleEvent(CoordinatorEvent event) {\n           performPartitionMovement((Long) event.getEventMetadata());\n           break;\n \n+        case LEADER_DO_POST_BECOMING_LEADER:", "originalCommit": "80b37469f0b0f91fb94fb54cadbfa578b857e5f3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU0NjkzNw==", "url": "https://github.com/linkedin/brooklin/pull/685#discussion_r383546937", "bodyText": "Shall we call this something like: POST_BECOME_LEADER instead? I don't like the existing name at all. And update all functions/comments to reflect the same.", "author": "somandal", "createdAt": "2020-02-24T22:15:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjY3NzY5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDAxODI5MA==", "url": "https://github.com/linkedin/brooklin/pull/685#discussion_r384018290", "bodyText": "I completely agree with both of you. @somandal POST_BECOME_LEADER looks incomplete and is not aligning with the other 3 leader specific event names. How about LEADER_DO_POST_ELECTION ?", "author": "vmaheshw", "createdAt": "2020-02-25T17:26:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjY3NzY5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDAyNjgzMw==", "url": "https://github.com/linkedin/brooklin/pull/685#discussion_r384026833", "bodyText": "Just an FYI, the event to handle datastream add/drop is also a leader specific event, so I wouldn't read too much into the \"LEADER\" naming scheme. I also noticed that the names of events talk about the operation performed. Maybe we should name it along those lines as well? LEADER_DO_POST_ELECTION_CLEANUP or something.", "author": "somandal", "createdAt": "2020-02-25T17:40:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjY3NzY5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDAyODQ1NA==", "url": "https://github.com/linkedin/brooklin/pull/685#discussion_r384028454", "bodyText": "Just an FYI, the event to handle datastream add/drop is also a leader specific event, so I wouldn't read too much into the \"LEADER\" naming scheme. I also noticed that the names of events talk about the operation performed. Maybe we should name it along those lines as well? LEADER_DO_POST_ELECTION_CLEANUP or something.", "author": "somandal", "createdAt": "2020-02-25T17:43:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjY3NzY5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDAzNDE3NQ==", "url": "https://github.com/linkedin/brooklin/pull/685#discussion_r384034175", "bodyText": "How about LEADER_DO_CLEANUP_POST_ELECTION?  It sounds more readable.", "author": "vmaheshw", "createdAt": "2020-02-25T18:07:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjY3NzY5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDAzNDc1NQ==", "url": "https://github.com/linkedin/brooklin/pull/685#discussion_r384034755", "bodyText": "Sounds great!", "author": "somandal", "createdAt": "2020-02-25T18:09:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjY3NzY5MQ=="}], "type": "inlineReview", "revised_code": {"commit": "26691234a293d494ed08f6579435f47c37e784f8", "chunk": "diff --git a/datastream-server/src/main/java/com/linkedin/datastream/server/Coordinator.java b/datastream-server/src/main/java/com/linkedin/datastream/server/Coordinator.java\nindex 05c78cdd..d286bde0 100644\n--- a/datastream-server/src/main/java/com/linkedin/datastream/server/Coordinator.java\n+++ b/datastream-server/src/main/java/com/linkedin/datastream/server/Coordinator.java\n\n@@ -732,8 +732,8 @@ public class Coordinator implements ZkAdapter.ZkAdapterListener, MetricsAware {\n           performPartitionMovement((Long) event.getEventMetadata());\n           break;\n \n-        case LEADER_DO_POST_BECOMING_LEADER:\n-          performTaskPostBecomingLeader();\n+        case LEADER_DO_CLEANUP_POST_ELECTION:\n+          performCleanupTaskPostElection();\n           break;\n \n         default:\n"}}, {"oid": "c983e969c54e65157200cfd4bd9f377cce1746d8", "url": "https://github.com/linkedin/brooklin/commit/c983e969c54e65157200cfd4bd9f377cce1746d8", "message": "Enhance TestZkAdapter test case", "committedDate": "2020-02-21T18:57:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU0NzgzNg==", "url": "https://github.com/linkedin/brooklin/pull/685#discussion_r383547836", "bodyText": "If you plan to rename \"performTaskPostBecomingLeader\", can you also add a static constant for this string literal?", "author": "somandal", "createdAt": "2020-02-24T22:17:27Z", "path": "datastream-server/src/main/java/com/linkedin/datastream/server/Coordinator.java", "diffHunk": "@@ -1243,6 +1257,13 @@ private void performPartitionMovement(Long notifyTimestamp) {\n     return newAssignmentsByInstance;\n   }\n \n+  void performTaskPostBecomingLeader() {\n+    _log.info(\"performTaskPostBecomingLeader called\");\n+    int orphanCount = _adapter.cleanUpOrphanConnectorTasks(_config.getZkCleanUpOrphanConnectorTask());\n+    _dynamicMetricsManager.createOrUpdateMeter(MODULE, \"performTaskPostBecomingLeader\",", "originalCommit": "c983e969c54e65157200cfd4bd9f377cce1746d8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDAyMjE0Ng==", "url": "https://github.com/linkedin/brooklin/pull/685#discussion_r384022146", "bodyText": "Please correct me if I understand something wrong. This pattern is followed in the entire file for  createOrUpdateMeter.", "author": "vmaheshw", "createdAt": "2020-02-25T17:32:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU0NzgzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDAyODI4Nw==", "url": "https://github.com/linkedin/brooklin/pull/685#discussion_r384028287", "bodyText": "Just thought it'll be cleaner to have this as a const separately, but sure if you've done it this way for consistency it's your call. I would generally prefer making all string literals constants, but that is just me.", "author": "somandal", "createdAt": "2020-02-25T17:43:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU0NzgzNg=="}], "type": "inlineReview", "revised_code": {"commit": "26691234a293d494ed08f6579435f47c37e784f8", "chunk": "diff --git a/datastream-server/src/main/java/com/linkedin/datastream/server/Coordinator.java b/datastream-server/src/main/java/com/linkedin/datastream/server/Coordinator.java\nindex 05c78cdd..d286bde0 100644\n--- a/datastream-server/src/main/java/com/linkedin/datastream/server/Coordinator.java\n+++ b/datastream-server/src/main/java/com/linkedin/datastream/server/Coordinator.java\n\n@@ -1257,10 +1257,10 @@ public class Coordinator implements ZkAdapter.ZkAdapterListener, MetricsAware {\n     return newAssignmentsByInstance;\n   }\n \n-  void performTaskPostBecomingLeader() {\n-    _log.info(\"performTaskPostBecomingLeader called\");\n+  void performCleanupTaskPostElection() {\n+    _log.info(\"performCleanupTaskPostElection called\");\n     int orphanCount = _adapter.cleanUpOrphanConnectorTasks(_config.getZkCleanUpOrphanConnectorTask());\n-    _dynamicMetricsManager.createOrUpdateMeter(MODULE, \"performTaskPostBecomingLeader\",\n+    _dynamicMetricsManager.createOrUpdateMeter(MODULE, \"performCleanupTaskPostElection\",\n         NUM_ORPHAN_CONNECTOR_TASKS, orphanCount);\n   }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU1MDAzNA==", "url": "https://github.com/linkedin/brooklin/pull/685#discussion_r383550034", "bodyText": "nit: can we make the comment style consistent in this function? some comments have an extra // before and after, other's don't. And it is not exactly clear if this is only because of differentiating steps? If so, maybe number the steps instead to make it clear that those are step related comments?", "author": "somandal", "createdAt": "2020-02-24T22:22:25Z", "path": "datastream-server-restli/src/test/java/com/linkedin/datastream/server/TestCoordinator.java", "diffHunk": "@@ -2443,6 +2450,115 @@ public void testDatastreamDedupeMetadataCopy() throws Exception {\n     Assert.assertEquals(datastreams[1].getMetadata().get(destMetaKey), destMetaVal);\n   }\n \n+  private class TestCoordinatorWithSpyZkAdapter extends Coordinator {\n+\n+    TestCoordinatorWithSpyZkAdapter(CachedDatastreamReader testDatastreamCache, Properties testConfig) throws DatastreamException {\n+      super(testDatastreamCache, testConfig);\n+    }\n+\n+    @Override\n+    ZkAdapter createZkAdapter() {\n+      return spy(new ZkAdapter(getConfig().getZkAddress(), getConfig().getCluster(),\n+          getConfig().getDefaultTransportProviderName(), getConfig().getZkSessionTimeout(),\n+          getConfig().getZkConnectionTimeout(), this));\n+    }\n+  }\n+\n+  @Test\n+  public void testCoordinatorPerformPostBecomingLeaderTasks() throws Exception {\n+    String testCluster = \"testCoordinationSmoke3\";\n+    String testConnectorType = \"testConnectorType\";\n+    String datastreamName1 = \"datastream1\";\n+\n+    Properties props = new Properties();\n+    props.put(CoordinatorConfig.CONFIG_CLUSTER, testCluster);\n+    props.put(CoordinatorConfig.CONFIG_ZK_ADDRESS, _zkConnectionString);\n+    props.put(CoordinatorConfig.CONFIG_ZK_SESSION_TIMEOUT, String.valueOf(ZkClient.DEFAULT_SESSION_TIMEOUT));\n+    props.put(CoordinatorConfig.CONFIG_ZK_CONNECTION_TIMEOUT, String.valueOf(ZkClient.DEFAULT_CONNECTION_TIMEOUT));\n+\n+    ZkClient zkClient = new ZkClient(_zkConnectionString);\n+    _cachedDatastreamReader = new CachedDatastreamReader(zkClient, testCluster);\n+    Coordinator instance1 = new TestCoordinatorWithSpyZkAdapter(_cachedDatastreamReader, props);\n+    ZkAdapter spyZkAdapter1 = instance1.getZkAdapter();\n+    instance1.addTransportProvider(DummyTransportProviderAdminFactory.PROVIDER_NAME,\n+        new DummyTransportProviderAdminFactory().createTransportProviderAdmin(\n+            DummyTransportProviderAdminFactory.PROVIDER_NAME, new Properties()));\n+\n+    TestHookConnector connector1 = new TestHookConnector(\"connector1\", testConnectorType);\n+    instance1.addConnector(testConnectorType, connector1, new BroadcastStrategy(Optional.empty()), false,\n+        new SourceBasedDeduper(), null);\n+    instance1.start();\n+\n+    String isLeaderMetricName = \"Coordinator.isLeader\";\n+    Gauge<Integer> isLeader = DynamicMetricsManager.getInstance().getMetric(isLeaderMetricName);\n+\n+    Assert.assertEquals(isLeader.getValue().intValue(), 1);\n+\n+    //\n+    // create datastream definitions under /testAssignmentBasic/datastream/datastream1\n+    //", "originalCommit": "c983e969c54e65157200cfd4bd9f377cce1746d8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDAyMDIxNA==", "url": "https://github.com/linkedin/brooklin/pull/685#discussion_r384020214", "bodyText": "I have followed the comment style used in TestCoordinator file.", "author": "vmaheshw", "createdAt": "2020-02-25T17:29:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU1MDAzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDAyODUyMA==", "url": "https://github.com/linkedin/brooklin/pull/685#discussion_r384028520", "bodyText": "Sure, if you think consistency is more important then leave it as is. In general though, this style of commenting is out of the ordinary from the rest of the code base", "author": "somandal", "createdAt": "2020-02-25T17:43:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU1MDAzNA=="}], "type": "inlineReview", "revised_code": {"commit": "26691234a293d494ed08f6579435f47c37e784f8", "chunk": "diff --git a/datastream-server-restli/src/test/java/com/linkedin/datastream/server/TestCoordinator.java b/datastream-server-restli/src/test/java/com/linkedin/datastream/server/TestCoordinator.java\nindex 172fdae4..23084847 100644\n--- a/datastream-server-restli/src/test/java/com/linkedin/datastream/server/TestCoordinator.java\n+++ b/datastream-server-restli/src/test/java/com/linkedin/datastream/server/TestCoordinator.java\n\n@@ -2465,7 +2465,7 @@ public class TestCoordinator {\n   }\n \n   @Test\n-  public void testCoordinatorPerformPostBecomingLeaderTasks() throws Exception {\n+  public void testCoordinatorLeaderCleanupTasksPostElection() throws Exception {\n     String testCluster = \"testCoordinationSmoke3\";\n     String testConnectorType = \"testConnectorType\";\n     String datastreamName1 = \"datastream1\";\n"}}, {"oid": "26691234a293d494ed08f6579435f47c37e784f8", "url": "https://github.com/linkedin/brooklin/commit/26691234a293d494ed08f6579435f47c37e784f8", "message": "Fix Coordinator Event", "committedDate": "2020-02-25T19:09:45Z", "type": "commit"}]}