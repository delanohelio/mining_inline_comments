{"pr_number": 3519, "pr_title": "fix: fix bug in CtLineElementComparator", "pr_createdAt": "2020-08-03T07:15:47Z", "pr_url": "https://github.com/INRIA/spoon/pull/3519", "timeline": [{"oid": "05efd094df5be14f6a428cfadb72701a50782ab1", "url": "https://github.com/INRIA/spoon/commit/05efd094df5be14f6a428cfadb72701a50782ab1", "message": " fix comparator", "committedDate": "2020-08-03T07:30:36Z", "type": "commit"}, {"oid": "05efd094df5be14f6a428cfadb72701a50782ab1", "url": "https://github.com/INRIA/spoon/commit/05efd094df5be14f6a428cfadb72701a50782ab1", "message": " fix comparator", "committedDate": "2020-08-03T07:30:36Z", "type": "forcePushed"}, {"oid": "08580cd2142b3ee8bbca6c58312c8fa4114aeb7c", "url": "https://github.com/INRIA/spoon/commit/08580cd2142b3ee8bbca6c58312c8fa4114aeb7c", "message": "remove checks, because we cant relay on a sorting\nif all constructors have invalid positions.", "committedDate": "2020-08-06T17:37:37Z", "type": "commit"}, {"oid": "3a0e5ad85e30e0b230cfc0de789e00fe578c22a0", "url": "https://github.com/INRIA/spoon/commit/3a0e5ad85e30e0b230cfc0de789e00fe578c22a0", "message": "generate visitors", "committedDate": "2020-08-06T18:01:17Z", "type": "commit"}, {"oid": "d92ecdb798f4bc797e7c2fdb16cfbe188987a5d5", "url": "https://github.com/INRIA/spoon/commit/d92ecdb798f4bc797e7c2fdb16cfbe188987a5d5", "message": "update comment to describe the new behavior.", "committedDate": "2020-08-08T18:44:01Z", "type": "commit"}, {"oid": "99629c231050555cf6b3e46d1d9486f210485957", "url": "https://github.com/INRIA/spoon/commit/99629c231050555cf6b3e46d1d9486f210485957", "message": "Fix checkstyle:\n- Add missing newline add end of file", "committedDate": "2020-08-08T18:44:26Z", "type": "commit"}, {"oid": "da180c36efdd0bfdf10dcd53c41a47bc3ce440bf", "url": "https://github.com/INRIA/spoon/commit/da180c36efdd0bfdf10dcd53c41a47bc3ce440bf", "message": " update licence header", "committedDate": "2020-08-08T19:01:54Z", "type": "commit"}, {"oid": "f8ec5382809ded91f4988e288d12e9e5f5a93a06", "url": "https://github.com/INRIA/spoon/commit/f8ec5382809ded91f4988e288d12e9e5f5a93a06", "message": "Merge branch 'master' into comparatorBug", "committedDate": "2020-08-14T09:06:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDU0MDg1MA==", "url": "https://github.com/INRIA/spoon/pull/3519#discussion_r470540850", "bodyText": "it's better to change the expected value than to remove assertions.", "author": "monperrus", "createdAt": "2020-08-14T10:20:47Z", "path": "src/test/java/spoon/test/ctClass/CtClassTest.java", "diffHunk": "@@ -95,18 +95,10 @@ public void getConstructor() throws Exception {\n \t\tcons.addParameter(cons.getFactory().createParameter().setType(cons.getFactory().Type().OBJECT));\n \t\t// now that we have changed the signature we can call getConstructors safely\n \t\tassertEquals(4, foo.getConstructors().size());\n-\t\t// we cloned the first constructor, so it has the same position, and comes before the 2nd and 3rd constructor\n-\t\tassertSame(cons, foo.getTypeMembers().get(1));", "originalCommit": "da180c36efdd0bfdf10dcd53c41a47bc3ce440bf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjEzNjA2Mw==", "url": "https://github.com/INRIA/spoon/pull/3519#discussion_r472136063", "bodyText": "now the test should still showcase adding a parameter does not change the constructor order and is still green.", "author": "MartinWitt", "createdAt": "2020-08-18T12:22:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDU0MDg1MA=="}], "type": "inlineReview", "revised_code": {"commit": "34df6296a2b1785b3b50372259def1bec30a8c71", "chunk": "diff --git a/src/test/java/spoon/test/ctClass/CtClassTest.java b/src/test/java/spoon/test/ctClass/CtClassTest.java\nindex 39bc5f37..51056d8b 100644\n--- a/src/test/java/spoon/test/ctClass/CtClassTest.java\n+++ b/src/test/java/spoon/test/ctClass/CtClassTest.java\n\n@@ -83,22 +83,32 @@ public class CtClassTest {\n \t\ttypeStringArrayArray.setComponentType(typeStringArray);\n \t\tconstructor = foo.getConstructor(typeStringArrayArray);\n \t\tassertEquals(typeStringArrayArray, constructor.getParameters().get(0).getType());\n-\n \t\t// contract: one could add a type member that already exists (equals but not same) and modify it afterwards\n \t\t// this adds some flexibility for client code\n \t\t// see https://github.com/INRIA/spoon/issues/1862\n \t\tCtConstructor cons = foo.getConstructors().toArray(new CtConstructor[0])[0].clone();\n \t\tfoo.addConstructor(cons);\n+\t\tint position = foo.getTypeMembers().indexOf(cons);\n+\t\tSystem.out.println(position);\n \t\t// as long as we have not changed the signature, getConstructors, which is based on signatures,\n \t\t// thinks there is one single constructor (and that's OK)\n \t\tassertEquals(3, foo.getConstructors().size());\n \t\tcons.addParameter(cons.getFactory().createParameter().setType(cons.getFactory().Type().OBJECT));\n \t\t// now that we have changed the signature we can call getConstructors safely\n \t\tassertEquals(4, foo.getConstructors().size());\n-\n+\t\t// we cloned the first constructor, so it has the same position, and comes before the 2nd and 3rd constructor\n+\t\tassertSame(cons, foo.getTypeMembers().get(position));\n \t\t// the parent is set (the core problem described in the issue has been fixed)\n \t\tassertSame(foo, cons.getParent());\n \n+\t\t// now we clone and reset the position\n+\t\tCtConstructor cons2 = foo.getConstructors().toArray(new CtConstructor[0])[0].clone();\n+\t\tcons2.setPosition(null);\n+\t\t// adding the constructor, this time, without a position\n+\t\tfoo.addConstructor(cons2);\n+\t\t// without position, it has been addded at the end\n+\t\tassertSame(cons2, foo.getTypeMembers().get(4));\n+\n \t}\n \n \t@Test\n"}}, {"oid": "34df6296a2b1785b3b50372259def1bec30a8c71", "url": "https://github.com/INRIA/spoon/commit/34df6296a2b1785b3b50372259def1bec30a8c71", "message": "readd assertion", "committedDate": "2020-08-17T13:56:35Z", "type": "commit"}, {"oid": "610bd849c048f229cd0871dbdca6b45aa070efcd", "url": "https://github.com/INRIA/spoon/commit/610bd849c048f229cd0871dbdca6b45aa070efcd", "message": "Update CtClassTest.java\n\nremove sysout", "committedDate": "2020-08-17T19:15:13Z", "type": "commit"}]}