{"pr_number": 5146, "pr_title": "Issue 5140: Ensure ControllerResolverFactory ensure the scheduled task is interrupted during shutdown.", "pr_createdAt": "2020-09-05T13:25:36Z", "pr_url": "https://github.com/pravega/pravega/pull/5146", "timeline": [{"oid": "1648e6d018daf565787c8f42707ebd88d2eafefa", "url": "https://github.com/pravega/pravega/commit/1648e6d018daf565787c8f42707ebd88d2eafefa", "message": "Ensure the scheduled Future is cancelled.\n\nSigned-off-by: Sandeep <sandeep.shridhar@emc.com>", "committedDate": "2020-09-05T13:22:14Z", "type": "commit"}, {"oid": "f44465ab46a44dc917ef2ada7339ac9cb6232dd1", "url": "https://github.com/pravega/pravega/commit/f44465ab46a44dc917ef2ada7339ac9cb6232dd1", "message": "Ensure watermarking threads are not closed.\n\nSigned-off-by: Sandeep <sandeep.shridhar@emc.com>", "committedDate": "2020-09-06T09:48:58Z", "type": "commit"}, {"oid": "f44465ab46a44dc917ef2ada7339ac9cb6232dd1", "url": "https://github.com/pravega/pravega/commit/f44465ab46a44dc917ef2ada7339ac9cb6232dd1", "message": "Ensure watermarking threads are not closed.\n\nSigned-off-by: Sandeep <sandeep.shridhar@emc.com>", "committedDate": "2020-09-06T09:48:58Z", "type": "forcePushed"}, {"oid": "4035f9d989abbe87b84c1530272d974a80833f62", "url": "https://github.com/pravega/pravega/commit/4035f9d989abbe87b84c1530272d974a80833f62", "message": "fix possible race.\n\nSigned-off-by: Sandeep <sandeep.shridhar@emc.com>", "committedDate": "2020-09-06T15:06:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDE4OTg4Nw==", "url": "https://github.com/pravega/pravega/pull/5146#discussion_r484189887", "bodyText": "Should the get and set separated out here?\n\nThis method returns if get stop returns true.\nSet is called after the callback is complete, using compareAndSet(false, true).\n\nThis might be especially useful if `callback.connectionDropped() can fail with an exception.\nOn the other hand, if the failure of connectionDropped() call can be safely discounted, the existing code'd be OK.", "author": "ravisharda", "createdAt": "2020-09-07T05:28:48Z", "path": "client/src/main/java/io/pravega/client/connection/impl/TcpClientConnection.java", "diffHunk": "@@ -159,7 +159,9 @@ static WireCommand readCommand(InputStream in, IoBuffer buffer) throws IOExcepti\n         }\n         \n         public void stop() {\n-            stop.set(true);\n+            if (stop.getAndSet(true)) {", "originalCommit": "4035f9d989abbe87b84c1530272d974a80833f62", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDIwMjY1Ng==", "url": "https://github.com/pravega/pravega/pull/5146#discussion_r484202656", "bodyText": "yeah, the idea is to ensure that we do not stop and already stopped/closed connection.", "author": "shrids", "createdAt": "2020-09-07T06:14:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDE4OTg4Nw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDE5MDQyMw==", "url": "https://github.com/pravega/pravega/pull/5146#discussion_r484190423", "bodyText": "Why is this change required? My reading from the code in the method is that it shouldn't be necessary to do this.", "author": "ravisharda", "createdAt": "2020-09-07T05:31:03Z", "path": "client/src/main/java/io/pravega/client/connection/impl/ConnectionPoolImpl.java", "diffHunk": "@@ -186,6 +186,7 @@ public void pruneUnusedConnections() {\n     }\n \n     @Override\n+    @Synchronized", "originalCommit": "4035f9d989abbe87b84c1530272d974a80833f62", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDIyMzM3NQ==", "url": "https://github.com/pravega/pravega/pull/5146#discussion_r484223375", "bodyText": "Yeah, there can be a getClientConnection() invocation which would update the map after a connection creation while this close() method is invoked.", "author": "shrids", "createdAt": "2020-09-07T07:07:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDE5MDQyMw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDE5MTMwNw==", "url": "https://github.com/pravega/pravega/pull/5146#discussion_r484191307", "bodyText": "nit: There is no timeout duration specified, unlike what the comment suggests. This comment might be referring on the default value used in the shutdown method. If someone changes that value, this comment would go stale. It might be useful rather to say something like Wait for default timeout duration before...", "author": "ravisharda", "createdAt": "2020-09-07T05:34:52Z", "path": "client/src/main/java/io/pravega/client/stream/impl/ClientFactoryImpl.java", "diffHunk": "@@ -244,8 +244,10 @@ private Segment getSegmentForRevisionedClient(String scope, String streamName) {\n \n     @Override\n     public void close() {\n-        controller.close();\n+        // wait for 5 seconds before forcibly terminating the watermarkReader threads.\n+        ExecutorServiceHelpers.shutdown(watermarkReaderThreads);", "originalCommit": "4035f9d989abbe87b84c1530272d974a80833f62", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDIwMjk3MQ==", "url": "https://github.com/pravega/pravega/pull/5146#discussion_r484202971", "bodyText": "updated it.", "author": "shrids", "createdAt": "2020-09-07T06:15:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDE5MTMwNw=="}], "type": "inlineReview", "revised_code": {"commit": "0794f79881c54aab8395b2015eb28ac12dae9ded", "chunk": "diff --git a/client/src/main/java/io/pravega/client/stream/impl/ClientFactoryImpl.java b/client/src/main/java/io/pravega/client/stream/impl/ClientFactoryImpl.java\nindex 0dc28a423..5d500bc4c 100644\n--- a/client/src/main/java/io/pravega/client/stream/impl/ClientFactoryImpl.java\n+++ b/client/src/main/java/io/pravega/client/stream/impl/ClientFactoryImpl.java\n\n@@ -244,7 +244,7 @@ public class ClientFactoryImpl extends AbstractClientFactoryImpl implements Even\n \n     @Override\n     public void close() {\n-        // wait for 5 seconds before forcibly terminating the watermarkReader threads.\n+        // wait for default timeout duration before forcibly terminating the watermarkReader threads.\n         ExecutorServiceHelpers.shutdown(watermarkReaderThreads);\n         connectionPool.close();\n         controller.close();\n"}}, {"oid": "0794f79881c54aab8395b2015eb28ac12dae9ded", "url": "https://github.com/pravega/pravega/commit/0794f79881c54aab8395b2015eb28ac12dae9ded", "message": "CR CHanges: updated the comment.\n\nSigned-off-by: Sandeep <sandeep.shridhar@emc.com>", "committedDate": "2020-09-07T07:08:14Z", "type": "commit"}, {"oid": "6d1e5133087cb630804721f615afe9beab5a7025", "url": "https://github.com/pravega/pravega/commit/6d1e5133087cb630804721f615afe9beab5a7025", "message": "Merge branch 'master' into issue-5140", "committedDate": "2020-09-07T12:04:32Z", "type": "commit"}, {"oid": "58e09aef8a10b82bfb2878ee95f75609d6e65163", "url": "https://github.com/pravega/pravega/commit/58e09aef8a10b82bfb2878ee95f75609d6e65163", "message": "Merge branch 'master' into issue-5140", "committedDate": "2020-09-08T04:08:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTAyMDUxOA==", "url": "https://github.com/pravega/pravega/pull/5146#discussion_r485020518", "bodyText": "FYI, this has no effect. It is not implemented in the JRE.", "author": "andreipaduroiu", "createdAt": "2020-09-08T15:44:02Z", "path": "client/src/main/java/io/pravega/client/control/impl/ControllerResolverFactory.java", "diffHunk": "@@ -201,7 +201,7 @@ public void start(Listener listener) {\n         public void shutdown() {\n             shutdown = true;\n             if (scheduledFuture != null) {\n-                scheduledFuture.cancel(false);\n+                scheduledFuture.cancel(true);", "originalCommit": "58e09aef8a10b82bfb2878ee95f75609d6e65163", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTMwNTg3MA==", "url": "https://github.com/pravega/pravega/pull/5146#discussion_r485305870", "bodyText": "This is a ScheduledFuture on which cancel() is invoked.\n public ScheduledFuture<?> schedule(Runnable command, long delay, TimeUnit unit);\nAs I understand your comment applies only on a CompletableFuture. let me know...", "author": "shrids", "createdAt": "2020-09-09T02:50:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTAyMDUxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTY5MDk1Ng==", "url": "https://github.com/pravega/pravega/pull/5146#discussion_r485690956", "bodyText": "Ah I missed that one. Nevermind then :)", "author": "andreipaduroiu", "createdAt": "2020-09-09T15:12:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTAyMDUxOA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "fff8044ab442703e773a5b51f034712054d3d0f1", "url": "https://github.com/pravega/pravega/commit/fff8044ab442703e773a5b51f034712054d3d0f1", "message": "Merge branch 'master' into issue-5140", "committedDate": "2020-09-08T15:48:06Z", "type": "commit"}, {"oid": "425c792527bfa7bc5e98d7d4a456cf64021d84aa", "url": "https://github.com/pravega/pravega/commit/425c792527bfa7bc5e98d7d4a456cf64021d84aa", "message": "Merge branch 'master' into issue-5140", "committedDate": "2020-09-10T03:10:59Z", "type": "commit"}]}