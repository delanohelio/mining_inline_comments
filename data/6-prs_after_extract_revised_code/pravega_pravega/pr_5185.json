{"pr_number": 5185, "pr_title": "Issue 5188: Improve RawClient exception handling.", "pr_createdAt": "2020-09-14T14:40:48Z", "pr_url": "https://github.com/pravega/pravega/pull/5185", "timeline": [{"oid": "0281c1d171e0e8b97a2d159ad60a881e12dca912", "url": "https://github.com/pravega/pravega/commit/0281c1d171e0e8b97a2d159ad60a881e12dca912", "message": "Improve exception handling.\n\nSigned-off-by: Sandeep <sandeep.shridhar@emc.com>", "committedDate": "2020-09-14T14:27:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODAxNDQ2Mg==", "url": "https://github.com/pravega/pravega/pull/5185#discussion_r488014462", "bodyText": "we should al least keep a reference to e as \"cause\" of the ConnectionFailedException\notherwise we are simply \"masking\" any error with ConnectionFailedException\nNot sure how we are dealing with special exceptions like InterruptedException", "author": "eolivelli", "createdAt": "2020-09-14T15:17:15Z", "path": "client/src/main/java/io/pravega/client/connection/impl/RawClient.java", "diffHunk": "@@ -87,16 +88,22 @@ public void authTokenCheckFailed(WireCommands.AuthTokenCheckFailed authTokenChec\n         }\n     }\n \n-    public RawClient(PravegaNodeUri uri, ConnectionPool connectonPool) {\n+    public RawClient(PravegaNodeUri uri, ConnectionPool connectionPool) {\n         this.segmentId = null;\n-        this.connection = connectonPool.getClientConnection(flow, uri, responseProcessor);\n+        this.connection = connectionPool.getClientConnection(flow, uri, responseProcessor)\n+        .exceptionally(e -> {\n+            throw new CompletionException(new ConnectionFailedException(\"Failed to obtain client connection to segment \" + segmentId.getScopedName()));", "originalCommit": "0281c1d171e0e8b97a2d159ad60a881e12dca912", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMwODk4MA==", "url": "https://github.com/pravega/pravega/pull/5185#discussion_r488308980", "bodyText": "It's not a blocking call, so we shouldn't have to worry about Interrupted.", "author": "tkaitchuck", "createdAt": "2020-09-15T00:21:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODAxNDQ2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODM5NjgxNg==", "url": "https://github.com/pravega/pravega/pull/5185#discussion_r488396816", "bodyText": "improved it.", "author": "shrids", "createdAt": "2020-09-15T05:36:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODAxNDQ2Mg=="}], "type": "inlineReview", "revised_code": {"commit": "0e2328587327d6bbc508df051e2be7b0736391dc", "chunk": "diff --git a/client/src/main/java/io/pravega/client/connection/impl/RawClient.java b/client/src/main/java/io/pravega/client/connection/impl/RawClient.java\nindex 116b663208..f5cd44ad09 100644\n--- a/client/src/main/java/io/pravega/client/connection/impl/RawClient.java\n+++ b/client/src/main/java/io/pravega/client/connection/impl/RawClient.java\n\n@@ -92,7 +92,8 @@ public class RawClient implements AutoCloseable {\n         this.segmentId = null;\n         this.connection = connectionPool.getClientConnection(flow, uri, responseProcessor)\n         .exceptionally(e -> {\n-            throw new CompletionException(new ConnectionFailedException(\"Failed to obtain client connection to segment \" + segmentId.getScopedName()));\n+            log.warn(\"Exception observed while attempting to obtain a connection to segment store {}\", uri, e);\n+            throw new CompletionException(new ConnectionFailedException(\"Failed to obtain client connection to  \" + uri));\n         });\n         Futures.exceptionListener(connection, e -> closeConnection(e));\n     }\n"}}, {"oid": "0e2328587327d6bbc508df051e2be7b0736391dc", "url": "https://github.com/pravega/pravega/commit/0e2328587327d6bbc508df051e2be7b0736391dc", "message": "Improve exception handling.\n\nSigned-off-by: Sandeep <sandeep.shridhar@emc.com>", "committedDate": "2020-09-15T05:29:11Z", "type": "commit"}, {"oid": "f4800eb7ba3c70afb0e45d7ca83ad20d3abdcf0b", "url": "https://github.com/pravega/pravega/commit/f4800eb7ba3c70afb0e45d7ca83ad20d3abdcf0b", "message": "Merge branch 'master' into issue-rawclient-exceptionHandling", "committedDate": "2020-09-15T05:48:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODQwNDY5Mw==", "url": "https://github.com/pravega/pravega/pull/5185#discussion_r488404693", "bodyText": "I would add 'e' as cause", "author": "eolivelli", "createdAt": "2020-09-15T05:58:47Z", "path": "client/src/main/java/io/pravega/client/connection/impl/RawClient.java", "diffHunk": "@@ -87,16 +88,24 @@ public void authTokenCheckFailed(WireCommands.AuthTokenCheckFailed authTokenChec\n         }\n     }\n \n-    public RawClient(PravegaNodeUri uri, ConnectionPool connectonPool) {\n+    public RawClient(PravegaNodeUri uri, ConnectionPool connectionPool) {\n         this.segmentId = null;\n-        this.connection = connectonPool.getClientConnection(flow, uri, responseProcessor);\n+        this.connection = connectionPool.getClientConnection(flow, uri, responseProcessor)\n+        .exceptionally(e -> {\n+            log.warn(\"Exception observed while attempting to obtain a connection to segment store {}\", uri, e);\n+            throw new CompletionException(new ConnectionFailedException(\"Failed to obtain client connection to  \" + uri));", "originalCommit": "f4800eb7ba3c70afb0e45d7ca83ad20d3abdcf0b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODQwNjUyOA==", "url": "https://github.com/pravega/pravega/pull/5185#discussion_r488406528", "bodyText": "done. ( i was about to push that change :D )", "author": "shrids", "createdAt": "2020-09-15T06:03:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODQwNDY5Mw=="}], "type": "inlineReview", "revised_code": {"commit": "5dc9ef3c228f58371feb56e27e530dec9937ac23", "chunk": "diff --git a/client/src/main/java/io/pravega/client/connection/impl/RawClient.java b/client/src/main/java/io/pravega/client/connection/impl/RawClient.java\nindex f5cd44ad09..c3de025713 100644\n--- a/client/src/main/java/io/pravega/client/connection/impl/RawClient.java\n+++ b/client/src/main/java/io/pravega/client/connection/impl/RawClient.java\n\n@@ -93,7 +93,7 @@ public class RawClient implements AutoCloseable {\n         this.connection = connectionPool.getClientConnection(flow, uri, responseProcessor)\n         .exceptionally(e -> {\n             log.warn(\"Exception observed while attempting to obtain a connection to segment store {}\", uri, e);\n-            throw new CompletionException(new ConnectionFailedException(\"Failed to obtain client connection to  \" + uri));\n+            throw new CompletionException(new ConnectionFailedException(e));\n         });\n         Futures.exceptionListener(connection, e -> closeConnection(e));\n     }\n"}}, {"oid": "5dc9ef3c228f58371feb56e27e530dec9937ac23", "url": "https://github.com/pravega/pravega/commit/5dc9ef3c228f58371feb56e27e530dec9937ac23", "message": "pass exeption.\n\nSigned-off-by: Sandeep <sandeep.shridhar@emc.com>", "committedDate": "2020-09-15T06:02:18Z", "type": "commit"}, {"oid": "04b5f773fb52b1f7a83a9ac02cb06b8d31c70b1d", "url": "https://github.com/pravega/pravega/commit/04b5f773fb52b1f7a83a9ac02cb06b8d31c70b1d", "message": "Improve ConditionalOutputStream\n\nSigned-off-by: Sandeep <sandeep.shridhar@emc.com>", "committedDate": "2020-09-15T07:24:00Z", "type": "commit"}, {"oid": "e37c9514e9b324a554b156dbd5f688b15df29617", "url": "https://github.com/pravega/pravega/commit/e37c9514e9b324a554b156dbd5f688b15df29617", "message": "Fix flaky integration test.\n\nSigned-off-by: Sandeep <sandeep.shridhar@emc.com>", "committedDate": "2020-09-15T11:00:04Z", "type": "commit"}]}