{"pr_number": 5422, "pr_title": "Issue 5421: Avoid closing pre-existing metrics.", "pr_createdAt": "2020-12-11T01:10:58Z", "pr_url": "https://github.com/pravega/pravega/pull/5422", "timeline": [{"oid": "76a81ee9a75a0d6b50d36e1be2fa28366244483a", "url": "https://github.com/pravega/pravega/commit/76a81ee9a75a0d6b50d36e1be2fa28366244483a", "message": "Testing changes to fix Jenkins name resolution problem.\n\nSigned-off-by: Ra\u00fal Gracia <raul.gracia@emc.com>", "committedDate": "2020-10-16T15:32:54Z", "type": "commit"}, {"oid": "7d773a263dcc3db971355e77116c796a15307fd6", "url": "https://github.com/pravega/pravega/commit/7d773a263dcc3db971355e77116c796a15307fd6", "message": "Fix checkstyle.\n\nSigned-off-by: Ra\u00fal Gracia <raul.gracia@emc.com>", "committedDate": "2020-10-16T18:20:25Z", "type": "commit"}, {"oid": "2d09f4947f38844ebf526dc01c572a3374b42f17", "url": "https://github.com/pravega/pravega/commit/2d09f4947f38844ebf526dc01c572a3374b42f17", "message": "Try using loopback address.\n\nSigned-off-by: Ra\u00fal Gracia <raul.gracia@emc.com>", "committedDate": "2020-10-19T08:07:09Z", "type": "commit"}, {"oid": "538f6b066515763bdb348e13718ab2630f4e28ea", "url": "https://github.com/pravega/pravega/commit/538f6b066515763bdb348e13718ab2630f4e28ea", "message": "Use InetAddress to set Bookie advertised address.\n\nSigned-off-by: Ra\u00fal Gracia <raul.gracia@emc.com>", "committedDate": "2020-10-21T14:57:37Z", "type": "commit"}, {"oid": "3cd5e3fa649da33121ae112c707b01ee55111076", "url": "https://github.com/pravega/pravega/commit/3cd5e3fa649da33121ae112c707b01ee55111076", "message": "Merge branch 'master' of https://github.com/pravega/pravega into upstream-master\n\n\u0001 Conflicts:\n\u0001\tcli/admin/src/test/java/io/pravega/cli/admin/bookkeeper/BookkeeperCommandsTest.java", "committedDate": "2020-11-13T00:11:29Z", "type": "commit"}, {"oid": "56a89f46895e38e479f4471046ef5e973819fbb5", "url": "https://github.com/pravega/pravega/commit/56a89f46895e38e479f4471046ef5e973819fbb5", "message": "Merge branch 'master' of https://github.com/pravega/pravega into upstream-master", "committedDate": "2020-12-08T20:55:13Z", "type": "commit"}, {"oid": "81196167cc0c3c6b23b7307c9d7736851fdf7b17", "url": "https://github.com/pravega/pravega/commit/81196167cc0c3c6b23b7307c9d7736851fdf7b17", "message": "Merge branch 'master' of https://github.com/pravega/pravega into upstream-master", "committedDate": "2020-12-11T00:50:28Z", "type": "commit"}, {"oid": "78b85fba4ba604d82a8b7cd34efa9c59f54dcda7", "url": "https://github.com/pravega/pravega/commit/78b85fba4ba604d82a8b7cd34efa9c59f54dcda7", "message": "Fix `getOrSet` prematurely closing a valid Meter.\n\nSigned-off-by: co-jo <colin.hryniowski@dell.com>", "committedDate": "2020-12-11T00:57:16Z", "type": "commit"}, {"oid": "153b1f42ffb40418b1bd5b8d3036aa9b6cdd65bf", "url": "https://github.com/pravega/pravega/commit/153b1f42ffb40418b1bd5b8d3036aa9b6cdd65bf", "message": "Add back comment.\n\nSigned-off-by: co-jo <colin.hryniowski@dell.com>", "committedDate": "2020-12-11T00:59:02Z", "type": "commit"}, {"oid": "1f50ecd1e899e5b4909656411620ba35f1769b11", "url": "https://github.com/pravega/pravega/commit/1f50ecd1e899e5b4909656411620ba35f1769b11", "message": "Make `getOrSet` atomic.\nAdd exception to concurrent closure of a proxy.\n\nSigned-off-by: co-jo <colin.hryniowski@dell.com>", "committedDate": "2020-12-11T19:33:30Z", "type": "commit"}, {"oid": "5bb2a5af3dfc9b019b446841974ed82231e8a4ea", "url": "https://github.com/pravega/pravega/commit/5bb2a5af3dfc9b019b446841974ed82231e8a4ea", "message": "Remove concatenated string.\n\nSigned-off-by: co-jo <colin.hryniowski@dell.com>", "committedDate": "2020-12-11T19:43:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTIxNzY1Ng==", "url": "https://github.com/pravega/pravega/pull/5422#discussion_r541217656", "bodyText": "The expected argument has been changed because before the expectation that was we would still create the Metric and add it to the metrics array, but just immediately mark it as closed. Now we just avoid that creation step completely (if it exists).", "author": "co-jo", "createdAt": "2020-12-11T19:50:57Z", "path": "shared/metrics/src/test/java/io/pravega/shared/metrics/StatsLoggerProxyTest.java", "diffHunk": "@@ -67,23 +67,20 @@ public void testGetOrCreate() {\n         createMetrics(proxy, \"\", \"hostname\", \"localhost\");\n         Assert.assertEquals(\"Unexpected number of metrics registered initially.\", METRIC_COUNT * 2, metrics.size());\n \n-        // Re-create/request the same metrics. Verify the original ones have not been touched, but we did create (and close)\n-        // a new set.\n+        // Re-create/request the same metrics. Verify the original ones have not been touched.\n         createMetrics(proxy, \"\");\n-        Assert.assertEquals(\"Unexpected number of metrics registered after re-registering same names.\", 3 * METRIC_COUNT, metrics.size());\n+        Assert.assertEquals(\"Unexpected number of metrics registered after re-registering same names.\", 2 * METRIC_COUNT, metrics.size());", "originalCommit": "1f50ecd1e899e5b4909656411620ba35f1769b11", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "11b40e30c9cdd5500b3db16235f98cbb26423c10", "url": "https://github.com/pravega/pravega/commit/11b40e30c9cdd5500b3db16235f98cbb26423c10", "message": "Merge branch 'master' into issue-5323-metrics-fix", "committedDate": "2020-12-11T21:33:01Z", "type": "commit"}, {"oid": "2f12b522374defdae870ce3ee9b98f30f1c45be1", "url": "https://github.com/pravega/pravega/commit/2f12b522374defdae870ce3ee9b98f30f1c45be1", "message": "Merge remote-tracking branch 'origin/issue-5323-metrics-fix' into issue-5323-metrics-fix", "committedDate": "2020-12-11T22:12:42Z", "type": "commit"}, {"oid": "968aa96298956edaa5493a50b4b708beda483b8d", "url": "https://github.com/pravega/pravega/commit/968aa96298956edaa5493a50b4b708beda483b8d", "message": "Use Preconditions.\n\nSigned-off-by: co-jo <colin.hryniowski@dell.com>", "committedDate": "2020-12-11T22:15:13Z", "type": "commit"}, {"oid": "80b61352d8bc781e35a9677802d9f36d0dd6aca7", "url": "https://github.com/pravega/pravega/commit/80b61352d8bc781e35a9677802d9f36d0dd6aca7", "message": "Fix the close method so the protected instance request does not have to validate via preconditions.\n\nSigned-off-by: co-jo <colin.hryniowski@dell.com>", "committedDate": "2020-12-12T01:10:44Z", "type": "commit"}, {"oid": "3ddf34a5d254ce333bb7747cadc79a9bef610b57", "url": "https://github.com/pravega/pravega/commit/3ddf34a5d254ce333bb7747cadc79a9bef610b57", "message": "Merge branch 'master' into issue-5323-metrics-fix", "committedDate": "2020-12-14T19:19:10Z", "type": "commit"}, {"oid": "bcf9e268076b12535d103ed2fe16680b37c98464", "url": "https://github.com/pravega/pravega/commit/bcf9e268076b12535d103ed2fe16680b37c98464", "message": "Merge branch 'master' into issue-5323-metrics-fix", "committedDate": "2020-12-15T08:15:33Z", "type": "commit"}, {"oid": "df2cded6afbbe6ad9b1594088c98c7a492cf2d92", "url": "https://github.com/pravega/pravega/commit/df2cded6afbbe6ad9b1594088c98c7a492cf2d92", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5323-metrics-fix", "committedDate": "2020-12-15T18:42:05Z", "type": "commit"}, {"oid": "a4063fc6307bab68ec6bfc0739d2d074424a325b", "url": "https://github.com/pravega/pravega/commit/a4063fc6307bab68ec6bfc0739d2d074424a325b", "message": "Relax the `Preconditions` check to a warning log.\n\nSigned-off-by: co-jo <colin.hryniowski@dell.com>", "committedDate": "2020-12-15T19:00:24Z", "type": "commit"}, {"oid": "39796cea559cb264acb6fd8620cbecab8b992183", "url": "https://github.com/pravega/pravega/commit/39796cea559cb264acb6fd8620cbecab8b992183", "message": "Merge remote-tracking branch 'origin/issue-5323-metrics-fix' into issue-5323-metrics-fix", "committedDate": "2020-12-15T19:01:54Z", "type": "commit"}, {"oid": "8361e0b039c30b487c37aaaa376a985c69d1fee1", "url": "https://github.com/pravega/pravega/commit/8361e0b039c30b487c37aaaa376a985c69d1fee1", "message": "Remove newline.\n\nSigned-off-by: co-jo <colin.hryniowski@dell.com>", "committedDate": "2020-12-15T19:02:32Z", "type": "commit"}, {"oid": "feab3e1315f0ebc40091eddfdaef57bb65ebfcbe", "url": "https://github.com/pravega/pravega/commit/feab3e1315f0ebc40091eddfdaef57bb65ebfcbe", "message": "Removed new line changed codecov?\n\nSigned-off-by: co-jo <colin.hryniowski@dell.com>", "committedDate": "2020-12-16T18:24:18Z", "type": "commit"}, {"oid": "7cdd1d50c5f621002c47f0fdcd9d2779fbba5067", "url": "https://github.com/pravega/pravega/commit/7cdd1d50c5f621002c47f0fdcd9d2779fbba5067", "message": "Merge branch 'master' into issue-5323-metrics-fix", "committedDate": "2020-12-16T22:13:39Z", "type": "commit"}, {"oid": "74da356bdeafd3c519ebb9c1ce135251c3d8254d", "url": "https://github.com/pravega/pravega/commit/74da356bdeafd3c519ebb9c1ce135251c3d8254d", "message": "A MetricProxy test to ensure the close method is only executed once.\n\nSigned-off-by: co-jo <colin.hryniowski@dell.com>", "committedDate": "2020-12-16T22:53:56Z", "type": "commit"}, {"oid": "955c55c52157becd1441206a961d5f2c77e5b75d", "url": "https://github.com/pravega/pravega/commit/955c55c52157becd1441206a961d5f2c77e5b75d", "message": "Merge remote-tracking branch 'origin/issue-5323-metrics-fix' into issue-5323-metrics-fix", "committedDate": "2020-12-16T22:54:08Z", "type": "commit"}, {"oid": "750f22afe74d29542eb80f6003fae8ae81dec29d", "url": "https://github.com/pravega/pravega/commit/750f22afe74d29542eb80f6003fae8ae81dec29d", "message": "Merge branch 'master' into issue-5323-metrics-fix", "committedDate": "2020-12-17T08:24:33Z", "type": "commit"}]}