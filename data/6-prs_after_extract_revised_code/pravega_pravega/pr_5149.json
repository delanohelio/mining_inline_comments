{"pr_number": 5149, "pr_title": "Issue 5002: Delete scope api with delete streams flag ", "pr_createdAt": "2020-09-07T03:10:30Z", "pr_url": "https://github.com/pravega/pravega/pull/5149", "timeline": [{"oid": "ae2cd4a2ce8b0768c6ec497fc7680b989a3ec7f7", "url": "https://github.com/pravega/pravega/commit/ae2cd4a2ce8b0768c6ec497fc7680b989a3ec7f7", "message": "Issue 5002: Delete scope api with delete streams flag\n\nSigned-off-by: Shivesh Ranjan <shivesh.ranjan@gmail.com>", "committedDate": "2020-09-07T03:03:35Z", "type": "commit"}, {"oid": "4c95f498fe69343993fea7d0ffd321a74dfb6644", "url": "https://github.com/pravega/pravega/commit/4c95f498fe69343993fea7d0ffd321a74dfb6644", "message": "Javadoc\n\nSigned-off-by: Shivesh Ranjan <shivesh.ranjan@gmail.com>", "committedDate": "2020-09-07T03:09:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDE2MzYyOQ==", "url": "https://github.com/pravega/pravega/pull/5149#discussion_r484163629", "bodyText": "If a \"seal\" or \"deleteStream\" operation fails for a single stream should'nt we continue deleting the other streams?", "author": "shrids", "createdAt": "2020-09-07T03:19:35Z", "path": "client/src/main/java/io/pravega/client/admin/impl/StreamManagerImpl.java", "diffHunk": "@@ -141,12 +141,27 @@ public boolean checkStreamExists(String scopeName, String streamName) {\n     }\n \n     @Override\n+    @Deprecated\n     public boolean deleteScope(String scopeName) {\n+        return deleteScope(scopeName, false);\n+    }\n+\n+    @Override\n+    public boolean deleteScope(String scopeName, boolean deleteStreams) {\n         NameUtils.validateUserScopeName(scopeName);\n         log.info(\"Deleting scope: {}\", scopeName);\n-        return  Futures.getThrowingException(controller.deleteScope(scopeName));\n+        \n+        if (deleteStreams) {\n+            Iterator<Stream> iterator = listStreams(scopeName);\n+            while (iterator.hasNext()) {\n+                Stream stream = iterator.next();\n+                Futures.getThrowingException(controller.sealStream(stream.getScope(), stream.getStreamName()));", "originalCommit": "4c95f498fe69343993fea7d0ffd321a74dfb6644", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDE3NjI3Ng==", "url": "https://github.com/pravega/pravega/pull/5149#discussion_r484176276", "bodyText": "Well, even if we opportunistically delete other streams, the scope can not be deleted if a single stream's seal and delete failed. So we should throw the error back to the user so that they can decide on how to handle it.\na subsequent attempt to delete the scope using this api will iterate over all available streams and attemp to delete them.", "author": "shiveshr", "createdAt": "2020-09-07T04:26:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDE2MzYyOQ=="}], "type": "inlineReview", "revised_code": {"commit": "5fd3931311575a3e5c8b978b75b431542b62cc24", "chunk": "diff --git a/client/src/main/java/io/pravega/client/admin/impl/StreamManagerImpl.java b/client/src/main/java/io/pravega/client/admin/impl/StreamManagerImpl.java\nindex d94b31c9e3..0633b27fc4 100644\n--- a/client/src/main/java/io/pravega/client/admin/impl/StreamManagerImpl.java\n+++ b/client/src/main/java/io/pravega/client/admin/impl/StreamManagerImpl.java\n\n@@ -150,12 +153,13 @@ public class StreamManagerImpl implements StreamManager {\n     public boolean deleteScope(String scopeName, boolean deleteStreams) {\n         NameUtils.validateUserScopeName(scopeName);\n         log.info(\"Deleting scope: {}\", scopeName);\n-        \n         if (deleteStreams) {\n             Iterator<Stream> iterator = listStreams(scopeName);\n             while (iterator.hasNext()) {\n                 Stream stream = iterator.next();\n-                Futures.getThrowingException(controller.sealStream(stream.getScope(), stream.getStreamName()));\n+                // If the stream was removed by another request while we attempted to seal it, we could get InvalidStreamException. \n+                Futures.getThrowingException(Futures.exceptionallyExpecting(controller.sealStream(stream.getScope(), stream.getStreamName()),\n+                          e -> Exceptions.unwrap(e) instanceof InvalidStreamException, null));\n                 Futures.getThrowingException(controller.deleteStream(stream.getScope(), stream.getStreamName()));\n             }\n         }\n"}}, {"oid": "5fd3931311575a3e5c8b978b75b431542b62cc24", "url": "https://github.com/pravega/pravega/commit/5fd3931311575a3e5c8b978b75b431542b62cc24", "message": "Add retry for seal\n\nSigned-off-by: Shivesh Ranjan <shivesh.ranjan@gmail.com>", "committedDate": "2020-09-07T04:24:16Z", "type": "commit"}, {"oid": "c5d0dec65710804f695d00ee4079f4c1313b81c3", "url": "https://github.com/pravega/pravega/commit/c5d0dec65710804f695d00ee4079f4c1313b81c3", "message": "Merge branch 'master' into issue-5002", "committedDate": "2020-09-07T05:28:45Z", "type": "commit"}, {"oid": "8d0386dd5a4e50d6cbc4af3ac6b455800ad4feb0", "url": "https://github.com/pravega/pravega/commit/8d0386dd5a4e50d6cbc4af3ac6b455800ad4feb0", "message": "remove deprecated\n\nSigned-off-by: Shivesh Ranjan <shivesh.ranjan@gmail.com>", "committedDate": "2020-09-07T06:33:40Z", "type": "commit"}, {"oid": "2b671af8fff05c8f7de7b77378803957c0465c0a", "url": "https://github.com/pravega/pravega/commit/2b671af8fff05c8f7de7b77378803957c0465c0a", "message": "Merge branch 'issue-5002' of https://github.com/shiveshr/pravega-1 into issue-5002", "committedDate": "2020-09-07T06:34:07Z", "type": "commit"}, {"oid": "6f908c96dce6749f0e3c8aacd42a8dcaede0b610", "url": "https://github.com/pravega/pravega/commit/6f908c96dce6749f0e3c8aacd42a8dcaede0b610", "message": "javadoc\n\nSigned-off-by: Shivesh Ranjan <shivesh.ranjan@gmail.com>", "committedDate": "2020-09-07T06:40:00Z", "type": "commit"}, {"oid": "37e2ed8002af37edaa683b39d24ba18350f39bff", "url": "https://github.com/pravega/pravega/commit/37e2ed8002af37edaa683b39d24ba18350f39bff", "message": "javadoc\n\nSigned-off-by: Shivesh Ranjan <shivesh.ranjan@gmail.com>", "committedDate": "2020-09-07T07:16:51Z", "type": "commit"}, {"oid": "508305032dbdf809fadb6464842ee489e36410e2", "url": "https://github.com/pravega/pravega/commit/508305032dbdf809fadb6464842ee489e36410e2", "message": "Merge branch 'master' into issue-5002", "committedDate": "2020-09-07T12:56:14Z", "type": "commit"}]}