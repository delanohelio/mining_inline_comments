{"pr_number": 5044, "pr_title": "Issue 4476: Truncate internal streams to reclaim storage space", "pr_createdAt": "2020-08-07T11:58:15Z", "pr_url": "https://github.com/pravega/pravega/pull/5044", "timeline": [{"oid": "c04e9440db3b350a303fb8cf767fe38665318bc4", "url": "https://github.com/pravega/pravega/commit/c04e9440db3b350a303fb8cf767fe38665318bc4", "message": "truncate internal streams\n\nSigned-off-by: Shivesh Ranjan <shivesh.ranjan@gmail.com>", "committedDate": "2020-08-07T11:34:53Z", "type": "commit"}, {"oid": "ad3ad9e6a71b1171c4c57ddad53ae192f7e22688", "url": "https://github.com/pravega/pravega/commit/ad3ad9e6a71b1171c4c57ddad53ae192f7e22688", "message": "Use 2 minute truncation interval\n\nSigned-off-by: Shivesh Ranjan <shivesh.ranjan@gmail.com>", "committedDate": "2020-08-07T12:00:58Z", "type": "commit"}, {"oid": "1719870dc643e74c0e607182f150f3ec35213cab", "url": "https://github.com/pravega/pravega/commit/1719870dc643e74c0e607182f150f3ec35213cab", "message": "checkstyle\n\nSigned-off-by: Shivesh Ranjan <shivesh.ranjan@gmail.com>", "committedDate": "2020-08-07T12:06:26Z", "type": "commit"}, {"oid": "15e488e28800c0e0fc91ce1fb39ec04edc709f86", "url": "https://github.com/pravega/pravega/commit/15e488e28800c0e0fc91ce1fb39ec04edc709f86", "message": "submit truncate stream job\n\nSigned-off-by: Shivesh Ranjan <shivesh.ranjan@gmail.com>", "committedDate": "2020-08-07T15:23:25Z", "type": "commit"}, {"oid": "89a5442ed3c6d59cd26cd1c01326e79a6f57e669", "url": "https://github.com/pravega/pravega/commit/89a5442ed3c6d59cd26cd1c01326e79a6f57e669", "message": "increase truncation interval\n\nSigned-off-by: Shivesh Ranjan <shivesh.ranjan@gmail.com>", "committedDate": "2020-08-07T15:31:10Z", "type": "commit"}, {"oid": "b6fd2a2055b9c4b1e132da1535b16a396bbd482f", "url": "https://github.com/pravega/pravega/commit/b6fd2a2055b9c4b1e132da1535b16a396bbd482f", "message": "Merge branch 'master' into issue4476", "committedDate": "2020-08-07T16:56:53Z", "type": "commit"}, {"oid": "f328b14569b4024fd6ded9b02e6e4a972b59b068", "url": "https://github.com/pravega/pravega/commit/f328b14569b4024fd6ded9b02e6e4a972b59b068", "message": "Merge branch 'master' into issue4476", "committedDate": "2020-08-08T04:42:53Z", "type": "commit"}, {"oid": "e7d779b21f8179af9b71e5740718da637311b54a", "url": "https://github.com/pravega/pravega/commit/e7d779b21f8179af9b71e5740718da637311b54a", "message": "coverage\n\nSigned-off-by: Shivesh Ranjan <shivesh.ranjan@gmail.com>", "committedDate": "2020-08-10T04:33:00Z", "type": "commit"}, {"oid": "a82dc4a35c74789e854624de50cd77befcb0adbe", "url": "https://github.com/pravega/pravega/commit/a82dc4a35c74789e854624de50cd77befcb0adbe", "message": "Merge branch 'issue4476' of https://github.com/shiveshr/pravega-1 into issue4476", "committedDate": "2020-08-10T04:33:45Z", "type": "commit"}, {"oid": "7cd7c83488c2ae8734eb25ac024833fec48852e4", "url": "https://github.com/pravega/pravega/commit/7cd7c83488c2ae8734eb25ac024833fec48852e4", "message": "checkstyle\n\nSigned-off-by: Shivesh Ranjan <shivesh.ranjan@gmail.com>", "committedDate": "2020-08-10T06:31:15Z", "type": "commit"}, {"oid": "14ca9d91ad5526d803c06403ba42063258c9a05d", "url": "https://github.com/pravega/pravega/commit/14ca9d91ad5526d803c06403ba42063258c9a05d", "message": "Merge branch 'master' into issue4476", "committedDate": "2020-08-13T14:34:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDAwMTI0MA==", "url": "https://github.com/pravega/pravega/pull/5044#discussion_r470001240", "bodyText": "You need to add a check inside truncate to verify if isRunning() == true. Otherwise we can stop this service, but since this still has a 10-second delay, it will execute one call of truncate and then cancel it. This may not be the intended behavior.", "author": "andreipaduroiu", "createdAt": "2020-08-13T14:37:52Z", "path": "controller/src/main/java/io/pravega/controller/server/eventProcessor/ControllerEventProcessors.java", "diffHunk": "@@ -288,9 +300,67 @@ public boolean isReady() {\n             streamMetadataTasks.initializeStreamWriters(clientFactory, config.getRequestStreamName());\n             streamTransactionMetadataTasks.initializeStreamWriters(clientFactory, config);\n             tableMetadataTasks.initializeStreamWriters(clientFactory, config.getKvtStreamName());\n+\n+            long delay = truncationInterval.get();\n+            Futures.loop(this::isRunning, () -> Futures.delayedFuture(", "originalCommit": "14ca9d91ad5526d803c06403ba42063258c9a05d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDA1ODg3OA==", "url": "https://github.com/pravega/pravega/pull/5044#discussion_r470058878", "bodyText": "Added a Precondition on truncate method.\nAlthough its not really going to cause any incorrect behaviour even if an extra truncation ran (and would run until the executor is shutdown or curator is shutdown), as it is equivalent to us being in the middle of truncation when the service shutdown.", "author": "shiveshr", "createdAt": "2020-08-13T16:00:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDAwMTI0MA=="}], "type": "inlineReview", "revised_code": {"commit": "802e70b11b9071f185db5c8a88cd46f898deb00d", "chunk": "diff --git a/controller/src/main/java/io/pravega/controller/server/eventProcessor/ControllerEventProcessors.java b/controller/src/main/java/io/pravega/controller/server/eventProcessor/ControllerEventProcessors.java\nindex 8964a53919..629c6abaff 100755\n--- a/controller/src/main/java/io/pravega/controller/server/eventProcessor/ControllerEventProcessors.java\n+++ b/controller/src/main/java/io/pravega/controller/server/eventProcessor/ControllerEventProcessors.java\n\n@@ -315,6 +316,7 @@ public class ControllerEventProcessors extends AbstractIdleService implements Fa\n \n     @VisibleForTesting\n     CompletableFuture<Void> truncate(String streamName, String readergroupName, StreamMetadataTasks streamMetadataTasks) {\n+        Preconditions.checkState(isRunning());\n         try {\n             // 1. get all processes from checkpoint store \n             // 2. get the all checkpoints for all readers in the readergroup for the stream.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDAwMTY1Nw==", "url": "https://github.com/pravega/pravega/pull/5044#discussion_r470001657", "bodyText": "Why don't you inherit from ThreadPoolTestBase which will manage the executor for you?", "author": "andreipaduroiu", "createdAt": "2020-08-13T14:38:28Z", "path": "controller/src/test/java/io/pravega/controller/server/eventProcessor/ControllerEventProcessorsTest.java", "diffHunk": "@@ -50,18 +59,14 @@\n import static org.junit.Assert.assertTrue;\n import static org.mockito.ArgumentMatchers.any;\n import static org.mockito.ArgumentMatchers.anyString;\n-import static org.mockito.Mockito.doAnswer;\n-import static org.mockito.Mockito.mock;\n-import static org.mockito.Mockito.times;\n-import static org.mockito.Mockito.verify;\n-import static org.mockito.Mockito.when;\n+import static org.mockito.Mockito.*;\n \n public class ControllerEventProcessorsTest {\n     ScheduledExecutorService executor;\n \n     @Before\n     public void setUp() {\n-        executor = Executors.newSingleThreadScheduledExecutor();\n+        executor = Executors.newScheduledThreadPool(10);", "originalCommit": "14ca9d91ad5526d803c06403ba42063258c9a05d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "802e70b11b9071f185db5c8a88cd46f898deb00d", "chunk": "diff --git a/controller/src/test/java/io/pravega/controller/server/eventProcessor/ControllerEventProcessorsTest.java b/controller/src/test/java/io/pravega/controller/server/eventProcessor/ControllerEventProcessorsTest.java\nindex f538e62956..1384cba831 100644\n--- a/controller/src/test/java/io/pravega/controller/server/eventProcessor/ControllerEventProcessorsTest.java\n+++ b/controller/src/test/java/io/pravega/controller/server/eventProcessor/ControllerEventProcessorsTest.java\n\n@@ -61,17 +62,10 @@ import static org.mockito.ArgumentMatchers.any;\n import static org.mockito.ArgumentMatchers.anyString;\n import static org.mockito.Mockito.*;\n \n-public class ControllerEventProcessorsTest {\n-    ScheduledExecutorService executor;\n-\n-    @Before\n-    public void setUp() {\n-        executor = Executors.newScheduledThreadPool(10);\n-    }\n-\n-    @After\n-    public void tearDown() {\n-        executor.shutdown();\n+public class ControllerEventProcessorsTest extends ThreadPooledTestSuite {\n+    @Override\n+    public int getThreadPoolSize() {\n+        return 10;\n     }\n     \n     @Test(timeout = 10000)\n"}}, {"oid": "b4dfacb584378cbc335169f08ca1e739f8ff0d53", "url": "https://github.com/pravega/pravega/commit/b4dfacb584378cbc335169f08ca1e739f8ff0d53", "message": "Merge branch 'master' into issue4476", "committedDate": "2020-08-13T15:52:43Z", "type": "commit"}, {"oid": "802e70b11b9071f185db5c8a88cd46f898deb00d", "url": "https://github.com/pravega/pravega/commit/802e70b11b9071f185db5c8a88cd46f898deb00d", "message": "PR comments\n\nSigned-off-by: Shivesh Ranjan <shivesh.ranjan@gmail.com>", "committedDate": "2020-08-13T16:04:49Z", "type": "commit"}, {"oid": "7385c88fe6ee52b26f48e6a4de0ac4d22f0bc4de", "url": "https://github.com/pravega/pravega/commit/7385c88fe6ee52b26f48e6a4de0ac4d22f0bc4de", "message": "Merge branch 'issue4476' of https://github.com/shiveshr/pravega-1 into issue4476", "committedDate": "2020-08-13T16:05:08Z", "type": "commit"}, {"oid": "2dac041b5fe6d6a2a38f868cdc75f5b09bbc758b", "url": "https://github.com/pravega/pravega/commit/2dac041b5fe6d6a2a38f868cdc75f5b09bbc758b", "message": "checkstyle\n\nSigned-off-by: Shivesh Ranjan <shivesh.ranjan@gmail.com>", "committedDate": "2020-08-13T17:27:27Z", "type": "commit"}]}